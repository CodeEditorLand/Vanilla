import"./overlayWidgets.css";import{createFastDomNode as l}from"../../../../base/browser/fastDomNode.js";import{OverlayWidgetPositionPreference as r}from"../../editorBrowser.js";import{PartFingerprint as g,PartFingerprints as c,ViewPart as m}from"../../view/viewPart.js";import"../../view/renderingContext.js";import"../../../common/viewModel/viewContext.js";import"../../../common/viewEvents.js";import{EditorOption as a}from"../../../common/config/editorOptions.js";import*as p from"../../../../base/browser/dom.js";class M extends m{_viewDomNode;_widgets;_viewDomNodeRect;_domNode;overflowingOverlayWidgetsDomNode;_verticalScrollbarWidth;_minimapWidth;_horizontalScrollbarHeight;_editorHeight;_editorWidth;constructor(t,i){super(t),this._viewDomNode=i;const o=this._context.configuration.options.get(a.layoutInfo);this._widgets={},this._verticalScrollbarWidth=o.verticalScrollbarWidth,this._minimapWidth=o.minimap.minimapWidth,this._horizontalScrollbarHeight=o.horizontalScrollbarHeight,this._editorHeight=o.height,this._editorWidth=o.width,this._viewDomNodeRect={top:0,left:0,width:0,height:0},this._domNode=l(document.createElement("div")),c.write(this._domNode,g.OverlayWidgets),this._domNode.setClassName("overlayWidgets"),this.overflowingOverlayWidgetsDomNode=l(document.createElement("div")),c.write(this.overflowingOverlayWidgetsDomNode,g.OverflowingOverlayWidgets),this.overflowingOverlayWidgetsDomNode.setClassName("overflowingOverlayWidgets")}dispose(){super.dispose(),this._widgets={}}getDomNode(){return this._domNode}onConfigurationChanged(t){const e=this._context.configuration.options.get(a.layoutInfo);return this._verticalScrollbarWidth=e.verticalScrollbarWidth,this._minimapWidth=e.minimap.minimapWidth,this._horizontalScrollbarHeight=e.horizontalScrollbarHeight,this._editorHeight=e.height,this._editorWidth=e.width,!0}addWidget(t){const i=l(t.getDomNode());this._widgets[t.getId()]={widget:t,preference:null,domNode:i},i.setPosition("absolute"),i.setAttribute("widgetId",t.getId()),t.allowEditorOverflow?this.overflowingOverlayWidgetsDomNode.appendChild(i):this._domNode.appendChild(i),this.setShouldRender(),this._updateMaxMinWidth()}setWidgetPosition(t,i){const e=this._widgets[t.getId()],o=i?i.preference:null,d=i?.stackOridinal;return e.preference===o&&e.stack===d?(this._updateMaxMinWidth(),!1):(e.preference=o,e.stack=d,this.setShouldRender(),this._updateMaxMinWidth(),!0)}removeWidget(t){const i=t.getId();if(this._widgets.hasOwnProperty(i)){const o=this._widgets[i].domNode.domNode;delete this._widgets[i],o.remove(),this.setShouldRender(),this._updateMaxMinWidth()}}_updateMaxMinWidth(){let t=0;const i=Object.keys(this._widgets);for(let e=0,o=i.length;e<o;e++){const d=i[e],n=this._widgets[d].widget.getMinContentWidthInPx?.();typeof n<"u"&&(t=Math.max(t,n))}this._context.viewLayout.setOverlayWidgetsMinWidth(t)}_renderWidget(t,i){const e=t.domNode;if(t.preference===null){e.setTop("");return}const o=2*this._verticalScrollbarWidth+this._minimapWidth;if(t.preference===r.TOP_RIGHT_CORNER||t.preference===r.BOTTOM_RIGHT_CORNER){if(t.preference===r.BOTTOM_RIGHT_CORNER){const d=e.domNode.clientHeight;e.setTop(this._editorHeight-d-2*this._horizontalScrollbarHeight)}else e.setTop(0);t.stack!==void 0?(e.setTop(i[t.preference]),i[t.preference]+=e.domNode.clientWidth):e.setRight(o)}else if(t.preference===r.TOP_CENTER)e.domNode.style.right="50%",t.stack!==void 0?(e.setTop(i[r.TOP_CENTER]),i[r.TOP_CENTER]+=e.domNode.clientHeight):e.setTop(0);else{const{top:d,left:s}=t.preference;if(this._context.configuration.options.get(a.fixedOverflowWidgets)&&t.widget.allowEditorOverflow){const h=this._viewDomNodeRect;e.setTop(d+h.top),e.setLeft(s+h.left),e.setPosition("fixed")}else e.setTop(d),e.setLeft(s),e.setPosition("absolute")}}prepareRender(t){this._viewDomNodeRect=p.getDomNodePagePosition(this._viewDomNode.domNode)}render(t){this._domNode.setWidth(this._editorWidth);const i=Object.keys(this._widgets),e=Array.from({length:r.TOP_CENTER+1},()=>0);i.sort((o,d)=>(this._widgets[o].stack||0)-(this._widgets[d].stack||0));for(let o=0,d=i.length;o<d;o++){const s=i[o];this._renderWidget(this._widgets[s],e)}}}export{M as ViewOverlayWidgets};
