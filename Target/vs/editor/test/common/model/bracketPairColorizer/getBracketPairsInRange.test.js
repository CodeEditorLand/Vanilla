import o from"assert";import{disposeOnReturn as i}from"../../../../../base/common/lifecycle.js";import{ensureNoDisposablesAreLeakedInTestSuite as k}from"../../../../../base/test/common/utils.js";import{Position as d}from"../../../../common/core/position.js";import{Range as B}from"../../../../common/core/range.js";import{StandardTokenType as y}from"../../../../common/encodedTokenAttributes.js";import{TokenizationRegistry as m}from"../../../../common/languages.js";import{ILanguageService as f}from"../../../../common/languages/language.js";import{ILanguageConfigurationService as T}from"../../../../common/languages/languageConfigurationRegistry.js";import"../../../../common/model/textModel.js";import"../../../../common/textModelBracketPairs.js";import{TokenInfo as E,TokenizedDocument as q}from"./tokenizer.test.js";import{createModelServices as R,instantiateTextModel as S}from"../../testTextModel.js";suite("Bracket Pair Colorizer - getBracketPairsInRange",()=>{k();function l(a,e){const t="testLanguage",n=R(a),c=n.get(T),v=n.get(f);a.add(v.registerLanguage({id:t}));const p=v.languageIdCodec.encodeLanguageId(t),r=new q([new E(e,p,y.Other,!0)]);return a.add(m.register(t,r.getTokenizationSupport())),a.add(c.register(t,{brackets:[["<",">"]],colorizedBracketPairs:[["{","}"],["[","]"],["(",")"]]})),a.add(S(n,e,t))}test("Basic 1",()=>{i(a=>{const e=new g("{ ( [] \xB9 ) [ \xB2 { } ] () } []"),t=l(a,e.text);t.tokenization.getLineTokens(1).getLanguageId(0),o.deepStrictEqual(t.bracketPairs.getBracketPairsInRange(e.range(1,2)).map(u).toArray(),[{level:0,range:"[1,1 -> 1,2]",openRange:"[1,1 -> 1,2]",closeRange:"[1,23 -> 1,24]"},{level:1,range:"[1,3 -> 1,4]",openRange:"[1,3 -> 1,4]",closeRange:"[1,9 -> 1,10]"},{level:1,range:"[1,11 -> 1,12]",openRange:"[1,11 -> 1,12]",closeRange:"[1,18 -> 1,19]"}])})}),test("Basic 2",()=>{i(a=>{const e=new g("{ ( [] \xB9 \xB2) [  { } ] () } []"),t=l(a,e.text);o.deepStrictEqual(t.bracketPairs.getBracketPairsInRange(e.range(1,2)).map(u).toArray(),[{level:0,range:"[1,1 -> 1,2]",openRange:"[1,1 -> 1,2]",closeRange:"[1,23 -> 1,24]"},{level:1,range:"[1,3 -> 1,4]",openRange:"[1,3 -> 1,4]",closeRange:"[1,9 -> 1,10]"}])})}),test("Basic Empty",()=>{i(a=>{const e=new g("\xB9 \xB2 { ( [] ) [  { } ] () } []"),t=l(a,e.text);o.deepStrictEqual(t.bracketPairs.getBracketPairsInRange(e.range(1,2)).map(u).toArray(),[])})}),test("Basic All",()=>{i(a=>{const e=new g("\xB9 { ( [] ) [  { } ] () } [] \xB2"),t=l(a,e.text);o.deepStrictEqual(t.bracketPairs.getBracketPairsInRange(e.range(1,2)).map(u).toArray(),[{level:0,range:"[1,2 -> 1,3]",openRange:"[1,2 -> 1,3]",closeRange:"[1,23 -> 1,24]"},{level:1,range:"[1,4 -> 1,5]",openRange:"[1,4 -> 1,5]",closeRange:"[1,9 -> 1,10]"},{level:2,range:"[1,6 -> 1,7]",openRange:"[1,6 -> 1,7]",closeRange:"[1,7 -> 1,8]"},{level:1,range:"[1,11 -> 1,12]",openRange:"[1,11 -> 1,12]",closeRange:"[1,18 -> 1,19]"},{level:2,range:"[1,14 -> 1,15]",openRange:"[1,14 -> 1,15]",closeRange:"[1,16 -> 1,17]"},{level:1,range:"[1,20 -> 1,21]",openRange:"[1,20 -> 1,21]",closeRange:"[1,21 -> 1,22]"},{level:0,range:"[1,25 -> 1,26]",openRange:"[1,25 -> 1,26]",closeRange:"[1,26 -> 1,27]"}])})}),test("getBracketsInRange",()=>{i(a=>{const e=new g("\xB9 { [ ( [ [ (  ) ] ] ) ] } { } \xB2"),t=l(a,e.text);o.deepStrictEqual(t.bracketPairs.getBracketsInRange(e.range(1,2)).map(n=>({level:n.nestingLevel,levelEqualBracketType:n.nestingLevelOfEqualBracketType,range:n.range.toString()})).toArray(),[{level:0,levelEqualBracketType:0,range:"[1,2 -> 1,3]"},{level:1,levelEqualBracketType:0,range:"[1,4 -> 1,5]"},{level:2,levelEqualBracketType:0,range:"[1,6 -> 1,7]"},{level:3,levelEqualBracketType:1,range:"[1,8 -> 1,9]"},{level:4,levelEqualBracketType:2,range:"[1,10 -> 1,11]"},{level:5,levelEqualBracketType:1,range:"[1,12 -> 1,13]"},{level:5,levelEqualBracketType:1,range:"[1,15 -> 1,16]"},{level:4,levelEqualBracketType:2,range:"[1,17 -> 1,18]"},{level:3,levelEqualBracketType:1,range:"[1,19 -> 1,20]"},{level:2,levelEqualBracketType:0,range:"[1,21 -> 1,22]"},{level:1,levelEqualBracketType:0,range:"[1,23 -> 1,24]"},{level:0,levelEqualBracketType:0,range:"[1,25 -> 1,26]"},{level:0,levelEqualBracketType:0,range:"[1,27 -> 1,28]"},{level:0,levelEqualBracketType:0,range:"[1,29 -> 1,30]"}])})}),test("Test Error Brackets",()=>{i(a=>{const e=new g("\xB9 { () ] \xB2 "),t=l(a,e.text);o.deepStrictEqual(t.bracketPairs.getBracketsInRange(e.range(1,2)).map(n=>({level:n.nestingLevel,range:n.range.toString(),isInvalid:n.isInvalid})).toArray(),[{level:0,isInvalid:!0,range:"[1,2 -> 1,3]"},{level:1,isInvalid:!1,range:"[1,4 -> 1,5]"},{level:1,isInvalid:!1,range:"[1,5 -> 1,6]"},{level:0,isInvalid:!0,range:"[1,7 -> 1,8]"}])})}),test("colorizedBracketsVSBrackets",()=>{i(a=>{const e=new g("\xB9 {} [<()>] <{>} \xB2"),t=l(a,e.text);o.deepStrictEqual(t.bracketPairs.getBracketsInRange(e.range(1,2),!0).map(n=>({level:n.nestingLevel,levelEqualBracketType:n.nestingLevelOfEqualBracketType,range:n.range.toString()})).toArray(),[{level:0,levelEqualBracketType:0,range:"[1,2 -> 1,3]"},{level:0,levelEqualBracketType:0,range:"[1,3 -> 1,4]"},{level:0,levelEqualBracketType:0,range:"[1,5 -> 1,6]"},{level:1,levelEqualBracketType:0,range:"[1,7 -> 1,8]"},{level:1,levelEqualBracketType:0,range:"[1,8 -> 1,9]"},{level:0,levelEqualBracketType:0,range:"[1,10 -> 1,11]"},{level:0,levelEqualBracketType:0,range:"[1,13 -> 1,14]"},{level:-1,levelEqualBracketType:0,range:"[1,15 -> 1,16]"}]),o.deepStrictEqual(t.bracketPairs.getBracketsInRange(e.range(1,2),!1).map(n=>({level:n.nestingLevel,levelEqualBracketType:n.nestingLevelOfEqualBracketType,range:n.range.toString()})).toArray(),[{level:0,levelEqualBracketType:0,range:"[1,2 -> 1,3]"},{level:0,levelEqualBracketType:0,range:"[1,3 -> 1,4]"},{level:0,levelEqualBracketType:0,range:"[1,5 -> 1,6]"},{level:1,levelEqualBracketType:0,range:"[1,6 -> 1,7]"},{level:2,levelEqualBracketType:0,range:"[1,7 -> 1,8]"},{level:2,levelEqualBracketType:0,range:"[1,8 -> 1,9]"},{level:1,levelEqualBracketType:0,range:"[1,9 -> 1,10]"},{level:0,levelEqualBracketType:0,range:"[1,10 -> 1,11]"},{level:0,levelEqualBracketType:0,range:"[1,12 -> 1,13]"},{level:1,levelEqualBracketType:0,range:"[1,13 -> 1,14]"},{level:0,levelEqualBracketType:0,range:"[1,14 -> 1,15]"},{level:-1,levelEqualBracketType:0,range:"[1,15 -> 1,16]"}])})})});function u(l){return{level:l.nestingLevel,range:l.openingBracketRange.toString(),openRange:l.openingBracketRange.toString(),closeRange:l.closingBracketRange?.toString()||null}}class I{lineStartOffsetByLineIdx;constructor(a){this.lineStartOffsetByLineIdx=[],this.lineStartOffsetByLineIdx.push(0);for(let e=0;e<a.length;e++)a.charAt(e)===`
`&&this.lineStartOffsetByLineIdx.push(e+1)}getOffset(a){return this.lineStartOffsetByLineIdx[a.lineNumber-1]+a.column-1}getPosition(a){const e=this.lineStartOffsetByLineIdx.findIndex(t=>t<=a);return new d(e+1,a-this.lineStartOffsetByLineIdx[e]+1)}}class g{text;positions;constructor(a){const e=["\u2070","\xB9","\xB2","\xB3","\u2074","\u2075","\u2076","\u2077","\u2078","\u2079"];let t="";const n=new Map;let c=0;for(let r=0;r<a.length;r++){const s=e.indexOf(a[r]);s>=0?n.set(s,c):(t+=a[r],c++)}this.text=t;const v=new I(this.text),p=new Map;for(const[r,s]of n.entries())p.set(r,v.getPosition(s));this.positions=p}range(a,e){return B.fromPositions(this.positions.get(a),this.positions.get(e))}}
