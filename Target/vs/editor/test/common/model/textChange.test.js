import m from"assert";import{ensureNoDisposablesAreLeakedInTestSuite as E}from"../../../../base/test/common/utils.js";import{compressConsecutiveTextChanges as v,TextChange as p}from"../../../common/core/textChange.js";const R=!1;suite("TextChangeCompressor",()=>{E();function g(n,e){let t=n;for(let s=e.length-1;s>=0;s--)t=t.substring(0,e[s].offset)+e[s].text+t.substring(e[s].offset+e[s].length);return t}function u(n,e){let t=n;const s=new Array(e.length);let f=0;for(let r=0;r<e.length;r++){const i=e[r],l=i.offset+f,c=i.length,d=i.text,x=t.substr(l,c);t=t.substr(0,l)+d+t.substr(l+c),s[r]=new p(i.offset,x,l,d),f+=d.length-c}return s}function o(n,e,t){const s=g(n,e),f=u(n,e),r=g(s,t),i=u(s,t),l=v(f,i),c=l.map(h=>({offset:h.oldPosition,length:h.oldLength,text:h.newText})),d=g(n,c);m.strictEqual(d,r);const x=l.map(h=>({offset:h.newPosition,length:h.newLength,text:h.oldText})),S=g(r,x);m.strictEqual(S,n)}test("simple 1",()=>{o("",[{offset:0,length:0,text:"h"}],[{offset:1,length:0,text:"e"}])}),test("simple 2",()=>{o("|",[{offset:0,length:0,text:"h"}],[{offset:2,length:0,text:"e"}])}),test("complex1",()=>{o("abcdefghij",[{offset:0,length:3,text:"qh"},{offset:5,length:0,text:"1"},{offset:8,length:2,text:"X"}],[{offset:1,length:0,text:"Z"},{offset:3,length:3,text:"Y"}])}),test("gen1",()=>{o("kxm",[{offset:0,length:1,text:"tod_neu"}],[{offset:1,length:2,text:"sag_e"}])}),test("gen2",()=>{o("kpb_r_v",[{offset:5,length:2,text:"a_jvf_l"}],[{offset:10,length:2,text:"w"}])}),test("gen3",()=>{o("slu_w",[{offset:4,length:1,text:"_wfw"}],[{offset:3,length:5,text:""}])}),test("gen4",()=>{o("_e",[{offset:2,length:0,text:"zo_b"}],[{offset:1,length:3,text:"tra"}])}),test("gen5",()=>{o("ssn_",[{offset:0,length:2,text:"tat_nwe"}],[{offset:2,length:6,text:"jm"}])}),test("gen6",()=>{o("kl_nru",[{offset:4,length:1,text:""}],[{offset:1,length:4,text:"__ut"}])});const C=97,T=122;function a(n,e){return Math.floor(Math.random()*(e-n+1))+n}function w(n,e){const t=a(n,e);let s="";for(let f=0;f<t;f++)s+=String.fromCharCode(a(C,T));return s}function G(){switch(a(1,3)){case 1:return"\r";case 2:return`
`;case 3:return`\r
`}throw new Error("not possible")}function _(n){const e=a(1,n?3:10),t=[];for(let s=0;s<e;s++)t.push(w(0,n?3:10)+G());return t.join("")}function b(n,e=1,t=5){const s=[];let f=a(e,t),r=n.length;for(;f>0&&r>0;){const i=a(0,r),l=a(0,r-i),c=_(!0);s.push({offset:i,length:l,text:c}),r=i,f--}return s.reverse(),s}class I{_content;_edits1;_edits2;constructor(){this._content=_(!1).replace(/\n/g,"_"),this._edits1=b(this._content,1,5).map(t=>({offset:t.offset,length:t.length,text:t.text.replace(/\n/g,"_")}));const e=g(this._content,this._edits1);this._edits2=b(e,1,5).map(t=>({offset:t.offset,length:t.length,text:t.text.replace(/\n/g,"_")}))}print(){console.log(`assertCompression(${JSON.stringify(this._content)}, ${JSON.stringify(this._edits1)}, ${JSON.stringify(this._edits2)});`)}assert(){o(this._content,this._edits1,this._edits2)}}if(R){let n=0;for(;;){n++,console.log(`------RUNNING TextChangeCompressor TEST ${n}`);const e=new I;try{e.assert()}catch(t){console.log(t),e.print();break}}}}),suite("TextChange",()=>{E(),test("issue #118041: unicode character undo bug",()=>{const g=new p(428,"\uFEFF",428,""),u=new Uint8Array(g.writeSize());g.write(u,0);const o=[];p.read(u,0,o),m.deepStrictEqual(o[0],g)})});
