import*as L from"../../../base/common/strings.js";import"../core/range.js";import"../model.js";import{IndentAction as p}from"./languageConfiguration.js";import{IndentConsts as R}from"./supports/indentRules.js";import{EditorAutoIndentStrategy as A}from"../config/editorOptions.js";import"./languageConfigurationRegistry.js";import"../tokens/lineTokens.js";import{IndentationContextProcessor as k,isLanguageDifferentFromLineStart as S,ProcessedIndentRulesSupport as m}from"./supports/indentationLineProcessor.js";import"../cursorCommon.js";function V(i,n,e){const c=i.tokenization.getLanguageIdAtPosition(n,0);if(n>1){let t,a=-1;for(t=n-1;t>=1;t--){if(i.tokenization.getLanguageIdAtPosition(t,0)!==c)return a;const r=i.getLineContent(t);if(e.shouldIgnore(t)||/^\s+$/.test(r)||r===""){a=t;continue}return t}}return-1}function T(i,n,e,c=!0,t){if(i<A.Full)return null;const a=t.getLanguageConfiguration(n.tokenization.getLanguageId()).indentRulesSupport;if(!a)return null;const r=new m(n,a,t);if(e<=1)return{indentation:"",action:null};for(let g=e-1;g>0&&n.getLineContent(g)==="";g--)if(g===1)return{indentation:"",action:null};const s=V(n,e,r);if(s<0)return null;if(s<1)return{indentation:"",action:null};if(r.shouldIncrease(s)||r.shouldIndentNextLine(s)){const g=n.getLineContent(s);return{indentation:L.getLeadingWhitespace(g),action:p.Indent,line:s}}else if(r.shouldDecrease(s)){const g=n.getLineContent(s);return{indentation:L.getLeadingWhitespace(g),action:null,line:s}}else{if(s===1)return{indentation:L.getLeadingWhitespace(n.getLineContent(s)),action:null,line:s};const g=s-1,d=a.getIndentMetadata(n.getLineContent(g));if(!(d&(R.INCREASE_MASK|R.DECREASE_MASK))&&d&R.INDENT_NEXTLINE_MASK){let o=0;for(let f=g-1;f>0;f--)if(!r.shouldIndentNextLine(f)){o=f;break}return{indentation:L.getLeadingWhitespace(n.getLineContent(o+1)),action:null,line:o+1}}if(c)return{indentation:L.getLeadingWhitespace(n.getLineContent(s)),action:null,line:s};for(let o=s;o>0;o--){if(r.shouldIncrease(o))return{indentation:L.getLeadingWhitespace(n.getLineContent(o)),action:p.Indent,line:o};if(r.shouldIndentNextLine(o)){let f=0;for(let u=o-1;u>0;u--)if(!r.shouldIndentNextLine(o)){f=u;break}return{indentation:L.getLeadingWhitespace(n.getLineContent(f+1)),action:null,line:f+1}}else if(r.shouldDecrease(o))return{indentation:L.getLeadingWhitespace(n.getLineContent(o)),action:null,line:o}}return{indentation:L.getLeadingWhitespace(n.getLineContent(1)),action:null,line:1}}}function Y(i,n,e,c,t,a){if(i<A.Full)return null;const r=a.getLanguageConfiguration(e);if(!r)return null;const s=a.getLanguageConfiguration(e).indentRulesSupport;if(!s)return null;const g=new m(n,s,a),d=T(i,n,c,void 0,a);if(d){const o=d.line;if(o!==void 0){let f=!0;for(let u=o;u<c-1;u++)if(!/^\s*$/.test(n.getLineContent(u))){f=!1;break}if(f){const u=r.onEnter(i,"",n.getLineContent(o),"");if(u){let l=L.getLeadingWhitespace(n.getLineContent(o));return u.removeText&&(l=l.substring(0,l.length-u.removeText)),u.indentAction===p.Indent||u.indentAction===p.IndentOutdent?l=t.shiftIndent(l):u.indentAction===p.Outdent&&(l=t.unshiftIndent(l)),g.shouldDecrease(c)&&(l=t.unshiftIndent(l)),u.appendText&&(l+=u.appendText),L.getLeadingWhitespace(l)}}}return g.shouldDecrease(c)?d.action===p.Indent?d.indentation:t.unshiftIndent(d.indentation):d.action===p.Indent?t.shiftIndent(d.indentation):d.indentation}return null}function Z(i,n,e,c,t){if(i<A.Full)return null;const a=n.getLanguageIdAtPosition(e.startLineNumber,e.startColumn),r=t.getLanguageConfiguration(a).indentRulesSupport;if(!r)return null;n.tokenization.forceTokenization(e.startLineNumber);const g=new k(n,t).getProcessedTokenContextAroundRange(e),d=g.afterRangeProcessedTokens,o=g.beforeRangeProcessedTokens,f=L.getLeadingWhitespace(o.getLineContent()),u=z(n,e.startLineNumber,o),l=S(n,e.getStartPosition()),x=n.getLineContent(e.startLineNumber),h=L.getLeadingWhitespace(x),b=T(i,u,e.startLineNumber+1,void 0,t);if(!b){const C=l?h:f;return{beforeEnter:C,afterEnter:C}}let I=l?h:b.indentation;return b.action===p.Indent&&(I=c.shiftIndent(I)),r.shouldDecrease(d.getLineContent())&&(I=c.unshiftIndent(I)),{beforeEnter:l?h:f,afterEnter:I}}function nn(i,n,e,c,t,a){const r=i.autoIndent;if(r<A.Full||S(n,e.getStartPosition()))return null;const g=n.getLanguageIdAtPosition(e.startLineNumber,e.startColumn),d=a.getLanguageConfiguration(g).indentRulesSupport;if(!d)return null;const f=new k(n,a).getProcessedTokenContextAroundRange(e),u=f.beforeRangeProcessedTokens.getLineContent(),l=f.afterRangeProcessedTokens.getLineContent(),x=u+l,h=u+c+l;if(!d.shouldDecrease(x)&&d.shouldDecrease(h)){const I=T(r,n,e.startLineNumber,!1,a);if(!I)return null;let C=I.indentation;return I.action!==p.Indent&&(C=t.unshiftIndent(C)),C}const b=e.startLineNumber-1;if(b>0){const I=n.getLineContent(b);if(d.shouldIndentNextLine(I)&&d.shouldIncrease(h)){const E=T(r,n,e.startLineNumber,!1,a)?.indentation;if(E!==void 0){const M=n.getLineContent(e.startLineNumber),W=L.getLeadingWhitespace(M),N=t.shiftIndent(E)===W,D=/^\s*$/.test(x),P=i.autoClosingPairs.autoClosingPairsOpenByEnd.get(c),F=P&&P.length>0&&D;if(N&&F)return E}}}return null}function tn(i,n,e){const c=e.getLanguageConfiguration(i.getLanguageId()).indentRulesSupport;return!c||n<1||n>i.getLineCount()?null:c.getIndentMetadata(i.getLineContent(n))}function z(i,n,e){return{tokenization:{getLineTokens:t=>t===n?e:i.tokenization.getLineTokens(t),getLanguageId:()=>i.getLanguageId(),getLanguageIdAtPosition:(t,a)=>i.getLanguageIdAtPosition(t,a)},getLineContent:t=>t===n?e.getLineContent():i.getLineContent(t)}}export{Y as getGoodIndentForLine,nn as getIndentActionForType,Z as getIndentForEnter,tn as getIndentMetadata,T as getInheritIndentForLine};
