import{CallbackIterable as M,compareBy as N}from"../../../../base/common/arrays.js";import{Emitter as w}from"../../../../base/common/event.js";import{Disposable as D,DisposableStore as y,MutableDisposable as _}from"../../../../base/common/lifecycle.js";import"../../core/position.js";import{Range as P}from"../../core/range.js";import"../../languages/languageConfigurationRegistry.js";import{ignoreBracketsInToken as T}from"../../languages/supports.js";import"../../languages/supports/languageBracketsConfiguration.js";import{BracketsUtils as I}from"../../languages/supports/richEditBrackets.js";import{BracketPairsTree as A}from"./bracketPairsTree/bracketPairsTree.js";import"../textModel.js";import"../../textModelBracketPairs.js";import"../../textModelEvents.js";import"../../tokens/lineTokens.js";class me extends D{constructor(e,n){super();this.textModel=e;this.languageConfigurationService=n}bracketPairsTree=this._register(new _);onDidChangeEmitter=new w;onDidChange=this.onDidChangeEmitter.event;get canBuildAST(){return this.textModel.getValueLength()<=5e6}bracketsRequested=!1;handleLanguageConfigurationServiceChange(e){(!e.languageId||this.bracketPairsTree.value?.object.didLanguageChange(e.languageId))&&(this.bracketPairsTree.clear(),this.updateBracketPairsTree())}handleDidChangeOptions(e){this.bracketPairsTree.clear(),this.updateBracketPairsTree()}handleDidChangeLanguage(e){this.bracketPairsTree.clear(),this.updateBracketPairsTree()}handleDidChangeContent(e){this.bracketPairsTree.value?.object.handleContentChanged(e)}handleDidChangeBackgroundTokenizationState(){this.bracketPairsTree.value?.object.handleDidChangeBackgroundTokenizationState()}handleDidChangeTokens(e){this.bracketPairsTree.value?.object.handleDidChangeTokens(e)}updateBracketPairsTree(){if(this.bracketsRequested&&this.canBuildAST){if(!this.bracketPairsTree.value){const e=new y;this.bracketPairsTree.value=F(e.add(new A(this.textModel,n=>this.languageConfigurationService.getLanguageConfiguration(n))),e),e.add(this.bracketPairsTree.value.object.onDidChange(n=>this.onDidChangeEmitter.fire(n))),this.onDidChangeEmitter.fire()}}else this.bracketPairsTree.value&&(this.bracketPairsTree.clear(),this.onDidChangeEmitter.fire())}getBracketPairsInRange(e){return this.bracketsRequested=!0,this.updateBracketPairsTree(),this.bracketPairsTree.value?.object.getBracketPairsInRange(e,!1)||M.empty}getBracketPairsInRangeWithMinIndentation(e){return this.bracketsRequested=!0,this.updateBracketPairsTree(),this.bracketPairsTree.value?.object.getBracketPairsInRange(e,!0)||M.empty}getBracketsInRange(e,n=!1){return this.bracketsRequested=!0,this.updateBracketPairsTree(),this.bracketPairsTree.value?.object.getBracketsInRange(e,n)||M.empty}findMatchingBracketUp(e,n,c){const r=this.textModel.validatePosition(n),f=this.textModel.getLanguageIdAtPosition(r.lineNumber,r.column);if(this.canBuildAST){const u=this.languageConfigurationService.getLanguageConfiguration(f).bracketsNew.getClosingBracketInfo(e);if(!u)return null;const l=this.getBracketPairsInRange(P.fromPositions(n,n)).findLast(k=>u.closes(k.openingBracketInfo));return l?l.openingBracketRange:null}else{const u=e.toLowerCase(),l=this.languageConfigurationService.getLanguageConfiguration(f).brackets;if(!l)return null;const k=l.textIsBracket[u];return k?L(this._findMatchingBracketUp(k,r,E(c))):null}}matchBracket(e,n){if(this.canBuildAST){const c=this.getBracketPairsInRange(P.fromPositions(e,e)).filter(r=>r.closingBracketRange!==void 0&&(r.openingBracketRange.containsPosition(e)||r.closingBracketRange.containsPosition(e))).findLastMaxBy(N(r=>r.openingBracketRange.containsPosition(e)?r.openingBracketRange:r.closingBracketRange,P.compareRangesUsingStarts));return c?[c.openingBracketRange,c.closingBracketRange]:null}else{const c=E(n);return this._matchBracket(this.textModel.validatePosition(e),c)}}_establishBracketSearchOffsets(e,n,c,r){const f=n.getCount(),u=n.getLanguageId(r);let l=Math.max(0,e.column-1-c.maxBracketLength);for(let g=r-1;g>=0;g--){const s=n.getEndOffset(g);if(s<=l)break;if(T(n.getStandardTokenType(g))||n.getLanguageId(g)!==u){l=s;break}}let k=Math.min(n.getLineContent().length,e.column-1+c.maxBracketLength);for(let g=r+1;g<f;g++){const s=n.getStartOffset(g);if(s>=k)break;if(T(n.getStandardTokenType(g))||n.getLanguageId(g)!==u){k=s;break}}return{searchStartOffset:l,searchEndOffset:k}}_matchBracket(e,n){const c=e.lineNumber,r=this.textModel.tokenization.getLineTokens(c),f=this.textModel.getLineContent(c),u=r.findTokenIndexAtOffset(e.column-1);if(u<0)return null;const l=this.languageConfigurationService.getLanguageConfiguration(r.getLanguageId(u)).brackets;if(l&&!T(r.getStandardTokenType(u))){let{searchStartOffset:k,searchEndOffset:g}=this._establishBracketSearchOffsets(e,r,l,u),s=null;for(;;){const i=I.findNextBracketInRange(l.forwardRegex,c,f,k,g);if(!i)break;if(i.startColumn<=e.column&&e.column<=i.endColumn){const o=f.substring(i.startColumn-1,i.endColumn-1).toLowerCase(),a=this._matchFoundBracket(i,l.textIsBracket[o],l.textIsOpenBracket[o],n);if(a){if(a instanceof R)return null;s=a}}k=i.endColumn-1}if(s)return s}if(u>0&&r.getStartOffset(u)===e.column-1){const k=u-1,g=this.languageConfigurationService.getLanguageConfiguration(r.getLanguageId(k)).brackets;if(g&&!T(r.getStandardTokenType(k))){const{searchStartOffset:s,searchEndOffset:i}=this._establishBracketSearchOffsets(e,r,g,k),o=I.findPrevBracketInRange(g.reversedRegex,c,f,s,i);if(o&&o.startColumn<=e.column&&e.column<=o.endColumn){const a=f.substring(o.startColumn-1,o.endColumn-1).toLowerCase(),t=this._matchFoundBracket(o,g.textIsBracket[a],g.textIsOpenBracket[a],n);if(t)return t instanceof R?null:t}}}return null}_matchFoundBracket(e,n,c,r){if(!n)return null;const f=c?this._findMatchingBracketDown(n,e.getEndPosition(),r):this._findMatchingBracketUp(n,e.getStartPosition(),r);return f?f instanceof R?f:[e,f]:null}_findMatchingBracketUp(e,n,c){const r=e.languageId,f=e.reversedRegex;let u=-1,l=0;const k=(g,s,i,o)=>{for(;;){if(c&&++l%100===0&&!c())return R.INSTANCE;const a=I.findPrevBracketInRange(f,g,s,i,o);if(!a)break;const t=s.substring(a.startColumn-1,a.endColumn-1).toLowerCase();if(e.isOpen(t)?u++:e.isClose(t)&&u--,u===0)return a;o=a.startColumn-1}return null};for(let g=n.lineNumber;g>=1;g--){const s=this.textModel.tokenization.getLineTokens(g),i=s.getCount(),o=this.textModel.getLineContent(g);let a=i-1,t=o.length,d=o.length;g===n.lineNumber&&(a=s.findTokenIndexAtOffset(n.column-1),t=n.column-1,d=n.column-1);let h=!0;for(;a>=0;a--){const C=s.getLanguageId(a)===r&&!T(s.getStandardTokenType(a));if(C)h?t=s.getStartOffset(a):(t=s.getStartOffset(a),d=s.getEndOffset(a));else if(h&&t!==d){const B=k(g,o,t,d);if(B)return B}h=C}if(h&&t!==d){const C=k(g,o,t,d);if(C)return C}}return null}_findMatchingBracketDown(e,n,c){const r=e.languageId,f=e.forwardRegex;let u=1,l=0;const k=(s,i,o,a)=>{for(;;){if(c&&++l%100===0&&!c())return R.INSTANCE;const t=I.findNextBracketInRange(f,s,i,o,a);if(!t)break;const d=i.substring(t.startColumn-1,t.endColumn-1).toLowerCase();if(e.isOpen(d)?u++:e.isClose(d)&&u--,u===0)return t;o=t.endColumn-1}return null},g=this.textModel.getLineCount();for(let s=n.lineNumber;s<=g;s++){const i=this.textModel.tokenization.getLineTokens(s),o=i.getCount(),a=this.textModel.getLineContent(s);let t=0,d=0,h=0;s===n.lineNumber&&(t=i.findTokenIndexAtOffset(n.column-1),d=n.column-1,h=n.column-1);let C=!0;for(;t<o;t++){const B=i.getLanguageId(t)===r&&!T(i.getStandardTokenType(t));if(B)C||(d=i.getStartOffset(t)),h=i.getEndOffset(t);else if(C&&d!==h){const b=k(s,a,d,h);if(b)return b}C=B}if(C&&d!==h){const B=k(s,a,d,h);if(B)return B}}return null}findPrevBracket(e){const n=this.textModel.validatePosition(e);if(this.canBuildAST)return this.bracketsRequested=!0,this.updateBracketPairsTree(),this.bracketPairsTree.value?.object.getFirstBracketBefore(n)||null;let c=null,r=null,f=null;for(let u=n.lineNumber;u>=1;u--){const l=this.textModel.tokenization.getLineTokens(u),k=l.getCount(),g=this.textModel.getLineContent(u);let s=k-1,i=g.length,o=g.length;if(u===n.lineNumber){s=l.findTokenIndexAtOffset(n.column-1),i=n.column-1,o=n.column-1;const t=l.getLanguageId(s);c!==t&&(c=t,r=this.languageConfigurationService.getLanguageConfiguration(c).brackets,f=this.languageConfigurationService.getLanguageConfiguration(c).bracketsNew)}let a=!0;for(;s>=0;s--){const t=l.getLanguageId(s);if(c!==t){if(r&&f&&a&&i!==o){const h=I.findPrevBracketInRange(r.reversedRegex,u,g,i,o);if(h)return this._toFoundBracket(f,h);a=!1}c=t,r=this.languageConfigurationService.getLanguageConfiguration(c).brackets,f=this.languageConfigurationService.getLanguageConfiguration(c).bracketsNew}const d=!!r&&!T(l.getStandardTokenType(s));if(d)a?i=l.getStartOffset(s):(i=l.getStartOffset(s),o=l.getEndOffset(s));else if(f&&r&&a&&i!==o){const h=I.findPrevBracketInRange(r.reversedRegex,u,g,i,o);if(h)return this._toFoundBracket(f,h)}a=d}if(f&&r&&a&&i!==o){const t=I.findPrevBracketInRange(r.reversedRegex,u,g,i,o);if(t)return this._toFoundBracket(f,t)}}return null}findNextBracket(e){const n=this.textModel.validatePosition(e);if(this.canBuildAST)return this.bracketsRequested=!0,this.updateBracketPairsTree(),this.bracketPairsTree.value?.object.getFirstBracketAfter(n)||null;const c=this.textModel.getLineCount();let r=null,f=null,u=null;for(let l=n.lineNumber;l<=c;l++){const k=this.textModel.tokenization.getLineTokens(l),g=k.getCount(),s=this.textModel.getLineContent(l);let i=0,o=0,a=0;if(l===n.lineNumber){i=k.findTokenIndexAtOffset(n.column-1),o=n.column-1,a=n.column-1;const d=k.getLanguageId(i);r!==d&&(r=d,f=this.languageConfigurationService.getLanguageConfiguration(r).brackets,u=this.languageConfigurationService.getLanguageConfiguration(r).bracketsNew)}let t=!0;for(;i<g;i++){const d=k.getLanguageId(i);if(r!==d){if(u&&f&&t&&o!==a){const C=I.findNextBracketInRange(f.forwardRegex,l,s,o,a);if(C)return this._toFoundBracket(u,C);t=!1}r=d,f=this.languageConfigurationService.getLanguageConfiguration(r).brackets,u=this.languageConfigurationService.getLanguageConfiguration(r).bracketsNew}const h=!!f&&!T(k.getStandardTokenType(i));if(h)t||(o=k.getStartOffset(i)),a=k.getEndOffset(i);else if(u&&f&&t&&o!==a){const C=I.findNextBracketInRange(f.forwardRegex,l,s,o,a);if(C)return this._toFoundBracket(u,C)}t=h}if(u&&f&&t&&o!==a){const d=I.findNextBracketInRange(f.forwardRegex,l,s,o,a);if(d)return this._toFoundBracket(u,d)}}return null}findEnclosingBrackets(e,n){const c=this.textModel.validatePosition(e);if(this.canBuildAST){const a=P.fromPositions(c),t=this.getBracketPairsInRange(P.fromPositions(c,c)).findLast(d=>d.closingBracketRange!==void 0&&d.range.strictContainsRange(a));return t?[t.openingBracketRange,t.closingBracketRange]:null}const r=E(n),f=this.textModel.getLineCount(),u=new Map;let l=[];const k=(a,t)=>{if(!u.has(a)){const d=[];for(let h=0,C=t?t.brackets.length:0;h<C;h++)d[h]=0;u.set(a,d)}l=u.get(a)};let g=0;const s=(a,t,d,h,C)=>{for(;;){if(r&&++g%100===0&&!r())return R.INSTANCE;const B=I.findNextBracketInRange(a.forwardRegex,t,d,h,C);if(!B)break;const b=d.substring(B.startColumn-1,B.endColumn-1).toLowerCase(),m=a.textIsBracket[b];if(m&&(m.isOpen(b)?l[m.index]++:m.isClose(b)&&l[m.index]--,l[m.index]===-1))return this._matchFoundBracket(B,m,!1,r);h=B.endColumn-1}return null};let i=null,o=null;for(let a=c.lineNumber;a<=f;a++){const t=this.textModel.tokenization.getLineTokens(a),d=t.getCount(),h=this.textModel.getLineContent(a);let C=0,B=0,b=0;if(a===c.lineNumber){C=t.findTokenIndexAtOffset(c.column-1),B=c.column-1,b=c.column-1;const v=t.getLanguageId(C);i!==v&&(i=v,o=this.languageConfigurationService.getLanguageConfiguration(i).brackets,k(i,o))}let m=!0;for(;C<d;C++){const v=t.getLanguageId(C);if(i!==v){if(o&&m&&B!==b){const x=s(o,a,h,B,b);if(x)return L(x);m=!1}i=v,o=this.languageConfigurationService.getLanguageConfiguration(i).brackets,k(i,o)}const O=!!o&&!T(t.getStandardTokenType(C));if(O)m||(B=t.getStartOffset(C)),b=t.getEndOffset(C);else if(o&&m&&B!==b){const x=s(o,a,h,B,b);if(x)return L(x)}m=O}if(o&&m&&B!==b){const v=s(o,a,h,B,b);if(v)return L(v)}}return null}_toFoundBracket(e,n){if(!n)return null;let c=this.textModel.getValueInRange(n);c=c.toLowerCase();const r=e.getBracketInfo(c);return r?{range:n,bracketInfo:r}:null}}function F(p,S){return{object:p,dispose:()=>S?.dispose()}}function E(p){if(typeof p>"u")return()=>!0;{const S=Date.now();return()=>Date.now()-S<=p}}class R{static INSTANCE=new R;_searchCanceledBrand=void 0;constructor(){}}function L(p){return p instanceof R?null:p}export{me as BracketPairsTextModelPart};
