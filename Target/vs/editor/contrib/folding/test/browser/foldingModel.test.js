import d from"assert";import{escapeRegExpCharacters as T}from"../../../../../base/common/strings.js";import{ensureNoDisposablesAreLeakedInTestSuite as U}from"../../../../../base/test/common/utils.js";import{EditOperation as F}from"../../../../common/core/editOperation.js";import{Position as O}from"../../../../common/core/position.js";import{Range as V}from"../../../../common/core/range.js";import{Selection as W}from"../../../../common/core/selection.js";import{TrackedRangeStickiness as j}from"../../../../common/model.js";import{ModelDecorationOptions as I}from"../../../../common/model/textModel.js";import{toSelectedLines as X}from"../../browser/folding.js";import{FoldingModel as R,getNextFoldLine as x,getParentFoldLine as C,getPreviousFoldLine as h,setCollapseStateAtLevel as q,setCollapseStateForMatchingLines as G,setCollapseStateForRest as N,setCollapseStateLevelsDown as y,setCollapseStateLevelsUp as S,setCollapseStateUp as $}from"../../browser/foldingModel.js";import"../../browser/foldingRanges.js";import{computeRanges as A}from"../../browser/indentRangeProvider.js";import{createTextModel as E}from"../../../../test/common/testTextModel.js";class p{constructor(f){this.model=f}static collapsedDecoration=I.register({description:"test",stickiness:j.NeverGrowsWhenTypingAtEdges,linesDecorationsClassName:"folding"});static expandedDecoration=I.register({description:"test",stickiness:j.NeverGrowsWhenTypingAtEdges,linesDecorationsClassName:"folding"});static hiddenDecoration=I.register({description:"test",stickiness:j.NeverGrowsWhenTypingAtEdges,linesDecorationsClassName:"folding"});getDecorationOption(f,L){return L?p.hiddenDecoration:f?p.collapsedDecoration:p.expandedDecoration}changeDecorations(f){return this.model.changeDecorations(f)}removeDecorations(f){this.model.changeDecorations(L=>{L.deltaDecorations(f,[])})}getDecorations(){const f=this.model.getAllDecorations(),L=[];for(const a of f)a.options===p.hiddenDecoration?L.push({line:a.range.startLineNumber,type:"hidden"}):a.options===p.collapsedDecoration?L.push({line:a.range.startLineNumber,type:"collapsed"}):a.options===p.expandedDecoration&&L.push({line:a.range.startLineNumber,type:"expanded"});return L}}suite("Folding Model",()=>{U();function n(g,t,e=!1){return{startLineNumber:g,endLineNumber:t,isCollapsed:e}}function f(g,t){return{line:g,type:t}}function L(g,t,e){d.strictEqual(!!g,!!t,e),g&&t&&(d.strictEqual(g.startLineNumber,t.startLineNumber,e),d.strictEqual(g.endLineNumber,t.endLineNumber,e),d.strictEqual(g.isCollapsed,t.isCollapsed,e))}function a(g,t,e){const l=[],s=g.regions;for(let o=0;o<s.length;o++)s.isCollapsed(o)&&l.push(n(s.getStartLineNumber(o),s.getEndLineNumber(o)));d.deepStrictEqual(l,t,e)}function u(g,t,e){const l=[],s=g.regions;for(let o=0;o<s.length;o++)l.push(n(s.getStartLineNumber(o),s.getEndLineNumber(o),s.isCollapsed(o)));d.deepStrictEqual(l,t,e)}function v(g,t,e){const l=g.decorationProvider;d.deepStrictEqual(l.getDecorations(),t,e)}function m(g,t,e){d.deepStrictEqual(g.map(l=>({startLineNumber:l.startLineNumber,endLineNumber:l.endLineNumber,isCollapsed:l.isCollapsed})),t,e)}test("getRegionAtLine",()=>{const t=E(["/**"," * Comment"," */","class A {","  void foo() {","    // comment {","  }","}"].join(`
`));try{const e=new R(t,new p(t)),l=A(t,!1,void 0);e.update(l);const s=n(1,3,!1),o=n(4,7,!1),i=n(5,6,!1);u(e,[s,o,i]),L(e.getRegionAtLine(1),s,"1"),L(e.getRegionAtLine(2),s,"2"),L(e.getRegionAtLine(3),s,"3"),L(e.getRegionAtLine(4),o,"4"),L(e.getRegionAtLine(5),i,"5"),L(e.getRegionAtLine(6),i,"5"),L(e.getRegionAtLine(7),o,"6"),L(e.getRegionAtLine(8),null,"7")}finally{t.dispose()}}),test("collapse",()=>{const t=E(["/**"," * Comment"," */","class A {","  void foo() {","    // comment {","  }","}"].join(`
`));try{const e=new R(t,new p(t)),l=A(t,!1,void 0);e.update(l);const s=n(1,3,!1),o=n(4,7,!1),i=n(5,6,!1);u(e,[s,o,i]),e.toggleCollapseState([e.getRegionAtLine(1)]),e.update(l),u(e,[n(1,3,!0),o,i]),e.toggleCollapseState([e.getRegionAtLine(5)]),e.update(l),u(e,[n(1,3,!0),o,n(5,6,!0)]),e.toggleCollapseState([e.getRegionAtLine(7)]),e.update(l),u(e,[n(1,3,!0),n(4,7,!0),n(5,6,!0)]),t.dispose()}finally{t.dispose()}}),test("update",()=>{const t=E(["/**"," * Comment"," */","class A {","  void foo() {","    // comment {","  }","}"].join(`
`));try{const e=new R(t,new p(t)),l=A(t,!1,void 0);e.update(l);const s=n(1,3,!1),o=n(4,7,!1),i=n(5,6,!1);u(e,[s,o,i]),e.toggleCollapseState([e.getRegionAtLine(2),e.getRegionAtLine(5)]),t.applyEdits([F.insert(new O(4,1),`//hello
`)]),e.update(A(t,!1,void 0)),u(e,[n(1,3,!0),n(5,8,!1),n(6,7,!0)])}finally{t.dispose()}}),test("delete",()=>{const t=E(["function foo() {","  switch (x) {","    case 1:","      //hello1","      break;","    case 2:","      //hello2","      break;","    case 3:","      //hello3","      break;","  }","}"].join(`
`));try{const e=new R(t,new p(t)),l=A(t,!1,void 0);e.update(l);const s=n(1,12,!1),o=n(2,11,!1),i=n(3,5,!1),r=n(6,8,!1),c=n(9,11,!1);u(e,[s,o,i,r,c]),e.toggleCollapseState([e.getRegionAtLine(6)]),t.applyEdits([F.delete(new V(6,11,9,0))]),e.update(A(t,!0,void 0),X([new W(7,1,7,1)])),u(e,[n(1,9,!1),n(2,8,!1),n(3,5,!1),n(6,8,!1)])}finally{t.dispose()}}),test("getRegionsInside",()=>{const t=E(["/**"," * Comment"," */","class A {","  void foo() {","    // comment {","  }","}"].join(`
`));try{const e=new R(t,new p(t)),l=A(t,!1,void 0);e.update(l);const s=n(1,3,!1),o=n(4,7,!1),i=n(5,6,!1);u(e,[s,o,i]);const r=e.getRegionAtLine(s.startLineNumber),c=e.getRegionAtLine(o.startLineNumber),w=e.getRegionAtLine(i.startLineNumber);m(e.getRegionsInside(null),[s,o,i],"1"),m(e.getRegionsInside(r),[],"2"),m(e.getRegionsInside(c),[i],"3"),m(e.getRegionsInside(w),[],"4")}finally{t.dispose()}}),test("getRegionsInsideWithLevel",()=>{const t=E(["//#region","//#endregion","class A {","  void foo() {","    if (true) {","        return;","    }","    if (true) {","      return;","    }","  }","}"].join(`
`));try{const e=new R(t,new p(t)),l=A(t,!1,{start:/^\/\/#region$/,end:/^\/\/#endregion$/});e.update(l);const s=n(1,2,!1),o=n(3,11,!1),i=n(4,10,!1),r=n(5,6,!1),c=n(8,9,!1),w=e.getRegionAtLine(s.startLineNumber),D=e.getRegionAtLine(o.startLineNumber),k=e.getRegionAtLine(i.startLineNumber);u(e,[s,o,i,r,c]),m(e.getRegionsInside(null,(b,M)=>M===1),[s,o],"1"),m(e.getRegionsInside(null,(b,M)=>M===2),[i],"2"),m(e.getRegionsInside(null,(b,M)=>M===3),[r,c],"3"),m(e.getRegionsInside(D,(b,M)=>M===1),[i],"4"),m(e.getRegionsInside(D,(b,M)=>M===2),[r,c],"5"),m(e.getRegionsInside(k,(b,M)=>M===1),[r,c],"6"),m(e.getRegionsInside(D,(b,M)=>b.hidesLine(9)),[i,c],"7"),m(e.getRegionsInside(w,(b,M)=>M===1),[],"8")}finally{t.dispose()}}),test("getRegionAtLine2",()=>{const t=E(["//#region","class A {","  void foo() {","    if (true) {","      //hello","    }","","  }","}","//#endregion",""].join(`
`));try{const e=new R(t,new p(t)),l=A(t,!1,{start:/^\/\/#region$/,end:/^\/\/#endregion$/});e.update(l);const s=n(1,10,!1),o=n(2,8,!1),i=n(3,7,!1),r=n(4,5,!1);u(e,[s,o,i,r]),m(e.getAllRegionsAtLine(1),[s],"1"),m(e.getAllRegionsAtLine(2),[s,o].reverse(),"2"),m(e.getAllRegionsAtLine(3),[s,o,i].reverse(),"3"),m(e.getAllRegionsAtLine(4),[s,o,i,r].reverse(),"4"),m(e.getAllRegionsAtLine(5),[s,o,i,r].reverse(),"5"),m(e.getAllRegionsAtLine(6),[s,o,i].reverse(),"6"),m(e.getAllRegionsAtLine(7),[s,o,i].reverse(),"7"),m(e.getAllRegionsAtLine(8),[s,o].reverse(),"8"),m(e.getAllRegionsAtLine(9),[s],"9"),m(e.getAllRegionsAtLine(10),[s],"10"),m(e.getAllRegionsAtLine(11),[],"10")}finally{t.dispose()}}),test("setCollapseStateRecursivly",()=>{const t=E(["//#region","//#endregion","class A {","  void foo() {","    if (true) {","        return;","    }","","    if (true) {","      return;","    }","  }","}"].join(`
`));try{const e=new R(t,new p(t)),l=A(t,!1,{start:/^\/\/#region$/,end:/^\/\/#endregion$/});e.update(l);const s=n(1,2,!1),o=n(3,12,!1),i=n(4,11,!1),r=n(5,6,!1),c=n(9,10,!1);u(e,[s,o,i,r,c]),y(e,!0,Number.MAX_VALUE,[4]),a(e,[i,r,c],"1"),y(e,!1,Number.MAX_VALUE,[8]),a(e,[],"2"),y(e,!0,Number.MAX_VALUE,[12]),a(e,[o,i,r,c],"1"),y(e,!1,Number.MAX_VALUE,[7]),a(e,[o],"1"),y(e,!1),a(e,[],"1"),y(e,!0),a(e,[s,o,i,r,c],"1")}finally{t.dispose()}}),test("setCollapseStateAtLevel",()=>{const t=E(["//#region","//#endregion","class A {","  void foo() {","    if (true) {","        return;","    }","","    if (true) {","      return;","    }","  }","  //#region","  const bar = 9;","  //#endregion","}"].join(`
`));try{const e=new R(t,new p(t)),l=A(t,!1,{start:/^\s*\/\/#region$/,end:/^\s*\/\/#endregion$/});e.update(l);const s=n(1,2,!1),o=n(3,15,!1),i=n(4,11,!1),r=n(5,6,!1),c=n(9,10,!1),w=n(13,15,!1);u(e,[s,o,i,r,c,w]),q(e,1,!0,[]),a(e,[s,o],"1"),q(e,1,!1,[5]),a(e,[o],"2"),q(e,1,!1,[1]),a(e,[],"3"),q(e,2,!0,[]),a(e,[i,w],"4"),q(e,2,!1,[5,6]),a(e,[i],"5"),q(e,3,!0,[4,9]),a(e,[i,r],"6"),q(e,3,!1,[4,9]),a(e,[i],"7")}finally{t.dispose()}}),test("setCollapseStateLevelsDown",()=>{const t=E(["//#region","//#endregion","class A {","  void foo() {","    if (true) {","        return;","    }","","    if (true) {","      return;","    }","  }","}"].join(`
`));try{const e=new R(t,new p(t)),l=A(t,!1,{start:/^\/\/#region$/,end:/^\/\/#endregion$/});e.update(l);const s=n(1,2,!1),o=n(3,12,!1),i=n(4,11,!1),r=n(5,6,!1),c=n(9,10,!1);u(e,[s,o,i,r,c]),y(e,!0,1,[4]),a(e,[i],"1"),y(e,!0,2,[4]),a(e,[i,r,c],"2"),y(e,!1,2,[3]),a(e,[r,c],"3"),y(e,!1,2,[2]),a(e,[r,c],"4"),y(e,!0,4,[2]),a(e,[s,r,c],"5"),y(e,!1,4,[2,3]),a(e,[],"6")}finally{t.dispose()}}),test("setCollapseStateLevelsUp",()=>{const t=E(["//#region","//#endregion","class A {","  void foo() {","    if (true) {","        return;","    }","","    if (true) {","      return;","    }","  }","}"].join(`
`));try{const e=new R(t,new p(t)),l=A(t,!1,{start:/^\/\/#region$/,end:/^\/\/#endregion$/});e.update(l);const s=n(1,2,!1),o=n(3,12,!1),i=n(4,11,!1),r=n(5,6,!1),c=n(9,10,!1);u(e,[s,o,i,r,c]),S(e,!0,1,[4]),a(e,[i],"1"),S(e,!0,2,[4]),a(e,[o,i],"2"),S(e,!1,4,[1,3,4]),a(e,[],"3"),S(e,!0,2,[10]),a(e,[i,c],"4")}finally{t.dispose()}}),test("setCollapseStateUp",()=>{const t=E(["//#region","//#endregion","class A {","  void foo() {","    if (true) {","        return;","    }","","    if (true) {","      return;","    }","  }","}"].join(`
`));try{const e=new R(t,new p(t)),l=A(t,!1,{start:/^\/\/#region$/,end:/^\/\/#endregion$/});e.update(l);const s=n(1,2,!1),o=n(3,12,!1),i=n(4,11,!1),r=n(5,6,!1),c=n(9,10,!1);u(e,[s,o,i,r,c]),$(e,!0,[5]),a(e,[r],"1"),$(e,!0,[5]),a(e,[i,r],"2"),$(e,!0,[4]),a(e,[o,i,r],"2")}finally{t.dispose()}}),test("setCollapseStateForMatchingLines",()=>{const t=E(["/**"," * the class"," */","class A {","  /**","   * the foo","   */","  void foo() {","    /*","     * the comment","     */","  }","}"].join(`
`));try{const e=new R(t,new p(t)),l=A(t,!1,{start:/^\/\/#region$/,end:/^\/\/#endregion$/});e.update(l);const s=n(1,3,!1),o=n(4,12,!1),i=n(5,7,!1),r=n(8,11,!1),c=n(9,11,!1);u(e,[s,o,i,r,c]);const w=new RegExp("^\\s*"+T("/*"));G(e,w,!0),a(e,[s,i,c],"1")}finally{t.dispose()}}),test("setCollapseStateForRest",()=>{const t=E(["//#region","//#endregion","class A {","  void foo() {","    if (true) {","        return;","    }","","    if (true) {","      return;","    }","  }","}"].join(`
`));try{const e=new R(t,new p(t)),l=A(t,!1,{start:/^\/\/#region$/,end:/^\/\/#endregion$/});e.update(l);const s=n(1,2,!1),o=n(3,12,!1),i=n(4,11,!1),r=n(5,6,!1),c=n(9,10,!1);u(e,[s,o,i,r,c]),N(e,!0,[5]),a(e,[s,c],"1"),N(e,!1,[5]),a(e,[],"2"),N(e,!0,[1]),a(e,[o,i,r,c],"3"),N(e,!0,[3]),a(e,[s,o,i,r,c],"3")}finally{t.dispose()}}),test("folding decoration",()=>{const t=E(["class A {","  void foo() {","    if (true) {","      hoo();","    }","  }","}"].join(`
`));try{const e=new R(t,new p(t)),l=A(t,!1,void 0);e.update(l);const s=n(1,6,!1),o=n(2,5,!1),i=n(3,4,!1);u(e,[s,o,i]),v(e,[f(1,"expanded"),f(2,"expanded"),f(3,"expanded")]),e.toggleCollapseState([e.getRegionAtLine(2)]),u(e,[s,n(2,5,!0),i]),v(e,[f(1,"expanded"),f(2,"collapsed"),f(3,"hidden")]),e.update(l),u(e,[s,n(2,5,!0),i]),v(e,[f(1,"expanded"),f(2,"collapsed"),f(3,"hidden")]),e.toggleCollapseState([e.getRegionAtLine(1)]),u(e,[n(1,6,!0),n(2,5,!0),i]),v(e,[f(1,"collapsed"),f(2,"hidden"),f(3,"hidden")]),e.update(l),u(e,[n(1,6,!0),n(2,5,!0),i]),v(e,[f(1,"collapsed"),f(2,"hidden"),f(3,"hidden")]),e.toggleCollapseState([e.getRegionAtLine(1),e.getRegionAtLine(3)]),u(e,[s,n(2,5,!0),n(3,4,!0)]),v(e,[f(1,"expanded"),f(2,"collapsed"),f(3,"hidden")]),e.update(l),u(e,[s,n(2,5,!0),n(3,4,!0)]),v(e,[f(1,"expanded"),f(2,"collapsed"),f(3,"hidden")]),t.dispose()}finally{t.dispose()}}),test("fold jumping",()=>{const t=E(["class A {","  void foo() {","    if (1) {","      a();","    } else if (2) {","      if (true) {","        b();","      }","    } else {","      c();","    }","  }","}"].join(`
`));try{const e=new R(t,new p(t)),l=A(t,!1,void 0);e.update(l);const s=n(1,12,!1),o=n(2,11,!1),i=n(3,4,!1),r=n(5,8,!1),c=n(6,7,!1),w=n(9,10,!1);u(e,[s,o,i,r,c,w]),d.strictEqual(C(7,e),6),d.strictEqual(C(6,e),5),d.strictEqual(C(5,e),2),d.strictEqual(C(2,e),1),d.strictEqual(C(1,e),null),d.strictEqual(h(10,e),9),d.strictEqual(h(9,e),5),d.strictEqual(h(5,e),3),d.strictEqual(h(3,e),null),d.strictEqual(h(4,e),3),d.strictEqual(h(7,e),6),d.strictEqual(h(8,e),6),d.strictEqual(x(3,e),5),d.strictEqual(x(5,e),9),d.strictEqual(x(9,e),null),d.strictEqual(x(4,e),5),d.strictEqual(x(7,e),9),d.strictEqual(x(8,e),9)}finally{t.dispose()}}),test("fold jumping issue #129503",()=>{const t=E(["","if True:","  print(1)","if True:","  print(1)",""].join(`
`));try{const e=new R(t,new p(t)),l=A(t,!1,void 0);e.update(l);const s=n(2,3,!1),o=n(4,6,!1);u(e,[s,o]),d.strictEqual(x(1,e),2),d.strictEqual(x(2,e),4),d.strictEqual(x(3,e),4),d.strictEqual(x(4,e),null),d.strictEqual(x(5,e),null),d.strictEqual(x(6,e),null),d.strictEqual(h(1,e),null),d.strictEqual(h(2,e),null),d.strictEqual(h(3,e),2),d.strictEqual(h(4,e),2),d.strictEqual(h(5,e),4),d.strictEqual(h(6,e),4)}finally{t.dispose()}})});export{p as TestDecorationProvider};
