import{onUnexpectedError as b}from"../../../../base/common/errors.js";import{Emitter as w}from"../../../../base/common/event.js";import"../../../../base/common/filters.js";import{defaultGenerator as I}from"../../../../base/common/idGenerator.js";import{dispose as d}from"../../../../base/common/lifecycle.js";import{ResourceMap as y}from"../../../../base/common/map.js";import{basename as a,extUri as p}from"../../../../base/common/resources.js";import*as L from"../../../../base/common/strings.js";import{Constants as x}from"../../../../base/common/uint.js";import"../../../../base/common/uri.js";import"../../../common/core/position.js";import{Range as l}from"../../../common/core/range.js";import"../../../common/languages.js";import"../../../common/services/resolverService.js";import{localize as o}from"../../../../nls.js";class P{constructor(r,t,n,e){this.isProviderFirst=r;this.parent=t;this.link=n;this._rangeCallback=e}id=I.nextId();_range;get uri(){return this.link.uri}get range(){return this._range??this.link.targetSelectionRange??this.link.range}set range(r){this._range=r,this._rangeCallback(this)}get ariaMessage(){const r=this.parent.getPreview(this)?.preview(this.range);return r?o({key:"aria.oneReference.preview",comment:["Placeholders are: 0: filename, 1:line number, 2: column number, 3: preview snippet of source code"]},"{0} in {1} on line {2} at column {3}",r.value,a(this.uri),this.range.startLineNumber,this.range.startColumn):o("aria.oneReference","in {0} on line {1} at column {2}",a(this.uri),this.range.startLineNumber,this.range.startColumn)}}class C{constructor(r){this._modelReference=r}dispose(){this._modelReference.dispose()}preview(r,t=8){const n=this._modelReference.object.textEditorModel;if(!n)return;const{startLineNumber:e,startColumn:i,endLineNumber:s,endColumn:f}=r,m=n.getWordUntilPosition({lineNumber:e,column:i-t}),R=new l(e,m.startColumn,e,i),v=new l(s,f,s,x.MAX_SAFE_SMALL_INTEGER),u=n.getValueInRange(R).replace(/^\s+/,""),g=n.getValueInRange(r),_=n.getValueInRange(v).replace(/\s+$/,"");return{value:u+g+_,highlight:{start:u.length,end:u.length+g.length}}}}class M{constructor(r,t){this.parent=r;this.uri=t}children=[];_previews=new y;dispose(){d(this._previews.values()),this._previews.clear()}getPreview(r){return this._previews.get(r.uri)}get ariaMessage(){const r=this.children.length;return r===1?o("aria.fileReferences.1","1 symbol in {0}, full path {1}",a(this.uri),this.uri.fsPath):o("aria.fileReferences.N","{0} symbols in {1}, full path {2}",r,a(this.uri),this.uri.fsPath)}async resolve(r){if(this._previews.size!==0)return this;for(const t of this.children)if(!this._previews.has(t.uri))try{const n=await r.createModelReference(t.uri);this._previews.set(t.uri,new C(n))}catch(n){b(n)}return this}}class c{_links;_title;groups=[];references=[];_onDidChangeReferenceRange=new w;onDidChangeReferenceRange=this._onDidChangeReferenceRange.event;constructor(r,t){this._links=r,this._title=t;const[n]=r;r.sort(c._compareReferences);let e;for(const i of r)if((!e||!p.isEqual(e.uri,i.uri,!0))&&(e=new M(this,i.uri),this.groups.push(e)),e.children.length===0||c._compareReferences(i,e.children[e.children.length-1])!==0){const s=new P(n===i,e,i,f=>this._onDidChangeReferenceRange.fire(f));this.references.push(s),e.children.push(s)}}dispose(){d(this.groups),this._onDidChangeReferenceRange.dispose(),this.groups.length=0}clone(){return new c(this._links,this._title)}get title(){return this._title}get isEmpty(){return this.groups.length===0}get ariaMessage(){return this.isEmpty?o("aria.result.0","No results found"):this.references.length===1?o("aria.result.1","Found 1 symbol in {0}",this.references[0].uri.fsPath):this.groups.length===1?o("aria.result.n1","Found {0} symbols in {1}",this.references.length,this.groups[0].uri.fsPath):o("aria.result.nm","Found {0} symbols in {1} files",this.references.length,this.groups.length)}nextOrPreviousReference(r,t){const{parent:n}=r;let e=n.children.indexOf(r);const i=n.children.length,s=n.parent.groups.length;return s===1||t&&e+1<i||!t&&e>0?(t?e=(e+1)%i:e=(e+i-1)%i,n.children[e]):(e=n.parent.groups.indexOf(n),t?(e=(e+1)%s,n.parent.groups[e].children[0]):(e=(e+s-1)%s,n.parent.groups[e].children[n.parent.groups[e].children.length-1]))}nearestReference(r,t){const n=this.references.map((e,i)=>({idx:i,prefixLen:L.commonPrefixLength(e.uri.toString(),r.toString()),offsetDist:Math.abs(e.range.startLineNumber-t.lineNumber)*100+Math.abs(e.range.startColumn-t.column)})).sort((e,i)=>e.prefixLen>i.prefixLen?-1:e.prefixLen<i.prefixLen?1:e.offsetDist<i.offsetDist?-1:e.offsetDist>i.offsetDist?1:0)[0];if(n)return this.references[n.idx]}referenceAt(r,t){for(const n of this.references)if(n.uri.toString()===r.toString()&&l.containsPosition(n.range,t))return n}firstReference(){for(const r of this.references)if(r.isProviderFirst)return r;return this.references[0]}static _compareReferences(r,t){return p.compare(r.uri,t.uri)||l.compareRangesUsingStarts(r.range,t.range)}}export{C as FilePreview,M as FileReferences,P as OneReference,c as ReferencesModel};
