import{coalesce as F}from"../../../../base/common/arrays.js";import{CancellationToken as c}from"../../../../base/common/cancellation.js";import{onUnexpectedExternalError as I}from"../../../../base/common/errors.js";import{matchesSomeScheme as R,Schemas as P}from"../../../../base/common/network.js";import{registerModelAndPositionCommand as u}from"../../../browser/editorExtensions.js";import"../../../common/core/position.js";import"../../../common/languageFeatureRegistry.js";import"../../../common/languages.js";import"../../../common/model.js";import{ILanguageFeaturesService as l}from"../../../common/services/languageFeatures.js";import{ReferencesModel as _}from"./referencesModel.js";function L(e,o){return o.uri.scheme===e.uri.scheme?!0:!R(o.uri,P.walkThroughSnippet,P.vscodeChatCodeBlock,P.vscodeChatCodeCompareBlock)}async function g(e,o,r,n,i){const a=r.ordered(e,n).map(m=>Promise.resolve(i(m,e,o)).then(void 0,f=>{I(f)})),t=await Promise.all(a);return F(t.flat()).filter(m=>L(e,m))}function k(e,o,r,n,i){return g(o,r,e,n,(s,a,t)=>s.provideDefinition(a,t,i))}function x(e,o,r,n,i){return g(o,r,e,n,(s,a,t)=>s.provideDeclaration(a,t,i))}function T(e,o,r,n,i){return g(o,r,e,n,(s,a,t)=>s.provideImplementation(a,t,i))}function D(e,o,r,n,i){return g(o,r,e,n,(s,a,t)=>s.provideTypeDefinition(a,t,i))}function y(e,o,r,n,i,s){return g(o,r,e,i,async(a,t,m)=>{const f=(await a.provideReferences(t,m,{includeDeclaration:!0},s))?.filter(p=>L(t,p));if(!n||!f||f.length!==2)return f;const v=(await a.provideReferences(t,m,{includeDeclaration:!1},s))?.filter(p=>L(t,p));return v&&v.length===1?v:f})}async function d(e){const o=await e(),r=new _(o,""),n=r.references.map(i=>i.link);return r.dispose(),n}u("_executeDefinitionProvider",(e,o,r)=>{const n=e.get(l),i=k(n.definitionProvider,o,r,!1,c.None);return d(()=>i)}),u("_executeDefinitionProvider_recursive",(e,o,r)=>{const n=e.get(l),i=k(n.definitionProvider,o,r,!0,c.None);return d(()=>i)}),u("_executeTypeDefinitionProvider",(e,o,r)=>{const n=e.get(l),i=D(n.typeDefinitionProvider,o,r,!1,c.None);return d(()=>i)}),u("_executeTypeDefinitionProvider_recursive",(e,o,r)=>{const n=e.get(l),i=D(n.typeDefinitionProvider,o,r,!0,c.None);return d(()=>i)}),u("_executeDeclarationProvider",(e,o,r)=>{const n=e.get(l),i=x(n.declarationProvider,o,r,!1,c.None);return d(()=>i)}),u("_executeDeclarationProvider_recursive",(e,o,r)=>{const n=e.get(l),i=x(n.declarationProvider,o,r,!0,c.None);return d(()=>i)}),u("_executeReferenceProvider",(e,o,r)=>{const n=e.get(l),i=y(n.referenceProvider,o,r,!1,!1,c.None);return d(()=>i)}),u("_executeReferenceProvider_recursive",(e,o,r)=>{const n=e.get(l),i=y(n.referenceProvider,o,r,!1,!0,c.None);return d(()=>i)}),u("_executeImplementationProvider",(e,o,r)=>{const n=e.get(l),i=T(n.implementationProvider,o,r,!1,c.None);return d(()=>i)}),u("_executeImplementationProvider_recursive",(e,o,r)=>{const n=e.get(l),i=T(n.implementationProvider,o,r,!0,c.None);return d(()=>i)});export{x as getDeclarationsAtPosition,k as getDefinitionsAtPosition,T as getImplementationsAtPosition,y as getReferencesAtPosition,D as getTypeDefinitionsAtPosition};
