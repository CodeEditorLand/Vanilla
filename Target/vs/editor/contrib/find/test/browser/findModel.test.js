import n from"assert";import{DisposableStore as E}from"../../../../../base/common/lifecycle.js";import{ensureNoDisposablesAreLeakedInTestSuite as q}from"../../../../../base/test/common/utils.js";import{CoreNavigationCommands as p}from"../../../../browser/coreCommands.js";import"../../../../browser/editorBrowser.js";import{Position as w}from"../../../../common/core/position.js";import{Range as u}from"../../../../common/core/range.js";import{Selection as h}from"../../../../common/core/selection.js";import{PieceTreeTextBufferBuilder as S}from"../../../../common/model/pieceTreeTextBuffer/pieceTreeTextBufferBuilder.js";import{FindModelBoundToEditorModel as c}from"../../browser/findModel.js";import{FindReplaceState as i}from"../../browser/findState.js";import{withTestCodeEditor as M}from"../../../../test/browser/testCodeEditor.js";suite("FindModel",()=>{let o;setup(()=>{o=new E}),teardown(()=>{o.dispose()}),q();function s(e,t){test(e,()=>{const a=["// my cool header",'#include "cool.h"',"#include <iostream>","","int main() {",'    cout << "hello world, Hello!" << endl;','    cout << "hello world again" << endl;','    cout << "Hello world again" << endl;','    cout << "helloworld again" << endl;',"}","// blablablaciao",""];M(a,{},m=>t(m));const r=a.join(`
`),d=new S;d.acceptChunk(r.substr(0,94)),d.acceptChunk(r.substr(94,101)),d.acceptChunk(r.substr(195,59));const g=d.finish();M(g,{},m=>t(m))})}function f(e){return[e.startLineNumber,e.startColumn,e.endLineNumber,e.endColumn]}function v(e){const t=e.getModel(),a=[],r=[];for(const d of t.getAllDecorations())d.options.className==="currentFindMatch"?(a.push(d.range),r.push(d.range)):d.options.className==="findMatch"&&r.push(d.range);return a.sort(u.compareRangesUsingStarts),r.sort(u.compareRangesUsingStarts),{highlighted:a.map(f),findDecorations:r.map(f)}}function l(e,t,a,r){n.deepStrictEqual(f(e.getSelection()),t,"cursor");const d={highlighted:a?[a]:[],findDecorations:r};n.deepStrictEqual(v(e),d,"state")}s("incremental find from beginning of file",e=>{e.setPosition({lineNumber:1,column:1});const t=o.add(new i),a=o.add(new c(e,t));t.change({searchString:"H"},!0),l(e,[1,12,1,13],[1,12,1,13],[[1,12,1,13],[2,16,2,17],[6,14,6,15],[6,27,6,28],[7,14,7,15],[8,14,8,15],[9,14,9,15]]),t.change({searchString:"He"},!0),l(e,[1,12,1,14],[1,12,1,14],[[1,12,1,14],[6,14,6,16],[6,27,6,29],[7,14,7,16],[8,14,8,16],[9,14,9,16]]),t.change({searchString:"Hello"},!0),l(e,[6,14,6,19],[6,14,6,19],[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19],[9,14,9,19]]),t.change({matchCase:!0},!0),l(e,[6,27,6,32],[6,27,6,32],[[6,27,6,32],[8,14,8,19]]),t.change({searchString:"hello"},!0),l(e,[6,14,6,19],[6,14,6,19],[[6,14,6,19],[7,14,7,19],[9,14,9,19]]),t.change({wholeWord:!0},!0),l(e,[6,14,6,19],[6,14,6,19],[[6,14,6,19],[7,14,7,19]]),t.change({matchCase:!1},!0),l(e,[6,14,6,19],[6,14,6,19],[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),t.change({wholeWord:!1},!0),l(e,[6,14,6,19],[6,14,6,19],[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19],[9,14,9,19]]),t.change({searchScope:[new u(8,1,10,1)]},!0),l(e,[8,14,8,19],[8,14,8,19],[[8,14,8,19],[9,14,9,19]]),t.change({searchScope:null},!0),l(e,[6,14,6,19],[6,14,6,19],[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19],[9,14,9,19]]),a.dispose(),t.dispose()}),s("find model removes its decorations",e=>{const t=o.add(new i);t.change({searchString:"hello"},!1);const a=o.add(new c(e,t));n.strictEqual(t.matchesCount,5),l(e,[1,1,1,1],null,[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19],[9,14,9,19]]),a.dispose(),t.dispose(),l(e,[1,1,1,1],null,[])}),s("find model updates state matchesCount",e=>{const t=o.add(new i);t.change({searchString:"hello"},!1);const a=o.add(new c(e,t));n.strictEqual(t.matchesCount,5),l(e,[1,1,1,1],null,[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19],[9,14,9,19]]),t.change({searchString:"helloo"},!1),n.strictEqual(t.matchesCount,0),l(e,[1,1,1,1],null,[]),a.dispose(),t.dispose()}),s("find model reacts to position change",e=>{const t=o.add(new i);t.change({searchString:"hello"},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19],[9,14,9,19]]),e.trigger("mouse",p.MoveTo.id,{position:new w(6,20)}),l(e,[6,20,6,20],null,[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19],[9,14,9,19]]),t.change({searchString:"Hello"},!0),l(e,[6,27,6,32],[6,27,6,32],[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19],[9,14,9,19]]),a.dispose(),t.dispose()}),s("find model next",e=>{const t=o.add(new i);t.change({searchString:"hello",wholeWord:!0},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),a.moveToNextMatch(),l(e,[6,14,6,19],[6,14,6,19],[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),a.moveToNextMatch(),l(e,[6,27,6,32],[6,27,6,32],[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),a.moveToNextMatch(),l(e,[7,14,7,19],[7,14,7,19],[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),a.moveToNextMatch(),l(e,[8,14,8,19],[8,14,8,19],[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),a.moveToNextMatch(),l(e,[6,14,6,19],[6,14,6,19],[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),a.dispose(),t.dispose()}),s("find model next stays in scope",e=>{const t=o.add(new i);t.change({searchString:"hello",wholeWord:!0,searchScope:[new u(7,1,9,1)]},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[7,14,7,19],[8,14,8,19]]),a.moveToNextMatch(),l(e,[7,14,7,19],[7,14,7,19],[[7,14,7,19],[8,14,8,19]]),a.moveToNextMatch(),l(e,[8,14,8,19],[8,14,8,19],[[7,14,7,19],[8,14,8,19]]),a.moveToNextMatch(),l(e,[7,14,7,19],[7,14,7,19],[[7,14,7,19],[8,14,8,19]]),a.dispose(),t.dispose()}),s("multi-selection find model next stays in scope (overlap)",e=>{const t=o.add(new i);t.change({searchString:"hello",wholeWord:!0,searchScope:[new u(7,1,8,2),new u(8,1,9,1)]},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[7,14,7,19],[8,14,8,19]]),a.moveToNextMatch(),l(e,[7,14,7,19],[7,14,7,19],[[7,14,7,19],[8,14,8,19]]),a.moveToNextMatch(),l(e,[8,14,8,19],[8,14,8,19],[[7,14,7,19],[8,14,8,19]]),a.moveToNextMatch(),l(e,[7,14,7,19],[7,14,7,19],[[7,14,7,19],[8,14,8,19]]),a.dispose(),t.dispose()}),s("multi-selection find model next stays in scope",e=>{const t=o.add(new i);t.change({searchString:"hello",matchCase:!0,wholeWord:!1,searchScope:[new u(6,1,7,38),new u(9,3,9,38)]},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[6,14,6,19],[7,14,7,19],[9,14,9,19]]),a.moveToNextMatch(),l(e,[6,14,6,19],[6,14,6,19],[[6,14,6,19],[7,14,7,19],[9,14,9,19]]),a.moveToNextMatch(),l(e,[7,14,7,19],[7,14,7,19],[[6,14,6,19],[7,14,7,19],[9,14,9,19]]),a.moveToNextMatch(),l(e,[9,14,9,19],[9,14,9,19],[[6,14,6,19],[7,14,7,19],[9,14,9,19]]),a.moveToNextMatch(),l(e,[6,14,6,19],[6,14,6,19],[[6,14,6,19],[7,14,7,19],[9,14,9,19]]),a.dispose(),t.dispose()}),s("find model prev",e=>{const t=o.add(new i);t.change({searchString:"hello",wholeWord:!0},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),a.moveToPrevMatch(),l(e,[8,14,8,19],[8,14,8,19],[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),a.moveToPrevMatch(),l(e,[7,14,7,19],[7,14,7,19],[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),a.moveToPrevMatch(),l(e,[6,27,6,32],[6,27,6,32],[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),a.moveToPrevMatch(),l(e,[6,14,6,19],[6,14,6,19],[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),a.moveToPrevMatch(),l(e,[8,14,8,19],[8,14,8,19],[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),a.dispose(),t.dispose()}),s("find model prev stays in scope",e=>{const t=o.add(new i);t.change({searchString:"hello",wholeWord:!0,searchScope:[new u(7,1,9,1)]},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[7,14,7,19],[8,14,8,19]]),a.moveToPrevMatch(),l(e,[8,14,8,19],[8,14,8,19],[[7,14,7,19],[8,14,8,19]]),a.moveToPrevMatch(),l(e,[7,14,7,19],[7,14,7,19],[[7,14,7,19],[8,14,8,19]]),a.moveToPrevMatch(),l(e,[8,14,8,19],[8,14,8,19],[[7,14,7,19],[8,14,8,19]]),a.dispose(),t.dispose()}),s("find model next/prev with no matches",e=>{const t=o.add(new i);t.change({searchString:"helloo",wholeWord:!0},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[]),a.moveToNextMatch(),l(e,[1,1,1,1],null,[]),a.moveToPrevMatch(),l(e,[1,1,1,1],null,[]),a.dispose(),t.dispose()}),s("find model next/prev respects cursor position",e=>{const t=o.add(new i);t.change({searchString:"hello",wholeWord:!0},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),e.trigger("mouse",p.MoveTo.id,{position:new w(6,20)}),l(e,[6,20,6,20],null,[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),a.moveToNextMatch(),l(e,[6,27,6,32],[6,27,6,32],[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),a.dispose(),t.dispose()}),s("find ^",e=>{const t=o.add(new i);t.change({searchString:"^",isRegex:!0},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[1,1,1,1],[2,1,2,1],[3,1,3,1],[4,1,4,1],[5,1,5,1],[6,1,6,1],[7,1,7,1],[8,1,8,1],[9,1,9,1],[10,1,10,1],[11,1,11,1],[12,1,12,1]]),a.moveToNextMatch(),l(e,[2,1,2,1],[2,1,2,1],[[1,1,1,1],[2,1,2,1],[3,1,3,1],[4,1,4,1],[5,1,5,1],[6,1,6,1],[7,1,7,1],[8,1,8,1],[9,1,9,1],[10,1,10,1],[11,1,11,1],[12,1,12,1]]),a.moveToNextMatch(),l(e,[3,1,3,1],[3,1,3,1],[[1,1,1,1],[2,1,2,1],[3,1,3,1],[4,1,4,1],[5,1,5,1],[6,1,6,1],[7,1,7,1],[8,1,8,1],[9,1,9,1],[10,1,10,1],[11,1,11,1],[12,1,12,1]]),a.dispose(),t.dispose()}),s("find $",e=>{const t=o.add(new i);t.change({searchString:"$",isRegex:!0},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[1,18,1,18],[2,18,2,18],[3,20,3,20],[4,1,4,1],[5,13,5,13],[6,43,6,43],[7,41,7,41],[8,41,8,41],[9,40,9,40],[10,2,10,2],[11,17,11,17],[12,1,12,1]]),a.moveToNextMatch(),l(e,[1,18,1,18],[1,18,1,18],[[1,18,1,18],[2,18,2,18],[3,20,3,20],[4,1,4,1],[5,13,5,13],[6,43,6,43],[7,41,7,41],[8,41,8,41],[9,40,9,40],[10,2,10,2],[11,17,11,17],[12,1,12,1]]),a.moveToNextMatch(),l(e,[2,18,2,18],[2,18,2,18],[[1,18,1,18],[2,18,2,18],[3,20,3,20],[4,1,4,1],[5,13,5,13],[6,43,6,43],[7,41,7,41],[8,41,8,41],[9,40,9,40],[10,2,10,2],[11,17,11,17],[12,1,12,1]]),a.moveToNextMatch(),l(e,[3,20,3,20],[3,20,3,20],[[1,18,1,18],[2,18,2,18],[3,20,3,20],[4,1,4,1],[5,13,5,13],[6,43,6,43],[7,41,7,41],[8,41,8,41],[9,40,9,40],[10,2,10,2],[11,17,11,17],[12,1,12,1]]),a.dispose(),t.dispose()}),s("find next ^$",e=>{const t=o.add(new i);t.change({searchString:"^$",isRegex:!0},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[4,1,4,1],[12,1,12,1]]),a.moveToNextMatch(),l(e,[4,1,4,1],[4,1,4,1],[[4,1,4,1],[12,1,12,1]]),a.moveToNextMatch(),l(e,[12,1,12,1],[12,1,12,1],[[4,1,4,1],[12,1,12,1]]),a.moveToNextMatch(),l(e,[4,1,4,1],[4,1,4,1],[[4,1,4,1],[12,1,12,1]]),a.dispose(),t.dispose()}),s("find .*",e=>{const t=o.add(new i);t.change({searchString:".*",isRegex:!0},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[1,1,1,18],[2,1,2,18],[3,1,3,20],[4,1,4,1],[5,1,5,13],[6,1,6,43],[7,1,7,41],[8,1,8,41],[9,1,9,40],[10,1,10,2],[11,1,11,17],[12,1,12,1]]),a.dispose(),t.dispose()}),s("find next ^.*$",e=>{const t=o.add(new i);t.change({searchString:"^.*$",isRegex:!0},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[1,1,1,18],[2,1,2,18],[3,1,3,20],[4,1,4,1],[5,1,5,13],[6,1,6,43],[7,1,7,41],[8,1,8,41],[9,1,9,40],[10,1,10,2],[11,1,11,17],[12,1,12,1]]),a.moveToNextMatch(),l(e,[1,1,1,18],[1,1,1,18],[[1,1,1,18],[2,1,2,18],[3,1,3,20],[4,1,4,1],[5,1,5,13],[6,1,6,43],[7,1,7,41],[8,1,8,41],[9,1,9,40],[10,1,10,2],[11,1,11,17],[12,1,12,1]]),a.moveToNextMatch(),l(e,[2,1,2,18],[2,1,2,18],[[1,1,1,18],[2,1,2,18],[3,1,3,20],[4,1,4,1],[5,1,5,13],[6,1,6,43],[7,1,7,41],[8,1,8,41],[9,1,9,40],[10,1,10,2],[11,1,11,17],[12,1,12,1]]),a.dispose(),t.dispose()}),s("find prev ^.*$",e=>{const t=o.add(new i);t.change({searchString:"^.*$",isRegex:!0},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[1,1,1,18],[2,1,2,18],[3,1,3,20],[4,1,4,1],[5,1,5,13],[6,1,6,43],[7,1,7,41],[8,1,8,41],[9,1,9,40],[10,1,10,2],[11,1,11,17],[12,1,12,1]]),a.moveToPrevMatch(),l(e,[12,1,12,1],[12,1,12,1],[[1,1,1,18],[2,1,2,18],[3,1,3,20],[4,1,4,1],[5,1,5,13],[6,1,6,43],[7,1,7,41],[8,1,8,41],[9,1,9,40],[10,1,10,2],[11,1,11,17],[12,1,12,1]]),a.moveToPrevMatch(),l(e,[11,1,11,17],[11,1,11,17],[[1,1,1,18],[2,1,2,18],[3,1,3,20],[4,1,4,1],[5,1,5,13],[6,1,6,43],[7,1,7,41],[8,1,8,41],[9,1,9,40],[10,1,10,2],[11,1,11,17],[12,1,12,1]]),a.dispose(),t.dispose()}),s("find prev ^$",e=>{const t=o.add(new i);t.change({searchString:"^$",isRegex:!0},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[4,1,4,1],[12,1,12,1]]),a.moveToPrevMatch(),l(e,[12,1,12,1],[12,1,12,1],[[4,1,4,1],[12,1,12,1]]),a.moveToPrevMatch(),l(e,[4,1,4,1],[4,1,4,1],[[4,1,4,1],[12,1,12,1]]),a.moveToPrevMatch(),l(e,[12,1,12,1],[12,1,12,1],[[4,1,4,1],[12,1,12,1]]),a.dispose(),t.dispose()}),s("replace hello",e=>{const t=o.add(new i);t.change({searchString:"hello",replaceString:"hi",wholeWord:!0},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),e.trigger("mouse",p.MoveTo.id,{position:new w(6,20)}),l(e,[6,20,6,20],null,[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),n.strictEqual(e.getModel().getLineContent(6),'    cout << "hello world, Hello!" << endl;'),a.replace(),l(e,[6,27,6,32],[6,27,6,32],[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),n.strictEqual(e.getModel().getLineContent(6),'    cout << "hello world, Hello!" << endl;'),a.replace(),l(e,[7,14,7,19],[7,14,7,19],[[6,14,6,19],[7,14,7,19],[8,14,8,19]]),n.strictEqual(e.getModel().getLineContent(6),'    cout << "hello world, hi!" << endl;'),a.replace(),l(e,[8,14,8,19],[8,14,8,19],[[6,14,6,19],[8,14,8,19]]),n.strictEqual(e.getModel().getLineContent(7),'    cout << "hi world again" << endl;'),a.replace(),l(e,[6,14,6,19],[6,14,6,19],[[6,14,6,19]]),n.strictEqual(e.getModel().getLineContent(8),'    cout << "hi world again" << endl;'),a.replace(),l(e,[6,16,6,16],null,[]),n.strictEqual(e.getModel().getLineContent(6),'    cout << "hi world, hi!" << endl;'),a.dispose(),t.dispose()}),s("replace bla",e=>{const t=o.add(new i);t.change({searchString:"bla",replaceString:"ciao"},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[11,4,11,7],[11,7,11,10],[11,10,11,13]]),a.replace(),l(e,[11,4,11,7],[11,4,11,7],[[11,4,11,7],[11,7,11,10],[11,10,11,13]]),n.strictEqual(e.getModel().getLineContent(11),"// blablablaciao"),a.replace(),l(e,[11,8,11,11],[11,8,11,11],[[11,8,11,11],[11,11,11,14]]),n.strictEqual(e.getModel().getLineContent(11),"// ciaoblablaciao"),a.replace(),l(e,[11,12,11,15],[11,12,11,15],[[11,12,11,15]]),n.strictEqual(e.getModel().getLineContent(11),"// ciaociaoblaciao"),a.replace(),l(e,[11,16,11,16],null,[]),n.strictEqual(e.getModel().getLineContent(11),"// ciaociaociaociao"),a.dispose(),t.dispose()}),s("replaceAll hello",e=>{const t=o.add(new i);t.change({searchString:"hello",replaceString:"hi",wholeWord:!0},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),e.trigger("mouse",p.MoveTo.id,{position:new w(6,20)}),l(e,[6,20,6,20],null,[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),n.strictEqual(e.getModel().getLineContent(6),'    cout << "hello world, Hello!" << endl;'),a.replaceAll(),l(e,[6,17,6,17],null,[]),n.strictEqual(e.getModel().getLineContent(6),'    cout << "hi world, hi!" << endl;'),n.strictEqual(e.getModel().getLineContent(7),'    cout << "hi world again" << endl;'),n.strictEqual(e.getModel().getLineContent(8),'    cout << "hi world again" << endl;'),a.dispose(),t.dispose()}),s("replaceAll two spaces with one space",e=>{const t=o.add(new i);t.change({searchString:"  ",replaceString:" "},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[6,1,6,3],[6,3,6,5],[7,1,7,3],[7,3,7,5],[8,1,8,3],[8,3,8,5],[9,1,9,3],[9,3,9,5]]),a.replaceAll(),l(e,[1,1,1,1],null,[[6,1,6,3],[7,1,7,3],[8,1,8,3],[9,1,9,3]]),n.strictEqual(e.getModel().getLineContent(6),'  cout << "hello world, Hello!" << endl;'),n.strictEqual(e.getModel().getLineContent(7),'  cout << "hello world again" << endl;'),n.strictEqual(e.getModel().getLineContent(8),'  cout << "Hello world again" << endl;'),n.strictEqual(e.getModel().getLineContent(9),'  cout << "helloworld again" << endl;'),a.dispose(),t.dispose()}),s("replaceAll bla",e=>{const t=o.add(new i);t.change({searchString:"bla",replaceString:"ciao"},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[11,4,11,7],[11,7,11,10],[11,10,11,13]]),a.replaceAll(),l(e,[1,1,1,1],null,[]),n.strictEqual(e.getModel().getLineContent(11),"// ciaociaociaociao"),a.dispose(),t.dispose()}),s("replaceAll bla with \\t\\n",e=>{const t=o.add(new i);t.change({searchString:"bla",replaceString:"<\\n\\t>",isRegex:!0},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[11,4,11,7],[11,7,11,10],[11,10,11,13]]),a.replaceAll(),l(e,[1,1,1,1],null,[]),n.strictEqual(e.getModel().getLineContent(11),"// <"),n.strictEqual(e.getModel().getLineContent(12),"	><"),n.strictEqual(e.getModel().getLineContent(13),"	><"),n.strictEqual(e.getModel().getLineContent(14),"	>ciao"),a.dispose(),t.dispose()}),s('issue #3516: "replace all" moves page/cursor/focus/scroll to the place of the last replacement',e=>{const t=o.add(new i);t.change({searchString:"include",replaceString:"bar"},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[2,2,2,9],[3,2,3,9]]),a.replaceAll(),l(e,[1,1,1,1],null,[]),n.strictEqual(e.getModel().getLineContent(2),'#bar "cool.h"'),n.strictEqual(e.getModel().getLineContent(3),"#bar <iostream>"),a.dispose(),t.dispose()}),s("listens to model content changes",e=>{const t=o.add(new i);t.change({searchString:"hello",replaceString:"hi",wholeWord:!0},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),e.getModel().setValue(`hello
hi`),l(e,[1,1,1,1],null,[]),a.dispose(),t.dispose()}),s("selectAllMatches",e=>{const t=o.add(new i);t.change({searchString:"hello",replaceString:"hi",wholeWord:!0},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),a.selectAllMatches(),n.deepStrictEqual(e.getSelections().map(r=>r.toString()),[new h(6,14,6,19),new h(6,27,6,32),new h(7,14,7,19),new h(8,14,8,19)].map(r=>r.toString())),l(e,[6,14,6,19],null,[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),a.dispose(),t.dispose()}),s("issue #14143 selectAllMatches should maintain primary cursor if feasible",e=>{const t=o.add(new i);t.change({searchString:"hello",replaceString:"hi",wholeWord:!0},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),e.setSelection(new u(7,14,7,19)),a.selectAllMatches(),n.deepStrictEqual(e.getSelections().map(r=>r.toString()),[new h(7,14,7,19),new h(6,14,6,19),new h(6,27,6,32),new h(8,14,8,19)].map(r=>r.toString())),n.deepStrictEqual(e.getSelection().toString(),new h(7,14,7,19).toString()),l(e,[7,14,7,19],null,[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),a.dispose(),t.dispose()}),s("issue #1914: NPE when there is only one find match",e=>{const t=o.add(new i);t.change({searchString:"cool.h"},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[2,11,2,17]]),a.moveToNextMatch(),l(e,[2,11,2,17],[2,11,2,17],[[2,11,2,17]]),a.moveToNextMatch(),l(e,[2,11,2,17],[2,11,2,17],[[2,11,2,17]]),a.dispose(),t.dispose()}),s("replace when search string has look ahed regex",e=>{const t=o.add(new i);t.change({searchString:"hello(?=\\sworld)",replaceString:"hi",isRegex:!0},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[6,14,6,19],[7,14,7,19],[8,14,8,19]]),a.replace(),l(e,[6,14,6,19],[6,14,6,19],[[6,14,6,19],[7,14,7,19],[8,14,8,19]]),n.strictEqual(e.getModel().getLineContent(6),'    cout << "hello world, Hello!" << endl;'),a.replace(),l(e,[7,14,7,19],[7,14,7,19],[[7,14,7,19],[8,14,8,19]]),n.strictEqual(e.getModel().getLineContent(6),'    cout << "hi world, Hello!" << endl;'),a.replace(),l(e,[8,14,8,19],[8,14,8,19],[[8,14,8,19]]),n.strictEqual(e.getModel().getLineContent(7),'    cout << "hi world again" << endl;'),a.replace(),l(e,[8,16,8,16],null,[]),n.strictEqual(e.getModel().getLineContent(8),'    cout << "hi world again" << endl;'),a.dispose(),t.dispose()}),s("replace when search string has look ahed regex and cursor is at the last find match",e=>{const t=o.add(new i);t.change({searchString:"hello(?=\\sworld)",replaceString:"hi",isRegex:!0},!1);const a=o.add(new c(e,t));e.trigger("mouse",p.MoveTo.id,{position:new w(8,14)}),l(e,[8,14,8,14],null,[[6,14,6,19],[7,14,7,19],[8,14,8,19]]),a.replace(),l(e,[8,14,8,19],[8,14,8,19],[[6,14,6,19],[7,14,7,19],[8,14,8,19]]),n.strictEqual(e.getModel().getLineContent(8),'    cout << "Hello world again" << endl;'),a.replace(),l(e,[6,14,6,19],[6,14,6,19],[[6,14,6,19],[7,14,7,19]]),n.strictEqual(e.getModel().getLineContent(8),'    cout << "hi world again" << endl;'),a.replace(),l(e,[7,14,7,19],[7,14,7,19],[[7,14,7,19]]),n.strictEqual(e.getModel().getLineContent(6),'    cout << "hi world, Hello!" << endl;'),a.replace(),l(e,[7,16,7,16],null,[]),n.strictEqual(e.getModel().getLineContent(7),'    cout << "hi world again" << endl;'),a.dispose(),t.dispose()}),s("replaceAll when search string has look ahed regex",e=>{const t=o.add(new i);t.change({searchString:"hello(?=\\sworld)",replaceString:"hi",isRegex:!0},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[6,14,6,19],[7,14,7,19],[8,14,8,19]]),a.replaceAll(),n.strictEqual(e.getModel().getLineContent(6),'    cout << "hi world, Hello!" << endl;'),n.strictEqual(e.getModel().getLineContent(7),'    cout << "hi world again" << endl;'),n.strictEqual(e.getModel().getLineContent(8),'    cout << "hi world again" << endl;'),l(e,[1,1,1,1],null,[]),a.dispose(),t.dispose()}),s("replace when search string has look ahed regex and replace string has capturing groups",e=>{const t=o.add(new i);t.change({searchString:"hel(lo)(?=\\sworld)",replaceString:"hi$1",isRegex:!0},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[6,14,6,19],[7,14,7,19],[8,14,8,19]]),a.replace(),l(e,[6,14,6,19],[6,14,6,19],[[6,14,6,19],[7,14,7,19],[8,14,8,19]]),n.strictEqual(e.getModel().getLineContent(6),'    cout << "hello world, Hello!" << endl;'),a.replace(),l(e,[7,14,7,19],[7,14,7,19],[[7,14,7,19],[8,14,8,19]]),n.strictEqual(e.getModel().getLineContent(6),'    cout << "hilo world, Hello!" << endl;'),a.replace(),l(e,[8,14,8,19],[8,14,8,19],[[8,14,8,19]]),n.strictEqual(e.getModel().getLineContent(7),'    cout << "hilo world again" << endl;'),a.replace(),l(e,[8,18,8,18],null,[]),n.strictEqual(e.getModel().getLineContent(8),'    cout << "hilo world again" << endl;'),a.dispose(),t.dispose()}),s("replaceAll when search string has look ahed regex and replace string has capturing groups",e=>{const t=o.add(new i);t.change({searchString:"wo(rl)d(?=.*;$)",replaceString:"gi$1",isRegex:!0},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[6,20,6,25],[7,20,7,25],[8,20,8,25],[9,19,9,24]]),a.replaceAll(),n.strictEqual(e.getModel().getLineContent(6),'    cout << "hello girl, Hello!" << endl;'),n.strictEqual(e.getModel().getLineContent(7),'    cout << "hello girl again" << endl;'),n.strictEqual(e.getModel().getLineContent(8),'    cout << "Hello girl again" << endl;'),n.strictEqual(e.getModel().getLineContent(9),'    cout << "hellogirl again" << endl;'),l(e,[1,1,1,1],null,[]),a.dispose(),t.dispose()}),s("replaceAll when search string is multiline and has look ahed regex and replace string has capturing groups",e=>{const t=o.add(new i);t.change({searchString:"wo(rl)d(.*;\\n)(?=.*hello)",replaceString:"gi$1$2",isRegex:!0,matchCase:!0},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[6,20,7,1],[8,20,9,1]]),a.replaceAll(),n.strictEqual(e.getModel().getLineContent(6),'    cout << "hello girl, Hello!" << endl;'),n.strictEqual(e.getModel().getLineContent(8),'    cout << "Hello girl again" << endl;'),l(e,[1,1,1,1],null,[]),a.dispose(),t.dispose()}),s("replaceAll preserving case",e=>{const t=o.add(new i);t.change({searchString:"hello",replaceString:"goodbye",isRegex:!1,matchCase:!1,preserveCase:!0},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19],[9,14,9,19]]),a.replaceAll(),n.strictEqual(e.getModel().getLineContent(6),'    cout << "goodbye world, Goodbye!" << endl;'),n.strictEqual(e.getModel().getLineContent(7),'    cout << "goodbye world again" << endl;'),n.strictEqual(e.getModel().getLineContent(8),'    cout << "Goodbye world again" << endl;'),n.strictEqual(e.getModel().getLineContent(9),'    cout << "goodbyeworld again" << endl;'),l(e,[1,1,1,1],null,[]),a.dispose(),t.dispose()}),s("issue #18711 replaceAll with empty string",e=>{const t=o.add(new i);t.change({searchString:"hello",replaceString:"",wholeWord:!0},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[6,14,6,19],[6,27,6,32],[7,14,7,19],[8,14,8,19]]),a.replaceAll(),l(e,[1,1,1,1],null,[]),n.strictEqual(e.getModel().getLineContent(6),'    cout << " world, !" << endl;'),n.strictEqual(e.getModel().getLineContent(7),'    cout << " world again" << endl;'),n.strictEqual(e.getModel().getLineContent(8),'    cout << " world again" << endl;'),a.dispose(),t.dispose()}),s("issue #32522 replaceAll with ^ on more than 1000 matches",e=>{let t="";for(let g=0;g<1100;g++)t+="line"+g+`
`;e.getModel().setValue(t);const a=o.add(new i);a.change({searchString:"^",replaceString:"a ",isRegex:!0},!1);const r=o.add(new c(e,a));r.replaceAll();let d="";for(let g=0;g<1100;g++)d+="a line"+g+`
`;d+="a ",n.strictEqual(e.getModel().getValue(),d),r.dispose(),a.dispose()}),s("issue #19740 Find and replace capture group/backreference inserts `undefined` instead of empty string",e=>{const t=o.add(new i);t.change({searchString:"hello(z)?",replaceString:"hi$1",isRegex:!0,matchCase:!0},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[6,14,6,19],[7,14,7,19],[9,14,9,19]]),a.replaceAll(),l(e,[1,1,1,1],null,[]),n.strictEqual(e.getModel().getLineContent(6),'    cout << "hi world, Hello!" << endl;'),n.strictEqual(e.getModel().getLineContent(7),'    cout << "hi world again" << endl;'),n.strictEqual(e.getModel().getLineContent(9),'    cout << "hiworld again" << endl;'),a.dispose(),t.dispose()}),s("issue #27083. search scope works even if it is a single line",e=>{const t=o.add(new i);t.change({searchString:"hello",wholeWord:!0,searchScope:[new u(7,1,8,1)]},!1);const a=o.add(new c(e,t));l(e,[1,1,1,1],null,[[7,14,7,19]]),a.dispose(),t.dispose()}),s('issue #3516: Control behavior of "Next" operations (not looping back to beginning)',e=>{const t=o.add(new i);t.change({searchString:"hello",loop:!1},!1);const a=o.add(new c(e,t));n.strictEqual(t.matchesCount,5),n.strictEqual(t.matchesPosition,0),n.strictEqual(t.canNavigateForward(),!0),n.strictEqual(t.canNavigateBack(),!0),a.moveToNextMatch(),n.strictEqual(t.matchesPosition,1),n.strictEqual(t.canNavigateForward(),!0),n.strictEqual(t.canNavigateBack(),!1),a.moveToNextMatch(),n.strictEqual(t.matchesPosition,2),n.strictEqual(t.canNavigateForward(),!0),n.strictEqual(t.canNavigateBack(),!0),a.moveToNextMatch(),n.strictEqual(t.matchesPosition,3),n.strictEqual(t.canNavigateForward(),!0),n.strictEqual(t.canNavigateBack(),!0),a.moveToNextMatch(),n.strictEqual(t.matchesPosition,4),n.strictEqual(t.canNavigateForward(),!0),n.strictEqual(t.canNavigateBack(),!0),a.moveToNextMatch(),n.strictEqual(t.matchesPosition,5),n.strictEqual(t.canNavigateForward(),!1),n.strictEqual(t.canNavigateBack(),!0),a.moveToNextMatch(),n.strictEqual(t.matchesPosition,5),n.strictEqual(t.canNavigateForward(),!1),n.strictEqual(t.canNavigateBack(),!0),a.moveToNextMatch(),n.strictEqual(t.matchesPosition,5),n.strictEqual(t.canNavigateForward(),!1),n.strictEqual(t.canNavigateBack(),!0),a.moveToPrevMatch(),n.strictEqual(t.matchesPosition,4),n.strictEqual(t.canNavigateForward(),!0),n.strictEqual(t.canNavigateBack(),!0),a.moveToPrevMatch(),n.strictEqual(t.matchesPosition,3),n.strictEqual(t.canNavigateForward(),!0),n.strictEqual(t.canNavigateBack(),!0),a.moveToPrevMatch(),n.strictEqual(t.matchesPosition,2),n.strictEqual(t.canNavigateForward(),!0),n.strictEqual(t.canNavigateBack(),!0),a.moveToPrevMatch(),n.strictEqual(t.matchesPosition,1),n.strictEqual(t.canNavigateForward(),!0),n.strictEqual(t.canNavigateBack(),!1),a.moveToPrevMatch(),n.strictEqual(t.matchesPosition,1),n.strictEqual(t.canNavigateForward(),!0),n.strictEqual(t.canNavigateBack(),!1),a.moveToPrevMatch(),n.strictEqual(t.matchesPosition,1),n.strictEqual(t.canNavigateForward(),!0),n.strictEqual(t.canNavigateBack(),!1)}),s('issue #3516: Control behavior of "Next" operations (looping back to beginning)',e=>{const t=o.add(new i);t.change({searchString:"hello"},!1);const a=o.add(new c(e,t));n.strictEqual(t.matchesCount,5),n.strictEqual(t.matchesPosition,0),n.strictEqual(t.canNavigateForward(),!0),n.strictEqual(t.canNavigateBack(),!0),a.moveToNextMatch(),n.strictEqual(t.matchesPosition,1),n.strictEqual(t.canNavigateForward(),!0),n.strictEqual(t.canNavigateBack(),!0),a.moveToNextMatch(),n.strictEqual(t.matchesPosition,2),n.strictEqual(t.canNavigateForward(),!0),n.strictEqual(t.canNavigateBack(),!0),a.moveToNextMatch(),n.strictEqual(t.matchesPosition,3),n.strictEqual(t.canNavigateForward(),!0),n.strictEqual(t.canNavigateBack(),!0),a.moveToNextMatch(),n.strictEqual(t.matchesPosition,4),n.strictEqual(t.canNavigateForward(),!0),n.strictEqual(t.canNavigateBack(),!0),a.moveToNextMatch(),n.strictEqual(t.matchesPosition,5),n.strictEqual(t.canNavigateForward(),!0),n.strictEqual(t.canNavigateBack(),!0),a.moveToNextMatch(),n.strictEqual(t.matchesPosition,1),n.strictEqual(t.canNavigateForward(),!0),n.strictEqual(t.canNavigateBack(),!0),a.moveToNextMatch(),n.strictEqual(t.matchesPosition,2),n.strictEqual(t.canNavigateForward(),!0),n.strictEqual(t.canNavigateBack(),!0),a.moveToPrevMatch(),n.strictEqual(t.matchesPosition,1),n.strictEqual(t.canNavigateForward(),!0),n.strictEqual(t.canNavigateBack(),!0),a.moveToPrevMatch(),n.strictEqual(t.matchesPosition,5),n.strictEqual(t.canNavigateForward(),!0),n.strictEqual(t.canNavigateBack(),!0),a.moveToPrevMatch(),n.strictEqual(t.matchesPosition,4),n.strictEqual(t.canNavigateForward(),!0),n.strictEqual(t.canNavigateBack(),!0),a.moveToPrevMatch(),n.strictEqual(t.matchesPosition,3),n.strictEqual(t.canNavigateForward(),!0),n.strictEqual(t.canNavigateBack(),!0),a.moveToPrevMatch(),n.strictEqual(t.matchesPosition,2),n.strictEqual(t.canNavigateForward(),!0),n.strictEqual(t.canNavigateBack(),!0),a.moveToPrevMatch(),n.strictEqual(t.matchesPosition,1),n.strictEqual(t.canNavigateForward(),!0),n.strictEqual(t.canNavigateBack(),!0)})});
