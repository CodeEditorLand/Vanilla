import{quickSelect as S}from"../../../../base/common/arrays.js";import{CharCode as _}from"../../../../base/common/charCode.js";import{anyScore as v,fuzzyScore as g,FuzzyScore as I,fuzzyScoreGracefulAggressive as x,FuzzyScoreOptions as y}from"../../../../base/common/filters.js";import{compareIgnoreCase as z}from"../../../../base/common/strings.js";import"../../../common/config/editorOptions.js";import{CompletionItemKind as h}from"../../../common/languages.js";import"./wordDistance.js";import"./suggest.js";class q{constructor(t,i){this.leadingLineContent=t;this.characterCountDelta=i}}var L=(o=>(o[o.Nothing=0]="Nothing",o[o.All=1]="All",o[o.Incr=2]="Incr",o))(L||{});class c{constructor(t,i,o,n,l,m,d=y.default,u=void 0){this.clipboardText=u;this._items=t,this._column=i,this._wordDistance=n,this._options=l,this._refilterKind=1,this._lineContext=o,this._fuzzyScoreOptions=d,m==="top"?this._snippetCompareFn=c._compareCompletionItemsSnippetsUp:m==="bottom"&&(this._snippetCompareFn=c._compareCompletionItemsSnippetsDown)}_items;_column;_wordDistance;_options;_snippetCompareFn=c._compareCompletionItems;_fuzzyScoreOptions;_lineContext;_refilterKind;_filteredItems;_itemsByProvider;_stats;get lineContext(){return this._lineContext}set lineContext(t){(this._lineContext.leadingLineContent!==t.leadingLineContent||this._lineContext.characterCountDelta!==t.characterCountDelta)&&(this._refilterKind=this._lineContext.characterCountDelta<t.characterCountDelta&&this._filteredItems?2:1,this._lineContext=t)}get items(){return this._ensureCachedState(),this._filteredItems}getItemsByProvider(){return this._ensureCachedState(),this._itemsByProvider}getIncompleteProvider(){this._ensureCachedState();const t=new Set;for(const[i,o]of this.getItemsByProvider())o.length>0&&o[0].container.incomplete&&t.add(i);return t}get stats(){return this._ensureCachedState(),this._stats}_ensureCachedState(){this._refilterKind!==0&&this._createCachedState()}_createCachedState(){this._itemsByProvider=new Map;const t=[],{leadingLineContent:i,characterCountDelta:o}=this._lineContext;let n="",l="";const m=this._refilterKind===1?this._items:this._filteredItems,d=[],u=!this._options.filterGraceful||m.length>2e3?g:x;for(let p=0;p<m.length;p++){const e=m[p];if(e.isInvalid)continue;const f=this._itemsByProvider.get(e.provider);f?f.push(e):this._itemsByProvider.set(e.provider,[e]);const C=e.position.column-e.editStart.column,a=C+o-(e.position.column-this._column);if(n.length!==a&&(n=a===0?"":i.slice(-a),l=n.toLowerCase()),e.word=n,a===0)e.score=I.Default;else{let s=0;for(;s<C;){const r=n.charCodeAt(s);if(r===_.Space||r===_.Tab)s+=1;else break}if(s>=a)e.score=I.Default;else if(typeof e.completion.filterText=="string"){const r=u(n,l,s,e.completion.filterText,e.filterTextLow,0,this._fuzzyScoreOptions);if(!r)continue;z(e.completion.filterText,e.textLabel)===0?e.score=r:(e.score=v(n,l,s,e.textLabel,e.labelLow,0),e.score[0]=r[0])}else{const r=u(n,l,s,e.textLabel,e.labelLow,0,this._fuzzyScoreOptions);if(!r)continue;e.score=r}}e.idx=p,e.distance=this._wordDistance.distance(e.position,e.completion),d.push(e),t.push(e.textLabel.length)}this._filteredItems=d.sort(this._snippetCompareFn),this._refilterKind=0,this._stats={pLabelLen:t.length?S(t.length-.85,t,(p,e)=>p-e):0}}static _compareCompletionItems(t,i){return t.score[0]>i.score[0]?-1:t.score[0]<i.score[0]?1:t.distance<i.distance?-1:t.distance>i.distance?1:t.idx<i.idx?-1:t.idx>i.idx?1:0}static _compareCompletionItemsSnippetsDown(t,i){if(t.completion.kind!==i.completion.kind){if(t.completion.kind===h.Snippet)return 1;if(i.completion.kind===h.Snippet)return-1}return c._compareCompletionItems(t,i)}static _compareCompletionItemsSnippetsUp(t,i){if(t.completion.kind!==i.completion.kind){if(t.completion.kind===h.Snippet)return-1;if(i.completion.kind===h.Snippet)return 1}return c._compareCompletionItems(t,i)}}export{c as CompletionModel,q as LineContext};
