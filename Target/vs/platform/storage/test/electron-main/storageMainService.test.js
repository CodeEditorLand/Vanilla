import{notStrictEqual as M,strictEqual as o}from"assert";import{Schemas as P}from"../../../../base/common/network.js";import{joinPath as p}from"../../../../base/common/resources.js";import{URI as h}from"../../../../base/common/uri.js";import{generateUuid as m}from"../../../../base/common/uuid.js";import{OPTIONS as E,parseArgs as R}from"../../../environment/node/argv.js";import{NativeEnvironmentService as A}from"../../../environment/node/environmentService.js";import{FileService as N}from"../../../files/common/fileService.js";import"../../../lifecycle/electron-main/lifecycleMainService.js";import{NullLogService as u}from"../../../log/common/log.js";import O from"../../../product/common/product.js";import"../../../product/common/productService.js";import{SaveStrategy as L,StateService as T}from"../../../state/node/stateService.js";import{IS_NEW_KEY as W,StorageScope as w}from"../../common/storage.js";import"../../electron-main/storageMain.js";import{StorageMainService as U}from"../../electron-main/storageMainService.js";import{currentSessionDateStorageKey as z,firstSessionDateStorageKey as H}from"../../../telemetry/common/telemetry.js";import{UriIdentityService as K}from"../../../uriIdentity/common/uriIdentityService.js";import"../../../userDataProfile/common/userDataProfile.js";import{UserDataProfilesMainService as x}from"../../../userDataProfile/electron-main/userDataProfile.js";import{TestLifecycleMainService as y}from"../../../test/electron-main/workbenchTestServices.js";import{ensureNoDisposablesAreLeakedInTestSuite as B}from"../../../../base/test/common/utils.js";import{DisposableStore as _}from"../../../../base/common/lifecycle.js";suite("StorageMainService",function(){const r=new _,I={_serviceBrand:void 0,...O},d=h.file("/location").with({scheme:P.inMemory}),g={id:"id",name:"inMemory",shortName:"inMemory",isDefault:!1,location:d,globalStorageHome:p(d,"globalStorageHome"),settingsResource:p(d,"settingsResource"),keybindingsResource:p(d,"keybindingsResource"),tasksResource:p(d,"tasksResource"),snippetsHome:p(d,"snippetsHome"),extensionsResource:p(d,"extensionsResource"),cacheHome:p(d,"cache")};class b extends U{getStorageOptions(){return{useInMemoryStorage:!0}}}async function v(e,t){o(e.isInMemory(),!0),t===w.APPLICATION?(o(e.items.size,0),await e.init(),o(typeof e.get(H),"string"),o(typeof e.get(z),"string")):await e.init();let n;r.add(e.onDidChangeStorage(s=>{n=s}));let i=!1;r.add(e.onDidCloseStorage(()=>i=!0));const a=e.items.size;e.set("bar","foo"),o(n.key,"bar"),e.set("barNumber",55),e.set("barBoolean",!0),o(e.get("bar"),"foo"),o(e.get("barNumber"),"55"),o(e.get("barBoolean"),"true"),o(e.items.size,a+3),e.delete("bar"),o(e.get("bar"),void 0),o(e.items.size,a+2),o(e.get(W),"true"),await e.close(),o(i,!0)}teardown(()=>{r.clear()});function f(e=new y){const t=new A(R(process.argv,E),I),n=r.add(new N(new u)),i=r.add(new K(n)),a=r.add(new b(new u,t,r.add(new x(r.add(new T(L.DELAYED,t,new u,n)),r.add(i),t,n,new u)),e,n,i));return r.add(a.applicationStorage),a}test("basics (application)",function(){const e=f();return v(e.applicationStorage,w.APPLICATION)}),test("basics (profile)",function(){const e=f(),t=g;return v(e.profileStorage(t),w.PROFILE)}),test("basics (workspace)",function(){const e={id:m()},t=f();return v(t.workspaceStorage(e),w.WORKSPACE)}),test("storage closed onWillShutdown",async function(){const e=new y,t=f(e),n=g,i={id:m()},a=t.workspaceStorage(i);let s=!1;r.add(a.onDidCloseStorage(()=>{s=!0}));const c=t.profileStorage(n);let l=!1;r.add(c.onDidCloseStorage(()=>{l=!0}));const S=t.applicationStorage;let C=!1;r.add(S.onDidCloseStorage(()=>{C=!0})),o(S,t.applicationStorage),o(c,t.profileStorage(n)),o(a,t.workspaceStorage(i)),await S.init(),await c.init(),await a.init(),await e.fireOnWillShutdown(),o(C,!0),o(l,!0),o(s,!0);const D=t.profileStorage(n);M(c,D);const k=t.workspaceStorage(i);M(a,k),await k.close()}),test("storage closed before init works",async function(){const e=f(),t=g,n={id:m()},i=e.workspaceStorage(n);let a=!1;r.add(i.onDidCloseStorage(()=>{a=!0}));const s=e.profileStorage(t);let c=!1;r.add(s.onDidCloseStorage(()=>{c=!0}));const l=e.applicationStorage;let S=!1;r.add(l.onDidCloseStorage(()=>{S=!0})),await l.close(),await s.close(),await i.close(),o(S,!0),o(c,!0),o(a,!0)}),test("storage closed before init awaits works",async function(){const e=f(),t=g,n={id:m()},i=e.workspaceStorage(n);let a=!1;r.add(i.onDidCloseStorage(()=>{a=!0}));const s=e.profileStorage(t);let c=!1;r.add(s.onDidCloseStorage(()=>{c=!0}));const l=e.applicationStorage;let S=!1;r.add(l.onDidCloseStorage(()=>{S=!0})),l.init(),s.init(),i.init(),await l.close(),await s.close(),await i.close(),o(S,!0),o(c,!0),o(a,!0)}),B()});
