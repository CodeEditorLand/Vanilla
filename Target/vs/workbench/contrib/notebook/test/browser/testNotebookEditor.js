import*as V from"../../../../../base/browser/dom.js";import"../../../../../base/browser/ui/list/list.js";import{VSBuffer as _}from"../../../../../base/common/buffer.js";import{NotImplementedError as w}from"../../../../../base/common/errors.js";import{Emitter as c,Event as v}from"../../../../../base/common/event.js";import{DisposableStore as N}from"../../../../../base/common/lifecycle.js";import{ResourceMap as U}from"../../../../../base/common/map.js";import{Mimes as A}from"../../../../../base/common/mime.js";import{URI as M}from"../../../../../base/common/uri.js";import{mock as m}from"../../../../../base/test/common/mock.js";import{runWithFakedTimers as P}from"../../../../../base/test/common/timeTravelScheduler.js";import{ILanguageService as B}from"../../../../../editor/common/languages/language.js";import{ILanguageConfigurationService as W}from"../../../../../editor/common/languages/languageConfigurationRegistry.js";import{LanguageService as H}from"../../../../../editor/common/services/languageService.js";import{IModelService as K}from"../../../../../editor/common/services/model.js";import{ModelService as q}from"../../../../../editor/common/services/modelService.js";import{ITextModelService as z}from"../../../../../editor/common/services/resolverService.js";import{TestLanguageConfigurationService as $}from"../../../../../editor/test/common/modes/testLanguageConfigurationService.js";import{IClipboardService as j}from"../../../../../platform/clipboard/common/clipboardService.js";import{TestClipboardService as G}from"../../../../../platform/clipboard/test/common/testClipboardService.js";import{IConfigurationService as b}from"../../../../../platform/configuration/common/configuration.js";import{TestConfigurationService as J}from"../../../../../platform/configuration/test/common/testConfigurationService.js";import{ContextKeyService as Q}from"../../../../../platform/contextkey/browser/contextKeyService.js";import{IContextKeyService as E}from"../../../../../platform/contextkey/common/contextkey.js";import{TestInstantiationService as X}from"../../../../../platform/instantiation/test/common/instantiationServiceMock.js";import{IKeybindingService as Y}from"../../../../../platform/keybinding/common/keybinding.js";import{MockKeybindingService as Z}from"../../../../../platform/keybinding/test/common/mockKeybindingService.js";import{ILayoutService as ee}from"../../../../../platform/layout/browser/layoutService.js";import{IListService as te,ListService as oe}from"../../../../../platform/list/browser/listService.js";import{ILogService as re,NullLogService as ne}from"../../../../../platform/log/common/log.js";import{IStorageService as ie}from"../../../../../platform/storage/common/storage.js";import{IThemeService as de}from"../../../../../platform/theme/common/themeService.js";import{TestThemeService as le}from"../../../../../platform/theme/test/common/testThemeService.js";import{IUndoRedoService as se}from"../../../../../platform/undoRedo/common/undoRedo.js";import{UndoRedoService as ae}from"../../../../../platform/undoRedo/common/undoRedoService.js";import{IWorkspaceTrustRequestService as ue}from"../../../../../platform/workspace/common/workspaceTrust.js";import"../../../../common/editor/editorInput.js";import{EditorModel as ce}from"../../../../common/editor/editorModel.js";import{CellFocusMode as f}from"../../browser/notebookBrowser.js";import"../../browser/notebookViewEvents.js";import{NotebookCellStatusBarService as me}from"../../browser/services/notebookCellStatusBarServiceImpl.js";import{ListViewInfoAccessor as ge,NotebookCellList as pe}from"../../browser/view/notebookCellList.js";import"../../browser/view/notebookRenderingCommon.js";import{NotebookEventDispatcher as ve}from"../../browser/viewModel/eventDispatcher.js";import{NotebookViewModel as be}from"../../browser/viewModel/notebookViewModelImpl.js";import{ViewContext as fe}from"../../browser/viewModel/viewContext.js";import{NotebookCellTextModel as Ce}from"../../common/model/notebookCellTextModel.js";import{NotebookTextModel as Ie}from"../../common/model/notebookTextModel.js";import{INotebookCellStatusBarService as ke}from"../../common/notebookCellStatusBarService.js";import{CellUri as C,NotebookCellExecutionState as Se,SelectionStateType as x}from"../../common/notebookCommon.js";import{INotebookExecutionStateService as I}from"../../common/notebookExecutionStateService.js";import{NotebookOptions as D}from"../../browser/notebookOptions.js";import"../../common/notebookRange.js";import{TextModelResolverService as he}from"../../../../services/textmodelResolver/common/textModelResolverService.js";import"../../../../services/workingCopy/common/workingCopy.js";import{TestLayoutService as we}from"../../../../test/browser/workbenchTestServices.js";import{TestStorageService as Ne,TestWorkspaceTrustRequestService as Me}from"../../../../test/common/workbenchTestServices.js";import{FontInfo as Ee}from"../../../../../editor/common/config/fontInfo.js";import{EditorFontLigatures as xe,EditorFontVariations as De}from"../../../../../editor/common/config/editorOptions.js";import{ICodeEditorService as k}from"../../../../../editor/browser/services/codeEditorService.js";import{mainWindow as y}from"../../../../../base/browser/window.js";import{TestCodeEditorService as ye}from"../../../../../editor/test/browser/editorTestServices.js";import{INotebookCellOutlineDataSourceFactory as Re,NotebookCellOutlineDataSourceFactory as Te}from"../../browser/viewModel/notebookOutlineDataSourceFactory.js";import{ILanguageDetectionService as Fe}from"../../../../services/languageDetection/common/languageDetectionWorkerService.js";import{INotebookOutlineEntryFactory as Oe,NotebookOutlineEntryFactory as Le}from"../../browser/viewModel/notebookOutlineEntryFactory.js";import{IOutlineService as Ve}from"../../../../services/outline/browser/outline.js";class yo extends Ce{constructor(d,n,s,i,l,g,u){super(C.generate(M.parse("test:///fake/notebook"),n),n,s,i,A.text,l,g,void 0,void 0,void 0,{transientCellMetadata:{},transientDocumentMetadata:{},transientOutputs:!1,cellContentMetadata:{}},u);this.viewType=d;this.source=s}}class _e extends ce{constructor(d){super();this._notebook=d;d&&d.onDidChangeContent&&this._register(d.onDidChangeContent(()=>{this._dirty=!0,this._onDidChangeDirty.fire(),this._onDidChangeContent.fire()}))}_dirty=!1;_onDidSave=this._register(new c);onDidSave=this._onDidSave.event;_onDidChangeDirty=this._register(new c);onDidChangeDirty=this._onDidChangeDirty.event;onDidChangeOrphaned=v.None;onDidChangeReadonly=v.None;onDidRevertUntitled=v.None;_onDidChangeContent=this._register(new c);onDidChangeContent=this._onDidChangeContent.event;get viewType(){return this._notebook.viewType}get resource(){return this._notebook.uri}get notebook(){return this._notebook}isReadonly(){return!1}isOrphaned(){return!1}hasAssociatedFilePath(){return!1}isDirty(){return this._dirty}get hasErrorState(){return!1}isModified(){return this._dirty}getNotebook(){return this._notebook}async load(){return this}async save(){return this._notebook?(this._dirty=!1,this._onDidChangeDirty.fire(),this._onDidSave.fire({}),!0):!1}saveAs(){throw new w}revert(){throw new w}}function R(o){const e=o.add(new X),d=new le;return e.stub(B,o.add(new H)),e.stub(se,e.createInstance(ae)),e.stub(b,new J),e.stub(de,d),e.stub(W,o.add(new $)),e.stub(K,o.add(e.createInstance(q))),e.stub(z,o.add(e.createInstance(he))),e.stub(E,o.add(e.createInstance(Q))),e.stub(te,o.add(e.createInstance(oe))),e.stub(ee,new we),e.stub(re,new ne),e.stub(j,G),e.stub(ie,o.add(new Ne)),e.stub(ue,o.add(new Me(!0))),e.stub(I,new Pe),e.stub(Y,new Z),e.stub(ke,o.add(new me)),e.stub(k,o.add(new ye(d))),e.stub(Ve,new class extends m(){registerOutlineCreator(){return{dispose(){}}}}),e.stub(Re,e.createInstance(Te)),e.stub(Oe,e.createInstance(Le)),e.stub(Fe,new class{_serviceBrand;isEnabledForLanguage(s){return!1}async detectLanguage(s,i){}}),e}function T(o,e,d){const n="notebook",s=e.add(o.createInstance(Ie,n,M.parse("test://test"),d.map(t=>({source:t[0],mime:void 0,language:t[1],cellKind:t[2],outputs:t[3]??[],metadata:t[4]})),{},{transientCellMetadata:{},transientDocumentMetadata:{},cellContentMetadata:{},transientOutputs:!1})),i=e.add(new _e(s)),l=e.add(new D(y,!1,void 0,o.get(b),o.get(I),o.get(k))),g=new class extends m(){},u=new fe(l,e.add(new ve),()=>g),r=e.add(o.createInstance(be,n,i.notebook,u,null,{isReadOnly:!1})),a=e.add(Ue(o,e,u));a.attachViewModel(r);const S=e.add(new ge(a));let h=[{start:0,end:100}];const O=Date.now().toString();return{editor:new class extends m(){dispose(){r.dispose()}notebookOptions=l;onDidChangeModel=new c().event;onDidChangeCellState=new c().event;getViewModel(){return r}textModel=r.notebookDocument;hasModel(){return!!r}getLength(){return r.length}getFocus(){return r.getFocus()}getSelections(){return r.getSelections()}setFocus(t){r.updateSelectionsState({kind:x.Index,focus:t,selections:r.getSelections()})}setSelections(t){r.updateSelectionsState({kind:x.Index,focus:r.getFocus(),selections:t})}getViewIndexByModelIndex(t){return S.getViewIndex(r.viewCells[t])}getCellRangeFromViewRange(t,p){return S.getCellRangeFromViewRange(t,p)}revealCellRangeInView(){}setHiddenAreas(t){return a.setHiddenAreas(t,!0)}getActiveCell(){const t=a.getFocusedElements();if(t&&t.length)return t[0]}hasOutputTextSelection(){return!1}changeModelDecorations(){return null}focusElement(){}setCellEditorSelection(){}async revealRangeInCenterIfOutsideViewportAsync(){}async layoutNotebookCell(){}async createOutput(){}async removeInset(){}async focusNotebookCell(t,p){t.focusMode=p==="editor"?f.Editor:p==="output"?f.Output:f.Container}cellAt(t){return r.cellAt(t)}getCellIndex(t){return r.getCellIndex(t)}getCellsInRange(t){return r.getCellsInRange(t)}getCellByHandle(t){return r.getCellByHandle(t)}getNextVisibleCellIndex(t){return r.getNextVisibleCellIndex(t)}getControl(){return this}get onDidChangeSelection(){return r.onDidChangeSelection}get onDidChangeOptions(){return r.onDidChangeOptions}get onDidChangeViewCells(){return r.onDidChangeViewCells}async find(t,p){return r.find(t,p).filter(L=>L.length>0)}deltaCellDecorations(){return[]}onDidChangeVisibleRanges=v.None;get visibleRanges(){return h}set visibleRanges(t){h=t}getId(){return O}setScrollTop(t){a.scrollTop=t}get scrollTop(){return a.scrollTop}getLayoutInfo(){return{width:0,height:0,scrollHeight:a.getScrollHeight(),fontInfo:new Ee({pixelRatio:1,fontFamily:"mockFont",fontWeight:"normal",fontSize:14,fontFeatureSettings:xe.OFF,fontVariationSettings:De.OFF,lineHeight:19,letterSpacing:1.5,isMonospace:!0,typicalHalfwidthCharacterWidth:10,typicalFullwidthCharacterWidth:20,canUseHalfwidthRightwardsArrow:!0,spaceWidth:10,middotWidth:10,wsmiddotWidth:10,maxDigitWidth:10},!0),stickyHeight:0}}},viewModel:r}}function F(o,e,d){return T(o,e,d)}async function To(o,e,d){const n=new N,s=R(n),i=F(s,n,o),l=F(s,n,e),g=new class extends m(){get notebook(){return i.viewModel.notebookDocument}get resource(){return i.viewModel.notebookDocument.uri}},u=new class extends m(){get notebook(){return l.viewModel.notebookDocument}get resource(){return l.viewModel.notebookDocument.uri}},r=new class extends m(){get original(){return g}get modified(){return u}},a=await d(r,n,s);return a instanceof Promise?a.finally(()=>{i.editor.dispose(),i.viewModel.notebookDocument.dispose(),i.viewModel.dispose(),l.editor.dispose(),l.viewModel.notebookDocument.dispose(),l.viewModel.dispose(),n.dispose()}):(i.editor.dispose(),i.viewModel.notebookDocument.dispose(),i.viewModel.dispose(),l.editor.dispose(),l.viewModel.notebookDocument.dispose(),l.viewModel.dispose(),n.dispose()),a}async function Fo(o,e,d){const n=new N,s=d??R(n),i=T(s,n,o);return P({useFakeTimers:!0},async()=>{const l=await e(i.editor,i.viewModel,n,s);return l instanceof Promise?l.finally(()=>{i.editor.dispose(),i.viewModel.dispose(),i.editor.textModel.dispose(),n.dispose()}):(i.editor.dispose(),i.viewModel.dispose(),i.editor.textModel.dispose(),n.dispose()),l})}function Ue(o,e,d){const n={getHeight(u){return u.getHeight(17)},getTemplateId(){return"template"}},s=new class extends m(){},i={templateId:"template",renderTemplate(){return s},renderElement(){},disposeTemplate(){}},l=d?d.notebookOptions:e.add(new D(y,!1,void 0,o.get(b),o.get(I),o.get(k)));return e.add(o.createInstance(pe,"NotebookCellList",V.$("container"),l,n,[i],o.get(E),{supportDynamicHeights:!0,multipleSelectionSupport:!0}))}function Oo(o){return _.fromString(o)}class Ae{constructor(e,d,n){this.notebook=e;this.cellHandle=d;this.onComplete=n}state=Se.Unconfirmed;didPause=!1;isPaused=!1;confirm(){}update(e){}complete(e){this.onComplete()}}class Pe{_serviceBrand;_executions=new U;onDidChangeExecution=new c().event;onDidChangeLastRunFailState=new c().event;forceCancelNotebookExecutions(e){}getCellExecutionsForNotebook(e){return[]}getCellExecution(e){return this._executions.get(e)}createCellExecution(e,d){const n=()=>this._executions.delete(C.generate(e,d)),s=new Ae(e,d,n);return this._executions.set(C.generate(e,d),s),s}getCellExecutionsByHandleForNotebook(e){}getLastFailedCellForNotebook(e){}getExecution(e){}createExecution(e){throw new Error("Method not implemented.")}}export{_e as NotebookEditorTestModel,yo as TestCell,Pe as TestNotebookExecutionStateService,Ue as createNotebookCellList,F as createTestNotebookEditor,R as setupInstantiationService,Oo as valueBytesFromString,Fo as withTestNotebook,To as withTestNotebookDiffModel};
