import w from"assert";import{Event as h}from"../../../../../base/common/event.js";import{DisposableStore as C}from"../../../../../base/common/lifecycle.js";import{mock as f}from"../../../../../base/test/common/mock.js";import{assertSnapshot as u}from"../../../../../base/test/common/snapshot.js";import{ensureNoDisposablesAreLeakedInTestSuite as y}from"../../../../../base/test/common/utils.js";import{ILanguageFeaturesService as S}from"../../../../../editor/common/services/languageFeatures.js";import{LanguageFeaturesService as M}from"../../../../../editor/common/services/languageFeaturesService.js";import"../../../../../platform/instantiation/test/common/instantiationServiceMock.js";import"../../../../common/editor.js";import{NotebookCellOutline as j}from"../../browser/contrib/outline/notebookOutline.js";import"../../browser/notebookBrowser.js";import"../../browser/view/notebookRenderingCommon.js";import"../../browser/viewModel/OutlineEntry.js";import{computeContent as E}from"../../browser/viewParts/notebookEditorStickyScroll.js";import{CellKind as e}from"../../common/notebookCommon.js";import{createNotebookCellList as m,setupInstantiationService as L,withTestNotebook as v}from"./testNotebookEditor.js";import{OutlineTarget as T}from"../../../../services/outline/browser/outline.js";suite("NotebookEditorStickyScroll",()=>{let k,i;const c=document.createElement("div");teardown(()=>{k.dispose()});const b=y();setup(()=>{k=new C,i=L(k),i.set(S,new M)});function d(a){return a.hasModel()||w.ok(!1,"MUST have active text editor"),b.add(i.createInstance(j,new class extends f(){getControl(){return a}onDidChangeModel=h.None;onDidChangeSelection=h.None},T.QuickPick))}function p(a,o,t,r,n){const s=E(o,t,r,0);for(const l of s.values())n.add(l.line);return g(s.values())}function g(a){const o=[];for(const t of a)t.rendered&&o.unshift(t.line.element.innerText);return o}test("test0: should render empty, 	scrollTop at 0",async function(){await v([["# header a","markdown",e.Markup,[],{}],["## header aa","markdown",e.Markup,[],{}],["var b = 1;","javascript",e.Code,[],{}],["var b = 1;","javascript",e.Code,[],{}],["var b = 1;","javascript",e.Code,[],{}],["var b = 1;","javascript",e.Code,[],{}],["# header b","markdown",e.Markup,[],{}],["var c = 2;","javascript",e.Code,[],{}]],async(a,o)=>{o.restoreEditorViewState({editingCells:Array.from({length:8},()=>!1),editorViewStates:Array.from({length:8},()=>null),cellTotalHeights:Array.from({length:8},()=>50),cellLineNumberStates:{},collapsedInputCells:{},collapsedOutputCells:{}});const t=k.add(m(i,k));t.attachViewModel(o),t.layout(400,100),a.setScrollTop(0),a.visibleRanges=[{start:0,end:8}];const r=d(a),n=r.entries,s=p(c,a,t,n,k);await u(s),r.dispose()})}),test("test1: should render 0->1, 	visible range 3->8",async function(){await v([["# header a","markdown",e.Markup,[],{}],["## header aa","markdown",e.Markup,[],{}],["var b = 1;","javascript",e.Code,[],{}],["var b = 1;","javascript",e.Code,[],{}],["var b = 1;","javascript",e.Code,[],{}],["var b = 1;","javascript",e.Code,[],{}],["# header b","markdown",e.Markup,[],{}],["var c = 2;","javascript",e.Code,[],{}]],async(a,o,t)=>{o.restoreEditorViewState({editingCells:Array.from({length:8},()=>!1),editorViewStates:Array.from({length:8},()=>null),cellTotalHeights:Array.from({length:8},()=>50),cellLineNumberStates:{},collapsedInputCells:{},collapsedOutputCells:{}});const r=t.add(m(i,t));r.attachViewModel(o),r.layout(400,100),a.setScrollTop(175),a.visibleRanges=[{start:3,end:8}];const n=d(a),s=n.entries,l=p(c,a,r,s,t);await u(l),n.dispose()})}),test("test2: should render 0, 		visible range 6->9 so collapsing next 2 against following section",async function(){await v([["# header a","markdown",e.Markup,[],{}],["## header aa","markdown",e.Markup,[],{}],["### header aaa","markdown",e.Markup,[],{}],["var b = 1;","javascript",e.Code,[],{}],["var b = 1;","javascript",e.Code,[],{}],["var b = 1;","javascript",e.Code,[],{}],["var b = 1;","javascript",e.Code,[],{}],["# header b","markdown",e.Markup,[],{}],["var c = 2;","javascript",e.Code,[],{}]],async(a,o,t)=>{o.restoreEditorViewState({editingCells:Array.from({length:9},()=>!1),editorViewStates:Array.from({length:9},()=>null),cellTotalHeights:Array.from({length:9},()=>50),cellLineNumberStates:{},collapsedInputCells:{},collapsedOutputCells:{}});const r=t.add(m(i,t));r.attachViewModel(o),r.layout(400,100),a.setScrollTop(325),a.visibleRanges=[{start:6,end:9}];const n=d(a),s=n.entries,l=p(c,a,r,s,t);await u(l),n.dispose()})}),test("test3: should render 0->2, 	collapsing against equivalent level header",async function(){await v([["# header a","markdown",e.Markup,[],{}],["## header aa","markdown",e.Markup,[],{}],["### header aaa","markdown",e.Markup,[],{}],["var b = 1;","javascript",e.Code,[],{}],["### header aab","markdown",e.Markup,[],{}],["var b = 1;","javascript",e.Code,[],{}],["var b = 1;","javascript",e.Code,[],{}],["var b = 1;","javascript",e.Code,[],{}],["# header b","markdown",e.Markup,[],{}],["var c = 2;","javascript",e.Code,[],{}]],async(a,o,t)=>{o.restoreEditorViewState({editingCells:Array.from({length:10},()=>!1),editorViewStates:Array.from({length:10},()=>null),cellTotalHeights:Array.from({length:10},()=>50),cellLineNumberStates:{},collapsedInputCells:{},collapsedOutputCells:{}});const r=t.add(m(i,t));r.attachViewModel(o),r.layout(400,100),a.setScrollTop(175),a.visibleRanges=[{start:3,end:10}];const n=d(a),s=n.entries,l=p(c,a,r,s,t);await u(l),n.dispose()})}),test("test4: should render 0, 		scrolltop halfway through cell 0",async function(){await v([["# header a","markdown",e.Markup,[],{}],["## header aa","markdown",e.Markup,[],{}],["var b = 1;","javascript",e.Code,[],{}],["var b = 1;","javascript",e.Code,[],{}],["var b = 1;","javascript",e.Code,[],{}],["var b = 1;","javascript",e.Code,[],{}],["# header b","markdown",e.Markup,[],{}],["var c = 2;","javascript",e.Code,[],{}]],async(a,o,t)=>{o.restoreEditorViewState({editingCells:Array.from({length:8},()=>!1),editorViewStates:Array.from({length:8},()=>null),cellTotalHeights:Array.from({length:8},()=>50),cellLineNumberStates:{},collapsedInputCells:{},collapsedOutputCells:{}});const r=t.add(m(i,t));r.attachViewModel(o),r.layout(400,100),a.setScrollTop(50),a.visibleRanges=[{start:0,end:8}];const n=d(a),s=n.entries,l=p(c,a,r,s,t);await u(l),n.dispose()})}),test("test5: should render 0->2, 	scrolltop halfway through cell 2",async function(){await v([["# header a","markdown",e.Markup,[],{}],["## header aa","markdown",e.Markup,[],{}],["### header aaa","markdown",e.Markup,[],{}],["#### header aaaa","markdown",e.Markup,[],{}],["var b = 1;","javascript",e.Code,[],{}],["var b = 1;","javascript",e.Code,[],{}],["var b = 1;","javascript",e.Code,[],{}],["var b = 1;","javascript",e.Code,[],{}],["# header b","markdown",e.Markup,[],{}],["var c = 2;","javascript",e.Code,[],{}]],async(a,o,t)=>{o.restoreEditorViewState({editingCells:Array.from({length:10},()=>!1),editorViewStates:Array.from({length:10},()=>null),cellTotalHeights:Array.from({length:10},()=>50),cellLineNumberStates:{},collapsedInputCells:{},collapsedOutputCells:{}});const r=t.add(m(i,t));r.attachViewModel(o),r.layout(400,100),a.setScrollTop(125),a.visibleRanges=[{start:2,end:10}];const n=d(a),s=n.entries,l=p(c,a,r,s,t);await u(l),n.dispose()})}),test("test6: should render 6->7, 	scrolltop halfway through cell 7",async function(){await v([["# header a","markdown",e.Markup,[],{}],["## header aa","markdown",e.Markup,[],{}],["var b = 1;","javascript",e.Code,[],{}],["var b = 1;","javascript",e.Code,[],{}],["var b = 1;","javascript",e.Code,[],{}],["var b = 1;","javascript",e.Code,[],{}],["# header b","markdown",e.Markup,[],{}],["## header bb","markdown",e.Markup,[],{}],["### header bbb","markdown",e.Markup,[],{}],["var c = 2;","javascript",e.Code,[],{}]],async(a,o,t)=>{o.restoreEditorViewState({editingCells:Array.from({length:10},()=>!1),editorViewStates:Array.from({length:10},()=>null),cellTotalHeights:Array.from({length:10},()=>50),cellLineNumberStates:{},collapsedInputCells:{},collapsedOutputCells:{}});const r=t.add(m(i,t));r.attachViewModel(o),r.layout(400,100),a.setScrollTop(375),a.visibleRanges=[{start:7,end:10}];const n=d(a),s=n.entries,l=p(c,a,r,s,t);await u(l),n.dispose()})}),test("test7: should render 0->1, 	collapsing against next section",async function(){await v([["# header a","markdown",e.Markup,[],{}],["## header aa","markdown",e.Markup,[],{}],["### header aaa","markdown",e.Markup,[],{}],["#### header aaaa","markdown",e.Markup,[],{}],["var b = 1;","javascript",e.Code,[],{}],["var b = 1;","javascript",e.Code,[],{}],["var b = 1;","javascript",e.Code,[],{}],["var b = 1;","javascript",e.Code,[],{}],["# header b","markdown",e.Markup,[],{}],["## header bb","markdown",e.Markup,[],{}],["### header bbb","markdown",e.Markup,[],{}],["var c = 2;","javascript",e.Code,[],{}]],async(a,o,t)=>{o.restoreEditorViewState({editingCells:Array.from({length:12},()=>!1),editorViewStates:Array.from({length:12},()=>null),cellTotalHeights:Array.from({length:12},()=>50),cellLineNumberStates:{},collapsedInputCells:{},collapsedOutputCells:{}});const r=t.add(m(i,t));r.attachViewModel(o),r.layout(400,100),a.setScrollTop(350),a.visibleRanges=[{start:7,end:12}];const n=d(a),s=n.entries,l=p(c,a,r,s,t);await u(l),n.dispose()})})});
