import t from"assert";import{VSBuffer as f}from"../../../../../base/common/buffer.js";import{DisposableStore as M}from"../../../../../base/common/lifecycle.js";import{Mimes as p}from"../../../../../base/common/mime.js";import{ensureNoDisposablesAreLeakedInTestSuite as j}from"../../../../../base/test/common/utils.js";import{ILanguageService as T}from"../../../../../editor/common/languages/language.js";import"../../../../../platform/instantiation/test/common/instantiationServiceMock.js";import{IUndoRedoService as w}from"../../../../../platform/undoRedo/common/undoRedo.js";import{NotebookTextModel as r}from"../../common/model/notebookTextModel.js";import{CellEditType as i,CellKind as u,MOVE_CURSOR_1_LINE_COMMAND as k,SelectionStateType as b}from"../../common/notebookCommon.js";import{setupInstantiationService as S,TestCell as E,valueBytesFromString as s,withTestNotebook as o}from"./testNotebookEditor.js";suite("NotebookTextModel",()=>{let q,C,v;j(),suiteSetup(()=>{q=new M,C=S(q),v=C.get(T),C.spy(w,"pushElement")}),suiteTeardown(()=>q.dispose()),test("insert",async function(){await o([["var a = 1;","javascript",u.Code,[],{}],["var b = 2;","javascript",u.Code,[],{}],["var c = 3;","javascript",u.Code,[],{}],["var d = 4;","javascript",u.Code,[],{}]],(n,e,d)=>{const a=n.textModel;a.applyEdits([{editType:i.Replace,index:1,count:0,cells:[d.add(new E(a.viewType,5,"var e = 5;","javascript",u.Code,[],v))]},{editType:i.Replace,index:3,count:0,cells:[d.add(new E(a.viewType,6,"var f = 6;","javascript",u.Code,[],v))]}],!0,void 0,()=>{},void 0,!0),t.strictEqual(a.cells.length,6),t.strictEqual(a.cells[1].getValue(),"var e = 5;"),t.strictEqual(a.cells[4].getValue(),"var f = 6;")})}),test("multiple inserts at same position",async function(){await o([["var a = 1;","javascript",u.Code,[],{}],["var b = 2;","javascript",u.Code,[],{}],["var c = 3;","javascript",u.Code,[],{}],["var d = 4;","javascript",u.Code,[],{}]],(n,e,d)=>{const a=n.textModel;a.applyEdits([{editType:i.Replace,index:1,count:0,cells:[d.add(new E(a.viewType,5,"var e = 5;","javascript",u.Code,[],v))]},{editType:i.Replace,index:1,count:0,cells:[d.add(new E(a.viewType,6,"var f = 6;","javascript",u.Code,[],v))]}],!0,void 0,()=>{},void 0,!0),t.strictEqual(a.cells.length,6),t.strictEqual(a.cells[1].getValue(),"var e = 5;"),t.strictEqual(a.cells[2].getValue(),"var f = 6;")})}),test("delete",async function(){await o([["var a = 1;","javascript",u.Code,[],{}],["var b = 2;","javascript",u.Code,[],{}],["var c = 3;","javascript",u.Code,[],{}],["var d = 4;","javascript",u.Code,[],{}]],n=>{const e=n.textModel;e.applyEdits([{editType:i.Replace,index:1,count:1,cells:[]},{editType:i.Replace,index:3,count:1,cells:[]}],!0,void 0,()=>{},void 0,!0),t.strictEqual(e.cells[0].getValue(),"var a = 1;"),t.strictEqual(e.cells[1].getValue(),"var c = 3;")})}),test("delete + insert",async function(){await o([["var a = 1;","javascript",u.Code,[],{}],["var b = 2;","javascript",u.Code,[],{}],["var c = 3;","javascript",u.Code,[],{}],["var d = 4;","javascript",u.Code,[],{}]],(n,e,d)=>{const a=n.textModel;a.applyEdits([{editType:i.Replace,index:1,count:1,cells:[]},{editType:i.Replace,index:3,count:0,cells:[d.add(new E(a.viewType,5,"var e = 5;","javascript",u.Code,[],v))]}],!0,void 0,()=>{},void 0,!0),t.strictEqual(a.cells.length,4),t.strictEqual(a.cells[0].getValue(),"var a = 1;"),t.strictEqual(a.cells[2].getValue(),"var e = 5;")})}),test("delete + insert at same position",async function(){await o([["var a = 1;","javascript",u.Code,[],{}],["var b = 2;","javascript",u.Code,[],{}],["var c = 3;","javascript",u.Code,[],{}],["var d = 4;","javascript",u.Code,[],{}]],(n,e,d)=>{const a=n.textModel;a.applyEdits([{editType:i.Replace,index:1,count:1,cells:[]},{editType:i.Replace,index:1,count:0,cells:[d.add(new E(a.viewType,5,"var e = 5;","javascript",u.Code,[],v))]}],!0,void 0,()=>{},void 0,!0),t.strictEqual(a.cells.length,4),t.strictEqual(a.cells[0].getValue(),"var a = 1;"),t.strictEqual(a.cells[1].getValue(),"var e = 5;"),t.strictEqual(a.cells[2].getValue(),"var c = 3;")})}),test("(replace) delete + insert at same position",async function(){await o([["var a = 1;","javascript",u.Code,[],{}],["var b = 2;","javascript",u.Code,[],{}],["var c = 3;","javascript",u.Code,[],{}],["var d = 4;","javascript",u.Code,[],{}]],(n,e,d)=>{const a=n.textModel;a.applyEdits([{editType:i.Replace,index:1,count:1,cells:[d.add(new E(a.viewType,5,"var e = 5;","javascript",u.Code,[],v))]}],!0,void 0,()=>{},void 0,!0),t.strictEqual(a.cells.length,4),t.strictEqual(a.cells[0].getValue(),"var a = 1;"),t.strictEqual(a.cells[1].getValue(),"var e = 5;"),t.strictEqual(a.cells[2].getValue(),"var c = 3;")})}),test("output",async function(){await o([["var a = 1;","javascript",u.Code,[],{}]],n=>{const e=n.textModel;t.throws(()=>{e.applyEdits([{index:Number.MAX_VALUE,editType:i.Output,outputs:[]}],!0,void 0,()=>{},void 0,!0)}),t.throws(()=>{e.applyEdits([{index:-1,editType:i.Output,outputs:[]}],!0,void 0,()=>{},void 0,!0)}),e.applyEdits([{index:0,editType:i.Output,outputs:[{outputId:"someId",outputs:[{mime:p.markdown,data:s("_Hello_")}]}]}],!0,void 0,()=>{},void 0,!0),t.strictEqual(e.cells.length,1),t.strictEqual(e.cells[0].outputs.length,1),e.applyEdits([{index:0,editType:i.Output,append:!0,outputs:[{outputId:"someId2",outputs:[{mime:p.markdown,data:s("_Hello2_")}]}]}],!0,void 0,()=>{},void 0,!0),t.strictEqual(e.cells.length,1),t.strictEqual(e.cells[0].outputs.length,2);let[d,a]=e.cells[0].outputs;t.strictEqual(d.outputId,"someId"),t.strictEqual(a.outputId,"someId2"),e.applyEdits([{index:0,editType:i.Output,outputs:[{outputId:"someId3",outputs:[{mime:p.text,data:s("Last, replaced output")}]}]}],!0,void 0,()=>{},void 0,!0),t.strictEqual(e.cells.length,1),t.strictEqual(e.cells[0].outputs.length,1),[d]=e.cells[0].outputs,t.strictEqual(d.outputId,"someId3")})}),test("multiple append output in one position",async function(){await o([["var a = 1;","javascript",u.Code,[],{}]],n=>{const e=n.textModel;e.applyEdits([{index:0,editType:i.Output,append:!0,outputs:[{outputId:"append1",outputs:[{mime:p.markdown,data:s("append 1")}]}]},{index:0,editType:i.Output,append:!0,outputs:[{outputId:"append2",outputs:[{mime:p.markdown,data:s("append 2")}]}]}],!0,void 0,()=>{},void 0,!0),t.strictEqual(e.cells.length,1),t.strictEqual(e.cells[0].outputs.length,2);const[d,a]=e.cells[0].outputs;t.strictEqual(d.outputId,"append1"),t.strictEqual(a.outputId,"append2")})}),test("append to output created in same batch",async function(){await o([["var a = 1;","javascript",u.Code,[],{}]],n=>{const e=n.textModel;e.applyEdits([{index:0,editType:i.Output,append:!0,outputs:[{outputId:"append1",outputs:[{mime:p.markdown,data:s("append 1")}]}]},{editType:i.OutputItems,append:!0,outputId:"append1",items:[{mime:p.markdown,data:s("append 2")}]}],!0,void 0,()=>{},void 0,!0),t.strictEqual(e.cells.length,1),t.strictEqual(e.cells[0].outputs.length,1,"has 1 output");const[d]=e.cells[0].outputs;t.strictEqual(d.outputId,"append1"),t.strictEqual(d.outputs.length,2,"has 2 items")})});const l="application/vnd.code.notebook.stdout",x="application/vnd.code.notebook.stderr";test("appending streaming outputs",async function(){await o([["var a = 1;","javascript",u.Code,[],{}]],n=>{const e=n.textModel;e.applyEdits([{index:0,editType:i.Output,append:!0,outputs:[{outputId:"append1",outputs:[{mime:l,data:s("append 1")}]}]}],!0,void 0,()=>{},void 0,!0);const[d]=e.cells[0].outputs;t.strictEqual(d.versionId,0,"initial output version should be 0"),e.applyEdits([{editType:i.OutputItems,append:!0,outputId:"append1",items:[{mime:l,data:s("append 2")},{mime:l,data:s("append 3")}]}],!0,void 0,()=>{},void 0,!0),t.strictEqual(d.versionId,1,"version should bump per append"),e.applyEdits([{editType:i.OutputItems,append:!0,outputId:"append1",items:[{mime:l,data:s("append 4")},{mime:l,data:s("append 5")}]}],!0,void 0,()=>{},void 0,!0),t.strictEqual(d.versionId,2,"version should bump per append"),t.strictEqual(e.cells.length,1),t.strictEqual(e.cells[0].outputs.length,1,"has 1 output"),t.strictEqual(d.outputId,"append1"),t.strictEqual(d.outputs.length,1,"outputs are compressed"),t.strictEqual(d.outputs[0].data.toString(),"append 1append 2append 3append 4append 5"),t.strictEqual(d.appendedSinceVersion(0,l)?.toString(),"append 2append 3append 4append 5"),t.strictEqual(d.appendedSinceVersion(1,l)?.toString(),"append 4append 5"),t.strictEqual(d.appendedSinceVersion(2,l),void 0),t.strictEqual(d.appendedSinceVersion(2,x),void 0)})}),test("replacing streaming outputs",async function(){await o([["var a = 1;","javascript",u.Code,[],{}]],n=>{const e=n.textModel;e.applyEdits([{index:0,editType:i.Output,append:!0,outputs:[{outputId:"append1",outputs:[{mime:l,data:s("append 1")}]}]}],!0,void 0,()=>{},void 0,!0);const[d]=e.cells[0].outputs;t.strictEqual(d.versionId,0,"initial output version should be 0"),e.applyEdits([{editType:i.OutputItems,append:!0,outputId:"append1",items:[{mime:l,data:s("append 2")}]}],!0,void 0,()=>{},void 0,!0),t.strictEqual(d.versionId,1,"version should bump per append"),e.applyEdits([{editType:i.OutputItems,append:!1,outputId:"append1",items:[{mime:l,data:s("replace 3")}]}],!0,void 0,()=>{},void 0,!0),t.strictEqual(d.versionId,2,"version should bump per replace"),e.applyEdits([{editType:i.OutputItems,append:!0,outputId:"append1",items:[{mime:l,data:s("append 4")}]}],!0,void 0,()=>{},void 0,!0),t.strictEqual(d.versionId,3,"version should bump per append"),t.strictEqual(d.outputs[0].data.toString(),"replace 3append 4"),t.strictEqual(d.appendedSinceVersion(0,l),void 0,"replacing output should clear out previous versioned output buffers"),t.strictEqual(d.appendedSinceVersion(1,l),void 0,"replacing output should clear out previous versioned output buffers"),t.strictEqual(d.appendedSinceVersion(2,l)?.toString(),"append 4")})}),test("appending streaming outputs with move cursor compression",async function(){await o([["var a = 1;","javascript",u.Code,[],{}]],n=>{const e=n.textModel;e.applyEdits([{index:0,editType:i.Output,append:!0,outputs:[{outputId:"append1",outputs:[{mime:l,data:s("append 1")},{mime:l,data:s(`
append 1`)}]}]}],!0,void 0,()=>{},void 0,!0);const[d]=e.cells[0].outputs;t.strictEqual(d.versionId,0,"initial output version should be 0"),e.applyEdits([{editType:i.OutputItems,append:!0,outputId:"append1",items:[{mime:l,data:s(k+`
append 2`)}]}],!0,void 0,()=>{},void 0,!0),t.strictEqual(d.versionId,1,"version should bump per append"),t.strictEqual(d.outputs[0].data.toString(),`append 1
append 2`),t.strictEqual(d.appendedSinceVersion(0,l),void 0,"compressing outputs should clear out previous versioned output buffers")})}),test("appending streaming outputs with carraige return compression",async function(){await o([["var a = 1;","javascript",u.Code,[],{}]],n=>{const e=n.textModel;e.applyEdits([{index:0,editType:i.Output,append:!0,outputs:[{outputId:"append1",outputs:[{mime:l,data:s("append 1")},{mime:l,data:s(`
append 1`)}]}]}],!0,void 0,()=>{},void 0,!0);const[d]=e.cells[0].outputs;t.strictEqual(d.versionId,0,"initial output version should be 0"),e.applyEdits([{editType:i.OutputItems,append:!0,outputId:"append1",items:[{mime:l,data:s("\rappend 2")}]}],!0,void 0,()=>{},void 0,!0),t.strictEqual(d.versionId,1,"version should bump per append"),t.strictEqual(d.outputs[0].data.toString(),`append 1
append 2`),t.strictEqual(d.appendedSinceVersion(0,l),void 0,"compressing outputs should clear out previous versioned output buffers")})}),test("appending multiple different mime streaming outputs",async function(){await o([["var a = 1;","javascript",u.Code,[],{}]],n=>{const e=n.textModel;e.applyEdits([{index:0,editType:i.Output,append:!0,outputs:[{outputId:"append1",outputs:[{mime:l,data:s("stdout 1")},{mime:x,data:s("stderr 1")}]}]}],!0,void 0,()=>{},void 0,!0);const[d]=e.cells[0].outputs;t.strictEqual(d.versionId,0,"initial output version should be 0"),e.applyEdits([{editType:i.OutputItems,append:!0,outputId:"append1",items:[{mime:l,data:s("stdout 2")},{mime:x,data:s("stderr 2")}]}],!0,void 0,()=>{},void 0,!0),t.strictEqual(d.versionId,1,"version should bump per replace"),t.strictEqual(d.appendedSinceVersion(0,x)?.toString(),"stderr 2"),t.strictEqual(d.appendedSinceVersion(0,l)?.toString(),"stdout 2")})}),test("metadata",async function(){await o([["var a = 1;","javascript",u.Code,[],{}]],n=>{const e=n.textModel;t.throws(()=>{e.applyEdits([{index:Number.MAX_VALUE,editType:i.Metadata,metadata:{}}],!0,void 0,()=>{},void 0,!0)}),t.throws(()=>{e.applyEdits([{index:-1,editType:i.Metadata,metadata:{}}],!0,void 0,()=>{},void 0,!0)}),e.applyEdits([{index:0,editType:i.Metadata,metadata:{customProperty:15}}],!0,void 0,()=>{},void 0,!0),e.applyEdits([{index:0,editType:i.Metadata,metadata:{}}],!0,void 0,()=>{},void 0,!0),t.strictEqual(e.cells.length,1),t.strictEqual(e.cells[0].metadata.customProperty,void 0)})}),test("partial metadata",async function(){await o([["var a = 1;","javascript",u.Code,[],{}]],n=>{const e=n.textModel;e.applyEdits([{index:0,editType:i.PartialMetadata,metadata:{customProperty:15}}],!0,void 0,()=>{},void 0,!0),e.applyEdits([{index:0,editType:i.PartialMetadata,metadata:{}}],!0,void 0,()=>{},void 0,!0),t.strictEqual(e.cells.length,1),t.strictEqual(e.cells[0].metadata.customProperty,15)})}),test("multiple inserts in one edit",async function(){await o([["var a = 1;","javascript",u.Code,[],{}],["var b = 2;","javascript",u.Code,[],{}],["var c = 3;","javascript",u.Code,[],{}],["var d = 4;","javascript",u.Code,[],{}]],(n,e,d)=>{const a=n.textModel;let c;const m=a.onDidChangeContent(h=>{c=h}),y=[],g=a.onWillAddRemoveCells(h=>{y.push(h)}),I=a.versionId;a.applyEdits([{editType:i.Replace,index:1,count:1,cells:[]},{editType:i.Replace,index:1,count:0,cells:[d.add(new E(a.viewType,5,"var e = 5;","javascript",u.Code,[],v))]}],!0,void 0,()=>({kind:b.Index,focus:{start:0,end:1},selections:[{start:0,end:1}]}),void 0,!0),t.strictEqual(a.cells.length,4),t.strictEqual(a.cells[0].getValue(),"var a = 1;"),t.strictEqual(a.cells[1].getValue(),"var e = 5;"),t.strictEqual(a.cells[2].getValue(),"var c = 3;"),t.notStrictEqual(c,void 0),t.strictEqual(c.rawEvents.length,2),t.deepStrictEqual(c.endSelectionState?.selections,[{start:0,end:1}]),t.strictEqual(y.length,2),t.strictEqual(a.versionId,I+1),m.dispose(),g.dispose()})}),test("insert and metadata change in one edit",async function(){await o([["var a = 1;","javascript",u.Code,[],{}],["var b = 2;","javascript",u.Code,[],{}],["var c = 3;","javascript",u.Code,[],{}],["var d = 4;","javascript",u.Code,[],{}]],n=>{const e=n.textModel;let d;const a=e.onDidChangeContent(g=>{d=g}),c=[],m=e.onWillAddRemoveCells(g=>{c.push(g)}),y=e.versionId;e.applyEdits([{editType:i.Replace,index:1,count:1,cells:[]},{index:0,editType:i.Metadata,metadata:{}}],!0,void 0,()=>({kind:b.Index,focus:{start:0,end:1},selections:[{start:0,end:1}]}),void 0,!0),t.notStrictEqual(d,void 0),t.strictEqual(d.rawEvents.length,2),t.deepStrictEqual(d.endSelectionState?.selections,[{start:0,end:1}]),t.strictEqual(c.length,1),t.strictEqual(e.versionId,y+1),a.dispose(),m.dispose()})}),test("Updating appending/updating output in Notebooks does not work as expected #117273",async function(){await o([["var a = 1;","javascript",u.Code,[],{}]],n=>{const e=n.textModel;t.strictEqual(e.cells.length,1),t.strictEqual(e.cells[0].outputs.length,0);const d=e.applyEdits([{editType:i.Output,index:0,outputs:[{outputId:"out1",outputs:[{mime:"application/x.notebook.stream",data:f.wrap(new Uint8Array([1]))}]}],append:!1}],!0,void 0,()=>{},void 0,!1);t.ok(d),t.strictEqual(e.cells[0].outputs.length,1);const a=e.applyEdits([{editType:i.Output,index:0,outputs:[{outputId:"out2",outputs:[{mime:"application/x.notebook.stream",data:f.wrap(new Uint8Array([1]))}]}],append:!0}],!0,void 0,()=>{},void 0,!1);t.ok(a),t.strictEqual(e.cells[0].outputs.length,2)})}),test("Clearing output of an empty notebook makes it dirty #119608",async function(){await o([["var a = 1;","javascript",u.Code,[],{}],["var b = 2;","javascript",u.Code,[],{}]],(n,e,d)=>{const a=n.textModel;let c;d.add(a.onDidChangeContent(m=>{c=m}));{const m=a.applyEdits([{editType:i.Output,index:0,outputs:[{outputId:"out1",outputs:[{mime:"application/x.notebook.stream",data:f.wrap(new Uint8Array([1]))}]}],append:!1}],!0,void 0,()=>{},void 0,!1);t.ok(m),t.strictEqual(a.cells[0].outputs.length,1),t.ok(c)}{c=void 0;const m=a.applyEdits([{editType:i.Output,index:0,outputs:[],append:!1},{editType:i.Output,index:1,outputs:[],append:!1}],!0,void 0,()=>{},void 0,!1);t.ok(m),t.ok(c)}{c=void 0;const m=a.applyEdits([{editType:i.Output,index:0,outputs:[],append:!1},{editType:i.Output,index:1,outputs:[],append:!1}],!0,void 0,()=>{},void 0,!1);t.ok(m),t.ok(c===void 0)}})}),test("Cell metadata/output change should update version id and alternative id #121807",async function(){await o([["var a = 1;","javascript",u.Code,[],{}],["var b = 2;","javascript",u.Code,[],{}]],async(n,e)=>{t.strictEqual(n.textModel.versionId,0);const d="0_0,1;1,1";t.strictEqual(n.textModel.alternativeVersionId,d),n.textModel.applyEdits([{index:0,editType:i.Metadata,metadata:{inputCollapsed:!0}}],!0,void 0,()=>{},void 0,!0),t.strictEqual(n.textModel.versionId,1),t.notStrictEqual(n.textModel.alternativeVersionId,d);const a="1_0,1;1,1";t.strictEqual(n.textModel.alternativeVersionId,a),await e.undo(),t.strictEqual(n.textModel.versionId,2),t.strictEqual(n.textModel.alternativeVersionId,d),await e.redo(),t.strictEqual(n.textModel.versionId,3),t.notStrictEqual(n.textModel.alternativeVersionId,d),t.strictEqual(n.textModel.alternativeVersionId,a),n.textModel.applyEdits([{index:1,editType:i.Metadata,metadata:{inputCollapsed:!0}}],!0,void 0,()=>{},void 0,!0),t.strictEqual(n.textModel.versionId,4),t.strictEqual(n.textModel.alternativeVersionId,"4_0,1;1,1"),await e.undo(),t.strictEqual(n.textModel.versionId,5),t.strictEqual(n.textModel.alternativeVersionId,a)})}),test("Destructive sorting in _doApplyEdits #121994",async function(){await o([["var a = 1;","javascript",u.Code,[{outputId:"i42",outputs:[{mime:"m/ime",data:s("test")}]}],{}]],async n=>{const e=n.textModel;t.strictEqual(e.cells[0].outputs.length,1),t.strictEqual(e.cells[0].outputs[0].outputs.length,1),t.deepStrictEqual(e.cells[0].outputs[0].outputs[0].data,s("test"));const d=[{editType:i.Output,handle:0,outputs:[]},{editType:i.Output,handle:0,append:!0,outputs:[{outputId:"newOutput",outputs:[{mime:p.text,data:s("cba")},{mime:"application/foo",data:s("cba")}]}]}];n.textModel.applyEdits(d,!0,void 0,()=>{},void 0,!0),t.strictEqual(e.cells[0].outputs.length,1),t.strictEqual(e.cells[0].outputs[0].outputs.length,2)})}),test("Destructive sorting in _doApplyEdits #121994. cell splice between output changes",async function(){await o([["var a = 1;","javascript",u.Code,[{outputId:"i42",outputs:[{mime:"m/ime",data:s("test")}]}],{}],["var b = 2;","javascript",u.Code,[{outputId:"i43",outputs:[{mime:"m/ime",data:s("test")}]}],{}],["var c = 3;","javascript",u.Code,[{outputId:"i44",outputs:[{mime:"m/ime",data:s("test")}]}],{}]],async n=>{const e=n.textModel,d=[{editType:i.Output,index:0,outputs:[]},{editType:i.Replace,index:1,count:1,cells:[]},{editType:i.Output,index:2,append:!0,outputs:[{outputId:"newOutput",outputs:[{mime:p.text,data:s("cba")},{mime:"application/foo",data:s("cba")}]}]}];n.textModel.applyEdits(d,!0,void 0,()=>{},void 0,!0),t.strictEqual(e.cells.length,2),t.strictEqual(e.cells[0].outputs.length,0),t.strictEqual(e.cells[1].outputs.length,2),t.strictEqual(e.cells[1].outputs[0].outputId,"i44"),t.strictEqual(e.cells[1].outputs[1].outputId,"newOutput")})}),test("Destructive sorting in _doApplyEdits #121994. cell splice between output changes 2",async function(){await o([["var a = 1;","javascript",u.Code,[{outputId:"i42",outputs:[{mime:"m/ime",data:s("test")}]}],{}],["var b = 2;","javascript",u.Code,[{outputId:"i43",outputs:[{mime:"m/ime",data:s("test")}]}],{}],["var c = 3;","javascript",u.Code,[{outputId:"i44",outputs:[{mime:"m/ime",data:s("test")}]}],{}]],async n=>{const e=n.textModel,d=[{editType:i.Output,index:1,append:!0,outputs:[{outputId:"newOutput",outputs:[{mime:p.text,data:s("cba")},{mime:"application/foo",data:s("cba")}]}]},{editType:i.Replace,index:1,count:1,cells:[]},{editType:i.Output,index:1,append:!0,outputs:[{outputId:"newOutput2",outputs:[{mime:p.text,data:s("cba")},{mime:"application/foo",data:s("cba")}]}]}];n.textModel.applyEdits(d,!0,void 0,()=>{},void 0,!0),t.strictEqual(e.cells.length,2),t.strictEqual(e.cells[0].outputs.length,1),t.strictEqual(e.cells[1].outputs.length,1),t.strictEqual(e.cells[1].outputs[0].outputId,"i44")})}),test("Output edits splice",async function(){await o([["var a = 1;","javascript",u.Code,[],{}]],n=>{const e=n.textModel;t.strictEqual(e.cells.length,1),t.strictEqual(e.cells[0].outputs.length,0);const d=e.applyEdits([{editType:i.Output,index:0,outputs:[{outputId:"out1",outputs:[{mime:"application/x.notebook.stream",data:s("1")}]},{outputId:"out2",outputs:[{mime:"application/x.notebook.stream",data:s("2")}]},{outputId:"out3",outputs:[{mime:"application/x.notebook.stream",data:s("3")}]},{outputId:"out4",outputs:[{mime:"application/x.notebook.stream",data:s("4")}]}],append:!1}],!0,void 0,()=>{},void 0,!1);t.ok(d),t.strictEqual(e.cells[0].outputs.length,4);const a=e.applyEdits([{editType:i.Output,index:0,outputs:[{outputId:"out1",outputs:[{mime:"application/x.notebook.stream",data:s("1")}]},{outputId:"out5",outputs:[{mime:"application/x.notebook.stream",data:s("5")}]},{outputId:"out3",outputs:[{mime:"application/x.notebook.stream",data:s("3")}]},{outputId:"out6",outputs:[{mime:"application/x.notebook.stream",data:s("6")}]}],append:!1}],!0,void 0,()=>{},void 0,!1);t.ok(a),t.strictEqual(e.cells[0].outputs.length,4),t.strictEqual(e.cells[0].outputs[0].outputId,"out1"),t.strictEqual(e.cells[0].outputs[1].outputId,"out5"),t.strictEqual(e.cells[0].outputs[2].outputId,"out3"),t.strictEqual(e.cells[0].outputs[3].outputId,"out6")})}),test("computeEdits no insert",async function(){await o([["var a = 1;","javascript",u.Code,[],{}]],n=>{const e=n.textModel,d=r.computeEdits(e,[{source:"var a = 1;",language:"javascript",cellKind:u.Code,mime:void 0,outputs:[],metadata:void 0}]);t.deepStrictEqual(d,[{editType:i.Metadata,index:0,metadata:{}}])})}),test("computeEdits cell content changed",async function(){await o([["var a = 1;","javascript",u.Code,[],{}]],n=>{const e=n.textModel,d=[{source:"var a = 2;",language:"javascript",cellKind:u.Code,mime:void 0,outputs:[],metadata:void 0}],a=r.computeEdits(e,d);t.deepStrictEqual(a,[{editType:i.Replace,index:0,count:1,cells:d}])})}),test("computeEdits last cell content changed",async function(){await o([["var a = 1;","javascript",u.Code,[],{}],["var b = 1;","javascript",u.Code,[],{}]],n=>{const e=n.textModel,d=[{source:"var a = 1;",language:"javascript",cellKind:u.Code,mime:void 0,outputs:[],metadata:void 0},{source:"var b = 2;",language:"javascript",cellKind:u.Code,mime:void 0,outputs:[],metadata:void 0}],a=r.computeEdits(e,d);t.deepStrictEqual(a,[{editType:i.Metadata,index:0,metadata:{}},{editType:i.Replace,index:1,count:1,cells:d.slice(1)}])})}),test("computeEdits first cell content changed",async function(){await o([["var a = 1;","javascript",u.Code,[],{}],["var b = 1;","javascript",u.Code,[],{}]],n=>{const e=n.textModel,d=[{source:"var a = 2;",language:"javascript",cellKind:u.Code,mime:void 0,outputs:[],metadata:void 0},{source:"var b = 1;",language:"javascript",cellKind:u.Code,mime:void 0,outputs:[],metadata:void 0}],a=r.computeEdits(e,d);t.deepStrictEqual(a,[{editType:i.Replace,index:0,count:1,cells:d.slice(0,1)},{editType:i.Metadata,index:1,metadata:{}}])})}),test("computeEdits middle cell content changed",async function(){await o([["var a = 1;","javascript",u.Code,[],{}],["var b = 1;","javascript",u.Code,[],{}],["var c = 1;","javascript",u.Code,[],{}]],n=>{const e=n.textModel,d=[{source:"var a = 1;",language:"javascript",cellKind:u.Code,mime:void 0,outputs:[],metadata:void 0},{source:"var b = 2;",language:"javascript",cellKind:u.Code,mime:void 0,outputs:[],metadata:void 0},{source:"var c = 1;",language:"javascript",cellKind:u.Code,mime:void 0,outputs:[],metadata:void 0}],a=r.computeEdits(e,d);t.deepStrictEqual(a,[{editType:i.Metadata,index:0,metadata:{}},{editType:i.Replace,index:1,count:1,cells:d.slice(1,2)},{editType:i.Metadata,index:2,metadata:{}}])})}),test("computeEdits cell metadata changed",async function(){await o([["var a = 1;","javascript",u.Code,[],{}],["var b = 1;","javascript",u.Code,[],{}]],n=>{const e=n.textModel,d=[{source:"var a = 1;",language:"javascript",cellKind:u.Code,mime:void 0,outputs:[],metadata:{name:"foo"}},{source:"var b = 1;",language:"javascript",cellKind:u.Code,mime:void 0,outputs:[],metadata:void 0}],a=r.computeEdits(e,d);t.deepStrictEqual(a,[{editType:i.Metadata,index:0,metadata:{name:"foo"}},{editType:i.Metadata,index:1,metadata:{}}])})}),test("computeEdits cell language changed",async function(){await o([["var a = 1;","javascript",u.Code,[],{}],["var b = 1;","javascript",u.Code,[],{}]],n=>{const e=n.textModel,d=[{source:"var a = 1;",language:"typescript",cellKind:u.Code,mime:void 0,outputs:[],metadata:void 0},{source:"var b = 1;",language:"javascript",cellKind:u.Code,mime:void 0,outputs:[],metadata:void 0}],a=r.computeEdits(e,d);t.deepStrictEqual(a,[{editType:i.Replace,index:0,count:1,cells:d.slice(0,1)},{editType:i.Metadata,index:1,metadata:{}}])})}),test("computeEdits cell kind changed",async function(){await o([["var a = 1;","javascript",u.Code,[],{}],["var b = 1;","javascript",u.Code,[],{}]],n=>{const e=n.textModel,d=[{source:"var a = 1;",language:"javascript",cellKind:u.Code,mime:void 0,outputs:[],metadata:void 0},{source:"var b = 1;",language:"javascript",cellKind:u.Markup,mime:void 0,outputs:[],metadata:void 0}],a=r.computeEdits(e,d);t.deepStrictEqual(a,[{editType:i.Metadata,index:0,metadata:{}},{editType:i.Replace,index:1,count:1,cells:d.slice(1)}])})}),test("computeEdits cell metadata & content changed",async function(){await o([["var a = 1;","javascript",u.Code,[],{}],["var b = 1;","javascript",u.Code,[],{}]],n=>{const e=n.textModel,d=[{source:"var a = 1;",language:"javascript",cellKind:u.Code,mime:void 0,outputs:[],metadata:{name:"foo"}},{source:"var b = 2;",language:"javascript",cellKind:u.Code,mime:void 0,outputs:[],metadata:{name:"bar"}}],a=r.computeEdits(e,d);t.deepStrictEqual(a,[{editType:i.Metadata,index:0,metadata:{name:"foo"}},{editType:i.Replace,index:1,count:1,cells:d.slice(1)}])})}),test("computeEdits cell internal metadata changed",async function(){await o([["var a = 1;","javascript",u.Code,[],{}],["var b = 1;","javascript",u.Code,[],{}]],n=>{const e=n.textModel,d=[{source:"var a = 1;",language:"javascript",cellKind:u.Code,mime:void 0,outputs:[],metadata:void 0,internalMetadata:{executionOrder:1}},{source:"var b = 1;",language:"javascript",cellKind:u.Code,mime:void 0,outputs:[],metadata:void 0}],a=r.computeEdits(e,d);t.deepStrictEqual(a,[{editType:i.Replace,index:0,count:1,cells:d.slice(0,1)},{editType:i.Metadata,index:1,metadata:{}}])})}),test("computeEdits cell insertion",async function(){await o([["var a = 1;","javascript",u.Code,[],{}],["var b = 1;","javascript",u.Code,[],{}]],n=>{const e=n.textModel,d=[{source:"var a = 1;",language:"javascript",cellKind:u.Code,mime:void 0,outputs:[],metadata:void 0},{source:"var c = 1;",language:"javascript",cellKind:u.Code,mime:void 0,outputs:[],metadata:void 0},{source:"var b = 1;",language:"javascript",cellKind:u.Code,mime:void 0,outputs:[],metadata:{foo:"bar"}}],a=r.computeEdits(e,d);t.deepStrictEqual(a,[{editType:i.Metadata,index:0,metadata:{}},{editType:i.Replace,index:1,count:0,cells:d.slice(1,2)},{editType:i.Metadata,index:1,metadata:{foo:"bar"}}]),e.applyEdits(a,!0,void 0,()=>{},void 0,!0),t.equal(e.cells.length,3),t.equal(e.cells[1].getValue(),"var c = 1;"),t.equal(e.cells[2].getValue(),"var b = 1;"),t.deepStrictEqual(e.cells[2].metadata,{foo:"bar"})})}),test("computeEdits output changed",async function(){await o([["var a = 1;","javascript",u.Code,[],{}],["var b = 1;","javascript",u.Code,[],{}]],n=>{const e=n.textModel,d=[{source:"var a = 1;",language:"javascript",cellKind:u.Code,mime:void 0,outputs:[{outputId:"someId",outputs:[{mime:p.markdown,data:s("_World_")}]}],metadata:void 0},{source:"var b = 1;",language:"javascript",cellKind:u.Code,mime:void 0,outputs:[],metadata:{foo:"bar"}}],a=r.computeEdits(e,d);t.deepStrictEqual(a,[{editType:i.Metadata,index:0,metadata:{}},{editType:i.Output,index:0,outputs:[{outputId:"someId",outputs:[{mime:p.markdown,data:s("_World_")}]}],append:!1},{editType:i.Metadata,index:1,metadata:{foo:"bar"}}]),e.applyEdits(a,!0,void 0,()=>{},void 0,!0),t.equal(e.cells.length,2),t.strictEqual(e.cells[0].outputs.length,1),t.equal(e.cells[0].outputs[0].outputId,"someId"),t.equal(e.cells[0].outputs[0].outputs[0].data.toString(),"_World_")})}),test("computeEdits output items changed",async function(){await o([["var a = 1;","javascript",u.Code,[{outputId:"someId",outputs:[{mime:p.markdown,data:s("_Hello_")}]}],{}],["var b = 1;","javascript",u.Code,[],{}]],n=>{const e=n.textModel,d=[{source:"var a = 1;",language:"javascript",cellKind:u.Code,mime:void 0,outputs:[{outputId:"someId",outputs:[{mime:p.markdown,data:s("_World_")}]}],metadata:void 0},{source:"var b = 1;",language:"javascript",cellKind:u.Code,mime:void 0,outputs:[],metadata:{foo:"bar"}}],a=r.computeEdits(e,d);t.deepStrictEqual(a,[{editType:i.Metadata,index:0,metadata:{}},{editType:i.OutputItems,outputId:"someId",items:[{mime:p.markdown,data:s("_World_")}],append:!1},{editType:i.Metadata,index:1,metadata:{foo:"bar"}}]),e.applyEdits(a,!0,void 0,()=>{},void 0,!0),t.equal(e.cells.length,2),t.strictEqual(e.cells[0].outputs.length,1),t.equal(e.cells[0].outputs[0].outputId,"someId"),t.equal(e.cells[0].outputs[0].outputs[0].data.toString(),"_World_")})}),test("Append multiple text/plain output items",async function(){await o([["var a = 1;","javascript",u.Code,[{outputId:"1",outputs:[{mime:"text/plain",data:s("foo")}]}],{}]],n=>{const e=n.textModel,d=[{editType:i.OutputItems,outputId:"1",append:!0,items:[{mime:"text/plain",data:f.fromString("bar")},{mime:"text/plain",data:f.fromString("baz")}]}];e.applyEdits(d,!0,void 0,()=>{},void 0,!0),t.equal(e.cells.length,1),t.equal(e.cells[0].outputs.length,1),t.equal(e.cells[0].outputs[0].outputs.length,3),t.equal(e.cells[0].outputs[0].outputs[0].mime,"text/plain"),t.equal(e.cells[0].outputs[0].outputs[0].data.toString(),"foo"),t.equal(e.cells[0].outputs[0].outputs[1].mime,"text/plain"),t.equal(e.cells[0].outputs[0].outputs[1].data.toString(),"bar"),t.equal(e.cells[0].outputs[0].outputs[2].mime,"text/plain"),t.equal(e.cells[0].outputs[0].outputs[2].data.toString(),"baz")})}),test("Append multiple stdout stream output items to an output with another mime",async function(){await o([["var a = 1;","javascript",u.Code,[{outputId:"1",outputs:[{mime:"text/plain",data:s("foo")}]}],{}]],n=>{const e=n.textModel,d=[{editType:i.OutputItems,outputId:"1",append:!0,items:[{mime:"application/vnd.code.notebook.stdout",data:f.fromString("bar")},{mime:"application/vnd.code.notebook.stdout",data:f.fromString("baz")}]}];e.applyEdits(d,!0,void 0,()=>{},void 0,!0),t.equal(e.cells.length,1),t.equal(e.cells[0].outputs.length,1),t.equal(e.cells[0].outputs[0].outputs.length,3),t.equal(e.cells[0].outputs[0].outputs[0].mime,"text/plain"),t.equal(e.cells[0].outputs[0].outputs[0].data.toString(),"foo"),t.equal(e.cells[0].outputs[0].outputs[1].mime,"application/vnd.code.notebook.stdout"),t.equal(e.cells[0].outputs[0].outputs[1].data.toString(),"bar"),t.equal(e.cells[0].outputs[0].outputs[2].mime,"application/vnd.code.notebook.stdout"),t.equal(e.cells[0].outputs[0].outputs[2].data.toString(),"baz")})}),test("Compress multiple stdout stream output items",async function(){await o([["var a = 1;","javascript",u.Code,[{outputId:"1",outputs:[{mime:"application/vnd.code.notebook.stdout",data:s("foo")}]}],{}]],n=>{const e=n.textModel,d=[{editType:i.OutputItems,outputId:"1",append:!0,items:[{mime:"application/vnd.code.notebook.stdout",data:f.fromString("bar")},{mime:"application/vnd.code.notebook.stdout",data:f.fromString("baz")}]}];e.applyEdits(d,!0,void 0,()=>{},void 0,!0),t.equal(e.cells.length,1),t.equal(e.cells[0].outputs.length,1),t.equal(e.cells[0].outputs[0].outputs.length,1),t.equal(e.cells[0].outputs[0].outputs[0].mime,"application/vnd.code.notebook.stdout"),t.equal(e.cells[0].outputs[0].outputs[0].data.toString(),"foobarbaz")})}),test("Compress multiple stderr stream output items",async function(){await o([["var a = 1;","javascript",u.Code,[{outputId:"1",outputs:[{mime:"application/vnd.code.notebook.stderr",data:s("foo")}]}],{}]],n=>{const e=n.textModel,d=[{editType:i.OutputItems,outputId:"1",append:!0,items:[{mime:"application/vnd.code.notebook.stderr",data:f.fromString("bar")},{mime:"application/vnd.code.notebook.stderr",data:f.fromString("baz")}]}];e.applyEdits(d,!0,void 0,()=>{},void 0,!0),t.equal(e.cells.length,1),t.equal(e.cells[0].outputs.length,1),t.equal(e.cells[0].outputs[0].outputs.length,1),t.equal(e.cells[0].outputs[0].outputs[0].mime,"application/vnd.code.notebook.stderr"),t.equal(e.cells[0].outputs[0].outputs[0].data.toString(),"foobarbaz")})}),test("findNextMatch",async function(){await o([["var a = 1;","javascript",u.Code,[],{}],["var b = 2;","javascript",u.Code,[],{}],["var c = 3;","javascript",u.Code,[],{}],["var d = 4;","javascript",u.Code,[],{}]],(n,e)=>{const d=e.notebookDocument;let a=d.findNextMatch("var",{cellIndex:0,position:{lineNumber:1,column:1}},!1,!1,null);t.ok(a),t.strictEqual(a.match.range.startLineNumber,1),t.strictEqual(a.match.range.startColumn,1),a=d.findNextMatch("b",{cellIndex:1,position:{lineNumber:1,column:1}},!1,!1,null),t.ok(a),t.strictEqual(a.match.range.startLineNumber,1),t.strictEqual(a.match.range.startColumn,5),a=d.findNextMatch("c",{cellIndex:2,position:{lineNumber:1,column:1}},!1,!1,null),t.ok(a),t.strictEqual(a.match.range.startLineNumber,1),t.strictEqual(a.match.range.startColumn,5),a=d.findNextMatch("d",{cellIndex:3,position:{lineNumber:1,column:1}},!1,!1,null),t.ok(a),t.strictEqual(a.match.range.startLineNumber,1),t.strictEqual(a.match.range.startColumn,5),a=d.findNextMatch("e",{cellIndex:0,position:{lineNumber:1,column:1}},!1,!1,null),t.strictEqual(a,null)})}),test("findNextMatch 2",async function(){await o([["var a = 1; var a = 2;","javascript",u.Code,[],{}],["var b = 2;","javascript",u.Code,[],{}],["var c = 3;","javascript",u.Code,[],{}],["var d = 4;","javascript",u.Code,[],{}]],(n,e)=>{const d=e.notebookDocument;let a=d.findNextMatch("var",{cellIndex:0,position:{lineNumber:1,column:1}},!1,!1,null);t.ok(a),t.strictEqual(a.match.range.startLineNumber,1),t.strictEqual(a.match.range.startColumn,1),a=d.findNextMatch("b",{cellIndex:1,position:{lineNumber:1,column:1}},!1,!1,null),t.ok(a),t.strictEqual(a.match.range.startLineNumber,1),t.strictEqual(a.match.range.startColumn,5),a=d.findNextMatch("c",{cellIndex:2,position:{lineNumber:1,column:1}},!1,!1,null),t.ok(a),t.strictEqual(a.match.range.startLineNumber,1),t.strictEqual(a.match.range.startColumn,5),a=d.findNextMatch("d",{cellIndex:3,position:{lineNumber:1,column:1}},!1,!1,null),t.ok(a),t.strictEqual(a.match.range.startLineNumber,1),t.strictEqual(a.match.range.startColumn,5),a=d.findNextMatch("e",{cellIndex:0,position:{lineNumber:1,column:1}},!1,!1,null),t.strictEqual(a,null),a=d.findNextMatch("var",{cellIndex:0,position:{lineNumber:1,column:1}},!1,!1,null),t.ok(a),t.strictEqual(a.match.range.startLineNumber,1),t.strictEqual(a.match.range.startColumn,1),a=d.findNextMatch("var",{cellIndex:0,position:{lineNumber:1,column:5}},!1,!1,null),t.ok(a),t.strictEqual(a.match.range.startLineNumber,1),t.strictEqual(a.match.range.startColumn,12),a=d.findNextMatch("a",{cellIndex:0,position:{lineNumber:1,column:10}},!1,!1,null),t.ok(a),t.strictEqual(a.match.range.startLineNumber,1),t.strictEqual(a.match.range.startColumn,13),a=d.findNextMatch("var",{cellIndex:0,position:{lineNumber:1,column:20}},!1,!1,null),t.ok(a),t.strictEqual(a.match.range.startLineNumber,1),t.strictEqual(a.match.range.startColumn,1)})})});
