var L=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var w=(h,l,t,e)=>{for(var i=e>1?void 0:e?H(l,t):l,s=h.length-1,a;s>=0;s--)(a=h[s])&&(i=(e?a(l,t,i):a(i))||i);return e&&i&&L(l,t,i),i},r=(h,l)=>(t,e)=>l(t,e,h);import*as o from"../../../../../../base/browser/dom.js";import{renderIcon as f}from"../../../../../../base/browser/ui/iconLabel/iconLabels.js";import{disposableTimeout as N,raceCancellation as b}from"../../../../../../base/common/async.js";import{CancellationTokenSource as E}from"../../../../../../base/common/cancellation.js";import{Codicon as y}from"../../../../../../base/common/codicons.js";import{ThemeIcon as D}from"../../../../../../base/common/themables.js";import{Disposable as x,DisposableStore as I,MutableDisposable as F,toDisposable as k}from"../../../../../../base/common/lifecycle.js";import"../../../../../../editor/browser/editorBrowser.js";import{CodeEditorWidget as A}from"../../../../../../editor/browser/widget/codeEditor/codeEditorWidget.js";import"../../../../../../editor/common/config/editorOptions.js";import{EditorContextKeys as T}from"../../../../../../editor/common/editorContextKeys.js";import{ILanguageService as P}from"../../../../../../editor/common/languages/language.js";import{tokenizeToStringSync as _}from"../../../../../../editor/common/languages/textToHtmlTokenizer.js";import"../../../../../../editor/common/model.js";import{localize as S}from"../../../../../../nls.js";import{IAccessibilityService as W}from"../../../../../../platform/accessibility/common/accessibility.js";import{IConfigurationService as U}from"../../../../../../platform/configuration/common/configuration.js";import{IContextKeyService as O}from"../../../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as z}from"../../../../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as R}from"../../../../../../platform/instantiation/common/serviceCollection.js";import{IKeybindingService as V}from"../../../../../../platform/keybinding/common/keybinding.js";import{CellEditState as u,CellFocusMode as d,CellFoldingState as m,EXPAND_CELL_INPUT_COMMAND_ID as K}from"../../notebookBrowser.js";import{collapsedIcon as B,expandedIcon as $}from"../../notebookIcons.js";import{CellEditorOptions as X}from"./cellEditorOptions.js";import"../notebookRenderingCommon.js";import"../../viewModel/markupCellViewModel.js";import{WordHighlighterContribution as M}from"../../../../../../editor/contrib/wordHighlighter/browser/wordHighlighter.js";let g=class extends x{constructor(t,e,i,s,a,n,c,v,p,C){super();this.notebookEditor=t;this.viewCell=e;this.templateData=i;this.renderedEditors=s;this.accessibilityService=a;this.contextKeyService=n;this.instantiationService=c;this.languageService=v;this.configurationService=p;this.keybindingService=C;this.constructDOM(),this.editorPart=i.editorPart,this.cellEditorOptions=this._register(new X(this.notebookEditor.getBaseCellEditorOptions(e.language),this.notebookEditor.notebookOptions,this.configurationService)),this.cellEditorOptions.setLineNumbers(this.viewCell.lineNumbers),this.editorOptions=this.cellEditorOptions.getValue(this.viewCell.internalMetadata,this.viewCell.uri),this._register(k(()=>s.delete(this.viewCell))),this.registerListeners(),this.templateData.cellParts.scheduleRenderCell(this.viewCell),this._register(k(()=>{this.templateData.cellParts.unrenderCell(this.viewCell)})),this._register(this.accessibilityService.onDidChangeScreenReaderOptimized(()=>{this.viewUpdate()})),this.updateForHover(),this.updateForFocusModeChange(),this.foldingState=e.foldingState,this.layoutFoldingIndicator(),this.updateFoldingIconShowClass(),this.viewCell.layoutInfo.totalHeight>0&&this.relayoutCell(),this.applyDecorations(),this.viewUpdate(),this.layoutCellParts(),this._register(this.viewCell.onDidChangeLayout(()=>{this.layoutCellParts()}))}editor=null;markdownAccessibilityContainer;editorPart;localDisposables=this._register(new I);focusSwitchDisposable=this._register(new F);editorDisposables=this._register(new I);foldingState;cellEditorOptions;editorOptions;_isDisposed=!1;layoutCellParts(){this.templateData.cellParts.updateInternalLayoutNow(this.viewCell)}constructDOM(){const t=`aria-markup-cell-${this.viewCell.id}`;this.markdownAccessibilityContainer=this.templateData.cellContainer,this.markdownAccessibilityContainer.id=t,this.markdownAccessibilityContainer.style.height="1px",this.markdownAccessibilityContainer.style.overflow="hidden",this.markdownAccessibilityContainer.style.position="absolute",this.markdownAccessibilityContainer.style.top="100000px",this.markdownAccessibilityContainer.style.left="10000px",this.markdownAccessibilityContainer.ariaHidden="false",this.templateData.rootContainer.setAttribute("aria-describedby",t),this.templateData.container.classList.toggle("webview-backed-markdown-cell",!0)}registerListeners(){this._register(this.viewCell.onDidChangeState(t=>{this.templateData.cellParts.updateState(this.viewCell,t)})),this._register(this.viewCell.model.onDidChangeMetadata(()=>{this.viewUpdate()})),this._register(this.viewCell.onDidChangeState(t=>{if((t.editStateChanged||t.contentChanged)&&this.viewUpdate(),t.focusModeChanged&&this.updateForFocusModeChange(),t.foldingStateChanged){const e=this.viewCell.foldingState;e!==this.foldingState&&(this.foldingState=e,this.layoutFoldingIndicator())}t.cellIsHoveredChanged&&this.updateForHover(),t.inputCollapsedChanged&&(this.updateCollapsedState(),this.viewUpdate()),t.cellLineNumberChanged&&this.cellEditorOptions.setLineNumbers(this.viewCell.lineNumbers)})),this._register(this.notebookEditor.notebookOptions.onDidChangeOptions(t=>{t.showFoldingControls&&this.updateFoldingIconShowClass()})),this._register(this.viewCell.onDidChangeLayout(t=>{const e=this.editor?.getLayoutInfo();t.outerWidth&&this.viewCell.getEditState()===u.Editing&&e&&e.width!==this.viewCell.layoutInfo.editorWidth&&this.onCellEditorWidthChange()})),this._register(this.cellEditorOptions.onDidChange(()=>this.updateMarkupCellOptions()))}updateMarkupCellOptions(){if(this.updateEditorOptions(this.cellEditorOptions.getUpdatedValue(this.viewCell.internalMetadata,this.viewCell.uri)),this.editor){this.editor.updateOptions(this.cellEditorOptions.getUpdatedValue(this.viewCell.internalMetadata,this.viewCell.uri));const t=new E;this._register({dispose(){t.dispose(!0)}}),b(this.viewCell.resolveTextModel(),t.token).then(e=>{this._isDisposed||e&&e.updateOptions({indentSize:this.cellEditorOptions.indentSize,tabSize:this.cellEditorOptions.tabSize,insertSpaces:this.cellEditorOptions.insertSpaces})})}}updateCollapsedState(){this.viewCell.isInputCollapsed?this.notebookEditor.hideMarkupPreviews([this.viewCell]):this.notebookEditor.unhideMarkupPreviews([this.viewCell])}updateForHover(){this.templateData.container.classList.toggle("markdown-cell-hover",this.viewCell.cellIsHovered)}updateForFocusModeChange(){this.viewCell.focusMode===d.Editor&&this.focusEditorIfNeeded(),this.templateData.container.classList.toggle("cell-editor-focus",this.viewCell.focusMode===d.Editor)}applyDecorations(){this._register(this.viewCell.onCellDecorationsChanged(t=>{t.added.forEach(e=>{e.className&&(this.notebookEditor.deltaCellContainerClassNames(this.viewCell.id,[e.className],[]),this.templateData.rootContainer.classList.add(e.className))}),t.removed.forEach(e=>{e.className&&(this.notebookEditor.deltaCellContainerClassNames(this.viewCell.id,[],[e.className]),this.templateData.rootContainer.classList.remove(e.className))})})),this.viewCell.getCellDecorations().forEach(t=>{t.className&&(this.notebookEditor.deltaCellContainerClassNames(this.viewCell.id,[t.className],[]),this.templateData.rootContainer.classList.add(t.className))})}dispose(){this._isDisposed=!0,this.notebookEditor.getActiveCell()===this.viewCell&&this.viewCell.focusMode===d.Editor&&(this.notebookEditor.hasEditorFocus()||this.notebookEditor.getDomNode().ownerDocument.activeElement===this.notebookEditor.getDomNode().ownerDocument.body)&&this.notebookEditor.focusContainer(),this.viewCell.detachTextEditor(),super.dispose()}updateFoldingIconShowClass(){const t=this.notebookEditor.notebookOptions.getDisplayOptions().showFoldingControls;this.templateData.foldingIndicator.classList.remove("mouseover","always"),this.templateData.foldingIndicator.classList.add(t)}viewUpdate(){this.viewCell.isInputCollapsed?this.viewUpdateCollapsed():this.viewCell.getEditState()===u.Editing?this.viewUpdateEditing():this.viewUpdatePreview()}viewUpdateCollapsed(){o.show(this.templateData.cellInputCollapsedContainer),o.hide(this.editorPart),this.templateData.cellInputCollapsedContainer.innerText="",o.append(this.templateData.cellInputCollapsedContainer,o.$("span")).classList.add(...D.asClassNameArray(y.markdown));const e=o.$("div");e.classList.add("cell-collapse-preview");const i=this.getRichText(this.viewCell.textBuffer,this.viewCell.language);o.safeInnerHtml(e,i),this.templateData.cellInputCollapsedContainer.appendChild(e);const s=o.append(e,o.$("span.expandInputIcon"));s.classList.add(...D.asClassNameArray(y.more));const a=this.keybindingService.lookupKeybinding(K);a&&(e.title=S("cellExpandInputButtonLabelWithDoubleClick","Double-click to expand cell input ({0})",a.getLabel()),s.title=S("cellExpandInputButtonLabel","Expand Cell Input ({0})",a.getLabel())),this.markdownAccessibilityContainer.ariaHidden="true",this.templateData.container.classList.toggle("input-collapsed",!0),this.viewCell.renderedMarkdownHeight=0,this.viewCell.layoutChange({})}getRichText(t,e){return _(this.languageService,t.getLineContent(1),e)}viewUpdateEditing(){let t;if(o.show(this.editorPart),this.markdownAccessibilityContainer.ariaHidden="true",o.hide(this.templateData.cellInputCollapsedContainer),this.notebookEditor.hideMarkupPreviews([this.viewCell]),this.templateData.container.classList.toggle("input-collapsed",!1),this.templateData.container.classList.toggle("markdown-cell-edit-mode",!0),this.editor&&this.editor.hasModel())t=this.editor.getContentHeight(),this.viewCell.attachTextEditor(this.editor),this.focusEditorIfNeeded(),this.bindEditorListeners(this.editor),this.editor.layout({width:this.viewCell.layoutInfo.editorWidth,height:t});else{this.editorDisposables.clear();const e=this.notebookEditor.notebookOptions.computeMarkdownCellEditorWidth(this.notebookEditor.getLayoutInfo().width),i=this.viewCell.lineCount,s=this.viewCell.layoutInfo.fontInfo?.lineHeight||17,a=this.notebookEditor.notebookOptions.computeEditorPadding(this.viewCell.internalMetadata,this.viewCell.uri);t=Math.max(i,1)*s+a.top+a.bottom,this.templateData.editorContainer.innerText="";const n=this.contextKeyService.createScoped(this.templateData.editorPart);T.inCompositeEditor.bindTo(n).set(!0);const c=this.editorDisposables.add(this.instantiationService.createChild(new R([O,n])));this.editorDisposables.add(n),this.editor=this.editorDisposables.add(c.createInstance(A,this.templateData.editorContainer,{...this.editorOptions,dimension:{width:e,height:t}},{contributions:this.notebookEditor.creationOptions.cellEditorContributions})),this.templateData.currentEditor=this.editor,this.editorDisposables.add(this.editor.onDidBlurEditorWidget(()=>{this.editor&&M.get(this.editor)?.stopHighlighting()})),this.editorDisposables.add(this.editor.onDidFocusEditorWidget(()=>{this.editor&&M.get(this.editor)?.restoreViewState(!0)}));const v=new E;this.editorDisposables.add({dispose(){v.dispose(!0)}}),b(this.viewCell.resolveTextModel(),v.token).then(p=>{if(!p)return;this.editor.setModel(p),p.updateOptions({indentSize:this.cellEditorOptions.indentSize,tabSize:this.cellEditorOptions.tabSize,insertSpaces:this.cellEditorOptions.insertSpaces});const C=this.editor.getContentHeight();C!==t&&(this.editor.layout({width:e,height:C}),t=C),this.viewCell.attachTextEditor(this.editor),this.viewCell.getEditState()===u.Editing&&this.focusEditorIfNeeded(),this.bindEditorListeners(this.editor),this.viewCell.editorHeight=t})}this.viewCell.editorHeight=t,this.focusEditorIfNeeded(),this.renderedEditors.set(this.viewCell,this.editor)}viewUpdatePreview(){this.viewCell.detachTextEditor(),o.hide(this.editorPart),o.hide(this.templateData.cellInputCollapsedContainer),this.markdownAccessibilityContainer.ariaHidden="false",this.templateData.container.classList.toggle("input-collapsed",!1),this.templateData.container.classList.toggle("markdown-cell-edit-mode",!1),this.renderedEditors.delete(this.viewCell),this.markdownAccessibilityContainer.innerText="",this.viewCell.renderedHtml&&(this.accessibilityService.isScreenReaderOptimized()?o.safeInnerHtml(this.markdownAccessibilityContainer,this.viewCell.renderedHtml):o.clearNode(this.markdownAccessibilityContainer)),this.notebookEditor.createMarkupPreview(this.viewCell)}focusEditorIfNeeded(){if(this.viewCell.focusMode===d.Editor&&(this.notebookEditor.hasEditorFocus()||this.notebookEditor.getDomNode().ownerDocument.activeElement===this.notebookEditor.getDomNode().ownerDocument.body)){if(!this.editor)return;this.editor.focus();const t=this.editor.getSelection();if(!t)return;this.notebookEditor.revealRangeInViewAsync(this.viewCell,t)}}layoutEditor(t){this.editor?.layout(t)}onCellEditorWidthChange(){const t=this.editor.getContentHeight();this.layoutEditor({width:this.viewCell.layoutInfo.editorWidth,height:t})}relayoutCell(){this.notebookEditor.layoutNotebookCell(this.viewCell,this.viewCell.layoutInfo.totalHeight),this.layoutFoldingIndicator()}updateEditorOptions(t){this.editorOptions=t,this.editor?.updateOptions(this.editorOptions)}layoutFoldingIndicator(){switch(this.foldingState){case m.None:this.templateData.foldingIndicator.style.display="none",this.templateData.foldingIndicator.innerText="";break;case m.Collapsed:this.templateData.foldingIndicator.style.display="",o.reset(this.templateData.foldingIndicator,f(B));break;case m.Expanded:this.templateData.foldingIndicator.style.display="",o.reset(this.templateData.foldingIndicator,f($));break;default:break}}bindEditorListeners(t){this.localDisposables.clear(),this.focusSwitchDisposable.clear(),this.localDisposables.add(t.onDidContentSizeChange(i=>{i.contentHeightChanged&&this.onCellEditorHeightChange(t,i.contentHeight)})),this.localDisposables.add(t.onDidChangeCursorSelection(i=>{if(i.source==="restoreState")return;const s=t.getSelections();if(s?.length){const a=t.getContentHeight(),n=this.viewCell.layoutInfo.editorHeight;a!==n&&this.onCellEditorHeightChange(t,a);const c=s[s.length-1];this.notebookEditor.revealRangeInViewAsync(this.viewCell,c)}}));const e=()=>this.viewCell.focusMode=t.hasWidgetFocus()?d.Editor:d.Container;this.localDisposables.add(t.onDidFocusEditorWidget(()=>{e()})),this.localDisposables.add(t.onDidBlurEditorWidget(()=>{this.templateData.container.ownerDocument.activeElement?.contains(this.templateData.container)?this.focusSwitchDisposable.value=N(()=>e(),300):e()})),e()}onCellEditorHeightChange(t,e){const i=t.getLayoutInfo();this.viewCell.editorHeight=e,t.layout({width:i.width,height:e})}};g=w([r(4,W),r(5,O),r(6,z),r(7,P),r(8,U),r(9,V)],g);export{g as MarkupCell};
