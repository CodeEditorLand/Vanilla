var S=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var d=(l,s,e,t)=>{for(var n=t>1?void 0:t?T(s,e):s,r=l.length-1,C;r>=0;r--)(C=l[r])&&(n=(t?C(s,e,n):C(n))||n);return t&&n&&S(s,e,n),n},i=(l,s)=>(e,t)=>s(e,t,l);import{Event as O,Emitter as y}from"../../../../base/common/event.js";import{Schemas as L}from"../../../../base/common/network.js";import{URI as _}from"../../../../base/common/uri.js";import{Disposable as m}from"../../../../base/common/lifecycle.js";import{IInstantiationService as x}from"../../../../platform/instantiation/common/instantiation.js";import{IStorageService as E,StorageScope as g,StorageTarget as w}from"../../../../platform/storage/common/storage.js";import{Registry as h}from"../../../../platform/registry/common/platform.js";import{OUTPUT_VIEW_ID as u,LOG_MIME as D,OUTPUT_MIME as A,Extensions as v,ACTIVE_OUTPUT_CHANNEL_CONTEXT as V,CONTEXT_ACTIVE_FILE_OUTPUT as M,CONTEXT_ACTIVE_OUTPUT_LEVEL_SETTABLE as P,CONTEXT_ACTIVE_OUTPUT_LEVEL as b,CONTEXT_ACTIVE_OUTPUT_LEVEL_IS_DEFAULT as U}from"../../../services/output/common/output.js";import{OutputLinkProvider as R}from"./outputLinkProvider.js";import{ITextModelService as N}from"../../../../editor/common/services/resolverService.js";import"../../../../editor/common/model.js";import{ILogService as K,ILoggerService as W,LogLevelToString as X}from"../../../../platform/log/common/log.js";import{ILifecycleService as B}from"../../../services/lifecycle/common/lifecycle.js";import"../common/outputChannelModel.js";import{IViewsService as F}from"../../../services/views/common/viewsService.js";import"./outputView.js";import{IOutputChannelModelService as H}from"../common/outputChannelModelService.js";import{ILanguageService as k}from"../../../../editor/common/languages/language.js";import{IContextKeyService as $}from"../../../../platform/contextkey/common/contextkey.js";import{SetLogLevelAction as G}from"../../logs/common/logsActions.js";import{IDefaultLogLevelsService as Y}from"../../logs/common/defaultLogLevels.js";const I="output.activechannel";let c=class extends m{constructor(e,t,n){super();this.outputChannelDescriptor=e;this.id=e.id,this.label=e.label,this.uri=_.from({scheme:L.outputChannel,path:this.id}),this.model=this._register(t.createOutputChannelModel(this.id,this.uri,e.languageId?n.createById(e.languageId):n.createByMimeType(e.log?D:A),e.file))}scrollLock=!1;model;id;label;uri;append(e){this.model.append(e)}update(e,t){this.model.update(e,t,!0)}clear(){this.model.clear()}replace(e){this.model.replace(e)}};c=d([i(1,H),i(2,k)],c);let p=class extends m{constructor(e,t,n,r,C,j,q,o,z){super();this.storageService=e;this.instantiationService=t;this.logService=r;this.loggerService=C;this.lifecycleService=j;this.viewsService=q;this.defaultLogLevelsService=z;this.activeChannelIdInStorage=this.storageService.get(I,g.WORKSPACE,""),this.activeOutputChannelContext=V.bindTo(o),this.activeOutputChannelContext.set(this.activeChannelIdInStorage),this._register(this.onActiveOutputChannel(a=>this.activeOutputChannelContext.set(a))),this.activeFileOutputChannelContext=M.bindTo(o),this.activeOutputChannelLevelSettableContext=P.bindTo(o),this.activeOutputChannelLevelContext=b.bindTo(o),this.activeOutputChannelLevelIsDefaultContext=U.bindTo(o),this._register(n.registerTextModelContentProvider(L.outputChannel,this)),this._register(t.createInstance(R));const f=h.as(v.OutputChannels);for(const a of f.getChannels())this.onDidRegisterChannel(a.id);if(this._register(f.onDidRegisterChannel(this.onDidRegisterChannel,this)),!this.activeChannel){const a=this.getChannelDescriptors();this.setActiveChannel(a&&a.length>0?this.getChannel(a[0].id):void 0)}this._register(O.filter(this.viewsService.onDidChangeViewVisibility,a=>a.id===u&&a.visible)(()=>{this.activeChannel&&this.viewsService.getActiveViewWithId(u)?.showChannel(this.activeChannel,!0)})),this._register(this.loggerService.onDidChangeLogLevel(a=>{this.setLevelContext(),this.setLevelIsDefaultContext()})),this._register(this.defaultLogLevelsService.onDidChangeDefaultLogLevels(()=>{this.setLevelIsDefaultContext()})),this._register(this.lifecycleService.onDidShutdown(()=>this.dispose()))}channels=new Map;activeChannelIdInStorage;activeChannel;_onActiveOutputChannel=this._register(new y);onActiveOutputChannel=this._onActiveOutputChannel.event;activeOutputChannelContext;activeFileOutputChannelContext;activeOutputChannelLevelSettableContext;activeOutputChannelLevelContext;activeOutputChannelLevelIsDefaultContext;provideTextContent(e){const t=this.getChannel(e.path);return t?t.model.loadModel():null}async showChannel(e,t){const n=this.getChannel(e);this.activeChannel?.id!==n?.id&&(this.setActiveChannel(n),this._onActiveOutputChannel.fire(e));const r=await this.viewsService.openView(u,!t);r&&n&&r.showChannel(n,!!t)}getChannel(e){return this.channels.get(e)}getChannelDescriptor(e){return h.as(v.OutputChannels).getChannel(e)}getChannelDescriptors(){return h.as(v.OutputChannels).getChannels()}getActiveChannel(){return this.activeChannel}async onDidRegisterChannel(e){const t=this.createChannel(e);this.channels.set(e,t),(!this.activeChannel||this.activeChannelIdInStorage===e)&&(this.setActiveChannel(t),this._onActiveOutputChannel.fire(e),this.viewsService.getActiveViewWithId(u)?.showChannel(t,!0))}createChannel(e){const t=this.instantiateChannel(e);return this._register(O.once(t.model.onDispose)(()=>{if(this.activeChannel===t){const n=this.getChannelDescriptors(),r=n.length?this.getChannel(n[0].id):void 0;r&&this.viewsService.isViewVisible(u)?this.showChannel(r.id):this.setActiveChannel(void 0)}h.as(v.OutputChannels).removeChannel(e)})),t}instantiateChannel(e){const t=h.as(v.OutputChannels).getChannel(e);if(!t)throw this.logService.error(`Channel '${e}' is not registered yet`),new Error(`Channel '${e}' is not registered yet`);return this.instantiationService.createInstance(c,t)}setLevelContext(){const e=this.activeChannel?.outputChannelDescriptor,t=e?.log?this.loggerService.getLogLevel(e.file):void 0;this.activeOutputChannelLevelContext.set(t!==void 0?X(t):"")}async setLevelIsDefaultContext(){const e=this.activeChannel?.outputChannelDescriptor;if(e?.log){const t=this.loggerService.getLogLevel(e.file),n=await this.defaultLogLevelsService.getDefaultLogLevel(e.extensionId);this.activeOutputChannelLevelIsDefaultContext.set(n===t)}else this.activeOutputChannelLevelIsDefaultContext.set(!1)}setActiveChannel(e){this.activeChannel=e;const t=e?.outputChannelDescriptor;this.activeFileOutputChannelContext.set(!!t?.file),this.activeOutputChannelLevelSettableContext.set(t!==void 0&&G.isLevelSettable(t)),this.setLevelIsDefaultContext(),this.setLevelContext(),this.activeChannel?this.storageService.store(I,this.activeChannel.id,g.WORKSPACE,w.MACHINE):this.storageService.remove(I,g.WORKSPACE)}};p=d([i(0,E),i(1,x),i(2,N),i(3,K),i(4,W),i(5,B),i(6,F),i(7,$),i(8,Y)],p);export{p as OutputService};
