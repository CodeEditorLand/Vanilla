var H=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var y=(m,a,e,t)=>{for(var i=t>1?void 0:t?x(a,e):a,o=m.length-1,r;o>=0;o--)(r=m[o])&&(i=(t?r(a,e,i):r(i))||i);return t&&i&&H(a,e,i),i},c=(m,a)=>(e,t)=>a(e,t,m);import{TreeItemCollapsibleState as R,IViewDescriptorService as P}from"../../../common/views.js";import{localize as n}from"../../../../nls.js";import{TreeViewPane as k}from"../../../browser/parts/views/treeView.js";import{IInstantiationService as N}from"../../../../platform/instantiation/common/instantiation.js";import{IUserDataSyncService as L,Change as w,MergeState as _,IUserDataSyncEnablementService as M}from"../../../../platform/userDataSync/common/userDataSync.js";import{registerAction2 as S,Action2 as I,MenuId as g}from"../../../../platform/actions/common/actions.js";import{ContextKeyExpr as l,IContextKeyService as O}from"../../../../platform/contextkey/common/contextkey.js";import{URI as u}from"../../../../base/common/uri.js";import{IEditorService as W}from"../../../services/editor/common/editorService.js";import{getSyncAreaLabel as $,IUserDataSyncWorkbenchService as q,SYNC_CONFLICTS_VIEW_ID as D}from"../../../services/userDataSync/common/userDataSync.js";import{basename as h,isEqual as K}from"../../../../base/common/resources.js";import*as b from"../../../../base/browser/dom.js";import"../../../browser/parts/views/viewsViewlet.js";import{IKeybindingService as F}from"../../../../platform/keybinding/common/keybinding.js";import{IContextMenuService as Y}from"../../../../platform/contextview/browser/contextView.js";import{IConfigurationService as J}from"../../../../platform/configuration/common/configuration.js";import{IOpenerService as z}from"../../../../platform/opener/common/opener.js";import{IThemeService as B}from"../../../../platform/theme/common/themeService.js";import{ITelemetryService as j}from"../../../../platform/telemetry/common/telemetry.js";import{INotificationService as G}from"../../../../platform/notification/common/notification.js";import{Codicon as C}from"../../../../base/common/codicons.js";import{IUserDataProfilesService as Q,reviveProfile as X}from"../../../../platform/userDataProfile/common/userDataProfile.js";import{DEFAULT_EDITOR_ASSOCIATION as Z}from"../../../common/editor.js";import{IHoverService as ee}from"../../../../platform/hover/browser/hover.js";import{IAccessibleViewInformationService as re}from"../../../services/accessibility/common/accessibleViewInformationService.js";let d=class extends k{constructor(e,t,i,o,r,p,s,v,f,A,V,T,U,oe,te,ie,ce,E){super(e,i,o,r,p,s,v,f,A,V,T,U,E);this.editorService=t;this.userDataSyncService=oe;this.userDataSyncWorkbenchService=te;this.userDataSyncEnablementService=ie;this.userDataProfilesService=ce;this._register(this.userDataSyncService.onDidChangeConflicts(()=>this.treeView.refresh())),this.registerActions()}renderTreeView(e){super.renderTreeView(b.append(e,b.$("")));const t=this;this.treeView.message=n("explanation","Please go through each entry and merge to resolve conflicts."),this.treeView.dataProvider={getChildren(){return t.getTreeItems()}}}async getTreeItems(){const e=[],t=this.userDataSyncService.conflicts.map(o=>o.conflicts.map(r=>({...r,syncResource:o.syncResource,profile:o.profile}))).flat().sort((o,r)=>o.profile.id===r.profile.id?0:o.profile.isDefault?-1:r.profile.isDefault?1:o.profile.name.localeCompare(r.profile.name)),i=[];for(const o of t){let r=i[i.length-1]?.[0].id===o.profile.id?i[i.length-1][1]:void 0;r||i.push([o.profile,r=[]]),r.push(o)}for(const[o,r]of i){const p=[];for(const s of r){const v=JSON.stringify(s),f={handle:v,resourceUri:s.remoteResource,label:{label:h(s.remoteResource),strikethrough:s.mergeState===_.Accepted&&(s.localChange===w.Deleted||s.remoteChange===w.Deleted)},description:$(s.syncResource),collapsibleState:R.None,command:{id:"workbench.actions.sync.openConflicts",title:"",arguments:[{$treeViewId:"",$treeItemHandle:v}]},contextValue:"sync-conflict-resource"};p.push(f)}e.push({handle:o.id,label:{label:o.name},collapsibleState:R.Expanded,children:p})}return i.length===1&&i[0][0].isDefault?e[0].children??[]:e}parseHandle(e){const t=JSON.parse(e);return{syncResource:t.syncResource,profile:X(t.profile,this.userDataProfilesService.profilesHome.scheme),localResource:u.revive(t.localResource),remoteResource:u.revive(t.remoteResource),baseResource:u.revive(t.baseResource),previewResource:u.revive(t.previewResource),acceptedResource:u.revive(t.acceptedResource),localChange:t.localChange,remoteChange:t.remoteChange,mergeState:t.mergeState}}registerActions(){const e=this;this._register(S(class extends I{constructor(){super({id:"workbench.actions.sync.openConflicts",title:n({key:"workbench.actions.sync.openConflicts",comment:["This is an action title to show the conflicts between local and remote version of resources"]},"Show Conflicts")})}async run(i,o){const r=e.parseHandle(o.$treeItemHandle);return e.open(r)}})),this._register(S(class extends I{constructor(){super({id:"workbench.actions.sync.acceptRemote",title:n("workbench.actions.sync.acceptRemote","Accept Remote"),icon:C.cloudDownload,menu:{id:g.ViewItemContext,when:l.and(l.equals("view",D),l.equals("viewItem","sync-conflict-resource")),group:"inline",order:1}})}async run(i,o){const r=e.parseHandle(o.$treeItemHandle);await e.userDataSyncWorkbenchService.accept({syncResource:r.syncResource,profile:r.profile},r.remoteResource,void 0,e.userDataSyncEnablementService.isEnabled())}})),this._register(S(class extends I{constructor(){super({id:"workbench.actions.sync.acceptLocal",title:n("workbench.actions.sync.acceptLocal","Accept Local"),icon:C.cloudUpload,menu:{id:g.ViewItemContext,when:l.and(l.equals("view",D),l.equals("viewItem","sync-conflict-resource")),group:"inline",order:2}})}async run(i,o){const r=e.parseHandle(o.$treeItemHandle);await e.userDataSyncWorkbenchService.accept({syncResource:r.syncResource,profile:r.profile},r.localResource,void 0,e.userDataSyncEnablementService.isEnabled())}}))}async open(e){if(!this.userDataSyncService.conflicts.some(({conflicts:o})=>o.some(({localResource:r})=>K(r,e.localResource))))return;const t=n({key:"remoteResourceName",comment:["remote as in file in cloud"]},"{0} (Remote)",h(e.remoteResource)),i=n("localResourceName","{0} (Local)",h(e.remoteResource));await this.editorService.openEditor({input1:{resource:e.remoteResource,label:n("Theirs","Theirs"),description:t},input2:{resource:e.localResource,label:n("Yours","Yours"),description:i},base:{resource:e.baseResource},result:{resource:e.previewResource},options:{preserveFocus:!0,revealIfVisible:!0,pinned:!0,override:Z.id}})}};d=y([c(1,W),c(2,F),c(3,Y),c(4,J),c(5,O),c(6,P),c(7,N),c(8,z),c(9,B),c(10,j),c(11,G),c(12,ee),c(13,L),c(14,q),c(15,M),c(16,Q),c(17,re)],d);export{d as UserDataSyncConflictsViewPane};
