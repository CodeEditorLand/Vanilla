var y=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var u=(h,a,e,t)=>{for(var o=t>1?void 0:t?D(a,e):a,l=h.length-1,i;l>=0;l--)(i=h[l])&&(o=(t?i(a,e,o):i(o))||o);return t&&o&&y(a,e,o),o},C=(h,a)=>(e,t)=>a(e,t,h);import{basename as w}from"../../../../base/common/path.js";import{coalesce as I}from"../../../../base/common/arrays.js";import"../../../../base/common/cancellation.js";import{onUnexpectedExternalError as v}from"../../../../base/common/errors.js";import{Iterable as V}from"../../../../base/common/iterator.js";import{toDisposable as P}from"../../../../base/common/lifecycle.js";import{URI as S}from"../../../../base/common/uri.js";import"../../../../editor/common/languages.js";import{IChatWidgetService as q,showChatView as x}from"./chat.js";import{ChatDynamicVariableModel as L}from"./contrib/chatDynamicVariables.js";import{ChatAgentLocation as R}from"../common/chatAgents.js";import"../common/chatModel.js";import{ChatRequestDynamicVariablePart as T,ChatRequestToolPart as _,ChatRequestVariablePart as E}from"../common/chatParserTypes.js";import"../common/chatService.js";import"../common/chatVariables.js";import{ChatContextAttachments as p}from"./contrib/chatContextAttachments.js";import{IViewsService as A}from"../../../services/views/common/viewsService.js";import{ILanguageModelToolsService as M}from"../common/languageModelToolsService.js";import{ThemeIcon as N}from"../../../../base/common/themables.js";let g=class{constructor(a,e,t){this.chatWidgetService=a;this.viewsService=e;this.toolsService=t}_resolver=new Map;async resolveVariables(a,e,t,o,l){let i=[];const d=[];a.parts.forEach((r,c)=>{if(r instanceof E){const s=this._resolver.get(r.variableName.toLowerCase());if(s){const m=[],b=n=>{if(n.kind==="reference"){m.push(n);return}o(n)};d.push(s.resolver(a.text,r.variableArg,t,b,l).then(n=>{n&&(i[c]={id:s.data.id,modelDescription:s.data.modelDescription,name:r.variableName,range:r.range,value:n,references:m,fullName:s.data.fullName,icon:s.data.icon})}).catch(v))}}else if(r instanceof T)i[c]={id:r.id,name:r.referenceText,range:r.range,value:r.data};else if(r instanceof _){const s=this.toolsService.getTool(r.toolId);s&&(i[c]={id:r.toolId,name:r.toolName,range:r.range,value:void 0,isTool:!0,icon:N.isThemeIcon(s.icon)?s.icon:void 0,fullName:s.displayName})}});const f=[];return e?.forEach((r,c)=>{const s=this._resolver.get(r.name?.toLowerCase());if(s){const m=[],b=n=>{if(n.kind==="reference"){m.push(n);return}o(n)};d.push(s.resolver(a.text,"",t,b,l).then(n=>{n&&(f[c]={id:s.data.id,modelDescription:s.data.modelDescription,name:r.name,fullName:r.fullName,range:r.range,value:n,references:m,icon:r.icon})}).catch(v))}else(r.isDynamic||r.isTool)&&(f[c]={...r})}),await Promise.allSettled(d),i=I(i),i.sort((r,c)=>c.range.start-r.range.start),i.push(...I(f)),{variables:i}}async resolveVariable(a,e,t,o,l){const i=this._resolver.get(a.toLowerCase());if(i)return await i.resolver(e,void 0,t,o,l)}hasVariable(a){return this._resolver.has(a.toLowerCase())}getVariable(a){return this._resolver.get(a.toLowerCase())?.data}getVariables(a){const e=V.map(this._resolver.values(),t=>t.data);return V.filter(e,t=>a!==R.Editor||!new Set(["selection","editor"]).has(t.name))}getDynamicVariables(a){const e=this.chatWidgetService.getWidgetBySessionId(a);if(!e||!e.viewModel||!e.supportsFileReferences)return[];const t=e.getContrib(L.ID);return t?t.variables:[]}registerVariable(a,e){const t=a.name.toLowerCase();if(this._resolver.has(t))throw new Error(`A chat variable with the name '${a.name}' already exists.`);return this._resolver.set(t,{data:a,resolver:e}),P(()=>{this._resolver.delete(t)})}async attachContext(a,e,t){if(t!==R.Panel)return;const o=this.chatWidgetService.lastFocusedWidget??await x(this.viewsService);if(!o||!o.viewModel)return;const l=a.toLowerCase();if(l==="file"&&typeof e!="string"){const d=S.isUri(e)?e:e.uri,f="range"in e?e.range:void 0;o.getContrib(p.ID)?.setContext(!1,{value:e,id:d.toString()+(f?.toString()??""),name:w(d.path),isFile:!0,isDynamic:!0});return}const i=this._resolver.get(l);i&&o.getContrib(p.ID)?.setContext(!1,{...i.data,value:e})}};g=u([C(0,q),C(1,A),C(2,M)],g);export{g as ChatVariablesService};
