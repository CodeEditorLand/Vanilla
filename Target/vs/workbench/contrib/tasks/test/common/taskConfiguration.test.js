import{URI as q}from"../../../../../base/common/uri.js";import t from"assert";import S from"../../../../../base/common/severity.js";import*as y from"../../../../../base/common/uuid.js";import*as G from"../../../../../base/common/types.js";import*as p from"../../../../../base/common/platform.js";import{ValidationStatus as D}from"../../../../../base/common/parsers.js";import{FileLocationKind as v,ApplyToKind as f}from"../../common/problemMatcher.js";import{WorkspaceFolder as $}from"../../../../../platform/workspace/common/workspace.js";import*as a from"../../common/tasks.js";import{parse as I,TaskConfigSource as x,ProblemMatcherConverter as C,UUIDMap as L,TaskParser as h}from"../../common/taskConfiguration.js";import{MockContextKeyService as _}from"../../../../../platform/keybinding/test/common/mockKeybindingService.js";import"../../../../../platform/contextkey/common/contextkey.js";import{Workspace as K}from"../../../../../platform/workspace/test/common/testWorkspace.js";import{TestInstantiationService as F}from"../../../../../platform/instantiation/test/common/instantiationServiceMock.js";import"../../common/taskDefinitionRegistry.js";const b=new $({uri:q.file("/workspace/folderOne"),name:"folderOne",index:0}),R=new K("id",[b]);class P{_validationStatus=new D;receivedMessage=!1;lastMessage=void 0;info(e){this.log(e)}warn(e){this.log(e)}error(e){this.log(e)}fatal(e){this.log(e)}get status(){return this._validationStatus}log(e){this.receivedMessage=!0,this.lastMessage=e}clearMessage(){this.lastMessage=void 0}}class o{result;builders;constructor(){this.result=[],this.builders=[]}task(e,r){const i=new A(this,e,r);return this.builders.push(i),this.result.push(i.result),i}done(){for(const e of this.builders)e.done()}}class U{constructor(e){this.parent=e;this.result={echo:!1,reveal:a.RevealKind.Always,revealProblems:a.RevealProblemKind.Never,focus:!1,panel:a.PanelKind.Shared,showReuseMessage:!0,clear:!1,close:!1}}result;echo(e){return this.result.echo=e,this}reveal(e){return this.result.reveal=e,this}focus(e){return this.result.focus=e,this}instance(e){return this.result.panel=e,this}showReuseMessage(e){return this.result.showReuseMessage=e,this}close(e){return this.result.close=e,this}done(){}}class W{constructor(e,r){this.parent=e;this.presentationBuilder=new U(this),this.result={name:r,runtime:a.RuntimeType.Process,args:[],options:{cwd:"${workspaceFolder}"},presentation:this.presentationBuilder.result,suppressTaskName:!1}}result;presentationBuilder;name(e){return this.result.name=e,this}runtime(e){return this.result.runtime=e,this}args(e){return this.result.args=e,this}options(e){return this.result.options=e,this}taskSelector(e){return this.result.taskSelector=e,this}suppressTaskName(e){return this.result.suppressTaskName=e,this}presentation(){return this.presentationBuilder}done(e){this.result.args=this.result.args.map(r=>r==="$name"?e:r),this.presentationBuilder.done()}}class A{constructor(e,r,i){this.parent=e;this.commandBuilder=new W(this,i),this.result=new a.CustomTask(r,{kind:a.TaskSourceKind.Workspace,label:"workspace",config:{workspaceFolder:b,element:void 0,index:-1,file:".vscode/tasks.json"}},r,a.CUSTOMIZED_TASK_TYPE,this.commandBuilder.result,!1,{reevaluateOnRerun:!0},{identifier:r,name:r,isBackground:!1,promptOnClose:!0,problemMatchers:[]})}result;commandBuilder;identifier(e){return this.result.configurationProperties.identifier=e,this}group(e){return this.result.configurationProperties.group=e,this}isBackground(e){return this.result.configurationProperties.isBackground=e,this}promptOnClose(e){return this.result.configurationProperties.promptOnClose=e,this}problemMatcher(){const e=new w(this);return this.result.configurationProperties.problemMatchers.push(e.result),e}command(){return this.commandBuilder}done(){this.commandBuilder.done(this.result.configurationProperties.name)}}class w{constructor(e){this.parent=e;this.result={owner:w.DEFAULT_UUID,applyTo:f.allDocuments,severity:void 0,fileLocation:v.Relative,filePrefix:"${workspaceFolder}",pattern:void 0}}static DEFAULT_UUID=y.generateUuid();result;owner(e){return this.result.owner=e,this}applyTo(e){return this.result.applyTo=e,this}severity(e){return this.result.severity=e,this}fileLocation(e){return this.result.fileLocation=e,this}filePrefix(e){return this.result.filePrefix=e,this}pattern(e){const r=new j(this,e);return this.result.pattern||(this.result.pattern=r.result),r}}class j{constructor(e,r){this.parent=e;this.result={regexp:r,file:1,message:0,line:2,character:3}}result;file(e){return this.result.file=e,this}message(e){return this.result.message=e,this}location(e){return this.result.location=e,this}line(e){return this.result.line=e,this}character(e){return this.result.character=e,this}endLine(e){return this.result.endLine=e,this}endCharacter(e){return this.result.endCharacter=e,this}code(e){return this.result.code=e,this}severity(e){return this.result.severity=e,this}loop(e){return this.result.loop=e,this}}class B extends _{getContext(e){return{getValue:r=>!0}}}function M(s,e){const r=new P,i=I(b,R,p.platform,s,r,x.TasksJson,new B);t.ok(!r.receivedMessage),t.strictEqual(i.custom.length,1);const u=i.custom[0];t.ok(u),t.strictEqual(u.configurationProperties.problemMatchers.length,e)}function n(s,e){e.done();const r=new P,i=I(b,R,p.platform,s,r,x.TasksJson,new B);r.receivedMessage&&t.ok(!1,r.lastMessage),V(i,e.result)}class N{_store;constructor(){this._store=Object.create(null)}add(e,r){let i=this._store[e];i||(i=[],this._store[e]=i),i.push(r)}static assert(e,r){const i=Object.keys(e._store),u=Object.keys(r._store);i.length===0&&u.length===0||(t.strictEqual(i.length,u.length),i.forEach(m=>t.ok(r._store[m])),u.forEach(m=>e._store[m]),i.forEach(m=>{const k=e._store[m],l=r._store[m];if(t.strictEqual(k.length,l.length),k.length===1){t.strictEqual(k[0].configurationProperties.name,l[0].configurationProperties.name);return}const d=Object.create(null);l.forEach(c=>d[c.configurationProperties.name]=!0),k.forEach(c=>delete d[c.configurationProperties.name]),t.strictEqual(Object.keys(d).length,0)}))}}function V(s,e){t.ok(s.validationStatus.isOK());const r=s.custom;if(t.strictEqual(typeof r,typeof e),!r)return;const i=Object.create(null),u=Object.create(null),m=new N;r.forEach(c=>{t.ok(!i[c.configurationProperties.name]),i[c.configurationProperties.name]=c,u[c._id]=c.configurationProperties.name;const g=a.TaskGroup.from(c.configurationProperties.group)?._id;g&&m.add(g,c)});const k=Object.create(null),l=new N;e.forEach(c=>{t.ok(!k[c.configurationProperties.name]),k[c.configurationProperties.name]=c;const g=a.TaskGroup.from(c.configurationProperties.group)?._id;g&&l.add(g,c)});const d=Object.keys(i);t.strictEqual(d.length,e.length),d.forEach(c=>{const g=i[c],E=k[c];t.ok(E),J(g,E)}),N.assert(m,l)}function J(s,e){if(t.ok(s._id),t.strictEqual(s.configurationProperties.name,e.configurationProperties.name,"name"),!a.InMemoryTask.is(s)&&!a.InMemoryTask.is(e)&&H(s.command,e.command),t.strictEqual(s.configurationProperties.isBackground,e.configurationProperties.isBackground,"isBackground"),t.strictEqual(typeof s.configurationProperties.problemMatchers,typeof e.configurationProperties.problemMatchers),t.strictEqual(s.configurationProperties.promptOnClose,e.configurationProperties.promptOnClose,"promptOnClose"),t.strictEqual(typeof s.configurationProperties.group,typeof e.configurationProperties.group,"group types unequal"),s.configurationProperties.problemMatchers&&e.configurationProperties.problemMatchers){t.strictEqual(s.configurationProperties.problemMatchers.length,e.configurationProperties.problemMatchers.length);for(let r=0;r<s.configurationProperties.problemMatchers.length;r++)z(s.configurationProperties.problemMatchers[r],e.configurationProperties.problemMatchers[r])}s.configurationProperties.group&&e.configurationProperties.group&&(G.isString(s.configurationProperties.group)?t.strictEqual(s.configurationProperties.group,e.configurationProperties.group):Y(s.configurationProperties.group,e.configurationProperties.group))}function H(s,e){t.strictEqual(typeof s,typeof e),s&&e&&(Z(s.presentation,e.presentation),t.strictEqual(s.name,e.name,"name"),t.strictEqual(s.runtime,e.runtime,"runtime type"),t.strictEqual(s.suppressTaskName,e.suppressTaskName,"suppressTaskName"),t.strictEqual(s.taskSelector,e.taskSelector,"taskSelector"),t.deepStrictEqual(s.args,e.args,"args"),t.strictEqual(typeof s.options,typeof e.options),s.options&&e.options&&(t.strictEqual(s.options.cwd,e.options.cwd,"cwd"),t.strictEqual(typeof s.options.env,typeof e.options.env,"env"),s.options.env&&e.options.env&&t.deepStrictEqual(s.options.env,e.options.env,"env")))}function Y(s,e){t.strictEqual(typeof s,typeof e),s&&e&&(t.strictEqual(s._id,e._id,`group ids unequal. actual: ${s._id} expected ${e._id}`),t.strictEqual(s.isDefault,e.isDefault,`group defaults unequal. actual: ${s.isDefault} expected ${e.isDefault}`))}function Z(s,e){t.strictEqual(typeof s,typeof e),s&&e&&(t.strictEqual(s.echo,e.echo),t.strictEqual(s.reveal,e.reveal))}function z(s,e){if(t.strictEqual(typeof s,typeof e),typeof s=="string"&&typeof e=="string"){t.strictEqual(s,e,"Problem matcher references are different");return}typeof s!="string"&&typeof e!="string"&&(e.owner===w.DEFAULT_UUID?t.ok(y.isUUID(s.owner),"Owner must be a UUID"):t.strictEqual(s.owner,e.owner),t.strictEqual(s.applyTo,e.applyTo),t.strictEqual(s.severity,e.severity),t.strictEqual(s.fileLocation,e.fileLocation),t.strictEqual(s.filePrefix,e.filePrefix),s.pattern&&e.pattern&&Q(s.pattern,e.pattern))}function Q(s,e){if(t.strictEqual(typeof s,typeof e),Array.isArray(s)){const r=s,i=e;t.strictEqual(r.length,i.length);for(let u=0;u<r.length;u++)O(r[u],i[u])}else O(s,e)}function O(s,e){t.strictEqual(s.regexp.toString(),e.regexp.toString()),t.strictEqual(s.file,e.file),t.strictEqual(s.message,e.message),typeof e.location<"u"?t.strictEqual(s.location,e.location):(t.strictEqual(s.line,e.line),t.strictEqual(s.character,e.character),t.strictEqual(s.endLine,e.endLine),t.strictEqual(s.endCharacter,e.endCharacter)),t.strictEqual(s.code,e.code),t.strictEqual(s.severity,e.severity),t.strictEqual(s.loop,e.loop)}suite("Tasks version 0.1.0",()=>{test("tasks: all default",()=>{const s=new o;s.task("tsc","tsc").group(a.TaskGroup.Build).command().suppressTaskName(!0),n({version:"0.1.0",command:"tsc"},s)}),test("tasks: global isShellCommand",()=>{const s=new o;s.task("tsc","tsc").group(a.TaskGroup.Build).command().suppressTaskName(!0).runtime(a.RuntimeType.Shell),n({version:"0.1.0",command:"tsc",isShellCommand:!0},s)}),test("tasks: global show output silent",()=>{const s=new o;s.task("tsc","tsc").group(a.TaskGroup.Build).command().suppressTaskName(!0).presentation().reveal(a.RevealKind.Silent),n({version:"0.1.0",command:"tsc",showOutput:"silent"},s)}),test("tasks: global promptOnClose default",()=>{const s=new o;s.task("tsc","tsc").group(a.TaskGroup.Build).command().suppressTaskName(!0),n({version:"0.1.0",command:"tsc",promptOnClose:!0},s)}),test("tasks: global promptOnClose",()=>{const s=new o;s.task("tsc","tsc").group(a.TaskGroup.Build).promptOnClose(!1).command().suppressTaskName(!0),n({version:"0.1.0",command:"tsc",promptOnClose:!1},s)}),test("tasks: global promptOnClose default watching",()=>{const s=new o;s.task("tsc","tsc").group(a.TaskGroup.Build).isBackground(!0).promptOnClose(!1).command().suppressTaskName(!0),n({version:"0.1.0",command:"tsc",isWatching:!0},s)}),test("tasks: global show output never",()=>{const s=new o;s.task("tsc","tsc").group(a.TaskGroup.Build).command().suppressTaskName(!0).presentation().reveal(a.RevealKind.Never),n({version:"0.1.0",command:"tsc",showOutput:"never"},s)}),test("tasks: global echo Command",()=>{const s=new o;s.task("tsc","tsc").group(a.TaskGroup.Build).command().suppressTaskName(!0).presentation().echo(!0),n({version:"0.1.0",command:"tsc",echoCommand:!0},s)}),test("tasks: global args",()=>{const s=new o;s.task("tsc","tsc").group(a.TaskGroup.Build).command().suppressTaskName(!0).args(["--p"]),n({version:"0.1.0",command:"tsc",args:["--p"]},s)}),test("tasks: options - cwd",()=>{const s=new o;s.task("tsc","tsc").group(a.TaskGroup.Build).command().suppressTaskName(!0).options({cwd:"myPath"}),n({version:"0.1.0",command:"tsc",options:{cwd:"myPath"}},s)}),test("tasks: options - env",()=>{const s=new o;s.task("tsc","tsc").group(a.TaskGroup.Build).command().suppressTaskName(!0).options({cwd:"${workspaceFolder}",env:{key:"value"}}),n({version:"0.1.0",command:"tsc",options:{env:{key:"value"}}},s)}),test("tasks: os windows",()=>{const s=p.isWindows?"tsc.win":"tsc",e=new o;e.task(s,s).group(a.TaskGroup.Build).command().suppressTaskName(!0),n({version:"0.1.0",command:"tsc",windows:{command:"tsc.win"}},e)}),test("tasks: os windows & global isShellCommand",()=>{const s=p.isWindows?"tsc.win":"tsc",e=new o;e.task(s,s).group(a.TaskGroup.Build).command().suppressTaskName(!0).runtime(a.RuntimeType.Shell),n({version:"0.1.0",command:"tsc",isShellCommand:!0,windows:{command:"tsc.win"}},e)}),test("tasks: os mac",()=>{const s=p.isMacintosh?"tsc.osx":"tsc",e=new o;e.task(s,s).group(a.TaskGroup.Build).command().suppressTaskName(!0),n({version:"0.1.0",command:"tsc",osx:{command:"tsc.osx"}},e)}),test("tasks: os linux",()=>{const s=p.isLinux?"tsc.linux":"tsc",e=new o;e.task(s,s).group(a.TaskGroup.Build).command().suppressTaskName(!0),n({version:"0.1.0",command:"tsc",linux:{command:"tsc.linux"}},e)}),test("tasks: overwrite showOutput",()=>{const s=new o;s.task("tsc","tsc").group(a.TaskGroup.Build).command().suppressTaskName(!0).presentation().reveal(p.isWindows?a.RevealKind.Always:a.RevealKind.Never),n({version:"0.1.0",command:"tsc",showOutput:"never",windows:{showOutput:"always"}},s)}),test("tasks: overwrite echo Command",()=>{const s=new o;s.task("tsc","tsc").group(a.TaskGroup.Build).command().suppressTaskName(!0).presentation().echo(!p.isWindows),n({version:"0.1.0",command:"tsc",echoCommand:!0,windows:{echoCommand:!1}},s)}),test("tasks: global problemMatcher one",()=>{M({version:"0.1.0",command:"tsc",problemMatcher:"$msCompile"},1)}),test("tasks: global problemMatcher two",()=>{M({version:"0.1.0",command:"tsc",problemMatcher:["$eslint-compact","$msCompile"]},2)}),test("tasks: task definition",()=>{const s={version:"0.1.0",command:"tsc",tasks:[{taskName:"taskName"}]},e=new o;e.task("taskName","tsc").command().args(["$name"]),n(s,e)}),test("tasks: build task",()=>{const s={version:"0.1.0",command:"tsc",tasks:[{taskName:"taskName",isBuildCommand:!0}]},e=new o;e.task("taskName","tsc").group(a.TaskGroup.Build).command().args(["$name"]),n(s,e)}),test("tasks: default build task",()=>{const s={version:"0.1.0",command:"tsc",tasks:[{taskName:"build"}]},e=new o;e.task("build","tsc").group(a.TaskGroup.Build).command().args(["$name"]),n(s,e)}),test("tasks: test task",()=>{const s={version:"0.1.0",command:"tsc",tasks:[{taskName:"taskName",isTestCommand:!0}]},e=new o;e.task("taskName","tsc").group(a.TaskGroup.Test).command().args(["$name"]),n(s,e)}),test("tasks: default test task",()=>{const s={version:"0.1.0",command:"tsc",tasks:[{taskName:"test"}]},e=new o;e.task("test","tsc").group(a.TaskGroup.Test).command().args(["$name"]),n(s,e)}),test("tasks: task with values",()=>{const s={version:"0.1.0",command:"tsc",tasks:[{taskName:"test",showOutput:"never",echoCommand:!0,args:["--p"],isWatching:!0}]},e=new o;e.task("test","tsc").group(a.TaskGroup.Test).isBackground(!0).promptOnClose(!1).command().args(["$name","--p"]).presentation().echo(!0).reveal(a.RevealKind.Never),n(s,e)}),test("tasks: task inherits global values",()=>{const s={version:"0.1.0",command:"tsc",showOutput:"never",echoCommand:!0,tasks:[{taskName:"test"}]},e=new o;e.task("test","tsc").group(a.TaskGroup.Test).command().args(["$name"]).presentation().echo(!0).reveal(a.RevealKind.Never),n(s,e)}),test("tasks: problem matcher default",()=>{const s={version:"0.1.0",command:"tsc",tasks:[{taskName:"taskName",problemMatcher:{pattern:{regexp:"abc"}}}]},e=new o;e.task("taskName","tsc").command().args(["$name"]).parent.problemMatcher().pattern(/abc/),n(s,e)}),test("tasks: problem matcher .* regular expression",()=>{const s={version:"0.1.0",command:"tsc",tasks:[{taskName:"taskName",problemMatcher:{pattern:{regexp:".*"}}}]},e=new o;e.task("taskName","tsc").command().args(["$name"]).parent.problemMatcher().pattern(/.*/),n(s,e)}),test("tasks: problem matcher owner, applyTo, severity and fileLocation",()=>{const s={version:"0.1.0",command:"tsc",tasks:[{taskName:"taskName",problemMatcher:{owner:"myOwner",applyTo:"closedDocuments",severity:"warning",fileLocation:"absolute",pattern:{regexp:"abc"}}}]},e=new o;e.task("taskName","tsc").command().args(["$name"]).parent.problemMatcher().owner("myOwner").applyTo(f.closedDocuments).severity(S.Warning).fileLocation(v.Absolute).filePrefix(void 0).pattern(/abc/),n(s,e)}),test("tasks: problem matcher fileLocation and filePrefix",()=>{const s={version:"0.1.0",command:"tsc",tasks:[{taskName:"taskName",problemMatcher:{fileLocation:["relative","myPath"],pattern:{regexp:"abc"}}}]},e=new o;e.task("taskName","tsc").command().args(["$name"]).parent.problemMatcher().fileLocation(v.Relative).filePrefix("myPath").pattern(/abc/),n(s,e)}),test("tasks: problem pattern location",()=>{const s={version:"0.1.0",command:"tsc",tasks:[{taskName:"taskName",problemMatcher:{pattern:{regexp:"abc",file:10,message:11,location:12,severity:13,code:14}}}]},e=new o;e.task("taskName","tsc").command().args(["$name"]).parent.problemMatcher().pattern(/abc/).file(10).message(11).location(12).severity(13).code(14),n(s,e)}),test("tasks: problem pattern line & column",()=>{const s={version:"0.1.0",command:"tsc",tasks:[{taskName:"taskName",problemMatcher:{pattern:{regexp:"abc",file:10,message:11,line:12,column:13,endLine:14,endColumn:15,severity:16,code:17}}}]},e=new o;e.task("taskName","tsc").command().args(["$name"]).parent.problemMatcher().pattern(/abc/).file(10).message(11).line(12).character(13).endLine(14).endCharacter(15).severity(16).code(17),n(s,e)}),test("tasks: prompt on close default",()=>{const s={version:"0.1.0",command:"tsc",tasks:[{taskName:"taskName"}]},e=new o;e.task("taskName","tsc").promptOnClose(!0).command().args(["$name"]),n(s,e)}),test("tasks: prompt on close watching",()=>{const s={version:"0.1.0",command:"tsc",tasks:[{taskName:"taskName",isWatching:!0}]},e=new o;e.task("taskName","tsc").isBackground(!0).promptOnClose(!1).command().args(["$name"]),n(s,e)}),test("tasks: prompt on close set",()=>{const s={version:"0.1.0",command:"tsc",tasks:[{taskName:"taskName",promptOnClose:!1}]},e=new o;e.task("taskName","tsc").promptOnClose(!1).command().args(["$name"]),n(s,e)}),test("tasks: task selector set",()=>{const s={version:"0.1.0",command:"tsc",taskSelector:"/t:",tasks:[{taskName:"taskName"}]},e=new o;e.task("taskName","tsc").command().taskSelector("/t:").args(["/t:taskName"]),n(s,e)}),test("tasks: suppress task name set",()=>{const s={version:"0.1.0",command:"tsc",suppressTaskName:!1,tasks:[{taskName:"taskName",suppressTaskName:!0}]},e=new o;e.task("taskName","tsc").command().suppressTaskName(!0),n(s,e)}),test("tasks: suppress task name inherit",()=>{const s={version:"0.1.0",command:"tsc",suppressTaskName:!0,tasks:[{taskName:"taskName"}]},e=new o;e.task("taskName","tsc").command().suppressTaskName(!0),n(s,e)}),test("tasks: two tasks",()=>{const s={version:"0.1.0",command:"tsc",tasks:[{taskName:"taskNameOne"},{taskName:"taskNameTwo"}]},e=new o;e.task("taskNameOne","tsc").command().args(["$name"]),e.task("taskNameTwo","tsc").command().args(["$name"]),n(s,e)}),test("tasks: with command",()=>{const s={version:"0.1.0",tasks:[{taskName:"taskNameOne",command:"tsc"}]},e=new o;e.task("taskNameOne","tsc").command().suppressTaskName(!0),n(s,e)}),test("tasks: two tasks with command",()=>{const s={version:"0.1.0",tasks:[{taskName:"taskNameOne",command:"tsc"},{taskName:"taskNameTwo",command:"dir"}]},e=new o;e.task("taskNameOne","tsc").command().suppressTaskName(!0),e.task("taskNameTwo","dir").command().suppressTaskName(!0),n(s,e)}),test("tasks: with command and args",()=>{const s={version:"0.1.0",tasks:[{taskName:"taskNameOne",command:"tsc",isShellCommand:!0,args:["arg"],options:{cwd:"cwd",env:{env:"env"}}}]},e=new o;e.task("taskNameOne","tsc").command().suppressTaskName(!0).runtime(a.RuntimeType.Shell).args(["arg"]).options({cwd:"cwd",env:{env:"env"}}),n(s,e)}),test("tasks: with command os specific",()=>{const s=p.isWindows?"tsc.win":"tsc",e={version:"0.1.0",tasks:[{taskName:"taskNameOne",command:"tsc",windows:{command:"tsc.win"}}]},r=new o;r.task("taskNameOne",s).command().suppressTaskName(!0),n(e,r)}),test("tasks: with Windows specific args",()=>{const s=p.isWindows?["arg1","arg2"]:["arg1"],e={version:"0.1.0",tasks:[{taskName:"tsc",command:"tsc",args:["arg1"],windows:{args:["arg2"]}}]},r=new o;r.task("tsc","tsc").command().suppressTaskName(!0).args(s),n(e,r)}),test("tasks: with Linux specific args",()=>{const s=p.isLinux?["arg1","arg2"]:["arg1"],e={version:"0.1.0",tasks:[{taskName:"tsc",command:"tsc",args:["arg1"],linux:{args:["arg2"]}}]},r=new o;r.task("tsc","tsc").command().suppressTaskName(!0).args(s),n(e,r)}),test("tasks: global command and task command properties",()=>{const s={version:"0.1.0",command:"tsc",tasks:[{taskName:"taskNameOne",isShellCommand:!0}]},e=new o;e.task("taskNameOne","tsc").command().runtime(a.RuntimeType.Shell).args(["$name"]),n(s,e)}),test("tasks: global and tasks args",()=>{const s={version:"0.1.0",command:"tsc",args:["global"],tasks:[{taskName:"taskNameOne",args:["local"]}]},e=new o;e.task("taskNameOne","tsc").command().args(["global","$name","local"]),n(s,e)}),test("tasks: global and tasks args with task selector",()=>{const s={version:"0.1.0",command:"tsc",args:["global"],taskSelector:"/t:",tasks:[{taskName:"taskNameOne",args:["local"]}]},e=new o;e.task("taskNameOne","tsc").command().taskSelector("/t:").args(["global","/t:taskNameOne","local"]),n(s,e)})}),suite("Tasks version 2.0.0",()=>{test.skip("Build workspace task",()=>{const s={version:"2.0.0",tasks:[{taskName:"dir",command:"dir",type:"shell",group:"build"}]},e=new o;e.task("dir","dir").group(a.TaskGroup.Build).command().suppressTaskName(!0).runtime(a.RuntimeType.Shell).presentation().echo(!0),n(s,e)}),test("Global group none",()=>{const s={version:"2.0.0",command:"dir",type:"shell",group:"none"},e=new o;e.task("dir","dir").command().suppressTaskName(!0).runtime(a.RuntimeType.Shell).presentation().echo(!0),n(s,e)}),test.skip("Global group build",()=>{const s={version:"2.0.0",command:"dir",type:"shell",group:"build"},e=new o;e.task("dir","dir").group(a.TaskGroup.Build).command().suppressTaskName(!0).runtime(a.RuntimeType.Shell).presentation().echo(!0),n(s,e)}),test.skip("Global group default build",()=>{const s={version:"2.0.0",command:"dir",type:"shell",group:{kind:"build",isDefault:!0}},e=new o,r=a.TaskGroup.Build;r.isDefault=!0,e.task("dir","dir").group(r).command().suppressTaskName(!0).runtime(a.RuntimeType.Shell).presentation().echo(!0),n(s,e)}),test("Local group none",()=>{const s={version:"2.0.0",tasks:[{taskName:"dir",command:"dir",type:"shell",group:"none"}]},e=new o;e.task("dir","dir").command().suppressTaskName(!0).runtime(a.RuntimeType.Shell).presentation().echo(!0),n(s,e)}),test.skip("Local group build",()=>{const s={version:"2.0.0",tasks:[{taskName:"dir",command:"dir",type:"shell",group:"build"}]},e=new o;e.task("dir","dir").group(a.TaskGroup.Build).command().suppressTaskName(!0).runtime(a.RuntimeType.Shell).presentation().echo(!0),n(s,e)}),test.skip("Local group default build",()=>{const s={version:"2.0.0",tasks:[{taskName:"dir",command:"dir",type:"shell",group:{kind:"build",isDefault:!0}}]},e=new o,r=a.TaskGroup.Build;r.isDefault=!0,e.task("dir","dir").group(r).command().suppressTaskName(!0).runtime(a.RuntimeType.Shell).presentation().echo(!0),n(s,e)}),test("Arg overwrite",()=>{const s={version:"2.0.0",tasks:[{label:"echo",type:"shell",command:"echo",args:["global"],windows:{args:["windows"]},linux:{args:["linux"]},osx:{args:["osx"]}}]},e=new o;p.isWindows?(e.task("echo","echo").command().suppressTaskName(!0).args(["windows"]).runtime(a.RuntimeType.Shell).presentation().echo(!0),n(s,e)):p.isLinux?(e.task("echo","echo").command().suppressTaskName(!0).args(["linux"]).runtime(a.RuntimeType.Shell).presentation().echo(!0),n(s,e)):p.isMacintosh&&(e.task("echo","echo").command().suppressTaskName(!0).args(["osx"]).runtime(a.RuntimeType.Shell).presentation().echo(!0),n(s,e))})}),suite("Bugs / regression tests",()=>{(p.isLinux?test.skip:test)("Bug 19548",()=>{const s={version:"0.1.0",windows:{command:"powershell",options:{cwd:"${workspaceFolder}"},tasks:[{taskName:"composeForDebug",suppressTaskName:!0,args:["-ExecutionPolicy","RemoteSigned",".\\dockerTask.ps1","-ComposeForDebug","-Environment","debug"],isBuildCommand:!1,showOutput:"always",echoCommand:!0}]},osx:{command:"/bin/bash",options:{cwd:"${workspaceFolder}"},tasks:[{taskName:"composeForDebug",suppressTaskName:!0,args:["-c","./dockerTask.sh composeForDebug debug"],isBuildCommand:!1,showOutput:"always"}]}},e=new o;p.isWindows?(e.task("composeForDebug","powershell").command().suppressTaskName(!0).args(["-ExecutionPolicy","RemoteSigned",".\\dockerTask.ps1","-ComposeForDebug","-Environment","debug"]).options({cwd:"${workspaceFolder}"}).presentation().echo(!0).reveal(a.RevealKind.Always),n(s,e)):p.isMacintosh&&(e.task("composeForDebug","/bin/bash").command().suppressTaskName(!0).args(["-c","./dockerTask.sh composeForDebug debug"]).options({cwd:"${workspaceFolder}"}).presentation().reveal(a.RevealKind.Always),n(s,e))}),test("Bug 28489",()=>{const s={version:"0.1.0",command:"",isShellCommand:!0,args:[""],showOutput:"always",tasks:[{taskName:"build",command:"bash",args:["build.sh"]}]},e=new o;e.task("build","bash").group(a.TaskGroup.Build).command().suppressTaskName(!0).args(["build.sh"]).runtime(a.RuntimeType.Shell),n(s,e)})});class X{}class ee{}class se{_task;get(e){return this._task}set(e){this._task=e}}suite("Task configuration conversions",()=>{const s={},e={},r=new se;let i,u,m,k;setup(()=>{i=new F,m=i.createInstance(X),m.name="real",m.label="real label",k=new P,u=i.createInstance(ee),u.problemReporter=k,u.namedProblemMatchers={real:m},u.uuidMap=new L}),teardown(()=>{i.dispose()}),suite("ProblemMatcherConverter.from",()=>{test("returns [] and an error for an unknown problem matcher",()=>{const l=C.from("$fake",u);t.deepEqual(l.value,[]),t.strictEqual(l.errors?.length,1)}),test("returns config for a known problem matcher",()=>{const l=C.from("$real",u);t.strictEqual(l.errors?.length,0),t.deepEqual(l.value,[{label:"real label"}])}),test("returns config for a known problem matcher including applyTo",()=>{m.applyTo=f.closedDocuments;const l=C.from("$real",u);t.strictEqual(l.errors?.length,0),t.deepEqual(l.value,[{label:"real label",applyTo:f.closedDocuments}])})}),suite("TaskParser.from",()=>{suite("CustomTask",()=>{suite("incomplete config reports an appropriate error for missing",()=>{test("name",()=>{const l=h.from([{}],s,u,e);T(l,void 0,k,"Error: a task must provide a label property")}),test("command",()=>{const l=h.from([{taskName:"task"}],s,u,e);T(l,void 0,k,"Error: the task 'task' doesn't define a command")})}),test("returns expected result",()=>{const l=[{taskName:"task",command:"echo test"},{taskName:"task 2",command:"echo test"}],d=h.from(l,s,u,e);T(d,{custom:l},k,void 0)})}),suite("ConfiguredTask",()=>{test("returns expected result",()=>{const l=[{taskName:"task",command:"echo test",type:"any",label:"task"},{taskName:"task 2",command:"echo test",type:"any",label:"task 2"}];r.set({extensionId:"registered",taskType:"any",properties:{}});const d=h.from(l,s,u,e,r);T(d,{configured:l},k,void 0)})})})});function T(s,e,r,i){i===void 0?t.strictEqual(r.lastMessage,void 0):t.ok(r.lastMessage?.includes(i)),t.deepEqual(s.custom.length,e?.custom?.length||0),t.deepEqual(s.configured.length,e?.configured?.length||0);let u=0;if(e?.configured)for(const m of e?.configured)t.strictEqual(s.configured[u]._label,m.label),u++;if(u=0,e?.custom)for(const m of e?.custom)t.strictEqual(s.custom[u]._label,m.taskName),u++;r.clearMessage()}
