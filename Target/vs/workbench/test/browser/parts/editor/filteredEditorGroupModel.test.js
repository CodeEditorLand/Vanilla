import t from"assert";import{EditorGroupModel as D}from"../../../../common/editor/editorGroupModel.js";import{EditorExtensions as O,EditorsOrder as c,GroupModelChangeKind as k}from"../../../../common/editor.js";import"../../../../../base/common/uri.js";import{TestLifecycleService as N}from"../../workbenchTestServices.js";import{TestConfigurationService as R}from"../../../../../platform/configuration/test/common/testConfigurationService.js";import{TestInstantiationService as M}from"../../../../../platform/instantiation/test/common/instantiationServiceMock.js";import{IConfigurationService as _}from"../../../../../platform/configuration/common/configuration.js";import{ILifecycleService as B}from"../../../../services/lifecycle/common/lifecycle.js";import{IWorkspaceContextService as Q}from"../../../../../platform/workspace/common/workspace.js";import{Registry as z}from"../../../../../platform/registry/common/platform.js";import"../../../../../platform/instantiation/common/instantiation.js";import{ITelemetryService as P}from"../../../../../platform/telemetry/common/telemetry.js";import{NullTelemetryService as Y}from"../../../../../platform/telemetry/common/telemetryUtils.js";import{IStorageService as V}from"../../../../../platform/storage/common/storage.js";import{DisposableStore as J,toDisposable as K}from"../../../../../base/common/lifecycle.js";import{TestContextService as W,TestStorageService as j}from"../../../common/workbenchTestServices.js";import{EditorInput as x}from"../../../../common/editor/editorInput.js";import{isEqual as H}from"../../../../../base/common/resources.js";import{ensureNoDisposablesAreLeakedInTestSuite as X}from"../../../../../base/test/common/utils.js";import{StickyEditorGroupModel as a,UnstickyEditorGroupModel as E}from"../../../../common/editor/filteredEditorGroupModel.js";suite("FilteredEditorGroupModel",()=>{let f;suiteTeardown(()=>{f?.dispose(),f=void 0});function b(){f||(f=new M);const i=f;i.stub(V,o.add(new j)),i.stub(B,o.add(new N)),i.stub(Q,new W),i.stub(P,Y);const r=new R;return r.setUserConfiguration("workbench",{editor:{openPositioning:"right",focusRecentEditorAfterClose:!0}}),i.stub(_,r),i}function u(i){const r=o.add(b().createInstance(D,i));return o.add(K(()=>{for(const e of r.getEditors(c.MOST_RECENTLY_ACTIVE))r.closeEditor(e)})),r}let A=0;class g extends x{constructor(e){super();this.id=e}resource=void 0;get typeId(){return"testEditorInputForGroups"}async resolve(){return null}matches(e){return e&&this.id===e.id&&e instanceof g}setDirty(){this._onDidChangeDirty.fire()}setLabel(){this._onDidChangeLabel.fire()}}class S extends x{constructor(e){super();this.id=e}resource=void 0;get typeId(){return"testEditorInputForGroups-nonSerializable"}async resolve(){return null}matches(e){return e&&this.id===e.id&&e instanceof S}}class T extends x{constructor(e,s){super();this.id=e;this.resource=s}preferredResource=this.resource;get typeId(){return"testFileEditorInputForGroups"}get editorId(){return this.id}async resolve(){return null}setPreferredName(e){}setPreferredDescription(e){}setPreferredResource(e){}async setEncoding(e){}getEncoding(){}setPreferredEncoding(e){}setForceOpenAsBinary(){}setPreferredContents(e){}setLanguageId(e){}setPreferredLanguageId(e){}isResolved(){return!1}matches(e){return super.matches(e)?!0:e instanceof T?H(e.resource,this.resource):!1}}function d(i=String(A++),r,e){return e?o.add(new T(i,e)):r?o.add(new S(i)):o.add(new g(i))}function h(i){for(const r of i.getEditors(c.SEQUENTIAL))i.closeEditor(r,void 0,!1)}class q{static disableSerialize=!1;static disableDeserialize=!1;canSerialize(r){return!0}serialize(r){if(q.disableSerialize)return;const s={id:r.id};return JSON.stringify(s)}deserialize(r,e){if(q.disableDeserialize)return;const s=JSON.parse(e);return o.add(new g(s.id))}}const o=new J;setup(()=>{q.disableSerialize=!1,q.disableDeserialize=!1,o.add(z.as(O.EditorFactory).registerEditorSerializer("testEditorInputForGroups",q))}),teardown(()=>{o.clear(),A=1}),test("Sticky/Unsticky count",async()=>{const i=u(),r=o.add(new a(i)),e=o.add(new E(i)),s=d(),n=d();i.openEditor(s,{pinned:!0,sticky:!0}),i.openEditor(n,{pinned:!0,sticky:!0}),t.strictEqual(r.count,2),t.strictEqual(e.count,0),i.unstick(s),t.strictEqual(r.count,1),t.strictEqual(e.count,1),i.unstick(n),t.strictEqual(r.count,0),t.strictEqual(e.count,2)}),test("Sticky/Unsticky stickyCount",async()=>{const i=u(),r=o.add(new a(i)),e=o.add(new E(i)),s=d(),n=d();i.openEditor(s,{pinned:!0,sticky:!0}),i.openEditor(n,{pinned:!0,sticky:!0}),t.strictEqual(r.stickyCount,2),t.strictEqual(e.stickyCount,0),i.unstick(s),t.strictEqual(r.stickyCount,1),t.strictEqual(e.stickyCount,0),i.unstick(n),t.strictEqual(r.stickyCount,0),t.strictEqual(e.stickyCount,0)}),test("Sticky/Unsticky isEmpty",async()=>{const i=u(),r=o.add(new a(i)),e=o.add(new E(i)),s=d(),n=d();i.openEditor(s,{pinned:!0,sticky:!1}),i.openEditor(n,{pinned:!0,sticky:!1}),t.strictEqual(r.count===0,!0),t.strictEqual(e.count===0,!1),i.stick(s),t.strictEqual(r.count===0,!1),t.strictEqual(e.count===0,!1),i.stick(n),t.strictEqual(r.count===0,!1),t.strictEqual(e.count===0,!0)}),test("Sticky/Unsticky editors",async()=>{const i=u(),r=o.add(new a(i)),e=o.add(new E(i)),s=d(),n=d();i.openEditor(s,{pinned:!0,sticky:!0}),i.openEditor(n,{pinned:!0,sticky:!0}),t.strictEqual(r.getEditors(c.SEQUENTIAL).length,2),t.strictEqual(e.getEditors(c.SEQUENTIAL).length,0),i.unstick(s),t.strictEqual(r.getEditors(c.SEQUENTIAL).length,1),t.strictEqual(e.getEditors(c.SEQUENTIAL).length,1),t.strictEqual(r.getEditors(c.SEQUENTIAL)[0],n),t.strictEqual(e.getEditors(c.SEQUENTIAL)[0],s),i.unstick(n),t.strictEqual(r.getEditors(c.SEQUENTIAL).length,0),t.strictEqual(e.getEditors(c.SEQUENTIAL).length,2)}),test("Sticky/Unsticky activeEditor",async()=>{const i=u(),r=o.add(new a(i)),e=o.add(new E(i)),s=d(),n=d();i.openEditor(s,{pinned:!0,sticky:!0,active:!0}),t.strictEqual(r.activeEditor,s),t.strictEqual(e.activeEditor,null),i.openEditor(n,{pinned:!0,sticky:!1,active:!0}),t.strictEqual(r.activeEditor,null),t.strictEqual(e.activeEditor,n),i.closeEditor(s),t.strictEqual(r.activeEditor,null),t.strictEqual(e.activeEditor,n),i.closeEditor(n),t.strictEqual(r.activeEditor,null),t.strictEqual(e.activeEditor,null)}),test("Sticky/Unsticky previewEditor",async()=>{const i=u(),r=o.add(new a(i)),e=o.add(new E(i)),s=d(),n=d();i.openEditor(s),t.strictEqual(r.previewEditor,null),t.strictEqual(e.previewEditor,s),i.openEditor(n,{sticky:!0}),t.strictEqual(r.previewEditor,null),t.strictEqual(e.previewEditor,s)}),test("Sticky/Unsticky isSticky()",async()=>{const i=u(),r=o.add(new a(i)),e=o.add(new E(i)),s=d(),n=d();i.openEditor(s,{pinned:!0,sticky:!0}),i.openEditor(n,{pinned:!0,sticky:!0}),t.strictEqual(r.isSticky(s),!0),t.strictEqual(r.isSticky(n),!0),i.unstick(s),i.closeEditor(s),i.openEditor(n,{pinned:!0,sticky:!0}),t.strictEqual(e.isSticky(s),!1),t.strictEqual(e.isSticky(n),!1)}),test("Sticky/Unsticky isPinned()",async()=>{const i=u(),r=o.add(new a(i)),e=o.add(new E(i)),s=d(),n=d(),l=d(),y=d();i.openEditor(s,{pinned:!0,sticky:!0}),i.openEditor(n,{pinned:!0,sticky:!1}),i.openEditor(l,{pinned:!1,sticky:!0}),i.openEditor(y,{pinned:!1,sticky:!1}),t.strictEqual(r.isPinned(s),!0),t.strictEqual(e.isPinned(n),!0),t.strictEqual(r.isPinned(l),!0),t.strictEqual(e.isPinned(y),!1)}),test("Sticky/Unsticky isActive()",async()=>{const i=u(),r=o.add(new a(i)),e=o.add(new E(i)),s=d(),n=d();i.openEditor(s,{pinned:!0,sticky:!0,active:!0}),t.strictEqual(r.isActive(s),!0),i.openEditor(n,{pinned:!0,sticky:!1,active:!0}),t.strictEqual(r.isActive(s),!1),t.strictEqual(e.isActive(n),!0),i.unstick(s),t.strictEqual(e.isActive(s),!1),t.strictEqual(e.isActive(n),!0)}),test("Sticky/Unsticky getEditors()",async()=>{const i=u(),r=o.add(new a(i)),e=o.add(new E(i)),s=d(),n=d();i.openEditor(s,{pinned:!0,sticky:!0,active:!0}),i.openEditor(n,{pinned:!0,sticky:!0,active:!0}),t.strictEqual(r.getEditors(c.SEQUENTIAL).length,2),t.strictEqual(r.getEditors(c.MOST_RECENTLY_ACTIVE).length,2),t.strictEqual(e.getEditors(c.SEQUENTIAL).length,0),t.strictEqual(e.getEditors(c.MOST_RECENTLY_ACTIVE).length,0),t.strictEqual(r.getEditors(c.SEQUENTIAL,{excludeSticky:!0}).length,0),t.strictEqual(r.getEditors(c.SEQUENTIAL,{excludeSticky:!1}).length,2),t.strictEqual(e.getEditors(c.SEQUENTIAL,{excludeSticky:!0}).length,0),t.strictEqual(e.getEditors(c.SEQUENTIAL,{excludeSticky:!1}).length,0),t.strictEqual(r.getEditors(c.MOST_RECENTLY_ACTIVE)[0],n),t.strictEqual(r.getEditors(c.MOST_RECENTLY_ACTIVE)[1],s),i.unstick(s),t.strictEqual(r.getEditors(c.SEQUENTIAL).length,1),t.strictEqual(e.getEditors(c.MOST_RECENTLY_ACTIVE).length,1),t.strictEqual(r.getEditors(c.MOST_RECENTLY_ACTIVE)[0],n),t.strictEqual(e.getEditors(c.SEQUENTIAL)[0],s),i.unstick(n),t.strictEqual(r.getEditors(c.SEQUENTIAL).length,0),t.strictEqual(e.getEditors(c.MOST_RECENTLY_ACTIVE).length,2),t.strictEqual(e.getEditors(c.MOST_RECENTLY_ACTIVE)[0],n),t.strictEqual(e.getEditors(c.MOST_RECENTLY_ACTIVE)[1],s),t.strictEqual(e.getEditors(c.SEQUENTIAL)[0],n),t.strictEqual(e.getEditors(c.SEQUENTIAL)[1],s)}),test("Sticky/Unsticky getEditorByIndex()",async()=>{const i=u(),r=o.add(new a(i)),e=o.add(new E(i)),s=d(),n=d(),l=d();i.openEditor(s,{pinned:!0,sticky:!0}),i.openEditor(n,{pinned:!0,sticky:!0}),t.strictEqual(r.getEditorByIndex(0),s),t.strictEqual(r.getEditorByIndex(1),n),t.strictEqual(r.getEditorByIndex(2),void 0),t.strictEqual(e.getEditorByIndex(0),void 0),t.strictEqual(e.getEditorByIndex(1),void 0),i.openEditor(l,{pinned:!0,sticky:!1}),t.strictEqual(r.getEditorByIndex(0),s),t.strictEqual(r.getEditorByIndex(1),n),t.strictEqual(r.getEditorByIndex(2),void 0),t.strictEqual(e.getEditorByIndex(0),l),t.strictEqual(e.getEditorByIndex(1),void 0),i.unstick(s),t.strictEqual(r.getEditorByIndex(0),n),t.strictEqual(r.getEditorByIndex(1),void 0),t.strictEqual(e.getEditorByIndex(0),s),t.strictEqual(e.getEditorByIndex(1),l),t.strictEqual(e.getEditorByIndex(2),void 0)}),test("Sticky/Unsticky indexOf()",async()=>{const i=u(),r=o.add(new a(i)),e=o.add(new E(i)),s=d(),n=d(),l=d();i.openEditor(s,{pinned:!0,sticky:!0}),i.openEditor(n,{pinned:!0,sticky:!0}),t.strictEqual(r.indexOf(s),0),t.strictEqual(r.indexOf(n),1),t.strictEqual(e.indexOf(s),-1),t.strictEqual(e.indexOf(n),-1),i.openEditor(l,{pinned:!0,sticky:!1}),t.strictEqual(r.indexOf(s),0),t.strictEqual(r.indexOf(n),1),t.strictEqual(r.indexOf(l),-1),t.strictEqual(e.indexOf(s),-1),t.strictEqual(e.indexOf(n),-1),t.strictEqual(e.indexOf(l),0),i.unstick(s),t.strictEqual(r.indexOf(s),-1),t.strictEqual(r.indexOf(n),0),t.strictEqual(r.indexOf(l),-1),t.strictEqual(e.indexOf(s),0),t.strictEqual(e.indexOf(n),-1),t.strictEqual(e.indexOf(l),1)}),test("Sticky/Unsticky isFirst()",async()=>{const i=u(),r=o.add(new a(i)),e=o.add(new E(i)),s=d(),n=d();i.openEditor(s,{pinned:!0,sticky:!0}),t.strictEqual(r.isFirst(s),!0),i.openEditor(n,{pinned:!0,sticky:!0}),t.strictEqual(r.isFirst(s),!0),t.strictEqual(r.isFirst(n),!1),i.unstick(s),t.strictEqual(e.isFirst(s),!0),t.strictEqual(r.isFirst(n),!0),i.unstick(n),t.strictEqual(e.isFirst(s),!1),t.strictEqual(e.isFirst(n),!0),i.moveEditor(n,1),t.strictEqual(e.isFirst(s),!0),t.strictEqual(e.isFirst(n),!1)}),test("Sticky/Unsticky isLast()",async()=>{const i=u(),r=o.add(new a(i)),e=o.add(new E(i)),s=d(),n=d();i.openEditor(s,{pinned:!0,sticky:!0}),t.strictEqual(r.isLast(s),!0),i.openEditor(n,{pinned:!0,sticky:!0}),t.strictEqual(r.isLast(s),!1),t.strictEqual(r.isLast(n),!0),i.unstick(s),t.strictEqual(e.isLast(s),!0),t.strictEqual(r.isLast(n),!0),i.unstick(n),t.strictEqual(e.isLast(s),!0),t.strictEqual(e.isLast(n),!1),i.moveEditor(n,1),t.strictEqual(e.isLast(s),!1),t.strictEqual(e.isLast(n),!0)}),test("Sticky/Unsticky contains()",async()=>{const i=u(),r=o.add(new a(i)),e=o.add(new E(i)),s=d(),n=d();i.openEditor(s,{pinned:!0,sticky:!0}),i.openEditor(n,{pinned:!0,sticky:!0}),t.strictEqual(r.contains(s),!0),t.strictEqual(r.contains(n),!0),t.strictEqual(e.contains(s),!1),t.strictEqual(e.contains(n),!1),i.unstick(s),t.strictEqual(r.contains(s),!1),t.strictEqual(r.contains(n),!0),t.strictEqual(e.contains(s),!0),t.strictEqual(e.contains(n),!1),i.unstick(n),t.strictEqual(r.contains(s),!1),t.strictEqual(r.contains(n),!1),t.strictEqual(e.contains(s),!0),t.strictEqual(e.contains(n),!0)}),test("Sticky/Unsticky group information",async()=>{const i=u(),r=o.add(new a(i)),e=o.add(new E(i));t.strictEqual(r.id,i.id),t.strictEqual(e.id,i.id),t.strictEqual(r.isLocked,i.isLocked),t.strictEqual(e.isLocked,i.isLocked),i.lock(!0),t.strictEqual(r.isLocked,i.isLocked),t.strictEqual(e.isLocked,i.isLocked),i.lock(!1),t.strictEqual(r.isLocked,i.isLocked),t.strictEqual(e.isLocked,i.isLocked)}),test("Multiple Editors - Editor Emits Dirty and Label Changed",function(){const i=u(),r=u(),e=o.add(new a(i)),s=o.add(new E(i)),n=o.add(new a(r)),l=o.add(new E(r)),y=d(),I=d();i.openEditor(y,{pinned:!0,active:!0}),r.openEditor(I,{pinned:!0,active:!0,sticky:!0});let m=0;o.add(e.onDidModelChange(p=>{p.kind===k.EDITOR_DIRTY&&m++}));let L=0;o.add(s.onDidModelChange(p=>{p.kind===k.EDITOR_DIRTY&&L++}));let v=0;o.add(n.onDidModelChange(p=>{p.kind===k.EDITOR_DIRTY&&v++}));let F=0;o.add(l.onDidModelChange(p=>{p.kind===k.EDITOR_DIRTY&&F++}));let C=0;o.add(e.onDidModelChange(p=>{p.kind===k.EDITOR_LABEL&&C++}));let w=0;o.add(s.onDidModelChange(p=>{p.kind===k.EDITOR_LABEL&&w++}));let G=0;o.add(n.onDidModelChange(p=>{p.kind===k.EDITOR_LABEL&&G++}));let U=0;o.add(l.onDidModelChange(p=>{p.kind===k.EDITOR_LABEL&&U++})),y.setDirty(),y.setLabel(),t.strictEqual(m,0),t.strictEqual(L,1),t.strictEqual(C,0),t.strictEqual(w,1),I.setDirty(),I.setLabel(),t.strictEqual(v,1),t.strictEqual(F,0),t.strictEqual(G,1),t.strictEqual(U,0),h(r),I.setDirty(),I.setLabel(),t.strictEqual(v,1),t.strictEqual(F,0),t.strictEqual(G,1),t.strictEqual(U,0),t.strictEqual(m,0),t.strictEqual(L,1),t.strictEqual(C,0),t.strictEqual(w,1)}),test("Sticky/Unsticky isTransient()",async()=>{const i=u(),r=o.add(new a(i)),e=o.add(new E(i)),s=d(),n=d(),l=d(),y=d();i.openEditor(s,{pinned:!0,transient:!1}),i.openEditor(n,{pinned:!0}),i.openEditor(l,{pinned:!0,transient:!0}),i.openEditor(y,{pinned:!1,transient:!0}),t.strictEqual(r.isTransient(s),!1),t.strictEqual(e.isTransient(n),!1),t.strictEqual(r.isTransient(l),!0),t.strictEqual(e.isTransient(y),!0)}),X()});
