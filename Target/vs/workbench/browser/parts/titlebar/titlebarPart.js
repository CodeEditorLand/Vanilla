var he=Object.defineProperty;var ue=Object.getOwnPropertyDescriptor;var y=(h,a,t,e)=>{for(var i=e>1?void 0:e?ue(a,t):a,n=h.length-1,r;n>=0;n--)(r=h[n])&&(i=(e?r(a,t,i):r(i))||i);return e&&i&&he(a,t,i),i},o=(h,a)=>(t,e)=>a(t,e,h);import"./media/titlebarpart.css";import{localize as me,localize2 as pe}from"../../../../nls.js";import{MultiWindowParts as ve,Part as be}from"../../part.js";import"../../../services/title/browser/titleService.js";import{getWCOTitlebarAreaRect as ge,getZoomFactor as B,isWCOEnabled as q}from"../../../../base/browser/browser.js";import{getTitleBarStyle as fe,getMenuBarVisibility as Ie,hasCustomTitlebar as L,hasNativeTitlebar as w,DEFAULT_CUSTOM_TITLEBAR_HEIGHT as Te}from"../../../../platform/window/common/window.js";import{IContextMenuService as R}from"../../../../platform/contextview/browser/contextView.js";import{StandardMouseEvent as ye}from"../../../../base/browser/mouseEvent.js";import{IConfigurationService as N}from"../../../../platform/configuration/common/configuration.js";import{DisposableStore as u}from"../../../../base/common/lifecycle.js";import{IBrowserWorkbenchEnvironmentService as H}from"../../../services/environment/browser/environmentService.js";import{IThemeService as _}from"../../../../platform/theme/common/themeService.js";import{ThemeIcon as Ce}from"../../../../base/common/themables.js";import{TITLE_BAR_ACTIVE_BACKGROUND as Ae,TITLE_BAR_ACTIVE_FOREGROUND as Se,TITLE_BAR_INACTIVE_FOREGROUND as Ee,TITLE_BAR_INACTIVE_BACKGROUND as Me,TITLE_BAR_BORDER as Be,WORKBENCH_BACKGROUND as Le}from"../../../common/theme.js";import{isMacintosh as l,isWindows as we,isLinux as _e,isWeb as d,isNative as W,platformLocale as De}from"../../../../base/common/platform.js";import{Color as xe}from"../../../../base/common/color.js";import{EventType as j,EventHelper as J,Dimension as X,append as c,$ as s,addDisposableListener as Q,prepend as ee,reset as Ve,getWindow as m,getWindowId as Oe,isAncestor as Pe,getActiveDocument as Re,isHTMLElement as Ne}from"../../../../base/browser/dom.js";import{CustomMenubarControl as He}from"./menubarControl.js";import{IInstantiationService as D}from"../../../../platform/instantiation/common/instantiation.js";import{Emitter as te,Event as ie}from"../../../../base/common/event.js";import{IStorageService as x,StorageScope as We}from"../../../../platform/storage/common/storage.js";import{Parts as oe,IWorkbenchLayoutService as G,ActivityBarPosition as re,LayoutSettings as v,EditorActionsLocation as ne,EditorTabsMode as Ge}from"../../../services/layout/browser/layoutService.js";import{createActionViewItem as Ke,createAndFillInActionBarActions as ke}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{Action2 as Fe,IMenuService as K,MenuId as C,registerAction2 as Ue}from"../../../../platform/actions/common/actions.js";import{IContextKeyService as k}from"../../../../platform/contextkey/common/contextkey.js";import{IHostService as F}from"../../../services/host/browser/host.js";import{Codicon as Ye}from"../../../../base/common/codicons.js";import{getIconRegistry as Ze}from"../../../../platform/theme/common/iconRegistry.js";import{WindowTitle as ze}from"./windowTitle.js";import{CommandCenterControl as $e}from"./commandCenterControl.js";import{Categories as qe}from"../../../../platform/action/common/actionCommonCategories.js";import{WorkbenchToolBar as je}from"../../../../platform/actions/browser/toolbar.js";import{ACCOUNTS_ACTIVITY_ID as ae,GLOBAL_ACTIVITY_ID as se}from"../../../common/activity.js";import{AccountsActivityActionViewItem as Je,isAccountsActionVisible as Xe,SimpleAccountActivityActionViewItem as Qe,SimpleGlobalActivityActionViewItem as et}from"../globalCompositeBar.js";import{HoverPosition as le}from"../../../../base/browser/ui/hover/hoverWidget.js";import{IEditorGroupsService as U}from"../../../services/editor/common/editorGroupsService.js";import{ActionRunner as tt}from"../../../../base/common/actions.js";import{IEditorService as Y}from"../../../services/editor/common/editorService.js";import{ActionsOrientation as it,prepareActions as ce}from"../../../../base/browser/ui/actionbar/actionbar.js";import{EDITOR_CORE_NAVIGATION_COMMANDS as ot}from"../editor/editorCommands.js";import{AnchorAlignment as rt}from"../../../../base/browser/ui/contextview/contextview.js";import{EditorPane as nt}from"../editor/editorPane.js";import{IKeybindingService as Z}from"../../../../platform/keybinding/common/keybinding.js";import"../../../../base/common/keybindings.js";import{EditorCommandsContextActionRunner as at}from"../editor/editorTabsControl.js";import"../../../common/editor.js";import{mainWindow as st}from"../../../../base/browser/window.js";import{ACCOUNTS_ACTIVITY_TILE_ACTION as lt,GLOBAL_ACTIVITY_TITLE_ACTION as ct}from"./titlebarActions.js";import"../../../../base/browser/ui/grid/grid.js";import{createInstantHoverDelegate as dt}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import"../../../../base/browser/ui/actionbar/actionViewItems.js";import"../../../../base/browser/ui/hover/hoverDelegate.js";import{CommandsRegistry as ht}from"../../../../platform/commands/common/commands.js";let V=class extends ve{constructor(t,e,i){super("workbench.titleService",i,e);this.instantiationService=t;this._register(this.registerPart(this.mainPart)),this.registerActions(),this.registerAPICommands()}mainPart=this._register(this.createMainTitlebarPart());createMainTitlebarPart(){return this.instantiationService.createInstance(A)}registerActions(){const t=this;this._register(Ue(class extends Fe{constructor(){super({id:"workbench.action.focusTitleBar",title:pe("focusTitleBar","Focus Title Bar"),category:qe.View,f1:!0})}run(){t.getPartByDocument(Re()).focus()}}))}registerAPICommands(){this._register(ht.registerCommand({id:"registerWindowTitleVariable",handler:(t,e,i)=>{this.registerVariables([{name:e,contextKey:i}])},metadata:{description:"Registers a new title variable",args:[{name:"name",schema:{type:"string"},description:"The name of the variable to register"},{name:"contextKey",schema:{type:"string"},description:"The context key to use for the value of the variable"}]}}))}createAuxiliaryTitlebarPart(t,e){const i=document.createElement("div");i.classList.add("part","titlebar"),i.setAttribute("role","none"),i.style.position="relative",t.insertBefore(i,t.firstChild);const n=new u,r=this.doCreateAuxiliaryTitlebarPart(i,e);return n.add(this.registerPart(r)),n.add(ie.runAndSubscribe(r.onDidChange,()=>i.style.height=`${r.height}px`)),r.create(i),this.properties&&r.updateProperties(this.properties),this.variables.size&&r.registerVariables(Array.from(this.variables.values())),ie.once(r.onWillDispose)(()=>n.dispose()),r}doCreateAuxiliaryTitlebarPart(t,e){return this.instantiationService.createInstance(p,t,e,this.mainPart)}onMenubarVisibilityChange=this.mainPart.onMenubarVisibilityChange;properties=void 0;updateProperties(t){this.properties=t;for(const e of this.parts)e.updateProperties(t)}variables=new Map;registerVariables(t){const e=[];for(const i of t)this.variables.has(i.name)||(this.variables.set(i.name,i),e.push(i));for(const i of this.parts)i.registerVariables(e)}};V=y([o(0,D),o(1,x),o(2,_)],V);let b=class extends be{constructor(t,e,i,n,r,S,g,f,I,T,E,M,O,P,z,$){super(t,{hasTitle:!1},f,I,T);this.contextMenuService=n;this.configurationService=r;this.environmentService=S;this.instantiationService=g;this.storageService=I;this.contextKeyService=E;this.hostService=M;this.editorGroupService=O;this.menuService=z;this.keybindingService=$;this.isAuxiliary=i!=="main",this.editorService=P.createScoped(i,this._store),this.editorGroupsContainer=i==="main"?O.mainPart:i,this.windowTitle=this._register(g.createInstance(ze,e,i)),this.hoverDelegate=this._register(dt()),this.registerListeners(Oe(e))}minimumWidth=0;maximumWidth=Number.POSITIVE_INFINITY;get minimumHeight(){const t=d&&q();let e=this.isCommandCenterVisible||t?Te:30;return t&&(e=Math.max(e,ge(m(this.element))?.height??0)),e/(this.preventZoom?B(m(this.element)):1)}get maximumHeight(){return this.minimumHeight}_onMenubarVisibilityChange=this._register(new te);onMenubarVisibilityChange=this._onMenubarVisibilityChange.event;_onWillDispose=this._register(new te);onWillDispose=this._onWillDispose.event;rootContainer;windowControlsContainer;dragRegion;title;leftContent;centerContent;rightContent;customMenubar;appIcon;appIconBadge;menubar;lastLayoutDimensions;actionToolBar;actionToolBarDisposable=this._register(new u);editorActionsChangeDisposable=this._register(new u);actionToolBarElement;layoutToolbarMenu;editorToolbarMenuDisposables=this._register(new u);layoutToolbarMenuDisposables=this._register(new u);activityToolbarDisposables=this._register(new u);hoverDelegate;titleDisposables=this._register(new u);titleBarStyle=fe(this.configurationService);isInactive=!1;isAuxiliary;windowTitle;editorService;editorGroupsContainer;registerListeners(t){this._register(this.hostService.onDidChangeFocus(e=>e?this.onFocus():this.onBlur())),this._register(this.hostService.onDidChangeActiveWindow(e=>e===t?this.onFocus():this.onBlur())),this._register(this.configurationService.onDidChangeConfiguration(e=>this.onConfigurationChanged(e))),this._register(this.editorGroupService.onDidChangeEditorPartOptions(e=>this.onEditorPartConfigurationChange(e)))}onBlur(){this.isInactive=!0,this.updateStyles()}onFocus(){this.isInactive=!1,this.updateStyles()}onEditorPartConfigurationChange({oldPartOptions:t,newPartOptions:e}){(t.editorActionsLocation!==e.editorActionsLocation||t.showTabs!==e.showTabs)&&L(this.configurationService,this.titleBarStyle)&&this.actionToolBar&&(this.createActionToolBar(),this.createActionToolBarMenus({editorActions:!0}),this._onDidChange.fire(void 0))}onConfigurationChanged(t){if(!this.isAuxiliary&&!w(this.configurationService,this.titleBarStyle)&&(!l||d)&&t.affectsConfiguration("window.menuBarVisibility")&&(this.currentMenubarVisibility==="compact"?this.uninstallMenubar():this.installMenubar()),L(this.configurationService,this.titleBarStyle)&&this.actionToolBar){const e=t.affectsConfiguration(v.LAYOUT_ACTIONS),i=t.affectsConfiguration(v.ACTIVITY_BAR_LOCATION);(e||i)&&(this.createActionToolBarMenus({layoutActions:e,activityActions:i}),this._onDidChange.fire(void 0))}t.affectsConfiguration(v.COMMAND_CENTER)&&(this.createTitle(),this._onDidChange.fire(void 0))}installMenubar(){this.menubar||(this.customMenubar=this._register(this.instantiationService.createInstance(He)),this.menubar=c(this.leftContent,s("div.menubar")),this.menubar.setAttribute("role","menubar"),this._register(this.customMenubar.onVisibilityChange(t=>this.onMenubarVisibilityChanged(t))),this.customMenubar.create(this.menubar))}uninstallMenubar(){this.customMenubar?.dispose(),this.customMenubar=void 0,this.menubar?.remove(),this.menubar=void 0,this.onMenubarVisibilityChanged(!1)}onMenubarVisibilityChanged(t){(d||we||_e)&&(this.lastLayoutDimensions&&this.layout(this.lastLayoutDimensions.width,this.lastLayoutDimensions.height),this._onMenubarVisibilityChange.fire(t))}updateProperties(t){this.windowTitle.updateProperties(t)}registerVariables(t){this.windowTitle.registerVariables(t)}createContentArea(t){if(this.element=t,this.rootContainer=c(t,s(".titlebar-container")),this.leftContent=c(this.rootContainer,s(".titlebar-left")),this.centerContent=c(this.rootContainer,s(".titlebar-center")),this.rightContent=c(this.rootContainer,s(".titlebar-right")),!l&&!d&&!w(this.configurationService,this.titleBarStyle)&&(this.appIcon=ee(this.leftContent,s("a.window-appicon")),!this.isAuxiliary&&d)){const e=this.environmentService.options?.homeIndicator;if(e){const i=Ze().getIcon(e.icon)?{id:e.icon}:Ye.code;this.appIcon.setAttribute("href",e.href),this.appIcon.classList.add(...Ce.asClassNameArray(i)),this.appIconBadge=document.createElement("div"),this.appIconBadge.classList.add("home-bar-icon-badge"),this.appIcon.appendChild(this.appIconBadge)}}if(this.dragRegion=ee(this.rootContainer,s("div.titlebar-drag-region")),!this.isAuxiliary&&!w(this.configurationService,this.titleBarStyle)&&(!l||d)&&this.currentMenubarVisibility!=="compact"&&this.installMenubar(),this.title=c(this.centerContent,s("div.window-title")),this.createTitle(),L(this.configurationService,this.titleBarStyle)&&(this.actionToolBarElement=c(this.rightContent,s("div.action-toolbar-container")),this.createActionToolBar(),this.createActionToolBarMenus()),!w(this.configurationService,this.titleBarStyle)){let e=l?"left":"right";l&&W&&new Intl.Locale(De)?.textInfo?.direction==="rtl"&&(e="right"),l&&W&&e==="left"||(this.windowControlsContainer=c(e==="left"?this.leftContent:this.rightContent,s("div.window-controls-container")),d&&c(e==="left"?this.rightContent:this.leftContent,s("div.window-controls-container")),q()&&this.windowControlsContainer.classList.add("wco-enabled"))}return this._register(Q(this.rootContainer,j.CONTEXT_MENU,e=>{J.stop(e);let i;l&&Ne(e.target)&&Pe(e.target,this.title)?i=C.TitleBarTitleContext:i=C.TitleBarContext,this.onContextMenu(e,i)})),l&&this._register(Q(this.title,j.MOUSE_DOWN,e=>{e.metaKey&&(J.stop(e,!0),this.onContextMenu(e,C.TitleBarTitleContext))},!0)),this.updateStyles(),this.element}createTitle(){if(this.titleDisposables.clear(),!this.isCommandCenterVisible)this.title.innerText=this.windowTitle.value,this.titleDisposables.add(this.windowTitle.onDidChange(()=>{this.title.innerText=this.windowTitle.value}));else{const t=this.instantiationService.createInstance($e,this.windowTitle,this.hoverDelegate);Ve(this.title,t.element),this.titleDisposables.add(t)}}actionViewItemProvider(t,e){if(!this.isAuxiliary){if(t.id===se)return this.instantiationService.createInstance(et,{position:()=>le.BELOW},e);if(t.id===ae)return this.instantiationService.createInstance(Qe,{position:()=>le.BELOW},e)}const i=this.editorGroupsContainer.activeGroup?.activeEditorPane;if(i&&i instanceof nt){const n=i.getActionViewItem(t,e);if(n)return n}return Ke(this.instantiationService,t,{...e,menuAsChild:!1})}getKeybinding(t){const e=this.editorGroupsContainer.activeGroup?.activeEditorPane?.scopedContextKeyService??this.contextKeyService;return this.keybindingService.lookupKeybinding(t.id,e)}createActionToolBar(){this.actionToolBarDisposable.clear(),this.actionToolBar=this.actionToolBarDisposable.add(this.instantiationService.createInstance(je,this.actionToolBarElement,{contextMenu:C.TitleBarContext,orientation:it.HORIZONTAL,ariaLabel:me("ariaLabelTitleActions","Title actions"),getKeyBinding:t=>this.getKeybinding(t),overflowBehavior:{maxItems:9,exempted:[ae,se,...ot]},anchorAlignmentProvider:()=>rt.RIGHT,telemetrySource:"titlePart",highlightToggledItems:this.editorActionsEnabled,actionViewItemProvider:(t,e)=>this.actionViewItemProvider(t,e),hoverDelegate:this.hoverDelegate})),this.editorActionsEnabled&&this.actionToolBarDisposable.add(this.editorGroupsContainer.onDidChangeActiveGroup(()=>this.createActionToolBarMenus({editorActions:!0})))}createActionToolBarMenus(t=!0){t===!0&&(t={editorActions:!0,layoutActions:!0,activityActions:!0});const e=()=>{const i={primary:[],secondary:[]};if(this.editorActionsEnabled){this.editorActionsChangeDisposable.clear();const n=this.editorGroupsContainer.activeGroup;if(n){const r=n.createEditorActions(this.editorActionsChangeDisposable);i.primary.push(...r.actions.primary),i.secondary.push(...r.actions.secondary),this.editorActionsChangeDisposable.add(r.onDidChange(()=>e()))}}this.layoutToolbarMenu&&ke(this.layoutToolbarMenu,{},i,()=>!this.editorActionsEnabled),this.activityActionsEnabled&&(Xe(this.storageService)&&i.primary.push(lt),i.primary.push(ct)),this.actionToolBar.setActions(ce(i.primary),ce(i.secondary))};if(t.editorActions)if(this.editorToolbarMenuDisposables.clear(),this.editorActionsEnabled&&this.editorService.activeEditor!==void 0){const i={groupId:this.editorGroupsContainer.activeGroup.id};this.actionToolBar.actionRunner=new at(i),this.actionToolBar.context=i,this.editorToolbarMenuDisposables.add(this.actionToolBar.actionRunner)}else this.actionToolBar.actionRunner=new tt,this.actionToolBar.context=void 0,this.editorToolbarMenuDisposables.add(this.actionToolBar.actionRunner);t.layoutActions&&(this.layoutToolbarMenuDisposables.clear(),this.layoutControlEnabled?(this.layoutToolbarMenu=this.menuService.createMenu(C.LayoutControlMenu,this.contextKeyService),this.layoutToolbarMenuDisposables.add(this.layoutToolbarMenu),this.layoutToolbarMenuDisposables.add(this.layoutToolbarMenu.onDidChange(()=>e()))):this.layoutToolbarMenu=void 0),t.activityActions&&(this.activityToolbarDisposables.clear(),this.activityActionsEnabled&&this.activityToolbarDisposables.add(this.storageService.onDidChangeValue(We.PROFILE,Je.ACCOUNTS_VISIBILITY_PREFERENCE_KEY,this._store)(()=>e()))),e()}updateStyles(){if(super.updateStyles(),this.element){this.isInactive?this.element.classList.add("inactive"):this.element.classList.remove("inactive");const t=this.getColor(this.isInactive?Me:Ae,(n,r)=>n.isOpaque()?n:n.makeOpaque(Le(r)))||"";this.element.style.backgroundColor=t,this.appIconBadge&&(this.appIconBadge.style.backgroundColor=t),t&&xe.fromHex(t).isLighter()?this.element.classList.add("light"):this.element.classList.remove("light");const e=this.getColor(this.isInactive?Ee:Se);this.element.style.color=e||"";const i=this.getColor(Be);this.element.style.borderBottom=i?`1px solid ${i}`:""}}onContextMenu(t,e){const i=new ye(m(this.element),t);this.contextMenuService.showContextMenu({getAnchor:()=>i,menuId:e,contextKeyService:this.contextKeyService,domForShadowRoot:l&&W?i.target:void 0})}get currentMenubarVisibility(){return this.isAuxiliary?"hidden":Ie(this.configurationService)}get layoutControlEnabled(){return!this.isAuxiliary&&this.configurationService.getValue(v.LAYOUT_ACTIONS)!==!1}get isCommandCenterVisible(){return this.configurationService.getValue(v.COMMAND_CENTER)!==!1}get editorActionsEnabled(){return this.editorGroupService.partOptions.editorActionsLocation===ne.TITLEBAR||this.editorGroupService.partOptions.editorActionsLocation===ne.DEFAULT&&this.editorGroupService.partOptions.showTabs===Ge.NONE}get activityActionsEnabled(){const t=this.configurationService.getValue(v.ACTIVITY_BAR_LOCATION);return!this.isAuxiliary&&(t===re.TOP||t===re.BOTTOM)}get hasZoomableElements(){const t=!(this.currentMenubarVisibility==="hidden"||this.currentMenubarVisibility==="compact"||!d&&l),e=this.isCommandCenterVisible,i=this.layoutControlEnabled||this.editorActionsEnabled||this.activityActionsEnabled;return t||e||i}get preventZoom(){return B(m(this.element))<1||!this.hasZoomableElements}layout(t,e){this.updateLayout(new X(t,e)),super.layoutContents(t,e)}updateLayout(t){if(this.lastLayoutDimensions=t,L(this.configurationService,this.titleBarStyle)){const e=B(m(this.element));if(this.element.style.setProperty("--zoom-factor",e.toString()),this.rootContainer.classList.toggle("counter-zoom",this.preventZoom),this.customMenubar){const i=new X(0,t.height);this.customMenubar.layout(i)}}}focus(){this.customMenubar?this.customMenubar.toggleFocus():this.element.querySelector('[tabindex]:not([tabindex="-1"])').focus()}toJSON(){return{type:oe.TITLEBAR_PART}}dispose(){this._onWillDispose.fire(),super.dispose()}};b=y([o(3,R),o(4,N),o(5,H),o(6,D),o(7,_),o(8,x),o(9,G),o(10,k),o(11,F),o(12,U),o(13,Y),o(14,K),o(15,Z)],b);let A=class extends b{constructor(a,t,e,i,n,r,S,g,f,I,T,E,M){super(oe.TITLEBAR_PART,st,"main",a,t,e,i,n,r,S,g,f,I,T,E,M)}};A=y([o(0,R),o(1,N),o(2,H),o(3,D),o(4,_),o(5,x),o(6,G),o(7,k),o(8,F),o(9,U),o(10,Y),o(11,K),o(12,Z)],A);let p=class extends b{constructor(t,e,i,n,r,S,g,f,I,T,E,M,O,P,z,$){const de=p.COUNTER++;super(`workbench.parts.auxiliaryTitle.${de}`,m(t),e,n,r,S,g,f,I,T,E,M,O,P,z,$);this.container=t;this.mainTitlebar=i}static COUNTER=1;get height(){return this.minimumHeight}get preventZoom(){return B(m(this.element))<1||!this.mainTitlebar.hasZoomableElements}};p=y([o(3,R),o(4,N),o(5,H),o(6,D),o(7,_),o(8,x),o(9,G),o(10,k),o(11,F),o(12,U),o(13,Y),o(14,K),o(15,Z)],p);export{p as AuxiliaryBrowserTitlebarPart,V as BrowserTitleService,b as BrowserTitlebarPart,A as MainBrowserTitlebarPart};
