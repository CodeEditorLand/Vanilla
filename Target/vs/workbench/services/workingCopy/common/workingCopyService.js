import{createDecorator as t}from"../../../../platform/instantiation/common/instantiation.js";import{InstantiationType as s,registerSingleton as a}from"../../../../platform/instantiation/common/extensions.js";import{Emitter as r}from"../../../../base/common/event.js";import{URI as d}from"../../../../base/common/uri.js";import{Disposable as g,toDisposable as p,DisposableStore as y,DisposableMap as C}from"../../../../base/common/lifecycle.js";import{ResourceMap as l}from"../../../../base/common/map.js";import"./workingCopy.js";const h=t("workingCopyService");class f extends g{_onDidRegister=this._register(new r);onDidRegister=this._onDidRegister.event;_onDidUnregister=this._register(new r);onDidUnregister=this._onDidUnregister.event;_onDidChangeDirty=this._register(new r);onDidChangeDirty=this._onDidChangeDirty.event;_onDidChangeContent=this._register(new r);onDidChangeContent=this._onDidChangeContent.event;_onDidSave=this._register(new r);onDidSave=this._onDidSave.event;get workingCopies(){return Array.from(this._workingCopies.values())}_workingCopies=new Set;mapResourceToWorkingCopies=new l;mapWorkingCopyToListeners=this._register(new C);registerWorkingCopy(e){let i=this.mapResourceToWorkingCopies.get(e.resource);if(i?.has(e.typeId))throw new Error(`Cannot register more than one working copy with the same resource ${e.resource.toString()} and type ${e.typeId}.`);this._workingCopies.add(e),i||(i=new Map,this.mapResourceToWorkingCopies.set(e.resource,i)),i.set(e.typeId,e);const o=new y;return o.add(e.onDidChangeContent(()=>this._onDidChangeContent.fire(e))),o.add(e.onDidChangeDirty(()=>this._onDidChangeDirty.fire(e))),o.add(e.onDidSave(n=>this._onDidSave.fire({workingCopy:e,...n}))),this.mapWorkingCopyToListeners.set(e,o),this._onDidRegister.fire(e),e.isDirty()&&this._onDidChangeDirty.fire(e),p(()=>{this.unregisterWorkingCopy(e),this._onDidUnregister.fire(e)})}unregisterWorkingCopy(e){this._workingCopies.delete(e);const i=this.mapResourceToWorkingCopies.get(e.resource);i?.delete(e.typeId)&&i.size===0&&this.mapResourceToWorkingCopies.delete(e.resource),e.isDirty()&&this._onDidChangeDirty.fire(e),this.mapWorkingCopyToListeners.deleteAndDispose(e)}has(e){return d.isUri(e)?this.mapResourceToWorkingCopies.has(e):this.mapResourceToWorkingCopies.get(e.resource)?.has(e.typeId)??!1}get(e){return this.mapResourceToWorkingCopies.get(e.resource)?.get(e.typeId)}getAll(e){const i=this.mapResourceToWorkingCopies.get(e);if(i)return Array.from(i.values())}get hasDirty(){for(const e of this._workingCopies)if(e.isDirty())return!0;return!1}get dirtyCount(){let e=0;for(const i of this._workingCopies)i.isDirty()&&e++;return e}get dirtyWorkingCopies(){return this.workingCopies.filter(e=>e.isDirty())}get modifiedCount(){let e=0;for(const i of this._workingCopies)i.isModified()&&e++;return e}get modifiedWorkingCopies(){return this.workingCopies.filter(e=>e.isModified())}isDirty(e,i){const o=this.mapResourceToWorkingCopies.get(e);if(o){if(typeof i=="string")return o.get(i)?.isDirty()??!1;for(const[,n]of o)if(n.isDirty())return!0}return!1}}a(h,f,s.Delayed);export{h as IWorkingCopyService,f as WorkingCopyService};
