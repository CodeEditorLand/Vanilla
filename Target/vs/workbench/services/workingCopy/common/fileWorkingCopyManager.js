var x=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var f=(v,l,e,i)=>{for(var o=i>1?void 0:i?N(l,e):l,r=v.length-1,n;r>=0;r--)(n=v[r])&&(o=(i?n(l,e,o):n(o))||o);return i&&o&&x(l,e,o),o},t=(v,l)=>(e,i)=>l(e,i,v);import{localize as s}from"../../../../nls.js";import{Emitter as b,Event as L}from"../../../../base/common/event.js";import{Promises as T}from"../../../../base/common/async.js";import"../../../../base/common/buffer.js";import{CancellationToken as g}from"../../../../base/common/cancellation.js";import{Disposable as h}from"../../../../base/common/lifecycle.js";import{toLocalResource as C,joinPath as k,isEqual as B,basename as y,dirname as V}from"../../../../base/common/resources.js";import{URI as q}from"../../../../base/common/uri.js";import{IFileDialogService as G,IDialogService as K}from"../../../../platform/dialogs/common/dialogs.js";import{IFileService as Y}from"../../../../platform/files/common/files.js";import{SaveSourceRegistry as u}from"../../../common/editor.js";import{IWorkbenchEnvironmentService as H}from"../../environment/common/environmentService.js";import{IPathService as j}from"../../path/common/pathService.js";import{IUriIdentityService as z}from"../../../../platform/uriIdentity/common/uriIdentity.js";import{StoredFileWorkingCopyState as F}from"./storedFileWorkingCopy.js";import{StoredFileWorkingCopyManager as J}from"./storedFileWorkingCopyManager.js";import{UntitledFileWorkingCopy as S}from"./untitledFileWorkingCopy.js";import{UntitledFileWorkingCopyManager as Q}from"./untitledFileWorkingCopyManager.js";import{IWorkingCopyFileService as X}from"./workingCopyFileService.js";import"./abstractFileWorkingCopyManager.js";import{SnapshotContext as Z}from"./fileWorkingCopy.js";import{ILabelService as $}from"../../../../platform/label/common/label.js";import{ILogService as ee}from"../../../../platform/log/common/log.js";import{INotificationService as ie}from"../../../../platform/notification/common/notification.js";import{IEditorService as oe}from"../../editor/common/editorService.js";import{IElevatedFileService as re}from"../../files/common/elevatedFileService.js";import{IFilesConfigurationService as te}from"../../filesConfiguration/common/filesConfigurationService.js";import{ILifecycleService as ne}from"../../lifecycle/common/lifecycle.js";import{IWorkingCopyBackupService as se}from"./workingCopyBackup.js";import{IWorkingCopyEditorService as ae}from"./workingCopyEditorService.js";import{IWorkingCopyService as le}from"./workingCopyService.js";import{Schemas as de}from"../../../../base/common/network.js";import{IDecorationsService as pe}from"../../decorations/common/decorations.js";import{Codicon as W}from"../../../../base/common/codicons.js";import{listErrorForeground as U}from"../../../../platform/theme/common/colorRegistry.js";import{IProgressService as ce}from"../../../../platform/progress/common/progress.js";let d=class extends h{constructor(e,i,o,r,n,a,p,I,c,R,ye,w,m,P,O,D,E,ve,ge,Se,Ie,_){super();this.workingCopyTypeId=e;this.storedWorkingCopyModelFactory=i;this.untitledWorkingCopyModelFactory=o;this.fileService=r;this.logService=p;this.workingCopyFileService=I;this.uriIdentityService=R;this.fileDialogService=ye;this.filesConfigurationService=w;this.pathService=ve;this.environmentService=ge;this.dialogService=Se;this.decorationsService=Ie;this.stored=this._register(new J(this.workingCopyTypeId,this.storedWorkingCopyModelFactory,r,n,a,p,I,c,R,w,m,P,O,D,E,_)),this.untitled=this._register(new Q(this.workingCopyTypeId,this.untitledWorkingCopyModelFactory,async(A,M)=>!!await this.saveAs(A.resource,void 0,M),r,a,p,c,m)),this.onDidCreate=L.any(this.stored.onDidCreate,this.untitled.onDidCreate),this.provideDecorations()}onDidCreate;static FILE_WORKING_COPY_SAVE_CREATE_SOURCE=u.registerSource("fileWorkingCopyCreate.source",s("fileWorkingCopyCreate.source","File Created"));static FILE_WORKING_COPY_SAVE_REPLACE_SOURCE=u.registerSource("fileWorkingCopyReplace.source",s("fileWorkingCopyReplace.source","File Replaced"));stored;untitled;provideDecorations(){const e=this._register(new class extends h{constructor(o){super();this.stored=o;this.registerListeners()}label=s("fileWorkingCopyDecorations","File Working Copy Decorations");_onDidChange=this._register(new b);onDidChange=this._onDidChange.event;registerListeners(){this._register(this.stored.onDidResolve(o=>{(o.isReadonly()||o.hasState(F.ORPHAN))&&this._onDidChange.fire([o.resource])})),this._register(this.stored.onDidRemove(o=>this._onDidChange.fire([o]))),this._register(this.stored.onDidChangeReadonly(o=>this._onDidChange.fire([o.resource]))),this._register(this.stored.onDidChangeOrphaned(o=>this._onDidChange.fire([o.resource])))}provideDecorations(o){const r=this.stored.get(o);if(!r||r.isDisposed())return;const n=r.isReadonly(),a=r.hasState(F.ORPHAN);if(n&&a)return{color:U,letter:W.lockSmall,strikethrough:!0,tooltip:s("readonlyAndDeleted","Deleted, Read-only")};if(n)return{letter:W.lockSmall,tooltip:s("readonly","Read-only")};if(a)return{color:U,strikethrough:!0,tooltip:s("deleted","Deleted")}}}(this.stored));this._register(this.decorationsService.registerDecorationsProvider(e))}get workingCopies(){return[...this.stored.workingCopies,...this.untitled.workingCopies]}get(e){return this.stored.get(e)??this.untitled.get(e)}resolve(e,i){return q.isUri(e)?e.scheme===de.untitled?this.untitled.resolve({untitledResource:e}):this.stored.resolve(e,i):this.untitled.resolve(e)}async saveAs(e,i,o){if(!i){const r=this.get(e);r instanceof S&&r.hasAssociatedFilePath?i=await this.suggestSavePath(e):i=await this.fileDialogService.pickFileToSave(await this.suggestSavePath(o?.suggestedTarget??e),o?.availableFileSystems)}if(i){if(this.filesConfigurationService.isReadonly(i))if(await this.confirmMakeWriteable(i))this.filesConfigurationService.updateReadonly(i,!1);else return;return this.fileService.hasProvider(e)&&B(e,i)?this.doSave(e,{...o,force:!0}):this.fileService.hasProvider(e)&&this.uriIdentityService.extUri.isEqual(e,i)&&await this.fileService.exists(e)?(await this.workingCopyFileService.move([{file:{source:e,target:i}}],g.None),await this.doSave(e,o)??await this.doSave(i,o)):this.doSaveAs(e,i,o)}}async doSave(e,i){const o=this.stored.get(e);if(o&&await o.save(i))return o}async doSaveAs(e,i,o){let r;const n=this.get(e);n?.isResolved()?r=await n.model.snapshot(Z.Save,g.None):r=(await this.fileService.readFileStream(e)).value;const{targetFileExists:a,targetStoredFileWorkingCopy:p}=await this.doResolveSaveTarget(e,i);if(!(n instanceof S&&n.hasAssociatedFilePath&&a&&this.uriIdentityService.extUri.isEqual(i,C(n.resource,this.environmentService.remoteAuthority,this.pathService.defaultUriScheme))&&!await this.confirmOverwrite(i)||(await p.model?.update(r,g.None),o?.source||(o={...o,source:a?d.FILE_WORKING_COPY_SAVE_REPLACE_SOURCE:d.FILE_WORKING_COPY_SAVE_CREATE_SOURCE}),!await p.save({...o,from:e,force:!0})))){try{await n?.revert()}catch(c){this.logService.error(c)}return p}}async doResolveSaveTarget(e,i){let o=!1,r=this.stored.get(i);return r?.isResolved()?o=!0:(o=await this.fileService.exists(i),o||await this.workingCopyFileService.create([{resource:i}],g.None),this.uriIdentityService.extUri.isEqual(e,i)&&this.get(e)?r=await this.stored.resolve(e):r=await this.stored.resolve(i)),{targetFileExists:o,targetStoredFileWorkingCopy:r}}async confirmOverwrite(e){const{confirmed:i}=await this.dialogService.confirm({type:"warning",message:s("confirmOverwrite","'{0}' already exists. Do you want to replace it?",y(e)),detail:s("overwriteIrreversible","A file or folder with the name '{0}' already exists in the folder '{1}'. Replacing it will overwrite its current contents.",y(e),y(V(e))),primaryButton:s({key:"replaceButtonLabel",comment:["&& denotes a mnemonic"]},"&&Replace")});return i}async confirmMakeWriteable(e){const{confirmed:i}=await this.dialogService.confirm({type:"warning",message:s("confirmMakeWriteable","'{0}' is marked as read-only. Do you want to save anyway?",y(e)),detail:s("confirmMakeWriteableDetail","Paths can be configured as read-only via settings."),primaryButton:s({key:"makeWriteableButtonLabel",comment:["&& denotes a mnemonic"]},"&&Save Anyway")});return i}async suggestSavePath(e){if(this.fileService.hasProvider(e))return e;const i=this.get(e);if(i instanceof S&&i.hasAssociatedFilePath)return C(e,this.environmentService.remoteAuthority,this.pathService.defaultUriScheme);const o=await this.fileDialogService.defaultFilePath();if(i){const r=k(o,i.name);if(await this.pathService.hasValidBasename(r,i.name))return r}return k(o,y(e))}async destroy(){await T.settled([this.stored.destroy(),this.untitled.destroy()])}};d=f([t(3,Y),t(4,ne),t(5,$),t(6,ee),t(7,X),t(8,se),t(9,z),t(10,G),t(11,te),t(12,le),t(13,ie),t(14,ae),t(15,oe),t(16,re),t(17,j),t(18,H),t(19,K),t(20,pe),t(21,ce)],d);export{d as FileWorkingCopyManager};
