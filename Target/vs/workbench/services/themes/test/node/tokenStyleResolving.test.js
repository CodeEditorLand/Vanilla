import{ColorThemeData as d}from"../../common/colorThemeData.js";import f from"assert";import"../../common/workbenchThemeService.js";import{TokenStyle as F,getTokenClassificationRegistry as k}from"../../../../../platform/theme/common/tokenClassificationRegistry.js";import{Color as b}from"../../../../../base/common/color.js";import{isString as h}from"../../../../../base/common/types.js";import{FileService as E}from"../../../../../platform/files/common/fileService.js";import{NullLogService as v}from"../../../../../platform/log/common/log.js";import{DiskFileSystemProvider as I}from"../../../../../platform/files/node/diskFileSystemProvider.js";import{FileAccess as w,Schemas as D}from"../../../../../base/common/network.js";import{ExtensionResourceLoaderService as q}from"../../../../../platform/extensionResourceLoader/common/extensionResourceLoaderService.js";import"../../../../../platform/theme/common/themeService.js";import{mock as p,TestProductService as j}from"../../../../test/common/workbenchTestServices.js";import"../../../../../platform/request/common/request.js";import"../../../../../platform/storage/common/storage.js";import"../../../../../platform/environment/common/environment.js";import"../../../../../platform/configuration/common/configuration.js";import{ensureNoDisposablesAreLeakedInTestSuite as L}from"../../../../../base/test/common/utils.js";const y={bold:void 0,underline:void 0,italic:void 0},g={bold:!1,underline:!1,italic:!1};function t(n,r){const s=h(n)?b.fromHex(n):void 0;return new F(s,r?.bold,r?.underline,r?.strikethrough,r?.italic)}function C(n){if(!n)return"tokenstyle-undefined";let r=n.foreground?n.foreground.toString():"no-foreground";return n.bold!==void 0&&(r+=n.bold?"+B":"-B"),n.underline!==void 0&&(r+=n.underline?"+U":"-U"),n.italic!==void 0&&(r+=n.italic?"+I":"-I"),r}function a(n,r,s){f.strictEqual(C(n),C(r),s)}function R(n,r,s,c=""){if(s==null||r===void 0){f.strictEqual(r,s,c);return}f.strictEqual(r.bold,s.bold,"bold "+c),f.strictEqual(r.italic,s.italic,"italic "+c),f.strictEqual(r.underline,s.underline,"underline "+c);const u=r.foreground;u&&s.foreground?f.strictEqual(n[u],b.Format.CSS.formatHexA(s.foreground,!0).toUpperCase(),"foreground "+c):f.strictEqual(u,s.foreground||0,"foreground "+c)}function l(n,r,s="typescript"){const c=n.tokenColorMap;for(const u in r){const[S,...m]=u.split("."),e=r[u],i=n.getTokenStyleMetadata(S,m,s);R(c,i,e,u)}}suite("Themes - TokenStyleResolving",()=>{const n=new E(new v),r=new(p()),s=new(p()),c=new(p()),u=new(p()),S=new q(n,s,j,c,u,r),m=new I(new v);n.registerProvider(D.file,m),teardown(()=>{m.dispose()}),L(),test("color defaults",async()=>{const e=d.createUnloadedTheme("foo");e.location=w.asFileUri("vs/workbench/services/themes/test/node/color-theme.json"),await e.ensureLoaded(S),f.strictEqual(e.isLoaded,!0),l(e,{comment:t("#000000",y),variable:t("#111111",g),type:t("#333333",{bold:!1,underline:!0,italic:!1}),function:t("#333333",g),string:t("#444444",y),number:t("#555555",y),keyword:t("#666666",y)})}),test("resolveScopes",async()=>{const e=d.createLoadedEmptyTheme("test","test"),i={textMateRules:[{scope:"variable",settings:{fontStyle:"",foreground:"#F8F8F2"}},{scope:"keyword.operator",settings:{fontStyle:"italic bold underline",foreground:"#F92672"}},{scope:"storage",settings:{fontStyle:"italic",foreground:"#F92672"}},{scope:["storage.type","meta.structure.dictionary.json string.quoted.double.json"],settings:{foreground:"#66D9EF"}},{scope:"entity.name.type, entity.name.class, entity.name.namespace, entity.name.scope-resolution",settings:{fontStyle:"underline",foreground:"#A6E22E"}}]};e.setCustomTokenColors(i);let o;const T=void 0;o=e.resolveScopes([["variable"]]),a(o,t("#F8F8F2",g),"variable"),o=e.resolveScopes([["keyword.operator"]]),a(o,t("#F92672",{italic:!0,bold:!0,underline:!0}),"keyword"),o=e.resolveScopes([["keyword"]]),a(o,T,"keyword"),o=e.resolveScopes([["keyword.operator"]]),a(o,t("#F92672",{italic:!0,bold:!0,underline:!0}),"keyword.operator"),o=e.resolveScopes([["keyword.operators"]]),a(o,T,"keyword.operators"),o=e.resolveScopes([["storage"]]),a(o,t("#F92672",{italic:!0,bold:!1,underline:!1}),"storage"),o=e.resolveScopes([["storage.type"]]),a(o,t("#66D9EF",{italic:!0,bold:!1,underline:!1}),"storage.type"),o=e.resolveScopes([["entity.name.class"]]),a(o,t("#A6E22E",{italic:!1,bold:!1,underline:!0}),"entity.name.class"),o=e.resolveScopes([["meta.structure.dictionary.json","string.quoted.double.json"]]),a(o,t("#66D9EF",void 0),"json property"),o=e.resolveScopes([["keyword"],["storage.type"],["entity.name.class"]]),a(o,t("#66D9EF",{italic:!0,bold:!1,underline:!1}),"storage.type")}),test("resolveScopes - match most specific",async()=>{const e=d.createLoadedEmptyTheme("test","test"),i={textMateRules:[{scope:"entity.name.type",settings:{fontStyle:"underline",foreground:"#A6E22E"}},{scope:"entity.name.type.class",settings:{foreground:"#FF00FF"}},{scope:"entity.name",settings:{foreground:"#FFFFFF"}}]};e.setCustomTokenColors(i);const o=e.resolveScopes([["entity.name.type.class"]]);a(o,t("#FF00FF",{italic:!1,bold:!1,underline:!0}),"entity.name.type.class")}),test("rule matching",async()=>{const e=d.createLoadedEmptyTheme("test","test");e.setCustomColors({"editor.foreground":"#000000"}),e.setCustomSemanticTokenColors({enabled:!0,rules:{type:"#ff0000",class:{foreground:"#0000ff",italic:!0},"*.static":{bold:!0},"*.declaration":{italic:!0},"*.async.static":{italic:!0,underline:!0},"*.async":{foreground:"#000fff",underline:!0}}}),l(e,{type:t("#ff0000",y),"type.static":t("#ff0000",{bold:!0}),"type.static.declaration":t("#ff0000",{bold:!0,italic:!0}),class:t("#0000ff",{italic:!0}),"class.static.declaration":t("#0000ff",{bold:!0,italic:!0}),"class.declaration":t("#0000ff",{italic:!0}),"class.declaration.async":t("#000fff",{underline:!0,italic:!0}),"class.declaration.async.static":t("#000fff",{italic:!0,underline:!0,bold:!0})})}),test("super type",async()=>{const e=k();e.registerTokenType("myTestInterface","A type just for testing","interface"),e.registerTokenType("myTestSubInterface","A type just for testing","myTestInterface");try{const i=d.createLoadedEmptyTheme("test","test");i.setCustomColors({"editor.foreground":"#000000"}),i.setCustomSemanticTokenColors({enabled:!0,rules:{interface:"#ff0000",myTestInterface:{italic:!0},"interface.static":{bold:!0}}}),l(i,{myTestSubInterface:t("#ff0000",{italic:!0})}),l(i,{"myTestSubInterface.static":t("#ff0000",{italic:!0,bold:!0})}),i.setCustomSemanticTokenColors({enabled:!0,rules:{interface:"#ff0000",myTestInterface:{foreground:"#ff00ff",italic:!0}}}),l(i,{myTestSubInterface:t("#ff00ff",{italic:!0})})}finally{e.deregisterTokenType("myTestInterface"),e.deregisterTokenType("myTestSubInterface")}}),test("language",async()=>{try{const e=d.createLoadedEmptyTheme("test","test");e.setCustomColors({"editor.foreground":"#000000"}),e.setCustomSemanticTokenColors({enabled:!0,rules:{interface:"#fff000","interface:java":"#ff0000","interface.static":{bold:!0},"interface.static:typescript":{italic:!0}}}),l(e,{interface:t("#ff0000",void 0)},"java"),l(e,{interface:t("#fff000",void 0)},"typescript"),l(e,{"interface.static":t("#ff0000",{bold:!0})},"java"),l(e,{"interface.static":t("#fff000",{bold:!0,italic:!0})},"typescript")}finally{}}),test("language - scope resolving",async()=>{const e=k(),i=e.getTokenStylingDefaultRules().length;e.registerTokenStyleDefault(e.parseTokenSelector("type","typescript1"),{scopesToProbe:[["entity.name.type.ts1"]]}),e.registerTokenStyleDefault(e.parseTokenSelector("type:javascript1"),{scopesToProbe:[["entity.name.type.js1"]]});try{const o=d.createLoadedEmptyTheme("test","test");o.setCustomColors({"editor.foreground":"#000000"}),o.setCustomTokenColors({textMateRules:[{scope:"entity.name.type",settings:{foreground:"#aa0000"}},{scope:"entity.name.type.ts1",settings:{foreground:"#bb0000"}}]}),l(o,{type:t("#aa0000",void 0)},"javascript1"),l(o,{type:t("#bb0000",void 0)},"typescript1")}finally{e.deregisterTokenStyleDefault(e.parseTokenSelector("type","typescript1")),e.deregisterTokenStyleDefault(e.parseTokenSelector("type:javascript1")),f.strictEqual(e.getTokenStylingDefaultRules().length,i)}})});
