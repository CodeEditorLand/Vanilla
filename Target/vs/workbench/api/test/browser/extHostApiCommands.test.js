import"../../../../editor/contrib/codeAction/browser/codeAction.js";import"../../../../editor/contrib/codelens/browser/codelens.js";import"../../../../editor/contrib/colorPicker/browser/colorPickerContribution.js";import"../../../../editor/contrib/format/browser/format.js";import"../../../../editor/contrib/gotoSymbol/browser/goToCommands.js";import"../../../../editor/contrib/documentSymbols/browser/documentSymbols.js";import"../../../../editor/contrib/hover/browser/getHover.js";import"../../../../editor/contrib/links/browser/getLinks.js";import"../../../../editor/contrib/parameterHints/browser/provideSignatureHelp.js";import"../../../../editor/contrib/smartSelect/browser/smartSelect.js";import"../../../../editor/contrib/suggest/browser/suggest.js";import"../../../../editor/contrib/rename/browser/rename.js";import"../../../../editor/contrib/inlayHints/browser/inlayHintsController.js";import n from"assert";import{setUnexpectedErrorHandler as H,errorHandler as M}from"../../../../base/common/errors.js";import{URI as p}from"../../../../base/common/uri.js";import{Event as K}from"../../../../base/common/event.js";import*as e from"../../common/extHostTypes.js";import{createTextModel as F}from"../../../../editor/test/common/testTextModel.js";import{TestRPCProtocol as U}from"../common/testRPCProtocol.js";import{MarkerService as W}from"../../../../platform/markers/common/markerService.js";import{IMarkerService as _}from"../../../../platform/markers/common/markers.js";import{ICommandService as N,CommandsRegistry as B}from"../../../../platform/commands/common/commands.js";import{IModelService as G}from"../../../../editor/common/services/model.js";import{ExtHostLanguageFeatures as $}from"../../common/extHostLanguageFeatures.js";import{MainThreadLanguageFeatures as j}from"../../browser/mainThreadLanguageFeatures.js";import{ExtHostApiCommands as V}from"../../common/extHostApiCommands.js";import{ExtHostCommands as Q}from"../../common/extHostCommands.js";import{MainThreadCommands as z}from"../../browser/mainThreadCommands.js";import{ExtHostDocuments as J}from"../../common/extHostDocuments.js";import{ExtHostDocumentsAndEditors as X}from"../../common/extHostDocumentsAndEditors.js";import{MainContext as T,ExtHostContext as R}from"../../common/extHost.protocol.js";import{ExtHostDiagnostics as Y}from"../../common/extHostDiagnostics.js";import"../../../contrib/search/browser/search.contribution.js";import{ILogService as Z,NullLogService as x}from"../../../../platform/log/common/log.js";import"../../../../editor/common/model.js";import{nullExtensionDescription as m,IExtensionService as ee}from"../../../services/extensions/common/extensions.js";import{dispose as te,ImmortalReference as ne}from"../../../../base/common/lifecycle.js";import{IEditorWorkerService as oe}from"../../../../editor/common/services/editorWorker.js";import{mock as w}from"../../../../base/test/common/mock.js";import{NullApiDeprecationService as re}from"../../common/extHostApiDeprecationService.js";import{ServiceCollection as ie}from"../../../../platform/instantiation/common/serviceCollection.js";import{SyncDescriptor as P}from"../../../../platform/instantiation/common/descriptors.js";import{ITextModelService as ae}from"../../../../editor/common/services/resolverService.js";import"../../common/extHostFileSystemInfo.js";import{URITransformerService as se}from"../../common/extHostUriTransformerService.js";import{IOutlineModelService as k,OutlineModelService as ce}from"../../../../editor/contrib/documentSymbols/browser/outlineModel.js";import{ILanguageFeatureDebounceService as A,LanguageFeatureDebounceService as O}from"../../../../editor/common/services/languageFeatureDebounce.js";import{ILanguageFeaturesService as de}from"../../../../editor/common/services/languageFeatures.js";import{LanguageFeaturesService as le}from"../../../../editor/common/services/languageFeaturesService.js";import{assertType as ue}from"../../../../base/common/types.js";import{IUriIdentityService as me}from"../../../../platform/uriIdentity/common/uriIdentity.js";import"../../common/extHostTelemetry.js";import{IConfigurationService as ve}from"../../../../platform/configuration/common/configuration.js";import{TestConfigurationService as ge}from"../../../../platform/configuration/test/common/testConfigurationService.js";import{IEnvironmentService as pe}from"../../../../platform/environment/common/environment.js";import{TestInstantiationService as ye}from"../../../../platform/instantiation/test/common/instantiationServiceMock.js";import{ensureNoDisposablesAreLeakedInTestSuite as fe}from"../../../../base/test/common/utils.js";import{runWithFakedTimers as he}from"../../../../base/test/common/timeTravelScheduler.js";import{timeout as we}from"../../../../base/common/async.js";function f(u,a="Expected rejection"){return u().then(()=>n.ok(!1,a),C=>n.ok(!0))}function q(u){const a=u;return a&&a.uri instanceof p&&a.range instanceof e.Range}suite("ExtHostLanguageFeatureCommands",function(){const u={scheme:"far"};let a,C,d,c,b,i,l=[],L;suiteSetup(()=>{a=F(["This is the first line","This is the second line","This is the third line"].join(`
`),void 0,void 0,p.parse("far://testing/file.b")),L=M.getUnexpectedErrorHandler(),H(()=>{}),d=new U;const t=new ie;t.set(me,new class extends w(){asCanonicalUri(v){return v}}),t.set(de,new P(le)),t.set(ee,new class extends w(){async activateByEvent(){}activationEventIsDone(v){return!0}}),t.set(N,new P(class extends w(){executeCommand(v,...g){const h=B.getCommands().get(v);if(!h)return Promise.reject(new Error(v+" NOT known"));const{handler:E}=h;return Promise.resolve(C.invokeFunction(E,...g))}})),t.set(pe,new class extends w(){isBuilt=!0;isExtensionDevelopment=!1}),t.set(_,new W),t.set(Z,new P(x)),t.set(A,new P(O)),t.set(G,new class extends w(){getModel(){return a}onModelRemoved=K.None}),t.set(ae,new class extends w(){async createModelReference(){return new ne(new class extends w(){textEditorModel=a})}}),t.set(oe,new class extends w(){async computeMoreMinimalEdits(v,g){return g||void 0}}),t.set(A,new P(O)),t.set(k,new P(ce)),t.set(ve,new ge),C=new ye(t);const o=new X(d,new x);o.$acceptDocumentsAndEditorsDelta({addedDocuments:[{isDirty:!1,versionId:a.getVersionId(),languageId:a.getLanguageId(),uri:a.uri,lines:a.getValue().split(a.getEOL()),EOL:a.getEOL()}]});const r=new J(d,o);d.set(R.ExtHostDocuments,r),i=new Q(d,new x,new class extends w(){onExtensionError(){return!0}}),d.set(R.ExtHostCommands,i),d.set(T.MainThreadCommands,C.createInstance(z,d)),V.register(i);const s=new Y(d,new x,new class extends w(){},o);return d.set(R.ExtHostDiagnostics,s),c=new $(d,new se(null),r,i,s,new x,re,new class extends w(){onExtensionError(){return!0}}),d.set(R.ExtHostLanguageFeatures,c),b=d.set(T.MainThreadLanguageFeatures,C.createInstance(j,d)),C.get(k),d.sync()}),suiteTeardown(()=>{H(L),a.dispose(),b.dispose(),C.get(k).dispose(),C.dispose()}),teardown(()=>(l=te(l),d.sync())),fe();function y(t,o){test(t,async function(){await he({},async()=>{await o(),await we(1e4)})})}test("WorkspaceSymbols, invalid arguments",function(){const t=[f(()=>i.executeCommand("vscode.executeWorkspaceSymbolProvider")),f(()=>i.executeCommand("vscode.executeWorkspaceSymbolProvider",null)),f(()=>i.executeCommand("vscode.executeWorkspaceSymbolProvider",void 0)),f(()=>i.executeCommand("vscode.executeWorkspaceSymbolProvider",!0))];return Promise.all(t)}),test("WorkspaceSymbols, back and forth",function(){return l.push(c.registerWorkspaceSymbolProvider(m,{provideWorkspaceSymbols(t){return[new e.SymbolInformation(t,e.SymbolKind.Array,new e.Range(0,0,1,1),p.parse("far://testing/first")),new e.SymbolInformation(t,e.SymbolKind.Array,new e.Range(0,0,1,1),p.parse("far://testing/second"))]}})),l.push(c.registerWorkspaceSymbolProvider(m,{provideWorkspaceSymbols(t){return[new e.SymbolInformation(t,e.SymbolKind.Array,new e.Range(0,0,1,1),p.parse("far://testing/first"))]}})),d.sync().then(()=>i.executeCommand("vscode.executeWorkspaceSymbolProvider","testing").then(t=>{n.strictEqual(t.length,2);for(const o of t)n.strictEqual(o instanceof e.SymbolInformation,!0),n.strictEqual(o.name,"testing"),n.strictEqual(o.kind,e.SymbolKind.Array)}))}),test("executeWorkspaceSymbolProvider should accept empty string, #39522",async function(){l.push(c.registerWorkspaceSymbolProvider(m,{provideWorkspaceSymbols(){return[new e.SymbolInformation("hello",e.SymbolKind.Array,new e.Range(0,0,0,0),p.parse("foo:bar"))]}})),await d.sync();let t=await i.executeCommand("vscode.executeWorkspaceSymbolProvider","");n.strictEqual(t.length,1),await d.sync(),t=await i.executeCommand("vscode.executeWorkspaceSymbolProvider","*"),n.strictEqual(t.length,1)}),test("executeFormatDocumentProvider, back and forth",async function(){l.push(c.registerDocumentFormattingEditProvider(m,u,new class{provideDocumentFormattingEdits(){return[e.TextEdit.insert(new e.Position(0,0),"42")]}})),await d.sync();const t=await i.executeCommand("vscode.executeFormatDocumentProvider",a.uri);n.strictEqual(t.length,1)}),test("vscode.prepareRename",async function(){l.push(c.registerRenameProvider(m,u,new class{prepareRename(o,r){return{range:new e.Range(0,12,0,24),placeholder:"foooPlaceholder"}}provideRenameEdits(o,r,s){const v=new e.WorkspaceEdit;return v.insert(o.uri,r,s),v}})),await d.sync();const t=await i.executeCommand("vscode.prepareRename",a.uri,new e.Position(0,12));n.ok(t),n.strictEqual(t.placeholder,"foooPlaceholder"),n.strictEqual(t.range.start.line,0),n.strictEqual(t.range.start.character,12),n.strictEqual(t.range.end.line,0),n.strictEqual(t.range.end.character,24)}),test("vscode.executeDocumentRenameProvider",async function(){l.push(c.registerRenameProvider(m,u,new class{provideRenameEdits(r,s,v){const g=new e.WorkspaceEdit;return g.insert(r.uri,s,v),g}})),await d.sync();const t=await i.executeCommand("vscode.executeDocumentRenameProvider",a.uri,new e.Position(0,12),"newNameOfThis");n.ok(t),n.strictEqual(t.has(a.uri),!0);const o=t.get(a.uri);n.strictEqual(o.length,1),n.strictEqual(o[0].newText,"newNameOfThis")}),test("Definition, invalid arguments",function(){const t=[f(()=>i.executeCommand("vscode.executeDefinitionProvider")),f(()=>i.executeCommand("vscode.executeDefinitionProvider",null)),f(()=>i.executeCommand("vscode.executeDefinitionProvider",void 0)),f(()=>i.executeCommand("vscode.executeDefinitionProvider",!0,!1))];return Promise.all(t)}),test("Definition, back and forth",function(){return l.push(c.registerDefinitionProvider(m,u,{provideDefinition(t){return new e.Location(t.uri,new e.Range(1,0,0,0))}})),l.push(c.registerDefinitionProvider(m,u,{provideDefinition(t){return new e.Location(t.uri,new e.Range(1,0,0,0))}})),l.push(c.registerDefinitionProvider(m,u,{provideDefinition(t){return[new e.Location(t.uri,new e.Range(2,0,0,0)),new e.Location(t.uri,new e.Range(3,0,0,0)),new e.Location(t.uri,new e.Range(4,0,0,0))]}})),d.sync().then(()=>i.executeCommand("vscode.executeDefinitionProvider",a.uri,new e.Position(0,0)).then(t=>{n.strictEqual(t.length,4);for(const o of t)n.ok(o.uri instanceof p),n.ok(o.range instanceof e.Range)}))}),test("Definition, back and forth (sorting & de-deduping)",function(){return l.push(c.registerDefinitionProvider(m,u,{provideDefinition(t){return new e.Location(p.parse("file:///b"),new e.Range(1,0,0,0))}})),l.push(c.registerDefinitionProvider(m,u,{provideDefinition(t){return new e.Location(p.parse("file:///b"),new e.Range(1,0,0,0))}})),l.push(c.registerDefinitionProvider(m,u,{provideDefinition(t){return[new e.Location(p.parse("file:///a"),new e.Range(2,0,0,0)),new e.Location(p.parse("file:///c"),new e.Range(3,0,0,0)),new e.Location(p.parse("file:///d"),new e.Range(4,0,0,0))]}})),d.sync().then(()=>i.executeCommand("vscode.executeDefinitionProvider",a.uri,new e.Position(0,0)).then(t=>{n.strictEqual(t.length,4),n.strictEqual(t[0].uri.path,"/a"),n.strictEqual(t[1].uri.path,"/b"),n.strictEqual(t[2].uri.path,"/c"),n.strictEqual(t[3].uri.path,"/d")}))}),test("Definition Link",()=>(l.push(c.registerDefinitionProvider(m,u,{provideDefinition(t){return[new e.Location(t.uri,new e.Range(0,0,0,0)),{targetUri:t.uri,targetRange:new e.Range(1,0,0,0),targetSelectionRange:new e.Range(1,1,1,1),originSelectionRange:new e.Range(2,2,2,2)}]}})),d.sync().then(()=>i.executeCommand("vscode.executeDefinitionProvider",a.uri,new e.Position(0,0)).then(t=>{n.strictEqual(t.length,2);for(const o of t)q(o)?(n.ok(o.uri instanceof p),n.ok(o.range instanceof e.Range)):(n.ok(o.targetUri instanceof p),n.ok(o.targetRange instanceof e.Range),n.ok(o.targetSelectionRange instanceof e.Range),n.ok(o.originSelectionRange instanceof e.Range))})))),test("Declaration, back and forth",function(){return l.push(c.registerDeclarationProvider(m,u,{provideDeclaration(t){return new e.Location(t.uri,new e.Range(1,0,0,0))}})),l.push(c.registerDeclarationProvider(m,u,{provideDeclaration(t){return new e.Location(t.uri,new e.Range(1,0,0,0))}})),l.push(c.registerDeclarationProvider(m,u,{provideDeclaration(t){return[new e.Location(t.uri,new e.Range(2,0,0,0)),new e.Location(t.uri,new e.Range(3,0,0,0)),new e.Location(t.uri,new e.Range(4,0,0,0))]}})),d.sync().then(()=>i.executeCommand("vscode.executeDeclarationProvider",a.uri,new e.Position(0,0)).then(t=>{n.strictEqual(t.length,4);for(const o of t)n.ok(o.uri instanceof p),n.ok(o.range instanceof e.Range)}))}),test("Declaration Link",()=>(l.push(c.registerDeclarationProvider(m,u,{provideDeclaration(t){return[new e.Location(t.uri,new e.Range(0,0,0,0)),{targetUri:t.uri,targetRange:new e.Range(1,0,0,0),targetSelectionRange:new e.Range(1,1,1,1),originSelectionRange:new e.Range(2,2,2,2)}]}})),d.sync().then(()=>i.executeCommand("vscode.executeDeclarationProvider",a.uri,new e.Position(0,0)).then(t=>{n.strictEqual(t.length,2);for(const o of t)q(o)?(n.ok(o.uri instanceof p),n.ok(o.range instanceof e.Range)):(n.ok(o.targetUri instanceof p),n.ok(o.targetRange instanceof e.Range),n.ok(o.targetSelectionRange instanceof e.Range),n.ok(o.originSelectionRange instanceof e.Range))})))),test("Type Definition, invalid arguments",function(){const t=[f(()=>i.executeCommand("vscode.executeTypeDefinitionProvider")),f(()=>i.executeCommand("vscode.executeTypeDefinitionProvider",null)),f(()=>i.executeCommand("vscode.executeTypeDefinitionProvider",void 0)),f(()=>i.executeCommand("vscode.executeTypeDefinitionProvider",!0,!1))];return Promise.all(t)}),test("Type Definition, back and forth",function(){return l.push(c.registerTypeDefinitionProvider(m,u,{provideTypeDefinition(t){return new e.Location(t.uri,new e.Range(1,0,0,0))}})),l.push(c.registerTypeDefinitionProvider(m,u,{provideTypeDefinition(t){return new e.Location(t.uri,new e.Range(1,0,0,0))}})),l.push(c.registerTypeDefinitionProvider(m,u,{provideTypeDefinition(t){return[new e.Location(t.uri,new e.Range(2,0,0,0)),new e.Location(t.uri,new e.Range(3,0,0,0)),new e.Location(t.uri,new e.Range(4,0,0,0))]}})),d.sync().then(()=>i.executeCommand("vscode.executeTypeDefinitionProvider",a.uri,new e.Position(0,0)).then(t=>{n.strictEqual(t.length,4);for(const o of t)n.ok(o.uri instanceof p),n.ok(o.range instanceof e.Range)}))}),test("Type Definition Link",()=>(l.push(c.registerTypeDefinitionProvider(m,u,{provideTypeDefinition(t){return[new e.Location(t.uri,new e.Range(0,0,0,0)),{targetUri:t.uri,targetRange:new e.Range(1,0,0,0),targetSelectionRange:new e.Range(1,1,1,1),originSelectionRange:new e.Range(2,2,2,2)}]}})),d.sync().then(()=>i.executeCommand("vscode.executeTypeDefinitionProvider",a.uri,new e.Position(0,0)).then(t=>{n.strictEqual(t.length,2);for(const o of t)q(o)?(n.ok(o.uri instanceof p),n.ok(o.range instanceof e.Range)):(n.ok(o.targetUri instanceof p),n.ok(o.targetRange instanceof e.Range),n.ok(o.targetSelectionRange instanceof e.Range),n.ok(o.originSelectionRange instanceof e.Range))})))),test("Implementation, invalid arguments",function(){const t=[f(()=>i.executeCommand("vscode.executeImplementationProvider")),f(()=>i.executeCommand("vscode.executeImplementationProvider",null)),f(()=>i.executeCommand("vscode.executeImplementationProvider",void 0)),f(()=>i.executeCommand("vscode.executeImplementationProvider",!0,!1))];return Promise.all(t)}),test("Implementation, back and forth",function(){return l.push(c.registerImplementationProvider(m,u,{provideImplementation(t){return new e.Location(t.uri,new e.Range(1,0,0,0))}})),l.push(c.registerImplementationProvider(m,u,{provideImplementation(t){return new e.Location(t.uri,new e.Range(1,0,0,0))}})),l.push(c.registerImplementationProvider(m,u,{provideImplementation(t){return[new e.Location(t.uri,new e.Range(2,0,0,0)),new e.Location(t.uri,new e.Range(3,0,0,0)),new e.Location(t.uri,new e.Range(4,0,0,0))]}})),d.sync().then(()=>i.executeCommand("vscode.executeImplementationProvider",a.uri,new e.Position(0,0)).then(t=>{n.strictEqual(t.length,4);for(const o of t)n.ok(o.uri instanceof p),n.ok(o.range instanceof e.Range)}))}),test("Implementation Definition Link",()=>(l.push(c.registerImplementationProvider(m,u,{provideImplementation(t){return[new e.Location(t.uri,new e.Range(0,0,0,0)),{targetUri:t.uri,targetRange:new e.Range(1,0,0,0),targetSelectionRange:new e.Range(1,1,1,1),originSelectionRange:new e.Range(2,2,2,2)}]}})),d.sync().then(()=>i.executeCommand("vscode.executeImplementationProvider",a.uri,new e.Position(0,0)).then(t=>{n.strictEqual(t.length,2);for(const o of t)q(o)?(n.ok(o.uri instanceof p),n.ok(o.range instanceof e.Range)):(n.ok(o.targetUri instanceof p),n.ok(o.targetRange instanceof e.Range),n.ok(o.targetSelectionRange instanceof e.Range),n.ok(o.originSelectionRange instanceof e.Range))})))),test("reference search, back and forth",function(){return l.push(c.registerReferenceProvider(m,u,{provideReferences(){return[new e.Location(p.parse("some:uri/path"),new e.Range(0,1,0,5))]}})),i.executeCommand("vscode.executeReferenceProvider",a.uri,new e.Position(0,0)).then(t=>{n.strictEqual(t.length,1);const[o]=t;n.strictEqual(o.uri.toString(),"some:uri/path"),n.strictEqual(o.range.start.line,0),n.strictEqual(o.range.start.character,1),n.strictEqual(o.range.end.line,0),n.strictEqual(o.range.end.character,5)})}),test('"vscode.executeDocumentHighlights" API has stopped returning DocumentHighlight[]#200056',async function(){return l.push(c.registerDocumentHighlightProvider(m,u,{provideDocumentHighlights(){return[new e.DocumentHighlight(new e.Range(0,17,0,25),e.DocumentHighlightKind.Read)]}})),await d.sync(),i.executeCommand("vscode.executeDocumentHighlights",a.uri,new e.Position(0,0)).then(t=>{n.ok(Array.isArray(t)),n.strictEqual(t.length,1);const[o]=t;n.strictEqual(o.range.start.line,0),n.strictEqual(o.range.start.character,17),n.strictEqual(o.range.end.line,0),n.strictEqual(o.range.end.character,25)})}),test("Outline, back and forth",function(){return l.push(c.registerDocumentSymbolProvider(m,u,{provideDocumentSymbols(){return[new e.SymbolInformation("testing1",e.SymbolKind.Enum,new e.Range(1,0,1,0)),new e.SymbolInformation("testing2",e.SymbolKind.Enum,new e.Range(0,1,0,3))]}})),d.sync().then(()=>i.executeCommand("vscode.executeDocumentSymbolProvider",a.uri).then(t=>{n.strictEqual(t.length,2);const[o,r]=t;n.strictEqual(o instanceof e.SymbolInformation,!0),n.strictEqual(r instanceof e.SymbolInformation,!0),n.strictEqual(o.name,"testing2"),n.strictEqual(r.name,"testing1")}))}),test("vscode.executeDocumentSymbolProvider command only returns SymbolInformation[] rather than DocumentSymbol[] #57984",function(){return l.push(c.registerDocumentSymbolProvider(m,u,{provideDocumentSymbols(){return[new e.SymbolInformation("SymbolInformation",e.SymbolKind.Enum,new e.Range(1,0,1,0))]}})),l.push(c.registerDocumentSymbolProvider(m,u,{provideDocumentSymbols(){const t=new e.DocumentSymbol("DocumentSymbol","DocumentSymbol#detail",e.SymbolKind.Enum,new e.Range(1,0,1,0),new e.Range(1,0,1,0));return t.children=[new e.DocumentSymbol("DocumentSymbol#child","DocumentSymbol#detail#child",e.SymbolKind.Enum,new e.Range(1,0,1,0),new e.Range(1,0,1,0))],[t]}})),d.sync().then(()=>i.executeCommand("vscode.executeDocumentSymbolProvider",a.uri).then(t=>{n.strictEqual(t.length,2);const[o,r]=t;n.strictEqual(o instanceof e.SymbolInformation,!0),n.strictEqual(o instanceof e.DocumentSymbol,!1),n.strictEqual(r instanceof e.SymbolInformation,!0),n.strictEqual(o.name,"DocumentSymbol"),n.strictEqual(o.children.length,1),n.strictEqual(r.name,"SymbolInformation")}))}),y("triggerCharacter is null when completion provider is called programmatically #159914",async function(){let t;l.push(c.registerCompletionItemProvider(m,u,{provideCompletionItems(o,r,s,v){return t=v,[]}},[])),await d.sync(),await i.executeCommand("vscode.executeCompletionItemProvider",a.uri,new e.Position(0,4)),n.ok(t),n.deepStrictEqual(t,{triggerKind:e.CompletionTriggerKind.Invoke,triggerCharacter:void 0})}),y("Suggest, back and forth",async function(){l.push(c.registerCompletionItemProvider(m,u,{provideCompletionItems(){const E=new e.CompletionItem("item1");E.documentation=new e.MarkdownString("hello_md_string");const I=new e.CompletionItem("item2");I.textEdit=e.TextEdit.replace(new e.Range(0,4,0,8),"foo");const D=new e.CompletionItem("item3");D.textEdit=e.TextEdit.replace(new e.Range(0,1,0,6),"foobar");const S=new e.CompletionItem("item4");return S.range=new e.Range(0,1,0,4),S.insertText=new e.SnippetString("foo$0bar"),[E,I,D,S]}},[])),await d.sync();const t=await i.executeCommand("vscode.executeCompletionItemProvider",a.uri,new e.Position(0,4));n.ok(t instanceof e.CompletionList);const o=t.items;n.ok(Array.isArray(o)),n.strictEqual(o.length,4);const[r,s,v,g]=o;n.strictEqual(r.label,"item1"),n.strictEqual(r.textEdit,void 0),n.ok(!e.Range.isRange(r.range)),n.strictEqual(r.documentation.value,"hello_md_string"),n.strictEqual(s.label,"item2"),n.strictEqual(s.textEdit.newText,"foo"),n.strictEqual(s.textEdit.range.start.line,0),n.strictEqual(s.textEdit.range.start.character,4),n.strictEqual(s.textEdit.range.end.line,0),n.strictEqual(s.textEdit.range.end.character,8),n.strictEqual(v.label,"item3"),n.strictEqual(v.textEdit.newText,"foobar"),n.strictEqual(v.textEdit.range.start.line,0),n.strictEqual(v.textEdit.range.start.character,1),n.strictEqual(v.textEdit.range.end.line,0),n.strictEqual(v.textEdit.range.end.character,6),n.strictEqual(g.label,"item4"),n.strictEqual(g.textEdit,void 0);const h=g.range;n.ok(e.Range.isRange(h)),n.strictEqual(h.start.line,0),n.strictEqual(h.start.character,1),n.strictEqual(h.end.line,0),n.strictEqual(h.end.character,4),n.ok(g.insertText instanceof e.SnippetString),n.strictEqual(g.insertText.value,"foo$0bar")}),y("Suggest, return CompletionList !array",async function(){l.push(c.registerCompletionItemProvider(m,u,{provideCompletionItems(){const o=new e.CompletionItem("item1"),r=new e.CompletionItem("item2");return new e.CompletionList([o,r],!0)}},[])),await d.sync();const t=await i.executeCommand("vscode.executeCompletionItemProvider",a.uri,new e.Position(0,4));n.ok(t instanceof e.CompletionList),n.strictEqual(t.isIncomplete,!0)}),y("Suggest, resolve completion items",async function(){let t=0;l.push(c.registerCompletionItemProvider(m,u,{provideCompletionItems(){const r=new e.CompletionItem("item1"),s=new e.CompletionItem("item2"),v=new e.CompletionItem("item3"),g=new e.CompletionItem("item4");return new e.CompletionList([r,s,v,g],!1)},resolveCompletionItem(r){return t+=1,r}},[])),await d.sync();const o=await i.executeCommand("vscode.executeCompletionItemProvider",a.uri,new e.Position(0,4),void 0,2);n.ok(o instanceof e.CompletionList),n.strictEqual(t,2)}),y('"vscode.executeCompletionItemProvider" doesnot return a preselect field #53749',async function(){l.push(c.registerCompletionItemProvider(m,u,{provideCompletionItems(){const g=new e.CompletionItem("item1");g.preselect=!0;const h=new e.CompletionItem("item2"),E=new e.CompletionItem("item3");E.preselect=!0;const I=new e.CompletionItem("item4");return new e.CompletionList([g,h,E,I],!1)}},[])),await d.sync();const t=await i.executeCommand("vscode.executeCompletionItemProvider",a.uri,new e.Position(0,4),void 0);n.ok(t instanceof e.CompletionList),n.strictEqual(t.items.length,4);const[o,r,s,v]=t.items;n.strictEqual(o.preselect,!0),n.strictEqual(r.preselect,void 0),n.strictEqual(s.preselect,!0),n.strictEqual(v.preselect,void 0)}),y("executeCompletionItemProvider doesn't capture commitCharacters #58228",async function(){l.push(c.registerCompletionItemProvider(m,u,{provideCompletionItems(){const s=new e.CompletionItem("item1");s.commitCharacters=["a","b"];const v=new e.CompletionItem("item2");return new e.CompletionList([s,v],!1)}},[])),await d.sync();const t=await i.executeCommand("vscode.executeCompletionItemProvider",a.uri,new e.Position(0,4),void 0);n.ok(t instanceof e.CompletionList),n.strictEqual(t.items.length,2);const[o,r]=t.items;n.deepStrictEqual(o.commitCharacters,["a","b"]),n.strictEqual(r.commitCharacters,void 0)}),y("vscode.executeCompletionItemProvider returns the wrong CompletionItemKinds in insiders #95715",async function(){l.push(c.registerCompletionItemProvider(m,u,{provideCompletionItems(){return[new e.CompletionItem("My Method",e.CompletionItemKind.Method),new e.CompletionItem("My Property",e.CompletionItemKind.Property)]}},[])),await d.sync();const t=await i.executeCommand("vscode.executeCompletionItemProvider",a.uri,new e.Position(0,4),void 0);n.ok(t instanceof e.CompletionList),n.strictEqual(t.items.length,2);const[o,r]=t.items;n.strictEqual(o.kind,e.CompletionItemKind.Method),n.strictEqual(r.kind,e.CompletionItemKind.Property)}),test("Parameter Hints, back and forth",async()=>{l.push(c.registerSignatureHelpProvider(m,u,new class{provideSignatureHelp(o,r,s,v){return{activeSignature:0,activeParameter:1,signatures:[{label:"abc",documentation:`${v.triggerKind===1?"invoked":"unknown"} ${v.triggerCharacter}`,parameters:[]}]}}},[])),await d.sync();const t=await i.executeCommand("vscode.executeSignatureHelpProvider",a.uri,new e.Position(0,1),",");n.strictEqual(t.activeSignature,0),n.strictEqual(t.activeParameter,1),n.strictEqual(t.signatures.length,1),n.strictEqual(t.signatures[0].label,"abc"),n.strictEqual(t.signatures[0].documentation,"invoked ,")}),y("QuickFix, back and forth",function(){return l.push(c.registerCodeActionProvider(m,u,{provideCodeActions(){return[{command:"testing",title:"Title",arguments:[1,2,!0]}]}})),d.sync().then(()=>i.executeCommand("vscode.executeCodeActionProvider",a.uri,new e.Range(0,0,1,1)).then(t=>{n.strictEqual(t.length,1);const[o]=t;n.strictEqual(o.title,"Title"),n.strictEqual(o.command,"testing"),n.deepStrictEqual(o.arguments,[1,2,!0])}))}),y("vscode.executeCodeActionProvider results seem to be missing their `command` property #45124",function(){return l.push(c.registerCodeActionProvider(m,u,{provideCodeActions(t,o){return[{command:{arguments:[t,o],command:"command",title:"command_title"},kind:e.CodeActionKind.Empty.append("foo"),title:"title"}]}})),d.sync().then(()=>i.executeCommand("vscode.executeCodeActionProvider",a.uri,new e.Range(0,0,1,1)).then(t=>{n.strictEqual(t.length,1);const[o]=t;n.ok(o.command),n.strictEqual(o.command.command,"command"),n.strictEqual(o.command.title,"command_title"),n.strictEqual(o.kind.value,"foo"),n.strictEqual(o.title,"title")}))}),y("vscode.executeCodeActionProvider passes Range to provider although Selection is passed in #77997",function(){l.push(c.registerCodeActionProvider(m,u,{provideCodeActions(o,r){return[{command:{arguments:[o,r],command:"command",title:"command_title"},kind:e.CodeActionKind.Empty.append("foo"),title:"title"}]}}));const t=new e.Selection(0,0,1,1);return d.sync().then(()=>i.executeCommand("vscode.executeCodeActionProvider",a.uri,t).then(o=>{n.strictEqual(o.length,1);const[r]=o;n.ok(r.command),n.ok(r.command.arguments[1]instanceof e.Selection),n.ok(r.command.arguments[1].isEqual(t))}))}),y("vscode.executeCodeActionProvider results seem to be missing their `isPreferred` property #78098",function(){l.push(c.registerCodeActionProvider(m,u,{provideCodeActions(o,r){return[{command:{arguments:[o,r],command:"command",title:"command_title"},kind:e.CodeActionKind.Empty.append("foo"),title:"title",isPreferred:!0}]}}));const t=new e.Selection(0,0,1,1);return d.sync().then(()=>i.executeCommand("vscode.executeCodeActionProvider",a.uri,t).then(o=>{n.strictEqual(o.length,1);const[r]=o;n.strictEqual(r.isPreferred,!0)}))}),y("resolving code action",async function(){let t=0;class o extends e.CodeAction{}l.push(c.registerCodeActionProvider(m,u,{provideCodeActions(g,h){return[new o("title",e.CodeActionKind.Empty.append("foo"))]},resolveCodeAction(g){return n.ok(g instanceof o),t+=1,g.title="resolved title",g.edit=new e.WorkspaceEdit,g}}));const r=new e.Selection(0,0,1,1);await d.sync();const s=await i.executeCommand("vscode.executeCodeActionProvider",a.uri,r,void 0,1e3);n.strictEqual(t,1),n.strictEqual(s.length,1);const[v]=s;n.strictEqual(v.title,"title"),n.ok(v.edit)}),y("CodeLens, back and forth",function(){const t={foo(){},bar(){},big:c};return l.push(c.registerCodeLensProvider(m,u,{provideCodeLenses(){return[new e.CodeLens(new e.Range(0,0,1,1),{title:"Title",command:"cmd",arguments:[1,!0,t]})]}})),d.sync().then(()=>i.executeCommand("vscode.executeCodeLensProvider",a.uri).then(o=>{n.strictEqual(o.length,1);const[r]=o;n.strictEqual(r.command.title,"Title"),n.strictEqual(r.command.command,"cmd"),n.strictEqual(r.command.arguments[0],1),n.strictEqual(r.command.arguments[1],!0),n.strictEqual(r.command.arguments[2],t)}))}),y("CodeLens, resolve",async function(){let t=0;l.push(c.registerCodeLensProvider(m,u,{provideCodeLenses(){return[new e.CodeLens(new e.Range(0,0,1,1)),new e.CodeLens(new e.Range(0,0,1,1)),new e.CodeLens(new e.Range(0,0,1,1)),new e.CodeLens(new e.Range(0,0,1,1),{title:"Already resolved",command:"fff"})]},resolveCodeLens(r){return r.command={title:t.toString(),command:"resolved"},t+=1,r}})),await d.sync();let o=await i.executeCommand("vscode.executeCodeLensProvider",a.uri,2);n.strictEqual(o.length,3),n.strictEqual(t,2),t=0,o=await i.executeCommand("vscode.executeCodeLensProvider",a.uri),n.strictEqual(o.length,4),n.strictEqual(t,0)}),y("Links, back and forth",function(){return l.push(c.registerDocumentLinkProvider(m,u,{provideDocumentLinks(){return[new e.DocumentLink(new e.Range(0,0,0,20),p.parse("foo:bar"))]}})),d.sync().then(()=>i.executeCommand("vscode.executeLinkProvider",a.uri).then(t=>{n.strictEqual(t.length,1);const[o]=t;n.strictEqual(o.target+"","foo:bar"),n.strictEqual(o.range.start.line,0),n.strictEqual(o.range.start.character,0),n.strictEqual(o.range.end.line,0),n.strictEqual(o.range.end.character,20)}))}),y("What's the condition for DocumentLink target to be undefined? #106308",async function(){l.push(c.registerDocumentLinkProvider(m,u,{provideDocumentLinks(){return[new e.DocumentLink(new e.Range(0,0,0,20),void 0)]},resolveDocumentLink(r){return r.target=p.parse("foo:bar"),r}})),await d.sync();const t=await i.executeCommand("vscode.executeLinkProvider",a.uri);n.strictEqual(t.length,1),n.strictEqual(t[0].target,void 0);const o=await i.executeCommand("vscode.executeLinkProvider",a.uri,1e3);n.strictEqual(o.length,1),n.strictEqual(o[0].target.toString(),p.parse("foo:bar").toString())}),y("DocumentLink[] vscode.executeLinkProvider returns lack tooltip #213970",async function(){l.push(c.registerDocumentLinkProvider(m,u,{provideDocumentLinks(){const o=new e.DocumentLink(new e.Range(0,0,0,20),p.parse("foo:bar"));return o.tooltip="Link Tooltip",[o]}})),await d.sync();const t=await i.executeCommand("vscode.executeLinkProvider",a.uri);n.strictEqual(t.length,1),n.strictEqual(t[0].tooltip,"Link Tooltip")}),test("Color provider",function(){return l.push(c.registerColorProvider(m,u,{provideDocumentColors(){return[new e.ColorInformation(new e.Range(0,0,0,20),new e.Color(.1,.2,.3,.4))]},provideColorPresentations(){const t=new e.ColorPresentation("#ABC");return t.textEdit=e.TextEdit.replace(new e.Range(1,0,1,20),"#ABC"),t.additionalTextEdits=[e.TextEdit.insert(new e.Position(2,20),"*")],[t]}})),d.sync().then(()=>i.executeCommand("vscode.executeDocumentColorProvider",a.uri).then(t=>{n.strictEqual(t.length,1);const[o]=t;n.strictEqual(o.color.red,.1),n.strictEqual(o.color.green,.2),n.strictEqual(o.color.blue,.3),n.strictEqual(o.color.alpha,.4),n.strictEqual(o.range.start.line,0),n.strictEqual(o.range.start.character,0),n.strictEqual(o.range.end.line,0),n.strictEqual(o.range.end.character,20)})).then(()=>{const t=new e.Color(.5,.6,.7,.8),o=new e.Range(0,0,0,20);return i.executeCommand("vscode.executeColorPresentationProvider",t,{uri:a.uri,range:o}).then(r=>{n.strictEqual(r.length,1);const[s]=r;n.strictEqual(s.label,"#ABC"),n.strictEqual(s.textEdit.newText,"#ABC"),n.strictEqual(s.textEdit.range.start.line,1),n.strictEqual(s.textEdit.range.start.character,0),n.strictEqual(s.textEdit.range.end.line,1),n.strictEqual(s.textEdit.range.end.character,20),n.strictEqual(s.additionalTextEdits.length,1),n.strictEqual(s.additionalTextEdits[0].range.start.line,2),n.strictEqual(s.additionalTextEdits[0].range.start.character,20),n.strictEqual(s.additionalTextEdits[0].range.end.line,2),n.strictEqual(s.additionalTextEdits[0].range.end.character,20)})})}),test('"TypeError: e.onCancellationRequested is not a function" calling hover provider in Insiders #54174',function(){return l.push(c.registerHoverProvider(m,u,{provideHover(){return new e.Hover("fofofofo")}})),d.sync().then(()=>i.executeCommand("vscode.executeHoverProvider",a.uri,new e.Position(1,1)).then(t=>{n.strictEqual(t.length,1),n.strictEqual(t[0].contents.length,1)}))}),y("Inlay Hints, back and forth",async function(){l.push(c.registerInlayHintsProvider(m,u,{provideInlayHints(){return[new e.InlayHint(new e.Position(0,1),"Foo")]}})),await d.sync();const t=await i.executeCommand("vscode.executeInlayHintProvider",a.uri,new e.Range(0,0,20,20));n.strictEqual(t.length,1);const[o]=t;n.strictEqual(o.label,"Foo"),n.strictEqual(o.position.line,0),n.strictEqual(o.position.character,1)}),y("Inline Hints, merge",async function(){l.push(c.registerInlayHintsProvider(m,u,{provideInlayHints(){const v=new e.InlayHintLabelPart("Bar");v.tooltip="part_tooltip",v.command={command:"cmd",title:"part"};const g=new e.InlayHint(new e.Position(10,11),[v]);return g.tooltip="hint_tooltip",g.paddingLeft=!0,g.paddingRight=!1,[g]}})),l.push(c.registerInlayHintsProvider(m,u,{provideInlayHints(){const v=new e.InlayHint(new e.Position(0,1),"Foo",e.InlayHintKind.Parameter);return v.textEdits=[e.TextEdit.insert(new e.Position(0,0),"Hello")],[v]}})),await d.sync();const t=await i.executeCommand("vscode.executeInlayHintProvider",a.uri,new e.Range(0,0,20,20));n.strictEqual(t.length,2);const[o,r]=t;n.strictEqual(o.label,"Foo"),n.strictEqual(o.position.line,0),n.strictEqual(o.position.character,1),n.strictEqual(o.textEdits?.length,1),n.strictEqual(o.textEdits[0].newText,"Hello"),n.strictEqual(r.position.line,10),n.strictEqual(r.position.character,11),n.strictEqual(r.paddingLeft,!0),n.strictEqual(r.paddingRight,!1),n.strictEqual(r.tooltip,"hint_tooltip");const s=r.label[0];ue(s instanceof e.InlayHintLabelPart),n.strictEqual(s.value,"Bar"),n.strictEqual(s.tooltip,"part_tooltip"),n.strictEqual(s.command?.command,"cmd"),n.strictEqual(s.command?.title,"part")}),y("Inline Hints, bad provider",async function(){l.push(c.registerInlayHintsProvider(m,u,{provideInlayHints(){return[new e.InlayHint(new e.Position(0,1),"Foo")]}})),l.push(c.registerInlayHintsProvider(m,u,{provideInlayHints(){throw new Error}})),await d.sync();const t=await i.executeCommand("vscode.executeInlayHintProvider",a.uri,new e.Range(0,0,20,20));n.strictEqual(t.length,1);const[o]=t;n.strictEqual(o.label,"Foo"),n.strictEqual(o.position.line,0),n.strictEqual(o.position.character,1)}),test("Selection Range, back and forth",async function(){l.push(c.registerSelectionRangeProvider(m,u,{provideSelectionRanges(){return[new e.SelectionRange(new e.Range(0,10,0,18),new e.SelectionRange(new e.Range(0,2,0,20)))]}})),await d.sync();const t=await i.executeCommand("vscode.executeSelectionRangeProvider",a.uri,[new e.Position(0,10)]);n.strictEqual(t.length,1),n.ok(t[0].parent)}),test("CallHierarchy, back and forth",async function(){l.push(c.registerCallHierarchyProvider(m,u,new class{prepareCallHierarchy(s,v){return new e.CallHierarchyItem(e.SymbolKind.Constant,"ROOT","ROOT",s.uri,new e.Range(0,0,0,0),new e.Range(0,0,0,0))}provideCallHierarchyIncomingCalls(s,v){return[new e.CallHierarchyIncomingCall(new e.CallHierarchyItem(e.SymbolKind.Constant,"INCOMING","INCOMING",s.uri,new e.Range(0,0,0,0),new e.Range(0,0,0,0)),[new e.Range(0,0,0,0)])]}provideCallHierarchyOutgoingCalls(s,v){return[new e.CallHierarchyOutgoingCall(new e.CallHierarchyItem(e.SymbolKind.Constant,"OUTGOING","OUTGOING",s.uri,new e.Range(0,0,0,0),new e.Range(0,0,0,0)),[new e.Range(0,0,0,0)])]}})),await d.sync();const t=await i.executeCommand("vscode.prepareCallHierarchy",a.uri,new e.Position(0,0));n.ok(Array.isArray(t)),n.strictEqual(t.length,1),n.strictEqual(t[0].name,"ROOT");const o=await i.executeCommand("vscode.provideIncomingCalls",t[0]);n.strictEqual(o.length,1),n.strictEqual(o[0].from.name,"INCOMING");const r=await i.executeCommand("vscode.provideOutgoingCalls",t[0]);n.strictEqual(r.length,1),n.strictEqual(r[0].to.name,"OUTGOING")}),test("prepareCallHierarchy throws TypeError if clangd returns empty result #137415",async function(){l.push(c.registerCallHierarchyProvider(m,u,new class{prepareCallHierarchy(o,r){return[]}provideCallHierarchyIncomingCalls(o,r){return[]}provideCallHierarchyOutgoingCalls(o,r){return[]}})),await d.sync();const t=await i.executeCommand("vscode.prepareCallHierarchy",a.uri,new e.Position(0,0));n.ok(Array.isArray(t)),n.strictEqual(t.length,0)}),test("TypeHierarchy, back and forth",async function(){l.push(c.registerTypeHierarchyProvider(m,u,new class{prepareTypeHierarchy(s,v,g){return[new e.TypeHierarchyItem(e.SymbolKind.Constant,"ROOT","ROOT",s.uri,new e.Range(0,0,0,0),new e.Range(0,0,0,0))]}provideTypeHierarchySupertypes(s,v){return[new e.TypeHierarchyItem(e.SymbolKind.Constant,"SUPER","SUPER",s.uri,new e.Range(0,0,0,0),new e.Range(0,0,0,0))]}provideTypeHierarchySubtypes(s,v){return[new e.TypeHierarchyItem(e.SymbolKind.Constant,"SUB","SUB",s.uri,new e.Range(0,0,0,0),new e.Range(0,0,0,0))]}})),await d.sync();const t=await i.executeCommand("vscode.prepareTypeHierarchy",a.uri,new e.Position(0,0));n.ok(Array.isArray(t)),n.strictEqual(t.length,1),n.strictEqual(t[0].name,"ROOT");const o=await i.executeCommand("vscode.provideSupertypes",t[0]);n.strictEqual(o.length,1),n.strictEqual(o[0].name,"SUPER");const r=await i.executeCommand("vscode.provideSubtypes",t[0]);n.strictEqual(r.length,1),n.strictEqual(r[0].name,"SUB")}),test("selectionRangeProvider on inner array always returns outer array #91852",async function(){l.push(c.registerSelectionRangeProvider(m,u,{provideSelectionRanges(o,r){const[s]=r;return[new e.SelectionRange(new e.Range(s.line,s.character,s.line,s.character))]}})),await d.sync();const t=await i.executeCommand("vscode.executeSelectionRangeProvider",a.uri,[new e.Position(0,10)]);n.strictEqual(t.length,1),n.strictEqual(t[0].range.start.line,0),n.strictEqual(t[0].range.start.character,10),n.strictEqual(t[0].range.end.line,0),n.strictEqual(t[0].range.end.character,10)}),test("more element test of selectionRangeProvider on inner array always returns outer array #91852",async function(){l.push(c.registerSelectionRangeProvider(m,u,{provideSelectionRanges(o,r){const[s,v]=r;return[new e.SelectionRange(new e.Range(s.line,s.character,s.line,s.character)),new e.SelectionRange(new e.Range(v.line,v.character,v.line,v.character))]}})),await d.sync();const t=await i.executeCommand("vscode.executeSelectionRangeProvider",a.uri,[new e.Position(0,0),new e.Position(0,10)]);n.strictEqual(t.length,2),n.strictEqual(t[0].range.start.line,0),n.strictEqual(t[0].range.start.character,0),n.strictEqual(t[0].range.end.line,0),n.strictEqual(t[0].range.end.character,0),n.strictEqual(t[1].range.start.line,0),n.strictEqual(t[1].range.start.character,10),n.strictEqual(t[1].range.end.line,0),n.strictEqual(t[1].range.end.character,10)})});
