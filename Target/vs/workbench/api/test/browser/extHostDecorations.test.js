import e from"assert";import{timeout as s}from"../../../../base/common/async.js";import{CancellationToken as v}from"../../../../base/common/cancellation.js";import{URI as h}from"../../../../base/common/uri.js";import{mock as l}from"../../../../base/test/common/mock.js";import{ensureNoDisposablesAreLeakedInTestSuite as E}from"../../../../base/test/common/utils.js";import{NullLogService as w}from"../../../../platform/log/common/log.js";import"../../common/extHost.protocol.js";import{ExtHostDecorations as x}from"../../common/extHostDecorations.js";import"../../common/extHostRpcService.js";import{nullExtensionDescription as m}from"../../../services/extensions/common/extensions.js";suite("ExtHostDecorations",function(){let n,t;const o=new Set;E(),setup(function(){o.clear(),n=new class extends l(){$registerDecorationProvider(r){o.add(r)}},t=new x(new class extends l(){getProxy(){return n}},new w)}),test("SCM Decorations missing #100524",async function(){let r=!1,a=!1;t.registerFileDecorationProvider({provideFileDecoration(){return r=!0,new Promise(()=>{})}},m),t.registerFileDecorationProvider({provideFileDecoration(){return a=!0,new Promise(i=>i({badge:"H",tooltip:"Hello"}))}},m);const c=[...o.values()].map((i,D)=>t.$provideDecorations(i,[{id:D,uri:h.parse("test:///file")}],v.None));e.strictEqual(r,!0),e.strictEqual(a,!0),e.strictEqual(c.length,2);const[u,p]=c,d=await Promise.race([u,s(30).then(()=>!1)]);e.strictEqual(typeof d,"boolean");const f=await Promise.race([p,s(30).then(()=>!1)]);e.strictEqual(typeof f,"object"),await s(30)})});
