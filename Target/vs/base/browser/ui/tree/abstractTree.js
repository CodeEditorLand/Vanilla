import"../../dnd.js";import{$ as S,append as P,clearNode as ve,createStyleSheet as me,getWindow as J,h as O,hasParentWithClass as $,isActiveElement as ye,asCssValueWithDefault as Q,isKeyboardEvent as I,addDisposableListener as Z,isEditableElement as ee}from"../../dom.js";import{DomEmitter as N}from"../../event.js";import{StandardKeyboardEvent as G}from"../../keyboardEvent.js";import{ActionBar as be}from"../actionbar/actionbar.js";import"../contextview/contextview.js";import{FindInput as De}from"../findinput/findInput.js";import{MessageType as te,unthemedInboxStyles as Se}from"../inputbox/inputBox.js";import"../list/list.js";import{ElementsDragAndDropData as ie}from"../list/listView.js";import{isActionItem as Ie,isButton as Fe,isMonacoCustomToggle as we,isMonacoEditor as Ce,isStickyScrollContainer as E,isStickyScrollElement as x,List as Ne,MouseController as Ee}from"../list/listWidget.js";import{Toggle as oe,unthemedToggleStyles as xe}from"../toggle/toggle.js";import{getVisibleState as ke,isFilterResult as Me}from"./indexTreeModel.js";import{TreeDragOverBubble as Le,TreeError as Re,TreeMouseEventTarget as k,TreeVisibility as M}from"./tree.js";import{Action as Ae}from"../../../common/actions.js";import{distinct as ne,equals as K,range as _e}from"../../../common/arrays.js";import{Delayer as Pe,disposableTimeout as Oe,timeout as He}from"../../../common/async.js";import{Codicon as H}from"../../../common/codicons.js";import{ThemeIcon as se}from"../../../common/themables.js";import{SetMap as Ve}from"../../../common/map.js";import{Emitter as f,Event as u,EventBufferer as Be,Relay as L}from"../../../common/event.js";import{fuzzyScore as We,FuzzyScore as R}from"../../../common/filters.js";import{KeyCode as m}from"../../../common/keyCodes.js";import{Disposable as F,DisposableStore as v,dispose as U,toDisposable as q}from"../../../common/lifecycle.js";import{clamp as V}from"../../../common/numbers.js";import"../../../common/scrollable.js";import{isNumber as ze}from"../../../common/types.js";import"./media/tree.css";import{localize as y}from"../../../../nls.js";import"../hover/hoverDelegate.js";import{createInstantHoverDelegate as $e,getDefaultHoverDelegate as re}from"../hover/hoverDelegateFactory.js";import{autorun as Ge,constObservable as Ke}from"../../../common/observable.js";import{alert as le}from"../aria/aria.js";class Ue extends ie{constructor(e){super(e.elements.map(i=>i.element));this.data=e}set context(e){this.data.context=e}get context(){return this.data.context}}function Y(a){return a instanceof ie?new Ue(a):a}class qe{constructor(t,e){this.modelProvider=t;this.dnd=e}autoExpandNode;autoExpandDisposable=F.None;disposables=new v;getDragURI(t){return this.dnd.getDragURI(t.element)}getDragLabel(t,e){if(this.dnd.getDragLabel)return this.dnd.getDragLabel(t.map(i=>i.element),e)}onDragStart(t,e){this.dnd.onDragStart?.(Y(t),e)}onDragOver(t,e,i,n,o,s=!0){const r=this.dnd.onDragOver(Y(t),e&&e.element,i,n,o),l=this.autoExpandNode!==e;if(l&&(this.autoExpandDisposable.dispose(),this.autoExpandNode=e),typeof e>"u")return r;if(l&&typeof r!="boolean"&&r.autoExpand&&(this.autoExpandDisposable=Oe(()=>{const g=this.modelProvider(),b=g.getNodeLocation(e);g.isCollapsed(b)&&g.setCollapsed(b,!1),this.autoExpandNode=void 0},500,this.disposables)),typeof r=="boolean"||!r.accept||typeof r.bubble>"u"||r.feedback){if(!s){const g=typeof r=="boolean"?r:r.accept,b=typeof r=="boolean"?void 0:r.effect;return{accept:g,effect:b,feedback:[i]}}return r}if(r.bubble===Le.Up){const g=this.modelProvider(),b=g.getNodeLocation(e),h=g.getParentNodeLocation(b),p=g.getNode(h),D=h&&g.getListIndex(h);return this.onDragOver(t,p,D,n,o,!1)}const d=this.modelProvider(),c=d.getNodeLocation(e),T=d.getListIndex(c),C=d.getListRenderCount(c);return{...r,feedback:_e(T,T+C)}}drop(t,e,i,n,o){this.autoExpandDisposable.dispose(),this.autoExpandNode=void 0,this.dnd.drop(Y(t),e&&e.element,i,n,o)}onDragEnd(t){this.dnd.onDragEnd?.(t)}dispose(){this.disposables.dispose(),this.dnd.dispose()}}function Ye(a,t){return t&&{...t,identityProvider:t.identityProvider&&{getId(e){return t.identityProvider.getId(e.element)}},dnd:t.dnd&&new qe(a,t.dnd),multipleSelectionController:t.multipleSelectionController&&{isSelectionSingleChangeEvent(e){return t.multipleSelectionController.isSelectionSingleChangeEvent({...e,element:e.element})},isSelectionRangeChangeEvent(e){return t.multipleSelectionController.isSelectionRangeChangeEvent({...e,element:e.element})}},accessibilityProvider:t.accessibilityProvider&&{...t.accessibilityProvider,getSetSize(e){const i=a(),n=i.getNodeLocation(e),o=i.getParentNodeLocation(n);return i.getNode(o).visibleChildrenCount},getPosInSet(e){return e.visibleChildIndex+1},isChecked:t.accessibilityProvider&&t.accessibilityProvider.isChecked?e=>t.accessibilityProvider.isChecked(e.element):void 0,getRole:t.accessibilityProvider&&t.accessibilityProvider.getRole?e=>t.accessibilityProvider.getRole(e.element):()=>"treeitem",getAriaLabel(e){return t.accessibilityProvider.getAriaLabel(e.element)},getWidgetAriaLabel(){return t.accessibilityProvider.getWidgetAriaLabel()},getWidgetRole:t.accessibilityProvider&&t.accessibilityProvider.getWidgetRole?()=>t.accessibilityProvider.getWidgetRole():()=>"tree",getAriaLevel:t.accessibilityProvider&&t.accessibilityProvider.getAriaLevel?e=>t.accessibilityProvider.getAriaLevel(e.element):e=>e.depth,getActiveDescendantId:t.accessibilityProvider.getActiveDescendantId&&(e=>t.accessibilityProvider.getActiveDescendantId(e.element))},keyboardNavigationLabelProvider:t.keyboardNavigationLabelProvider&&{...t.keyboardNavigationLabelProvider,getKeyboardNavigationLabel(e){return t.keyboardNavigationLabelProvider.getKeyboardNavigationLabel(e.element)}}}}class Xe{constructor(t){this.delegate=t}getHeight(t){return this.delegate.getHeight(t.element)}getTemplateId(t){return this.delegate.getTemplateId(t.element)}hasDynamicHeight(t){return!!this.delegate.hasDynamicHeight&&this.delegate.hasDynamicHeight(t.element)}setDynamicHeight(t,e){this.delegate.setDynamicHeight?.(t.element,e)}}class A{focus;selection;expanded;scrollTop;static lift(t){return t instanceof A?t:new A(t)}static empty(t=0){return new A({focus:[],selection:[],expanded:Object.create(null),scrollTop:t})}constructor(t){if(this.focus=new Set(t.focus),this.selection=new Set(t.selection),t.expanded instanceof Array){this.expanded=Object.create(null);for(const e of t.expanded)this.expanded[e]=1}else this.expanded=t.expanded;this.expanded=t.expanded,this.scrollTop=t.scrollTop}toJSON(){return{focus:Array.from(this.focus),selection:Array.from(this.selection),expanded:this.expanded,scrollTop:this.scrollTop}}}var je=(i=>(i.None="none",i.OnHover="onHover",i.Always="always",i))(je||{});class Je{constructor(t,e=[]){this._elements=e;this.onDidChange=u.forEach(t,i=>this._elements=i,this.disposables)}disposables=new v;onDidChange;get elements(){return this._elements}dispose(){this.disposables.dispose()}}class W{constructor(t,e,i,n,o,s={}){this.renderer=t;this.model=e;this.activeNodes=n;this.renderedIndentGuides=o;this.templateId=t.templateId,this.updateOptions(s),u.map(i,r=>r.node)(this.onDidChangeNodeTwistieState,this,this.disposables),t.onDidChangeTwistieState?.(this.onDidChangeTwistieState,this,this.disposables)}static DefaultIndent=8;templateId;renderedElements=new Map;renderedNodes=new Map;indent=W.DefaultIndent;hideTwistiesOfChildlessElements=!1;shouldRenderIndentGuides=!1;activeIndentNodes=new Set;indentGuidesDisposable=F.None;disposables=new v;updateOptions(t={}){if(typeof t.indent<"u"){const e=V(t.indent,0,40);if(e!==this.indent){this.indent=e;for(const[i,n]of this.renderedNodes)this.renderTreeElement(i,n)}}if(typeof t.renderIndentGuides<"u"){const e=t.renderIndentGuides!=="none";if(e!==this.shouldRenderIndentGuides){this.shouldRenderIndentGuides=e;for(const[i,n]of this.renderedNodes)this._renderIndentGuides(i,n);if(this.indentGuidesDisposable.dispose(),e){const i=new v;this.activeNodes.onDidChange(this._onDidChangeActiveNodes,this,i),this.indentGuidesDisposable=i,this._onDidChangeActiveNodes(this.activeNodes.elements)}}}typeof t.hideTwistiesOfChildlessElements<"u"&&(this.hideTwistiesOfChildlessElements=t.hideTwistiesOfChildlessElements)}renderTemplate(t){const e=P(t,S(".monaco-tl-row")),i=P(e,S(".monaco-tl-indent")),n=P(e,S(".monaco-tl-twistie")),o=P(e,S(".monaco-tl-contents")),s=this.renderer.renderTemplate(o);return{container:t,indent:i,twistie:n,indentGuidesDisposable:F.None,templateData:s}}renderElement(t,e,i,n){this.renderedNodes.set(t,i),this.renderedElements.set(t.element,t),this.renderTreeElement(t,i),this.renderer.renderElement(t,e,i.templateData,n)}disposeElement(t,e,i,n){i.indentGuidesDisposable.dispose(),this.renderer.disposeElement?.(t,e,i.templateData,n),typeof n=="number"&&(this.renderedNodes.delete(t),this.renderedElements.delete(t.element))}disposeTemplate(t){this.renderer.disposeTemplate(t.templateData)}onDidChangeTwistieState(t){const e=this.renderedElements.get(t);e&&this.onDidChangeNodeTwistieState(e)}onDidChangeNodeTwistieState(t){const e=this.renderedNodes.get(t);e&&(this._onDidChangeActiveNodes(this.activeNodes.elements),this.renderTreeElement(t,e))}renderTreeElement(t,e){const i=W.DefaultIndent+(t.depth-1)*this.indent;e.twistie.style.paddingLeft=`${i}px`,e.indent.style.width=`${i+this.indent-16}px`,t.collapsible?e.container.setAttribute("aria-expanded",String(!t.collapsed)):e.container.removeAttribute("aria-expanded"),e.twistie.classList.remove(...se.asClassNameArray(H.treeItemExpanded));let n=!1;this.renderer.renderTwistie&&(n=this.renderer.renderTwistie(t.element,e.twistie)),t.collapsible&&(!this.hideTwistiesOfChildlessElements||t.visibleChildrenCount>0)?(n||e.twistie.classList.add(...se.asClassNameArray(H.treeItemExpanded)),e.twistie.classList.add("collapsible"),e.twistie.classList.toggle("collapsed",t.collapsed)):e.twistie.classList.remove("collapsible","collapsed"),this._renderIndentGuides(t,e)}_renderIndentGuides(t,e){if(ve(e.indent),e.indentGuidesDisposable.dispose(),!this.shouldRenderIndentGuides)return;const i=new v;for(;;){const n=this.model.getNodeLocation(t),o=this.model.getParentNodeLocation(n);if(!o)break;const s=this.model.getNode(o),r=S(".indent-guide",{style:`width: ${this.indent}px`});this.activeIndentNodes.has(s)&&r.classList.add("active"),e.indent.childElementCount===0?e.indent.appendChild(r):e.indent.insertBefore(r,e.indent.firstElementChild),this.renderedIndentGuides.add(s,r),i.add(q(()=>this.renderedIndentGuides.delete(s,r))),t=s}e.indentGuidesDisposable=i}_onDidChangeActiveNodes(t){if(!this.shouldRenderIndentGuides)return;const e=new Set;t.forEach(i=>{const n=this.model.getNodeLocation(i);try{const o=this.model.getParentNodeLocation(n);i.collapsible&&i.children.length>0&&!i.collapsed?e.add(i):o&&e.add(this.model.getNode(o))}catch{}}),this.activeIndentNodes.forEach(i=>{e.has(i)||this.renderedIndentGuides.forEach(i,n=>n.classList.remove("active"))}),e.forEach(i=>{this.activeIndentNodes.has(i)||this.renderedIndentGuides.forEach(i,n=>n.classList.add("active"))}),this.activeIndentNodes=e}setModel(t){this.model=t}dispose(){this.renderedNodes.clear(),this.renderedElements.clear(),this.indentGuidesDisposable.dispose(),U(this.disposables)}}class Qe{constructor(t,e,i){this.tree=t;this.keyboardNavigationLabelProvider=e;this._filter=i;t.onWillRefilter(this.reset,this,this.disposables)}_totalCount=0;get totalCount(){return this._totalCount}_matchCount=0;get matchCount(){return this._matchCount}_pattern="";_lowercasePattern="";disposables=new v;set pattern(t){this._pattern=t,this._lowercasePattern=t.toLowerCase()}filter(t,e){let i=M.Visible;if(this._filter){const s=this._filter.filter(t,e);if(typeof s=="boolean"?i=s?M.Visible:M.Hidden:Me(s)?i=ke(s.visibility):i=s,i===M.Hidden)return!1}if(this._totalCount++,!this._pattern)return this._matchCount++,{data:R.Default,visibility:i};const n=this.keyboardNavigationLabelProvider.getKeyboardNavigationLabel(t),o=Array.isArray(n)?n:[n];for(const s of o){const r=s&&s.toString();if(typeof r>"u")return{data:R.Default,visibility:i};let l;if(this.tree.findMatchType===1){const d=r.toLowerCase().indexOf(this._lowercasePattern);if(d>-1){l=[Number.MAX_SAFE_INTEGER,0];for(let c=this._lowercasePattern.length;c>0;c--)l.push(d+c-1)}}else l=We(this._pattern,this._lowercasePattern,0,r,r.toLowerCase(),0,{firstMatchCanBeWeak:!0,boostFullMatch:!0});if(l)return this._matchCount++,o.length===1?{data:l,visibility:i}:{data:{label:r,score:l},visibility:i}}return this.tree.findMode===1?typeof this.tree.options.defaultFindVisibility=="number"?this.tree.options.defaultFindVisibility:this.tree.options.defaultFindVisibility?this.tree.options.defaultFindVisibility(t):M.Recurse:{data:R.Default,visibility:i}}reset(){this._totalCount=0,this._matchCount=0}dispose(){U(this.disposables)}}class Ze extends oe{constructor(t){super({icon:H.listFilter,title:y("filter","Filter"),isChecked:t.isChecked??!1,hoverDelegate:t.hoverDelegate??re("element"),inputActiveOptionBorder:t.inputActiveOptionBorder,inputActiveOptionForeground:t.inputActiveOptionForeground,inputActiveOptionBackground:t.inputActiveOptionBackground})}}class et extends oe{constructor(t){super({icon:H.searchFuzzy,title:y("fuzzySearch","Fuzzy Match"),isChecked:t.isChecked??!1,hoverDelegate:t.hoverDelegate??re("element"),inputActiveOptionBorder:t.inputActiveOptionBorder,inputActiveOptionForeground:t.inputActiveOptionForeground,inputActiveOptionBackground:t.inputActiveOptionBackground})}}const tt={inputBoxStyles:Se,toggleStyles:xe,listFilterWidgetBackground:void 0,listFilterWidgetNoMatchesOutline:void 0,listFilterWidgetOutline:void 0,listFilterWidgetShadow:void 0};var it=(e=>(e[e.Highlight=0]="Highlight",e[e.Filter=1]="Filter",e))(it||{}),ot=(e=>(e[e.Fuzzy=0]="Fuzzy",e[e.Contiguous=1]="Contiguous",e))(ot||{});class nt extends F{constructor(e,i,n,o,s,r){super();this.tree=i;e.appendChild(this.elements.root),this._register(q(()=>this.elements.root.remove()));const l=r?.styles??tt;l.listFilterWidgetBackground&&(this.elements.root.style.backgroundColor=l.listFilterWidgetBackground),l.listFilterWidgetShadow&&(this.elements.root.style.boxShadow=`0 0 8px 2px ${l.listFilterWidgetShadow}`);const d=this._register($e());this.modeToggle=this._register(new Ze({...l.toggleStyles,isChecked:o===1,hoverDelegate:d})),this.matchTypeToggle=this._register(new et({...l.toggleStyles,isChecked:s===0,hoverDelegate:d})),this.onDidChangeMode=u.map(this.modeToggle.onChange,()=>this.modeToggle.checked?1:0,this._store),this.onDidChangeMatchType=u.map(this.matchTypeToggle.onChange,()=>this.matchTypeToggle.checked?0:1,this._store),this.findInput=this._register(new De(this.elements.findInput,n,{label:y("type to search","Type to search"),additionalToggles:[this.modeToggle,this.matchTypeToggle],showCommonFindToggles:!1,inputBoxStyles:l.inputBoxStyles,toggleStyles:l.toggleStyles,history:r?.history})),this.actionbar=this._register(new be(this.elements.actionbar)),this.mode=o;const c=this._register(new N(this.findInput.inputBox.inputElement,"keydown")),T=u.chain(c.event,h=>h.map(p=>new G(p)));this._register(T(h=>{if(h.equals(m.Enter)){h.preventDefault(),h.stopPropagation(),this.findInput.inputBox.addToHistory(),this.tree.domFocus();return}if(h.equals(m.DownArrow)){h.preventDefault(),h.stopPropagation(),this.findInput.inputBox.isAtLastInHistory()||this.findInput.inputBox.isNowhereInHistory()?(this.findInput.inputBox.addToHistory(),this.tree.domFocus()):this.findInput.inputBox.showNextValue();return}if(h.equals(m.UpArrow)){h.preventDefault(),h.stopPropagation(),this.findInput.inputBox.showPreviousValue();return}}));const C=this._register(new Ae("close",y("close","Close"),"codicon codicon-close",!0,()=>this.dispose()));this.actionbar.push(C,{icon:!0,label:!1});const g=this._register(new N(this.elements.grab,"mousedown"));this._register(g.event(h=>{const p=new v,D=p.add(new N(J(h),"mousemove")),z=p.add(new N(J(h),"mouseup")),ce=this.right,he=h.pageX,ue=this.top,Te=h.pageY;this.elements.grab.classList.add("grabbing");const pe=this.elements.root.style.transition;this.elements.root.style.transition="unset";const j=_=>{const ge=_.pageX-he;this.right=ce-ge;const fe=_.pageY-Te;this.top=ue+fe,this.layout()};p.add(D.event(j)),p.add(z.event(_=>{j(_),this.elements.grab.classList.remove("grabbing"),this.elements.root.style.transition=pe,p.dispose()}))}));const b=u.chain(this._register(new N(this.elements.grab,"keydown")).event,h=>h.map(p=>new G(p)));this._register(b(h=>{let p,D;if(h.keyCode===m.LeftArrow?p=Number.POSITIVE_INFINITY:h.keyCode===m.RightArrow?p=0:h.keyCode===m.Space&&(p=this.right===0?Number.POSITIVE_INFINITY:0),h.keyCode===m.UpArrow?D=0:h.keyCode===m.DownArrow&&(D=Number.POSITIVE_INFINITY),p!==void 0&&(h.preventDefault(),h.stopPropagation(),this.right=p,this.layout()),D!==void 0){h.preventDefault(),h.stopPropagation(),this.top=D;const z=this.elements.root.style.transition;this.elements.root.style.transition="unset",this.layout(),setTimeout(()=>{this.elements.root.style.transition=z},0)}})),this.onDidChangeValue=this.findInput.onDidChange}elements=O(".monaco-tree-type-filter",[O(".monaco-tree-type-filter-grab.codicon.codicon-debug-gripper@grab",{tabIndex:0}),O(".monaco-tree-type-filter-input@findInput"),O(".monaco-tree-type-filter-actionbar@actionbar")]);set mode(e){this.modeToggle.checked=e===1,this.findInput.inputBox.setPlaceHolder(e===1?y("type to filter","Type to filter"):y("type to search","Type to search"))}set matchType(e){this.matchTypeToggle.checked=e===0}get value(){return this.findInput.inputBox.value}set value(e){this.findInput.inputBox.value=e}modeToggle;matchTypeToggle;findInput;actionbar;width=0;right=0;top=0;_onDidDisable=new f;onDidDisable=this._onDidDisable.event;onDidChangeValue;onDidChangeMode;onDidChangeMatchType;getHistory(){return this.findInput.inputBox.getHistory()}focus(){this.findInput.focus()}select(){this.findInput.select(),this.findInput.inputBox.addToHistory(!0)}layout(e=this.width){this.width=e,this.right=V(this.right,0,Math.max(0,e-212)),this.elements.root.style.right=`${this.right}px`,this.top=V(this.top,0,24),this.elements.root.style.top=`${this.top}px`}showMessage(e){this.findInput.showMessage(e)}clearMessage(){this.findInput.clearMessage()}async dispose(){this._onDidDisable.fire(),this.elements.root.classList.add("disabled"),await He(300),super.dispose()}}class st{constructor(t,e,i,n,o={}){this.tree=t;this.view=e;this.filter=i;this.contextViewProvider=n;this.options=o;this._mode=t.options.defaultFindMode??0,this._matchType=t.options.defaultFindMatchType??0}_history;_pattern="";get pattern(){return this._pattern}previousPattern="";_mode;get mode(){return this._mode}set mode(t){t!==this._mode&&(this._mode=t,this.widget&&(this.widget.mode=this._mode),this.tree.refilter(),this.render(),this._onDidChangeMode.fire(t))}_matchType;get matchType(){return this._matchType}set matchType(t){t!==this._matchType&&(this._matchType=t,this.widget&&(this.widget.matchType=this._matchType),this.tree.refilter(),this.render(),this._onDidChangeMatchType.fire(t))}widget;width=0;_onDidChangeMode=new f;onDidChangeMode=this._onDidChangeMode.event;_onDidChangeMatchType=new f;onDidChangeMatchType=this._onDidChangeMatchType.event;_onDidChangePattern=new f;onDidChangePattern=this._onDidChangePattern.event;_onDidChangeOpenState=new f;onDidChangeOpenState=this._onDidChangeOpenState.event;enabledDisposables=new v;disposables=new v;updateOptions(t={}){t.defaultFindMode!==void 0&&(this.mode=t.defaultFindMode),t.defaultFindMatchType!==void 0&&(this.matchType=t.defaultFindMatchType)}isOpened(){return!!this.widget}open(){if(this.widget){this.widget.focus(),this.widget.select();return}this.widget=new nt(this.view.getHTMLElement(),this.tree,this.contextViewProvider,this.mode,this.matchType,{...this.options,history:this._history}),this.enabledDisposables.add(this.widget),this.widget.onDidChangeValue(this.onDidChangeValue,this,this.enabledDisposables),this.widget.onDidChangeMode(t=>this.mode=t,void 0,this.enabledDisposables),this.widget.onDidChangeMatchType(t=>this.matchType=t,void 0,this.enabledDisposables),this.widget.onDidDisable(this.close,this,this.enabledDisposables),this.widget.layout(this.width),this.widget.focus(),this.widget.value=this.previousPattern,this.widget.select(),this._onDidChangeOpenState.fire(!0)}close(){this.widget&&(this._history=this.widget.getHistory(),this.widget=void 0,this.enabledDisposables.clear(),this.previousPattern=this.pattern,this.onDidChangeValue(""),this.tree.domFocus(),this._onDidChangeOpenState.fire(!1))}onDidChangeValue(t){this._pattern=t,this._onDidChangePattern.fire(t),this.filter.pattern=t,this.tree.refilter(),t&&this.tree.focusNext(0,!0,void 0,i=>!R.isDefault(i.filterData));const e=this.tree.getFocus();if(e.length>0){const i=e[0];this.tree.getRelativeTop(i)===null&&this.tree.reveal(i,.5)}this.render()}render(){const t=this.filter.totalCount>0&&this.filter.matchCount===0;this.pattern&&t?(le(y("replFindNoResults","No results")),this.tree.options.showNotFoundMessage??!0?this.widget?.showMessage({type:te.WARNING,content:y("not found","No elements found.")}):this.widget?.showMessage({type:te.WARNING})):(this.widget?.clearMessage(),this.pattern&&le(y("replFindResults","{0} results",this.filter.matchCount)))}shouldAllowFocus(t){return!this.widget||!this.pattern||this.filter.totalCount>0&&this.filter.matchCount<=1?!0:!R.isDefault(t.filterData)}layout(t){this.width=t,this.widget?.layout(t)}dispose(){this._history=void 0,this._onDidChangePattern.dispose(),this.enabledDisposables.dispose(),this.disposables.dispose()}}function rt(a,t){return a.position===t.position&&ae(a,t)}function ae(a,t){return a.node.element===t.node.element&&a.startIndex===t.startIndex&&a.height===t.height&&a.endIndex===t.endIndex}class lt{constructor(t=[]){this.stickyNodes=t}get count(){return this.stickyNodes.length}equal(t){return K(this.stickyNodes,t.stickyNodes,rt)}lastNodePartiallyVisible(){if(this.count===0)return!1;const t=this.stickyNodes[this.count-1];if(this.count===1)return t.position!==0;const e=this.stickyNodes[this.count-2];return e.position+e.height!==t.position}animationStateChanged(t){if(!K(this.stickyNodes,t.stickyNodes,ae)||this.count===0)return!1;const e=this.stickyNodes[this.count-1],i=t.stickyNodes[t.count-1];return e.position!==i.position}}class at{constrainStickyScrollNodes(t,e,i){for(let n=0;n<t.length;n++){const o=t[n];if(o.position+o.height>i||n>=e)return t.slice(0,n)}return t}}class de extends F{constructor(e,i,n,o,s,r={}){super();this.tree=e;this.model=i;this.view=n;this.treeDelegate=s;const l=this.validateStickySettings(r);this.stickyScrollMaxItemCount=l.stickyScrollMaxItemCount,this.stickyScrollDelegate=r.stickyScrollDelegate??new at,this._widget=this._register(new dt(n.getScrollableElement(),n,e,o,s,r.accessibilityProvider)),this.onDidChangeHasFocus=this._widget.onDidChangeHasFocus,this.onContextMenu=this._widget.onContextMenu,this._register(n.onDidScroll(()=>this.update())),this._register(n.onDidChangeContentHeight(()=>this.update())),this._register(e.onDidChangeCollapseState(()=>this.update())),this.update()}onDidChangeHasFocus;onContextMenu;stickyScrollDelegate;stickyScrollMaxItemCount;maxWidgetViewRatio=.4;_widget;get height(){return this._widget.height}get count(){return this._widget.count}getNode(e){return this._widget.getNode(e)}getNodeAtHeight(e){let i;if(e===0?i=this.view.firstVisibleIndex:i=this.view.indexAt(e+this.view.scrollTop),!(i<0||i>=this.view.length))return this.view.element(i)}update(){const e=this.getNodeAtHeight(0);if(!e||this.tree.scrollTop===0){this._widget.setState(void 0);return}const i=this.findStickyState(e);this._widget.setState(i)}findStickyState(e){const i=[];let n=e,o=0,s=this.getNextStickyNode(n,void 0,o);for(;s&&(i.push(s),o+=s.height,!(i.length<=this.stickyScrollMaxItemCount&&(n=this.getNextVisibleNode(s),!n)));)s=this.getNextStickyNode(n,s.node,o);const r=this.constrainStickyNodes(i);return r.length?new lt(r):void 0}getNextVisibleNode(e){return this.getNodeAtHeight(e.position+e.height)}getNextStickyNode(e,i,n){const o=this.getAncestorUnderPrevious(e,i);if(o&&!(o===e&&(!this.nodeIsUncollapsedParent(e)||this.nodeTopAlignsWithStickyNodesBottom(e,n))))return this.createStickyScrollNode(o,n)}nodeTopAlignsWithStickyNodesBottom(e,i){const n=this.getNodeIndex(e),o=this.view.getElementTop(n),s=i;return this.view.scrollTop===o-s}createStickyScrollNode(e,i){const n=this.treeDelegate.getHeight(e),{startIndex:o,endIndex:s}=this.getNodeRange(e),r=this.calculateStickyNodePosition(s,i,n);return{node:e,position:r,height:n,startIndex:o,endIndex:s}}getAncestorUnderPrevious(e,i=void 0){let n=e,o=this.getParentNode(n);for(;o;){if(o===i)return n;n=o,o=this.getParentNode(n)}if(i===void 0)return n}calculateStickyNodePosition(e,i,n){let o=this.view.getRelativeTop(e);if(o===null&&this.view.firstVisibleIndex===e&&e+1<this.view.length){const c=this.treeDelegate.getHeight(this.view.element(e)),T=this.view.getRelativeTop(e+1);o=T?T-c/this.view.renderHeight:null}if(o===null)return i;const s=this.view.element(e),r=this.treeDelegate.getHeight(s),d=o*this.view.renderHeight+r;return i+n>d&&i<=d?d-n:i}constrainStickyNodes(e){if(e.length===0)return[];const i=this.view.renderHeight*this.maxWidgetViewRatio,n=e[e.length-1];if(e.length<=this.stickyScrollMaxItemCount&&n.position+n.height<=i)return e;const o=this.stickyScrollDelegate.constrainStickyScrollNodes(e,this.stickyScrollMaxItemCount,i);if(!o.length)return[];const s=o[o.length-1];if(o.length>this.stickyScrollMaxItemCount||s.position+s.height>i)throw new Error("stickyScrollDelegate violates constraints");return o}getParentNode(e){const i=this.model.getNodeLocation(e),n=this.model.getParentNodeLocation(i);return n?this.model.getNode(n):void 0}nodeIsUncollapsedParent(e){const i=this.model.getNodeLocation(e);return this.model.getListRenderCount(i)>1}getNodeIndex(e){const i=this.model.getNodeLocation(e);return this.model.getListIndex(i)}getNodeRange(e){const i=this.model.getNodeLocation(e),n=this.model.getListIndex(i);if(n<0)throw new Error("Node not found in tree");const o=this.model.getListRenderCount(i),s=n+o-1;return{startIndex:n,endIndex:s}}nodePositionTopBelowWidget(e){const i=[];let n=this.getParentNode(e);for(;n;)i.push(n),n=this.getParentNode(n);let o=0;for(let s=0;s<i.length&&s<this.stickyScrollMaxItemCount;s++)o+=this.treeDelegate.getHeight(i[s]);return o}getFocus(){return this._widget.getFocus()}domFocus(){this._widget.domFocus()}focusedLast(){return this._widget.focusedLast()}updateOptions(e={}){if(!e.stickyScrollMaxItemCount)return;const i=this.validateStickySettings(e);this.stickyScrollMaxItemCount!==i.stickyScrollMaxItemCount&&(this.stickyScrollMaxItemCount=i.stickyScrollMaxItemCount,this.update())}validateStickySettings(e){let i=7;return typeof e.stickyScrollMaxItemCount=="number"&&(i=Math.max(e.stickyScrollMaxItemCount,1)),{stickyScrollMaxItemCount:i}}setModel(e){this.model=e}}class dt{constructor(t,e,i,n,o,s){this.view=e;this.tree=i;this.treeRenderers=n;this.treeDelegate=o;this.accessibilityProvider=s;this._rootDomNode=S(".monaco-tree-sticky-container.empty"),t.appendChild(this._rootDomNode);const r=S(".monaco-tree-sticky-container-shadow");this._rootDomNode.appendChild(r),this.stickyScrollFocus=new ct(this._rootDomNode,e),this.onDidChangeHasFocus=this.stickyScrollFocus.onDidChangeHasFocus,this.onContextMenu=this.stickyScrollFocus.onContextMenu}_rootDomNode;_previousState;_previousElements=[];_previousStateDisposables=new v;stickyScrollFocus;onDidChangeHasFocus;onContextMenu;get height(){if(!this._previousState)return 0;const t=this._previousState.stickyNodes[this._previousState.count-1];return t.position+t.height}get count(){return this._previousState?.count??0}getNode(t){return this._previousState?.stickyNodes.find(e=>e.node===t)}setState(t){const e=!!this._previousState&&this._previousState.count>0,i=!!t&&t.count>0;if(!e&&!i||e&&i&&this._previousState.equal(t))return;if(e!==i&&this.setVisible(i),!i){this._previousState=void 0,this._previousElements=[],this._previousStateDisposables.clear();return}const n=t.stickyNodes[t.count-1];if(this._previousState&&t.animationStateChanged(this._previousState))this._previousElements[this._previousState.count-1].style.top=`${n.position}px`;else{this._previousStateDisposables.clear();const o=Array(t.count);for(let s=t.count-1;s>=0;s--){const r=t.stickyNodes[s],{element:l,disposable:d}=this.createElement(r,s,t.count);o[s]=l,this._rootDomNode.appendChild(l),this._previousStateDisposables.add(d)}this.stickyScrollFocus.updateElements(o,t),this._previousElements=o}this._previousState=t,this._rootDomNode.style.height=`${n.position+n.height}px`}createElement(t,e,i){const n=t.startIndex,o=document.createElement("div");o.style.top=`${t.position}px`,this.tree.options.setRowHeight!==!1&&(o.style.height=`${t.height}px`),this.tree.options.setRowLineHeight!==!1&&(o.style.lineHeight=`${t.height}px`),o.classList.add("monaco-tree-sticky-row"),o.classList.add("monaco-list-row"),o.setAttribute("data-index",`${n}`),o.setAttribute("data-parity",n%2===0?"even":"odd"),o.setAttribute("id",this.view.getElementID(n));const s=this.setAccessibilityAttributes(o,t.node.element,e,i),r=this.treeDelegate.getTemplateId(t.node),l=this.treeRenderers.find(C=>C.templateId===r);if(!l)throw new Error(`No renderer found for template id ${r}`);let d=t.node;d===this.tree.getNode(this.tree.getNodeLocation(t.node))&&(d=new Proxy(t.node,{}));const c=l.renderTemplate(o);l.renderElement(d,t.startIndex,c,t.height);const T=q(()=>{s.dispose(),l.disposeElement(d,t.startIndex,c,t.height),l.disposeTemplate(c),o.remove()});return{element:o,disposable:T}}setAccessibilityAttributes(t,e,i,n){if(!this.accessibilityProvider)return F.None;this.accessibilityProvider.getSetSize&&t.setAttribute("aria-setsize",String(this.accessibilityProvider.getSetSize(e,i,n))),this.accessibilityProvider.getPosInSet&&t.setAttribute("aria-posinset",String(this.accessibilityProvider.getPosInSet(e,i))),this.accessibilityProvider.getRole&&t.setAttribute("role",this.accessibilityProvider.getRole(e)??"treeitem");const o=this.accessibilityProvider.getAriaLabel(e),s=o&&typeof o!="string"?o:Ke(o),r=Ge(d=>{const c=d.readObservable(s);c?t.setAttribute("aria-label",c):t.removeAttribute("aria-label")});typeof o=="string"||o&&t.setAttribute("aria-label",o.get());const l=this.accessibilityProvider.getAriaLevel&&this.accessibilityProvider.getAriaLevel(e);return typeof l=="number"&&t.setAttribute("aria-level",`${l}`),t.setAttribute("aria-selected",String(!1)),r}setVisible(t){this._rootDomNode.classList.toggle("empty",!t),t||this.stickyScrollFocus.updateElements([],void 0)}getFocus(){return this.stickyScrollFocus.getFocus()}domFocus(){this.stickyScrollFocus.domFocus()}focusedLast(){return this.stickyScrollFocus.focusedLast()}dispose(){this.stickyScrollFocus.dispose(),this._previousStateDisposables.dispose(),this._rootDomNode.remove()}}class ct extends F{constructor(e,i){super();this.container=e;this.view=i;this._register(Z(this.container,"focus",()=>this.onFocus())),this._register(Z(this.container,"blur",()=>this.onBlur())),this._register(this.view.onDidFocus(()=>this.toggleStickyScrollFocused(!1))),this._register(this.view.onKeyDown(n=>this.onKeyDown(n))),this._register(this.view.onMouseDown(n=>this.onMouseDown(n))),this._register(this.view.onContextMenu(n=>this.handleContextMenu(n)))}focusedIndex=-1;elements=[];state;_onDidChangeHasFocus=new f;onDidChangeHasFocus=this._onDidChangeHasFocus.event;_onContextMenu=new f;onContextMenu=this._onContextMenu.event;_domHasFocus=!1;get domHasFocus(){return this._domHasFocus}set domHasFocus(e){e!==this._domHasFocus&&(this._onDidChangeHasFocus.fire(e),this._domHasFocus=e)}handleContextMenu(e){const i=e.browserEvent.target;if(!E(i)&&!x(i)){this.focusedLast()&&this.view.domFocus();return}if(!I(e.browserEvent)){if(!this.state)throw new Error("Context menu should not be triggered when state is undefined");const r=this.state.stickyNodes.findIndex(l=>l.node.element===e.element?.element);if(r===-1)throw new Error("Context menu should not be triggered when element is not in sticky scroll widget");this.container.focus(),this.setFocus(r);return}if(!this.state||this.focusedIndex<0)throw new Error("Context menu key should not be triggered when focus is not in sticky scroll widget");const o=this.state.stickyNodes[this.focusedIndex].node.element,s=this.elements[this.focusedIndex];this._onContextMenu.fire({element:o,anchor:s,browserEvent:e.browserEvent,isStickyScroll:!0})}onKeyDown(e){if(this.domHasFocus&&this.state){if(e.key==="ArrowUp")this.setFocusedElement(Math.max(0,this.focusedIndex-1)),e.preventDefault(),e.stopPropagation();else if(e.key==="ArrowDown"||e.key==="ArrowRight"){if(this.focusedIndex>=this.state.count-1){const i=this.state.stickyNodes[this.state.count-1].startIndex+1;this.view.domFocus(),this.view.setFocus([i]),this.scrollNodeUnderWidget(i,this.state)}else this.setFocusedElement(this.focusedIndex+1);e.preventDefault(),e.stopPropagation()}}}onMouseDown(e){const i=e.browserEvent.target;!E(i)&&!x(i)||(e.browserEvent.preventDefault(),e.browserEvent.stopPropagation())}updateElements(e,i){if(i&&i.count===0)throw new Error("Sticky scroll state must be undefined when there are no sticky nodes");if(i&&i.count!==e.length)throw new Error("Sticky scroll focus received illigel state");const n=this.focusedIndex;if(this.removeFocus(),this.elements=e,this.state=i,i){const o=V(n,0,i.count-1);this.setFocus(o)}else this.domHasFocus&&this.view.domFocus();this.container.tabIndex=i?0:-1}setFocusedElement(e){const i=this.state;if(!i)throw new Error("Cannot set focus when state is undefined");if(this.setFocus(e),!(e<i.count-1)&&i.lastNodePartiallyVisible()){const n=i.stickyNodes[e];this.scrollNodeUnderWidget(n.endIndex+1,i)}}scrollNodeUnderWidget(e,i){const n=i.stickyNodes[i.count-1],o=i.count>1?i.stickyNodes[i.count-2]:void 0,s=this.view.getElementTop(e),r=o?o.position+o.height+n.height:n.height;this.view.scrollTop=s-r}getFocus(){if(!(!this.state||this.focusedIndex===-1))return this.state.stickyNodes[this.focusedIndex].node.element}domFocus(){if(!this.state)throw new Error("Cannot focus when state is undefined");this.container.focus()}focusedLast(){return this.state?this.view.getHTMLElement().classList.contains("sticky-scroll-focused"):!1}removeFocus(){this.focusedIndex!==-1&&(this.toggleElementFocus(this.elements[this.focusedIndex],!1),this.focusedIndex=-1)}setFocus(e){if(0>e)throw new Error("addFocus() can not remove focus");if(!this.state&&e>=0)throw new Error("Cannot set focus index when state is undefined");if(this.state&&e>=this.state.count)throw new Error("Cannot set focus index to an index that does not exist");const i=this.focusedIndex;i>=0&&this.toggleElementFocus(this.elements[i],!1),e>=0&&this.toggleElementFocus(this.elements[e],!0),this.focusedIndex=e}toggleElementFocus(e,i){this.toggleElementActiveFocus(e,i&&this.domHasFocus),this.toggleElementPassiveFocus(e,i)}toggleCurrentElementActiveFocus(e){this.focusedIndex!==-1&&this.toggleElementActiveFocus(this.elements[this.focusedIndex],e)}toggleElementActiveFocus(e,i){e.classList.toggle("focused",i)}toggleElementPassiveFocus(e,i){e.classList.toggle("passive-focused",i)}toggleStickyScrollFocused(e){this.view.getHTMLElement().classList.toggle("sticky-scroll-focused",e)}onFocus(){if(!this.state||this.elements.length===0)throw new Error("Cannot focus when state is undefined or elements are empty");this.domHasFocus=!0,this.toggleStickyScrollFocused(!0),this.toggleCurrentElementActiveFocus(!0),this.focusedIndex===-1&&this.setFocus(0)}onBlur(){this.domHasFocus=!1,this.toggleCurrentElementActiveFocus(!1)}dispose(){this.toggleStickyScrollFocused(!1),this._onDidChangeHasFocus.fire(!1),super.dispose()}}function w(a){let t=k.Unknown;return $(a.browserEvent.target,"monaco-tl-twistie","monaco-tl-row")?t=k.Twistie:$(a.browserEvent.target,"monaco-tl-contents","monaco-tl-row")?t=k.Element:$(a.browserEvent.target,"monaco-tree-type-filter","monaco-list")&&(t=k.Filter),{browserEvent:a.browserEvent,element:a.element?a.element.element:null,target:t}}function ht(a){const t=E(a.browserEvent.target);return{element:a.element?a.element.element:null,browserEvent:a.browserEvent,anchor:a.anchor,isStickyScroll:t}}function B(a,t){t(a),a.children.forEach(e=>B(e,t))}class X{constructor(t,e){this.getFirstViewElementWithTrait=t;this.identityProvider=e}nodes=[];elements;_onDidChange=new f;onDidChange=this._onDidChange.event;_nodeSet;get nodeSet(){return this._nodeSet||(this._nodeSet=this.createNodeSet()),this._nodeSet}set(t,e){!e?.__forceEvent&&K(this.nodes,t)||this._set(t,!1,e)}_set(t,e,i){if(this.nodes=[...t],this.elements=void 0,this._nodeSet=void 0,!e){const n=this;this._onDidChange.fire({get elements(){return n.get()},browserEvent:i})}}get(){return this.elements||(this.elements=this.nodes.map(t=>t.element)),[...this.elements]}getNodes(){return this.nodes}has(t){return this.nodeSet.has(t)}onDidModelSplice({insertedNodes:t,deletedNodes:e}){if(!this.identityProvider){const l=this.createNodeSet(),d=c=>l.delete(c);e.forEach(c=>B(c,d)),this.set([...l.values()]);return}const i=new Set,n=l=>i.add(this.identityProvider.getId(l.element).toString());e.forEach(l=>B(l,n));const o=new Map,s=l=>o.set(this.identityProvider.getId(l.element).toString(),l);t.forEach(l=>B(l,s));const r=[];for(const l of this.nodes){const d=this.identityProvider.getId(l.element).toString();if(!i.has(d))r.push(l);else{const T=o.get(d);T&&T.visible&&r.push(T)}}if(this.nodes.length>0&&r.length===0){const l=this.getFirstViewElementWithTrait();l&&r.push(l)}this._set(r,!0)}createNodeSet(){const t=new Set;for(const e of this.nodes)t.add(e);return t}}class ut extends Ee{constructor(e,i,n){super(e);this.tree=i;this.stickyScrollProvider=n}onViewPointer(e){if(Fe(e.browserEvent.target)||ee(e.browserEvent.target)||Ce(e.browserEvent.target)||e.browserEvent.isHandledByList)return;const i=e.element;if(!i)return super.onViewPointer(e);if(this.isSelectionRangeChangeEvent(e)||this.isSelectionSingleChangeEvent(e))return super.onViewPointer(e);const n=e.browserEvent.target,o=n.classList.contains("monaco-tl-twistie")||n.classList.contains("monaco-icon-label")&&n.classList.contains("folder-icon")&&e.browserEvent.offsetX<16,s=x(e.browserEvent.target);let r=!1;if(s?r=!0:typeof this.tree.expandOnlyOnTwistieClick=="function"?r=this.tree.expandOnlyOnTwistieClick(i.element):r=!!this.tree.expandOnlyOnTwistieClick,s)this.handleStickyScrollMouseEvent(e,i);else{if(r&&!o&&e.browserEvent.detail!==2)return super.onViewPointer(e);if(!this.tree.expandOnDoubleClick&&e.browserEvent.detail===2)return super.onViewPointer(e)}if(i.collapsible&&(!s||o)){const l=this.tree.getNodeLocation(i),d=e.browserEvent.altKey;if(this.tree.setFocus([l]),this.tree.toggleCollapsed(l,d),o){e.browserEvent.isHandledByList=!0;return}}s||super.onViewPointer(e)}handleStickyScrollMouseEvent(e,i){if(we(e.browserEvent.target)||Ie(e.browserEvent.target))return;const n=this.stickyScrollProvider();if(!n)throw new Error("Sticky scroll controller not found");const o=this.list.indexOf(i),s=this.list.getElementTop(o),r=n.nodePositionTopBelowWidget(i);this.tree.scrollTop=s-r,this.list.domFocus(),this.list.setFocus([o]),this.list.setSelection([o])}onDoubleClick(e){e.browserEvent.target.classList.contains("monaco-tl-twistie")||!this.tree.expandOnDoubleClick||e.browserEvent.isHandledByList||super.onDoubleClick(e)}onMouseDown(e){const i=e.browserEvent.target;if(!E(i)&&!x(i)){super.onMouseDown(e);return}}onContextMenu(e){const i=e.browserEvent.target;if(!E(i)&&!x(i)){super.onContextMenu(e);return}}}class Tt extends Ne{constructor(e,i,n,o,s,r,l,d){super(e,i,n,o,d);this.focusTrait=s;this.selectionTrait=r;this.anchorTrait=l}createMouseController(e){return new ut(this,e.tree,e.stickyScrollProvider)}splice(e,i,n=[]){if(super.splice(e,i,n),n.length===0)return;const o=[],s=[];let r;n.forEach((l,d)=>{this.focusTrait.has(l)&&o.push(e+d),this.selectionTrait.has(l)&&s.push(e+d),this.anchorTrait.has(l)&&(r=e+d)}),o.length>0&&super.setFocus(ne([...super.getFocus(),...o])),s.length>0&&super.setSelection(ne([...super.getSelection(),...s])),typeof r=="number"&&super.setAnchor(r)}setFocus(e,i,n=!1){super.setFocus(e,i),n||this.focusTrait.set(e.map(o=>this.element(o)),i)}setSelection(e,i,n=!1){super.setSelection(e,i),n||this.selectionTrait.set(e.map(o=>this.element(o)),i)}setAnchor(e,i=!1){super.setAnchor(e),i||(typeof e>"u"?this.anchorTrait.set([]):this.anchorTrait.set([this.element(e)]))}}var pt=(e=>(e[e.Tree=0]="Tree",e[e.StickyScroll=1]="StickyScroll",e))(pt||{});class xi{constructor(t,e,i,n,o={}){this._user=t;this._options=o;let s;o.keyboardNavigationLabelProvider&&(s=new Qe(this,o.keyboardNavigationLabelProvider,o.filter),o={...o,filter:s},this.disposables.add(s)),this.model=this.createModel(t,o),this.treeDelegate=new Xe(i);const r=this.disposables.add(new Je(this.onDidChangeActiveNodesRelay.event)),l=new Ve;this.renderers=n.map(d=>new W(d,this.model,this.onDidChangeCollapseStateRelay.event,r,l,o));for(const d of this.renderers)this.disposables.add(d);if(this.focus=new X(()=>this.view.getFocusedElements()[0],o.identityProvider),this.selection=new X(()=>this.view.getSelectedElements()[0],o.identityProvider),this.anchor=new X(()=>this.view.getAnchorElement(),o.identityProvider),this.view=new Tt(t,e,this.treeDelegate,this.renderers,this.focus,this.selection,this.anchor,{...Ye(()=>this.model,o),tree:this,stickyScrollProvider:()=>this.stickyScrollController}),this.setupModel(this.model),o.keyboardSupport!==!1){const d=u.chain(this.view.onKeyDown,c=>c.filter(T=>!ee(T.target)).map(T=>new G(T)));u.chain(d,c=>c.filter(T=>T.keyCode===m.LeftArrow))(this.onLeftArrow,this,this.disposables),u.chain(d,c=>c.filter(T=>T.keyCode===m.RightArrow))(this.onRightArrow,this,this.disposables),u.chain(d,c=>c.filter(T=>T.keyCode===m.Space))(this.onSpace,this,this.disposables)}if((o.findWidgetEnabled??!0)&&o.keyboardNavigationLabelProvider&&o.contextViewProvider){const d=this.options.findWidgetStyles?{styles:this.options.findWidgetStyles}:void 0;this.findController=new st(this,this.view,s,o.contextViewProvider,d),this.focusNavigationFilter=c=>this.findController.shouldAllowFocus(c),this.onDidChangeFindOpenState=this.findController.onDidChangeOpenState,this.disposables.add(this.findController),this.onDidChangeFindMode=this.findController.onDidChangeMode,this.onDidChangeFindMatchType=this.findController.onDidChangeMatchType,this.disposables.add(this.onDidSpliceModelRelay.event(()=>{!this.findController.isOpened()||this.findController.pattern.length===0||(this.refilter(),this.findController.render())}))}else this.onDidChangeFindMode=u.None,this.onDidChangeFindMatchType=u.None;o.enableStickyScroll&&(this.stickyScrollController=new de(this,this.model,this.view,this.renderers,this.treeDelegate,o),this.onDidChangeStickyScrollFocused=this.stickyScrollController.onDidChangeHasFocus),this.styleElement=me(this.view.getHTMLElement()),this.getHTMLElement().classList.toggle("always",this._options.renderIndentGuides==="always")}view;renderers;model;treeDelegate;focus;selection;anchor;eventBufferer=new Be;findController;onDidChangeFindOpenState=u.None;onDidChangeStickyScrollFocused=u.None;focusNavigationFilter;stickyScrollController;styleElement;disposables=new v;get onDidScroll(){return this.view.onDidScroll}get onDidChangeFocus(){return this.eventBufferer.wrapEvent(this.focus.onDidChange)}get onDidChangeSelection(){return this.eventBufferer.wrapEvent(this.selection.onDidChange)}get onMouseClick(){return u.map(this.view.onMouseClick,w)}get onMouseDblClick(){return u.filter(u.map(this.view.onMouseDblClick,w),t=>t.target!==k.Filter)}get onMouseOver(){return u.map(this.view.onMouseOver,w)}get onMouseOut(){return u.map(this.view.onMouseOut,w)}get onContextMenu(){return u.any(u.filter(u.map(this.view.onContextMenu,ht),t=>!t.isStickyScroll),this.stickyScrollController?.onContextMenu??u.None)}get onTap(){return u.map(this.view.onTap,w)}get onPointer(){return u.map(this.view.onPointer,w)}get onKeyDown(){return this.view.onKeyDown}get onKeyUp(){return this.view.onKeyUp}get onKeyPress(){return this.view.onKeyPress}get onDidFocus(){return this.view.onDidFocus}get onDidBlur(){return this.view.onDidBlur}onDidSwapModel=this.disposables.add(new f);onDidChangeModelRelay=this.disposables.add(new L);onDidSpliceModelRelay=this.disposables.add(new L);onDidChangeCollapseStateRelay=this.disposables.add(new L);onDidChangeRenderNodeCountRelay=this.disposables.add(new L);onDidChangeActiveNodesRelay=this.disposables.add(new L);get onDidChangeModel(){return u.any(this.onDidChangeModelRelay.event,this.onDidSwapModel.event)}get onDidChangeCollapseState(){return this.model.onDidChangeCollapseState}get onDidChangeRenderNodeCount(){return this.model.onDidChangeRenderNodeCount}_onWillRefilter=new f;onWillRefilter=this._onWillRefilter.event;get findMode(){return this.findController?.mode??0}set findMode(t){this.findController&&(this.findController.mode=t)}onDidChangeFindMode;get findMatchType(){return this.findController?.matchType??0}set findMatchType(t){this.findController&&(this.findController.matchType=t)}onDidChangeFindMatchType;get onDidChangeFindPattern(){return this.findController?this.findController.onDidChangePattern:u.None}get expandOnDoubleClick(){return typeof this._options.expandOnDoubleClick>"u"?!0:this._options.expandOnDoubleClick}get expandOnlyOnTwistieClick(){return typeof this._options.expandOnlyOnTwistieClick>"u"?!0:this._options.expandOnlyOnTwistieClick}_onDidUpdateOptions=new f;onDidUpdateOptions=this._onDidUpdateOptions.event;get onDidDispose(){return this.view.onDidDispose}updateOptions(t={}){this._options={...this._options,...t};for(const e of this.renderers)e.updateOptions(t);this.view.updateOptions(this._options),this.findController?.updateOptions(t),this.updateStickyScroll(t),this._onDidUpdateOptions.fire(this._options),this.getHTMLElement().classList.toggle("always",this._options.renderIndentGuides==="always")}get options(){return this._options}updateStickyScroll(t){!this.stickyScrollController&&this._options.enableStickyScroll?(this.stickyScrollController=new de(this,this.model,this.view,this.renderers,this.treeDelegate,this._options),this.onDidChangeStickyScrollFocused=this.stickyScrollController.onDidChangeHasFocus):this.stickyScrollController&&!this._options.enableStickyScroll&&(this.onDidChangeStickyScrollFocused=u.None,this.stickyScrollController.dispose(),this.stickyScrollController=void 0),this.stickyScrollController?.updateOptions(t)}updateWidth(t){const e=this.model.getListIndex(t);e!==-1&&this.view.updateWidth(e)}getHTMLElement(){return this.view.getHTMLElement()}get contentHeight(){return this.view.contentHeight}get contentWidth(){return this.view.contentWidth}get onDidChangeContentHeight(){return this.view.onDidChangeContentHeight}get onDidChangeContentWidth(){return this.view.onDidChangeContentWidth}get scrollTop(){return this.view.scrollTop}set scrollTop(t){this.view.scrollTop=t}get scrollLeft(){return this.view.scrollLeft}set scrollLeft(t){this.view.scrollLeft=t}get scrollHeight(){return this.view.scrollHeight}get renderHeight(){return this.view.renderHeight}get firstVisibleElement(){let t=this.view.firstVisibleIndex;return this.stickyScrollController&&(t+=this.stickyScrollController.count),t<0||t>=this.view.length?void 0:this.view.element(t).element}get lastVisibleElement(){const t=this.view.lastVisibleIndex;return this.view.element(t).element}get ariaLabel(){return this.view.ariaLabel}set ariaLabel(t){this.view.ariaLabel=t}get selectionSize(){return this.selection.getNodes().length}domFocus(){this.stickyScrollController?.focusedLast()?this.stickyScrollController.domFocus():this.view.domFocus()}isDOMFocused(){return ye(this.getHTMLElement())}layout(t,e){this.view.layout(t,e),ze(e)&&this.findController?.layout(e)}style(t){const e=`.${this.view.domId}`,i=[];t.treeIndentGuidesStroke&&(i.push(`.monaco-list${e}:hover .monaco-tl-indent > .indent-guide, .monaco-list${e}.always .monaco-tl-indent > .indent-guide  { border-color: ${t.treeInactiveIndentGuidesStroke}; }`),i.push(`.monaco-list${e} .monaco-tl-indent > .indent-guide.active { border-color: ${t.treeIndentGuidesStroke}; }`));const n=t.treeStickyScrollBackground??t.listBackground;n&&(i.push(`.monaco-list${e} .monaco-scrollable-element .monaco-tree-sticky-container { background-color: ${n}; }`),i.push(`.monaco-list${e} .monaco-scrollable-element .monaco-tree-sticky-container .monaco-tree-sticky-row { background-color: ${n}; }`)),t.treeStickyScrollBorder&&i.push(`.monaco-list${e} .monaco-scrollable-element .monaco-tree-sticky-container { border-bottom: 1px solid ${t.treeStickyScrollBorder}; }`),t.treeStickyScrollShadow&&i.push(`.monaco-list${e} .monaco-scrollable-element .monaco-tree-sticky-container .monaco-tree-sticky-container-shadow { box-shadow: ${t.treeStickyScrollShadow} 0 6px 6px -6px inset; height: 3px; }`),t.listFocusForeground&&(i.push(`.monaco-list${e}.sticky-scroll-focused .monaco-scrollable-element .monaco-tree-sticky-container:focus .monaco-list-row.focused { color: ${t.listFocusForeground}; }`),i.push(`.monaco-list${e}:not(.sticky-scroll-focused) .monaco-scrollable-element .monaco-tree-sticky-container .monaco-list-row.focused { color: inherit; }`));const o=Q(t.listFocusAndSelectionOutline,Q(t.listSelectionOutline,t.listFocusOutline??""));o&&(i.push(`.monaco-list${e}.sticky-scroll-focused .monaco-scrollable-element .monaco-tree-sticky-container:focus .monaco-list-row.focused.selected { outline: 1px solid ${o}; outline-offset: -1px;}`),i.push(`.monaco-list${e}:not(.sticky-scroll-focused) .monaco-scrollable-element .monaco-tree-sticky-container .monaco-list-row.focused.selected { outline: inherit;}`)),t.listFocusOutline&&(i.push(`.monaco-list${e}.sticky-scroll-focused .monaco-scrollable-element .monaco-tree-sticky-container:focus .monaco-list-row.focused { outline: 1px solid ${t.listFocusOutline}; outline-offset: -1px; }`),i.push(`.monaco-list${e}:not(.sticky-scroll-focused) .monaco-scrollable-element .monaco-tree-sticky-container .monaco-list-row.focused { outline: inherit; }`),i.push(`.monaco-workbench.context-menu-visible .monaco-list${e}.last-focused.sticky-scroll-focused .monaco-scrollable-element .monaco-tree-sticky-container .monaco-list-row.passive-focused { outline: 1px solid ${t.listFocusOutline}; outline-offset: -1px; }`),i.push(`.monaco-workbench.context-menu-visible .monaco-list${e}.last-focused.sticky-scroll-focused .monaco-list-rows .monaco-list-row.focused { outline: inherit; }`),i.push(`.monaco-workbench.context-menu-visible .monaco-list${e}.last-focused:not(.sticky-scroll-focused) .monaco-tree-sticky-container .monaco-list-rows .monaco-list-row.focused { outline: inherit; }`)),this.styleElement.textContent=i.join(`
`),this.view.style(t)}getParentElement(t){const e=this.model.getParentNodeLocation(t);return this.model.getNode(e).element}getFirstElementChild(t){return this.model.getFirstElementChild(t)}getNode(t){return this.model.getNode(t)}getNodeLocation(t){return this.model.getNodeLocation(t)}collapse(t,e=!1){return this.model.setCollapsed(t,!0,e)}expand(t,e=!1){return this.model.setCollapsed(t,!1,e)}toggleCollapsed(t,e=!1){return this.model.setCollapsed(t,void 0,e)}expandAll(){this.model.setCollapsed(this.model.rootRef,!1,!0)}collapseAll(){this.model.setCollapsed(this.model.rootRef,!0,!0)}isCollapsible(t){return this.model.isCollapsible(t)}setCollapsible(t,e){return this.model.setCollapsible(t,e)}isCollapsed(t){return this.model.isCollapsed(t)}expandTo(t){this.model.expandTo(t)}triggerTypeNavigation(){this.view.triggerTypeNavigation()}openFind(){this.findController?.open()}closeFind(){this.findController?.close()}refilter(){this._onWillRefilter.fire(void 0),this.model.refilter()}setAnchor(t){if(typeof t>"u")return this.view.setAnchor(void 0);this.eventBufferer.bufferEvents(()=>{const e=this.model.getNode(t);this.anchor.set([e]);const i=this.model.getListIndex(t);i>-1&&this.view.setAnchor(i,!0)})}getAnchor(){return this.anchor.get().at(0)}setSelection(t,e){this.eventBufferer.bufferEvents(()=>{const i=t.map(o=>this.model.getNode(o));this.selection.set(i,e);const n=t.map(o=>this.model.getListIndex(o)).filter(o=>o>-1);this.view.setSelection(n,e,!0)})}getSelection(){return this.selection.get()}setFocus(t,e){this.eventBufferer.bufferEvents(()=>{const i=t.map(o=>this.model.getNode(o));this.focus.set(i,e);const n=t.map(o=>this.model.getListIndex(o)).filter(o=>o>-1);this.view.setFocus(n,e,!0)})}focusNext(t=1,e=!1,i,n=I(i)&&i.altKey?void 0:this.focusNavigationFilter){this.view.focusNext(t,e,i,n)}focusPrevious(t=1,e=!1,i,n=I(i)&&i.altKey?void 0:this.focusNavigationFilter){this.view.focusPrevious(t,e,i,n)}focusNextPage(t,e=I(t)&&t.altKey?void 0:this.focusNavigationFilter){return this.view.focusNextPage(t,e)}focusPreviousPage(t,e=I(t)&&t.altKey?void 0:this.focusNavigationFilter){return this.view.focusPreviousPage(t,e,()=>this.stickyScrollController?.height??0)}focusLast(t,e=I(t)&&t.altKey?void 0:this.focusNavigationFilter){this.view.focusLast(t,e)}focusFirst(t,e=I(t)&&t.altKey?void 0:this.focusNavigationFilter){this.view.focusFirst(t,e)}getFocus(){return this.focus.get()}getStickyScrollFocus(){const t=this.stickyScrollController?.getFocus();return t!==void 0?[t]:[]}getFocusedPart(){return this.stickyScrollController?.focusedLast()?1:0}reveal(t,e){this.model.expandTo(t);const i=this.model.getListIndex(t);if(i!==-1)if(!this.stickyScrollController)this.view.reveal(i,e);else{const n=this.stickyScrollController.nodePositionTopBelowWidget(this.getNode(t));this.view.reveal(i,e,n)}}getRelativeTop(t){const e=this.model.getListIndex(t);if(e===-1)return null;const i=this.stickyScrollController?.getNode(this.getNode(t));return this.view.getRelativeTop(e,i?.position??this.stickyScrollController?.height)}getViewState(t=this.options.identityProvider){if(!t)throw new Re(this._user,"Can't get tree view state without an identity provider");const e=s=>t.getId(s).toString(),i=A.empty(this.scrollTop);for(const s of this.getFocus())i.focus.add(e(s));for(const s of this.getSelection())i.selection.add(e(s));const n=this.model.getNode(),o=[n];for(;o.length>0;){const s=o.shift();s!==n&&s.collapsible&&(i.expanded[e(s.element)]=s.collapsed?0:1),o.push(...s.children)}return i}onLeftArrow(t){t.preventDefault(),t.stopPropagation();const e=this.view.getFocusedElements();if(e.length===0)return;const i=e[0],n=this.model.getNodeLocation(i);if(!this.model.setCollapsed(n,!0)){const s=this.model.getParentNodeLocation(n);if(!s)return;const r=this.model.getListIndex(s);this.view.reveal(r),this.view.setFocus([r])}}onRightArrow(t){t.preventDefault(),t.stopPropagation();const e=this.view.getFocusedElements();if(e.length===0)return;const i=e[0],n=this.model.getNodeLocation(i);if(!this.model.setCollapsed(n,!1)){if(!i.children.some(l=>l.visible))return;const[s]=this.view.getFocus(),r=s+1;this.view.reveal(r),this.view.setFocus([r])}}onSpace(t){t.preventDefault(),t.stopPropagation();const e=this.view.getFocusedElements();if(e.length===0)return;const i=e[0],n=this.model.getNodeLocation(i),o=t.browserEvent.altKey;this.model.setCollapsed(n,void 0,o)}modelDisposables=new v;setupModel(t){this.modelDisposables.clear(),this.modelDisposables.add(t.onDidSpliceRenderedNodes(({start:o,deleteCount:s,elements:r})=>this.view.splice(o,s,r)));const e=u.forEach(t.onDidSpliceModel,o=>{this.eventBufferer.bufferEvents(()=>{this.focus.onDidModelSplice(o),this.selection.onDidModelSplice(o)})},this.modelDisposables);e(()=>null,null,this.modelDisposables);const i=this.modelDisposables.add(new f),n=this.modelDisposables.add(new Pe(0));this.modelDisposables.add(u.any(e,this.focus.onDidChange,this.selection.onDidChange)(()=>{n.trigger(()=>{const o=new Set;for(const s of this.focus.getNodes())o.add(s);for(const s of this.selection.getNodes())o.add(s);i.fire([...o.values()])})})),this.onDidChangeActiveNodesRelay.input=i.event,this.onDidChangeModelRelay.input=u.signal(t.onDidSpliceModel),this.onDidChangeCollapseStateRelay.input=t.onDidChangeCollapseState,this.onDidChangeRenderNodeCountRelay.input=t.onDidChangeRenderNodeCount}setModel(t){const e=this.model;this.model=t,this.setupModel(t),this.renderers.forEach(i=>i.setModel(t)),this.stickyScrollController?.setModel(t),this.view.splice(0,e.getListRenderCount(e.rootRef)),this.model.refilter(),this.onDidSwapModel.fire()}getModel(){return this.model}navigate(t){return new gt(this.view,this.model,t)}dispose(){U(this.disposables),this.stickyScrollController?.dispose(),this.view.dispose(),this.modelDisposables.dispose()}}class gt{constructor(t,e,i){this.view=t;this.model=e;i?this.index=this.model.getListIndex(i):this.index=-1}index;current(){return this.index<0||this.index>=this.view.length?null:this.view.element(this.index).element}previous(){return this.index--,this.current()}next(){return this.index++,this.current()}first(){return this.index=0,this.current()}last(){return this.index=this.view.length-1,this.current()}}export{xi as AbstractTree,pt as AbstractTreePart,A as AbstractTreeViewState,Xe as ComposedTreeDelegate,et as FuzzyToggle,Ze as ModeToggle,je as RenderIndentGuides,ot as TreeFindMatchType,it as TreeFindMode,W as TreeRenderer};
