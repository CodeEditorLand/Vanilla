import s from"assert";import{createScanner as p,parse as d,ParseErrorCode as y,parseTree as T,ScanError as v,SyntaxKind as e}from"../../common/json.js";import{getParseErrorMessage as k}from"../../common/jsonErrorMessages.js";import{ensureNoDisposablesAreLeakedInTestSuite as w}from"./utils.js";function t(l,...i){const f=p(l);let o;for(;(o=f.scan())!==e.EOF;)s.strictEqual(o,i.shift());s.strictEqual(i.length,0)}function L(l,i,f){const o=p(l);o.scan(),s.strictEqual(o.getToken(),i),s.strictEqual(o.getTokenError(),f)}function r(l,i,f){const o=[],c=d(l,o,f);o.length!==0&&s(!1,k(o[0].error)),s.deepStrictEqual(c,i)}function n(l,i,f){const o=[],c=d(l,o,f);s(o.length>0),s.deepStrictEqual(c,i)}function a(l,i,f=[],o){const c=[],m=T(l,c,o);s.deepStrictEqual(c.map(u=>u.error,i),f);const g=u=>{if(u.children)for(const h of u.children)s.strictEqual(u,h.parent),delete h.parent,g(h)};g(m),s.deepStrictEqual(m,i)}suite("JSON",()=>{w(),test("tokens",()=>{t("{",e.OpenBraceToken),t("}",e.CloseBraceToken),t("[",e.OpenBracketToken),t("]",e.CloseBracketToken),t(":",e.ColonToken),t(",",e.CommaToken)}),test("comments",()=>{t("// this is a comment",e.LineCommentTrivia),t(`// this is a comment
`,e.LineCommentTrivia,e.LineBreakTrivia),t("/* this is a comment*/",e.BlockCommentTrivia),t(`/* this is a \r
comment*/`,e.BlockCommentTrivia),t(`/* this is a 
comment*/`,e.BlockCommentTrivia),t("/* this is a",e.BlockCommentTrivia),t(`/* this is a 
comment`,e.BlockCommentTrivia),t("/ ttt",e.Unknown,e.Trivia,e.Unknown)}),test("strings",()=>{t('"test"',e.StringLiteral),t('"\\""',e.StringLiteral),t('"\\/"',e.StringLiteral),t('"\\b"',e.StringLiteral),t('"\\f"',e.StringLiteral),t('"\\n"',e.StringLiteral),t('"\\r"',e.StringLiteral),t('"\\t"',e.StringLiteral),t('"\\v"',e.StringLiteral),t('"\u88FF"',e.StringLiteral),t('"\u200B\u2028"',e.StringLiteral),t('"test',e.StringLiteral),t(`"test
"`,e.StringLiteral,e.LineBreakTrivia,e.StringLiteral),L('"	"',e.StringLiteral,v.InvalidCharacter),L('"	 "',e.StringLiteral,v.InvalidCharacter)}),test("numbers",()=>{t("0",e.NumericLiteral),t("0.1",e.NumericLiteral),t("-0.1",e.NumericLiteral),t("-1",e.NumericLiteral),t("1",e.NumericLiteral),t("123456789",e.NumericLiteral),t("10",e.NumericLiteral),t("90",e.NumericLiteral),t("90E+123",e.NumericLiteral),t("90e+123",e.NumericLiteral),t("90e-123",e.NumericLiteral),t("90E-123",e.NumericLiteral),t("90E123",e.NumericLiteral),t("90e123",e.NumericLiteral),t("01",e.NumericLiteral,e.NumericLiteral),t("-01",e.NumericLiteral,e.NumericLiteral),t("-",e.Unknown),t(".0",e.Unknown)}),test("keywords: true, false, null",()=>{t("true",e.TrueKeyword),t("false",e.FalseKeyword),t("null",e.NullKeyword),t("true false null",e.TrueKeyword,e.Trivia,e.FalseKeyword,e.Trivia,e.NullKeyword),t("nulllll",e.Unknown),t("True",e.Unknown),t("foo-bar",e.Unknown),t("foo bar",e.Unknown,e.Trivia,e.Unknown)}),test("trivia",()=>{t(" ",e.Trivia),t("  	  ",e.Trivia),t(`  	  
  	  `,e.Trivia,e.LineBreakTrivia,e.Trivia),t(`\r
`,e.LineBreakTrivia),t("\r",e.LineBreakTrivia),t(`
`,e.LineBreakTrivia),t(`
\r`,e.LineBreakTrivia,e.LineBreakTrivia),t(`
   
`,e.LineBreakTrivia,e.Trivia,e.LineBreakTrivia)}),test("parse: literals",()=>{r("true",!0),r("false",!1),r("null",null),r('"foo"',"foo"),r('"\\"-\\\\-\\/-\\b-\\f-\\n-\\r-\\t"',`"-\\-/-\b-\f-
-\r-	`),r('"\\u00DC"',"\xDC"),r("9",9),r("-9",-9),r("0.129",.129),r("23e3",23e3),r("1.2E+3",1200),r("1.2E-3",.0012),r("1.2E-3 // comment",.0012)}),test("parse: objects",()=>{r("{}",{}),r('{ "foo": true }',{foo:!0}),r('{ "bar": 8, "xoo": "foo" }',{bar:8,xoo:"foo"}),r('{ "hello": [], "world": {} }',{hello:[],world:{}}),r('{ "a": false, "b": true, "c": [ 7.4 ] }',{a:!1,b:!0,c:[7.4]}),r('{ "lineComment": "//", "blockComment": ["/*", "*/"], "brackets": [ ["{", "}"], ["[", "]"], ["(", ")"] ] }',{lineComment:"//",blockComment:["/*","*/"],brackets:[["{","}"],["[","]"],["(",")"]]}),r('{ "hello": [], "world": {} }',{hello:[],world:{}}),r('{ "hello": { "again": { "inside": 5 }, "world": 1 }}',{hello:{again:{inside:5},world:1}}),r('{ "foo": /*hello*/true }',{foo:!0})}),test("parse: arrays",()=>{r("[]",[]),r("[ [],  [ [] ]]",[[],[[]]]),r("[ 1, 2, 3 ]",[1,2,3]),r('[ { "a": null } ]',[{a:null}])}),test("parse: objects with errors",()=>{n("{,}",{}),n('{ "foo": true, }',{foo:!0},{allowTrailingComma:!1}),n('{ "bar": 8 "xoo": "foo" }',{bar:8,xoo:"foo"}),n('{ ,"bar": 8 }',{bar:8}),n('{ ,"bar": 8, "foo" }',{bar:8}),n('{ "bar": 8, "foo": }',{bar:8}),n('{ 8, "foo": 9 }',{foo:9})}),test("parse: array with errors",()=>{n("[,]",[]),n("[ 1, 2, ]",[1,2],{allowTrailingComma:!1}),n("[ 1 2, 3 ]",[1,2,3]),n("[ ,1, 2, 3 ]",[1,2,3]),n("[ ,1, 2, 3, ]",[1,2,3],{allowTrailingComma:!1})}),test("parse: disallow commments",()=>{const l={disallowComments:!0};r('[ 1, 2, null, "foo" ]',[1,2,null,"foo"],l),r('{ "hello": [], "world": {} }',{hello:[],world:{}},l),n('{ "foo": /*comment*/ true }',{foo:!0},l)}),test("parse: trailing comma",()=>{r('{ "hello": [], }',{hello:[]});let l={allowTrailingComma:!0};r('{ "hello": [], }',{hello:[]},l),r('{ "hello": [] }',{hello:[]},l),r('{ "hello": [], "world": {}, }',{hello:[],world:{}},l),r('{ "hello": [], "world": {} }',{hello:[],world:{}},l),r('{ "hello": [1,] }',{hello:[1]},l),l={allowTrailingComma:!1},n('{ "hello": [], }',{hello:[]},l),n('{ "hello": [], "world": {}, }',{hello:[],world:{}},l)}),test("tree: literals",()=>{a("true",{type:"boolean",offset:0,length:4,value:!0}),a("false",{type:"boolean",offset:0,length:5,value:!1}),a("null",{type:"null",offset:0,length:4,value:null}),a("23",{type:"number",offset:0,length:2,value:23}),a("-1.93e-19",{type:"number",offset:0,length:9,value:-193e-21}),a('"hello"',{type:"string",offset:0,length:7,value:"hello"})}),test("tree: arrays",()=>{a("[]",{type:"array",offset:0,length:2,children:[]}),a("[ 1 ]",{type:"array",offset:0,length:5,children:[{type:"number",offset:2,length:1,value:1}]}),a('[ 1,"x"]',{type:"array",offset:0,length:8,children:[{type:"number",offset:2,length:1,value:1},{type:"string",offset:4,length:3,value:"x"}]}),a("[[]]",{type:"array",offset:0,length:4,children:[{type:"array",offset:1,length:2,children:[]}]})}),test("tree: objects",()=>{a("{ }",{type:"object",offset:0,length:3,children:[]}),a('{ "val": 1 }',{type:"object",offset:0,length:12,children:[{type:"property",offset:2,length:8,colonOffset:7,children:[{type:"string",offset:2,length:5,value:"val"},{type:"number",offset:9,length:1,value:1}]}]}),a('{"id": "$", "v": [ null, null] }',{type:"object",offset:0,length:32,children:[{type:"property",offset:1,length:9,colonOffset:5,children:[{type:"string",offset:1,length:4,value:"id"},{type:"string",offset:7,length:3,value:"$"}]},{type:"property",offset:12,length:18,colonOffset:15,children:[{type:"string",offset:12,length:3,value:"v"},{type:"array",offset:17,length:13,children:[{type:"null",offset:19,length:4,value:null},{type:"null",offset:25,length:4,value:null}]}]}]}),a('{  "id": { "foo": { } } , }',{type:"object",offset:0,length:27,children:[{type:"property",offset:3,length:20,colonOffset:7,children:[{type:"string",offset:3,length:4,value:"id"},{type:"object",offset:9,length:14,children:[{type:"property",offset:11,length:10,colonOffset:16,children:[{type:"string",offset:11,length:5,value:"foo"},{type:"object",offset:18,length:3,children:[]}]}]}]}]},[y.PropertyNameExpected,y.ValueExpected],{allowTrailingComma:!1})})});
