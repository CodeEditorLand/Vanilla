import S from"assert";import{DisposableStore as M}from"../../../../base/common/lifecycle.js";import{ensureNoDisposablesAreLeakedInTestSuite as _}from"../../../../base/test/common/utils.js";import{TrimTrailingWhitespaceCommand as f,trimTrailingWhitespace as C}from"../../../common/commands/trimTrailingWhitespaceCommand.js";import"../../../common/core/editOperation.js";import{Position as t}from"../../../common/core/position.js";import{Range as x}from"../../../common/core/range.js";import{Selection as k}from"../../../common/core/selection.js";import{MetadataConsts as u,StandardTokenType as I}from"../../../common/encodedTokenAttributes.js";import{EncodedTokenizationResult as w,TokenizationRegistry as L}from"../../../common/languages.js";import{ILanguageService as D}from"../../../common/languages/language.js";import{NullState as F}from"../../../common/languages/nullTokenize.js";import{getEditOperation as A}from"../testCommand.js";import{createModelServices as K,instantiateTextModel as N,withEditorModel as O}from"../../common/testTextModel.js";function i(e,n,o,r=n,a=o){return{range:new x(r,a,n,o),text:e}}function s(e,n,o,r=n,a=o){return{range:new x(r,a,n,o),text:e,forceMoveMarkers:!1}}function l(e,n){return O(e,o=>{const r=new f(new k(1,1,1,1),[],!0),a=A(o,r);S.deepStrictEqual(a,n)})}function m(e,n,o){return O(e,r=>{const a=C(r,n,!0);S.deepStrictEqual(a,o)})}suite("Editor Commands - Trim Trailing Whitespace Command",()=>{let e;setup(()=>{e=new M}),teardown(()=>{e.dispose()}),_(),test("remove trailing whitespace",function(){l([""],[]),l(["text"],[]),l(["text   "],[s(null,1,5,1,8)]),l(["text	   "],[s(null,1,5,1,9)]),l(["	   "],[s(null,1,1,1,5)]),l(["text	"],[s(null,1,5,1,6)]),l(["some text	","some more text","	  ","even more text  ","and some mixed	   	"],[s(null,1,10,1,11),s(null,3,1,3,4),s(null,4,15,4,17),s(null,5,15,5,20)]),m(["text   "],[new t(1,1),new t(1,2),new t(1,3)],[i(null,1,5,1,8)]),m(["text   "],[new t(1,1),new t(1,5)],[i(null,1,5,1,8)]),m(["text   "],[new t(1,1),new t(1,5),new t(1,6)],[i(null,1,6,1,8)]),m(["some text	","some more text","	  ","even more text  ","and some mixed	   	"],[],[i(null,1,10,1,11),i(null,3,1,3,4),i(null,4,15,4,17),i(null,5,15,5,20)]),m(["some text	","some more text","	  ","even more text  ","and some mixed	   	"],[new t(1,11),new t(3,2),new t(5,1),new t(4,1),new t(5,10)],[i(null,3,2,3,4),i(null,4,15,4,17),i(null,5,15,5,20)])}),test("skips strings and regex if configured",function(){const n=K(e),o=n.get(D),r="testLanguageId",a=o.languageIdCodec;e.add(o.registerLanguage({id:r}));const E=a.encodeLanguageId(r),T=(E<<u.LANGUAGEID_OFFSET|I.Other<<u.TOKEN_TYPE_OFFSET|u.BALANCED_BRACKETS_MASK)>>>0,g=(E<<u.LANGUAGEID_OFFSET|I.String<<u.TOKEN_TYPE_OFFSET|u.BALANCED_BRACKETS_MASK)>>>0,z={getInitialState:()=>F,tokenize:void 0,tokenizeEncoded:(b,U,p)=>{switch(b){case"const a = `  ":{const d=new Uint32Array([0,T,10,g]);return new w(d,p)}case"  a string  ":{const d=new Uint32Array([0,g]);return new w(d,p)}case"`;  ":{const d=new Uint32Array([0,g,1,T]);return new w(d,p)}}throw new Error("Unexpected")}};e.add(L.register(r,z));const c=e.add(N(n,["const a = `  ","  a string  ","`;  "].join(`
`),r));c.tokenization.forceTokenization(1),c.tokenization.forceTokenization(2),c.tokenization.forceTokenization(3);const h=new f(new k(1,1,1,1),[],!1),v=A(c,h);S.deepStrictEqual(v,[s(null,3,3,3,5)])})});
