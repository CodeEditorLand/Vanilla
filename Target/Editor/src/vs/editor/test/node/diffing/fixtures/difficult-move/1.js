const o=require("gulp"),d=require("path"),j=require("event-stream"),u=require("./lib/util"),{getVersion:ee}=require("./lib/getVersion"),f=require("./lib/task"),M=require("./lib/optimize"),t=require("../product.json"),h=require("gulp-rename"),p=require("gulp-replace"),q=require("gulp-filter"),{getProductionDependencies:se}=require("./lib/dependencies"),A=require("vinyl-fs"),ne=require("../package.json"),oe=require("gulp-flatmap"),re=require("gulp-gunzip"),ie=require("vinyl"),E=require("fs"),te=require("glob"),{compileBuildTask:ce}=require("./gulpfile.compile"),{compileExtensionsBuildTask:ae,compileExtensionMediaBuildTask:de}=require("./gulpfile.extensions"),{vscodeWebEntryPoints:ue,vscodeWebResourceIncludes:le,createVSCodeWebFileContentMapper:pe}=require("./gulpfile.vscode.web"),me=require("child_process"),N=require("fancy-log"),v=d.dirname(__dirname),g=ee(v),C=d.dirname(v),be=d.join(v,"remote"),_=[{platform:"win32",arch:"ia32"},{platform:"win32",arch:"x64"},{platform:"darwin",arch:"x64"},{platform:"darwin",arch:"arm64"},{platform:"linux",arch:"x64"},{platform:"linux",arch:"armhf"},{platform:"linux",arch:"arm64"},{platform:"alpine",arch:"arm64"},{platform:"linux",arch:"alpine"}],D=["out-build/bootstrap.js","out-build/bootstrap-fork.js","out-build/bootstrap-amd.js","out-build/bootstrap-node.js","out-build/vs/base/common/performance.js","out-build/vs/platform/files/**/*.exe","out-build/vs/platform/files/**/*.md","out-build/vs/base/node/cpuUsage.sh","out-build/vs/base/node/ps.sh","out-build/vs/workbench/contrib/terminal/browser/media/shellIntegration.ps1","out-build/vs/workbench/contrib/terminal/browser/media/shellIntegration-bash.sh","out-build/vs/workbench/contrib/terminal/browser/media/shellIntegration-env.zsh","out-build/vs/workbench/contrib/terminal/browser/media/shellIntegration-profile.zsh","out-build/vs/workbench/contrib/terminal/browser/media/shellIntegration-rc.zsh","out-build/vs/workbench/contrib/terminal/browser/media/shellIntegration-login.zsh","out-build/vs/workbench/contrib/terminal/browser/media/fish_xdg_data/fish/vendor_conf.d/shellIntegration.fish","!**/test/**"],fe=[...D,...le],z=[{name:"vs/server/node/server.main",exclude:["vs/css","vs/nls"]},{name:"vs/server/node/server.cli",exclude:["vs/css","vs/nls"]},{name:"vs/workbench/api/node/extensionHostProcess",exclude:["vs/css","vs/nls"]},{name:"vs/platform/files/node/watcher/watcherMain",exclude:["vs/css","vs/nls"]},{name:"vs/platform/terminal/node/ptyHostMain",exclude:["vs/css","vs/nls"]}],he=[...z,...ue];function ve(){const s=E.readFileSync(d.join(v,"remote",".yarnrc"),"utf8"),e=/^target "(.*)"$/m.exec(s)[1],i=/^ms_build_id "(.*)"$/m.exec(s)[1];return{nodeVersion:e,internalNodeVersion:i}}function $e(s,e,i){let l;switch(e){case"win32":l=`win-${i}/node.exe`;break;case"darwin":case"linux":l=`node-v${s}-${e}-${i}.tar.gz`;break;case"alpine":l=`${e}-${i}/node`;break}const a=E.readFileSync(d.join(v,"build","checksums","nodejs.txt"),"utf8");for(const b of a.split(`
`)){const[r,c]=b.split(/\s+/);if(c===l)return r}}const{nodeVersion:m,internalNodeVersion:V}=ve();_.forEach(({platform:s,arch:e})=>{o.task(f.define(`node-${s}-${e}`,()=>{const i=d.join(".build","node",`v${m}`,`${s}-${e}`);return E.existsSync(i)?Promise.resolve(null):(u.rimraf(i),we(s,e).pipe(A.dest(i)))}))});const B=o.task(`node-${process.platform}-${process.arch}`);B&&o.task(f.define("node",B));function we(s,e){const{fetchUrls:i,fetchGithub:l}=require("./lib/fetch"),a=require("gulp-untar"),b=require("crypto");e==="ia32"?e="x86":e==="armhf"?e="armv7l":e==="alpine"&&(s="alpine",e="x64"),N(`Downloading node.js ${m} ${s} ${e} from ${t.nodejsRepository}...`);const r=$e(m,s,e);switch(r?N(`Using SHA256 checksum for checking integrity: ${r}`):N.warn("Unable to verify integrity of downloaded node.js binary because no SHA256 checksum was found!"),s){case"win32":return(t.nodejsRepository!=="https://nodejs.org"?l(t.nodejsRepository,{version:`${m}-${V}`,name:`win-${e}-node.exe`,checksumSha256:r}):i(`/dist/v${m}/win-${e}/node.exe`,{base:"https://nodejs.org",checksumSha256:r})).pipe(h("node.exe"));case"darwin":case"linux":return(t.nodejsRepository!=="https://nodejs.org"?l(t.nodejsRepository,{version:`${m}-${V}`,name:`node-v${m}-${s}-${e}.tar.gz`,checksumSha256:r}):i(`/dist/v${m}/node-v${m}-${s}-${e}.tar.gz`,{base:"https://nodejs.org",checksumSha256:r})).pipe(oe(c=>c.pipe(re()).pipe(a()))).pipe(q("**/node")).pipe(u.setExecutableBit("**")).pipe(h("node"));case"alpine":{const c=e==="arm64"?"arm64v8/node":"node";N(`Downloading node.js ${m} ${s} ${e} from docker image ${c}`);const k=me.execSync(`docker run --rm ${c}:${m}-alpine /bin/sh -c 'cat \`which node\`'`,{maxBuffer:100*1024*1024,encoding:"buffer"});if(r){const $=b.createHash("sha256").update(k).digest("hex");if($!==r)throw new Error(`Checksum mismatch for node.js from docker image (expected ${options.checksumSha256}, actual ${$}))`)}return j.readArray([new ie({path:"node",contents:k,stat:{mode:parseInt("755",8)}})])}}}function ke(s,e,i,l,a){const b=d.join(C,a);return()=>{const r=require("gulp-json-editor"),c=o.src(l+"/**",{base:"."}).pipe(h(function(n){n.dirname=n.dirname.replace(new RegExp("^"+l),"out")})).pipe(u.setExecutableBit(["**/*.sh"])).pipe(q(["**","!**/*.js.map"])),k=["debuggers","jsonValidation"],$=n=>{switch(n.extensionKind){case"ui":return!0;case"workspace":return!1;default:return!(n.main||n.contributes&&Object.keys(n.contributes).some(y=>k.indexOf(y)!==-1))}},S=te.sync("extensions/*/package.json").filter(n=>{if(s==="reh-web")return!0;const y=JSON.parse(E.readFileSync(d.join(v,n)).toString());return!$(y)}).map(n=>d.basename(d.dirname(n))).filter(n=>n!=="vscode-api-tests"&&n!=="vscode-test-resolver"),I=JSON.parse(E.readFileSync(d.join(v,"product.json"),"utf8")).builtInExtensions.filter(n=>!n.platforms||new Set(n.platforms).has(e)).filter(n=>!n.clientOnly).map(n=>n.name),F=[...S,...I].map(n=>`.build/extensions/${n}/**`),W=o.src(F,{base:".build",dot:!0}),U=o.src(".build/extensions/node_modules/**",{base:".build",dot:!0}),J=j.merge(c,W,U).pipe(q(["**","!**/*.js.map"],{dot:!0}));let w=ne.version;const P=t.quality;P&&P!=="stable"&&(w+="-"+P);const H=t.nameShort,L=o.src(["remote/package.json"],{base:"remote"}).pipe(r({name:H,version:w,dependencies:void 0,optionalDependencies:void 0})),G=new Date().toISOString(),K=o.src(["product.json"],{base:"."}).pipe(r({commit:g,date:G,version:w})),Q=o.src(["remote/LICENSE"],{base:"remote",allowEmpty:!0}),O=u.filter(n=>!n.isDirectory()&&/\.js$/.test(n.path)),X=se(be).map(n=>d.relative(v,n.path)).map(n=>[`${n}/**`,`!${n}/**/{test,tests}/**`,`!${n}/.bin/**`]).flat(),Y=o.src(X,{base:"remote",dot:!0}).pipe(q(["**","!**/package-lock.json","!**/yarn.lock","!**/*.js.map"])).pipe(u.cleanNodeModules(d.join(__dirname,".moduleignore"))).pipe(u.cleanNodeModules(d.join(__dirname,`.moduleignore.${process.platform}`))).pipe(O).pipe(u.stripSourceMappingURL()).pipe(O.restore),R=`.build/node/v${m}/${e}-${i}`,Z=o.src(`${R}/**`,{base:R,dot:!0});let T=[];s==="reh-web"&&(T=["resources/server/favicon.ico","resources/server/code-192.png","resources/server/code-512.png","resources/server/manifest.json"].map(n=>o.src(n,{base:"."}).pipe(h(n))));let x=j.merge(L,K,Q,J,Y,Z,...T).pipe(u.skipDirectories()).pipe(u.fixWin32DirectoryPermissions());return e==="win32"?x=j.merge(x,o.src("resources/server/bin/remote-cli/code.cmd",{base:"."}).pipe(p("@@VERSION@@",w)).pipe(p("@@COMMIT@@",g)).pipe(p("@@APPNAME@@",t.applicationName)).pipe(h(`bin/remote-cli/${t.applicationName}.cmd`)),o.src("resources/server/bin/helpers/browser.cmd",{base:"."}).pipe(p("@@VERSION@@",w)).pipe(p("@@COMMIT@@",g)).pipe(p("@@APPNAME@@",t.applicationName)).pipe(h("bin/helpers/browser.cmd")),o.src("resources/server/bin/code-server.cmd",{base:"."}).pipe(h(`bin/${t.serverApplicationName}.cmd`))):(e==="linux"||e==="alpine"||e==="darwin")&&(x=j.merge(x,o.src(`resources/server/bin/remote-cli/${e==="darwin"?"code-darwin.sh":"code-linux.sh"}`,{base:"."}).pipe(p("@@VERSION@@",w)).pipe(p("@@COMMIT@@",g)).pipe(p("@@APPNAME@@",t.applicationName)).pipe(h(`bin/remote-cli/${t.applicationName}`)).pipe(u.setExecutableBit()),o.src(`resources/server/bin/helpers/${e==="darwin"?"browser-darwin.sh":"browser-linux.sh"}`,{base:"."}).pipe(p("@@VERSION@@",w)).pipe(p("@@COMMIT@@",g)).pipe(p("@@APPNAME@@",t.applicationName)).pipe(h("bin/helpers/browser.sh")).pipe(u.setExecutableBit()),o.src(`resources/server/bin/${e==="darwin"?"code-server-darwin.sh":"code-server-linux.sh"}`,{base:"."}).pipe(h(`bin/${t.serverApplicationName}`)).pipe(u.setExecutableBit()))),x.pipe(A.dest(b))}}function ge(s){const e={...s};return delete e.webEndpointUrlTemplate,e}["reh","reh-web"].forEach(s=>{const e=f.define(`optimize-vscode-${s}`,f.series(u.rimraf(`out-vscode-${s}`),M.optimizeTask({out:`out-vscode-${s}`,amd:{src:"out-build",entryPoints:(s==="reh"?z:he).flat(),otherSources:[],resources:s==="reh"?D:fe,loaderConfig:M.loaderConfig(),inlineAmdImages:!0,bundleInfo:void 0,fileContentMapper:pe(".build/extensions",s==="reh-web"?ge(t):t)},commonJS:{src:"out-build",entryPoints:["out-build/server-main.js","out-build/server-cli.js"],platform:"node",external:["minimist","../product.json","../package.json"]}}))),i=f.define(`minify-vscode-${s}`,f.series(e,u.rimraf(`out-vscode-${s}-min`),M.minifyTask(`out-vscode-${s}`,`https://ticino.blob.core.windows.net/sourcemaps/${g}/core`)));o.task(i),_.forEach(l=>{const a=c=>c?`-${c}`:"",b=l.platform,r=l.arch;["","min"].forEach(c=>{const k=`out-vscode-${s}${a(c)}`,$=`vscode-${s}${a(b)}${a(r)}`,S=f.define(`vscode-${s}${a(b)}${a(r)}${a(c)}-ci`,f.series(o.task(`node-${b}-${r}`),u.rimraf(d.join(C,$)),ke(s,b,r,k,$)));o.task(S);const I=f.define(`vscode-${s}${a(b)}${a(r)}${a(c)}`,f.series(ce,ae,de,c?i:e,S));o.task(I)})})});
