const o=require("gulp"),u=require("path"),x=require("event-stream"),d=require("./lib/util"),{getVersion:ne}=require("./lib/getVersion"),v=require("./lib/task"),R=require("./lib/optimize"),i=require("../product.json"),b=require("gulp-rename"),m=require("gulp-replace"),k=require("gulp-filter"),{getProductionDependencies:oe}=require("./lib/dependencies"),_=require("vinyl-fs"),re=require("../package.json"),D=require("gulp-flatmap"),C=require("gulp-gunzip"),ie=require("vinyl"),j=require("fs"),te=require("glob"),{compileBuildTask:ce}=require("./gulpfile.compile"),{compileExtensionsBuildTask:ae,compileExtensionMediaBuildTask:de}=require("./gulpfile.extensions"),{vscodeWebEntryPoints:pe,vscodeWebResourceIncludes:ue,createVSCodeWebFileContentMapper:le}=require("./gulpfile.vscode.web"),me=require("child_process"),S=require("fancy-log"),h=u.dirname(__dirname),w=ne(h),z=u.dirname(h),be=u.join(h,"remote"),B=[{platform:"win32",arch:"ia32"},{platform:"win32",arch:"x64"},{platform:"darwin",arch:"x64"},{platform:"darwin",arch:"arm64"},{platform:"linux",arch:"x64"},{platform:"linux",arch:"armhf"},{platform:"linux",arch:"arm64"},{platform:"alpine",arch:"arm64"},{platform:"linux",arch:"alpine"}],V=["out-build/bootstrap.js","out-build/bootstrap-fork.js","out-build/bootstrap-amd.js","out-build/bootstrap-node.js","out-build/vs/base/common/performance.js","out-build/vs/platform/files/**/*.exe","out-build/vs/platform/files/**/*.md","out-build/vs/base/node/cpuUsage.sh","out-build/vs/base/node/ps.sh","out-build/vs/workbench/contrib/terminal/browser/media/shellIntegration.ps1","out-build/vs/workbench/contrib/terminal/browser/media/shellIntegration-bash.sh","out-build/vs/workbench/contrib/terminal/browser/media/shellIntegration-env.zsh","out-build/vs/workbench/contrib/terminal/browser/media/shellIntegration-profile.zsh","out-build/vs/workbench/contrib/terminal/browser/media/shellIntegration-rc.zsh","out-build/vs/workbench/contrib/terminal/browser/media/shellIntegration-login.zsh","out-build/vs/workbench/contrib/terminal/browser/media/fish_xdg_data/fish/vendor_conf.d/shellIntegration.fish","!**/test/**"],fe=[...V,...ue],F=[{name:"vs/server/node/server.main",exclude:["vs/css","vs/nls"]},{name:"vs/server/node/server.cli",exclude:["vs/css","vs/nls"]},{name:"vs/workbench/api/node/extensionHostProcess",exclude:["vs/css","vs/nls"]},{name:"vs/platform/files/node/watcher/watcherMain",exclude:["vs/css","vs/nls"]},{name:"vs/platform/terminal/node/ptyHostMain",exclude:["vs/css","vs/nls"]}],ve=[...F,...pe];function he(){const s=j.readFileSync(u.join(h,"remote",".yarnrc"),"utf8"),e=/^target "(.*)"$/m.exec(s)[1],r=/^ms_build_id "(.*)"$/m.exec(s)[1];return{nodeVersion:e,internalNodeVersion:r}}function $e(s,e,r){let a;switch(e){case"win32":a=`win-${r}/node.exe`;break;case"darwin":case"alpine":case"linux":a=`node-v${s}-${e}-${r}.tar.gz`;break}const t=j.readFileSync(u.join(h,"build","checksums","nodejs.txt"),"utf8");for(const f of t.split(`
`)){const[c,p]=f.split(/\s+/);if(p===a)return c}}function we(s,e,r){const a=r==="arm64"?"arm64v8/node":"node";S(`Downloading node.js ${s} ${e} ${r} from docker image ${a}`);const t=me.execSync(`docker run --rm ${a}:${s}-alpine /bin/sh -c 'cat \`which node\`'`,{maxBuffer:100*1024*1024,encoding:"buffer"});return x.readArray([new ie({path:"node",contents:t,stat:{mode:parseInt("755",8)}})])}const{nodeVersion:l,internalNodeVersion:M}=he();B.forEach(({platform:s,arch:e})=>{o.task(v.define(`node-${s}-${e}`,()=>{const r=u.join(".build","node",`v${l}`,`${s}-${e}`);return j.existsSync(r)?Promise.resolve(null):(d.rimraf(r),ge(s,e).pipe(_.dest(r)))}))});const W=o.task(`node-${process.platform}-${process.arch}`);W&&o.task(v.define("node",W));function ge(s,e){const{fetchUrls:r,fetchGithub:a}=require("./lib/fetch"),t=require("gulp-untar"),f=require("crypto");e==="ia32"?e="x86":e==="armhf"?e="armv7l":e==="alpine"&&(s="alpine",e="x64"),S(`Downloading node.js ${l} ${s} ${e} from ${i.nodejsRepository}...`);const c=$e(l,s,e);switch(c?S(`Using SHA256 checksum for checking integrity: ${c}`):S.warn("Unable to verify integrity of downloaded node.js binary because no SHA256 checksum was found!"),s){case"win32":return(i.nodejsRepository!=="https://nodejs.org"?a(i.nodejsRepository,{version:`${l}-${M}`,name:`win-${e}-node.exe`,checksumSha256:c}):r(`/dist/v${l}/win-${e}/node.exe`,{base:"https://nodejs.org",checksumSha256:c})).pipe(b("node.exe"));case"darwin":case"linux":return(i.nodejsRepository!=="https://nodejs.org"?a(i.nodejsRepository,{version:`${l}-${M}`,name:`node-v${l}-${s}-${e}.tar.gz`,checksumSha256:c}):r(`/dist/v${l}/node-v${l}-${s}-${e}.tar.gz`,{base:"https://nodejs.org",checksumSha256:c})).pipe(D(p=>p.pipe(C()).pipe(t()))).pipe(k("**/node")).pipe(d.setExecutableBit("**")).pipe(b("node"));case"alpine":return i.nodejsRepository!=="https://nodejs.org"?a(i.nodejsRepository,{version:`${l}-${M}`,name:`node-v${l}-${s}-${e}.tar.gz`,checksumSha256:c}).pipe(D(p=>p.pipe(C()).pipe(t()))).pipe(k("**/node")).pipe(d.setExecutableBit("**")).pipe(b("node")):we(l,s,e)}}function xe(s,e,r,a,t){const f=u.join(z,t);return()=>{const c=require("gulp-json-editor"),p=o.src(a+"/**",{base:"."}).pipe(b(function(n){n.dirname=n.dirname.replace(new RegExp("^"+a),"out")})).pipe(d.setExecutableBit(["**/*.sh"])).pipe(k(["**","!**/*.js.map"])),N=["debuggers","jsonValidation"],E=n=>{switch(n.extensionKind){case"ui":return!0;case"workspace":return!1;default:return!(n.main||n.contributes&&Object.keys(n.contributes).some(P=>N.indexOf(P)!==-1))}},q=te.sync("extensions/*/package.json").filter(n=>{if(s==="reh-web")return!0;const P=JSON.parse(j.readFileSync(u.join(h,n)).toString());return!E(P)}).map(n=>u.basename(u.dirname(n))).filter(n=>n!=="vscode-api-tests"&&n!=="vscode-test-resolver"),I=JSON.parse(j.readFileSync(u.join(h,"product.json"),"utf8")).builtInExtensions.filter(n=>!n.platforms||new Set(n.platforms).has(e)).filter(n=>!n.clientOnly).map(n=>n.name),U=[...q,...I].map(n=>`.build/extensions/${n}/**`),J=o.src(U,{base:".build",dot:!0}),L=o.src(".build/extensions/node_modules/**",{base:".build",dot:!0}),H=x.merge(p,J,L).pipe(k(["**","!**/*.js.map"],{dot:!0}));let $=re.version;const y=i.quality;y&&y!=="stable"&&($+="-"+y);const G=i.nameShort,K=o.src(["remote/package.json"],{base:"remote"}).pipe(c({name:G,version:$,dependencies:void 0,optionalDependencies:void 0})),Q=new Date().toISOString(),X=o.src(["product.json"],{base:"."}).pipe(c({commit:w,date:Q,version:$})),Y=o.src(["remote/LICENSE"],{base:"remote",allowEmpty:!0}),O=d.filter(n=>!n.isDirectory()&&/\.js$/.test(n.path)),Z=oe(be).map(n=>u.relative(h,n.path)).map(n=>[`${n}/**`,`!${n}/**/{test,tests}/**`,`!${n}/.bin/**`]).flat(),ee=o.src(Z,{base:"remote",dot:!0}).pipe(k(["**","!**/package-lock.json","!**/yarn.lock","!**/*.js.map"])).pipe(d.cleanNodeModules(u.join(__dirname,".moduleignore"))).pipe(d.cleanNodeModules(u.join(__dirname,`.moduleignore.${process.platform}`))).pipe(O).pipe(d.stripSourceMappingURL()).pipe(O.restore),T=`.build/node/v${l}/${e}-${r}`,se=o.src(`${T}/**`,{base:T,dot:!0});let A=[];s==="reh-web"&&(A=["resources/server/favicon.ico","resources/server/code-192.png","resources/server/code-512.png","resources/server/manifest.json"].map(n=>o.src(n,{base:"."}).pipe(b(n))));let g=x.merge(K,X,Y,H,ee,se,...A).pipe(d.skipDirectories()).pipe(d.fixWin32DirectoryPermissions());return e==="win32"?g=x.merge(g,o.src("resources/server/bin/remote-cli/code.cmd",{base:"."}).pipe(m("@@VERSION@@",$)).pipe(m("@@COMMIT@@",w)).pipe(m("@@APPNAME@@",i.applicationName)).pipe(b(`bin/remote-cli/${i.applicationName}.cmd`)),o.src("resources/server/bin/helpers/browser.cmd",{base:"."}).pipe(m("@@VERSION@@",$)).pipe(m("@@COMMIT@@",w)).pipe(m("@@APPNAME@@",i.applicationName)).pipe(b("bin/helpers/browser.cmd")),o.src("resources/server/bin/code-server.cmd",{base:"."}).pipe(b(`bin/${i.serverApplicationName}.cmd`))):(e==="linux"||e==="alpine"||e==="darwin")&&(g=x.merge(g,o.src(`resources/server/bin/remote-cli/${e==="darwin"?"code-darwin.sh":"code-linux.sh"}`,{base:"."}).pipe(m("@@VERSION@@",$)).pipe(m("@@COMMIT@@",w)).pipe(m("@@APPNAME@@",i.applicationName)).pipe(b(`bin/remote-cli/${i.applicationName}`)).pipe(d.setExecutableBit()),o.src(`resources/server/bin/helpers/${e==="darwin"?"browser-darwin.sh":"browser-linux.sh"}`,{base:"."}).pipe(m("@@VERSION@@",$)).pipe(m("@@COMMIT@@",w)).pipe(m("@@APPNAME@@",i.applicationName)).pipe(b("bin/helpers/browser.sh")).pipe(d.setExecutableBit()),o.src(`resources/server/bin/${e==="darwin"?"code-server-darwin.sh":"code-server-linux.sh"}`,{base:"."}).pipe(b(`bin/${i.serverApplicationName}`)).pipe(d.setExecutableBit()))),g.pipe(_.dest(f))}}function ke(s){const e={...s};return delete e.webEndpointUrlTemplate,e}["reh","reh-web"].forEach(s=>{const e=v.define(`optimize-vscode-${s}`,v.series(d.rimraf(`out-vscode-${s}`),R.optimizeTask({out:`out-vscode-${s}`,amd:{src:"out-build",entryPoints:(s==="reh"?F:ve).flat(),otherSources:[],resources:s==="reh"?V:fe,loaderConfig:R.loaderConfig(),inlineAmdImages:!0,bundleInfo:void 0,fileContentMapper:le(".build/extensions",s==="reh-web"?ke(i):i)},commonJS:{src:"out-build",entryPoints:["out-build/server-main.js","out-build/server-cli.js"],platform:"node",external:["minimist","../product.json","../package.json"]}}))),r=v.define(`minify-vscode-${s}`,v.series(e,d.rimraf(`out-vscode-${s}-min`),R.minifyTask(`out-vscode-${s}`,`https://ticino.blob.core.windows.net/sourcemaps/${w}/core`)));o.task(r),B.forEach(a=>{const t=p=>p?`-${p}`:"",f=a.platform,c=a.arch;["","min"].forEach(p=>{const N=`out-vscode-${s}${t(p)}`,E=`vscode-${s}${t(f)}${t(c)}`,q=v.define(`vscode-${s}${t(f)}${t(c)}${t(p)}-ci`,v.series(o.task(`node-${f}-${c}`),d.rimraf(u.join(z,E)),xe(s,f,c,N,E)));o.task(q);const I=v.define(`vscode-${s}${t(f)}${t(c)}${t(p)}`,v.series(ce,ae,de,p?r:e,q));o.task(I)})})});
