var y=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var D=(p,l,n,e)=>{for(var o=e>1?void 0:e?L(l,n):l,u=p.length-1,i;u>=0;u--)(i=p[u])&&(o=(e?i(l,n,o):i(o))||o);return e&&o&&y(l,n,o),o},d=(p,l)=>(n,e)=>l(n,e,p);import{Disposable as v,dispose as I}from"../../../../base/common/lifecycle.js";import*as k from"../../../../base/common/errors.js";import"../../../common/model.js";import"../../../common/textModelEvents.js";import"../../../common/languages.js";import{IModelService as q}from"../../../common/services/model.js";import{IConfigurationService as w}from"../../../../platform/configuration/common/configuration.js";import{RunOnceScheduler as P}from"../../../../base/common/async.js";import{CancellationTokenSource as A}from"../../../../base/common/cancellation.js";import{IThemeService as C}from"../../../../platform/theme/common/themeService.js";import{toMultilineTokens2 as M}from"../../../common/services/semanticTokensProviderStyling.js";import{getDocumentSemanticTokens as x,hasDocumentSemanticTokensProvider as U,isSemanticTokens as N,isSemanticTokensEdits as F}from"../common/getSemanticTokens.js";import{ILanguageFeatureDebounceService as R}from"../../../common/services/languageFeatureDebounce.js";import{StopWatch as z}from"../../../../base/common/stopwatch.js";import{ILanguageFeaturesService as E}from"../../../common/services/languageFeatures.js";import"../../../common/languageFeatureRegistry.js";import{ISemanticTokensStylingService as b}from"../../../common/services/semanticTokensStyling.js";import{registerEditorFeature as Q}from"../../../common/editorFeatures.js";import{SEMANTIC_HIGHLIGHTING_SETTING_ID as Y,isSemanticColoringEnabled as T}from"../common/semanticTokensConfig.js";let S=class extends v{_watchers;constructor(l,n,e,o,u,i){super(),this._watchers=Object.create(null);const c=t=>{this._watchers[t.uri.toString()]=new h(t,l,e,u,i)},a=(t,r)=>{r.dispose(),delete this._watchers[t.uri.toString()]},s=()=>{for(const t of n.getModels()){const r=this._watchers[t.uri.toString()];T(t,e,o)?r||c(t):r&&a(t,r)}};n.getModels().forEach(t=>{T(t,e,o)&&c(t)}),this._register(n.onModelAdded(t=>{T(t,e,o)&&c(t)})),this._register(n.onModelRemoved(t=>{const r=this._watchers[t.uri.toString()];r&&a(t,r)})),this._register(o.onDidChangeConfiguration(t=>{t.affectsConfiguration(Y)&&s()})),this._register(e.onDidColorThemeChange(s))}dispose(){for(const l of Object.values(this._watchers))l.dispose();super.dispose()}};S=D([d(0,b),d(1,q),d(2,C),d(3,w),d(4,R),d(5,E)],S);let h=class extends v{constructor(n,e,o,u,i){super();this._semanticTokensStylingService=e;this._isDisposed=!1,this._model=n,this._provider=i.documentSemanticTokensProvider,this._debounceInformation=u.for(this._provider,"DocumentSemanticTokens",{min:h.REQUEST_MIN_DELAY,max:h.REQUEST_MAX_DELAY}),this._fetchDocumentSemanticTokens=this._register(new P(()=>this._fetchDocumentSemanticTokensNow(),h.REQUEST_MIN_DELAY)),this._currentDocumentResponse=null,this._currentDocumentRequestCancellationTokenSource=null,this._documentProvidersChangeListeners=[],this._providersChangedDuringRequest=!1,this._register(this._model.onDidChangeContent(()=>{this._fetchDocumentSemanticTokens.isScheduled()||this._fetchDocumentSemanticTokens.schedule(this._debounceInformation.get(this._model))})),this._register(this._model.onDidChangeAttached(()=>{this._fetchDocumentSemanticTokens.isScheduled()||this._fetchDocumentSemanticTokens.schedule(this._debounceInformation.get(this._model))})),this._register(this._model.onDidChangeLanguage(()=>{this._currentDocumentResponse&&(this._currentDocumentResponse.dispose(),this._currentDocumentResponse=null),this._currentDocumentRequestCancellationTokenSource&&(this._currentDocumentRequestCancellationTokenSource.cancel(),this._currentDocumentRequestCancellationTokenSource=null),this._setDocumentSemanticTokens(null,null,null,[]),this._fetchDocumentSemanticTokens.schedule(0)}));const c=()=>{I(this._documentProvidersChangeListeners),this._documentProvidersChangeListeners=[];for(const a of this._provider.all(n))typeof a.onDidChange=="function"&&this._documentProvidersChangeListeners.push(a.onDidChange(()=>{if(this._currentDocumentRequestCancellationTokenSource){this._providersChangedDuringRequest=!0;return}this._fetchDocumentSemanticTokens.schedule(0)}))};c(),this._register(this._provider.onDidChange(()=>{c(),this._fetchDocumentSemanticTokens.schedule(this._debounceInformation.get(this._model))})),this._register(o.onDidColorThemeChange(a=>{this._setDocumentSemanticTokens(null,null,null,[]),this._fetchDocumentSemanticTokens.schedule(this._debounceInformation.get(this._model))})),this._fetchDocumentSemanticTokens.schedule(0)}static REQUEST_MIN_DELAY=300;static REQUEST_MAX_DELAY=2e3;_isDisposed;_model;_provider;_debounceInformation;_fetchDocumentSemanticTokens;_currentDocumentResponse;_currentDocumentRequestCancellationTokenSource;_documentProvidersChangeListeners;_providersChangedDuringRequest;dispose(){this._currentDocumentResponse&&(this._currentDocumentResponse.dispose(),this._currentDocumentResponse=null),this._currentDocumentRequestCancellationTokenSource&&(this._currentDocumentRequestCancellationTokenSource.cancel(),this._currentDocumentRequestCancellationTokenSource=null),I(this._documentProvidersChangeListeners),this._documentProvidersChangeListeners=[],this._setDocumentSemanticTokens(null,null,null,[]),this._isDisposed=!0,super.dispose()}_fetchDocumentSemanticTokensNow(){if(this._currentDocumentRequestCancellationTokenSource)return;if(!U(this._provider,this._model)){this._currentDocumentResponse&&this._model.tokenization.setSemanticTokens(null,!1);return}if(!this._model.isAttachedToEditor())return;const n=new A,e=this._currentDocumentResponse?this._currentDocumentResponse.provider:null,o=this._currentDocumentResponse&&this._currentDocumentResponse.resultId||null,u=x(this._provider,this._model,e,o,n.token);this._currentDocumentRequestCancellationTokenSource=n,this._providersChangedDuringRequest=!1;const i=[],c=this._model.onDidChangeContent(s=>{i.push(s)}),a=new z(!1);u.then(s=>{if(this._debounceInformation.update(this._model,a.elapsed()),this._currentDocumentRequestCancellationTokenSource=null,c.dispose(),!s)this._setDocumentSemanticTokens(null,null,null,i);else{const{provider:t,tokens:r}=s,f=this._semanticTokensStylingService.getStyling(t);this._setDocumentSemanticTokens(t,r||null,f,i)}},s=>{s&&(k.isCancellationError(s)||typeof s.message=="string"&&s.message.indexOf("busy")!==-1)||k.onUnexpectedError(s),this._currentDocumentRequestCancellationTokenSource=null,c.dispose(),(i.length>0||this._providersChangedDuringRequest)&&(this._fetchDocumentSemanticTokens.isScheduled()||this._fetchDocumentSemanticTokens.schedule(this._debounceInformation.get(this._model)))})}static _copy(n,e,o,u,i){i=Math.min(i,o.length-u,n.length-e);for(let c=0;c<i;c++)o[u+c]=n[e+c]}_setDocumentSemanticTokens(n,e,o,u){const i=this._currentDocumentResponse,c=()=>{(u.length>0||this._providersChangedDuringRequest)&&!this._fetchDocumentSemanticTokens.isScheduled()&&this._fetchDocumentSemanticTokens.schedule(this._debounceInformation.get(this._model))};if(this._currentDocumentResponse&&(this._currentDocumentResponse.dispose(),this._currentDocumentResponse=null),this._isDisposed){n&&e&&n.releaseDocumentSemanticTokens(e.resultId);return}if(!n||!o){this._model.tokenization.setSemanticTokens(null,!1);return}if(!e){this._model.tokenization.setSemanticTokens(null,!0),c();return}if(F(e)){if(!i){this._model.tokenization.setSemanticTokens(null,!0);return}if(e.edits.length===0)e={resultId:e.resultId,data:i.data};else{let a=0;for(const _ of e.edits)a+=(_.data?_.data.length:0)-_.deleteCount;const s=i.data,t=new Uint32Array(s.length+a);let r=s.length,f=t.length;for(let _=e.edits.length-1;_>=0;_--){const m=e.edits[_];if(m.start>s.length){o.warnInvalidEditStart(i.resultId,e.resultId,_,m.start,s.length),this._model.tokenization.setSemanticTokens(null,!0);return}const g=r-(m.start+m.deleteCount);g>0&&(h._copy(s,r-g,t,f-g,g),f-=g),m.data&&(h._copy(m.data,0,t,f-m.data.length,m.data.length),f-=m.data.length),r=m.start}r>0&&h._copy(s,0,t,0,r),e={resultId:e.resultId,data:t}}}if(N(e)){this._currentDocumentResponse=new G(n,e.resultId,e.data);const a=M(e,o,this._model.getLanguageId());if(u.length>0)for(const s of u)for(const t of a)for(const r of s.changes)t.applyEdit(r.range,r.text);this._model.tokenization.setSemanticTokens(a,!0)}else this._model.tokenization.setSemanticTokens(null,!0);c()}};h=D([d(1,b),d(2,C),d(3,R),d(4,E)],h);class G{constructor(l,n,e){this.provider=l;this.resultId=n;this.data=e}dispose(){this.provider.releaseDocumentSemanticTokens(this.resultId)}}Q(S);export{S as DocumentSemanticTokensFeature};
