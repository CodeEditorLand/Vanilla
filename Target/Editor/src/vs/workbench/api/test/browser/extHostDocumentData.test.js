import e from"assert";import{URI as c}from"../../../../base/common/uri.js";import{ExtHostDocumentData as f}from"../../common/extHostDocumentData.js";import{Position as r}from"../../common/extHostTypes.js";import{Range as u}from"../../../../editor/common/core/range.js";import"../../common/extHost.protocol.js";import"../../../../editor/common/model/mirrorTextModel.js";import{mock as q}from"../../../../base/test/common/mock.js";import*as x from"./extHostDocumentData.test.perf-data.js";import{setDefaultGetWordAtTextConfig as v}from"../../../../editor/common/core/wordHelper.js";import{ensureNoDisposablesAreLeakedInTestSuite as b}from"../../../../base/test/common/utils.js";suite("ExtHostDocumentData",()=>{let n;function l(t,o,s){const a=n.document.positionAt(t);e.strictEqual(a.line,o),e.strictEqual(a.character,s)}function i(t,o,s){const a=new r(t,o),d=n.document.offsetAt(a);e.strictEqual(d,s)}setup(function(){n=new f(void 0,c.file(""),["This is line one","and this is line number two","it is followed by #3","and finished with the fourth."],`
`,1,"text",!1)}),b(),test("readonly-ness",()=>{e.throws(()=>n.document.uri=null),e.throws(()=>n.document.fileName="foofile"),e.throws(()=>n.document.isDirty=!1),e.throws(()=>n.document.isUntitled=!1),e.throws(()=>n.document.languageId="dddd"),e.throws(()=>n.document.lineCount=9)}),test("save, when disposed",function(){let t;const o=new f(new class extends q(){$trySaveDocument(s){return e.ok(!t),t=s,Promise.resolve(!0)}},c.parse("foo:bar"),[],`
`,1,"text",!0);return o.document.save().then(()=>(e.strictEqual(t.toString(),"foo:bar"),o.dispose(),o.document.save().then(()=>{e.ok(!1,"expected failure")},s=>{e.ok(s)})))}),test("read, when disposed",function(){n.dispose();const{document:t}=n;e.strictEqual(t.lineCount,4),e.strictEqual(t.lineAt(0).text,"This is line one")}),test("lines",()=>{e.strictEqual(n.document.lineCount,4),e.throws(()=>n.document.lineAt(-1)),e.throws(()=>n.document.lineAt(n.document.lineCount)),e.throws(()=>n.document.lineAt(Number.MAX_VALUE)),e.throws(()=>n.document.lineAt(Number.MIN_VALUE)),e.throws(()=>n.document.lineAt(.8));let t=n.document.lineAt(0);e.strictEqual(t.lineNumber,0),e.strictEqual(t.text.length,16),e.strictEqual(t.text,"This is line one"),e.strictEqual(t.isEmptyOrWhitespace,!1),e.strictEqual(t.firstNonWhitespaceCharacterIndex,0),n.onEvents({changes:[{range:{startLineNumber:1,startColumn:1,endLineNumber:1,endColumn:1},rangeOffset:void 0,rangeLength:void 0,text:"	 "}],eol:void 0,versionId:void 0,isRedoing:!1,isUndoing:!1}),e.strictEqual(t.text,"This is line one"),e.strictEqual(t.firstNonWhitespaceCharacterIndex,0),t=n.document.lineAt(0),e.strictEqual(t.text,"	 This is line one"),e.strictEqual(t.firstNonWhitespaceCharacterIndex,2)}),test("line, issue #5704",function(){let t=n.document.lineAt(0),{range:o,rangeIncludingLineBreak:s}=t;e.strictEqual(o.end.line,0),e.strictEqual(o.end.character,16),e.strictEqual(s.end.line,1),e.strictEqual(s.end.character,0),t=n.document.lineAt(n.document.lineCount-1),o=t.range,s=t.rangeIncludingLineBreak,e.strictEqual(o.end.line,3),e.strictEqual(o.end.character,29),e.strictEqual(s.end.line,3),e.strictEqual(s.end.character,29)}),test("offsetAt",()=>{i(0,0,0),i(0,1,1),i(0,16,16),i(1,0,17),i(1,3,20),i(2,0,45),i(4,29,95),i(4,30,95),i(4,Number.MAX_VALUE,95),i(5,29,95),i(Number.MAX_VALUE,29,95),i(Number.MAX_VALUE,Number.MAX_VALUE,95)}),test("offsetAt, after remove",function(){n.onEvents({changes:[{range:{startLineNumber:1,startColumn:3,endLineNumber:1,endColumn:6},rangeOffset:void 0,rangeLength:void 0,text:""}],eol:void 0,versionId:void 0,isRedoing:!1,isUndoing:!1}),i(0,1,1),i(0,13,13),i(1,0,14)}),test("offsetAt, after replace",function(){n.onEvents({changes:[{range:{startLineNumber:1,startColumn:3,endLineNumber:1,endColumn:6},rangeOffset:void 0,rangeLength:void 0,text:"is could be"}],eol:void 0,versionId:void 0,isRedoing:!1,isUndoing:!1}),i(0,1,1),i(0,24,24),i(1,0,25)}),test("offsetAt, after insert line",function(){n.onEvents({changes:[{range:{startLineNumber:1,startColumn:3,endLineNumber:1,endColumn:6},rangeOffset:void 0,rangeLength:void 0,text:`is could be
a line with number`}],eol:void 0,versionId:void 0,isRedoing:!1,isUndoing:!1}),i(0,1,1),i(0,13,13),i(1,0,14),i(1,18,32),i(1,29,43),i(2,0,44)}),test("offsetAt, after remove line",function(){n.onEvents({changes:[{range:{startLineNumber:1,startColumn:3,endLineNumber:2,endColumn:6},rangeOffset:void 0,rangeLength:void 0,text:""}],eol:void 0,versionId:void 0,isRedoing:!1,isUndoing:!1}),i(0,1,1),i(0,2,2),i(1,0,25)}),test("positionAt",()=>{l(0,0,0),l(Number.MIN_VALUE,0,0),l(1,0,1),l(16,0,16),l(17,1,0),l(20,1,3),l(45,2,0),l(95,3,29),l(96,3,29),l(99,3,29),l(Number.MAX_VALUE,3,29)}),test("getWordRangeAtPosition",()=>{n=new f(void 0,c.file(""),["aaaa bbbb+cccc abc"],`
`,1,"text",!1);let t=n.document.getWordRangeAtPosition(new r(0,2));e.strictEqual(t.start.line,0),e.strictEqual(t.start.character,0),e.strictEqual(t.end.line,0),e.strictEqual(t.end.character,4),e.throws(()=>n.document.getWordRangeAtPosition(new r(0,2),/.*/)),t=n.document.getWordRangeAtPosition(new r(0,5),/[a-z+]+/),e.strictEqual(t.start.line,0),e.strictEqual(t.start.character,5),e.strictEqual(t.end.line,0),e.strictEqual(t.end.character,14),t=n.document.getWordRangeAtPosition(new r(0,17),/[a-z+]+/),e.strictEqual(t.start.line,0),e.strictEqual(t.start.character,15),e.strictEqual(t.end.line,0),e.strictEqual(t.end.character,18),t=n.document.getWordRangeAtPosition(new r(0,11),/yy/),e.strictEqual(t,void 0)}),test("getWordRangeAtPosition doesn't quite use the regex as expected, #29102",function(){n=new f(void 0,c.file(""),["some text here","/** foo bar */","function() {",'	"far boo"',"}"],`
`,1,"text",!1);let t=n.document.getWordRangeAtPosition(new r(0,0),/\/\*.+\*\//);e.strictEqual(t,void 0),t=n.document.getWordRangeAtPosition(new r(1,0),/\/\*.+\*\//),e.strictEqual(t.start.line,1),e.strictEqual(t.start.character,0),e.strictEqual(t.end.line,1),e.strictEqual(t.end.character,14),t=n.document.getWordRangeAtPosition(new r(3,0),/("|').*\1/),e.strictEqual(t,void 0),t=n.document.getWordRangeAtPosition(new r(3,1),/("|').*\1/),e.strictEqual(t.start.line,3),e.strictEqual(t.start.character,1),e.strictEqual(t.end.line,3),e.strictEqual(t.end.character,10)}),test("getWordRangeAtPosition can freeze the extension host #95319",function(){const t=/(https?:\/\/github\.com\/(([^\s]+)\/([^\s]+))\/([^\s]+\/)?(issues|pull)\/([0-9]+))|(([^\s]+)\/([^\s]+))?#([1-9][0-9]*)($|[\s\:\;\-\(\=])/;n=new f(void 0,c.file(""),[x._$_$_expensive],`
`,1,"text",!1);const o=v({maxLen:1e3,windowSize:15,timeBudget:30});try{let s=n.document.getWordRangeAtPosition(new r(0,1177170),t);e.strictEqual(s,void 0);const a=new r(0,1177170);s=n.document.getWordRangeAtPosition(a),e.ok(s),e.ok(s.contains(a)),e.strictEqual(n.document.getText(s),"TaskDefinition")}finally{o.dispose()}}),test("Rename popup sometimes populates with text on the left side omitted #96013",function(){const t=/(-?\d*\.\d\w*)|([^\`\~\!\@\#\$\%\^\&\*\(\)\-\=\+\[\{\]\}\\\|\;\:\'\"\,\.\<\>\/\?\s]+)/g,o="int abcdefhijklmnopqwvrstxyz;";n=new f(void 0,c.file(""),[o],`
`,1,"text",!1);const s=n.document.getWordRangeAtPosition(new r(0,27),t);e.strictEqual(s.start.line,0),e.strictEqual(s.end.line,0),e.strictEqual(s.start.character,4),e.strictEqual(s.end.character,28)}),test("Custom snippet $TM_SELECTED_TEXT not show suggestion #108892",function(){n=new f(void 0,c.file(""),[`        <p><span xml:lang="en">Sheldon</span>, soprannominato "<span xml:lang="en">Shelly</span> dalla madre e dalla sorella, \xE8 nato a <span xml:lang="en">Galveston</span>, in <span xml:lang="en">Texas</span>, il 26 febbraio 1980 in un supermercato. \xC8 stato un bambino prodigio, come testimoniato dal suo quoziente d'intelligenza (187, di molto superiore alla norma) e dalla sua rapida carriera scolastica: si \xE8 diplomato all'eta di 11 anni approdando alla stessa et\xE0 alla formazione universitaria e all'et\xE0 di 16 anni ha ottenuto il suo primo dottorato di ricerca. All'inizio della serie e per gran parte di essa vive con il coinquilino Leonard nell'appartamento 4A al 2311 <span xml:lang="en">North Los Robles Avenue</span> di <span xml:lang="en">Pasadena</span>, per poi trasferirsi nell'appartamento di <span xml:lang="en">Penny</span> con <span xml:lang="en">Amy</span> nella decima stagione. Come pi\xF9 volte afferma lui stesso possiede una memoria eidetica e un orecchio assoluto. \xC8 stato educato da una madre estremamente religiosa e, in pi\xF9 occasioni, questo aspetto contrasta con il rigore scientifico di <span xml:lang="en">Sheldon</span>; tuttavia la donna sembra essere l'unica persona in grado di comandarlo a bacchetta.</p>`],`
`,1,"text",!1);const t=new r(0,55),o=n.document.getWordRangeAtPosition(t);e.strictEqual(o.start.line,0),e.strictEqual(o.end.line,0),e.strictEqual(o.start.character,47),e.strictEqual(o.end.character,61),e.strictEqual(n.document.getText(o),"soprannominato")})});var L=(i=>(i[i.OffsetToPosition=0]="OffsetToPosition",i[i.PositionToOffset=1]="PositionToOffset",i))(L||{});suite("ExtHostDocumentData updates line mapping",()=>{function n(s){return"("+s.line+","+s.character+")"}function l(s,a){const d=s.getText();let g=0,m=0,p=!1;for(let h=0;h<=d.length;h++){const w=new r(g,m+(p?-1:0));if(a===0){const E=s.document.positionAt(h);e.strictEqual(n(E),n(w),"positionAt mismatch for offset "+h)}else{const E=h+(p?-1:0),A=s.document.offsetAt(w);e.strictEqual(A,E,"offsetAt mismatch for position "+n(w))}d.charAt(h)===`
`?(g++,m=0):m++,p=d.charAt(h)==="\r"}}function i(s,a,d){return{changes:[{range:s,rangeOffset:void 0,rangeLength:void 0,text:a}],eol:d,versionId:void 0,isRedoing:!1,isUndoing:!1}}function t(s,a,d,g){const m=new f(void 0,c.file(""),s.slice(0),a,1,"text",!1);l(m,d),m.onEvents(g),l(m,d)}function o(s,a){t(s,`
`,1,a),t(s,`
`,0,a),t(s,`\r
`,1,a),t(s,`\r
`,0,a)}b(),test("line mapping",()=>{o(["This is line one","and this is line number two","it is followed by #3","and finished with the fourth."],{changes:[],eol:void 0,versionId:7,isRedoing:!1,isUndoing:!1})}),test("after remove",()=>{o(["This is line one","and this is line number two","it is followed by #3","and finished with the fourth."],i(new u(1,3,1,6),""))}),test("after replace",()=>{o(["This is line one","and this is line number two","it is followed by #3","and finished with the fourth."],i(new u(1,3,1,6),"is could be"))}),test("after insert line",()=>{o(["This is line one","and this is line number two","it is followed by #3","and finished with the fourth."],i(new u(1,3,1,6),`is could be
a line with number`))}),test("after insert two lines",()=>{o(["This is line one","and this is line number two","it is followed by #3","and finished with the fourth."],i(new u(1,3,1,6),`is could be
a line with number
yet another line`))}),test("after remove line",()=>{o(["This is line one","and this is line number two","it is followed by #3","and finished with the fourth."],i(new u(1,3,2,6),""))}),test("after remove two lines",()=>{o(["This is line one","and this is line number two","it is followed by #3","and finished with the fourth."],i(new u(1,3,3,6),""))}),test("after deleting entire content",()=>{o(["This is line one","and this is line number two","it is followed by #3","and finished with the fourth."],i(new u(1,3,4,30),""))}),test("after replacing entire content",()=>{o(["This is line one","and this is line number two","it is followed by #3","and finished with the fourth."],i(new u(1,3,4,30),`some new text
that
spans multiple lines`))}),test("after changing EOL to CRLF",()=>{o(["This is line one","and this is line number two","it is followed by #3","and finished with the fourth."],i(new u(1,1,1,1),"",`\r
`))}),test("after changing EOL to LF",()=>{o(["This is line one","and this is line number two","it is followed by #3","and finished with the fourth."],i(new u(1,1,1,1),"",`
`))})});
