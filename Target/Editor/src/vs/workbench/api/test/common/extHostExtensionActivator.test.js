import o from"assert";import{promiseWithResolvers as h,timeout as d}from"../../../../base/common/async.js";import"../../../../base/common/types.js";import{URI as I}from"../../../../base/common/uri.js";import{ensureNoDisposablesAreLeakedInTestSuite as S}from"../../../../base/test/common/utils.js";import{ExtensionIdentifier as w,TargetPlatform as g}from"../../../../platform/extensions/common/extensions.js";import{NullLogService as b}from"../../../../platform/log/common/log.js";import{EmptyExtension as f,ExtensionActivationTimes as A,ExtensionsActivator as q}from"../../common/extHostExtensionActivator.js";import{ExtensionDescriptionRegistry as y}from"../../../services/extensions/common/extensionDescriptionRegistry.js";import"../../../services/extensions/common/extensions.js";suite("ExtensionsActivator",()=>{S();const n=new w("a"),a=new w("b"),E=new w("c");test("calls activate only once with sequential activations",async()=>{const t=new p,e=l(t,[r(n)]);await e.activateByEvent("*",!1),o.deepStrictEqual(t.activateCalls,[n]),await e.activateByEvent("*",!1),o.deepStrictEqual(t.activateCalls,[n])}),test("calls activate only once with parallel activations",async()=>{const t=new v,e=new u([[n,t]]),i=l(e,[r(n,[],["evt1","evt2"])]),s=i.activateByEvent("evt1",!1),c=i.activateByEvent("evt2",!1);t.resolve(),await s,await c,o.deepStrictEqual(e.activateCalls,[n])}),test("activates dependencies first",async()=>{const t=new v,e=new v,i=new u([[n,t],[a,e]]),c=l(i,[r(n,[a],["evt1"]),r(a,[],["evt1"])]).activateByEvent("evt1",!1);await d(0),o.deepStrictEqual(i.activateCalls,[a]),e.resolve(),await d(0),o.deepStrictEqual(i.activateCalls,[a,n]),t.resolve(),await d(0),await c,o.deepStrictEqual(i.activateCalls,[a,n])}),test("Supports having resolved extensions",async()=>{const t=new p,e=r(a);delete e.main,delete e.browser,await l(t,[r(n,[a])],[e]).activateByEvent("*",!1),o.deepStrictEqual(t.activateCalls,[n])}),test("Supports having external extensions",async()=>{const t=new v,e=new v,i=new u([[n,t],[a,e]]),s=r(a);s.api="none";const x=l(i,[r(n,[a])],[s]).activateByEvent("*",!1);await d(0),o.deepStrictEqual(i.activateCalls,[a]),e.resolve(),await d(0),o.deepStrictEqual(i.activateCalls,[a,n]),t.resolve(),await x,o.deepStrictEqual(i.activateCalls,[a,n])}),test("Error: activateById with missing extension",async()=>{const t=new p,e=l(t,[r(n),r(a)]);let i;try{await e.activateById(E,{startup:!1,extensionId:E,activationEvent:"none"})}catch(s){i=s}o.strictEqual(typeof i>"u",!1)}),test("Error: dependency missing",async()=>{const t=new p;await l(t,[r(n,[a])]).activateByEvent("*",!1),o.deepStrictEqual(t.errors.length,1),o.deepStrictEqual(t.errors[0][0],n)}),test("Error: dependency activation failed",async()=>{const t=new v,e=new v,i=new u([[n,t],[a,e]]),c=l(i,[r(n,[a]),r(a)]).activateByEvent("*",!1);e.reject(new Error("b fails!")),await c,o.deepStrictEqual(i.errors.length,2),o.deepStrictEqual(i.errors[0][0],a),o.deepStrictEqual(i.errors[1][0],n)}),test("issue #144518: Problem with git extension and vscode-icons",async()=>{const t=new v,e=new v,i=new v,s=new u([[n,t],[a,e],[E,i]]);l(s,[r(n,[a]),r(a),r(E)]).activateByEvent("*",!1),o.deepStrictEqual(s.activateCalls,[a,E]),e.resolve(),await d(0),o.deepStrictEqual(s.activateCalls,[a,E,n]),t.resolve()});class p{activateCalls=[];errors=[];onExtensionActivationError(e,i,s){this.errors.push([e,i,s])}actualActivateExtension(e,i){return this.activateCalls.push(e),Promise.resolve(new f(A.NONE))}}class u extends p{constructor(i){super();this._promises=i}actualActivateExtension(i,s){this.activateCalls.push(i);for(const[c,x]of this._promises)if(c.value===i.value)return x.promise;throw new Error("Unexpected!")}}class v{_resolve;_reject;promise;constructor(){({promise:this.promise,resolve:this._resolve,reject:this._reject}=h())}resolve(){this._resolve(new f(A.NONE))}reject(e){this._reject(e)}}const m={readActivationEvents:t=>t.activationEvents??[]};function l(t,e,i=[]){const s=new y(m,e),c=new y(m,e.concat(i));return new q(s,c,t,new b)}function r(t,e=[],i=["*"]){return{name:t.value,publisher:"test",version:"0.0.0",engines:{vscode:"^1.0.0"},identifier:t,extensionLocation:I.parse("nothing://nowhere"),isBuiltin:!1,isUnderDevelopment:!1,isUserBuiltin:!1,activationEvents:i,main:"index.js",targetPlatform:g.UNDEFINED,extensionDependencies:e.map(s=>s.value),enabledApiProposals:void 0}}});
