var D=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var g=(a,s,e,t)=>{for(var i=t>1?void 0:t?M(s,e):s,n=a.length-1,r;n>=0;n--)(r=a[n])&&(i=(t?r(s,e,i):r(i))||i);return t&&i&&D(s,e,i),i},I=(a,s)=>(e,t)=>s(e,t,a);import{Event as G,Emitter as T}from"../../../base/common/event.js";import{EditorsOrder as S,EditorExtensions as m,SideBySideEditor as k,EditorCloseContext as v,GroupModelChangeKind as h}from"../editor.js";import{EditorInput as _}from"./editorInput.js";import{SideBySideEditorInput as f}from"./sideBySideEditorInput.js";import{IInstantiationService as R}from"../../../platform/instantiation/common/instantiation.js";import{IConfigurationService as w}from"../../../platform/configuration/common/configuration.js";import{dispose as C,Disposable as A,DisposableStore as L}from"../../../base/common/lifecycle.js";import{Registry as b}from"../../../platform/registry/common/platform.js";import{coalesce as x}from"../../../base/common/arrays.js";const y={LEFT:"left",RIGHT:"right",FIRST:"first",LAST:"last"};function P(a){const s=a;return!!(s&&typeof s=="object"&&Array.isArray(s.editors)&&Array.isArray(s.mru))}function Z(a){const s=a;return s.editor&&s.editorIndex!==void 0}function $(a){const s=a;return s.kind===h.EDITOR_OPEN&&s.editorIndex!==void 0}function ee(a){const s=a;return s.kind===h.EDITOR_MOVE&&s.editorIndex!==void 0&&s.oldEditorIndex!==void 0}function te(a){const s=a;return s.kind===h.EDITOR_CLOSE&&s.editorIndex!==void 0&&s.context!==void 0&&s.sticky!==void 0}let c=class extends A{constructor(e,t,i){super();this.instantiationService=t;this.configurationService=i;P(e)?this._id=this.deserialize(e):this._id=c.IDS++,this.onConfigurationUpdated(),this.registerListeners()}static IDS=0;_onDidModelChange=this._register(new T({leakWarningThreshold:500}));onDidModelChange=this._onDidModelChange.event;_id;get id(){return this._id}editors=[];mru=[];editorListeners=new Set;locked=!1;selection=[];get active(){return this.selection[0]??null}preview=null;sticky=-1;transient=new Set;editorOpenPositioning;focusRecentEditorAfterClose;registerListeners(){this._register(this.configurationService.onDidChangeConfiguration(e=>this.onConfigurationUpdated(e)))}onConfigurationUpdated(e){e&&!e.affectsConfiguration("workbench.editor.openPositioning")&&!e.affectsConfiguration("workbench.editor.focusRecentEditorAfterClose")||(this.editorOpenPositioning=this.configurationService.getValue("workbench.editor.openPositioning"),this.focusRecentEditorAfterClose=this.configurationService.getValue("workbench.editor.focusRecentEditorAfterClose"))}get count(){return this.editors.length}get stickyCount(){return this.sticky+1}getEditors(e,t){const i=e===S.MOST_RECENTLY_ACTIVE?this.mru.slice(0):this.editors.slice(0);return t?.excludeSticky?e===S.MOST_RECENTLY_ACTIVE?i.filter(n=>!this.isSticky(n)):i.slice(this.sticky+1):i}getEditorByIndex(e){return this.editors[e]}get activeEditor(){return this.active}isActive(e){return this.matches(this.active,e)}get previewEditor(){return this.preview}openEditor(e,t){const i=t?.sticky||typeof t?.index=="number"&&this.isSticky(t.index),n=t?.pinned||t?.sticky,r=!!t?.transient,d=t?.active||!this.activeEditor||!n&&this.preview===this.activeEditor,l=this.findEditor(e,t);if(l){const[o,E]=l;return this.doSetTransient(o,E,r===!1?!1:this.isTransient(o)),n&&this.doPin(o,E),this.setSelection(d?o:this.activeEditor,t?.inactiveSelection??[]),t&&typeof t.index=="number"&&this.moveEditor(o,t.index),i&&this.doStick(o,this.indexOf(o)),{editor:o,isNew:!1}}else{const o=e,E=this.indexOf(this.active);let u;if(t&&typeof t.index=="number"?u=t.index:this.editorOpenPositioning===y.FIRST?(u=0,!i&&this.isSticky(u)&&(u=this.sticky+1)):this.editorOpenPositioning===y.LAST?u=this.editors.length:(this.editorOpenPositioning===y.LEFT?E===0||!this.editors.length?u=0:u=E:u=E+1,!i&&this.isSticky(u)&&(u=this.sticky+1)),i&&(this.sticky++,this.isSticky(u)||(u=this.sticky)),(n||!this.preview)&&this.splice(u,!1,o),r&&this.doSetTransient(o,u,!0),!n){if(this.preview){const O=this.indexOf(this.preview);u>O&&u--,this.replaceEditor(this.preview,o,u,!d)}this.preview=o}this.registerEditorListeners(o);const p={kind:h.EDITOR_OPEN,editor:o,editorIndex:u};return this._onDidModelChange.fire(p),this.setSelection(d?o:this.activeEditor,t?.inactiveSelection??[]),{editor:o,isNew:!0}}}registerEditorListeners(e){const t=new L;this.editorListeners.add(t),t.add(G.once(e.onWillDispose)(()=>{const i=this.editors.indexOf(e);if(i>=0){const n={kind:h.EDITOR_WILL_DISPOSE,editor:e,editorIndex:i};this._onDidModelChange.fire(n)}})),t.add(e.onDidChangeDirty(()=>{const i={kind:h.EDITOR_DIRTY,editor:e,editorIndex:this.editors.indexOf(e)};this._onDidModelChange.fire(i)})),t.add(e.onDidChangeLabel(()=>{const i={kind:h.EDITOR_LABEL,editor:e,editorIndex:this.editors.indexOf(e)};this._onDidModelChange.fire(i)})),t.add(e.onDidChangeCapabilities(()=>{const i={kind:h.EDITOR_CAPABILITIES,editor:e,editorIndex:this.editors.indexOf(e)};this._onDidModelChange.fire(i)})),t.add(this.onDidModelChange(i=>{i.kind===h.EDITOR_CLOSE&&i.editor?.matches(e)&&(C(t),this.editorListeners.delete(t))}))}replaceEditor(e,t,i,n=!0){const r=this.doCloseEditor(e,v.REPLACE,n);if(this.splice(i,!1,t),r){const d={kind:h.EDITOR_CLOSE,...r};this._onDidModelChange.fire(d)}}closeEditor(e,t=v.UNKNOWN,i=!0){const n=this.doCloseEditor(e,t,i);if(n){const r={kind:h.EDITOR_CLOSE,...n};return this._onDidModelChange.fire(r),n}}doCloseEditor(e,t,i){const n=this.indexOf(e);if(n===-1)return;const r=this.editors[n],d=this.isSticky(n),l=this.active===r;if(i&&l)if(this.mru.length>1){let o;this.focusRecentEditorAfterClose?o=this.mru[1]:n===this.editors.length-1?o=this.editors[n-1]:o=this.editors[n+1];const E=this.selection.filter(u=>u!==r&&u!==o);this.doSetSelection(o,this.editors.indexOf(o),E)}else this.doSetSelection(null,void 0,[]);else if(!l&&this.doIsSelected(r)){const o=this.selection.filter(E=>E!==r&&E!==this.activeEditor);this.doSetSelection(this.activeEditor,this.indexOf(this.activeEditor),o)}return this.preview===r&&(this.preview=null),this.transient.delete(r),this.splice(n,!0),{editor:r,sticky:d,editorIndex:n,context:t}}moveEditor(e,t){t>=this.editors.length?t=this.editors.length-1:t<0&&(t=0);const i=this.indexOf(e);if(i<0||t===i)return;const n=this.editors[i],r=this.sticky;this.isSticky(i)&&t>this.sticky?this.sticky--:!this.isSticky(i)&&t<=this.sticky&&this.sticky++,this.editors.splice(i,1),this.editors.splice(t,0,n);const d={kind:h.EDITOR_MOVE,editor:n,oldEditorIndex:i,editorIndex:t};if(this._onDidModelChange.fire(d),r!==this.sticky){const l={kind:h.EDITOR_STICKY,editor:n,editorIndex:t};this._onDidModelChange.fire(l)}return n}setActive(e){let t;return e?t=this.setEditorActive(e):this.setGroupActive(),t}setGroupActive(){this._onDidModelChange.fire({kind:h.GROUP_ACTIVE})}setEditorActive(e){const t=this.findEditor(e);if(!t)return;const[i,n]=t;return this.doSetSelection(i,n,[]),i}get selectedEditors(){return this.editors.filter(e=>this.doIsSelected(e))}isSelected(e){let t;return typeof e=="number"?t=this.editors[e]:t=this.findEditor(e)?.[0],!!t&&this.doIsSelected(t)}doIsSelected(e){return this.selection.includes(e)}setSelection(e,t){const i=this.findEditor(e);if(!i)return;const[n,r]=i,d=new Set;for(const l of t){const o=this.findEditor(l);if(!o)return;const[E]=o;E!==n&&d.add(E)}this.doSetSelection(n,r,Array.from(d))}doSetSelection(e,t,i){const n=this.activeEditor,r=this.selection;let d;e?d=[e,...i]:d=[],this.selection=d;const l=e&&typeof t=="number"&&n!==e;if(l){const o=this.indexOf(e,this.mru);this.mru.splice(o,1),this.mru.unshift(e);const E={kind:h.EDITOR_ACTIVE,editor:e,editorIndex:t};this._onDidModelChange.fire(E)}if(l||r.length!==d.length||r.some(o=>!d.includes(o))){const o={kind:h.EDITORS_SELECTION};this._onDidModelChange.fire(o)}}setIndex(e){this._onDidModelChange.fire({kind:h.GROUP_INDEX})}setLabel(e){this._onDidModelChange.fire({kind:h.GROUP_LABEL})}pin(e){const t=this.findEditor(e);if(!t)return;const[i,n]=t;return this.doPin(i,n),i}doPin(e,t){if(this.isPinned(e))return;this.setTransient(e,!1),this.preview=null;const i={kind:h.EDITOR_PIN,editor:e,editorIndex:t};this._onDidModelChange.fire(i)}unpin(e){const t=this.findEditor(e);if(!t)return;const[i,n]=t;return this.doUnpin(i,n),i}doUnpin(e,t){if(!this.isPinned(e))return;const i=this.preview;this.preview=e;const n={kind:h.EDITOR_PIN,editor:e,editorIndex:t};this._onDidModelChange.fire(n),i&&this.closeEditor(i,v.UNPIN)}isPinned(e){let t;return typeof e=="number"?t=this.editors[e]:t=e,!this.matches(this.preview,t)}stick(e){const t=this.findEditor(e);if(!t)return;const[i,n]=t;return this.doStick(i,n),i}doStick(e,t){if(this.isSticky(t))return;this.pin(e);const i=this.sticky+1;this.moveEditor(e,i),this.sticky++;const n={kind:h.EDITOR_STICKY,editor:e,editorIndex:i};this._onDidModelChange.fire(n)}unstick(e){const t=this.findEditor(e);if(!t)return;const[i,n]=t;return this.doUnstick(i,n),i}doUnstick(e,t){if(!this.isSticky(t))return;const i=this.sticky;this.moveEditor(e,i),this.sticky--;const n={kind:h.EDITOR_STICKY,editor:e,editorIndex:i};this._onDidModelChange.fire(n)}isSticky(e){if(this.sticky<0)return!1;let t;return typeof e=="number"?t=e:t=this.indexOf(e),t<0?!1:t<=this.sticky}setTransient(e,t){if(!t&&this.transient.size===0)return;const i=this.findEditor(e);if(!i)return;const[n,r]=i;return this.doSetTransient(n,r,t),n}doSetTransient(e,t,i){if(i){if(this.transient.has(e))return;this.transient.add(e)}else{if(!this.transient.has(e))return;this.transient.delete(e)}const n={kind:h.EDITOR_TRANSIENT,editor:e,editorIndex:t};this._onDidModelChange.fire(n)}isTransient(e){if(this.transient.size===0)return!1;let t;return typeof e=="number"?t=this.editors[e]:t=this.findEditor(e)?.[0],!!t&&this.transient.has(t)}splice(e,t,i){const n=this.editors[e];if(t&&this.isSticky(e)&&this.sticky--,i?this.editors.splice(e,t?1:0,i):this.editors.splice(e,t?1:0),!t&&i)this.mru.length===0?this.mru.push(i):this.mru.splice(1,0,i);else{const r=this.indexOf(n,this.mru);t&&!i?this.mru.splice(r,1):t&&i&&this.mru.splice(r,1,i)}}indexOf(e,t=this.editors,i){let n=-1;if(!e)return n;for(let r=0;r<t.length;r++){const d=t[r];if(this.matches(d,e,i))if(i?.supportSideBySide&&d instanceof f&&!(e instanceof f))n=r;else{n=r;break}}return n}findEditor(e,t){const i=this.indexOf(e,this.editors,t);if(i!==-1)return[this.editors[i],i]}isFirst(e,t=this.editors){return this.matches(t[0],e)}isLast(e,t=this.editors){return this.matches(t[t.length-1],e)}contains(e,t){return this.indexOf(e,this.editors,t)!==-1}matches(e,t,i){if(!e||!t)return!1;if(i?.supportSideBySide&&e instanceof f&&!(t instanceof f))switch(i.supportSideBySide){case k.ANY:if(this.matches(e.primary,t,i)||this.matches(e.secondary,t,i))return!0;break;case k.BOTH:if(this.matches(e.primary,t,i)&&this.matches(e.secondary,t,i))return!0;break}const n=e===t;return i?.strictEquals?n:n||e.matches(t)}get isLocked(){return this.locked}lock(e){this.isLocked!==e&&(this.locked=e,this._onDidModelChange.fire({kind:h.GROUP_LOCKED}))}clone(){const e=this.instantiationService.createInstance(c,void 0);e.editors=this.editors.slice(0),e.mru=this.mru.slice(0),e.preview=this.preview,e.selection=this.selection.slice(0),e.sticky=this.sticky;for(const t of e.editors)e.registerEditorListeners(t);return e}serialize(){const e=b.as(m.EditorFactory),t=[],i=[];let n,r=this.sticky;for(let l=0;l<this.editors.length;l++){const o=this.editors[l];let E=!1;const u=e.getEditorSerializer(o);if(u){const p=u.canSerialize(o)?u.serialize(o):void 0;typeof p=="string"?(E=!0,i.push({id:o.typeId,value:p}),t.push(o),this.preview===o&&(n=t.length-1)):E=!1}!E&&this.isSticky(l)&&r--}const d=this.mru.map(l=>this.indexOf(l,t)).filter(l=>l>=0);return{id:this.id,locked:this.locked?!0:void 0,editors:i,mru:d,preview:n,sticky:r>=0?r:void 0}}deserialize(e){const t=b.as(m.EditorFactory);return typeof e.id=="number"?(this._id=e.id,c.IDS=Math.max(e.id+1,c.IDS)):this._id=c.IDS++,e.locked&&(this.locked=!0),this.editors=x(e.editors.map((i,n)=>{let r;const d=t.getEditorSerializer(i.id);if(d){const l=d.deserialize(this.instantiationService,i.value);l instanceof _&&(r=l,this.registerEditorListeners(r))}return!r&&typeof e.sticky=="number"&&n<=e.sticky&&e.sticky--,r})),this.mru=x(e.mru.map(i=>this.editors[i])),this.selection=this.mru.length>0?[this.mru[0]]:[],typeof e.preview=="number"&&(this.preview=this.editors[e.preview]),typeof e.sticky=="number"&&(this.sticky=e.sticky),this._id}dispose(){C(Array.from(this.editorListeners)),this.editorListeners.clear(),this.transient.clear(),super.dispose()}};c=g([I(1,R),I(2,w)],c);export{c as EditorGroupModel,Z as isGroupEditorChangeEvent,te as isGroupEditorCloseEvent,ee as isGroupEditorMoveEvent,$ as isGroupEditorOpenEvent,P as isSerializedEditorGroupModel};
