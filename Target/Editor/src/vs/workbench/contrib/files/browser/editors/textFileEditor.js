var g=Object.defineProperty;var y=Object.getOwnPropertyDescriptor;var m=(p,s,e,r)=>{for(var i=r>1?void 0:r?y(s,e):s,t=p.length-1,n;t>=0;t--)(n=p[t])&&(i=(r?n(s,e,i):n(i))||i);return r&&i&&g(s,e,i),i},o=(p,s)=>(e,r)=>s(e,r,p);import{localize as d}from"../../../../../nls.js";import{mark as f}from"../../../../../base/common/performance.js";import{assertIsDefined as C}from"../../../../../base/common/types.js";import{IPathService as x}from"../../../../services/path/common/pathService.js";import{toAction as E}from"../../../../../base/common/actions.js";import{VIEWLET_ID as w,TEXT_FILE_EDITOR_ID as R,BINARY_TEXT_FILE_MODE as D}from"../../common/files.js";import{ITextFileService as _,TextFileOperationResult as A}from"../../../../services/textfile/common/textfiles.js";import{AbstractTextCodeEditor as b}from"../../../../browser/parts/editor/textCodeEditor.js";import{isTextEditorViewState as L,DEFAULT_EDITOR_ASSOCIATION as S,createEditorOpenError as h,createTooLargeFileError as V}from"../../../../common/editor.js";import"../../../../common/editor/editorInput.js";import{applyTextEditorOptions as B}from"../../../../common/editor/editorOptions.js";import{BinaryEditorModel as P}from"../../../../common/editor/binaryEditorModel.js";import{FileEditorInput as k}from"./fileEditorInput.js";import{FileOperationError as M,FileOperationResult as I,IFileService as N,FileOperation as z,ByteSize as W,TooLargeFileOperationError as G}from"../../../../../platform/files/common/files.js";import{ITelemetryService as U}from"../../../../../platform/telemetry/common/telemetry.js";import{IWorkspaceContextService as H}from"../../../../../platform/workspace/common/workspace.js";import{IStorageService as Y}from"../../../../../platform/storage/common/storage.js";import{ITextResourceConfigurationService as X}from"../../../../../editor/common/services/textResourceConfiguration.js";import{IInstantiationService as q}from"../../../../../platform/instantiation/common/instantiation.js";import{IThemeService as j}from"../../../../../platform/theme/common/themeService.js";import{ScrollType as J}from"../../../../../editor/common/editorCommon.js";import{IEditorService as K}from"../../../../services/editor/common/editorService.js";import{IEditorGroupsService as Q}from"../../../../services/editor/common/editorGroupsService.js";import"../../../../../base/common/cancellation.js";import{EditorActivation as Z}from"../../../../../platform/editor/common/editor.js";import{IUriIdentityService as $}from"../../../../../platform/uriIdentity/common/uriIdentity.js";import{IExplorerService as ee}from"../files.js";import{IPaneCompositePartService as re}from"../../../../services/panecomposite/browser/panecomposite.js";import{ViewContainerLocation as ie}from"../../../../common/views.js";import{IConfigurationService as te}from"../../../../../platform/configuration/common/configuration.js";import{IPreferencesService as oe}from"../../../../services/preferences/common/preferences.js";import{IHostService as ne}from"../../../../services/host/browser/host.js";import"../../../../../editor/common/config/editorOptions.js";import{IFilesConfigurationService as ae}from"../../../../services/filesConfiguration/common/filesConfigurationService.js";let l=class extends b{constructor(e,r,i,t,n,u,a,c,F,O,T,de,se,le,ce,pe,fe,Ie,ue){super(l.ID,e,r,n,a,c,O,F,T,i);this.paneCompositeService=t;this.contextService=u;this.textFileService=de;this.explorerService=se;this.uriIdentityService=le;this.pathService=ce;this.configurationService=pe;this.preferencesService=fe;this.hostService=Ie;this.filesConfigurationService=ue;this._register(this.fileService.onDidFilesChange(v=>this.onDidFilesChange(v))),this._register(this.fileService.onDidRunOperation(v=>this.onDidRunOperation(v)))}static ID=R;onDidFilesChange(e){for(const r of e.rawDeleted)this.clearEditorViewState(r)}onDidRunOperation(e){e.operation===z.MOVE&&e.target&&this.moveEditorViewState(e.resource,e.target.resource,this.uriIdentityService.extUri)}getTitle(){return this.input?this.input.getName():d("textFileEditor","Text File Editor")}get input(){return this._input}async setInput(e,r,i,t){f("code/willSetInputToTextFileEditor"),await super.setInput(e,r,i,t);try{const n=await e.resolve(r);if(t.isCancellationRequested)return;if(n instanceof P)return this.openAsBinary(e,r);const u=n,a=C(this.editorControl);if(a.setModel(u.textEditorModel),!L(r?.viewState)){const c=this.loadEditorViewState(e,i);c&&(r?.selection&&(c.cursorState=[]),a.restoreViewState(c))}r&&B(r,a,J.Immediate),a.updateOptions(this.getReadonlyConfiguration(u.isReadonly())),a.handleInitialized&&a.handleInitialized()}catch(n){await this.handleSetInputError(n,e,r)}f("code/didSetInputToTextFileEditor")}async handleSetInputError(e,r,i){if(e.textFileOperationResult===A.FILE_IS_BINARY)return this.openAsBinary(r,i);if(e.fileOperationResult===I.FILE_IS_DIRECTORY){const t=[];throw t.push(E({id:"workbench.files.action.openFolder",label:d("openFolder","Open Folder"),run:async()=>this.hostService.openWindow([{folderUri:r.resource}],{forceNewWindow:!0})})),this.contextService.isInsideWorkspace(r.preferredResource)&&t.push(E({id:"workbench.files.action.reveal",label:d("reveal","Reveal Folder"),run:async()=>(await this.paneCompositeService.openPaneComposite(w,ie.Sidebar,!0),this.explorerService.select(r.preferredResource,!0))})),h(d("fileIsDirectory","The file is not displayed in the text editor because it is a directory."),t,{forceMessage:!0})}if(e.fileOperationResult===I.FILE_TOO_LARGE){let t;throw e instanceof G?t=d("fileTooLargeForHeapErrorWithSize","The file is not displayed in the text editor because it is very large ({0}).",W.formatSize(e.size)):t=d("fileTooLargeForHeapErrorWithoutSize","The file is not displayed in the text editor because it is very large."),V(this.group,r,i,t,this.preferencesService)}throw e.fileOperationResult===I.FILE_NOT_FOUND&&!this.filesConfigurationService.isReadonly(r.preferredResource)&&await this.pathService.hasValidBasename(r.preferredResource)?h(new M(d("unavailableResourceErrorEditorText","The editor could not be opened because the file was not found."),I.FILE_NOT_FOUND),[E({id:"workbench.files.action.createMissingFile",label:d("createFile","Create File"),run:async()=>(await this.textFileService.create([{resource:r.preferredResource}]),this.editorService.openEditor({resource:r.preferredResource,options:{pinned:!0}}))})],{allowDialog:!0}):e}openAsBinary(e,r){const i=this.configurationService.getValue("workbench.editor.defaultBinaryEditor"),t={...r,activation:Z.PRESERVE};i&&i!==""&&i!==S.id?this.doOpenAsBinaryInDifferentEditor(this.group,i,e,t):this.doOpenAsBinaryInSameEditor(this.group,i,e,t)}doOpenAsBinaryInDifferentEditor(e,r,i,t){this.editorService.replaceEditors([{editor:i,replacement:{resource:i.resource,options:{...t,override:r}}}],e)}doOpenAsBinaryInSameEditor(e,r,i,t){r===S.id?(i.setForceOpenAsText(),i.setPreferredLanguageId(D),t={...t,forceReload:!0}):i.setForceOpenAsBinary(),e.openEditor(i,t)}clearInput(){super.clearInput(),this.editorControl?.setModel(null)}createEditorControl(e,r){f("code/willCreateTextFileEditorControl"),super.createEditorControl(e,r),f("code/didCreateTextFileEditorControl")}tracksEditorViewState(e){return e instanceof k}tracksDisposedEditorViewState(){return!0}};l=m([o(1,U),o(2,N),o(3,re),o(4,q),o(5,H),o(6,Y),o(7,X),o(8,K),o(9,j),o(10,Q),o(11,_),o(12,ee),o(13,$),o(14,x),o(15,te),o(16,oe),o(17,ne),o(18,ae)],l);export{l as TextFileEditor};
