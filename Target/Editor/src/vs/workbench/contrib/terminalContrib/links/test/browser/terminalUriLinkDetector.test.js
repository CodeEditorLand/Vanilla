import{IConfigurationService as u}from"../../../../../../platform/configuration/common/configuration.js";import{TestConfigurationService as h}from"../../../../../../platform/configuration/test/common/testConfigurationService.js";import{IFileService as b}from"../../../../../../platform/files/common/files.js";import{TestInstantiationService as d}from"../../../../../../platform/instantiation/test/common/instantiationServiceMock.js";import{TerminalBuiltinLinkType as e}from"../../browser/links.js";import{TerminalLinkResolver as g}from"../../browser/terminalLinkResolver.js";import{TerminalUriLinkDetector as k}from"../../browser/terminalUriLinkDetector.js";import{assertLinkHelper as w}from"./linkTestUtils.js";import{createFileStat as U}from"../../../../../test/common/workbenchTestServices.js";import{URI as r}from"../../../../../../base/common/uri.js";import{OperatingSystem as x}from"../../../../../../base/common/platform.js";import{importAMDNodeModule as v}from"../../../../../../amdX.js";import{ensureNoDisposablesAreLeakedInTestSuite as L}from"../../../../../../base/test/common/utils.js";import{NullLogService as y}from"../../../../../../platform/log/common/log.js";import{ITerminalLogService as T}from"../../../../../../platform/terminal/common/terminal.js";suite("Workbench - TerminalUriLinkDetector",()=>{const c=L();let l,p,f,i=[],a;setup(async()=>{a=c.add(new d),l=new h,a.stub(u,l),a.stub(b,{async stat(s){if(!i.map(n=>n.path).includes(s.path))throw new Error("Doesn't exist");return U(s)}}),a.stub(T,new y),i=[];const t=(await v("@xterm/xterm","lib/xterm.js")).Terminal;f=new t({allowProposedApi:!0,cols:80,rows:30}),p=a.createInstance(k,f,{initialCwd:"/parent/cwd",os:x.Linux,remoteAuthority:void 0,userHome:"/home",backend:void 0},a.createInstance(g))}),teardown(()=>{a.dispose()});async function o(t,s,n){await w(s,n,p,t)}const m=[[e.Url,'x = "http://foo.bar";',[{range:[[6,1],[19,1]],uri:r.parse("http://foo.bar")}]],[e.Url,"x = (http://foo.bar);",[{range:[[6,1],[19,1]],uri:r.parse("http://foo.bar")}]],[e.Url,"x = 'http://foo.bar';",[{range:[[6,1],[19,1]],uri:r.parse("http://foo.bar")}]],[e.Url,"x =  http://foo.bar ;",[{range:[[6,1],[19,1]],uri:r.parse("http://foo.bar")}]],[e.Url,"x = <http://foo.bar>;",[{range:[[6,1],[19,1]],uri:r.parse("http://foo.bar")}]],[e.Url,"x = {http://foo.bar};",[{range:[[6,1],[19,1]],uri:r.parse("http://foo.bar")}]],[e.Url,"(see http://foo.bar)",[{range:[[6,1],[19,1]],uri:r.parse("http://foo.bar")}]],[e.Url,"[see http://foo.bar]",[{range:[[6,1],[19,1]],uri:r.parse("http://foo.bar")}]],[e.Url,"{see http://foo.bar}",[{range:[[6,1],[19,1]],uri:r.parse("http://foo.bar")}]],[e.Url,"<see http://foo.bar>",[{range:[[6,1],[19,1]],uri:r.parse("http://foo.bar")}]],[e.Url,"<url>http://foo.bar</url>",[{range:[[6,1],[19,1]],uri:r.parse("http://foo.bar")}]],[e.Url,"// Click here to learn more. https://go.microsoft.com/fwlink/?LinkID=513275&clcid=0x409",[{range:[[30,1],[7,2]],uri:r.parse("https://go.microsoft.com/fwlink/?LinkID=513275&clcid=0x409")}]],[e.Url,"// Click here to learn more. https://msdn.microsoft.com/en-us/library/windows/desktop/aa365247(v=vs.85).aspx",[{range:[[30,1],[28,2]],uri:r.parse("https://msdn.microsoft.com/en-us/library/windows/desktop/aa365247(v=vs.85).aspx")}]],[e.Url,"// https://github.com/projectkudu/kudu/blob/master/Kudu.Core/Scripts/selectNodeVersion.js",[{range:[[4,1],[9,2]],uri:r.parse("https://github.com/projectkudu/kudu/blob/master/Kudu.Core/Scripts/selectNodeVersion.js")}]],[e.Url,"<!-- !!! Do not remove !!!   WebContentRef(link:https://go.microsoft.com/fwlink/?LinkId=166007, area:Admin, updated:2015, nextUpdate:2016, tags:SqlServer)   !!! Do not remove !!! -->",[{range:[[49,1],[14,2]],uri:r.parse("https://go.microsoft.com/fwlink/?LinkId=166007")}]],[e.Url,"For instructions, see https://go.microsoft.com/fwlink/?LinkId=166007.</value>",[{range:[[23,1],[68,1]],uri:r.parse("https://go.microsoft.com/fwlink/?LinkId=166007")}]],[e.Url,"For instructions, see https://msdn.microsoft.com/en-us/library/windows/desktop/aa365247(v=vs.85).aspx.</value>",[{range:[[23,1],[21,2]],uri:r.parse("https://msdn.microsoft.com/en-us/library/windows/desktop/aa365247(v=vs.85).aspx")}]],[e.Url,'x = "https://en.wikipedia.org/wiki/Z\xFCrich";',[{range:[[6,1],[41,1]],uri:r.parse("https://en.wikipedia.org/wiki/Z\xFCrich")}]],[e.Url,"\u8ACB\u53C3\u95B1 http://go.microsoft.com/fwlink/?LinkId=761051\u3002",[{range:[[8,1],[53,1]],uri:r.parse("http://go.microsoft.com/fwlink/?LinkId=761051")}]],[e.Url,"\uFF08\u8ACB\u53C3\u95B1 http://go.microsoft.com/fwlink/?LinkId=761051\uFF09",[{range:[[10,1],[55,1]],uri:r.parse("http://go.microsoft.com/fwlink/?LinkId=761051")}]],[e.LocalFile,'x = "file:///foo.bar";',[{range:[[6,1],[20,1]],uri:r.parse("file:///foo.bar")}],r.parse("file:///foo.bar")],[e.LocalFile,'x = "file://c:/foo.bar";',[{range:[[6,1],[22,1]],uri:r.parse("file://c:/foo.bar")}],r.parse("file://c:/foo.bar")],[e.LocalFile,'x = "file://shares/foo.bar";',[{range:[[6,1],[26,1]],uri:r.parse("file://shares/foo.bar")}],r.parse("file://shares/foo.bar")],[e.LocalFile,'x = "file://sh\xE4res/foo.bar";',[{range:[[6,1],[26,1]],uri:r.parse("file://sh\xE4res/foo.bar")}],r.parse("file://sh\xE4res/foo.bar")],[e.Url,"Some text, then http://www.bing.com.",[{range:[[17,1],[35,1]],uri:r.parse("http://www.bing.com")}]],[e.Url,"let url = `http://***/_api/web/lists/GetByTitle('Teambuildingaanvragen')/items`;",[{range:[[12,1],[78,1]],uri:r.parse("http://***/_api/web/lists/GetByTitle('Teambuildingaanvragen')/items")}]],[e.Url,"7. At this point, ServiceMain has been called.  There is no functionality presently in ServiceMain, but you can consult the [MSDN documentation](https://msdn.microsoft.com/en-us/library/windows/desktop/ms687414(v=vs.85).aspx) to add functionality as desired!",[{range:[[66,2],[64,3]],uri:r.parse("https://msdn.microsoft.com/en-us/library/windows/desktop/ms687414(v=vs.85).aspx")}]],[e.Url,'let x = "http://[::1]:5000/connect/token"',[{range:[[10,1],[40,1]],uri:r.parse("http://[::1]:5000/connect/token")}]],[e.Url,"2. Navigate to **https://portal.azure.com**",[{range:[[18,1],[41,1]],uri:r.parse("https://portal.azure.com")}]],[e.Url,"POST|https://portal.azure.com|2019-12-05|",[{range:[[6,1],[29,1]],uri:r.parse("https://portal.azure.com")}]],[e.Url,"aa  https://foo.bar/[this is foo site]  aa",[{range:[[5,1],[38,1]],uri:r.parse("https://foo.bar/[this is foo site]")}]]];for(const t of m)test("link computer case: `"+t[1]+"`",async()=>{i=t[3]?[t[3]]:[],await o(t[0],t[1],t[2])});test("should support multiple link results",async()=>{await o(e.Url,"http://foo.bar http://bar.foo",[{range:[[1,1],[14,1]],uri:r.parse("http://foo.bar")},{range:[[16,1],[29,1]],uri:r.parse("http://bar.foo")}])}),test("should detect file:// links with :line suffix",async()=>{i=[r.file("c:/folder/file")],await o(e.LocalFile,"file:///c:/folder/file:23",[{range:[[1,1],[25,1]],uri:r.parse("file:///c:/folder/file")}])}),test("should detect file:// links with :line:col suffix",async()=>{i=[r.file("c:/folder/file")],await o(e.LocalFile,"file:///c:/folder/file:23:10",[{range:[[1,1],[28,1]],uri:r.parse("file:///c:/folder/file")}])}),test("should filter out https:// link that exceed 4096 characters",async()=>{await o(e.Url,`https://${"foobarbaz/".repeat(200)}`,[{range:[[1,1],[8,26]],uri:r.parse(`https://${"foobarbaz/".repeat(200)}`)}]),await o(e.Url,`https://${"foobarbaz/".repeat(450)}`,[])}),test("should filter out file:// links that exceed 4096 characters",async()=>{i=[r.file(`/${"foobarbaz/".repeat(200)}`)],await o(e.LocalFile,`file:///${"foobarbaz/".repeat(200)}`,[{uri:r.parse(`file:///${"foobarbaz/".repeat(200)}`),range:[[1,1],[8,26]]}]),i=[r.file(`/${"foobarbaz/".repeat(450)}`)],await o(e.LocalFile,`file:///${"foobarbaz/".repeat(450)}`,[])})});
