import c from"assert";import{FoldingModel as f,updateFoldingStateAtIndex as u}from"../../browser/viewModel/foldingModel.js";import{changeCellToKind as j,computeCellLinesContents as p,copyCellRange as o,insertCell as q,joinNotebookCells as v,moveCellRange as E,runDeleteAction as i}from"../../browser/controller/cellOperations.js";import{CellEditType as C,CellKind as a,SelectionStateType as l}from"../../common/notebookCommon.js";import{withTestNotebook as r}from"./testNotebookEditor.js";import{Range as d}from"../../../../../editor/common/core/range.js";import{ResourceTextEdit as g}from"../../../../../editor/browser/services/bulkEditService.js";import{ResourceNotebookCellEdit as b}from"../../../bulkEdit/browser/bulkCellEdits.js";import{ILanguageService as m}from"../../../../../editor/common/languages/language.js";import{ValidAnnotatedEditOperation as S}from"../../../../../editor/common/model.js";import{ensureNoDisposablesAreLeakedInTestSuite as y}from"../../../../../base/test/common/utils.js";suite("CellOperations",()=>{y(),test("Move cells - single cell",async function(){await r([["# header a","markdown",a.Markup,[],{}],["var b = 1;","javascript",a.Code,[],{}],["# header b","markdown",a.Markup,[],{}],["var b = 2;","javascript",a.Code,[],{}],["var c = 3;","javascript",a.Code,[],{}]],async(e,t)=>{t.updateSelectionsState({kind:l.Index,focus:{start:1,end:2},selections:[{start:1,end:2}]});const n=t.cellAt(1);c.ok(n),await E({notebookEditor:e,cell:n},"down"),c.strictEqual(t.cellAt(2)?.getText(),"var b = 1;"),c.strictEqual(n,t.cellAt(2))})}),test("Move cells - multiple cells in a selection",async function(){await r([["# header a","markdown",a.Markup,[],{}],["var b = 1;","javascript",a.Code,[],{}],["# header b","markdown",a.Markup,[],{}],["var b = 2;","javascript",a.Code,[],{}],["var c = 3;","javascript",a.Code,[],{}]],async(e,t)=>{t.updateSelectionsState({kind:l.Index,focus:{start:1,end:2},selections:[{start:0,end:2}]}),await E({notebookEditor:e},"down"),c.strictEqual(t.cellAt(0)?.getText(),"# header b"),c.strictEqual(t.cellAt(1)?.getText(),"# header a"),c.strictEqual(t.cellAt(2)?.getText(),"var b = 1;")})}),test("Move cells - move with folding ranges",async function(){await r([["# header a","markdown",a.Markup,[],{}],["var b = 1;","javascript",a.Code,[],{}],["# header b","markdown",a.Markup,[],{}],["var b = 2;","javascript",a.Code,[],{}],["var c = 3;","javascript",a.Code,[],{}]],async(e,t,n)=>{const s=n.add(new f);s.attachViewModel(t),u(s,0,!0),u(s,1,!0),t.updateFoldingRanges(s.regions),e.setHiddenAreas([{start:1,end:2}]),e.setHiddenAreas(t.getHiddenRanges()),t.updateSelectionsState({kind:l.Index,focus:{start:0,end:1},selections:[{start:0,end:1}]}),await E({notebookEditor:e},"down"),c.strictEqual(t.cellAt(0)?.getText(),"# header b"),c.strictEqual(t.cellAt(1)?.getText(),"# header a"),c.strictEqual(t.cellAt(2)?.getText(),"var b = 1;")})}),test("Copy/duplicate cells - single cell",async function(){await r([["# header a","markdown",a.Markup,[],{}],["var b = 1;","javascript",a.Code,[],{}],["# header b","markdown",a.Markup,[],{}],["var b = 2;","javascript",a.Code,[],{}],["var c = 3;","javascript",a.Code,[],{}]],async(e,t)=>{t.updateSelectionsState({kind:l.Index,focus:{start:1,end:2},selections:[{start:1,end:2}]}),await o({notebookEditor:e,cell:t.cellAt(1)},"down"),c.strictEqual(t.length,6),c.strictEqual(t.cellAt(1)?.getText(),"var b = 1;"),c.strictEqual(t.cellAt(2)?.getText(),"var b = 1;")})}),test("Copy/duplicate cells - target and selection are different, #119769",async function(){await r([["# header a","markdown",a.Markup,[],{}],["var b = 1;","javascript",a.Code,[],{}],["# header b","markdown",a.Markup,[],{}],["var b = 2;","javascript",a.Code,[],{}],["var c = 3;","javascript",a.Code,[],{}]],async(e,t)=>{t.updateSelectionsState({kind:l.Index,focus:{start:0,end:1},selections:[{start:0,end:1}]}),await o({notebookEditor:e,cell:t.cellAt(1),ui:!0},"down"),c.strictEqual(t.length,6),c.strictEqual(t.cellAt(1)?.getText(),"var b = 1;"),c.strictEqual(t.cellAt(2)?.getText(),"var b = 1;")})}),test("Copy/duplicate cells - multiple cells in a selection",async function(){await r([["# header a","markdown",a.Markup,[],{}],["var b = 1;","javascript",a.Code,[],{}],["# header b","markdown",a.Markup,[],{}],["var b = 2;","javascript",a.Code,[],{}],["var c = 3;","javascript",a.Code,[],{}]],async(e,t)=>{t.updateSelectionsState({kind:l.Index,focus:{start:1,end:2},selections:[{start:0,end:2}]}),await o({notebookEditor:e,cell:t.cellAt(1)},"down"),c.strictEqual(t.length,7),c.strictEqual(t.cellAt(0)?.getText(),"# header a"),c.strictEqual(t.cellAt(1)?.getText(),"var b = 1;"),c.strictEqual(t.cellAt(2)?.getText(),"# header a"),c.strictEqual(t.cellAt(3)?.getText(),"var b = 1;")})}),test("Copy/duplicate cells - move with folding ranges",async function(){await r([["# header a","markdown",a.Markup,[],{}],["var b = 1;","javascript",a.Code,[],{}],["# header b","markdown",a.Markup,[],{}],["var b = 2;","javascript",a.Code,[],{}],["var c = 3;","javascript",a.Code,[],{}]],async(e,t,n)=>{const s=n.add(new f);s.attachViewModel(t),u(s,0,!0),u(s,1,!0),t.updateFoldingRanges(s.regions),e.setHiddenAreas([{start:1,end:2}]),e.setHiddenAreas(t.getHiddenRanges()),t.updateSelectionsState({kind:l.Index,focus:{start:0,end:1},selections:[{start:0,end:1}]}),await o({notebookEditor:e,cell:t.cellAt(1)},"down"),c.strictEqual(t.length,7),c.strictEqual(t.cellAt(0)?.getText(),"# header a"),c.strictEqual(t.cellAt(1)?.getText(),"var b = 1;"),c.strictEqual(t.cellAt(2)?.getText(),"# header a"),c.strictEqual(t.cellAt(3)?.getText(),"var b = 1;")})}),test("Copy/duplicate cells - should not share the same text buffer #102423",async function(){await r([["# header a","markdown",a.Markup,[],{}],["var b = 1;","javascript",a.Code,[],{}]],async(e,t)=>{t.updateSelectionsState({kind:l.Index,focus:{start:1,end:2},selections:[{start:1,end:2}]}),await o({notebookEditor:e,cell:t.cellAt(1)},"down"),c.strictEqual(t.length,3);const n=t.cellAt(1),s=t.cellAt(2);c.ok(n),c.ok(s),c.strictEqual(n.getText(),"var b = 1;"),c.strictEqual(t.cellAt(2)?.getText(),"var b = 1;"),n.textBuffer.applyEdits([new S(null,new d(1,1,1,4),"",!1,!1,!1)],!1,!0),c.notStrictEqual(n.getText(),s.getText())})}),test("Join cell with below - single cell",async function(){await r([["# header a","markdown",a.Markup,[],{}],["var b = 1;","javascript",a.Code,[],{}],["# header b","markdown",a.Markup,[],{}],["var b = 2;","javascript",a.Code,[],{}],["var c = 3;","javascript",a.Code,[],{}]],async(e,t,n)=>{t.updateSelectionsState({kind:l.Index,focus:{start:3,end:4},selections:[{start:3,end:4}]});const s=await v(e,{start:3,end:4},"below");c.strictEqual(s?.edits.length,2),c.deepStrictEqual(s?.edits[0],new g(t.cellAt(3).uri,{range:new d(1,11,1,11),text:t.cellAt(4).textBuffer.getEOL()+"var c = 3;"})),c.deepStrictEqual(s?.edits[1],new b(e.textModel.uri,{editType:C.Replace,index:4,count:1,cells:[]}))})}),test("Join cell with above - single cell",async function(){await r([["# header a","markdown",a.Markup,[],{}],["var b = 1;","javascript",a.Code,[],{}],["# header b","markdown",a.Markup,[],{}],["var b = 2;","javascript",a.Code,[],{}],["var c = 3;","javascript",a.Code,[],{}]],async(e,t,n)=>{t.updateSelectionsState({kind:l.Index,focus:{start:3,end:4},selections:[{start:3,end:4}]});const s=await v(e,{start:4,end:5},"above");c.strictEqual(s?.edits.length,2),c.deepStrictEqual(s?.edits[0],new g(t.cellAt(3).uri,{range:new d(1,11,1,11),text:t.cellAt(4).textBuffer.getEOL()+"var c = 3;"})),c.deepStrictEqual(s?.edits[1],new b(e.textModel.uri,{editType:C.Replace,index:4,count:1,cells:[]}))})}),test("Join cell with below - multiple cells",async function(){await r([["var a = 1;","javascript",a.Code,[],{}],["var b = 2;","javascript",a.Code,[],{}],["var c = 3;","javascript",a.Code,[],{}]],async(e,t,n)=>{t.updateSelectionsState({kind:l.Index,focus:{start:1,end:2},selections:[{start:0,end:2}]});const s=await v(e,{start:0,end:2},"below");c.strictEqual(s?.edits.length,2),c.deepStrictEqual(s?.edits[0],new g(t.cellAt(0).uri,{range:new d(1,11,1,11),text:t.cellAt(1).textBuffer.getEOL()+"var b = 2;"+t.cellAt(2).textBuffer.getEOL()+"var c = 3;"})),c.deepStrictEqual(s?.edits[1],new b(e.textModel.uri,{editType:C.Replace,index:1,count:2,cells:[]}))})}),test("Join cell with above - multiple cells",async function(){await r([["var a = 1;","javascript",a.Code,[],{}],["var b = 2;","javascript",a.Code,[],{}],["var c = 3;","javascript",a.Code,[],{}]],async(e,t,n)=>{t.updateSelectionsState({kind:l.Index,focus:{start:2,end:3},selections:[{start:1,end:3}]});const s=await v(e,{start:1,end:3},"above");c.strictEqual(s?.edits.length,2),c.deepStrictEqual(s?.edits[0],new g(t.cellAt(0).uri,{range:new d(1,11,1,11),text:t.cellAt(1).textBuffer.getEOL()+"var b = 2;"+t.cellAt(2).textBuffer.getEOL()+"var c = 3;"})),c.deepStrictEqual(s?.edits[1],new b(e.textModel.uri,{editType:C.Replace,index:1,count:2,cells:[]}))})}),test("Delete focus cell",async function(){await r([["var a = 1;","javascript",a.Code,[],{}],["var b = 2;","javascript",a.Code,[],{}],["var c = 3;","javascript",a.Code,[],{}]],async(e,t)=>{e.setFocus({start:0,end:1}),e.setSelections([{start:0,end:1}]),i(e,t.cellAt(0)),c.strictEqual(t.length,2)})}),test("Delete selected cells",async function(){await r([["var a = 1;","javascript",a.Code,[],{}],["var b = 2;","javascript",a.Code,[],{}],["var c = 3;","javascript",a.Code,[],{}]],async(e,t)=>{e.setFocus({start:0,end:1}),e.setSelections([{start:0,end:2}]),i(e,t.cellAt(0)),c.strictEqual(t.length,1)})}),test("Delete focus cell out of a selection",async function(){await r([["var a = 1;","javascript",a.Code,[],{}],["var b = 2;","javascript",a.Code,[],{}],["var c = 3;","javascript",a.Code,[],{}],["var d = 4;","javascript",a.Code,[],{}]],async(e,t)=>{e.setFocus({start:0,end:1}),e.setSelections([{start:2,end:4}]),i(e,t.cellAt(0)),c.strictEqual(t.length,3)})}),test("Delete UI target",async function(){await r([["var a = 1;","javascript",a.Code,[],{}],["var b = 2;","javascript",a.Code,[],{}],["var c = 3;","javascript",a.Code,[],{}]],async(e,t)=>{e.setFocus({start:0,end:1}),e.setSelections([{start:0,end:1}]),i(e,t.cellAt(2)),c.strictEqual(t.length,2),c.strictEqual(t.cellAt(0)?.getText(),"var a = 1;"),c.strictEqual(t.cellAt(1)?.getText(),"var b = 2;")})}),test("Delete UI target 2",async function(){await r([["var a = 1;","javascript",a.Code,[],{}],["var b = 2;","javascript",a.Code,[],{}],["var c = 3;","javascript",a.Code,[],{}],["var d = 4;","javascript",a.Code,[],{}],["var e = 5;","javascript",a.Code,[],{}]],async(e,t)=>{e.setFocus({start:0,end:1}),e.setSelections([{start:0,end:1},{start:3,end:5}]),i(e,t.cellAt(1)),c.strictEqual(t.length,4),c.deepStrictEqual(e.getFocus(),{start:0,end:1}),c.deepStrictEqual(t.getSelections(),[{start:0,end:1},{start:2,end:4}])})}),test("Delete UI target 3",async function(){await r([["var a = 1;","javascript",a.Code,[],{}],["var b = 2;","javascript",a.Code,[],{}],["var c = 3;","javascript",a.Code,[],{}],["var d = 4;","javascript",a.Code,[],{}],["var e = 5;","javascript",a.Code,[],{}]],async(e,t)=>{e.setFocus({start:0,end:1}),e.setSelections([{start:2,end:3}]),i(e,t.cellAt(0)),c.strictEqual(t.length,4),c.deepStrictEqual(e.getFocus(),{start:0,end:1}),c.deepStrictEqual(t.getSelections(),[{start:1,end:2}])})}),test("Delete UI target 4",async function(){await r([["var a = 1;","javascript",a.Code,[],{}],["var b = 2;","javascript",a.Code,[],{}],["var c = 3;","javascript",a.Code,[],{}],["var d = 4;","javascript",a.Code,[],{}],["var e = 5;","javascript",a.Code,[],{}]],async(e,t)=>{e.setFocus({start:2,end:3}),e.setSelections([{start:3,end:5}]),i(e,t.cellAt(0)),c.strictEqual(t.length,4),c.deepStrictEqual(e.getFocus(),{start:1,end:2}),c.deepStrictEqual(t.getSelections(),[{start:2,end:4}])})}),test("Delete last cell sets selection correctly",async function(){await r([["var a = 1;","javascript",a.Code,[],{}],["var b = 2;","javascript",a.Code,[],{}],["var c = 3;","javascript",a.Code,[],{}]],async(e,t)=>{e.setFocus({start:2,end:3}),e.setSelections([{start:2,end:3}]),i(e,t.cellAt(2)),c.strictEqual(t.length,2),c.deepStrictEqual(e.getFocus(),{start:1,end:2})})}),test("#120187. Delete should work on multiple distinct selection",async function(){await r([["var a = 1;","javascript",a.Code,[],{}],["var b = 2;","javascript",a.Code,[],{}],["var c = 3;","javascript",a.Code,[],{}],["var d = 4;","javascript",a.Code,[],{}]],async(e,t)=>{e.setFocus({start:0,end:1}),e.setSelections([{start:0,end:1},{start:3,end:4}]),i(e,t.cellAt(0)),c.strictEqual(t.length,2),c.deepStrictEqual(e.getFocus(),{start:0,end:1})})}),test("#120187. Delete should work on multiple distinct selection 2",async function(){await r([["var a = 1;","javascript",a.Code,[],{}],["var b = 2;","javascript",a.Code,[],{}],["var c = 3;","javascript",a.Code,[],{}],["var d = 4;","javascript",a.Code,[],{}],["var e = 5;","javascript",a.Code,[],{}]],async(e,t)=>{e.setFocus({start:1,end:2}),e.setSelections([{start:1,end:2},{start:3,end:5}]),i(e,t.cellAt(1)),c.strictEqual(t.length,2),c.deepStrictEqual(e.getFocus(),{start:1,end:2})})}),test("Change cell kind - single cell",async function(){await r([["# header a","markdown",a.Markup,[],{}],["var b = 1;","javascript",a.Code,[],{}],["# header b","markdown",a.Markup,[],{}],["var b = 2;","javascript",a.Code,[],{}],["var c = 3;","javascript",a.Code,[],{}]],async(e,t)=>{t.updateSelectionsState({kind:l.Index,focus:{start:1,end:2},selections:[{start:1,end:2}]}),await j(a.Markup,{notebookEditor:e,cell:t.cellAt(1),ui:!0}),c.strictEqual(t.cellAt(1)?.cellKind,a.Markup)})}),test("Change cell kind - multi cells",async function(){await r([["# header a","markdown",a.Markup,[],{}],["var b = 1;","javascript",a.Code,[],{}],["# header b","markdown",a.Markup,[],{}],["var b = 2;","javascript",a.Code,[],{}],["var c = 3;","javascript",a.Code,[],{}]],async(e,t)=>{t.updateSelectionsState({kind:l.Index,focus:{start:1,end:2},selections:[{start:1,end:2}]}),await j(a.Markup,{notebookEditor:e,selectedCells:[t.cellAt(3),t.cellAt(4)],ui:!1}),c.strictEqual(t.cellAt(3)?.cellKind,a.Markup),c.strictEqual(t.cellAt(4)?.cellKind,a.Markup)})}),test("split cell",async function(){await r([["var b = 1;","javascript",a.Code,[],{}]],(e,t)=>{c.deepStrictEqual(p(t.cellAt(0),[{lineNumber:1,column:4}]),["var"," b = 1;"]),c.deepStrictEqual(p(t.cellAt(0),[{lineNumber:1,column:4},{lineNumber:1,column:6}]),["var"," b"," = 1;"]),c.deepStrictEqual(p(t.cellAt(0),[{lineNumber:1,column:1}]),["","var b = 1;"]),c.deepStrictEqual(p(t.cellAt(0),[{lineNumber:1,column:11}]),["var b = 1;",""])})}),test("Insert cell",async function(){await r([["# header a","markdown",a.Markup,[],{}],["var b = 1;","javascript",a.Code,[],{}],["# header b","markdown",a.Markup,[],{}],["var b = 2;","javascript",a.Code,[],{}],["var c = 3;","javascript",a.Code,[],{}]],async(e,t,n,s)=>{const k=s.get(m),A=q(k,e,4,a.Code,"above","var a = 0;");c.strictEqual(t.length,6),c.strictEqual(t.cellAt(4),A);const h=q(k,e,1,a.Code,"below","var a = 0;");c.strictEqual(t.length,7),c.strictEqual(t.cellAt(2),h)})})});
