import t from"assert";import{DisposableStore as w}from"../../../../../base/common/lifecycle.js";import{Mimes as e}from"../../../../../base/common/mime.js";import{URI as x}from"../../../../../base/common/uri.js";import{ensureNoDisposablesAreLeakedInTestSuite as S}from"../../../../../base/test/common/utils.js";import{ILanguageService as k}from"../../../../../editor/common/languages/language.js";import"../../../../../platform/instantiation/test/common/instantiationServiceMock.js";import{CellKind as j,CellUri as m,diff as f,MimeTypeDisplayOrder as l,NotebookWorkingCopyTypeIdentifier as q}from"../../common/notebookCommon.js";import{cellIndexesToRanges as r,cellRangesToIndexes as g,reduceCellRanges as p}from"../../common/notebookRange.js";import{setupInstantiationService as h,TestCell as E}from"./testNotebookEditor.js";suite("NotebookCommon",()=>{S();let n,i,o;setup(()=>{n=new w,i=h(n),o=i.get(k)}),test("sortMimeTypes default orders",function(){t.deepStrictEqual(new l().sort(["application/json","application/javascript","text/html","image/svg+xml",e.latex,e.markdown,"image/png","image/jpeg",e.text]),["application/json","application/javascript","text/html","image/svg+xml",e.latex,e.markdown,"image/png","image/jpeg",e.text]),t.deepStrictEqual(new l().sort(["application/json",e.latex,e.markdown,"application/javascript","text/html",e.text,"image/png","image/jpeg","image/svg+xml"]),["application/json","application/javascript","text/html","image/svg+xml",e.latex,e.markdown,"image/png","image/jpeg",e.text]),t.deepStrictEqual(new l().sort([e.markdown,"application/json",e.text,"image/jpeg","application/javascript","text/html","image/png","image/svg+xml"]),["application/json","application/javascript","text/html","image/svg+xml",e.markdown,"image/png","image/jpeg",e.text]),n.dispose()}),test("sortMimeTypes user orders",function(){t.deepStrictEqual(new l(["image/png",e.text,e.markdown,"text/html","application/json"]).sort(["application/json","application/javascript","text/html","image/svg+xml",e.markdown,"image/png","image/jpeg",e.text]),["image/png",e.text,e.markdown,"text/html","application/json","application/javascript","image/svg+xml","image/jpeg"]),t.deepStrictEqual(new l(["application/json","text/html","text/html",e.markdown,"application/json"]).sort([e.markdown,"application/json",e.text,"application/javascript","text/html","image/svg+xml","image/jpeg","image/png"]),["application/json","text/html",e.markdown,"application/javascript","image/svg+xml","image/png","image/jpeg",e.text]),n.dispose()}),test("prioritizes mimetypes",()=>{const a=new l([e.markdown,"text/html","application/json"]);t.deepStrictEqual(a.toArray(),[e.markdown,"text/html","application/json"]),a.prioritize("text/html",["application/json"]),t.deepStrictEqual(a.toArray(),[e.markdown,"text/html","application/json"]),a.prioritize("text/html",["application/json",e.markdown]),t.deepStrictEqual(a.toArray(),["text/html",e.markdown,"application/json"]),a.prioritize("text/plain",["application/json",e.markdown]),t.deepStrictEqual(a.toArray(),["text/plain","text/html",e.markdown,"application/json"]),a.prioritize(e.markdown,["text/plain","application/json",e.markdown]),t.deepStrictEqual(a.toArray(),["text/html",e.markdown,"text/plain","application/json"]),a.prioritize("text/plain",["text/plain","text/html",e.markdown]),t.deepStrictEqual(a.toArray(),["text/plain","text/html",e.markdown,"application/json"]);const c=new l(["a","b"]);c.prioritize("b",["a","b","a","q"]),t.deepStrictEqual(c.toArray(),["b","a"]),n.dispose()}),test("sortMimeTypes glob",function(){t.deepStrictEqual(new l(["application/vnd-vega*",e.markdown,"text/html","application/json"]).sort(["application/json","application/javascript","text/html","application/vnd-plot.json","application/vnd-vega.json"]),["application/vnd-vega.json","text/html","application/json","application/vnd-plot.json","application/javascript"],"glob *"),n.dispose()}),test("diff cells",function(){const a=[];for(let s=0;s<5;s++)a.push(n.add(new E("notebook",s,`var a = ${s};`,"javascript",j.Code,[],o)));t.deepStrictEqual(f(a,[],s=>a.indexOf(s)>-1),[{start:0,deleteCount:5,toInsert:[]}]),t.deepStrictEqual(f([],a,s=>!1),[{start:0,deleteCount:0,toInsert:a}]);const c=n.add(new E("notebook",6,"var a = 6;","javascript",j.Code,[],o)),u=n.add(new E("notebook",7,"var a = 7;","javascript",j.Code,[],o)),d=[a[0],a[1],c,a[3],u,a[4]],v=f(a,d,s=>a.indexOf(s)>-1);t.deepStrictEqual(v,[{start:2,deleteCount:1,toInsert:[c]},{start:4,deleteCount:0,toInsert:[u]}]),n.dispose()})}),suite("CellUri",function(){S(),test("parse, generate (file-scheme)",function(){const n=x.parse("file:///bar/f\xF8lder/file.nb"),i=17,o=m.generate(n,i),a=m.parse(o);t.ok(!!a),t.strictEqual(a?.handle,i),t.strictEqual(a?.notebook.toString(),n.toString())}),test("parse, generate (foo-scheme)",function(){const n=x.parse("foo:///bar/f\xF8lder/file.nb"),i=17,o=m.generate(n,i),a=m.parse(o);t.ok(!!a),t.strictEqual(a?.handle,i),t.strictEqual(a?.notebook.toString(),n.toString())}),test("stable order",function(){const n=x.parse("foo:///bar/f\xF8lder/file.nb"),i=[1,2,9,10,88,100,666666,7777777],u=i.map(d=>m.generate(n,d)).sort().map(String).sort().map(d=>x.parse(d)).map(d=>m.parse(d)?.handle);t.deepStrictEqual(u,i)})}),suite("CellRange",function(){S(),test("Cell range to index",function(){t.deepStrictEqual(g([]),[]),t.deepStrictEqual(g([{start:0,end:0}]),[]),t.deepStrictEqual(g([{start:0,end:1}]),[0]),t.deepStrictEqual(g([{start:0,end:2}]),[0,1]),t.deepStrictEqual(g([{start:0,end:2},{start:2,end:3}]),[0,1,2]),t.deepStrictEqual(g([{start:0,end:2},{start:3,end:4}]),[0,1,3])}),test("Cell index to range",function(){t.deepStrictEqual(r([]),[]),t.deepStrictEqual(r([0]),[{start:0,end:1}]),t.deepStrictEqual(r([0,1]),[{start:0,end:2}]),t.deepStrictEqual(r([0,1,2]),[{start:0,end:3}]),t.deepStrictEqual(r([0,1,3]),[{start:0,end:2},{start:3,end:4}]),t.deepStrictEqual(r([1,0]),[{start:0,end:2}]),t.deepStrictEqual(r([1,2,0]),[{start:0,end:3}]),t.deepStrictEqual(r([3,1,0]),[{start:0,end:2},{start:3,end:4}]),t.deepStrictEqual(r([9,10]),[{start:9,end:11}]),t.deepStrictEqual(r([10,9]),[{start:9,end:11}])}),test("Reduce ranges",function(){t.deepStrictEqual(p([{start:0,end:1},{start:1,end:2}]),[{start:0,end:2}]),t.deepStrictEqual(p([{start:0,end:2},{start:1,end:3}]),[{start:0,end:3}]),t.deepStrictEqual(p([{start:1,end:3},{start:0,end:2}]),[{start:0,end:3}]),t.deepStrictEqual(p([{start:0,end:2},{start:4,end:5}]),[{start:0,end:2},{start:4,end:5}]),t.deepStrictEqual(p([{start:0,end:1},{start:1,end:2},{start:4,end:6}]),[{start:0,end:2},{start:4,end:6}]),t.deepStrictEqual(p([{start:0,end:1},{start:1,end:3},{start:3,end:4}]),[{start:0,end:4}])}),test("Reduce ranges 2, empty ranges",function(){t.deepStrictEqual(p([{start:0,end:0},{start:0,end:0}]),[{start:0,end:0}]),t.deepStrictEqual(p([{start:0,end:0},{start:1,end:2}]),[{start:1,end:2}]),t.deepStrictEqual(p([{start:2,end:2}]),[{start:2,end:2}])})}),suite("NotebookWorkingCopyTypeIdentifier",function(){S(),test("works",function(){const n="testViewType",i=q.create("testViewType");t.strictEqual(q.parse(i),n),t.strictEqual(q.parse("something"),void 0)})});
