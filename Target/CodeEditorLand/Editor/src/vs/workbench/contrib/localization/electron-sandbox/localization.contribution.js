var _=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var L=(d,c,n,e)=>{for(var t=e>1?void 0:e?D(c,n):c,i=d.length-1,s;i>=0;i--)(s=d[i])&&(t=(e?s(c,n,t):s(t))||t);return e&&t&&_(c,n,t),t},o=(d,c)=>(n,e)=>c(n,e,d);import{localize as y}from"../../../../nls.js";import{Registry as k}from"../../../../platform/registry/common/platform.js";import{Extensions as U}from"../../../common/contributions.js";import{LifecyclePhase as M}from"../../../services/lifecycle/common/lifecycle.js";import*as u from"../../../../base/common/platform.js";import{IExtensionManagementService as W,IExtensionGalleryService as K,InstallOperation as V}from"../../../../platform/extensionManagement/common/extensionManagement.js";import{INotificationService as $,NeverShowAgainScope as z}from"../../../../platform/notification/common/notification.js";import w from"../../../../base/common/severity.js";import{IStorageService as F,StorageScope as N,StorageTarget as Y}from"../../../../platform/storage/common/storage.js";import{VIEWLET_ID as q}from"../../extensions/common/extensions.js";import{minimumTranslatedStrings as x}from"./minimalTranslations.js";import{ITelemetryService as J}from"../../../../platform/telemetry/common/telemetry.js";import{CancellationToken as P}from"../../../../base/common/cancellation.js";import{IPaneCompositePartService as j}from"../../../services/panecomposite/browser/panecomposite.js";import{ViewContainerLocation as B}from"../../../common/views.js";import{ILocaleService as X}from"../../../services/localization/common/locale.js";import{IProductService as H}from"../../../../platform/product/common/productService.js";import{BaseLocalizationWorkbenchContribution as Q}from"../common/localization.contribution.js";let l=class extends Q{constructor(n,e,t,i,s,r,g,v){super();this.notificationService=n;this.localeService=e;this.productService=t;this.storageService=i;this.extensionManagementService=s;this.galleryService=r;this.paneCompositeService=g;this.telemetryService=v;this.checkAndInstall(),this._register(this.extensionManagementService.onDidInstallExtensions(m=>this.onDidInstallExtensions(m))),this._register(this.extensionManagementService.onDidUninstallExtension(m=>this.onDidUninstallExtension(m)))}static LANGUAGEPACK_SUGGESTION_IGNORE_STORAGE_KEY="extensionsAssistant/languagePackSuggestionIgnore";async onDidInstallExtensions(n){for(const e of n)e.operation===V.Install&&e.local&&await this.onDidInstallExtension(e.local,!!e.context?.extensionsSync)}async onDidInstallExtension(n,e){const t=n.manifest.contributes?.localizations?.[0];if(!t||u.language===t.languageId)return;const{languageId:i,languageName:s}=t;this.notificationService.prompt(w.Info,y("updateLocale","Would you like to change {0}'s display language to {1} and restart?",this.productService.nameLong,s||i),[{label:y("changeAndRestart","Change Language and Restart"),run:async()=>{await this.localeService.setLocale({id:i,label:s??i,extensionId:n.identifier.id},!0)}}],{sticky:!0,neverShowAgain:{id:"langugage.update.donotask",isSecondary:!0,scope:z.APPLICATION}})}async onDidUninstallExtension(n){await this.isLocaleInstalled(u.language)||this.localeService.setLocale({id:"en",label:"English"})}async checkAndInstall(){const n=u.language;let e=u.locale??"";const t=JSON.parse(this.storageService.get(l.LANGUAGEPACK_SUGGESTION_IGNORE_STORAGE_KEY,N.APPLICATION,"[]"));if(!this.galleryService.isEnabled()||!n||!e||u.Language.isDefaultVariant()||e.startsWith(n)||t.includes(e)||await this.isLocaleInstalled(e))return;const s=e;let r=await this.galleryService.query({text:`tag:lp-${e}`},P.None);if(r.total===0&&(e=e.split("-")[0],r=await this.galleryService.query({text:`tag:lp-${e}`},P.None),r.total===0))return;const g=r.total===1?r.firstPage[0]:r.firstPage.find(a=>a.publisher==="MS-CEINTL"&&a.name.startsWith("vscode-language-pack")),v=g??r.firstPage[0];if(!v.assets.manifest)return;const[m,T]=await Promise.all([this.galleryService.getManifest(v,P.None),this.galleryService.getCoreTranslation(v,e)]),S=m?.contributes?.localizations?.find(a=>e.startsWith(a.languageId.toLowerCase())),f=S&&S.languageName||e,b=S&&(S.localizedLanguageName||S.languageName)||e,h=T?.contents?.["vs/workbench/contrib/localization/electron-sandbox/minimalTranslations"]??{},A=g?"installAndRestartMessage":"showLanguagePackExtensions",C=!h[A],p={};Object.keys(x).forEach(a=>{!h[a]||C?p[a]=x[a].replace("{0}",()=>f):p[a]=`${h[a].replace("{0}",()=>b)} (${x[a].replace("{0}",()=>f)})`});const I=a=>{this.telemetryService.publicLog("languagePackSuggestion:popup",{userReaction:a,language:e})},R={label:p.searchMarketplace,run:async()=>{I("search");const a=await this.paneCompositeService.openPaneComposite(q,B.Sidebar,!0);if(!a)return;const E=a.getViewPaneContainer();E&&(E.search(`tag:lp-${e}`),E.focus())}},G={label:p.installAndRestart,run:async()=>{I("installAndRestart"),await this.localeService.setLocale({id:e,label:f,extensionId:g?.identifier.id,galleryExtension:g},!0)}},O=p[A];this.notificationService.prompt(w.Info,O,[g?G:R,{label:y("neverAgain","Don't Show Again"),isSecondary:!0,run:()=>{t.push(s),this.storageService.store(l.LANGUAGEPACK_SUGGESTION_IGNORE_STORAGE_KEY,JSON.stringify(t),N.APPLICATION,Y.USER),I("neverShowAgain")}}],{onCancel:()=>{I("cancelled")}})}async isLocaleInstalled(n){return(await this.extensionManagementService.getInstalled()).some(t=>!!t.manifest.contributes?.localizations?.length&&t.manifest.contributes.localizations.some(i=>n.startsWith(i.languageId.toLowerCase())))}};l=L([o(0,$),o(1,X),o(2,H),o(3,F),o(4,W),o(5,K),o(6,j),o(7,J)],l);const Z=k.as(U.Workbench);Z.registerWorkbenchContribution(l,M.Eventually);
