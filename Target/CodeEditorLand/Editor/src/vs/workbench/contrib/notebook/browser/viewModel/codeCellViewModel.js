var D=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var S=(C,c,t,e)=>{for(var o=e>1?void 0:e?V(c,t):c,u=C.length-1,i;u>=0;u--)(i=C[u])&&(o=(e?i(c,t,o):i(o))||o);return e&&o&&D(c,t,o),o},f=(C,c)=>(t,e)=>c(t,e,C);import{Emitter as m,PauseableEmitter as k}from"../../../../../base/common/event.js";import{dispose as w}from"../../../../../base/common/lifecycle.js";import{observableValue as L}from"../../../../../base/common/observable.js";import*as W from"../../../../../base/common/uuid.js";import{ICodeEditorService as F}from"../../../../../editor/browser/services/codeEditorService.js";import"../../../../../editor/common/editorCommon.js";import{PrefixSumComputer as B}from"../../../../../editor/common/model/prefixSumComputer.js";import{ITextModelService as R}from"../../../../../editor/common/services/resolverService.js";import{IConfigurationService as z}from"../../../../../platform/configuration/common/configuration.js";import{IInstantiationService as N}from"../../../../../platform/instantiation/common/instantiation.js";import{IUndoRedoService as U}from"../../../../../platform/undoRedo/common/undoRedo.js";import{CellEditState as v,CellLayoutState as g}from"../notebookBrowser.js";import"../notebookOptions.js";import"../notebookViewEvents.js";import{CellOutputViewModel as E}from"./cellOutputViewModel.js";import"./viewContext.js";import"../../common/model/notebookCellTextModel.js";import{CellKind as P}from"../../common/notebookCommon.js";import"../../common/notebookExecutionStateService.js";import{INotebookService as G}from"../../common/notebookService.js";import{BaseCellViewModel as A}from"./baseCellViewModel.js";const wt=500;let b=class extends A{constructor(t,e,o,u,i,r,p,_,d,h){super(t,e,W.generateUuid(),u,i,p,_,d);this.viewContext=u;this._notebookService=r;this._outputViewModels=this.model.outputs.map(n=>new E(this,n,this._notebookService)),this._register(this.model.onDidChangeOutputs(n=>{const s=[];let l=!1;for(let a=n.start;a<n.start+n.deleteCount;a++)this._outputCollection[a]!==void 0&&this._outputCollection[a]!==0&&(l=!0);this._outputCollection.splice(n.start,n.deleteCount,...n.newOutputs.map(()=>0)),s.push(...this._outputViewModels.splice(n.start,n.deleteCount,...n.newOutputs.map(a=>new E(this,a,this._notebookService)))),this._outputsTop=null,this._onDidChangeOutputs.fire(n),this._onDidRemoveOutputs.fire(s),l&&this.layoutChange({outputHeight:!0},"CodeCellViewModel#model.onDidChangeOutputs"),w(s)})),this._outputCollection=new Array(this.model.outputs.length),this._layoutInfo={fontInfo:o?.fontInfo||null,editorHeight:0,editorWidth:o?this.viewContext.notebookOptions.computeCodeCellEditorWidth(o.width):0,chatHeight:0,statusBarHeight:0,commentOffset:0,commentHeight:0,outputContainerOffset:0,outputTotalHeight:0,outputShowMoreContainerHeight:0,outputShowMoreContainerOffset:0,totalHeight:this.computeTotalHeight(17,0,0,0),codeIndicatorHeight:0,outputIndicatorHeight:0,bottomToolbarOffset:0,layoutState:g.Uninitialized,estimatedHasHorizontalScrolling:!1}}cellKind=P.Code;_onLayoutInfoRead=this._register(new m);onLayoutInfoRead=this._onLayoutInfoRead.event;_onDidStartExecution=this._register(new m);onDidStartExecution=this._onDidStartExecution.event;_onDidStopExecution=this._register(new m);onDidStopExecution=this._onDidStopExecution.event;_onDidChangeOutputs=this._register(new m);onDidChangeOutputs=this._onDidChangeOutputs.event;_onDidRemoveOutputs=this._register(new m);onDidRemoveOutputs=this._onDidRemoveOutputs.event;_outputCollection=[];_outputsTop=null;_pauseableEmitter=this._register(new k);onDidChangeLayout=this._pauseableEmitter.event;_editorHeight=0;set editorHeight(t){this._editorHeight!==t&&(this._editorHeight=t,this.layoutChange({editorHeight:!0},"CodeCellViewModel#editorHeight"))}get editorHeight(){throw new Error("editorHeight is write-only")}_chatHeight=0;set chatHeight(t){this._chatHeight!==t&&(this._chatHeight=t,this.layoutChange({chatHeight:!0},"CodeCellViewModel#chatHeight"))}get chatHeight(){return this._chatHeight}_hoveringOutput=!1;get outputIsHovered(){return this._hoveringOutput}set outputIsHovered(t){this._hoveringOutput=t,this._onDidChangeState.fire({outputIsHoveredChanged:!0})}_focusOnOutput=!1;get outputIsFocused(){return this._focusOnOutput}set outputIsFocused(t){this._focusOnOutput=t,this._onDidChangeState.fire({outputIsFocusedChanged:!0})}_focusInputInOutput=!1;get inputInOutputIsFocused(){return this._focusInputInOutput}set inputInOutputIsFocused(t){this._focusInputInOutput=t}_outputMinHeight=0;get outputMinHeight(){return this._outputMinHeight}set outputMinHeight(t){this._outputMinHeight=t}_layoutInfo;get layoutInfo(){return this._layoutInfo}_outputViewModels;get outputsViewModels(){return this._outputViewModels}excecutionError=L("excecutionError",void 0);updateExecutionState(t){t.changed?this._onDidStartExecution.fire(t):this._onDidStopExecution.fire(t)}updateOptions(t){(t.cellStatusBarVisibility||t.insertToolbarPosition||t.cellToolbarLocation)&&this.layoutChange({})}pauseLayout(){this._pauseableEmitter.pause()}resumeLayout(){this._pauseableEmitter.resume()}layoutChange(t,e){this._ensureOutputsTop();const o=this.viewContext.notebookOptions.getLayoutConfiguration(),u=this.viewContext.notebookOptions.computeBottomToolbarDimensions(this.viewType),i=t.outputShowMoreContainerHeight?t.outputShowMoreContainerHeight:this._layoutInfo.outputShowMoreContainerHeight,r=Math.max(this._outputMinHeight,this.isOutputCollapsed?o.collapsedIndicatorHeight:this._outputsTop.getTotalSum()),p=t.commentHeight?this._commentHeight:this._layoutInfo.commentHeight,_=this.layoutInfo;if(this.isInputCollapsed){const d=o.collapsedIndicatorHeight,h=r+i,n=t.chatHeight?this._chatHeight:this._layoutInfo.chatHeight,s=o.cellTopMargin+o.collapsedIndicatorHeight,l=o.cellTopMargin+o.collapsedIndicatorHeight+o.cellBottomMargin+u.bottomToolbarGap+n+p+r+i,a=l-u.bottomToolbarGap-u.bottomToolbarHeight/2-i,I=this.viewContext.notebookOptions.computeBottomToolbarOffset(l,this.viewType),y=t.outerWidth!==void 0?this.viewContext.notebookOptions.computeCodeCellEditorWidth(t.outerWidth):this._layoutInfo?.editorWidth;this._layoutInfo={fontInfo:t.font??this._layoutInfo.fontInfo??null,editorHeight:this._layoutInfo.editorHeight,editorWidth:y,chatHeight:n,statusBarHeight:0,outputContainerOffset:s,outputTotalHeight:r,outputShowMoreContainerHeight:i,outputShowMoreContainerOffset:a,commentOffset:s+r,commentHeight:p,totalHeight:l,codeIndicatorHeight:d,outputIndicatorHeight:h,bottomToolbarOffset:I,layoutState:this._layoutInfo.layoutState,estimatedHasHorizontalScrolling:!1}}else{let d,h,n,s=!1;const l=t.chatHeight?this._chatHeight:this._layoutInfo.chatHeight;if(!t.editorHeight&&this._layoutInfo.layoutState===g.FromCache&&!t.outputHeight){const H=this.estimateEditorHeight(t.font?.lineHeight??this._layoutInfo.fontInfo?.lineHeight);h=H.editorHeight,s=H.hasHorizontalScrolling,n=this._layoutInfo.totalHeight,d=g.FromCache}else if(t.editorHeight||this._layoutInfo.layoutState===g.Measured)h=this._editorHeight,n=this.computeTotalHeight(this._editorHeight,r,i,l),d=g.Measured,s=this._layoutInfo.estimatedHasHorizontalScrolling;else{const H=this.estimateEditorHeight(t.font?.lineHeight??this._layoutInfo.fontInfo?.lineHeight);h=H.editorHeight,s=H.hasHorizontalScrolling,n=this.computeTotalHeight(h,r,i,l),d=g.Estimated}const a=this.viewContext.notebookOptions.computeEditorStatusbarHeight(this.internalMetadata,this.uri),I=h+a,y=r+i,O=o.editorToolbarHeight+o.cellTopMargin+l+h+a,M=n-u.bottomToolbarGap-u.bottomToolbarHeight/2-i,T=this.viewContext.notebookOptions.computeBottomToolbarOffset(n,this.viewType),x=t.outerWidth!==void 0?this.viewContext.notebookOptions.computeCodeCellEditorWidth(t.outerWidth):this._layoutInfo?.editorWidth;this._layoutInfo={fontInfo:t.font??this._layoutInfo.fontInfo??null,chatHeight:l,editorHeight:h,editorWidth:x,statusBarHeight:a,outputContainerOffset:O,outputTotalHeight:r,outputShowMoreContainerHeight:i,outputShowMoreContainerOffset:M,commentOffset:O+r,commentHeight:p,totalHeight:n,codeIndicatorHeight:I,outputIndicatorHeight:y,bottomToolbarOffset:T,layoutState:d,estimatedHasHorizontalScrolling:s}}this._fireOnDidChangeLayout({...t,totalHeight:this.layoutInfo.totalHeight!==_.totalHeight,source:e})}_fireOnDidChangeLayout(t){this._pauseableEmitter.fire(t)}restoreEditorViewState(t,e){super.restoreEditorViewState(t),e!==void 0&&this._layoutInfo.layoutState!==g.Measured&&(this._layoutInfo={...this._layoutInfo,totalHeight:e,layoutState:g.FromCache})}getDynamicHeight(){return this._onLayoutInfoRead.fire(),this._layoutInfo.totalHeight}getHeight(t){if(this._layoutInfo.layoutState===g.Uninitialized){const e=this.estimateEditorHeight(t);return this.computeTotalHeight(e.editorHeight,0,0,0)}else return this._layoutInfo.totalHeight}estimateEditorHeight(t=20){let e=!1;const o=this.viewContext.getBaseCellEditorOptions(this.language);if(this.layoutInfo.fontInfo&&o.value.wordWrap==="off"){for(let p=0;p<this.lineCount;p++)if(this.textBuffer.getLineLastNonWhitespaceColumn(p+1)*(this.layoutInfo.fontInfo.typicalHalfwidthCharacterWidth+this.layoutInfo.fontInfo.letterSpacing)>this.layoutInfo.editorWidth){e=!0;break}}const u=e?12:0,i=this.viewContext.notebookOptions.computeEditorPadding(this.internalMetadata,this.uri);return{editorHeight:this.lineCount*t+i.top+i.bottom+u,hasHorizontalScrolling:e}}computeTotalHeight(t,e,o,u){const i=this.viewContext.notebookOptions.getLayoutConfiguration(),{bottomToolbarGap:r}=this.viewContext.notebookOptions.computeBottomToolbarDimensions(this.viewType);return i.editorToolbarHeight+i.cellTopMargin+u+t+this.viewContext.notebookOptions.computeEditorStatusbarHeight(this.internalMetadata,this.uri)+this._commentHeight+e+o+r+i.cellBottomMargin}onDidChangeTextModelContent(){this.getEditState()!==v.Editing&&(this.updateEditState(v.Editing,"onDidChangeTextModelContent"),this._onDidChangeState.fire({contentChanged:!0}))}onDeselect(){this.updateEditState(v.Preview,"onDeselect")}updateOutputShowMoreContainerHeight(t){this.layoutChange({outputShowMoreContainerHeight:t},"CodeCellViewModel#updateOutputShowMoreContainerHeight")}updateOutputMinHeight(t){this.outputMinHeight=t}unlockOutputHeight(){this.outputMinHeight=0,this.layoutChange({outputHeight:!0})}updateOutputHeight(t,e,o){if(t>=this._outputCollection.length)throw new Error("Output index out of range!");this._ensureOutputsTop(),t===0||e>0?this._outputViewModels[t].setVisible(!0):e===0&&this._outputViewModels[t].setVisible(!1),this._outputViewModels[t].visible.get()&&e<28&&(e=28),this._outputCollection[t]=e,this._outputsTop.setValue(t,e)&&this.layoutChange({outputHeight:!0},o)}getOutputOffsetInContainer(t){if(this._ensureOutputsTop(),t>=this._outputCollection.length)throw new Error("Output index out of range!");return this._outputsTop.getPrefixSum(t-1)}getOutputOffset(t){return this.layoutInfo.outputContainerOffset+this.getOutputOffsetInContainer(t)}spliceOutputHeights(t,e,o){if(this._ensureOutputsTop(),this._outputsTop.removeValues(t,e),o.length){const u=new Uint32Array(o.length);for(let i=0;i<o.length;i++)u[i]=o[i];this._outputsTop.insertValues(t,u)}this.layoutChange({outputHeight:!0},"CodeCellViewModel#spliceOutputs")}_ensureOutputsTop(){if(!this._outputsTop){const t=new Uint32Array(this._outputCollection.length);for(let e=0;e<this._outputCollection.length;e++)t[e]=this._outputCollection[e];this._outputsTop=new B(t)}}_hasFindResult=this._register(new m);hasFindResult=this._hasFindResult.event;startFind(t,e){const o=super.cellStartFind(t,e);return o===null?null:{cell:this,contentMatches:o}}dispose(){super.dispose(),this._outputCollection=[],this._outputsTop=null,w(this._outputViewModels)}};b=S([f(4,z),f(5,G),f(6,R),f(7,U),f(8,F),f(9,N)],b);export{b as CodeCellViewModel,wt as outputDisplayLimit};
