import t from"assert";import{DisposableStore as h}from"../../../../../base/common/lifecycle.js";import{ensureNoDisposablesAreLeakedInTestSuite as g}from"../../../../../base/test/common/utils.js";import{IConfigurationService as A}from"../../../../../platform/configuration/common/configuration.js";import{TestConfigurationService as w}from"../../../../../platform/configuration/test/common/testConfigurationService.js";import"../../../../../platform/instantiation/test/common/instantiationServiceMock.js";import{NotebookCellsLayout as r}from"../../browser/view/notebookCellListView.js";import{FoldingModel as m}from"../../browser/viewModel/foldingModel.js";import{CellEditType as f,CellKind as u}from"../../common/notebookCommon.js";import{createNotebookCellList as p,setupInstantiationService as x,withTestNotebook as q}from"./testNotebookEditor.js";suite("NotebookRangeMap",()=>{g(),test("empty",()=>{const e=new r;t.strictEqual(e.size,0),t.strictEqual(e.count,0)});const l={size:1},a={size:2},E={size:3},s={size:5},n={size:10};test("length & count",()=>{const e=new r;e.splice(0,0,[l]),t.strictEqual(e.size,1),t.strictEqual(e.count,1)}),test("length & count #2",()=>{const e=new r;e.splice(0,0,[l,l,l,l,l]),t.strictEqual(e.size,5),t.strictEqual(e.count,5)}),test("length & count #3",()=>{const e=new r;e.splice(0,0,[s]),t.strictEqual(e.size,5),t.strictEqual(e.count,1)}),test("length & count #4",()=>{const e=new r;e.splice(0,0,[s,s,s,s,s]),t.strictEqual(e.size,25),t.strictEqual(e.count,5)}),test("insert",()=>{const e=new r;e.splice(0,0,[s,s,s,s,s]),t.strictEqual(e.size,25),t.strictEqual(e.count,5),e.splice(0,0,[s,s,s,s,s]),t.strictEqual(e.size,50),t.strictEqual(e.count,10),e.splice(5,0,[n,n]),t.strictEqual(e.size,70),t.strictEqual(e.count,12),e.splice(12,0,[{size:200}]),t.strictEqual(e.size,270),t.strictEqual(e.count,13)}),test("delete",()=>{const e=new r;e.splice(0,0,[s,s,s,s,s,s,s,s,s,s,s,s,s,s,s,s,s,s,s,s]),t.strictEqual(e.size,100),t.strictEqual(e.count,20),e.splice(10,5),t.strictEqual(e.size,75),t.strictEqual(e.count,15),e.splice(0,1),t.strictEqual(e.size,70),t.strictEqual(e.count,14),e.splice(1,13),t.strictEqual(e.size,5),t.strictEqual(e.count,1),e.splice(1,1),t.strictEqual(e.size,5),t.strictEqual(e.count,1)}),test("insert & delete",()=>{const e=new r;t.strictEqual(e.size,0),t.strictEqual(e.count,0),e.splice(0,0,[l]),t.strictEqual(e.size,1),t.strictEqual(e.count,1),e.splice(0,1),t.strictEqual(e.size,0),t.strictEqual(e.count,0)}),test("insert & delete #2",()=>{const e=new r;e.splice(0,0,[l,l,l,l,l,l,l,l,l,l]),e.splice(2,6),t.strictEqual(e.count,4),t.strictEqual(e.size,4)}),test("insert & delete #3",()=>{const e=new r;e.splice(0,0,[l,l,l,l,l,l,l,l,l,l,a,a,a,a,a,a,a,a,a,a]),e.splice(8,4),t.strictEqual(e.count,16),t.strictEqual(e.size,24)}),test("insert & delete #4",()=>{const e=new r;e.splice(0,0,[l,l,l,l,l,l,l,l,l,l,a,a,a,a,a,a,a,a,a,a]),e.splice(5,0,[E,E,E,E,E]),t.strictEqual(e.count,25),t.strictEqual(e.size,45),e.splice(4,7),t.strictEqual(e.count,18),t.strictEqual(e.size,28)}),suite("indexAt, positionAt",()=>{test("empty",()=>{const e=new r;t.strictEqual(e.indexAt(0),0),t.strictEqual(e.indexAt(10),0),t.strictEqual(e.indexAt(-1),-1),t.strictEqual(e.positionAt(0),-1),t.strictEqual(e.positionAt(10),-1),t.strictEqual(e.positionAt(-1),-1)}),test("simple",()=>{const e=new r;e.splice(0,0,[l]),t.strictEqual(e.indexAt(0),0),t.strictEqual(e.indexAt(1),1),t.strictEqual(e.positionAt(0),0),t.strictEqual(e.positionAt(1),-1)}),test("simple #2",()=>{const e=new r;e.splice(0,0,[n]),t.strictEqual(e.indexAt(0),0),t.strictEqual(e.indexAt(5),0),t.strictEqual(e.indexAt(9),0),t.strictEqual(e.indexAt(10),1),t.strictEqual(e.positionAt(0),0),t.strictEqual(e.positionAt(1),-1)}),test("insert",()=>{const e=new r;e.splice(0,0,[l,l,l,l,l,l,l,l,l,l]),t.strictEqual(e.indexAt(0),0),t.strictEqual(e.indexAt(1),1),t.strictEqual(e.indexAt(5),5),t.strictEqual(e.indexAt(9),9),t.strictEqual(e.indexAt(10),10),t.strictEqual(e.indexAt(11),10),e.splice(10,0,[l,l,l,l,l,l,l,l,l,l]),t.strictEqual(e.indexAt(10),10),t.strictEqual(e.indexAt(19),19),t.strictEqual(e.indexAt(20),20),t.strictEqual(e.indexAt(21),20),t.strictEqual(e.positionAt(0),0),t.strictEqual(e.positionAt(1),1),t.strictEqual(e.positionAt(19),19),t.strictEqual(e.positionAt(20),-1)}),test("delete",()=>{const e=new r;e.splice(0,0,[l,l,l,l,l,l,l,l,l,l]),e.splice(2,6),t.strictEqual(e.indexAt(0),0),t.strictEqual(e.indexAt(1),1),t.strictEqual(e.indexAt(3),3),t.strictEqual(e.indexAt(4),4),t.strictEqual(e.indexAt(5),4),t.strictEqual(e.positionAt(0),0),t.strictEqual(e.positionAt(1),1),t.strictEqual(e.positionAt(3),3),t.strictEqual(e.positionAt(4),-1)}),test("delete #2",()=>{const e=new r;e.splice(0,0,[n,n,n,n,n,n,n,n,n,n]),e.splice(2,6),t.strictEqual(e.indexAt(0),0),t.strictEqual(e.indexAt(1),0),t.strictEqual(e.indexAt(30),3),t.strictEqual(e.indexAt(40),4),t.strictEqual(e.indexAt(50),4),t.strictEqual(e.positionAt(0),0),t.strictEqual(e.positionAt(1),10),t.strictEqual(e.positionAt(2),20),t.strictEqual(e.positionAt(3),30),t.strictEqual(e.positionAt(4),-1)})})}),suite("NotebookRangeMap with top padding",()=>{g(),test("empty",()=>{const s=new r(10);t.strictEqual(s.size,10),t.strictEqual(s.count,0)});const l={size:1},a={size:5},E={size:10};test("length & count",()=>{const s=new r(10);s.splice(0,0,[l]),t.strictEqual(s.size,11),t.strictEqual(s.count,1)}),test("length & count #2",()=>{const s=new r(10);s.splice(0,0,[l,l,l,l,l]),t.strictEqual(s.size,15),t.strictEqual(s.count,5)}),test("length & count #3",()=>{const s=new r(10);s.splice(0,0,[a]),t.strictEqual(s.size,15),t.strictEqual(s.count,1)}),test("length & count #4",()=>{const s=new r(10);s.splice(0,0,[a,a,a,a,a]),t.strictEqual(s.size,35),t.strictEqual(s.count,5)}),test("insert",()=>{const s=new r(10);s.splice(0,0,[a,a,a,a,a]),t.strictEqual(s.size,35),t.strictEqual(s.count,5),s.splice(0,0,[a,a,a,a,a]),t.strictEqual(s.size,60),t.strictEqual(s.count,10),s.splice(5,0,[E,E]),t.strictEqual(s.size,80),t.strictEqual(s.count,12),s.splice(12,0,[{size:200}]),t.strictEqual(s.size,280),t.strictEqual(s.count,13)}),suite("indexAt, positionAt",()=>{test("empty",()=>{const s=new r(10);t.strictEqual(s.indexAt(0),0),t.strictEqual(s.indexAt(10),0),t.strictEqual(s.indexAt(-1),-1),t.strictEqual(s.positionAt(0),-1),t.strictEqual(s.positionAt(10),-1),t.strictEqual(s.positionAt(-1),-1)}),test("simple",()=>{const s=new r(10);s.splice(0,0,[l]),t.strictEqual(s.indexAt(0),0),t.strictEqual(s.indexAt(1),0),t.strictEqual(s.indexAt(10),0),t.strictEqual(s.indexAt(11),1),t.strictEqual(s.positionAt(0),10),t.strictEqual(s.positionAt(1),-1)})})}),suite("NotebookRangeMap with whitesspaces",()=>{let l,a,E;teardown(()=>{l.dispose()}),g(),setup(()=>{l=new h,a=x(l),E=new w,a.stub(A,E)}),test("simple",()=>{const s=new r(0);s.splice(0,0,[{size:479},{size:163},{size:182},{size:106},{size:106},{size:106},{size:87}]);const n=s.indexAt(650),e=s.indexAfter(1539);t.strictEqual(n,2),t.strictEqual(e,7),s.insertWhitespace("1",0,18),t.strictEqual(s.indexAt(650),1)}),test("Whitespace CRUD",async function(){const s={size:20},n=new r(0);n.splice(0,0,[s,s,s]),n.insertWhitespace("0",0,5),n.insertWhitespace("1",0,5),t.strictEqual(n.indexAt(0),0),t.strictEqual(n.indexAt(1),0),t.strictEqual(n.indexAt(10),0),t.strictEqual(n.indexAt(11),0),t.strictEqual(n.indexAt(21),0),t.strictEqual(n.indexAt(31),1),t.strictEqual(n.positionAt(0),10),t.strictEqual(n.getWhitespacePosition("0"),0),t.strictEqual(n.getWhitespacePosition("1"),5),t.strictEqual(n.positionAt(0),10),t.strictEqual(n.positionAt(1),30),n.changeOneWhitespace("0",0,10),t.strictEqual(n.getWhitespacePosition("0"),0),t.strictEqual(n.getWhitespacePosition("1"),10),t.strictEqual(n.positionAt(0),15),t.strictEqual(n.positionAt(1),35),n.removeWhitespace("1"),t.strictEqual(n.getWhitespacePosition("0"),0),t.strictEqual(n.positionAt(0),10),t.strictEqual(n.positionAt(1),30)}),test("Whitespace with editing",async function(){await q([["# header a","markdown",u.Markup,[],{}],["var b = 1;","javascript",u.Code,[],{}],["# header b","markdown",u.Markup,[],{}],["var b = 2;","javascript",u.Code,[],{}],["# header c","markdown",u.Markup,[],{}]],async(s,n,e)=>{n.restoreEditorViewState({editingCells:[!1,!1,!1,!1,!1],cellLineNumberStates:{},editorViewStates:[null,null,null,null,null],cellTotalHeights:[50,100,50,100,50],collapsedInputCells:{},collapsedOutputCells:{}});const i=p(a,e);e.add(i),i.attachViewModel(n),i.layout(210,100),t.strictEqual(i.scrollHeight,350),i.changeViewZones(o=>{const c=o.addZone({afterModelPosition:1,heightInPx:20,domNode:document.createElement("div")});o.layoutZone(c),t.strictEqual(i.scrollHeight,370),t.strictEqual(i.getElementTop(0),0),t.strictEqual(i.getElementTop(1),70),t.strictEqual(i.getElementTop(2),170),s.textModel.applyEdits([{editType:f.Replace,index:0,count:1,cells:[]}],!0,void 0,()=>{},void 0,!0),t.strictEqual(i.getElementTop(0),20),t.strictEqual(i.getElementTop(1),120),t.strictEqual(i.getElementTop(2),170),o.removeZone(c)})})}),test("Multiple Whitespaces",async function(){await q([["# header a","markdown",u.Markup,[],{}],["var b = 1;","javascript",u.Code,[],{}],["# header b","markdown",u.Markup,[],{}],["var b = 2;","javascript",u.Code,[],{}],["# header c","markdown",u.Markup,[],{}]],async(s,n,e)=>{n.restoreEditorViewState({editingCells:[!1,!1,!1,!1,!1],cellLineNumberStates:{},editorViewStates:[null,null,null,null,null],cellTotalHeights:[50,100,50,100,50],collapsedInputCells:{},collapsedOutputCells:{}});const i=p(a,e);e.add(i),i.attachViewModel(n),i.layout(210,100),t.strictEqual(i.scrollHeight,350),i.changeViewZones(o=>{const c=o.addZone({afterModelPosition:0,heightInPx:20,domNode:document.createElement("div")});o.layoutZone(c);const d=o.addZone({afterModelPosition:3,heightInPx:20,domNode:document.createElement("div")});o.layoutZone(d),t.strictEqual(i.scrollHeight,390),t.strictEqual(i.getElementTop(0),20),t.strictEqual(i.getElementTop(1),70),t.strictEqual(i.getElementTop(2),170),t.strictEqual(i.getElementTop(3),240),o.removeZone(c),t.strictEqual(i.scrollHeight,370),t.strictEqual(i.getElementTop(0),0),t.strictEqual(i.getElementTop(1),50),t.strictEqual(i.getElementTop(2),150),t.strictEqual(i.getElementTop(3),220),o.removeZone(d),t.strictEqual(i.scrollHeight,350),t.strictEqual(i.getElementTop(3),200)})})}),test("Multiple Whitespaces 2",async function(){await q([["# header a","markdown",u.Markup,[],{}],["var b = 1;","javascript",u.Code,[],{}],["# header b","markdown",u.Markup,[],{}],["var b = 2;","javascript",u.Code,[],{}],["# header c","markdown",u.Markup,[],{}]],async(s,n,e)=>{n.restoreEditorViewState({editingCells:[!1,!1,!1,!1,!1],cellLineNumberStates:{},editorViewStates:[null,null,null,null,null],cellTotalHeights:[50,100,50,100,50],collapsedInputCells:{},collapsedOutputCells:{}});const i=p(a,e);e.add(i),i.attachViewModel(n),i.layout(210,100),t.strictEqual(i.scrollHeight,350),i.changeViewZones(o=>{const c=o.addZone({afterModelPosition:0,heightInPx:20,domNode:document.createElement("div")});o.layoutZone(c);const d=o.addZone({afterModelPosition:1,heightInPx:20,domNode:document.createElement("div")});o.layoutZone(d),t.strictEqual(i.scrollHeight,390),t.strictEqual(i._getView().getWhitespacePosition(c),0),t.strictEqual(i._getView().getWhitespacePosition(d),70),o.removeZone(c),o.removeZone(d)})})}),test("Whitespace with folding support",async function(){await q([["# header a","markdown",u.Markup,[],{}],["var b = 1;","javascript",u.Code,[],{}],["# header b","markdown",u.Markup,[],{}],["var b = 2;","javascript",u.Code,[],{}],["# header c","markdown",u.Markup,[],{}]],async(s,n,e)=>{n.restoreEditorViewState({editingCells:[!1,!1,!1,!1,!1],cellLineNumberStates:{},editorViewStates:[null,null,null,null,null],cellTotalHeights:[50,100,50,100,50],collapsedInputCells:{},collapsedOutputCells:{}});const i=p(a,e);e.add(i),i.attachViewModel(n),i.layout(210,100),t.strictEqual(i.scrollHeight,350),i.changeViewZones(o=>{const c=o.addZone({afterModelPosition:0,heightInPx:20,domNode:document.createElement("div")});o.layoutZone(c),t.strictEqual(i.scrollHeight,370),t.strictEqual(i.getElementTop(0),20),t.strictEqual(i.getElementTop(1),70),t.strictEqual(i.getElementTop(2),170),t.strictEqual(i.getElementTop(3),220),t.strictEqual(i.getElementTop(4),320),o.removeZone(c),t.strictEqual(i.scrollHeight,350)}),i.changeViewZones(o=>{const c=o.addZone({afterModelPosition:1,heightInPx:20,domNode:document.createElement("div")});o.layoutZone(c),t.strictEqual(i.scrollHeight,370),t.strictEqual(i.getElementTop(0),0),t.strictEqual(i.getElementTop(1),70),t.strictEqual(i.getElementTop(2),170),t.strictEqual(i.getElementTop(3),220),t.strictEqual(i.getElementTop(4),320),o.removeZone(c),t.strictEqual(i.scrollHeight,350)}),i.changeViewZones(o=>{const c=o.addZone({afterModelPosition:3,heightInPx:20,domNode:document.createElement("div")});o.layoutZone(c),t.strictEqual(i.scrollHeight,370);const d=e.add(new m);d.attachViewModel(n),d.applyMemento([{start:2,end:3}]),n.updateFoldingRanges(d.regions),t.deepStrictEqual(n.getHiddenRanges(),[{start:3,end:3}]),i.setHiddenAreas(n.getHiddenRanges(),!0),t.strictEqual(i.scrollHeight,250),t.strictEqual(i.getElementTop(0),0),t.strictEqual(i.getElementTop(1),50),t.strictEqual(i.getElementTop(2),150),t.strictEqual(i.getElementTop(3),200),i.setHiddenAreas([],!0),t.strictEqual(i.scrollHeight,370),o.removeZone(c),t.strictEqual(i.scrollHeight,350)}),i.changeViewZones(o=>{const c=o.addZone({afterModelPosition:4,heightInPx:20,domNode:document.createElement("div")});o.layoutZone(c),t.strictEqual(i.scrollHeight,370);const d=e.add(new m);d.attachViewModel(n),d.applyMemento([{start:2,end:3}]),n.updateFoldingRanges(d.regions),t.deepStrictEqual(n.getHiddenRanges(),[{start:3,end:3}]),i.setHiddenAreas(n.getHiddenRanges(),!0),t.strictEqual(i.scrollHeight,270),t.strictEqual(i.getElementTop(0),0),t.strictEqual(i.getElementTop(1),50),t.strictEqual(i.getElementTop(2),150),t.strictEqual(i.getElementTop(3),220),i.setHiddenAreas([],!0),t.strictEqual(i.scrollHeight,370),o.removeZone(c),t.strictEqual(i.scrollHeight,350)}),i.changeViewZones(o=>{const c=o.addZone({afterModelPosition:4,heightInPx:20,domNode:document.createElement("div")});o.layoutZone(c),t.strictEqual(i.scrollHeight,370);const d=e.add(new m);d.attachViewModel(n),d.applyMemento([{start:0,end:1}]),n.updateFoldingRanges(d.regions),t.deepStrictEqual(n.getHiddenRanges(),[{start:1,end:1}]),i.setHiddenAreas(n.getHiddenRanges(),!0),t.strictEqual(i.scrollHeight,270),t.strictEqual(i.getElementTop(0),0),t.strictEqual(i.getElementTop(1),50),t.strictEqual(i.getElementTop(2),100),t.strictEqual(i.getElementTop(3),220),i.setHiddenAreas([],!0),t.strictEqual(i.scrollHeight,370),o.removeZone(c),t.strictEqual(i.scrollHeight,350)})})}),test("Whitespace with multiple viewzones at same position",async function(){await q([["# header a","markdown",u.Markup,[],{}],["var b = 1;","javascript",u.Code,[],{}],["# header b","markdown",u.Markup,[],{}],["var b = 2;","javascript",u.Code,[],{}],["# header c","markdown",u.Markup,[],{}]],async(s,n,e)=>{n.restoreEditorViewState({editingCells:[!1,!1,!1,!1,!1],cellLineNumberStates:{},editorViewStates:[null,null,null,null,null],cellTotalHeights:[50,100,50,100,50],collapsedInputCells:{},collapsedOutputCells:{}});const i=p(a,e);e.add(i),i.attachViewModel(n),i.layout(210,100),t.strictEqual(i.scrollHeight,350),i.changeViewZones(o=>{const c=o.addZone({afterModelPosition:0,heightInPx:20,domNode:document.createElement("div")});o.layoutZone(c),t.strictEqual(i.scrollHeight,370);const d=o.addZone({afterModelPosition:0,heightInPx:20,domNode:document.createElement("div")});o.layoutZone(d),t.strictEqual(i.scrollHeight,390),t.strictEqual(i.getElementTop(0),40),t.strictEqual(i.getElementTop(1),90),t.strictEqual(i.getElementTop(2),190),t.strictEqual(i.getElementTop(3),240),t.strictEqual(i.getElementTop(4),340),o.removeZone(c),t.strictEqual(i.scrollHeight,370),o.removeZone(d),t.strictEqual(i.scrollHeight,350)})})})});
