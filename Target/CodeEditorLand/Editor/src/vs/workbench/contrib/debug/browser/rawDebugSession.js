var f=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var m=(c,e,t,o)=>{for(var r=o>1?void 0:o?v(e,t):e,s=c.length-1,i;s>=0;s--)(i=c[s])&&(r=(o?i(e,t,r):i(r))||r);return o&&r&&f(e,t,r),r},l=(c,e)=>(t,o)=>e(t,o,c);import*as g from"../../../../nls.js";import{Emitter as a}from"../../../../base/common/event.js";import*as E from"../../../../base/common/objects.js";import{toAction as S}from"../../../../base/common/actions.js";import*as D from"../../../../base/common/errors.js";import{createErrorWithActions as R}from"../../../../base/common/errorMessage.js";import{formatPII as y,isUri as h}from"../common/debugUtils.js";import"../common/debug.js";import{IExtensionHostDebugService as I}from"../../../../platform/debug/common/extensionHostDebug.js";import{URI as P}from"../../../../base/common/uri.js";import{IOpenerService as w}from"../../../../platform/opener/common/opener.js";import{dispose as k}from"../../../../base/common/lifecycle.js";import"../../../../base/common/cancellation.js";import{INotificationService as A,Severity as C}from"../../../../platform/notification/common/notification.js";import{IDialogService as T}from"../../../../platform/dialogs/common/dialogs.js";import{Schemas as _}from"../../../../base/common/network.js";let b=class{constructor(e,t,o,r,s,i,u,p){this.dbgr=t;this.sessionId=o;this.name=r;this.extensionHostDebugService=s;this.openerService=i;this.notificationService=u;this.dialogSerivce=p;this.debugAdapter=e,this._capabilities=Object.create(null),this.toDispose.push(this.debugAdapter.onError(n=>{this.shutdown(n)})),this.toDispose.push(this.debugAdapter.onExit(n=>{n!==0?this.shutdown(new Error(`exit code: ${n}`)):this.shutdown()})),this.debugAdapter.onEvent(n=>{switch(n.event){case"initialized":this._readyForBreakpoints=!0,this._onDidInitialize.fire(n);break;case"loadedSource":this._onDidLoadedSource.fire(n);break;case"capabilities":if(n.body){const d=n.body.capabilities;this.mergeCapabilities(d)}break;case"stopped":this.didReceiveStoppedEvent=!0,this.stoppedSinceLastStep=!0,this._onDidStop.fire(n);break;case"continued":this.allThreadsContinued=n.body.allThreadsContinued!==!1,this._onDidContinued.fire(n);break;case"thread":this._onDidThread.fire(n);break;case"output":this._onDidOutput.fire(n);break;case"breakpoint":this._onDidBreakpoint.fire(n);break;case"terminated":this._onDidTerminateDebugee.fire(n);break;case"exited":this._onDidExitDebugee.fire(n);break;case"progressStart":this._onDidProgressStart.fire(n);break;case"progressUpdate":this._onDidProgressUpdate.fire(n);break;case"progressEnd":this._onDidProgressEnd.fire(n);break;case"invalidated":this._onDidInvalidated.fire(n);break;case"memory":this._onDidInvalidateMemory.fire(n);break;case"process":break;case"module":break;default:this._onDidCustomEvent.fire(n);break}this._onDidEvent.fire(n)}),this.debugAdapter.onRequest(n=>this.dispatchRequest(n))}allThreadsContinued=!0;_readyForBreakpoints=!1;_capabilities;debugAdapterStopped=!1;inShutdown=!1;terminated=!1;firedAdapterExitEvent=!1;startTime=0;didReceiveStoppedEvent=!1;_onDidInitialize=new a;_onDidStop=new a;_onDidContinued=new a;_onDidTerminateDebugee=new a;_onDidExitDebugee=new a;_onDidThread=new a;_onDidOutput=new a;_onDidBreakpoint=new a;_onDidLoadedSource=new a;_onDidProgressStart=new a;_onDidProgressUpdate=new a;_onDidProgressEnd=new a;_onDidInvalidated=new a;_onDidInvalidateMemory=new a;_onDidCustomEvent=new a;_onDidEvent=new a;_onDidExitAdapter=new a;debugAdapter;stoppedSinceLastStep=!1;toDispose=[];get isInShutdown(){return this.inShutdown}get onDidExitAdapter(){return this._onDidExitAdapter.event}get capabilities(){return this._capabilities}get readyForBreakpoints(){return this._readyForBreakpoints}get onDidInitialize(){return this._onDidInitialize.event}get onDidStop(){return this._onDidStop.event}get onDidContinued(){return this._onDidContinued.event}get onDidTerminateDebugee(){return this._onDidTerminateDebugee.event}get onDidExitDebugee(){return this._onDidExitDebugee.event}get onDidThread(){return this._onDidThread.event}get onDidOutput(){return this._onDidOutput.event}get onDidBreakpoint(){return this._onDidBreakpoint.event}get onDidLoadedSource(){return this._onDidLoadedSource.event}get onDidCustomEvent(){return this._onDidCustomEvent.event}get onDidProgressStart(){return this._onDidProgressStart.event}get onDidProgressUpdate(){return this._onDidProgressUpdate.event}get onDidProgressEnd(){return this._onDidProgressEnd.event}get onDidInvalidated(){return this._onDidInvalidated.event}get onDidInvalidateMemory(){return this._onDidInvalidateMemory.event}get onDidEvent(){return this._onDidEvent.event}async start(){if(!this.debugAdapter)return Promise.reject(new Error(g.localize("noDebugAdapterStart","No debug adapter, can not start debug session.")));await this.debugAdapter.startSession(),this.startTime=new Date().getTime()}async initialize(e){const t=await this.send("initialize",e,void 0,void 0,!1);return t&&this.mergeCapabilities(t.body),t}disconnect(e){const t=this.capabilities.supportTerminateDebuggee?e.terminateDebuggee:void 0,o=this.capabilities.supportTerminateDebuggee&&this.capabilities.supportSuspendDebuggee?e.suspendDebuggee:void 0;return this.shutdown(void 0,e.restart,t,o)}async launchOrAttach(e){const t=await this.send(e.request,e,void 0,void 0,!1);return t&&this.mergeCapabilities(t.body),t}terminate(e=!1){return this.capabilities.supportsTerminateRequest?this.terminated?this.disconnect({terminateDebuggee:!0,restart:e}):(this.terminated=!0,this.send("terminate",{restart:e},void 0)):Promise.reject(new Error("terminated not supported"))}restart(e){return this.capabilities.supportsRestartRequest?this.send("restart",e):Promise.reject(new Error("restart not supported"))}async next(e){this.stoppedSinceLastStep=!1;const t=await this.send("next",e);return this.stoppedSinceLastStep||this.fireSimulatedContinuedEvent(e.threadId),t}async stepIn(e){this.stoppedSinceLastStep=!1;const t=await this.send("stepIn",e);return this.stoppedSinceLastStep||this.fireSimulatedContinuedEvent(e.threadId),t}async stepOut(e){this.stoppedSinceLastStep=!1;const t=await this.send("stepOut",e);return this.stoppedSinceLastStep||this.fireSimulatedContinuedEvent(e.threadId),t}async continue(e){this.stoppedSinceLastStep=!1;const t=await this.send("continue",e);return t&&t.body&&t.body.allThreadsContinued!==void 0&&(this.allThreadsContinued=t.body.allThreadsContinued),this.stoppedSinceLastStep||this.fireSimulatedContinuedEvent(e.threadId,this.allThreadsContinued),t}pause(e){return this.send("pause",e)}terminateThreads(e){return this.capabilities.supportsTerminateThreadsRequest?this.send("terminateThreads",e):Promise.reject(new Error("terminateThreads not supported"))}setVariable(e){return this.capabilities.supportsSetVariable?this.send("setVariable",e):Promise.reject(new Error("setVariable not supported"))}setExpression(e){return this.capabilities.supportsSetExpression?this.send("setExpression",e):Promise.reject(new Error("setExpression not supported"))}async restartFrame(e,t){if(this.capabilities.supportsRestartFrame){this.stoppedSinceLastStep=!1;const o=await this.send("restartFrame",e);return this.stoppedSinceLastStep||this.fireSimulatedContinuedEvent(t),o}return Promise.reject(new Error("restartFrame not supported"))}stepInTargets(e){return this.capabilities.supportsStepInTargetsRequest?this.send("stepInTargets",e):Promise.reject(new Error("stepInTargets not supported"))}completions(e,t){return this.capabilities.supportsCompletionsRequest?this.send("completions",e,t):Promise.reject(new Error("completions not supported"))}setBreakpoints(e){return this.send("setBreakpoints",e)}setFunctionBreakpoints(e){return this.capabilities.supportsFunctionBreakpoints?this.send("setFunctionBreakpoints",e):Promise.reject(new Error("setFunctionBreakpoints not supported"))}dataBreakpointInfo(e){return this.capabilities.supportsDataBreakpoints?this.send("dataBreakpointInfo",e):Promise.reject(new Error("dataBreakpointInfo not supported"))}setDataBreakpoints(e){return this.capabilities.supportsDataBreakpoints?this.send("setDataBreakpoints",e):Promise.reject(new Error("setDataBreakpoints not supported"))}setExceptionBreakpoints(e){return this.send("setExceptionBreakpoints",e)}breakpointLocations(e){return this.capabilities.supportsBreakpointLocationsRequest?this.send("breakpointLocations",e):Promise.reject(new Error("breakpointLocations is not supported"))}configurationDone(){return this.capabilities.supportsConfigurationDoneRequest?this.send("configurationDone",null):Promise.reject(new Error("configurationDone not supported"))}stackTrace(e,t){return this.send("stackTrace",e,t)}exceptionInfo(e){return this.capabilities.supportsExceptionInfoRequest?this.send("exceptionInfo",e):Promise.reject(new Error("exceptionInfo not supported"))}scopes(e,t){return this.send("scopes",e,t)}variables(e,t){return this.send("variables",e,t)}source(e){return this.send("source",e)}locations(e){return this.send("locations",e)}loadedSources(e){return this.capabilities.supportsLoadedSourcesRequest?this.send("loadedSources",e):Promise.reject(new Error("loadedSources not supported"))}threads(){return this.send("threads",null)}evaluate(e){return this.send("evaluate",e)}async stepBack(e){if(this.capabilities.supportsStepBack){this.stoppedSinceLastStep=!1;const t=await this.send("stepBack",e);return this.stoppedSinceLastStep||this.fireSimulatedContinuedEvent(e.threadId),t}return Promise.reject(new Error("stepBack not supported"))}async reverseContinue(e){if(this.capabilities.supportsStepBack){this.stoppedSinceLastStep=!1;const t=await this.send("reverseContinue",e);return this.stoppedSinceLastStep||this.fireSimulatedContinuedEvent(e.threadId),t}return Promise.reject(new Error("reverseContinue not supported"))}gotoTargets(e){return this.capabilities.supportsGotoTargetsRequest?this.send("gotoTargets",e):Promise.reject(new Error("gotoTargets is not supported"))}async goto(e){if(this.capabilities.supportsGotoTargetsRequest){this.stoppedSinceLastStep=!1;const t=await this.send("goto",e);return this.stoppedSinceLastStep||this.fireSimulatedContinuedEvent(e.threadId),t}return Promise.reject(new Error("goto is not supported"))}async setInstructionBreakpoints(e){return this.capabilities.supportsInstructionBreakpoints?await this.send("setInstructionBreakpoints",e):Promise.reject(new Error("setInstructionBreakpoints is not supported"))}async disassemble(e){return this.capabilities.supportsDisassembleRequest?await this.send("disassemble",e):Promise.reject(new Error("disassemble is not supported"))}async readMemory(e){return this.capabilities.supportsReadMemoryRequest?await this.send("readMemory",e):Promise.reject(new Error("readMemory is not supported"))}async writeMemory(e){return this.capabilities.supportsWriteMemoryRequest?await this.send("writeMemory",e):Promise.reject(new Error("writeMemory is not supported"))}cancel(e){return this.send("cancel",e)}custom(e,t){return this.send(e,t)}async shutdown(e,t=!1,o=void 0,r=void 0){if(!this.inShutdown)if(this.inShutdown=!0,this.debugAdapter)try{const s={restart:t};typeof o=="boolean"&&(s.terminateDebuggee=o),typeof r=="boolean"&&(s.suspendDebuggee=r),await this.send("disconnect",s,void 0,e?200:2e3)}catch{}finally{await this.stopAdapter(e)}else return this.stopAdapter(e)}async stopAdapter(e){try{if(this.debugAdapter){const t=this.debugAdapter;this.debugAdapter=null,await t.stopSession(),this.debugAdapterStopped=!0}}finally{this.fireAdapterExitEvent(e)}}fireAdapterExitEvent(e){if(!this.firedAdapterExitEvent){this.firedAdapterExitEvent=!0;const t={emittedStopped:this.didReceiveStoppedEvent,sessionLengthInSeconds:(new Date().getTime()-this.startTime)/1e3};e&&!this.debugAdapterStopped&&(t.error=e),this._onDidExitAdapter.fire(t)}}async dispatchRequest(e){const t={type:"response",seq:0,command:e.command,request_seq:e.seq,success:!0},o=r=>this.debugAdapter&&this.debugAdapter.sendResponse(r);if(e.command==="launchVSCode")try{let r=await this.launchVsCode(e.arguments);if(!r.success){const{confirmed:s}=await this.dialogSerivce.confirm({type:C.Warning,message:g.localize("canNotStart","The debugger needs to open a new tab or window for the debuggee but the browser prevented this. You must give permission to continue."),primaryButton:g.localize({key:"continue",comment:["&& denotes a mnemonic"]},"&&Continue")});s?r=await this.launchVsCode(e.arguments):(t.success=!1,o(t),await this.shutdown())}t.body={rendererDebugPort:r.rendererDebugPort},o(t)}catch(r){t.success=!1,t.message=r.message,o(t)}else if(e.command==="runInTerminal")try{const r=await this.dbgr.runInTerminal(e.arguments,this.sessionId),s=t;s.body={},typeof r=="number"&&(s.body.shellProcessId=r),o(s)}catch(r){t.success=!1,t.message=r.message,o(t)}else if(e.command==="startDebugging")try{const r=e.arguments,s={...r.configuration,request:r.request,type:this.dbgr.type,name:r.configuration.name||this.name};await this.dbgr.startDebugging(s,this.sessionId)||(t.success=!1,t.message="Failed to start debugging"),o(t)}catch(r){t.success=!1,t.message=r.message,o(t)}else t.success=!1,t.message=`unknown request '${e.command}'`,o(t)}launchVsCode(e){const t=[];for(const o of e.args){const r=(o.prefix||"")+(o.path||""),s=/^--(.+)=(.+)$/.exec(r);if(s&&s.length===3){const i=s[1];let u=s[2];(i==="file-uri"||i==="folder-uri")&&!h(o.path)&&(u=h(u)?u:P.file(u).toString()),t.push(`--${i}=${u}`)}else t.push(r)}return e.env&&t.push(`--extensionEnvironment=${JSON.stringify(e.env)}`),this.extensionHostDebugService.openExtensionDevelopmentHostWindow(t,!!e.debugRenderer)}send(e,t,o,r,s=!0){return new Promise((i,u)=>{if(!this.debugAdapter){this.inShutdown?i(void 0):u(new Error(g.localize("noDebugAdapter","No debugger available found. Can not send '{0}'.",e)));return}let p;const n=this.debugAdapter.sendRequest(e,t,d=>{p?.dispose(),d.success?i(d):u(d)},r);o&&(p=o.onCancellationRequested(()=>{p.dispose(),this.capabilities.supportsCancelRequest&&this.cancel({requestId:n})}))}).then(void 0,i=>Promise.reject(this.handleErrorResponse(i,s)))}handleErrorResponse(e,t){if(e.command==="canceled"&&e.message==="canceled")return new D.CancellationError;const o=e?.body?.error,r=e?.message||"",s=o?y(o.format,!1,o.variables):r,i=o?.url;if(o&&i){const p=o.urlLabel?o.urlLabel:g.localize("moreInfo","More Info"),n=P.parse(i),d=n.scheme===_.command?"debug.moreInfo.command":"debug.moreInfo";return R(s,[S({id:d,label:p,run:()=>this.openerService.open(n,{allowCommands:!0})})])}t&&o&&o.format&&o.showUser&&this.notificationService.error(s);const u=new D.ErrorNoTelemetry(s);return u.showUser=o?.showUser,u}mergeCapabilities(e){e&&(this._capabilities=E.mixin(this._capabilities,e))}fireSimulatedContinuedEvent(e,t=!1){this._onDidContinued.fire({type:"event",event:"continued",body:{threadId:e,allThreadsContinued:t},seq:void 0})}dispose(){k(this.toDispose)}};b=m([l(4,I),l(5,w),l(6,A),l(7,T)],b);export{b as RawDebugSession};
