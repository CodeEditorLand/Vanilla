var L=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var U=(T,m,u,r)=>{for(var s=r>1?void 0:r?F(m,u):m,i=T.length-1,o;i>=0;i--)(o=T[i])&&(s=(r?o(m,u,s):o(s))||s);return r&&s&&L(m,u,s),s},b=(T,m)=>(u,r)=>m(u,r,T);import t from"assert";import{URI as I}from"../../../../../base/common/uri.js";import{isResourceDiffEditorInput as v,isResourceSideBySideEditorInput as M,isUntitledResourceEditorInput as q}from"../../../../common/editor.js";import{workbenchInstantiationService as k,registerTestEditor as A,TestFileEditorInput as N,registerTestResourceEditor as w,registerTestSideBySideEditor as C}from"../../../../test/browser/workbenchTestServices.js";import{TextResourceEditorInput as P}from"../../../../common/editor/textResourceEditorInput.js";import{SyncDescriptor as B}from"../../../../../platform/instantiation/common/descriptors.js";import{FileEditorInput as h}from"../../../../contrib/files/browser/editors/fileEditorInput.js";import{UntitledTextEditorInput as x}from"../../../untitled/common/untitledTextEditorInput.js";import{ensureNoDisposablesAreLeakedInTestSuite as _,toResource as n}from"../../../../../base/test/common/utils.js";import{IFileService as j}from"../../../../../platform/files/common/files.js";import{Disposable as H,DisposableStore as O}from"../../../../../base/common/lifecycle.js";import"../../../untitled/common/untitledTextEditorModel.js";import{NullFileSystemProvider as V}from"../../../../../platform/files/test/common/nullFileSystemProvider.js";import{DiffEditorInput as X}from"../../../../common/editor/diffEditorInput.js";import{isLinux as z}from"../../../../../base/common/platform.js";import{SideBySideEditorInput as G}from"../../../../common/editor/sideBySideEditorInput.js";import"../../common/textfiles.js";import{TextEditorService as R}from"../../common/textEditorService.js";import{ILanguageService as J}from"../../../../../editor/common/languages/language.js";import"../../../../common/editor/editorInput.js";suite("TextEditorService",()=>{const T="MyTestEditorForEditorService",m="testEditorInputForEditorService";let u=class extends H{constructor(i,o){super(),this._register(o.registerProvider(i,new V))}};u=U([b(1,j)],u);const r=new O;setup(()=>{r.add(A(T,[new B(N)],m)),r.add(w()),r.add(C())}),teardown(()=>{r.clear()}),test("createTextEditor - basics",async function(){const s=k(void 0,r),i=s.get(J),o=r.add(s.createInstance(R)),a="create-input-test";r.add(i.registerLanguage({id:a}));let e=r.add(o.createTextEditor({resource:n.call(this,"/index.html"),options:{selection:{startLineNumber:1,startColumn:1}}}));t(e instanceof h);let d=e;t.strictEqual(d.resource.fsPath,n.call(this,"/index.html").fsPath),e=r.add(o.createTextEditor({resource:n.call(this,"/index.html")}));const f=r.add(o.createTextEditor({resource:n.call(this,"/INDEX.html")}));z?(t.notStrictEqual(e,f),t.notStrictEqual(e.resource?.toString(),f.resource?.toString())):(t.strictEqual(e,f),t.strictEqual(e.resource?.toString(),f.resource?.toString())),t.strictEqual(r.add(o.createTextEditor(e)),e),e=r.add(o.createTextEditor({resource:n.call(this,"/index.html"),encoding:"utf16le",options:{selection:{startLineNumber:1,startColumn:1}}})),t(e instanceof h),d=e,t.strictEqual(d.getPreferredEncoding(),"utf16le"),e=r.add(o.createTextEditor({resource:n.call(this,"/index.html"),languageId:a})),t(e instanceof h),d=e,t.strictEqual(d.getPreferredLanguageId(),a);let g=r.add(await d.resolve());t.strictEqual(g.textEditorModel?.getLanguageId(),a),e=r.add(o.createTextEditor({resource:n.call(this,"/index.html"),contents:"My contents"})),t(e instanceof h),d=e,g=r.add(await d.resolve()),t.strictEqual(g.textEditorModel?.getValue(),"My contents"),t.strictEqual(g.isDirty(),!0),e=r.add(o.createTextEditor({resource:n.call(this,"/index.html"),languageId:"text"})),t(e instanceof h),d=e,t.strictEqual(d.getPreferredLanguageId(),"text"),e=r.add(o.createTextEditor({resource:void 0,options:{selection:{startLineNumber:1,startColumn:1}}})),t(e instanceof x);let c={contents:"Hello Untitled",options:{selection:{startLineNumber:1,startColumn:1}}};e=r.add(o.createTextEditor(c)),t.ok(q(c)),t(e instanceof x);let l=r.add(await e.resolve());t.strictEqual(l.textEditorModel?.getValue(),"Hello Untitled"),e=r.add(o.createTextEditor({resource:void 0,languageId:a,options:{selection:{startLineNumber:1,startColumn:1}}})),t(e instanceof x),l=r.add(await e.resolve()),t.strictEqual(l.getLanguageId(),a),e=r.add(o.createTextEditor({resource:I.file("/some/path.txt"),forceUntitled:!0,options:{selection:{startLineNumber:1,startColumn:1}}})),t(e instanceof x),t.ok(e.hasAssociatedFilePath),c={resource:I.parse("untitled://Untitled-1"),forceUntitled:!0,options:{selection:{startLineNumber:1,startColumn:1}}},t.ok(q(c)),e=r.add(o.createTextEditor(c)),t(e instanceof x),t.ok(!e.hasAssociatedFilePath),c={resource:I.file("/fake"),forceUntitled:!0},t.ok(q(c)),e=r.add(o.createTextEditor(c)),t(e instanceof x);const y=r.add(s.createInstance(u,"untitled-custom"));e=r.add(o.createTextEditor({resource:I.parse("untitled-custom://some/path"),forceUntitled:!0,options:{selection:{startLineNumber:1,startColumn:1}}})),t(e instanceof x),t.ok(e.hasAssociatedFilePath),y.dispose(),e=r.add(o.createTextEditor({resource:I.parse("custom:resource")})),t(e instanceof P);const E={modified:{resource:n.call(this,"/modified.html")},original:{resource:n.call(this,"/original.html")}};t.strictEqual(v(E),!0),e=r.add(o.createTextEditor(E)),t(e instanceof X),r.add(e.modified),r.add(e.original),t.strictEqual(e.original.resource?.toString(),E.original.resource.toString()),t.strictEqual(e.modified.resource?.toString(),E.modified.resource.toString());const S=e.toUntyped();t.strictEqual(S.original.resource?.toString(),E.original.resource.toString()),t.strictEqual(S.modified.resource?.toString(),E.modified.resource.toString());const p={primary:{resource:n.call(this,"/primary.html")},secondary:{resource:n.call(this,"/secondary.html")}};t.strictEqual(M(p),!0),e=r.add(o.createTextEditor(p)),t(e instanceof G),r.add(e.primary),r.add(e.secondary),t.strictEqual(e.primary.resource?.toString(),p.primary.resource.toString()),t.strictEqual(e.secondary.resource?.toString(),p.secondary.resource.toString());const D=e.toUntyped();t.strictEqual(D.primary.resource?.toString(),p.primary.resource.toString()),t.strictEqual(D.secondary.resource?.toString(),p.secondary.resource.toString())}),test("createTextEditor- caching",function(){const s=k(void 0,r),i=r.add(s.createInstance(R)),o=n.call(this,"/foo/bar/cache1.js"),a=r.add(i.createTextEditor({resource:o}));t.ok(a);const e=n.call(this,"/foo/bar/cache2.js"),d=r.add(i.createTextEditor({resource:e}));t.ok(d),t.notStrictEqual(a,d);const f=r.add(i.createTextEditor({resource:o}));t.strictEqual(f,a),f.dispose(),t.ok(a.isDisposed());const g=r.add(i.createTextEditor({resource:o}));t.notStrictEqual(g,a),t.ok(!g.isDisposed());const c=I.from({scheme:"custom",path:"/foo/bar/cache1.js"}),l=r.add(i.createTextEditor({resource:c}));t.ok(l);const y=I.from({scheme:"custom",path:"/foo/bar/cache2.js"}),E=r.add(i.createTextEditor({resource:y}));t.ok(E),t.notStrictEqual(l,E);const S=r.add(i.createTextEditor({resource:c}));t.strictEqual(S,l),S.dispose(),t.ok(l.isDisposed());const p=r.add(i.createTextEditor({resource:c}));t.notStrictEqual(p,l),t.ok(!p.isDisposed())}),_()});
