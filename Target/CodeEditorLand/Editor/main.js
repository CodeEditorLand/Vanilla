import*as d from"path";import*as u from"original-fs";import*as k from"os";import*as x from"./bootstrap-node.js";import*as N from"./bootstrap-amd.js";import{fileURLToPath as T}from"url";import{app as o,protocol as R,crashReporter as j,Menu as U,contentTracing as V}from"electron";import F from"minimist";import{product as a}from"./bootstrap-meta.js";import{parse as _}from"./vs/base/common/jsonc.js";import{getUserDataPath as I}from"./vs/platform/environment/node/userDataPath.js";import*as m from"./vs/base/common/performance.js";import{resolveNLSConfiguration as D}from"./vs/base/node/nls.js";import{getUNCHost as M,addUNCHostToAllowlist as $}from"./vs/base/node/unc.js";const w=d.dirname(T(import.meta.url));m.mark("code/didStartMain");const E=x.configurePortable(a);x.enableASARSupport();const c=Z(),S=W(c);c.sandbox&&!c["disable-chromium-sandbox"]&&!S["disable-chromium-sandbox"]?o.enableSandbox():o.commandLine.hasSwitch("no-sandbox")&&!o.commandLine.hasSwitch("disable-gpu-sandbox")?o.commandLine.appendSwitch("disable-gpu-sandbox"):(o.commandLine.appendSwitch("no-sandbox"),o.commandLine.appendSwitch("disable-gpu-sandbox"));const h=I(c,a.nameShort??"code-oss-dev");if(process.platform==="win32"){const e=M(h);e&&$(e)}o.setPath("userData",h);const O=X();U.setApplicationMenu(null),m.mark("code/willStartCrashReporter"),(c["crash-reporter-directory"]||S["enable-crash-reporter"]&&!c["disable-crash-reporter"])&&q(),m.mark("code/didStartCrashReporter"),E&&E.isPortable&&o.setAppLogsPath(d.join(h,"logs")),R.registerSchemesAsPrivileged([{scheme:"vscode-webview",privileges:{standard:!0,secure:!0,supportFetchAPI:!0,corsEnabled:!0,allowServiceWorkers:!0,codeCache:!0}},{scheme:"vscode-file",privileges:{secure:!0,standard:!0,supportFetchAPI:!0,corsEnabled:!0,codeCache:!0}}]),Q();let v;const y=A((o.getPreferredSystemLanguages()?.[0]??"en").toLowerCase()),g=ee(S);if(g&&(v=D({userLocale:g,osLocale:y,commit:a.commit,userDataPath:h,nlsMetadataPath:w})),process.platform==="win32"||process.platform==="linux"){const e=!g||g==="qps-ploc"?"en":g;o.commandLine.appendSwitch("lang",e)}o.once("ready",function(){if(c.trace){const e={categoryFilter:c["trace-category-filter"]||"*",traceOptions:c["trace-options"]||"record-until-full,enable-sampling"};V.startRecording(e).finally(()=>P())}else P()});async function P(){m.mark("code/mainAppReady");try{const[,e]=await Promise.all([Y(O),K()]);H(O,e)}catch{}}function H(e,r){process.env.VSCODE_NLS_CONFIG=JSON.stringify(r),process.env.VSCODE_CODE_CACHE_PATH=e||"",m.mark("code/willLoadMainBundle"),N.load("vs/code/electron-main/main",()=>{m.mark("code/didLoadMainBundle")})}function W(e){const r=["disable-hardware-acceleration","force-color-profile","disable-lcd-text","proxy-bypass-list"];process.platform==="linux"&&(r.push("force-renderer-accessibility"),r.push("password-store"));const s=["enable-proposed-api","log-level","use-inmemory-secretstorage"],p=z();Object.keys(p).forEach(i=>{const t=p[i];if(r.indexOf(i)!==-1){if(t===!0||t==="true")i==="disable-hardware-acceleration"?o.disableHardwareAcceleration():o.commandLine.appendSwitch(i);else if(t)if(i==="password-store"){let n=t;(t==="gnome"||t==="gnome-keyring")&&(n="gnome-libsecret"),o.commandLine.appendSwitch(i,n)}else o.commandLine.appendSwitch(i,t)}else if(s.indexOf(i)!==-1)switch(i){case"enable-proposed-api":Array.isArray(t)&&t.forEach(n=>n&&typeof n=="string"&&process.argv.push("--enable-proposed-api",n));break;case"log-level":if(typeof t=="string")process.argv.push("--log",t);else if(Array.isArray(t))for(const n of t)process.argv.push("--log",n);break;case"use-inmemory-secretstorage":t&&process.argv.push("--use-inmemory-secretstorage");break}});const f=`CalculateNativeWinOcclusion,${o.commandLine.getSwitchValue("disable-features")}`;o.commandLine.appendSwitch("disable-features",f);const l=`FontMatchingCTMigration,${o.commandLine.getSwitchValue("disable-blink-features")}`;o.commandLine.appendSwitch("disable-blink-features",l);const b=J(e);return b&&o.commandLine.appendSwitch("js-flags",b),p}function z(){const e=G();let r;try{r=_(u.readFileSync(e).toString())}catch(s){s&&s.code==="ENOENT"&&B(e)}return r||(r={}),r}function B(e){try{const r=d.dirname(e);u.existsSync(r)||u.mkdirSync(r);const s=["// This configuration file allows you to pass permanent command line arguments to VS Code.","// Only a subset of arguments is currently supported to reduce the likelihood of breaking","// the installation.","//","// PLEASE DO NOT CHANGE WITHOUT UNDERSTANDING THE IMPACT","//","// NOTE: Changing this file requires a restart of VS Code.","{","	// Use software rendering instead of hardware accelerated rendering.","	// This can help in cases where you see rendering issues in VS Code.",'	// "disable-hardware-acceleration": true',"}"];u.writeFileSync(e,s.join(`
`))}catch{}}function G(){const e=process.env.VSCODE_PORTABLE;if(e)return d.join(e,"argv.json");let r=a.dataFolderName;return process.env.VSCODE_DEV&&(r=`${r}-dev`),d.join(k.homedir(),r,"argv.json")}function q(){let e=c["crash-reporter-directory"],r="";if(e){if(e=d.normalize(e),d.isAbsolute(e)||o.exit(1),!u.existsSync(e))try{u.mkdirSync(e,{recursive:!0})}catch{o.exit(1)}o.setPath("crashDumps",e)}else{const l=a.appCenter;if(l){const b=process.platform==="win32",i=process.platform==="linux",t=process.platform==="darwin",n=S["crash-reporter-id"];if(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(n)){if(b)switch(process.arch){case"x64":r=l["win32-x64"];break;case"arm64":r=l["win32-arm64"];break}else if(t)if(a.darwinUniversalAssetId)r=l["darwin-universal"];else switch(process.arch){case"x64":r=l.darwin;break;case"arm64":r=l["darwin-arm64"];break}else i&&(r=l["linux-x64"]);r=r.concat("&uid=",n,"&iid=",n,"&sid=",n);const C=process.argv,L=C.indexOf("--");L===-1?C.push("--crash-reporter-id",n):C.splice(L,0,"--crash-reporter-id",n)}}}const s=(a.crashReporter?a.crashReporter.productName:void 0)||a.nameShort,p=(a.crashReporter?a.crashReporter.companyName:void 0)||"Microsoft",f=!!(!process.env.VSCODE_DEV&&r&&!e);j.start({companyName:p,productName:process.env.VSCODE_DEV?`${s} Dev`:s,submitURL:r,uploadToServer:f,compress:!0})}function J(e){const r=[];return e["js-flags"]&&r.push(e["js-flags"]),r.length>0?r.join(" "):null}function Z(){return F(process.argv,{string:["user-data-dir","locale","js-flags","crash-reporter-directory"],boolean:["disable-chromium-sandbox"],default:{sandbox:!0},alias:{"no-sandbox":"sandbox"}})}function Q(){const e=[];global.macOpenFiles=e,o.on("open-file",function(p,f){e.push(f)});const r=[],s=function(p,f){p.preventDefault(),r.push(f)};o.on("will-finish-launching",function(){o.on("open-url",s)}),global.getOpenUrls=function(){return o.removeListener("open-url",s),r}}function X(){if(process.argv.indexOf("--no-cached-data")>0||process.env.VSCODE_DEV)return;const e=a.commit;if(e)return d.join(h,"CachedData",e)}async function Y(e){if(typeof e=="string")try{return await u.promises.mkdir(e,{recursive:!0}),e}catch{}}function A(e){if(e.startsWith("zh")){const r=e.split("-")[1];return["hans","cn","sg","my"].includes(r)?"zh-cn":"zh-tw"}return e}async function K(){const e=v?await v:void 0;if(e)return e;let r=o.getLocale();return r?(r=A(r.toLowerCase()),D({userLocale:r,osLocale:y,commit:a.commit,userDataPath:h,nlsMetadataPath:w})):{userLocale:"en",osLocale:y,resolvedLanguage:"en",defaultMessagesFile:d.join(w,"nls.messages.json"),locale:"en",availableLanguages:{}}}function ee(e){const r=c.locale;return r?r.toLowerCase():typeof e?.locale=="string"?e.locale.toLowerCase():void 0}
