import*as d from"path";import*as f from"original-fs";import*as k from"os";import*as x from"./bootstrap-node.js";import*as N from"./bootstrap-amd.js";import{fileURLToPath as T}from"url";import{app as o,protocol as R,crashReporter as j,Menu as U,contentTracing as V}from"electron";import F from"minimist";import{product as s}from"./bootstrap-meta.js";import{parse as _}from"./vs/base/common/jsonc.js";import{getUserDataPath as I}from"./vs/platform/environment/node/userDataPath.js";import*as m from"./vs/base/common/performance.js";import{resolveNLSConfiguration as E}from"./vs/base/node/nls.js";import{getUNCHost as M,addUNCHostToAllowlist as $}from"./vs/base/node/unc.js";const C=d.dirname(T(import.meta.url));m.mark("code/didStartMain");const O=x.configurePortable(s);x.enableASARSupport();const c=Z(),S=W(c);c.sandbox&&!c["disable-chromium-sandbox"]&&!S["disable-chromium-sandbox"]?o.enableSandbox():o.commandLine.hasSwitch("no-sandbox")&&!o.commandLine.hasSwitch("disable-gpu-sandbox")?o.commandLine.appendSwitch("disable-gpu-sandbox"):(o.commandLine.appendSwitch("no-sandbox"),o.commandLine.appendSwitch("disable-gpu-sandbox"));const h=I(c,s.nameShort??"code-oss-dev");if(process.platform==="win32"){const e=M(h);e&&$(e)}o.setPath("userData",h);const D=X();U.setApplicationMenu(null),m.mark("code/willStartCrashReporter"),(c["crash-reporter-directory"]||S["enable-crash-reporter"]&&!c["disable-crash-reporter"])&&q(),m.mark("code/didStartCrashReporter"),O&&O.isPortable&&o.setAppLogsPath(d.join(h,"logs")),R.registerSchemesAsPrivileged([{scheme:"vscode-webview",privileges:{standard:!0,secure:!0,supportFetchAPI:!0,corsEnabled:!0,allowServiceWorkers:!0,codeCache:!0}},{scheme:"vscode-file",privileges:{secure:!0,standard:!0,supportFetchAPI:!0,corsEnabled:!0,codeCache:!0}}]),Q();let v;const y=P((o.getPreferredSystemLanguages()?.[0]??"en").toLowerCase()),g=ee(S);if(g&&(v=E({userLocale:g,osLocale:y,commit:s.commit,userDataPath:h,nlsMetadataPath:C})),process.platform==="win32"||process.platform==="linux"){const e=!g||g==="qps-ploc"?"en":g;o.commandLine.appendSwitch("lang",e)}o.once("ready",function(){if(c.trace){const e={categoryFilter:c["trace-category-filter"]||"*",traceOptions:c["trace-options"]||"record-until-full,enable-sampling"};V.startRecording(e).finally(()=>A())}else A()});async function A(){m.mark("code/mainAppReady");try{const[,e]=await Promise.all([Y(D),K()]);H(D,e)}catch(e){console.error(e)}}function H(e,r){process.env.VSCODE_NLS_CONFIG=JSON.stringify(r),process.env.VSCODE_CODE_CACHE_PATH=e||"",m.mark("code/willLoadMainBundle"),N.load("vs/code/electron-main/main",()=>{m.mark("code/didLoadMainBundle")})}function W(e){const r=["disable-hardware-acceleration","force-color-profile","disable-lcd-text","proxy-bypass-list"];process.platform==="linux"&&(r.push("force-renderer-accessibility"),r.push("password-store"));const a=["enable-proposed-api","log-level","use-inmemory-secretstorage"],p=z();Object.keys(p).forEach(i=>{const n=p[i];if(r.indexOf(i)!==-1){if(n===!0||n==="true")i==="disable-hardware-acceleration"?o.disableHardwareAcceleration():o.commandLine.appendSwitch(i);else if(n)if(i==="password-store"){let t=n;(n==="gnome"||n==="gnome-keyring")&&(t="gnome-libsecret"),o.commandLine.appendSwitch(i,t)}else o.commandLine.appendSwitch(i,n)}else if(a.indexOf(i)!==-1)switch(i){case"enable-proposed-api":Array.isArray(n)?n.forEach(t=>t&&typeof t=="string"&&process.argv.push("--enable-proposed-api",t)):console.error("Unexpected value for `enable-proposed-api` in argv.json. Expected array of extension ids.");break;case"log-level":if(typeof n=="string")process.argv.push("--log",n);else if(Array.isArray(n))for(const t of n)process.argv.push("--log",t);break;case"use-inmemory-secretstorage":n&&process.argv.push("--use-inmemory-secretstorage");break}});const u=`CalculateNativeWinOcclusion,${o.commandLine.getSwitchValue("disable-features")}`;o.commandLine.appendSwitch("disable-features",u);const l=`FontMatchingCTMigration,${o.commandLine.getSwitchValue("disable-blink-features")}`;o.commandLine.appendSwitch("disable-blink-features",l);const b=J(e);return b&&o.commandLine.appendSwitch("js-flags",b),p}function z(){const e=G();let r;try{r=_(f.readFileSync(e).toString())}catch(a){a&&a.code==="ENOENT"?B(e):console.warn(`Unable to read argv.json configuration file in ${e}, falling back to defaults (${a})`)}return r||(r={}),r}function B(e){try{const r=d.dirname(e);f.existsSync(r)||f.mkdirSync(r);const a=["// This configuration file allows you to pass permanent command line arguments to VS Code.","// Only a subset of arguments is currently supported to reduce the likelihood of breaking","// the installation.","//","// PLEASE DO NOT CHANGE WITHOUT UNDERSTANDING THE IMPACT","//","// NOTE: Changing this file requires a restart of VS Code.","{","	// Use software rendering instead of hardware accelerated rendering.","	// This can help in cases where you see rendering issues in VS Code.",'	// "disable-hardware-acceleration": true',"}"];f.writeFileSync(e,a.join(`
`))}catch(r){console.error(`Unable to create argv.json configuration file in ${e}, falling back to defaults (${r})`)}}function G(){const e=process.env.VSCODE_PORTABLE;if(e)return d.join(e,"argv.json");let r=s.dataFolderName;return process.env.VSCODE_DEV&&(r=`${r}-dev`),d.join(k.homedir(),r,"argv.json")}function q(){let e=c["crash-reporter-directory"],r="";if(e){if(e=d.normalize(e),d.isAbsolute(e)||(console.error(`The path '${e}' specified for --crash-reporter-directory must be absolute.`),o.exit(1)),!f.existsSync(e))try{f.mkdirSync(e,{recursive:!0})}catch{console.error(`The path '${e}' specified for --crash-reporter-directory does not seem to exist or cannot be created.`),o.exit(1)}console.log(`Found --crash-reporter-directory argument. Setting crashDumps directory to be '${e}'`),o.setPath("crashDumps",e)}else{const l=s.appCenter;if(l){const b=process.platform==="win32",i=process.platform==="linux",n=process.platform==="darwin",t=S["crash-reporter-id"];if(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t)){if(b)switch(process.arch){case"x64":r=l["win32-x64"];break;case"arm64":r=l["win32-arm64"];break}else if(n)if(s.darwinUniversalAssetId)r=l["darwin-universal"];else switch(process.arch){case"x64":r=l.darwin;break;case"arm64":r=l["darwin-arm64"];break}else i&&(r=l["linux-x64"]);r=r.concat("&uid=",t,"&iid=",t,"&sid=",t);const w=process.argv,L=w.indexOf("--");L===-1?w.push("--crash-reporter-id",t):w.splice(L,0,"--crash-reporter-id",t)}}}const a=(s.crashReporter?s.crashReporter.productName:void 0)||s.nameShort,p=(s.crashReporter?s.crashReporter.companyName:void 0)||"Microsoft",u=!!(!process.env.VSCODE_DEV&&r&&!e);j.start({companyName:p,productName:process.env.VSCODE_DEV?`${a} Dev`:a,submitURL:r,uploadToServer:u,compress:!0})}function J(e){const r=[];return e["js-flags"]&&r.push(e["js-flags"]),r.length>0?r.join(" "):null}function Z(){return F(process.argv,{string:["user-data-dir","locale","js-flags","crash-reporter-directory"],boolean:["disable-chromium-sandbox"],default:{sandbox:!0},alias:{"no-sandbox":"sandbox"}})}function Q(){const e=[];global.macOpenFiles=e,o.on("open-file",function(p,u){e.push(u)});const r=[],a=function(p,u){p.preventDefault(),r.push(u)};o.on("will-finish-launching",function(){o.on("open-url",a)}),global.getOpenUrls=function(){return o.removeListener("open-url",a),r}}function X(){if(process.argv.indexOf("--no-cached-data")>0||process.env.VSCODE_DEV)return;const e=s.commit;if(e)return d.join(h,"CachedData",e)}async function Y(e){if(typeof e=="string")try{return await f.promises.mkdir(e,{recursive:!0}),e}catch{}}function P(e){if(e.startsWith("zh")){const r=e.split("-")[1];return["hans","cn","sg","my"].includes(r)?"zh-cn":"zh-tw"}return e}async function K(){const e=v?await v:void 0;if(e)return e;let r=o.getLocale();return r?(r=P(r.toLowerCase()),E({userLocale:r,osLocale:y,commit:s.commit,userDataPath:h,nlsMetadataPath:C})):{userLocale:"en",osLocale:y,resolvedLanguage:"en",defaultMessagesFile:d.join(C,"nls.messages.json"),locale:"en",availableLanguages:{}}}function ee(e){const r=c.locale;return r?r.toLowerCase():typeof e?.locale=="string"?e.locale.toLowerCase():void 0}
