import{bufferToStream as D,VSBuffer as u}from"../../../../base/common/buffer.js";import"../../../../base/common/cancellation.js";import"../../../../base/common/collections.js";import{Emitter as y}from"../../../../base/common/event.js";import"../../../../base/common/jsonFormatter.js";import{Disposable as U}from"../../../../base/common/lifecycle.js";import{Schemas as I}from"../../../../base/common/network.js";import{joinPath as l}from"../../../../base/common/resources.js";import{URI as b}from"../../../../base/common/uri.js";import{generateUuid as P}from"../../../../base/common/uuid.js";import"../../../../base/parts/request/common/request.js";import{IConfigurationService as E}from"../../../configuration/common/configuration.js";import{ConfigurationService as _}from"../../../configuration/common/configurationService.js";import{IEnvironmentService as C}from"../../../environment/common/environment.js";import{GlobalExtensionEnablementService as w}from"../../../extensionManagement/common/extensionEnablementService.js";import{IExtensionGalleryService as M,IExtensionManagementService as x,IGlobalExtensionEnablementService as q}from"../../../extensionManagement/common/extensionManagement.js";import{IFileService as T}from"../../../files/common/files.js";import{FileService as A}from"../../../files/common/fileService.js";import{InMemoryFileSystemProvider as p}from"../../../files/common/inMemoryFilesystemProvider.js";import{TestInstantiationService as H}from"../../../instantiation/test/common/instantiationServiceMock.js";import{ILogService as O,NullLogService as N}from"../../../log/common/log.js";import L from"../../../product/common/product.js";import{IProductService as k}from"../../../product/common/productService.js";import{IRequestService as F}from"../../../request/common/request.js";import{InMemoryStorageService as $,IStorageService as G}from"../../../storage/common/storage.js";import{ITelemetryService as j}from"../../../telemetry/common/telemetry.js";import{NullTelemetryService as z}from"../../../telemetry/common/telemetryUtils.js";import{IUriIdentityService as B}from"../../../uriIdentity/common/uriIdentity.js";import{UriIdentityService as W}from"../../../uriIdentity/common/uriIdentityService.js";import{ExtensionStorageService as J,IExtensionStorageService as K}from"../../../extensionManagement/common/extensionStorage.js";import{IgnoredExtensionsManagementService as V,IIgnoredExtensionsManagementService as Y}from"../../common/ignoredExtensions.js";import{ALL_SYNC_RESOURCES as X,getDefaultIgnoredSettings as Q,IUserDataSyncLocalStoreService as Z,IUserDataSyncLogService as ee,IUserDataSyncEnablementService as te,IUserDataSyncService as f,IUserDataSyncStoreManagementService as re,IUserDataSyncStoreService as d,IUserDataSyncUtilService as ie,registerConfiguration as se,USER_DATA_SYNC_SCHEME as ne}from"../../common/userDataSync.js";import{IUserDataSyncAccountService as ae,UserDataSyncAccountService as oe}from"../../common/userDataSyncAccount.js";import{UserDataSyncLocalStoreService as ce}from"../../common/userDataSyncLocalStoreService.js";import{IUserDataSyncMachinesService as ue,UserDataSyncMachinesService as le}from"../../common/userDataSyncMachines.js";import{UserDataSyncEnablementService as he}from"../../common/userDataSyncEnablementService.js";import{UserDataSyncService as Se}from"../../common/userDataSyncService.js";import{UserDataSyncStoreManagementService as fe,UserDataSyncStoreService as de}from"../../common/userDataSyncStoreService.js";import{InMemoryUserDataProfilesService as ve,IUserDataProfilesService as R}from"../../../userDataProfile/common/userDataProfile.js";import{NullPolicyService as me}from"../../../policy/common/policy.js";import{IUserDataProfileStorageService as ge}from"../../../userDataProfile/common/userDataProfileStorageService.js";import{TestUserDataProfileStorageService as ye}from"../../../userDataProfile/test/common/userDataProfileStorageService.test.js";class _t extends U{constructor(i=new Ie){super();this.testServer=i;this.instantiationService=this._register(new H)}instantiationService;async setUp(i=!1){this._register(se());const r=this.instantiationService.stub(O,new N),t=b.file("userdata").with({scheme:I.inMemory}),n=l(t,".sync"),a=this.instantiationService.stub(C,{userDataSyncHome:n,userRoamingDataHome:t,cacheHome:l(t,"cache"),argvResource:l(t,"argv.json"),sync:"on"});this.instantiationService.stub(k,{_serviceBrand:void 0,...L,"configurationSync.store":{url:this.testServer.url,stableUrl:this.testServer.url,insidersUrl:this.testServer.url,canSwitch:!1,authenticationProviders:{test:{scopes:[]}}}});const s=this._register(new A(r));this._register(s.registerProvider(I.inMemory,this._register(new p))),this._register(s.registerProvider(ne,this._register(new p))),this.instantiationService.stub(T,s);const c=this._register(this.instantiationService.createInstance(W));this.instantiationService.stub(B,c);const o=this._register(new ve(a,s,c,r));this.instantiationService.stub(R,o);const m=this._register(new Re(o.defaultProfile));this.instantiationService.stub(G,this._register(m)),this.instantiationService.stub(ge,this._register(new ye(!1,m)));const S=this._register(new _(o.defaultProfile.settingsResource,s,new me,r));await S.initialize(),this.instantiationService.stub(E,S),this.instantiationService.stub(F,this.testServer),this.instantiationService.stub(ee,r),this.instantiationService.stub(j,z),this.instantiationService.stub(re,this._register(this.instantiationService.createInstance(fe))),this.instantiationService.stub(d,this._register(this.instantiationService.createInstance(de)));const g=this._register(this.instantiationService.createInstance(oe));await g.updateAccount({authenticationProviderId:"authenticationProviderId",token:"token"}),this.instantiationService.stub(ae,g),this.instantiationService.stub(ue,this._register(this.instantiationService.createInstance(le))),this.instantiationService.stub(Z,this._register(this.instantiationService.createInstance(ce))),this.instantiationService.stub(ie,new pe),this.instantiationService.stub(te,this._register(this.instantiationService.createInstance(he))),this.instantiationService.stub(x,{async getInstalled(){return[]},onDidInstallExtensions:new y().event,onDidUninstallExtension:new y().event}),this.instantiationService.stub(q,this._register(this.instantiationService.createInstance(w))),this.instantiationService.stub(K,this._register(this.instantiationService.createInstance(J))),this.instantiationService.stub(Y,this.instantiationService.createInstance(V)),this.instantiationService.stub(M,{isEnabled(){return!0},async getCompatibleExtension(){return null}}),this.instantiationService.stub(f,this._register(this.instantiationService.createInstance(Se))),i||(await s.writeFile(o.defaultProfile.settingsResource,u.fromString(JSON.stringify({}))),await s.writeFile(o.defaultProfile.keybindingsResource,u.fromString(JSON.stringify([]))),await s.writeFile(l(o.defaultProfile.snippetsHome,"c.json"),u.fromString("{}")),await s.writeFile(o.defaultProfile.tasksResource,u.fromString("{}")),await s.writeFile(a.argvResource,u.fromString(JSON.stringify({locale:"en"})))),await S.reloadConfiguration()}async sync(){await(await this.instantiationService.get(f).createSyncTask(null)).run()}read(i,r){return this.instantiationService.get(d).readResource(i,null,r)}async getResourceManifest(){return(await this.instantiationService.get(d).manifest(null))?.latest??null}getSynchronizer(i){return this.instantiationService.get(f).getOrCreateActiveProfileSynchronizer(this.instantiationService.get(R).defaultProfile,void 0).enabled.find(r=>r.resource===i)}}const v=[...X,"machines"];class Ie{constructor(e=Number.MAX_SAFE_INTEGER,i){this.rateLimit=e;this.retryAfter=i}_serviceBrand;url="http://host:3000";session=null;collections=new Map;data=new Map;_requests=[];get requests(){return this._requests}_requestsWithAllHeaders=[];get requestsWithAllHeaders(){return this._requestsWithAllHeaders}_responses=[];get responses(){return this._responses}reset(){this._requests=[],this._responses=[],this._requestsWithAllHeaders=[]}manifestRef=0;collectionCounter=0;async resolveProxy(e){return e}async lookupAuthorization(e){}async lookupKerberosAuthorization(e){}async loadCertificates(){return[]}async request(e,i){if(this._requests.length===this.rateLimit)return this.toResponse(429,this.retryAfter?{"retry-after":`${this.retryAfter}`}:void 0);const r={};e.headers&&(e.headers["If-None-Match"]&&(r["If-None-Match"]=e.headers["If-None-Match"]),e.headers["If-Match"]&&(r["If-Match"]=e.headers["If-Match"])),this._requests.push({url:e.url,type:e.type,headers:r}),this._requestsWithAllHeaders.push({url:e.url,type:e.type,headers:e.headers});const t=await this.doRequest(e);return this._responses.push({status:t.res.statusCode}),t}async doRequest(e){const i=`${this.url}/v1/`,r=e.url.indexOf(i)===0?e.url.substring(i.length):void 0,t=r?r.split("/"):[];return e.type==="GET"&&t.length===1&&t[0]==="manifest"?this.getManifest(e.headers):e.type==="GET"&&t.length===3&&t[0]==="resource"?this.getResourceData(void 0,t[1],t[2]==="latest"?void 0:t[2],e.headers):e.type==="POST"&&t.length===2&&t[0]==="resource"?this.writeData(void 0,t[1],e.data,e.headers):e.type==="GET"&&t.length===5&&t[0]==="collection"&&t[2]==="resource"?this.getResourceData(t[1],t[3],t[4]==="latest"?void 0:t[4],e.headers):e.type==="POST"&&t.length===4&&t[0]==="collection"&&t[2]==="resource"?this.writeData(t[1],t[3],e.data,e.headers):e.type==="DELETE"&&t.length===2&&t[0]==="resource"?this.deleteResourceData(void 0,t[1]):e.type==="DELETE"&&t.length===1&&t[0]==="resource"?this.clear(e.headers):e.type==="DELETE"&&t[0]==="collection"?this.toResponse(204):e.type==="POST"&&t.length===1&&t[0]==="collection"?this.createCollection():this.toResponse(501)}async getManifest(e){if(this.session){const i=Object.create({});this.data.forEach((n,a)=>i[a]=n.ref);let r;if(this.collectionCounter){r={};for(let n=1;n<=this.collectionCounter;n++){const a=this.collections.get(`${n}`);if(a){const s=Object.create({});a.forEach((c,o)=>s[o]=c.ref),r[`${n}`]={latest:s}}}}const t={session:this.session,latest:i,collection:r};return this.toResponse(200,{"Content-Type":"application/json",etag:`${this.manifestRef++}`},JSON.stringify(t))}return this.toResponse(204,{etag:`${this.manifestRef++}`})}async getResourceData(e,i,r,t={}){const n=e?this.collections.get(e):this.data;if(!n)return this.toResponse(501);const a=v.find(s=>s===i);if(a){const s=n.get(a);return r&&s?.ref!==r?this.toResponse(404):s?t["If-None-Match"]===s.ref?this.toResponse(304):this.toResponse(200,{etag:s.ref},s.content||""):this.toResponse(204,{etag:"0"})}return this.toResponse(204)}async writeData(e,i,r="",t={}){this.session||(this.session=P());const n=e?this.collections.get(e):this.data;if(!n)return this.toResponse(501);const a=v.find(s=>s===i);if(a){const s=n.get(a);if(t["If-Match"]!==void 0&&t["If-Match"]!==(s?s.ref:"0"))return this.toResponse(412);const c=`${parseInt(s?.ref||"0")+1}`;return n.set(a,{ref:c,content:r}),this.toResponse(200,{etag:c})}return this.toResponse(204)}async deleteResourceData(e,i,r={}){const t=e?this.collections.get(e):this.data;if(!t)return this.toResponse(501);const n=v.find(a=>a===i);return n?(t.delete(n),this.toResponse(200)):this.toResponse(404)}async createCollection(){const e=`${++this.collectionCounter}`;return this.collections.set(e,new Map),this.toResponse(200,{},e)}async clear(e){return this.collections.clear(),this.data.clear(),this.session=null,this.collectionCounter=0,this.toResponse(204)}toResponse(e,i,r){return{res:{headers:i||{},statusCode:e},stream:D(u.fromString(r||""))}}}class pe{_serviceBrand;async resolveDefaultCoreIgnoredSettings(){return Q()}async resolveUserBindings(e){const i={};for(const r of e)i[r]=r;return i}async resolveFormattingOptions(e){return{eol:`
`,insertSpaces:!1,tabSize:4}}}class Re extends ${constructor(i){super();this.profileStorageProfile=i}hasScope(i){return this.profileStorageProfile.id===i.id}}export{pe as TestUserDataSyncUtilService,_t as UserDataSyncClient,Ie as UserDataSyncTestServer};
