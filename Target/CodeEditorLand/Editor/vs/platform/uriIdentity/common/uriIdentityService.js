var h=Object.defineProperty;var d=Object.getOwnPropertyDescriptor;var c=(n,e,r,t)=>{for(var i=t>1?void 0:t?d(e,r):e,s=n.length-1,l;s>=0;s--)(l=n[s])&&(i=(t?l(e,r,i):l(i))||i);return t&&i&&h(e,r,i),i},m=(n,e)=>(r,t)=>e(r,t,n);import{IUriIdentityService as p}from"./uriIdentity.js";import"../../../base/common/uri.js";import{InstantiationType as v,registerSingleton as U}from"../../instantiation/common/extensions.js";import{IFileService as _,FileSystemProviderCapabilities as g}from"../../files/common/files.js";import{ExtUri as f,normalizePath as y}from"../../../base/common/resources.js";import{SkipList as I}from"../../../base/common/skipList.js";import{Event as C}from"../../../base/common/event.js";import{DisposableStore as P}from"../../../base/common/lifecycle.js";class a{constructor(e){this.uri=e}static _clock=0;time=a._clock++;touch(){return this.time=a._clock++,this}}let o=class{constructor(e){this._fileService=e;const r=new Map,t=i=>{let s=r.get(i.scheme);return s===void 0&&(s=e.hasProvider(i)&&!this._fileService.hasCapability(i,g.PathCaseSensitive),r.set(i.scheme,s)),s};this._dispooables.add(C.any(e.onDidChangeFileSystemProviderRegistrations,e.onDidChangeFileSystemProviderCapabilities)(i=>{r.delete(i.scheme)})),this.extUri=new f(t),this._canonicalUris=new I((i,s)=>this.extUri.compare(i,s,!0),this._limit)}extUri;_dispooables=new P;_canonicalUris;_limit=2**16;dispose(){this._dispooables.dispose(),this._canonicalUris.clear()}asCanonicalUri(e){this._fileService.hasProvider(e)&&(e=y(e));const r=this._canonicalUris.get(e);return r?r.touch().uri.with({fragment:e.fragment}):(this._canonicalUris.set(e,new a(e)),this._checkTrim(),e)}_checkTrim(){if(this._canonicalUris.size<this._limit)return;const e=[...this._canonicalUris.entries()].sort((t,i)=>t[1].time<i[1].time?1:t[1].time>i[1].time?-1:0);a._clock=0,this._canonicalUris.clear();const r=this._limit*.5;for(let t=0;t<r;t++)this._canonicalUris.set(e[t][0],e[t][1].touch())}};o=c([m(0,_)],o),U(p,o,v.Delayed);export{o as UriIdentityService};
