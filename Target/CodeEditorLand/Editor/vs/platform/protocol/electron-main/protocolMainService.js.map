{
  "version": 3,
  "sources": ["../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/platform/protocol/electron-main/protocolMainService.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { session } from \"electron\";\nimport {\n\tDisposable,\n\ttype IDisposable,\n\ttoDisposable,\n} from \"../../../base/common/lifecycle.js\";\nimport { COI, FileAccess, Schemas } from \"../../../base/common/network.js\";\nimport { basename, extname, normalize } from \"../../../base/common/path.js\";\nimport { isLinux } from \"../../../base/common/platform.js\";\nimport { TernarySearchTree } from \"../../../base/common/ternarySearchTree.js\";\nimport { URI } from \"../../../base/common/uri.js\";\nimport { generateUuid } from \"../../../base/common/uuid.js\";\nimport { validatedIpcMain } from \"../../../base/parts/ipc/electron-main/ipcMain.js\";\nimport { INativeEnvironmentService } from \"../../environment/common/environment.js\";\nimport { ILogService } from \"../../log/common/log.js\";\nimport { IUserDataProfilesService } from \"../../userDataProfile/common/userDataProfile.js\";\nimport type { IIPCObjectUrl, IProtocolMainService } from \"./protocol.js\";\n\ntype ProtocolCallback = {\n\t(result: string | Electron.FilePathWithHeaders | { error: number }): void;\n};\n\nexport class ProtocolMainService\n\textends Disposable\n\timplements IProtocolMainService\n{\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate readonly validRoots = TernarySearchTree.forPaths<boolean>(!isLinux);\n\tprivate readonly validExtensions = new Set([\n\t\t\".svg\",\n\t\t\".png\",\n\t\t\".jpg\",\n\t\t\".jpeg\",\n\t\t\".gif\",\n\t\t\".bmp\",\n\t\t\".webp\",\n\t\t\".mp4\",\n\t]); // https://github.com/microsoft/vscode/issues/119384\n\n\tconstructor(\n\t\t@INativeEnvironmentService private readonly environmentService: INativeEnvironmentService,\n\t\t@IUserDataProfilesService userDataProfilesService: IUserDataProfilesService,\n\t\t@ILogService private readonly logService: ILogService\n\t) {\n\t\tsuper();\n\n\t\t// Define an initial set of roots we allow loading from\n\t\t// - appRoot\t: all files installed as part of the app\n\t\t// - extensions : all files shipped from extensions\n\t\t// - storage    : all files in global and workspace storage (https://github.com/microsoft/vscode/issues/116735)\n\t\tthis.addValidFileRoot(environmentService.appRoot);\n\t\tthis.addValidFileRoot(environmentService.extensionsPath);\n\t\tthis.addValidFileRoot(userDataProfilesService.defaultProfile.globalStorageHome.with({ scheme: Schemas.file }).fsPath);\n\t\tthis.addValidFileRoot(environmentService.workspaceStorageHome.with({ scheme: Schemas.file }).fsPath);\n\n\t\t// Handle protocols\n\t\tthis.handleProtocols();\n\t}\n\n\tprivate handleProtocols(): void {\n\t\tconst { defaultSession } = session;\n\n\t\t// Register vscode-file:// handler\n\t\tdefaultSession.protocol.registerFileProtocol(\n\t\t\tSchemas.vscodeFileResource,\n\t\t\t(request, callback) =>\n\t\t\t\tthis.handleResourceRequest(request, callback),\n\t\t);\n\n\t\t// Block any file:// access\n\t\tdefaultSession.protocol.interceptFileProtocol(\n\t\t\tSchemas.file,\n\t\t\t(request, callback) => this.handleFileRequest(request, callback),\n\t\t);\n\n\t\t// Cleanup\n\t\tthis._register(\n\t\t\ttoDisposable(() => {\n\t\t\t\tdefaultSession.protocol.unregisterProtocol(\n\t\t\t\t\tSchemas.vscodeFileResource,\n\t\t\t\t);\n\t\t\t\tdefaultSession.protocol.uninterceptProtocol(Schemas.file);\n\t\t\t}),\n\t\t);\n\t}\n\n\taddValidFileRoot(root: string): IDisposable {\n\t\t// Pass to `normalize` because we later also do the\n\t\t// same for all paths to check against.\n\t\tconst normalizedRoot = normalize(root);\n\n\t\tif (!this.validRoots.get(normalizedRoot)) {\n\t\t\tthis.validRoots.set(normalizedRoot, true);\n\n\t\t\treturn toDisposable(() => this.validRoots.delete(normalizedRoot));\n\t\t}\n\n\t\treturn Disposable.None;\n\t}\n\n\t//#region file://\n\n\tprivate handleFileRequest(\n\t\trequest: Electron.ProtocolRequest,\n\t\tcallback: ProtocolCallback,\n\t) {\n\t\tconst uri = URI.parse(request.url);\n\n\t\tthis.logService.error(\n\t\t\t`Refused to load resource ${uri.fsPath} from ${Schemas.file}: protocol (original URL: ${request.url})`,\n\t\t);\n\n\t\treturn callback({ error: -3 /* ABORTED */ });\n\t}\n\n\t//#endregion\n\n\t//#region vscode-file://\n\n\tprivate handleResourceRequest(\n\t\trequest: Electron.ProtocolRequest,\n\t\tcallback: ProtocolCallback,\n\t): void {\n\t\tconst path = this.requestToNormalizedFilePath(request);\n\n\t\tlet headers: Record<string, string> | undefined;\n\t\tif (this.environmentService.crossOriginIsolated) {\n\t\t\tconst pathBasename = basename(path);\n\t\t\tif (\n\t\t\t\tpathBasename === \"workbench.html\" ||\n\t\t\t\tpathBasename === \"workbench-dev.html\" ||\n\t\t\t\tpathBasename === \"workbench.esm.html\" ||\n\t\t\t\tpathBasename === \"workbench-dev.esm.html\"\n\t\t\t) {\n\t\t\t\theaders = COI.CoopAndCoep;\n\t\t\t} else {\n\t\t\t\theaders = COI.getHeadersFromQuery(request.url);\n\t\t\t}\n\t\t}\n\n\t\t// first check by validRoots\n\t\tif (this.validRoots.findSubstr(path)) {\n\t\t\treturn callback({ path, headers });\n\t\t}\n\n\t\t// then check by validExtensions\n\t\tif (this.validExtensions.has(extname(path).toLowerCase())) {\n\t\t\treturn callback({ path });\n\t\t}\n\n\t\t// finally block to load the resource\n\t\tthis.logService.error(\n\t\t\t`${Schemas.vscodeFileResource}: Refused to load resource ${path} from ${Schemas.vscodeFileResource}: protocol (original URL: ${request.url})`,\n\t\t);\n\n\t\treturn callback({ error: -3 /* ABORTED */ });\n\t}\n\n\tprivate requestToNormalizedFilePath(\n\t\trequest: Electron.ProtocolRequest,\n\t): string {\n\t\t// 1.) Use `URI.parse()` util from us to convert the raw\n\t\t//     URL into our URI.\n\t\tconst requestUri = URI.parse(request.url);\n\n\t\t// 2.) Use `FileAccess.asFileUri` to convert back from a\n\t\t//     `vscode-file:` URI to a `file:` URI.\n\t\tconst unnormalizedFileUri = FileAccess.uriToFileUri(requestUri);\n\n\t\t// 3.) Strip anything from the URI that could result in\n\t\t//     relative paths (such as \"..\") by using `normalize`\n\t\treturn normalize(unnormalizedFileUri.fsPath);\n\t}\n\n\t//#endregion\n\n\t//#region IPC Object URLs\n\n\tcreateIPCObjectUrl<T>(): IIPCObjectUrl<T> {\n\t\tlet obj: T | undefined;\n\n\t\t// Create unique URI\n\t\tconst resource = URI.from({\n\t\t\tscheme: \"vscode\", // used for all our IPC communication (vscode:<channel>)\n\t\t\tpath: generateUuid(),\n\t\t});\n\n\t\t// Install IPC handler\n\t\tconst channel = resource.toString();\n\t\tconst handler = async (): Promise<T | undefined> => obj;\n\t\tvalidatedIpcMain.handle(channel, handler);\n\n\t\tthis.logService.trace(\n\t\t\t`IPC Object URL: Registered new channel ${channel}.`,\n\t\t);\n\n\t\treturn {\n\t\t\tresource,\n\t\t\tupdate: (updatedObj) => (obj = updatedObj),\n\t\t\tdispose: () => {\n\t\t\t\tthis.logService.trace(\n\t\t\t\t\t`IPC Object URL: Removed channel ${channel}.`,\n\t\t\t\t);\n\n\t\t\t\tvalidatedIpcMain.removeHandler(channel);\n\t\t\t},\n\t\t};\n\t}\n\n\t//#endregion\n}\n"],
  "mappings": "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",
  "names": []
}
