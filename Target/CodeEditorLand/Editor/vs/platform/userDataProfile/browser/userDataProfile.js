var m=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var S=(l,e,t,r)=>{for(var i=r>1?void 0:r?P(e,t):e,o=l.length-1,s;o>=0;o--)(s=l[o])&&(i=(r?s(e,t,i):s(i))||i);return r&&i&&m(e,t,i),i},c=(l,e)=>(t,r)=>e(t,r,l);import{BroadcastDataChannel as g}from"../../../base/browser/broadcast.js";import{revive as v}from"../../../base/common/marshalling.js";import{IEnvironmentService as I}from"../../environment/common/environment.js";import{IFileService as D}from"../../files/common/files.js";import{ILogService as O}from"../../log/common/log.js";import{IUriIdentityService as u}from"../../uriIdentity/common/uriIdentity.js";import{UserDataProfilesService as n,reviveProfile as d}from"../common/userDataProfile.js";let f=class extends n{changesBroadcastChannel;constructor(e,t,r,i){super(e,t,r,i),this.changesBroadcastChannel=this._register(new g(`${n.PROFILES_KEY}.changes`)),this._register(this.changesBroadcastChannel.onDidReceiveData(o=>{try{this._profilesObject=void 0;const s=o.added.map(a=>d(a,this.profilesHome.scheme)),h=o.removed.map(a=>d(a,this.profilesHome.scheme)),p=o.updated.map(a=>d(a,this.profilesHome.scheme));this.updateTransientProfiles(s.filter(a=>a.isTransient),h.filter(a=>a.isTransient),p.filter(a=>a.isTransient)),this._onDidChangeProfiles.fire({added:s,removed:h,updated:p,all:this.profiles})}catch{}}))}updateTransientProfiles(e,t,r){if(e.length&&this.transientProfilesObject.profiles.push(...e),t.length||r.length){const i=this.transientProfilesObject.profiles;this.transientProfilesObject.profiles=[];for(const o of i)t.some(s=>o.id===s.id)||this.transientProfilesObject.profiles.push(r.find(s=>o.id===s.id)??o)}}getStoredProfiles(){try{const e=localStorage.getItem(n.PROFILES_KEY);if(e)return v(JSON.parse(e))}catch(e){this.logService.error(e)}return[]}triggerProfilesChanges(e,t,r){super.triggerProfilesChanges(e,t,r),this.changesBroadcastChannel.postData({added:e,removed:t,updated:r})}saveStoredProfiles(e){localStorage.setItem(n.PROFILES_KEY,JSON.stringify(e))}getStoredProfileAssociations(){const e="profileAssociationsMigration";try{const t=localStorage.getItem(n.PROFILE_ASSOCIATIONS_KEY);if(t){let r=JSON.parse(t);return localStorage.getItem(e)||(r=this.migrateStoredProfileAssociations(r),this.saveStoredProfileAssociations(r),localStorage.setItem(e,"true")),r}}catch(t){this.logService.error(t)}return{}}saveStoredProfileAssociations(e){localStorage.setItem(n.PROFILE_ASSOCIATIONS_KEY,JSON.stringify(e))}};f=S([c(0,I),c(1,D),c(2,u),c(3,O)],f);export{f as BrowserUserDataProfilesService};
