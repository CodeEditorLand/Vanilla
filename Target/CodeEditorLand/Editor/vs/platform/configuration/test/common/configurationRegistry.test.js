import t from"assert";import{ensureNoDisposablesAreLeakedInTestSuite as a}from"../../../../base/test/common/utils.js";import{Extensions as n}from"../../common/configurationRegistry.js";import{Registry as s}from"../../../registry/common/platform.js";suite("ConfigurationRegistry",()=>{a();const e=s.as(n.Configuration);setup(()=>o()),teardown(()=>o());function o(){e.deregisterConfigurations(e.getConfigurations()),e.deregisterDefaultConfigurations(e.getRegisteredDefaultConfigurations())}test("configuration override",async()=>{e.registerConfiguration({id:"_test_default",type:"object",properties:{config:{type:"object"}}}),e.registerDefaultConfigurations([{overrides:{config:{a:1,b:2}}}]),e.registerDefaultConfigurations([{overrides:{"[lang]":{a:2,c:3}}}]),t.deepStrictEqual(e.getConfigurationProperties().config.default,{a:1,b:2}),t.deepStrictEqual(e.getConfigurationProperties()["[lang]"].default,{a:2,c:3})}),test("configuration override defaults - prevent overriding default value",async()=>{e.registerConfiguration({id:"_test_default",type:"object",properties:{"config.preventDefaultValueOverride":{type:"object",default:{a:0},disallowConfigurationDefault:!0}}}),e.registerDefaultConfigurations([{overrides:{"config.preventDefaultValueOverride":{a:1,b:2}}}]),t.deepStrictEqual(e.getConfigurationProperties()["config.preventDefaultValueOverride"].default,{a:0})}),test("configuration override defaults - merges defaults",async()=>{e.registerDefaultConfigurations([{overrides:{"[lang]":{a:1,b:2}}}]),e.registerDefaultConfigurations([{overrides:{"[lang]":{a:2,c:3}}}]),t.deepStrictEqual(e.getConfigurationProperties()["[lang]"].default,{a:2,b:2,c:3})}),test("configuration defaults - merge object default overrides",async()=>{e.registerConfiguration({id:"_test_default",type:"object",properties:{config:{type:"object"}}}),e.registerDefaultConfigurations([{overrides:{config:{a:1,b:2}}}]),e.registerDefaultConfigurations([{overrides:{config:{a:2,c:3}}}]),t.deepStrictEqual(e.getConfigurationProperties().config.default,{a:2,b:2,c:3})}),test("registering multiple settings with same policy",async()=>{e.registerConfiguration({id:"_test_default",type:"object",properties:{policy1:{type:"object",policy:{name:"policy",minimumVersion:"1.0.0"}},policy2:{type:"object",policy:{name:"policy",minimumVersion:"1.0.0"}}}});const i=e.getConfigurationProperties();t.ok(i.policy1!==void 0),t.ok(i.policy2===void 0)}),test("configuration defaults - deregister merged object default override",async()=>{e.registerConfiguration({id:"_test_default",type:"object",properties:{config:{type:"object"}}});const i=[{overrides:{config:{a:1,b:2}},source:{id:"source1",displayName:"source1"}}],r=[{overrides:{config:{a:2,c:3}},source:{id:"source2",displayName:"source2"}}];e.registerDefaultConfigurations(i),e.registerDefaultConfigurations(r),t.deepStrictEqual(e.getConfigurationProperties().config.default,{a:2,b:2,c:3}),e.deregisterDefaultConfigurations(r),t.deepStrictEqual(e.getConfigurationProperties().config.default,{a:1,b:2}),e.deregisterDefaultConfigurations(i),t.deepStrictEqual(e.getConfigurationProperties().config.default,{})}),test("configuration defaults - deregister merged object default override without source",async()=>{e.registerConfiguration({id:"_test_default",type:"object",properties:{config:{type:"object"}}});const i=[{overrides:{config:{a:1,b:2}}}],r=[{overrides:{config:{a:2,c:3}}}];e.registerDefaultConfigurations(i),e.registerDefaultConfigurations(r),t.deepStrictEqual(e.getConfigurationProperties().config.default,{a:2,b:2,c:3}),e.deregisterDefaultConfigurations(r),t.deepStrictEqual(e.getConfigurationProperties().config.default,{a:1,b:2}),e.deregisterDefaultConfigurations(i),t.deepStrictEqual(e.getConfigurationProperties().config.default,{})}),test("configuration defaults - deregister merged object default language overrides",async()=>{e.registerConfiguration({id:"_test_default",type:"object",properties:{config:{type:"object"}}});const i=[{overrides:{"[lang]":{config:{a:1,b:2}}},source:{id:"source1",displayName:"source1"}}],r=[{overrides:{"[lang]":{config:{a:2,c:3}}},source:{id:"source2",displayName:"source2"}}];e.registerDefaultConfigurations(i),e.registerDefaultConfigurations(r),t.deepStrictEqual(e.getConfigurationProperties()["[lang]"].default,{config:{a:2,b:2,c:3}}),e.deregisterDefaultConfigurations(r),t.deepStrictEqual(e.getConfigurationProperties()["[lang]"].default,{config:{a:1,b:2}}),e.deregisterDefaultConfigurations(i),t.deepStrictEqual(e.getConfigurationProperties()["[lang]"],void 0)})});
