{
  "version": 3,
  "sources": ["../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/platform/log/common/fileLog.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { ThrottledDelayer } from '../../../base/common/async.js';\nimport { VSBuffer } from '../../../base/common/buffer.js';\nimport { basename, dirname, joinPath } from '../../../base/common/resources.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { ByteSize, FileOperationError, FileOperationResult, IFileService, whenProviderRegistered } from '../../files/common/files.js';\nimport { BufferLogger } from './bufferLog.js';\nimport { AbstractLoggerService, AbstractMessageLogger, ILogger, ILoggerOptions, ILoggerService, LogLevel } from './log.js';\n\nconst MAX_FILE_SIZE = 5 * ByteSize.MB;\n\nclass FileLogger extends AbstractMessageLogger implements ILogger {\n\n\tprivate readonly initializePromise: Promise<void>;\n\tprivate readonly flushDelayer: ThrottledDelayer<void>;\n\tprivate backupIndex: number = 1;\n\tprivate buffer: string = '';\n\n\tconstructor(\n\t\tprivate readonly resource: URI,\n\t\tlevel: LogLevel,\n\t\tprivate readonly donotUseFormatters: boolean,\n\t\t@IFileService private readonly fileService: IFileService\n\t) {\n\t\tsuper();\n\t\tthis.setLevel(level);\n\t\tthis.flushDelayer = new ThrottledDelayer<void>(100 /* buffer saves over a short time */);\n\t\tthis.initializePromise = this.initialize();\n\t}\n\n\toverride async flush(): Promise<void> {\n\t\tif (!this.buffer) {\n\t\t\treturn;\n\t\t}\n\t\tawait this.initializePromise;\n\t\tlet content = await this.loadContent();\n\t\tif (content.length > MAX_FILE_SIZE) {\n\t\t\tawait this.fileService.writeFile(this.getBackupResource(), VSBuffer.fromString(content));\n\t\t\tcontent = '';\n\t\t}\n\t\tif (this.buffer) {\n\t\t\tcontent += this.buffer;\n\t\t\tthis.buffer = '';\n\t\t\tawait this.fileService.writeFile(this.resource, VSBuffer.fromString(content));\n\t\t}\n\t}\n\n\tprivate async initialize(): Promise<void> {\n\t\ttry {\n\t\t\tawait this.fileService.createFile(this.resource);\n\t\t} catch (error) {\n\t\t\tif ((<FileOperationError>error).fileOperationResult !== FileOperationResult.FILE_MODIFIED_SINCE) {\n\t\t\t\tthrow error;\n\t\t\t}\n\t\t}\n\t}\n\n\tprotected log(level: LogLevel, message: string): void {\n\t\tif (this.donotUseFormatters) {\n\t\t\tthis.buffer += message;\n\t\t} else {\n\t\t\tthis.buffer += `${this.getCurrentTimestamp()} [${this.stringifyLogLevel(level)}] ${message}\\n`;\n\t\t}\n\t\tthis.flushDelayer.trigger(() => this.flush());\n\t}\n\n\tprivate getCurrentTimestamp(): string {\n\t\tconst toTwoDigits = (v: number) => v < 10 ? `0${v}` : v;\n\t\tconst toThreeDigits = (v: number) => v < 10 ? `00${v}` : v < 100 ? `0${v}` : v;\n\t\tconst currentTime = new Date();\n\t\treturn `${currentTime.getFullYear()}-${toTwoDigits(currentTime.getMonth() + 1)}-${toTwoDigits(currentTime.getDate())} ${toTwoDigits(currentTime.getHours())}:${toTwoDigits(currentTime.getMinutes())}:${toTwoDigits(currentTime.getSeconds())}.${toThreeDigits(currentTime.getMilliseconds())}`;\n\t}\n\n\tprivate getBackupResource(): URI {\n\t\tthis.backupIndex = this.backupIndex > 5 ? 1 : this.backupIndex;\n\t\treturn joinPath(dirname(this.resource), `${basename(this.resource)}_${this.backupIndex++}`);\n\t}\n\n\tprivate async loadContent(): Promise<string> {\n\t\ttry {\n\t\t\tconst content = await this.fileService.readFile(this.resource);\n\t\t\treturn content.value.toString();\n\t\t} catch (e) {\n\t\t\treturn '';\n\t\t}\n\t}\n\n\tprivate stringifyLogLevel(level: LogLevel): string {\n\t\tswitch (level) {\n\t\t\tcase LogLevel.Debug: return 'debug';\n\t\t\tcase LogLevel.Error: return 'error';\n\t\t\tcase LogLevel.Info: return 'info';\n\t\t\tcase LogLevel.Trace: return 'trace';\n\t\t\tcase LogLevel.Warning: return 'warning';\n\t\t}\n\t\treturn '';\n\t}\n\n}\n\nexport class FileLoggerService extends AbstractLoggerService implements ILoggerService {\n\n\tconstructor(\n\t\tlogLevel: LogLevel,\n\t\tlogsHome: URI,\n\t\tprivate readonly fileService: IFileService,\n\t) {\n\t\tsuper(logLevel, logsHome);\n\t}\n\n\tprotected doCreateLogger(resource: URI, logLevel: LogLevel, options?: ILoggerOptions): ILogger {\n\t\tconst logger = new BufferLogger(logLevel);\n\t\twhenProviderRegistered(resource, this.fileService).then(() => logger.logger = new FileLogger(resource, logger.getLevel(), !!options?.donotUseFormatters, this.fileService));\n\t\treturn logger;\n\t}\n}\n"],
  "mappings": "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",
  "names": []
}
