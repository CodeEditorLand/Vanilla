var g=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var h=(n,t,e,i)=>{for(var r=i>1?void 0:i?f(t,e):t,s=n.length-1,a;s>=0;s--)(a=n[s])&&(r=(i?a(t,e,r):a(r))||r);return i&&r&&g(t,e,r),r},o=(n,t)=>(e,i)=>t(e,i,n);import"electron";import{validatedIpcMain as l}from"../../../base/parts/ipc/electron-main/ipcMain.js";import{Barrier as m,DeferredPromise as v}from"../../../base/common/async.js";import{Disposable as u}from"../../../base/common/lifecycle.js";import{IEnvironmentMainService as P}from"../../environment/electron-main/environmentMainService.js";import{ILifecycleMainService as S}from"../../lifecycle/electron-main/lifecycleMainService.js";import{ILogService as w}from"../../log/common/log.js";import"../node/sharedProcess.js";import{IUserDataProfilesService as I}from"../../userDataProfile/common/userDataProfile.js";import{IPolicyService as M}from"../../policy/common/policy.js";import{ILoggerMainService as C}from"../../log/electron-main/loggerService.js";import{UtilityProcess as D}from"../../utilityProcess/electron-main/utilityProcess.js";import{NullTelemetryService as L}from"../../telemetry/common/telemetryUtils.js";import{parseSharedProcessDebugPort as R}from"../../environment/node/environmentService.js";import{assertIsDefined as _}from"../../../base/common/types.js";import{SharedProcessChannelConnection as p,SharedProcessRawConnection as y,SharedProcessLifecycle as d}from"../common/sharedProcess.js";import{Emitter as W}from"../../../base/common/event.js";let c=class extends u{constructor(e,i,r,s,a,b,q,B,U){super();this.machineId=e;this.sqmId=i;this.devDeviceId=r;this.environmentMainService=s;this.userDataProfilesService=a;this.lifecycleMainService=b;this.logService=q;this.loggerMainService=B;this.policyService=U;this.registerListeners()}firstWindowConnectionBarrier=new m;utilityProcess=void 0;utilityProcessLogListener=void 0;_onDidCrash=this._register(new W);onDidCrash=this._onDidCrash.event;registerListeners(){l.on(p.request,(e,i)=>this.onWindowConnection(e,i,p.response)),l.on(y.request,(e,i)=>this.onWindowConnection(e,i,y.response)),this._register(this.lifecycleMainService.onWillShutdown(()=>this.onWillShutdown()))}async onWindowConnection(e,i,r){this.logService.trace(`[SharedProcess] onWindowConnection for: ${r}`),this.firstWindowConnectionBarrier.isOpen()||this.firstWindowConnectionBarrier.open(),await this.whenReady();const s=await this.connect(r);if(e.sender.isDestroyed())return s.close();e.sender.postMessage(r,i,[s])}onWillShutdown(){this.logService.trace("[SharedProcess] onWillShutdown"),this.utilityProcess?.postMessage(d.exit),this.utilityProcess=void 0}_whenReady=void 0;whenReady(){return this._whenReady||(this._whenReady=(async()=>{await this.whenIpcReady;const e=new v;this.utilityProcess?.once(d.initDone,()=>e.complete()),await e.p,this.utilityProcessLogListener?.dispose(),this.logService.trace("[SharedProcess] Overall ready")})()),this._whenReady}_whenIpcReady=void 0;get whenIpcReady(){return this._whenIpcReady||(this._whenIpcReady=(async()=>{await this.firstWindowConnectionBarrier.wait(),this.createUtilityProcess();const e=new v;this.utilityProcess?.once(d.ipcReady,()=>e.complete()),await e.p,this.logService.trace("[SharedProcess] IPC ready")})()),this._whenIpcReady}createUtilityProcess(){this.utilityProcess=this._register(new D(this.logService,L,this.lifecycleMainService)),this.utilityProcessLogListener=this.utilityProcess.onMessage(r=>{typeof r.warning=="string"?this.logService.warn(r.warning):typeof r.error=="string"&&this.logService.error(r.error)});const e=R(this.environmentMainService.args,this.environmentMainService.isBuilt);let i;e.port&&(i=["--nolazy"],e.break?i.push(`--inspect-brk=${e.port}`):i.push(`--inspect=${e.port}`)),this.utilityProcess.start({type:"shared-process",entryPoint:"vs/code/electron-utility/sharedProcess/sharedProcessMain",payload:this.createSharedProcessConfiguration(),respondToAuthRequestsFromMainProcess:!0,execArgv:i}),this._register(this.utilityProcess.onCrash(()=>this._onDidCrash.fire()))}createSharedProcessConfiguration(){return{machineId:this.machineId,sqmId:this.sqmId,devDeviceId:this.devDeviceId,codeCachePath:this.environmentMainService.codeCachePath,profiles:{home:this.userDataProfilesService.profilesHome,all:this.userDataProfilesService.profiles},args:this.environmentMainService.args,logLevel:this.loggerMainService.getLogLevel(),loggers:this.loggerMainService.getRegisteredLoggers(),policiesData:this.policyService.serialize()}}async connect(e){return await this.whenIpcReady,_(this.utilityProcess).connect(e)}};c=h([o(3,P),o(4,I),o(5,S),o(6,w),o(7,C),o(8,M)],c);export{c as SharedProcess};
