import t from"assert";import{readFileSync as k,promises as c}from"fs";import{tmpdir as f}from"os";import{DisposableStore as g}from"../../../../base/common/lifecycle.js";import{Schemas as v}from"../../../../base/common/network.js";import{join as n}from"../../../../base/common/path.js";import{URI as i}from"../../../../base/common/uri.js";import{Promises as E,writeFileSync as d}from"../../../../base/node/pfs.js";import{ensureNoDisposablesAreLeakedInTestSuite as q}from"../../../../base/test/common/utils.js";import{flakySuite as w,getRandomTestPath as p}from"../../../../base/test/node/testUtils.js";import"../../../files/common/files.js";import{FileService as S}from"../../../files/common/fileService.js";import{DiskFileSystemProvider as D}from"../../../files/node/diskFileSystemProvider.js";import{NullLogService as h}from"../../../log/common/log.js";import{FileStorage as l,SaveStrategy as r}from"../../node/stateService.js";w("StateService",()=>{let u,a,o,y;const m=new g;setup(()=>(u=p(f(),"vsctests","statemainservice"),o=new h,a=m.add(new S(o)),y=m.add(new D(o)),m.add(a.registerProvider(v.file,y)),c.mkdir(u,{recursive:!0}))),teardown(()=>(m.clear(),E.rm(u))),test("Basics (delayed strategy)",async function(){const s=n(u,"storage.json");d(s,"");let e=m.add(new l(i.file(s),r.DELAYED,o,a));return await e.init(),e.setItem("some.key","some.value"),t.strictEqual(e.getItem("some.key"),"some.value"),e.removeItem("some.key"),t.strictEqual(e.getItem("some.key","some.default"),"some.default"),t.ok(!e.getItem("some.unknonw.key")),e.setItem("some.other.key","some.other.value"),await e.close(),e=m.add(new l(i.file(s),r.DELAYED,o,a)),await e.init(),t.strictEqual(e.getItem("some.other.key"),"some.other.value"),e.setItem("some.other.key","some.other.value"),t.strictEqual(e.getItem("some.other.key"),"some.other.value"),e.setItem("some.undefined.key",void 0),t.strictEqual(e.getItem("some.undefined.key","some.default"),"some.default"),e.setItem("some.null.key",null),t.strictEqual(e.getItem("some.null.key","some.default"),"some.default"),e.setItems([{key:"some.setItems.key1",data:"some.value"},{key:"some.setItems.key2",data:0},{key:"some.setItems.key3",data:!0},{key:"some.setItems.key4",data:null},{key:"some.setItems.key5",data:void 0}]),t.strictEqual(e.getItem("some.setItems.key1"),"some.value"),t.strictEqual(e.getItem("some.setItems.key2"),0),t.strictEqual(e.getItem("some.setItems.key3"),!0),t.strictEqual(e.getItem("some.setItems.key4"),void 0),t.strictEqual(e.getItem("some.setItems.key5"),void 0),e.setItems([{key:"some.setItems.key1",data:void 0},{key:"some.setItems.key2",data:void 0},{key:"some.setItems.key3",data:void 0},{key:"some.setItems.key4",data:null},{key:"some.setItems.key5",data:void 0}]),t.strictEqual(e.getItem("some.setItems.key1"),void 0),t.strictEqual(e.getItem("some.setItems.key2"),void 0),t.strictEqual(e.getItem("some.setItems.key3"),void 0),t.strictEqual(e.getItem("some.setItems.key4"),void 0),t.strictEqual(e.getItem("some.setItems.key5"),void 0),e.close()}),test("Basics (immediate strategy)",async function(){const s=n(u,"storage.json");d(s,"");let e=m.add(new l(i.file(s),r.IMMEDIATE,o,a));return await e.init(),e.setItem("some.key","some.value"),t.strictEqual(e.getItem("some.key"),"some.value"),e.removeItem("some.key"),t.strictEqual(e.getItem("some.key","some.default"),"some.default"),t.ok(!e.getItem("some.unknonw.key")),e.setItem("some.other.key","some.other.value"),await e.close(),e=m.add(new l(i.file(s),r.IMMEDIATE,o,a)),await e.init(),t.strictEqual(e.getItem("some.other.key"),"some.other.value"),e.setItem("some.other.key","some.other.value"),t.strictEqual(e.getItem("some.other.key"),"some.other.value"),e.setItem("some.undefined.key",void 0),t.strictEqual(e.getItem("some.undefined.key","some.default"),"some.default"),e.setItem("some.null.key",null),t.strictEqual(e.getItem("some.null.key","some.default"),"some.default"),e.setItems([{key:"some.setItems.key1",data:"some.value"},{key:"some.setItems.key2",data:0},{key:"some.setItems.key3",data:!0},{key:"some.setItems.key4",data:null},{key:"some.setItems.key5",data:void 0}]),t.strictEqual(e.getItem("some.setItems.key1"),"some.value"),t.strictEqual(e.getItem("some.setItems.key2"),0),t.strictEqual(e.getItem("some.setItems.key3"),!0),t.strictEqual(e.getItem("some.setItems.key4"),void 0),t.strictEqual(e.getItem("some.setItems.key5"),void 0),e.setItems([{key:"some.setItems.key1",data:void 0},{key:"some.setItems.key2",data:void 0},{key:"some.setItems.key3",data:void 0},{key:"some.setItems.key4",data:null},{key:"some.setItems.key5",data:void 0}]),t.strictEqual(e.getItem("some.setItems.key1"),void 0),t.strictEqual(e.getItem("some.setItems.key2"),void 0),t.strictEqual(e.getItem("some.setItems.key3"),void 0),t.strictEqual(e.getItem("some.setItems.key4"),void 0),t.strictEqual(e.getItem("some.setItems.key5"),void 0),e.close()}),test("Multiple ops are buffered and applied",async function(){const s=n(u,"storage.json");d(s,"");let e=m.add(new l(i.file(s),r.DELAYED,o,a));return await e.init(),e.setItem("some.key1","some.value1"),e.setItem("some.key2","some.value2"),e.setItem("some.key3","some.value3"),e.setItem("some.key4","some.value4"),e.removeItem("some.key4"),t.strictEqual(e.getItem("some.key1"),"some.value1"),t.strictEqual(e.getItem("some.key2"),"some.value2"),t.strictEqual(e.getItem("some.key3"),"some.value3"),t.strictEqual(e.getItem("some.key4"),void 0),await e.close(),e=m.add(new l(i.file(s),r.DELAYED,o,a)),await e.init(),t.strictEqual(e.getItem("some.key1"),"some.value1"),t.strictEqual(e.getItem("some.key2"),"some.value2"),t.strictEqual(e.getItem("some.key3"),"some.value3"),t.strictEqual(e.getItem("some.key4"),void 0),e.close()}),test("Multiple ops (Immediate Strategy)",async function(){const s=n(u,"storage.json");d(s,"");let e=m.add(new l(i.file(s),r.IMMEDIATE,o,a));return await e.init(),e.setItem("some.key1","some.value1"),e.setItem("some.key2","some.value2"),e.setItem("some.key3","some.value3"),e.setItem("some.key4","some.value4"),e.removeItem("some.key4"),t.strictEqual(e.getItem("some.key1"),"some.value1"),t.strictEqual(e.getItem("some.key2"),"some.value2"),t.strictEqual(e.getItem("some.key3"),"some.value3"),t.strictEqual(e.getItem("some.key4"),void 0),await e.close(),e=m.add(new l(i.file(s),r.IMMEDIATE,o,a)),await e.init(),t.strictEqual(e.getItem("some.key1"),"some.value1"),t.strictEqual(e.getItem("some.key2"),"some.value2"),t.strictEqual(e.getItem("some.key3"),"some.value3"),t.strictEqual(e.getItem("some.key4"),void 0),e.close()}),test("Used before init",async function(){const s=n(u,"storage.json");d(s,"");const e=m.add(new l(i.file(s),r.DELAYED,o,a));return e.setItem("some.key1","some.value1"),e.setItem("some.key2","some.value2"),e.setItem("some.key3","some.value3"),e.setItem("some.key4","some.value4"),e.removeItem("some.key4"),t.strictEqual(e.getItem("some.key1"),"some.value1"),t.strictEqual(e.getItem("some.key2"),"some.value2"),t.strictEqual(e.getItem("some.key3"),"some.value3"),t.strictEqual(e.getItem("some.key4"),void 0),await e.init(),t.strictEqual(e.getItem("some.key1"),"some.value1"),t.strictEqual(e.getItem("some.key2"),"some.value2"),t.strictEqual(e.getItem("some.key3"),"some.value3"),t.strictEqual(e.getItem("some.key4"),void 0),e.close()}),test("Used after close",async function(){const s=n(u,"storage.json");d(s,"");const e=m.add(new l(i.file(s),r.DELAYED,o,a));await e.init(),e.setItem("some.key1","some.value1"),e.setItem("some.key2","some.value2"),e.setItem("some.key3","some.value3"),e.setItem("some.key4","some.value4"),await e.close(),e.setItem("some.key5","some.marker");const I=k(s).toString();return t.ok(I.includes("some.value1")),t.ok(!I.includes("some.marker")),e.close()}),test("Closed before init",async function(){const s=n(u,"storage.json");d(s,"");const e=m.add(new l(i.file(s),r.DELAYED,o,a));e.setItem("some.key1","some.value1"),e.setItem("some.key2","some.value2"),e.setItem("some.key3","some.value3"),e.setItem("some.key4","some.value4"),await e.close();const I=k(s).toString();t.strictEqual(I.length,0)}),q()});
