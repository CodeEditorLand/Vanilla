{
  "version": 3,
  "sources": ["../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/platform/extensionManagement/node/extensionSignatureVerificationService.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { importAMDNodeModule } from \"../../../amdX.js\";\nimport { getErrorMessage } from \"../../../base/common/errors.js\";\nimport type { TargetPlatform } from \"../../extensions/common/extensions.js\";\nimport { createDecorator } from \"../../instantiation/common/instantiation.js\";\nimport { ILogService, LogLevel } from \"../../log/common/log.js\";\nimport { ITelemetryService } from \"../../telemetry/common/telemetry.js\";\nimport { ExtensionSignatureVerificationCode } from \"../common/extensionManagement.js\";\n\nexport const IExtensionSignatureVerificationService =\n\tcreateDecorator<IExtensionSignatureVerificationService>(\n\t\t\"IExtensionSignatureVerificationService\",\n\t);\n\nexport interface IExtensionSignatureVerificationResult {\n\treadonly code: ExtensionSignatureVerificationCode;\n}\n\n/**\n * A service for verifying signed extensions.\n */\nexport interface IExtensionSignatureVerificationService {\n\treadonly _serviceBrand: undefined;\n\n\t/**\n\t * Verifies an extension file (.vsix) against a signature archive file.\n\t * @param { string } extensionId The extension identifier.\n\t * @param { string } version The extension version.\n\t * @param { string } vsixFilePath The extension file path.\n\t * @param { string } signatureArchiveFilePath The signature archive file path.\n\t * @returns { Promise<IExtensionSignatureVerificationResult | undefined> } returns the verification result or undefined if the verification was not executed.\n\t */\n\tverify(\n\t\textensionId: string,\n\t\tversion: string,\n\t\tvsixFilePath: string,\n\t\tsignatureArchiveFilePath: string,\n\t\tclientTargetPlatform?: TargetPlatform,\n\t): Promise<IExtensionSignatureVerificationResult | undefined>;\n}\n\ndeclare namespace vsceSign {\n\texport function verify(\n\t\tvsixFilePath: string,\n\t\tsignatureArchiveFilePath: string,\n\t\tverbose: boolean,\n\t): Promise<ExtensionSignatureVerificationResult>;\n}\n\n/**\n * Extension signature verification result\n */\nexport interface ExtensionSignatureVerificationResult {\n\treadonly code: ExtensionSignatureVerificationCode;\n\treadonly didExecute: boolean;\n\treadonly internalCode?: number;\n\treadonly output?: string;\n}\n\nexport class ExtensionSignatureVerificationService\n\timplements IExtensionSignatureVerificationService\n{\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate moduleLoadingPromise: Promise<typeof vsceSign> | undefined;\n\n\tconstructor(\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t) {}\n\n\tprivate vsceSign(): Promise<typeof vsceSign> {\n\t\tif (!this.moduleLoadingPromise) {\n\t\t\tthis.moduleLoadingPromise = this.resolveVsceSign();\n\t\t}\n\n\t\treturn this.moduleLoadingPromise;\n\t}\n\n\tprivate async resolveVsceSign(): Promise<typeof vsceSign> {\n\t\t// ESM-uncomment-begin\n\t\tif (typeof importAMDNodeModule === \"function\") {\n\t\t\t/* fixes unused import, remove me */\n\t\t}\n\t\tconst mod = \"@vscode/vsce-sign\";\n\t\treturn import(mod);\n\t\t// ESM-uncomment-end\n\n\t\t// ESM-comment-begin\n\t\t// return importAMDNodeModule('@vscode/vsce-sign', 'src/main.js');\n\t\t// ESM-comment-end\n\t}\n\n\tpublic async verify(\n\t\textensionId: string,\n\t\tversion: string,\n\t\tvsixFilePath: string,\n\t\tsignatureArchiveFilePath: string,\n\t\tclientTargetPlatform?: TargetPlatform,\n\t): Promise<IExtensionSignatureVerificationResult | undefined> {\n\t\tlet module: typeof vsceSign;\n\n\t\ttry {\n\t\t\tmodule = await this.vsceSign();\n\t\t} catch (error) {\n\t\t\tthis.logService.error(\n\t\t\t\t\"Could not load vsce-sign module\",\n\t\t\t\tgetErrorMessage(error),\n\t\t\t);\n\t\t\tthis.logService.info(\n\t\t\t\t`Extension signature verification is not done: ${extensionId}`,\n\t\t\t);\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst startTime = new Date().getTime();\n\t\tlet result: ExtensionSignatureVerificationResult;\n\n\t\ttry {\n\t\t\tthis.logService.trace(\n\t\t\t\t`Verifying extension signature for ${extensionId}...`,\n\t\t\t);\n\t\t\tresult = await module.verify(\n\t\t\t\tvsixFilePath,\n\t\t\t\tsignatureArchiveFilePath,\n\t\t\t\tthis.logService.getLevel() === LogLevel.Trace,\n\t\t\t);\n\t\t} catch (e) {\n\t\t\tresult = {\n\t\t\t\tcode: ExtensionSignatureVerificationCode.UnknownError,\n\t\t\t\tdidExecute: false,\n\t\t\t\toutput: getErrorMessage(e),\n\t\t\t};\n\t\t}\n\n\t\tconst duration = new Date().getTime() - startTime;\n\n\t\tthis.logService.info(\n\t\t\t`Extension signature verification result for ${extensionId}: ${result.code}. Executed: ${result.didExecute}. Duration: ${duration}ms.`,\n\t\t);\n\t\tthis.logService.trace(\n\t\t\t`Extension signature verification output for ${extensionId}:\\n${result.output}`,\n\t\t);\n\n\t\ttype ExtensionSignatureVerificationClassification = {\n\t\t\towner: \"sandy081\";\n\t\t\tcomment: \"Extension signature verification event\";\n\t\t\textensionId: {\n\t\t\t\tclassification: \"SystemMetaData\";\n\t\t\t\tpurpose: \"FeatureInsight\";\n\t\t\t\tcomment: \"extension identifier\";\n\t\t\t};\n\t\t\textensionVersion: {\n\t\t\t\tclassification: \"SystemMetaData\";\n\t\t\t\tpurpose: \"FeatureInsight\";\n\t\t\t\tcomment: \"extension version\";\n\t\t\t};\n\t\t\tcode: {\n\t\t\t\tclassification: \"SystemMetaData\";\n\t\t\t\tpurpose: \"FeatureInsight\";\n\t\t\t\tcomment: \"result code of the verification\";\n\t\t\t};\n\t\t\tinternalCode?: {\n\t\t\t\tclassification: \"SystemMetaData\";\n\t\t\t\tpurpose: \"PerformanceAndHealth\";\n\t\t\t\tisMeasurement: true;\n\t\t\t\tcomment: \"internal code of the verification\";\n\t\t\t};\n\t\t\tduration: {\n\t\t\t\tclassification: \"SystemMetaData\";\n\t\t\t\tpurpose: \"PerformanceAndHealth\";\n\t\t\t\tisMeasurement: true;\n\t\t\t\tcomment: \"amount of time taken to verify the signature\";\n\t\t\t};\n\t\t\tdidExecute: {\n\t\t\t\tclassification: \"SystemMetaData\";\n\t\t\t\tpurpose: \"FeatureInsight\";\n\t\t\t\tcomment: \"whether the verification was executed\";\n\t\t\t};\n\t\t\tclientTargetPlatform?: {\n\t\t\t\tclassification: \"SystemMetaData\";\n\t\t\t\tpurpose: \"FeatureInsight\";\n\t\t\t\tcomment: \"target platform of the client\";\n\t\t\t};\n\t\t};\n\t\ttype ExtensionSignatureVerificationEvent = {\n\t\t\textensionId: string;\n\t\t\textensionVersion: string;\n\t\t\tcode: string;\n\t\t\tinternalCode?: number;\n\t\t\tduration: number;\n\t\t\tdidExecute: boolean;\n\t\t\tclientTargetPlatform?: string;\n\t\t};\n\t\tthis.telemetryService.publicLog2<\n\t\t\tExtensionSignatureVerificationEvent,\n\t\t\tExtensionSignatureVerificationClassification\n\t\t>(\"extensionsignature:verification\", {\n\t\t\textensionId,\n\t\t\textensionVersion: version,\n\t\t\tcode: result.code,\n\t\t\tinternalCode: result.internalCode,\n\t\t\tduration,\n\t\t\tdidExecute: result.didExecute,\n\t\t\tclientTargetPlatform,\n\t\t});\n\n\t\treturn { code: result.code };\n\t}\n}\n"],
  "mappings": ";;;;;;;;;;;;AAKA,SAAS,2BAA2B;AACpC,SAAS,uBAAuB;AAEhC,SAAS,uBAAuB;AAChC,SAAS,aAAa,gBAAgB;AACtC,SAAS,yBAAyB;AAClC,SAAS,0CAA0C;AAE5C,MAAM,yCACZ;AAAA,EACC;AACD;AA+CM,IAAM,wCAAN,MAEP;AAAA,EAKC,YAC+B,YACM,kBACnC;AAF6B;AACM;AAAA,EAClC;AAAA,EAzEJ,OAiEA;AAAA;AAAA;AAAA,EAGS;AAAA,EAOA,WAAqC;AAC5C,QAAI,CAAC,KAAK,sBAAsB;AAC/B,WAAK,uBAAuB,KAAK,gBAAgB;AAAA,IAClD;AAEA,WAAO,KAAK;AAAA,EACb;AAAA,EAEA,MAAc,kBAA4C;AAEzD,QAAI,OAAO,wBAAwB,YAAY;AAAA,IAE/C;AACA,UAAM,MAAM;AACZ,WAAO,OAAO;AAAA,EAMf;AAAA,EAEA,MAAa,OACZ,aACA,SACA,cACA,0BACA,sBAC6D;AAC7D,QAAI;AAEJ,QAAI;AACH,eAAS,MAAM,KAAK,SAAS;AAAA,IAC9B,SAAS,OAAO;AACf,WAAK,WAAW;AAAA,QACf;AAAA,QACA,gBAAgB,KAAK;AAAA,MACtB;AACA,WAAK,WAAW;AAAA,QACf,iDAAiD,WAAW;AAAA,MAC7D;AACA,aAAO;AAAA,IACR;AAEA,UAAM,aAAY,oBAAI,KAAK,GAAE,QAAQ;AACrC,QAAI;AAEJ,QAAI;AACH,WAAK,WAAW;AAAA,QACf,qCAAqC,WAAW;AAAA,MACjD;AACA,eAAS,MAAM,OAAO;AAAA,QACrB;AAAA,QACA;AAAA,QACA,KAAK,WAAW,SAAS,MAAM,SAAS;AAAA,MACzC;AAAA,IACD,SAAS,GAAG;AACX,eAAS;AAAA,QACR,MAAM,mCAAmC;AAAA,QACzC,YAAY;AAAA,QACZ,QAAQ,gBAAgB,CAAC;AAAA,MAC1B;AAAA,IACD;AAEA,UAAM,YAAW,oBAAI,KAAK,GAAE,QAAQ,IAAI;AAExC,SAAK,WAAW;AAAA,MACf,+CAA+C,WAAW,KAAK,OAAO,IAAI,eAAe,OAAO,UAAU,eAAe,QAAQ;AAAA,IAClI;AACA,SAAK,WAAW;AAAA,MACf,+CAA+C,WAAW;AAAA,EAAM,OAAO,MAAM;AAAA,IAC9E;AAoDA,SAAK,iBAAiB,WAGpB,mCAAmC;AAAA,MACpC;AAAA,MACA,kBAAkB;AAAA,MAClB,MAAM,OAAO;AAAA,MACb,cAAc,OAAO;AAAA,MACrB;AAAA,MACA,YAAY,OAAO;AAAA,MACnB;AAAA,IACD,CAAC;AAED,WAAO,EAAE,MAAM,OAAO,KAAK;AAAA,EAC5B;AACD;AAtJa,wCAAN;AAAA,EAQJ;AAAA,EACA;AAAA,GATU;",
  "names": []
}
