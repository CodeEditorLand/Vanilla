{
  "version": 3,
  "sources": ["../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/platform/extensionManagement/node/extensionLifecycle.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { type ChildProcess, fork } from \"child_process\";\nimport { Limiter } from \"../../../base/common/async.js\";\nimport { toErrorMessage } from \"../../../base/common/errorMessage.js\";\nimport { Event } from \"../../../base/common/event.js\";\nimport { Disposable } from \"../../../base/common/lifecycle.js\";\nimport { Schemas } from \"../../../base/common/network.js\";\nimport { join } from \"../../../base/common/path.js\";\nimport { Promises } from \"../../../base/node/pfs.js\";\nimport { ILogService } from \"../../log/common/log.js\";\nimport { IUserDataProfilesService } from \"../../userDataProfile/common/userDataProfile.js\";\nimport type { ILocalExtension } from \"../common/extensionManagement.js\";\n\nexport class ExtensionsLifecycle extends Disposable {\n\tprivate processesLimiter: Limiter<void> = new Limiter(5); // Run max 5 processes in parallel\n\n\tconstructor(\n\t\t@IUserDataProfilesService private userDataProfilesService: IUserDataProfilesService,\n\t\t@ILogService private readonly logService: ILogService\n\t) {\n\t\tsuper();\n\t}\n\n\tasync postUninstall(extension: ILocalExtension): Promise<void> {\n\t\tconst script = this.parseScript(extension, \"uninstall\");\n\t\tif (script) {\n\t\t\tthis.logService.info(\n\t\t\t\textension.identifier.id,\n\t\t\t\textension.manifest.version,\n\t\t\t\t`Running post uninstall script`,\n\t\t\t);\n\t\t\tawait this.processesLimiter.queue(async () => {\n\t\t\t\ttry {\n\t\t\t\t\tawait this.runLifecycleHook(\n\t\t\t\t\t\tscript.script,\n\t\t\t\t\t\t\"uninstall\",\n\t\t\t\t\t\tscript.args,\n\t\t\t\t\t\ttrue,\n\t\t\t\t\t\textension,\n\t\t\t\t\t);\n\t\t\t\t\tthis.logService.info(\n\t\t\t\t\t\t`Finished running post uninstall script`,\n\t\t\t\t\t\textension.identifier.id,\n\t\t\t\t\t\textension.manifest.version,\n\t\t\t\t\t);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tthis.logService.error(\n\t\t\t\t\t\t\"Failed to run post uninstall script\",\n\t\t\t\t\t\textension.identifier.id,\n\t\t\t\t\t\textension.manifest.version,\n\t\t\t\t\t);\n\t\t\t\t\tthis.logService.error(error);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\ttry {\n\t\t\tawait Promises.rm(this.getExtensionStoragePath(extension));\n\t\t} catch (error) {\n\t\t\tthis.logService.error(\n\t\t\t\t\"Error while removing extension storage path\",\n\t\t\t\textension.identifier.id,\n\t\t\t);\n\t\t\tthis.logService.error(error);\n\t\t}\n\t}\n\n\tprivate parseScript(\n\t\textension: ILocalExtension,\n\t\ttype: string,\n\t): { script: string; args: string[] } | null {\n\t\tconst scriptKey = `vscode:${type}`;\n\t\tif (\n\t\t\textension.location.scheme === Schemas.file &&\n\t\t\textension.manifest &&\n\t\t\textension.manifest[\"scripts\"] &&\n\t\t\ttypeof extension.manifest[\"scripts\"][scriptKey] === \"string\"\n\t\t) {\n\t\t\tconst script = (<string>(\n\t\t\t\textension.manifest[\"scripts\"][scriptKey]\n\t\t\t)).split(\" \");\n\t\t\tif (script.length < 2 || script[0] !== \"node\" || !script[1]) {\n\t\t\t\tthis.logService.warn(\n\t\t\t\t\textension.identifier.id,\n\t\t\t\t\textension.manifest.version,\n\t\t\t\t\t`${scriptKey} should be a node script`,\n\t\t\t\t);\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\treturn {\n\t\t\t\tscript: join(extension.location.fsPath, script[1]),\n\t\t\t\targs: script.slice(2) || [],\n\t\t\t};\n\t\t}\n\t\treturn null;\n\t}\n\n\tprivate runLifecycleHook(\n\t\tlifecycleHook: string,\n\t\tlifecycleType: string,\n\t\targs: string[],\n\t\ttimeout: boolean,\n\t\textension: ILocalExtension,\n\t): Promise<void> {\n\t\treturn new Promise<void>((c, e) => {\n\t\t\tconst extensionLifecycleProcess = this.start(\n\t\t\t\tlifecycleHook,\n\t\t\t\tlifecycleType,\n\t\t\t\targs,\n\t\t\t\textension,\n\t\t\t);\n\t\t\tlet timeoutHandler: any;\n\n\t\t\tconst onexit = (error?: string) => {\n\t\t\t\tif (timeoutHandler) {\n\t\t\t\t\tclearTimeout(timeoutHandler);\n\t\t\t\t\ttimeoutHandler = null;\n\t\t\t\t}\n\t\t\t\tif (error) {\n\t\t\t\t\te(error);\n\t\t\t\t} else {\n\t\t\t\t\tc(undefined);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\t// on error\n\t\t\textensionLifecycleProcess.on(\"error\", (err) => {\n\t\t\t\tonexit(toErrorMessage(err) || \"Unknown\");\n\t\t\t});\n\n\t\t\t// on exit\n\t\t\textensionLifecycleProcess.on(\n\t\t\t\t\"exit\",\n\t\t\t\t(code: number, signal: string) => {\n\t\t\t\t\tonexit(\n\t\t\t\t\t\tcode\n\t\t\t\t\t\t\t? `post-${lifecycleType} process exited with code ${code}`\n\t\t\t\t\t\t\t: undefined,\n\t\t\t\t\t);\n\t\t\t\t},\n\t\t\t);\n\n\t\t\tif (timeout) {\n\t\t\t\t// timeout: kill process after waiting for 5s\n\t\t\t\ttimeoutHandler = setTimeout(() => {\n\t\t\t\t\ttimeoutHandler = null;\n\t\t\t\t\textensionLifecycleProcess.kill();\n\t\t\t\t\te(\"timed out\");\n\t\t\t\t}, 5000);\n\t\t\t}\n\t\t});\n\t}\n\n\tprivate start(\n\t\tuninstallHook: string,\n\t\tlifecycleType: string,\n\t\targs: string[],\n\t\textension: ILocalExtension,\n\t): ChildProcess {\n\t\tconst opts = {\n\t\t\tsilent: true,\n\t\t\texecArgv: undefined,\n\t\t};\n\t\tconst extensionUninstallProcess = fork(\n\t\t\tuninstallHook,\n\t\t\t[`--type=extension-post-${lifecycleType}`, ...args],\n\t\t\topts,\n\t\t);\n\n\t\t// Catch all output coming from the process\n\t\ttype Output = { data: string; format: string[] };\n\t\textensionUninstallProcess.stdout!.setEncoding(\"utf8\");\n\t\textensionUninstallProcess.stderr!.setEncoding(\"utf8\");\n\n\t\tconst onStdout = Event.fromNodeEventEmitter<string>(\n\t\t\textensionUninstallProcess.stdout!,\n\t\t\t\"data\",\n\t\t);\n\t\tconst onStderr = Event.fromNodeEventEmitter<string>(\n\t\t\textensionUninstallProcess.stderr!,\n\t\t\t\"data\",\n\t\t);\n\n\t\t// Log output\n\t\tthis._register(\n\t\t\tonStdout((data) =>\n\t\t\t\tthis.logService.info(\n\t\t\t\t\textension.identifier.id,\n\t\t\t\t\textension.manifest.version,\n\t\t\t\t\t`post-${lifecycleType}`,\n\t\t\t\t\tdata,\n\t\t\t\t),\n\t\t\t),\n\t\t);\n\t\tthis._register(\n\t\t\tonStderr((data) =>\n\t\t\t\tthis.logService.error(\n\t\t\t\t\textension.identifier.id,\n\t\t\t\t\textension.manifest.version,\n\t\t\t\t\t`post-${lifecycleType}`,\n\t\t\t\t\tdata,\n\t\t\t\t),\n\t\t\t),\n\t\t);\n\n\t\tconst onOutput = Event.any(\n\t\t\tEvent.map(\n\t\t\t\tonStdout,\n\t\t\t\t(o) => ({ data: `%c${o}`, format: [\"\"] }),\n\t\t\t\tthis._store,\n\t\t\t),\n\t\t\tEvent.map(\n\t\t\t\tonStderr,\n\t\t\t\t(o) => ({ data: `%c${o}`, format: [\"color: red\"] }),\n\t\t\t\tthis._store,\n\t\t\t),\n\t\t);\n\t\t// Debounce all output, so we can render it in the Chrome console as a group\n\t\tconst onDebouncedOutput = Event.debounce<Output>(\n\t\t\tonOutput,\n\t\t\t(r, o) => {\n\t\t\t\treturn r\n\t\t\t\t\t? {\n\t\t\t\t\t\t\tdata: r.data + o.data,\n\t\t\t\t\t\t\tformat: [...r.format, ...o.format],\n\t\t\t\t\t\t}\n\t\t\t\t\t: { data: o.data, format: o.format };\n\t\t\t},\n\t\t\t100,\n\t\t\tundefined,\n\t\t\tundefined,\n\t\t\tundefined,\n\t\t\tthis._store,\n\t\t);\n\n\t\t// Print out output\n\t\tonDebouncedOutput((data) => {\n\t\t\tconsole.group(extension.identifier.id);\n\t\t\tconsole.log(data.data, ...data.format);\n\t\t\tconsole.groupEnd();\n\t\t});\n\n\t\treturn extensionUninstallProcess;\n\t}\n\n\tprivate getExtensionStoragePath(extension: ILocalExtension): string {\n\t\treturn join(\n\t\t\tthis.userDataProfilesService.defaultProfile.globalStorageHome\n\t\t\t\t.fsPath,\n\t\t\textension.identifier.id.toLowerCase(),\n\t\t);\n\t}\n}\n"],
  "mappings": "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",
  "names": []
}
