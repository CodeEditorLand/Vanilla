var ue=Object.defineProperty;var de=Object.getOwnPropertyDescriptor;var R=(n,e,t,r)=>{for(var s=r>1?void 0:r?de(e,t):e,i=n.length-1,u;i>=0;i--)(u=n[i])&&(s=(r?u(e,t,s):u(s))||s);return r&&s&&ue(e,t,s),s},y=(n,e)=>(t,r)=>e(t,r,n);import{distinct as fe}from"../../../base/common/arrays.js";import{CancellationToken as S}from"../../../base/common/cancellation.js";import{CancellationError as ge,getErrorMessage as E,isCancellationError as K}from"../../../base/common/errors.js";import{isWeb as M,platform as ye}from"../../../base/common/platform.js";import{arch as pe}from"../../../base/common/process.js";import{StopWatch as Z}from"../../../base/common/stopwatch.js";import{isBoolean as D}from"../../../base/common/types.js";import{URI as ee}from"../../../base/common/uri.js";import{isOfflineError as me}from"../../../base/parts/request/common/request.js";import{IConfigurationService as N}from"../../configuration/common/configuration.js";import{IEnvironmentService as O}from"../../environment/common/environment.js";import{areApiProposalsCompatible as he,isEngineValid as L}from"../../extensions/common/extensionValidator.js";import{TargetPlatform as T}from"../../extensions/common/extensions.js";import{resolveMarketplaceHeaders as Ie}from"../../externalServices/common/marketplace.js";import{IFileService as U}from"../../files/common/files.js";import{ILogService as q}from"../../log/common/log.js";import{IProductService as $}from"../../product/common/productService.js";import{IRequestService as B,asJson as z,asTextOrError as P,isSuccess as Se}from"../../request/common/request.js";import{IStorageService as xe}from"../../storage/common/storage.js";import{ITelemetryService as Q}from"../../telemetry/common/telemetry.js";import{ExtensionGalleryError as W,ExtensionGalleryErrorCode as v,InstallOperation as te,SortBy as H,SortOrder as we,StatisticType as Ee,WEB_EXTENSION_TAG as ve,getTargetPlatform as be,isNotWebExtensionInWebTargetPlatform as V,isTargetPlatformCompatible as re,toTargetPlatform as Pe}from"./extensionManagement.js";import{adoptToGalleryExtensionId as Ce,areSameExtensions as X,getGalleryExtensionId as j,getGalleryExtensionTelemetryData as Re}from"./extensionManagementUtil.js";const se=M?T.WEB:be(ye,pe),C="X-Market-Search-Activity-Id";var Te=(f=>(f[f.None=0]="None",f[f.IncludeVersions=1]="IncludeVersions",f[f.IncludeFiles=2]="IncludeFiles",f[f.IncludeCategoryAndTags=4]="IncludeCategoryAndTags",f[f.IncludeSharedAccounts=8]="IncludeSharedAccounts",f[f.IncludeVersionProperties=16]="IncludeVersionProperties",f[f.ExcludeNonValidated=32]="ExcludeNonValidated",f[f.IncludeInstallationTargets=64]="IncludeInstallationTargets",f[f.IncludeAssetUri=128]="IncludeAssetUri",f[f.IncludeStatistics=256]="IncludeStatistics",f[f.IncludeLatestVersionOnly=512]="IncludeLatestVersionOnly",f[f.Unpublished=4096]="Unpublished",f[f.IncludeNameConflictInfo=32768]="IncludeNameConflictInfo",f))(Te||{});function Ve(...n){return String(n.reduce((e,t)=>e|t,0))}var Ge=(a=>(a[a.Tag=1]="Tag",a[a.ExtensionId=4]="ExtensionId",a[a.Category=5]="Category",a[a.ExtensionName=7]="ExtensionName",a[a.Target=8]="Target",a[a.Featured=9]="Featured",a[a.SearchText=10]="SearchText",a[a.ExcludeWithFlags=12]="ExcludeWithFlags",a))(Ge||{});const p={Icon:"Microsoft.VisualStudio.Services.Icons.Default",Details:"Microsoft.VisualStudio.Services.Content.Details",Changelog:"Microsoft.VisualStudio.Services.Content.Changelog",Manifest:"Microsoft.VisualStudio.Code.Manifest",VSIX:"Microsoft.VisualStudio.Services.VSIXPackage",License:"Microsoft.VisualStudio.Services.Content.License",Repository:"Microsoft.VisualStudio.Services.Links.Source",Signature:"Microsoft.VisualStudio.Services.VsixSignature"},x={Dependency:"Microsoft.VisualStudio.Code.ExtensionDependencies",ExtensionPack:"Microsoft.VisualStudio.Code.ExtensionPack",Engine:"Microsoft.VisualStudio.Code.Engine",PreRelease:"Microsoft.VisualStudio.Code.PreRelease",EnabledApiProposals:"Microsoft.VisualStudio.Code.EnabledApiProposals",LocalizedLanguages:"Microsoft.VisualStudio.Code.LocalizedLanguages",WebExtension:"Microsoft.VisualStudio.Code.WebExtension",SponsorLink:"Microsoft.VisualStudio.Code.SponsorLink",SupportLink:"Microsoft.VisualStudio.Services.Links.Support",ExecutesCode:"Microsoft.VisualStudio.Code.ExecutesCode"},Fe=10,ke={pageNumber:1,pageSize:Fe,sortBy:H.NoneOrRelevance,sortOrder:we.Default,flags:0,criteria:[],assetTypes:[]};class m{constructor(e=ke){this.state=e}get pageNumber(){return this.state.pageNumber}get pageSize(){return this.state.pageSize}get sortBy(){return this.state.sortBy}get sortOrder(){return this.state.sortOrder}get flags(){return this.state.flags}get criteria(){return this.state.criteria}withPage(e,t=this.state.pageSize){return new m({...this.state,pageNumber:e,pageSize:t})}withFilter(e,...t){const r=[...this.state.criteria,...t.length?t.map(s=>({filterType:e,value:s})):[{filterType:e}]];return new m({...this.state,criteria:r})}withSortBy(e){return new m({...this.state,sortBy:e})}withSortOrder(e){return new m({...this.state,sortOrder:e})}withFlags(...e){return new m({...this.state,flags:e.reduce((t,r)=>t|r,0)})}withAssetTypes(...e){return new m({...this.state,assetTypes:e})}withSource(e){return new m({...this.state,source:e})}get raw(){const{criteria:e,pageNumber:t,pageSize:r,sortBy:s,sortOrder:i,flags:u,assetTypes:o}=this.state;return{filters:[{criteria:e,pageNumber:t,pageSize:r,sortBy:s,sortOrder:i}],assetTypes:o,flags:u}}get searchText(){const e=this.state.criteria.filter(t=>t.filterType===10)[0];return e&&e.value?e.value:""}get telemetryData(){return{filterTypes:this.state.criteria.map(e=>String(e.filterType)),flags:this.state.flags,sortBy:String(this.sortBy),sortOrder:String(this.sortOrder),pageNumber:String(this.pageNumber),source:this.state.source,searchTextLength:this.searchText.length}}}function J(n,e){const t=(n||[]).filter(r=>r.statisticName===e)[0];return t?t.value:0}function Ae(n){const e="Microsoft.VisualStudio.Code.Translation.";return n.files.filter(r=>r.assetType.indexOf(e)===0).reduce((r,s)=>{const i=w(n,s.assetType);return i&&r.push([s.assetType.substring(e.length),i]),r},[])}function Me(n){if(n.properties){const e=n.properties.filter(s=>s.key===p.Repository),t=/((git|ssh|http(s)?)|(git@[\w.]+))(:(\/\/)?)([\w.@:/\-~]+)(.git)(\/)?/,r=e.filter(s=>t.test(s.value))[0];return r?{uri:r.value,fallbackUri:r.value}:null}return w(n,p.Repository)}function De(n){return{uri:`${n.fallbackAssetUri}/${p.VSIX}?redirect=true${n.targetPlatform?`&targetPlatform=${n.targetPlatform}`:""}`,fallbackUri:`${n.fallbackAssetUri}/${p.VSIX}${n.targetPlatform?`?targetPlatform=${n.targetPlatform}`:""}`}}function w(n,e){return n.files.filter(r=>r.assetType===e)[0]?{uri:`${n.assetUri}/${e}${n.targetPlatform?`?targetPlatform=${n.targetPlatform}`:""}`,fallbackUri:`${n.fallbackAssetUri}/${e}${n.targetPlatform?`?targetPlatform=${n.targetPlatform}`:""}`}:null}function ne(n,e){const t=n.properties?n.properties.filter(s=>s.key===e):[],r=t.length>0&&t[0].value;return r?r.split(",").map(s=>Ce(s)):[]}function ie(n){const e=n.properties?n.properties.filter(t=>t.key===x.Engine):[];return e.length>0&&e[0].value||""}function G(n){const e=n.properties?n.properties.filter(t=>t.key===x.PreRelease):[];return e.length>0&&e[0].value==="true"}function Ne(n){const e=n.properties?n.properties.filter(t=>t.key===x.ExecutesCode):[];return e.length>0?e[0].value==="true":void 0}function _(n){const e=n.properties?n.properties.filter(r=>r.key===x.EnabledApiProposals):[],t=e.length>0&&e[0].value||"";return t?t.split(","):[]}function Oe(n){const e=n.properties?n.properties.filter(r=>r.key===x.LocalizedLanguages):[],t=e.length>0&&e[0].value||"";return t?t.split(","):[]}function Le(n){return n.properties?.find(e=>e.key===x.SponsorLink)?.value}function Ue(n){return n.properties?.find(e=>e.key===x.SupportLink)?.value}function qe(n){return n.indexOf("preview")!==-1}function F(n){return n.targetPlatform?Pe(n.targetPlatform):T.UNDEFINED}function Y(n){const e=fe(n.versions.map(F)),t=!!n.tags?.includes(ve),r=e.indexOf(T.WEB);return t?r===-1&&e.push(T.WEB):r!==-1&&e.splice(r,1),e}function ae(n,e){for(let t=0;t<n.length;t++){const r=n[t];if(r.version===n[t-1]?.version){let s=t;if(F(r)===e)for(;s>0&&n[s-1].version===r.version;)s--;s!==t&&(n.splice(t,1),n.splice(s,0,r))}}return n}function oe(n,e,t){n.telemetryData={index:e,querySource:t,queryActivityId:n.queryContext?.[C]}}function le(n,e,t,r){const s=n.versions[0],i={manifest:w(e,p.Manifest),readme:w(e,p.Details),changelog:w(e,p.Changelog),license:w(e,p.License),repository:Me(e),download:De(e),icon:w(e,p.Icon),signature:w(e,p.Signature),coreTranslations:Ae(e)};return{type:"gallery",identifier:{id:j(n.publisher.publisherName,n.extensionName),uuid:n.extensionId},name:n.extensionName,version:e.version,displayName:n.displayName,publisherId:n.publisher.publisherId,publisher:n.publisher.publisherName,publisherDisplayName:n.publisher.displayName,publisherDomain:n.publisher.domain?{link:n.publisher.domain,verified:!!n.publisher.isDomainVerified}:void 0,publisherSponsorLink:Le(s),description:n.shortDescription??"",installCount:J(n.statistics,"install"),rating:J(n.statistics,"averagerating"),ratingCount:J(n.statistics,"ratingcount"),categories:n.categories||[],tags:n.tags||[],releaseDate:Date.parse(n.releaseDate),lastUpdated:Date.parse(n.lastUpdated),allTargetPlatforms:t,assets:i,properties:{dependencies:ne(e,x.Dependency),extensionPack:ne(e,x.ExtensionPack),engine:ie(e),enabledApiProposals:_(e),localizedLanguages:Oe(e),targetPlatform:F(e),isPreReleaseVersion:G(e),executesCode:Ne(e)},hasPreReleaseVersion:G(s),hasReleaseVersion:!0,preview:qe(n.flags),isSigned:!!i.signature,queryContext:r,supportLink:Ue(s)}}let b=class{constructor(e,t,r,s,i,u,o,a){this.requestService=t;this.logService=r;this.environmentService=s;this.telemetryService=i;this.fileService=u;this.productService=o;this.configurationService=a;const c=o.extensionsGallery,d=c?.servicePPEUrl&&a.getValue("_extensionsGallery.enablePPE");this.extensionsGalleryUrl=d?c.servicePPEUrl:c?.serviceUrl,this.extensionsGallerySearchUrl=d?void 0:c?.searchUrl,this.extensionsControlUrl=c?.controlUrl,this.extensionsEnabledWithApiProposalVersion=o.extensionsEnabledWithApiProposalVersion?.map(l=>l.toLowerCase())??[],this.commonHeadersPromise=Ie(o.version,o,this.environmentService,this.configurationService,this.fileService,e,this.telemetryService)}extensionsGalleryUrl;extensionsGallerySearchUrl;extensionsControlUrl;commonHeadersPromise;extensionsEnabledWithApiProposalVersion;api(e=""){return`${this.extensionsGalleryUrl}${e}`}isEnabled(){return!!this.extensionsGalleryUrl}async getExtensions(e,t,r){const s=S.isCancellationToken(t)?{}:t,i=S.isCancellationToken(t)?t:r,u=await this.doGetExtensions(e,s,i),o=u.map(c=>c.identifier.uuid),a=[];for(const c of e)c.uuid&&!o.includes(c.uuid)&&a.push({...c,uuid:void 0});if(a.length){this.telemetryService.publicLog2("galleryService:additionalQueryByName",{count:a.length});const c=await this.doGetExtensions(a,s,i);u.push(...c)}return u}async doGetExtensions(e,t,r){const s=[],i=[],u=[],o=[];let a=!0;for(const l of e){l.uuid?i.push(l.uuid):s.push(l.id);const g=!!(l.version||l.preRelease);u.push({id:l.id,uuid:l.uuid,includePreRelease:g}),l.version&&o.push({id:l.id,uuid:l.uuid,version:l.version}),a=a&&!!l.hasPreRelease&&!g}if(!i.length&&!s.length)return[];let c=new m().withPage(1,e.length);i.length&&(c=c.withFilter(4,...i)),s.length&&(c=c.withFilter(7,...s)),(t.queryAllVersions||a)&&(c=c.withFlags(c.flags,1)),t.source&&(c=c.withSource(t.source));const{extensions:d}=await this.queryGalleryExtensions(c,{targetPlatform:t.targetPlatform??se,includePreRelease:u,versions:o,compatible:!!t.compatible,productVersion:t.productVersion??{version:this.productService.version,date:this.productService.date}},r);return t.source&&d.forEach((l,g)=>oe(l,g,t.source)),d}async getCompatibleExtension(e,t,r,s={version:this.productService.version,date:this.productService.date}){if(V(e.allTargetPlatforms,r))return null;if(await this.isExtensionCompatible(e,t,r))return e;const i=new m().withFlags(1).withPage(1,1).withFilter(4,e.identifier.uuid),{extensions:u}=await this.queryGalleryExtensions(i,{targetPlatform:r,compatible:!0,includePreRelease:t,productVersion:s},S.None);return u[0]||null}async isExtensionCompatible(e,t,r,s={version:this.productService.version,date:this.productService.date}){if(!re(e.properties.targetPlatform,e.allTargetPlatforms,r)||!t&&e.properties.isPreReleaseVersion)return!1;let i=e.properties.engine;if(!i){const u=await this.getManifest(e,S.None);if(!u)throw new Error("Manifest was not found");i=u.engines.vscode}return!(!L(i,s.version,s.date)||!this.areApiProposalsCompatible(e.identifier,e.properties.enabledApiProposals))}areApiProposalsCompatible(e,t){return!t||!this.extensionsEnabledWithApiProposalVersion.includes(e.id.toLowerCase())?!0:he(t)}async isValidVersion(e,t,r,s,i,u,o={version:this.productService.version,date:this.productService.date}){if(!re(F(t),i,u)||r!=="any"&&G(t)!==(r==="prerelease"))return!1;if(s)try{const a=await this.getEngine(e,t);if(!L(a,o.version,o.date))return!1}catch(a){return this.logService.error(`Error while getting the engine for the version ${t.version}.`,E(a)),!1}return!0}async query(e,t){let r=e.text||"";const s=e.pageSize??50;let i=new m().withPage(1,s);r?(r=r.replace(/\bcategory:("([^"]*)"|([^"]\S*))(\s+|\b|$)/g,(d,l,g)=>(i=i.withFilter(5,g||l),"")),r=r.replace(/\btag:("([^"]*)"|([^"]\S*))(\s+|\b|$)/g,(d,l,g)=>(i=i.withFilter(1,g||l),"")),r=r.replace(/\bfeatured(\s+|\b|$)/g,()=>(i=i.withFilter(9),"")),r=r.trim(),r&&(r=r.length<200?r:r.substring(0,200),i=i.withFilter(10,r)),i=i.withSortBy(H.NoneOrRelevance)):e.ids?i=i.withFilter(4,...e.ids):e.names?i=i.withFilter(7,...e.names):i=i.withSortBy(H.InstallCount),typeof e.sortBy=="number"&&(i=i.withSortBy(e.sortBy)),typeof e.sortOrder=="number"&&(i=i.withSortOrder(e.sortOrder)),e.source&&(i=i.withSource(e.source));const u=async(d,l)=>{const{extensions:g,total:f}=await this.queryGalleryExtensions(d,{targetPlatform:se,compatible:!1,includePreRelease:!!e.includePreRelease,productVersion:e.productVersion??{version:this.productService.version,date:this.productService.date}},l);return g.forEach((h,I)=>oe(h,(d.pageNumber-1)*d.pageSize+I,e.source)),{extensions:g,total:f}},{extensions:o,total:a}=await u(i,t),c=async(d,l)=>{if(l.isCancellationRequested)throw new ge;const{extensions:g}=await u(i.withPage(d+1),l);return g};return{firstPage:o,total:a,pageSize:i.pageSize,getPage:c}}async queryGalleryExtensions(e,t,r){const s=e.flags;e.flags&512&&e.flags&1&&(e=e.withFlags(e.flags&-2,512)),!(e.flags&512)&&!(e.flags&1)&&(e=e.withFlags(e.flags,512)),t.versions?.length&&(e=e.withFlags(e.flags&-513,1)),e=e.withFlags(e.flags,128,4,2,256,16);const{galleryExtensions:i,total:u,context:o}=await this.queryRawGalleryExtensions(e,r);if(!(e.flags&512)){const l=[];for(const g of i){const f=await this.toGalleryExtensionWithCriteria(g,t,o);f&&l.push(f)}return{extensions:l,total:u}}const c=[],d=new Map;for(let l=0;l<i.length;l++){const g=i[l],f={id:j(g.publisher.publisherName,g.extensionName),uuid:g.extensionId},h=D(t.includePreRelease)?t.includePreRelease:!!t.includePreRelease.find(ce=>X(ce,f))?.includePreRelease;if(t.compatible&&V(Y(g),t.targetPlatform))continue;const I=await this.toGalleryExtensionWithCriteria(g,t,o);!I||I.properties.isPreReleaseVersion&&(!h||!I.hasReleaseVersion)||!I.properties.isPreReleaseVersion&&I.properties.targetPlatform!==t.targetPlatform&&I.hasPreReleaseVersion?d.set(g.extensionId,l):c.push([l,I])}if(d.size){const l=new Z,g=new m().withFlags(s&-513,1).withPage(1,d.size).withFilter(4,...d.keys()),{extensions:f}=await this.queryGalleryExtensions(g,t,r);this.telemetryService.publicLog2("galleryService:additionalQuery",{duration:l.elapsed(),count:d.size});for(const h of f){const I=d.get(h.identifier.uuid);c.push([I,h])}}return{extensions:c.sort((l,g)=>l[0]-g[0]).map(([,l])=>l),total:u}}async toGalleryExtensionWithCriteria(e,t,r){const s={id:j(e.publisher.publisherName,e.extensionName),uuid:e.extensionId},i=t.versions?.find(c=>X(c,s))?.version,u=D(t.includePreRelease)?t.includePreRelease:!!t.includePreRelease.find(c=>X(c,s))?.includePreRelease,o=Y(e),a=ae(e.versions,t.targetPlatform);if(t.compatible&&V(o,t.targetPlatform))return null;for(let c=0;c<a.length;c++){const d=a[c];if(!(i&&d.version!==i)){if(await this.isValidVersion(s.id,d,u?"any":"release",t.compatible,o,t.targetPlatform,t.productVersion)){if(t.compatible&&!this.areApiProposalsCompatible(s,_(d)))continue;return le(e,d,o,r)}if(i&&d.version===i)return null}}return i||t.compatible?null:le(e,e.versions[0],o)}async queryRawGalleryExtensions(e,t){if(!this.isEnabled())throw new Error("No extension gallery service configured.");e=e.withFlags(e.flags,32).withFilter(8,"Microsoft.VisualStudio.Code").withFilter(12,Ve(4096));const r=await this.commonHeadersPromise,s=JSON.stringify(e.raw),i={...r,"Content-Type":"application/json",Accept:"application/json;api-version=3.0-preview.1","Accept-Encoding":"gzip","Content-Length":String(s.length)},u=new Z;let o,a,c=0;try{if(o=await this.requestService.request({type:"POST",url:this.extensionsGallerySearchUrl&&e.criteria.some(l=>l.filterType===10)?this.extensionsGallerySearchUrl:this.api("/extensionquery"),data:s,headers:i},t),o.res.statusCode&&o.res.statusCode>=400&&o.res.statusCode<500)return{galleryExtensions:[],total:c};const d=await z(o);if(d){const l=d.results[0],g=l.extensions,f=l.resultMetadata&&l.resultMetadata.filter(h=>h.metadataType==="ResultCount")[0];return c=f&&f.metadataItems.filter(h=>h.name==="TotalCount")[0].count||0,{galleryExtensions:g,total:c,context:o.res.headers.activityid?{[C]:o.res.headers.activityid}:{}}}return{galleryExtensions:[],total:c}}catch(d){if(K(d))throw a=v.Cancelled,d;{const l=E(d);throw a=me(d)?v.Offline:l.startsWith("XHR timeout")?v.Timeout:v.Failed,new W(l,a)}}finally{this.telemetryService.publicLog2("galleryService:query",{...e.telemetryData,requestBodySize:String(s.length),duration:u.elapsed(),success:!!o&&Se(o),responseBodySize:o?.res.headers["Content-Length"],statusCode:o?String(o.res.statusCode):void 0,errorCode:a,count:String(c)})}}async reportStatistic(e,t,r,s){if(!this.isEnabled())return;const i=M?this.api(`/itemName/${e}.${t}/version/${r}/statType/${s===Ee.Install?"1":"3"}/vscodewebextension`):this.api(`/publishers/${e}/extensions/${t}/${r}/stats?statType=${s}`),u=M?"api-version=6.1-preview.1":"*/*;api-version=4.0-preview.1",a={...await this.commonHeadersPromise,Accept:u};try{await this.requestService.request({type:"POST",url:i,headers:a},S.None)}catch{}}async download(e,t,r){this.logService.trace("ExtensionGalleryService#download",e.identifier.id);const s=Re(e),i=new Date().getTime(),u=r===te.Install?"install":r===te.Update?"update":"",o=u?{uri:`${e.assets.download.uri}${ee.parse(e.assets.download.uri).query?"&":"?"}${u}=true`,fallbackUri:`${e.assets.download.fallbackUri}${ee.parse(e.assets.download.fallbackUri).query?"&":"?"}${u}=true`}:e.assets.download,a=e.queryContext?.[C]?{[C]:e.queryContext[C]}:void 0,c=await this.getAsset(e.identifier.id,o,p.VSIX,a?{headers:a}:void 0);try{await this.fileService.writeFile(t,c.stream)}catch(d){try{await this.fileService.del(t)}catch(l){this.logService.warn(`Error while deleting the file ${t.toString()}`,E(l))}throw new W(E(d),v.DownloadFailedWriting)}this.telemetryService.publicLog("galleryService:downloadVSIX",{...s,duration:new Date().getTime()-i})}async downloadSignatureArchive(e,t){if(!e.assets.signature)throw new Error("No signature asset found");this.logService.trace("ExtensionGalleryService#downloadSignatureArchive",e.identifier.id);const r=await this.getAsset(e.identifier.id,e.assets.signature,p.Signature);try{await this.fileService.writeFile(t,r.stream)}catch(s){try{await this.fileService.del(t)}catch(i){this.logService.warn(`Error while deleting the file ${t.toString()}`,E(i))}throw new W(E(s),v.DownloadFailedWriting)}}async getReadme(e,t){if(e.assets.readme){const r=await this.getAsset(e.identifier.id,e.assets.readme,p.Details,{},t);return await P(r)||""}return""}async getManifest(e,t){if(e.assets.manifest){const r=await this.getAsset(e.identifier.id,e.assets.manifest,p.Manifest,{},t),s=await P(r);return s?JSON.parse(s):null}return null}async getManifestFromRawExtensionVersion(e,t,r){const s=w(t,p.Manifest);if(!s)throw new Error("Manifest was not found");const i={"Accept-Encoding":"gzip"},u=await this.getAsset(e,s,p.Manifest,{headers:i});return await z(u)}async getCoreTranslation(e,t){const r=e.assets.coreTranslations.filter(s=>s[0]===t.toUpperCase())[0];if(r){const s=await this.getAsset(e.identifier.id,r[1],r[0]),i=await P(s);return i?JSON.parse(i):null}return null}async getChangelog(e,t){if(e.assets.changelog){const r=await this.getAsset(e.identifier.id,e.assets.changelog,p.Changelog,{},t);return await P(r)||""}return""}async getAllCompatibleVersions(e,t,r){let s=new m().withFlags(1,4,2,16).withPage(1,1);e.uuid?s=s.withFilter(4,e.uuid):s=s.withFilter(7,e.id);const{galleryExtensions:i}=await this.queryRawGalleryExtensions(s,S.None);if(!i.length)return[];const u=Y(i[0]);if(V(u,r))return[];const o=[];await Promise.all(i[0].versions.map(async d=>{try{await this.isValidVersion(e.id,d,t?"any":"release",!0,u,r)&&this.areApiProposalsCompatible(e,_(d))&&o.push(d)}catch{}}));const a=[],c=new Set;for(const d of ae(o,r))c.has(d.version)||(c.add(d.version),a.push({version:d.version,date:d.lastUpdated,isPreReleaseVersion:G(d)}));return a}async getAsset(e,t,r,s={},i=S.None){const u=await this.commonHeadersPromise,o={type:"GET"},a={...u,...s.headers||{}};s={...s,...o,headers:a};const c=t.uri,d=t.fallbackUri,l={...s,url:c};try{const g=await this.requestService.request(l,i);if(g.res.statusCode===200)return g;const f=await P(g);throw new Error(`Expected 200, got back ${g.res.statusCode} instead.

${f}`)}catch(g){if(K(g))throw g;const f=E(g);this.telemetryService.publicLog2("galleryService:cdnFallback",{extension:e,assetType:r,message:f});const h={...s,url:d};return this.requestService.request(h,i)}}async getEngine(e,t){let r=ie(t);if(!r){this.telemetryService.publicLog2("galleryService:engineFallback",{extension:e,version:t.version});const s=await this.getManifestFromRawExtensionVersion(e,t,S.None);if(!s)throw new Error("Manifest was not found");r=s.engines.vscode}return r}async getExtensionsControlManifest(){if(!this.isEnabled())throw new Error("No extension gallery service configured.");if(!this.extensionsControlUrl)return{malicious:[],deprecated:{},search:[]};const e=await this.requestService.request({type:"GET",url:this.extensionsControlUrl},S.None);if(e.res.statusCode!==200)throw new Error("Could not get extensions report.");const t=await z(e),r=[],s={},i=[],u=[];if(t){for(const o of t.malicious)r.push({id:o});if(t.migrateToPreRelease)for(const[o,a]of Object.entries(t.migrateToPreRelease))(!a.engine||L(a.engine,this.productService.version,this.productService.date))&&(s[o.toLowerCase()]={disallowInstall:!0,extension:{id:a.id,displayName:a.displayName,autoMigrate:{storage:!!a.migrateStorage},preRelease:!0}});if(t.deprecated)for(const[o,a]of Object.entries(t.deprecated))a&&(s[o.toLowerCase()]=D(a)?{}:a);if(t.search)for(const o of t.search)i.push(o);if(Array.isArray(t.extensionsEnabledWithPreRelease))for(const o of t.extensionsEnabledWithPreRelease)u.push(o.toLowerCase())}return{malicious:r,deprecated:s,search:i,extensionsEnabledWithPreRelease:u}}};b=R([y(1,B),y(2,q),y(3,O),y(4,Q),y(5,U),y(6,$),y(7,N)],b);let k=class extends b{constructor(e,t,r,s,i,u,o,a){super(e,t,r,s,i,u,o,a)}};k=R([y(0,xe),y(1,B),y(2,q),y(3,O),y(4,Q),y(5,U),y(6,$),y(7,N)],k);let A=class extends b{constructor(e,t,r,s,i,u,o){super(void 0,e,t,r,s,i,u,o)}};A=R([y(0,B),y(1,q),y(2,O),y(3,Q),y(4,U),y(5,$),y(6,N)],A);export{k as ExtensionGalleryService,A as ExtensionGalleryServiceWithNoStorageService,ae as sortExtensionVersions};
