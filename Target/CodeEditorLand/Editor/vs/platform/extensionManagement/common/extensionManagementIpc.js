import{Emitter as x,Event as E}from"../../../base/common/event.js";import{Disposable as h}from"../../../base/common/lifecycle.js";import{cloneAndChange as v}from"../../../base/common/objects.js";import{URI as a}from"../../../base/common/uri.js";import{DefaultURITransformer as m,transformAndReviveIncomingURIs as f}from"../../../base/common/uriIpc.js";import"../../../base/parts/ipc/common/ipc.js";import{isTargetPlatformCompatible as U}from"./extensionManagement.js";import"../../extensions/common/extensions.js";function c(s,o){return s?a.revive(o?o.transformIncoming(s):s):void 0}function d(s,o){return o?o.transformOutgoingURI(s):s}function l(s,o){o=o||m;const e=s.manifest;return{...f({...s,manifest:void 0},o),manifest:e}}function p(s,o){return s?.profileLocation?f(s,o??m):s}function u(s,o){return o?v(s,e=>e instanceof a?o.transformOutgoingURI(e):void 0):s}class nn{constructor(o,e){this.service=o;this.getUriTransformer=e;this.onInstallExtension=E.buffer(o.onInstallExtension,!0),this.onDidInstallExtensions=E.buffer(o.onDidInstallExtensions,!0),this.onUninstallExtension=E.buffer(o.onUninstallExtension,!0),this.onDidUninstallExtension=E.buffer(o.onDidUninstallExtension,!0),this.onDidUpdateExtensionMetadata=E.buffer(o.onDidUpdateExtensionMetadata,!0)}onInstallExtension;onDidInstallExtensions;onUninstallExtension;onDidUninstallExtension;onDidUpdateExtensionMetadata;listen(o,e){const n=this.getUriTransformer(o);switch(e){case"onInstallExtension":return E.map(this.onInstallExtension,t=>({...t,profileLocation:t.profileLocation?d(t.profileLocation,n):t.profileLocation}));case"onDidInstallExtensions":return E.map(this.onDidInstallExtensions,t=>t.map(i=>({...i,local:i.local?u(i.local,n):i.local,profileLocation:i.profileLocation?d(i.profileLocation,n):i.profileLocation})));case"onUninstallExtension":return E.map(this.onUninstallExtension,t=>({...t,profileLocation:t.profileLocation?d(t.profileLocation,n):t.profileLocation}));case"onDidUninstallExtension":return E.map(this.onDidUninstallExtension,t=>({...t,profileLocation:t.profileLocation?d(t.profileLocation,n):t.profileLocation}));case"onDidUpdateExtensionMetadata":return E.map(this.onDidUpdateExtensionMetadata,t=>({local:u(t.local,n),profileLocation:d(t.profileLocation,n)}))}throw new Error("Invalid listen")}async call(o,e,n){const t=this.getUriTransformer(o);switch(e){case"zip":{const i=l(n[0],t),r=await this.service.zip(i);return d(r,t)}case"install":return this.service.install(c(n[0],t),p(n[1],t));case"installFromLocation":return this.service.installFromLocation(c(n[0],t),c(n[1],t));case"installExtensionsFromProfile":return this.service.installExtensionsFromProfile(n[0],c(n[1],t),c(n[2],t));case"getManifest":return this.service.getManifest(c(n[0],t));case"getTargetPlatform":return this.service.getTargetPlatform();case"canInstall":return this.service.canInstall(n[0]);case"installFromGallery":return this.service.installFromGallery(n[0],p(n[1],t));case"installGalleryExtensions":{const i=n[0];return this.service.installGalleryExtensions(i.map(({extension:r,options:I})=>({extension:r,options:p(I,t)??{}})))}case"uninstall":return this.service.uninstall(l(n[0],t),p(n[1],t));case"uninstallExtensions":{const i=n[0];return this.service.uninstallExtensions(i.map(({extension:r,options:I})=>({extension:l(r,t),options:p(I,t)})))}case"reinstallFromGallery":return this.service.reinstallFromGallery(l(n[0],t));case"getInstalled":return(await this.service.getInstalled(n[0],c(n[1],t),n[2])).map(r=>u(r,t));case"toggleAppliationScope":{const i=await this.service.toggleAppliationScope(l(n[0],t),c(n[1],t));return u(i,t)}case"copyExtensions":return this.service.copyExtensions(c(n[0],t),c(n[1],t));case"updateMetadata":{const i=await this.service.updateMetadata(l(n[0],t),n[1],c(n[2],t));return u(i,t)}case"resetPinnedStateForAllUserExtensions":return this.service.resetPinnedStateForAllUserExtensions(n[0]);case"getExtensionsControlManifest":return this.service.getExtensionsControlManifest();case"download":return this.service.download(n[0],n[1],n[2]);case"cleanUp":return this.service.cleanUp()}throw new Error("Invalid call")}}class tn extends h{constructor(e){super();this.channel=e;this._register(this.channel.listen("onInstallExtension")(n=>this.onInstallExtensionEvent({...n,source:this.isUriComponents(n.source)?a.revive(n.source):n.source,profileLocation:a.revive(n.profileLocation)}))),this._register(this.channel.listen("onDidInstallExtensions")(n=>this.onDidInstallExtensionsEvent(n.map(t=>({...t,local:t.local?l(t.local,null):t.local,source:this.isUriComponents(t.source)?a.revive(t.source):t.source,profileLocation:a.revive(t.profileLocation)}))))),this._register(this.channel.listen("onUninstallExtension")(n=>this.onUninstallExtensionEvent({...n,profileLocation:a.revive(n.profileLocation)}))),this._register(this.channel.listen("onDidUninstallExtension")(n=>this.onDidUninstallExtensionEvent({...n,profileLocation:a.revive(n.profileLocation)}))),this._register(this.channel.listen("onDidUpdateExtensionMetadata")(n=>this.onDidUpdateExtensionMetadataEvent({profileLocation:a.revive(n.profileLocation),local:l(n.local,null)})))}_onInstallExtension=this._register(new x);get onInstallExtension(){return this._onInstallExtension.event}_onDidInstallExtensions=this._register(new x);get onDidInstallExtensions(){return this._onDidInstallExtensions.event}_onUninstallExtension=this._register(new x);get onUninstallExtension(){return this._onUninstallExtension.event}_onDidUninstallExtension=this._register(new x);get onDidUninstallExtension(){return this._onDidUninstallExtension.event}_onDidUpdateExtensionMetadata=this._register(new x);get onDidUpdateExtensionMetadata(){return this._onDidUpdateExtensionMetadata.event}onInstallExtensionEvent(e){this._onInstallExtension.fire(e)}onDidInstallExtensionsEvent(e){this._onDidInstallExtensions.fire(e)}onUninstallExtensionEvent(e){this._onUninstallExtension.fire(e)}onDidUninstallExtensionEvent(e){this._onDidUninstallExtension.fire(e)}onDidUpdateExtensionMetadataEvent(e){this._onDidUpdateExtensionMetadata.fire(e)}isUriComponents(e){return e?typeof e.path=="string"&&typeof e.scheme=="string":!1}_targetPlatformPromise;getTargetPlatform(){return this._targetPlatformPromise||(this._targetPlatformPromise=this.channel.call("getTargetPlatform")),this._targetPlatformPromise}async canInstall(e){const n=await this.getTargetPlatform();return e.allTargetPlatforms.some(t=>U(t,e.allTargetPlatforms,n))}zip(e){return Promise.resolve(this.channel.call("zip",[e]).then(n=>a.revive(n)))}install(e,n){return Promise.resolve(this.channel.call("install",[e,n])).then(t=>l(t,null))}installFromLocation(e,n){return Promise.resolve(this.channel.call("installFromLocation",[e,n])).then(t=>l(t,null))}async installExtensionsFromProfile(e,n,t){return(await this.channel.call("installExtensionsFromProfile",[e,n,t])).map(r=>l(r,null))}getManifest(e){return Promise.resolve(this.channel.call("getManifest",[e]))}installFromGallery(e,n){return Promise.resolve(this.channel.call("installFromGallery",[e,n])).then(t=>l(t,null))}async installGalleryExtensions(e){return(await this.channel.call("installGalleryExtensions",[e])).map(t=>({...t,local:t.local?l(t.local,null):t.local,source:this.isUriComponents(t.source)?a.revive(t.source):t.source,profileLocation:a.revive(t.profileLocation)}))}uninstall(e,n){if(e.isWorkspaceScoped)throw new Error("Cannot uninstall a workspace extension");return Promise.resolve(this.channel.call("uninstall",[e,n]))}uninstallExtensions(e){if(e.some(n=>n.extension.isWorkspaceScoped))throw new Error("Cannot uninstall a workspace extension");return Promise.resolve(this.channel.call("uninstallExtensions",[e]))}reinstallFromGallery(e){return Promise.resolve(this.channel.call("reinstallFromGallery",[e])).then(n=>l(n,null))}getInstalled(e=null,n,t){return Promise.resolve(this.channel.call("getInstalled",[e,n,t])).then(i=>i.map(r=>l(r,null)))}updateMetadata(e,n,t){return Promise.resolve(this.channel.call("updateMetadata",[e,n,t])).then(i=>l(i,null))}resetPinnedStateForAllUserExtensions(e){return this.channel.call("resetPinnedStateForAllUserExtensions",[e])}toggleAppliationScope(e,n){return this.channel.call("toggleAppliationScope",[e,n]).then(t=>l(t,null))}copyExtensions(e,n){return this.channel.call("copyExtensions",[e,n])}getExtensionsControlManifest(){return Promise.resolve(this.channel.call("getExtensionsControlManifest"))}async download(e,n,t){const i=await this.channel.call("download",[e,n,t]);return a.revive(i)}async cleanUp(){return this.channel.call("cleanUp")}registerParticipant(){throw new Error("Not Supported")}}class en{constructor(o){this.service=o}listen(o,e){throw new Error("Invalid listen")}call(o,e,n){switch(e){case"getConfigBasedTips":return this.service.getConfigBasedTips(a.revive(n[0]));case"getImportantExecutableBasedTips":return this.service.getImportantExecutableBasedTips();case"getOtherExecutableBasedTips":return this.service.getOtherExecutableBasedTips()}throw new Error("Invalid call")}}export{nn as ExtensionManagementChannel,tn as ExtensionManagementChannelClient,en as ExtensionTipsChannel};
