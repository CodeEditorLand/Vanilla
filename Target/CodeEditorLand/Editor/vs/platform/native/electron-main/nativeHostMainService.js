var H=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var E=(y,w,e,i)=>{for(var n=i>1?void 0:i?U(w,e):w,o=y.length-1,r;o>=0;o--)(r=y[o])&&(n=(i?r(w,e,n):r(n))||n);return i&&n&&H(w,e,n),n},d=(y,w)=>(e,i)=>w(e,i,y);import*as C from"fs";import{exec as D}from"child_process";import{app as I,clipboard as c,Menu as S,powerMonitor as z,screen as W,shell as u,webContents as L}from"electron";import{arch as $,cpus as _,freemem as V,loadavg as K,platform as q,release as G,totalmem as Y,type as j}from"os";import{promisify as k}from"util";import{memoize as J}from"../../../base/common/decorators.js";import{Emitter as Q,Event as t}from"../../../base/common/event.js";import{Disposable as X}from"../../../base/common/lifecycle.js";import{matchesSomeScheme as Z,Schemas as B}from"../../../base/common/network.js";import{dirname as A,join as p,posix as ee,resolve as ie,win32 as ne}from"../../../base/common/path.js";import{isLinux as O,isMacintosh as oe,isWindows as b}from"../../../base/common/platform.js";import"../../../base/common/types.js";import{URI as P}from"../../../base/common/uri.js";import{realpath as re}from"../../../base/node/extpath.js";import{virtualMachineHint as te}from"../../../base/node/id.js";import{Promises as N,SymlinkSupport as T}from"../../../base/node/pfs.js";import{findFreePort as de}from"../../../base/node/ports.js";import{localize as a}from"../../../nls.js";import"../../action/common/action.js";import"../../dialogs/common/dialogs.js";import{IDialogMainService as se}from"../../dialogs/electron-main/dialogMainService.js";import{IEnvironmentMainService as ae}from"../../environment/electron-main/environmentMainService.js";import{createDecorator as ce}from"../../instantiation/common/instantiation.js";import{ILifecycleMainService as we}from"../../lifecycle/electron-main/lifecycleMainService.js";import{ILogService as me}from"../../log/common/log.js";import"../common/native.js";import{IProductService as le}from"../../product/common/productService.js";import"../../theme/common/themeService.js";import{IThemeMainService as ue}from"../../theme/electron-main/themeMainService.js";import"../../window/electron-main/window.js";import{useWindowControlsOverlay as R}from"../../window/common/window.js";import{IWindowsMainService as pe,OpenContext as x}from"../../windows/electron-main/windows.js";import{isWorkspaceIdentifier as fe,toWorkspaceIdentifier as ve}from"../../workspace/common/workspace.js";import{IWorkspacesManagementMainService as he}from"../../workspaces/electron-main/workspacesManagementMainService.js";import{VSBuffer as ye}from"../../../base/common/buffer.js";import{hasWSLFeatureInstalled as ge}from"../../remote/node/wsl.js";import{WindowProfiler as Ie}from"../../profiling/electron-main/windowProfiling.js";import"../../profiling/common/profiling.js";import{IAuxiliaryWindowsMainService as Se}from"../../auxiliaryWindow/electron-main/auxiliaryWindows.js";import"../../auxiliaryWindow/electron-main/auxiliaryWindow.js";import{CancellationError as F}from"../../../base/common/errors.js";import{IConfigurationService as We}from"../../configuration/common/configuration.js";import{IProxyAuthService as be}from"./auth.js";import{IRequestService as Pe}from"../../request/common/request.js";const Ki=ce("nativeHostMainService");let M=class extends X{constructor(e,i,n,o,r,s,g,m,f,l,v,h){super();this.windowsMainService=e;this.auxiliaryWindowsMainService=i;this.dialogMainService=n;this.lifecycleMainService=o;this.environmentMainService=r;this.logService=s;this.productService=g;this.themeMainService=m;this.workspacesManagementMainService=f;this.configurationService=l;this.requestService=v;this.proxyAuthService=h}get windowId(){throw new Error("Not implemented in electron-main")}onDidOpenMainWindow=t.map(this.windowsMainService.onDidOpenWindow,e=>e.id);onDidTriggerWindowSystemContextMenu=t.any(t.map(this.windowsMainService.onDidTriggerSystemContextMenu,({window:e,x:i,y:n})=>({windowId:e.id,x:i,y:n})),t.map(this.auxiliaryWindowsMainService.onDidTriggerSystemContextMenu,({window:e,x:i,y:n})=>({windowId:e.id,x:i,y:n})));onDidMaximizeWindow=t.any(t.map(this.windowsMainService.onDidMaximizeWindow,e=>e.id),t.map(this.auxiliaryWindowsMainService.onDidMaximizeWindow,e=>e.id));onDidUnmaximizeWindow=t.any(t.map(this.windowsMainService.onDidUnmaximizeWindow,e=>e.id),t.map(this.auxiliaryWindowsMainService.onDidUnmaximizeWindow,e=>e.id));onDidChangeWindowFullScreen=t.any(t.map(this.windowsMainService.onDidChangeFullScreen,e=>({windowId:e.window.id,fullscreen:e.fullscreen})),t.map(this.auxiliaryWindowsMainService.onDidChangeFullScreen,e=>({windowId:e.window.id,fullscreen:e.fullscreen})));onDidBlurMainWindow=t.filter(t.fromNodeEventEmitter(I,"browser-window-blur",(e,i)=>i.id),e=>!!this.windowsMainService.getWindowById(e));onDidFocusMainWindow=t.any(t.map(t.filter(t.map(this.windowsMainService.onDidChangeWindowsCount,()=>this.windowsMainService.getLastActiveWindow()),e=>!!e),e=>e.id),t.filter(t.fromNodeEventEmitter(I,"browser-window-focus",(e,i)=>i.id),e=>!!this.windowsMainService.getWindowById(e)));onDidBlurMainOrAuxiliaryWindow=t.any(this.onDidBlurMainWindow,t.map(t.filter(t.fromNodeEventEmitter(I,"browser-window-blur",(e,i)=>this.auxiliaryWindowsMainService.getWindowByWebContents(i.webContents)),e=>!!e),e=>e.id));onDidFocusMainOrAuxiliaryWindow=t.any(this.onDidFocusMainWindow,t.map(t.filter(t.fromNodeEventEmitter(I,"browser-window-focus",(e,i)=>this.auxiliaryWindowsMainService.getWindowByWebContents(i.webContents)),e=>!!e),e=>e.id));onDidResumeOS=t.fromNodeEventEmitter(z,"resume");onDidChangeColorScheme=this.themeMainService.onDidChangeColorScheme;_onDidChangePassword=this._register(new Q);onDidChangePassword=this._onDidChangePassword.event;onDidChangeDisplay=t.debounce(t.any(t.filter(t.fromNodeEventEmitter(W,"display-metrics-changed",(e,i,n)=>n),e=>!(Array.isArray(e)&&e.length===1&&e[0]==="workArea")),t.fromNodeEventEmitter(W,"display-added"),t.fromNodeEventEmitter(W,"display-removed")),()=>{},100);async getWindows(e,i){const n=this.windowsMainService.getWindows().map(r=>({id:r.id,workspace:r.openedWorkspace??ve(r.backupPath,r.isExtensionDevelopmentHost),title:r.win?.getTitle()??"",filename:r.getRepresentedFilename(),dirty:r.isDocumentEdited()})),o=[];return i.includeAuxiliaryWindows&&o.push(...this.auxiliaryWindowsMainService.getWindows().map(r=>({id:r.id,parentId:r.parentId,title:r.win?.getTitle()??"",filename:r.getRepresentedFilename()}))),[...n,...o]}async getWindowCount(e){return this.windowsMainService.getWindowCount()}async getActiveWindowId(e){const i=this.windowsMainService.getFocusedWindow()||this.windowsMainService.getLastActiveWindow();if(i)return i.id}async getActiveWindowPosition(){const e=this.windowsMainService.getFocusedWindow()||this.windowsMainService.getLastActiveWindow();if(e)return e.getBounds()}openWindow(e,i,n){return Array.isArray(i)?this.doOpenWindow(e,i,n):this.doOpenEmptyWindow(e,i)}async doOpenWindow(e,i,n=Object.create(null)){i.length>0&&await this.windowsMainService.open({context:x.API,contextWindowId:e,urisToOpen:i,cli:this.environmentMainService.args,forceNewWindow:n.forceNewWindow,forceReuseWindow:n.forceReuseWindow,preferNewWindow:n.preferNewWindow,diffMode:n.diffMode,mergeMode:n.mergeMode,addMode:n.addMode,gotoLineMode:n.gotoLineMode,noRecentEntry:n.noRecentEntry,waitMarkerFileURI:n.waitMarkerFileURI,remoteAuthority:n.remoteAuthority||void 0,forceProfile:n.forceProfile,forceTempProfile:n.forceTempProfile})}async doOpenEmptyWindow(e,i){await this.windowsMainService.openEmptyWindow({context:x.API,contextWindowId:e},i)}async isFullScreen(e,i){return this.windowById(i?.targetWindowId,e)?.isFullScreen??!1}async toggleFullScreen(e,i){this.windowById(i?.targetWindowId,e)?.toggleFullScreen()}async handleTitleDoubleClick(e,i){this.windowById(i?.targetWindowId,e)?.handleTitleDoubleClick()}async getCursorScreenPoint(e){const i=W.getCursorScreenPoint(),n=W.getDisplayNearestPoint(i);return{point:i,display:n.bounds}}async isMaximized(e,i){return this.windowById(i?.targetWindowId,e)?.win?.isMaximized()??!1}async maximizeWindow(e,i){this.windowById(i?.targetWindowId,e)?.win?.maximize()}async unmaximizeWindow(e,i){this.windowById(i?.targetWindowId,e)?.win?.unmaximize()}async minimizeWindow(e,i){this.windowById(i?.targetWindowId,e)?.win?.minimize()}async moveWindowTop(e,i){this.windowById(i?.targetWindowId,e)?.win?.moveTop()}async positionWindow(e,i,n){const o=this.windowById(n?.targetWindowId,e);if(o?.win){if(o.win.isFullScreen()){const r=t.toPromise(t.once(t.fromNodeEventEmitter(o.win,"leave-full-screen")));o.win.setFullScreen(!1),await r}o.win.setBounds(i)}}async updateWindowControls(e,i){this.windowById(i?.targetWindowId,e)?.updateWindowControls(i)}async focusWindow(e,i){this.windowById(i?.targetWindowId,e)?.focus({force:i?.force??!1})}async setMinimumSize(e,i,n){const o=this.codeWindowById(e);if(o?.win){const[r,s]=o.win.getSize(),[g,m]=o.win.getMinimumSize(),[f,l]=[i??g,n??m],[v,h]=[Math.max(r,f),Math.max(s,l)];(g!==f||m!==l)&&o.win.setMinimumSize(f,l),(r!==v||s!==h)&&o.win.setSize(v,h)}}async saveWindowSplash(e,i){this.themeMainService.saveWindowSplash(e,i)}async installShellCommand(e){const{source:i,target:n}=await this.getShellCommandLink();try{const{symbolicLink:o}=await T.stat(i);if(o&&!o.dangling){const r=await re(i);if(n===r)return}await C.promises.unlink(i)}catch(o){if(o.code!=="ENOENT")throw o}try{await C.promises.symlink(n,i)}catch(o){if(o.code!=="EACCES"&&o.code!=="ENOENT")throw o;const{response:r}=await this.showMessageBox(e,{type:"info",message:a("warnEscalation","{0} will now prompt with 'osascript' for Administrator privileges to install the shell command.",this.productService.nameShort),buttons:[a({key:"ok",comment:["&& denotes a mnemonic"]},"&&OK"),a("cancel","Cancel")]});if(r===1)throw new F;try{const s=`osascript -e "do shell script \\"mkdir -p /usr/local/bin && ln -sf '${n}' '${i}'\\" with administrator privileges"`;await k(D)(s)}catch{throw new Error(a("cantCreateBinFolder","Unable to install the shell command '{0}'.",i))}}}async uninstallShellCommand(e){const{source:i}=await this.getShellCommandLink();try{await C.promises.unlink(i)}catch(n){switch(n.code){case"EACCES":{const{response:o}=await this.showMessageBox(e,{type:"info",message:a("warnEscalationUninstall","{0} will now prompt with 'osascript' for Administrator privileges to uninstall the shell command.",this.productService.nameShort),buttons:[a({key:"ok",comment:["&& denotes a mnemonic"]},"&&OK"),a("cancel","Cancel")]});if(o===1)throw new F;try{const r=`osascript -e "do shell script \\"rm '${i}'\\" with administrator privileges"`;await k(D)(r)}catch{throw new Error(a("cantUninstall","Unable to uninstall the shell command '{0}'.",i))}break}case"ENOENT":break;default:throw n}}}async getShellCommandLink(){const e=ie(this.environmentMainService.appRoot,"bin","code"),i=`/usr/local/bin/${this.productService.applicationName}`;if(!await N.exists(e))throw new Error(a("sourceMissing","Unable to find shell script in '{0}'",e));return{source:i,target:e}}async showMessageBox(e,i){const n=this.windowById(i?.targetWindowId,e);return this.dialogMainService.showMessageBox(i,n?.win??void 0)}async showSaveDialog(e,i){const n=this.windowById(i?.targetWindowId,e);return this.dialogMainService.showSaveDialog(i,n?.win??void 0)}async showOpenDialog(e,i){const n=this.windowById(i?.targetWindowId,e);return this.dialogMainService.showOpenDialog(i,n?.win??void 0)}async pickFileFolderAndOpen(e,i){const n=await this.dialogMainService.pickFileFolder(i);n&&await this.doOpenPicked(await Promise.all(n.map(async o=>await T.existsDirectory(o)?{folderUri:P.file(o)}:{fileUri:P.file(o)})),i,e)}async pickFolderAndOpen(e,i){const n=await this.dialogMainService.pickFolder(i);n&&await this.doOpenPicked(n.map(o=>({folderUri:P.file(o)})),i,e)}async pickFileAndOpen(e,i){const n=await this.dialogMainService.pickFile(i);n&&await this.doOpenPicked(n.map(o=>({fileUri:P.file(o)})),i,e)}async pickWorkspaceAndOpen(e,i){const n=await this.dialogMainService.pickWorkspace(i);n&&await this.doOpenPicked(n.map(o=>({workspaceUri:P.file(o)})),i,e)}async doOpenPicked(e,i,n){await this.windowsMainService.open({context:x.DIALOG,contextWindowId:n,cli:this.environmentMainService.args,urisToOpen:e,forceNewWindow:i.forceNewWindow})}async showItemInFolder(e,i){u.showItemInFolder(i)}async setRepresentedFilename(e,i,n){this.windowById(n?.targetWindowId,e)?.setRepresentedFilename(i)}async setDocumentEdited(e,i,n){this.windowById(n?.targetWindowId,e)?.setDocumentEdited(i)}async openExternal(e,i,n){this.environmentMainService.unsetSnapExportedVariables();try{Z(i,B.http,B.https)?this.openExternalBrowser(i,n):u.openExternal(i)}finally{this.environmentMainService.restoreSnapExportedVariables()}return!0}async openExternalBrowser(e,i){const n=i??this.configurationService.getValue("workbench.externalBrowser");if(!n)return u.openExternal(e);if((n.includes(ee.sep)||n.includes(ne.sep))&&!await N.exists(n))return this.logService.error(`Configured external browser path does not exist: ${n}`),u.openExternal(e);try{const{default:o}=await import("open");(await o(e,{app:{name:Object.hasOwn(o.apps,n)?o.apps[n]:n}})).stderr?.once("data",s=>(this.logService.error(`Error openening external URL '${e}' using browser '${n}': ${s.toString()}`),u.openExternal(e)))}catch(o){return this.logService.error(`Unable to open external URL '${e}' using browser '${n}' due to ${o}.`),u.openExternal(e)}}moveItemToTrash(e,i){return u.trashItem(i)}async isAdmin(){let e;return b?e=(await import("native-is-elevated")).default():e=process.getuid?.()===0,e}async writeElevated(e,i,n,o){const r=await import("@vscode/sudo-prompt");return new Promise((s,g)=>{const m=[`"${this.cliPath}"`];o?.unlock&&m.push("--file-chmod"),m.push("--file-write",`"${i.fsPath}"`,`"${n.fsPath}"`);const f={name:this.productService.nameLong.replace("-",""),icns:oe&&this.environmentMainService.isBuilt?p(A(this.environmentMainService.appRoot),`${this.productService.nameShort}.icns`):void 0};r.exec(m.join(" "),f,(l,v,h)=>{v&&this.logService.trace(`[sudo-prompt] received stdout: ${v}`),h&&this.logService.trace(`[sudo-prompt] received stderr: ${h}`),l?g(l):s(void 0)})})}async isRunningUnderARM64Translation(){return O||b?!1:I.runningUnderARM64Translation}get cliPath(){return b?this.environmentMainService.isBuilt?p(A(process.execPath),"bin",`${this.productService.applicationName}.cmd`):p(this.environmentMainService.appRoot,"scripts","code-cli.bat"):O?this.environmentMainService.isBuilt?p(A(process.execPath),"bin",`${this.productService.applicationName}`):p(this.environmentMainService.appRoot,"scripts","code-cli.sh"):this.environmentMainService.isBuilt?p(this.environmentMainService.appRoot,"bin","code"):p(this.environmentMainService.appRoot,"scripts","code-cli.sh")}async getOSStatistics(){return{totalmem:Y(),freemem:V(),loadavg:K()}}async getOSProperties(){return{arch:$(),platform:q(),release:G(),type:j(),cpus:_()}}async getOSVirtualMachineHint(){return te.value()}async getOSColorScheme(){return this.themeMainService.getColorScheme()}async hasWSLFeatureInstalled(){return b&&ge()}async getProcessId(e){return this.windowById(void 0,e)?.win?.webContents.getOSProcessId()}async killProcess(e,i,n){process.kill(i,n)}async readClipboardText(e,i){return c.readText(i)}async readImage(){return c.readImage().toPNG()}async writeClipboardText(e,i,n){return c.writeText(i,n)}async readClipboardFindText(e){return c.readFindText()}async writeClipboardFindText(e,i){return c.writeFindText(i)}async writeClipboardBuffer(e,i,n,o){return c.writeBuffer(i,Buffer.from(n.buffer),o)}async readClipboardBuffer(e,i){return ye.wrap(c.readBuffer(i))}async hasClipboard(e,i,n){return c.has(i,n)}async newWindowTab(){await this.windowsMainService.open({context:x.API,cli:this.environmentMainService.args,forceNewTabbedWindow:!0,forceEmpty:!0,remoteAuthority:this.environmentMainService.args.remote||void 0})}async showPreviousWindowTab(){S.sendActionToFirstResponder("selectPreviousTab:")}async showNextWindowTab(){S.sendActionToFirstResponder("selectNextTab:")}async moveWindowTabToNewWindow(){S.sendActionToFirstResponder("moveTabToNewWindow:")}async mergeAllWindowTabs(){S.sendActionToFirstResponder("mergeAllWindows:")}async toggleWindowTabsBar(){S.sendActionToFirstResponder("toggleTabBar:")}async updateTouchBar(e,i){this.codeWindowById(e)?.updateTouchBar(i)}async notifyReady(e){this.codeWindowById(e)?.setReady()}async relaunch(e,i){return this.lifecycleMainService.relaunch(i)}async reload(e,i){const n=this.codeWindowById(e);if(n){if(fe(n.openedWorkspace)){const o=n.openedWorkspace.configPath;if(o.scheme===B.file&&(await this.workspacesManagementMainService.resolveLocalWorkspace(o))?.transient)return this.openWindow(n.id,{forceReuseWindow:!0})}return this.lifecycleMainService.reload(n,i?.disableExtensions!==void 0?{_:[],"disable-extensions":i.disableExtensions}:void 0)}}async closeWindow(e,i){return this.windowById(i?.targetWindowId,e)?.win?.close()}async quit(e){const i=this.windowsMainService.getLastActiveWindow();i?.isExtensionDevelopmentHost&&this.windowsMainService.getWindowCount()>1&&i.win?i.win.close():this.lifecycleMainService.quit()}async exit(e,i){await this.lifecycleMainService.kill(i)}async resolveProxy(e,i){if(this.environmentMainService.extensionTestsLocationURI){const r=this.configurationService.getValue("integration-test.http.proxy");if(r)return r}return this.codeWindowById(e)?.win?.webContents?.session?.resolveProxy(i)}async lookupAuthorization(e,i){return this.proxyAuthService.lookupAuthorization(i)}async lookupKerberosAuthorization(e,i){return this.requestService.lookupKerberosAuthorization(i)}async loadCertificates(e){return this.requestService.loadCertificates()}findFreePort(e,i,n,o,r=1){return de(i,n,o,r)}async openDevTools(e,i){const n=this.windowById(i?.targetWindowId,e);let o;O&&R(this.configurationService)&&(o="bottom"),n?.win?.webContents.openDevTools(o?{mode:o}:void 0)}async toggleDevTools(e,i){const o=this.windowById(i?.targetWindowId,e)?.win?.webContents;o&&(O&&R(this.configurationService)&&!o.isDevToolsOpened()?o.openDevTools({mode:"bottom"}):o.toggleDevTools())}async profileRenderer(e,i,n){const o=this.codeWindowById(e);if(!o||!o.win)throw new Error;return await new Ie(o.win,i,this.logService).inspect(n)}async windowsGetStringRegKey(e,i,n,o){if(!b)return;const r=await import("@vscode/windows-registry");try{return r.GetStringRegKey(i,n,o)}catch{return}}windowById(e,i){return this.codeWindowById(e)??this.auxiliaryWindowById(e)??this.codeWindowById(i)}codeWindowById(e){if(typeof e=="number")return this.windowsMainService.getWindowById(e)}auxiliaryWindowById(e){if(typeof e!="number")return;const i=L.fromId(e);if(i)return this.auxiliaryWindowsMainService.getWindowByWebContents(i)}};E([J],M.prototype,"cliPath",1),M=E([d(0,pe),d(1,Se),d(2,se),d(3,we),d(4,ae),d(5,me),d(6,le),d(7,ue),d(8,he),d(9,We),d(10,Pe),d(11,be)],M);export{Ki as INativeHostMainService,M as NativeHostMainService};
