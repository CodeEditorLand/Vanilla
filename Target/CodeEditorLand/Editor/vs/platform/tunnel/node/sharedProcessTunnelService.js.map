{
  "version": 3,
  "sources": ["../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/platform/tunnel/node/sharedProcessTunnelService.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { DeferredPromise } from \"../../../base/common/async.js\";\nimport { canceled } from \"../../../base/common/errors.js\";\nimport { Disposable } from \"../../../base/common/lifecycle.js\";\nimport { ILogService } from \"../../log/common/log.js\";\nimport type {\n\tIAddress,\n\tIAddressProvider,\n} from \"../../remote/common/remoteAgentConnection.js\";\nimport type {\n\tISharedProcessTunnel,\n\tISharedProcessTunnelService,\n} from \"../../remote/common/sharedProcessTunnelService.js\";\nimport { ISharedTunnelsService, type RemoteTunnel } from \"../common/tunnel.js\";\n\nclass TunnelData extends Disposable implements IAddressProvider {\n\tprivate _address: IAddress | null;\n\tprivate _addressPromise: DeferredPromise<IAddress> | null;\n\n\tconstructor() {\n\t\tsuper();\n\t\tthis._address = null;\n\t\tthis._addressPromise = null;\n\t}\n\n\tasync getAddress(): Promise<IAddress> {\n\t\tif (this._address) {\n\t\t\t// address is resolved\n\t\t\treturn this._address;\n\t\t}\n\t\tif (!this._addressPromise) {\n\t\t\tthis._addressPromise = new DeferredPromise<IAddress>();\n\t\t}\n\t\treturn this._addressPromise.p;\n\t}\n\n\tsetAddress(address: IAddress): void {\n\t\tthis._address = address;\n\t\tif (this._addressPromise) {\n\t\t\tthis._addressPromise.complete(address);\n\t\t\tthis._addressPromise = null;\n\t\t}\n\t}\n\n\tsetTunnel(tunnel: RemoteTunnel): void {\n\t\tthis._register(tunnel);\n\t}\n}\n\nexport class SharedProcessTunnelService\n\textends Disposable\n\timplements ISharedProcessTunnelService\n{\n\t_serviceBrand: undefined;\n\n\tprivate static _lastId = 0;\n\n\tprivate readonly _tunnels: Map<string, TunnelData> = new Map<\n\t\tstring,\n\t\tTunnelData\n\t>();\n\tprivate readonly _disposedTunnels: Set<string> = new Set<string>();\n\n\tconstructor(\n\t\t@ISharedTunnelsService private readonly _tunnelService: ISharedTunnelsService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t) {\n\t\tsuper();\n\t}\n\n\tpublic override dispose(): void {\n\t\tsuper.dispose();\n\t\tthis._tunnels.forEach((tunnel) => tunnel.dispose());\n\t}\n\n\tasync createTunnel(): Promise<{ id: string }> {\n\t\tconst id = String(++SharedProcessTunnelService._lastId);\n\t\treturn { id };\n\t}\n\n\tasync startTunnel(\n\t\tauthority: string,\n\t\tid: string,\n\t\ttunnelRemoteHost: string,\n\t\ttunnelRemotePort: number,\n\t\ttunnelLocalHost: string,\n\t\ttunnelLocalPort: number | undefined,\n\t\televateIfNeeded: boolean | undefined,\n\t): Promise<ISharedProcessTunnel> {\n\t\tconst tunnelData = new TunnelData();\n\n\t\tconst tunnel = await Promise.resolve(\n\t\t\tthis._tunnelService.openTunnel(\n\t\t\t\tauthority,\n\t\t\t\ttunnelData,\n\t\t\t\ttunnelRemoteHost,\n\t\t\t\ttunnelRemotePort,\n\t\t\t\ttunnelLocalHost,\n\t\t\t\ttunnelLocalPort,\n\t\t\t\televateIfNeeded,\n\t\t\t),\n\t\t);\n\t\tif (!tunnel || typeof tunnel === \"string\") {\n\t\t\tthis._logService.info(\n\t\t\t\t`[SharedProcessTunnelService] Could not create a tunnel to ${tunnelRemoteHost}:${tunnelRemotePort} (remote).`,\n\t\t\t);\n\t\t\ttunnelData.dispose();\n\t\t\tthrow new Error(`Could not create tunnel`);\n\t\t}\n\n\t\tif (this._disposedTunnels.has(id)) {\n\t\t\t// This tunnel was disposed in the meantime\n\t\t\tthis._disposedTunnels.delete(id);\n\t\t\ttunnelData.dispose();\n\t\t\tawait tunnel.dispose();\n\t\t\tthrow canceled();\n\t\t}\n\n\t\ttunnelData.setTunnel(tunnel);\n\t\tthis._tunnels.set(id, tunnelData);\n\n\t\tthis._logService.info(\n\t\t\t`[SharedProcessTunnelService] Created tunnel ${id}: ${tunnel.localAddress} (local) to ${tunnelRemoteHost}:${tunnelRemotePort} (remote).`,\n\t\t);\n\t\tconst result: ISharedProcessTunnel = {\n\t\t\ttunnelLocalPort: tunnel.tunnelLocalPort,\n\t\t\tlocalAddress: tunnel.localAddress,\n\t\t};\n\t\treturn result;\n\t}\n\n\tasync setAddress(id: string, address: IAddress): Promise<void> {\n\t\tconst tunnel = this._tunnels.get(id);\n\t\tif (!tunnel) {\n\t\t\treturn;\n\t\t}\n\t\ttunnel.setAddress(address);\n\t}\n\n\tasync destroyTunnel(id: string): Promise<void> {\n\t\tconst tunnel = this._tunnels.get(id);\n\t\tif (tunnel) {\n\t\t\tthis._logService.info(\n\t\t\t\t`[SharedProcessTunnelService] Disposing tunnel ${id}.`,\n\t\t\t);\n\t\t\tthis._tunnels.delete(id);\n\t\t\tawait tunnel.dispose();\n\t\t\treturn;\n\t\t}\n\n\t\t// Looks like this tunnel is still starting, mark the id as disposed\n\t\tthis._disposedTunnels.add(id);\n\t}\n}\n"],
  "mappings": ";;;;;;;;;;;;AAKA,SAAS,uBAAuB;AAChC,SAAS,gBAAgB;AACzB,SAAS,kBAAkB;AAC3B,SAAS,mBAAmB;AAS5B,SAAS,6BAAgD;AAEzD,MAAM,mBAAmB,WAAuC;AAAA,EAnBhE,OAmBgE;AAAA;AAAA;AAAA,EACvD;AAAA,EACA;AAAA,EAER,cAAc;AACb,UAAM;AACN,SAAK,WAAW;AAChB,SAAK,kBAAkB;AAAA,EACxB;AAAA,EAEA,MAAM,aAAgC;AACrC,QAAI,KAAK,UAAU;AAElB,aAAO,KAAK;AAAA,IACb;AACA,QAAI,CAAC,KAAK,iBAAiB;AAC1B,WAAK,kBAAkB,IAAI,gBAA0B;AAAA,IACtD;AACA,WAAO,KAAK,gBAAgB;AAAA,EAC7B;AAAA,EAEA,WAAW,SAAyB;AACnC,SAAK,WAAW;AAChB,QAAI,KAAK,iBAAiB;AACzB,WAAK,gBAAgB,SAAS,OAAO;AACrC,WAAK,kBAAkB;AAAA,IACxB;AAAA,EACD;AAAA,EAEA,UAAU,QAA4B;AACrC,SAAK,UAAU,MAAM;AAAA,EACtB;AACD;AAEO,IAAM,6BAAN,cACE,WAET;AAAA,EAWC,YACyC,gBACV,aAC7B;AACD,UAAM;AAHkC;AACV;AAAA,EAG/B;AAAA,EAxED,OAwDA;AAAA;AAAA;AAAA,EACC;AAAA,EAEA,OAAe,UAAU;AAAA,EAER,WAAoC,oBAAI,IAGvD;AAAA,EACe,mBAAgC,oBAAI,IAAY;AAAA,EASjD,UAAgB;AAC/B,UAAM,QAAQ;AACd,SAAK,SAAS,QAAQ,CAAC,WAAW,OAAO,QAAQ,CAAC;AAAA,EACnD;AAAA,EAEA,MAAM,eAAwC;AAC7C,UAAM,KAAK,OAAO,EAAE,2BAA2B,OAAO;AACtD,WAAO,EAAE,GAAG;AAAA,EACb;AAAA,EAEA,MAAM,YACL,WACA,IACA,kBACA,kBACA,iBACA,iBACA,iBACgC;AAChC,UAAM,aAAa,IAAI,WAAW;AAElC,UAAM,SAAS,MAAM,QAAQ;AAAA,MAC5B,KAAK,eAAe;AAAA,QACnB;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,MACD;AAAA,IACD;AACA,QAAI,CAAC,UAAU,OAAO,WAAW,UAAU;AAC1C,WAAK,YAAY;AAAA,QAChB,6DAA6D,gBAAgB,IAAI,gBAAgB;AAAA,MAClG;AACA,iBAAW,QAAQ;AACnB,YAAM,IAAI,MAAM,yBAAyB;AAAA,IAC1C;AAEA,QAAI,KAAK,iBAAiB,IAAI,EAAE,GAAG;AAElC,WAAK,iBAAiB,OAAO,EAAE;AAC/B,iBAAW,QAAQ;AACnB,YAAM,OAAO,QAAQ;AACrB,YAAM,SAAS;AAAA,IAChB;AAEA,eAAW,UAAU,MAAM;AAC3B,SAAK,SAAS,IAAI,IAAI,UAAU;AAEhC,SAAK,YAAY;AAAA,MAChB,+CAA+C,EAAE,KAAK,OAAO,YAAY,eAAe,gBAAgB,IAAI,gBAAgB;AAAA,IAC7H;AACA,UAAM,SAA+B;AAAA,MACpC,iBAAiB,OAAO;AAAA,MACxB,cAAc,OAAO;AAAA,IACtB;AACA,WAAO;AAAA,EACR;AAAA,EAEA,MAAM,WAAW,IAAY,SAAkC;AAC9D,UAAM,SAAS,KAAK,SAAS,IAAI,EAAE;AACnC,QAAI,CAAC,QAAQ;AACZ;AAAA,IACD;AACA,WAAO,WAAW,OAAO;AAAA,EAC1B;AAAA,EAEA,MAAM,cAAc,IAA2B;AAC9C,UAAM,SAAS,KAAK,SAAS,IAAI,EAAE;AACnC,QAAI,QAAQ;AACX,WAAK,YAAY;AAAA,QAChB,iDAAiD,EAAE;AAAA,MACpD;AACA,WAAK,SAAS,OAAO,EAAE;AACvB,YAAM,OAAO,QAAQ;AACrB;AAAA,IACD;AAGA,SAAK,iBAAiB,IAAI,EAAE;AAAA,EAC7B;AACD;AAxGa,6BAAN;AAAA,EAeJ;AAAA,EACA;AAAA,GAhBU;",
  "names": []
}
