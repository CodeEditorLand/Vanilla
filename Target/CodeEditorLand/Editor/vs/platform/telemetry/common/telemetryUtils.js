import{cloneAndChange as g,safeStringify as c}from"../../../base/common/objects.js";import{isObject as y}from"../../../base/common/types.js";import"../../../base/common/uri.js";import"../../configuration/common/configuration.js";import"../../environment/common/environment.js";import"../../product/common/productService.js";import{getRemoteName as T}from"../../remote/common/remoteHosts.js";import{verifyMicrosoftInternalDomain as I}from"./commonProperties.js";import{TelemetryConfiguration as u,TelemetryLevel as a,TELEMETRY_CRASH_REPORTER_SETTING_ID as x,TELEMETRY_OLD_SETTING_ID as E,TELEMETRY_SETTING_ID as b}from"./telemetry.js";class h{constructor(r){this.value=r}isTrustedTelemetryValue=!0}class v{telemetryLevel=a.NONE;sessionId="someValue.sessionId";machineId="someValue.machineId";sqmId="someValue.sqmId";devDeviceId="someValue.devDeviceId";firstSessionDate="someValue.firstSessionDate";sendErrorTelemetry=!1;publicLog(){}publicLog2(){}publicLogError(){}publicLogError2(){}setExperimentProperty(){}}const F=new v;class Y{_serviceBrand;async publicLog(r,t,o){}async publicLogError(r,t,o){}}const k="telemetry",q="extensionTelemetryLog",K={log:()=>null,flush:()=>Promise.resolve(null)};function j(e,r){return!r.isBuilt&&!r.disableTelemetry?!0:!(r.disableTelemetry||!e.enableTelemetry)}function W(e,r){return r.extensionTestsLocationURI?!0:!(r.isBuilt||r.disableTelemetry||e.enableTelemetry&&e.aiConfig?.ariaKey)}function J(e){const r=e.getValue(b),t=e.getValue(x);if(e.getValue(E)===!1||t===!1)return a.NONE;switch(r??u.ON){case u.ON:return a.USAGE;case u.ERROR:return a.ERROR;case u.CRASH:return a.CRASH;case u.OFF:return a.NONE}}function Q(e){const r={},t={},o={};d(e,o);for(let s in o){s=s.length>150?s.substr(s.length-149):s;const n=o[s];typeof n=="number"?t[s]=n:typeof n=="boolean"?t[s]=n?1:0:typeof n=="string"?(n.length>8192,r[s]=n.substring(0,8191)):typeof n<"u"&&n!==null&&(r[s]=n)}return{properties:r,measurements:t}}const R=new Set(["ssh-remote","dev-container","attached-container","wsl","tunnel","codespaces","amlext"]);function X(e){if(!e)return"none";const r=T(e);return R.has(r)?r:"other"}function d(e,r,t=0,o){if(e)for(const s of Object.getOwnPropertyNames(e)){const n=e[s],i=o?o+s:s;Array.isArray(n)?r[i]=c(n):n instanceof Date?r[i]=n.toISOString():y(n)?t<2?d(n,r,t+1,i+"."):r[i]=c(n):r[i]=n}}function ee(e,r){const t=e.msftInternalDomains||[],o=r.getValue("telemetry.internalTesting");return I(t)||o}function re(e){return[e.appRoot,e.extensionsPath,e.userHome.fsPath,e.tmpDir.fsPath,e.userDataPath]}function P(e,r){if(!e||!e.includes("/")&&!e.includes("\\"))return e;let t=e;const o=[];for(const l of r)for(;;){const m=l.exec(e);if(!m)break;o.push([m.index,l.lastIndex])}const s=/^[\\\/]?(node_modules|node_modules\.asar)[\\\/]/,n=/(file:\/\/)?([a-zA-Z]:(\\\\|\\|\/)|(\\\\|\\|\/))?([\w-\._]+(\\\\|\\|\/))+[\w-\._]*/g;let i=0;for(t="";;){const l=n.exec(e);if(!l)break;const m=o.some(([f,p])=>l.index<p&&f<n.lastIndex);!s.test(l[0])&&!m&&(t+=e.substring(i,l.index)+"<REDACTED: user-file-path>",i=n.lastIndex)}return i<e.length&&(t+=e.substr(i)),t}function D(e){if(!e)return e;const r=[{label:"Google API Key",regex:/AIza[A-Za-z0-9_\\\-]{35}/},{label:"Slack Token",regex:/xox[pbar]\-[A-Za-z0-9]/},{label:"GitHub Token",regex:/(gh[psuro]_[a-zA-Z0-9]{36}|github_pat_[a-zA-Z0-9]{22}_[a-zA-Z0-9]{59})/},{label:"Generic Secret",regex:/(key|token|sig|secret|signature|password|passwd|pwd|android:value)[^a-zA-Z0-9]/i},{label:"CLI Credentials",regex:/((login|psexec|(certutil|psexec)\.exe).{1,50}(\s-u(ser(name)?)?\s+.{3,100})?\s-(admin|user|vm|root)?p(ass(word)?)?\s+["']?[^$\-\/\s]|(^|[\s\r\n\\])net(\.exe)?.{1,5}(user\s+|share\s+\/user:| user -? secrets ? set) \s + [^ $\s \/])/},{label:"Email",regex:/@[a-zA-Z0-9-]+\.[a-zA-Z0-9-]+/}];for(const t of r)if(t.regex.test(e))return`<REDACTED: ${t.label}>`;return e}function te(e,r){return g(e,t=>{if(t instanceof h||Object.hasOwnProperty.call(t,"isTrustedTelemetryValue"))return t.value;if(typeof t=="string"){let o=t.replaceAll("%20"," ");o=P(o,r);for(const s of r)o=o.replace(s,"");return o=D(o),o}})}export{K as NullAppender,Y as NullEndpointTelemetryService,F as NullTelemetryService,v as NullTelemetryServiceShape,h as TelemetryTrustedValue,te as cleanData,X as cleanRemoteAuthority,q as extensionTelemetryLogChannelId,re as getPiiPathsFromEnvironment,J as getTelemetryLevel,ee as isInternalTelemetry,W as isLoggingOnly,j as supportsTelemetry,k as telemetryLogId,Q as validateTelemetryData};
