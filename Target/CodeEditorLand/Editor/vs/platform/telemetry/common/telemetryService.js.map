{
  "version": 3,
  "sources": ["../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/platform/telemetry/common/telemetryService.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { DisposableStore } from '../../../base/common/lifecycle.js';\nimport { mixin } from '../../../base/common/objects.js';\nimport { isWeb } from '../../../base/common/platform.js';\nimport { escapeRegExpCharacters } from '../../../base/common/strings.js';\nimport { localize } from '../../../nls.js';\nimport { IConfigurationService } from '../../configuration/common/configuration.js';\nimport { ConfigurationScope, Extensions, IConfigurationRegistry } from '../../configuration/common/configurationRegistry.js';\nimport product from '../../product/common/product.js';\nimport { IProductService } from '../../product/common/productService.js';\nimport { Registry } from '../../registry/common/platform.js';\nimport { ClassifiedEvent, IGDPRProperty, OmitMetadata, StrictPropertyCheck } from './gdprTypings.js';\nimport { ITelemetryData, ITelemetryService, TelemetryConfiguration, TelemetryLevel, TELEMETRY_CRASH_REPORTER_SETTING_ID, TELEMETRY_OLD_SETTING_ID, TELEMETRY_SECTION_ID, TELEMETRY_SETTING_ID, ICommonProperties } from './telemetry.js';\nimport { cleanData, getTelemetryLevel, ITelemetryAppender } from './telemetryUtils.js';\n\nexport interface ITelemetryServiceConfig {\n\tappenders: ITelemetryAppender[];\n\tsendErrorTelemetry?: boolean;\n\tcommonProperties?: ICommonProperties;\n\tpiiPaths?: string[];\n}\n\nexport class TelemetryService implements ITelemetryService {\n\n\tstatic readonly IDLE_START_EVENT_NAME = 'UserIdleStart';\n\tstatic readonly IDLE_STOP_EVENT_NAME = 'UserIdleStop';\n\n\tdeclare readonly _serviceBrand: undefined;\n\n\treadonly sessionId: string;\n\treadonly machineId: string;\n\treadonly sqmId: string;\n\treadonly devDeviceId: string;\n\treadonly firstSessionDate: string;\n\treadonly msftInternal: boolean | undefined;\n\n\tprivate _appenders: ITelemetryAppender[];\n\tprivate _commonProperties: ICommonProperties;\n\tprivate _experimentProperties: { [name: string]: string } = {};\n\tprivate _piiPaths: string[];\n\tprivate _telemetryLevel: TelemetryLevel;\n\tprivate _sendErrorTelemetry: boolean;\n\n\tprivate readonly _disposables = new DisposableStore();\n\tprivate _cleanupPatterns: RegExp[] = [];\n\n\tconstructor(\n\t\tconfig: ITelemetryServiceConfig,\n\t\t@IConfigurationService private _configurationService: IConfigurationService,\n\t\t@IProductService private _productService: IProductService\n\t) {\n\t\tthis._appenders = config.appenders;\n\t\tthis._commonProperties = config.commonProperties ?? Object.create(null);\n\n\t\tthis.sessionId = this._commonProperties['sessionID'] as string;\n\t\tthis.machineId = this._commonProperties['common.machineId'] as string;\n\t\tthis.sqmId = this._commonProperties['common.sqmId'] as string;\n\t\tthis.devDeviceId = this._commonProperties['common.devDeviceId'] as string;\n\t\tthis.firstSessionDate = this._commonProperties['common.firstSessionDate'] as string;\n\t\tthis.msftInternal = this._commonProperties['common.msftInternal'] as boolean | undefined;\n\n\t\tthis._piiPaths = config.piiPaths || [];\n\t\tthis._telemetryLevel = TelemetryLevel.USAGE;\n\t\tthis._sendErrorTelemetry = !!config.sendErrorTelemetry;\n\n\t\t// static cleanup pattern for: `vscode-file:///DANGEROUS/PATH/resources/app/Useful/Information`\n\t\tthis._cleanupPatterns = [/(vscode-)?file:\\/\\/\\/.*?\\/resources\\/app\\//gi];\n\n\t\tfor (const piiPath of this._piiPaths) {\n\t\t\tthis._cleanupPatterns.push(new RegExp(escapeRegExpCharacters(piiPath), 'gi'));\n\n\t\t\tif (piiPath.indexOf('\\\\') >= 0) {\n\t\t\t\tthis._cleanupPatterns.push(new RegExp(escapeRegExpCharacters(piiPath.replace(/\\\\/g, '/')), 'gi'));\n\t\t\t}\n\t\t}\n\n\t\tthis._updateTelemetryLevel();\n\t\tthis._disposables.add(this._configurationService.onDidChangeConfiguration(e => {\n\t\t\t// Check on the telemetry settings and update the state if changed\n\t\t\tconst affectsTelemetryConfig =\n\t\t\t\te.affectsConfiguration(TELEMETRY_SETTING_ID)\n\t\t\t\t|| e.affectsConfiguration(TELEMETRY_OLD_SETTING_ID)\n\t\t\t\t|| e.affectsConfiguration(TELEMETRY_CRASH_REPORTER_SETTING_ID);\n\t\t\tif (affectsTelemetryConfig) {\n\t\t\t\tthis._updateTelemetryLevel();\n\t\t\t}\n\t\t}));\n\t}\n\n\tsetExperimentProperty(name: string, value: string): void {\n\t\tthis._experimentProperties[name] = value;\n\t}\n\n\tprivate _updateTelemetryLevel(): void {\n\t\tlet level = getTelemetryLevel(this._configurationService);\n\t\tconst collectableTelemetry = this._productService.enabledTelemetryLevels;\n\t\t// Also ensure that error telemetry is respecting the product configuration for collectable telemetry\n\t\tif (collectableTelemetry) {\n\t\t\tthis._sendErrorTelemetry = this.sendErrorTelemetry ? collectableTelemetry.error : false;\n\t\t\t// Make sure the telemetry level from the service is the minimum of the config and product\n\t\t\tconst maxCollectableTelemetryLevel = collectableTelemetry.usage ? TelemetryLevel.USAGE : collectableTelemetry.error ? TelemetryLevel.ERROR : TelemetryLevel.NONE;\n\t\t\tlevel = Math.min(level, maxCollectableTelemetryLevel);\n\t\t}\n\n\t\tthis._telemetryLevel = level;\n\t}\n\n\tget sendErrorTelemetry(): boolean {\n\t\treturn this._sendErrorTelemetry;\n\t}\n\n\tget telemetryLevel(): TelemetryLevel {\n\t\treturn this._telemetryLevel;\n\t}\n\n\tdispose(): void {\n\t\tthis._disposables.dispose();\n\t}\n\n\tprivate _log(eventName: string, eventLevel: TelemetryLevel, data?: ITelemetryData) {\n\t\t// don't send events when the user is optout\n\t\tif (this._telemetryLevel < eventLevel) {\n\t\t\treturn;\n\t\t}\n\n\t\t// add experiment properties\n\t\tdata = mixin(data, this._experimentProperties);\n\n\t\t// remove all PII from data\n\t\tdata = cleanData(data as Record<string, any>, this._cleanupPatterns);\n\n\t\t// add common properties\n\t\tdata = mixin(data, this._commonProperties);\n\n\t\t// Log to the appenders of sufficient level\n\t\tthis._appenders.forEach(a => a.log(eventName, data));\n\t}\n\n\tpublicLog(eventName: string, data?: ITelemetryData) {\n\t\tthis._log(eventName, TelemetryLevel.USAGE, data);\n\t}\n\n\tpublicLog2<E extends ClassifiedEvent<OmitMetadata<T>> = never, T extends IGDPRProperty = never>(eventName: string, data?: StrictPropertyCheck<T, E>) {\n\t\tthis.publicLog(eventName, data as ITelemetryData);\n\t}\n\n\tpublicLogError(errorEventName: string, data?: ITelemetryData) {\n\t\tif (!this._sendErrorTelemetry) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Send error event and anonymize paths\n\t\tthis._log(errorEventName, TelemetryLevel.ERROR, data);\n\t}\n\n\tpublicLogError2<E extends ClassifiedEvent<OmitMetadata<T>> = never, T extends IGDPRProperty = never>(eventName: string, data?: StrictPropertyCheck<T, E>) {\n\t\tthis.publicLogError(eventName, data as ITelemetryData);\n\t}\n}\n\nfunction getTelemetryLevelSettingDescription(): string {\n\tconst telemetryText = localize('telemetry.telemetryLevelMd', \"Controls {0} telemetry, first-party extension telemetry, and participating third-party extension telemetry. Some third party extensions might not respect this setting. Consult the specific extension's documentation to be sure. Telemetry helps us better understand how {0} is performing, where improvements need to be made, and how features are being used.\", product.nameLong);\n\tconst externalLinksStatement = !product.privacyStatementUrl ?\n\t\tlocalize(\"telemetry.docsStatement\", \"Read more about the [data we collect]({0}).\", 'https://aka.ms/vscode-telemetry') :\n\t\tlocalize(\"telemetry.docsAndPrivacyStatement\", \"Read more about the [data we collect]({0}) and our [privacy statement]({1}).\", 'https://aka.ms/vscode-telemetry', product.privacyStatementUrl);\n\tconst restartString = !isWeb ? localize('telemetry.restart', 'A full restart of the application is necessary for crash reporting changes to take effect.') : '';\n\n\tconst crashReportsHeader = localize('telemetry.crashReports', \"Crash Reports\");\n\tconst errorsHeader = localize('telemetry.errors', \"Error Telemetry\");\n\tconst usageHeader = localize('telemetry.usage', \"Usage Data\");\n\n\tconst telemetryTableDescription = localize('telemetry.telemetryLevel.tableDescription', \"The following table outlines the data sent with each setting:\");\n\tconst telemetryTable = `\n|       | ${crashReportsHeader} | ${errorsHeader} | ${usageHeader} |\n|:------|:---------------------:|:---------------:|:--------------:|\n| all   |            \u2713          |        \u2713        |        \u2713       |\n| error |            \u2713          |        \u2713        |        -       |\n| crash |            \u2713          |        -        |        -       |\n| off   |            -          |        -        |        -       |\n`;\n\n\tconst deprecatedSettingNote = localize('telemetry.telemetryLevel.deprecated', \"****Note:*** If this setting is 'off', no telemetry will be sent regardless of other telemetry settings. If this setting is set to anything except 'off' and telemetry is disabled with deprecated settings, no telemetry will be sent.*\");\n\tconst telemetryDescription = `\n${telemetryText} ${externalLinksStatement} ${restartString}\n\n&nbsp;\n\n${telemetryTableDescription}\n${telemetryTable}\n\n&nbsp;\n\n${deprecatedSettingNote}\n`;\n\n\treturn telemetryDescription;\n}\n\nRegistry.as<IConfigurationRegistry>(Extensions.Configuration).registerConfiguration({\n\t'id': TELEMETRY_SECTION_ID,\n\t'order': 1,\n\t'type': 'object',\n\t'title': localize('telemetryConfigurationTitle', \"Telemetry\"),\n\t'properties': {\n\t\t[TELEMETRY_SETTING_ID]: {\n\t\t\t'type': 'string',\n\t\t\t'enum': [TelemetryConfiguration.ON, TelemetryConfiguration.ERROR, TelemetryConfiguration.CRASH, TelemetryConfiguration.OFF],\n\t\t\t'enumDescriptions': [\n\t\t\t\tlocalize('telemetry.telemetryLevel.default', \"Sends usage data, errors, and crash reports.\"),\n\t\t\t\tlocalize('telemetry.telemetryLevel.error', \"Sends general error telemetry and crash reports.\"),\n\t\t\t\tlocalize('telemetry.telemetryLevel.crash', \"Sends OS level crash reports.\"),\n\t\t\t\tlocalize('telemetry.telemetryLevel.off', \"Disables all product telemetry.\")\n\t\t\t],\n\t\t\t'markdownDescription': getTelemetryLevelSettingDescription(),\n\t\t\t'default': TelemetryConfiguration.ON,\n\t\t\t'restricted': true,\n\t\t\t'scope': ConfigurationScope.APPLICATION,\n\t\t\t'tags': ['usesOnlineServices', 'telemetry']\n\t\t}\n\t}\n});\n\n// Deprecated telemetry setting\nRegistry.as<IConfigurationRegistry>(Extensions.Configuration).registerConfiguration({\n\t'id': TELEMETRY_SECTION_ID,\n\t'order': 110,\n\t'type': 'object',\n\t'title': localize('telemetryConfigurationTitle', \"Telemetry\"),\n\t'properties': {\n\t\t[TELEMETRY_OLD_SETTING_ID]: {\n\t\t\t'type': 'boolean',\n\t\t\t'markdownDescription':\n\t\t\t\t!product.privacyStatementUrl ?\n\t\t\t\t\tlocalize('telemetry.enableTelemetry', \"Enable diagnostic data to be collected. This helps us to better understand how {0} is performing and where improvements need to be made.\", product.nameLong) :\n\t\t\t\t\tlocalize('telemetry.enableTelemetryMd', \"Enable diagnostic data to be collected. This helps us to better understand how {0} is performing and where improvements need to be made. [Read more]({1}) about what we collect and our privacy statement.\", product.nameLong, product.privacyStatementUrl),\n\t\t\t'default': true,\n\t\t\t'restricted': true,\n\t\t\t'markdownDeprecationMessage': localize('enableTelemetryDeprecated', \"If this setting is false, no telemetry will be sent regardless of the new setting's value. Deprecated in favor of the {0} setting.\", `\\`#${TELEMETRY_SETTING_ID}#\\``),\n\t\t\t'scope': ConfigurationScope.APPLICATION,\n\t\t\t'tags': ['usesOnlineServices', 'telemetry']\n\t\t}\n\t}\n});\n\n"],
  "mappings": "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",
  "names": []
}
