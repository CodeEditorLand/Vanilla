var f=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var p=(e,s,t,o)=>{for(var r=o>1?void 0:o?v(s,t):s,i=e.length-1,n;i>=0;i--)(n=e[i])&&(r=(o?n(s,t,r):n(r))||r);return o&&r&&f(s,t,r),r},l=(e,s)=>(t,o)=>s(t,o,e);import"http";import"https";import{parse as g}from"url";import{createGunzip as S}from"zlib";import{Promises as R}from"../../../base/common/async.js";import{streamToBufferReadableStream as y}from"../../../base/common/buffer.js";import"../../../base/common/cancellation.js";import{CancellationError as q,getErrorMessage as w}from"../../../base/common/errors.js";import"../../../base/common/stream.js";import{isBoolean as C,isNumber as I}from"../../../base/common/types.js";import"../../../base/parts/request/common/request.js";import{IConfigurationService as x}from"../../configuration/common/configuration.js";import{INativeEnvironmentService as b}from"../../environment/common/environment.js";import{ILogService as L}from"../../log/common/log.js";import{getResolvedShellEnv as A}from"../../shell/node/shellEnv.js";import{AbstractRequestService as P}from"../common/request.js";import{getProxyAgent as z}from"./proxy.js";let d=class extends P{constructor(t,o,r,i){super(t);this.configurationService=o;this.environmentService=r;this.logService=i;this.configure(),this._register(o.onDidChangeConfiguration(n=>{n.affectsConfiguration("http")&&this.configure()}))}proxyUrl;strictSSL;authorization;shellEnvErrorLogged;configure(){const t=this.configurationService.getValue("http");this.proxyUrl=t?.proxy,this.strictSSL=!!t?.proxyStrictSSL,this.authorization=t?.proxyAuthorization}async request(t,o){const{proxyUrl:r,strictSSL:i}=this;let n;try{n=await A(this.configurationService,this.logService,this.environmentService.args,process.env)}catch(c){this.shellEnvErrorLogged||(this.shellEnvErrorLogged=!0,this.logService.error("resolving shell environment failed",w(c)))}const u={...process.env,...n},a=t.agent?t.agent:await z(t.url||"",u,{proxyUrl:r,strictSSL:i});return t.agent=a,t.strictSSL=i,this.authorization&&(t.headers={...t.headers||{},"Proxy-Authorization":this.authorization}),this.logAndRequest(t,()=>h(t,o))}async resolveProxy(t){}async lookupAuthorization(t){}async lookupKerberosAuthorization(t){try{const o=await import("kerberos"),r=new URL(t),i=this.configurationService.getValue("http.proxyKerberosServicePrincipal")||(process.platform==="win32"?`HTTP/${r.hostname}`:`HTTP@${r.hostname}`);return this.logService.debug("RequestService#lookupKerberosAuthorization Kerberos authentication lookup",`proxyURL:${r}`,`spn:${i}`),"Negotiate "+await(await o.initializeClient(i)).step("")}catch(o){this.logService.debug("RequestService#lookupKerberosAuthorization Kerberos authentication failed",o);return}}async loadCertificates(){return(await import("@vscode/proxy-agent")).loadSystemCertificates({log:this.logService})}};d=p([l(1,x),l(2,b),l(3,L)],d);async function E(e){return(g(e.url).protocol==="https:"?await import("https"):await import("http")).request}async function h(e,s){return R.withAsyncBody(async(t,o)=>{const r=g(e.url),i=e.getRawRequest?e.getRawRequest(e):await E(e),n={hostname:r.hostname,port:r.port?parseInt(r.port):r.protocol==="https:"?443:80,protocol:r.protocol,path:r.path,method:e.type||"GET",headers:e.headers,agent:e.agent,rejectUnauthorized:C(e.strictSSL)?e.strictSSL:!0};e.user&&e.password&&(n.auth=e.user+":"+e.password);const u=i(n,a=>{const c=I(e.followRedirects)?e.followRedirects:3;if(a.statusCode&&a.statusCode>=300&&a.statusCode<400&&c>0&&a.headers.location)h({...e,url:a.headers.location,followRedirects:c-1},s).then(t,o);else{let m=a;!e.isChromiumNetwork&&a.headers["content-encoding"]==="gzip"&&(m=a.pipe(S())),t({res:a,stream:y(m)})}});u.on("error",o),e.timeout&&u.setTimeout(e.timeout),e.isChromiumNetwork&&u.removeHeader("Content-Length"),e.data&&typeof e.data=="string"&&u.write(e.data),u.end(),s.onCancellationRequested(()=>{u.abort(),o(new q)})})}export{d as RequestService,h as nodeRequest};
