{
  "version": 3,
  "sources": ["../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/platform/update/electron-main/updateService.snap.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { spawn } from \"child_process\";\nimport { realpath, watch } from \"fs\";\nimport { timeout } from \"../../../base/common/async.js\";\nimport { Emitter, Event } from \"../../../base/common/event.js\";\nimport * as path from \"../../../base/common/path.js\";\nimport { IEnvironmentMainService } from \"../../environment/electron-main/environmentMainService.js\";\nimport { ILifecycleMainService } from \"../../lifecycle/electron-main/lifecycleMainService.js\";\nimport { ILogService } from \"../../log/common/log.js\";\nimport { ITelemetryService } from \"../../telemetry/common/telemetry.js\";\nimport {\n\ttype AvailableForDownload,\n\ttype IUpdateService,\n\tState,\n\tStateType,\n\tUpdateType,\n} from \"../common/update.js\";\nimport type { UpdateNotAvailableClassification } from \"./abstractUpdateService.js\";\n\nabstract class AbstractUpdateService implements IUpdateService {\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate _state: State = State.Uninitialized;\n\n\tprivate readonly _onStateChange = new Emitter<State>();\n\treadonly onStateChange: Event<State> = this._onStateChange.event;\n\n\tget state(): State {\n\t\treturn this._state;\n\t}\n\n\tprotected setState(state: State): void {\n\t\tthis.logService.info(\"update#setState\", state.type);\n\t\tthis._state = state;\n\t\tthis._onStateChange.fire(state);\n\t}\n\n\tconstructor(\n\t\t@ILifecycleMainService private readonly lifecycleMainService: ILifecycleMainService,\n\t\t@IEnvironmentMainService environmentMainService: IEnvironmentMainService,\n\t\t@ILogService protected logService: ILogService,\n\t) {\n\t\tif (environmentMainService.disableUpdates) {\n\t\t\tthis.logService.info('update#ctor - updates are disabled');\n\t\t\treturn;\n\t\t}\n\n\t\tthis.setState(State.Idle(this.getUpdateType()));\n\n\t\t// Start checking for updates after 30 seconds\n\t\tthis.scheduleCheckForUpdates(30 * 1000).then(undefined, err => this.logService.error(err));\n\t}\n\n\tprivate scheduleCheckForUpdates(delay = 60 * 60 * 1000): Promise<void> {\n\t\treturn timeout(delay)\n\t\t\t.then(() => this.checkForUpdates(false))\n\t\t\t.then(() => {\n\t\t\t\t// Check again after 1 hour\n\t\t\t\treturn this.scheduleCheckForUpdates(60 * 60 * 1000);\n\t\t\t});\n\t}\n\n\tasync checkForUpdates(explicit: boolean): Promise<void> {\n\t\tthis.logService.trace(\n\t\t\t\"update#checkForUpdates, state = \",\n\t\t\tthis.state.type,\n\t\t);\n\n\t\tif (this.state.type !== StateType.Idle) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.doCheckForUpdates(explicit);\n\t}\n\n\tasync downloadUpdate(): Promise<void> {\n\t\tthis.logService.trace(\n\t\t\t\"update#downloadUpdate, state = \",\n\t\t\tthis.state.type,\n\t\t);\n\n\t\tif (this.state.type !== StateType.AvailableForDownload) {\n\t\t\treturn;\n\t\t}\n\n\t\tawait this.doDownloadUpdate(this.state);\n\t}\n\n\tprotected doDownloadUpdate(state: AvailableForDownload): Promise<void> {\n\t\treturn Promise.resolve(undefined);\n\t}\n\n\tasync applyUpdate(): Promise<void> {\n\t\tthis.logService.trace(\"update#applyUpdate, state = \", this.state.type);\n\n\t\tif (this.state.type !== StateType.Downloaded) {\n\t\t\treturn;\n\t\t}\n\n\t\tawait this.doApplyUpdate();\n\t}\n\n\tprotected doApplyUpdate(): Promise<void> {\n\t\treturn Promise.resolve(undefined);\n\t}\n\n\tquitAndInstall(): Promise<void> {\n\t\tthis.logService.trace(\n\t\t\t\"update#quitAndInstall, state = \",\n\t\t\tthis.state.type,\n\t\t);\n\n\t\tif (this.state.type !== StateType.Ready) {\n\t\t\treturn Promise.resolve(undefined);\n\t\t}\n\n\t\tthis.logService.trace(\n\t\t\t\"update#quitAndInstall(): before lifecycle quit()\",\n\t\t);\n\n\t\tthis.lifecycleMainService\n\t\t\t.quit(true /* will restart */)\n\t\t\t.then((vetod) => {\n\t\t\t\tthis.logService.trace(\n\t\t\t\t\t`update#quitAndInstall(): after lifecycle quit() with veto: ${vetod}`,\n\t\t\t\t);\n\t\t\t\tif (vetod) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.logService.trace(\n\t\t\t\t\t\"update#quitAndInstall(): running raw#quitAndInstall()\",\n\t\t\t\t);\n\t\t\t\tthis.doQuitAndInstall();\n\t\t\t});\n\n\t\treturn Promise.resolve(undefined);\n\t}\n\n\tprotected getUpdateType(): UpdateType {\n\t\treturn UpdateType.Snap;\n\t}\n\n\tprotected doQuitAndInstall(): void {\n\t\t// noop\n\t}\n\n\tabstract isLatestVersion(): Promise<boolean | undefined>;\n\n\tasync _applySpecificUpdate(packagePath: string): Promise<void> {\n\t\t// noop\n\t}\n\n\tprotected abstract doCheckForUpdates(context: any): void;\n}\n\nexport class SnapUpdateService extends AbstractUpdateService {\n\tconstructor(\n\t\tprivate snap: string,\n\t\tprivate snapRevision: string,\n\t\t@ILifecycleMainService lifecycleMainService: ILifecycleMainService,\n\t\t@IEnvironmentMainService environmentMainService: IEnvironmentMainService,\n\t\t@ILogService logService: ILogService,\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService\n\t) {\n\t\tsuper(lifecycleMainService, environmentMainService, logService);\n\n\t\tconst watcher = watch(path.dirname(this.snap));\n\t\tconst onChange = Event.fromNodeEventEmitter(watcher, 'change', (_, fileName: string) => fileName);\n\t\tconst onCurrentChange = Event.filter(onChange, n => n === 'current');\n\t\tconst onDebouncedCurrentChange = Event.debounce(onCurrentChange, (_, e) => e, 2000);\n\t\tconst listener = onDebouncedCurrentChange(() => this.checkForUpdates(false));\n\n\t\tlifecycleMainService.onWillShutdown(() => {\n\t\t\tlistener.dispose();\n\t\t\twatcher.close();\n\t\t});\n\t}\n\n\tprotected doCheckForUpdates(): void {\n\t\tthis.setState(State.CheckingForUpdates(false));\n\t\tthis.isUpdateAvailable().then(\n\t\t\t(result) => {\n\t\t\t\tif (result) {\n\t\t\t\t\tthis.setState(State.Ready({ version: \"something\" }));\n\t\t\t\t} else {\n\t\t\t\t\tthis.telemetryService.publicLog2<\n\t\t\t\t\t\t{ explicit: boolean },\n\t\t\t\t\t\tUpdateNotAvailableClassification\n\t\t\t\t\t>(\"update:notAvailable\", { explicit: false });\n\n\t\t\t\t\tthis.setState(State.Idle(UpdateType.Snap));\n\t\t\t\t}\n\t\t\t},\n\t\t\t(err) => {\n\t\t\t\tthis.logService.error(err);\n\t\t\t\tthis.telemetryService.publicLog2<\n\t\t\t\t\t{ explicit: boolean },\n\t\t\t\t\tUpdateNotAvailableClassification\n\t\t\t\t>(\"update:notAvailable\", { explicit: false });\n\t\t\t\tthis.setState(State.Idle(UpdateType.Snap, err.message || err));\n\t\t\t},\n\t\t);\n\t}\n\n\tprotected override doQuitAndInstall(): void {\n\t\tthis.logService.trace(\n\t\t\t\"update#quitAndInstall(): running raw#quitAndInstall()\",\n\t\t);\n\n\t\t// Allow 3 seconds for VS Code to close\n\t\tspawn(\"sleep 3 && \" + path.basename(process.argv[0]), {\n\t\t\tshell: true,\n\t\t\tdetached: true,\n\t\t\tstdio: \"ignore\",\n\t\t});\n\t}\n\n\tprivate async isUpdateAvailable(): Promise<boolean> {\n\t\tconst resolvedCurrentSnapPath = await new Promise<string>((c, e) =>\n\t\t\trealpath(`${path.dirname(this.snap)}/current`, (err, r) =>\n\t\t\t\terr ? e(err) : c(r),\n\t\t\t),\n\t\t);\n\t\tconst currentRevision = path.basename(resolvedCurrentSnapPath);\n\t\treturn this.snapRevision !== currentRevision;\n\t}\n\n\tisLatestVersion(): Promise<boolean | undefined> {\n\t\treturn this.isUpdateAvailable().then(undefined, (err) => {\n\t\t\tthis.logService.error(\n\t\t\t\t\"update#checkForSnapUpdate(): Could not get realpath of application.\",\n\t\t\t);\n\t\t\treturn undefined;\n\t\t});\n\t}\n}\n"],
  "mappings": "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",
  "names": []
}
