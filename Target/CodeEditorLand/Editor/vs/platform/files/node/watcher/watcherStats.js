import{requestFilterToString as w}from"../../../../../vs/platform/files/common/watcher.js";import"../../../../../vs/platform/files/node/watcher/nodejs/nodejsWatcher.js";import"../../../../../vs/platform/files/node/watcher/parcel/parcelWatcher.js";function F(s,n,e){const t=[],i=g(s.filter(c=>c.recursive)),o=i.filter(c=>n.isSuspended(c)===!1),a=i.filter(c=>n.isSuspended(c)==="polling"),l=i.filter(c=>n.isSuspended(c)===!0),d=I(i,n),r=q(n),u=g(s.filter(c=>!c.recursive)),U=u.filter(c=>e.isSuspended(c)===!1),b=u.filter(c=>e.isSuspended(c)==="polling"),J=u.filter(c=>e.isSuspended(c)===!0),p=I(u,e),h=m(e);t.push("[Summary]"),t.push(`- Recursive Requests:     total: ${i.length}, suspended: ${d.suspended}, polling: ${d.polling}`),t.push(`- Non-Recursive Requests: total: ${u.length}, suspended: ${p.suspended}, polling: ${p.polling}`),t.push(`- Recursive Watchers:     total: ${n.watchers.size}, active: ${r.active}, failed: ${r.failed}, stopped: ${r.stopped}`),t.push(`- Non-Recursive Watchers: total: ${e.watchers.size}, active: ${h.active}, failed: ${h.failed}, reusing: ${h.reusing}`),t.push(`- I/O Handles Impact:     total: ${d.polling+p.polling+r.active+h.active}`),t.push(`
[Recursive Requests (${i.length}, suspended: ${d.suspended}, polling: ${d.polling})]:`);const v=[];for(const c of[o,a,l].flat())P(v,c,n);t.push(...f(v));const $=[];x($,n),t.push(...f($)),t.push(`
[Non-Recursive Requests (${u.length}, suspended: ${p.suspended}, polling: ${p.polling})]:`);const S=[];for(const c of[U,b,J].flat())P(S,c,e);t.push(...f(S));const W=[];return E(W,e),t.push(...f(W)),`

[File Watcher] request stats:

${t.join(`
`)}

`}function f(s){let n=0;for(const e of s)n=Math.max(n,e.split("	")[0].length);for(let e=0;e<s.length;e++){const i=s[e].split("	");if(i.length===2){const o=" ".repeat(n-i[0].length);s[e]=`${i[0]}${o}	${i[1]}`}}return s}function I(s,n){let e=0,t=0;for(const i of s){const o=n.isSuspended(i);o!==!1&&(t++,o==="polling"&&e++)}return{suspended:t,polling:e}}function q(s){let n=0,e=0,t=0;for(const i of s.watchers.values())!i.failed&&!i.stopped&&n++,i.failed&&e++,i.stopped&&t++;return{active:n,failed:e,stopped:t}}function m(s){let n=0,e=0,t=0;for(const i of s.watchers)!i.instance.failed&&!i.instance.isReusingRecursiveWatcher&&n++,i.instance.failed&&e++,i.instance.isReusingRecursiveWatcher&&t++;return{active:n,failed:e,reusing:t}}function g(s){return s.sort((n,e)=>{const t=N(n)?n.path:n.request.path,i=N(e)?e.path:e.request.path,o=Math.min(t.length,i.length);for(let a=0;a<o;a++)if(t[a]!==i[a])return t[a]<i[a]?-1:1;return t.length-i.length}),s}function N(s){return typeof s?.path=="string"}function P(s,n,e){const t=[],i=e.isSuspended(n);i!==!1&&(i==="polling"?t.push("[SUSPENDED <polling>]"):t.push("[SUSPENDED <non-polling>]")),s.push(` ${n.path}	${t.length>0?t.join(" ")+" ":""}(${R(n)})`)}function R(s){return`excludes: ${s.excludes.length>0?s.excludes:"<none>"}, includes: ${s.includes&&s.includes.length>0?JSON.stringify(s.includes):"<all>"}, filter: ${w(s.filter)}, correlationId: ${typeof s.correlationId=="number"?s.correlationId:"<none>"}`}function x(s,n){const e=g(Array.from(n.watchers.values())),{active:t,failed:i,stopped:o}=q(n);s.push(`
[Recursive Watchers (${e.length}, active: ${t}, failed: ${i}, stopped: ${o})]:`);for(const a of e){const l=[];a.failed&&l.push("[FAILED]"),a.stopped&&l.push("[STOPPED]"),a.subscriptionsCount>0&&l.push(`[SUBSCRIBED:${a.subscriptionsCount}]`),a.restarts>0&&l.push(`[RESTARTED:${a.restarts}]`),s.push(` ${a.request.path}	${l.length>0?l.join(" ")+" ":""}(${R(a.request)})`)}}function E(s,n){const e=g(Array.from(n.watchers.values())),t=e.filter(r=>!r.instance.failed&&!r.instance.isReusingRecursiveWatcher),i=e.filter(r=>r.instance.failed),o=e.filter(r=>r.instance.isReusingRecursiveWatcher),{active:a,failed:l,reusing:d}=m(n);s.push(`
[Non-Recursive Watchers (${e.length}, active: ${a}, failed: ${l}, reusing: ${d})]:`);for(const r of[t,i,o].flat()){const u=[];r.instance.failed&&u.push("[FAILED]"),r.instance.isReusingRecursiveWatcher&&u.push("[REUSING]"),s.push(` ${r.request.path}	${u.length>0?u.join(" ")+" ":""}(${R(r.request)})`)}}export{F as computeStats};
