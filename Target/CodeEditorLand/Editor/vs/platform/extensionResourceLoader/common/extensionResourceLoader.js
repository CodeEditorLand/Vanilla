import{RemoteAuthorities as a}from"../../../base/common/network.js";import{isWeb as u}from"../../../base/common/platform.js";import{format2 as m}from"../../../base/common/strings.js";import{URI as c}from"../../../base/common/uri.js";import{TargetPlatform as s}from"../../extensions/common/extensions.js";import{getServiceMachineId as d}from"../../externalServices/common/serviceMachineId.js";import{createDecorator as p}from"../../instantiation/common/instantiation.js";import{TelemetryLevel as h}from"../../telemetry/common/telemetry.js";import{getTelemetryLevel as v,supportsTelemetry as f}from"../../telemetry/common/telemetryUtils.js";const y="/web-extension-resource/",b=p("extensionResourceLoaderService");function P(n,e){if(n.query!==`target=${e}`)return;const r=n.path.split("/");if(r[3])return r[3]=`${r[3]}+${e}`,n.with({query:null,path:r.join("/")})}class T{constructor(e,r,t,i,l){this._fileService=e;this._storageService=r;this._productService=t;this._environmentService=i;this._configurationService=l;t.extensionsGallery&&(this._extensionGalleryResourceUrlTemplate=t.extensionsGallery.resourceUrlTemplate,this._extensionGalleryAuthority=this._extensionGalleryResourceUrlTemplate?this._getExtensionGalleryAuthority(c.parse(this._extensionGalleryResourceUrlTemplate)):void 0)}_serviceBrand;_extensionGalleryResourceUrlTemplate;_extensionGalleryAuthority;get supportsExtensionGalleryResources(){return this._extensionGalleryResourceUrlTemplate!==void 0}getExtensionGalleryResourceURL({publisher:e,name:r,version:t,targetPlatform:i},l){if(this._extensionGalleryResourceUrlTemplate){const o=c.parse(m(this._extensionGalleryResourceUrlTemplate,{publisher:e,name:r,version:i!==void 0&&i!==s.UNDEFINED&&i!==s.UNKNOWN&&i!==s.UNIVERSAL?`${t}+${i}`:t,path:"extension"}));return this._isWebExtensionResourceEndPoint(o)?o.with({scheme:a.getPreferredWebSchema()}):o}}isExtensionGalleryResource(e){return!!this._extensionGalleryAuthority&&this._extensionGalleryAuthority===this._getExtensionGalleryAuthority(e)}async getExtensionGalleryRequestHeaders(){const e={"X-Client-Name":`${this._productService.applicationName}${u?"-web":""}`,"X-Client-Version":this._productService.version};return f(this._productService,this._environmentService)&&v(this._configurationService)===h.USAGE&&(e["X-Machine-Id"]=await this._getServiceMachineId()),this._productService.commit&&(e["X-Client-Commit"]=this._productService.commit),e}_serviceMachineIdPromise;_getServiceMachineId(){return this._serviceMachineIdPromise||(this._serviceMachineIdPromise=d(this._environmentService,this._fileService,this._storageService)),this._serviceMachineIdPromise}_getExtensionGalleryAuthority(e){if(this._isWebExtensionResourceEndPoint(e))return e.authority;const r=e.authority.indexOf(".");return r!==-1?e.authority.substring(r+1):void 0}_isWebExtensionResourceEndPoint(e){const r=e.path,t=a.getServerRootPath();return r.startsWith(t)&&r.startsWith(y,t.length)}}export{T as AbstractExtensionResourceLoaderService,b as IExtensionResourceLoaderService,P as migratePlatformSpecificExtensionGalleryResourceURL};
