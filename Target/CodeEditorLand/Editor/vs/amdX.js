import{canASAR as p,isESM as l}from"../vs/base/common/amd.js";import{FileAccess as f,nodeModulesAsarPath as h,nodeModulesPath as y,Schemas as _,VSCODE_AUTHORITY as g}from"../vs/base/common/network.js";import*as m from"../vs/base/common/platform.js";import"../vs/base/common/product.js";import{assertType as P}from"../vs/base/common/types.js";import{URI as T}from"../vs/base/common/uri.js";class S{constructor(e,t,r){this.id=e;this.dependencies=t;this.callback=r}}class u{static INSTANCE=new u;_isWebWorker=typeof self=="object"&&self.constructor&&self.constructor.name==="DedicatedWorkerGlobalScope";_isRenderer=typeof document=="object";_defineCalls=[];_initialized=!1;_amdPolicy;constructor(){}_initialize(){this._initialized||(this._initialized=!0,globalThis.define=(e,t,r)=>{typeof e!="string"&&(r=t,t=e,e=null),(typeof t!="object"||!Array.isArray(t))&&(r=t,t=null),this._defineCalls.push(new S(e,t,r))},globalThis.define.amd=!0,this._isRenderer?this._amdPolicy=globalThis._VSCODE_WEB_PACKAGE_TTP??window.trustedTypes?.createPolicy("amdLoader",{createScriptURL(e){if(e.startsWith(window.location.origin)||e.startsWith(`${_.vscodeFileResource}://${g}`))return e;throw new Error(`[trusted_script_src] Invalid script url: ${e}`)}}):this._isWebWorker&&(this._amdPolicy=globalThis._VSCODE_WEB_PACKAGE_TTP??globalThis.trustedTypes?.createPolicy("amdLoader",{createScriptURL(e){return e}})))}async load(e){this._initialize();const t=await(this._isWebWorker?this._workerLoadScript(e):this._isRenderer?this._rendererLoadScript(e):this._nodeJSLoadScript(e));if(!t){console.warn(`Did not receive a define call from script ${e}`);return}const r={},i=[],n=[];if(Array.isArray(t.dependencies))for(const o of t.dependencies)o==="exports"?i.push(r):n.push(o);if(n.length>0)throw new Error(`Cannot resolve dependencies for script ${e}. The dependencies are: ${n.join(", ")}`);return typeof t.callback=="function"?t.callback(...i)??r:t.callback}_rendererLoadScript(e){return new Promise((t,r)=>{const i=document.createElement("script");i.setAttribute("async","async"),i.setAttribute("type","text/javascript");const n=()=>{i.removeEventListener("load",o),i.removeEventListener("error",s)},o=c=>{n(),t(this._defineCalls.pop())},s=c=>{n(),r(c)};i.addEventListener("load",o),i.addEventListener("error",s),this._amdPolicy&&(e=this._amdPolicy.createScriptURL(e)),i.setAttribute("src",e),window.document.getElementsByTagName("head")[0].appendChild(i)})}async _workerLoadScript(e){return this._amdPolicy&&(e=this._amdPolicy.createScriptURL(e)),l?await import(e):importScripts(e),this._defineCalls.pop()}async _nodeJSLoadScript(e){try{const t=globalThis._VSCODE_NODE_MODULES.fs,r=globalThis._VSCODE_NODE_MODULES.vm,i=globalThis._VSCODE_NODE_MODULES.module,n=T.parse(e).fsPath,o=t.readFileSync(n).toString(),s=i.wrap(o.replace(/^#!.*/,""));return new r.Script(s).runInThisContext().apply(),this._defineCalls.pop()}catch(t){throw t}}}const d=new Map;async function R(a,e,t){if(l){t===void 0&&(t=!!(globalThis._VSCODE_PRODUCT_JSON??globalThis.vscode?.context?.configuration()?.product)?.commit);const r=e?`${a}/${e}`:a;if(d.has(r))return d.get(r);let i;if(/^\w[\w\d+.-]*:\/\//.test(r))i=r;else{const c=`${p&&t&&!m.isWeb?h:y}/${r}`;i=f.asBrowserUri(c).toString(!0)}const n=u.INSTANCE.load(i);return d.set(r,n),n}else return await import(a)}function O(a,e){P(l);const r=!!(globalThis._VSCODE_PRODUCT_JSON??globalThis.vscode?.context?.configuration()?.product)?.commit,i=p&&r&&!m.isWeb,n=`${a}/${e}`,s=`${i?h:y}/${n}`;return f.asBrowserUri(s).toString(!0)}export{R as importAMDNodeModule,O as resolveAmdNodeModulePath};
