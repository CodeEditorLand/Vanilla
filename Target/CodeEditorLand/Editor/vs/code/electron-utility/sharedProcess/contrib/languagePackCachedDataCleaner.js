var k=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var h=(c,a,t,r)=>{for(var e=r>1?void 0:r?I(a,t):a,o=c.length-1,s;o>=0;o--)(s=c[o])&&(e=(r?s(a,t,e):s(e))||e);return r&&e&&k(a,t,e),e},u=(c,a)=>(t,r)=>a(t,r,c);import*as d from"fs";import{RunOnceScheduler as x}from"../../../../base/common/async.js";import"../../../../base/common/collections.js";import{onUnexpectedError as E}from"../../../../base/common/errors.js";import{Disposable as w}from"../../../../base/common/lifecycle.js";import{join as n}from"../../../../base/common/path.js";import{Promises as l}from"../../../../base/node/pfs.js";import{INativeEnvironmentService as D}from"../../../../platform/environment/common/environment.js";import{ILogService as P}from"../../../../platform/log/common/log.js";import{IProductService as b}from"../../../../platform/product/common/productService.js";let p=class extends w{constructor(t,r,e){super();this.environmentService=t;this.logService=r;this.productService=e;this.environmentService.isBuilt&&this._register(new x(()=>{this.cleanUpLanguagePackCache()},4e4)).schedule()}_DataMaxAge=this.productService.quality!=="stable"?1e3*60*60*24*7:1e3*60*60*24*30*3;async cleanUpLanguagePackCache(){this.logService.trace("[language pack cache cleanup]: Starting to clean up unused language packs.");try{const t=Object.create(null),r=JSON.parse(await d.promises.readFile(n(this.environmentService.userDataPath,"languagepacks.json"),"utf8"));for(const i of Object.keys(r)){const g=r[i];t[`${g.hash}.${i}`]=!0}const e=n(this.environmentService.userDataPath,"clp");if(!await l.exists(e))return;const s=await l.readdir(e);for(const i of s){if(t[i]){this.logService.trace(`[language pack cache cleanup]: Skipping folder ${i}. Language pack still in use.`);continue}this.logService.trace(`[language pack cache cleanup]: Removing unused language pack: ${i}`),await l.rm(n(e,i))}const S=Date.now();for(const i of Object.keys(t)){const g=n(e,i),y=await l.readdir(g);for(const m of y){if(m==="tcf.json")continue;const v=n(g,m),f=await d.promises.stat(v);f.isDirectory()&&S-f.mtime.getTime()>this._DataMaxAge&&(this.logService.trace(`[language pack cache cleanup]: Removing language pack cache folder: ${n(i,m)}`),await l.rm(v))}}}catch(t){E(t)}}};p=h([u(0,D),u(1,P),u(2,b)],p);export{p as LanguagePackCachedDataCleaner};
