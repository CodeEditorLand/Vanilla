var l=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var m=(n,o,e,t)=>{for(var r=t>1?void 0:t?S(o,e):o,i=n.length-1,s;i>=0;i--)(s=n[i])&&(r=(t?s(o,e,r):s(r))||r);return t&&r&&l(o,e,r),r},a=(n,o)=>(e,t)=>o(e,t,n);import{RunOnceScheduler as f}from"../../../../base/common/async.js";import{onUnexpectedError as d}from"../../../../base/common/errors.js";import{Disposable as g}from"../../../../base/common/lifecycle.js";import{Schemas as h}from"../../../../base/common/network.js";import{join as w}from"../../../../base/common/path.js";import{Promises as v}from"../../../../base/node/pfs.js";import{INativeEnvironmentService as u}from"../../../../platform/environment/common/environment.js";import{IMainProcessService as P}from"../../../../platform/ipc/common/mainProcessService.js";import{ILogService as E}from"../../../../platform/log/common/log.js";import{INativeHostService as I}from"../../../../platform/native/common/native.js";import{StorageClient as N}from"../../../../platform/storage/common/storageIpc.js";import{EXTENSION_DEVELOPMENT_EMPTY_WINDOW_WORKSPACE as y}from"../../../../platform/workspace/common/workspace.js";import{NON_EMPTY_WORKSPACE_ID_LENGTH as _}from"../../../../platform/workspaces/node/workspaces.js";let c=class extends g{constructor(e,t,r,i){super();this.environmentService=e;this.logService=t;this.nativeHostService=r;this.mainProcessService=i;this._register(new f(()=>{this.cleanUpStorage()},30*1e3)).schedule()}async cleanUpStorage(){this.logService.trace("[storage cleanup]: Starting to clean up workspace storage folders for unused empty workspaces.");try{const e=this.environmentService.workspaceStorageHome.with({scheme:h.file}).fsPath,t=await v.readdir(e),r=new N(this.mainProcessService.getChannel("storage"));await Promise.all(t.map(async i=>{const s=w(e,i);i.length===_||i===y.id||(await this.nativeHostService.getWindows({includeAuxiliaryWindows:!1})).some(p=>p.workspace?.id===i)||await r.isUsed(s)||(this.logService.trace(`[storage cleanup]: Deleting workspace storage folder ${i} as it seems to be an unused empty workspace.`),await v.rm(s))}))}catch(e){d(e)}}};c=m([a(0,u),a(1,E),a(2,I),a(3,P)],c);export{c as UnusedWorkspaceStorageDataCleaner};
