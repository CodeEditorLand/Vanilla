import"../../platform/update/common/update.config.contribution.js";import{promises as D,unlinkSync as b}from"fs";import{app as A,dialog as U}from"electron";import{coalesce as y,distinct as R}from"../../base/common/arrays.js";import{Promises as x}from"../../base/common/async.js";import{toErrorMessage as H}from"../../base/common/errorMessage.js";import{ExpectedError as P,setUnexpectedErrorHandler as W}from"../../base/common/errors.js";import{Event as C}from"../../base/common/event.js";import{isValidBasename as T,parseLineAndColumnAware as _,sanitizeFilePath as O}from"../../base/common/extpath.js";import{getPathLabel as V}from"../../base/common/labels.js";import{DisposableStore as B}from"../../base/common/lifecycle.js";import{Schemas as u}from"../../base/common/network.js";import{basename as j,resolve as q}from"../../base/common/path.js";import{mark as L}from"../../base/common/performance.js";import{isMacintosh as z,isWindows as S,OS as $}from"../../base/common/platform.js";import{cwd as G}from"../../base/common/process.js";import{rtrim as M,trim as k}from"../../base/common/strings.js";import{URI as J}from"../../base/common/uri.js";import{Promises as K}from"../../base/node/pfs.js";import{addUNCHostToAllowlist as X,getUNCHost as Y}from"../../base/node/unc.js";import{ProxyChannel as N}from"../../base/parts/ipc/common/ipc.js";import"../../base/parts/ipc/common/ipc.net.js";import{connect as Q,serve as Z,XDG_RUNTIME_DIR as ee}from"../../base/parts/ipc/node/ipc.net.js";import{localize as f}from"../../nls.js";import{IConfigurationService as re}from"../../platform/configuration/common/configuration.js";import{ConfigurationService as te}from"../../platform/configuration/common/configurationService.js";import"../../platform/diagnostics/electron-main/diagnosticsMainService.js";import{DiagnosticsService as ie}from"../../platform/diagnostics/node/diagnosticsService.js";import{massageMessageBoxOptions as oe}from"../../platform/dialogs/common/dialogs.js";import"../../platform/environment/common/argv.js";import{EnvironmentMainService as ne,IEnvironmentMainService as se}from"../../platform/environment/electron-main/environmentMainService.js";import{addArg as ae,parseMainProcessArgv as ce}from"../../platform/environment/node/argvHelper.js";import{createWaitMarkerFileSync as me}from"../../platform/environment/node/wait.js";import{IFileService as F}from"../../platform/files/common/files.js";import{FileService as le}from"../../platform/files/common/fileService.js";import{DiskFileSystemProvider as de}from"../../platform/files/node/diskFileSystemProvider.js";import{SyncDescriptor as h}from"../../platform/instantiation/common/descriptors.js";import"../../platform/instantiation/common/instantiation.js";import{InstantiationService as fe}from"../../platform/instantiation/common/instantiationService.js";import{ServiceCollection as ge}from"../../platform/instantiation/common/serviceCollection.js";import"../../platform/launch/electron-main/launchMainService.js";import{ILifecycleMainService as I,LifecycleMainService as pe}from"../../platform/lifecycle/electron-main/lifecycleMainService.js";import{BufferLogger as ve}from"../../platform/log/common/bufferLog.js";import{ConsoleMainLogger as ue,getLogLevel as Se,ILoggerService as he,ILogService as E}from"../../platform/log/common/log.js";import{LogService as we}from"../../platform/log/common/logService.js";import{ILoggerMainService as Pe,LoggerMainService as Ie}from"../../platform/log/electron-main/loggerService.js";import{FilePolicyService as Ee}from"../../platform/policy/common/filePolicyService.js";import{IPolicyService as De,NullPolicyService as ye}from"../../platform/policy/common/policy.js";import{NativePolicyService as Ce}from"../../platform/policy/node/nativePolicyService.js";import Le from"../../platform/product/common/product.js";import{IProductService as Me}from"../../platform/product/common/productService.js";import{IProtocolMainService as ke}from"../../platform/protocol/electron-main/protocol.js";import{ProtocolMainService as Ne}from"../../platform/protocol/electron-main/protocolMainService.js";import{IRequestService as Fe}from"../../platform/request/common/request.js";import{RequestService as be}from"../../platform/request/electron-utility/requestService.js";import{ISignService as Ae}from"../../platform/sign/common/sign.js";import{SignService as Ue}from"../../platform/sign/node/signService.js";import{IStateReadService as Re,IStateService as xe}from"../../platform/state/node/state.js";import{SaveStrategy as He,StateService as We}from"../../platform/state/node/stateService.js";import{NullTelemetryService as Te}from"../../platform/telemetry/common/telemetryUtils.js";import{IThemeMainService as _e,ThemeMainService as Oe}from"../../platform/theme/electron-main/themeMainService.js";import{ITunnelService as Ve}from"../../platform/tunnel/common/tunnel.js";import{TunnelService as Be}from"../../platform/tunnel/node/tunnelService.js";import{IUriIdentityService as je}from"../../platform/uriIdentity/common/uriIdentity.js";import{UriIdentityService as qe}from"../../platform/uriIdentity/common/uriIdentityService.js";import{FileUserDataProvider as ze}from"../../platform/userData/common/fileUserDataProvider.js";import{IUserDataProfilesMainService as $e,UserDataProfilesMainService as Ge}from"../../platform/userDataProfile/electron-main/userDataProfile.js";import{CodeApplication as Je}from"./app.js";class Ke{main(){try{this.startup()}catch(e){console.error(e.message),A.exit(1)}}async startup(){W(i=>console.error(i));const[e,r,t,o,s,m,a,n]=this.createServices();try{try{await this.initServices(t,n,o,s,a)}catch(i){throw this.handleStartupDataDirError(t,a,i),i}await e.invokeFunction(async i=>{const l=i.get(E),d=i.get(I),g=i.get(F),c=i.get(he),p=await this.claimInstance(l,t,d,e,a,!0);return K.writeFile(t.mainLockfile,String(process.pid)).catch(v=>{l.warn(`app#startup(): Error writing main lockfile: ${v.stack}`)}),m.logger=c.createLogger("main",{name:f("mainLog","Main")}),C.once(d.onWillShutdown)(v=>{g.dispose(),o.dispose(),v.join("instanceLockfile",D.unlink(t.mainLockfile).catch(()=>{}))}),e.createInstance(Je,p,r).startup()})}catch(i){e.invokeFunction(this.quit,i)}}createServices(){const e=new ge,r=new B;process.once("exit",()=>r.dispose());const t={_serviceBrand:void 0,...Le};e.set(Me,t);const o=new ne(this.resolveArgs(),t),s=this.patchEnvironment(o);e.set(se,o);const m=new Ie(Se(o),o.logsHome);e.set(Pe,m);const a=new ve(m.getLogLevel()),n=r.add(new we(a,[new ue(m.getLogLevel())]));e.set(E,n);const i=new le(n);e.set(F,i);const l=new de(n);i.registerProvider(u.file,l);const d=new qe(i);e.set(je,d);const g=new We(He.DELAYED,o,n,i);e.set(Re,g),e.set(xe,g);const c=new Ge(g,d,o,i,n);e.set($e,c),i.registerProvider(u.vscodeUserData,new ze(u.file,l,u.vscodeUserData,c,d,n));const p=S&&t.win32RegValueName?r.add(new Ce(n,t.win32RegValueName)):o.policyFile?r.add(new Ee(o.policyFile,i,n)):new ye;e.set(De,p);const v=new te(c.defaultProfile.settingsResource,i,p,n);e.set(re,v),e.set(I,new h(pe,void 0,!1));const w=m.createLogger("network-main",{name:f("network-main","Network (Main)"),hidden:!0});return e.set(Fe,new h(be,[w],!0)),e.set(_e,new h(Oe)),e.set(Ae,new h(Ue,void 0,!1)),e.set(Ve,new h(Be)),e.set(ke,new Ne(o,c,n)),[new fe(e,!0),s,o,v,g,a,t,c]}patchEnvironment(e){const r={VSCODE_IPC_HOOK:e.mainIPCHandle};return["VSCODE_NLS_CONFIG","VSCODE_PORTABLE"].forEach(t=>{const o=process.env[t];typeof o=="string"&&(r[t]=o)}),Object.assign(process.env,r),r}async initServices(e,r,t,o,s){await x.settled([Promise.all([this.allowWindowsUNCPath(e.extensionsPath),e.codeCachePath,e.logsHome.with({scheme:u.file}).fsPath,r.defaultProfile.globalStorageHome.with({scheme:u.file}).fsPath,e.workspaceStorageHome.with({scheme:u.file}).fsPath,e.localHistoryHome.with({scheme:u.file}).fsPath,e.backupHome].map(m=>m?D.mkdir(m,{recursive:!0}):void 0)),o.init(),t.initialize()]),r.init()}allowWindowsUNCPath(e){if(S){const r=Y(e);r&&X(r)}return e}async claimInstance(e,r,t,o,s,m){let a;try{L("code/willStartMainServer"),a=await Z(r.mainIPCHandle),L("code/didStartMainServer"),C.once(t.onWillShutdown)(()=>a.dispose())}catch(n){if(n.code!=="EADDRINUSE")throw this.handleStartupDataDirError(r,s,n),n;let i;try{i=await Q(r.mainIPCHandle,"main")}catch(c){if(!m||S||c.code!=="ECONNREFUSED")throw c.code==="EPERM"&&this.showStartupWarningDialog(f("secondInstanceAdmin","Another instance of {0} is already running as administrator.",s.nameShort),f("secondInstanceAdminDetail","Please close the other instance and try again."),s),c;try{b(r.mainIPCHandle)}catch(p){throw e.warn("Could not delete obsolete instance handle",p),p}return this.claimInstance(e,r,t,o,s,!1)}if(r.extensionTestsLocationURI&&!r.debugExtensionHost.break){const c=`Running extension tests from the command line is currently only supported if no other instance of ${s.nameShort} is running.`;throw e.error(c),i.dispose(),new Error(c)}let l;!r.args.wait&&!r.args.status&&(l=setTimeout(()=>{this.showStartupWarningDialog(f("secondInstanceNoResponse","Another instance of {0} is running but not responding",s.nameShort),f("secondInstanceNoResponseDetail","Please close all other instances and try again."),s)},1e4));const d=N.toService(i.getChannel("launch"),{disableMarshalling:!0}),g=N.toService(i.getChannel("diagnostics"),{disableMarshalling:!0});if(r.args.status)return o.invokeFunction(async()=>{const c=new ie(Te,s),p=await g.getMainDiagnostics(),v=await g.getRemoteDiagnostics({includeProcesses:!0,includeWorkspaceMetadata:!0}),w=await c.getDiagnostics(p,v);throw console.log(w),new P});throw S&&await this.windowsAllowSetForegroundWindow(d,e),e.trace("Sending env to running instance..."),await d.start(r.args,process.env),i.dispose(),l&&clearTimeout(l),new P("Sent env to running instance. Terminating...")}if(r.args.status)throw console.log(f("statusWarning","Warning: The --status argument can only be used if {0} is already running. Please run it again after {0} has started.",s.nameShort)),new P("Terminating...");return process.env.VSCODE_PID=String(process.pid),a}handleStartupDataDirError(e,r,t){if(t.code==="EACCES"||t.code==="EPERM"){const o=y([e.userDataPath,e.extensionsPath,ee]).map(s=>V(J.file(s),{os:$,tildify:e}));this.showStartupWarningDialog(f("startupDataDirError","Unable to write program user data."),f("startupUserDataAndExtensionsDirErrorDetail",`{0}

Please make sure the following directories are writeable:

{1}`,H(t),o.join(`
`)),r)}}showStartupWarningDialog(e,r,t){U.showMessageBoxSync(oe({type:"warning",buttons:[f({key:"close",comment:["&& denotes a mnemonic"]},"&&Close")],message:e,detail:r},t).options)}async windowsAllowSetForegroundWindow(e,r){if(S){const t=await e.getMainProcessId();r.trace("Sending some foreground love to the running instance:",t);try{(await import("windows-foreground-love")).allowSetForegroundWindow(t)}catch(o){r.error(o)}}}quit(e,r){const t=e.get(E),o=e.get(I);let s=0;r&&(r.isExpected?r.message&&t.trace(r.message):(s=1,r.stack?t.error(r.stack):t.error(`Startup error: ${r.toString()}`))),o.kill(s)}resolveArgs(){const e=this.validatePaths(ce(process.argv));if(e.wait&&!e.waitMarkerFilePath){const r=me(e.verbose);r&&(ae(process.argv,"--waitMarkerFilePath",r),e.waitMarkerFilePath=r)}return e}validatePaths(e){if(e["open-url"]&&(e._urls=e._,e._=[]),!e.remote){const r=this.doValidatePaths(e._,e.goto);e._=r}return e}doValidatePaths(e,r){const t=G(),o=e.map(a=>{let n=String(a),i;r&&(i=_(n),n=i.path),n&&(n=this.preparePath(t,n));const l=O(n,t),d=j(l);return d&&!T(d)?null:r&&i?(i.path=l,this.toPath(i)):l}),s=S||z,m=R(o,a=>a&&s?a.toLowerCase():a||"");return y(m)}preparePath(e,r){return S&&(r=M(r,'"')),r=k(k(r," "),"	"),S&&(r=q(e,r),r=M(r,".")),r}toPath(e){const r=[e.path];return typeof e.line=="number"&&r.push(String(e.line)),typeof e.column=="number"&&r.push(String(e.column)),r.join(":")}}const Xe=new Ke;Xe.main();
