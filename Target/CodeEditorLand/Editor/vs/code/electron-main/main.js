import"../../platform/update/common/update.config.contribution.js";import{promises as E,unlinkSync as b}from"fs";import{app as F,dialog as A}from"electron";import{coalesce as y,distinct as U}from"../../base/common/arrays.js";import{Promises as R}from"../../base/common/async.js";import{toErrorMessage as x}from"../../base/common/errorMessage.js";import{ExpectedError as w,setUnexpectedErrorHandler as H}from"../../base/common/errors.js";import{Event as D}from"../../base/common/event.js";import{isValidBasename as W,parseLineAndColumnAware as T,sanitizeFilePath as _}from"../../base/common/extpath.js";import{getPathLabel as O}from"../../base/common/labels.js";import{DisposableStore as j}from"../../base/common/lifecycle.js";import{Schemas as v}from"../../base/common/network.js";import{basename as V,resolve as B}from"../../base/common/path.js";import{mark as C}from"../../base/common/performance.js";import{OS as z,isMacintosh as q,isWindows as u}from"../../base/common/platform.js";import{cwd as $}from"../../base/common/process.js";import{rtrim as M,trim as L}from"../../base/common/strings.js";import{URI as G}from"../../base/common/uri.js";import{Promises as J}from"../../base/node/pfs.js";import{addUNCHostToAllowlist as K,getUNCHost as X}from"../../base/node/unc.js";import{ProxyChannel as N}from"../../base/parts/ipc/common/ipc.js";import{XDG_RUNTIME_DIR as Y,connect as Q,serve as Z}from"../../base/parts/ipc/node/ipc.net.js";import{localize as S}from"../../nls.js";import{IConfigurationService as ee}from"../../platform/configuration/common/configuration.js";import{ConfigurationService as re}from"../../platform/configuration/common/configurationService.js";import{DiagnosticsService as te}from"../../platform/diagnostics/node/diagnosticsService.js";import{massageMessageBoxOptions as ie}from"../../platform/dialogs/common/dialogs.js";import{EnvironmentMainService as oe,IEnvironmentMainService as ne}from"../../platform/environment/electron-main/environmentMainService.js";import{addArg as se,parseMainProcessArgv as ae}from"../../platform/environment/node/argvHelper.js";import{createWaitMarkerFileSync as ce}from"../../platform/environment/node/wait.js";import{FileService as me}from"../../platform/files/common/fileService.js";import{IFileService as k}from"../../platform/files/common/files.js";import{DiskFileSystemProvider as le}from"../../platform/files/node/diskFileSystemProvider.js";import{SyncDescriptor as h}from"../../platform/instantiation/common/descriptors.js";import{InstantiationService as de}from"../../platform/instantiation/common/instantiationService.js";import{ServiceCollection as fe}from"../../platform/instantiation/common/serviceCollection.js";import{ILifecycleMainService as P,LifecycleMainService as pe}from"../../platform/lifecycle/electron-main/lifecycleMainService.js";import{BufferLogger as ge}from"../../platform/log/common/bufferLog.js";import{ConsoleMainLogger as ve,ILogService as I,ILoggerService as ue,getLogLevel as Se}from"../../platform/log/common/log.js";import{LogService as he}from"../../platform/log/common/logService.js";import{ILoggerMainService as we,LoggerMainService as Pe}from"../../platform/log/electron-main/loggerService.js";import{FilePolicyService as Ie}from"../../platform/policy/common/filePolicyService.js";import{IPolicyService as Ee,NullPolicyService as ye}from"../../platform/policy/common/policy.js";import{NativePolicyService as De}from"../../platform/policy/node/nativePolicyService.js";import Ce from"../../platform/product/common/product.js";import{IProductService as Me}from"../../platform/product/common/productService.js";import{IProtocolMainService as Le}from"../../platform/protocol/electron-main/protocol.js";import{ProtocolMainService as Ne}from"../../platform/protocol/electron-main/protocolMainService.js";import{IRequestService as ke}from"../../platform/request/common/request.js";import{RequestService as be}from"../../platform/request/electron-utility/requestService.js";import{ISignService as Fe}from"../../platform/sign/common/sign.js";import{SignService as Ae}from"../../platform/sign/node/signService.js";import{IStateReadService as Ue,IStateService as Re}from"../../platform/state/node/state.js";import{SaveStrategy as xe,StateService as He}from"../../platform/state/node/stateService.js";import{NullTelemetryService as We}from"../../platform/telemetry/common/telemetryUtils.js";import{IThemeMainService as Te,ThemeMainService as _e}from"../../platform/theme/electron-main/themeMainService.js";import{ITunnelService as Oe}from"../../platform/tunnel/common/tunnel.js";import{TunnelService as je}from"../../platform/tunnel/node/tunnelService.js";import{IUriIdentityService as Ve}from"../../platform/uriIdentity/common/uriIdentity.js";import{UriIdentityService as Be}from"../../platform/uriIdentity/common/uriIdentityService.js";import{FileUserDataProvider as ze}from"../../platform/userData/common/fileUserDataProvider.js";import{IUserDataProfilesMainService as qe,UserDataProfilesMainService as $e}from"../../platform/userDataProfile/electron-main/userDataProfile.js";import{CodeApplication as Ge}from"./app.js";class Je{main(){try{this.startup()}catch{F.exit(1)}}async startup(){H(i=>{});const[e,r,t,o,s,l,a,n]=this.createServices();try{try{await this.initServices(t,n,o,s,a)}catch(i){throw this.handleStartupDataDirError(t,a,i),i}await e.invokeFunction(async i=>{const m=i.get(I),d=i.get(P),f=i.get(k),c=i.get(ue),p=await this.claimInstance(m,t,d,e,a,!0);return J.writeFile(t.mainLockfile,String(process.pid)).catch(g=>{m.warn(`app#startup(): Error writing main lockfile: ${g.stack}`)}),l.logger=c.createLogger("main",{name:S("mainLog","Main")}),D.once(d.onWillShutdown)(g=>{f.dispose(),o.dispose(),g.join("instanceLockfile",E.unlink(t.mainLockfile).catch(()=>{}))}),e.createInstance(Ge,p,r).startup()})}catch(i){e.invokeFunction(this.quit,i)}}createServices(){const e=new fe,r=new j;process.once("exit",()=>r.dispose());const t={_serviceBrand:void 0,...Ce};e.set(Me,t);const o=new oe(this.resolveArgs(),t),s=this.patchEnvironment(o);e.set(ne,o);const l=new Pe(Se(o),o.logsHome);e.set(we,l);const a=new ge(l.getLogLevel()),n=r.add(new he(a,[new ve(l.getLogLevel())]));e.set(I,n);const i=new me(n);e.set(k,i);const m=new le(n);i.registerProvider(v.file,m);const d=new Be(i);e.set(Ve,d);const f=new He(xe.DELAYED,o,n,i);e.set(Ue,f),e.set(Re,f);const c=new $e(f,d,o,i,n);e.set(qe,c),i.registerProvider(v.vscodeUserData,new ze(v.file,m,v.vscodeUserData,c,d,n));const p=u&&t.win32RegValueName?r.add(new De(n,t.win32RegValueName)):o.policyFile?r.add(new Ie(o.policyFile,i,n)):new ye;e.set(Ee,p);const g=new re(c.defaultProfile.settingsResource,i,p,n);return e.set(ee,g),e.set(P,new h(pe,void 0,!1)),e.set(ke,new h(be,void 0,!0)),e.set(Te,new h(_e)),e.set(Fe,new h(Ae,void 0,!1)),e.set(Oe,new h(je)),e.set(Le,new Ne(o,c,n)),[new de(e,!0),s,o,g,f,a,t,c]}patchEnvironment(e){const r={VSCODE_IPC_HOOK:e.mainIPCHandle};return["VSCODE_NLS_CONFIG","VSCODE_PORTABLE"].forEach(t=>{const o=process.env[t];typeof o=="string"&&(r[t]=o)}),Object.assign(process.env,r),r}async initServices(e,r,t,o,s){await R.settled([Promise.all([this.allowWindowsUNCPath(e.extensionsPath),e.codeCachePath,e.logsHome.with({scheme:v.file}).fsPath,r.defaultProfile.globalStorageHome.with({scheme:v.file}).fsPath,e.workspaceStorageHome.with({scheme:v.file}).fsPath,e.localHistoryHome.with({scheme:v.file}).fsPath,e.backupHome].map(l=>l?E.mkdir(l,{recursive:!0}):void 0)),o.init(),t.initialize()]),r.init()}allowWindowsUNCPath(e){if(u){const r=X(e);r&&K(r)}return e}async claimInstance(e,r,t,o,s,l){let a;try{C("code/willStartMainServer"),a=await Z(r.mainIPCHandle),C("code/didStartMainServer"),D.once(t.onWillShutdown)(()=>a.dispose())}catch(n){if(n.code!=="EADDRINUSE")throw this.handleStartupDataDirError(r,s,n),n;let i;try{i=await Q(r.mainIPCHandle,"main")}catch(c){if(!l||u||c.code!=="ECONNREFUSED")throw c.code==="EPERM"&&this.showStartupWarningDialog(S("secondInstanceAdmin","Another instance of {0} is already running as administrator.",s.nameShort),S("secondInstanceAdminDetail","Please close the other instance and try again."),s),c;try{b(r.mainIPCHandle)}catch(p){throw e.warn("Could not delete obsolete instance handle",p),p}return this.claimInstance(e,r,t,o,s,!1)}if(r.extensionTestsLocationURI&&!r.debugExtensionHost.break){const c=`Running extension tests from the command line is currently only supported if no other instance of ${s.nameShort} is running.`;throw e.error(c),i.dispose(),new Error(c)}let m;!r.args.wait&&!r.args.status&&(m=setTimeout(()=>{this.showStartupWarningDialog(S("secondInstanceNoResponse","Another instance of {0} is running but not responding",s.nameShort),S("secondInstanceNoResponseDetail","Please close all other instances and try again."),s)},1e4));const d=N.toService(i.getChannel("launch"),{disableMarshalling:!0}),f=N.toService(i.getChannel("diagnostics"),{disableMarshalling:!0});if(r.args.status)return o.invokeFunction(async()=>{const c=new te(We,s),p=await f.getMainDiagnostics(),g=await f.getRemoteDiagnostics({includeProcesses:!0,includeWorkspaceMetadata:!0}),Ye=await c.getDiagnostics(p,g);throw new w});throw u&&await this.windowsAllowSetForegroundWindow(d,e),e.trace("Sending env to running instance..."),await d.start(r.args,process.env),i.dispose(),m&&clearTimeout(m),new w("Sent env to running instance. Terminating...")}if(r.args.status)throw new w("Terminating...");return process.env.VSCODE_PID=String(process.pid),a}handleStartupDataDirError(e,r,t){if(t.code==="EACCES"||t.code==="EPERM"){const o=y([e.userDataPath,e.extensionsPath,Y]).map(s=>O(G.file(s),{os:z,tildify:e}));this.showStartupWarningDialog(S("startupDataDirError","Unable to write program user data."),S("startupUserDataAndExtensionsDirErrorDetail",`{0}

Please make sure the following directories are writeable:

{1}`,x(t),o.join(`
`)),r)}}showStartupWarningDialog(e,r,t){A.showMessageBoxSync(ie({type:"warning",buttons:[S({key:"close",comment:["&& denotes a mnemonic"]},"&&Close")],message:e,detail:r},t).options)}async windowsAllowSetForegroundWindow(e,r){if(u){const t=await e.getMainProcessId();r.trace("Sending some foreground love to the running instance:",t);try{(await import("windows-foreground-love")).allowSetForegroundWindow(t)}catch(o){r.error(o)}}}quit(e,r){const t=e.get(I),o=e.get(P);let s=0;r&&(r.isExpected?r.message&&t.trace(r.message):(s=1,r.stack?t.error(r.stack):t.error(`Startup error: ${r.toString()}`))),o.kill(s)}resolveArgs(){const e=this.validatePaths(ae(process.argv));if(e.wait&&!e.waitMarkerFilePath){const r=ce(e.verbose);r&&(se(process.argv,"--waitMarkerFilePath",r),e.waitMarkerFilePath=r)}return e}validatePaths(e){if(e["open-url"]&&(e._urls=e._,e._=[]),!e.remote){const r=this.doValidatePaths(e._,e.goto);e._=r}return e}doValidatePaths(e,r){const t=$(),o=e.map(a=>{let n=String(a),i;r&&(i=T(n),n=i.path),n&&(n=this.preparePath(t,n));const m=_(n,t),d=V(m);return d&&!W(d)?null:r&&i?(i.path=m,this.toPath(i)):m}),s=u||q,l=U(o,a=>a&&s?a.toLowerCase():a||"");return y(l)}preparePath(e,r){return u&&(r=M(r,'"')),r=L(L(r," "),"	"),u&&(r=B(e,r),r=M(r,".")),r}toPath(e){const r=[e.path];return typeof e.line=="number"&&r.push(String(e.line)),typeof e.column=="number"&&r.push(String(e.column)),r.join(":")}}const Ke=new Je;Ke.main();
