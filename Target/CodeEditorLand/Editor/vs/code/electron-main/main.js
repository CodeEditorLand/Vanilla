import"../../platform/update/common/update.config.contribution.js";import{app as F,dialog as b}from"electron";import{unlinkSync as A,promises as E}from"fs";import{URI as U}from"../../base/common/uri.js";import{coalesce as D,distinct as R}from"../../base/common/arrays.js";import{Promises as x}from"../../base/common/async.js";import{toErrorMessage as H}from"../../base/common/errorMessage.js";import{ExpectedError as w,setUnexpectedErrorHandler as W}from"../../base/common/errors.js";import{isValidBasename as T,parseLineAndColumnAware as _,sanitizeFilePath as O}from"../../base/common/extpath.js";import{Event as y}from"../../base/common/event.js";import{getPathLabel as V}from"../../base/common/labels.js";import{Schemas as u}from"../../base/common/network.js";import{basename as B,resolve as z}from"../../base/common/path.js";import{mark as C}from"../../base/common/performance.js";import{isMacintosh as j,isWindows as v,OS as q}from"../../base/common/platform.js";import{cwd as $}from"../../base/common/process.js";import{rtrim as M,trim as L}from"../../base/common/strings.js";import{Promises as G}from"../../base/node/pfs.js";import{ProxyChannel as N}from"../../base/parts/ipc/common/ipc.js";import"../../base/parts/ipc/common/ipc.net.js";import{connect as J,serve as K,XDG_RUNTIME_DIR as X}from"../../base/parts/ipc/node/ipc.net.js";import{CodeApplication as Y}from"./app.js";import{localize as S}from"../../nls.js";import{IConfigurationService as Q}from"../../platform/configuration/common/configuration.js";import{ConfigurationService as Z}from"../../platform/configuration/common/configurationService.js";import"../../platform/diagnostics/electron-main/diagnosticsMainService.js";import{DiagnosticsService as ee}from"../../platform/diagnostics/node/diagnosticsService.js";import"../../platform/environment/common/argv.js";import{EnvironmentMainService as re,IEnvironmentMainService as ie}from"../../platform/environment/electron-main/environmentMainService.js";import{addArg as te,parseMainProcessArgv as oe}from"../../platform/environment/node/argvHelper.js";import{createWaitMarkerFileSync as ne}from"../../platform/environment/node/wait.js";import{IFileService as k}from"../../platform/files/common/files.js";import{FileService as se}from"../../platform/files/common/fileService.js";import{DiskFileSystemProvider as ae}from"../../platform/files/node/diskFileSystemProvider.js";import{SyncDescriptor as h}from"../../platform/instantiation/common/descriptors.js";import"../../platform/instantiation/common/instantiation.js";import{InstantiationService as ce}from"../../platform/instantiation/common/instantiationService.js";import{ServiceCollection as me}from"../../platform/instantiation/common/serviceCollection.js";import"../../platform/launch/electron-main/launchMainService.js";import{ILifecycleMainService as P,LifecycleMainService as le}from"../../platform/lifecycle/electron-main/lifecycleMainService.js";import{BufferLogger as de}from"../../platform/log/common/bufferLog.js";import{ConsoleMainLogger as fe,getLogLevel as ge,ILoggerService as pe,ILogService as I}from"../../platform/log/common/log.js";import ue from"../../platform/product/common/product.js";import{IProductService as ve}from"../../platform/product/common/productService.js";import{IProtocolMainService as Se}from"../../platform/protocol/electron-main/protocol.js";import{ProtocolMainService as he}from"../../platform/protocol/electron-main/protocolMainService.js";import{ITunnelService as we}from"../../platform/tunnel/common/tunnel.js";import{TunnelService as Pe}from"../../platform/tunnel/node/tunnelService.js";import{IRequestService as Ie}from"../../platform/request/common/request.js";import{RequestService as Ee}from"../../platform/request/electron-utility/requestService.js";import{ISignService as De}from"../../platform/sign/common/sign.js";import{SignService as ye}from"../../platform/sign/node/signService.js";import{IStateReadService as Ce,IStateService as Me}from"../../platform/state/node/state.js";import{NullTelemetryService as Le}from"../../platform/telemetry/common/telemetryUtils.js";import{IThemeMainService as Ne,ThemeMainService as ke}from"../../platform/theme/electron-main/themeMainService.js";import{IUserDataProfilesMainService as Fe,UserDataProfilesMainService as be}from"../../platform/userDataProfile/electron-main/userDataProfile.js";import{IPolicyService as Ae,NullPolicyService as Ue}from"../../platform/policy/common/policy.js";import{NativePolicyService as Re}from"../../platform/policy/node/nativePolicyService.js";import{FilePolicyService as xe}from"../../platform/policy/common/filePolicyService.js";import{DisposableStore as He}from"../../base/common/lifecycle.js";import{IUriIdentityService as We}from"../../platform/uriIdentity/common/uriIdentity.js";import{UriIdentityService as Te}from"../../platform/uriIdentity/common/uriIdentityService.js";import{ILoggerMainService as _e,LoggerMainService as Oe}from"../../platform/log/electron-main/loggerService.js";import{LogService as Ve}from"../../platform/log/common/logService.js";import{massageMessageBoxOptions as Be}from"../../platform/dialogs/common/dialogs.js";import{SaveStrategy as ze,StateService as je}from"../../platform/state/node/stateService.js";import{FileUserDataProvider as qe}from"../../platform/userData/common/fileUserDataProvider.js";import{addUNCHostToAllowlist as $e,getUNCHost as Ge}from"../../base/node/unc.js";class Je{main(){try{this.startup()}catch{F.exit(1)}}async startup(){W(t=>{});const[e,r,i,o,s,l,a,n]=this.createServices();try{try{await this.initServices(i,n,o,s,a)}catch(t){throw this.handleStartupDataDirError(i,a,t),t}await e.invokeFunction(async t=>{const m=t.get(I),d=t.get(P),f=t.get(k),c=t.get(pe),g=await this.claimInstance(m,i,d,e,a,!0);return G.writeFile(i.mainLockfile,String(process.pid)).catch(p=>{m.warn(`app#startup(): Error writing main lockfile: ${p.stack}`)}),l.logger=c.createLogger("main",{name:S("mainLog","Main")}),y.once(d.onWillShutdown)(p=>{f.dispose(),o.dispose(),p.join("instanceLockfile",E.unlink(i.mainLockfile).catch(()=>{}))}),e.createInstance(Y,g,r).startup()})}catch(t){e.invokeFunction(this.quit,t)}}createServices(){const e=new me,r=new He;process.once("exit",()=>r.dispose());const i={_serviceBrand:void 0,...ue};e.set(ve,i);const o=new re(this.resolveArgs(),i),s=this.patchEnvironment(o);e.set(ie,o);const l=new Oe(ge(o),o.logsHome);e.set(_e,l);const a=new de(l.getLogLevel()),n=r.add(new Ve(a,[new fe(l.getLogLevel())]));e.set(I,n);const t=new se(n);e.set(k,t);const m=new ae(n);t.registerProvider(u.file,m);const d=new Te(t);e.set(We,d);const f=new je(ze.DELAYED,o,n,t);e.set(Ce,f),e.set(Me,f);const c=new be(f,d,o,t,n);e.set(Fe,c),t.registerProvider(u.vscodeUserData,new qe(u.file,m,u.vscodeUserData,c,d,n));const g=v&&i.win32RegValueName?r.add(new Re(n,i.win32RegValueName)):o.policyFile?r.add(new xe(o.policyFile,t,n)):new Ue;e.set(Ae,g);const p=new Z(c.defaultProfile.settingsResource,t,g,n);return e.set(Q,p),e.set(P,new h(le,void 0,!1)),e.set(Ie,new h(Ee,void 0,!0)),e.set(Ne,new h(ke)),e.set(De,new h(ye,void 0,!1)),e.set(we,new h(Pe)),e.set(Se,new he(o,c,n)),[new ce(e,!0),s,o,p,f,a,i,c]}patchEnvironment(e){const r={VSCODE_IPC_HOOK:e.mainIPCHandle};return["VSCODE_NLS_CONFIG","VSCODE_PORTABLE"].forEach(i=>{const o=process.env[i];typeof o=="string"&&(r[i]=o)}),Object.assign(process.env,r),r}async initServices(e,r,i,o,s){await x.settled([Promise.all([this.allowWindowsUNCPath(e.extensionsPath),e.codeCachePath,e.logsHome.with({scheme:u.file}).fsPath,r.defaultProfile.globalStorageHome.with({scheme:u.file}).fsPath,e.workspaceStorageHome.with({scheme:u.file}).fsPath,e.localHistoryHome.with({scheme:u.file}).fsPath,e.backupHome].map(l=>l?E.mkdir(l,{recursive:!0}):void 0)),o.init(),i.initialize()]),r.init()}allowWindowsUNCPath(e){if(v){const r=Ge(e);r&&$e(r)}return e}async claimInstance(e,r,i,o,s,l){let a;try{C("code/willStartMainServer"),a=await K(r.mainIPCHandle),C("code/didStartMainServer"),y.once(i.onWillShutdown)(()=>a.dispose())}catch(n){if(n.code!=="EADDRINUSE")throw this.handleStartupDataDirError(r,s,n),n;let t;try{t=await J(r.mainIPCHandle,"main")}catch(c){if(!l||v||c.code!=="ECONNREFUSED")throw c.code==="EPERM"&&this.showStartupWarningDialog(S("secondInstanceAdmin","Another instance of {0} is already running as administrator.",s.nameShort),S("secondInstanceAdminDetail","Please close the other instance and try again."),s),c;try{A(r.mainIPCHandle)}catch(g){throw e.warn("Could not delete obsolete instance handle",g),g}return this.claimInstance(e,r,i,o,s,!1)}if(r.extensionTestsLocationURI&&!r.debugExtensionHost.break){const c=`Running extension tests from the command line is currently only supported if no other instance of ${s.nameShort} is running.`;throw e.error(c),t.dispose(),new Error(c)}let m;!r.args.wait&&!r.args.status&&(m=setTimeout(()=>{this.showStartupWarningDialog(S("secondInstanceNoResponse","Another instance of {0} is running but not responding",s.nameShort),S("secondInstanceNoResponseDetail","Please close all other instances and try again."),s)},1e4));const d=N.toService(t.getChannel("launch"),{disableMarshalling:!0}),f=N.toService(t.getChannel("diagnostics"),{disableMarshalling:!0});if(r.args.status)return o.invokeFunction(async()=>{const c=new ee(Le,s),g=await f.getMainDiagnostics(),p=await f.getRemoteDiagnostics({includeProcesses:!0,includeWorkspaceMetadata:!0}),Ye=await c.getDiagnostics(g,p);throw new w});throw v&&await this.windowsAllowSetForegroundWindow(d,e),e.trace("Sending env to running instance..."),await d.start(r.args,process.env),t.dispose(),m&&clearTimeout(m),new w("Sent env to running instance. Terminating...")}if(r.args.status)throw new w("Terminating...");return process.env.VSCODE_PID=String(process.pid),a}handleStartupDataDirError(e,r,i){if(i.code==="EACCES"||i.code==="EPERM"){const o=D([e.userDataPath,e.extensionsPath,X]).map(s=>V(U.file(s),{os:q,tildify:e}));this.showStartupWarningDialog(S("startupDataDirError","Unable to write program user data."),S("startupUserDataAndExtensionsDirErrorDetail",`{0}

Please make sure the following directories are writeable:

{1}`,H(i),o.join(`
`)),r)}}showStartupWarningDialog(e,r,i){b.showMessageBoxSync(Be({type:"warning",buttons:[S({key:"close",comment:["&& denotes a mnemonic"]},"&&Close")],message:e,detail:r},i).options)}async windowsAllowSetForegroundWindow(e,r){if(v){const i=await e.getMainProcessId();r.trace("Sending some foreground love to the running instance:",i);try{(await import("windows-foreground-love")).allowSetForegroundWindow(i)}catch(o){r.error(o)}}}quit(e,r){const i=e.get(I),o=e.get(P);let s=0;r&&(r.isExpected?r.message&&i.trace(r.message):(s=1,r.stack?i.error(r.stack):i.error(`Startup error: ${r.toString()}`))),o.kill(s)}resolveArgs(){const e=this.validatePaths(oe(process.argv));if(e.wait&&!e.waitMarkerFilePath){const r=ne(e.verbose);r&&(te(process.argv,"--waitMarkerFilePath",r),e.waitMarkerFilePath=r)}return e}validatePaths(e){if(e["open-url"]&&(e._urls=e._,e._=[]),!e.remote){const r=this.doValidatePaths(e._,e.goto);e._=r}return e}doValidatePaths(e,r){const i=$(),o=e.map(a=>{let n=String(a),t;r&&(t=_(n),n=t.path),n&&(n=this.preparePath(i,n));const m=O(n,i),d=B(m);return d&&!T(d)?null:r&&t?(t.path=m,this.toPath(t)):m}),s=v||j,l=R(o,a=>a&&s?a.toLowerCase():a||"");return D(l)}preparePath(e,r){return v&&(r=M(r,'"')),r=L(L(r," "),"	"),v&&(r=z(e,r),r=M(r,".")),r}toPath(e){const r=[e.path];return typeof e.line=="number"&&r.push(String(e.line)),typeof e.column=="number"&&r.push(String(e.column)),r.join(":")}}const Ke=new Je;Ke.main();
