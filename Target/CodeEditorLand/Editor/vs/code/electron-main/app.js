var Oe=Object.defineProperty;var Le=Object.getOwnPropertyDescriptor;var z=(L,C,i,t)=>{for(var n=t>1?void 0:t?Le(C,i):C,e=L.length-1,r;e>=0;e--)(r=L[e])&&(n=(t?r(C,i,n):r(n))||n);return t&&n&&Oe(C,i,n),n},y=(L,C)=>(i,t)=>C(i,t,L);import{hostname as Ee,release as xe}from"os";import{app as R,BrowserWindow as Te,protocol as j,session as U,systemPreferences as J}from"electron";import{Promises as ke,RunOnceScheduler as Ne,runWhenGlobalIdle as Ae}from"../../base/common/async.js";import{VSBuffer as Z}from"../../base/common/buffer.js";import{toErrorMessage as Fe}from"../../base/common/errorMessage.js";import{isSigPipeError as He,onUnexpectedError as Q,setUnexpectedErrorHandler as De}from"../../base/common/errors.js";import{Event as F}from"../../base/common/event.js";import{parse as _e}from"../../base/common/jsonc.js";import{getPathLabel as H}from"../../base/common/labels.js";import{Lazy as qe}from"../../base/common/lazy.js";import{Disposable as Be,DisposableStore as $e}from"../../base/common/lifecycle.js";import{Schemas as v,VSCODE_AUTHORITY as Ke}from"../../base/common/network.js";import{normalizeNFC as X}from"../../base/common/normalization.js";import{join as Ve,posix as Ge}from"../../base/common/path.js";import{isLinux as Ye,isLinuxSnap as ze,isMacintosh as E,isWindows as x,OS as D}from"../../base/common/platform.js";import{assertType as je}from"../../base/common/types.js";import{URI as w}from"../../base/common/uri.js";import{generateUuid as Je}from"../../base/common/uuid.js";import{addUNCHostToAllowlist as Ze,disableUNCAccessRestrictions as Qe}from"../../base/node/unc.js";import{registerContextMenuListener as Xe}from"../../base/parts/contextmenu/electron-main/contextmenu.js";import{getDelayedChannel as ee,ProxyChannel as h,StaticRouter as er}from"../../base/parts/ipc/common/ipc.js";import{Server as rr}from"../../base/parts/ipc/electron-main/ipc.electron.js";import{Client as ir}from"../../base/parts/ipc/electron-main/ipc.mp.js";import{validatedIpcMain as W}from"../../base/parts/ipc/electron-main/ipcMain.js";import"../../base/parts/ipc/node/ipc.net.js";import{localize as M}from"../../nls.js";import{IAuxiliaryWindowsMainService as re}from"../../platform/auxiliaryWindow/electron-main/auxiliaryWindows.js";import{AuxiliaryWindowsMainService as tr}from"../../platform/auxiliaryWindow/electron-main/auxiliaryWindowsMainService.js";import{IBackupMainService as nr}from"../../platform/backup/electron-main/backup.js";import{BackupMainService as or}from"../../platform/backup/electron-main/backupMainService.js";import{IConfigurationService as sr}from"../../platform/configuration/common/configuration.js";import{CSSDevelopmentService as ar,ICSSDevelopmentService as cr}from"../../platform/cssDev/node/cssDevService.js";import{ElectronExtensionHostDebugBroadcastChannel as lr}from"../../platform/debug/electron-main/extensionHostDebugIpc.js";import{IDiagnosticsService as dr}from"../../platform/diagnostics/common/diagnostics.js";import{DiagnosticsMainService as pr,IDiagnosticsMainService as ie}from"../../platform/diagnostics/electron-main/diagnosticsMainService.js";import{DialogMainService as vr,IDialogMainService as te}from"../../platform/dialogs/electron-main/dialogMainService.js";import{IEncryptionMainService as ne}from"../../platform/encryption/common/encryptionService.js";import{EncryptionMainService as mr}from"../../platform/encryption/electron-main/encryptionMainService.js";import"../../platform/environment/common/argv.js";import{IEnvironmentMainService as hr}from"../../platform/environment/electron-main/environmentMainService.js";import{isLaunchedFromCli as ur}from"../../platform/environment/node/argvHelper.js";import{IExtensionsProfileScannerService as fr}from"../../platform/extensionManagement/common/extensionsProfileScannerService.js";import{IExtensionsScannerService as Sr}from"../../platform/extensionManagement/common/extensionsScannerService.js";import{ExtensionsProfileScannerService as gr}from"../../platform/extensionManagement/node/extensionsProfileScannerService.js";import{ExtensionsScannerService as wr}from"../../platform/extensionManagement/node/extensionsScannerService.js";import{IExtensionHostStarter as oe,ipcExtensionHostStarterChannelName as yr}from"../../platform/extensions/common/extensionHostStarter.js";import{ExtensionHostStarter as Mr}from"../../platform/extensions/electron-main/extensionHostStarter.js";import{IExternalTerminalMainService as T}from"../../platform/externalTerminal/electron-main/externalTerminal.js";import{LinuxExternalTerminalService as Ir,MacExternalTerminalService as Cr,WindowsExternalTerminalService as Pr}from"../../platform/externalTerminal/node/externalTerminalService.js";import{LOCAL_FILE_SYSTEM_CHANNEL_NAME as se}from"../../platform/files/common/diskFileSystemProviderClient.js";import{IFileService as Rr}from"../../platform/files/common/files.js";import{DiskFileSystemProviderChannel as Ur}from"../../platform/files/electron-main/diskFileSystemProviderServer.js";import{DiskFileSystemProvider as br}from"../../platform/files/node/diskFileSystemProvider.js";import{SyncDescriptor as p}from"../../platform/instantiation/common/descriptors.js";import{IInstantiationService as Wr}from"../../platform/instantiation/common/instantiation.js";import{ServiceCollection as Or}from"../../platform/instantiation/common/serviceCollection.js";import{IIssueMainService as ae,IProcessMainService as ce}from"../../platform/issue/common/issue.js";import{IssueMainService as Lr}from"../../platform/issue/electron-main/issueMainService.js";import{ProcessMainService as Er}from"../../platform/issue/electron-main/processMainService.js";import{IKeyboardLayoutMainService as le,KeyboardLayoutMainService as xr}from"../../platform/keyboardLayout/electron-main/keyboardLayoutMainService.js";import{ILaunchMainService as de,LaunchMainService as Tr}from"../../platform/launch/electron-main/launchMainService.js";import{ILifecycleMainService as kr,LifecycleMainPhase as _,ShutdownReason as Nr}from"../../platform/lifecycle/electron-main/lifecycleMainService.js";import{ILoggerService as Ar,ILogService as Fr}from"../../platform/log/common/log.js";import{ILoggerMainService as Hr}from"../../platform/log/electron-main/loggerService.js";import{LoggerChannel as Dr}from"../../platform/log/electron-main/logIpc.js";import{IMenubarMainService as pe,MenubarMainService as _r}from"../../platform/menubar/electron-main/menubarMainService.js";import{IProxyAuthService as ve,ProxyAuthService as qr}from"../../platform/native/electron-main/auth.js";import{INativeHostMainService as q,NativeHostMainService as Br}from"../../platform/native/electron-main/nativeHostMainService.js";import{IPolicyService as $r}from"../../platform/policy/common/policy.js";import{PolicyChannel as Kr}from"../../platform/policy/common/policyIpc.js";import{IProductService as Vr}from"../../platform/product/common/productService.js";import{NODE_REMOTE_RESOURCE_CHANNEL_NAME as Gr,NODE_REMOTE_RESOURCE_IPC_METHOD_NAME as Yr,NodeRemoteResourceRouter as zr}from"../../platform/remote/common/electronRemoteResources.js";import{getRemoteAuthority as jr}from"../../platform/remote/common/remoteHosts.js";import{IRequestService as Jr}from"../../platform/request/common/request.js";import{RequestChannel as Zr}from"../../platform/request/common/requestIpc.js";import{SharedProcess as Qr}from"../../platform/sharedProcess/electron-main/sharedProcess.js";import{getResolvedShellEnv as Xr}from"../../platform/shell/node/shellEnv.js";import{ISignService as ei}from"../../platform/sign/common/sign.js";import{IStateService as ri}from"../../platform/state/node/state.js";import{StorageDatabaseChannel as ii}from"../../platform/storage/electron-main/storageIpc.js";import{ApplicationStorageMainService as ti,IApplicationStorageMainService as ni,IStorageMainService as B,StorageMainService as oi}from"../../platform/storage/electron-main/storageMainService.js";import{resolveCommonProperties as si}from"../../platform/telemetry/common/commonProperties.js";import{ITelemetryService as me,TelemetryLevel as ai}from"../../platform/telemetry/common/telemetry.js";import{TelemetryAppenderClient as ci}from"../../platform/telemetry/common/telemetryIpc.js";import{TelemetryService as li}from"../../platform/telemetry/common/telemetryService.js";import{getPiiPathsFromEnvironment as di,getTelemetryLevel as pi,isInternalTelemetry as vi,NullTelemetryService as mi,supportsTelemetry as hi}from"../../platform/telemetry/common/telemetryUtils.js";import{resolvedevDeviceId as ui,resolveMachineId as fi,resolveSqmId as Si}from"../../platform/telemetry/electron-main/telemetryUtils.js";import{ILocalPtyService as he,LocalReconnectConstants as ue,TerminalIpcChannels as gi,TerminalSettingId as wi}from"../../platform/terminal/common/terminal.js";import{ElectronPtyHostStarter as yi}from"../../platform/terminal/electron-main/electronPtyHostStarter.js";import{PtyHostService as Mi}from"../../platform/terminal/node/ptyHostService.js";import{IUpdateService as O}from"../../platform/update/common/update.js";import{UpdateChannel as Ii}from"../../platform/update/common/updateIpc.js";import{DarwinUpdateService as Ci}from"../../platform/update/electron-main/updateService.darwin.js";import{LinuxUpdateService as Pi}from"../../platform/update/electron-main/updateService.linux.js";import{SnapUpdateService as Ri}from"../../platform/update/electron-main/updateService.snap.js";import{Win32UpdateService as Ui}from"../../platform/update/electron-main/updateService.win32.js";import{IURLService as $}from"../../platform/url/common/url.js";import{URLHandlerChannelClient as bi,URLHandlerRouter as Wi}from"../../platform/url/common/urlIpc.js";import{NativeURLService as Oi}from"../../platform/url/common/urlService.js";import{ElectronURLListener as Li}from"../../platform/url/electron-main/electronUrlListener.js";import"../../platform/url/electron-main/url.js";import{IUserDataProfilesMainService as K}from"../../platform/userDataProfile/electron-main/userDataProfile.js";import{UserDataProfilesHandler as Ei}from"../../platform/userDataProfile/electron-main/userDataProfilesHandler.js";import{ProfileStorageChangesListenerChannel as xi}from"../../platform/userDataProfile/electron-main/userDataProfileStorageIpc.js";import{ipcUtilityProcessWorkerChannelName as Ti}from"../../platform/utilityProcess/common/utilityProcessWorkerService.js";import{IUtilityProcessWorkerMainService as fe,UtilityProcessWorkerMainService as ki}from"../../platform/utilityProcess/electron-main/utilityProcessWorkerMainService.js";import{IWebviewManagerService as Se}from"../../platform/webview/common/webviewManagerService.js";import{WebviewMainService as Ni}from"../../platform/webview/electron-main/webviewMainService.js";import{isFolderToOpen as Ai,isWorkspaceToOpen as Fi}from"../../platform/window/common/window.js";import"../../platform/window/electron-main/window.js";import{IWindowsMainService as k,OpenContext as I}from"../../platform/windows/electron-main/windows.js";import{WindowsMainService as Hi}from"../../platform/windows/electron-main/windowsMainService.js";import{ActiveWindowManager as Di}from"../../platform/windows/node/windowTracker.js";import{hasWorkspaceFileExtension as N}from"../../platform/workspace/common/workspace.js";import{IWorkspacesService as ge}from"../../platform/workspaces/common/workspaces.js";import{IWorkspacesHistoryMainService as _i,WorkspacesHistoryMainService as qi}from"../../platform/workspaces/electron-main/workspacesHistoryMainService.js";import{WorkspacesMainService as Bi}from"../../platform/workspaces/electron-main/workspacesMainService.js";import{IWorkspacesManagementMainService as $i,WorkspacesManagementMainService as Ki}from"../../platform/workspaces/electron-main/workspacesManagementMainService.js";let b=class extends Be{constructor(i,t,n,e,r,a,l,d,o,c,s,m){super();this.mainProcessNodeIpcServer=i;this.userEnv=t;this.mainInstantiationService=n;this.logService=e;this.loggerService=r;this.environmentMainService=a;this.lifecycleMainService=l;this.configurationService=d;this.stateService=o;this.fileService=c;this.productService=s;this.userDataProfilesMainService=m;this.configureSession(),this.registerListeners()}static SECURITY_PROTOCOL_HANDLING_CONFIRMATION_SETTING_KEY={[v.file]:"security.promptForLocalFileProtocolHandling",[v.vscodeRemote]:"security.promptForRemoteFileProtocolHandling"};windowsMainService;auxiliaryWindowsMainService;nativeHostMainService;configureSession(){const i=o=>o?.startsWith(`${v.vscodeWebview}://`),t=new Set(["clipboard-read","clipboard-sanitized-write"]);U.defaultSession.setPermissionRequestHandler((o,c,s,m)=>i(m.requestingUrl)?s(t.has(c)):s(!1)),U.defaultSession.setPermissionCheckHandler((o,c,s,m)=>i(m.requestingUrl)?t.has(c):!1);const n=new Set([v.file,v.vscodeFileResource,v.vscodeRemoteResource,v.vscodeManagedRemoteResource,"devtools"]),e=o=>{for(let c=o;c;c=c.parent)if(c.url.startsWith(`${v.vscodeWebview}://`))return!0;return!1},r=o=>o.resourceType==="xhr"||e(o.frame),a=o=>{const c=o.frame;if(!c||!this.windowsMainService)return!1;const s=Te.getAllWindows();for(const m of s)if(c.processId===m.webContents.mainFrame.processId)return!0;return!1},l=(o,c)=>{if(o.path!=="/index.html")return!0;const s=c.frame;if(!s||!this.windowsMainService)return!1;for(const m of this.windowsMainService.getWindows())if(m.win&&s.processId===m.win.webContents.mainFrame.processId)return!0;return!1};U.defaultSession.webRequest.onBeforeRequest((o,c)=>{const s=w.parse(o.url);return s.scheme===v.vscodeWebview&&!l(s,o)?(this.logService.error("Blocked vscode-webview request",o.url),c({cancel:!0})):s.scheme===v.vscodeFileResource&&!a(o)?(this.logService.error("Blocked vscode-file request",o.url),c({cancel:!0})):s.path.endsWith(".svg")&&!n.has(s.scheme)?c({cancel:!r(o)}):c({cancel:!1})}),U.defaultSession.webRequest.onHeadersReceived((o,c)=>{const s=o.responseHeaders,m=s["content-type"]||s["Content-Type"];if(m&&Array.isArray(m)){const u=w.parse(o.url);if(u.path.endsWith(".svg")&&n.has(u.scheme))return s["Content-Type"]=["image/svg+xml"],c({cancel:!1,responseHeaders:s});if(!u.path.endsWith(v.vscodeRemoteResource)&&m.some(g=>g.toLowerCase().includes("image/svg")))return c({cancel:!r(o)})}return c({cancel:!1})}),U.defaultSession.webRequest.onHeadersReceived((o,c)=>{if(o.url.startsWith("https://vscode.download.prss.microsoft.com/")){const s=o.responseHeaders??Object.create(null);if(s["Access-Control-Allow-Origin"]===void 0)return s["Access-Control-Allow-Origin"]=["*"],c({cancel:!1,responseHeaders:s})}return c({cancel:!1})});const d=U.defaultSession;typeof d.setCodeCachePath=="function"&&this.environmentMainService.codeCachePath&&d.setCodeCachePath(Ve(this.environmentMainService.codeCachePath,"chrome")),x&&(this.configurationService.getValue("security.restrictUNCAccess")===!1?Qe():Ze(this.configurationService.getValue("security.allowedUNCHosts")))}registerListeners(){De(n=>this.onUnexpectedError(n)),process.on("uncaughtException",n=>{He(n)||Q(n)}),process.on("unhandledRejection",n=>Q(n)),F.once(this.lifecycleMainService.onWillShutdown)(()=>this.dispose()),Xe(),R.on("accessibility-support-changed",(n,e)=>{this.windowsMainService?.sendToAll("vscode:accessibilitySupportChanged",e)}),R.on("activate",async(n,e)=>{this.logService.trace("app#activate"),e||await this.windowsMainService?.openEmptyWindow({context:I.DOCK})}),R.on("web-contents-created",(n,e)=>{e?.opener?.url.startsWith(`${v.vscodeFileResource}://${Ke}/`)&&(this.logService.trace('[aux window]  app.on("web-contents-created"): Registering auxiliary window'),this.auxiliaryWindowsMainService?.registerWindow(e)),e.on("will-navigate",r=>{this.logService.error("webContents#will-navigate: Prevented webcontent navigation"),r.preventDefault()}),e.setWindowOpenHandler(r=>r.url==="about:blank"?(this.logService.trace("[aux window] webContents#setWindowOpenHandler: Allowing auxiliary window to open on about:blank"),{action:"allow",overrideBrowserWindowOptions:this.auxiliaryWindowsMainService?.createWindow(r)}):(this.logService.trace(`webContents#setWindowOpenHandler: Prevented opening window with URL ${r.url}}`),this.nativeHostMainService?.openExternal(void 0,r.url),{action:"deny"}))});let i=[],t;R.on("open-file",(n,e)=>{e=X(e),this.logService.trace("app#open-file: ",e),n.preventDefault(),i.push(N(e)?{workspaceUri:w.file(e)}:{fileUri:w.file(e)}),t!==void 0&&(clearTimeout(t),t=void 0),t=setTimeout(async()=>{await this.windowsMainService?.open({context:I.DOCK,cli:this.environmentMainService.args,urisToOpen:i,gotoLineMode:!1,preferNewWindow:!0}),i=[],t=void 0},100)}),R.on("new-window-for-tab",async()=>{await this.windowsMainService?.openEmptyWindow({context:I.DESKTOP})}),W.handle("vscode:fetchShellEnv",n=>{const e=this.windowsMainService?.getWindowByWebContents(n.sender);let r,a;return e?.config?(r=e.config,a={...process.env,...e.config.userEnv}):(r=this.environmentMainService.args,a=process.env),this.resolveShellEnvironment(r,a,!1)}),W.on("vscode:toggleDevTools",n=>n.sender.toggleDevTools()),W.on("vscode:openDevTools",n=>n.sender.openDevTools()),W.on("vscode:reloadWindow",n=>n.sender.reload()),W.handle("vscode:notifyZoomLevel",async(n,e)=>{const r=this.windowsMainService?.getWindowByWebContents(n.sender);r&&r.notifyZoomLevel(e)})}onUnexpectedError(i){if(i){const t={message:`[uncaught exception in main]: ${i.message}`,stack:i.stack};this.windowsMainService?.sendToFocused("vscode:reportError",JSON.stringify(t))}this.logService.error(`[uncaught exception in main]: ${i}`),i.stack&&this.logService.error(i.stack)}async startup(){this.logService.debug("Starting VS Code"),this.logService.debug(`from: ${this.environmentMainService.appRoot}`),this.logService.debug("args:",this.environmentMainService.args);const i=this.productService.win32AppUserModelId;x&&i&&R.setAppUserModelId(i);try{E&&this.configurationService.getValue("window.nativeTabs")===!0&&!J.getUserDefault("NSUseImprovedLayoutPass","boolean")&&J.setUserDefault("NSUseImprovedLayoutPass","boolean",!0)}catch(s){this.logService.error(s)}const t=new rr;F.once(this.lifecycleMainService.onWillShutdown)(s=>{s.reason===Nr.KILL&&t.dispose()}),this.logService.trace("Resolving machine identifier...");const[n,e,r]=await Promise.all([fi(this.stateService,this.logService),Si(this.stateService,this.logService),ui(this.stateService,this.logService)]);this.logService.trace(`Resolved machine identifier: ${n}`);const{sharedProcessReady:a,sharedProcessClient:l}=this.setupSharedProcess(n,e,r),d=await this.initServices(n,e,r,a);d.invokeFunction(s=>s.get(ve)),this._register(d.createInstance(Ei)),d.invokeFunction(s=>this.initChannels(s,t,l));const o=await d.invokeFunction(s=>this.setupProtocolUrlHandlers(s,t));this.setupManagedRemoteResourceUrlHandler(t),this.lifecycleMainService.phase=_.Ready,await d.invokeFunction(s=>this.openFirstWindow(s,o)),this.lifecycleMainService.phase=_.AfterWindowOpen,this.afterWindowOpen(),this._register(new Ne(()=>{this._register(Ae(()=>this.lifecycleMainService.phase=_.Eventually,2500))},2500)).schedule()}async setupProtocolUrlHandlers(i,t){const n=this.windowsMainService=i.get(k),e=i.get($),r=this.nativeHostMainService=i.get(q),a=i.get(te),l=this;e.registerHandler({async handleURL(u,g){return l.handleProtocolUrl(n,a,e,u,g)}});const d=this._register(new Di({onDidOpenMainWindow:r.onDidOpenMainWindow,onDidFocusMainWindow:r.onDidFocusMainWindow,getActiveWindowId:()=>r.getActiveWindowId(-1)})),o=new er(u=>d.getActiveClientId().then(g=>u===g)),c=new Wi(o,this.logService),s=t.getChannel("urlHandler",c);e.registerHandler(new bi(s));const m=await this.resolveInitialProtocolUrls(n,a);return this._register(new Li(m?.urls,e,n,this.environmentMainService,this.productService,this.logService)),m}setupManagedRemoteResourceUrlHandler(i){const t=()=>({statusCode:404,data:"Not found"}),n=new qe(()=>i.getChannel(Gr,new zr));j.registerBufferProtocol(v.vscodeManagedRemoteResource,(e,r)=>{const a=w.parse(e.url);if(!a.authority.startsWith("window:"))return r(t());n.value.call(Yr,[a]).then(l=>r({...l,data:Buffer.from(l.body,"base64")}),l=>{this.logService.warn("error dispatching remote resource call",l),r({statusCode:500,data:String(l)})})})}async resolveInitialProtocolUrls(i,t){const n=this.environmentMainService.args["open-url"]?this.environmentMainService.args._urls||[]:[];n.length>0&&this.logService.trace("app#resolveInitialProtocolUrls() protocol urls from command line:",n);const e=global.getOpenUrls()||[];if(e.length>0&&this.logService.trace("app#resolveInitialProtocolUrls() protocol urls from macOS 'open-url' event:",e),n.length+e.length===0)return;const r=[...n,...e].map(d=>{try{return{uri:w.parse(d),originalUrl:d}}catch{this.logService.trace("app#resolveInitialProtocolUrls() protocol url failed to parse:",d);return}}),a=[],l=[];for(const d of r){if(!d)continue;const o=this.getWindowOpenableFromProtocolUrl(d.uri);if(o)if(await this.shouldBlockOpenable(o,i,t)){this.logService.trace("app#resolveInitialProtocolUrls() protocol url was blocked:",d.uri.toString(!0));continue}else this.logService.trace("app#resolveInitialProtocolUrls() protocol url will be handled as window to open:",d.uri.toString(!0),o),a.push(o);else this.logService.trace("app#resolveInitialProtocolUrls() protocol url will be passed to active window for handling:",d.uri.toString(!0)),l.push(d)}return{urls:l,openables:a}}async shouldBlockOpenable(i,t,n){let e,r;if(Fi(i)?(e=i.workspaceUri,r=M("confirmOpenMessageWorkspace","An external application wants to open '{0}' in {1}. Do you want to open this workspace file?",e.scheme===v.file?H(e,{os:D,tildify:this.environmentMainService}):e.toString(!0),this.productService.nameShort)):Ai(i)?(e=i.folderUri,r=M("confirmOpenMessageFolder","An external application wants to open '{0}' in {1}. Do you want to open this folder?",e.scheme===v.file?H(e,{os:D,tildify:this.environmentMainService}):e.toString(!0),this.productService.nameShort)):(e=i.fileUri,r=M("confirmOpenMessageFileOrFolder","An external application wants to open '{0}' in {1}. Do you want to open this file or folder?",e.scheme===v.file?H(e,{os:D,tildify:this.environmentMainService}):e.toString(!0),this.productService.nameShort)),e.scheme!==v.file&&e.scheme!==v.vscodeRemote||this.configurationService.getValue(b.SECURITY_PROTOCOL_HANDLING_CONFIRMATION_SETTING_KEY[e.scheme])===!1)return!1;const{response:l,checkboxChecked:d}=await n.showMessageBox({type:"warning",buttons:[M({key:"open",comment:["&& denotes a mnemonic"]},"&&Yes"),M({key:"cancel",comment:["&& denotes a mnemonic"]},"&&No")],message:r,detail:M("confirmOpenDetail","If you did not initiate this request, it may represent an attempted attack on your system. Unless you took an explicit action to initiate this request, you should press 'No'"),checkboxLabel:e.scheme===v.file?M("doNotAskAgainLocal","Allow opening local paths without asking"):M("doNotAskAgainRemote","Allow opening remote paths without asking"),cancelId:1});if(l!==0)return!0;if(d){const o={channel:"vscode:disablePromptForProtocolHandling",args:e.scheme===v.file?"local":"remote"};t.sendToFocused(o.channel,o.args),t.sendToOpeningWindow(o.channel,o.args)}return!1}getWindowOpenableFromProtocolUrl(i){if(i.path){if(i.authority===v.file){const t=w.file(i.fsPath);return N(t)?{workspaceUri:t}:{fileUri:t}}else if(i.authority===v.vscodeRemote){const t=i.path.indexOf(Ge.sep,1);let n,e;t!==-1?(n=i.path.substring(1,t),e=i.path.substring(t)):(n=i.path.substring(1),e="/");let r=i.query;const a=new URLSearchParams(i.query);a.get("windowId")==="_blank"&&(a.delete("windowId"),r=a.toString());const l=w.from({scheme:v.vscodeRemote,authority:n,path:e,query:r,fragment:i.fragment});return N(e)?{workspaceUri:l}:/:[\d]+$/.test(e)?{fileUri:l}:{folderUri:l}}}}async handleProtocolUrl(i,t,n,e,r){this.logService.trace("app#handleProtocolUrl():",e.toString(!0),r),e.scheme===this.productService.urlProtocol&&e.path==="workspace"&&(e=e.with({authority:"file",path:w.parse(e.query).path,query:""}));let a=!1;const l=new URLSearchParams(e.query);l.get("windowId")==="_blank"?(this.logService.trace("app#handleProtocolUrl() found 'windowId=_blank' as parameter, setting shouldOpenInNewWindow=true:",e.toString(!0)),l.delete("windowId"),e=e.with({query:l.toString()}),a=!0):E&&i.getWindowCount()===0&&(this.logService.trace("app#handleProtocolUrl() running on macOS with no window open, setting shouldOpenInNewWindow=true:",e.toString(!0)),a=!0);const d=l.get("continueOn");d!==null&&(this.logService.trace("app#handleProtocolUrl() found 'continueOn' as parameter:",e.toString(!0)),l.delete("continueOn"),e=e.with({query:l.toString()}),this.environmentMainService.continueOn=d??void 0);const o=this.getWindowOpenableFromProtocolUrl(e);return o?await this.shouldBlockOpenable(o,i,t)?(this.logService.trace("app#handleProtocolUrl() protocol url was blocked:",e.toString(!0)),!0):(this.logService.trace("app#handleProtocolUrl() opening protocol url as window:",o,e.toString(!0)),(await i.open({context:I.LINK,cli:{...this.environmentMainService.args},urisToOpen:[o],forceNewWindow:a,gotoLineMode:!0})).at(0)?.focus(),!0):a?(this.logService.trace("app#handleProtocolUrl() opening empty window and passing in protocol url:",e.toString(!0)),await(await i.open({context:I.LINK,cli:{...this.environmentMainService.args},forceNewWindow:!0,forceEmpty:!0,gotoLineMode:!0,remoteAuthority:jr(e)})).at(0)?.ready(),n.open(e,r)):(this.logService.trace("app#handleProtocolUrl(): not handled",e.toString(!0),r),!1)}setupSharedProcess(i,t,n){const e=this._register(this.mainInstantiationService.createInstance(Qr,i,t,n));this._register(e.onDidCrash(()=>this.windowsMainService?.sendToFocused("vscode:reportSharedProcessCrash")));const r=(async()=>{this.logService.trace("Main->SharedProcess#connect");const l=await e.connect();return this.logService.trace("Main->SharedProcess#connect: connection established"),new ir(l,"main")})();return{sharedProcessReady:(async()=>(await e.whenReady(),r))(),sharedProcessClient:r}}async initServices(i,t,n,e){const r=new Or;switch(process.platform){case"win32":r.set(O,new p(Ui));break;case"linux":ze?r.set(O,new p(Ri,[process.env.SNAP,process.env.SNAP_REVISION])):r.set(O,new p(Pi));break;case"darwin":r.set(O,new p(Ci));break}r.set(k,new p(Hi,[i,t,n,this.userEnv],!1)),r.set(re,new p(tr,void 0,!1));const a=new vr(this.logService,this.productService);r.set(te,a),r.set(de,new p(Tr,void 0,!1)),r.set(ie,new p(pr,void 0,!1)),r.set(dr,h.toService(ee(e.then(s=>s.getChannel("diagnostics"))))),r.set(ae,new p(Lr,[this.userEnv])),r.set(ce,new p(Er,[this.userEnv])),r.set(ne,new p(mr)),r.set(le,new p(xr)),r.set(q,new p(Br,void 0,!1)),r.set(Se,new p(Ni)),r.set(pe,new p(_r)),r.set(oe,new p(Mr)),r.set(B,new p(oi)),r.set(ni,new p(ti));const l=new yi({graceTime:ue.GraceTime,shortGraceTime:ue.ShortGraceTime,scrollback:this.configurationService.getValue(wi.PersistentSessionScrollback)??100},this.configurationService,this.environmentMainService,this.lifecycleMainService,this.logService),d=new Mi(l,this.configurationService,this.logService,this.loggerService);r.set(he,d),x?r.set(T,new p(Pr)):E?r.set(T,new p(Cr)):Ye&&r.set(T,new p(Ir));const o=new or(this.environmentMainService,this.configurationService,this.logService,this.stateService);r.set(nr,o);const c=new Ki(this.environmentMainService,this.logService,this.userDataProfilesMainService,o,a);if(r.set($i,c),r.set(ge,new p(Bi,void 0,!1)),r.set(_i,new p(qi,void 0,!1)),r.set($,new p(Oi,void 0,!1)),hi(this.productService,this.environmentMainService)){const s=vi(this.productService,this.configurationService),m=ee(e.then(A=>A.getChannel("telemetryAppender"))),u=new ci(m),g=si(xe(),Ee(),process.arch,this.productService.commit,this.productService.version,i,t,n,s),f=di(this.environmentMainService),P={appenders:[u],commonProperties:g,piiPaths:f,sendErrorTelemetry:!0};r.set(me,new p(li,[P],!1))}else r.set(me,mi);return r.set(fr,new p(gr,void 0,!0)),r.set(Sr,new p(wr,void 0,!0)),r.set(fe,new p(ki,void 0,!0)),r.set(ve,new p(qr)),r.set(cr,new p(ar,void 0,!0)),await ke.settled([o.initialize(),c.initialize()]),this.mainInstantiationService.createChild(r)}initChannels(i,t,n){const e=this._register(new $e),r=h.fromService(i.get(de),e,{disableMarshalling:!0});this.mainProcessNodeIpcServer.registerChannel("launch",r);const a=h.fromService(i.get(ie),e,{disableMarshalling:!0});this.mainProcessNodeIpcServer.registerChannel("diagnostics",a);const l=e.add(new Kr(i.get($r)));t.registerChannel("policy",l),n.then(S=>S.registerChannel("policy",l));const d=this.fileService.getProvider(v.file);je(d instanceof br);const o=e.add(new Ur(d,this.logService,this.environmentMainService));t.registerChannel(se,o),n.then(S=>S.registerChannel(se,o));const c=h.fromService(i.get(K),e);t.registerChannel("userDataProfiles",c),n.then(S=>S.registerChannel("userDataProfiles",c));const s=new Zr(i.get(Jr));n.then(S=>S.registerChannel("request",s));const m=new Ii(i.get(O));t.registerChannel("update",m);const u=h.fromService(i.get(ae),e);t.registerChannel("issue",u);const g=h.fromService(i.get(ce),e);t.registerChannel("process",g);const f=h.fromService(i.get(ne),e);t.registerChannel("encryption",f);const P=h.fromService(i.get(ei),e);t.registerChannel("sign",P);const A=h.fromService(i.get(le),e);t.registerChannel("keyboardLayout",A),this.nativeHostMainService=i.get(q);const V=h.fromService(this.nativeHostMainService,e);t.registerChannel("nativeHost",V),n.then(S=>S.registerChannel("nativeHost",V));const we=h.fromService(i.get(ge),e);t.registerChannel("workspaces",we);const ye=h.fromService(i.get(pe),e);t.registerChannel("menubar",ye);const Me=h.fromService(i.get($),e);t.registerChannel("url",Me);const Ie=h.fromService(i.get(Se),e);t.registerChannel("webview",Ie);const G=e.add(new ii(this.logService,i.get(B)));t.registerChannel("storage",G),n.then(S=>S.registerChannel("storage",G));const Ce=e.add(new xi(i.get(B),i.get(K),this.logService));n.then(S=>S.registerChannel("profileStorageListener",Ce));const Pe=h.fromService(i.get(he),e);t.registerChannel(gi.LocalPty,Pe);const Re=h.fromService(i.get(T),e);t.registerChannel("externalTerminal",Re);const Y=new Dr(i.get(Hr));t.registerChannel("logger",Y),n.then(S=>S.registerChannel("logger",Y));const Ue=new lr(i.get(k));t.registerChannel("extensionhostdebugservice",Ue);const be=h.fromService(i.get(oe),e);t.registerChannel(yr,be);const We=h.fromService(i.get(fe),e);t.registerChannel(Ti,We)}async openFirstWindow(i,t){const n=this.windowsMainService=i.get(k);this.auxiliaryWindowsMainService=i.get(re);const e=ur(process.env)?I.CLI:I.DESKTOP,r=this.environmentMainService.args;if(t){if(t.openables.length>0)return n.open({context:e,cli:r,urisToOpen:t.openables,gotoLineMode:!0,initialStartup:!0});if(t.urls.length>0)for(const f of t.urls){const P=new URLSearchParams(f.uri.query);if(P.get("windowId")==="_blank")return P.delete("windowId"),f.originalUrl=f.uri.toString(!0),f.uri=f.uri.with({query:P.toString()}),n.open({context:e,cli:r,forceNewWindow:!0,forceEmpty:!0,gotoLineMode:!0,initialStartup:!0})}}const a=global.macOpenFiles,l=r._.length,d=!!r["folder-uri"],o=!!r["file-uri"],c=r["skip-add-to-recently-opened"]===!0,s=r.wait&&r.waitMarkerFilePath?w.file(r.waitMarkerFilePath):void 0,m=r.remote||void 0,u=r.profile,g=r["profile-temp"];if(!l&&!d&&!o){if(r["new-window"]||u||g)return n.open({context:e,cli:r,forceNewWindow:!0,forceEmpty:!0,noRecentEntry:c,waitMarkerFileURI:s,initialStartup:!0,remoteAuthority:m,forceProfile:u,forceTempProfile:g});if(a.length)return n.open({context:I.DOCK,cli:r,urisToOpen:a.map(f=>(f=X(f),N(f)?{workspaceUri:w.file(f)}:{fileUri:w.file(f)})),noRecentEntry:c,waitMarkerFileURI:s,initialStartup:!0})}return n.open({context:e,cli:r,forceNewWindow:r["new-window"],diffMode:r.diff,mergeMode:r.merge,noRecentEntry:c,waitMarkerFileURI:s,gotoLineMode:r.goto,initialStartup:!0,remoteAuthority:m,forceProfile:u,forceTempProfile:g})}afterWindowOpen(){this.installMutex(),j.registerHttpProtocol(v.vscodeRemoteResource,(i,t)=>{t({url:i.url.replace(/^vscode-remote-resource:/,"http:"),method:i.method})}),this.resolveShellEnvironment(this.environmentMainService.args,process.env,!0),this.updateCrashReporterEnablement(),E&&R.runningUnderARM64Translation&&this.windowsMainService?.sendToFocused("vscode:showTranslatedBuildWarning")}async installMutex(){const i=this.productService.win32MutexName;if(x&&i)try{const t=await import("@vscode/windows-mutex"),n=new t.Mutex(i);F.once(this.lifecycleMainService.onWillShutdown)(()=>n.release())}catch(t){this.logService.error(t)}}async resolveShellEnvironment(i,t,n){try{return await Xr(this.configurationService,this.logService,i,t)}catch(e){const r=Fe(e);n?this.windowsMainService?.sendToFocused("vscode:showResolveShellEnvError",r):this.logService.error(r)}return{}}async updateCrashReporterEnablement(){try{const t=(await this.fileService.readFile(this.environmentMainService.argvResource)).value.toString(),n=_e(t),r=pi(this.configurationService)>=ai.CRASH;if(n["enable-crash-reporter"]===void 0){const a=["","	// Allows to disable crash reporting.","	// Should restart the app if the value is changed.",`	"enable-crash-reporter": ${r},`,"","	// Unique id used for correlating crash reports sent from this instance.","	// Do not edit this value.",`	"crash-reporter-id": "${Je()}"`,"}"],l=t.substring(0,t.length-2).concat(`,
`,a.join(`
`));await this.fileService.writeFile(this.environmentMainService.argvResource,Z.fromString(l))}else{const a=t.replace(/"enable-crash-reporter": .*,/,`"enable-crash-reporter": ${r},`);a!==t&&await this.fileService.writeFile(this.environmentMainService.argvResource,Z.fromString(a))}}catch(i){this.logService.error(i),this.windowsMainService?.sendToFocused("vscode:showArgvParseWarning")}}};b=z([y(2,Wr),y(3,Fr),y(4,Ar),y(5,hr),y(6,kr),y(7,sr),y(8,ri),y(9,Rr),y(10,Vr),y(11,K)],b);export{b as CodeApplication};
