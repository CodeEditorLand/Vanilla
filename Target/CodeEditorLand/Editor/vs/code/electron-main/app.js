var Le=Object.defineProperty;var Ee=Object.getOwnPropertyDescriptor;var Y=(L,C,i,t)=>{for(var n=t>1?void 0:t?Ee(C,i):C,e=L.length-1,r;e>=0;e--)(r=L[e])&&(n=(t?r(C,i,n):r(n))||n);return t&&n&&Le(C,i,n),n},y=(L,C)=>(i,t)=>C(i,t,L);import{app as R,BrowserWindow as xe,protocol as z,session as U,systemPreferences as j}from"electron";import{addUNCHostToAllowlist as Te,disableUNCAccessRestrictions as ke}from"../../base/node/unc.js";import{validatedIpcMain as W}from"../../base/parts/ipc/electron-main/ipcMain.js";import{hostname as Ne,release as Ae}from"os";import{VSBuffer as J}from"../../base/common/buffer.js";import{toErrorMessage as Fe}from"../../base/common/errorMessage.js";import{isSigPipeError as He,onUnexpectedError as Z,setUnexpectedErrorHandler as De}from"../../base/common/errors.js";import{Event as F}from"../../base/common/event.js";import{parse as _e}from"../../base/common/jsonc.js";import{getPathLabel as H}from"../../base/common/labels.js";import{Disposable as qe,DisposableStore as Be}from"../../base/common/lifecycle.js";import{Schemas as p,VSCODE_AUTHORITY as Ve}from"../../base/common/network.js";import{join as $e,posix as Ke}from"../../base/common/path.js";import{isLinux as Ge,isLinuxSnap as Ye,isMacintosh as x,isWindows as T,OS as D}from"../../base/common/platform.js";import{assertType as ze}from"../../base/common/types.js";import{URI as w}from"../../base/common/uri.js";import{generateUuid as je}from"../../base/common/uuid.js";import{registerContextMenuListener as Je}from"../../base/parts/contextmenu/electron-main/contextmenu.js";import{getDelayedChannel as Q,ProxyChannel as u,StaticRouter as Ze}from"../../base/parts/ipc/common/ipc.js";import{Server as Qe}from"../../base/parts/ipc/electron-main/ipc.electron.js";import{Client as Xe}from"../../base/parts/ipc/electron-main/ipc.mp.js";import"../../base/parts/ipc/node/ipc.net.js";import{IProxyAuthService as X,ProxyAuthService as er}from"../../platform/native/electron-main/auth.js";import{localize as M}from"../../nls.js";import{IBackupMainService as rr}from"../../platform/backup/electron-main/backup.js";import{BackupMainService as ir}from"../../platform/backup/electron-main/backupMainService.js";import{IConfigurationService as tr}from"../../platform/configuration/common/configuration.js";import{ElectronExtensionHostDebugBroadcastChannel as nr}from"../../platform/debug/electron-main/extensionHostDebugIpc.js";import{IDiagnosticsService as or}from"../../platform/diagnostics/common/diagnostics.js";import{DiagnosticsMainService as sr,IDiagnosticsMainService as ee}from"../../platform/diagnostics/electron-main/diagnosticsMainService.js";import{DialogMainService as ar,IDialogMainService as re}from"../../platform/dialogs/electron-main/dialogMainService.js";import{IEncryptionMainService as ie}from"../../platform/encryption/common/encryptionService.js";import{EncryptionMainService as cr}from"../../platform/encryption/electron-main/encryptionMainService.js";import"../../platform/environment/common/argv.js";import{IEnvironmentMainService as lr}from"../../platform/environment/electron-main/environmentMainService.js";import{isLaunchedFromCli as dr}from"../../platform/environment/node/argvHelper.js";import{getResolvedShellEnv as vr}from"../../platform/shell/node/shellEnv.js";import{IExtensionHostStarter as te,ipcExtensionHostStarterChannelName as pr}from"../../platform/extensions/common/extensionHostStarter.js";import{ExtensionHostStarter as mr}from"../../platform/extensions/electron-main/extensionHostStarter.js";import{IExternalTerminalMainService as k}from"../../platform/externalTerminal/electron-main/externalTerminal.js";import{LinuxExternalTerminalService as ur,MacExternalTerminalService as hr,WindowsExternalTerminalService as fr}from"../../platform/externalTerminal/node/externalTerminalService.js";import{LOCAL_FILE_SYSTEM_CHANNEL_NAME as ne}from"../../platform/files/common/diskFileSystemProviderClient.js";import{IFileService as Sr}from"../../platform/files/common/files.js";import{DiskFileSystemProviderChannel as gr}from"../../platform/files/electron-main/diskFileSystemProviderServer.js";import{DiskFileSystemProvider as wr}from"../../platform/files/node/diskFileSystemProvider.js";import{SyncDescriptor as v}from"../../platform/instantiation/common/descriptors.js";import{IInstantiationService as yr}from"../../platform/instantiation/common/instantiation.js";import{ServiceCollection as Mr}from"../../platform/instantiation/common/serviceCollection.js";import{IProcessMainService as oe,IIssueMainService as se}from"../../platform/issue/common/issue.js";import{IssueMainService as Ir}from"../../platform/issue/electron-main/issueMainService.js";import{ProcessMainService as Cr}from"../../platform/issue/electron-main/processMainService.js";import{IKeyboardLayoutMainService as ae,KeyboardLayoutMainService as Pr}from"../../platform/keyboardLayout/electron-main/keyboardLayoutMainService.js";import{ILaunchMainService as ce,LaunchMainService as Rr}from"../../platform/launch/electron-main/launchMainService.js";import{ILifecycleMainService as Ur,LifecycleMainPhase as _,ShutdownReason as br}from"../../platform/lifecycle/electron-main/lifecycleMainService.js";import{ILoggerService as Wr,ILogService as Or}from"../../platform/log/common/log.js";import{IMenubarMainService as le,MenubarMainService as Lr}from"../../platform/menubar/electron-main/menubarMainService.js";import{INativeHostMainService as q,NativeHostMainService as Er}from"../../platform/native/electron-main/nativeHostMainService.js";import{IProductService as xr}from"../../platform/product/common/productService.js";import{getRemoteAuthority as Tr}from"../../platform/remote/common/remoteHosts.js";import{SharedProcess as kr}from"../../platform/sharedProcess/electron-main/sharedProcess.js";import{ISignService as Nr}from"../../platform/sign/common/sign.js";import{IStateService as Ar}from"../../platform/state/node/state.js";import{StorageDatabaseChannel as Fr}from"../../platform/storage/electron-main/storageIpc.js";import{ApplicationStorageMainService as Hr,IApplicationStorageMainService as Dr,IStorageMainService as B,StorageMainService as _r}from"../../platform/storage/electron-main/storageMainService.js";import{resolveCommonProperties as qr}from"../../platform/telemetry/common/commonProperties.js";import{ITelemetryService as de,TelemetryLevel as Br}from"../../platform/telemetry/common/telemetry.js";import{TelemetryAppenderClient as Vr}from"../../platform/telemetry/common/telemetryIpc.js";import{TelemetryService as $r}from"../../platform/telemetry/common/telemetryService.js";import{getPiiPathsFromEnvironment as Kr,getTelemetryLevel as Gr,isInternalTelemetry as Yr,NullTelemetryService as zr,supportsTelemetry as jr}from"../../platform/telemetry/common/telemetryUtils.js";import{IUpdateService as O}from"../../platform/update/common/update.js";import{UpdateChannel as Jr}from"../../platform/update/common/updateIpc.js";import{DarwinUpdateService as Zr}from"../../platform/update/electron-main/updateService.darwin.js";import{LinuxUpdateService as Qr}from"../../platform/update/electron-main/updateService.linux.js";import{SnapUpdateService as Xr}from"../../platform/update/electron-main/updateService.snap.js";import{Win32UpdateService as ei}from"../../platform/update/electron-main/updateService.win32.js";import{IURLService as V}from"../../platform/url/common/url.js";import{URLHandlerChannelClient as ri,URLHandlerRouter as ii}from"../../platform/url/common/urlIpc.js";import{NativeURLService as ti}from"../../platform/url/common/urlService.js";import{ElectronURLListener as ni}from"../../platform/url/electron-main/electronUrlListener.js";import{IWebviewManagerService as ve}from"../../platform/webview/common/webviewManagerService.js";import{WebviewMainService as oi}from"../../platform/webview/electron-main/webviewMainService.js";import{isFolderToOpen as si,isWorkspaceToOpen as ai}from"../../platform/window/common/window.js";import{IWindowsMainService as N,OpenContext as I}from"../../platform/windows/electron-main/windows.js";import"../../platform/window/electron-main/window.js";import{WindowsMainService as ci}from"../../platform/windows/electron-main/windowsMainService.js";import{ActiveWindowManager as li}from"../../platform/windows/node/windowTracker.js";import{hasWorkspaceFileExtension as A}from"../../platform/workspace/common/workspace.js";import{IWorkspacesService as pe}from"../../platform/workspaces/common/workspaces.js";import{IWorkspacesHistoryMainService as di,WorkspacesHistoryMainService as vi}from"../../platform/workspaces/electron-main/workspacesHistoryMainService.js";import{WorkspacesMainService as pi}from"../../platform/workspaces/electron-main/workspacesMainService.js";import{IWorkspacesManagementMainService as mi,WorkspacesManagementMainService as ui}from"../../platform/workspaces/electron-main/workspacesManagementMainService.js";import{IPolicyService as hi}from"../../platform/policy/common/policy.js";import{PolicyChannel as fi}from"../../platform/policy/common/policyIpc.js";import{IUserDataProfilesMainService as $}from"../../platform/userDataProfile/electron-main/userDataProfile.js";import{IExtensionsProfileScannerService as Si}from"../../platform/extensionManagement/common/extensionsProfileScannerService.js";import{IExtensionsScannerService as gi}from"../../platform/extensionManagement/common/extensionsScannerService.js";import{ExtensionsScannerService as wi}from"../../platform/extensionManagement/node/extensionsScannerService.js";import{UserDataProfilesHandler as yi}from"../../platform/userDataProfile/electron-main/userDataProfilesHandler.js";import{ProfileStorageChangesListenerChannel as Mi}from"../../platform/userDataProfile/electron-main/userDataProfileStorageIpc.js";import{Promises as Ii,RunOnceScheduler as Ci,runWhenGlobalIdle as Pi}from"../../base/common/async.js";import{resolveMachineId as Ri,resolveSqmId as Ui,resolvedevDeviceId as bi}from"../../platform/telemetry/electron-main/telemetryUtils.js";import{ExtensionsProfileScannerService as Wi}from"../../platform/extensionManagement/node/extensionsProfileScannerService.js";import{LoggerChannel as Oi}from"../../platform/log/electron-main/logIpc.js";import{ILoggerMainService as Li}from"../../platform/log/electron-main/loggerService.js";import"../../platform/url/electron-main/url.js";import{IUtilityProcessWorkerMainService as me,UtilityProcessWorkerMainService as Ei}from"../../platform/utilityProcess/electron-main/utilityProcessWorkerMainService.js";import{ipcUtilityProcessWorkerChannelName as xi}from"../../platform/utilityProcess/common/utilityProcessWorkerService.js";import{ILocalPtyService as ue,LocalReconnectConstants as he,TerminalIpcChannels as Ti,TerminalSettingId as ki}from"../../platform/terminal/common/terminal.js";import{ElectronPtyHostStarter as Ni}from"../../platform/terminal/electron-main/electronPtyHostStarter.js";import{PtyHostService as Ai}from"../../platform/terminal/node/ptyHostService.js";import{NODE_REMOTE_RESOURCE_CHANNEL_NAME as Fi,NODE_REMOTE_RESOURCE_IPC_METHOD_NAME as Hi,NodeRemoteResourceRouter as Di}from"../../platform/remote/common/electronRemoteResources.js";import{Lazy as _i}from"../../base/common/lazy.js";import{IAuxiliaryWindowsMainService as fe}from"../../platform/auxiliaryWindow/electron-main/auxiliaryWindows.js";import{AuxiliaryWindowsMainService as qi}from"../../platform/auxiliaryWindow/electron-main/auxiliaryWindowsMainService.js";import{normalizeNFC as Se}from"../../base/common/normalization.js";import{ICSSDevelopmentService as Bi,CSSDevelopmentService as Vi}from"../../platform/cssDev/node/cssDevService.js";import{ExtensionSignatureVerificationService as $i,IExtensionSignatureVerificationService as ge}from"../../platform/extensionManagement/node/extensionSignatureVerificationService.js";let b=class extends qe{constructor(i,t,n,e,r,a,l,d,o,c,s,m){super();this.mainProcessNodeIpcServer=i;this.userEnv=t;this.mainInstantiationService=n;this.logService=e;this.loggerService=r;this.environmentMainService=a;this.lifecycleMainService=l;this.configurationService=d;this.stateService=o;this.fileService=c;this.productService=s;this.userDataProfilesMainService=m;this.configureSession(),this.registerListeners()}static SECURITY_PROTOCOL_HANDLING_CONFIRMATION_SETTING_KEY={[p.file]:"security.promptForLocalFileProtocolHandling",[p.vscodeRemote]:"security.promptForRemoteFileProtocolHandling"};windowsMainService;auxiliaryWindowsMainService;nativeHostMainService;configureSession(){const i=o=>o?.startsWith(`${p.vscodeWebview}://`),t=new Set(["clipboard-read","clipboard-sanitized-write"]);U.defaultSession.setPermissionRequestHandler((o,c,s,m)=>i(m.requestingUrl)?s(t.has(c)):s(!1)),U.defaultSession.setPermissionCheckHandler((o,c,s,m)=>i(m.requestingUrl)?t.has(c):!1);const n=new Set([p.file,p.vscodeFileResource,p.vscodeRemoteResource,p.vscodeManagedRemoteResource,"devtools"]),e=o=>{for(let c=o;c;c=c.parent)if(c.url.startsWith(`${p.vscodeWebview}://`))return!0;return!1},r=o=>o.resourceType==="xhr"||e(o.frame),a=o=>{const c=o.frame;if(!c||!this.windowsMainService)return!1;const s=xe.getAllWindows();for(const m of s)if(c.processId===m.webContents.mainFrame.processId)return!0;return!1},l=(o,c)=>{if(o.path!=="/index.html")return!0;const s=c.frame;if(!s||!this.windowsMainService)return!1;for(const m of this.windowsMainService.getWindows())if(m.win&&s.processId===m.win.webContents.mainFrame.processId)return!0;return!1};U.defaultSession.webRequest.onBeforeRequest((o,c)=>{const s=w.parse(o.url);return s.scheme===p.vscodeWebview&&!l(s,o)?(this.logService.error("Blocked vscode-webview request",o.url),c({cancel:!0})):s.scheme===p.vscodeFileResource&&!a(o)?(this.logService.error("Blocked vscode-file request",o.url),c({cancel:!0})):s.path.endsWith(".svg")&&!n.has(s.scheme)?c({cancel:!r(o)}):c({cancel:!1})}),U.defaultSession.webRequest.onHeadersReceived((o,c)=>{const s=o.responseHeaders,m=s["content-type"]||s["Content-Type"];if(m&&Array.isArray(m)){const h=w.parse(o.url);if(h.path.endsWith(".svg")&&n.has(h.scheme))return s["Content-Type"]=["image/svg+xml"],c({cancel:!1,responseHeaders:s});if(!h.path.endsWith(p.vscodeRemoteResource)&&m.some(g=>g.toLowerCase().includes("image/svg")))return c({cancel:!r(o)})}return c({cancel:!1})}),U.defaultSession.webRequest.onHeadersReceived((o,c)=>{if(o.url.startsWith("https://vscode.download.prss.microsoft.com/")){const s=o.responseHeaders??Object.create(null);if(s["Access-Control-Allow-Origin"]===void 0)return s["Access-Control-Allow-Origin"]=["*"],c({cancel:!1,responseHeaders:s})}return c({cancel:!1})});const d=U.defaultSession;typeof d.setCodeCachePath=="function"&&this.environmentMainService.codeCachePath&&d.setCodeCachePath($e(this.environmentMainService.codeCachePath,"chrome")),T&&(this.configurationService.getValue("security.restrictUNCAccess")===!1?ke():Te(this.configurationService.getValue("security.allowedUNCHosts")))}registerListeners(){De(n=>this.onUnexpectedError(n)),process.on("uncaughtException",n=>{He(n)||Z(n)}),process.on("unhandledRejection",n=>Z(n)),F.once(this.lifecycleMainService.onWillShutdown)(()=>this.dispose()),Je(),R.on("accessibility-support-changed",(n,e)=>{this.windowsMainService?.sendToAll("vscode:accessibilitySupportChanged",e)}),R.on("activate",async(n,e)=>{this.logService.trace("app#activate"),e||await this.windowsMainService?.openEmptyWindow({context:I.DOCK})}),R.on("web-contents-created",(n,e)=>{e?.opener?.url.startsWith(`${p.vscodeFileResource}://${Ve}/`)&&(this.logService.trace('[aux window]  app.on("web-contents-created"): Registering auxiliary window'),this.auxiliaryWindowsMainService?.registerWindow(e)),e.on("will-navigate",r=>{this.logService.error("webContents#will-navigate: Prevented webcontent navigation"),r.preventDefault()}),e.setWindowOpenHandler(r=>r.url==="about:blank"?(this.logService.trace("[aux window] webContents#setWindowOpenHandler: Allowing auxiliary window to open on about:blank"),{action:"allow",overrideBrowserWindowOptions:this.auxiliaryWindowsMainService?.createWindow(r)}):(this.logService.trace(`webContents#setWindowOpenHandler: Prevented opening window with URL ${r.url}}`),this.nativeHostMainService?.openExternal(void 0,r.url),{action:"deny"}))});let i=[],t;R.on("open-file",(n,e)=>{e=Se(e),this.logService.trace("app#open-file: ",e),n.preventDefault(),i.push(A(e)?{workspaceUri:w.file(e)}:{fileUri:w.file(e)}),t!==void 0&&(clearTimeout(t),t=void 0),t=setTimeout(async()=>{await this.windowsMainService?.open({context:I.DOCK,cli:this.environmentMainService.args,urisToOpen:i,gotoLineMode:!1,preferNewWindow:!0}),i=[],t=void 0},100)}),R.on("new-window-for-tab",async()=>{await this.windowsMainService?.openEmptyWindow({context:I.DESKTOP})}),W.handle("vscode:fetchShellEnv",n=>{const e=this.windowsMainService?.getWindowByWebContents(n.sender);let r,a;return e?.config?(r=e.config,a={...process.env,...e.config.userEnv}):(r=this.environmentMainService.args,a=process.env),this.resolveShellEnvironment(r,a,!1)}),W.on("vscode:toggleDevTools",n=>n.sender.toggleDevTools()),W.on("vscode:openDevTools",n=>n.sender.openDevTools()),W.on("vscode:reloadWindow",n=>n.sender.reload()),W.handle("vscode:notifyZoomLevel",async(n,e)=>{const r=this.windowsMainService?.getWindowByWebContents(n.sender);r&&r.notifyZoomLevel(e)})}onUnexpectedError(i){if(i){const t={message:`[uncaught exception in main]: ${i.message}`,stack:i.stack};this.windowsMainService?.sendToFocused("vscode:reportError",JSON.stringify(t))}this.logService.error(`[uncaught exception in main]: ${i}`),i.stack&&this.logService.error(i.stack)}async startup(){this.logService.debug("Starting VS Code"),this.logService.debug(`from: ${this.environmentMainService.appRoot}`),this.logService.debug("args:",this.environmentMainService.args);const i=this.productService.win32AppUserModelId;T&&i&&R.setAppUserModelId(i);try{x&&this.configurationService.getValue("window.nativeTabs")===!0&&!j.getUserDefault("NSUseImprovedLayoutPass","boolean")&&j.setUserDefault("NSUseImprovedLayoutPass","boolean",!0)}catch(s){this.logService.error(s)}const t=new Qe;F.once(this.lifecycleMainService.onWillShutdown)(s=>{s.reason===br.KILL&&t.dispose()}),this.logService.trace("Resolving machine identifier...");const[n,e,r]=await Promise.all([Ri(this.stateService,this.logService),Ui(this.stateService,this.logService),bi(this.stateService,this.logService)]);this.logService.trace(`Resolved machine identifier: ${n}`);const{sharedProcessReady:a,sharedProcessClient:l}=this.setupSharedProcess(n,e,r),d=await this.initServices(n,e,r,a);d.invokeFunction(s=>s.get(X)),this._register(d.createInstance(yi)),d.invokeFunction(s=>this.initChannels(s,t,l));const o=await d.invokeFunction(s=>this.setupProtocolUrlHandlers(s,t));this.setupManagedRemoteResourceUrlHandler(t),this.lifecycleMainService.phase=_.Ready,await d.invokeFunction(s=>this.openFirstWindow(s,o)),this.lifecycleMainService.phase=_.AfterWindowOpen,this.afterWindowOpen(),this._register(new Ci(()=>{this._register(Pi(()=>this.lifecycleMainService.phase=_.Eventually,2500))},2500)).schedule()}async setupProtocolUrlHandlers(i,t){const n=this.windowsMainService=i.get(N),e=i.get(V),r=this.nativeHostMainService=i.get(q),a=i.get(re),l=this;e.registerHandler({async handleURL(h,g){return l.handleProtocolUrl(n,a,e,h,g)}});const d=this._register(new li({onDidOpenMainWindow:r.onDidOpenMainWindow,onDidFocusMainWindow:r.onDidFocusMainWindow,getActiveWindowId:()=>r.getActiveWindowId(-1)})),o=new Ze(h=>d.getActiveClientId().then(g=>h===g)),c=new ii(o,this.logService),s=t.getChannel("urlHandler",c);e.registerHandler(new ri(s));const m=await this.resolveInitialProtocolUrls(n,a);return this._register(new ni(m?.urls,e,n,this.environmentMainService,this.productService,this.logService)),m}setupManagedRemoteResourceUrlHandler(i){const t=()=>({statusCode:404,data:"Not found"}),n=new _i(()=>i.getChannel(Fi,new Di));z.registerBufferProtocol(p.vscodeManagedRemoteResource,(e,r)=>{const a=w.parse(e.url);if(!a.authority.startsWith("window:"))return r(t());n.value.call(Hi,[a]).then(l=>r({...l,data:Buffer.from(l.body,"base64")}),l=>{this.logService.warn("error dispatching remote resource call",l),r({statusCode:500,data:String(l)})})})}async resolveInitialProtocolUrls(i,t){const n=this.environmentMainService.args["open-url"]?this.environmentMainService.args._urls||[]:[];n.length>0&&this.logService.trace("app#resolveInitialProtocolUrls() protocol urls from command line:",n);const e=global.getOpenUrls()||[];if(e.length>0&&this.logService.trace("app#resolveInitialProtocolUrls() protocol urls from macOS 'open-url' event:",e),n.length+e.length===0)return;const r=[...n,...e].map(d=>{try{return{uri:w.parse(d),originalUrl:d}}catch{this.logService.trace("app#resolveInitialProtocolUrls() protocol url failed to parse:",d);return}}),a=[],l=[];for(const d of r){if(!d)continue;const o=this.getWindowOpenableFromProtocolUrl(d.uri);if(o)if(await this.shouldBlockOpenable(o,i,t)){this.logService.trace("app#resolveInitialProtocolUrls() protocol url was blocked:",d.uri.toString(!0));continue}else this.logService.trace("app#resolveInitialProtocolUrls() protocol url will be handled as window to open:",d.uri.toString(!0),o),a.push(o);else this.logService.trace("app#resolveInitialProtocolUrls() protocol url will be passed to active window for handling:",d.uri.toString(!0)),l.push(d)}return{urls:l,openables:a}}async shouldBlockOpenable(i,t,n){let e,r;if(ai(i)?(e=i.workspaceUri,r=M("confirmOpenMessageWorkspace","An external application wants to open '{0}' in {1}. Do you want to open this workspace file?",e.scheme===p.file?H(e,{os:D,tildify:this.environmentMainService}):e.toString(!0),this.productService.nameShort)):si(i)?(e=i.folderUri,r=M("confirmOpenMessageFolder","An external application wants to open '{0}' in {1}. Do you want to open this folder?",e.scheme===p.file?H(e,{os:D,tildify:this.environmentMainService}):e.toString(!0),this.productService.nameShort)):(e=i.fileUri,r=M("confirmOpenMessageFileOrFolder","An external application wants to open '{0}' in {1}. Do you want to open this file or folder?",e.scheme===p.file?H(e,{os:D,tildify:this.environmentMainService}):e.toString(!0),this.productService.nameShort)),e.scheme!==p.file&&e.scheme!==p.vscodeRemote||this.configurationService.getValue(b.SECURITY_PROTOCOL_HANDLING_CONFIRMATION_SETTING_KEY[e.scheme])===!1)return!1;const{response:l,checkboxChecked:d}=await n.showMessageBox({type:"warning",buttons:[M({key:"open",comment:["&& denotes a mnemonic"]},"&&Yes"),M({key:"cancel",comment:["&& denotes a mnemonic"]},"&&No")],message:r,detail:M("confirmOpenDetail","If you did not initiate this request, it may represent an attempted attack on your system. Unless you took an explicit action to initiate this request, you should press 'No'"),checkboxLabel:e.scheme===p.file?M("doNotAskAgainLocal","Allow opening local paths without asking"):M("doNotAskAgainRemote","Allow opening remote paths without asking"),cancelId:1});if(l!==0)return!0;if(d){const o={channel:"vscode:disablePromptForProtocolHandling",args:e.scheme===p.file?"local":"remote"};t.sendToFocused(o.channel,o.args),t.sendToOpeningWindow(o.channel,o.args)}return!1}getWindowOpenableFromProtocolUrl(i){if(i.path){if(i.authority===p.file){const t=w.file(i.fsPath);return A(t)?{workspaceUri:t}:{fileUri:t}}else if(i.authority===p.vscodeRemote){const t=i.path.indexOf(Ke.sep,1);let n,e;t!==-1?(n=i.path.substring(1,t),e=i.path.substring(t)):(n=i.path.substring(1),e="/");let r=i.query;const a=new URLSearchParams(i.query);a.get("windowId")==="_blank"&&(a.delete("windowId"),r=a.toString());const l=w.from({scheme:p.vscodeRemote,authority:n,path:e,query:r,fragment:i.fragment});return A(e)?{workspaceUri:l}:/:[\d]+$/.test(e)?{fileUri:l}:{folderUri:l}}}}async handleProtocolUrl(i,t,n,e,r){this.logService.trace("app#handleProtocolUrl():",e.toString(!0),r),e.scheme===this.productService.urlProtocol&&e.path==="workspace"&&(e=e.with({authority:"file",path:w.parse(e.query).path,query:""}));let a=!1;const l=new URLSearchParams(e.query);l.get("windowId")==="_blank"?(this.logService.trace("app#handleProtocolUrl() found 'windowId=_blank' as parameter, setting shouldOpenInNewWindow=true:",e.toString(!0)),l.delete("windowId"),e=e.with({query:l.toString()}),a=!0):x&&i.getWindowCount()===0&&(this.logService.trace("app#handleProtocolUrl() running on macOS with no window open, setting shouldOpenInNewWindow=true:",e.toString(!0)),a=!0);const d=l.get("continueOn");d!==null&&(this.logService.trace("app#handleProtocolUrl() found 'continueOn' as parameter:",e.toString(!0)),l.delete("continueOn"),e=e.with({query:l.toString()}),this.environmentMainService.continueOn=d??void 0);const o=this.getWindowOpenableFromProtocolUrl(e);return o?await this.shouldBlockOpenable(o,i,t)?(this.logService.trace("app#handleProtocolUrl() protocol url was blocked:",e.toString(!0)),!0):(this.logService.trace("app#handleProtocolUrl() opening protocol url as window:",o,e.toString(!0)),(await i.open({context:I.LINK,cli:{...this.environmentMainService.args},urisToOpen:[o],forceNewWindow:a,gotoLineMode:!0})).at(0)?.focus(),!0):a?(this.logService.trace("app#handleProtocolUrl() opening empty window and passing in protocol url:",e.toString(!0)),await(await i.open({context:I.LINK,cli:{...this.environmentMainService.args},forceNewWindow:!0,forceEmpty:!0,gotoLineMode:!0,remoteAuthority:Tr(e)})).at(0)?.ready(),n.open(e,r)):(this.logService.trace("app#handleProtocolUrl(): not handled",e.toString(!0),r),!1)}setupSharedProcess(i,t,n){const e=this._register(this.mainInstantiationService.createInstance(kr,i,t,n));this._register(e.onDidCrash(()=>this.windowsMainService?.sendToFocused("vscode:reportSharedProcessCrash")));const r=(async()=>{this.logService.trace("Main->SharedProcess#connect");const l=await e.connect();return this.logService.trace("Main->SharedProcess#connect: connection established"),new Xe(l,"main")})();return{sharedProcessReady:(async()=>(await e.whenReady(),r))(),sharedProcessClient:r}}async initServices(i,t,n,e){const r=new Mr;switch(process.platform){case"win32":r.set(O,new v(ei));break;case"linux":Ye?r.set(O,new v(Xr,[process.env.SNAP,process.env.SNAP_REVISION])):r.set(O,new v(Qr));break;case"darwin":r.set(O,new v(Zr));break}r.set(N,new v(ci,[i,t,n,this.userEnv],!1)),r.set(fe,new v(qi,void 0,!1));const a=new ar(this.logService,this.productService);r.set(re,a),r.set(ce,new v(Rr,void 0,!1)),r.set(ee,new v(sr,void 0,!1)),r.set(or,u.toService(Q(e.then(s=>s.getChannel("diagnostics"))))),r.set(se,new v(Ir,[this.userEnv])),r.set(oe,new v(Cr,[this.userEnv])),r.set(ie,new v(cr)),r.set(ae,new v(Pr)),r.set(q,new v(Er,void 0,!1)),r.set(ve,new v(oi)),r.set(le,new v(Lr)),r.set(te,new v(mr)),r.set(B,new v(_r)),r.set(Dr,new v(Hr));const l=new Ni({graceTime:he.GraceTime,shortGraceTime:he.ShortGraceTime,scrollback:this.configurationService.getValue(ki.PersistentSessionScrollback)??100},this.configurationService,this.environmentMainService,this.lifecycleMainService,this.logService),d=new Ai(l,this.configurationService,this.logService,this.loggerService);r.set(ue,d),T?r.set(k,new v(fr)):x?r.set(k,new v(hr)):Ge&&r.set(k,new v(ur));const o=new ir(this.environmentMainService,this.configurationService,this.logService,this.stateService);r.set(rr,o);const c=new ui(this.environmentMainService,this.logService,this.userDataProfilesMainService,o,a);if(r.set(mi,c),r.set(pe,new v(pi,void 0,!1)),r.set(di,new v(vi,void 0,!1)),r.set(V,new v(ti,void 0,!1)),jr(this.productService,this.environmentMainService)){const s=Yr(this.productService,this.configurationService),m=Q(e.then(E=>E.getChannel("telemetryAppender"))),h=new Vr(m),g=qr(Ae(),Ne(),process.arch,this.productService.commit,this.productService.version,i,t,n,s),f=Kr(this.environmentMainService),P={appenders:[h],commonProperties:g,piiPaths:f,sendErrorTelemetry:!0};r.set(de,new v($r,[P],!1))}else r.set(de,zr);return r.set(Si,new v(Wi,void 0,!0)),r.set(gi,new v(wi,void 0,!0)),r.set(me,new v(Ei,void 0,!0)),r.set(X,new v(er)),r.set(Bi,new v(Vi,void 0,!0)),this.productService.quality!=="stable"&&r.set(ge,new v($i,void 0,!0)),await Ii.settled([o.initialize(),c.initialize()]),this.mainInstantiationService.createChild(r)}initChannels(i,t,n){const e=this._register(new Be),r=u.fromService(i.get(ce),e,{disableMarshalling:!0});this.mainProcessNodeIpcServer.registerChannel("launch",r);const a=u.fromService(i.get(ee),e,{disableMarshalling:!0});this.mainProcessNodeIpcServer.registerChannel("diagnostics",a);const l=e.add(new fi(i.get(hi)));t.registerChannel("policy",l),n.then(S=>S.registerChannel("policy",l));const d=this.fileService.getProvider(p.file);ze(d instanceof wr);const o=e.add(new gr(d,this.logService,this.environmentMainService));t.registerChannel(ne,o),n.then(S=>S.registerChannel(ne,o));const c=u.fromService(i.get($),e);if(t.registerChannel("userDataProfiles",c),n.then(S=>S.registerChannel("userDataProfiles",c)),this.productService.quality!=="stable"){const S=i.get(ge);n.then(Oe=>Oe.registerChannel("signatureVerificationService",u.fromService(S,e)))}const s=new Jr(i.get(O));t.registerChannel("update",s);const m=u.fromService(i.get(se),e);t.registerChannel("issue",m);const h=u.fromService(i.get(oe),e);t.registerChannel("process",h);const g=u.fromService(i.get(ie),e);t.registerChannel("encryption",g);const f=u.fromService(i.get(Nr),e);t.registerChannel("sign",f);const P=u.fromService(i.get(ae),e);t.registerChannel("keyboardLayout",P),this.nativeHostMainService=i.get(q);const E=u.fromService(this.nativeHostMainService,e);t.registerChannel("nativeHost",E),n.then(S=>S.registerChannel("nativeHost",E));const we=u.fromService(i.get(pe),e);t.registerChannel("workspaces",we);const ye=u.fromService(i.get(le),e);t.registerChannel("menubar",ye);const Me=u.fromService(i.get(V),e);t.registerChannel("url",Me);const Ie=u.fromService(i.get(ve),e);t.registerChannel("webview",Ie);const K=e.add(new Fr(this.logService,i.get(B)));t.registerChannel("storage",K),n.then(S=>S.registerChannel("storage",K));const Ce=e.add(new Mi(i.get(B),i.get($),this.logService));n.then(S=>S.registerChannel("profileStorageListener",Ce));const Pe=u.fromService(i.get(ue),e);t.registerChannel(Ti.LocalPty,Pe);const Re=u.fromService(i.get(k),e);t.registerChannel("externalTerminal",Re);const G=new Oi(i.get(Li));t.registerChannel("logger",G),n.then(S=>S.registerChannel("logger",G));const Ue=new nr(i.get(N));t.registerChannel("extensionhostdebugservice",Ue);const be=u.fromService(i.get(te),e);t.registerChannel(pr,be);const We=u.fromService(i.get(me),e);t.registerChannel(xi,We)}async openFirstWindow(i,t){const n=this.windowsMainService=i.get(N);this.auxiliaryWindowsMainService=i.get(fe);const e=dr(process.env)?I.CLI:I.DESKTOP,r=this.environmentMainService.args;if(t){if(t.openables.length>0)return n.open({context:e,cli:r,urisToOpen:t.openables,gotoLineMode:!0,initialStartup:!0});if(t.urls.length>0)for(const f of t.urls){const P=new URLSearchParams(f.uri.query);if(P.get("windowId")==="_blank")return P.delete("windowId"),f.originalUrl=f.uri.toString(!0),f.uri=f.uri.with({query:P.toString()}),n.open({context:e,cli:r,forceNewWindow:!0,forceEmpty:!0,gotoLineMode:!0,initialStartup:!0})}}const a=global.macOpenFiles,l=r._.length,d=!!r["folder-uri"],o=!!r["file-uri"],c=r["skip-add-to-recently-opened"]===!0,s=r.wait&&r.waitMarkerFilePath?w.file(r.waitMarkerFilePath):void 0,m=r.remote||void 0,h=r.profile,g=r["profile-temp"];if(!l&&!d&&!o){if(r["new-window"]||h||g)return n.open({context:e,cli:r,forceNewWindow:!0,forceEmpty:!0,noRecentEntry:c,waitMarkerFileURI:s,initialStartup:!0,remoteAuthority:m,forceProfile:h,forceTempProfile:g});if(a.length)return n.open({context:I.DOCK,cli:r,urisToOpen:a.map(f=>(f=Se(f),A(f)?{workspaceUri:w.file(f)}:{fileUri:w.file(f)})),noRecentEntry:c,waitMarkerFileURI:s,initialStartup:!0})}return n.open({context:e,cli:r,forceNewWindow:r["new-window"],diffMode:r.diff,mergeMode:r.merge,noRecentEntry:c,waitMarkerFileURI:s,gotoLineMode:r.goto,initialStartup:!0,remoteAuthority:m,forceProfile:h,forceTempProfile:g})}afterWindowOpen(){this.installMutex(),z.registerHttpProtocol(p.vscodeRemoteResource,(i,t)=>{t({url:i.url.replace(/^vscode-remote-resource:/,"http:"),method:i.method})}),this.resolveShellEnvironment(this.environmentMainService.args,process.env,!0),this.updateCrashReporterEnablement(),x&&R.runningUnderARM64Translation&&this.windowsMainService?.sendToFocused("vscode:showTranslatedBuildWarning")}async installMutex(){const i=this.productService.win32MutexName;if(T&&i)try{const t=await import("@vscode/windows-mutex"),n=new t.Mutex(i);F.once(this.lifecycleMainService.onWillShutdown)(()=>n.release())}catch(t){this.logService.error(t)}}async resolveShellEnvironment(i,t,n){try{return await vr(this.configurationService,this.logService,i,t)}catch(e){const r=Fe(e);n?this.windowsMainService?.sendToFocused("vscode:showResolveShellEnvError",r):this.logService.error(r)}return{}}async updateCrashReporterEnablement(){try{const t=(await this.fileService.readFile(this.environmentMainService.argvResource)).value.toString(),n=_e(t),r=Gr(this.configurationService)>=Br.CRASH;if(n["enable-crash-reporter"]===void 0){const a=["","	// Allows to disable crash reporting.","	// Should restart the app if the value is changed.",`	"enable-crash-reporter": ${r},`,"","	// Unique id used for correlating crash reports sent from this instance.","	// Do not edit this value.",`	"crash-reporter-id": "${je()}"`,"}"],l=t.substring(0,t.length-2).concat(`,
`,a.join(`
`));await this.fileService.writeFile(this.environmentMainService.argvResource,J.fromString(l))}else{const a=t.replace(/"enable-crash-reporter": .*,/,`"enable-crash-reporter": ${r},`);a!==t&&await this.fileService.writeFile(this.environmentMainService.argvResource,J.fromString(a))}}catch(i){this.logService.error(i),this.windowsMainService?.sendToFocused("vscode:showArgvParseWarning")}}};b=Y([y(2,yr),y(3,Or),y(4,Wr),y(5,lr),y(6,Ur),y(7,tr),y(8,Ar),y(9,Sr),y(10,xr),y(11,$)],b);export{b as CodeApplication};
