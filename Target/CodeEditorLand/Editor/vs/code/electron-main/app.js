var Le=Object.defineProperty;var Ee=Object.getOwnPropertyDescriptor;var z=(L,C,i,t)=>{for(var n=t>1?void 0:t?Ee(C,i):C,e=L.length-1,r;e>=0;e--)(r=L[e])&&(n=(t?r(C,i,n):r(n))||n);return t&&n&&Le(C,i,n),n},y=(L,C)=>(i,t)=>C(i,t,L);import{hostname as xe,release as Te}from"os";import{app as R,BrowserWindow as ke,protocol as j,session as U,systemPreferences as J}from"electron";import{firstOrDefault as Z}from"../../../vs/base/common/arrays.js";import{Promises as Ne,RunOnceScheduler as Ae,runWhenGlobalIdle as Fe}from"../../../vs/base/common/async.js";import{VSBuffer as Q}from"../../../vs/base/common/buffer.js";import{toErrorMessage as De}from"../../../vs/base/common/errorMessage.js";import{isSigPipeError as He,onUnexpectedError as X,setUnexpectedErrorHandler as _e}from"../../../vs/base/common/errors.js";import{Event as F}from"../../../vs/base/common/event.js";import{parse as qe}from"vs/base/common/jsonc";import{getPathLabel as D}from"../../../vs/base/common/labels.js";import{Lazy as Be}from"../../../vs/base/common/lazy.js";import{Disposable as $e,DisposableStore as Ke}from"../../../vs/base/common/lifecycle.js";import{Schemas as v,VSCODE_AUTHORITY as Ve}from"../../../vs/base/common/network.js";import{normalizeNFC as ee}from"../../../vs/base/common/normalization.js";import{join as Ge,posix as Ye}from"../../../vs/base/common/path.js";import{isLinux as ze,isLinuxSnap as je,isMacintosh as E,isWindows as x,OS as H}from"../../../vs/base/common/platform.js";import{assertType as Je}from"../../../vs/base/common/types.js";import{URI as w}from"../../../vs/base/common/uri.js";import{generateUuid as Ze}from"../../../vs/base/common/uuid.js";import{addUNCHostToAllowlist as Qe,disableUNCAccessRestrictions as Xe}from"vs/base/node/unc";import{registerContextMenuListener as er}from"../../../vs/base/parts/contextmenu/electron-main/contextmenu.js";import{getDelayedChannel as re,ProxyChannel as h,StaticRouter as rr}from"../../../vs/base/parts/ipc/common/ipc.js";import{Server as ir}from"../../../vs/base/parts/ipc/electron-main/ipc.electron.js";import{Client as tr}from"../../../vs/base/parts/ipc/electron-main/ipc.mp.js";import{validatedIpcMain as W}from"../../../vs/base/parts/ipc/electron-main/ipcMain.js";import"../../../vs/base/parts/ipc/node/ipc.net.js";import{localize as M}from"../../../vs/nls.js";import{IAuxiliaryWindowsMainService as ie}from"../../../vs/platform/auxiliaryWindow/electron-main/auxiliaryWindows.js";import{AuxiliaryWindowsMainService as nr}from"../../../vs/platform/auxiliaryWindow/electron-main/auxiliaryWindowsMainService.js";import{IBackupMainService as or}from"../../../vs/platform/backup/electron-main/backup.js";import{BackupMainService as sr}from"../../../vs/platform/backup/electron-main/backupMainService.js";import{IConfigurationService as ar}from"../../../vs/platform/configuration/common/configuration.js";import{CSSDevelopmentService as cr,ICSSDevelopmentService as lr}from"../../../vs/platform/cssDev/node/cssDevService.js";import{ElectronExtensionHostDebugBroadcastChannel as dr}from"../../../vs/platform/debug/electron-main/extensionHostDebugIpc.js";import{IDiagnosticsService as pr}from"../../../vs/platform/diagnostics/common/diagnostics.js";import{DiagnosticsMainService as vr,IDiagnosticsMainService as te}from"../../../vs/platform/diagnostics/electron-main/diagnosticsMainService.js";import{DialogMainService as mr,IDialogMainService as ne}from"../../../vs/platform/dialogs/electron-main/dialogMainService.js";import{IEncryptionMainService as oe}from"../../../vs/platform/encryption/common/encryptionService.js";import{EncryptionMainService as hr}from"../../../vs/platform/encryption/electron-main/encryptionMainService.js";import"../../../vs/platform/environment/common/argv.js";import{IEnvironmentMainService as ur}from"../../../vs/platform/environment/electron-main/environmentMainService.js";import{isLaunchedFromCli as fr}from"../../../vs/platform/environment/node/argvHelper.js";import{IExtensionsProfileScannerService as Sr}from"../../../vs/platform/extensionManagement/common/extensionsProfileScannerService.js";import{IExtensionsScannerService as gr}from"../../../vs/platform/extensionManagement/common/extensionsScannerService.js";import{ExtensionsProfileScannerService as wr}from"../../../vs/platform/extensionManagement/node/extensionsProfileScannerService.js";import{ExtensionsScannerService as yr}from"../../../vs/platform/extensionManagement/node/extensionsScannerService.js";import{IExtensionHostStarter as se,ipcExtensionHostStarterChannelName as Mr}from"../../../vs/platform/extensions/common/extensionHostStarter.js";import{ExtensionHostStarter as Ir}from"../../../vs/platform/extensions/electron-main/extensionHostStarter.js";import{IExternalTerminalMainService as T}from"../../../vs/platform/externalTerminal/electron-main/externalTerminal.js";import{LinuxExternalTerminalService as Cr,MacExternalTerminalService as Pr,WindowsExternalTerminalService as Rr}from"../../../vs/platform/externalTerminal/node/externalTerminalService.js";import{LOCAL_FILE_SYSTEM_CHANNEL_NAME as ae}from"../../../vs/platform/files/common/diskFileSystemProviderClient.js";import{IFileService as Ur}from"../../../vs/platform/files/common/files.js";import{DiskFileSystemProviderChannel as br}from"../../../vs/platform/files/electron-main/diskFileSystemProviderServer.js";import{DiskFileSystemProvider as Wr}from"../../../vs/platform/files/node/diskFileSystemProvider.js";import{SyncDescriptor as p}from"../../../vs/platform/instantiation/common/descriptors.js";import{IInstantiationService as Or}from"../../../vs/platform/instantiation/common/instantiation.js";import{ServiceCollection as Lr}from"../../../vs/platform/instantiation/common/serviceCollection.js";import{IIssueMainService as ce,IProcessMainService as le}from"../../../vs/platform/issue/common/issue.js";import{IssueMainService as Er}from"../../../vs/platform/issue/electron-main/issueMainService.js";import{ProcessMainService as xr}from"../../../vs/platform/issue/electron-main/processMainService.js";import{IKeyboardLayoutMainService as de,KeyboardLayoutMainService as Tr}from"../../../vs/platform/keyboardLayout/electron-main/keyboardLayoutMainService.js";import{ILaunchMainService as pe,LaunchMainService as kr}from"../../../vs/platform/launch/electron-main/launchMainService.js";import{ILifecycleMainService as Nr,LifecycleMainPhase as _,ShutdownReason as Ar}from"../../../vs/platform/lifecycle/electron-main/lifecycleMainService.js";import{ILoggerService as Fr,ILogService as Dr}from"../../../vs/platform/log/common/log.js";import{ILoggerMainService as Hr}from"../../../vs/platform/log/electron-main/loggerService.js";import{LoggerChannel as _r}from"../../../vs/platform/log/electron-main/logIpc.js";import{IMenubarMainService as ve,MenubarMainService as qr}from"../../../vs/platform/menubar/electron-main/menubarMainService.js";import{IProxyAuthService as me,ProxyAuthService as Br}from"../../../vs/platform/native/electron-main/auth.js";import{INativeHostMainService as q,NativeHostMainService as $r}from"../../../vs/platform/native/electron-main/nativeHostMainService.js";import{IPolicyService as Kr}from"../../../vs/platform/policy/common/policy.js";import{PolicyChannel as Vr}from"../../../vs/platform/policy/common/policyIpc.js";import{IProductService as Gr}from"../../../vs/platform/product/common/productService.js";import{NODE_REMOTE_RESOURCE_CHANNEL_NAME as Yr,NODE_REMOTE_RESOURCE_IPC_METHOD_NAME as zr,NodeRemoteResourceRouter as jr}from"../../../vs/platform/remote/common/electronRemoteResources.js";import{getRemoteAuthority as Jr}from"../../../vs/platform/remote/common/remoteHosts.js";import{IRequestService as Zr}from"../../../vs/platform/request/common/request.js";import{RequestChannel as Qr}from"../../../vs/platform/request/common/requestIpc.js";import{SharedProcess as Xr}from"../../../vs/platform/sharedProcess/electron-main/sharedProcess.js";import{getResolvedShellEnv as ei}from"../../../vs/platform/shell/node/shellEnv.js";import{ISignService as ri}from"../../../vs/platform/sign/common/sign.js";import{IStateService as ii}from"../../../vs/platform/state/node/state.js";import{StorageDatabaseChannel as ti}from"../../../vs/platform/storage/electron-main/storageIpc.js";import{ApplicationStorageMainService as ni,IApplicationStorageMainService as oi,IStorageMainService as B,StorageMainService as si}from"../../../vs/platform/storage/electron-main/storageMainService.js";import{resolveCommonProperties as ai}from"../../../vs/platform/telemetry/common/commonProperties.js";import{ITelemetryService as he,TelemetryLevel as ci}from"../../../vs/platform/telemetry/common/telemetry.js";import{TelemetryAppenderClient as li}from"../../../vs/platform/telemetry/common/telemetryIpc.js";import{TelemetryService as di}from"../../../vs/platform/telemetry/common/telemetryService.js";import{getPiiPathsFromEnvironment as pi,getTelemetryLevel as vi,isInternalTelemetry as mi,NullTelemetryService as hi,supportsTelemetry as ui}from"../../../vs/platform/telemetry/common/telemetryUtils.js";import{resolvedevDeviceId as fi,resolveMachineId as Si,resolveSqmId as gi}from"../../../vs/platform/telemetry/electron-main/telemetryUtils.js";import{ILocalPtyService as ue,LocalReconnectConstants as fe,TerminalIpcChannels as wi,TerminalSettingId as yi}from"../../../vs/platform/terminal/common/terminal.js";import{ElectronPtyHostStarter as Mi}from"../../../vs/platform/terminal/electron-main/electronPtyHostStarter.js";import{PtyHostService as Ii}from"../../../vs/platform/terminal/node/ptyHostService.js";import{IUpdateService as O}from"../../../vs/platform/update/common/update.js";import{UpdateChannel as Ci}from"../../../vs/platform/update/common/updateIpc.js";import{DarwinUpdateService as Pi}from"../../../vs/platform/update/electron-main/updateService.darwin.js";import{LinuxUpdateService as Ri}from"../../../vs/platform/update/electron-main/updateService.linux.js";import{SnapUpdateService as Ui}from"../../../vs/platform/update/electron-main/updateService.snap.js";import{Win32UpdateService as bi}from"../../../vs/platform/update/electron-main/updateService.win32.js";import{IURLService as $}from"../../../vs/platform/url/common/url.js";import{URLHandlerChannelClient as Wi,URLHandlerRouter as Oi}from"../../../vs/platform/url/common/urlIpc.js";import{NativeURLService as Li}from"../../../vs/platform/url/common/urlService.js";import{ElectronURLListener as Ei}from"../../../vs/platform/url/electron-main/electronUrlListener.js";import"../../../vs/platform/url/electron-main/url.js";import{IUserDataProfilesMainService as K}from"../../../vs/platform/userDataProfile/electron-main/userDataProfile.js";import{UserDataProfilesHandler as xi}from"../../../vs/platform/userDataProfile/electron-main/userDataProfilesHandler.js";import{ProfileStorageChangesListenerChannel as Ti}from"../../../vs/platform/userDataProfile/electron-main/userDataProfileStorageIpc.js";import{ipcUtilityProcessWorkerChannelName as ki}from"../../../vs/platform/utilityProcess/common/utilityProcessWorkerService.js";import{IUtilityProcessWorkerMainService as Se,UtilityProcessWorkerMainService as Ni}from"../../../vs/platform/utilityProcess/electron-main/utilityProcessWorkerMainService.js";import{IWebviewManagerService as ge}from"../../../vs/platform/webview/common/webviewManagerService.js";import{WebviewMainService as Ai}from"../../../vs/platform/webview/electron-main/webviewMainService.js";import{isFolderToOpen as Fi,isWorkspaceToOpen as Di}from"../../../vs/platform/window/common/window.js";import"../../../vs/platform/window/electron-main/window.js";import{IWindowsMainService as k,OpenContext as I}from"../../../vs/platform/windows/electron-main/windows.js";import{WindowsMainService as Hi}from"../../../vs/platform/windows/electron-main/windowsMainService.js";import{ActiveWindowManager as _i}from"../../../vs/platform/windows/node/windowTracker.js";import{hasWorkspaceFileExtension as N}from"../../../vs/platform/workspace/common/workspace.js";import{IWorkspacesService as we}from"../../../vs/platform/workspaces/common/workspaces.js";import{IWorkspacesHistoryMainService as qi,WorkspacesHistoryMainService as Bi}from"../../../vs/platform/workspaces/electron-main/workspacesHistoryMainService.js";import{WorkspacesMainService as $i}from"../../../vs/platform/workspaces/electron-main/workspacesMainService.js";import{IWorkspacesManagementMainService as Ki,WorkspacesManagementMainService as Vi}from"../../../vs/platform/workspaces/electron-main/workspacesManagementMainService.js";let b=class extends $e{constructor(i,t,n,e,r,a,l,d,o,c,s,m){super();this.mainProcessNodeIpcServer=i;this.userEnv=t;this.mainInstantiationService=n;this.logService=e;this.loggerService=r;this.environmentMainService=a;this.lifecycleMainService=l;this.configurationService=d;this.stateService=o;this.fileService=c;this.productService=s;this.userDataProfilesMainService=m;this.configureSession(),this.registerListeners()}static SECURITY_PROTOCOL_HANDLING_CONFIRMATION_SETTING_KEY={[v.file]:"security.promptForLocalFileProtocolHandling",[v.vscodeRemote]:"security.promptForRemoteFileProtocolHandling"};windowsMainService;auxiliaryWindowsMainService;nativeHostMainService;configureSession(){const i=o=>o?.startsWith(`${v.vscodeWebview}://`),t=new Set(["clipboard-read","clipboard-sanitized-write"]);U.defaultSession.setPermissionRequestHandler((o,c,s,m)=>i(m.requestingUrl)?s(t.has(c)):s(!1)),U.defaultSession.setPermissionCheckHandler((o,c,s,m)=>i(m.requestingUrl)?t.has(c):!1);const n=new Set([v.file,v.vscodeFileResource,v.vscodeRemoteResource,v.vscodeManagedRemoteResource,"devtools"]),e=o=>{for(let c=o;c;c=c.parent)if(c.url.startsWith(`${v.vscodeWebview}://`))return!0;return!1},r=o=>o.resourceType==="xhr"||e(o.frame),a=o=>{const c=o.frame;if(!c||!this.windowsMainService)return!1;const s=ke.getAllWindows();for(const m of s)if(c.processId===m.webContents.mainFrame.processId)return!0;return!1},l=(o,c)=>{if(o.path!=="/index.html")return!0;const s=c.frame;if(!s||!this.windowsMainService)return!1;for(const m of this.windowsMainService.getWindows())if(m.win&&s.processId===m.win.webContents.mainFrame.processId)return!0;return!1};U.defaultSession.webRequest.onBeforeRequest((o,c)=>{const s=w.parse(o.url);return s.scheme===v.vscodeWebview&&!l(s,o)?(this.logService.error("Blocked vscode-webview request",o.url),c({cancel:!0})):s.scheme===v.vscodeFileResource&&!a(o)?(this.logService.error("Blocked vscode-file request",o.url),c({cancel:!0})):s.path.endsWith(".svg")&&!n.has(s.scheme)?c({cancel:!r(o)}):c({cancel:!1})}),U.defaultSession.webRequest.onHeadersReceived((o,c)=>{const s=o.responseHeaders,m=s["content-type"]||s["Content-Type"];if(m&&Array.isArray(m)){const u=w.parse(o.url);if(u.path.endsWith(".svg")&&n.has(u.scheme))return s["Content-Type"]=["image/svg+xml"],c({cancel:!1,responseHeaders:s});if(!u.path.endsWith(v.vscodeRemoteResource)&&m.some(g=>g.toLowerCase().includes("image/svg")))return c({cancel:!r(o)})}return c({cancel:!1})}),U.defaultSession.webRequest.onHeadersReceived((o,c)=>{if(o.url.startsWith("https://vscode.download.prss.microsoft.com/")){const s=o.responseHeaders??Object.create(null);if(s["Access-Control-Allow-Origin"]===void 0)return s["Access-Control-Allow-Origin"]=["*"],c({cancel:!1,responseHeaders:s})}return c({cancel:!1})});const d=U.defaultSession;typeof d.setCodeCachePath=="function"&&this.environmentMainService.codeCachePath&&d.setCodeCachePath(Ge(this.environmentMainService.codeCachePath,"chrome")),x&&(this.configurationService.getValue("security.restrictUNCAccess")===!1?Xe():Qe(this.configurationService.getValue("security.allowedUNCHosts")))}registerListeners(){_e(n=>this.onUnexpectedError(n)),process.on("uncaughtException",n=>{He(n)||X(n)}),process.on("unhandledRejection",n=>X(n)),F.once(this.lifecycleMainService.onWillShutdown)(()=>this.dispose()),er(),R.on("accessibility-support-changed",(n,e)=>{this.windowsMainService?.sendToAll("vscode:accessibilitySupportChanged",e)}),R.on("activate",async(n,e)=>{this.logService.trace("app#activate"),e||await this.windowsMainService?.openEmptyWindow({context:I.DOCK})}),R.on("web-contents-created",(n,e)=>{e?.opener?.url.startsWith(`${v.vscodeFileResource}://${Ve}/`)&&(this.logService.trace('[aux window]  app.on("web-contents-created"): Registering auxiliary window'),this.auxiliaryWindowsMainService?.registerWindow(e)),e.on("will-navigate",r=>{this.logService.error("webContents#will-navigate: Prevented webcontent navigation"),r.preventDefault()}),e.setWindowOpenHandler(r=>r.url==="about:blank"?(this.logService.trace("[aux window] webContents#setWindowOpenHandler: Allowing auxiliary window to open on about:blank"),{action:"allow",overrideBrowserWindowOptions:this.auxiliaryWindowsMainService?.createWindow(r)}):(this.logService.trace(`webContents#setWindowOpenHandler: Prevented opening window with URL ${r.url}}`),this.nativeHostMainService?.openExternal(void 0,r.url),{action:"deny"}))});let i=[],t;R.on("open-file",(n,e)=>{e=ee(e),this.logService.trace("app#open-file: ",e),n.preventDefault(),i.push(N(e)?{workspaceUri:w.file(e)}:{fileUri:w.file(e)}),t!==void 0&&(clearTimeout(t),t=void 0),t=setTimeout(async()=>{await this.windowsMainService?.open({context:I.DOCK,cli:this.environmentMainService.args,urisToOpen:i,gotoLineMode:!1,preferNewWindow:!0}),i=[],t=void 0},100)}),R.on("new-window-for-tab",async()=>{await this.windowsMainService?.openEmptyWindow({context:I.DESKTOP})}),W.handle("vscode:fetchShellEnv",n=>{const e=this.windowsMainService?.getWindowByWebContents(n.sender);let r,a;return e?.config?(r=e.config,a={...process.env,...e.config.userEnv}):(r=this.environmentMainService.args,a=process.env),this.resolveShellEnvironment(r,a,!1)}),W.on("vscode:toggleDevTools",n=>n.sender.toggleDevTools()),W.on("vscode:openDevTools",n=>n.sender.openDevTools()),W.on("vscode:reloadWindow",n=>n.sender.reload()),W.handle("vscode:notifyZoomLevel",async(n,e)=>{const r=this.windowsMainService?.getWindowByWebContents(n.sender);r&&r.notifyZoomLevel(e)})}onUnexpectedError(i){if(i){const t={message:`[uncaught exception in main]: ${i.message}`,stack:i.stack};this.windowsMainService?.sendToFocused("vscode:reportError",JSON.stringify(t))}this.logService.error(`[uncaught exception in main]: ${i}`),i.stack&&this.logService.error(i.stack)}async startup(){this.logService.debug("Starting VS Code"),this.logService.debug(`from: ${this.environmentMainService.appRoot}`),this.logService.debug("args:",this.environmentMainService.args);const i=this.productService.win32AppUserModelId;x&&i&&R.setAppUserModelId(i);try{E&&this.configurationService.getValue("window.nativeTabs")===!0&&!J.getUserDefault("NSUseImprovedLayoutPass","boolean")&&J.setUserDefault("NSUseImprovedLayoutPass","boolean",!0)}catch(s){this.logService.error(s)}const t=new ir;F.once(this.lifecycleMainService.onWillShutdown)(s=>{s.reason===Ar.KILL&&t.dispose()}),this.logService.trace("Resolving machine identifier...");const[n,e,r]=await Promise.all([Si(this.stateService,this.logService),gi(this.stateService,this.logService),fi(this.stateService,this.logService)]);this.logService.trace(`Resolved machine identifier: ${n}`);const{sharedProcessReady:a,sharedProcessClient:l}=this.setupSharedProcess(n,e,r),d=await this.initServices(n,e,r,a);d.invokeFunction(s=>s.get(me)),this._register(d.createInstance(xi)),d.invokeFunction(s=>this.initChannels(s,t,l));const o=await d.invokeFunction(s=>this.setupProtocolUrlHandlers(s,t));this.setupManagedRemoteResourceUrlHandler(t),this.lifecycleMainService.phase=_.Ready,await d.invokeFunction(s=>this.openFirstWindow(s,o)),this.lifecycleMainService.phase=_.AfterWindowOpen,this.afterWindowOpen(),this._register(new Ae(()=>{this._register(Fe(()=>this.lifecycleMainService.phase=_.Eventually,2500))},2500)).schedule()}async setupProtocolUrlHandlers(i,t){const n=this.windowsMainService=i.get(k),e=i.get($),r=this.nativeHostMainService=i.get(q),a=i.get(ne),l=this;e.registerHandler({async handleURL(u,g){return l.handleProtocolUrl(n,a,e,u,g)}});const d=this._register(new _i({onDidOpenMainWindow:r.onDidOpenMainWindow,onDidFocusMainWindow:r.onDidFocusMainWindow,getActiveWindowId:()=>r.getActiveWindowId(-1)})),o=new rr(u=>d.getActiveClientId().then(g=>u===g)),c=new Oi(o,this.logService),s=t.getChannel("urlHandler",c);e.registerHandler(new Wi(s));const m=await this.resolveInitialProtocolUrls(n,a);return this._register(new Ei(m?.urls,e,n,this.environmentMainService,this.productService,this.logService)),m}setupManagedRemoteResourceUrlHandler(i){const t=()=>({statusCode:404,data:"Not found"}),n=new Be(()=>i.getChannel(Yr,new jr));j.registerBufferProtocol(v.vscodeManagedRemoteResource,(e,r)=>{const a=w.parse(e.url);if(!a.authority.startsWith("window:"))return r(t());n.value.call(zr,[a]).then(l=>r({...l,data:Buffer.from(l.body,"base64")}),l=>{this.logService.warn("error dispatching remote resource call",l),r({statusCode:500,data:String(l)})})})}async resolveInitialProtocolUrls(i,t){const n=this.environmentMainService.args["open-url"]?this.environmentMainService.args._urls||[]:[];n.length>0&&this.logService.trace("app#resolveInitialProtocolUrls() protocol urls from command line:",n);const e=global.getOpenUrls()||[];if(e.length>0&&this.logService.trace("app#resolveInitialProtocolUrls() protocol urls from macOS 'open-url' event:",e),n.length+e.length===0)return;const r=[...n,...e].map(d=>{try{return{uri:w.parse(d),originalUrl:d}}catch{this.logService.trace("app#resolveInitialProtocolUrls() protocol url failed to parse:",d);return}}),a=[],l=[];for(const d of r){if(!d)continue;const o=this.getWindowOpenableFromProtocolUrl(d.uri);if(o)if(await this.shouldBlockOpenable(o,i,t)){this.logService.trace("app#resolveInitialProtocolUrls() protocol url was blocked:",d.uri.toString(!0));continue}else this.logService.trace("app#resolveInitialProtocolUrls() protocol url will be handled as window to open:",d.uri.toString(!0),o),a.push(o);else this.logService.trace("app#resolveInitialProtocolUrls() protocol url will be passed to active window for handling:",d.uri.toString(!0)),l.push(d)}return{urls:l,openables:a}}async shouldBlockOpenable(i,t,n){let e,r;if(Di(i)?(e=i.workspaceUri,r=M("confirmOpenMessageWorkspace","An external application wants to open '{0}' in {1}. Do you want to open this workspace file?",e.scheme===v.file?D(e,{os:H,tildify:this.environmentMainService}):e.toString(!0),this.productService.nameShort)):Fi(i)?(e=i.folderUri,r=M("confirmOpenMessageFolder","An external application wants to open '{0}' in {1}. Do you want to open this folder?",e.scheme===v.file?D(e,{os:H,tildify:this.environmentMainService}):e.toString(!0),this.productService.nameShort)):(e=i.fileUri,r=M("confirmOpenMessageFileOrFolder","An external application wants to open '{0}' in {1}. Do you want to open this file or folder?",e.scheme===v.file?D(e,{os:H,tildify:this.environmentMainService}):e.toString(!0),this.productService.nameShort)),e.scheme!==v.file&&e.scheme!==v.vscodeRemote||this.configurationService.getValue(b.SECURITY_PROTOCOL_HANDLING_CONFIRMATION_SETTING_KEY[e.scheme])===!1)return!1;const{response:l,checkboxChecked:d}=await n.showMessageBox({type:"warning",buttons:[M({key:"open",comment:["&& denotes a mnemonic"]},"&&Yes"),M({key:"cancel",comment:["&& denotes a mnemonic"]},"&&No")],message:r,detail:M("confirmOpenDetail","If you did not initiate this request, it may represent an attempted attack on your system. Unless you took an explicit action to initiate this request, you should press 'No'"),checkboxLabel:e.scheme===v.file?M("doNotAskAgainLocal","Allow opening local paths without asking"):M("doNotAskAgainRemote","Allow opening remote paths without asking"),cancelId:1});if(l!==0)return!0;if(d){const o={channel:"vscode:disablePromptForProtocolHandling",args:e.scheme===v.file?"local":"remote"};t.sendToFocused(o.channel,o.args),t.sendToOpeningWindow(o.channel,o.args)}return!1}getWindowOpenableFromProtocolUrl(i){if(i.path){if(i.authority===v.file){const t=w.file(i.fsPath);return N(t)?{workspaceUri:t}:{fileUri:t}}else if(i.authority===v.vscodeRemote){const t=i.path.indexOf(Ye.sep,1);let n,e;t!==-1?(n=i.path.substring(1,t),e=i.path.substring(t)):(n=i.path.substring(1),e="/");let r=i.query;const a=new URLSearchParams(i.query);a.get("windowId")==="_blank"&&(a.delete("windowId"),r=a.toString());const l=w.from({scheme:v.vscodeRemote,authority:n,path:e,query:r,fragment:i.fragment});return N(e)?{workspaceUri:l}:/:[\d]+$/.test(e)?{fileUri:l}:{folderUri:l}}}}async handleProtocolUrl(i,t,n,e,r){this.logService.trace("app#handleProtocolUrl():",e.toString(!0),r),e.scheme===this.productService.urlProtocol&&e.path==="workspace"&&(e=e.with({authority:"file",path:w.parse(e.query).path,query:""}));let a=!1;const l=new URLSearchParams(e.query);l.get("windowId")==="_blank"?(this.logService.trace("app#handleProtocolUrl() found 'windowId=_blank' as parameter, setting shouldOpenInNewWindow=true:",e.toString(!0)),l.delete("windowId"),e=e.with({query:l.toString()}),a=!0):E&&i.getWindowCount()===0&&(this.logService.trace("app#handleProtocolUrl() running on macOS with no window open, setting shouldOpenInNewWindow=true:",e.toString(!0)),a=!0);const d=l.get("continueOn");d!==null&&(this.logService.trace("app#handleProtocolUrl() found 'continueOn' as parameter:",e.toString(!0)),l.delete("continueOn"),e=e.with({query:l.toString()}),this.environmentMainService.continueOn=d??void 0);const o=this.getWindowOpenableFromProtocolUrl(e);return o?await this.shouldBlockOpenable(o,i,t)?(this.logService.trace("app#handleProtocolUrl() protocol url was blocked:",e.toString(!0)),!0):(this.logService.trace("app#handleProtocolUrl() opening protocol url as window:",o,e.toString(!0)),Z(await i.open({context:I.LINK,cli:{...this.environmentMainService.args},urisToOpen:[o],forceNewWindow:a,gotoLineMode:!0}))?.focus(),!0):a?(this.logService.trace("app#handleProtocolUrl() opening empty window and passing in protocol url:",e.toString(!0)),await Z(await i.open({context:I.LINK,cli:{...this.environmentMainService.args},forceNewWindow:!0,forceEmpty:!0,gotoLineMode:!0,remoteAuthority:Jr(e)}))?.ready(),n.open(e,r)):(this.logService.trace("app#handleProtocolUrl(): not handled",e.toString(!0),r),!1)}setupSharedProcess(i,t,n){const e=this._register(this.mainInstantiationService.createInstance(Xr,i,t,n));this._register(e.onDidCrash(()=>this.windowsMainService?.sendToFocused("vscode:reportSharedProcessCrash")));const r=(async()=>{this.logService.trace("Main->SharedProcess#connect");const l=await e.connect();return this.logService.trace("Main->SharedProcess#connect: connection established"),new tr(l,"main")})();return{sharedProcessReady:(async()=>(await e.whenReady(),r))(),sharedProcessClient:r}}async initServices(i,t,n,e){const r=new Lr;switch(process.platform){case"win32":r.set(O,new p(bi));break;case"linux":je?r.set(O,new p(Ui,[process.env.SNAP,process.env.SNAP_REVISION])):r.set(O,new p(Ri));break;case"darwin":r.set(O,new p(Pi));break}r.set(k,new p(Hi,[i,t,n,this.userEnv],!1)),r.set(ie,new p(nr,void 0,!1));const a=new mr(this.logService,this.productService);r.set(ne,a),r.set(pe,new p(kr,void 0,!1)),r.set(te,new p(vr,void 0,!1)),r.set(pr,h.toService(re(e.then(s=>s.getChannel("diagnostics"))))),r.set(ce,new p(Er,[this.userEnv])),r.set(le,new p(xr,[this.userEnv])),r.set(oe,new p(hr)),r.set(de,new p(Tr)),r.set(q,new p($r,void 0,!1)),r.set(ge,new p(Ai)),r.set(ve,new p(qr)),r.set(se,new p(Ir)),r.set(B,new p(si)),r.set(oi,new p(ni));const l=new Mi({graceTime:fe.GraceTime,shortGraceTime:fe.ShortGraceTime,scrollback:this.configurationService.getValue(yi.PersistentSessionScrollback)??100},this.configurationService,this.environmentMainService,this.lifecycleMainService,this.logService),d=new Ii(l,this.configurationService,this.logService,this.loggerService);r.set(ue,d),x?r.set(T,new p(Rr)):E?r.set(T,new p(Pr)):ze&&r.set(T,new p(Cr));const o=new sr(this.environmentMainService,this.configurationService,this.logService,this.stateService);r.set(or,o);const c=new Vi(this.environmentMainService,this.logService,this.userDataProfilesMainService,o,a);if(r.set(Ki,c),r.set(we,new p($i,void 0,!1)),r.set(qi,new p(Bi,void 0,!1)),r.set($,new p(Li,void 0,!1)),ui(this.productService,this.environmentMainService)){const s=mi(this.productService,this.configurationService),m=re(e.then(A=>A.getChannel("telemetryAppender"))),u=new li(m),g=ai(Te(),xe(),process.arch,this.productService.commit,this.productService.version,i,t,n,s),f=pi(this.environmentMainService),P={appenders:[u],commonProperties:g,piiPaths:f,sendErrorTelemetry:!0};r.set(he,new p(di,[P],!1))}else r.set(he,hi);return r.set(Sr,new p(wr,void 0,!0)),r.set(gr,new p(yr,void 0,!0)),r.set(Se,new p(Ni,void 0,!0)),r.set(me,new p(Br)),r.set(lr,new p(cr,void 0,!0)),await Ne.settled([o.initialize(),c.initialize()]),this.mainInstantiationService.createChild(r)}initChannels(i,t,n){const e=this._register(new Ke),r=h.fromService(i.get(pe),e,{disableMarshalling:!0});this.mainProcessNodeIpcServer.registerChannel("launch",r);const a=h.fromService(i.get(te),e,{disableMarshalling:!0});this.mainProcessNodeIpcServer.registerChannel("diagnostics",a);const l=e.add(new Vr(i.get(Kr)));t.registerChannel("policy",l),n.then(S=>S.registerChannel("policy",l));const d=this.fileService.getProvider(v.file);Je(d instanceof Wr);const o=e.add(new br(d,this.logService,this.environmentMainService));t.registerChannel(ae,o),n.then(S=>S.registerChannel(ae,o));const c=h.fromService(i.get(K),e);t.registerChannel("userDataProfiles",c),n.then(S=>S.registerChannel("userDataProfiles",c));const s=new Qr(i.get(Zr));n.then(S=>S.registerChannel("request",s));const m=new Ci(i.get(O));t.registerChannel("update",m);const u=h.fromService(i.get(ce),e);t.registerChannel("issue",u);const g=h.fromService(i.get(le),e);t.registerChannel("process",g);const f=h.fromService(i.get(oe),e);t.registerChannel("encryption",f);const P=h.fromService(i.get(ri),e);t.registerChannel("sign",P);const A=h.fromService(i.get(de),e);t.registerChannel("keyboardLayout",A),this.nativeHostMainService=i.get(q);const V=h.fromService(this.nativeHostMainService,e);t.registerChannel("nativeHost",V),n.then(S=>S.registerChannel("nativeHost",V));const ye=h.fromService(i.get(we),e);t.registerChannel("workspaces",ye);const Me=h.fromService(i.get(ve),e);t.registerChannel("menubar",Me);const Ie=h.fromService(i.get($),e);t.registerChannel("url",Ie);const Ce=h.fromService(i.get(ge),e);t.registerChannel("webview",Ce);const G=e.add(new ti(this.logService,i.get(B)));t.registerChannel("storage",G),n.then(S=>S.registerChannel("storage",G));const Pe=e.add(new Ti(i.get(B),i.get(K),this.logService));n.then(S=>S.registerChannel("profileStorageListener",Pe));const Re=h.fromService(i.get(ue),e);t.registerChannel(wi.LocalPty,Re);const Ue=h.fromService(i.get(T),e);t.registerChannel("externalTerminal",Ue);const Y=new _r(i.get(Hr));t.registerChannel("logger",Y),n.then(S=>S.registerChannel("logger",Y));const be=new dr(i.get(k));t.registerChannel("extensionhostdebugservice",be);const We=h.fromService(i.get(se),e);t.registerChannel(Mr,We);const Oe=h.fromService(i.get(Se),e);t.registerChannel(ki,Oe)}async openFirstWindow(i,t){const n=this.windowsMainService=i.get(k);this.auxiliaryWindowsMainService=i.get(ie);const e=fr(process.env)?I.CLI:I.DESKTOP,r=this.environmentMainService.args;if(t){if(t.openables.length>0)return n.open({context:e,cli:r,urisToOpen:t.openables,gotoLineMode:!0,initialStartup:!0});if(t.urls.length>0)for(const f of t.urls){const P=new URLSearchParams(f.uri.query);if(P.get("windowId")==="_blank")return P.delete("windowId"),f.originalUrl=f.uri.toString(!0),f.uri=f.uri.with({query:P.toString()}),n.open({context:e,cli:r,forceNewWindow:!0,forceEmpty:!0,gotoLineMode:!0,initialStartup:!0})}}const a=global.macOpenFiles,l=r._.length,d=!!r["folder-uri"],o=!!r["file-uri"],c=r["skip-add-to-recently-opened"]===!0,s=r.wait&&r.waitMarkerFilePath?w.file(r.waitMarkerFilePath):void 0,m=r.remote||void 0,u=r.profile,g=r["profile-temp"];if(!l&&!d&&!o){if(r["new-window"]||u||g)return n.open({context:e,cli:r,forceNewWindow:!0,forceEmpty:!0,noRecentEntry:c,waitMarkerFileURI:s,initialStartup:!0,remoteAuthority:m,forceProfile:u,forceTempProfile:g});if(a.length)return n.open({context:I.DOCK,cli:r,urisToOpen:a.map(f=>(f=ee(f),N(f)?{workspaceUri:w.file(f)}:{fileUri:w.file(f)})),noRecentEntry:c,waitMarkerFileURI:s,initialStartup:!0})}return n.open({context:e,cli:r,forceNewWindow:r["new-window"],diffMode:r.diff,mergeMode:r.merge,noRecentEntry:c,waitMarkerFileURI:s,gotoLineMode:r.goto,initialStartup:!0,remoteAuthority:m,forceProfile:u,forceTempProfile:g})}afterWindowOpen(){this.installMutex(),j.registerHttpProtocol(v.vscodeRemoteResource,(i,t)=>{t({url:i.url.replace(/^vscode-remote-resource:/,"http:"),method:i.method})}),this.resolveShellEnvironment(this.environmentMainService.args,process.env,!0),this.updateCrashReporterEnablement(),E&&R.runningUnderARM64Translation&&this.windowsMainService?.sendToFocused("vscode:showTranslatedBuildWarning")}async installMutex(){const i=this.productService.win32MutexName;if(x&&i)try{const t=await import("@vscode/windows-mutex"),n=new t.Mutex(i);F.once(this.lifecycleMainService.onWillShutdown)(()=>n.release())}catch(t){this.logService.error(t)}}async resolveShellEnvironment(i,t,n){try{return await ei(this.configurationService,this.logService,i,t)}catch(e){const r=De(e);n?this.windowsMainService?.sendToFocused("vscode:showResolveShellEnvError",r):this.logService.error(r)}return{}}async updateCrashReporterEnablement(){try{const t=(await this.fileService.readFile(this.environmentMainService.argvResource)).value.toString(),n=qe(t),r=vi(this.configurationService)>=ci.CRASH;if(n["enable-crash-reporter"]===void 0){const a=["","	// Allows to disable crash reporting.","	// Should restart the app if the value is changed.",`	"enable-crash-reporter": ${r},`,"","	// Unique id used for correlating crash reports sent from this instance.","	// Do not edit this value.",`	"crash-reporter-id": "${Ze()}"`,"}"],l=t.substring(0,t.length-2).concat(`,
`,a.join(`
`));await this.fileService.writeFile(this.environmentMainService.argvResource,Q.fromString(l))}else{const a=t.replace(/"enable-crash-reporter": .*,/,`"enable-crash-reporter": ${r},`);a!==t&&await this.fileService.writeFile(this.environmentMainService.argvResource,Q.fromString(a))}}catch(i){this.logService.error(i),this.windowsMainService?.sendToFocused("vscode:showArgvParseWarning")}}};b=z([y(2,Or),y(3,Dr),y(4,Fr),y(5,ur),y(6,Nr),y(7,ar),y(8,ii),y(9,Ur),y(10,Gr),y(11,K)],b);export{b as CodeApplication};
