import*as k from"fs";import{hostname as _,release as H}from"os";import{raceTimeout as b}from"../../../vs/base/common/async.js";import{toErrorMessage as q}from"../../../vs/base/common/errorMessage.js";import{isSigPipeError as W,onUnexpectedError as N,setUnexpectedErrorHandler as X}from"../../../vs/base/common/errors.js";import{Disposable as $}from"../../../vs/base/common/lifecycle.js";import{Schemas as p}from"../../../vs/base/common/network.js";import{isAbsolute as j,join as z}from"../../../vs/base/common/path.js";import{isWindows as C}from"../../../vs/base/common/platform.js";import{cwd as G}from"../../../vs/base/common/process.js";import{URI as K}from"../../../vs/base/common/uri.js";import{addUNCHostToAllowlist as B,getUNCHost as Y}from"vs/base/node/unc";import{localize as J}from"../../../vs/nls.js";import{IConfigurationService as Q}from"../../../vs/platform/configuration/common/configuration.js";import{ConfigurationService as Z}from"../../../vs/platform/configuration/common/configurationService.js";import{IDownloadService as ee}from"../../../vs/platform/download/common/download.js";import{DownloadService as re}from"../../../vs/platform/download/common/downloadService.js";import"../../../vs/platform/environment/common/argv.js";import{INativeEnvironmentService as D}from"../../../vs/platform/environment/common/environment.js";import{NativeEnvironmentService as ie}from"../../../vs/platform/environment/node/environmentService.js";import{ExtensionGalleryServiceWithNoStorageService as te}from"../../../vs/platform/extensionManagement/common/extensionGalleryService.js";import{IExtensionGalleryService as oe}from"../../../vs/platform/extensionManagement/common/extensionManagement.js";import{ExtensionManagementCLI as g}from"../../../vs/platform/extensionManagement/common/extensionManagementCLI.js";import{IExtensionsProfileScannerService as ne}from"../../../vs/platform/extensionManagement/common/extensionsProfileScannerService.js";import{IExtensionsScannerService as se}from"../../../vs/platform/extensionManagement/common/extensionsScannerService.js";import{ExtensionManagementService as ae,INativeServerExtensionManagementService as ce}from"../../../vs/platform/extensionManagement/node/extensionManagementService.js";import{ExtensionSignatureVerificationService as me,IExtensionSignatureVerificationService as le}from"../../../vs/platform/extensionManagement/node/extensionSignatureVerificationService.js";import{ExtensionsProfileScannerService as fe}from"../../../vs/platform/extensionManagement/node/extensionsProfileScannerService.js";import{ExtensionsScannerService as ve}from"../../../vs/platform/extensionManagement/node/extensionsScannerService.js";import{IFileService as U}from"../../../vs/platform/files/common/files.js";import{FileService as pe}from"../../../vs/platform/files/common/fileService.js";import{DiskFileSystemProvider as ge}from"../../../vs/platform/files/node/diskFileSystemProvider.js";import{SyncDescriptor as a}from"../../../vs/platform/instantiation/common/descriptors.js";import"../../../vs/platform/instantiation/common/instantiation.js";import{InstantiationService as de}from"../../../vs/platform/instantiation/common/instantiationService.js";import{ServiceCollection as Se}from"../../../vs/platform/instantiation/common/serviceCollection.js";import{ILanguagePackService as ue}from"../../../vs/platform/languagePacks/common/languagePacks.js";import{NativeLanguagePackService as Ie}from"../../../vs/platform/languagePacks/node/languagePacks.js";import{ConsoleLogger as l,getLogLevel as he,ILoggerService as we,ILogService as T,LogLevel as f}from"../../../vs/platform/log/common/log.js";import{LogService as Pe}from"../../../vs/platform/log/common/logService.js";import{LoggerService as ye}from"../../../vs/platform/log/node/loggerService.js";import{FilePolicyService as xe}from"../../../vs/platform/policy/common/filePolicyService.js";import{IPolicyService as Ee,NullPolicyService as Le}from"../../../vs/platform/policy/common/policy.js";import{NativePolicyService as Ne}from"../../../vs/platform/policy/node/nativePolicyService.js";import Ce from"../../../vs/platform/product/common/product.js";import{IProductService as De}from"../../../vs/platform/product/common/productService.js";import{IRequestService as Ue}from"../../../vs/platform/request/common/request.js";import{RequestService as Te}from"../../../vs/platform/request/node/requestService.js";import{SaveStrategy as Re,StateReadonlyService as Fe}from"../../../vs/platform/state/node/stateService.js";import{resolveCommonProperties as Ae}from"../../../vs/platform/telemetry/common/commonProperties.js";import{ITelemetryService as R}from"../../../vs/platform/telemetry/common/telemetry.js";import{TelemetryService as Me}from"../../../vs/platform/telemetry/common/telemetryService.js";import{getPiiPathsFromEnvironment as Oe,isInternalTelemetry as Ve,NullTelemetryService as ke,supportsTelemetry as _e}from"../../../vs/platform/telemetry/common/telemetryUtils.js";import{OneDataSystemAppender as He}from"../../../vs/platform/telemetry/node/1dsAppender.js";import{buildTelemetryMessage as be}from"../../../vs/platform/telemetry/node/telemetry.js";import{resolvedevDeviceId as qe,resolveMachineId as We,resolveSqmId as Xe}from"../../../vs/platform/telemetry/node/telemetryUtils.js";import{IUriIdentityService as F}from"../../../vs/platform/uriIdentity/common/uriIdentity.js";import{UriIdentityService as A}from"../../../vs/platform/uriIdentity/common/uriIdentityService.js";import{FileUserDataProvider as $e}from"../../../vs/platform/userData/common/fileUserDataProvider.js";import{IUserDataProfilesService as M}from"../../../vs/platform/userDataProfile/common/userDataProfile.js";import{UserDataProfilesReadonlyService as je}from"../../../vs/platform/userDataProfile/node/userDataProfile.js";class ze extends ${constructor(e){super();this.argv=e;this.registerListeners()}registerListeners(){process.once("exit",()=>this.dispose())}async run(){const[e,r]=await this.initServices();return e.invokeFunction(async i=>{const o=i.get(T),c=i.get(U),s=i.get(D),t=i.get(M);o.info("CLI main",this.argv),this.registerErrorHandler(o),await this.doRun(s,c,t,e),await Promise.all(r.map(n=>{b(n.flush(),1e3)}))})}async initServices(){const e=new Se,r={_serviceBrand:void 0,...Ce};e.set(De,r);const i=new ie(this.argv,r);e.set(D,i),await Promise.all([this.allowWindowsUNCPath(i.appSettingsHome.with({scheme:p.file}).fsPath),this.allowWindowsUNCPath(i.extensionsPath)].map(m=>m?k.promises.mkdir(m,{recursive:!0}):void 0));const o=new ye(he(i),i.logsHome);e.set(we,o);const c=this._register(o.createLogger("cli",{name:J("cli","CLI")})),s=[];o.getLogLevel()===f.Trace&&s.push(new l(o.getLogLevel()));const t=this._register(new Pe(c,s));e.set(T,t);const n=this._register(new pe(t));e.set(U,n);const P=this._register(new ge(t));n.registerProvider(p.file,P);const I=new A(n);e.set(F,I);const v=new Fe(Re.DELAYED,i,t,n),d=new je(v,I,i,n,t);e.set(M,d),n.registerProvider(p.vscodeUserData,new $e(p.file,P,p.vscodeUserData,d,I,t));const y=C&&r.win32RegValueName?this._register(new Ne(t,r.win32RegValueName)):i.policyFile?this._register(new xe(i.policyFile,n,t)):new Le;e.set(Ee,y);const S=this._register(new Z(d.defaultProfile.settingsResource,n,y,t));e.set(Q,S),await Promise.all([v.init(),S.initialize()]);let x;try{x=await We(v,t)}catch(m){m.code!=="ENOENT"&&t.error(m)}const O=await Xe(v,t),V=await qe(v,t);d.init(),e.set(F,new A(n));const E=new Te(S,i,t,o);e.set(Ue,E),e.set(ee,new a(re,void 0,!0)),e.set(ne,new a(fe,void 0,!0)),e.set(se,new a(ve,void 0,!0)),e.set(le,new a(me,void 0,!0)),e.set(ce,new a(ae,void 0,!0)),e.set(oe,new a(te,void 0,!0)),e.set(ue,new a(Ie,void 0,!1));const h=[],L=Ve(r,S);if(_e(r,i)){r.aiConfig&&r.aiConfig.ariaKey&&h.push(new He(E,L,"monacoworkbench",null,r.aiConfig.ariaKey));const m={appenders:h,sendErrorTelemetry:!1,commonProperties:Ae(H(),_(),process.arch,r.commit,r.version,x,O,V,L),piiPaths:Oe(i)};e.set(R,new a(Me,[m],!1))}else e.set(R,ke);return[new de(e),h]}allowWindowsUNCPath(e){if(C){const r=Y(e);r&&B(r)}return e}registerErrorHandler(e){X(r=>{const i=q(r,!0);i&&e.error(`[uncaught exception in CLI]: ${i}`)}),process.on("uncaughtException",r=>{W(r)||N(r)}),process.on("unhandledRejection",r=>N(r))}async doRun(e,r,i,o){let c;if(e.args.profile&&(c=i.profiles.find(t=>t.name===e.args.profile),!c))throw new Error(`Profile '${e.args.profile}' not found.`);const s=(c??i.defaultProfile).extensionsResource;if(this.argv["list-extensions"])return o.createInstance(g,new l(f.Info,!1)).listExtensions(!!this.argv["show-versions"],this.argv.category,s);if(this.argv["install-extension"]||this.argv["install-builtin-extension"]){const t={isMachineScoped:!!this.argv["do-not-sync"],installPreReleaseVersion:!!this.argv["pre-release"],profileLocation:s};return o.createInstance(g,new l(f.Info,!1)).installExtensions(this.asExtensionIdOrVSIX(this.argv["install-extension"]||[]),this.asExtensionIdOrVSIX(this.argv["install-builtin-extension"]||[]),t,!!this.argv.force)}else{if(this.argv["uninstall-extension"])return o.createInstance(g,new l(f.Info,!1)).uninstallExtensions(this.asExtensionIdOrVSIX(this.argv["uninstall-extension"]),!!this.argv.force,s);if(this.argv["update-extensions"])return o.createInstance(g,new l(f.Info,!1)).updateExtensions(s);if(this.argv["locate-extension"])return o.createInstance(g,new l(f.Info,!1)).locateExtension(this.argv["locate-extension"]);this.argv.telemetry&&console.log(await be(e.appRoot,e.extensionsPath))}}asExtensionIdOrVSIX(e){return e.map(r=>/\.vsix$/i.test(r)?K.file(j(r)?r:z(G(),r)):r)}}async function si(w){const u=new ze(w);try{await u.run()}finally{u.dispose()}}export{si as main};
