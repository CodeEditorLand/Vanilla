import*as k from"fs";import{hostname as _,release as b}from"os";import{raceTimeout as H}from"../../base/common/async.js";import{toErrorMessage as q}from"../../base/common/errorMessage.js";import{isSigPipeError as W,onUnexpectedError as N,setUnexpectedErrorHandler as j}from"../../base/common/errors.js";import{Disposable as X}from"../../base/common/lifecycle.js";import{Schemas as p}from"../../base/common/network.js";import{isAbsolute as $,join as z}from"../../base/common/path.js";import{isWindows as C}from"../../base/common/platform.js";import{cwd as G}from"../../base/common/process.js";import{URI as K}from"../../base/common/uri.js";import{addUNCHostToAllowlist as B,getUNCHost as Y}from"../../base/node/unc.js";import{localize as J}from"../../nls.js";import{IConfigurationService as Q}from"../../platform/configuration/common/configuration.js";import{ConfigurationService as Z}from"../../platform/configuration/common/configurationService.js";import{IDownloadService as ee}from"../../platform/download/common/download.js";import{DownloadService as re}from"../../platform/download/common/downloadService.js";import{INativeEnvironmentService as D}from"../../platform/environment/common/environment.js";import{NativeEnvironmentService as ie}from"../../platform/environment/node/environmentService.js";import{ExtensionGalleryServiceWithNoStorageService as te}from"../../platform/extensionManagement/common/extensionGalleryService.js";import{IExtensionGalleryService as oe}from"../../platform/extensionManagement/common/extensionManagement.js";import{ExtensionManagementCLI as g}from"../../platform/extensionManagement/common/extensionManagementCLI.js";import{IExtensionsProfileScannerService as ne}from"../../platform/extensionManagement/common/extensionsProfileScannerService.js";import{IExtensionsScannerService as se}from"../../platform/extensionManagement/common/extensionsScannerService.js";import{ExtensionManagementService as ae,INativeServerExtensionManagementService as me}from"../../platform/extensionManagement/node/extensionManagementService.js";import{ExtensionSignatureVerificationService as ce,IExtensionSignatureVerificationService as le}from"../../platform/extensionManagement/node/extensionSignatureVerificationService.js";import{ExtensionsProfileScannerService as fe}from"../../platform/extensionManagement/node/extensionsProfileScannerService.js";import{ExtensionsScannerService as ve}from"../../platform/extensionManagement/node/extensionsScannerService.js";import{FileService as pe}from"../../platform/files/common/fileService.js";import{IFileService as U}from"../../platform/files/common/files.js";import{DiskFileSystemProvider as ge}from"../../platform/files/node/diskFileSystemProvider.js";import{SyncDescriptor as a}from"../../platform/instantiation/common/descriptors.js";import{InstantiationService as de}from"../../platform/instantiation/common/instantiationService.js";import{ServiceCollection as Se}from"../../platform/instantiation/common/serviceCollection.js";import{ILanguagePackService as ue}from"../../platform/languagePacks/common/languagePacks.js";import{NativeLanguagePackService as Ie}from"../../platform/languagePacks/node/languagePacks.js";import{ConsoleLogger as l,ILogService as T,ILoggerService as he,LogLevel as f,getLogLevel as we}from"../../platform/log/common/log.js";import{LogService as ye}from"../../platform/log/common/logService.js";import{LoggerService as Pe}from"../../platform/log/node/loggerService.js";import{FilePolicyService as xe}from"../../platform/policy/common/filePolicyService.js";import{IPolicyService as Ee,NullPolicyService as Le}from"../../platform/policy/common/policy.js";import{NativePolicyService as Ne}from"../../platform/policy/node/nativePolicyService.js";import Ce from"../../platform/product/common/product.js";import{IProductService as De}from"../../platform/product/common/productService.js";import{IRequestService as Ue}from"../../platform/request/common/request.js";import{RequestService as Te}from"../../platform/request/node/requestService.js";import{SaveStrategy as Re,StateReadonlyService as Fe}from"../../platform/state/node/stateService.js";import{resolveCommonProperties as Ae}from"../../platform/telemetry/common/commonProperties.js";import{ITelemetryService as R}from"../../platform/telemetry/common/telemetry.js";import{TelemetryService as Me}from"../../platform/telemetry/common/telemetryService.js";import{NullTelemetryService as Oe,getPiiPathsFromEnvironment as Ve,isInternalTelemetry as ke,supportsTelemetry as _e}from"../../platform/telemetry/common/telemetryUtils.js";import{OneDataSystemAppender as be}from"../../platform/telemetry/node/1dsAppender.js";import"../../platform/telemetry/node/telemetry.js";import{resolveMachineId as He,resolveSqmId as qe,resolvedevDeviceId as We}from"../../platform/telemetry/node/telemetryUtils.js";import{IUriIdentityService as F}from"../../platform/uriIdentity/common/uriIdentity.js";import{UriIdentityService as A}from"../../platform/uriIdentity/common/uriIdentityService.js";import{FileUserDataProvider as je}from"../../platform/userData/common/fileUserDataProvider.js";import{IUserDataProfilesService as M}from"../../platform/userDataProfile/common/userDataProfile.js";import{UserDataProfilesReadonlyService as Xe}from"../../platform/userDataProfile/node/userDataProfile.js";class $e extends X{constructor(e){super();this.argv=e;this.registerListeners()}registerListeners(){process.once("exit",()=>this.dispose())}async run(){const[e,r]=await this.initServices();return e.invokeFunction(async i=>{const o=i.get(T),m=i.get(U),s=i.get(D),t=i.get(M);o.info("CLI main",this.argv),this.registerErrorHandler(o),await this.doRun(s,m,t,e),await Promise.all(r.map(n=>{H(n.flush(),1e3)}))})}async initServices(){const e=new Se,r={_serviceBrand:void 0,...Ce};e.set(De,r);const i=new ie(this.argv,r);e.set(D,i),await Promise.all([this.allowWindowsUNCPath(i.appSettingsHome.with({scheme:p.file}).fsPath),this.allowWindowsUNCPath(i.extensionsPath)].map(c=>c?k.promises.mkdir(c,{recursive:!0}):void 0));const o=new Pe(we(i),i.logsHome);e.set(he,o);const m=this._register(o.createLogger("cli",{name:J("cli","CLI")})),s=[];o.getLogLevel()===f.Trace&&s.push(new l(o.getLogLevel()));const t=this._register(new ye(m,s));e.set(T,t);const n=this._register(new pe(t));e.set(U,n);const y=this._register(new ge(t));n.registerProvider(p.file,y);const I=new A(n);e.set(F,I);const v=new Fe(Re.DELAYED,i,t,n),d=new Xe(v,I,i,n,t);e.set(M,d),n.registerProvider(p.vscodeUserData,new je(p.file,y,p.vscodeUserData,d,I,t));const P=C&&r.win32RegValueName?this._register(new Ne(t,r.win32RegValueName)):i.policyFile?this._register(new xe(i.policyFile,n,t)):new Le;e.set(Ee,P);const S=this._register(new Z(d.defaultProfile.settingsResource,n,P,t));e.set(Q,S),await Promise.all([v.init(),S.initialize()]);let x;try{x=await He(v,t)}catch(c){c.code!=="ENOENT"&&t.error(c)}const O=await qe(v,t),V=await We(v,t);d.init(),e.set(F,new A(n));const E=new Te(S,i,t);e.set(Ue,E),e.set(ee,new a(re,void 0,!0)),e.set(ne,new a(fe,void 0,!0)),e.set(se,new a(ve,void 0,!0)),e.set(le,new a(ce,void 0,!0)),e.set(me,new a(ae,void 0,!0)),e.set(oe,new a(te,void 0,!0)),e.set(ue,new a(Ie,void 0,!1));const h=[],L=ke(r,S);if(_e(r,i)){r.aiConfig&&r.aiConfig.ariaKey&&h.push(new be(E,L,"monacoworkbench",null,r.aiConfig.ariaKey));const c={appenders:h,sendErrorTelemetry:!1,commonProperties:Ae(b(),_(),process.arch,r.commit,r.version,x,O,V,L),piiPaths:Ve(i)};e.set(R,new a(Me,[c],!1))}else e.set(R,Oe);return[new de(e),h]}allowWindowsUNCPath(e){if(C){const r=Y(e);r&&B(r)}return e}registerErrorHandler(e){j(r=>{const i=q(r,!0);i&&e.error(`[uncaught exception in CLI]: ${i}`)}),process.on("uncaughtException",r=>{W(r)||N(r)}),process.on("unhandledRejection",r=>N(r))}async doRun(e,r,i,o){let m;if(e.args.profile&&(m=i.profiles.find(t=>t.name===e.args.profile),!m))throw new Error(`Profile '${e.args.profile}' not found.`);const s=(m??i.defaultProfile).extensionsResource;if(this.argv["list-extensions"])return o.createInstance(g,new l(f.Info,!1)).listExtensions(!!this.argv["show-versions"],this.argv.category,s);if(this.argv["install-extension"]||this.argv["install-builtin-extension"]){const t={isMachineScoped:!!this.argv["do-not-sync"],installPreReleaseVersion:!!this.argv["pre-release"],profileLocation:s};return o.createInstance(g,new l(f.Info,!1)).installExtensions(this.asExtensionIdOrVSIX(this.argv["install-extension"]||[]),this.asExtensionIdOrVSIX(this.argv["install-builtin-extension"]||[]),t,!!this.argv.force)}else{if(this.argv["uninstall-extension"])return o.createInstance(g,new l(f.Info,!1)).uninstallExtensions(this.asExtensionIdOrVSIX(this.argv["uninstall-extension"]),!!this.argv.force,s);if(this.argv["update-extensions"])return o.createInstance(g,new l(f.Info,!1)).updateExtensions(s);if(this.argv["locate-extension"])return o.createInstance(g,new l(f.Info,!1)).locateExtension(this.argv["locate-extension"]);this.argv.telemetry}}asExtensionIdOrVSIX(e){return e.map(r=>/\.vsix$/i.test(r)?K.file($(r)?r:z(G(),r)):r)}}async function Jr(w){const u=new $e(w);try{await u.run()}finally{u.dispose()}}export{Jr as main};
