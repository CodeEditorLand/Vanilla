import*as k from"fs";import{hostname as _,release as H}from"os";import{raceTimeout as b}from"../../base/common/async.js";import{toErrorMessage as q}from"../../base/common/errorMessage.js";import{isSigPipeError as W,onUnexpectedError as N,setUnexpectedErrorHandler as X}from"../../base/common/errors.js";import{Disposable as $}from"../../base/common/lifecycle.js";import{Schemas as p}from"../../base/common/network.js";import{isAbsolute as j,join as z}from"../../base/common/path.js";import{isWindows as C}from"../../base/common/platform.js";import{cwd as G}from"../../base/common/process.js";import{URI as K}from"../../base/common/uri.js";import{addUNCHostToAllowlist as B,getUNCHost as Y}from"../../base/node/unc.js";import{localize as J}from"../../nls.js";import{IConfigurationService as Q}from"../../platform/configuration/common/configuration.js";import{ConfigurationService as Z}from"../../platform/configuration/common/configurationService.js";import{IDownloadService as ee}from"../../platform/download/common/download.js";import{DownloadService as re}from"../../platform/download/common/downloadService.js";import"../../platform/environment/common/argv.js";import{INativeEnvironmentService as D}from"../../platform/environment/common/environment.js";import{NativeEnvironmentService as ie}from"../../platform/environment/node/environmentService.js";import{ExtensionGalleryServiceWithNoStorageService as te}from"../../platform/extensionManagement/common/extensionGalleryService.js";import{IExtensionGalleryService as oe}from"../../platform/extensionManagement/common/extensionManagement.js";import{ExtensionManagementCLI as g}from"../../platform/extensionManagement/common/extensionManagementCLI.js";import{IExtensionsProfileScannerService as ne}from"../../platform/extensionManagement/common/extensionsProfileScannerService.js";import{IExtensionsScannerService as se}from"../../platform/extensionManagement/common/extensionsScannerService.js";import{ExtensionManagementService as ae,INativeServerExtensionManagementService as ce}from"../../platform/extensionManagement/node/extensionManagementService.js";import{ExtensionSignatureVerificationService as me,IExtensionSignatureVerificationService as le}from"../../platform/extensionManagement/node/extensionSignatureVerificationService.js";import{ExtensionsProfileScannerService as fe}from"../../platform/extensionManagement/node/extensionsProfileScannerService.js";import{ExtensionsScannerService as ve}from"../../platform/extensionManagement/node/extensionsScannerService.js";import{IFileService as U}from"../../platform/files/common/files.js";import{FileService as pe}from"../../platform/files/common/fileService.js";import{DiskFileSystemProvider as ge}from"../../platform/files/node/diskFileSystemProvider.js";import{SyncDescriptor as a}from"../../platform/instantiation/common/descriptors.js";import"../../platform/instantiation/common/instantiation.js";import{InstantiationService as de}from"../../platform/instantiation/common/instantiationService.js";import{ServiceCollection as Se}from"../../platform/instantiation/common/serviceCollection.js";import{ILanguagePackService as ue}from"../../platform/languagePacks/common/languagePacks.js";import{NativeLanguagePackService as Ie}from"../../platform/languagePacks/node/languagePacks.js";import{ConsoleLogger as l,getLogLevel as he,ILoggerService as we,ILogService as T,LogLevel as f,NullLogger as Pe}from"../../platform/log/common/log.js";import{LogService as ye}from"../../platform/log/common/logService.js";import{LoggerService as xe}from"../../platform/log/node/loggerService.js";import{FilePolicyService as Ee}from"../../platform/policy/common/filePolicyService.js";import{IPolicyService as Le,NullPolicyService as Ne}from"../../platform/policy/common/policy.js";import{NativePolicyService as Ce}from"../../platform/policy/node/nativePolicyService.js";import De from"../../platform/product/common/product.js";import{IProductService as Ue}from"../../platform/product/common/productService.js";import{IRequestService as Te}from"../../platform/request/common/request.js";import{RequestService as Re}from"../../platform/request/node/requestService.js";import{SaveStrategy as Fe,StateReadonlyService as Ae}from"../../platform/state/node/stateService.js";import{resolveCommonProperties as Me}from"../../platform/telemetry/common/commonProperties.js";import{ITelemetryService as R}from"../../platform/telemetry/common/telemetry.js";import{TelemetryService as Oe}from"../../platform/telemetry/common/telemetryService.js";import{getPiiPathsFromEnvironment as Ve,isInternalTelemetry as ke,NullTelemetryService as _e,supportsTelemetry as He}from"../../platform/telemetry/common/telemetryUtils.js";import{OneDataSystemAppender as be}from"../../platform/telemetry/node/1dsAppender.js";import{buildTelemetryMessage as qe}from"../../platform/telemetry/node/telemetry.js";import{resolvedevDeviceId as We,resolveMachineId as Xe,resolveSqmId as $e}from"../../platform/telemetry/node/telemetryUtils.js";import{IUriIdentityService as F}from"../../platform/uriIdentity/common/uriIdentity.js";import{UriIdentityService as A}from"../../platform/uriIdentity/common/uriIdentityService.js";import{FileUserDataProvider as je}from"../../platform/userData/common/fileUserDataProvider.js";import{IUserDataProfilesService as M}from"../../platform/userDataProfile/common/userDataProfile.js";import{UserDataProfilesReadonlyService as ze}from"../../platform/userDataProfile/node/userDataProfile.js";class Ge extends ${constructor(e){super();this.argv=e;this.registerListeners()}registerListeners(){process.once("exit",()=>this.dispose())}async run(){const[e,r]=await this.initServices();return e.invokeFunction(async i=>{const o=i.get(T),c=i.get(U),s=i.get(D),t=i.get(M);o.info("CLI main",this.argv),this.registerErrorHandler(o),await this.doRun(s,c,t,e),await Promise.all(r.map(n=>{b(n.flush(),1e3)}))})}async initServices(){const e=new Se,r={_serviceBrand:void 0,...De};e.set(Ue,r);const i=new ie(this.argv,r);e.set(D,i),await Promise.all([this.allowWindowsUNCPath(i.appSettingsHome.with({scheme:p.file}).fsPath),this.allowWindowsUNCPath(i.extensionsPath)].map(m=>m?k.promises.mkdir(m,{recursive:!0}):void 0));const o=new xe(he(i),i.logsHome);e.set(we,o);const c=this._register(o.createLogger("cli",{name:J("cli","CLI")})),s=[];o.getLogLevel()===f.Trace&&s.push(new l(o.getLogLevel()));const t=this._register(new ye(c,s));e.set(T,t);const n=this._register(new pe(t));e.set(U,n);const P=this._register(new ge(t));n.registerProvider(p.file,P);const I=new A(n);e.set(F,I);const v=new Ae(Fe.DELAYED,i,t,n),d=new ze(v,I,i,n,t);e.set(M,d),n.registerProvider(p.vscodeUserData,new je(p.file,P,p.vscodeUserData,d,I,t));const y=C&&r.win32RegValueName?this._register(new Ce(t,r.win32RegValueName)):i.policyFile?this._register(new Ee(i.policyFile,n,t)):new Ne;e.set(Le,y);const S=this._register(new Z(d.defaultProfile.settingsResource,n,y,t));e.set(Q,S),await Promise.all([v.init(),S.initialize()]);let x;try{x=await Xe(v,t)}catch(m){m.code!=="ENOENT"&&t.error(m)}const O=await $e(v,t),V=await We(v,t);d.init(),e.set(F,new A(n));const E=new Re(new Pe,S,i,t);e.set(Te,E),e.set(ee,new a(re,void 0,!0)),e.set(ne,new a(fe,void 0,!0)),e.set(se,new a(ve,void 0,!0)),e.set(le,new a(me,void 0,!0)),e.set(ce,new a(ae,void 0,!0)),e.set(oe,new a(te,void 0,!0)),e.set(ue,new a(Ie,void 0,!1));const h=[],L=ke(r,S);if(He(r,i)){r.aiConfig&&r.aiConfig.ariaKey&&h.push(new be(E,L,"monacoworkbench",null,r.aiConfig.ariaKey));const m={appenders:h,sendErrorTelemetry:!1,commonProperties:Me(H(),_(),process.arch,r.commit,r.version,x,O,V,L),piiPaths:Ve(i)};e.set(R,new a(Oe,[m],!1))}else e.set(R,_e);return[new de(e),h]}allowWindowsUNCPath(e){if(C){const r=Y(e);r&&B(r)}return e}registerErrorHandler(e){X(r=>{const i=q(r,!0);i&&e.error(`[uncaught exception in CLI]: ${i}`)}),process.on("uncaughtException",r=>{W(r)||N(r)}),process.on("unhandledRejection",r=>N(r))}async doRun(e,r,i,o){let c;if(e.args.profile&&(c=i.profiles.find(t=>t.name===e.args.profile),!c))throw new Error(`Profile '${e.args.profile}' not found.`);const s=(c??i.defaultProfile).extensionsResource;if(this.argv["list-extensions"])return o.createInstance(g,new l(f.Info,!1)).listExtensions(!!this.argv["show-versions"],this.argv.category,s);if(this.argv["install-extension"]||this.argv["install-builtin-extension"]){const t={isMachineScoped:!!this.argv["do-not-sync"],installPreReleaseVersion:!!this.argv["pre-release"],profileLocation:s};return o.createInstance(g,new l(f.Info,!1)).installExtensions(this.asExtensionIdOrVSIX(this.argv["install-extension"]||[]),this.asExtensionIdOrVSIX(this.argv["install-builtin-extension"]||[]),t,!!this.argv.force)}else{if(this.argv["uninstall-extension"])return o.createInstance(g,new l(f.Info,!1)).uninstallExtensions(this.asExtensionIdOrVSIX(this.argv["uninstall-extension"]),!!this.argv.force,s);if(this.argv["update-extensions"])return o.createInstance(g,new l(f.Info,!1)).updateExtensions(s);if(this.argv["locate-extension"])return o.createInstance(g,new l(f.Info,!1)).locateExtension(this.argv["locate-extension"]);this.argv.telemetry&&console.log(await qe(e.appRoot,e.extensionsPath))}}asExtensionIdOrVSIX(e){return e.map(r=>/\.vsix$/i.test(r)?K.file(j(r)?r:z(G(),r)):r)}}async function ai(w){const u=new Ge(w);try{await u.run()}finally{u.dispose()}}export{ai as main};
