import{Disposable as f}from"../../../../base/common/lifecycle.js";import{StringBuilder as p}from"../../../common/core/stringBuilder.js";import{FontStyle as l,TokenMetadata as h}from"../../../common/encodedTokenAttributes.js";import{ensureNonNullable as c}from"../gpuUtils.js";let y=0;class u extends f{constructor(n,i){super();this._fontSize=n;this._fontFamily=i;this._canvas=new OffscreenCanvas(this._fontSize*3,this._fontSize*3),this._ctx=c(this._canvas.getContext("2d",{willReadFrequently:!0})),this._ctx.textBaseline="top",this._ctx.fillStyle="#FFFFFF"}id=y++;_canvas;_ctx;_workGlyph={source:null,boundingBox:{left:0,bottom:0,right:0,top:0},originOffset:{x:0,y:0}};_workGlyphConfig={chars:void 0,metadata:0};rasterizeGlyph(n,i,o){return n===""?{source:this._canvas,boundingBox:{top:0,left:0,bottom:-1,right:-1},originOffset:{x:0,y:0}}:this._workGlyphConfig.chars===n&&this._workGlyphConfig.metadata===i?this._workGlyph:(this._workGlyphConfig.chars=n,this._workGlyphConfig.metadata=i,this._rasterizeGlyph(n,i,o))}_rasterizeGlyph(n,i,o){this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height);const r=new p(200),s=h.getFontStyle(i);s&l.Italic&&r.appendString("italic "),s&l.Bold&&r.appendString("bold "),r.appendString(`${this._fontSize}px ${this._fontFamily}`),this._ctx.font=r.build();const t=this._fontSize,e=this._fontSize;this._ctx.fillStyle=o[h.getForeground(i)],this._ctx.fillText(n,t,e);const a=this._ctx.getImageData(0,0,this._canvas.width,this._canvas.height);return this._findGlyphBoundingBox(a,this._workGlyph.boundingBox),this._workGlyph.source=this._canvas,this._workGlyph.originOffset.x=this._workGlyph.boundingBox.left-t,this._workGlyph.originOffset.y=this._workGlyph.boundingBox.top-e,this._workGlyph}_findGlyphBoundingBox(n,i){const o=this._canvas.height,r=this._canvas.width;let s=!1;for(let t=0;t<o;t++){for(let e=0;e<r;e++){const a=t*r*4+e*4+3;if(n.data[a]!==0){i.top=t,s=!0;break}}if(s)break}i.left=0,s=!1;for(let t=0;t<r;t++){for(let e=0;e<o;e++){const a=e*r*4+t*4+3;if(n.data[a]!==0){i.left=t,s=!0;break}}if(s)break}i.right=r,s=!1;for(let t=r-1;t>=i.left;t--){for(let e=0;e<o;e++){const a=e*r*4+t*4+3;if(n.data[a]!==0){i.right=t,s=!0;break}}if(s)break}i.bottom=i.top,s=!1;for(let t=o-1;t>=0;t--){for(let e=0;e<r;e++){const a=t*r*4+e*4+3;if(n.data[a]!==0){i.bottom=t,s=!0;break}}if(s)break}}}export{u as GlyphRasterizer};
