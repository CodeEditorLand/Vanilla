{
  "version": 3,
  "sources": ["../../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/editor/browser/controller/editContext/native/screenReaderSupport.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { getActiveWindow } from \"../../../../../base/browser/dom.js\";\nimport type { FastDomNode } from \"../../../../../base/browser/fastDomNode.js\";\nimport { AccessibilitySupport } from \"../../../../../platform/accessibility/common/accessibility.js\";\nimport { IKeybindingService } from \"../../../../../platform/keybinding/common/keybinding.js\";\nimport { EditorOption } from \"../../../../common/config/editorOptions.js\";\nimport type { FontInfo } from \"../../../../common/config/fontInfo.js\";\nimport type { Position } from \"../../../../common/core/position.js\";\nimport type { Range } from \"../../../../common/core/range.js\";\nimport { Selection } from \"../../../../common/core/selection.js\";\nimport type { EndOfLinePreference } from \"../../../../common/model.js\";\nimport type {\n\tViewConfigurationChangedEvent,\n\tViewCursorStateChangedEvent,\n} from \"../../../../common/viewEvents.js\";\nimport type { ViewContext } from \"../../../../common/viewModel/viewContext.js\";\nimport { applyFontInfo } from \"../../../config/domFontInfo.js\";\nimport type {\n\tRenderingContext,\n\tRestrictedRenderingContext,\n} from \"../../../view/renderingContext.js\";\nimport {\n\ttype ISimpleModel,\n\tPagedScreenReaderStrategy,\n\ttype ScreenReaderContentState,\n\tariaLabelForScreenReaderContent,\n\tnewlinecount,\n} from \"../screenReaderUtils.js\";\n\nexport class ScreenReaderSupport {\n\t// Configuration values\n\tprivate _contentLeft = 1;\n\tprivate _contentWidth = 1;\n\tprivate _lineHeight = 1;\n\tprivate _fontInfo: FontInfo | undefined;\n\tprivate _accessibilitySupport: AccessibilitySupport =\n\t\tAccessibilitySupport.Unknown;\n\tprivate _accessibilityPageSize = 1;\n\n\tprivate _primarySelection: Selection = new Selection(1, 1, 1, 1);\n\tprivate _screenReaderContentState: ScreenReaderContentState | undefined;\n\n\tconstructor(\n\t\tprivate readonly _domNode: FastDomNode<HTMLElement>,\n\t\tprivate readonly _context: ViewContext,\n\t\t@IKeybindingService\n\t\tprivate readonly _keybindingService: IKeybindingService,\n\t) {\n\t\tthis._updateConfigurationSettings();\n\t\tthis._updateDomAttributes();\n\t}\n\n\tpublic onConfigurationChanged(e: ViewConfigurationChangedEvent): void {\n\t\tthis._updateConfigurationSettings();\n\t\tthis._updateDomAttributes();\n\t\tif (e.hasChanged(EditorOption.accessibilitySupport)) {\n\t\t\tthis.writeScreenReaderContent();\n\t\t}\n\t}\n\n\tprivate _updateConfigurationSettings(): void {\n\t\tconst options = this._context.configuration.options;\n\t\tconst layoutInfo = options.get(EditorOption.layoutInfo);\n\t\tthis._contentLeft = layoutInfo.contentLeft;\n\t\tthis._contentWidth = layoutInfo.contentWidth;\n\t\tthis._fontInfo = options.get(EditorOption.fontInfo);\n\t\tthis._lineHeight = options.get(EditorOption.lineHeight);\n\t\tthis._accessibilitySupport = options.get(\n\t\t\tEditorOption.accessibilitySupport,\n\t\t);\n\t\tthis._accessibilityPageSize = options.get(\n\t\t\tEditorOption.accessibilityPageSize,\n\t\t);\n\t}\n\n\tprivate _updateDomAttributes(): void {\n\t\tconst options = this._context.configuration.options;\n\t\tthis._domNode.domNode.setAttribute(\n\t\t\t\"aria-label\",\n\t\t\tariaLabelForScreenReaderContent(options, this._keybindingService),\n\t\t);\n\t\tconst tabSize = this._context.viewModel.model.getOptions().tabSize;\n\t\tconst spaceWidth = options.get(EditorOption.fontInfo).spaceWidth;\n\t\tthis._domNode.domNode.style.tabSize = `${tabSize * spaceWidth}px`;\n\t}\n\n\tpublic onCursorStateChanged(e: ViewCursorStateChangedEvent): void {\n\t\tthis._primarySelection = e.selections[0] ?? new Selection(1, 1, 1, 1);\n\t}\n\n\tpublic prepareRender(ctx: RenderingContext): void {\n\t\tthis.writeScreenReaderContent();\n\t}\n\n\tpublic render(ctx: RestrictedRenderingContext): void {\n\t\tif (!this._screenReaderContentState) {\n\t\t\treturn;\n\t\t}\n\t\t// For correct alignment of the screen reader content, we need to apply the correct font\n\t\tapplyFontInfo(this._domNode, this._fontInfo!);\n\n\t\tconst verticalOffsetForPrimaryLineNumber =\n\t\t\tthis._context.viewLayout.getVerticalOffsetForLineNumber(\n\t\t\t\tthis._primarySelection.positionLineNumber,\n\t\t\t);\n\t\tconst editorScrollTop = this._context.viewLayout.getCurrentScrollTop();\n\t\tconst top = verticalOffsetForPrimaryLineNumber - editorScrollTop;\n\n\t\tthis._domNode.setTop(top);\n\t\tthis._domNode.setLeft(this._contentLeft);\n\t\tthis._domNode.setWidth(this._contentWidth);\n\t\tthis._domNode.setHeight(this._lineHeight);\n\n\t\t// Setting position within the screen reader content by modifying scroll position\n\t\tconst textContentBeforeSelection =\n\t\t\tthis._screenReaderContentState.value.substring(\n\t\t\t\t0,\n\t\t\t\tthis._screenReaderContentState.selectionStart,\n\t\t\t);\n\t\tconst numberOfLinesOfContentBeforeSelection = newlinecount(\n\t\t\ttextContentBeforeSelection,\n\t\t);\n\t\tthis._domNode.domNode.scrollTop =\n\t\t\tnumberOfLinesOfContentBeforeSelection * this._lineHeight;\n\t}\n\n\tpublic setAriaOptions(): void {}\n\n\tpublic writeScreenReaderContent(): void {\n\t\tconst focusedElement = getActiveWindow().document.activeElement;\n\t\tif (!focusedElement || focusedElement !== this._domNode.domNode) {\n\t\t\treturn;\n\t\t}\n\t\tthis._screenReaderContentState = this._getScreenReaderContentState();\n\t\tif (!this._screenReaderContentState) {\n\t\t\treturn;\n\t\t}\n\t\tif (\n\t\t\tthis._domNode.domNode.textContent !==\n\t\t\tthis._screenReaderContentState.value\n\t\t) {\n\t\t\tthis._domNode.domNode.textContent =\n\t\t\t\tthis._screenReaderContentState.value;\n\t\t}\n\t\tthis._setSelectionOfScreenReaderContent(\n\t\t\tthis._screenReaderContentState.selectionStart,\n\t\t\tthis._screenReaderContentState.selectionEnd,\n\t\t);\n\t}\n\n\tprivate _getScreenReaderContentState():\n\t\t| ScreenReaderContentState\n\t\t| undefined {\n\t\tif (this._accessibilitySupport === AccessibilitySupport.Disabled) {\n\t\t\treturn;\n\t\t}\n\t\tconst simpleModel: ISimpleModel = {\n\t\t\tgetLineCount: (): number => {\n\t\t\t\treturn this._context.viewModel.getLineCount();\n\t\t\t},\n\t\t\tgetLineMaxColumn: (lineNumber: number): number => {\n\t\t\t\treturn this._context.viewModel.getLineMaxColumn(lineNumber);\n\t\t\t},\n\t\t\tgetValueInRange: (\n\t\t\t\trange: Range,\n\t\t\t\teol: EndOfLinePreference,\n\t\t\t): string => {\n\t\t\t\treturn this._context.viewModel.getValueInRange(range, eol);\n\t\t\t},\n\t\t\tgetValueLengthInRange: (\n\t\t\t\trange: Range,\n\t\t\t\teol: EndOfLinePreference,\n\t\t\t): number => {\n\t\t\t\treturn this._context.viewModel.getValueLengthInRange(\n\t\t\t\t\trange,\n\t\t\t\t\teol,\n\t\t\t\t);\n\t\t\t},\n\t\t\tmodifyPosition: (position: Position, offset: number): Position => {\n\t\t\t\treturn this._context.viewModel.modifyPosition(position, offset);\n\t\t\t},\n\t\t};\n\t\treturn PagedScreenReaderStrategy.fromEditorSelection(\n\t\t\tsimpleModel,\n\t\t\tthis._primarySelection,\n\t\t\tthis._accessibilityPageSize,\n\t\t\tthis._accessibilitySupport === AccessibilitySupport.Unknown,\n\t\t);\n\t}\n\n\tprivate _setSelectionOfScreenReaderContent(\n\t\tselectionOffsetStart: number,\n\t\tselectionOffsetEnd: number,\n\t): void {\n\t\tconst activeDocument = getActiveWindow().document;\n\t\tconst activeDocumentSelection = activeDocument.getSelection();\n\t\tif (!activeDocumentSelection) {\n\t\t\treturn;\n\t\t}\n\t\tconst textContent = this._domNode.domNode.firstChild;\n\t\tif (!textContent) {\n\t\t\treturn;\n\t\t}\n\t\tconst range = new globalThis.Range();\n\t\trange.setStart(textContent, selectionOffsetStart);\n\t\trange.setEnd(textContent, selectionOffsetEnd);\n\t\tactiveDocumentSelection.removeAllRanges();\n\t\tactiveDocumentSelection.addRange(range);\n\t}\n}\n"],
  "mappings": "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",
  "names": []
}
