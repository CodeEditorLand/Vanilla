var h=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var l=(a,e,i,t)=>{for(var n=t>1?void 0:t?p(e,i):e,o=a.length-1,r;o>=0;o--)(r=a[o])&&(n=(t?r(e,i,n):r(n))||n);return t&&n&&h(e,i,n),n},m=(a,e)=>(i,t)=>e(i,t,a);import{getActiveWindow as g}from"../../../../../base/browser/dom.js";import"../../../../../base/browser/fastDomNode.js";import{AccessibilitySupport as d}from"../../../../../platform/accessibility/common/accessibility.js";import{IKeybindingService as f}from"../../../../../platform/keybinding/common/keybinding.js";import{EditorOption as s}from"../../../../common/config/editorOptions.js";import"../../../../common/config/fontInfo.js";import"../../../../common/core/position.js";import"../../../../common/core/range.js";import{Selection as u}from"../../../../common/core/selection.js";import"../../../../common/model.js";import"../../../../common/viewEvents.js";import"../../../../common/viewModel/viewContext.js";import{applyFontInfo as _}from"../../../config/domFontInfo.js";import"../../../view/renderingContext.js";import{ariaLabelForScreenReaderContent as S,newlinecount as C,PagedScreenReaderStrategy as b}from"../screenReaderUtils.js";let c=class{constructor(e,i,t){this._domNode=e;this._context=i;this._keybindingService=t;this._updateConfigurationSettings(),this._updateDomAttributes()}_contentLeft=1;_contentWidth=1;_lineHeight=1;_fontInfo;_accessibilitySupport=d.Unknown;_accessibilityPageSize=1;_primarySelection=new u(1,1,1,1);_screenReaderContentState;onConfigurationChanged(e){this._updateConfigurationSettings(),this._updateDomAttributes(),e.hasChanged(s.accessibilitySupport)&&this.writeScreenReaderContent()}_updateConfigurationSettings(){const e=this._context.configuration.options,i=e.get(s.layoutInfo);this._contentLeft=i.contentLeft,this._contentWidth=i.contentWidth,this._fontInfo=e.get(s.fontInfo),this._lineHeight=e.get(s.lineHeight),this._accessibilitySupport=e.get(s.accessibilitySupport),this._accessibilityPageSize=e.get(s.accessibilityPageSize)}_updateDomAttributes(){const e=this._context.configuration.options;this._domNode.domNode.setAttribute("aria-label",S(e,this._keybindingService));const i=this._context.viewModel.model.getOptions().tabSize,t=e.get(s.fontInfo).spaceWidth;this._domNode.domNode.style.tabSize=`${i*t}px`}onCursorStateChanged(e){this._primarySelection=e.selections[0]??new u(1,1,1,1)}prepareRender(e){this.writeScreenReaderContent()}render(e){if(!this._screenReaderContentState)return;_(this._domNode,this._fontInfo);const i=this._context.viewLayout.getVerticalOffsetForLineNumber(this._primarySelection.positionLineNumber),t=this._context.viewLayout.getCurrentScrollTop(),n=i-t;this._domNode.setTop(n),this._domNode.setLeft(this._contentLeft),this._domNode.setWidth(this._contentWidth),this._domNode.setHeight(this._lineHeight);const o=this._screenReaderContentState.value.substring(0,this._screenReaderContentState.selectionStart),r=C(o);this._domNode.domNode.scrollTop=r*this._lineHeight}setAriaOptions(){}writeScreenReaderContent(){this._screenReaderContentState=this._getScreenReaderContentState(),this._screenReaderContentState&&(this._domNode.domNode.textContent!==this._screenReaderContentState.value&&(this._domNode.domNode.textContent=this._screenReaderContentState.value),this._setSelectionOfScreenReaderContent(this._screenReaderContentState.selectionStart,this._screenReaderContentState.selectionEnd))}_getScreenReaderContentState(){const e=this._accessibilitySupport===d.Disabled?1:this._accessibilityPageSize,i={getLineCount:()=>this._context.viewModel.getLineCount(),getLineMaxColumn:t=>this._context.viewModel.getLineMaxColumn(t),getValueInRange:(t,n)=>this._context.viewModel.getValueInRange(t,n),getValueLengthInRange:(t,n)=>this._context.viewModel.getValueLengthInRange(t,n),modifyPosition:(t,n)=>this._context.viewModel.modifyPosition(t,n)};return b.fromEditorSelection(i,this._primarySelection,e,this._accessibilitySupport===d.Unknown)}_setSelectionOfScreenReaderContent(e,i){const n=g().document.getSelection();if(!n)return;const o=this._domNode.domNode.firstChild;if(!o)return;const r=new globalThis.Range;r.setStart(o,e),r.setEnd(o,i),n.removeAllRanges(),n.addRange(r)}};c=l([m(2,f)],c);export{c as ScreenReaderSupport};
