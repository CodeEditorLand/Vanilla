var p=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var m=(a,e,t,n)=>{for(var i=n>1?void 0:n?f(e,t):e,o=a.length-1,r;o>=0;o--)(r=a[o])&&(i=(n?r(e,t,i):r(i))||i);return n&&i&&p(e,t,i),i},l=(a,e)=>(t,n)=>e(t,n,a);import{getActiveWindow as u}from"../../../../../base/browser/dom.js";import"../../../../../base/browser/fastDomNode.js";import{AccessibilitySupport as c}from"../../../../../platform/accessibility/common/accessibility.js";import{IKeybindingService as g}from"../../../../../platform/keybinding/common/keybinding.js";import{EditorOption as s}from"../../../../common/config/editorOptions.js";import"../../../../common/config/fontInfo.js";import"../../../../common/core/position.js";import"../../../../common/core/range.js";import{Selection as h}from"../../../../common/core/selection.js";import"../../../../common/model.js";import"../../../../common/viewEvents.js";import"../../../../common/viewModel/viewContext.js";import{applyFontInfo as _}from"../../../config/domFontInfo.js";import"../../../view/renderingContext.js";import{ariaLabelForScreenReaderContent as S,newlinecount as C,PagedScreenReaderStrategy as v}from"../screenReaderUtils.js";let d=class{constructor(e,t,n){this._domNode=e;this._context=t;this._keybindingService=n;this._updateConfigurationSettings(),this._updateDomAttributes()}_contentLeft=1;_contentWidth=1;_lineHeight=1;_fontInfo;_accessibilitySupport=c.Unknown;_accessibilityPageSize=1;_primarySelection=new h(1,1,1,1);_screenReaderContentState;onConfigurationChanged(e){this._updateConfigurationSettings(),this._updateDomAttributes(),e.hasChanged(s.accessibilitySupport)&&this.writeScreenReaderContent()}_updateConfigurationSettings(){const e=this._context.configuration.options,t=e.get(s.layoutInfo);this._contentLeft=t.contentLeft,this._contentWidth=t.contentWidth,this._fontInfo=e.get(s.fontInfo),this._lineHeight=e.get(s.lineHeight),this._accessibilitySupport=e.get(s.accessibilitySupport),this._accessibilityPageSize=e.get(s.accessibilityPageSize)}_updateDomAttributes(){const e=this._context.configuration.options;this._domNode.domNode.setAttribute("aria-label",S(e,this._keybindingService));const t=this._context.viewModel.model.getOptions().tabSize,n=e.get(s.fontInfo).spaceWidth;this._domNode.domNode.style.tabSize=`${t*n}px`}onCursorStateChanged(e){this._primarySelection=e.selections[0]??new h(1,1,1,1)}prepareRender(e){this.writeScreenReaderContent()}render(e){if(!this._screenReaderContentState)return;_(this._domNode,this._fontInfo);const t=this._context.viewLayout.getVerticalOffsetForLineNumber(this._primarySelection.positionLineNumber),n=this._context.viewLayout.getCurrentScrollTop(),i=t-n;this._domNode.setTop(i),this._domNode.setLeft(this._contentLeft),this._domNode.setWidth(this._contentWidth),this._domNode.setHeight(this._lineHeight);const o=this._screenReaderContentState.value.substring(0,this._screenReaderContentState.selectionStart),r=C(o);this._domNode.domNode.scrollTop=r*this._lineHeight}setAriaOptions(){}writeScreenReaderContent(){const e=u().document.activeElement;!e||e!==this._domNode.domNode||(this._screenReaderContentState=this._getScreenReaderContentState(),this._screenReaderContentState&&(this._domNode.domNode.textContent!==this._screenReaderContentState.value&&(this._domNode.domNode.textContent=this._screenReaderContentState.value),this._setSelectionOfScreenReaderContent(this._screenReaderContentState.selectionStart,this._screenReaderContentState.selectionEnd)))}_getScreenReaderContentState(){if(this._accessibilitySupport===c.Disabled)return;const e={getLineCount:()=>this._context.viewModel.getLineCount(),getLineMaxColumn:t=>this._context.viewModel.getLineMaxColumn(t),getValueInRange:(t,n)=>this._context.viewModel.getValueInRange(t,n),getValueLengthInRange:(t,n)=>this._context.viewModel.getValueLengthInRange(t,n),modifyPosition:(t,n)=>this._context.viewModel.modifyPosition(t,n)};return v.fromEditorSelection(e,this._primarySelection,this._accessibilityPageSize,this._accessibilitySupport===c.Unknown)}_setSelectionOfScreenReaderContent(e,t){const i=u().document.getSelection();if(!i)return;const o=this._domNode.domNode.firstChild;if(!o)return;const r=new globalThis.Range;r.setStart(o,e),r.setEnd(o,t),i.removeAllRanges(),i.addRange(r)}};d=m([l(2,g)],d);export{d as ScreenReaderSupport};
