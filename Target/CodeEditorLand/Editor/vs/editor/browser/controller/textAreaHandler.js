var X=Object.defineProperty;var J=Object.getOwnPropertyDescriptor;var z=(p,d,e,o)=>{for(var i=o>1?void 0:o?J(d,e):d,n=p.length-1,c;n>=0;n--)(c=p[n])&&(i=(o?c(d,e,i):c(i))||i);return o&&i&&X(d,e,i),i},N=(p,d)=>(e,o)=>d(e,o,p);import"vs/css!./textAreaHandler";import*as S from"../../../../vs/base/browser/browser.js";import{createFastDomNode as D}from"../../../../vs/base/browser/fastDomNode.js";import"../../../../vs/base/browser/keyboardEvent.js";import{MOUSE_CURSOR_TEXT_CSS_CLASS_NAME as W}from"../../../../vs/base/browser/ui/mouseCursor/mouseCursor.js";import{Color as Q}from"../../../../vs/base/common/color.js";import{IME as B}from"../../../../vs/base/common/ime.js";import*as P from"../../../../vs/base/common/platform.js";import*as ee from"../../../../vs/base/common/strings.js";import{applyFontInfo as K}from"../../../../vs/editor/browser/config/domFontInfo.js";import{CopyOptions as te,TextAreaInput as ie,TextAreaWrapper as oe}from"../../../../vs/editor/browser/controller/textAreaInput.js";import{_debugComposition as $,PagedScreenReaderStrategy as ne,TextAreaState as w}from"../../../../vs/editor/browser/controller/textAreaState.js";import"../../../../vs/editor/browser/editorBrowser.js";import"../../../../vs/editor/browser/view/renderingContext.js";import"../../../../vs/editor/browser/view/viewController.js";import{PartFingerprint as re,PartFingerprints as se,ViewPart as ae}from"../../../../vs/editor/browser/view/viewPart.js";import{LineNumbersOverlay as le}from"../../../../vs/editor/browser/viewParts/lineNumbers/lineNumbers.js";import{Margin as ce}from"../../../../vs/editor/browser/viewParts/margin/margin.js";import{EditorOption as r,EditorOptions as he,RenderLineNumbersType as de}from"../../../../vs/editor/common/config/editorOptions.js";import"../../../../vs/editor/common/config/fontInfo.js";import{Position as M}from"../../../../vs/editor/common/core/position.js";import{Range as V}from"../../../../vs/editor/common/core/range.js";import{Selection as U}from"../../../../vs/editor/common/core/selection.js";import{getMapForWordSeparators as q,WordCharacterClass as H}from"../../../../vs/editor/common/core/wordCharacterClassifier.js";import{ScrollType as ue}from"../../../../vs/editor/common/editorCommon.js";import{ColorId as pe}from"../../../../vs/editor/common/encodedTokenAttributes.js";import{TokenizationRegistry as ge}from"../../../../vs/editor/common/languages.js";import{EndOfLinePreference as Z}from"../../../../vs/editor/common/model.js";import*as be from"../../../../vs/editor/common/viewEvents.js";import"../../../../vs/editor/common/viewModel/viewContext.js";import*as I from"../../../../vs/nls.js";import{AccessibilitySupport as T}from"../../../../vs/platform/accessibility/common/accessibility.js";import{IInstantiationService as fe}from"../../../../vs/platform/instantiation/common/instantiation.js";import{IKeybindingService as me}from"../../../../vs/platform/keybinding/common/keybinding.js";class _e{constructor(d,e,o,i,n){this._context=d;this.modelLineNumber=e;this.distanceToModelLineStart=o;this.widthOfHiddenLineTextBefore=i;this.distanceToModelLineEnd=n}_visibleTextAreaBrand=void 0;startPosition=null;endPosition=null;visibleTextareaStart=null;visibleTextareaEnd=null;_previousPresentation=null;prepareRender(d){const e=new M(this.modelLineNumber,this.distanceToModelLineStart+1),o=new M(this.modelLineNumber,this._context.viewModel.model.getLineMaxColumn(this.modelLineNumber)-this.distanceToModelLineEnd);this.startPosition=this._context.viewModel.coordinatesConverter.convertModelPositionToViewPosition(e),this.endPosition=this._context.viewModel.coordinatesConverter.convertModelPositionToViewPosition(o),this.startPosition.lineNumber===this.endPosition.lineNumber?(this.visibleTextareaStart=d.visibleRangeForPosition(this.startPosition),this.visibleTextareaEnd=d.visibleRangeForPosition(this.endPosition)):(this.visibleTextareaStart=null,this.visibleTextareaEnd=null)}definePresentation(d){return this._previousPresentation||(d?this._previousPresentation=d:this._previousPresentation={foreground:pe.DefaultForeground,italic:!1,bold:!1,underline:!1,strikethrough:!1}),this._previousPresentation}}const k=S.isFirefox;let E=class extends ae{constructor(e,o,i,n,c){super(e);this._keybindingService=n;this._instantiationService=c;this._viewController=o,this._visibleRangeProvider=i,this._scrollLeft=0,this._scrollTop=0;const s=this._context.configuration.options,u=s.get(r.layoutInfo);this._setAccessibilityOptions(s),this._contentLeft=u.contentLeft,this._contentWidth=u.contentWidth,this._contentHeight=u.height,this._fontInfo=s.get(r.fontInfo),this._lineHeight=s.get(r.lineHeight),this._emptySelectionClipboard=s.get(r.emptySelectionClipboard),this._copyWithSyntaxHighlighting=s.get(r.copyWithSyntaxHighlighting),this._visibleTextArea=null,this._selections=[new U(1,1,1,1)],this._modelSelections=[new U(1,1,1,1)],this._lastRenderPosition=null,this.textArea=D(document.createElement("textarea")),se.write(this.textArea,re.TextArea),this.textArea.setClassName(`inputarea ${W}`),this.textArea.setAttribute("wrap",this._textAreaWrapping&&!this._visibleTextArea?"on":"off");const{tabSize:_}=this._context.viewModel.model.getOptions();this.textArea.domNode.style.tabSize=`${_*this._fontInfo.spaceWidth}px`,this.textArea.setAttribute("autocorrect","off"),this.textArea.setAttribute("autocapitalize","off"),this.textArea.setAttribute("autocomplete","off"),this.textArea.setAttribute("spellcheck","false"),this.textArea.setAttribute("aria-label",this._getAriaLabel(s)),this.textArea.setAttribute("aria-required",s.get(r.ariaRequired)?"true":"false"),this.textArea.setAttribute("tabindex",String(s.get(r.tabIndex))),this.textArea.setAttribute("role","textbox"),this.textArea.setAttribute("aria-roledescription",I.localize("editor","editor")),this.textArea.setAttribute("aria-multiline","true"),this.textArea.setAttribute("aria-autocomplete",s.get(r.readOnly)?"none":"both"),this._ensureReadOnlyAttribute(),this.textAreaCover=D(document.createElement("div")),this.textAreaCover.setPosition("absolute");const f={getLineCount:()=>this._context.viewModel.getLineCount(),getLineMaxColumn:t=>this._context.viewModel.getLineMaxColumn(t),getValueInRange:(t,a)=>this._context.viewModel.getValueInRange(t,a),getValueLengthInRange:(t,a)=>this._context.viewModel.getValueLengthInRange(t,a),modifyPosition:(t,a)=>this._context.viewModel.modifyPosition(t,a)},g={getDataToCopy:()=>{const t=this._context.viewModel.getPlainTextToCopy(this._modelSelections,this._emptySelectionClipboard,P.isWindows),a=this._context.viewModel.model.getEOL(),l=this._emptySelectionClipboard&&this._modelSelections.length===1&&this._modelSelections[0].isEmpty(),h=Array.isArray(t)?t:null,b=Array.isArray(t)?t.join(a):t;let v,m=null;if(te.forceCopyWithSyntaxHighlighting||this._copyWithSyntaxHighlighting&&b.length<65536){const A=this._context.viewModel.getRichTextToCopy(this._modelSelections,this._emptySelectionClipboard);A&&(v=A.html,m=A.mode)}return{isFromEmptySelection:l,multicursorText:h,text:b,html:v,mode:m}},getScreenReaderContent:()=>{if(this._accessibilitySupport===T.Disabled){const t=this._selections[0];if(P.isMacintosh&&t.isEmpty()){const l=t.getStartPosition();let h=this._getWordBeforePosition(l);if(h.length===0&&(h=this._getCharacterBeforePosition(l)),h.length>0)return new w(h,h.length,h.length,V.fromPositions(l),0)}if(P.isMacintosh&&!t.isEmpty()&&f.getValueLengthInRange(t,Z.TextDefined)<500){const l=f.getValueInRange(t,Z.TextDefined);return new w(l,0,l.length,t,0)}if(S.isSafari&&!t.isEmpty()){const l="vscode-placeholder";return new w(l,0,l.length,null,void 0)}return w.EMPTY}if(S.isAndroid){const t=this._selections[0];if(t.isEmpty()){const a=t.getStartPosition(),[l,h]=this._getAndroidWordAtPosition(a);if(l.length>0)return new w(l,h,h,V.fromPositions(a),0)}return w.EMPTY}return ne.fromEditorSelection(f,this._selections[0],this._accessibilityPageSize,this._accessibilitySupport===T.Unknown)},deduceModelPosition:(t,a,l)=>this._context.viewModel.deduceModelPositionRelativeToViewPosition(t,a,l)},x=this._register(new oe(this.textArea.domNode));this._textAreaInput=this._register(this._instantiationService.createInstance(ie,g,x,P.OS,{isAndroid:S.isAndroid,isChrome:S.isChrome,isFirefox:S.isFirefox,isSafari:S.isSafari})),this._register(this._textAreaInput.onKeyDown(t=>{this._viewController.emitKeyDown(t)})),this._register(this._textAreaInput.onKeyUp(t=>{this._viewController.emitKeyUp(t)})),this._register(this._textAreaInput.onPaste(t=>{let a=!1,l=null,h=null;t.metadata&&(a=this._emptySelectionClipboard&&!!t.metadata.isFromEmptySelection,l=typeof t.metadata.multicursorText<"u"?t.metadata.multicursorText:null,h=t.metadata.mode),this._viewController.paste(t.text,a,l,h)})),this._register(this._textAreaInput.onCut(()=>{this._viewController.cut()})),this._register(this._textAreaInput.onType(t=>{t.replacePrevCharCnt||t.replaceNextCharCnt||t.positionDelta?($&&console.log(` => compositionType: <<${t.text}>>, ${t.replacePrevCharCnt}, ${t.replaceNextCharCnt}, ${t.positionDelta}`),this._viewController.compositionType(t.text,t.replacePrevCharCnt,t.replaceNextCharCnt,t.positionDelta)):($&&console.log(` => type: <<${t.text}>>`),this._viewController.type(t.text))})),this._register(this._textAreaInput.onSelectionChangeRequest(t=>{this._viewController.setSelection(t)})),this._register(this._textAreaInput.onCompositionStart(t=>{const a=this.textArea.domNode,l=this._modelSelections[0],{distanceToModelLineStart:h,widthOfHiddenTextBefore:b}=(()=>{const m=a.value.substring(0,Math.min(a.selectionStart,a.selectionEnd)),A=m.lastIndexOf(`
`),C=m.substring(A+1),L=C.lastIndexOf("	"),O=C.length-L-1,y=l.getStartPosition(),R=Math.min(y.column-1,O),F=y.column-1-R,Y=C.substring(0,C.length-R),{tabSize:j}=this._context.viewModel.model.getOptions(),G=xe(this.textArea.domNode.ownerDocument,Y,this._fontInfo,j);return{distanceToModelLineStart:F,widthOfHiddenTextBefore:G}})(),{distanceToModelLineEnd:v}=(()=>{const m=a.value.substring(Math.max(a.selectionStart,a.selectionEnd)),A=m.indexOf(`
`),C=A===-1?m:m.substring(0,A),L=C.indexOf("	"),O=L===-1?C.length:C.length-L-1,y=l.getEndPosition(),R=Math.min(this._context.viewModel.model.getLineMaxColumn(y.lineNumber)-y.column,O);return{distanceToModelLineEnd:this._context.viewModel.model.getLineMaxColumn(y.lineNumber)-y.column-R}})();this._context.viewModel.revealRange("keyboard",!0,V.fromPositions(this._selections[0].getStartPosition()),be.VerticalRevealType.Simple,ue.Immediate),this._visibleTextArea=new _e(this._context,l.startLineNumber,h,b,v),this.textArea.setAttribute("wrap",this._textAreaWrapping&&!this._visibleTextArea?"on":"off"),this._visibleTextArea.prepareRender(this._visibleRangeProvider),this._render(),this.textArea.setClassName(`inputarea ${W} ime-input`),this._viewController.compositionStart(),this._context.viewModel.onCompositionStart()})),this._register(this._textAreaInput.onCompositionUpdate(t=>{this._visibleTextArea&&(this._visibleTextArea.prepareRender(this._visibleRangeProvider),this._render())})),this._register(this._textAreaInput.onCompositionEnd(()=>{this._visibleTextArea=null,this.textArea.setAttribute("wrap",this._textAreaWrapping&&!this._visibleTextArea?"on":"off"),this._render(),this.textArea.setClassName(`inputarea ${W}`),this._viewController.compositionEnd(),this._context.viewModel.onCompositionEnd()})),this._register(this._textAreaInput.onFocus(()=>{this._context.viewModel.setHasFocus(!0)})),this._register(this._textAreaInput.onBlur(()=>{this._context.viewModel.setHasFocus(!1)})),this._register(B.onDidChange(()=>{this._ensureReadOnlyAttribute()}))}_viewController;_visibleRangeProvider;_scrollLeft;_scrollTop;_accessibilitySupport;_accessibilityPageSize;_textAreaWrapping;_textAreaWidth;_contentLeft;_contentWidth;_contentHeight;_fontInfo;_lineHeight;_emptySelectionClipboard;_copyWithSyntaxHighlighting;_visibleTextArea;_selections;_modelSelections;_lastRenderPosition;textArea;textAreaCover;_textAreaInput;writeScreenReaderContent(e){this._textAreaInput.writeNativeTextAreaContent(e)}dispose(){super.dispose()}_getAndroidWordAtPosition(e){const o='`~!@#$%^&*()-=+[{]}\\|;:",.<>/?',i=this._context.viewModel.getLineContent(e.lineNumber),n=q(o,[]);let c=!0,s=e.column,u=!0,_=e.column,f=0;for(;f<50&&(c||u);){if(c&&s<=1&&(c=!1),c){const g=i.charCodeAt(s-2);n.get(g)!==H.Regular?c=!1:s--}if(u&&_>i.length&&(u=!1),u){const g=i.charCodeAt(_-1);n.get(g)!==H.Regular?u=!1:_++}f++}return[i.substring(s-1,_-1),e.column-s]}_getWordBeforePosition(e){const o=this._context.viewModel.getLineContent(e.lineNumber),i=q(this._context.configuration.options.get(r.wordSeparators),[]);let n=e.column,c=0;for(;n>1;){const s=o.charCodeAt(n-2);if(i.get(s)!==H.Regular||c>50)return o.substring(n-1,e.column-1);c++,n--}return o.substring(0,e.column-1)}_getCharacterBeforePosition(e){if(e.column>1){const i=this._context.viewModel.getLineContent(e.lineNumber).charAt(e.column-2);if(!ee.isHighSurrogate(i.charCodeAt(0)))return i}return""}_getAriaLabel(e){if(e.get(r.accessibilitySupport)===T.Disabled){const i=this._keybindingService.lookupKeybinding("editor.action.toggleScreenReaderAccessibilityMode")?.getAriaLabel(),n=this._keybindingService.lookupKeybinding("workbench.action.showCommands")?.getAriaLabel(),c=this._keybindingService.lookupKeybinding("workbench.action.openGlobalKeybindings")?.getAriaLabel(),s=I.localize("accessibilityModeOff","The editor is not accessible at this time.");return i?I.localize("accessibilityOffAriaLabel","{0} To enable screen reader optimized mode, use {1}",s,i):n?I.localize("accessibilityOffAriaLabelNoKb","{0} To enable screen reader optimized mode, open the quick pick with {1} and run the command Toggle Screen Reader Accessibility Mode, which is currently not triggerable via keyboard.",s,n):c?I.localize("accessibilityOffAriaLabelNoKbs","{0} Please assign a keybinding for the command Toggle Screen Reader Accessibility Mode by accessing the keybindings editor with {1} and run it.",s,c):s}return e.get(r.ariaLabel)}_setAccessibilityOptions(e){this._accessibilitySupport=e.get(r.accessibilitySupport);const o=e.get(r.accessibilityPageSize);this._accessibilitySupport===T.Enabled&&o===he.accessibilityPageSize.defaultValue?this._accessibilityPageSize=500:this._accessibilityPageSize=o;const n=e.get(r.layoutInfo).wrappingColumn;if(n!==-1&&this._accessibilitySupport!==T.Disabled){const c=e.get(r.fontInfo);this._textAreaWrapping=!0,this._textAreaWidth=Math.round(n*c.typicalHalfwidthCharacterWidth)}else this._textAreaWrapping=!1,this._textAreaWidth=k?0:1}onConfigurationChanged(e){const o=this._context.configuration.options,i=o.get(r.layoutInfo);this._setAccessibilityOptions(o),this._contentLeft=i.contentLeft,this._contentWidth=i.contentWidth,this._contentHeight=i.height,this._fontInfo=o.get(r.fontInfo),this._lineHeight=o.get(r.lineHeight),this._emptySelectionClipboard=o.get(r.emptySelectionClipboard),this._copyWithSyntaxHighlighting=o.get(r.copyWithSyntaxHighlighting),this.textArea.setAttribute("wrap",this._textAreaWrapping&&!this._visibleTextArea?"on":"off");const{tabSize:n}=this._context.viewModel.model.getOptions();return this.textArea.domNode.style.tabSize=`${n*this._fontInfo.spaceWidth}px`,this.textArea.setAttribute("aria-label",this._getAriaLabel(o)),this.textArea.setAttribute("aria-required",o.get(r.ariaRequired)?"true":"false"),this.textArea.setAttribute("tabindex",String(o.get(r.tabIndex))),(e.hasChanged(r.domReadOnly)||e.hasChanged(r.readOnly))&&this._ensureReadOnlyAttribute(),e.hasChanged(r.accessibilitySupport)&&this._textAreaInput.writeNativeTextAreaContent("strategy changed"),!0}onCursorStateChanged(e){return this._selections=e.selections.slice(0),this._modelSelections=e.modelSelections.slice(0),this._textAreaInput.writeNativeTextAreaContent("selection changed"),!0}onDecorationsChanged(e){return!0}onFlushed(e){return!0}onLinesChanged(e){return!0}onLinesDeleted(e){return!0}onLinesInserted(e){return!0}onScrollChanged(e){return this._scrollLeft=e.scrollLeft,this._scrollTop=e.scrollTop,!0}onZonesChanged(e){return!0}isFocused(){return this._textAreaInput.isFocused()}focusTextArea(){this._textAreaInput.focusTextArea()}refreshFocusState(){this._textAreaInput.refreshFocusState()}getLastRenderData(){return this._lastRenderPosition}setAriaOptions(e){e.activeDescendant?(this.textArea.setAttribute("aria-haspopup","true"),this.textArea.setAttribute("aria-autocomplete","list"),this.textArea.setAttribute("aria-activedescendant",e.activeDescendant)):(this.textArea.setAttribute("aria-haspopup","false"),this.textArea.setAttribute("aria-autocomplete","both"),this.textArea.removeAttribute("aria-activedescendant")),e.role&&this.textArea.setAttribute("role",e.role)}_ensureReadOnlyAttribute(){const e=this._context.configuration.options;!B.enabled||e.get(r.domReadOnly)&&e.get(r.readOnly)?this.textArea.setAttribute("readonly","true"):this.textArea.removeAttribute("readonly")}_primaryCursorPosition=new M(1,1);_primaryCursorVisibleRange=null;prepareRender(e){this._primaryCursorPosition=new M(this._selections[0].positionLineNumber,this._selections[0].positionColumn),this._primaryCursorVisibleRange=e.visibleRangeForPosition(this._primaryCursorPosition),this._visibleTextArea?.prepareRender(e)}render(e){this._textAreaInput.writeNativeTextAreaContent("render"),this._render()}_render(){if(this._visibleTextArea){const i=this._visibleTextArea.visibleTextareaStart,n=this._visibleTextArea.visibleTextareaEnd,c=this._visibleTextArea.startPosition,s=this._visibleTextArea.endPosition;if(c&&s&&i&&n&&n.left>=this._scrollLeft&&i.left<=this._scrollLeft+this._contentWidth){const u=this._context.viewLayout.getVerticalOffsetForLineNumber(this._primaryCursorPosition.lineNumber)-this._scrollTop,_=this._newlinecount(this.textArea.domNode.value.substr(0,this.textArea.domNode.selectionStart));let f=this._visibleTextArea.widthOfHiddenLineTextBefore,g=this._contentLeft+i.left-this._scrollLeft,x=n.left-i.left+1;if(g<this._contentLeft){const v=this._contentLeft-g;g+=v,f+=v,x-=v}x>this._contentWidth&&(x=this._contentWidth);const t=this._context.viewModel.getViewLineData(c.lineNumber),a=t.tokens.findTokenIndexAtOffset(c.column-1),l=t.tokens.findTokenIndexAtOffset(s.column-1),h=a===l,b=this._visibleTextArea.definePresentation(h?t.tokens.getPresentation(a):null);this.textArea.domNode.scrollTop=_*this._lineHeight,this.textArea.domNode.scrollLeft=f,this._doRender({lastRenderPosition:null,top:u,left:g,width:x,height:this._lineHeight,useCover:!1,color:(ge.getColorMap()||[])[b.foreground],italic:b.italic,bold:b.bold,underline:b.underline,strikethrough:b.strikethrough})}return}if(!this._primaryCursorVisibleRange){this._renderAtTopLeft();return}const e=this._contentLeft+this._primaryCursorVisibleRange.left-this._scrollLeft;if(e<this._contentLeft||e>this._contentLeft+this._contentWidth){this._renderAtTopLeft();return}const o=this._context.viewLayout.getVerticalOffsetForLineNumber(this._selections[0].positionLineNumber)-this._scrollTop;if(o<0||o>this._contentHeight){this._renderAtTopLeft();return}if(P.isMacintosh||this._accessibilitySupport===T.Enabled){this._doRender({lastRenderPosition:this._primaryCursorPosition,top:o,left:this._textAreaWrapping?this._contentLeft:e,width:this._textAreaWidth,height:this._lineHeight,useCover:!1}),this.textArea.domNode.scrollLeft=this._primaryCursorVisibleRange.left;const i=this._textAreaInput.textAreaState.newlineCountBeforeSelection??this._newlinecount(this.textArea.domNode.value.substr(0,this.textArea.domNode.selectionStart));this.textArea.domNode.scrollTop=i*this._lineHeight;return}this._doRender({lastRenderPosition:this._primaryCursorPosition,top:o,left:this._textAreaWrapping?this._contentLeft:e,width:this._textAreaWidth,height:k?0:1,useCover:!1})}_newlinecount(e){let o=0,i=-1;do{if(i=e.indexOf(`
`,i+1),i===-1)break;o++}while(!0);return o}_renderAtTopLeft(){this._doRender({lastRenderPosition:null,top:0,left:0,width:this._textAreaWidth,height:k?0:1,useCover:!0})}_doRender(e){this._lastRenderPosition=e.lastRenderPosition;const o=this.textArea,i=this.textAreaCover;K(o,this._fontInfo),o.setTop(e.top),o.setLeft(e.left),o.setWidth(e.width),o.setHeight(e.height),o.setColor(e.color?Q.Format.CSS.formatHex(e.color):""),o.setFontStyle(e.italic?"italic":""),e.bold&&o.setFontWeight("bold"),o.setTextDecoration(`${e.underline?" underline":""}${e.strikethrough?" line-through":""}`),i.setTop(e.useCover?e.top:0),i.setLeft(e.useCover?e.left:0),i.setWidth(e.useCover?e.width:0),i.setHeight(e.useCover?e.height:0);const n=this._context.configuration.options;n.get(r.glyphMargin)?i.setClassName("monaco-editor-background textAreaCover "+ce.OUTER_CLASS_NAME):n.get(r.lineNumbers).renderType!==de.Off?i.setClassName("monaco-editor-background textAreaCover "+le.CLASS_NAME):i.setClassName("monaco-editor-background textAreaCover")}};E=z([N(3,me),N(4,fe)],E);function xe(p,d,e,o){if(d.length===0)return 0;const i=p.createElement("div");i.style.position="absolute",i.style.top="-50000px",i.style.width="50000px";const n=p.createElement("span");K(n,e),n.style.whiteSpace="pre",n.style.tabSize=`${o*e.spaceWidth}px`,n.append(d),i.appendChild(n),p.body.appendChild(i);const c=n.offsetWidth;return i.remove(),c}export{E as TextAreaHandler};
