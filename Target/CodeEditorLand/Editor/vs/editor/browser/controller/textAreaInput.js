var M=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var T=(l,o,e,i)=>{for(var r=i>1?void 0:i?O(o,e):o,a=l.length-1,d;a>=0;a--)(d=l[a])&&(r=(i?d(o,e,r):d(r))||r);return i&&r&&M(o,e,r),r},b=(l,o)=>(e,i)=>o(e,i,l);import*as E from"../../../../vs/base/browser/browser.js";import*as m from"../../../../vs/base/browser/dom.js";import{DomEmitter as h}from"../../../../vs/base/browser/event.js";import{StandardKeyboardEvent as w}from"../../../../vs/base/browser/keyboardEvent.js";import{inputLatency as v}from"../../../../vs/base/browser/performance.js";import{RunOnceScheduler as A}from"../../../../vs/base/common/async.js";import{Emitter as u,Event as N}from"../../../../vs/base/common/event.js";import{KeyCode as y}from"../../../../vs/base/common/keyCodes.js";import{Disposable as I,MutableDisposable as L}from"../../../../vs/base/common/lifecycle.js";import{Mimes as F}from"../../../../vs/base/common/mime.js";import{OperatingSystem as D}from"../../../../vs/base/common/platform.js";import*as U from"../../../../vs/base/common/strings.js";import{_debugComposition as C,TextAreaState as _}from"../../../../vs/editor/browser/controller/textAreaState.js";import"../../../../vs/editor/common/core/position.js";import{Selection as W}from"../../../../vs/editor/common/core/selection.js";import{IAccessibilityService as B}from"../../../../vs/platform/accessibility/common/accessibility.js";import{ILogService as G}from"../../../../vs/platform/log/common/log.js";var K;(o=>o.Tap="-monaco-textarea-synthetic-tap")(K||={});const ce={forceCopyWithSyntaxHighlighting:!1};class x{static INSTANCE=new x;_lastState;constructor(){this._lastState=null}set(o,e){this._lastState={lastCopiedValue:o,data:e}}get(o){return this._lastState&&this._lastState.lastCopiedValue===o?this._lastState.data:(this._lastState=null,null)}}class H{_lastTypeTextLength;constructor(){this._lastTypeTextLength=0}handleCompositionUpdate(o){o=o||"";const e={text:o,replacePrevCharCnt:this._lastTypeTextLength,replaceNextCharCnt:0,positionDelta:0};return this._lastTypeTextLength=o.length,e}}let f=class extends I{constructor(e,i,r,a,d,S){super();this._host=e;this._textArea=i;this._OS=r;this._browser=a;this._accessibilityService=d;this._logService=S;this._asyncTriggerCut=this._register(new A(()=>this._onCut.fire(),0)),this._textAreaState=_.EMPTY,this._selectionChangeListener=null,this._accessibilityService.isScreenReaderOptimized()&&this.writeNativeTextAreaContent("ctor"),this._register(N.runAndSubscribe(this._accessibilityService.onDidChangeScreenReaderOptimized,()=>{this._accessibilityService.isScreenReaderOptimized()&&!this._asyncFocusGainWriteScreenReaderContent.value?this._asyncFocusGainWriteScreenReaderContent.value=this._register(new A(()=>this.writeNativeTextAreaContent("asyncFocusGain"),0)):this._asyncFocusGainWriteScreenReaderContent.clear()})),this._hasFocus=!1,this._currentComposition=null;let c=null;this._register(this._textArea.onKeyDown(t=>{const n=new w(t);(n.keyCode===y.KEY_IN_COMPOSITION||this._currentComposition&&n.keyCode===y.Backspace)&&n.stopPropagation(),n.equals(y.Escape)&&n.preventDefault(),c=n,this._onKeyDown.fire(n)})),this._register(this._textArea.onKeyUp(t=>{const n=new w(t);this._onKeyUp.fire(n)})),this._register(this._textArea.onCompositionStart(t=>{C&&console.log("[compositionstart]",t);const n=new H;if(this._currentComposition){this._currentComposition=n;return}if(this._currentComposition=n,this._OS===D.Macintosh&&c&&c.equals(y.KEY_IN_COMPOSITION)&&this._textAreaState.selectionStart===this._textAreaState.selectionEnd&&this._textAreaState.selectionStart>0&&this._textAreaState.value.substr(this._textAreaState.selectionStart-1,1)===t.data&&(c.code==="ArrowRight"||c.code==="ArrowLeft")){C&&console.log("[compositionstart] Handling long press case on macOS + arrow key",t),n.handleCompositionUpdate("x"),this._onCompositionStart.fire({data:t.data});return}if(this._browser.isAndroid){this._onCompositionStart.fire({data:t.data});return}this._onCompositionStart.fire({data:t.data})})),this._register(this._textArea.onCompositionUpdate(t=>{C&&console.log("[compositionupdate]",t);const n=this._currentComposition;if(!n)return;if(this._browser.isAndroid){const p=_.readFromTextArea(this._textArea,this._textAreaState),g=_.deduceAndroidCompositionInput(this._textAreaState,p);this._textAreaState=p,this._onType.fire(g),this._onCompositionUpdate.fire(t);return}const s=n.handleCompositionUpdate(t.data);this._textAreaState=_.readFromTextArea(this._textArea,this._textAreaState),this._onType.fire(s),this._onCompositionUpdate.fire(t)})),this._register(this._textArea.onCompositionEnd(t=>{C&&console.log("[compositionend]",t);const n=this._currentComposition;if(!n)return;if(this._currentComposition=null,this._browser.isAndroid){const p=_.readFromTextArea(this._textArea,this._textAreaState),g=_.deduceAndroidCompositionInput(this._textAreaState,p);this._textAreaState=p,this._onType.fire(g),this._onCompositionEnd.fire();return}const s=n.handleCompositionUpdate(t.data);this._textAreaState=_.readFromTextArea(this._textArea,this._textAreaState),this._onType.fire(s),this._onCompositionEnd.fire()})),this._register(this._textArea.onInput(t=>{if(C&&console.log("[input]",t),this._textArea.setIgnoreSelectionChangeTime("received input event"),this._currentComposition)return;const n=_.readFromTextArea(this._textArea,this._textAreaState),s=_.deduceInput(this._textAreaState,n,this._OS===D.Macintosh);s.replacePrevCharCnt===0&&s.text.length===1&&(U.isHighSurrogate(s.text.charCodeAt(0))||s.text.charCodeAt(0)===127)||(this._textAreaState=n,(s.text!==""||s.replacePrevCharCnt!==0||s.replaceNextCharCnt!==0||s.positionDelta!==0)&&this._onType.fire(s))})),this._register(this._textArea.onCut(t=>{this._textArea.setIgnoreSelectionChangeTime("received cut event"),this._ensureClipboardGetsEditorSelection(t),this._asyncTriggerCut.schedule()})),this._register(this._textArea.onCopy(t=>{this._ensureClipboardGetsEditorSelection(t)})),this._register(this._textArea.onPaste(t=>{if(this._textArea.setIgnoreSelectionChangeTime("received paste event"),t.preventDefault(),!t.clipboardData)return;let[n,s]=P.getTextData(t.clipboardData);n&&(s=s||x.INSTANCE.get(n),this._onPaste.fire({text:n,metadata:s}))})),this._register(this._textArea.onFocus(()=>{const t=this._hasFocus;this._setHasFocus(!0),this._accessibilityService.isScreenReaderOptimized()&&this._browser.isSafari&&!t&&this._hasFocus&&(this._asyncFocusGainWriteScreenReaderContent.value||(this._asyncFocusGainWriteScreenReaderContent.value=new A(()=>this.writeNativeTextAreaContent("asyncFocusGain"),0)),this._asyncFocusGainWriteScreenReaderContent.value.schedule())})),this._register(this._textArea.onBlur(()=>{this._currentComposition&&(this._currentComposition=null,this.writeNativeTextAreaContent("blurWithoutCompositionEnd"),this._onCompositionEnd.fire()),this._setHasFocus(!1)})),this._register(this._textArea.onSyntheticTap(()=>{this._browser.isAndroid&&this._currentComposition&&(this._currentComposition=null,this.writeNativeTextAreaContent("tapWithoutCompositionEnd"),this._onCompositionEnd.fire())}))}_onFocus=this._register(new u);onFocus=this._onFocus.event;_onBlur=this._register(new u);onBlur=this._onBlur.event;_onKeyDown=this._register(new u);onKeyDown=this._onKeyDown.event;_onKeyUp=this._register(new u);onKeyUp=this._onKeyUp.event;_onCut=this._register(new u);onCut=this._onCut.event;_onPaste=this._register(new u);onPaste=this._onPaste.event;_onType=this._register(new u);onType=this._onType.event;_onCompositionStart=this._register(new u);onCompositionStart=this._onCompositionStart.event;_onCompositionUpdate=this._register(new u);onCompositionUpdate=this._onCompositionUpdate.event;_onCompositionEnd=this._register(new u);onCompositionEnd=this._onCompositionEnd.event;_onSelectionChangeRequest=this._register(new u);onSelectionChangeRequest=this._onSelectionChangeRequest.event;_asyncTriggerCut;_asyncFocusGainWriteScreenReaderContent=this._register(new L);_textAreaState;get textAreaState(){return this._textAreaState}_selectionChangeListener;_hasFocus;_currentComposition;_initializeFromTest(){this._hasFocus=!0,this._textAreaState=_.readFromTextArea(this._textArea,null)}_installSelectionChangeListener(){let e=0;return m.addDisposableListener(this._textArea.ownerDocument,"selectionchange",i=>{if(v.onSelectionChange(),!this._hasFocus||this._currentComposition||!this._browser.isChrome)return;const r=Date.now(),a=r-e;if(e=r,a<5)return;const d=r-this._textArea.getIgnoreSelectionChangeTime();if(this._textArea.resetSelectionChangeTime(),d<100||!this._textAreaState.selection)return;const S=this._textArea.getValue();if(this._textAreaState.value!==S)return;const c=this._textArea.getSelectionStart(),t=this._textArea.getSelectionEnd();if(this._textAreaState.selectionStart===c&&this._textAreaState.selectionEnd===t)return;const n=this._textAreaState.deduceEditorPosition(c),s=this._host.deduceModelPosition(n[0],n[1],n[2]),p=this._textAreaState.deduceEditorPosition(t),g=this._host.deduceModelPosition(p[0],p[1],p[2]),R=new W(s.lineNumber,s.column,g.lineNumber,g.column);this._onSelectionChangeRequest.fire(R)})}dispose(){super.dispose(),this._selectionChangeListener&&(this._selectionChangeListener.dispose(),this._selectionChangeListener=null)}focusTextArea(){this._setHasFocus(!0),this.refreshFocusState()}isFocused(){return this._hasFocus}refreshFocusState(){this._setHasFocus(this._textArea.hasFocus())}_setHasFocus(e){this._hasFocus!==e&&(this._hasFocus=e,this._selectionChangeListener&&(this._selectionChangeListener.dispose(),this._selectionChangeListener=null),this._hasFocus&&(this._selectionChangeListener=this._installSelectionChangeListener()),this._hasFocus&&this.writeNativeTextAreaContent("focusgain"),this._hasFocus?this._onFocus.fire():this._onBlur.fire())}_setAndWriteTextAreaState(e,i){this._hasFocus||(i=i.collapseSelection()),i.writeToTextArea(e,this._textArea,this._hasFocus),this._textAreaState=i}writeNativeTextAreaContent(e){!this._accessibilityService.isScreenReaderOptimized()&&e==="render"||this._currentComposition||(this._logService.trace(`writeTextAreaState(reason: ${e})`),this._setAndWriteTextAreaState(e,this._host.getScreenReaderContent()))}_ensureClipboardGetsEditorSelection(e){const i=this._host.getDataToCopy(),r={version:1,isFromEmptySelection:i.isFromEmptySelection,multicursorText:i.multicursorText,mode:i.mode};x.INSTANCE.set(this._browser.isFirefox?i.text.replace(/\r\n/g,`
`):i.text,r),e.preventDefault(),e.clipboardData&&P.setTextData(e.clipboardData,i.text,i.html,r)}};f=T([b(4,B),b(5,G)],f);const P={getTextData(l){const o=l.getData(F.text);let e=null;const i=l.getData("vscode-editor-data");if(typeof i=="string")try{e=JSON.parse(i),e.version!==1&&(e=null)}catch{}return o.length===0&&e===null&&l.files.length>0?[Array.prototype.slice.call(l.files,0).map(a=>a.name).join(`
`),null]:[o,e]},setTextData(l,o,e,i){l.setData(F.text,o),typeof e=="string"&&l.setData("text/html",e),l.setData("vscode-editor-data",JSON.stringify(i))}};class he extends I{constructor(e){super();this._actual=e;this._ignoreSelectionChangeTime=0,this._register(this.onKeyDown(()=>v.onKeyDown())),this._register(this.onBeforeInput(()=>v.onBeforeInput())),this._register(this.onInput(()=>v.onInput())),this._register(this.onKeyUp(()=>v.onKeyUp())),this._register(m.addDisposableListener(this._actual,K.Tap,()=>this._onSyntheticTap.fire()))}onKeyDown=this._register(new h(this._actual,"keydown")).event;onKeyPress=this._register(new h(this._actual,"keypress")).event;onKeyUp=this._register(new h(this._actual,"keyup")).event;onCompositionStart=this._register(new h(this._actual,"compositionstart")).event;onCompositionUpdate=this._register(new h(this._actual,"compositionupdate")).event;onCompositionEnd=this._register(new h(this._actual,"compositionend")).event;onBeforeInput=this._register(new h(this._actual,"beforeinput")).event;onInput=this._register(new h(this._actual,"input")).event;onCut=this._register(new h(this._actual,"cut")).event;onCopy=this._register(new h(this._actual,"copy")).event;onPaste=this._register(new h(this._actual,"paste")).event;onFocus=this._register(new h(this._actual,"focus")).event;onBlur=this._register(new h(this._actual,"blur")).event;get ownerDocument(){return this._actual.ownerDocument}_onSyntheticTap=this._register(new u);onSyntheticTap=this._onSyntheticTap.event;_ignoreSelectionChangeTime;hasFocus(){const e=m.getShadowRoot(this._actual);return e?e.activeElement===this._actual:this._actual.isConnected?m.getActiveElement()===this._actual:!1}setIgnoreSelectionChangeTime(e){this._ignoreSelectionChangeTime=Date.now()}getIgnoreSelectionChangeTime(){return this._ignoreSelectionChangeTime}resetSelectionChangeTime(){this._ignoreSelectionChangeTime=0}getValue(){return this._actual.value}setValue(e,i){const r=this._actual;r.value!==i&&(this.setIgnoreSelectionChangeTime("setValue"),r.value=i)}getSelectionStart(){return this._actual.selectionDirection==="backward"?this._actual.selectionEnd:this._actual.selectionStart}getSelectionEnd(){return this._actual.selectionDirection==="backward"?this._actual.selectionStart:this._actual.selectionEnd}setSelectionRange(e,i,r){const a=this._actual;let d=null;const S=m.getShadowRoot(a);S?d=S.activeElement:d=m.getActiveElement();const c=m.getWindow(d),t=d===a,n=a.selectionStart,s=a.selectionEnd;if(t&&n===i&&s===r){E.isFirefox&&c.parent!==c&&a.focus();return}if(t){this.setIgnoreSelectionChangeTime("setSelectionRange"),a.setSelectionRange(i,r),E.isFirefox&&c.parent!==c&&a.focus();return}try{const p=m.saveParentsScrollTop(a);this.setIgnoreSelectionChangeTime("setSelectionRange"),a.focus(),a.setSelectionRange(i,r),m.restoreParentsScrollTop(a,p)}catch{}}}export{P as ClipboardEventUtils,ce as CopyOptions,x as InMemoryClipboardMetadataManager,f as TextAreaInput,K as TextAreaSyntethicEvents,he as TextAreaWrapper};
