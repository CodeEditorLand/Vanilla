import"./mouseHandler.js";import{MouseTargetType as s}from"../editorBrowser.js";import{PageCoordinates as G}from"../editorDom.js";import{PartFingerprint as f,PartFingerprints as W}from"../view/viewPart.js";import{ViewLine as R}from"../viewParts/viewLines/viewLine.js";import"../viewParts/viewCursors/viewCursor.js";import{EditorOption as v}from"../../common/config/editorOptions.js";import{Position as T}from"../../common/core/position.js";import{Range as I}from"../../common/core/range.js";import"../view/renderingContext.js";import"../../common/viewModel/viewContext.js";import"../../common/viewModel.js";import{CursorColumns as F}from"../../common/core/cursorColumns.js";import*as O from"../../../base/browser/dom.js";import{AtomicTabMoveOperations as Z,Direction as B}from"../../common/cursor/cursorAtomicMoveOperations.js";import{PositionAffinity as z}from"../../common/model.js";import"../../common/modelLineProjectionData.js";import"../../../base/common/types.js";import{Lazy as k}from"../../../base/common/lazy.js";var X=(t=>(t[t.Unknown=0]="Unknown",t[t.Content=1]="Content",t))(X||{});class b{constructor(e=null){this.hitTarget=e}type=0}class D{constructor(e,t,n){this.position=e;this.spanNode=t;this.injectedText=n}type=1;get hitTarget(){return this.spanNode}}var y;(e=>{function m(t,n,i){const o=t.getPositionFromDOMInfo(n,i);return o?new D(o,n,null):new b(n)}e.createFromDOMInfo=m})(y||={});class Fe{constructor(e,t){this.lastViewCursorsRenderData=e;this.lastTextareaPosition=t}}class p{static _deduceRage(e,t=null){return!t&&e?new I(e.lineNumber,e.column,e.lineNumber,e.column):t??null}static createUnknown(e,t,n){return{type:s.UNKNOWN,element:e,mouseColumn:t,position:n,range:this._deduceRage(n)}}static createTextarea(e,t){return{type:s.TEXTAREA,element:e,mouseColumn:t,position:null,range:null}}static createMargin(e,t,n,i,o,r){return{type:e,element:t,mouseColumn:n,position:i,range:o,detail:r}}static createViewZone(e,t,n,i,o){return{type:e,element:t,mouseColumn:n,position:i,range:this._deduceRage(i),detail:o}}static createContentText(e,t,n,i,o){return{type:s.CONTENT_TEXT,element:e,mouseColumn:t,position:n,range:this._deduceRage(n,i),detail:o}}static createContentEmpty(e,t,n,i){return{type:s.CONTENT_EMPTY,element:e,mouseColumn:t,position:n,range:this._deduceRage(n),detail:i}}static createContentWidget(e,t,n){return{type:s.CONTENT_WIDGET,element:e,mouseColumn:t,position:null,range:null,detail:n}}static createScrollbar(e,t,n){return{type:s.SCROLLBAR,element:e,mouseColumn:t,position:n,range:this._deduceRage(n)}}static createOverlayWidget(e,t,n){return{type:s.OVERLAY_WIDGET,element:e,mouseColumn:t,position:null,range:null,detail:n}}static createOutsideEditor(e,t,n,i){return{type:s.OUTSIDE_EDITOR,element:null,mouseColumn:e,position:t,range:this._deduceRage(t),outsidePosition:n,outsideDistance:i}}static _typeToString(e){return e===s.TEXTAREA?"TEXTAREA":e===s.GUTTER_GLYPH_MARGIN?"GUTTER_GLYPH_MARGIN":e===s.GUTTER_LINE_NUMBERS?"GUTTER_LINE_NUMBERS":e===s.GUTTER_LINE_DECORATIONS?"GUTTER_LINE_DECORATIONS":e===s.GUTTER_VIEW_ZONE?"GUTTER_VIEW_ZONE":e===s.CONTENT_TEXT?"CONTENT_TEXT":e===s.CONTENT_EMPTY?"CONTENT_EMPTY":e===s.CONTENT_VIEW_ZONE?"CONTENT_VIEW_ZONE":e===s.CONTENT_WIDGET?"CONTENT_WIDGET":e===s.OVERVIEW_RULER?"OVERVIEW_RULER":e===s.SCROLLBAR?"SCROLLBAR":e===s.OVERLAY_WIDGET?"OVERLAY_WIDGET":"UNKNOWN"}static toString(e){return this._typeToString(e.type)+": "+e.position+" - "+e.range+" - "+JSON.stringify(e.detail)}}class g{static isTextArea(e){return e.length===2&&e[0]===f.OverflowGuard&&e[1]===f.TextArea}static isChildOfViewLines(e){return e.length>=4&&e[0]===f.OverflowGuard&&e[3]===f.ViewLines}static isStrictChildOfViewLines(e){return e.length>4&&e[0]===f.OverflowGuard&&e[3]===f.ViewLines}static isChildOfScrollableElement(e){return e.length>=2&&e[0]===f.OverflowGuard&&e[1]===f.ScrollableElement}static isChildOfMinimap(e){return e.length>=2&&e[0]===f.OverflowGuard&&e[1]===f.Minimap}static isChildOfContentWidgets(e){return e.length>=4&&e[0]===f.OverflowGuard&&e[3]===f.ContentWidgets}static isChildOfOverflowGuard(e){return e.length>=1&&e[0]===f.OverflowGuard}static isChildOfOverflowingContentWidgets(e){return e.length>=1&&e[0]===f.OverflowingContentWidgets}static isChildOfOverlayWidgets(e){return e.length>=2&&e[0]===f.OverflowGuard&&e[1]===f.OverlayWidgets}static isChildOfOverflowingOverlayWidgets(e){return e.length>=1&&e[0]===f.OverflowingOverlayWidgets}}class P{viewModel;layoutInfo;viewDomNode;lineHeight;stickyTabStops;typicalHalfwidthCharacterWidth;lastRenderData;_context;_viewHelper;constructor(e,t,n){this.viewModel=e.viewModel;const i=e.configuration.options;this.layoutInfo=i.get(v.layoutInfo),this.viewDomNode=t.viewDomNode,this.lineHeight=i.get(v.lineHeight),this.stickyTabStops=i.get(v.stickyTabStops),this.typicalHalfwidthCharacterWidth=i.get(v.fontInfo).typicalHalfwidthCharacterWidth,this.lastRenderData=n,this._context=e,this._viewHelper=t}getZoneAtCoord(e){return P.getZoneAtCoord(this._context,e)}static getZoneAtCoord(e,t){const n=e.viewLayout.getWhitespaceAtVerticalOffset(t);if(n){const i=n.verticalOffset+n.height/2,o=e.viewModel.getLineCount();let r=null,l,a=null;return n.afterLineNumber!==o&&(a=new T(n.afterLineNumber+1,1)),n.afterLineNumber>0&&(r=new T(n.afterLineNumber,e.viewModel.getLineMaxColumn(n.afterLineNumber))),a===null?l=r:r===null?l=a:t<i?l=r:l=a,{viewZoneId:n.id,afterLineNumber:n.afterLineNumber,positionBefore:r,positionAfter:a,position:l}}return null}getFullLineRangeAtCoord(e){if(this._context.viewLayout.isAfterLines(e)){const i=this._context.viewModel.getLineCount(),o=this._context.viewModel.getLineMaxColumn(i);return{range:new I(i,o,i,o),isAfterLines:!0}}const t=this._context.viewLayout.getLineNumberAtVerticalOffset(e),n=this._context.viewModel.getLineMaxColumn(t);return{range:new I(t,1,t,n),isAfterLines:!1}}getLineNumberAtVerticalOffset(e){return this._context.viewLayout.getLineNumberAtVerticalOffset(e)}isAfterLines(e){return this._context.viewLayout.isAfterLines(e)}isInTopPadding(e){return this._context.viewLayout.isInTopPadding(e)}isInBottomPadding(e){return this._context.viewLayout.isInBottomPadding(e)}getVerticalOffsetForLineNumber(e){return this._context.viewLayout.getVerticalOffsetForLineNumber(e)}findAttribute(e,t){return P._findAttribute(e,t,this._viewHelper.viewDomNode)}static _findAttribute(e,t,n){for(;e&&e!==e.ownerDocument.body;){if(e.hasAttribute&&e.hasAttribute(t))return e.getAttribute(t);if(e===n)return null;e=e.parentNode}return null}getLineWidth(e){return this._viewHelper.getLineWidth(e)}visibleRangeForPosition(e,t){return this._viewHelper.visibleRangeForPosition(e,t)}getPositionFromDOMInfo(e,t){return this._viewHelper.getPositionFromDOMInfo(e,t)}getCurrentScrollTop(){return this._context.viewLayout.getCurrentScrollTop()}getCurrentScrollLeft(){return this._context.viewLayout.getCurrentScrollLeft()}}class Y{editorPos;pos;relativePos;mouseVerticalOffset;isInMarginArea;isInContentArea;mouseContentHorizontalOffset;mouseColumn;constructor(e,t,n,i){this.editorPos=t,this.pos=n,this.relativePos=i,this.mouseVerticalOffset=Math.max(0,e.getCurrentScrollTop()+this.relativePos.y),this.mouseContentHorizontalOffset=e.getCurrentScrollLeft()+this.relativePos.x-e.layoutInfo.contentLeft,this.isInMarginArea=this.relativePos.x<e.layoutInfo.contentLeft&&this.relativePos.x>=e.layoutInfo.glyphMarginLeft,this.isInContentArea=!this.isInMarginArea,this.mouseColumn=Math.max(0,d._getMouseColumn(this.mouseContentHorizontalOffset,e.typicalHalfwidthCharacterWidth))}}class $ extends Y{_ctx;_eventTarget;hitTestResult=new k(()=>d.doHitTest(this._ctx,this));_useHitTestTarget;_targetPathCacheElement=null;_targetPathCacheValue=new Uint8Array(0);get target(){return this._useHitTestTarget?this.hitTestResult.value.hitTarget:this._eventTarget}get targetPath(){return this._targetPathCacheElement!==this.target&&(this._targetPathCacheElement=this.target,this._targetPathCacheValue=W.collect(this.target,this._ctx.viewDomNode)),this._targetPathCacheValue}constructor(e,t,n,i,o){super(e,t,n,i),this._ctx=e,this._eventTarget=o;const r=!!this._eventTarget;this._useHitTestTarget=!r}toString(){return`pos(${this.pos.x},${this.pos.y}), editorPos(${this.editorPos.x},${this.editorPos.y}), relativePos(${this.relativePos.x},${this.relativePos.y}), mouseVerticalOffset: ${this.mouseVerticalOffset}, mouseContentHorizontalOffset: ${this.mouseContentHorizontalOffset}
	target: ${this.target?this.target.outerHTML:null}`}get wouldBenefitFromHitTestTargetSwitch(){return!this._useHitTestTarget&&this.hitTestResult.value.hitTarget!==null&&this.target!==this.hitTestResult.value.hitTarget}switchToHitTestTarget(){this._useHitTestTarget=!0}_getMouseColumn(e=null){return e&&e.column<this._ctx.viewModel.getLineMaxColumn(e.lineNumber)?F.visibleColumnFromColumn(this._ctx.viewModel.getLineContent(e.lineNumber),e.column,this._ctx.viewModel.model.getOptions().tabSize)+1:this.mouseColumn}fulfillUnknown(e=null){return p.createUnknown(this.target,this._getMouseColumn(e),e)}fulfillTextarea(){return p.createTextarea(this.target,this._getMouseColumn())}fulfillMargin(e,t,n,i){return p.createMargin(e,this.target,this._getMouseColumn(t),t,n,i)}fulfillViewZone(e,t,n){return p.createViewZone(e,this.target,this._getMouseColumn(t),t,n)}fulfillContentText(e,t,n){return p.createContentText(this.target,this._getMouseColumn(e),e,t,n)}fulfillContentEmpty(e,t){return p.createContentEmpty(this.target,this._getMouseColumn(e),e,t)}fulfillContentWidget(e){return p.createContentWidget(this.target,this._getMouseColumn(),e)}fulfillScrollbar(e){return p.createScrollbar(this.target,this._getMouseColumn(e),e)}fulfillOverlayWidget(e){return p.createOverlayWidget(this.target,this._getMouseColumn(),e)}}const S={isAfterLines:!0};function V(m){return{isAfterLines:!1,horizontalDistanceToText:m}}class d{_context;_viewHelper;constructor(e,t){this._context=e,this._viewHelper=t}mouseTargetIsWidget(e){const t=e.target,n=W.collect(t,this._viewHelper.viewDomNode);return!!(g.isChildOfContentWidgets(n)||g.isChildOfOverflowingContentWidgets(n)||g.isChildOfOverlayWidgets(n)||g.isChildOfOverflowingOverlayWidgets(n))}createMouseTarget(e,t,n,i,o){const r=new P(this._context,this._viewHelper,e),l=new $(r,t,n,i,o);try{const a=d._createMouseTarget(r,l);if(a.type===s.CONTENT_TEXT&&r.stickyTabStops&&a.position!==null){const c=d._snapToSoftTabBoundary(a.position,r.viewModel),E=I.fromPositions(c,c).plusRange(a.range);return l.fulfillContentText(c,E,a.detail)}return a}catch{return l.fulfillUnknown()}}static _createMouseTarget(e,t){if(t.target===null)return t.fulfillUnknown();const n=t;let i=null;return!g.isChildOfOverflowGuard(t.targetPath)&&!g.isChildOfOverflowingContentWidgets(t.targetPath)&&!g.isChildOfOverflowingOverlayWidgets(t.targetPath)&&(i=i||t.fulfillUnknown()),i=i||d._hitTestContentWidget(e,n),i=i||d._hitTestOverlayWidget(e,n),i=i||d._hitTestMinimap(e,n),i=i||d._hitTestScrollbarSlider(e,n),i=i||d._hitTestViewZone(e,n),i=i||d._hitTestMargin(e,n),i=i||d._hitTestViewCursor(e,n),i=i||d._hitTestTextArea(e,n),i=i||d._hitTestViewLines(e,n),i=i||d._hitTestScrollbar(e,n),i||t.fulfillUnknown()}static _hitTestContentWidget(e,t){if(g.isChildOfContentWidgets(t.targetPath)||g.isChildOfOverflowingContentWidgets(t.targetPath)){const n=e.findAttribute(t.target,"widgetId");return n?t.fulfillContentWidget(n):t.fulfillUnknown()}return null}static _hitTestOverlayWidget(e,t){if(g.isChildOfOverlayWidgets(t.targetPath)||g.isChildOfOverflowingOverlayWidgets(t.targetPath)){const n=e.findAttribute(t.target,"widgetId");return n?t.fulfillOverlayWidget(n):t.fulfillUnknown()}return null}static _hitTestViewCursor(e,t){if(t.target){const n=e.lastRenderData.lastViewCursorsRenderData;for(const i of n)if(t.target===i.domNode)return t.fulfillContentText(i.position,null,{mightBeForeignElement:!1,injectedText:null})}if(t.isInContentArea){const n=e.lastRenderData.lastViewCursorsRenderData,i=t.mouseContentHorizontalOffset,o=t.mouseVerticalOffset;for(const r of n){if(i<r.contentLeft||i>r.contentLeft+r.width)continue;const l=e.getVerticalOffsetForLineNumber(r.position.lineNumber);if(l<=o&&o<=l+r.height)return t.fulfillContentText(r.position,null,{mightBeForeignElement:!1,injectedText:null})}}return null}static _hitTestViewZone(e,t){const n=e.getZoneAtCoord(t.mouseVerticalOffset);if(n){const i=t.isInContentArea?s.CONTENT_VIEW_ZONE:s.GUTTER_VIEW_ZONE;return t.fulfillViewZone(i,n.position,n)}return null}static _hitTestTextArea(e,t){return g.isTextArea(t.targetPath)?e.lastRenderData.lastTextareaPosition?t.fulfillContentText(e.lastRenderData.lastTextareaPosition,null,{mightBeForeignElement:!1,injectedText:null}):t.fulfillTextarea():null}static _hitTestMargin(e,t){if(t.isInMarginArea){const n=e.getFullLineRangeAtCoord(t.mouseVerticalOffset),i=n.range.getStartPosition();let o=Math.abs(t.relativePos.x);const r={isAfterLines:n.isAfterLines,glyphMarginLeft:e.layoutInfo.glyphMarginLeft,glyphMarginWidth:e.layoutInfo.glyphMarginWidth,lineNumbersWidth:e.layoutInfo.lineNumbersWidth,offsetX:o};if(o-=e.layoutInfo.glyphMarginLeft,o<=e.layoutInfo.glyphMarginWidth){const l=e.viewModel.coordinatesConverter.convertViewPositionToModelPosition(n.range.getStartPosition()),a=e.viewModel.glyphLanes.getLanesAtLine(l.lineNumber);return r.glyphMarginLane=a[Math.floor(o/e.lineHeight)],t.fulfillMargin(s.GUTTER_GLYPH_MARGIN,i,n.range,r)}return o-=e.layoutInfo.glyphMarginWidth,o<=e.layoutInfo.lineNumbersWidth?t.fulfillMargin(s.GUTTER_LINE_NUMBERS,i,n.range,r):(o-=e.layoutInfo.lineNumbersWidth,t.fulfillMargin(s.GUTTER_LINE_DECORATIONS,i,n.range,r))}return null}static _hitTestViewLines(e,t){if(!g.isChildOfViewLines(t.targetPath))return null;if(e.isInTopPadding(t.mouseVerticalOffset))return t.fulfillContentEmpty(new T(1,1),S);if(e.isAfterLines(t.mouseVerticalOffset)||e.isInBottomPadding(t.mouseVerticalOffset)){const i=e.viewModel.getLineCount(),o=e.viewModel.getLineMaxColumn(i);return t.fulfillContentEmpty(new T(i,o),S)}if(g.isStrictChildOfViewLines(t.targetPath)){const i=e.getLineNumberAtVerticalOffset(t.mouseVerticalOffset);if(e.viewModel.getLineLength(i)===0){const r=e.getLineWidth(i),l=V(t.mouseContentHorizontalOffset-r);return t.fulfillContentEmpty(new T(i,1),l)}const o=e.getLineWidth(i);if(t.mouseContentHorizontalOffset>=o){const r=V(t.mouseContentHorizontalOffset-o),l=new T(i,e.viewModel.getLineMaxColumn(i));return t.fulfillContentEmpty(l,r)}}const n=t.hitTestResult.value;return n.type===1?d.createMouseTargetFromHitTestPosition(e,t,n.spanNode,n.position,n.injectedText):t.wouldBenefitFromHitTestTargetSwitch?(t.switchToHitTestTarget(),this._createMouseTarget(e,t)):t.fulfillUnknown()}static _hitTestMinimap(e,t){if(g.isChildOfMinimap(t.targetPath)){const n=e.getLineNumberAtVerticalOffset(t.mouseVerticalOffset),i=e.viewModel.getLineMaxColumn(n);return t.fulfillScrollbar(new T(n,i))}return null}static _hitTestScrollbarSlider(e,t){if(g.isChildOfScrollableElement(t.targetPath)&&t.target&&t.target.nodeType===1){const n=t.target.className;if(n&&/\b(slider|scrollbar)\b/.test(n)){const i=e.getLineNumberAtVerticalOffset(t.mouseVerticalOffset),o=e.viewModel.getLineMaxColumn(i);return t.fulfillScrollbar(new T(i,o))}}return null}static _hitTestScrollbar(e,t){if(g.isChildOfScrollableElement(t.targetPath)){const n=e.getLineNumberAtVerticalOffset(t.mouseVerticalOffset),i=e.viewModel.getLineMaxColumn(n);return t.fulfillScrollbar(new T(n,i))}return null}getMouseColumn(e){const t=this._context.configuration.options,n=t.get(v.layoutInfo),i=this._context.viewLayout.getCurrentScrollLeft()+e.x-n.contentLeft;return d._getMouseColumn(i,t.get(v.fontInfo).typicalHalfwidthCharacterWidth)}static _getMouseColumn(e,t){return e<0?1:Math.round(e/t)+1}static createMouseTargetFromHitTestPosition(e,t,n,i,o){const r=i.lineNumber,l=i.column,a=e.getLineWidth(r);if(t.mouseContentHorizontalOffset>a){const u=V(t.mouseContentHorizontalOffset-a);return t.fulfillContentEmpty(i,u)}const c=e.visibleRangeForPosition(r,l);if(!c)return t.fulfillUnknown(i);const E=c.left;if(Math.abs(t.mouseContentHorizontalOffset-E)<1)return t.fulfillContentText(i,null,{mightBeForeignElement:!!o,injectedText:o});const h=[];if(h.push({offset:c.left,column:l}),l>1){const u=e.visibleRangeForPosition(r,l-1);u&&h.push({offset:u.left,column:l-1})}const A=e.viewModel.getLineMaxColumn(r);if(l<A){const u=e.visibleRangeForPosition(r,l+1);u&&h.push({offset:u.left,column:l+1})}h.sort((u,M)=>u.offset-M.offset);const H=t.pos.toClientCoordinates(O.getWindow(e.viewDomNode)),N=n.getBoundingClientRect(),_=N.left<=H.clientX&&H.clientX<=N.right;let w=null;for(let u=1;u<h.length;u++){const M=h[u-1],C=h[u];if(M.offset<=t.mouseContentHorizontalOffset&&t.mouseContentHorizontalOffset<=C.offset){w=new I(r,M.column,r,C.column);const x=Math.abs(M.offset-t.mouseContentHorizontalOffset),U=Math.abs(C.offset-t.mouseContentHorizontalOffset);i=x<U?new T(r,M.column):new T(r,C.column);break}}return t.fulfillContentText(i,w,{mightBeForeignElement:!_||!!o,injectedText:o})}static _doHitTestWithCaretRangeFromPoint(e,t){const n=e.getLineNumberAtVerticalOffset(t.mouseVerticalOffset),i=e.getVerticalOffsetForLineNumber(n),o=i+e.lineHeight;if(!(n===e.viewModel.getLineCount()&&t.mouseVerticalOffset>o)){const l=Math.floor((i+o)/2);let a=t.pos.y+(l-t.mouseVerticalOffset);a<=t.editorPos.y&&(a=t.editorPos.y+1),a>=t.editorPos.y+t.editorPos.height&&(a=t.editorPos.y+t.editorPos.height-1);const c=new G(t.pos.x,a),E=this._actualDoHitTestWithCaretRangeFromPoint(e,c.toClientCoordinates(O.getWindow(e.viewDomNode)));if(E.type===1)return E}return this._actualDoHitTestWithCaretRangeFromPoint(e,t.pos.toClientCoordinates(O.getWindow(e.viewDomNode)))}static _actualDoHitTestWithCaretRangeFromPoint(e,t){const n=O.getShadowRoot(e.viewDomNode);let i;if(n?typeof n.caretRangeFromPoint>"u"?i=j(n,t.clientX,t.clientY):i=n.caretRangeFromPoint(t.clientX,t.clientY):i=e.viewDomNode.ownerDocument.caretRangeFromPoint(t.clientX,t.clientY),!i||!i.startContainer)return new b;const o=i.startContainer;if(o.nodeType===o.TEXT_NODE){const r=o.parentNode,l=r?r.parentNode:null,a=l?l.parentNode:null;return(a&&a.nodeType===a.ELEMENT_NODE?a.className:null)===R.CLASS_NAME?y.createFromDOMInfo(e,r,i.startOffset):new b(o.parentNode)}else if(o.nodeType===o.ELEMENT_NODE){const r=o.parentNode,l=r?r.parentNode:null;return(l&&l.nodeType===l.ELEMENT_NODE?l.className:null)===R.CLASS_NAME?y.createFromDOMInfo(e,o,o.textContent.length):new b(o)}return new b}static _doHitTestWithCaretPositionFromPoint(e,t){const n=e.viewDomNode.ownerDocument.caretPositionFromPoint(t.clientX,t.clientY);if(n.offsetNode.nodeType===n.offsetNode.TEXT_NODE){const i=n.offsetNode.parentNode,o=i?i.parentNode:null,r=o?o.parentNode:null;return(r&&r.nodeType===r.ELEMENT_NODE?r.className:null)===R.CLASS_NAME?y.createFromDOMInfo(e,n.offsetNode.parentNode,n.offset):new b(n.offsetNode.parentNode)}if(n.offsetNode.nodeType===n.offsetNode.ELEMENT_NODE){const i=n.offsetNode.parentNode,o=i&&i.nodeType===i.ELEMENT_NODE?i.className:null,r=i?i.parentNode:null,l=r&&r.nodeType===r.ELEMENT_NODE?r.className:null;if(o===R.CLASS_NAME){const a=n.offsetNode.childNodes[Math.min(n.offset,n.offsetNode.childNodes.length-1)];if(a)return y.createFromDOMInfo(e,a,0)}else if(l===R.CLASS_NAME)return y.createFromDOMInfo(e,n.offsetNode,0)}return new b(n.offsetNode)}static _snapToSoftTabBoundary(e,t){const n=t.getLineContent(e.lineNumber),{tabSize:i}=t.model.getOptions(),o=Z.atomicPosition(n,e.column-1,i,B.Nearest);return o!==-1?new T(e.lineNumber,o+1):e}static doHitTest(e,t){let n=new b;if(typeof e.viewDomNode.ownerDocument.caretRangeFromPoint=="function"?n=this._doHitTestWithCaretRangeFromPoint(e,t):e.viewDomNode.ownerDocument.caretPositionFromPoint&&(n=this._doHitTestWithCaretPositionFromPoint(e,t.pos.toClientCoordinates(O.getWindow(e.viewDomNode)))),n.type===1){const i=e.viewModel.getInjectedTextAt(n.position),o=e.viewModel.normalizePosition(n.position,z.None);(i||!o.equals(n.position))&&(n=new D(o,n.spanNode,i))}return n}}function j(m,e,t){const n=document.createRange();let i=m.elementFromPoint(e,t);if(i!==null){for(;i&&i.firstChild&&i.firstChild.nodeType!==i.firstChild.TEXT_NODE&&i.lastChild&&i.lastChild.firstChild;)i=i.lastChild;const o=i.getBoundingClientRect(),r=O.getWindow(i),l=r.getComputedStyle(i,null).getPropertyValue("font-style"),a=r.getComputedStyle(i,null).getPropertyValue("font-variant"),c=r.getComputedStyle(i,null).getPropertyValue("font-weight"),E=r.getComputedStyle(i,null).getPropertyValue("font-size"),h=r.getComputedStyle(i,null).getPropertyValue("line-height"),A=r.getComputedStyle(i,null).getPropertyValue("font-family"),H=`${l} ${a} ${c} ${E}/${h} ${A}`,N=i.innerText;let _=o.left,w=0,u;if(e>o.left+o.width)w=N.length;else{const M=L.getInstance();for(let C=0;C<N.length+1;C++){if(u=M.getCharWidth(N.charAt(C),H)/2,_+=u,e<_){w=C;break}_+=u}}n.setStart(i.firstChild,w),n.setEnd(i.firstChild,w)}return n}class L{static _INSTANCE=null;static getInstance(){return L._INSTANCE||(L._INSTANCE=new L),L._INSTANCE}_cache;_canvas;constructor(){this._cache={},this._canvas=document.createElement("canvas")}getCharWidth(e,t){const n=e+t;if(this._cache[n])return this._cache[n];const i=this._canvas.getContext("2d");i.font=t;const r=i.measureText(e).width;return this._cache[n]=r,r}}export{P as HitTestContext,p as MouseTarget,d as MouseTargetFactory,Fe as PointerHandlerLastRenderData};
