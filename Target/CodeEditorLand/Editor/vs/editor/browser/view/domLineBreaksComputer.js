import{createTrustedTypesPolicy as X}from"../../../base/browser/trustedTypes.js";import{CharCode as d}from"../../../base/common/charCode.js";import*as R from"../../../base/common/strings.js";import{assertIsDefined as J}from"../../../base/common/types.js";import{WrappingIndent as O}from"../../common/config/editorOptions.js";import{StringBuilder as K}from"../../common/core/stringBuilder.js";import{ModelLineProjectionData as E}from"../../common/modelLineProjectionData.js";import{LineInjectedText as F}from"../../common/textModelEvents.js";import{applyFontInfo as Q}from"../config/domFontInfo.js";const Y=X("domLineBreaksComputer",{createHTML:o=>o});class H{constructor(t){this.targetWindow=t}static create(t){return new H(new WeakRef(t))}createLineBreaksComputer(t,r,i,e,a){const u=[],p=[];return{addRequest:(m,h,M)=>{u.push(m),p.push(h)},finalize:()=>Z(J(this.targetWindow.deref()),u,t,r,i,e,a,p)}}}function Z(o,t,r,i,e,a,u,p){function m(n){const s=p[n];if(s){const l=F.applyInjectedText(t[n],s),I=s.map(g=>g.options),k=s.map(g=>g.column-1);return new E(k,I,[l.length],[],0)}else return null}if(e===-1){const n=[];for(let s=0,l=t.length;s<l;s++)n[s]=m(s);return n}const h=Math.round(e*r.typicalHalfwidthCharacterWidth),M=a===O.DeepIndent?2:a===O.Indent?1:0,S=Math.round(i*M),f=Math.ceil(r.spaceWidth*S),c=document.createElement("div");Q(c,r);const C=new K(1e4),b=[],y=[],v=[],B=[],_=[];for(let n=0;n<t.length;n++){const s=F.applyInjectedText(t[n],p[n]);let l=0,I=0,k=h;if(a!==O.None)if(l=R.firstNonWhitespaceIndex(s),l===-1)l=0;else{for(let T=0;T<l;T++){const j=s.charCodeAt(T)===d.Tab?i-I%i:1;I+=j}const x=Math.ceil(r.spaceWidth*I);x+r.typicalFullwidthCharacterWidth>h?(l=0,I=0):k=h-x}const g=s.substr(l),W=z(g,I,i,k,C,f);b[n]=l,y[n]=I,v[n]=g,B[n]=W[0],_[n]=W[1]}const w=C.build(),U=Y?.createHTML(w)??w;c.innerHTML=U,c.style.position="absolute",c.style.top="10000",u==="keepAll"?(c.style.wordBreak="keep-all",c.style.overflowWrap="anywhere"):(c.style.wordBreak="inherit",c.style.overflowWrap="break-word"),o.document.body.appendChild(c);const G=document.createRange(),V=Array.prototype.slice.call(c.children,0),A=[];for(let n=0;n<t.length;n++){const s=V[n],l=q(G,s,v[n],B[n]);if(l===null){A[n]=m(n);continue}const I=b[n],k=y[n]+S,g=_[n],W=[];for(let L=0,D=l.length;L<D;L++)W[L]=g[l[L]];if(I!==0)for(let L=0,D=l.length;L<D;L++)l[L]+=I;let x,T;const j=p[n];j?(x=j.map(L=>L.options),T=j.map(L=>L.column-1)):(x=null,T=null),A[n]=new E(T,x,l,W,k)}return c.remove(),A}var $=(t=>(t[t.SPAN_MODULO_LIMIT=16384]="SPAN_MODULO_LIMIT",t))($||{});function z(o,t,r,i,e,a){if(a!==0){const f=String(a);e.appendString('<div style="text-indent: -'),e.appendString(f),e.appendString("px; padding-left: "),e.appendString(f),e.appendString("px; box-sizing: border-box; width:")}else e.appendString('<div style="width:');e.appendString(String(i)),e.appendString('px;">');const u=o.length;let p=t,m=0;const h=[],M=[];let S=u>0?o.charCodeAt(0):d.Null;e.appendString("<span>");for(let f=0;f<u;f++){f!==0&&f%16384===0&&e.appendString("</span><span>"),h[f]=m,M[f]=p;const c=S;S=f+1<u?o.charCodeAt(f+1):d.Null;let C=1,b=1;switch(c){case d.Tab:C=r-p%r,b=C;for(let y=1;y<=C;y++)y<C?e.appendCharCode(160):e.appendASCIICharCode(d.Space);break;case d.Space:S===d.Space?e.appendCharCode(160):e.appendASCIICharCode(d.Space);break;case d.LessThan:e.appendString("&lt;");break;case d.GreaterThan:e.appendString("&gt;");break;case d.Ampersand:e.appendString("&amp;");break;case d.Null:e.appendString("&#00;");break;case d.UTF8_BOM:case d.LINE_SEPARATOR:case d.PARAGRAPH_SEPARATOR:case d.NEXT_LINE:e.appendCharCode(65533);break;default:R.isFullWidthCharacter(c)&&b++,c<32?e.appendCharCode(9216+c):e.appendCharCode(c)}m+=C,p+=b}return e.appendString("</span>"),h[o.length]=m,M[o.length]=p,e.appendString("</div>"),[h,M]}function q(o,t,r,i){if(r.length<=1)return null;const e=Array.prototype.slice.call(t.children,0),a=[];try{N(o,e,i,0,null,r.length-1,null,a)}catch{return null}return a.length===0?null:(a.push(r.length),a)}function N(o,t,r,i,e,a,u,p){if(i===a||(e=e||P(o,t,r[i],r[i+1]),u=u||P(o,t,r[a],r[a+1]),Math.abs(e[0].top-u[0].top)<=.1))return;if(i+1===a){p.push(a);return}const m=i+(a-i)/2|0,h=P(o,t,r[m],r[m+1]);N(o,t,r,i,e,m,h,p),N(o,t,r,m,h,a,u,p)}function P(o,t,r,i){return o.setStart(t[r/16384|0].firstChild,r%16384),o.setEnd(t[i/16384|0].firstChild,i%16384),o.getClientRects()}export{H as DOMLineBreaksComputerFactory};
