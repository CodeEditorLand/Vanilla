import{createTrustedTypesPolicy as X}from"../../../base/browser/trustedTypes.js";import{CharCode as d}from"../../../base/common/charCode.js";import*as F from"../../../base/common/strings.js";import{assertIsDefined as J}from"../../../base/common/types.js";import{applyFontInfo as K}from"../config/domFontInfo.js";import{WrappingIndent as j}from"../../common/config/editorOptions.js";import"../../common/config/fontInfo.js";import{StringBuilder as Q}from"../../common/core/stringBuilder.js";import"../../common/model.js";import{ModelLineProjectionData as R}from"../../common/modelLineProjectionData.js";import{LineInjectedText as E}from"../../common/textModelEvents.js";const Y=X("domLineBreaksComputer",{createHTML:i=>i});class H{constructor(t){this.targetWindow=t}static create(t){return new H(new WeakRef(t))}createLineBreaksComputer(t,r,o,e,a){const u=[],p=[];return{addRequest:(m,f,M)=>{u.push(m),p.push(f)},finalize:()=>Z(J(this.targetWindow.deref()),u,t,r,o,e,a,p)}}}function Z(i,t,r,o,e,a,u,p){function m(n){const s=p[n];if(s){const l=E.applyInjectedText(t[n],s),C=s.map(g=>g.options),x=s.map(g=>g.column-1);return new R(x,C,[l.length],[],0)}else return null}if(e===-1){const n=[];for(let s=0,l=t.length;s<l;s++)n[s]=m(s);return n}const f=Math.round(e*r.typicalHalfwidthCharacterWidth),M=a===j.DeepIndent?2:a===j.Indent?1:0,S=Math.round(o*M),h=Math.ceil(r.spaceWidth*S),c=document.createElement("div");K(c,r);const I=new Q(1e4),b=[],k=[],v=[],B=[],_=[];for(let n=0;n<t.length;n++){const s=E.applyInjectedText(t[n],p[n]);let l=0,C=0,x=f;if(a!==j.None)if(l=F.firstNonWhitespaceIndex(s),l===-1)l=0;else{for(let T=0;T<l;T++){const W=s.charCodeAt(T)===d.Tab?o-C%o:1;C+=W}const y=Math.ceil(r.spaceWidth*C);y+r.typicalFullwidthCharacterWidth>f?(l=0,C=0):x=f-y}const g=s.substr(l),A=z(g,C,o,x,I,h);b[n]=l,k[n]=C,v[n]=g,B[n]=A[0],_[n]=A[1]}const w=I.build(),U=Y?.createHTML(w)??w;c.innerHTML=U,c.style.position="absolute",c.style.top="10000",u==="keepAll"?(c.style.wordBreak="keep-all",c.style.overflowWrap="anywhere"):(c.style.wordBreak="inherit",c.style.overflowWrap="break-word"),i.document.body.appendChild(c);const G=document.createRange(),V=Array.prototype.slice.call(c.children,0),D=[];for(let n=0;n<t.length;n++){const s=V[n],l=q(G,s,v[n],B[n]);if(l===null){D[n]=m(n);continue}const C=b[n],x=k[n]+S,g=_[n],A=[];for(let L=0,O=l.length;L<O;L++)A[L]=g[l[L]];if(C!==0)for(let L=0,O=l.length;L<O;L++)l[L]+=C;let y,T;const W=p[n];W?(y=W.map(L=>L.options),T=W.map(L=>L.column-1)):(y=null,T=null),D[n]=new R(T,y,l,A,x)}return c.remove(),D}var $=(t=>(t[t.SPAN_MODULO_LIMIT=16384]="SPAN_MODULO_LIMIT",t))($||{});function z(i,t,r,o,e,a){if(a!==0){const h=String(a);e.appendString('<div style="text-indent: -'),e.appendString(h),e.appendString("px; padding-left: "),e.appendString(h),e.appendString("px; box-sizing: border-box; width:")}else e.appendString('<div style="width:');e.appendString(String(o)),e.appendString('px;">');const u=i.length;let p=t,m=0;const f=[],M=[];let S=0<u?i.charCodeAt(0):d.Null;e.appendString("<span>");for(let h=0;h<u;h++){h!==0&&h%16384===0&&e.appendString("</span><span>"),f[h]=m,M[h]=p;const c=S;S=h+1<u?i.charCodeAt(h+1):d.Null;let I=1,b=1;switch(c){case d.Tab:I=r-p%r,b=I;for(let k=1;k<=I;k++)k<I?e.appendCharCode(160):e.appendASCIICharCode(d.Space);break;case d.Space:S===d.Space?e.appendCharCode(160):e.appendASCIICharCode(d.Space);break;case d.LessThan:e.appendString("&lt;");break;case d.GreaterThan:e.appendString("&gt;");break;case d.Ampersand:e.appendString("&amp;");break;case d.Null:e.appendString("&#00;");break;case d.UTF8_BOM:case d.LINE_SEPARATOR:case d.PARAGRAPH_SEPARATOR:case d.NEXT_LINE:e.appendCharCode(65533);break;default:F.isFullWidthCharacter(c)&&b++,c<32?e.appendCharCode(9216+c):e.appendCharCode(c)}m+=I,p+=b}return e.appendString("</span>"),f[i.length]=m,M[i.length]=p,e.appendString("</div>"),[f,M]}function q(i,t,r,o){if(r.length<=1)return null;const e=Array.prototype.slice.call(t.children,0),a=[];try{N(i,e,o,0,null,r.length-1,null,a)}catch{return null}return a.length===0?null:(a.push(r.length),a)}function N(i,t,r,o,e,a,u,p){if(o===a||(e=e||P(i,t,r[o],r[o+1]),u=u||P(i,t,r[a],r[a+1]),Math.abs(e[0].top-u[0].top)<=.1))return;if(o+1===a){p.push(a);return}const m=o+(a-o)/2|0,f=P(i,t,r[m],r[m+1]);N(i,t,r,o,e,m,f,p),N(i,t,r,m,f,a,u,p)}function P(i,t,r,o){return i.setStart(t[r/16384|0].firstChild,r%16384),i.setEnd(t[o/16384|0].firstChild,o%16384),i.getClientRects()}export{H as DOMLineBreaksComputerFactory};
