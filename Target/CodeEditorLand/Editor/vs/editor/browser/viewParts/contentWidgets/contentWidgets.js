import*as D from"../../../../base/browser/dom.js";import{createFastDomNode as _}from"../../../../base/browser/fastDomNode.js";import{EditorOption as u}from"../../../common/config/editorOptions.js";import{PositionAffinity as V}from"../../../common/model.js";import{ContentWidgetPositionPreference as m}from"../../editorBrowser.js";import{PartFingerprint as P,PartFingerprints as C,ViewPart as O}from"../../view/viewPart.js";class H extends O{_viewDomNode;_widgets;domNode;overflowingContentWidgetsDomNode;constructor(e,t){super(e),this._viewDomNode=t,this._widgets={},this.domNode=_(document.createElement("div")),C.write(this.domNode,P.ContentWidgets),this.domNode.setClassName("contentWidgets"),this.domNode.setPosition("absolute"),this.domNode.setTop(0),this.overflowingContentWidgetsDomNode=_(document.createElement("div")),C.write(this.overflowingContentWidgetsDomNode,P.OverflowingContentWidgets),this.overflowingContentWidgetsDomNode.setClassName("overflowingContentWidgets")}dispose(){super.dispose(),this._widgets={}}onConfigurationChanged(e){const t=Object.keys(this._widgets);for(const o of t)this._widgets[o].onConfigurationChanged(e);return!0}onDecorationsChanged(e){return!0}onFlushed(e){return!0}onLineMappingChanged(e){return this._updateAnchorsViewPositions(),!0}onLinesChanged(e){return this._updateAnchorsViewPositions(),!0}onLinesDeleted(e){return this._updateAnchorsViewPositions(),!0}onLinesInserted(e){return this._updateAnchorsViewPositions(),!0}onScrollChanged(e){return!0}onZonesChanged(e){return!0}_updateAnchorsViewPositions(){const e=Object.keys(this._widgets);for(const t of e)this._widgets[t].updateAnchorViewPosition()}addWidget(e){const t=new E(this._context,this._viewDomNode,e);this._widgets[t.id]=t,t.allowEditorOverflow?this.overflowingContentWidgetsDomNode.appendChild(t.domNode):this.domNode.appendChild(t.domNode),this.setShouldRender()}setWidgetPosition(e,t,o,i,n){this._widgets[e.getId()].setPosition(t,o,i,n),this.setShouldRender()}removeWidget(e){const t=e.getId();if(this._widgets.hasOwnProperty(t)){const o=this._widgets[t];delete this._widgets[t];const i=o.domNode.domNode;i.remove(),i.removeAttribute("monaco-visible-content-widget"),this.setShouldRender()}}shouldSuppressMouseDownOnWidget(e){return this._widgets.hasOwnProperty(e)?this._widgets[e].suppressMouseDown:!1}onBeforeRender(e){const t=Object.keys(this._widgets);for(const o of t)this._widgets[o].onBeforeRender(e)}prepareRender(e){const t=Object.keys(this._widgets);for(const o of t)this._widgets[o].prepareRender(e)}render(e){const t=Object.keys(this._widgets);for(const o of t)this._widgets[o].render(e)}}class E{_context;_viewDomNode;_actual;domNode;id;allowEditorOverflow;suppressMouseDown;_fixedOverflowWidgets;_contentWidth;_contentLeft;_lineHeight;_primaryAnchor=new w(null,null);_secondaryAnchor=new w(null,null);_affinity;_preference;_cachedDomNodeOffsetWidth;_cachedDomNodeOffsetHeight;_maxWidth;_isVisible;_renderData;constructor(e,t,o){this._context=e,this._viewDomNode=t,this._actual=o,this.domNode=_(this._actual.getDomNode()),this.id=this._actual.getId(),this.allowEditorOverflow=this._actual.allowEditorOverflow||!1,this.suppressMouseDown=this._actual.suppressMouseDown||!1;const i=this._context.configuration.options,n=i.get(u.layoutInfo);this._fixedOverflowWidgets=i.get(u.fixedOverflowWidgets),this._contentWidth=n.contentWidth,this._contentLeft=n.contentLeft,this._lineHeight=i.get(u.lineHeight),this._affinity=null,this._preference=[],this._cachedDomNodeOffsetWidth=-1,this._cachedDomNodeOffsetHeight=-1,this._maxWidth=this._getMaxWidth(),this._isVisible=!1,this._renderData=null,this.domNode.setPosition(this._fixedOverflowWidgets&&this.allowEditorOverflow?"fixed":"absolute"),this.domNode.setDisplay("none"),this.domNode.setVisibility("hidden"),this.domNode.setAttribute("widgetId",this.id),this.domNode.setMaxWidth(this._maxWidth)}onConfigurationChanged(e){const t=this._context.configuration.options;if(this._lineHeight=t.get(u.lineHeight),e.hasChanged(u.layoutInfo)){const o=t.get(u.layoutInfo);this._contentLeft=o.contentLeft,this._contentWidth=o.contentWidth,this._maxWidth=this._getMaxWidth()}}updateAnchorViewPosition(){this._setPosition(this._affinity,this._primaryAnchor.modelPosition,this._secondaryAnchor.modelPosition)}_setPosition(e,t,o){this._affinity=e,this._primaryAnchor=i(t,this._context.viewModel,this._affinity),this._secondaryAnchor=i(o,this._context.viewModel,this._affinity);function i(n,s,r){if(!n)return new w(null,null);const d=s.model.validatePosition(n);if(s.coordinatesConverter.modelPositionIsVisible(d)){const a=s.coordinatesConverter.convertModelPositionToViewPosition(d,r??void 0);return new w(n,a)}return new w(n,null)}}_getMaxWidth(){const e=this.domNode.domNode.ownerDocument,t=e.defaultView;return this.allowEditorOverflow?t?.innerWidth||e.documentElement.offsetWidth||e.body.offsetWidth:this._contentWidth}setPosition(e,t,o,i){this._setPosition(i,e,t),this._preference=o,this._primaryAnchor.viewPosition&&this._preference&&this._preference.length>0?this.domNode.setDisplay("block"):this.domNode.setDisplay("none"),this._cachedDomNodeOffsetWidth=-1,this._cachedDomNodeOffsetHeight=-1}_layoutBoxInViewport(e,t,o,i){const n=e.top,s=n,r=e.top+e.height,d=i.viewportHeight-r,a=n-o,c=s>=o,l=r,h=d>=o;let f=e.left;return f+t>i.scrollLeft+i.viewportWidth&&(f=i.scrollLeft+i.viewportWidth-t),f<i.scrollLeft&&(f=i.scrollLeft),{fitsAbove:c,aboveTop:a,fitsBelow:h,belowTop:l,left:f}}_layoutHorizontalSegmentInPage(e,t,o,i){const r=Math.max(15,t.left-i),d=Math.min(t.left+t.width+i,e.width-15),c=this._viewDomNode.domNode.ownerDocument.defaultView;let l=t.left+o-(c?.scrollX??0);if(l+i>d){const h=l-(d-i);l-=h,o-=h}if(l<r){const h=l-r;l-=h,o-=h}return[o,l]}_layoutBoxInPage(e,t,o,i){const n=e.top-o,s=e.top+e.height,r=D.getDomNodePagePosition(this._viewDomNode.domNode),d=this._viewDomNode.domNode.ownerDocument,a=d.defaultView,c=r.top+n-(a?.scrollY??0),l=r.top+s-(a?.scrollY??0),h=D.getClientArea(d.body),[f,I]=this._layoutHorizontalSegmentInPage(h,r,e.left-i.scrollLeft+this._contentLeft,t),b=22,A=22,y=c>=b,N=l+o<=h.height-A;return this._fixedOverflowWidgets?{fitsAbove:y,aboveTop:Math.max(c,b),fitsBelow:N,belowTop:l,left:I}:{fitsAbove:y,aboveTop:n,fitsBelow:N,belowTop:s,left:f}}_prepareRenderWidgetAtExactPositionOverflowing(e){return new g(e.top,e.left+this._contentLeft)}_getAnchorsCoordinates(e){const t=n(this._primaryAnchor.viewPosition,this._affinity,this._lineHeight),o=this._secondaryAnchor.viewPosition?.lineNumber===this._primaryAnchor.viewPosition?.lineNumber?this._secondaryAnchor.viewPosition:null,i=n(o,this._affinity,this._lineHeight);return{primary:t,secondary:i};function n(s,r,d){if(!s)return null;const a=e.visibleRangeForPosition(s);if(!a)return null;const c=s.column===1&&r===V.LeftOfInjectedText?0:a.left,l=e.getVerticalOffsetForLineNumber(s.lineNumber)-e.scrollTop;return new W(l,c,d)}}_reduceAnchorCoordinates(e,t,o){if(!t)return e;const i=this._context.configuration.options.get(u.fontInfo);let n=t.left;return n<e.left?n=Math.max(n,e.left-o+i.typicalFullwidthCharacterWidth):n=Math.min(n,e.left+o-i.typicalFullwidthCharacterWidth),new W(e.top,n,e.height)}_prepareRenderWidget(e){if(!this._preference||this._preference.length===0)return null;const{primary:t,secondary:o}=this._getAnchorsCoordinates(e);if(!t)return{kind:"offViewport",preserveFocus:this.domNode.domNode.contains(this.domNode.domNode.ownerDocument.activeElement)};if(this._cachedDomNodeOffsetWidth===-1||this._cachedDomNodeOffsetHeight===-1){let s=null;if(typeof this._actual.beforeRender=="function"&&(s=v(this._actual.beforeRender,this._actual)),s)this._cachedDomNodeOffsetWidth=s.width,this._cachedDomNodeOffsetHeight=s.height;else{const d=this.domNode.domNode.getBoundingClientRect();this._cachedDomNodeOffsetWidth=Math.round(d.width),this._cachedDomNodeOffsetHeight=Math.round(d.height)}}const i=this._reduceAnchorCoordinates(t,o,this._cachedDomNodeOffsetWidth);let n;this.allowEditorOverflow?n=this._layoutBoxInPage(i,this._cachedDomNodeOffsetWidth,this._cachedDomNodeOffsetHeight,e):n=this._layoutBoxInViewport(i,this._cachedDomNodeOffsetWidth,this._cachedDomNodeOffsetHeight,e);for(let s=1;s<=2;s++)for(const r of this._preference)if(r===m.ABOVE){if(!n)return null;if(s===2||n.fitsAbove)return{kind:"inViewport",coordinate:new g(n.aboveTop,n.left),position:m.ABOVE}}else if(r===m.BELOW){if(!n)return null;if(s===2||n.fitsBelow)return{kind:"inViewport",coordinate:new g(n.belowTop,n.left),position:m.BELOW}}else return this.allowEditorOverflow?{kind:"inViewport",coordinate:this._prepareRenderWidgetAtExactPositionOverflowing(new g(i.top,i.left)),position:m.EXACT}:{kind:"inViewport",coordinate:new g(i.top,i.left),position:m.EXACT};return null}onBeforeRender(e){!this._primaryAnchor.viewPosition||!this._preference||this._primaryAnchor.viewPosition.lineNumber<e.startLineNumber||this._primaryAnchor.viewPosition.lineNumber>e.endLineNumber||this.domNode.setMaxWidth(this._maxWidth)}prepareRender(e){this._renderData=this._prepareRenderWidget(e)}render(e){if(!this._renderData||this._renderData.kind==="offViewport"){this._isVisible&&(this.domNode.removeAttribute("monaco-visible-content-widget"),this._isVisible=!1,this._renderData?.kind==="offViewport"&&this._renderData.preserveFocus?this.domNode.setTop(-1e3):this.domNode.setVisibility("hidden")),typeof this._actual.afterRender=="function"&&v(this._actual.afterRender,this._actual,null);return}this.allowEditorOverflow?(this.domNode.setTop(this._renderData.coordinate.top),this.domNode.setLeft(this._renderData.coordinate.left)):(this.domNode.setTop(this._renderData.coordinate.top+e.scrollTop-e.bigNumbersDelta),this.domNode.setLeft(this._renderData.coordinate.left)),this._isVisible||(this.domNode.setVisibility("inherit"),this.domNode.setAttribute("monaco-visible-content-widget","true"),this._isVisible=!0),typeof this._actual.afterRender=="function"&&v(this._actual.afterRender,this._actual,this._renderData.position)}}class w{constructor(e,t){this.modelPosition=e;this.viewPosition=t}}class g{constructor(e,t){this.top=e;this.left=t}_coordinateBrand=void 0}class W{constructor(e,t,o){this.top=e;this.left=t;this.height=o}_anchorCoordinateBrand=void 0}function v(p,e,...t){try{return p.call(e,...t)}catch{return null}}export{H as ViewContentWidgets};
