import"./whitespace.css";import{CharCode as d}from"../../../../base/common/charCode.js";import*as H from"../../../../base/common/strings.js";import{EditorOption as m}from"../../../common/config/editorOptions.js";import{editorWhitespaces as M}from"../../../common/core/editorColorRegistry.js";import{Position as F}from"../../../common/core/position.js";import{LineRange as G}from"../../../common/viewLayout/viewLineRenderer.js";import{DynamicViewOverlay as T}from"../../view/dynamicViewOverlay.js";class z extends T{_context;_options;_selection;_renderResult;constructor(e){super(),this._context=e,this._options=new D(this._context.configuration),this._selection=[],this._renderResult=null,this._context.addEventHandler(this)}dispose(){this._context.removeEventHandler(this),this._renderResult=null,super.dispose()}onConfigurationChanged(e){const n=new D(this._context.configuration);return this._options.equals(n)?e.hasChanged(m.layoutInfo):(this._options=n,!0)}onCursorStateChanged(e){return this._selection=e.selections,this._options.renderWhitespace==="selection"}onDecorationsChanged(e){return!0}onFlushed(e){return!0}onLinesChanged(e){return!0}onLinesDeleted(e){return!0}onLinesInserted(e){return!0}onScrollChanged(e){return e.scrollTopChanged}onZonesChanged(e){return!0}prepareRender(e){if(this._options.renderWhitespace==="none"){this._renderResult=null;return}const n=e.visibleRange.startLineNumber,a=e.visibleRange.endLineNumber-n+1,f=new Array(a);for(let t=0;t<a;t++)f[t]=!0;const g=this._context.viewModel.getMinimapLinesRenderingData(e.viewportData.startLineNumber,e.viewportData.endLineNumber,f);this._renderResult=[];for(let t=e.viewportData.startLineNumber;t<=e.viewportData.endLineNumber;t++){const s=t-e.viewportData.startLineNumber,o=g.data[s];let l=null;if(this._options.renderWhitespace==="selection"){const p=this._selection;for(const h of p){if(h.endLineNumber<t||h.startLineNumber>t)continue;const c=h.startLineNumber===t?h.startColumn:o.minColumn,w=h.endLineNumber===t?h.endColumn:o.maxColumn;c<w&&(l||(l=[]),l.push(new G(c-1,w-1)))}}this._renderResult[s]=this._applyRenderWhitespace(e,t,l,o)}}_applyRenderWhitespace(e,n,i,a){if(this._options.renderWhitespace==="selection"&&!i||this._options.renderWhitespace==="trailing"&&a.continuesWithWrappedLine)return"";const f=this._context.theme.getColor(M),g=this._options.renderWithSVG,t=a.content,s=this._options.stopRenderingLineAfter===-1?t.length:Math.min(this._options.stopRenderingLineAfter,t.length),o=a.continuesWithWrappedLine,l=a.minColumn-1,p=this._options.renderWhitespace==="boundary",h=this._options.renderWhitespace==="trailing",c=this._options.lineHeight,w=this._options.middotWidth,R=this._options.wsmiddotWidth,u=this._options.spaceWidth,S=Math.abs(R-u),N=Math.abs(w-u),A=S<N?11825:183,y=this._options.canUseHalfwidthRightwardsArrow;let v="",I=!1,E=H.firstNonWhitespaceIndex(t),_;E===-1?(I=!0,E=s,_=s):_=H.lastNonWhitespaceIndex(t);let V=0,b=i&&i[V],x=0;for(let r=l;r<s;r++){const W=t.charCodeAt(r);if(b&&r>=b.endOffset&&(V++,b=i&&i[V]),W!==d.Tab&&W!==d.Space||h&&!I&&r<=_)continue;if(p&&r>=E&&r<=_&&W===d.Space){const L=r-1>=0?t.charCodeAt(r-1):d.Null,$=r+1<s?t.charCodeAt(r+1):d.Null;if(L!==d.Space&&$!==d.Space)continue}if(p&&o&&r===s-1){const L=r-1>=0?t.charCodeAt(r-1):d.Null;if(W===d.Space&&L!==d.Space&&L!==d.Tab)continue}if(i&&(!b||b.startOffset>r||b.endOffset<=r))continue;const C=e.visibleRangeForPosition(new F(n,r+1));C&&(g?(x=Math.max(x,C.left),W===d.Tab?v+=this._renderArrow(c,u,C.left):v+=`<circle cx="${(C.left+u/2).toFixed(2)}" cy="${(c/2).toFixed(2)}" r="${(u/7).toFixed(2)}" />`):W===d.Tab?v+=`<div class="mwh" style="left:${C.left}px;height:${c}px;">${y?"\uFFEB":"\u2192"}</div>`:v+=`<div class="mwh" style="left:${C.left}px;height:${c}px;">${String.fromCharCode(A)}</div>`)}return g?(x=Math.round(x+u),`<svg style="bottom:0;position:absolute;width:${x}px;height:${c}px" viewBox="0 0 ${x} ${c}" xmlns="http://www.w3.org/2000/svg" fill="${f}">`+v+"</svg>"):v}_renderArrow(e,n,i){const a=n/7,f=n,g=e/2,t=i,s={x:0,y:a/2},o={x:100/125*f,y:s.y},l={x:o.x-.2*o.x,y:o.y+.2*o.x},p={x:l.x+.1*o.x,y:l.y+.1*o.x},h={x:p.x+.35*o.x,y:p.y-.35*o.x},c={x:h.x,y:-h.y},w={x:p.x,y:-p.y},R={x:l.x,y:-l.y},u={x:o.x,y:-o.y},S={x:s.x,y:-s.y};return`<path d="M ${[s,o,l,p,h,c,w,R,u,S].map(y=>`${(t+y.x).toFixed(2)} ${(g+y.y).toFixed(2)}`).join(" L ")}" />`}render(e,n){if(!this._renderResult)return"";const i=n-e;return i<0||i>=this._renderResult.length?"":this._renderResult[i]}}class D{renderWhitespace;renderWithSVG;spaceWidth;middotWidth;wsmiddotWidth;canUseHalfwidthRightwardsArrow;lineHeight;stopRenderingLineAfter;constructor(e){const n=e.options,i=n.get(m.fontInfo),a=n.get(m.experimentalWhitespaceRendering);a==="off"?(this.renderWhitespace="none",this.renderWithSVG=!1):a==="svg"?(this.renderWhitespace=n.get(m.renderWhitespace),this.renderWithSVG=!0):(this.renderWhitespace=n.get(m.renderWhitespace),this.renderWithSVG=!1),this.spaceWidth=i.spaceWidth,this.middotWidth=i.middotWidth,this.wsmiddotWidth=i.wsmiddotWidth,this.canUseHalfwidthRightwardsArrow=i.canUseHalfwidthRightwardsArrow,this.lineHeight=n.get(m.lineHeight),this.stopRenderingLineAfter=n.get(m.stopRenderingLineAfter)}equals(e){return this.renderWhitespace===e.renderWhitespace&&this.renderWithSVG===e.renderWithSVG&&this.spaceWidth===e.spaceWidth&&this.middotWidth===e.middotWidth&&this.wsmiddotWidth===e.wsmiddotWidth&&this.canUseHalfwidthRightwardsArrow===e.canUseHalfwidthRightwardsArrow&&this.lineHeight===e.lineHeight&&this.stopRenderingLineAfter===e.stopRenderingLineAfter}}export{z as WhitespaceOverlay};
