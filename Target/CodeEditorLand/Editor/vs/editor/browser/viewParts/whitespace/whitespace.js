import"./whitespace.css";import{DynamicViewOverlay as F}from"../../view/dynamicViewOverlay.js";import"../../../common/core/selection.js";import"../../view/renderingContext.js";import"../../../common/viewModel/viewContext.js";import"../../../common/viewEvents.js";import"../../../common/viewModel.js";import{EditorOption as f}from"../../../common/config/editorOptions.js";import"../../../common/config/editorConfiguration.js";import*as H from"../../../../base/common/strings.js";import{CharCode as d}from"../../../../base/common/charCode.js";import{LineRange as G}from"../../../common/viewLayout/viewLineRenderer.js";import{Position as M}from"../../../common/core/position.js";import{editorWhitespaces as T}from"../../../common/core/editorColorRegistry.js";class oe extends F{_context;_options;_selection;_renderResult;constructor(e){super(),this._context=e,this._options=new D(this._context.configuration),this._selection=[],this._renderResult=null,this._context.addEventHandler(this)}dispose(){this._context.removeEventHandler(this),this._renderResult=null,super.dispose()}onConfigurationChanged(e){const n=new D(this._context.configuration);return this._options.equals(n)?e.hasChanged(f.layoutInfo):(this._options=n,!0)}onCursorStateChanged(e){return this._selection=e.selections,this._options.renderWhitespace==="selection"}onDecorationsChanged(e){return!0}onFlushed(e){return!0}onLinesChanged(e){return!0}onLinesDeleted(e){return!0}onLinesInserted(e){return!0}onScrollChanged(e){return e.scrollTopChanged}onZonesChanged(e){return!0}prepareRender(e){if(this._options.renderWhitespace==="none"){this._renderResult=null;return}const n=e.visibleRange.startLineNumber,a=e.visibleRange.endLineNumber-n+1,m=new Array(a);for(let t=0;t<a;t++)m[t]=!0;const g=this._context.viewModel.getMinimapLinesRenderingData(e.viewportData.startLineNumber,e.viewportData.endLineNumber,m);this._renderResult=[];for(let t=e.viewportData.startLineNumber;t<=e.viewportData.endLineNumber;t++){const s=t-e.viewportData.startLineNumber,r=g.data[s];let l=null;if(this._options.renderWhitespace==="selection"){const p=this._selection;for(const h of p){if(h.endLineNumber<t||h.startLineNumber>t)continue;const c=h.startLineNumber===t?h.startColumn:r.minColumn,w=h.endLineNumber===t?h.endColumn:r.maxColumn;c<w&&(l||(l=[]),l.push(new G(c-1,w-1)))}}this._renderResult[s]=this._applyRenderWhitespace(e,t,l,r)}}_applyRenderWhitespace(e,n,i,a){if(this._options.renderWhitespace==="selection"&&!i||this._options.renderWhitespace==="trailing"&&a.continuesWithWrappedLine)return"";const m=this._context.theme.getColor(T),g=this._options.renderWithSVG,t=a.content,s=this._options.stopRenderingLineAfter===-1?t.length:Math.min(this._options.stopRenderingLineAfter,t.length),r=a.continuesWithWrappedLine,l=a.minColumn-1,p=this._options.renderWhitespace==="boundary",h=this._options.renderWhitespace==="trailing",c=this._options.lineHeight,w=this._options.middotWidth,R=this._options.wsmiddotWidth,u=this._options.spaceWidth,S=Math.abs(R-u),N=Math.abs(w-u),A=S<N?11825:183,y=this._options.canUseHalfwidthRightwardsArrow;let b="",I=!1,E=H.firstNonWhitespaceIndex(t),_;E===-1?(I=!0,E=s,_=s):_=H.lastNonWhitespaceIndex(t);let V=0,v=i&&i[V],x=0;for(let o=l;o<s;o++){const W=t.charCodeAt(o);if(v&&o>=v.endOffset&&(V++,v=i&&i[V]),W!==d.Tab&&W!==d.Space||h&&!I&&o<=_)continue;if(p&&o>=E&&o<=_&&W===d.Space){const L=o-1>=0?t.charCodeAt(o-1):d.Null,$=o+1<s?t.charCodeAt(o+1):d.Null;if(L!==d.Space&&$!==d.Space)continue}if(p&&r&&o===s-1){const L=o-1>=0?t.charCodeAt(o-1):d.Null;if(W===d.Space&&L!==d.Space&&L!==d.Tab)continue}if(i&&(!v||v.startOffset>o||v.endOffset<=o))continue;const C=e.visibleRangeForPosition(new M(n,o+1));C&&(g?(x=Math.max(x,C.left),W===d.Tab?b+=this._renderArrow(c,u,C.left):b+=`<circle cx="${(C.left+u/2).toFixed(2)}" cy="${(c/2).toFixed(2)}" r="${(u/7).toFixed(2)}" />`):W===d.Tab?b+=`<div class="mwh" style="left:${C.left}px;height:${c}px;">${y?"\uFFEB":"\u2192"}</div>`:b+=`<div class="mwh" style="left:${C.left}px;height:${c}px;">${String.fromCharCode(A)}</div>`)}return g?(x=Math.round(x+u),`<svg style="bottom:0;position:absolute;width:${x}px;height:${c}px" viewBox="0 0 ${x} ${c}" xmlns="http://www.w3.org/2000/svg" fill="${m}">`+b+"</svg>"):b}_renderArrow(e,n,i){const a=n/7,m=n,g=e/2,t=i,s={x:0,y:a/2},r={x:100/125*m,y:s.y},l={x:r.x-.2*r.x,y:r.y+.2*r.x},p={x:l.x+.1*r.x,y:l.y+.1*r.x},h={x:p.x+.35*r.x,y:p.y-.35*r.x},c={x:h.x,y:-h.y},w={x:p.x,y:-p.y},R={x:l.x,y:-l.y},u={x:r.x,y:-r.y},S={x:s.x,y:-s.y};return`<path d="M ${[s,r,l,p,h,c,w,R,u,S].map(y=>`${(t+y.x).toFixed(2)} ${(g+y.y).toFixed(2)}`).join(" L ")}" />`}render(e,n){if(!this._renderResult)return"";const i=n-e;return i<0||i>=this._renderResult.length?"":this._renderResult[i]}}class D{renderWhitespace;renderWithSVG;spaceWidth;middotWidth;wsmiddotWidth;canUseHalfwidthRightwardsArrow;lineHeight;stopRenderingLineAfter;constructor(e){const n=e.options,i=n.get(f.fontInfo),a=n.get(f.experimentalWhitespaceRendering);a==="off"?(this.renderWhitespace="none",this.renderWithSVG=!1):a==="svg"?(this.renderWhitespace=n.get(f.renderWhitespace),this.renderWithSVG=!0):(this.renderWhitespace=n.get(f.renderWhitespace),this.renderWithSVG=!1),this.spaceWidth=i.spaceWidth,this.middotWidth=i.middotWidth,this.wsmiddotWidth=i.wsmiddotWidth,this.canUseHalfwidthRightwardsArrow=i.canUseHalfwidthRightwardsArrow,this.lineHeight=n.get(f.lineHeight),this.stopRenderingLineAfter=n.get(f.stopRenderingLineAfter)}equals(e){return this.renderWhitespace===e.renderWhitespace&&this.renderWithSVG===e.renderWithSVG&&this.spaceWidth===e.spaceWidth&&this.middotWidth===e.middotWidth&&this.wsmiddotWidth===e.wsmiddotWidth&&this.canUseHalfwidthRightwardsArrow===e.canUseHalfwidthRightwardsArrow&&this.lineHeight===e.lineHeight&&this.stopRenderingLineAfter===e.stopRenderingLineAfter}}export{oe as WhitespaceOverlay};
