import"./minimap.css";import*as R from"../../../../base/browser/dom.js";import{createFastDomNode as k}from"../../../../base/browser/fastDomNode.js";import{GlobalPointerMoveMonitor as ie}from"../../../../base/browser/globalPointerMoveMonitor.js";import{CharCode as Y}from"../../../../base/common/charCode.js";import{Disposable as ne}from"../../../../base/common/lifecycle.js";import*as oe from"../../../../base/common/platform.js";import*as j from"../../../../base/common/strings.js";import{RenderedLinesCollection as re}from"../../view/viewLayer.js";import{PartFingerprint as se,PartFingerprints as ae,ViewPart as le}from"../../view/viewPart.js";import{RenderMinimap as V,EditorOption as E,MINIMAP_GUTTER_WIDTH as I,EditorLayoutInfoComputer as de}from"../../../common/config/editorOptions.js";import{Range as B}from"../../../common/core/range.js";import{RGBA8 as z}from"../../../common/core/rgba.js";import{ScrollType as J}from"../../../common/editorCommon.js";import"../../../common/config/editorConfiguration.js";import{ColorId as K}from"../../../common/encodedTokenAttributes.js";import"./minimapCharRenderer.js";import{Constants as U}from"./minimapCharSheet.js";import{MinimapTokensColorTracker as me}from"../../../common/viewModel/minimapTokensColorTracker.js";import"../../view/renderingContext.js";import"../../../common/viewModel/viewContext.js";import"../../../common/editorTheme.js";import*as ue from"../../../common/viewEvents.js";import{ViewModelDecoration as he}from"../../../common/viewModel.js";import{minimapSelection as Q,minimapBackground as ce,minimapForegroundOpacity as pe,editorForeground as ge}from"../../../../platform/theme/common/colorRegistry.js";import"../../../common/model/textModel.js";import{Selection as be}from"../../../common/core/selection.js";import"../../../../base/common/color.js";import{EventType as X,Gesture as _e}from"../../../../base/browser/touch.js";import{MinimapCharRendererFactory as Le}from"./minimapCharRendererFactory.js";import{MinimapPosition as q,MinimapSectionHeaderStyle as fe}from"../../../common/model.js";import{createSingleCallFunction as ve}from"../../../../base/common/functional.js";import{LRUCache as Ce}from"../../../../base/common/map.js";import{DEFAULT_FONT_FAMILY as Me}from"../../../../base/browser/fonts.js";const Se=140,De=2;class O{renderMinimap;size;minimapHeightIsEditorHeight;scrollBeyondLastLine;paddingTop;paddingBottom;showSlider;autohide;pixelRatio;typicalHalfwidthCharacterWidth;lineHeight;minimapLeft;minimapWidth;minimapHeight;canvasInnerWidth;canvasInnerHeight;canvasOuterWidth;canvasOuterHeight;isSampling;editorHeight;fontScale;minimapLineHeight;minimapCharWidth;sectionHeaderFontFamily;sectionHeaderFontSize;sectionHeaderLetterSpacing;sectionHeaderFontColor;charRenderer;defaultBackgroundColor;backgroundColor;foregroundAlpha;constructor(e,i,t){const n=e.options,o=n.get(E.pixelRatio),r=n.get(E.layoutInfo),s=r.minimap,d=n.get(E.fontInfo),a=n.get(E.minimap);this.renderMinimap=s.renderMinimap,this.size=a.size,this.minimapHeightIsEditorHeight=s.minimapHeightIsEditorHeight,this.scrollBeyondLastLine=n.get(E.scrollBeyondLastLine),this.paddingTop=n.get(E.padding).top,this.paddingBottom=n.get(E.padding).bottom,this.showSlider=a.showSlider,this.autohide=a.autohide,this.pixelRatio=o,this.typicalHalfwidthCharacterWidth=d.typicalHalfwidthCharacterWidth,this.lineHeight=n.get(E.lineHeight),this.minimapLeft=s.minimapLeft,this.minimapWidth=s.minimapWidth,this.minimapHeight=r.height,this.canvasInnerWidth=s.minimapCanvasInnerWidth,this.canvasInnerHeight=s.minimapCanvasInnerHeight,this.canvasOuterWidth=s.minimapCanvasOuterWidth,this.canvasOuterHeight=s.minimapCanvasOuterHeight,this.isSampling=s.minimapIsSampling,this.editorHeight=r.height,this.fontScale=s.minimapScale,this.minimapLineHeight=s.minimapLineHeight,this.minimapCharWidth=U.BASE_CHAR_WIDTH*this.fontScale,this.sectionHeaderFontFamily=Me,this.sectionHeaderFontSize=a.sectionHeaderFontSize*o,this.sectionHeaderLetterSpacing=a.sectionHeaderLetterSpacing,this.sectionHeaderFontColor=O._getSectionHeaderColor(i,t.getColor(K.DefaultForeground)),this.charRenderer=ve(()=>Le.create(this.fontScale,d.fontFamily)),this.defaultBackgroundColor=t.getColor(K.DefaultBackground),this.backgroundColor=O._getMinimapBackground(i,this.defaultBackgroundColor),this.foregroundAlpha=O._getMinimapForegroundOpacity(i)}static _getMinimapBackground(e,i){const t=e.getColor(ce);return t?new z(t.rgba.r,t.rgba.g,t.rgba.b,Math.round(255*t.rgba.a)):i}static _getMinimapForegroundOpacity(e){const i=e.getColor(pe);return i?z._clamp(Math.round(255*i.rgba.a)):255}static _getSectionHeaderColor(e,i){const t=e.getColor(ge);return t?new z(t.rgba.r,t.rgba.g,t.rgba.b,Math.round(255*t.rgba.a)):i}equals(e){return this.renderMinimap===e.renderMinimap&&this.size===e.size&&this.minimapHeightIsEditorHeight===e.minimapHeightIsEditorHeight&&this.scrollBeyondLastLine===e.scrollBeyondLastLine&&this.paddingTop===e.paddingTop&&this.paddingBottom===e.paddingBottom&&this.showSlider===e.showSlider&&this.autohide===e.autohide&&this.pixelRatio===e.pixelRatio&&this.typicalHalfwidthCharacterWidth===e.typicalHalfwidthCharacterWidth&&this.lineHeight===e.lineHeight&&this.minimapLeft===e.minimapLeft&&this.minimapWidth===e.minimapWidth&&this.minimapHeight===e.minimapHeight&&this.canvasInnerWidth===e.canvasInnerWidth&&this.canvasInnerHeight===e.canvasInnerHeight&&this.canvasOuterWidth===e.canvasOuterWidth&&this.canvasOuterHeight===e.canvasOuterHeight&&this.isSampling===e.isSampling&&this.editorHeight===e.editorHeight&&this.fontScale===e.fontScale&&this.minimapLineHeight===e.minimapLineHeight&&this.minimapCharWidth===e.minimapCharWidth&&this.sectionHeaderFontSize===e.sectionHeaderFontSize&&this.sectionHeaderLetterSpacing===e.sectionHeaderLetterSpacing&&this.defaultBackgroundColor&&this.defaultBackgroundColor.equals(e.defaultBackgroundColor)&&this.backgroundColor&&this.backgroundColor.equals(e.backgroundColor)&&this.foregroundAlpha===e.foregroundAlpha}}class W{constructor(e,i,t,n,o,r,s,d,a){this.scrollTop=e;this.scrollHeight=i;this.sliderNeeded=t;this._computedSliderRatio=n;this.sliderTop=o;this.sliderHeight=r;this.topPaddingLineCount=s;this.startLineNumber=d;this.endLineNumber=a}getDesiredScrollTopFromDelta(e){return Math.round(this.scrollTop+e/this._computedSliderRatio)}getDesiredScrollTopFromTouchLocation(e){return Math.round((e-this.sliderHeight/2)/this._computedSliderRatio)}intersectWithViewport(e){const i=Math.max(this.startLineNumber,e.startLineNumber),t=Math.min(this.endLineNumber,e.endLineNumber);return i>t?null:[i,t]}getYForLineNumber(e,i){return+(e-this.startLineNumber+this.topPaddingLineCount)*i}static create(e,i,t,n,o,r,s,d,a,l,m){const p=e.pixelRatio,h=e.minimapLineHeight,g=Math.floor(e.canvasInnerHeight/h),u=e.lineHeight;if(e.minimapHeightIsEditorHeight){let v=d*e.lineHeight+e.paddingTop+e.paddingBottom;e.scrollBeyondLastLine&&(v+=Math.max(0,o-e.lineHeight-e.paddingBottom));const C=Math.max(1,Math.floor(o*o/v)),M=Math.max(0,e.minimapHeight-C),S=M/(l-o),w=a*S,D=M>0,y=Math.floor(e.canvasInnerHeight/e.minimapLineHeight),T=Math.floor(e.paddingTop/e.lineHeight);return new W(a,l,D,S,w,C,T,1,Math.min(s,y))}let c;if(r&&t!==s){const v=t-i+1;c=Math.floor(v*h/p)}else{const v=o/u;c=Math.floor(v*h/p)}const b=Math.floor(e.paddingTop/u);let _=Math.floor(e.paddingBottom/u);if(e.scrollBeyondLastLine){const v=o/u;_=Math.max(_,v-1)}let L;if(_>0){const v=o/u;L=(b+s+_-v-1)*h/p}else L=Math.max(0,(b+s)*h/p-c);L=Math.min(e.minimapHeight-c,L);const f=L/(l-o),N=a*f;if(g>=b+s+_){const v=L>0;return new W(a,l,v,f,N,c,b,1,s)}else{let v;i>1?v=i+b:v=Math.max(1,a/u);let C,M=Math.max(1,Math.floor(v-N*p/h));M<b?(C=b-M+1,M=1):(C=0,M=Math.max(1,M-b)),m&&m.scrollHeight===l&&(m.scrollTop>a&&(M=Math.min(M,m.startLineNumber),C=Math.max(C,m.topPaddingLineCount)),m.scrollTop<a&&(M=Math.max(M,m.startLineNumber),C=Math.min(C,m.topPaddingLineCount)));const S=Math.min(s,M-C+g-1),w=(a-n)/u;let D;return a>=e.paddingTop?D=(i-M+C+w)*h/p:D=a/e.paddingTop*(C+w)*h/p,new W(a,l,!0,f,D,c,C,M,S)}}}class G{static INVALID=new G(-1);dy;constructor(e){this.dy=e}onContentChanged(){this.dy=-1}onTokensChanged(){this.dy=-1}}class ee{renderedLayout;_imageData;_renderedLines;constructor(e,i,t){this.renderedLayout=e,this._imageData=i,this._renderedLines=new re({createLine:()=>G.INVALID}),this._renderedLines._set(e.startLineNumber,t)}linesEquals(e){if(!this.scrollEquals(e))return!1;const t=this._renderedLines._get().lines;for(let n=0,o=t.length;n<o;n++)if(t[n].dy===-1)return!1;return!0}scrollEquals(e){return this.renderedLayout.startLineNumber===e.startLineNumber&&this.renderedLayout.endLineNumber===e.endLineNumber}_get(){const e=this._renderedLines._get();return{imageData:this._imageData,rendLineNumberStart:e.rendLineNumberStart,lines:e.lines}}onLinesChanged(e,i){return this._renderedLines.onLinesChanged(e,i)}onLinesDeleted(e,i){this._renderedLines.onLinesDeleted(e,i)}onLinesInserted(e,i){this._renderedLines.onLinesInserted(e,i)}onTokensChanged(e){return this._renderedLines.onTokensChanged(e)}}class ${_backgroundFillData;_buffers;_lastUsedBuffer;constructor(e,i,t,n){this._backgroundFillData=$._createBackgroundFillData(i,t,n),this._buffers=[e.createImageData(i,t),e.createImageData(i,t)],this._lastUsedBuffer=0}getBuffer(){this._lastUsedBuffer=1-this._lastUsedBuffer;const e=this._buffers[this._lastUsedBuffer];return e.data.set(this._backgroundFillData),e}static _createBackgroundFillData(e,i,t){const n=t.r,o=t.g,r=t.b,s=t.a,d=new Uint8ClampedArray(e*i*4);let a=0;for(let l=0;l<i;l++)for(let m=0;m<e;m++)d[a]=n,d[a+1]=o,d[a+2]=r,d[a+3]=s,a+=4;return d}}class P{constructor(e,i){this.samplingRatio=e;this.minimapLines=i}static compute(e,i,t){if(e.renderMinimap===V.None||!e.isSampling)return[null,[]];const{minimapLineCount:n}=de.computeContainedMinimapLineCount({viewLineCount:i,scrollBeyondLastLine:e.scrollBeyondLastLine,paddingTop:e.paddingTop,paddingBottom:e.paddingBottom,height:e.editorHeight,lineHeight:e.lineHeight,pixelRatio:e.pixelRatio}),o=i/n,r=o/2;if(!t||t.minimapLines.length===0){const c=[];if(c[0]=1,n>1){for(let b=0,_=n-1;b<_;b++)c[b]=Math.round(b*o+r);c[n-1]=i}return[new P(o,c),[]]}const s=t.minimapLines,d=s.length,a=[];let l=0,m=0,p=1;const h=10;let g=[],u=null;for(let c=0;c<n;c++){const b=Math.max(p,Math.round(c*o)),_=Math.max(b,Math.round((c+1)*o));for(;l<d&&s[l]<b;){if(g.length<h){const f=l+1+m;u&&u.type==="deleted"&&u._oldIndex===l-1?u.deleteToLineNumber++:(u={type:"deleted",_oldIndex:l,deleteFromLineNumber:f,deleteToLineNumber:f},g.push(u)),m--}l++}let L;if(l<d&&s[l]<=_)L=s[l],l++;else if(c===0?L=1:c+1===n?L=i:L=Math.round(c*o+r),g.length<h){const f=l+1+m;u&&u.type==="inserted"&&u._i===c-1?u.insertToLineNumber++:(u={type:"inserted",_i:c,insertFromLineNumber:f,insertToLineNumber:f},g.push(u)),m++}a[c]=L,p=L}if(g.length<h)for(;l<d;){const c=l+1+m;u&&u.type==="deleted"&&u._oldIndex===l-1?u.deleteToLineNumber++:(u={type:"deleted",_oldIndex:l,deleteFromLineNumber:c,deleteToLineNumber:c},g.push(u)),m--,l++}else g=[{type:"flush"}];return[new P(o,a),g]}modelLineToMinimapLine(e){return Math.min(this.minimapLines.length,Math.max(1,Math.round(e/this.samplingRatio)))}modelLineRangeToMinimapLineRange(e,i){let t=this.modelLineToMinimapLine(e)-1;for(;t>0&&this.minimapLines[t-1]>=e;)t--;let n=this.modelLineToMinimapLine(i)-1;for(;n+1<this.minimapLines.length&&this.minimapLines[n+1]<=i;)n++;if(t===n){const o=this.minimapLines[t];if(o<e||o>i)return null}return[t+1,n+1]}decorationLineRangeToMinimapLineRange(e,i){let t=this.modelLineToMinimapLine(e),n=this.modelLineToMinimapLine(i);return e!==i&&n===t&&(n===this.minimapLines.length?t>1&&t--:n++),[t,n]}onLinesDeleted(e){const i=e.toLineNumber-e.fromLineNumber+1;let t=this.minimapLines.length,n=0;for(let o=this.minimapLines.length-1;o>=0&&!(this.minimapLines[o]<e.fromLineNumber);o--)this.minimapLines[o]<=e.toLineNumber?(this.minimapLines[o]=Math.max(1,e.fromLineNumber-1),t=Math.min(t,o),n=Math.max(n,o)):this.minimapLines[o]-=i;return[t,n]}onLinesInserted(e){const i=e.toLineNumber-e.fromLineNumber+1;for(let t=this.minimapLines.length-1;t>=0&&!(this.minimapLines[t]<e.fromLineNumber);t--)this.minimapLines[t]+=i}}class gt extends le{tokensColorTracker;_selections;_minimapSelections;options;_samplingState;_shouldCheckSampling;_sectionHeaderCache=new Ce(10,1.5);_actual;constructor(e){super(e),this.tokensColorTracker=me.getInstance(),this._selections=[],this._minimapSelections=null,this.options=new O(this._context.configuration,this._context.theme,this.tokensColorTracker);const[i]=P.compute(this.options,this._context.viewModel.getLineCount(),null);this._samplingState=i,this._shouldCheckSampling=!1,this._actual=new F(e.theme,this)}dispose(){this._actual.dispose(),super.dispose()}getDomNode(){return this._actual.getDomNode()}_onOptionsMaybeChanged(){const e=new O(this._context.configuration,this._context.theme,this.tokensColorTracker);return this.options.equals(e)?!1:(this.options=e,this._recreateLineSampling(),this._actual.onDidChangeOptions(),!0)}onConfigurationChanged(e){return this._onOptionsMaybeChanged()}onCursorStateChanged(e){return this._selections=e.selections,this._minimapSelections=null,this._actual.onSelectionChanged()}onDecorationsChanged(e){return e.affectsMinimap?this._actual.onDecorationsChanged():!1}onFlushed(e){return this._samplingState&&(this._shouldCheckSampling=!0),this._actual.onFlushed()}onLinesChanged(e){if(this._samplingState){const i=this._samplingState.modelLineRangeToMinimapLineRange(e.fromLineNumber,e.fromLineNumber+e.count-1);return i?this._actual.onLinesChanged(i[0],i[1]-i[0]+1):!1}else return this._actual.onLinesChanged(e.fromLineNumber,e.count)}onLinesDeleted(e){if(this._samplingState){const[i,t]=this._samplingState.onLinesDeleted(e);return i<=t&&this._actual.onLinesChanged(i+1,t-i+1),this._shouldCheckSampling=!0,!0}else return this._actual.onLinesDeleted(e.fromLineNumber,e.toLineNumber)}onLinesInserted(e){return this._samplingState?(this._samplingState.onLinesInserted(e),this._shouldCheckSampling=!0,!0):this._actual.onLinesInserted(e.fromLineNumber,e.toLineNumber)}onScrollChanged(e){return this._actual.onScrollChanged()}onThemeChanged(e){return this._actual.onThemeChanged(),this._onOptionsMaybeChanged(),!0}onTokensChanged(e){if(this._samplingState){const i=[];for(const t of e.ranges){const n=this._samplingState.modelLineRangeToMinimapLineRange(t.fromLineNumber,t.toLineNumber);n&&i.push({fromLineNumber:n[0],toLineNumber:n[1]})}return i.length?this._actual.onTokensChanged(i):!1}else return this._actual.onTokensChanged(e.ranges)}onTokensColorsChanged(e){return this._onOptionsMaybeChanged(),this._actual.onTokensColorsChanged()}onZonesChanged(e){return this._actual.onZonesChanged()}prepareRender(e){this._shouldCheckSampling&&(this._shouldCheckSampling=!1,this._recreateLineSampling())}render(e){let i=e.visibleRange.startLineNumber,t=e.visibleRange.endLineNumber;this._samplingState&&(i=this._samplingState.modelLineToMinimapLine(i),t=this._samplingState.modelLineToMinimapLine(t));const n={viewportContainsWhitespaceGaps:e.viewportData.whitespaceViewportData.length>0,scrollWidth:e.scrollWidth,scrollHeight:e.scrollHeight,viewportStartLineNumber:i,viewportEndLineNumber:t,viewportStartLineNumberVerticalOffset:e.getVerticalOffsetForLineNumber(i),scrollTop:e.scrollTop,scrollLeft:e.scrollLeft,viewportWidth:e.viewportWidth,viewportHeight:e.viewportHeight};this._actual.render(n)}_recreateLineSampling(){this._minimapSelections=null;const e=!!this._samplingState,[i,t]=P.compute(this.options,this._context.viewModel.getLineCount(),this._samplingState);if(this._samplingState=i,e&&this._samplingState)for(const n of t)switch(n.type){case"deleted":this._actual.onLinesDeleted(n.deleteFromLineNumber,n.deleteToLineNumber);break;case"inserted":this._actual.onLinesInserted(n.insertFromLineNumber,n.insertToLineNumber);break;case"flush":this._actual.onFlushed();break}}getLineCount(){return this._samplingState?this._samplingState.minimapLines.length:this._context.viewModel.getLineCount()}getRealLineCount(){return this._context.viewModel.getLineCount()}getLineContent(e){return this._samplingState?this._context.viewModel.getLineContent(this._samplingState.minimapLines[e-1]):this._context.viewModel.getLineContent(e)}getLineMaxColumn(e){return this._samplingState?this._context.viewModel.getLineMaxColumn(this._samplingState.minimapLines[e-1]):this._context.viewModel.getLineMaxColumn(e)}getMinimapLinesRenderingData(e,i,t){if(this._samplingState){const n=[];for(let o=0,r=i-e+1;o<r;o++)t[o]?n[o]=this._context.viewModel.getViewLineData(this._samplingState.minimapLines[e+o-1]):n[o]=null;return n}return this._context.viewModel.getMinimapLinesRenderingData(e,i,t).data}getSelections(){if(this._minimapSelections===null)if(this._samplingState){this._minimapSelections=[];for(const e of this._selections){const[i,t]=this._samplingState.decorationLineRangeToMinimapLineRange(e.startLineNumber,e.endLineNumber);this._minimapSelections.push(new be(i,e.startColumn,t,e.endColumn))}}else this._minimapSelections=this._selections;return this._minimapSelections}getMinimapDecorationsInViewport(e,i){const t=this._getMinimapDecorationsInViewport(e,i).filter(n=>!n.options.minimap?.sectionHeaderStyle);if(this._samplingState){const n=[];for(const o of t){if(!o.options.minimap)continue;const r=o.range,s=this._samplingState.modelLineToMinimapLine(r.startLineNumber),d=this._samplingState.modelLineToMinimapLine(r.endLineNumber);n.push(new he(new B(s,r.startColumn,d,r.endColumn),o.options))}return n}return t}getSectionHeaderDecorationsInViewport(e,i){const t=this.options.minimapLineHeight,o=this.options.sectionHeaderFontSize/t;return e=Math.floor(Math.max(1,e-o)),this._getMinimapDecorationsInViewport(e,i).filter(r=>!!r.options.minimap?.sectionHeaderStyle)}_getMinimapDecorationsInViewport(e,i){let t;if(this._samplingState){const n=this._samplingState.minimapLines[e-1],o=this._samplingState.minimapLines[i-1];t=new B(n,1,o,this._context.viewModel.getLineMaxColumn(o))}else t=new B(e,1,i,this._context.viewModel.getLineMaxColumn(i));return this._context.viewModel.getMinimapDecorationsInRange(t)}getSectionHeaderText(e,i){const t=e.options.minimap?.sectionHeaderText;if(!t)return null;const n=this._sectionHeaderCache.get(t);if(n)return n;const o=i(t);return this._sectionHeaderCache.set(t,o),o}getOptions(){return this._context.viewModel.model.getOptions()}revealLineNumber(e){this._samplingState&&(e=this._samplingState.minimapLines[e-1]),this._context.viewModel.revealRange("mouse",!1,new B(e,1,e,1),ue.VerticalRevealType.Center,J.Smooth)}setScrollTop(e){this._context.viewModel.viewLayout.setScrollPosition({scrollTop:e},J.Immediate)}}class F extends ne{_theme;_model;_domNode;_shadow;_canvas;_decorationsCanvas;_slider;_sliderHorizontal;_pointerDownListener;_sliderPointerMoveMonitor;_sliderPointerDownListener;_gestureDisposable;_sliderTouchStartListener;_sliderTouchMoveListener;_sliderTouchEndListener;_lastRenderData;_selectionColor;_renderDecorations=!1;_gestureInProgress=!1;_buffers;constructor(e,i){super(),this._theme=e,this._model=i,this._lastRenderData=null,this._buffers=null,this._selectionColor=this._theme.getColor(Q),this._domNode=k(document.createElement("div")),ae.write(this._domNode,se.Minimap),this._domNode.setClassName(this._getMinimapDomNodeClassName()),this._domNode.setPosition("absolute"),this._domNode.setAttribute("role","presentation"),this._domNode.setAttribute("aria-hidden","true"),this._shadow=k(document.createElement("div")),this._shadow.setClassName("minimap-shadow-hidden"),this._domNode.appendChild(this._shadow),this._canvas=k(document.createElement("canvas")),this._canvas.setPosition("absolute"),this._canvas.setLeft(0),this._domNode.appendChild(this._canvas),this._decorationsCanvas=k(document.createElement("canvas")),this._decorationsCanvas.setPosition("absolute"),this._decorationsCanvas.setClassName("minimap-decorations-layer"),this._decorationsCanvas.setLeft(0),this._domNode.appendChild(this._decorationsCanvas),this._slider=k(document.createElement("div")),this._slider.setPosition("absolute"),this._slider.setClassName("minimap-slider"),this._slider.setLayerHinting(!0),this._slider.setContain("strict"),this._domNode.appendChild(this._slider),this._sliderHorizontal=k(document.createElement("div")),this._sliderHorizontal.setPosition("absolute"),this._sliderHorizontal.setClassName("minimap-slider-horizontal"),this._slider.appendChild(this._sliderHorizontal),this._applyLayout(),this._pointerDownListener=R.addStandardDisposableListener(this._domNode.domNode,R.EventType.POINTER_DOWN,t=>{if(t.preventDefault(),this._model.options.renderMinimap===V.None||!this._lastRenderData)return;if(this._model.options.size!=="proportional"){if(t.button===0&&this._lastRenderData){const a=R.getDomNodePagePosition(this._slider.domNode),l=a.top+a.height/2;this._startSliderDragging(t,l,this._lastRenderData.renderedLayout)}return}const o=this._model.options.minimapLineHeight,r=this._model.options.canvasInnerHeight/this._model.options.canvasOuterHeight*t.offsetY;let d=Math.floor(r/o)+this._lastRenderData.renderedLayout.startLineNumber-this._lastRenderData.renderedLayout.topPaddingLineCount;d=Math.min(d,this._model.getLineCount()),this._model.revealLineNumber(d)}),this._sliderPointerMoveMonitor=new ie,this._sliderPointerDownListener=R.addStandardDisposableListener(this._slider.domNode,R.EventType.POINTER_DOWN,t=>{t.preventDefault(),t.stopPropagation(),t.button===0&&this._lastRenderData&&this._startSliderDragging(t,t.pageY,this._lastRenderData.renderedLayout)}),this._gestureDisposable=_e.addTarget(this._domNode.domNode),this._sliderTouchStartListener=R.addDisposableListener(this._domNode.domNode,X.Start,t=>{t.preventDefault(),t.stopPropagation(),this._lastRenderData&&(this._slider.toggleClassName("active",!0),this._gestureInProgress=!0,this.scrollDueToTouchEvent(t))},{passive:!1}),this._sliderTouchMoveListener=R.addDisposableListener(this._domNode.domNode,X.Change,t=>{t.preventDefault(),t.stopPropagation(),this._lastRenderData&&this._gestureInProgress&&this.scrollDueToTouchEvent(t)},{passive:!1}),this._sliderTouchEndListener=R.addStandardDisposableListener(this._domNode.domNode,X.End,t=>{t.preventDefault(),t.stopPropagation(),this._gestureInProgress=!1,this._slider.toggleClassName("active",!1)})}_startSliderDragging(e,i,t){if(!e.target||!(e.target instanceof Element))return;const n=e.pageX;this._slider.toggleClassName("active",!0);const o=(r,s)=>{const d=R.getDomNodePagePosition(this._domNode.domNode),a=Math.min(Math.abs(s-n),Math.abs(s-d.left),Math.abs(s-d.left-d.width));if(oe.isWindows&&a>Se){this._model.setScrollTop(t.scrollTop);return}const l=r-i;this._model.setScrollTop(t.getDesiredScrollTopFromDelta(l))};e.pageY!==i&&o(e.pageY,n),this._sliderPointerMoveMonitor.startMonitoring(e.target,e.pointerId,e.buttons,r=>o(r.pageY,r.pageX),()=>{this._slider.toggleClassName("active",!1)})}scrollDueToTouchEvent(e){const i=this._domNode.domNode.getBoundingClientRect().top,t=this._lastRenderData.renderedLayout.getDesiredScrollTopFromTouchLocation(e.pageY-i);this._model.setScrollTop(t)}dispose(){this._pointerDownListener.dispose(),this._sliderPointerMoveMonitor.dispose(),this._sliderPointerDownListener.dispose(),this._gestureDisposable.dispose(),this._sliderTouchStartListener.dispose(),this._sliderTouchMoveListener.dispose(),this._sliderTouchEndListener.dispose(),super.dispose()}_getMinimapDomNodeClassName(){const e=["minimap"];return this._model.options.showSlider==="always"?e.push("slider-always"):e.push("slider-mouseover"),this._model.options.autohide&&e.push("autohide"),e.join(" ")}getDomNode(){return this._domNode}_applyLayout(){this._domNode.setLeft(this._model.options.minimapLeft),this._domNode.setWidth(this._model.options.minimapWidth),this._domNode.setHeight(this._model.options.minimapHeight),this._shadow.setHeight(this._model.options.minimapHeight),this._canvas.setWidth(this._model.options.canvasOuterWidth),this._canvas.setHeight(this._model.options.canvasOuterHeight),this._canvas.domNode.width=this._model.options.canvasInnerWidth,this._canvas.domNode.height=this._model.options.canvasInnerHeight,this._decorationsCanvas.setWidth(this._model.options.canvasOuterWidth),this._decorationsCanvas.setHeight(this._model.options.canvasOuterHeight),this._decorationsCanvas.domNode.width=this._model.options.canvasInnerWidth,this._decorationsCanvas.domNode.height=this._model.options.canvasInnerHeight,this._slider.setWidth(this._model.options.minimapWidth)}_getBuffer(){return this._buffers||this._model.options.canvasInnerWidth>0&&this._model.options.canvasInnerHeight>0&&(this._buffers=new $(this._canvas.domNode.getContext("2d"),this._model.options.canvasInnerWidth,this._model.options.canvasInnerHeight,this._model.options.backgroundColor)),this._buffers?this._buffers.getBuffer():null}onDidChangeOptions(){this._lastRenderData=null,this._buffers=null,this._applyLayout(),this._domNode.setClassName(this._getMinimapDomNodeClassName())}onSelectionChanged(){return this._renderDecorations=!0,!0}onDecorationsChanged(){return this._renderDecorations=!0,!0}onFlushed(){return this._lastRenderData=null,!0}onLinesChanged(e,i){return this._lastRenderData?this._lastRenderData.onLinesChanged(e,i):!1}onLinesDeleted(e,i){return this._lastRenderData?.onLinesDeleted(e,i),!0}onLinesInserted(e,i){return this._lastRenderData?.onLinesInserted(e,i),!0}onScrollChanged(){return this._renderDecorations=!0,!0}onThemeChanged(){return this._selectionColor=this._theme.getColor(Q),this._renderDecorations=!0,!0}onTokensChanged(e){return this._lastRenderData?this._lastRenderData.onTokensChanged(e):!1}onTokensColorsChanged(){return this._lastRenderData=null,this._buffers=null,!0}onZonesChanged(){return this._lastRenderData=null,!0}render(e){if(this._model.options.renderMinimap===V.None){this._shadow.setClassName("minimap-shadow-hidden"),this._sliderHorizontal.setWidth(0),this._sliderHorizontal.setHeight(0);return}e.scrollLeft+e.viewportWidth>=e.scrollWidth?this._shadow.setClassName("minimap-shadow-hidden"):this._shadow.setClassName("minimap-shadow-visible");const t=W.create(this._model.options,e.viewportStartLineNumber,e.viewportEndLineNumber,e.viewportStartLineNumberVerticalOffset,e.viewportHeight,e.viewportContainsWhitespaceGaps,this._model.getLineCount(),this._model.getRealLineCount(),e.scrollTop,e.scrollHeight,this._lastRenderData?this._lastRenderData.renderedLayout:null);this._slider.setDisplay(t.sliderNeeded?"block":"none"),this._slider.setTop(t.sliderTop),this._slider.setHeight(t.sliderHeight),this._sliderHorizontal.setLeft(0),this._sliderHorizontal.setWidth(this._model.options.minimapWidth),this._sliderHorizontal.setTop(0),this._sliderHorizontal.setHeight(t.sliderHeight),this.renderDecorations(t),this._lastRenderData=this.renderLines(t)}renderDecorations(e){if(this._renderDecorations){this._renderDecorations=!1;const i=this._model.getSelections();i.sort(B.compareRangesUsingStarts);const t=this._model.getMinimapDecorationsInViewport(e.startLineNumber,e.endLineNumber);t.sort((p,h)=>(p.options.zIndex||0)-(h.options.zIndex||0));const{canvasInnerWidth:n,canvasInnerHeight:o}=this._model.options,r=this._model.options.minimapLineHeight,s=this._model.options.minimapCharWidth,d=this._model.getOptions().tabSize,a=this._decorationsCanvas.domNode.getContext("2d");a.clearRect(0,0,n,o);const l=new te(e.startLineNumber,e.endLineNumber,!1);this._renderSelectionLineHighlights(a,i,l,e,r),this._renderDecorationsLineHighlights(a,t,l,e,r);const m=new te(e.startLineNumber,e.endLineNumber,null);this._renderSelectionsHighlights(a,i,m,e,r,d,s,n),this._renderDecorationsHighlights(a,t,m,e,r,d,s,n),this._renderSectionHeaders(e)}}_renderSelectionLineHighlights(e,i,t,n,o){if(!this._selectionColor||this._selectionColor.isTransparent())return;e.fillStyle=this._selectionColor.transparent(.5).toString();let r=0,s=0;for(const d of i){const a=n.intersectWithViewport(d);if(!a)continue;const[l,m]=a;for(let g=l;g<=m;g++)t.set(g,!0);const p=n.getYForLineNumber(l,o),h=n.getYForLineNumber(m,o);s>=p||(s>r&&e.fillRect(I,r,e.canvas.width,s-r),r=p),s=h}s>r&&e.fillRect(I,r,e.canvas.width,s-r)}_renderDecorationsLineHighlights(e,i,t,n,o){const r=new Map;for(let s=i.length-1;s>=0;s--){const d=i[s],a=d.options.minimap;if(!a||a.position!==q.Inline)continue;const l=n.intersectWithViewport(d.range);if(!l)continue;const[m,p]=l,h=a.getColor(this._theme.value);if(!h||h.isTransparent())continue;let g=r.get(h.toString());g||(g=h.transparent(.5).toString(),r.set(h.toString(),g)),e.fillStyle=g;for(let u=m;u<=p;u++){if(t.has(u))continue;t.set(u,!0);const c=n.getYForLineNumber(m,o);e.fillRect(I,c,e.canvas.width,o)}}}_renderSelectionsHighlights(e,i,t,n,o,r,s,d){if(!(!this._selectionColor||this._selectionColor.isTransparent()))for(const a of i){const l=n.intersectWithViewport(a);if(!l)continue;const[m,p]=l;for(let h=m;h<=p;h++)this.renderDecorationOnLine(e,t,a,this._selectionColor,n,h,o,o,r,s,d)}}_renderDecorationsHighlights(e,i,t,n,o,r,s,d){for(const a of i){const l=a.options.minimap;if(!l)continue;const m=n.intersectWithViewport(a.range);if(!m)continue;const[p,h]=m,g=l.getColor(this._theme.value);if(!(!g||g.isTransparent()))for(let u=p;u<=h;u++)switch(l.position){case q.Inline:this.renderDecorationOnLine(e,t,a.range,g,n,u,o,o,r,s,d);continue;case q.Gutter:{const c=n.getYForLineNumber(u,o);this.renderDecoration(e,g,2,c,De,o);continue}}}}renderDecorationOnLine(e,i,t,n,o,r,s,d,a,l,m){const p=o.getYForLineNumber(r,d);if(p+s<0||p>this._model.options.canvasInnerHeight)return;const{startLineNumber:h,endLineNumber:g}=t,u=h===r?t.startColumn:1,c=g===r?t.endColumn:this._model.getLineMaxColumn(r),b=this.getXOffsetForPosition(i,r,u,a,l,m),_=this.getXOffsetForPosition(i,r,c,a,l,m);this.renderDecoration(e,n,b,p,_-b,s)}getXOffsetForPosition(e,i,t,n,o,r){if(t===1)return I;if((t-1)*o>=r)return r;let d=e.get(i);if(!d){const a=this._model.getLineContent(i);d=[I];let l=I;for(let m=1;m<a.length+1;m++){const p=a.charCodeAt(m-1),h=p===Y.Tab?n*o:j.isFullWidthCharacter(p)?2*o:o,g=l+h;if(g>=r){d[m]=r;break}d[m]=g,l=g}e.set(i,d)}return t-1<d.length?d[t-1]:r}renderDecoration(e,i,t,n,o,r){e.fillStyle=i&&i.toString()||"",e.fillRect(t,n,o,r)}_renderSectionHeaders(e){const i=this._model.options.minimapLineHeight,t=this._model.options.sectionHeaderFontSize,n=this._model.options.sectionHeaderLetterSpacing,o=t*1.5,{canvasInnerWidth:r}=this._model.options,s=this._model.options.backgroundColor,d=`rgb(${s.r} ${s.g} ${s.b} / .7)`,a=this._model.options.sectionHeaderFontColor,l=`rgb(${a.r} ${a.g} ${a.b})`,m=l,p=this._decorationsCanvas.domNode.getContext("2d");p.letterSpacing=n+"px",p.font="500 "+t+"px "+this._model.options.sectionHeaderFontFamily,p.strokeStyle=m,p.lineWidth=.2;const h=this._model.getSectionHeaderDecorationsInViewport(e.startLineNumber,e.endLineNumber);h.sort((u,c)=>u.range.startLineNumber-c.range.startLineNumber);const g=F._fitSectionHeader.bind(null,p,r-I);for(const u of h){const c=e.getYForLineNumber(u.range.startLineNumber,i)+t,b=c-t,_=b+2,L=this._model.getSectionHeaderText(u,g);F._renderSectionLabel(p,L,u.options.minimap?.sectionHeaderStyle===fe.Underlined,d,l,r,b,o,c,_)}}static _fitSectionHeader(e,i,t){if(!t)return t;const n="\u2026",o=e.measureText(t).width,r=e.measureText(n).width;if(o<=i||o<=r)return t;const s=t.length,d=o/t.length,a=Math.floor((i-r)/d)-1;let l=Math.ceil(a/2);for(;l>0&&/\s/.test(t[l-1]);)--l;return t.substring(0,l)+n+t.substring(s-(a-l))}static _renderSectionLabel(e,i,t,n,o,r,s,d,a,l){i&&(e.fillStyle=n,e.fillRect(0,s,r,d),e.fillStyle=o,e.fillText(i,I,a)),t&&(e.beginPath(),e.moveTo(0,l),e.lineTo(r,l),e.closePath(),e.stroke())}renderLines(e){const i=e.startLineNumber,t=e.endLineNumber,n=this._model.options.minimapLineHeight;if(this._lastRenderData&&this._lastRenderData.linesEquals(e)){const H=this._lastRenderData._get();return new ee(e,H.imageData,H.lines)}const o=this._getBuffer();if(!o)return null;const[r,s,d]=F._renderUntouchedLines(o,e.topPaddingLineCount,i,t,n,this._lastRenderData),a=this._model.getMinimapLinesRenderingData(i,t,d),l=this._model.getOptions().tabSize,m=this._model.options.defaultBackgroundColor,p=this._model.options.backgroundColor,h=this._model.options.foregroundAlpha,g=this._model.tokensColorTracker,u=g.backgroundIsLight(),c=this._model.options.renderMinimap,b=this._model.options.charRenderer(),_=this._model.options.fontScale,L=this._model.options.minimapCharWidth,N=(c===V.Text?U.BASE_CHAR_HEIGHT:U.BASE_CHAR_HEIGHT+1)*_,v=n>N?Math.floor((n-N)/2):0,C=p.a/255,M=new z(Math.round((p.r-m.r)*C+m.r),Math.round((p.g-m.g)*C+m.g),Math.round((p.b-m.b)*C+m.b),255);let S=e.topPaddingLineCount*n;const w=[];for(let H=0,A=t-i+1;H<A;H++)d[H]&&F._renderLine(o,M,p.a,u,c,L,g,h,b,S,v,l,a[H],_,n),w[H]=new G(S),S+=n;const D=r===-1?0:r,T=(s===-1?o.height:s)-D;return this._canvas.domNode.getContext("2d").putImageData(o,0,0,0,D,o.width,T),new ee(e,o,w)}static _renderUntouchedLines(e,i,t,n,o,r){const s=[];if(!r){for(let S=0,w=n-t+1;S<w;S++)s[S]=!0;return[-1,-1,s]}const d=r._get(),a=d.imageData.data,l=d.rendLineNumberStart,m=d.lines,p=m.length,h=e.width,g=e.data,u=(n-t+1)*o*h*4;let c=-1,b=-1,_=-1,L=-1,f=-1,N=-1,v=i*o;for(let S=t;S<=n;S++){const w=S-t,D=S-l,y=D>=0&&D<p?m[D].dy:-1;if(y===-1){s[w]=!0,v+=o;continue}const T=y*h*4,x=(y+o)*h*4,H=v*h*4,A=(v+o)*h*4;L===T&&N===H?(L=x,N=A):(_!==-1&&(g.set(a.subarray(_,L),f),c===-1&&_===0&&_===f&&(c=L),b===-1&&L===u&&_===f&&(b=_)),_=T,L=x,f=H,N=A),s[w]=!1,v+=o}_!==-1&&(g.set(a.subarray(_,L),f),c===-1&&_===0&&_===f&&(c=L),b===-1&&L===u&&_===f&&(b=_));const C=c===-1?-1:c/(h*4),M=b===-1?-1:b/(h*4);return[C,M,s]}static _renderLine(e,i,t,n,o,r,s,d,a,l,m,p,h,g,u){const c=h.content,b=h.tokens,_=e.width-r,L=u===1;let f=I,N=0,v=0;for(let C=0,M=b.getCount();C<M;C++){const S=b.getEndOffset(C),w=b.getForeground(C),D=s.getColor(w);for(;N<S;N++){if(f>_)return;const y=c.charCodeAt(N);if(y===Y.Tab){const T=p-(N+v)%p;v+=T-1,f+=T*r}else if(y===Y.Space)f+=r;else{const T=j.isFullWidthCharacter(y)?2:1;for(let x=0;x<T;x++)if(o===V.Blocks?a.blockRenderChar(e,f,l+m,D,d,i,t,L):a.renderChar(e,f,l+m,y,D,d,i,t,g,n,L),f+=r,f>_)return}}}}}class te{_startLineNumber;_endLineNumber;_defaultValue;_values;constructor(e,i,t){this._startLineNumber=e,this._endLineNumber=i,this._defaultValue=t,this._values=[];for(let n=0,o=this._endLineNumber-this._startLineNumber+1;n<o;n++)this._values[n]=t}has(e){return this.get(e)!==this._defaultValue}set(e,i){e<this._startLineNumber||e>this._endLineNumber||(this._values[e-this._startLineNumber]=i)}get(e){return e<this._startLineNumber||e>this._endLineNumber?this._defaultValue:this._values[e-this._startLineNumber]}}export{gt as Minimap};
