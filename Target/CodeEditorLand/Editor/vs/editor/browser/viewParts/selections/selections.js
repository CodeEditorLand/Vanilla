import"./selections.css";import{DynamicViewOverlay as I}from"../../view/dynamicViewOverlay.js";import"../../../common/core/range.js";import"../../view/renderingContext.js";import"../../../common/viewModel/viewContext.js";import"../../../common/viewEvents.js";import{editorSelectionForeground as v}from"../../../../platform/theme/common/colorRegistry.js";import{registerThemingParticipant as w}from"../../../../platform/theme/common/themeService.js";import{EditorOption as T}from"../../../common/config/editorOptions.js";var W=(n=>(n[n.EXTERN=0]="EXTERN",n[n.INTERN=1]="INTERN",n[n.FLAT=2]="FLAT",n))(W||{});class O{left;width;startStyle;endStyle;constructor(t){this.left=t.left,this.width=t.width,this.startStyle=null,this.endStyle=null}}class H{lineNumber;ranges;constructor(t,e){this.lineNumber=t,this.ranges=e}}function D(c){return new O(c)}function V(c){return new H(c.lineNumber,c.ranges.map(D))}class s extends I{static SELECTION_CLASS_NAME="selected-text";static SELECTION_TOP_LEFT="top-left-radius";static SELECTION_BOTTOM_LEFT="bottom-left-radius";static SELECTION_TOP_RIGHT="top-right-radius";static SELECTION_BOTTOM_RIGHT="bottom-right-radius";static EDITOR_BACKGROUND_CLASS_NAME="monaco-editor-background";static ROUNDED_PIECE_WIDTH=10;_context;_roundedSelection;_typicalHalfwidthCharacterWidth;_selections;_renderResult;constructor(t){super(),this._context=t;const e=this._context.configuration.options;this._roundedSelection=e.get(T.roundedSelection),this._typicalHalfwidthCharacterWidth=e.get(T.fontInfo).typicalHalfwidthCharacterWidth,this._selections=[],this._renderResult=null,this._context.addEventHandler(this)}dispose(){this._context.removeEventHandler(this),this._renderResult=null,super.dispose()}onConfigurationChanged(t){const e=this._context.configuration.options;return this._roundedSelection=e.get(T.roundedSelection),this._typicalHalfwidthCharacterWidth=e.get(T.fontInfo).typicalHalfwidthCharacterWidth,!0}onCursorStateChanged(t){return this._selections=t.selections.slice(0),!0}onDecorationsChanged(t){return!0}onFlushed(t){return!0}onLinesChanged(t){return!0}onLinesDeleted(t){return!0}onLinesInserted(t){return!0}onScrollChanged(t){return t.scrollTopChanged}onZonesChanged(t){return!0}_visibleRangesHaveGaps(t){for(let e=0,n=t.length;e<n;e++)if(t[e].ranges.length>1)return!0;return!1}_enrichVisibleRangesWithStyle(t,e,n){const a=this._typicalHalfwidthCharacterWidth/4;let o=null,i=null;if(n&&n.length>0&&e.length>0){const r=e[0].lineNumber;if(r===t.startLineNumber)for(let l=0;!o&&l<n.length;l++)n[l].lineNumber===r&&(o=n[l].ranges[0]);const d=e[e.length-1].lineNumber;if(d===t.endLineNumber)for(let l=n.length-1;!i&&l>=0;l--)n[l].lineNumber===d&&(i=n[l].ranges[0]);o&&!o.startStyle&&(o=null),i&&!i.startStyle&&(i=null)}for(let r=0,d=e.length;r<d;r++){const l=e[r].ranges[0],p=l.left,b=l.left+l.width,S={top:0,bottom:0},u={top:0,bottom:0};if(r>0){const h=e[r-1].ranges[0].left,E=e[r-1].ranges[0].left+e[r-1].ranges[0].width;C(p-h)<a?S.top=2:p>h&&(S.top=1),C(b-E)<a?u.top=2:h<b&&b<E&&(u.top=1)}else o&&(S.top=o.startStyle.top,u.top=o.endStyle.top);if(r+1<d){const h=e[r+1].ranges[0].left,E=e[r+1].ranges[0].left+e[r+1].ranges[0].width;C(p-h)<a?S.bottom=2:h<p&&p<E&&(S.bottom=1),C(b-E)<a?u.bottom=2:b<E&&(u.bottom=1)}else i&&(S.bottom=i.startStyle.bottom,u.bottom=i.endStyle.bottom);l.startStyle=S,l.endStyle=u}}_getVisibleRangesWithStyle(t,e,n){const o=(e.linesVisibleRangesForRange(t,!0)||[]).map(V);return!this._visibleRangesHaveGaps(o)&&this._roundedSelection&&this._enrichVisibleRangesWithStyle(e.visibleRange,o,n),o}_createSelectionPiece(t,e,n,a,o){return'<div class="cslr '+n+'" style="top:'+t.toString()+"px;bottom:"+e.toString()+"px;left:"+a.toString()+"px;width:"+o.toString()+'px;"></div>'}_actualRenderOneSelection(t,e,n,a){if(a.length===0)return;const o=!!a[0].ranges[0].startStyle,i=a[0].lineNumber,r=a[a.length-1].lineNumber;for(let d=0,l=a.length;d<l;d++){const p=a[d],b=p.lineNumber,S=b-e,u=n&&b===i?1:0,h=n&&b!==i&&b===r?1:0;let E="",y="";for(let _=0,L=p.ranges.length;_<L;_++){const g=p.ranges[_];if(o){const R=g.startStyle,f=g.endStyle;if(R.top===1||R.bottom===1){E+=this._createSelectionPiece(u,h,s.SELECTION_CLASS_NAME,g.left-s.ROUNDED_PIECE_WIDTH,s.ROUNDED_PIECE_WIDTH);let N=s.EDITOR_BACKGROUND_CLASS_NAME;R.top===1&&(N+=" "+s.SELECTION_TOP_RIGHT),R.bottom===1&&(N+=" "+s.SELECTION_BOTTOM_RIGHT),E+=this._createSelectionPiece(u,h,N,g.left-s.ROUNDED_PIECE_WIDTH,s.ROUNDED_PIECE_WIDTH)}if(f.top===1||f.bottom===1){E+=this._createSelectionPiece(u,h,s.SELECTION_CLASS_NAME,g.left+g.width,s.ROUNDED_PIECE_WIDTH);let N=s.EDITOR_BACKGROUND_CLASS_NAME;f.top===1&&(N+=" "+s.SELECTION_TOP_LEFT),f.bottom===1&&(N+=" "+s.SELECTION_BOTTOM_LEFT),E+=this._createSelectionPiece(u,h,N,g.left+g.width,s.ROUNDED_PIECE_WIDTH)}}let m=s.SELECTION_CLASS_NAME;if(o){const R=g.startStyle,f=g.endStyle;R.top===0&&(m+=" "+s.SELECTION_TOP_LEFT),R.bottom===0&&(m+=" "+s.SELECTION_BOTTOM_LEFT),f.top===0&&(m+=" "+s.SELECTION_TOP_RIGHT),f.bottom===0&&(m+=" "+s.SELECTION_BOTTOM_RIGHT)}y+=this._createSelectionPiece(u,h,m,g.left,g.width)}t[S][0]+=E,t[S][1]+=y}}_previousFrameVisibleRangesWithStyle=[];prepareRender(t){const e=[],n=t.visibleRange.startLineNumber,a=t.visibleRange.endLineNumber;for(let i=n;i<=a;i++){const r=i-n;e[r]=["",""]}const o=[];for(let i=0,r=this._selections.length;i<r;i++){const d=this._selections[i];if(d.isEmpty()){o[i]=null;continue}const l=this._getVisibleRangesWithStyle(d,t,this._previousFrameVisibleRangesWithStyle[i]);o[i]=l,this._actualRenderOneSelection(e,n,this._selections.length>1,l)}this._previousFrameVisibleRangesWithStyle=o,this._renderResult=e.map(([i,r])=>i+r)}render(t,e){if(!this._renderResult)return"";const n=e-t;return n<0||n>=this._renderResult.length?"":this._renderResult[n]}}w((c,t)=>{const e=c.getColor(v);e&&!e.isTransparent()&&t.addRule(`.monaco-editor .view-line span.inline-selected-text { color: ${e}; }`)});function C(c){return c<0?-c:c}export{s as SelectionsOverlay};
