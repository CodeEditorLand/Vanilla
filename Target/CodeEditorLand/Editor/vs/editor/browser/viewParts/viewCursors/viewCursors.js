import"./viewCursors.css";import{createFastDomNode as p}from"../../../../base/browser/fastDomNode.js";import{TimeoutTimer as C}from"../../../../base/common/async.js";import{ViewPart as g}from"../../view/viewPart.js";import{ViewCursor as m,CursorPlurality as u}from"./viewCursor.js";import{TextEditorCursorBlinkingStyle as s,TextEditorCursorStyle as l,EditorOption as n}from"../../../common/config/editorOptions.js";import"../../../common/core/position.js";import{editorCursorBackground as _,editorCursorForeground as v,editorMultiCursorPrimaryForeground as b,editorMultiCursorPrimaryBackground as y,editorMultiCursorSecondaryForeground as f,editorMultiCursorSecondaryBackground as E}from"../../../common/core/editorColorRegistry.js";import"../../view/renderingContext.js";import"../../../common/viewModel/viewContext.js";import"../../../common/viewEvents.js";import{registerThemingParticipant as k}from"../../../../platform/theme/common/themeService.js";import{isHighContrast as w}from"../../../../platform/theme/common/theme.js";import{CursorChangeReason as N}from"../../../common/cursorEvents.js";import{WindowIntervalTimer as B,getWindow as S}from"../../../../base/browser/dom.js";class c extends g{static BLINK_INTERVAL=500;_readOnly;_cursorBlinking;_cursorStyle;_cursorSmoothCaretAnimation;_experimentalEditContextEnabled;_selectionIsEmpty;_isComposingInput;_isVisible;_domNode;_startCursorBlinkAnimation;_cursorFlatBlinkInterval;_blinkingEnabled;_editorHasFocus;_primaryCursor;_secondaryCursors;_renderData;constructor(e){super(e);const r=this._context.configuration.options;this._readOnly=r.get(n.readOnly),this._cursorBlinking=r.get(n.cursorBlinking),this._cursorStyle=r.get(n.cursorStyle),this._cursorSmoothCaretAnimation=r.get(n.cursorSmoothCaretAnimation),this._experimentalEditContextEnabled=r.get(n.experimentalEditContextEnabled),this._selectionIsEmpty=!0,this._isComposingInput=!1,this._isVisible=!1,this._primaryCursor=new m(this._context,u.Single),this._secondaryCursors=[],this._renderData=[],this._domNode=p(document.createElement("div")),this._domNode.setAttribute("role","presentation"),this._domNode.setAttribute("aria-hidden","true"),this._updateDomClassName(),this._domNode.appendChild(this._primaryCursor.getDomNode()),this._startCursorBlinkAnimation=new C,this._cursorFlatBlinkInterval=new B,this._blinkingEnabled=!1,this._editorHasFocus=!1,this._updateBlinking()}dispose(){super.dispose(),this._startCursorBlinkAnimation.dispose(),this._cursorFlatBlinkInterval.dispose()}getDomNode(){return this._domNode}onCompositionStart(e){return this._isComposingInput=!0,this._updateBlinking(),!0}onCompositionEnd(e){return this._isComposingInput=!1,this._updateBlinking(),!0}onConfigurationChanged(e){const r=this._context.configuration.options;this._readOnly=r.get(n.readOnly),this._cursorBlinking=r.get(n.cursorBlinking),this._cursorStyle=r.get(n.cursorStyle),this._cursorSmoothCaretAnimation=r.get(n.cursorSmoothCaretAnimation),this._experimentalEditContextEnabled=r.get(n.experimentalEditContextEnabled),this._updateBlinking(),this._updateDomClassName(),this._primaryCursor.onConfigurationChanged(e);for(let t=0,o=this._secondaryCursors.length;t<o;t++)this._secondaryCursors[t].onConfigurationChanged(e);return!0}_onCursorPositionChanged(e,r,t){const o=this._secondaryCursors.length!==r.length||this._cursorSmoothCaretAnimation==="explicit"&&t!==N.Explicit;if(this._primaryCursor.setPlurality(r.length?u.MultiPrimary:u.Single),this._primaryCursor.onCursorPositionChanged(e,o),this._updateBlinking(),this._secondaryCursors.length<r.length){const i=r.length-this._secondaryCursors.length;for(let a=0;a<i;a++){const d=new m(this._context,u.MultiSecondary);this._domNode.domNode.insertBefore(d.getDomNode().domNode,this._primaryCursor.getDomNode().domNode.nextSibling),this._secondaryCursors.push(d)}}else if(this._secondaryCursors.length>r.length){const i=this._secondaryCursors.length-r.length;for(let a=0;a<i;a++)this._domNode.removeChild(this._secondaryCursors[0].getDomNode()),this._secondaryCursors.splice(0,1)}for(let i=0;i<r.length;i++)this._secondaryCursors[i].onCursorPositionChanged(r[i],o)}onCursorStateChanged(e){const r=[];for(let o=0,i=e.selections.length;o<i;o++)r[o]=e.selections[o].getPosition();this._onCursorPositionChanged(r[0],r.slice(1),e.reason);const t=e.selections[0].isEmpty();return this._selectionIsEmpty!==t&&(this._selectionIsEmpty=t,this._updateDomClassName()),!0}onDecorationsChanged(e){return!0}onFlushed(e){return!0}onFocusChanged(e){return this._editorHasFocus=e.isFocused,this._updateBlinking(),!1}onLinesChanged(e){return!0}onLinesDeleted(e){return!0}onLinesInserted(e){return!0}onScrollChanged(e){return!0}onTokensChanged(e){const r=t=>{for(let o=0,i=e.ranges.length;o<i;o++)if(e.ranges[o].fromLineNumber<=t.lineNumber&&t.lineNumber<=e.ranges[o].toLineNumber)return!0;return!1};if(r(this._primaryCursor.getPosition()))return!0;for(const t of this._secondaryCursors)if(r(t.getPosition()))return!0;return!1}onZonesChanged(e){return!0}_getCursorBlinking(){return this._isComposingInput&&!this._experimentalEditContextEnabled?s.Hidden:this._editorHasFocus?this._readOnly?s.Solid:this._cursorBlinking:s.Hidden}_updateBlinking(){this._startCursorBlinkAnimation.cancel(),this._cursorFlatBlinkInterval.cancel();const e=this._getCursorBlinking(),r=e===s.Hidden,t=e===s.Solid;r?this._hide():this._show(),this._blinkingEnabled=!1,this._updateDomClassName(),!r&&!t&&(e===s.Blink?this._cursorFlatBlinkInterval.cancelAndSet(()=>{this._isVisible?this._hide():this._show()},c.BLINK_INTERVAL,S(this._domNode.domNode)):this._startCursorBlinkAnimation.setIfNotSet(()=>{this._blinkingEnabled=!0,this._updateDomClassName()},c.BLINK_INTERVAL))}_updateDomClassName(){this._domNode.setClassName(this._getClassName())}_getClassName(){let e="cursors-layer";switch(this._selectionIsEmpty||(e+=" has-selection"),this._cursorStyle){case l.Line:e+=" cursor-line-style";break;case l.Block:e+=" cursor-block-style";break;case l.Underline:e+=" cursor-underline-style";break;case l.LineThin:e+=" cursor-line-thin-style";break;case l.BlockOutline:e+=" cursor-block-outline-style";break;case l.UnderlineThin:e+=" cursor-underline-thin-style";break;default:e+=" cursor-line-style"}if(this._blinkingEnabled)switch(this._getCursorBlinking()){case s.Blink:e+=" cursor-blink";break;case s.Smooth:e+=" cursor-smooth";break;case s.Phase:e+=" cursor-phase";break;case s.Expand:e+=" cursor-expand";break;case s.Solid:e+=" cursor-solid";break;default:e+=" cursor-solid"}else e+=" cursor-solid";return(this._cursorSmoothCaretAnimation==="on"||this._cursorSmoothCaretAnimation==="explicit")&&(e+=" cursor-smooth-caret-animation"),e}_show(){this._primaryCursor.show();for(let e=0,r=this._secondaryCursors.length;e<r;e++)this._secondaryCursors[e].show();this._isVisible=!0}_hide(){this._primaryCursor.hide();for(let e=0,r=this._secondaryCursors.length;e<r;e++)this._secondaryCursors[e].hide();this._isVisible=!1}prepareRender(e){this._primaryCursor.prepareRender(e);for(let r=0,t=this._secondaryCursors.length;r<t;r++)this._secondaryCursors[r].prepareRender(e)}render(e){const r=[];let t=0;const o=this._primaryCursor.render(e);o&&(r[t++]=o);for(let i=0,a=this._secondaryCursors.length;i<a;i++){const d=this._secondaryCursors[i].render(e);d&&(r[t++]=d)}this._renderData=r}getLastRenderData(){return this._renderData}}k((h,e)=>{const r=[{class:".cursor",foreground:v,background:_},{class:".cursor-primary",foreground:b,background:y},{class:".cursor-secondary",foreground:f,background:E}];for(const t of r){const o=h.getColor(t.foreground);if(o){let i=h.getColor(t.background);i||(i=o.opposite()),e.addRule(`.monaco-editor .cursors-layer ${t.class} { background-color: ${o}; border-color: ${o}; color: ${i}; }`),w(h.type)&&e.addRule(`.monaco-editor .cursors-layer.has-selection ${t.class} { border-left: 1px solid ${i}; border-right: 1px solid ${i}; }`)}}});export{c as ViewCursors};
