import"./viewCursors.css";import{getWindow as p,WindowIntervalTimer as g}from"../../../../base/browser/dom.js";import{createFastDomNode as C}from"../../../../base/browser/fastDomNode.js";import{TimeoutTimer as _}from"../../../../base/common/async.js";import{isHighContrast as v}from"../../../../platform/theme/common/theme.js";import{registerThemingParticipant as b}from"../../../../platform/theme/common/themeService.js";import{EditorOption as n,TextEditorCursorBlinkingStyle as s,TextEditorCursorStyle as l}from"../../../common/config/editorOptions.js";import{editorCursorBackground as y,editorCursorForeground as f,editorMultiCursorPrimaryBackground as k,editorMultiCursorPrimaryForeground as E,editorMultiCursorSecondaryBackground as w,editorMultiCursorSecondaryForeground as N}from"../../../common/core/editorColorRegistry.js";import"../../../common/core/position.js";import{CursorChangeReason as B}from"../../../common/cursorEvents.js";import"../../../common/viewEvents.js";import"../../../common/viewModel/viewContext.js";import"../../view/renderingContext.js";import{ViewPart as S}from"../../view/viewPart.js";import{CursorPlurality as d,ViewCursor as m}from"./viewCursor.js";class c extends S{static BLINK_INTERVAL=500;_readOnly;_cursorBlinking;_cursorStyle;_cursorSmoothCaretAnimation;_selectionIsEmpty;_isComposingInput;_isVisible;_domNode;_startCursorBlinkAnimation;_cursorFlatBlinkInterval;_blinkingEnabled;_editorHasFocus;_primaryCursor;_secondaryCursors;_renderData;constructor(e){super(e);const r=this._context.configuration.options;this._readOnly=r.get(n.readOnly),this._cursorBlinking=r.get(n.cursorBlinking),this._cursorStyle=r.get(n.cursorStyle),this._cursorSmoothCaretAnimation=r.get(n.cursorSmoothCaretAnimation),this._selectionIsEmpty=!0,this._isComposingInput=!1,this._isVisible=!1,this._primaryCursor=new m(this._context,d.Single),this._secondaryCursors=[],this._renderData=[],this._domNode=C(document.createElement("div")),this._domNode.setAttribute("role","presentation"),this._domNode.setAttribute("aria-hidden","true"),this._updateDomClassName(),this._domNode.appendChild(this._primaryCursor.getDomNode()),this._startCursorBlinkAnimation=new _,this._cursorFlatBlinkInterval=new g,this._blinkingEnabled=!1,this._editorHasFocus=!1,this._updateBlinking()}dispose(){super.dispose(),this._startCursorBlinkAnimation.dispose(),this._cursorFlatBlinkInterval.dispose()}getDomNode(){return this._domNode}onCompositionStart(e){return this._isComposingInput=!0,this._updateBlinking(),!0}onCompositionEnd(e){return this._isComposingInput=!1,this._updateBlinking(),!0}onConfigurationChanged(e){const r=this._context.configuration.options;this._readOnly=r.get(n.readOnly),this._cursorBlinking=r.get(n.cursorBlinking),this._cursorStyle=r.get(n.cursorStyle),this._cursorSmoothCaretAnimation=r.get(n.cursorSmoothCaretAnimation),this._updateBlinking(),this._updateDomClassName(),this._primaryCursor.onConfigurationChanged(e);for(let o=0,t=this._secondaryCursors.length;o<t;o++)this._secondaryCursors[o].onConfigurationChanged(e);return!0}_onCursorPositionChanged(e,r,o){const t=this._secondaryCursors.length!==r.length||this._cursorSmoothCaretAnimation==="explicit"&&o!==B.Explicit;if(this._primaryCursor.setPlurality(r.length?d.MultiPrimary:d.Single),this._primaryCursor.onCursorPositionChanged(e,t),this._updateBlinking(),this._secondaryCursors.length<r.length){const i=r.length-this._secondaryCursors.length;for(let a=0;a<i;a++){const u=new m(this._context,d.MultiSecondary);this._domNode.domNode.insertBefore(u.getDomNode().domNode,this._primaryCursor.getDomNode().domNode.nextSibling),this._secondaryCursors.push(u)}}else if(this._secondaryCursors.length>r.length){const i=this._secondaryCursors.length-r.length;for(let a=0;a<i;a++)this._domNode.removeChild(this._secondaryCursors[0].getDomNode()),this._secondaryCursors.splice(0,1)}for(let i=0;i<r.length;i++)this._secondaryCursors[i].onCursorPositionChanged(r[i],t)}onCursorStateChanged(e){const r=[];for(let t=0,i=e.selections.length;t<i;t++)r[t]=e.selections[t].getPosition();this._onCursorPositionChanged(r[0],r.slice(1),e.reason);const o=e.selections[0].isEmpty();return this._selectionIsEmpty!==o&&(this._selectionIsEmpty=o,this._updateDomClassName()),!0}onDecorationsChanged(e){return!0}onFlushed(e){return!0}onFocusChanged(e){return this._editorHasFocus=e.isFocused,this._updateBlinking(),!1}onLinesChanged(e){return!0}onLinesDeleted(e){return!0}onLinesInserted(e){return!0}onScrollChanged(e){return!0}onTokensChanged(e){const r=o=>{for(let t=0,i=e.ranges.length;t<i;t++)if(e.ranges[t].fromLineNumber<=o.lineNumber&&o.lineNumber<=e.ranges[t].toLineNumber)return!0;return!1};if(r(this._primaryCursor.getPosition()))return!0;for(const o of this._secondaryCursors)if(r(o.getPosition()))return!0;return!1}onZonesChanged(e){return!0}_getCursorBlinking(){return this._isComposingInput?s.Hidden:this._editorHasFocus?this._readOnly?s.Solid:this._cursorBlinking:s.Hidden}_updateBlinking(){this._startCursorBlinkAnimation.cancel(),this._cursorFlatBlinkInterval.cancel();const e=this._getCursorBlinking(),r=e===s.Hidden,o=e===s.Solid;r?this._hide():this._show(),this._blinkingEnabled=!1,this._updateDomClassName(),!r&&!o&&(e===s.Blink?this._cursorFlatBlinkInterval.cancelAndSet(()=>{this._isVisible?this._hide():this._show()},c.BLINK_INTERVAL,p(this._domNode.domNode)):this._startCursorBlinkAnimation.setIfNotSet(()=>{this._blinkingEnabled=!0,this._updateDomClassName()},c.BLINK_INTERVAL))}_updateDomClassName(){this._domNode.setClassName(this._getClassName())}_getClassName(){let e="cursors-layer";switch(this._selectionIsEmpty||(e+=" has-selection"),this._cursorStyle){case l.Line:e+=" cursor-line-style";break;case l.Block:e+=" cursor-block-style";break;case l.Underline:e+=" cursor-underline-style";break;case l.LineThin:e+=" cursor-line-thin-style";break;case l.BlockOutline:e+=" cursor-block-outline-style";break;case l.UnderlineThin:e+=" cursor-underline-thin-style";break;default:e+=" cursor-line-style"}if(this._blinkingEnabled)switch(this._getCursorBlinking()){case s.Blink:e+=" cursor-blink";break;case s.Smooth:e+=" cursor-smooth";break;case s.Phase:e+=" cursor-phase";break;case s.Expand:e+=" cursor-expand";break;case s.Solid:e+=" cursor-solid";break;default:e+=" cursor-solid"}else e+=" cursor-solid";return(this._cursorSmoothCaretAnimation==="on"||this._cursorSmoothCaretAnimation==="explicit")&&(e+=" cursor-smooth-caret-animation"),e}_show(){this._primaryCursor.show();for(let e=0,r=this._secondaryCursors.length;e<r;e++)this._secondaryCursors[e].show();this._isVisible=!0}_hide(){this._primaryCursor.hide();for(let e=0,r=this._secondaryCursors.length;e<r;e++)this._secondaryCursors[e].hide();this._isVisible=!1}prepareRender(e){this._primaryCursor.prepareRender(e);for(let r=0,o=this._secondaryCursors.length;r<o;r++)this._secondaryCursors[r].prepareRender(e)}render(e){const r=[];let o=0;const t=this._primaryCursor.render(e);t&&(r[o++]=t);for(let i=0,a=this._secondaryCursors.length;i<a;i++){const u=this._secondaryCursors[i].render(e);u&&(r[o++]=u)}this._renderData=r}getLastRenderData(){return this._renderData}}b((h,e)=>{const r=[{class:".cursor",foreground:f,background:y},{class:".cursor-primary",foreground:E,background:k},{class:".cursor-secondary",foreground:N,background:w}];for(const o of r){const t=h.getColor(o.foreground);if(t){let i=h.getColor(o.background);i||(i=t.opposite()),e.addRule(`.monaco-editor .cursors-layer ${o.class} { background-color: ${t}; border-color: ${t}; color: ${i}; }`),v(h.type)&&e.addRule(`.monaco-editor .cursors-layer.has-selection ${o.class} { border-left: 1px solid ${i}; border-right: 1px solid ${i}; }`)}}});export{c as ViewCursors};
