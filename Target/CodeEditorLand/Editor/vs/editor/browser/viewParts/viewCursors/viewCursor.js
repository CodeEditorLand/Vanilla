import*as c from"../../../../base/browser/dom.js";import{createFastDomNode as R}from"../../../../base/browser/fastDomNode.js";import{MOUSE_CURSOR_TEXT_CSS_CLASS_NAME as C}from"../../../../base/browser/ui/mouseCursor/mouseCursor.js";import*as x from"../../../../base/common/strings.js";import{EditorOption as o,TextEditorCursorStyle as s}from"../../../common/config/editorOptions.js";import{Position as b}from"../../../common/core/position.js";import{Range as S}from"../../../common/core/range.js";import{applyFontInfo as y}from"../../config/domFontInfo.js";class N{constructor(t,i,e,n,r,d,l){this.top=t;this.left=i;this.paddingLeft=e;this.width=n;this.height=r;this.textContent=d;this.textContentClassName=l}}var H=(e=>(e[e.Single=0]="Single",e[e.MultiPrimary=1]="MultiPrimary",e[e.MultiSecondary=2]="MultiSecondary",e))(H||{});class M{_context;_domNode;_cursorStyle;_lineCursorWidth;_lineHeight;_typicalHalfwidthCharacterWidth;_isVisible;_position;_pluralityClass;_lastRenderedContent;_renderData;constructor(t,i){this._context=t;const e=this._context.configuration.options,n=e.get(o.fontInfo);this._cursorStyle=e.get(o.cursorStyle),this._lineHeight=e.get(o.lineHeight),this._typicalHalfwidthCharacterWidth=n.typicalHalfwidthCharacterWidth,this._lineCursorWidth=Math.min(e.get(o.cursorWidth),this._typicalHalfwidthCharacterWidth),this._isVisible=!0,this._domNode=R(document.createElement("div")),this._domNode.setClassName(`cursor ${C}`),this._domNode.setHeight(this._lineHeight),this._domNode.setTop(0),this._domNode.setLeft(0),y(this._domNode,n),this._domNode.setDisplay("none"),this._position=new b(1,1),this._pluralityClass="",this.setPlurality(i),this._lastRenderedContent="",this._renderData=null}getDomNode(){return this._domNode}getPosition(){return this._position}setPlurality(t){switch(t){default:case 0:this._pluralityClass="";break;case 1:this._pluralityClass="cursor-primary";break;case 2:this._pluralityClass="cursor-secondary";break}}show(){this._isVisible||(this._domNode.setVisibility("inherit"),this._isVisible=!0)}hide(){this._isVisible&&(this._domNode.setVisibility("hidden"),this._isVisible=!1)}onConfigurationChanged(t){const i=this._context.configuration.options,e=i.get(o.fontInfo);return this._cursorStyle=i.get(o.cursorStyle),this._lineHeight=i.get(o.lineHeight),this._typicalHalfwidthCharacterWidth=e.typicalHalfwidthCharacterWidth,this._lineCursorWidth=Math.min(i.get(o.cursorWidth),this._typicalHalfwidthCharacterWidth),y(this._domNode,e),!0}onCursorPositionChanged(t,i){return i?this._domNode.domNode.style.transitionProperty="none":this._domNode.domNode.style.transitionProperty="",this._position=t,!0}_getGraphemeAwarePosition(){const{lineNumber:t,column:i}=this._position,e=this._context.viewModel.getLineContent(t),[n,r]=x.getCharContainingOffset(e,i-1);return[new b(t,n+1),e.substring(n,r)]}_prepareRender(t){let i="",e="";const[n,r]=this._getGraphemeAwarePosition();if(this._cursorStyle===s.Line||this._cursorStyle===s.LineThin){const u=t.visibleRangeForPosition(n);if(!u||u.outsideRenderedLine)return null;const f=c.getWindow(this._domNode.domNode);let a;this._cursorStyle===s.Line?(a=c.computeScreenAwareSize(f,this._lineCursorWidth>0?this._lineCursorWidth:2),a>2&&(i=r,e=this._getTokenClassName(n))):a=c.computeScreenAwareSize(f,1);let m=u.left,_=0;a>=2&&m>=1&&(_=1,m-=_);const D=t.getVerticalOffsetForLineNumber(n.lineNumber)-t.bigNumbersDelta;return new N(D,m,_,a,this._lineHeight,i,e)}const d=t.linesVisibleRangesForRange(new S(n.lineNumber,n.column,n.lineNumber,n.column+r.length),!1);if(!d||d.length===0)return null;const l=d[0];if(l.outsideRenderedLine||l.ranges.length===0)return null;const h=l.ranges[0],v=r==="	"?this._typicalHalfwidthCharacterWidth:h.width<1?this._typicalHalfwidthCharacterWidth:h.width;this._cursorStyle===s.Block&&(i=r,e=this._getTokenClassName(n));let p=t.getVerticalOffsetForLineNumber(n.lineNumber)-t.bigNumbersDelta,g=this._lineHeight;return(this._cursorStyle===s.Underline||this._cursorStyle===s.UnderlineThin)&&(p+=this._lineHeight-2,g=2),new N(p,h.left,0,v,g,i,e)}_getTokenClassName(t){const i=this._context.viewModel.getViewLineData(t.lineNumber),e=i.tokens.findTokenIndexAtOffset(t.column-1);return i.tokens.getClassName(e)}prepareRender(t){this._renderData=this._prepareRender(t)}render(t){return this._renderData?(this._lastRenderedContent!==this._renderData.textContent&&(this._lastRenderedContent=this._renderData.textContent,this._domNode.domNode.textContent=this._lastRenderedContent),this._domNode.setClassName(`cursor ${this._pluralityClass} ${C} ${this._renderData.textContentClassName}`),this._domNode.setDisplay("block"),this._domNode.setTop(this._renderData.top),this._domNode.setLeft(this._renderData.left),this._domNode.setPaddingLeft(this._renderData.paddingLeft),this._domNode.setWidth(this._renderData.width),this._domNode.setLineHeight(this._renderData.height),this._domNode.setHeight(this._renderData.height),{domNode:this._domNode.domNode,position:this._position,contentLeft:this._renderData.left,height:this._renderData.height,width:2}):(this._domNode.setDisplay("none"),null)}}export{H as CursorPlurality,M as ViewCursor};
