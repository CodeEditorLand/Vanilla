import{createFastDomNode as I}from"../../../../base/browser/fastDomNode.js";import{equals as M}from"../../../../base/common/arrays.js";import{Color as x}from"../../../../base/common/color.js";import{EditorOption as y}from"../../../common/config/editorOptions.js";import{editorCursorForeground as L,editorMultiCursorPrimaryForeground as F,editorMultiCursorSecondaryForeground as V,editorOverviewRulerBackground as O,editorOverviewRulerBorder as B}from"../../../common/core/editorColorRegistry.js";import{Position as P}from"../../../common/core/position.js";import{TokenizationRegistry as D}from"../../../common/languages.js";import{OverviewRulerDecorationsGroup as T}from"../../../common/viewModel.js";import{ViewPart as A}from"../../view/viewPart.js";class j{lineHeight;pixelRatio;overviewRulerLanes;renderBorder;borderColor;hideCursor;cursorColorSingle;cursorColorPrimary;cursorColorSecondary;themeType;backgroundColor;top;right;domWidth;domHeight;canvasWidth;canvasHeight;x;w;constructor(e,r){const i=e.options;this.lineHeight=i.get(y.lineHeight),this.pixelRatio=i.get(y.pixelRatio),this.overviewRulerLanes=i.get(y.overviewRulerLanes),this.renderBorder=i.get(y.overviewRulerBorder);const t=r.getColor(B);this.borderColor=t?t.toString():null,this.hideCursor=i.get(y.hideCursorInOverviewRuler);const o=r.getColor(L);this.cursorColorSingle=o?o.transparent(.7).toString():null;const s=r.getColor(F);this.cursorColorPrimary=s?s.transparent(.7).toString():null;const l=r.getColor(V);this.cursorColorSecondary=l?l.transparent(.7).toString():null,this.themeType=r.type;const d=i.get(y.minimap),_=d.enabled,p=d.side,n=r.getColor(O),S=D.getDefaultBackground();n?this.backgroundColor=n:_&&p==="right"?this.backgroundColor=S:this.backgroundColor=null;const a=i.get(y.layoutInfo).overviewRuler;this.top=a.top,this.right=a.right,this.domWidth=a.width,this.domHeight=a.height,this.overviewRulerLanes===0?(this.canvasWidth=0,this.canvasHeight=0):(this.canvasWidth=this.domWidth*this.pixelRatio|0,this.canvasHeight=this.domHeight*this.pixelRatio|0);const[u,f]=this._initLanes(1,this.canvasWidth,this.overviewRulerLanes);this.x=u,this.w=f}_initLanes(e,r,i){const t=r-e;if(i>=3){const o=Math.floor(t/3),s=Math.floor(t/3),l=t-o-s,d=e,_=d+o,p=d+o+l;return[[0,d,_,d,p,d,_,d],[0,o,l,o+l,s,o+l+s,l+s,o+l+s]]}else if(i===2){const o=Math.floor(t/2),s=t-o,l=e,d=l+o;return[[0,l,l,l,d,l,l,l],[0,o,o,o,s,o+s,o+s,o+s]]}else{const o=e,s=t;return[[0,o,o,o,o,o,o,o],[0,s,s,s,s,s,s,s]]}}equals(e){return this.lineHeight===e.lineHeight&&this.pixelRatio===e.pixelRatio&&this.overviewRulerLanes===e.overviewRulerLanes&&this.renderBorder===e.renderBorder&&this.borderColor===e.borderColor&&this.hideCursor===e.hideCursor&&this.cursorColorSingle===e.cursorColorSingle&&this.cursorColorPrimary===e.cursorColorPrimary&&this.cursorColorSecondary===e.cursorColorSecondary&&this.themeType===e.themeType&&x.equals(this.backgroundColor,e.backgroundColor)&&this.top===e.top&&this.right===e.right&&this.domWidth===e.domWidth&&this.domHeight===e.domHeight&&this.canvasWidth===e.canvasWidth&&this.canvasHeight===e.canvasHeight}}var q=(e=>(e[e.MIN_DECORATION_HEIGHT=6]="MIN_DECORATION_HEIGHT",e))(q||{}),G=(t=>(t[t.Left=1]="Left",t[t.Center=2]="Center",t[t.Right=4]="Right",t[t.Full=7]="Full",t))(G||{}),Y=(i=>(i[i.NotNeeded=0]="NotNeeded",i[i.Maybe=1]="Maybe",i[i.Needed=2]="Needed",i))(Y||{});class te extends A{_actualShouldRender=0;_tokensColorTrackerListener;_domNode;_settings;_cursorPositions;_renderedDecorations=[];_renderedCursorPositions=[];constructor(e){super(e),this._domNode=I(document.createElement("canvas")),this._domNode.setClassName("decorationsOverviewRuler"),this._domNode.setPosition("absolute"),this._domNode.setLayerHinting(!0),this._domNode.setContain("strict"),this._domNode.setAttribute("aria-hidden","true"),this._updateSettings(!1),this._tokensColorTrackerListener=D.onDidChange(r=>{r.changedColorMap&&this._updateSettings(!0)}),this._cursorPositions=[{position:new P(1,1),color:this._settings.cursorColorSingle}]}dispose(){super.dispose(),this._tokensColorTrackerListener.dispose()}_updateSettings(e){const r=new j(this._context.configuration,this._context.theme);return this._settings&&this._settings.equals(r)?!1:(this._settings=r,this._domNode.setTop(this._settings.top),this._domNode.setRight(this._settings.right),this._domNode.setWidth(this._settings.domWidth),this._domNode.setHeight(this._settings.domHeight),this._domNode.domNode.width=this._settings.canvasWidth,this._domNode.domNode.height=this._settings.canvasHeight,e&&this._render(),!0)}_markRenderingIsNeeded(){return this._actualShouldRender=2,!0}_markRenderingIsMaybeNeeded(){return this._actualShouldRender=1,!0}onConfigurationChanged(e){return this._updateSettings(!1)?this._markRenderingIsNeeded():!1}onCursorStateChanged(e){this._cursorPositions=[];for(let r=0,i=e.selections.length;r<i;r++){let t=this._settings.cursorColorSingle;i>1&&(t=r===0?this._settings.cursorColorPrimary:this._settings.cursorColorSecondary),this._cursorPositions.push({position:e.selections[r].getPosition(),color:t})}return this._cursorPositions.sort((r,i)=>P.compare(r.position,i.position)),this._markRenderingIsMaybeNeeded()}onDecorationsChanged(e){return e.affectsOverviewRuler?this._markRenderingIsMaybeNeeded():!1}onFlushed(e){return this._markRenderingIsNeeded()}onScrollChanged(e){return e.scrollHeightChanged?this._markRenderingIsNeeded():!1}onZonesChanged(e){return this._markRenderingIsNeeded()}onThemeChanged(e){return this._updateSettings(!1)?this._markRenderingIsNeeded():!1}getDomNode(){return this._domNode.domNode}prepareRender(e){}render(e){this._render(),this._actualShouldRender=0}_render(){const e=this._settings.backgroundColor;if(this._settings.overviewRulerLanes===0){this._domNode.setBackgroundColor(e?x.Format.CSS.formatHexA(e):""),this._domNode.setDisplay("none");return}const r=this._context.viewModel.getAllOverviewRulerDecorations(this._context.theme);if(r.sort(T.compareByRenderingProps),this._actualShouldRender===1&&!T.equalsArr(this._renderedDecorations,r)&&(this._actualShouldRender=2),this._actualShouldRender===1&&!M(this._renderedCursorPositions,this._cursorPositions,(a,u)=>a.position.lineNumber===u.position.lineNumber&&a.color===u.color)&&(this._actualShouldRender=2),this._actualShouldRender===1)return;this._renderedDecorations=r,this._renderedCursorPositions=this._cursorPositions,this._domNode.setDisplay("block");const i=this._settings.canvasWidth,t=this._settings.canvasHeight,o=this._settings.lineHeight,s=this._context.viewLayout,l=this._context.viewLayout.getScrollHeight(),d=t/l,_=6*this._settings.pixelRatio|0,p=_/2|0,n=this._domNode.domNode.getContext("2d");e?e.isOpaque()?(n.fillStyle=x.Format.CSS.formatHexA(e),n.fillRect(0,0,i,t)):(n.clearRect(0,0,i,t),n.fillStyle=x.Format.CSS.formatHexA(e),n.fillRect(0,0,i,t)):n.clearRect(0,0,i,t);const S=this._settings.x,k=this._settings.w;for(const a of r){const u=a.color,f=a.data;n.fillStyle=u;let C=0,c=0,h=0;for(let g=0,b=f.length/3;g<b;g++){const w=f[3*g],R=f[3*g+1],E=f[3*g+2];let m=s.getVerticalOffsetForLineNumber(R)*d|0,v=(s.getVerticalOffsetForLineNumber(E)+o)*d|0;if(v-m<_){let N=(m+v)/2|0;N<p?N=p:N+p>t&&(N=t-p),m=N-p,v=N+p}m>h+1||w!==C?(g!==0&&n.fillRect(S[C],c,k[C],h-c),C=w,c=m,h=v):v>h&&(h=v)}n.fillRect(S[C],c,k[C],h-c)}if(!this._settings.hideCursor){const a=2*this._settings.pixelRatio|0,u=a/2|0,f=this._settings.x[7],C=this._settings.w[7];let c=-100,h=-100,g=null;for(let b=0,w=this._cursorPositions.length;b<w;b++){const R=this._cursorPositions[b].color;if(!R)continue;const E=this._cursorPositions[b].position;let m=s.getVerticalOffsetForLineNumber(E.lineNumber)*d|0;m<u?m=u:m+u>t&&(m=t-u);const v=m-u,H=v+a;v>h+1||R!==g?(b!==0&&g&&n.fillRect(f,c,C,h-c),c=v,h=H):H>h&&(h=H),g=R,n.fillStyle=R}g&&n.fillRect(f,c,C,h-c)}this._settings.renderBorder&&this._settings.borderColor&&this._settings.overviewRulerLanes>0&&(n.beginPath(),n.lineWidth=1,n.strokeStyle=this._settings.borderColor,n.moveTo(0,0),n.lineTo(0,t),n.moveTo(1,0),n.lineTo(i,0),n.stroke())}}export{te as DecorationsOverviewRuler};
