import"../../../../base/browser/fastDomNode.js";import{MOUSE_CURSOR_TEXT_CSS_CLASS_NAME as W}from"../../../../base/browser/ui/mouseCursor/mouseCursor.js";import{RunOnceScheduler as S}from"../../../../base/common/async.js";import*as H from"../../../../base/common/platform.js";import{Constants as F}from"../../../../base/common/uint.js";import"./viewLines.css";import{applyFontInfo as C}from"../../config/domFontInfo.js";import{HorizontalPosition as O,HorizontalRange as I,LineVisibleRanges as D}from"../../view/renderingContext.js";import{VisibleLinesCollection as z}from"../../view/viewLayer.js";import{PartFingerprint as P,PartFingerprints as k,ViewPart as q}from"../../view/viewPart.js";import{DomReadingContext as w}from"./domReadingContext.js";import{ViewLine as x}from"./viewLine.js";import{EditorOption as a}from"../../../common/config/editorOptions.js";import{Position as R}from"../../../common/core/position.js";import{Range as V}from"../../../common/core/range.js";import"../../../common/core/selection.js";import{ScrollType as A}from"../../../common/editorCommon.js";import*as m from"../../../common/viewEvents.js";import"../../../common/viewLayout/viewLinesViewportData.js";import"../../../common/viewModel.js";import"../../../common/viewModel/viewContext.js";import{ViewLineOptions as M}from"./viewLineOptions.js";class U{_currentVisibleRange;constructor(){this._currentVisibleRange=new V(1,1,1,1)}getCurrentVisibleRange(){return this._currentVisibleRange}setCurrentVisibleRange(e){this._currentVisibleRange=e}}class X{constructor(e,t,n,i,o,s,r){this.minimalReveal=e;this.lineNumber=t;this.startColumn=n;this.endColumn=i;this.startScrollTop=o;this.stopScrollTop=s;this.scrollType=r;this.minLineNumber=t,this.maxLineNumber=t}type="range";minLineNumber;maxLineNumber}class Y{constructor(e,t,n,i,o){this.minimalReveal=e;this.selections=t;this.startScrollTop=n;this.stopScrollTop=i;this.scrollType=o;let s=t[0].startLineNumber,r=t[0].endLineNumber;for(let u=1,h=t.length;u<h;u++){const d=t[u];s=Math.min(s,d.startLineNumber),r=Math.max(r,d.endLineNumber)}this.minLineNumber=s,this.maxLineNumber=r}type="selections";minLineNumber;maxLineNumber}class T extends q{static HORIZONTAL_EXTRA_PX=30;_linesContent;_textRangeRestingSpot;_visibleLines;domNode;_lineHeight;_typicalHalfwidthCharacterWidth;_isViewportWrapping;_revealHorizontalRightPadding;_cursorSurroundingLines;_cursorSurroundingLinesStyle;_canUseLayerHinting;_viewLineOptions;_maxLineWidth;_asyncUpdateLineWidths;_asyncCheckMonospaceFontAssumptions;_horizontalRevealRequest;_lastRenderedData;_stickyScrollEnabled;_maxNumberStickyLines;constructor(e,t){super(e);const n=this._context.configuration,i=this._context.configuration.options,o=i.get(a.fontInfo),s=i.get(a.wrappingInfo);this._lineHeight=i.get(a.lineHeight),this._typicalHalfwidthCharacterWidth=o.typicalHalfwidthCharacterWidth,this._isViewportWrapping=s.isViewportWrapping,this._revealHorizontalRightPadding=i.get(a.revealHorizontalRightPadding),this._cursorSurroundingLines=i.get(a.cursorSurroundingLines),this._cursorSurroundingLinesStyle=i.get(a.cursorSurroundingLinesStyle),this._canUseLayerHinting=!i.get(a.disableLayerHinting),this._viewLineOptions=new M(n,this._context.theme.type),this._linesContent=t,this._textRangeRestingSpot=document.createElement("div"),this._visibleLines=new z({createLine:()=>new x(this._viewLineOptions)}),this.domNode=this._visibleLines.domNode,k.write(this.domNode,P.ViewLines),this.domNode.setClassName(`view-lines ${W}`),C(this.domNode,o),this._maxLineWidth=0,this._asyncUpdateLineWidths=new S(()=>{this._updateLineWidthsSlow()},200),this._asyncCheckMonospaceFontAssumptions=new S(()=>{this._checkMonospaceFontAssumptions()},2e3),this._lastRenderedData=new U,this._horizontalRevealRequest=null,this._stickyScrollEnabled=i.get(a.stickyScroll).enabled,this._maxNumberStickyLines=i.get(a.stickyScroll).maxLineCount}dispose(){this._asyncUpdateLineWidths.dispose(),this._asyncCheckMonospaceFontAssumptions.dispose(),super.dispose()}getDomNode(){return this.domNode}onConfigurationChanged(e){this._visibleLines.onConfigurationChanged(e),e.hasChanged(a.wrappingInfo)&&(this._maxLineWidth=0);const t=this._context.configuration.options,n=t.get(a.fontInfo),i=t.get(a.wrappingInfo);return this._lineHeight=t.get(a.lineHeight),this._typicalHalfwidthCharacterWidth=n.typicalHalfwidthCharacterWidth,this._isViewportWrapping=i.isViewportWrapping,this._revealHorizontalRightPadding=t.get(a.revealHorizontalRightPadding),this._cursorSurroundingLines=t.get(a.cursorSurroundingLines),this._cursorSurroundingLinesStyle=t.get(a.cursorSurroundingLinesStyle),this._canUseLayerHinting=!t.get(a.disableLayerHinting),this._stickyScrollEnabled=t.get(a.stickyScroll).enabled,this._maxNumberStickyLines=t.get(a.stickyScroll).maxLineCount,C(this.domNode,n),this._onOptionsMaybeChanged(),e.hasChanged(a.layoutInfo)&&(this._maxLineWidth=0),!0}_onOptionsMaybeChanged(){const e=this._context.configuration,t=new M(e,this._context.theme.type);if(!this._viewLineOptions.equals(t)){this._viewLineOptions=t;const n=this._visibleLines.getStartLineNumber(),i=this._visibleLines.getEndLineNumber();for(let o=n;o<=i;o++)this._visibleLines.getVisibleLine(o).onOptionsChanged(this._viewLineOptions);return!0}return!1}onCursorStateChanged(e){const t=this._visibleLines.getStartLineNumber(),n=this._visibleLines.getEndLineNumber();let i=!1;for(let o=t;o<=n;o++)i=this._visibleLines.getVisibleLine(o).onSelectionChanged()||i;return i}onDecorationsChanged(e){{const t=this._visibleLines.getStartLineNumber(),n=this._visibleLines.getEndLineNumber();for(let i=t;i<=n;i++)this._visibleLines.getVisibleLine(i).onDecorationsChanged()}return!0}onFlushed(e){const t=this._visibleLines.onFlushed(e);return this._maxLineWidth=0,t}onLinesChanged(e){return this._visibleLines.onLinesChanged(e)}onLinesDeleted(e){return this._visibleLines.onLinesDeleted(e)}onLinesInserted(e){return this._visibleLines.onLinesInserted(e)}onRevealRangeRequest(e){const t=this._computeScrollTopToRevealRange(this._context.viewLayout.getFutureViewport(),e.source,e.minimalReveal,e.range,e.selections,e.verticalType);if(t===-1)return!1;let n=this._context.viewLayout.validateScrollPosition({scrollTop:t});e.revealHorizontal?e.range&&e.range.startLineNumber!==e.range.endLineNumber?n={scrollTop:n.scrollTop,scrollLeft:0}:e.range?this._horizontalRevealRequest=new X(e.minimalReveal,e.range.startLineNumber,e.range.startColumn,e.range.endColumn,this._context.viewLayout.getCurrentScrollTop(),n.scrollTop,e.scrollType):e.selections&&e.selections.length>0&&(this._horizontalRevealRequest=new Y(e.minimalReveal,e.selections,this._context.viewLayout.getCurrentScrollTop(),n.scrollTop,e.scrollType)):this._horizontalRevealRequest=null;const o=Math.abs(this._context.viewLayout.getCurrentScrollTop()-n.scrollTop)<=this._lineHeight?A.Immediate:e.scrollType;return this._context.viewModel.viewLayout.setScrollPosition(n,o),!0}onScrollChanged(e){if(this._horizontalRevealRequest&&e.scrollLeftChanged&&(this._horizontalRevealRequest=null),this._horizontalRevealRequest&&e.scrollTopChanged){const t=Math.min(this._horizontalRevealRequest.startScrollTop,this._horizontalRevealRequest.stopScrollTop),n=Math.max(this._horizontalRevealRequest.startScrollTop,this._horizontalRevealRequest.stopScrollTop);(e.scrollTop<t||e.scrollTop>n)&&(this._horizontalRevealRequest=null)}return this.domNode.setWidth(e.scrollWidth),this._visibleLines.onScrollChanged(e)||!0}onTokensChanged(e){return this._visibleLines.onTokensChanged(e)}onZonesChanged(e){return this._context.viewModel.viewLayout.setMaxLineWidth(this._maxLineWidth),this._visibleLines.onZonesChanged(e)}onThemeChanged(e){return this._onOptionsMaybeChanged()}getPositionFromDOMInfo(e,t){const n=this._getViewLineDomNode(e);if(n===null)return null;const i=this._getLineNumberFor(n);if(i===-1||i<1||i>this._context.viewModel.getLineCount())return null;if(this._context.viewModel.getLineMaxColumn(i)===1)return new R(i,1);const o=this._visibleLines.getStartLineNumber(),s=this._visibleLines.getEndLineNumber();if(i<o||i>s)return null;let r=this._visibleLines.getVisibleLine(i).getColumnOfNodeOffset(e,t);const u=this._context.viewModel.getLineMinColumn(i);return r<u&&(r=u),new R(i,r)}_getViewLineDomNode(e){for(;e&&e.nodeType===1;){if(e.className===x.CLASS_NAME)return e;e=e.parentElement}return null}_getLineNumberFor(e){const t=this._visibleLines.getStartLineNumber(),n=this._visibleLines.getEndLineNumber();for(let i=t;i<=n;i++){const o=this._visibleLines.getVisibleLine(i);if(e===o.getDomNode())return i}return-1}getLineWidth(e){const t=this._visibleLines.getStartLineNumber(),n=this._visibleLines.getEndLineNumber();if(e<t||e>n)return-1;const i=new w(this.domNode.domNode,this._textRangeRestingSpot),o=this._visibleLines.getVisibleLine(e).getWidth(i);return this._updateLineWidthsSlowIfDomDidLayout(i),o}linesVisibleRangesForRange(e,t){if(this.shouldRender())return null;const n=e.endLineNumber,i=V.intersectRanges(e,this._lastRenderedData.getCurrentVisibleRange());if(!i)return null;const o=[];let s=0;const r=new w(this.domNode.domNode,this._textRangeRestingSpot);let u=0;t&&(u=this._context.viewModel.coordinatesConverter.convertViewPositionToModelPosition(new R(i.startLineNumber,1)).lineNumber);const h=this._visibleLines.getStartLineNumber(),d=this._visibleLines.getEndLineNumber();for(let l=i.startLineNumber;l<=i.endLineNumber;l++){if(l<h||l>d)continue;const c=l===i.startLineNumber?i.startColumn:1,f=l!==i.endLineNumber,_=f?this._context.viewModel.getLineMaxColumn(l):i.endColumn,L=this._visibleLines.getVisibleLine(l).getVisibleRangesForRange(l,c,_,r);if(L){if(t&&l<n){const b=u;u=this._context.viewModel.coordinatesConverter.convertViewPositionToModelPosition(new R(l+1,1)).lineNumber,b!==u&&(L.ranges[L.ranges.length-1].width+=this._typicalHalfwidthCharacterWidth)}o[s++]=new D(L.outsideRenderedLine,l,I.from(L.ranges),f)}}return this._updateLineWidthsSlowIfDomDidLayout(r),s===0?null:o}_visibleRangesForLineRange(e,t,n){if(this.shouldRender()||e<this._visibleLines.getStartLineNumber()||e>this._visibleLines.getEndLineNumber())return null;const i=new w(this.domNode.domNode,this._textRangeRestingSpot),o=this._visibleLines.getVisibleLine(e).getVisibleRangesForRange(e,t,n,i);return this._updateLineWidthsSlowIfDomDidLayout(i),o}visibleRangeForPosition(e){const t=this._visibleRangesForLineRange(e.lineNumber,e.column,e.column);return t?new O(t.outsideRenderedLine,t.ranges[0].left):null}updateLineWidths(){this._updateLineWidths(!1)}_updateLineWidthsFast(){return this._updateLineWidths(!0)}_updateLineWidthsSlow(){this._updateLineWidths(!1)}_updateLineWidthsSlowIfDomDidLayout(e){e.didDomLayout&&(this._asyncUpdateLineWidths.isScheduled()||(this._asyncUpdateLineWidths.cancel(),this._updateLineWidthsSlow()))}_updateLineWidths(e){const t=this._visibleLines.getStartLineNumber(),n=this._visibleLines.getEndLineNumber();let i=1,o=!0;for(let s=t;s<=n;s++){const r=this._visibleLines.getVisibleLine(s);if(e&&!r.getWidthIsFast()){o=!1;continue}i=Math.max(i,r.getWidth(null))}return o&&t===1&&n===this._context.viewModel.getLineCount()&&(this._maxLineWidth=0),this._ensureMaxLineWidth(i),o}_checkMonospaceFontAssumptions(){let e=-1,t=-1;const n=this._visibleLines.getStartLineNumber(),i=this._visibleLines.getEndLineNumber();for(let o=n;o<=i;o++){const s=this._visibleLines.getVisibleLine(o);if(s.needsMonospaceFontCheck()){const r=s.getWidth(null);r>t&&(t=r,e=o)}}if(e!==-1&&!this._visibleLines.getVisibleLine(e).monospaceAssumptionsAreValid())for(let o=n;o<=i;o++)this._visibleLines.getVisibleLine(o).onMonospaceAssumptionsInvalidated()}prepareRender(){throw new Error("Not supported")}render(){throw new Error("Not supported")}renderText(e){if(this._visibleLines.renderLines(e),this._lastRenderedData.setCurrentVisibleRange(e.visibleRange),this.domNode.setWidth(this._context.viewLayout.getScrollWidth()),this.domNode.setHeight(Math.min(this._context.viewLayout.getScrollHeight(),1e6)),this._horizontalRevealRequest){const n=this._horizontalRevealRequest;if(e.startLineNumber<=n.minLineNumber&&n.maxLineNumber<=e.endLineNumber){this._horizontalRevealRequest=null,this.onDidRender();const i=this._computeScrollLeftToReveal(n);i&&(this._isViewportWrapping||this._ensureMaxLineWidth(i.maxHorizontalOffset),this._context.viewModel.viewLayout.setScrollPosition({scrollLeft:i.scrollLeft},n.scrollType))}}if(this._updateLineWidthsFast()?this._asyncUpdateLineWidths.cancel():this._asyncUpdateLineWidths.schedule(),H.isLinux&&!this._asyncCheckMonospaceFontAssumptions.isScheduled()){const n=this._visibleLines.getStartLineNumber(),i=this._visibleLines.getEndLineNumber();for(let o=n;o<=i;o++)if(this._visibleLines.getVisibleLine(o).needsMonospaceFontCheck()){this._asyncCheckMonospaceFontAssumptions.schedule();break}}this._linesContent.setLayerHinting(this._canUseLayerHinting),this._linesContent.setContain("strict");const t=this._context.viewLayout.getCurrentScrollTop()-e.bigNumbersDelta;this._linesContent.setTop(-t),this._linesContent.setLeft(-this._context.viewLayout.getCurrentScrollLeft())}_ensureMaxLineWidth(e){const t=Math.ceil(e);this._maxLineWidth<t&&(this._maxLineWidth=t,this._context.viewModel.viewLayout.setMaxLineWidth(this._maxLineWidth))}_computeScrollTopToRevealRange(e,t,n,i,o,s){const r=e.top,u=e.height,h=r+u;let d,l,c;if(o&&o.length>0){let p=o[0].startLineNumber,v=o[0].endLineNumber;for(let g=1,E=o.length;g<E;g++){const y=o[g];p=Math.min(p,y.startLineNumber),v=Math.max(v,y.endLineNumber)}d=!1,l=this._context.viewLayout.getVerticalOffsetForLineNumber(p),c=this._context.viewLayout.getVerticalOffsetForLineNumber(v)+this._lineHeight}else if(i)d=!0,l=this._context.viewLayout.getVerticalOffsetForLineNumber(i.startLineNumber),c=this._context.viewLayout.getVerticalOffsetForLineNumber(i.endLineNumber)+this._lineHeight;else return-1;const f=(t==="mouse"||n)&&this._cursorSurroundingLinesStyle==="default";let _=0,L=0;if(f)n||(_=this._lineHeight);else{const p=u/this._lineHeight,v=Math.max(this._cursorSurroundingLines,this._stickyScrollEnabled?this._maxNumberStickyLines:0),g=Math.min(p/2,v);_=g*this._lineHeight,L=Math.max(0,g-1)*this._lineHeight}n||(s===m.VerticalRevealType.Simple||s===m.VerticalRevealType.Bottom)&&(L+=this._lineHeight),l-=_,c+=L;let b;if(c-l>u){if(!d)return-1;b=l}else if(s===m.VerticalRevealType.NearTop||s===m.VerticalRevealType.NearTopIfOutsideViewport)if(s===m.VerticalRevealType.NearTopIfOutsideViewport&&r<=l&&c<=h)b=r;else{const p=Math.max(5*this._lineHeight,u*.2),v=l-p,g=c-u;b=Math.max(g,v)}else if(s===m.VerticalRevealType.Center||s===m.VerticalRevealType.CenterIfOutsideViewport)if(s===m.VerticalRevealType.CenterIfOutsideViewport&&r<=l&&c<=h)b=r;else{const p=(l+c)/2;b=Math.max(0,p-u/2)}else b=this._computeMinimumScrolling(r,h,l,c,s===m.VerticalRevealType.Top,s===m.VerticalRevealType.Bottom);return b}_computeScrollLeftToReveal(e){const t=this._context.viewLayout.getCurrentViewport(),n=this._context.configuration.options.get(a.layoutInfo),i=t.left,o=i+t.width-n.verticalScrollbarWidth;let s=F.MAX_SAFE_SMALL_INTEGER,r=0;if(e.type==="range"){const h=this._visibleRangesForLineRange(e.lineNumber,e.startColumn,e.endColumn);if(!h)return null;for(const d of h.ranges)s=Math.min(s,Math.round(d.left)),r=Math.max(r,Math.round(d.left+d.width))}else for(const h of e.selections){if(h.startLineNumber!==h.endLineNumber)return null;const d=this._visibleRangesForLineRange(h.startLineNumber,h.startColumn,h.endColumn);if(!d)return null;for(const l of d.ranges)s=Math.min(s,Math.round(l.left)),r=Math.max(r,Math.round(l.left+l.width))}return e.minimalReveal||(s=Math.max(0,s-T.HORIZONTAL_EXTRA_PX),r+=this._revealHorizontalRightPadding),e.type==="selections"&&r-s>t.width?null:{scrollLeft:this._computeMinimumScrolling(i,o,s,r),maxHorizontalOffset:r}}_computeMinimumScrolling(e,t,n,i,o,s){e=e|0,t=t|0,n=n|0,i=i|0,o=!!o,s=!!s;const r=t-e;if(i-n<r){if(o)return n;if(s)return Math.max(0,i-r);if(n<e)return n;if(i>t)return Math.max(0,i-r)}else return n;return e}}export{T as ViewLines};
