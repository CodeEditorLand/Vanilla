import*as w from"../../../../../vs/base/browser/browser.js";import{createFastDomNode as T}from"../../../../../vs/base/browser/fastDomNode.js";import*as V from"../../../../../vs/base/common/platform.js";import{FloatHorizontalRange as f,VisibleRanges as x}from"../../../../../vs/editor/browser/view/renderingContext.js";import"../../../../../vs/editor/browser/view/viewLayer.js";import"../../../../../vs/editor/browser/viewParts/lines/domReadingContext.js";import{RangeUtil as b}from"../../../../../vs/editor/browser/viewParts/lines/rangeUtil.js";import"../../../../../vs/editor/common/config/editorConfiguration.js";import{EditorFontLigatures as I,EditorOption as h}from"../../../../../vs/editor/common/config/editorOptions.js";import"../../../../../vs/editor/common/core/stringBuilder.js";import{LineDecoration as W}from"../../../../../vs/editor/common/viewLayout/lineDecorations.js";import{DomPosition as N,ForeignElementType as p,LineRange as E,RenderLineInput as v,renderViewLine as A}from"../../../../../vs/editor/common/viewLayout/viewLineRenderer.js";import"../../../../../vs/editor/common/viewLayout/viewLinesViewportData.js";import{InlineDecorationType as P}from"../../../../../vs/editor/common/viewModel.js";import{isHighContrast as C}from"../../../../../vs/platform/theme/common/theme.js";const z=function(){return V.isNative?!0:!(V.isLinux||w.isFirefox||w.isSafari)}();let u=!0;class ce{themeType;renderWhitespace;renderControlCharacters;spaceWidth;middotWidth;wsmiddotWidth;useMonospaceOptimizations;canUseHalfwidthRightwardsArrow;lineHeight;stopRenderingLineAfter;fontLigatures;constructor(e,t){this.themeType=t;const r=e.options,n=r.get(h.fontInfo);r.get(h.experimentalWhitespaceRendering)==="off"?this.renderWhitespace=r.get(h.renderWhitespace):this.renderWhitespace="none",this.renderControlCharacters=r.get(h.renderControlCharacters),this.spaceWidth=n.spaceWidth,this.middotWidth=n.middotWidth,this.wsmiddotWidth=n.wsmiddotWidth,this.useMonospaceOptimizations=n.isMonospace&&!r.get(h.disableMonospaceOptimizations),this.canUseHalfwidthRightwardsArrow=n.canUseHalfwidthRightwardsArrow,this.lineHeight=r.get(h.lineHeight),this.stopRenderingLineAfter=r.get(h.stopRenderingLineAfter),this.fontLigatures=r.get(h.fontLigatures)}equals(e){return this.themeType===e.themeType&&this.renderWhitespace===e.renderWhitespace&&this.renderControlCharacters===e.renderControlCharacters&&this.spaceWidth===e.spaceWidth&&this.middotWidth===e.middotWidth&&this.wsmiddotWidth===e.wsmiddotWidth&&this.useMonospaceOptimizations===e.useMonospaceOptimizations&&this.canUseHalfwidthRightwardsArrow===e.canUseHalfwidthRightwardsArrow&&this.lineHeight===e.lineHeight&&this.stopRenderingLineAfter===e.stopRenderingLineAfter&&this.fontLigatures===e.fontLigatures}}class D{static CLASS_NAME="view-line";_options;_isMaybeInvalid;_renderedViewLine;constructor(e){this._options=e,this._isMaybeInvalid=!0,this._renderedViewLine=null}getDomNode(){return this._renderedViewLine&&this._renderedViewLine.domNode?this._renderedViewLine.domNode.domNode:null}setDomNode(e){if(this._renderedViewLine)this._renderedViewLine.domNode=T(e);else throw new Error("I have no rendered view line to set the dom node to...")}onContentChanged(){this._isMaybeInvalid=!0}onTokensChanged(){this._isMaybeInvalid=!0}onDecorationsChanged(){this._isMaybeInvalid=!0}onOptionsChanged(e){this._isMaybeInvalid=!0,this._options=e}onSelectionChanged(){return C(this._options.themeType)||this._options.renderWhitespace==="selection"?(this._isMaybeInvalid=!0,!0):!1}renderLine(e,t,r,n,i){if(this._isMaybeInvalid===!1)return!1;this._isMaybeInvalid=!1;const o=n.getViewLineRenderingData(e),a=this._options,s=W.filter(o.inlineDecorations,e,o.minColumn,o.maxColumn);let d=null;if(C(a.themeType)||this._options.renderWhitespace==="selection"){const H=n.selections;for(const c of H){if(c.endLineNumber<e||c.startLineNumber>e)continue;const R=c.startLineNumber===e?c.startColumn:o.minColumn,M=c.endLineNumber===e?c.endColumn:o.maxColumn;R<M&&(C(a.themeType)&&s.push(new W(R,M,"inline-selected-text",P.Regular)),this._options.renderWhitespace==="selection"&&(d||(d=[]),d.push(new E(R-1,M-1))))}}const g=new v(a.useMonospaceOptimizations,a.canUseHalfwidthRightwardsArrow,o.content,o.continuesWithWrappedLine,o.isBasicASCII,o.containsRTL,o.minColumn-1,o.tokens,s,o.tabSize,o.startVisibleColumn,a.spaceWidth,a.middotWidth,a.wsmiddotWidth,a.stopRenderingLineAfter,a.renderWhitespace,a.renderControlCharacters,a.fontLigatures!==I.OFF,d);if(this._renderedViewLine&&this._renderedViewLine.input.equals(g))return!1;i.appendString('<div style="top:'),i.appendString(String(t)),i.appendString("px;height:"),i.appendString(String(r)),i.appendString('px;" class="'),i.appendString(D.CLASS_NAME),i.appendString('">');const m=A(g,i);i.appendString("</div>");let _=null;return u&&z&&o.isBasicASCII&&a.useMonospaceOptimizations&&m.containsForeignElements===p.None&&(_=new L(this._renderedViewLine?this._renderedViewLine.domNode:null,g,m.characterMapping)),_||(_=y(this._renderedViewLine?this._renderedViewLine.domNode:null,g,m.characterMapping,m.containsRTL,m.containsForeignElements)),this._renderedViewLine=_,!0}layoutLine(e,t,r){this._renderedViewLine&&this._renderedViewLine.domNode&&(this._renderedViewLine.domNode.setTop(t),this._renderedViewLine.domNode.setHeight(r))}getWidth(e){return this._renderedViewLine?this._renderedViewLine.getWidth(e):0}getWidthIsFast(){return this._renderedViewLine?this._renderedViewLine.getWidthIsFast():!0}needsMonospaceFontCheck(){return this._renderedViewLine?this._renderedViewLine instanceof L:!1}monospaceAssumptionsAreValid(){return this._renderedViewLine&&this._renderedViewLine instanceof L?this._renderedViewLine.monospaceAssumptionsAreValid():u}onMonospaceAssumptionsInvalidated(){this._renderedViewLine&&this._renderedViewLine instanceof L&&(this._renderedViewLine=this._renderedViewLine.toSlowRenderedLine())}getVisibleRangesForRange(e,t,r,n){if(!this._renderedViewLine)return null;t=Math.min(this._renderedViewLine.input.lineContent.length+1,Math.max(1,t)),r=Math.min(this._renderedViewLine.input.lineContent.length+1,Math.max(1,r));const i=this._renderedViewLine.input.stopRenderingLineAfter;if(i!==-1&&t>i+1&&r>i+1)return new x(!0,[new f(this.getWidth(n),0)]);i!==-1&&t>i+1&&(t=i+1),i!==-1&&r>i+1&&(r=i+1);const o=this._renderedViewLine.getVisibleRangesForRange(e,t,r,n);return o&&o.length>0?new x(!1,o):null}getColumnOfNodeOffset(e,t){return this._renderedViewLine?this._renderedViewLine.getColumnOfNodeOffset(e,t):1}}var S=(e=>(e[e.MaxMonospaceDistance=300]="MaxMonospaceDistance",e))(S||{});class L{domNode;input;_characterMapping;_charWidth;_keyColumnPixelOffsetCache;_cachedWidth=-1;constructor(e,t,r){this.domNode=e,this.input=t;const n=Math.floor(t.lineContent.length/300);if(n>0){this._keyColumnPixelOffsetCache=new Float32Array(n);for(let i=0;i<n;i++)this._keyColumnPixelOffsetCache[i]=-1}else this._keyColumnPixelOffsetCache=null;this._characterMapping=r,this._charWidth=t.spaceWidth}getWidth(e){if(!this.domNode||this.input.lineContent.length<300){const t=this._characterMapping.getHorizontalOffset(this._characterMapping.length);return Math.round(this._charWidth*t)}return this._cachedWidth===-1&&(this._cachedWidth=this._getReadingTarget(this.domNode).offsetWidth,e?.markDidDomLayout()),this._cachedWidth}getWidthIsFast(){return this.input.lineContent.length<300||this._cachedWidth!==-1}monospaceAssumptionsAreValid(){if(!this.domNode)return u;if(this.input.lineContent.length<300){const e=this.getWidth(null),t=this.domNode.domNode.firstChild.offsetWidth;Math.abs(e-t)>=2&&(console.warn("monospace assumptions have been violated, therefore disabling monospace optimizations!"),u=!1)}return u}toSlowRenderedLine(){return y(this.domNode,this.input,this._characterMapping,!1,p.None)}getVisibleRangesForRange(e,t,r,n){const i=this._getColumnPixelOffset(e,t,n),o=this._getColumnPixelOffset(e,r,n);return[new f(i,o-i)]}_getColumnPixelOffset(e,t,r){if(t<=300){const d=this._characterMapping.getHorizontalOffset(t);return this._charWidth*d}const n=Math.floor((t-1)/300)-1,i=(n+1)*300+1;let o=-1;if(this._keyColumnPixelOffsetCache&&(o=this._keyColumnPixelOffsetCache[n],o===-1&&(o=this._actualReadPixelOffset(e,i,r),this._keyColumnPixelOffsetCache[n]=o)),o===-1){const d=this._characterMapping.getHorizontalOffset(t);return this._charWidth*d}const a=this._characterMapping.getHorizontalOffset(i),s=this._characterMapping.getHorizontalOffset(t);return o+this._charWidth*(s-a)}_getReadingTarget(e){return e.domNode.firstChild}_actualReadPixelOffset(e,t,r){if(!this.domNode)return-1;const n=this._characterMapping.getDomPosition(t),i=b.readHorizontalRanges(this._getReadingTarget(this.domNode),n.partIndex,n.charIndex,n.partIndex,n.charIndex,r);return!i||i.length===0?-1:i[0].left}getColumnOfNodeOffset(e,t){return F(this._characterMapping,e,t)}}class O{domNode;input;_characterMapping;_isWhitespaceOnly;_containsForeignElements;_cachedWidth;_pixelOffsetCache;constructor(e,t,r,n,i){if(this.domNode=e,this.input=t,this._characterMapping=r,this._isWhitespaceOnly=/^\s*$/.test(t.lineContent),this._containsForeignElements=i,this._cachedWidth=-1,this._pixelOffsetCache=null,!n||this._characterMapping.length===0){this._pixelOffsetCache=new Float32Array(Math.max(2,this._characterMapping.length+1));for(let o=0,a=this._characterMapping.length;o<=a;o++)this._pixelOffsetCache[o]=-1}}_getReadingTarget(e){return e.domNode.firstChild}getWidth(e){return this.domNode?(this._cachedWidth===-1&&(this._cachedWidth=this._getReadingTarget(this.domNode).offsetWidth,e?.markDidDomLayout()),this._cachedWidth):0}getWidthIsFast(){return this._cachedWidth!==-1}getVisibleRangesForRange(e,t,r,n){if(!this.domNode)return null;if(this._pixelOffsetCache!==null){const i=this._readPixelOffset(this.domNode,e,t,n);if(i===-1)return null;const o=this._readPixelOffset(this.domNode,e,r,n);return o===-1?null:[new f(i,o-i)]}return this._readVisibleRangesForRange(this.domNode,e,t,r,n)}_readVisibleRangesForRange(e,t,r,n,i){if(r===n){const o=this._readPixelOffset(e,t,r,i);return o===-1?null:[new f(o,0)]}else return this._readRawVisibleRangesForRange(e,r,n,i)}_readPixelOffset(e,t,r,n){if(this._characterMapping.length===0){if(this._containsForeignElements===p.None||this._containsForeignElements===p.After)return 0;if(this._containsForeignElements===p.Before)return this.getWidth(n);const i=this._getReadingTarget(e);return i.firstChild?(n.markDidDomLayout(),i.firstChild.offsetWidth):0}if(this._pixelOffsetCache!==null){const i=this._pixelOffsetCache[r];if(i!==-1)return i;const o=this._actualReadPixelOffset(e,t,r,n);return this._pixelOffsetCache[r]=o,o}return this._actualReadPixelOffset(e,t,r,n)}_actualReadPixelOffset(e,t,r,n){if(this._characterMapping.length===0){const s=b.readHorizontalRanges(this._getReadingTarget(e),0,0,0,0,n);return!s||s.length===0?-1:s[0].left}if(r===this._characterMapping.length&&this._isWhitespaceOnly&&this._containsForeignElements===p.None)return this.getWidth(n);const i=this._characterMapping.getDomPosition(r),o=b.readHorizontalRanges(this._getReadingTarget(e),i.partIndex,i.charIndex,i.partIndex,i.charIndex,n);if(!o||o.length===0)return-1;const a=o[0].left;if(this.input.isBasicASCII){const s=this._characterMapping.getHorizontalOffset(r),d=Math.round(this.input.spaceWidth*s);if(Math.abs(d-a)<=1)return d}return a}_readRawVisibleRangesForRange(e,t,r,n){if(t===1&&r===this._characterMapping.length)return[new f(0,this.getWidth(n))];const i=this._characterMapping.getDomPosition(t),o=this._characterMapping.getDomPosition(r);return b.readHorizontalRanges(this._getReadingTarget(e),i.partIndex,i.charIndex,o.partIndex,o.charIndex,n)}getColumnOfNodeOffset(e,t){return F(this._characterMapping,e,t)}}class k extends O{_readVisibleRangesForRange(e,t,r,n,i){const o=super._readVisibleRangesForRange(e,t,r,n,i);if(!o||o.length===0||r===n||r===1&&n===this._characterMapping.length)return o;if(!this.input.containsRTL){const a=this._readPixelOffset(e,t,n,i);if(a!==-1){const s=o[o.length-1];s.left<a&&(s.width=a-s.left)}}return o}}const y=function(){return w.isWebKit?U:B}();function U(l,e,t,r,n){return new k(l,e,t,r,n)}function B(l,e,t,r,n){return new O(l,e,t,r,n)}function F(l,e,t){const r=e.textContent.length;let n=-1;for(;e;)e=e.previousSibling,n++;return l.getColumn(new N(n,t),r)}export{D as ViewLine,ce as ViewLineOptions,F as getColumnOfNodeOffset};
