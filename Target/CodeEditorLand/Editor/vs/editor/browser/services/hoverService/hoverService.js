var K=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var D=(i,s,e,t)=>{for(var n=t>1?void 0:t?U(s,e):s,f=i.length-1,a;f>=0;f--)(a=i[f])&&(n=(t?a(s,e,n):a(n))||n);return t&&n&&K(s,e,n),n},H=(i,s)=>(e,t)=>s(e,t,i);import{addDisposableListener as u,EventType as v,getActiveElement as S,getWindow as g,isAncestor as V,isAncestorOfActiveElement as A,isHTMLElement as w}from"../../../../../vs/base/browser/dom.js";import{StandardKeyboardEvent as B}from"../../../../../vs/base/browser/keyboardEvent.js";import"../../../../../vs/base/browser/ui/contextview/contextview.js";import{mainWindow as N}from"../../../../../vs/base/browser/window.js";import{TimeoutTimer as P}from"../../../../../vs/base/common/async.js";import{Disposable as R,DisposableStore as I,toDisposable as Y}from"../../../../../vs/base/common/lifecycle.js";import{HoverWidget as $}from"../../../../../vs/editor/browser/services/hoverService/hoverWidget.js";import{ManagedHoverWidget as q}from"../../../../../vs/editor/browser/services/hoverService/updatableHoverWidget.js";import{IAccessibilityService as z}from"../../../../../vs/platform/accessibility/common/accessibility.js";import{IContextMenuService as j}from"../../../../../vs/platform/contextview/browser/contextView.js";import{ContextViewHandler as G}from"../../../../../vs/platform/contextview/browser/contextViewService.js";import{IHoverService as J}from"../../../../../vs/platform/hover/browser/hover.js";import{InstantiationType as Q,registerSingleton as X}from"../../../../../vs/platform/instantiation/common/extensions.js";import{IInstantiationService as Z}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{IKeybindingService as ee}from"../../../../../vs/platform/keybinding/common/keybinding.js";import{ResultKind as te}from"../../../../../vs/platform/keybinding/common/keybindingResolver.js";import{ILayoutService as re}from"../../../../../vs/platform/layout/browser/layoutService.js";import{editorHoverBorder as oe}from"../../../../../vs/platform/theme/common/colorRegistry.js";import{registerThemingParticipant as ie}from"../../../../../vs/platform/theme/common/themeService.js";let _=class extends R{constructor(e,t,n,f,a){super();this._instantiationService=e;this._keybindingService=n;this._layoutService=f;this._accessibilityService=a;t.onDidShowContextMenu(()=>this.hideHover()),this._contextViewHandler=this._register(new G(this._layoutService))}_contextViewHandler;_currentHoverOptions;_currentHover;_lastHoverOptions;_lastFocusedElementBeforeOpen;showHover(e,t,n){if(L(this._currentHoverOptions)===L(e)||this._currentHover&&this._currentHoverOptions?.persistence?.sticky)return;this._currentHoverOptions=e,this._lastHoverOptions=e;const f=e.trapFocus||this._accessibilityService.isScreenReaderOptimized(),a=S();n||(f&&a?a.classList.contains("monaco-hover")||(this._lastFocusedElementBeforeOpen=a):this._lastFocusedElementBeforeOpen=void 0);const r=new I,o=this._instantiationService.createInstance($,e);if(e.persistence?.sticky&&(o.isLocked=!0),o.onDispose(()=>{this._currentHover?.domNode&&A(this._currentHover.domNode)&&this._lastFocusedElementBeforeOpen?.focus(),this._currentHoverOptions===e&&(this._currentHoverOptions=void 0),r.dispose()},void 0,r),!e.container){const d=w(e.target)?e.target:e.target.targetElements[0];e.container=this._layoutService.getContainer(g(d))}if(this._contextViewHandler.showContextView(new ne(o,t),e.container),o.onRequestLayout(()=>this._contextViewHandler.layout(),void 0,r),e.persistence?.sticky)r.add(u(g(e.container).document,v.MOUSE_DOWN,d=>{V(d.target,o.domNode)||this.doHideHover()}));else{if("targetElements"in e.target)for(const l of e.target.targetElements)r.add(u(l,v.CLICK,()=>this.hideHover()));else r.add(u(e.target,v.CLICK,()=>this.hideHover()));const d=S();if(d){const l=g(d).document;r.add(u(d,v.KEY_DOWN,p=>this._keyDown(p,o,!!e.persistence?.hideOnKeyDown))),r.add(u(l,v.KEY_DOWN,p=>this._keyDown(p,o,!!e.persistence?.hideOnKeyDown))),r.add(u(d,v.KEY_UP,p=>this._keyUp(p,o))),r.add(u(l,v.KEY_UP,p=>this._keyUp(p,o)))}}if("IntersectionObserver"in N){const d=new IntersectionObserver(p=>this._intersectionChange(p,o),{threshold:0}),l="targetElements"in e.target?e.target.targetElements[0]:e.target;d.observe(l),r.add(Y(()=>d.disconnect()))}return this._currentHover=o,o}hideHover(){this._currentHover?.isLocked||!this._currentHoverOptions||this.doHideHover()}doHideHover(){this._currentHover=void 0,this._currentHoverOptions=void 0,this._contextViewHandler.hideContextView()}_intersectionChange(e,t){e[e.length-1].isIntersecting||t.dispose()}showAndFocusLastHover(){this._lastHoverOptions&&this.showHover(this._lastHoverOptions,!0,!0)}_keyDown(e,t,n){if(e.key==="Alt"){t.isLocked=!0;return}const f=new B(e);this._keybindingService.resolveKeyboardEvent(f).getSingleModifierDispatchChords().some(r=>!!r)||this._keybindingService.softDispatch(f,f.target).kind!==te.NoMatchingKb||n&&(!this._currentHoverOptions?.trapFocus||e.key!=="Tab")&&(this.hideHover(),this._lastFocusedElementBeforeOpen?.focus())}_keyUp(e,t){e.key==="Alt"&&(t.isLocked=!1,t.isMouseIn||(this.hideHover(),this._lastFocusedElementBeforeOpen?.focus()))}_managedHovers=new Map;setupManagedHover(e,t,n,f){t.setAttribute("custom-hover","true"),t.title!==""&&(console.warn("HTML element already has a title attribute, which will conflict with the custom hover. Please remove the title attribute."),console.trace("Stack trace:",t.title),t.title="");let a,r;const o=(c,h)=>{const m=r!==void 0;c&&(r?.dispose(),r=void 0),h&&(a?.dispose(),a=void 0),m&&(e.onDidHideHover?.(),r=void 0)},d=(c,h,m,y)=>new P(async()=>{(!r||r.isDisposed)&&(r=new q(e,m||t,c>0),await r.update(typeof n=="function"?n():n,h,{...f,trapFocus:y}))},c);let l=!1;const p=u(t,v.MOUSE_DOWN,()=>{l=!0,o(!0,!0)},!0),T=u(t,v.MOUSE_UP,()=>{l=!1},!0),x=u(t,v.MOUSE_LEAVE,c=>{l=!1,o(!1,c.fromElement===t)},!0),C=c=>{if(a)return;const h=new I,m={targetElements:[t],dispose:()=>{}};if(e.placement===void 0||e.placement==="mouse"){const y=b=>{m.x=b.x+10,w(b.target)&&k(b.target,t)!==t&&o(!0,!0)};h.add(u(t,v.MOUSE_MOVE,y,!0))}a=h,!(w(c.target)&&k(c.target,t)!==t)&&h.add(d(e.delay,!1,m))},W=u(t,v.MOUSE_OVER,C,!0),F=()=>{if(l||a)return;const c={targetElements:[t],dispose:()=>{}},h=new I,m=()=>o(!0,!0);h.add(u(t,v.BLUR,m,!0)),h.add(d(e.delay,!1,c)),a=h};let O;const M=t.tagName.toLowerCase();M!=="input"&&M!=="textarea"&&(O=u(t,v.FOCUS,F,!0));const E={show:c=>{o(!1,!0),d(0,c,void 0,c)},hide:()=>{o(!0,!0)},update:async(c,h)=>{n=c,await r?.update(n,void 0,h)},dispose:()=>{this._managedHovers.delete(t),W.dispose(),x.dispose(),p.dispose(),T.dispose(),O?.dispose(),o(!0,!0)}};return this._managedHovers.set(t,E),E}showManagedHover(e){const t=this._managedHovers.get(e);t&&t.show(!0)}dispose(){this._managedHovers.forEach(e=>e.dispose()),super.dispose()}};_=D([H(0,Z),H(1,j),H(2,ee),H(3,re),H(4,z)],_);function L(i){if(i!==void 0)return i?.id??i}class ne{constructor(s,e=!1){this._hover=s;this._focus=e}layer=1;get anchorPosition(){return this._hover.anchor}render(s){return this._hover.render(s),this._focus&&this._hover.focus(),this._hover}getAnchor(){return{x:this._hover.x,y:this._hover.y}}layout(){this._hover.layout()}}function k(i,s){for(s=s??g(i).document.body;!i.hasAttribute("custom-hover")&&i!==s;)i=i.parentElement;return i}X(J,_,Q.Delayed),ie((i,s)=>{const e=i.getColor(oe);e&&(s.addRule(`.monaco-workbench .workbench-hover .hover-row:not(:first-child):not(:empty) { border-top: 1px solid ${e.transparent(.5)}; }`),s.addRule(`.monaco-workbench .workbench-hover hr { border-top: 1px solid ${e.transparent(.5)}; }`))});export{_ as HoverService};
