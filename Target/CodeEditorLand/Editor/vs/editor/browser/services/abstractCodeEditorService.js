var T=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var _=(a,t,e,o)=>{for(var i=o>1?void 0:o?I(t,e):t,r=a.length-1,n;r>=0;r--)(n=a[r])&&(i=(o?n(t,e,i):n(i))||i);return o&&i&&T(t,e,i),i},v=(a,t)=>(e,o)=>t(e,o,a);import*as c from"../../../base/browser/dom.js";import{Emitter as u}from"../../../base/common/event.js";import{Disposable as D,DisposableStore as E,toDisposable as R}from"../../../base/common/lifecycle.js";import{LinkedList as N}from"../../../base/common/linkedList.js";import*as S from"../../../base/common/strings.js";import{URI as b}from"../../../base/common/uri.js";import{IThemeService as x}from"../../../platform/theme/common/themeService.js";import{isThemeColor as M}from"../../common/editorCommon.js";import{OverviewRulerLane as O}from"../../common/model.js";let f=class extends D{constructor(e){super();this._themeService=e;this._codeEditors=Object.create(null),this._diffEditors=Object.create(null),this._globalStyleSheet=null}_onWillCreateCodeEditor=this._register(new u);onWillCreateCodeEditor=this._onWillCreateCodeEditor.event;_onCodeEditorAdd=this._register(new u);onCodeEditorAdd=this._onCodeEditorAdd.event;_onCodeEditorRemove=this._register(new u);onCodeEditorRemove=this._onCodeEditorRemove.event;_onWillCreateDiffEditor=this._register(new u);onWillCreateDiffEditor=this._onWillCreateDiffEditor.event;_onDiffEditorAdd=this._register(new u);onDiffEditorAdd=this._onDiffEditorAdd.event;_onDiffEditorRemove=this._register(new u);onDiffEditorRemove=this._onDiffEditorRemove.event;_onDidChangeTransientModelProperty=this._register(new u);onDidChangeTransientModelProperty=this._onDidChangeTransientModelProperty.event;_onDecorationTypeRegistered=this._register(new u);onDecorationTypeRegistered=this._onDecorationTypeRegistered.event;_codeEditors;_diffEditors;_globalStyleSheet;_decorationOptionProviders=new Map;_editorStyleSheets=new Map;_codeEditorOpenHandlers=new N;willCreateCodeEditor(){this._onWillCreateCodeEditor.fire()}addCodeEditor(e){this._codeEditors[e.getId()]=e,this._onCodeEditorAdd.fire(e)}removeCodeEditor(e){delete this._codeEditors[e.getId()]&&this._onCodeEditorRemove.fire(e)}listCodeEditors(){return Object.keys(this._codeEditors).map(e=>this._codeEditors[e])}willCreateDiffEditor(){this._onWillCreateDiffEditor.fire()}addDiffEditor(e){this._diffEditors[e.getId()]=e,this._onDiffEditorAdd.fire(e)}removeDiffEditor(e){delete this._diffEditors[e.getId()]&&this._onDiffEditorRemove.fire(e)}listDiffEditors(){return Object.keys(this._diffEditors).map(e=>this._diffEditors[e])}getFocusedCodeEditor(){let e=null;const o=this.listCodeEditors();for(const i of o){if(i.hasTextFocus())return i;i.hasWidgetFocus()&&(e=i)}return e}_getOrCreateGlobalStyleSheet(){return this._globalStyleSheet||(this._globalStyleSheet=this._createGlobalStyleSheet()),this._globalStyleSheet}_createGlobalStyleSheet(){return new P(c.createStyleSheet())}_getOrCreateStyleSheet(e){if(!e)return this._getOrCreateGlobalStyleSheet();const o=e.getContainerDomNode();if(!c.isInShadowDOM(o))return this._getOrCreateGlobalStyleSheet();const i=e.getId();if(!this._editorStyleSheets.has(i)){const r=new k(this,i,c.createStyleSheet(o));this._editorStyleSheets.set(i,r)}return this._editorStyleSheets.get(i)}_removeEditorStyleSheets(e){this._editorStyleSheets.delete(e)}registerDecorationType(e,o,i,r,n){let s=this._decorationOptionProviders.get(o);if(!s){const l=this._getOrCreateStyleSheet(n),p={styleSheet:l,key:o,parentTypeKey:r,options:i||Object.create(null)};r?s=new j(this._themeService,l,p):s=new W(e,this._themeService,l,p),this._decorationOptionProviders.set(o,s),this._onDecorationTypeRegistered.fire(o)}return s.refCount++,{dispose:()=>{this.removeDecorationType(o)}}}listDecorationTypes(){return Array.from(this._decorationOptionProviders.keys())}removeDecorationType(e){const o=this._decorationOptionProviders.get(e);o&&(o.refCount--,o.refCount<=0&&(this._decorationOptionProviders.delete(e),o.dispose(),this.listCodeEditors().forEach(i=>i.removeDecorationsByType(e))))}resolveDecorationOptions(e,o){const i=this._decorationOptionProviders.get(e);if(!i)throw new Error("Unknown decoration type key: "+e);return i.getOptions(this,o)}resolveDecorationCSSRules(e){const o=this._decorationOptionProviders.get(e);return o?o.resolveDecorationCSSRules():null}_transientWatchers={};_modelProperties=new Map;setModelProperty(e,o,i){const r=e.toString();let n;this._modelProperties.has(r)?n=this._modelProperties.get(r):(n=new Map,this._modelProperties.set(r,n)),n.set(o,i)}getModelProperty(e,o){const i=e.toString();if(this._modelProperties.has(i))return this._modelProperties.get(i).get(o)}setTransientModelProperty(e,o,i){const r=e.uri.toString();let n;this._transientWatchers.hasOwnProperty(r)?n=this._transientWatchers[r]:(n=new w(r,e,this),this._transientWatchers[r]=n),n.get(o)!==i&&(n.set(o,i),this._onDidChangeTransientModelProperty.fire(e))}getTransientModelProperty(e,o){const i=e.uri.toString();if(this._transientWatchers.hasOwnProperty(i))return this._transientWatchers[i].get(o)}getTransientModelProperties(e){const o=e.uri.toString();if(this._transientWatchers.hasOwnProperty(o))return this._transientWatchers[o].keys().map(i=>[i,this._transientWatchers[o].get(i)])}_removeWatcher(e){delete this._transientWatchers[e.uri]}async openCodeEditor(e,o,i){for(const r of this._codeEditorOpenHandlers){const n=await r(e,o,i);if(n!==null)return n}return null}registerCodeEditorOpenHandler(e){const o=this._codeEditorOpenHandlers.unshift(e);return R(o)}};f=_([v(0,x)],f);class w{uri;_values;constructor(t,e,o){this.uri=t,this._values={},e.onWillDispose(()=>o._removeWatcher(this))}set(t,e){this._values[t]=e}get(t){return this._values[t]}keys(){return Object.keys(this._values)}}class k{_parent;_editorId;_styleSheet;_refCount;get sheet(){return this._styleSheet.sheet}constructor(t,e,o){this._parent=t,this._editorId=e,this._styleSheet=o,this._refCount=0}ref(){this._refCount++}unref(){this._refCount--,this._refCount===0&&(this._styleSheet.remove(),this._parent._removeEditorStyleSheets(this._editorId))}insertRule(t,e){c.createCSSRule(t,e,this._styleSheet)}removeRulesContainingSelector(t){c.removeCSSRulesContainingSelector(t,this._styleSheet)}}class P{_styleSheet;get sheet(){return this._styleSheet.sheet}constructor(t){this._styleSheet=t}ref(){}unref(){}insertRule(t,e){c.createCSSRule(t,e,this._styleSheet)}removeRulesContainingSelector(t){c.removeCSSRulesContainingSelector(t,this._styleSheet)}}class j{_styleSheet;refCount;_parentTypeKey;_beforeContentRules;_afterContentRules;constructor(t,e,o){this._styleSheet=e,this._styleSheet.ref(),this._parentTypeKey=o.parentTypeKey,this.refCount=0,this._beforeContentRules=new g(3,o,t),this._afterContentRules=new g(4,o,t)}getOptions(t,e){const o=t.resolveDecorationOptions(this._parentTypeKey,!0);return this._beforeContentRules&&(o.beforeContentClassName=this._beforeContentRules.className),this._afterContentRules&&(o.afterContentClassName=this._afterContentRules.className),o}resolveDecorationCSSRules(){return this._styleSheet.sheet.cssRules}dispose(){this._beforeContentRules&&(this._beforeContentRules.dispose(),this._beforeContentRules=null),this._afterContentRules&&(this._afterContentRules.dispose(),this._afterContentRules=null),this._styleSheet.unref()}}class W{_disposables=new E;_styleSheet;refCount;description;className;inlineClassName;inlineClassNameAffectsLetterSpacing;beforeContentClassName;afterContentClassName;glyphMarginClassName;isWholeLine;overviewRuler;stickiness;beforeInjectedText;afterInjectedText;constructor(t,e,o,i){this.description=t,this._styleSheet=o,this._styleSheet.ref(),this.refCount=0;const r=d=>{const h=new g(d,i,e);if(this._disposables.add(h),h.hasContent)return h.className},n=d=>{const h=new g(d,i,e);return this._disposables.add(h),h.hasContent?{className:h.className,hasLetterSpacing:h.hasLetterSpacing}:null};this.className=r(0);const s=n(1);if(s&&(this.inlineClassName=s.className,this.inlineClassNameAffectsLetterSpacing=s.hasLetterSpacing),this.beforeContentClassName=r(3),this.afterContentClassName=r(4),i.options.beforeInjectedText&&i.options.beforeInjectedText.contentText){const d=n(5);this.beforeInjectedText={content:i.options.beforeInjectedText.contentText,inlineClassName:d?.className,inlineClassNameAffectsLetterSpacing:d?.hasLetterSpacing||i.options.beforeInjectedText.affectsLetterSpacing}}if(i.options.afterInjectedText&&i.options.afterInjectedText.contentText){const d=n(6);this.afterInjectedText={content:i.options.afterInjectedText.contentText,inlineClassName:d?.className,inlineClassNameAffectsLetterSpacing:d?.hasLetterSpacing||i.options.afterInjectedText.affectsLetterSpacing}}this.glyphMarginClassName=r(2);const l=i.options;this.isWholeLine=!!l.isWholeLine,this.stickiness=l.rangeBehavior;const p=l.light&&l.light.overviewRulerColor||l.overviewRulerColor,m=l.dark&&l.dark.overviewRulerColor||l.overviewRulerColor;(typeof p<"u"||typeof m<"u")&&(this.overviewRuler={color:p||m,darkColor:m||p,position:l.overviewRulerLane||O.Center})}getOptions(t,e){return e?{description:this.description,inlineClassName:this.inlineClassName,beforeContentClassName:this.beforeContentClassName,afterContentClassName:this.afterContentClassName,className:this.className,glyphMarginClassName:this.glyphMarginClassName,isWholeLine:this.isWholeLine,overviewRuler:this.overviewRuler,stickiness:this.stickiness,before:this.beforeInjectedText,after:this.afterInjectedText}:this}resolveDecorationCSSRules(){return this._styleSheet.sheet.rules}dispose(){this._disposables.dispose(),this._styleSheet.unref()}}const C={color:"color:{0} !important;",opacity:"opacity:{0};",backgroundColor:"background-color:{0};",outline:"outline:{0};",outlineColor:"outline-color:{0};",outlineStyle:"outline-style:{0};",outlineWidth:"outline-width:{0};",border:"border:{0};",borderColor:"border-color:{0};",borderRadius:"border-radius:{0};",borderSpacing:"border-spacing:{0};",borderStyle:"border-style:{0};",borderWidth:"border-width:{0};",fontStyle:"font-style:{0};",fontWeight:"font-weight:{0};",fontSize:"font-size:{0};",fontFamily:"font-family:{0};",textDecoration:"text-decoration:{0};",cursor:"cursor:{0};",letterSpacing:"letter-spacing:{0};",gutterIconPath:"background:{0} center center no-repeat;",gutterIconSize:"background-size:{0};",contentText:"content:'{0}';",contentIconPath:"content:{0};",margin:"margin:{0};",padding:"padding:{0};",width:"width:{0};",height:"height:{0};",verticalAlign:"vertical-align:{0};"};class g{_theme;_className;_unThemedSelector;_hasContent;_hasLetterSpacing;_ruleType;_themeListener;_providerArgs;_usesThemeColors;constructor(t,e,o){this._theme=o.getColorTheme(),this._ruleType=t,this._providerArgs=e,this._usesThemeColors=!1,this._hasContent=!1,this._hasLetterSpacing=!1;let i=y.getClassName(this._providerArgs.key,t);this._providerArgs.parentTypeKey&&(i=i+" "+y.getClassName(this._providerArgs.parentTypeKey,t)),this._className=i,this._unThemedSelector=y.getSelector(this._providerArgs.key,this._providerArgs.parentTypeKey,t),this._buildCSS(),this._usesThemeColors?this._themeListener=o.onDidColorThemeChange(r=>{this._theme=o.getColorTheme(),this._removeCSS(),this._buildCSS()}):this._themeListener=null}dispose(){this._hasContent&&(this._removeCSS(),this._hasContent=!1),this._themeListener&&(this._themeListener.dispose(),this._themeListener=null)}get hasContent(){return this._hasContent}get hasLetterSpacing(){return this._hasLetterSpacing}get className(){return this._className}_buildCSS(){const t=this._providerArgs.options;let e,o,i;switch(this._ruleType){case 0:e=this.getCSSTextForModelDecorationClassName(t),o=this.getCSSTextForModelDecorationClassName(t.light),i=this.getCSSTextForModelDecorationClassName(t.dark);break;case 1:e=this.getCSSTextForModelDecorationInlineClassName(t),o=this.getCSSTextForModelDecorationInlineClassName(t.light),i=this.getCSSTextForModelDecorationInlineClassName(t.dark);break;case 2:e=this.getCSSTextForModelDecorationGlyphMarginClassName(t),o=this.getCSSTextForModelDecorationGlyphMarginClassName(t.light),i=this.getCSSTextForModelDecorationGlyphMarginClassName(t.dark);break;case 3:e=this.getCSSTextForModelDecorationContentClassName(t.before),o=this.getCSSTextForModelDecorationContentClassName(t.light&&t.light.before),i=this.getCSSTextForModelDecorationContentClassName(t.dark&&t.dark.before);break;case 4:e=this.getCSSTextForModelDecorationContentClassName(t.after),o=this.getCSSTextForModelDecorationContentClassName(t.light&&t.light.after),i=this.getCSSTextForModelDecorationContentClassName(t.dark&&t.dark.after);break;case 5:e=this.getCSSTextForModelDecorationContentClassName(t.beforeInjectedText),o=this.getCSSTextForModelDecorationContentClassName(t.light&&t.light.beforeInjectedText),i=this.getCSSTextForModelDecorationContentClassName(t.dark&&t.dark.beforeInjectedText);break;case 6:e=this.getCSSTextForModelDecorationContentClassName(t.afterInjectedText),o=this.getCSSTextForModelDecorationContentClassName(t.light&&t.light.afterInjectedText),i=this.getCSSTextForModelDecorationContentClassName(t.dark&&t.dark.afterInjectedText);break;default:throw new Error("Unknown rule type: "+this._ruleType)}const r=this._providerArgs.styleSheet;let n=!1;e.length>0&&(r.insertRule(this._unThemedSelector,e),n=!0),o.length>0&&(r.insertRule(`.vs${this._unThemedSelector}, .hc-light${this._unThemedSelector}`,o),n=!0),i.length>0&&(r.insertRule(`.vs-dark${this._unThemedSelector}, .hc-black${this._unThemedSelector}`,i),n=!0),this._hasContent=n}_removeCSS(){this._providerArgs.styleSheet.removeRulesContainingSelector(this._unThemedSelector)}getCSSTextForModelDecorationClassName(t){if(!t)return"";const e=[];return this.collectCSSText(t,["backgroundColor"],e),this.collectCSSText(t,["outline","outlineColor","outlineStyle","outlineWidth"],e),this.collectBorderSettingsCSSText(t,e),e.join("")}getCSSTextForModelDecorationInlineClassName(t){if(!t)return"";const e=[];return this.collectCSSText(t,["fontStyle","fontWeight","textDecoration","cursor","color","opacity","letterSpacing"],e),t.letterSpacing&&(this._hasLetterSpacing=!0),e.join("")}getCSSTextForModelDecorationContentClassName(t){if(!t)return"";const e=[];if(typeof t<"u"){if(this.collectBorderSettingsCSSText(t,e),typeof t.contentIconPath<"u"&&e.push(S.format(C.contentIconPath,c.asCSSUrl(b.revive(t.contentIconPath)))),typeof t.contentText=="string"){const i=t.contentText.match(/^.*$/m)[0].replace(/['\\]/g,"\\$&");e.push(S.format(C.contentText,i))}this.collectCSSText(t,["verticalAlign","fontStyle","fontWeight","fontSize","fontFamily","textDecoration","color","opacity","backgroundColor","margin","padding"],e),this.collectCSSText(t,["width","height"],e)&&e.push("display:inline-block;")}return e.join("")}getCSSTextForModelDecorationGlyphMarginClassName(t){if(!t)return"";const e=[];return typeof t.gutterIconPath<"u"&&(e.push(S.format(C.gutterIconPath,c.asCSSUrl(b.revive(t.gutterIconPath)))),typeof t.gutterIconSize<"u"&&e.push(S.format(C.gutterIconSize,t.gutterIconSize))),e.join("")}collectBorderSettingsCSSText(t,e){return this.collectCSSText(t,["border","borderColor","borderRadius","borderSpacing","borderStyle","borderWidth"],e)?(e.push(S.format("box-sizing: border-box;")),!0):!1}collectCSSText(t,e,o){const i=o.length;for(const r of e){const n=this.resolveValue(t[r]);typeof n=="string"&&o.push(S.format(C[r],n))}return o.length!==i}resolveValue(t){if(M(t)){this._usesThemeColors=!0;const e=this._theme.getColor(t.id);return e?e.toString():"transparent"}return t}}var L=(s=>(s[s.ClassName=0]="ClassName",s[s.InlineClassName=1]="InlineClassName",s[s.GlyphMarginClassName=2]="GlyphMarginClassName",s[s.BeforeContentClassName=3]="BeforeContentClassName",s[s.AfterContentClassName=4]="AfterContentClassName",s[s.BeforeInjectedTextClassName=5]="BeforeInjectedTextClassName",s[s.AfterInjectedTextClassName=6]="AfterInjectedTextClassName",s))(L||{});class y{static getClassName(t,e){return"ced-"+t+"-"+e}static getSelector(t,e,o){let i=".monaco-editor ."+this.getClassName(t,o);return e&&(i=i+"."+this.getClassName(e,o)),o===3?i+="::before":o===4&&(i+="::after"),i}}export{f as AbstractCodeEditorService,P as GlobalStyleSheet,w as ModelTransientSettingWatcher,C as _CSS_MAP};
