var T=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var _=(a,t,e,i)=>{for(var o=i>1?void 0:i?I(t,e):t,r=a.length-1,n;r>=0;r--)(n=a[r])&&(o=(i?n(t,e,o):n(o))||o);return i&&o&&T(t,e,o),o},v=(a,t)=>(e,i)=>t(e,i,a);import*as c from"../../../base/browser/dom.js";import{Emitter as u}from"../../../base/common/event.js";import{DisposableStore as D,Disposable as E,toDisposable as R}from"../../../base/common/lifecycle.js";import{LinkedList as N}from"../../../base/common/linkedList.js";import*as p from"../../../base/common/strings.js";import{URI as b}from"../../../base/common/uri.js";import{isThemeColor as x}from"../../common/editorCommon.js";import{OverviewRulerLane as M}from"../../common/model.js";import{IThemeService as O}from"../../../platform/theme/common/themeService.js";let f=class extends E{constructor(e){super();this._themeService=e;this._codeEditors=Object.create(null),this._diffEditors=Object.create(null),this._globalStyleSheet=null}_onWillCreateCodeEditor=this._register(new u);onWillCreateCodeEditor=this._onWillCreateCodeEditor.event;_onCodeEditorAdd=this._register(new u);onCodeEditorAdd=this._onCodeEditorAdd.event;_onCodeEditorRemove=this._register(new u);onCodeEditorRemove=this._onCodeEditorRemove.event;_onWillCreateDiffEditor=this._register(new u);onWillCreateDiffEditor=this._onWillCreateDiffEditor.event;_onDiffEditorAdd=this._register(new u);onDiffEditorAdd=this._onDiffEditorAdd.event;_onDiffEditorRemove=this._register(new u);onDiffEditorRemove=this._onDiffEditorRemove.event;_onDidChangeTransientModelProperty=this._register(new u);onDidChangeTransientModelProperty=this._onDidChangeTransientModelProperty.event;_onDecorationTypeRegistered=this._register(new u);onDecorationTypeRegistered=this._onDecorationTypeRegistered.event;_codeEditors;_diffEditors;_globalStyleSheet;_decorationOptionProviders=new Map;_editorStyleSheets=new Map;_codeEditorOpenHandlers=new N;willCreateCodeEditor(){this._onWillCreateCodeEditor.fire()}addCodeEditor(e){this._codeEditors[e.getId()]=e,this._onCodeEditorAdd.fire(e)}removeCodeEditor(e){delete this._codeEditors[e.getId()]&&this._onCodeEditorRemove.fire(e)}listCodeEditors(){return Object.keys(this._codeEditors).map(e=>this._codeEditors[e])}willCreateDiffEditor(){this._onWillCreateDiffEditor.fire()}addDiffEditor(e){this._diffEditors[e.getId()]=e,this._onDiffEditorAdd.fire(e)}removeDiffEditor(e){delete this._diffEditors[e.getId()]&&this._onDiffEditorRemove.fire(e)}listDiffEditors(){return Object.keys(this._diffEditors).map(e=>this._diffEditors[e])}getFocusedCodeEditor(){let e=null;const i=this.listCodeEditors();for(const o of i){if(o.hasTextFocus())return o;o.hasWidgetFocus()&&(e=o)}return e}_getOrCreateGlobalStyleSheet(){return this._globalStyleSheet||(this._globalStyleSheet=this._createGlobalStyleSheet()),this._globalStyleSheet}_createGlobalStyleSheet(){return new P(c.createStyleSheet())}_getOrCreateStyleSheet(e){if(!e)return this._getOrCreateGlobalStyleSheet();const i=e.getContainerDomNode();if(!c.isInShadowDOM(i))return this._getOrCreateGlobalStyleSheet();const o=e.getId();if(!this._editorStyleSheets.has(o)){const r=new k(this,o,c.createStyleSheet(i));this._editorStyleSheets.set(o,r)}return this._editorStyleSheets.get(o)}_removeEditorStyleSheets(e){this._editorStyleSheets.delete(e)}registerDecorationType(e,i,o,r,n){let s=this._decorationOptionProviders.get(i);if(!s){const l=this._getOrCreateStyleSheet(n),S={styleSheet:l,key:i,parentTypeKey:r,options:o||Object.create(null)};r?s=new W(this._themeService,l,S):s=new j(e,this._themeService,l,S),this._decorationOptionProviders.set(i,s),this._onDecorationTypeRegistered.fire(i)}return s.refCount++,{dispose:()=>{this.removeDecorationType(i)}}}listDecorationTypes(){return Array.from(this._decorationOptionProviders.keys())}removeDecorationType(e){const i=this._decorationOptionProviders.get(e);i&&(i.refCount--,i.refCount<=0&&(this._decorationOptionProviders.delete(e),i.dispose(),this.listCodeEditors().forEach(o=>o.removeDecorationsByType(e))))}resolveDecorationOptions(e,i){const o=this._decorationOptionProviders.get(e);if(!o)throw new Error("Unknown decoration type key: "+e);return o.getOptions(this,i)}resolveDecorationCSSRules(e){const i=this._decorationOptionProviders.get(e);return i?i.resolveDecorationCSSRules():null}_transientWatchers={};_modelProperties=new Map;setModelProperty(e,i,o){const r=e.toString();let n;this._modelProperties.has(r)?n=this._modelProperties.get(r):(n=new Map,this._modelProperties.set(r,n)),n.set(i,o)}getModelProperty(e,i){const o=e.toString();if(this._modelProperties.has(o))return this._modelProperties.get(o).get(i)}setTransientModelProperty(e,i,o){const r=e.uri.toString();let n;this._transientWatchers.hasOwnProperty(r)?n=this._transientWatchers[r]:(n=new w(r,e,this),this._transientWatchers[r]=n),n.get(i)!==o&&(n.set(i,o),this._onDidChangeTransientModelProperty.fire(e))}getTransientModelProperty(e,i){const o=e.uri.toString();if(this._transientWatchers.hasOwnProperty(o))return this._transientWatchers[o].get(i)}getTransientModelProperties(e){const i=e.uri.toString();if(this._transientWatchers.hasOwnProperty(i))return this._transientWatchers[i].keys().map(o=>[o,this._transientWatchers[i].get(o)])}_removeWatcher(e){delete this._transientWatchers[e.uri]}async openCodeEditor(e,i,o){for(const r of this._codeEditorOpenHandlers){const n=await r(e,i,o);if(n!==null)return n}return null}registerCodeEditorOpenHandler(e){const i=this._codeEditorOpenHandlers.unshift(e);return R(i)}};f=_([v(0,O)],f);class w{uri;_values;constructor(t,e,i){this.uri=t,this._values={},e.onWillDispose(()=>i._removeWatcher(this))}set(t,e){this._values[t]=e}get(t){return this._values[t]}keys(){return Object.keys(this._values)}}class k{_parent;_editorId;_styleSheet;_refCount;get sheet(){return this._styleSheet.sheet}constructor(t,e,i){this._parent=t,this._editorId=e,this._styleSheet=i,this._refCount=0}ref(){this._refCount++}unref(){this._refCount--,this._refCount===0&&(this._styleSheet.remove(),this._parent._removeEditorStyleSheets(this._editorId))}insertRule(t,e){c.createCSSRule(t,e,this._styleSheet)}removeRulesContainingSelector(t){c.removeCSSRulesContainingSelector(t,this._styleSheet)}}class P{_styleSheet;get sheet(){return this._styleSheet.sheet}constructor(t){this._styleSheet=t}ref(){}unref(){}insertRule(t,e){c.createCSSRule(t,e,this._styleSheet)}removeRulesContainingSelector(t){c.removeCSSRulesContainingSelector(t,this._styleSheet)}}class W{_styleSheet;refCount;_parentTypeKey;_beforeContentRules;_afterContentRules;constructor(t,e,i){this._styleSheet=e,this._styleSheet.ref(),this._parentTypeKey=i.parentTypeKey,this.refCount=0,this._beforeContentRules=new g(3,i,t),this._afterContentRules=new g(4,i,t)}getOptions(t,e){const i=t.resolveDecorationOptions(this._parentTypeKey,!0);return this._beforeContentRules&&(i.beforeContentClassName=this._beforeContentRules.className),this._afterContentRules&&(i.afterContentClassName=this._afterContentRules.className),i}resolveDecorationCSSRules(){return this._styleSheet.sheet.cssRules}dispose(){this._beforeContentRules&&(this._beforeContentRules.dispose(),this._beforeContentRules=null),this._afterContentRules&&(this._afterContentRules.dispose(),this._afterContentRules=null),this._styleSheet.unref()}}class j{_disposables=new D;_styleSheet;refCount;description;className;inlineClassName;inlineClassNameAffectsLetterSpacing;beforeContentClassName;afterContentClassName;glyphMarginClassName;isWholeLine;overviewRuler;stickiness;beforeInjectedText;afterInjectedText;constructor(t,e,i,o){this.description=t,this._styleSheet=i,this._styleSheet.ref(),this.refCount=0;const r=d=>{const h=new g(d,o,e);if(this._disposables.add(h),h.hasContent)return h.className},n=d=>{const h=new g(d,o,e);return this._disposables.add(h),h.hasContent?{className:h.className,hasLetterSpacing:h.hasLetterSpacing}:null};this.className=r(0);const s=n(1);if(s&&(this.inlineClassName=s.className,this.inlineClassNameAffectsLetterSpacing=s.hasLetterSpacing),this.beforeContentClassName=r(3),this.afterContentClassName=r(4),o.options.beforeInjectedText&&o.options.beforeInjectedText.contentText){const d=n(5);this.beforeInjectedText={content:o.options.beforeInjectedText.contentText,inlineClassName:d?.className,inlineClassNameAffectsLetterSpacing:d?.hasLetterSpacing||o.options.beforeInjectedText.affectsLetterSpacing}}if(o.options.afterInjectedText&&o.options.afterInjectedText.contentText){const d=n(6);this.afterInjectedText={content:o.options.afterInjectedText.contentText,inlineClassName:d?.className,inlineClassNameAffectsLetterSpacing:d?.hasLetterSpacing||o.options.afterInjectedText.affectsLetterSpacing}}this.glyphMarginClassName=r(2);const l=o.options;this.isWholeLine=!!l.isWholeLine,this.stickiness=l.rangeBehavior;const S=l.light&&l.light.overviewRulerColor||l.overviewRulerColor,m=l.dark&&l.dark.overviewRulerColor||l.overviewRulerColor;(typeof S<"u"||typeof m<"u")&&(this.overviewRuler={color:S||m,darkColor:m||S,position:l.overviewRulerLane||M.Center})}getOptions(t,e){return e?{description:this.description,inlineClassName:this.inlineClassName,beforeContentClassName:this.beforeContentClassName,afterContentClassName:this.afterContentClassName,className:this.className,glyphMarginClassName:this.glyphMarginClassName,isWholeLine:this.isWholeLine,overviewRuler:this.overviewRuler,stickiness:this.stickiness,before:this.beforeInjectedText,after:this.afterInjectedText}:this}resolveDecorationCSSRules(){return this._styleSheet.sheet.rules}dispose(){this._disposables.dispose(),this._styleSheet.unref()}}const C={color:"color:{0} !important;",opacity:"opacity:{0};",backgroundColor:"background-color:{0};",outline:"outline:{0};",outlineColor:"outline-color:{0};",outlineStyle:"outline-style:{0};",outlineWidth:"outline-width:{0};",border:"border:{0};",borderColor:"border-color:{0};",borderRadius:"border-radius:{0};",borderSpacing:"border-spacing:{0};",borderStyle:"border-style:{0};",borderWidth:"border-width:{0};",fontStyle:"font-style:{0};",fontWeight:"font-weight:{0};",fontSize:"font-size:{0};",fontFamily:"font-family:{0};",textDecoration:"text-decoration:{0};",cursor:"cursor:{0};",letterSpacing:"letter-spacing:{0};",gutterIconPath:"background:{0} center center no-repeat;",gutterIconSize:"background-size:{0};",contentText:"content:'{0}';",contentIconPath:"content:{0};",margin:"margin:{0};",padding:"padding:{0};",width:"width:{0};",height:"height:{0};",verticalAlign:"vertical-align:{0};"};class g{_theme;_className;_unThemedSelector;_hasContent;_hasLetterSpacing;_ruleType;_themeListener;_providerArgs;_usesThemeColors;constructor(t,e,i){this._theme=i.getColorTheme(),this._ruleType=t,this._providerArgs=e,this._usesThemeColors=!1,this._hasContent=!1,this._hasLetterSpacing=!1;let o=y.getClassName(this._providerArgs.key,t);this._providerArgs.parentTypeKey&&(o=o+" "+y.getClassName(this._providerArgs.parentTypeKey,t)),this._className=o,this._unThemedSelector=y.getSelector(this._providerArgs.key,this._providerArgs.parentTypeKey,t),this._buildCSS(),this._usesThemeColors?this._themeListener=i.onDidColorThemeChange(r=>{this._theme=i.getColorTheme(),this._removeCSS(),this._buildCSS()}):this._themeListener=null}dispose(){this._hasContent&&(this._removeCSS(),this._hasContent=!1),this._themeListener&&(this._themeListener.dispose(),this._themeListener=null)}get hasContent(){return this._hasContent}get hasLetterSpacing(){return this._hasLetterSpacing}get className(){return this._className}_buildCSS(){const t=this._providerArgs.options;let e,i,o;switch(this._ruleType){case 0:e=this.getCSSTextForModelDecorationClassName(t),i=this.getCSSTextForModelDecorationClassName(t.light),o=this.getCSSTextForModelDecorationClassName(t.dark);break;case 1:e=this.getCSSTextForModelDecorationInlineClassName(t),i=this.getCSSTextForModelDecorationInlineClassName(t.light),o=this.getCSSTextForModelDecorationInlineClassName(t.dark);break;case 2:e=this.getCSSTextForModelDecorationGlyphMarginClassName(t),i=this.getCSSTextForModelDecorationGlyphMarginClassName(t.light),o=this.getCSSTextForModelDecorationGlyphMarginClassName(t.dark);break;case 3:e=this.getCSSTextForModelDecorationContentClassName(t.before),i=this.getCSSTextForModelDecorationContentClassName(t.light&&t.light.before),o=this.getCSSTextForModelDecorationContentClassName(t.dark&&t.dark.before);break;case 4:e=this.getCSSTextForModelDecorationContentClassName(t.after),i=this.getCSSTextForModelDecorationContentClassName(t.light&&t.light.after),o=this.getCSSTextForModelDecorationContentClassName(t.dark&&t.dark.after);break;case 5:e=this.getCSSTextForModelDecorationContentClassName(t.beforeInjectedText),i=this.getCSSTextForModelDecorationContentClassName(t.light&&t.light.beforeInjectedText),o=this.getCSSTextForModelDecorationContentClassName(t.dark&&t.dark.beforeInjectedText);break;case 6:e=this.getCSSTextForModelDecorationContentClassName(t.afterInjectedText),i=this.getCSSTextForModelDecorationContentClassName(t.light&&t.light.afterInjectedText),o=this.getCSSTextForModelDecorationContentClassName(t.dark&&t.dark.afterInjectedText);break;default:throw new Error("Unknown rule type: "+this._ruleType)}const r=this._providerArgs.styleSheet;let n=!1;e.length>0&&(r.insertRule(this._unThemedSelector,e),n=!0),i.length>0&&(r.insertRule(`.vs${this._unThemedSelector}, .hc-light${this._unThemedSelector}`,i),n=!0),o.length>0&&(r.insertRule(`.vs-dark${this._unThemedSelector}, .hc-black${this._unThemedSelector}`,o),n=!0),this._hasContent=n}_removeCSS(){this._providerArgs.styleSheet.removeRulesContainingSelector(this._unThemedSelector)}getCSSTextForModelDecorationClassName(t){if(!t)return"";const e=[];return this.collectCSSText(t,["backgroundColor"],e),this.collectCSSText(t,["outline","outlineColor","outlineStyle","outlineWidth"],e),this.collectBorderSettingsCSSText(t,e),e.join("")}getCSSTextForModelDecorationInlineClassName(t){if(!t)return"";const e=[];return this.collectCSSText(t,["fontStyle","fontWeight","textDecoration","cursor","color","opacity","letterSpacing"],e),t.letterSpacing&&(this._hasLetterSpacing=!0),e.join("")}getCSSTextForModelDecorationContentClassName(t){if(!t)return"";const e=[];if(typeof t<"u"){if(this.collectBorderSettingsCSSText(t,e),typeof t.contentIconPath<"u"&&e.push(p.format(C.contentIconPath,c.asCSSUrl(b.revive(t.contentIconPath)))),typeof t.contentText=="string"){const o=t.contentText.match(/^.*$/m)[0].replace(/['\\]/g,"\\$&");e.push(p.format(C.contentText,o))}this.collectCSSText(t,["verticalAlign","fontStyle","fontWeight","fontSize","fontFamily","textDecoration","color","opacity","backgroundColor","margin","padding"],e),this.collectCSSText(t,["width","height"],e)&&e.push("display:inline-block;")}return e.join("")}getCSSTextForModelDecorationGlyphMarginClassName(t){if(!t)return"";const e=[];return typeof t.gutterIconPath<"u"&&(e.push(p.format(C.gutterIconPath,c.asCSSUrl(b.revive(t.gutterIconPath)))),typeof t.gutterIconSize<"u"&&e.push(p.format(C.gutterIconSize,t.gutterIconSize))),e.join("")}collectBorderSettingsCSSText(t,e){return this.collectCSSText(t,["border","borderColor","borderRadius","borderSpacing","borderStyle","borderWidth"],e)?(e.push(p.format("box-sizing: border-box;")),!0):!1}collectCSSText(t,e,i){const o=i.length;for(const r of e){const n=this.resolveValue(t[r]);typeof n=="string"&&i.push(p.format(C[r],n))}return i.length!==o}resolveValue(t){if(x(t)){this._usesThemeColors=!0;const e=this._theme.getColor(t.id);return e?e.toString():"transparent"}return t}}var L=(s=>(s[s.ClassName=0]="ClassName",s[s.InlineClassName=1]="InlineClassName",s[s.GlyphMarginClassName=2]="GlyphMarginClassName",s[s.BeforeContentClassName=3]="BeforeContentClassName",s[s.AfterContentClassName=4]="AfterContentClassName",s[s.BeforeInjectedTextClassName=5]="BeforeInjectedTextClassName",s[s.AfterInjectedTextClassName=6]="AfterInjectedTextClassName",s))(L||{});class y{static getClassName(t,e){return"ced-"+t+"-"+e}static getSelector(t,e,i){let o=".monaco-editor ."+this.getClassName(t,i);return e&&(o=o+"."+this.getClassName(e,i)),i===3?o+="::before":i===4&&(o+="::after"),o}}export{f as AbstractCodeEditorService,P as GlobalStyleSheet,w as ModelTransientSettingWatcher,C as _CSS_MAP};
