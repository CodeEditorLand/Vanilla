var D=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var b=(a,o,e,t)=>{for(var i=t>1?void 0:t?L(o,e):o,r=a.length-1,n;r>=0;r--)(n=a[r])&&(i=(t?n(o,e,i):n(i))||i);return t&&i&&D(o,e,i),i},W=(a,o)=>(e,t)=>o(e,t,a);import*as N from"../../base/browser/dom.js";import{createFastDomNode as _}from"../../base/browser/fastDomNode.js";import{inputLatency as M}from"../../base/browser/performance.js";import{BugIndicatingError as c,onUnexpectedError as E}from"../../base/common/errors.js";import{IInstantiationService as I}from"../../platform/instantiation/common/instantiation.js";import{getThemeTypeSelector as G}from"../../platform/theme/common/themeService.js";import{EditorOption as u}from"../common/config/editorOptions.js";import{Position as P}from"../common/core/position.js";import{Range as V}from"../common/core/range.js";import{Selection as O}from"../common/core/selection.js";import{ScrollType as T}from"../common/editorCommon.js";import{GlyphMarginLane as A}from"../common/model.js";import{ViewEventHandler as S}from"../common/viewEventHandler.js";import{ViewportData as F}from"../common/viewLayout/viewLinesViewportData.js";import{ViewContext as H}from"../common/viewModel/viewContext.js";import{NativeEditContext as Z}from"./controller/editContext/native/nativeEditContext.js";import{TextAreaEditContext as j}from"./controller/editContext/textArea/textAreaEditContext.js";import{PointerHandlerLastRenderData as B}from"./controller/mouseTarget.js";import{PointerHandler as U}from"./controller/pointerHandler.js";import{ViewGpuContext as k}from"./gpu/viewGpuContext.js";import{RenderingContext as q}from"./view/renderingContext.js";import{ViewController as z}from"./view/viewController.js";import{ContentViewOverlays as J,MarginViewOverlays as K}from"./view/viewOverlays.js";import{PartFingerprint as Q,PartFingerprints as X}from"./view/viewPart.js";import{ViewUserInputEvents as Y}from"./view/viewUserInputEvents.js";import{BlockDecorations as $}from"./viewParts/blockDecorations/blockDecorations.js";import{ViewContentWidgets as ee}from"./viewParts/contentWidgets/contentWidgets.js";import{CurrentLineHighlightOverlay as te,CurrentLineMarginHighlightOverlay as ie}from"./viewParts/currentLineHighlight/currentLineHighlight.js";import{DecorationsOverlay as ne}from"./viewParts/decorations/decorations.js";import{EditorScrollbar as oe}from"./viewParts/editorScrollbar/editorScrollbar.js";import{GlyphMarginWidgets as re}from"./viewParts/glyphMargin/glyphMargin.js";import{IndentGuidesOverlay as se}from"./viewParts/indentGuides/indentGuides.js";import{LineNumbersOverlay as de}from"./viewParts/lineNumbers/lineNumbers.js";import{ViewLines as ae}from"./viewParts/lines/viewLines.js";import{LinesDecorationsOverlay as le}from"./viewParts/linesDecorations/linesDecorations.js";import{ViewLinesGpu as he}from"./viewParts/linesGpu/viewLinesGpu.js";import{Margin as pe}from"./viewParts/margin/margin.js";import{MarginViewLineDecorationsOverlay as ce}from"./viewParts/marginDecorations/marginDecorations.js";import{Minimap as ue}from"./viewParts/minimap/minimap.js";import{ViewOverlayWidgets as me}from"./viewParts/overlayWidgets/overlayWidgets.js";import{DecorationsOverviewRuler as ve}from"./viewParts/overviewRuler/decorationsOverviewRuler.js";import{OverviewRuler as ge}from"./viewParts/overviewRuler/overviewRuler.js";import{Rulers as _e}from"./viewParts/rulers/rulers.js";import{ScrollDecorationViewPart as we}from"./viewParts/scrollDecoration/scrollDecoration.js";import{SelectionsOverlay as Ce}from"./viewParts/selections/selections.js";import{ViewCursors as fe}from"./viewParts/viewCursors/viewCursors.js";import{ViewZones as ye}from"./viewParts/viewZones/viewZones.js";import{WhitespaceOverlay as xe}from"./viewParts/whitespace/whitespace.js";let v=class extends S{constructor(e,t,i,r,n,s,m){super();this._instantiationService=m;this._selections=[new O(1,1,1,1)],this._renderAnimationFrame=null,this._viewController=new z(t,r,n,e),this._context=new H(t,i,r),this._context.addEventHandler(this),this._viewParts=[],this._experimentalEditContextEnabled=this._context.configuration.options.get(u.experimentalEditContextEnabled),this._editContext=this._instantiateEditContext(this._experimentalEditContextEnabled),this._viewParts.push(this._editContext),this._linesContent=_(document.createElement("div")),this._linesContent.setClassName("lines-content monaco-editor-background"),this._linesContent.setPosition("absolute"),this.domNode=_(document.createElement("div")),this.domNode.setClassName(this._getEditorClassName()),this.domNode.setAttribute("role","code"),this._context.configuration.options.get(u.experimentalGpuAcceleration)==="on"&&(this._viewGpuContext=new k),this._overflowGuardContainer=_(document.createElement("div")),X.write(this._overflowGuardContainer,Q.OverflowGuard),this._overflowGuardContainer.setClassName("overflow-guard"),this._scrollbar=new oe(this._context,this._linesContent,this.domNode,this._overflowGuardContainer),this._viewParts.push(this._scrollbar),this._viewLines=new ae(this._context,this._linesContent),this._viewGpuContext&&(this._viewLinesGpu=this._instantiationService.createInstance(he,this._context,this._viewGpuContext)),this._viewZones=new ye(this._context),this._viewParts.push(this._viewZones);const g=new ve(this._context);this._viewParts.push(g);const C=new we(this._context);this._viewParts.push(C);const l=new J(this._context);this._viewParts.push(l),l.addDynamicOverlay(new te(this._context)),l.addDynamicOverlay(new Ce(this._context)),l.addDynamicOverlay(new se(this._context)),l.addDynamicOverlay(new ne(this._context)),l.addDynamicOverlay(new xe(this._context));const h=new K(this._context);this._viewParts.push(h),h.addDynamicOverlay(new ie(this._context)),h.addDynamicOverlay(new ce(this._context)),h.addDynamicOverlay(new le(this._context)),h.addDynamicOverlay(new de(this._context)),this._glyphMarginWidgets=new re(this._context),this._viewParts.push(this._glyphMarginWidgets);const p=new pe(this._context);p.getDomNode().appendChild(this._viewZones.marginDomNode),p.getDomNode().appendChild(h.getDomNode()),p.getDomNode().appendChild(this._glyphMarginWidgets.domNode),this._viewParts.push(p),this._contentWidgets=new ee(this._context,this.domNode),this._viewParts.push(this._contentWidgets),this._viewCursors=new fe(this._context),this._viewParts.push(this._viewCursors),this._overlayWidgets=new me(this._context,this.domNode),this._viewParts.push(this._overlayWidgets);const f=new _e(this._context);this._viewParts.push(f);const y=new $(this._context);this._viewParts.push(y);const x=new ue(this._context);if(this._viewParts.push(x),g){const R=this._scrollbar.getOverviewRulerLayoutInfo();R.parent.insertBefore(g.getDomNode(),R.insertBefore)}this._linesContent.appendChild(l.getDomNode()),this._linesContent.appendChild(f.domNode),this._linesContent.appendChild(this._viewZones.domNode),this._linesContent.appendChild(this._viewLines.getDomNode()),this._linesContent.appendChild(this._contentWidgets.domNode),this._linesContent.appendChild(this._viewCursors.getDomNode()),this._overflowGuardContainer.appendChild(p.getDomNode()),this._overflowGuardContainer.appendChild(this._scrollbar.getDomNode()),this._viewGpuContext&&this._overflowGuardContainer.appendChild(this._viewGpuContext.canvas),this._overflowGuardContainer.appendChild(C.getDomNode()),this._editContext.appendTo(this._overflowGuardContainer),this._overflowGuardContainer.appendChild(this._overlayWidgets.getDomNode()),this._overflowGuardContainer.appendChild(x.getDomNode()),this._overflowGuardContainer.appendChild(y.domNode),this.domNode.appendChild(this._overflowGuardContainer),s?(s.appendChild(this._contentWidgets.overflowingContentWidgetsDomNode.domNode),s.appendChild(this._overlayWidgets.overflowingOverlayWidgetsDomNode.domNode)):(this.domNode.appendChild(this._contentWidgets.overflowingContentWidgetsDomNode),this.domNode.appendChild(this._overlayWidgets.overflowingOverlayWidgetsDomNode)),this._applyLayout(),this._pointerHandler=this._register(new U(this._context,this._viewController,this._createPointerHandlerHelper()))}_scrollbar;_context;_viewGpuContext;_selections;_viewLines;_viewLinesGpu;_viewZones;_contentWidgets;_overlayWidgets;_glyphMarginWidgets;_viewCursors;_viewParts;_viewController;_experimentalEditContextEnabled;_editContext;_pointerHandler;_linesContent;domNode;_overflowGuardContainer;_shouldRecomputeGlyphMarginLanes=!1;_renderAnimationFrame;_instantiateEditContext(e){return e?this._instantiationService.createInstance(Z,this._context,this._viewController):this._instantiationService.createInstance(j,this._context,this._viewController,this._createTextAreaHandlerHelper())}_updateEditContext(){const e=this._context.configuration.options.get(u.experimentalEditContextEnabled);if(this._experimentalEditContextEnabled===e)return;this._experimentalEditContextEnabled=e,this._editContext.dispose(),this._editContext=this._instantiateEditContext(e),this._editContext.appendTo(this._overflowGuardContainer);const t=this._viewParts.indexOf(this._editContext);t!==-1&&this._viewParts.splice(t,1,this._editContext)}_computeGlyphMarginLanes(){const e=this._context.viewModel.model,t=this._context.viewModel.glyphLanes;let i=[],r=0;i=i.concat(e.getAllMarginDecorations().map(n=>{const s=n.options.glyphMargin?.position??A.Center;return r=Math.max(r,n.range.endLineNumber),{range:n.range,lane:s,persist:n.options.glyphMargin?.persistLane}})),i=i.concat(this._glyphMarginWidgets.getWidgets().map(n=>{const s=e.validateRange(n.preference.range);return r=Math.max(r,s.endLineNumber),{range:s,lane:n.preference.lane}})),i.sort((n,s)=>V.compareRangesUsingStarts(n.range,s.range)),t.reset(r);for(const n of i)t.push(n.lane,n.range,n.persist);return t}_createPointerHandlerHelper(){return{viewDomNode:this.domNode.domNode,linesContentDomNode:this._linesContent.domNode,viewLinesDomNode:this._viewLines.getDomNode().domNode,focusTextArea:()=>{this.focus()},dispatchTextAreaEvent:e=>{this._editContext.domNode.domNode.dispatchEvent(e)},getLastRenderData:()=>{const e=this._viewCursors.getLastRenderData()||[],t=this._editContext.getLastRenderData();return new B(e,t)},renderNow:()=>{this.render(!0,!1)},shouldSuppressMouseDownOnViewZone:e=>this._viewZones.shouldSuppressMouseDownOnViewZone(e),shouldSuppressMouseDownOnWidget:e=>this._contentWidgets.shouldSuppressMouseDownOnWidget(e),getPositionFromDOMInfo:(e,t)=>(this._flushAccumulatedAndRenderNow(),this._viewLines.getPositionFromDOMInfo(e,t)),visibleRangeForPosition:(e,t)=>(this._flushAccumulatedAndRenderNow(),this._viewLines.visibleRangeForPosition(new P(e,t))),getLineWidth:e=>(this._flushAccumulatedAndRenderNow(),this._viewLines.getLineWidth(e))}}_createTextAreaHandlerHelper(){return{visibleRangeForPosition:e=>(this._flushAccumulatedAndRenderNow(),this._viewLines.visibleRangeForPosition(e))}}_applyLayout(){const t=this._context.configuration.options.get(u.layoutInfo);this.domNode.setWidth(t.width),this.domNode.setHeight(t.height),this._overflowGuardContainer.setWidth(t.width),this._overflowGuardContainer.setHeight(t.height),this._linesContent.setWidth(16777216),this._linesContent.setHeight(16777216)}_getEditorClassName(){const e=this._editContext.isFocused()?" focused":"";return this._context.configuration.options.get(u.editorClassName)+" "+G(this._context.theme.type)+e}handleEvents(e){super.handleEvents(e),this._scheduleRender()}onConfigurationChanged(e){return this.domNode.setClassName(this._getEditorClassName()),this._updateEditContext(),this._applyLayout(),!1}onCursorStateChanged(e){return this._selections=e.selections,!1}onDecorationsChanged(e){return e.affectsGlyphMargin&&(this._shouldRecomputeGlyphMarginLanes=!0),!1}onFocusChanged(e){return this.domNode.setClassName(this._getEditorClassName()),!1}onThemeChanged(e){return this._context.theme.update(e.theme),this.domNode.setClassName(this._getEditorClassName()),!1}dispose(){this._renderAnimationFrame!==null&&(this._renderAnimationFrame.dispose(),this._renderAnimationFrame=null),this._contentWidgets.overflowingContentWidgetsDomNode.domNode.remove(),this._context.removeEventHandler(this),this._viewGpuContext?.dispose(),this._viewLines.dispose(),this._viewLinesGpu?.dispose();for(const e of this._viewParts)e.dispose();super.dispose()}_scheduleRender(){if(this._store.isDisposed)throw new c;if(this._renderAnimationFrame===null){const e=this._createCoordinatedRendering();this._renderAnimationFrame=w.INSTANCE.scheduleCoordinatedRendering({window:N.getWindow(this.domNode?.domNode),prepareRenderText:()=>{if(this._store.isDisposed)throw new c;try{return e.prepareRenderText()}finally{this._renderAnimationFrame=null}},renderText:()=>{if(this._store.isDisposed)throw new c;return e.renderText()},prepareRender:(t,i)=>{if(this._store.isDisposed)throw new c;return e.prepareRender(t,i)},render:(t,i)=>{if(this._store.isDisposed)throw new c;return e.render(t,i)}})}}_flushAccumulatedAndRenderNow(){const e=this._createCoordinatedRendering();d(()=>e.prepareRenderText());const t=d(()=>e.renderText());if(t){const[i,r]=t;d(()=>e.prepareRender(i,r)),d(()=>e.render(i,r))}}_getViewPartsToRender(){const e=[];let t=0;for(const i of this._viewParts)i.shouldRender()&&(e[t++]=i);return e}_createCoordinatedRendering(){return{prepareRenderText:()=>{if(this._shouldRecomputeGlyphMarginLanes){this._shouldRecomputeGlyphMarginLanes=!1;const e=this._computeGlyphMarginLanes();this._context.configuration.setGlyphMarginDecorationLaneCount(e.requiredLanes)}M.onRenderStart()},renderText:()=>{if(!this.domNode.domNode.isConnected)return null;let e=this._getViewPartsToRender();if(!this._viewLines.shouldRender()&&e.length===0)return null;const t=this._context.viewLayout.getLinesViewportData();this._context.viewModel.setViewport(t.startLineNumber,t.endLineNumber,t.centeredLineNumber);const i=new F(this._selections,t,this._context.viewLayout.getWhitespaceViewportData(),this._context.viewModel);return this._contentWidgets.shouldRender()&&this._contentWidgets.onBeforeRender(i),this._viewLines.shouldRender()&&(this._viewLines.renderText(i),this._viewLines.onDidRender(),e=this._getViewPartsToRender()),this._viewLinesGpu?.shouldRender()&&(this._viewLinesGpu.renderText(i),this._viewLinesGpu.onDidRender()),[e,new q(this._context.viewLayout,i,this._viewLines)]},prepareRender:(e,t)=>{for(const i of e)i.prepareRender(t)},render:(e,t)=>{for(const i of e)i.render(t),i.onDidRender()}}}delegateVerticalScrollbarPointerDown(e){this._scrollbar.delegateVerticalScrollbarPointerDown(e)}delegateScrollFromMouseWheelEvent(e){this._scrollbar.delegateScrollFromMouseWheelEvent(e)}restoreState(e){this._context.viewModel.viewLayout.setScrollPosition({scrollTop:e.scrollTop,scrollLeft:e.scrollLeft},T.Immediate),this._context.viewModel.visibleLinesStabilized()}getOffsetForColumn(e,t){const i=this._context.viewModel.model.validatePosition({lineNumber:e,column:t}),r=this._context.viewModel.coordinatesConverter.convertModelPositionToViewPosition(i);this._flushAccumulatedAndRenderNow();const n=this._viewLines.visibleRangeForPosition(new P(r.lineNumber,r.column));return n?n.left:-1}getTargetAtClientPoint(e,t){const i=this._pointerHandler.getTargetAtClientPoint(e,t);return i?Y.convertViewToModelMouseTarget(i,this._context.viewModel.coordinatesConverter):null}createOverviewRuler(e){return new ge(this._context,e)}change(e){this._viewZones.changeViewZones(e),this._scheduleRender()}render(e,t){if(t){this._viewLines.forceShouldRender();for(const i of this._viewParts)i.forceShouldRender()}e?this._flushAccumulatedAndRenderNow():this._scheduleRender()}writeScreenReaderContent(e){this._editContext.writeScreenReaderContent(e)}focus(){this._editContext.focus()}isFocused(){return this._editContext.isFocused()}refreshFocusState(){this._editContext.refreshFocusState()}setAriaOptions(e){this._editContext.setAriaOptions(e)}addContentWidget(e){this._contentWidgets.addWidget(e.widget),this.layoutContentWidget(e),this._scheduleRender()}layoutContentWidget(e){this._contentWidgets.setWidgetPosition(e.widget,e.position?.position??null,e.position?.secondaryPosition??null,e.position?.preference??null,e.position?.positionAffinity??null),this._scheduleRender()}removeContentWidget(e){this._contentWidgets.removeWidget(e.widget),this._scheduleRender()}addOverlayWidget(e){this._overlayWidgets.addWidget(e.widget),this.layoutOverlayWidget(e),this._scheduleRender()}layoutOverlayWidget(e){this._overlayWidgets.setWidgetPosition(e.widget,e.position)&&this._scheduleRender()}removeOverlayWidget(e){this._overlayWidgets.removeWidget(e.widget),this._scheduleRender()}addGlyphMarginWidget(e){this._glyphMarginWidgets.addWidget(e.widget),this._shouldRecomputeGlyphMarginLanes=!0,this._scheduleRender()}layoutGlyphMarginWidget(e){const t=e.position;this._glyphMarginWidgets.setWidgetPosition(e.widget,t)&&(this._shouldRecomputeGlyphMarginLanes=!0,this._scheduleRender())}removeGlyphMarginWidget(e){this._glyphMarginWidgets.removeWidget(e.widget),this._shouldRecomputeGlyphMarginLanes=!0,this._scheduleRender()}};v=b([W(6,I)],v);function d(a){try{return a()}catch(o){return E(o),null}}class w{static INSTANCE=new w;_coordinatedRenderings=[];_animationFrameRunners=new Map;constructor(){}scheduleCoordinatedRendering(o){return this._coordinatedRenderings.push(o),this._scheduleRender(o.window),{dispose:()=>{const e=this._coordinatedRenderings.indexOf(o);if(e!==-1&&(this._coordinatedRenderings.splice(e,1),this._coordinatedRenderings.length===0)){for(const[t,i]of this._animationFrameRunners)i.dispose();this._animationFrameRunners.clear()}}}}_scheduleRender(o){if(!this._animationFrameRunners.has(o)){const e=()=>{this._animationFrameRunners.delete(o),this._onRenderScheduled()};this._animationFrameRunners.set(o,N.runAtThisOrScheduleAtNextAnimationFrame(o,e,100))}}_onRenderScheduled(){const o=this._coordinatedRenderings.slice(0);this._coordinatedRenderings=[];for(const t of o)d(()=>t.prepareRenderText());const e=[];for(let t=0,i=o.length;t<i;t++){const r=o[t];e[t]=d(()=>r.renderText())}for(let t=0,i=o.length;t<i;t++){const r=o[t],n=e[t];if(!n)continue;const[s,m]=n;d(()=>r.prepareRender(s,m))}for(let t=0,i=o.length;t<i;t++){const r=o[t],n=e[t];if(!n)continue;const[s,m]=n;d(()=>r.render(s,m))}}}export{v as View};
