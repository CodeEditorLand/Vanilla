var L=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var b=(a,o,e,t)=>{for(var i=t>1?void 0:t?I(o,e):o,r=a.length-1,n;r>=0;r--)(n=a[r])&&(i=(t?n(o,e,i):n(i))||i);return t&&i&&L(o,e,i),i},N=(a,o)=>(e,t)=>o(e,t,a);import*as P from"../../base/browser/dom.js";import{createFastDomNode as _}from"../../base/browser/fastDomNode.js";import"../../base/browser/mouseEvent.js";import{inputLatency as O}from"../../base/browser/performance.js";import"../../base/browser/window.js";import{BugIndicatingError as p,onUnexpectedError as V}from"../../base/common/errors.js";import"../../base/common/lifecycle.js";import"./controller/mouseHandler.js";import{PointerHandlerLastRenderData as E}from"./controller/mouseTarget.js";import{PointerHandler as T}from"./controller/pointerHandler.js";import"./editorBrowser.js";import{RenderingContext as A}from"./view/renderingContext.js";import{ViewController as G}from"./view/viewController.js";import{ContentViewOverlays as F,MarginViewOverlays as S}from"./view/viewOverlays.js";import{PartFingerprint as H,PartFingerprints as Z}from"./view/viewPart.js";import{ViewUserInputEvents as B}from"./view/viewUserInputEvents.js";import{BlockDecorations as k}from"./viewParts/blockDecorations/blockDecorations.js";import{ViewContentWidgets as U}from"./viewParts/contentWidgets/contentWidgets.js";import{CurrentLineHighlightOverlay as q,CurrentLineMarginHighlightOverlay as z}from"./viewParts/currentLineHighlight/currentLineHighlight.js";import{DecorationsOverlay as j}from"./viewParts/decorations/decorations.js";import{EditorScrollbar as J}from"./viewParts/editorScrollbar/editorScrollbar.js";import{GlyphMarginWidgets as K}from"./viewParts/glyphMargin/glyphMargin.js";import{IndentGuidesOverlay as Q}from"./viewParts/indentGuides/indentGuides.js";import{LineNumbersOverlay as X}from"./viewParts/lineNumbers/lineNumbers.js";import{ViewLines as Y}from"./viewParts/lines/viewLines.js";import{LinesDecorationsOverlay as $}from"./viewParts/linesDecorations/linesDecorations.js";import{Margin as ee}from"./viewParts/margin/margin.js";import{MarginViewLineDecorationsOverlay as te}from"./viewParts/marginDecorations/marginDecorations.js";import{Minimap as ie}from"./viewParts/minimap/minimap.js";import{ViewOverlayWidgets as ne}from"./viewParts/overlayWidgets/overlayWidgets.js";import{DecorationsOverviewRuler as oe}from"./viewParts/overviewRuler/decorationsOverviewRuler.js";import{OverviewRuler as re}from"./viewParts/overviewRuler/overviewRuler.js";import{Rulers as se}from"./viewParts/rulers/rulers.js";import{ScrollDecorationViewPart as de}from"./viewParts/scrollDecoration/scrollDecoration.js";import{SelectionsOverlay as ae}from"./viewParts/selections/selections.js";import{ViewCursors as le}from"./viewParts/viewCursors/viewCursors.js";import{ViewZones as he}from"./viewParts/viewZones/viewZones.js";import{WhitespaceOverlay as ce}from"./viewParts/whitespace/whitespace.js";import"../common/config/editorConfiguration.js";import{EditorOption as w}from"../common/config/editorOptions.js";import{Position as D}from"../common/core/position.js";import{Range as pe}from"../common/core/range.js";import{Selection as ue}from"../common/core/selection.js";import{ScrollType as me}from"../common/editorCommon.js";import{GlyphMarginLane as ge}from"../common/model.js";import{ViewEventHandler as ve}from"../common/viewEventHandler.js";import"../common/viewEvents.js";import{ViewportData as _e}from"../common/viewLayout/viewLinesViewportData.js";import"../common/viewModel.js";import{ViewContext as we}from"../common/viewModel/viewContext.js";import{IInstantiationService as fe}from"../../platform/instantiation/common/instantiation.js";import{getThemeTypeSelector as Ce}from"../../platform/theme/common/themeService.js";import"./controller/editContext/editContextUtils.js";import{TextAreaEditContext as ye}from"./controller/editContext/textArea/textAreaEditContext.js";import{NativeEditContext as Re}from"./controller/editContext/native/nativeEditContext.js";let m=class extends ve{constructor(e,t,i,r,n,s,u){super();this._instantiationService=u;this._selections=[new ue(1,1,1,1)],this._renderAnimationFrame=null;const g=new G(t,r,n,e);this._context=new we(t,i,r),this._context.addEventHandler(this),this._viewParts=[];const M=this._context.configuration.options.get(w.experimentalEditContextEnabled);this._editContext=M?this._instantiationService.createInstance(Re,this._context,g):this._instantiationService.createInstance(ye,this._context,g,this._createTextAreaHandlerHelper()),this._viewParts.push(this._editContext),this._linesContent=_(document.createElement("div")),this._linesContent.setClassName("lines-content monaco-editor-background"),this._linesContent.setPosition("absolute"),this.domNode=_(document.createElement("div")),this.domNode.setClassName(this._getEditorClassName()),this.domNode.setAttribute("role","code"),this._overflowGuardContainer=_(document.createElement("div")),Z.write(this._overflowGuardContainer,H.OverflowGuard),this._overflowGuardContainer.setClassName("overflow-guard"),this._scrollbar=new J(this._context,this._linesContent,this.domNode,this._overflowGuardContainer),this._viewParts.push(this._scrollbar),this._viewLines=new Y(this._context,this._linesContent),this._viewZones=new he(this._context),this._viewParts.push(this._viewZones);const v=new oe(this._context);this._viewParts.push(v);const C=new de(this._context);this._viewParts.push(C);const l=new F(this._context);this._viewParts.push(l),l.addDynamicOverlay(new q(this._context)),l.addDynamicOverlay(new ae(this._context)),l.addDynamicOverlay(new Q(this._context)),l.addDynamicOverlay(new j(this._context)),l.addDynamicOverlay(new ce(this._context));const h=new S(this._context);this._viewParts.push(h),h.addDynamicOverlay(new z(this._context)),h.addDynamicOverlay(new te(this._context)),h.addDynamicOverlay(new $(this._context)),h.addDynamicOverlay(new X(this._context)),this._glyphMarginWidgets=new K(this._context),this._viewParts.push(this._glyphMarginWidgets);const c=new ee(this._context);c.getDomNode().appendChild(this._viewZones.marginDomNode),c.getDomNode().appendChild(h.getDomNode()),c.getDomNode().appendChild(this._glyphMarginWidgets.domNode),this._viewParts.push(c),this._contentWidgets=new U(this._context,this.domNode),this._viewParts.push(this._contentWidgets),this._viewCursors=new le(this._context),this._viewParts.push(this._viewCursors),this._overlayWidgets=new ne(this._context,this.domNode),this._viewParts.push(this._overlayWidgets);const y=new se(this._context);this._viewParts.push(y);const R=new k(this._context);this._viewParts.push(R);const x=new ie(this._context);if(this._viewParts.push(x),v){const W=this._scrollbar.getOverviewRulerLayoutInfo();W.parent.insertBefore(v.getDomNode(),W.insertBefore)}this._linesContent.appendChild(l.getDomNode()),this._linesContent.appendChild(y.domNode),this._linesContent.appendChild(this._viewZones.domNode),this._linesContent.appendChild(this._viewLines.getDomNode()),this._linesContent.appendChild(this._contentWidgets.domNode),this._linesContent.appendChild(this._viewCursors.getDomNode()),this._overflowGuardContainer.appendChild(c.getDomNode()),this._overflowGuardContainer.appendChild(this._scrollbar.getDomNode()),this._overflowGuardContainer.appendChild(C.getDomNode()),this._editContext.appendTo(this._overflowGuardContainer),this._overflowGuardContainer.appendChild(this._overlayWidgets.getDomNode()),this._overflowGuardContainer.appendChild(x.getDomNode()),this._overflowGuardContainer.appendChild(R.domNode),this.domNode.appendChild(this._overflowGuardContainer),s?(s.appendChild(this._contentWidgets.overflowingContentWidgetsDomNode.domNode),s.appendChild(this._overlayWidgets.overflowingOverlayWidgetsDomNode.domNode)):(this.domNode.appendChild(this._contentWidgets.overflowingContentWidgetsDomNode),this.domNode.appendChild(this._overlayWidgets.overflowingOverlayWidgetsDomNode)),this._applyLayout(),this._pointerHandler=this._register(new T(this._context,g,this._createPointerHandlerHelper()))}_scrollbar;_context;_selections;_viewLines;_viewZones;_contentWidgets;_overlayWidgets;_glyphMarginWidgets;_viewCursors;_viewParts;_editContext;_pointerHandler;_linesContent;domNode;_overflowGuardContainer;_shouldRecomputeGlyphMarginLanes=!1;_renderAnimationFrame;_computeGlyphMarginLanes(){const e=this._context.viewModel.model,t=this._context.viewModel.glyphLanes;let i=[],r=0;i=i.concat(e.getAllMarginDecorations().map(n=>{const s=n.options.glyphMargin?.position??ge.Center;return r=Math.max(r,n.range.endLineNumber),{range:n.range,lane:s,persist:n.options.glyphMargin?.persistLane}})),i=i.concat(this._glyphMarginWidgets.getWidgets().map(n=>{const s=e.validateRange(n.preference.range);return r=Math.max(r,s.endLineNumber),{range:s,lane:n.preference.lane}})),i.sort((n,s)=>pe.compareRangesUsingStarts(n.range,s.range)),t.reset(r);for(const n of i)t.push(n.lane,n.range,n.persist);return t}_createPointerHandlerHelper(){return{viewDomNode:this.domNode.domNode,linesContentDomNode:this._linesContent.domNode,viewLinesDomNode:this._viewLines.getDomNode().domNode,focusTextArea:()=>{this.focus()},dispatchTextAreaEvent:e=>{this._editContext.domNode.domNode.dispatchEvent(e)},getLastRenderData:()=>{const e=this._viewCursors.getLastRenderData()||[],t=this._editContext.getLastRenderData();return new E(e,t)},renderNow:()=>{this.render(!0,!1)},shouldSuppressMouseDownOnViewZone:e=>this._viewZones.shouldSuppressMouseDownOnViewZone(e),shouldSuppressMouseDownOnWidget:e=>this._contentWidgets.shouldSuppressMouseDownOnWidget(e),getPositionFromDOMInfo:(e,t)=>(this._flushAccumulatedAndRenderNow(),this._viewLines.getPositionFromDOMInfo(e,t)),visibleRangeForPosition:(e,t)=>(this._flushAccumulatedAndRenderNow(),this._viewLines.visibleRangeForPosition(new D(e,t))),getLineWidth:e=>(this._flushAccumulatedAndRenderNow(),this._viewLines.getLineWidth(e))}}_createTextAreaHandlerHelper(){return{visibleRangeForPosition:e=>(this._flushAccumulatedAndRenderNow(),this._viewLines.visibleRangeForPosition(e))}}_applyLayout(){const t=this._context.configuration.options.get(w.layoutInfo);this.domNode.setWidth(t.width),this.domNode.setHeight(t.height),this._overflowGuardContainer.setWidth(t.width),this._overflowGuardContainer.setHeight(t.height),this._linesContent.setWidth(16777216),this._linesContent.setHeight(16777216)}_getEditorClassName(){const e=this._editContext.isFocused()?" focused":"";return this._context.configuration.options.get(w.editorClassName)+" "+Ce(this._context.theme.type)+e}handleEvents(e){super.handleEvents(e),this._scheduleRender()}onConfigurationChanged(e){return this.domNode.setClassName(this._getEditorClassName()),this._applyLayout(),!1}onCursorStateChanged(e){return this._selections=e.selections,!1}onDecorationsChanged(e){return e.affectsGlyphMargin&&(this._shouldRecomputeGlyphMarginLanes=!0),!1}onFocusChanged(e){return this.domNode.setClassName(this._getEditorClassName()),!1}onThemeChanged(e){return this._context.theme.update(e.theme),this.domNode.setClassName(this._getEditorClassName()),!1}dispose(){this._renderAnimationFrame!==null&&(this._renderAnimationFrame.dispose(),this._renderAnimationFrame=null),this._contentWidgets.overflowingContentWidgetsDomNode.domNode.remove(),this._context.removeEventHandler(this),this._viewLines.dispose();for(const e of this._viewParts)e.dispose();super.dispose()}_scheduleRender(){if(this._store.isDisposed)throw new p;if(this._renderAnimationFrame===null){const e=this._createCoordinatedRendering();this._renderAnimationFrame=f.INSTANCE.scheduleCoordinatedRendering({window:P.getWindow(this.domNode?.domNode),prepareRenderText:()=>{if(this._store.isDisposed)throw new p;try{return e.prepareRenderText()}finally{this._renderAnimationFrame=null}},renderText:()=>{if(this._store.isDisposed)throw new p;return e.renderText()},prepareRender:(t,i)=>{if(this._store.isDisposed)throw new p;return e.prepareRender(t,i)},render:(t,i)=>{if(this._store.isDisposed)throw new p;return e.render(t,i)}})}}_flushAccumulatedAndRenderNow(){const e=this._createCoordinatedRendering();d(()=>e.prepareRenderText());const t=d(()=>e.renderText());if(t){const[i,r]=t;d(()=>e.prepareRender(i,r)),d(()=>e.render(i,r))}}_getViewPartsToRender(){const e=[];let t=0;for(const i of this._viewParts)i.shouldRender()&&(e[t++]=i);return e}_createCoordinatedRendering(){return{prepareRenderText:()=>{if(this._shouldRecomputeGlyphMarginLanes){this._shouldRecomputeGlyphMarginLanes=!1;const e=this._computeGlyphMarginLanes();this._context.configuration.setGlyphMarginDecorationLaneCount(e.requiredLanes)}O.onRenderStart()},renderText:()=>{if(!this.domNode.domNode.isConnected)return null;let e=this._getViewPartsToRender();if(!this._viewLines.shouldRender()&&e.length===0)return null;const t=this._context.viewLayout.getLinesViewportData();this._context.viewModel.setViewport(t.startLineNumber,t.endLineNumber,t.centeredLineNumber);const i=new _e(this._selections,t,this._context.viewLayout.getWhitespaceViewportData(),this._context.viewModel);return this._contentWidgets.shouldRender()&&this._contentWidgets.onBeforeRender(i),this._viewLines.shouldRender()&&(this._viewLines.renderText(i),this._viewLines.onDidRender(),e=this._getViewPartsToRender()),[e,new A(this._context.viewLayout,i,this._viewLines)]},prepareRender:(e,t)=>{for(const i of e)i.prepareRender(t)},render:(e,t)=>{for(const i of e)i.render(t),i.onDidRender()}}}delegateVerticalScrollbarPointerDown(e){this._scrollbar.delegateVerticalScrollbarPointerDown(e)}delegateScrollFromMouseWheelEvent(e){this._scrollbar.delegateScrollFromMouseWheelEvent(e)}restoreState(e){this._context.viewModel.viewLayout.setScrollPosition({scrollTop:e.scrollTop,scrollLeft:e.scrollLeft},me.Immediate),this._context.viewModel.visibleLinesStabilized()}getOffsetForColumn(e,t){const i=this._context.viewModel.model.validatePosition({lineNumber:e,column:t}),r=this._context.viewModel.coordinatesConverter.convertModelPositionToViewPosition(i);this._flushAccumulatedAndRenderNow();const n=this._viewLines.visibleRangeForPosition(new D(r.lineNumber,r.column));return n?n.left:-1}getTargetAtClientPoint(e,t){const i=this._pointerHandler.getTargetAtClientPoint(e,t);return i?B.convertViewToModelMouseTarget(i,this._context.viewModel.coordinatesConverter):null}createOverviewRuler(e){return new re(this._context,e)}change(e){this._viewZones.changeViewZones(e),this._scheduleRender()}render(e,t){if(t){this._viewLines.forceShouldRender();for(const i of this._viewParts)i.forceShouldRender()}e?this._flushAccumulatedAndRenderNow():this._scheduleRender()}writeScreenReaderContent(e){this._editContext.writeScreenReaderContent(e)}focus(){this._editContext.focus()}isFocused(){return this._editContext.isFocused()}refreshFocusState(){this._editContext.refreshFocusState()}setAriaOptions(e){this._editContext.setAriaOptions(e)}addContentWidget(e){this._contentWidgets.addWidget(e.widget),this.layoutContentWidget(e),this._scheduleRender()}layoutContentWidget(e){this._contentWidgets.setWidgetPosition(e.widget,e.position?.position??null,e.position?.secondaryPosition??null,e.position?.preference??null,e.position?.positionAffinity??null),this._scheduleRender()}removeContentWidget(e){this._contentWidgets.removeWidget(e.widget),this._scheduleRender()}addOverlayWidget(e){this._overlayWidgets.addWidget(e.widget),this.layoutOverlayWidget(e),this._scheduleRender()}layoutOverlayWidget(e){this._overlayWidgets.setWidgetPosition(e.widget,e.position)&&this._scheduleRender()}removeOverlayWidget(e){this._overlayWidgets.removeWidget(e.widget),this._scheduleRender()}addGlyphMarginWidget(e){this._glyphMarginWidgets.addWidget(e.widget),this._shouldRecomputeGlyphMarginLanes=!0,this._scheduleRender()}layoutGlyphMarginWidget(e){const t=e.position;this._glyphMarginWidgets.setWidgetPosition(e.widget,t)&&(this._shouldRecomputeGlyphMarginLanes=!0,this._scheduleRender())}removeGlyphMarginWidget(e){this._glyphMarginWidgets.removeWidget(e.widget),this._shouldRecomputeGlyphMarginLanes=!0,this._scheduleRender()}};m=b([N(6,fe)],m);function d(a){try{return a()}catch(o){return V(o),null}}class f{static INSTANCE=new f;_coordinatedRenderings=[];_animationFrameRunners=new Map;constructor(){}scheduleCoordinatedRendering(o){return this._coordinatedRenderings.push(o),this._scheduleRender(o.window),{dispose:()=>{const e=this._coordinatedRenderings.indexOf(o);if(e!==-1&&(this._coordinatedRenderings.splice(e,1),this._coordinatedRenderings.length===0)){for(const[t,i]of this._animationFrameRunners)i.dispose();this._animationFrameRunners.clear()}}}}_scheduleRender(o){if(!this._animationFrameRunners.has(o)){const e=()=>{this._animationFrameRunners.delete(o),this._onRenderScheduled()};this._animationFrameRunners.set(o,P.runAtThisOrScheduleAtNextAnimationFrame(o,e,100))}}_onRenderScheduled(){const o=this._coordinatedRenderings.slice(0);this._coordinatedRenderings=[];for(const t of o)d(()=>t.prepareRenderText());const e=[];for(let t=0,i=o.length;t<i;t++){const r=o[t];e[t]=d(()=>r.renderText())}for(let t=0,i=o.length;t<i;t++){const r=o[t],n=e[t];if(!n)continue;const[s,u]=n;d(()=>r.prepareRender(s,u))}for(let t=0,i=o.length;t<i;t++){const r=o[t],n=e[t];if(!n)continue;const[s,u]=n;d(()=>r.render(s,u))}}}export{m as View};
