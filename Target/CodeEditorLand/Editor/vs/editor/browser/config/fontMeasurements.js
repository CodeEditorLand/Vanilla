import{getWindowId as U}from"../../../base/browser/dom.js";import{PixelRatio as m}from"../../../base/browser/pixelRatio.js";import{Emitter as D}from"../../../base/common/event.js";import{Disposable as A}from"../../../base/common/lifecycle.js";import{CharWidthRequest as B,CharWidthRequestType as n,readCharWidths as k}from"./charWidthReader.js";import{EditorFontLigatures as z}from"../../common/config/editorOptions.js";import{FontInfo as l,SERIALIZED_FONT_INFO_VERSION as V}from"../../common/config/fontInfo.js";class O extends A{_cache=new Map;_evictUntrustedReadingsTimeout=-1;_onDidChange=this._register(new D);onDidChange=this._onDidChange.event;dispose(){this._evictUntrustedReadingsTimeout!==-1&&(clearTimeout(this._evictUntrustedReadingsTimeout),this._evictUntrustedReadingsTimeout=-1),super.dispose()}clearAllFontInfos(){this._cache.clear(),this._onDidChange.fire()}_ensureCache(a){const i=U(a);let e=this._cache.get(i);return e||(e=new E,this._cache.set(i,e)),e}_writeToCache(a,i,e){this._ensureCache(a).put(i,e),!e.isTrusted&&this._evictUntrustedReadingsTimeout===-1&&(this._evictUntrustedReadingsTimeout=a.setTimeout(()=>{this._evictUntrustedReadingsTimeout=-1,this._evictUntrustedReadings(a)},5e3))}_evictUntrustedReadings(a){const i=this._ensureCache(a),e=i.getValues();let t=!1;for(const r of e)r.isTrusted||(t=!0,i.remove(r));t&&this._onDidChange.fire()}serializeFontInfo(a){return this._ensureCache(a).getValues().filter(e=>e.isTrusted)}restoreFontInfo(a,i){for(const e of i){if(e.version!==V)continue;const t=new l(e,!1);this._writeToCache(a,t,t)}}readFontInfo(a,i){const e=this._ensureCache(a);if(!e.has(i)){let t=this._actualReadFontInfo(a,i);(t.typicalHalfwidthCharacterWidth<=2||t.typicalFullwidthCharacterWidth<=2||t.spaceWidth<=2||t.maxDigitWidth<=2)&&(t=new l({pixelRatio:m.getInstance(a).value,fontFamily:t.fontFamily,fontWeight:t.fontWeight,fontSize:t.fontSize,fontFeatureSettings:t.fontFeatureSettings,fontVariationSettings:t.fontVariationSettings,lineHeight:t.lineHeight,letterSpacing:t.letterSpacing,isMonospace:t.isMonospace,typicalHalfwidthCharacterWidth:Math.max(t.typicalHalfwidthCharacterWidth,5),typicalFullwidthCharacterWidth:Math.max(t.typicalFullwidthCharacterWidth,5),canUseHalfwidthRightwardsArrow:t.canUseHalfwidthRightwardsArrow,spaceWidth:Math.max(t.spaceWidth,5),middotWidth:Math.max(t.middotWidth,5),wsmiddotWidth:Math.max(t.wsmiddotWidth,5),maxDigitWidth:Math.max(t.maxDigitWidth,5)},!1)),this._writeToCache(a,i,t)}return e.get(i)}_createRequest(a,i,e,t){const r=new B(a,i);return e.push(r),t?.push(r),r}_actualReadFontInfo(a,i){const e=[],t=[],r=this._createRequest("n",n.Regular,e,t),w=this._createRequest("\uFF4D",n.Regular,e,null),R=this._createRequest(" ",n.Regular,e,t),_=this._createRequest("0",n.Regular,e,t),y=this._createRequest("1",n.Regular,e,t),W=this._createRequest("2",n.Regular,e,t),v=this._createRequest("3",n.Regular,e,t),F=this._createRequest("4",n.Regular,e,t),C=this._createRequest("5",n.Regular,e,t),I=this._createRequest("6",n.Regular,e,t),q=this._createRequest("7",n.Regular,e,t),S=this._createRequest("8",n.Regular,e,t),x=this._createRequest("9",n.Regular,e,t),b=this._createRequest("\u2192",n.Regular,e,t),u=this._createRequest("\uFFEB",n.Regular,e,null),T=this._createRequest("\xB7",n.Regular,e,t),M=this._createRequest(String.fromCharCode(11825),n.Regular,e,null),o="|/-_ilm%";for(let s=0,c=o.length;s<c;s++)this._createRequest(o.charAt(s),n.Regular,e,t),this._createRequest(o.charAt(s),n.Italic,e,t),this._createRequest(o.charAt(s),n.Bold,e,t);k(a,i,e);const H=Math.max(_.width,y.width,W.width,v.width,F.width,C.width,I.width,q.width,S.width,x.width);let h=i.fontFeatureSettings===z.OFF;const g=t[0].width;for(let s=1,c=t.length;h&&s<c;s++){const f=g-t[s].width;if(f<-.001||f>.001){h=!1;break}}let d=!0;return h&&u.width!==g&&(d=!1),u.width>b.width&&(d=!1),new l({pixelRatio:m.getInstance(a).value,fontFamily:i.fontFamily,fontWeight:i.fontWeight,fontSize:i.fontSize,fontFeatureSettings:i.fontFeatureSettings,fontVariationSettings:i.fontVariationSettings,lineHeight:i.lineHeight,letterSpacing:i.letterSpacing,isMonospace:h,typicalHalfwidthCharacterWidth:r.width,typicalFullwidthCharacterWidth:w.width,canUseHalfwidthRightwardsArrow:d,spaceWidth:R.width,middotWidth:T.width,wsmiddotWidth:M.width,maxDigitWidth:H},!0)}}class E{_keys;_values;constructor(){this._keys=Object.create(null),this._values=Object.create(null)}has(a){const i=a.getId();return!!this._values[i]}get(a){const i=a.getId();return this._values[i]}put(a,i){const e=a.getId();this._keys[e]=a,this._values[e]=i}remove(a){const i=a.getId();delete this._keys[i],delete this._values[i]}getValues(){return Object.keys(this._keys).map(a=>this._values[a])}}const Q=new O;export{Q as FontMeasurements,O as FontMeasurementsImpl};
