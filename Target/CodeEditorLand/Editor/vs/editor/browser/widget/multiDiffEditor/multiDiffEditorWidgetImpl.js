var H=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var M=(m,f,e,t)=>{for(var i=t>1?void 0:t?K(f,e):f,s=m.length-1,r;s>=0;s--)(r=m[s])&&(i=(t?r(f,e,i):r(i))||i);return t&&i&&H(f,e,i),i},y=(m,f)=>(e,t)=>f(e,t,m);import{getWindow as j,h as g,scheduleAtNextAnimationFrame as P}from"../../../../base/browser/dom.js";import{SmoothScrollableElement as F}from"../../../../base/browser/ui/scrollbar/scrollableElement.js";import{compareBy as L,numberComparator as z}from"../../../../base/common/arrays.js";import{findFirstMax as A}from"../../../../base/common/arraysFind.js";import{BugIndicatingError as E}from"../../../../base/common/errors.js";import{Disposable as x,toDisposable as V}from"../../../../base/common/lifecycle.js";import{autorun as u,autorunWithStore as U,derived as _,derivedWithStore as B,disposableObservableValue as N,globalTransaction as k,observableFromEvent as R,observableValue as W,transaction as w}from"../../../../base/common/observable.js";import{Scrollable as $,ScrollbarVisibility as T}from"../../../../base/common/scrollable.js";import"../../../../base/common/uri.js";import{localize as O}from"../../../../nls.js";import{IContextKeyService as C}from"../../../../platform/contextkey/common/contextkey.js";import"../../../../platform/editor/common/editor.js";import{IInstantiationService as G}from"../../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as Y}from"../../../../platform/instantiation/common/serviceCollection.js";import{OffsetRange as I}from"../../../common/core/offsetRange.js";import"../../../common/core/range.js";import{Selection as q}from"../../../common/core/selection.js";import"../../../common/editorCommon.js";import{EditorContextKeys as J}from"../../../common/editorContextKeys.js";import"../../editorBrowser.js";import{ObservableElementSizeObserver as Q}from"../diffEditor/utils.js";import{DiffEditorItemTemplate as X,TemplateData as Z}from"./diffEditorItemTemplate.js";import"./model.js";import"./multiDiffEditorViewModel.js";import"./multiDiffEditorWidget.js";import{ObjectPool as ee}from"./objectPool.js";import"./style.css";import"./workbenchUIElementFactory.js";let S=class extends x{constructor(e,t,i,s,r,n){super();this._element=e;this._dimension=t;this._viewModel=i;this._workbenchUIElementFactory=s;this._parentContextKeyService=r;this._parentInstantiationService=n;this._register(U((o,l)=>{const a=this._viewModel.read(o);if(a&&a.contextKeys)for(const[h,p]of Object.entries(a.contextKeys)){const v=this._contextKeyService.createKey(h,void 0);v.set(p),l.add(V(()=>v.reset()))}}));const d=this._parentContextKeyService.createKey(J.multiDiffEditorAllCollapsed.key,!1);this._register(u(o=>{const l=this._viewModel.read(o);if(l){const a=l.items.read(o).every(h=>h.collapsed.read(o));d.set(a)}})),this._register(u(o=>{const l=this._dimension.read(o);this._sizeObserver.observe(l)}));const c=_(o=>{if(this._viewItems.read(o).length>0)return;const a=this._viewModel.read(o);return!a||a.isLoading.read(o)?O("loading","Loading..."):O("noChangedFiles","No Changed Files")});this._register(u(o=>{const l=c.read(o);this._elements.placeholder.innerText=l??"",this._elements.placeholder.classList.toggle("visible",!!l)})),this._scrollableElements.content.style.position="relative",this._register(u(o=>{const l=this._sizeObserver.height.read(o);this._scrollableElements.root.style.height=`${l}px`;const a=this._totalHeight.read(o);this._scrollableElements.content.style.height=`${a}px`;const h=this._sizeObserver.width.read(o);let p=h;const v=this._viewItems.read(o),b=A(v,L(D=>D.maxScroll.read(o).maxScroll,z));if(b){const D=b.maxScroll.read(o);p=h+D.maxScroll}this._scrollableElement.setScrollDimensions({width:h,height:l,scrollHeight:a,scrollWidth:p})})),e.replaceChildren(this._elements.root),this._register(V(()=>{e.replaceChildren()})),this._register(this._register(u(o=>{k(l=>{this.render(o)})})))}_scrollableElements=g("div.scrollContent",[g("div@content",{style:{overflow:"hidden"}}),g("div.monaco-editor@overflowWidgetsDomNode",{})]);_scrollable=this._register(new $({forceIntegerValues:!1,scheduleAtNextAnimationFrame:e=>P(j(this._element),e),smoothScrollDuration:100}));_scrollableElement=this._register(new F(this._scrollableElements.root,{vertical:T.Auto,horizontal:T.Auto,useShadows:!1},this._scrollable));_elements=g("div.monaco-component.multiDiffEditor",{},[g("div",{},[this._scrollableElement.getDomNode()]),g("div.placeholder@placeholder",{},[g("div")])]);_sizeObserver=this._register(new Q(this._element,void 0));_objectPool=this._register(new ee(e=>{const t=this._instantiationService.createInstance(X,this._scrollableElements.content,this._scrollableElements.overflowWidgetsDomNode,this._workbenchUIElementFactory);return t.setData(e),t}));scrollTop=R(this,this._scrollableElement.onScroll,()=>this._scrollableElement.getScrollPosition().scrollTop);scrollLeft=R(this,this._scrollableElement.onScroll,()=>this._scrollableElement.getScrollPosition().scrollLeft);_viewItemsInfo=B(this,(e,t)=>{const i=this._viewModel.read(e);if(!i)return{items:[],getItem:d=>{throw new E}};const s=i.items.read(e),r=new Map;return{items:s.map(d=>{const c=t.add(new ie(d,this._objectPool,this.scrollLeft,l=>{this._scrollableElement.setScrollPosition({scrollTop:this._scrollableElement.getScrollPosition().scrollTop+l})})),o=this._lastDocStates?.[c.getKey()];return o&&w(l=>{c.setViewState(o,l)}),r.set(d,c),c}),getItem:d=>r.get(d)}});_viewItems=this._viewItemsInfo.map(this,e=>e.items);_spaceBetweenPx=0;_totalHeight=this._viewItems.map(this,(e,t)=>e.reduce((i,s)=>i+s.contentHeight.read(t)+this._spaceBetweenPx,0));activeControl=_(this,e=>{const t=this._viewModel.read(e)?.activeDiffItem.read(e);return t?this._viewItemsInfo.read(e).getItem(t).template.read(e)?.editor:void 0});_contextKeyService=this._register(this._parentContextKeyService.createScoped(this._element));_instantiationService=this._register(this._parentInstantiationService.createChild(new Y([C,this._contextKeyService])));setScrollState(e){this._scrollableElement.setScrollPosition({scrollLeft:e.left,scrollTop:e.top})}reveal(e,t){const i=this._viewItems.get(),s=i.findIndex(o=>o.viewModel.originalUri?.toString()===e.original?.toString()&&o.viewModel.modifiedUri?.toString()===e.modified?.toString());if(s===-1)throw new E("Resource not found in diff editor");const r=i[s];this._viewModel.get().activeDiffItem.setCache(r.viewModel,void 0);let n=0;for(let o=0;o<s;o++)n+=i[o].contentHeight.get()+this._spaceBetweenPx;this._scrollableElement.setScrollPosition({scrollTop:n});const d=r.template.get()?.editor,c="original"in e?d?.getOriginalEditor():d?.getModifiedEditor();c&&t?.range&&(c.revealRangeInCenter(t.range),te(c,t.range))}getViewState(){return{scrollState:{top:this.scrollTop.get(),left:this.scrollLeft.get()},docStates:Object.fromEntries(this._viewItems.get().map(e=>[e.getKey(),e.getViewState()]))}}_lastDocStates={};setViewState(e){this.setScrollState(e.scrollState),this._lastDocStates=e.docStates,w(t=>{if(e.docStates)for(const i of this._viewItems.get()){const s=e.docStates[i.getKey()];s&&i.setViewState(s,t)}})}findDocumentDiffItem(e){return this._viewItems.get().find(i=>i.viewModel.diffEditorViewModel.model.modified.uri.toString()===e.toString()||i.viewModel.diffEditorViewModel.model.original.uri.toString()===e.toString())?.viewModel.documentDiffItem}tryGetCodeEditor(e){const t=this._viewItems.get().find(s=>s.viewModel.diffEditorViewModel.model.modified.uri.toString()===e.toString()||s.viewModel.diffEditorViewModel.model.original.uri.toString()===e.toString()),i=t?.template.get()?.editor;if(i)return t.viewModel.diffEditorViewModel.model.modified.uri.toString()===e.toString()?{diffEditor:i,editor:i.getModifiedEditor()}:{diffEditor:i,editor:i.getOriginalEditor()}}render(e){const t=this.scrollTop.read(e);let i=0,s=0,r=0;const n=this._sizeObserver.height.read(e),d=I.ofStartAndLength(t,n),c=this._sizeObserver.width.read(e);for(const o of this._viewItems.read(e)){const l=o.contentHeight.read(e),a=Math.min(l,n),h=I.ofStartAndLength(s,a),p=I.ofStartAndLength(r,l);if(p.isBefore(d))i-=l-a,o.hide();else if(p.isAfter(d))o.hide();else{const v=Math.max(0,Math.min(d.start-p.start,l-a));i-=v;const b=I.ofStartAndLength(t+i,n);o.render(h,v,c,b)}s+=a+this._spaceBetweenPx,r+=l+this._spaceBetweenPx}this._scrollableElements.content.style.transform=`translateY(${-(t+i)}px)`}};S=M([y(4,C),y(5,G)],S);function te(m,f){const e=m.getModel(),t=m.createDecorationsCollection([{range:f,options:{description:"symbol-navigate-action-highlight",className:"symbolHighlight"}}]);setTimeout(()=>{m.getModel()===e&&t.clear()},350)}class ie extends x{constructor(e,t,i,s){super();this.viewModel=e;this._objectPool=t;this._scrollLeft=i;this._deltaScrollVertical=s;this.viewModel.setIsFocused(this._isFocused,void 0),this._register(u(r=>{const n=this._scrollLeft.read(r);this._templateRef.read(r)?.object.setScrollLeft(n)})),this._register(u(r=>{const n=this._templateRef.read(r);!n||!this._isHidden.read(r)||n.object.isFocused.read(r)||this._clear()}))}_templateRef=this._register(N(this,void 0));contentHeight=_(this,e=>this._templateRef.read(e)?.object.contentHeight?.read(e)??this.viewModel.lastTemplateData.read(e).contentHeight);maxScroll=_(this,e=>this._templateRef.read(e)?.object.maxScroll.read(e)??{maxScroll:0,scrollWidth:0});template=_(this,e=>this._templateRef.read(e)?.object);_isHidden=W(this,!1);_isFocused=_(this,e=>this.template.read(e)?.isFocused.read(e)??!1);dispose(){this._clear(),super.dispose()}toString(){return`VirtualViewItem(${this.viewModel.documentDiffItem.modified?.uri.toString()})`}getKey(){return this.viewModel.getKey()}getViewState(){return w(e=>{this._updateTemplateData(e)}),{collapsed:this.viewModel.collapsed.get(),selections:this.viewModel.lastTemplateData.get().selections}}setViewState(e,t){this.viewModel.collapsed.set(e.collapsed,t),this._updateTemplateData(t);const i=this.viewModel.lastTemplateData.get(),s=e.selections?.map(q.liftSelection);this.viewModel.lastTemplateData.set({...i,selections:s},t);const r=this._templateRef.get();r&&s&&r.object.editor.setSelections(s)}_updateTemplateData(e){const t=this._templateRef.get();t&&this.viewModel.lastTemplateData.set({contentHeight:t.object.contentHeight.get(),selections:t.object.editor.getSelections()??void 0},e)}_clear(){const e=this._templateRef.get();e&&w(t=>{this._updateTemplateData(t),e.object.hide(),this._templateRef.set(void 0,t)})}hide(){this._isHidden.set(!0,void 0)}render(e,t,i,s){this._isHidden.set(!1,void 0);let r=this._templateRef.get();if(!r){r=this._objectPool.getUnusedObj(new Z(this.viewModel,this._deltaScrollVertical)),this._templateRef.set(r,void 0);const n=this.viewModel.lastTemplateData.get().selections;n&&r.object.editor.setSelections(n)}r.object.render(e,i,t,s)}}export{S as MultiDiffEditorWidgetImpl};
