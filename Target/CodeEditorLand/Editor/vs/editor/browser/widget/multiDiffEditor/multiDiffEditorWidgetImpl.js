var C=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var D=(m,f,e,t)=>{for(var i=t>1?void 0:t?H(f,e):f,l=m.length-1,r;l>=0;l--)(r=m[l])&&(i=(t?r(f,e,i):r(i))||i);return t&&i&&C(f,e,i),i},y=(m,f)=>(e,t)=>f(e,t,m);import{getWindow as K,h as p,scheduleAtNextAnimationFrame as j}from"../../../../../vs/base/browser/dom.js";import{SmoothScrollableElement as P}from"../../../../../vs/base/browser/ui/scrollbar/scrollableElement.js";import{compareBy as F,numberComparator as L}from"../../../../../vs/base/common/arrays.js";import{findFirstMax as z}from"../../../../../vs/base/common/arraysFind.js";import{BugIndicatingError as M}from"../../../../../vs/base/common/errors.js";import{Disposable as E,toDisposable as x}from"../../../../../vs/base/common/lifecycle.js";import{autorun as v,autorunWithStore as A,derived as b,derivedWithStore as U,observableFromEvent as V,observableValue as B}from"../../../../../vs/base/common/observable.js";import{disposableObservableValue as N,globalTransaction as k,transaction as I}from"../../../../../vs/base/common/observableInternal/base.js";import{Scrollable as W,ScrollbarVisibility as R}from"../../../../../vs/base/common/scrollable.js";import"../../../../../vs/base/common/uri.js";import"vs/css!./style";import"../../../../../vs/editor/browser/editorBrowser.js";import{ObservableElementSizeObserver as $}from"../../../../../vs/editor/browser/widget/diffEditor/utils.js";import"../../../../../vs/editor/browser/widget/multiDiffEditor/model.js";import"../../../../../vs/editor/browser/widget/multiDiffEditor/multiDiffEditorWidget.js";import"../../../../../vs/editor/browser/widget/multiDiffEditor/workbenchUIElementFactory.js";import{OffsetRange as w}from"../../../../../vs/editor/common/core/offsetRange.js";import"../../../../../vs/editor/common/core/range.js";import{Selection as G}from"../../../../../vs/editor/common/core/selection.js";import"../../../../../vs/editor/common/editorCommon.js";import{EditorContextKeys as T}from"../../../../../vs/editor/common/editorContextKeys.js";import{localize as Y}from"../../../../../vs/nls.js";import{IContextKeyService as O}from"../../../../../vs/platform/contextkey/common/contextkey.js";import"../../../../../vs/platform/editor/common/editor.js";import{IInstantiationService as q}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{ServiceCollection as J}from"../../../../../vs/platform/instantiation/common/serviceCollection.js";import{DiffEditorItemTemplate as Q,TemplateData as X}from"./diffEditorItemTemplate.js";import"./multiDiffEditorViewModel.js";import{ObjectPool as Z}from"./objectPool.js";let S=class extends E{constructor(e,t,i,l,r,a){super();this._element=e;this._dimension=t;this._viewModel=i;this._workbenchUIElementFactory=l;this._parentContextKeyService=r;this._parentInstantiationService=a;this._contextKeyService.createKey(T.inMultiDiffEditor.key,!0),this._register(A((o,s)=>{const n=this._viewModel.read(o);if(n&&n.contextKeys)for(const[c,u]of Object.entries(n.contextKeys)){const h=this._contextKeyService.createKey(c,void 0);h.set(u),s.add(x(()=>h.reset()))}}));const d=this._parentContextKeyService.createKey(T.multiDiffEditorAllCollapsed.key,!1);this._register(v(o=>{const s=this._viewModel.read(o);if(s){const n=s.items.read(o).every(c=>c.collapsed.read(o));d.set(n)}})),this._register(v(o=>{const s=this._dimension.read(o);this._sizeObserver.observe(s)})),this._register(v(o=>{const s=this._viewItems.read(o);this._elements.placeholder.classList.toggle("visible",s.length===0)})),this._scrollableElements.content.style.position="relative",this._register(v(o=>{const s=this._sizeObserver.height.read(o);this._scrollableElements.root.style.height=`${s}px`;const n=this._totalHeight.read(o);this._scrollableElements.content.style.height=`${n}px`;const c=this._sizeObserver.width.read(o);let u=c;const h=this._viewItems.read(o),g=z(h,F(_=>_.maxScroll.read(o).maxScroll,L));if(g){const _=g.maxScroll.read(o);u=c+_.maxScroll}this._scrollableElement.setScrollDimensions({width:c,height:s,scrollHeight:n,scrollWidth:u})})),e.replaceChildren(this._elements.root),this._register(x(()=>{e.replaceChildren()})),this._register(this._register(v(o=>{k(s=>{this.render(o)})})))}_scrollableElements=p("div.scrollContent",[p("div@content",{style:{overflow:"hidden"}}),p("div.monaco-editor@overflowWidgetsDomNode",{})]);_scrollable=this._register(new W({forceIntegerValues:!1,scheduleAtNextAnimationFrame:e=>j(K(this._element),e),smoothScrollDuration:100}));_scrollableElement=this._register(new P(this._scrollableElements.root,{vertical:R.Auto,horizontal:R.Auto,useShadows:!1},this._scrollable));_elements=p("div.monaco-component.multiDiffEditor",{},[p("div",{},[this._scrollableElement.getDomNode()]),p("div.placeholder@placeholder",{},[p("div",[Y("noChangedFiles","No Changed Files")])])]);_sizeObserver=this._register(new $(this._element,void 0));_objectPool=this._register(new Z(e=>{const t=this._instantiationService.createInstance(Q,this._scrollableElements.content,this._scrollableElements.overflowWidgetsDomNode,this._workbenchUIElementFactory);return t.setData(e),t}));scrollTop=V(this,this._scrollableElement.onScroll,()=>this._scrollableElement.getScrollPosition().scrollTop);scrollLeft=V(this,this._scrollableElement.onScroll,()=>this._scrollableElement.getScrollPosition().scrollLeft);_viewItemsInfo=U(this,(e,t)=>{const i=this._viewModel.read(e);if(!i)return{items:[],getItem:d=>{throw new M}};const l=i.items.read(e),r=new Map;return{items:l.map(d=>{const o=t.add(new te(d,this._objectPool,this.scrollLeft,n=>{this._scrollableElement.setScrollPosition({scrollTop:this._scrollableElement.getScrollPosition().scrollTop+n})})),s=this._lastDocStates?.[o.getKey()];return s&&I(n=>{o.setViewState(s,n)}),r.set(d,o),o}),getItem:d=>r.get(d)}});_viewItems=this._viewItemsInfo.map(this,e=>e.items);_spaceBetweenPx=0;_totalHeight=this._viewItems.map(this,(e,t)=>e.reduce((i,l)=>i+l.contentHeight.read(t)+this._spaceBetweenPx,0));activeControl=b(this,e=>{const t=this._viewModel.read(e)?.activeDiffItem.read(e);return t?this._viewItemsInfo.read(e).getItem(t).template.read(e)?.editor:void 0});_contextKeyService=this._register(this._parentContextKeyService.createScoped(this._element));_instantiationService=this._register(this._parentInstantiationService.createChild(new J([O,this._contextKeyService])));setScrollState(e){this._scrollableElement.setScrollPosition({scrollLeft:e.left,scrollTop:e.top})}reveal(e,t){const i=this._viewItems.get(),l=i.findIndex(s=>s.viewModel.originalUri?.toString()===e.original?.toString()&&s.viewModel.modifiedUri?.toString()===e.modified?.toString());if(l===-1)throw new M("Resource not found in diff editor");const r=i[l];this._viewModel.get().activeDiffItem.setCache(r.viewModel,void 0);let a=0;for(let s=0;s<l;s++)a+=i[s].contentHeight.get()+this._spaceBetweenPx;this._scrollableElement.setScrollPosition({scrollTop:a});const d=r.template.get()?.editor,o="original"in e?d?.getOriginalEditor():d?.getModifiedEditor();o&&t?.range&&(o.revealRangeInCenter(t.range),ee(o,t.range))}getViewState(){return{scrollState:{top:this.scrollTop.get(),left:this.scrollLeft.get()},docStates:Object.fromEntries(this._viewItems.get().map(e=>[e.getKey(),e.getViewState()]))}}_lastDocStates={};setViewState(e){this.setScrollState(e.scrollState),this._lastDocStates=e.docStates,I(t=>{if(e.docStates)for(const i of this._viewItems.get()){const l=e.docStates[i.getKey()];l&&i.setViewState(l,t)}})}findDocumentDiffItem(e){return this._viewItems.get().find(i=>i.viewModel.diffEditorViewModel.model.modified.uri.toString()===e.toString()||i.viewModel.diffEditorViewModel.model.original.uri.toString()===e.toString())?.viewModel.documentDiffItem}tryGetCodeEditor(e){const t=this._viewItems.get().find(l=>l.viewModel.diffEditorViewModel.model.modified.uri.toString()===e.toString()||l.viewModel.diffEditorViewModel.model.original.uri.toString()===e.toString()),i=t?.template.get()?.editor;if(i)return t.viewModel.diffEditorViewModel.model.modified.uri.toString()===e.toString()?{diffEditor:i,editor:i.getModifiedEditor()}:{diffEditor:i,editor:i.getOriginalEditor()}}render(e){const t=this.scrollTop.read(e);let i=0,l=0,r=0;const a=this._sizeObserver.height.read(e),d=w.ofStartAndLength(t,a),o=this._sizeObserver.width.read(e);for(const s of this._viewItems.read(e)){const n=s.contentHeight.read(e),c=Math.min(n,a),u=w.ofStartAndLength(l,c),h=w.ofStartAndLength(r,n);if(h.isBefore(d))i-=n-c,s.hide();else if(h.isAfter(d))s.hide();else{const g=Math.max(0,Math.min(d.start-h.start,n-c));i-=g;const _=w.ofStartAndLength(t+i,a);s.render(u,g,o,_)}l+=c+this._spaceBetweenPx,r+=n+this._spaceBetweenPx}this._scrollableElements.content.style.transform=`translateY(${-(t+i)}px)`}};S=D([y(4,O),y(5,q)],S);function ee(m,f){const e=m.getModel(),t=m.createDecorationsCollection([{range:f,options:{description:"symbol-navigate-action-highlight",className:"symbolHighlight"}}]);setTimeout(()=>{m.getModel()===e&&t.clear()},350)}class te extends E{constructor(e,t,i,l){super();this.viewModel=e;this._objectPool=t;this._scrollLeft=i;this._deltaScrollVertical=l;this.viewModel.setIsFocused(this._isFocused,void 0),this._register(v(r=>{const a=this._scrollLeft.read(r);this._templateRef.read(r)?.object.setScrollLeft(a)})),this._register(v(r=>{const a=this._templateRef.read(r);!a||!this._isHidden.read(r)||a.object.isFocused.read(r)||this._clear()}))}_templateRef=this._register(N(this,void 0));contentHeight=b(this,e=>this._templateRef.read(e)?.object.contentHeight?.read(e)??this.viewModel.lastTemplateData.read(e).contentHeight);maxScroll=b(this,e=>this._templateRef.read(e)?.object.maxScroll.read(e)??{maxScroll:0,scrollWidth:0});template=b(this,e=>this._templateRef.read(e)?.object);_isHidden=B(this,!1);_isFocused=b(this,e=>this.template.read(e)?.isFocused.read(e)??!1);dispose(){this._clear(),super.dispose()}toString(){return`VirtualViewItem(${this.viewModel.documentDiffItem.modified?.uri.toString()})`}getKey(){return this.viewModel.getKey()}getViewState(){return I(e=>{this._updateTemplateData(e)}),{collapsed:this.viewModel.collapsed.get(),selections:this.viewModel.lastTemplateData.get().selections}}setViewState(e,t){this.viewModel.collapsed.set(e.collapsed,t),this._updateTemplateData(t);const i=this.viewModel.lastTemplateData.get(),l=e.selections?.map(G.liftSelection);this.viewModel.lastTemplateData.set({...i,selections:l},t);const r=this._templateRef.get();r&&l&&r.object.editor.setSelections(l)}_updateTemplateData(e){const t=this._templateRef.get();t&&this.viewModel.lastTemplateData.set({contentHeight:t.object.contentHeight.get(),selections:t.object.editor.getSelections()??void 0},e)}_clear(){const e=this._templateRef.get();e&&I(t=>{this._updateTemplateData(t),e.object.hide(),this._templateRef.set(void 0,t)})}hide(){this._isHidden.set(!0,void 0)}render(e,t,i,l){this._isHidden.set(!1,void 0);let r=this._templateRef.get();if(!r){r=this._objectPool.getUnusedObj(new X(this.viewModel,this._deltaScrollVertical)),this._templateRef.set(r,void 0);const a=this.viewModel.lastTemplateData.get().selections;a&&r.object.editor.setSelections(a)}r.object.render(e,i,t,l)}}export{S as MultiDiffEditorWidgetImpl};
