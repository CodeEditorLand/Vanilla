var V=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var w=(p,n,e,i)=>{for(var t=i>1?void 0:i?A(n,e):n,o=p.length-1,f;o>=0;o--)(f=p[o])&&(t=(i?f(n,e,t):f(t))||t);return i&&t&&V(n,e,t),t},B=(p,n)=>(e,i)=>n(e,i,p);import{groupAdjacentBy as k}from"../../../../base/common/arrays.js";import{softAssert as O}from"../../../../base/common/assert.js";import{RunOnceScheduler as j}from"../../../../base/common/async.js";import{CancellationTokenSource as q}from"../../../../base/common/cancellation.js";import{readHotReloadableExport as P}from"../../../../base/common/hotReloadHelpers.js";import{Disposable as W,toDisposable as G}from"../../../../base/common/lifecycle.js";import{autorun as J,autorunWithStore as K,derived as y,observableSignal as Q,observableSignalFromEvent as X,observableValue as C,transaction as M,waitForState as Y}from"../../../../base/common/observable.js";import{isDefined as H}from"../../../../base/common/types.js";import{LineRange as R,LineRangeSet as Z}from"../../../common/core/lineRange.js";import{DefaultLinesDiffComputer as $}from"../../../common/diff/defaultLinesDiffComputer/defaultLinesDiffComputer.js";import{optimizeSequenceDiffs as ee}from"../../../common/diff/defaultLinesDiffComputer/heuristicSequenceOptimizations.js";import{DetailedLineRangeMapping as F,LineRangeMapping as E,RangeMapping as ie}from"../../../common/diff/rangeMapping.js";import{TextEditInfo as x}from"../../../common/model/bracketPairsTextModelPart/bracketPairsTree/beforeEditPositionMapper.js";import{combineTextEditInfos as z}from"../../../common/model/bracketPairsTextModelPart/bracketPairsTree/combineTextEditInfos.js";import{IDiffProviderFactoryService as ne}from"./diffProviderFactoryService.js";import{filterWithPrevious as te}from"./utils.js";let S=class extends W{constructor(e,i,t){super();this.model=e;this._options=i;this._diffProviderFactoryService=t;this._register(G(()=>this._cancellationTokenSource.cancel()));const o=Q("contentChangedSignal"),f=this._register(new j(()=>o.trigger(void 0),200));this._register(J(d=>{const l=this._unchangedRegions.read(d);if(!l||l.regions.some(a=>a.isDragged.read(d)))return;const u=l.originalDecorationIds.map(a=>e.original.getDecorationRange(a)).map(a=>a?R.fromRangeInclusive(a):void 0),r=l.modifiedDecorationIds.map(a=>e.modified.getDecorationRange(a)).map(a=>a?R.fromRangeInclusive(a):void 0),g=l.regions.map((a,b)=>!u[b]||!r[b]?void 0:new T(u[b].startLineNumber,r[b].startLineNumber,u[b].length,a.visibleLineCountTop.read(d),a.visibleLineCountBottom.read(d))).filter(H),s=[];let h=!1;for(const a of k(g,(b,c)=>b.getHiddenModifiedRange(d).endLineNumberExclusive===c.getHiddenModifiedRange(d).startLineNumber))if(a.length>1){h=!0;const b=a.reduce((D,_)=>D+_.lineCount,0),c=new T(a[0].originalLineNumber,a[0].modifiedLineNumber,b,a[0].visibleLineCountTop.get(),a[a.length-1].visibleLineCountBottom.get());s.push(c)}else s.push(a[0]);if(h){const a=e.original.deltaDecorations(l.originalDecorationIds,s.map(c=>({range:c.originalUnchangedRange.toInclusiveRange(),options:{description:"unchanged"}}))),b=e.modified.deltaDecorations(l.modifiedDecorationIds,s.map(c=>({range:c.modifiedUnchangedRange.toInclusiveRange(),options:{description:"unchanged"}})));M(c=>{this._unchangedRegions.set({regions:s,originalDecorationIds:a,modifiedDecorationIds:b},c)})}}));const v=(d,l,u)=>{const r=T.fromDiffs(d.changes,e.original.getLineCount(),e.modified.getLineCount(),this._options.hideUnchangedRegionsMinimumLineCount.read(u),this._options.hideUnchangedRegionsContextLineCount.read(u));let g;const s=this._unchangedRegions.get();if(s){const c=s.originalDecorationIds.map(m=>e.original.getDecorationRange(m)).map(m=>m?R.fromRangeInclusive(m):void 0),D=s.modifiedDecorationIds.map(m=>e.modified.getDecorationRange(m)).map(m=>m?R.fromRangeInclusive(m):void 0);let U=te(s.regions.map((m,L)=>{if(!c[L]||!D[L])return;const N=c[L].length;return new T(c[L].startLineNumber,D[L].startLineNumber,N,Math.min(m.visibleLineCountTop.get(),N),Math.min(m.visibleLineCountBottom.get(),N-m.visibleLineCountTop.get()))}).filter(H),(m,L)=>!L||m.modifiedLineNumber>=L.modifiedLineNumber+L.lineCount&&m.originalLineNumber>=L.originalLineNumber+L.lineCount).map(m=>new E(m.getHiddenOriginalRange(u),m.getHiddenModifiedRange(u)));U=E.clip(U,R.ofLength(1,e.original.getLineCount()),R.ofLength(1,e.modified.getLineCount())),g=E.inverse(U,e.original.getLineCount(),e.modified.getLineCount())}const h=[];if(g)for(const c of r){const D=g.filter(_=>_.original.intersectsStrict(c.originalUnchangedRange)&&_.modified.intersectsStrict(c.modifiedUnchangedRange));h.push(...c.setVisibleRanges(D,l))}else h.push(...r);const a=e.original.deltaDecorations(s?.originalDecorationIds||[],h.map(c=>({range:c.originalUnchangedRange.toInclusiveRange(),options:{description:"unchanged"}}))),b=e.modified.deltaDecorations(s?.modifiedDecorationIds||[],h.map(c=>({range:c.modifiedUnchangedRange.toInclusiveRange(),options:{description:"unchanged"}})));this._unchangedRegions.set({regions:h,originalDecorationIds:a,modifiedDecorationIds:b},l)};this._register(e.modified.onDidChangeContent(d=>{if(this._diff.get()){const u=x.fromModelContentChanges(d.changes),r=(this._lastDiff,e.original,e.modified,void 0);r&&(this._lastDiff=r,M(g=>{this._diff.set(I.fromDiffResult(this._lastDiff),g),v(r,g);const s=this.movedTextToCompare.get();this.movedTextToCompare.set(s?this._lastDiff.moves.find(h=>h.lineRangeMapping.modified.intersect(s.lineRangeMapping.modified)):void 0,g)}))}this._isDiffUpToDate.set(!1,void 0),f.schedule()})),this._register(e.original.onDidChangeContent(d=>{if(this._diff.get()){const u=x.fromModelContentChanges(d.changes),r=(this._lastDiff,e.original,e.modified,void 0);r&&(this._lastDiff=r,M(g=>{this._diff.set(I.fromDiffResult(this._lastDiff),g),v(r,g);const s=this.movedTextToCompare.get();this.movedTextToCompare.set(s?this._lastDiff.moves.find(h=>h.lineRangeMapping.modified.intersect(s.lineRangeMapping.modified)):void 0,g)}))}this._isDiffUpToDate.set(!1,void 0),f.schedule()})),this._register(K(async(d,l)=>{this._options.hideUnchangedRegionsMinimumLineCount.read(d),this._options.hideUnchangedRegionsContextLineCount.read(d),f.cancel(),o.read(d);const u=this._diffProvider.read(d);u.onChangeSignal.read(d),P($,d),P(ee,d),this._isDiffUpToDate.set(!1,void 0);let r=[];l.add(e.original.onDidChangeContent(h=>{const a=x.fromModelContentChanges(h.changes);r=z(r,a)}));let g=[];l.add(e.modified.onDidChangeContent(h=>{const a=x.fromModelContentChanges(h.changes);g=z(g,a)}));let s=await u.diffProvider.computeDiff(e.original,e.modified,{ignoreTrimWhitespace:this._options.ignoreTrimWhitespace.read(d),maxComputationTimeMs:this._options.maxComputationTimeMs.read(d),computeMoves:this._options.showMoves.read(d)},this._cancellationTokenSource.token);this._cancellationTokenSource.token.isCancellationRequested||e.original.isDisposed()||e.modified.isDisposed()||(s=oe(s,e.original,e.modified),s=(e.original,e.modified,void 0)??s,s=(e.original,e.modified,void 0)??s,M(h=>{v(s,h),this._lastDiff=s;const a=I.fromDiffResult(s);this._diff.set(a,h),this._isDiffUpToDate.set(!0,h);const b=this.movedTextToCompare.get();this.movedTextToCompare.set(b?this._lastDiff.moves.find(c=>c.lineRangeMapping.modified.intersect(b.lineRangeMapping.modified)):void 0,h)}))}))}_isDiffUpToDate=C(this,!1);isDiffUpToDate=this._isDiffUpToDate;_lastDiff;_diff=C(this,void 0);diff=this._diff;_unchangedRegions=C(this,void 0);unchangedRegions=y(this,e=>this._options.hideUnchangedRegions.read(e)?this._unchangedRegions.read(e)?.regions??[]:(M(i=>{for(const t of this._unchangedRegions.get()?.regions||[])t.collapseAll(i)}),[]));movedTextToCompare=C(this,void 0);_activeMovedText=C(this,void 0);_hoveredMovedText=C(this,void 0);activeMovedText=y(this,e=>this.movedTextToCompare.read(e)??this._hoveredMovedText.read(e)??this._activeMovedText.read(e));setActiveMovedText(e){this._activeMovedText.set(e,void 0)}setHoveredMovedText(e){this._hoveredMovedText.set(e,void 0)}_cancellationTokenSource=new q;_diffProvider=y(this,e=>{const i=this._diffProviderFactoryService.createDiffProvider({diffAlgorithm:this._options.diffAlgorithm.read(e)}),t=X("onDidChange",i.onDidChange);return{diffProvider:i,onChangeSignal:t}});ensureModifiedLineIsVisible(e,i,t){if(this.diff.get()?.mappings.length===0)return;const o=this._unchangedRegions.get()?.regions||[];for(const f of o)if(f.getHiddenModifiedRange(void 0).contains(e)){f.showModifiedLine(e,i,t);return}}ensureOriginalLineIsVisible(e,i,t){if(this.diff.get()?.mappings.length===0)return;const o=this._unchangedRegions.get()?.regions||[];for(const f of o)if(f.getHiddenOriginalRange(void 0).contains(e)){f.showOriginalLine(e,i,t);return}}async waitForDiff(){await Y(this.isDiffUpToDate,e=>e)}serializeState(){return{collapsedRegions:this._unchangedRegions.get()?.regions.map(i=>({range:i.getHiddenModifiedRange(void 0).serialize()}))}}restoreSerializedState(e){const i=e.collapsedRegions?.map(o=>R.deserialize(o.range)),t=this._unchangedRegions.get();!t||!i||M(o=>{for(const f of t.regions)for(const v of i)if(f.modifiedUnchangedRange.intersect(v)){f.setHiddenModifiedRange(v,o);break}})}};S=w([B(2,ne)],S);function oe(p,n,e){return{changes:p.changes.map(i=>new F(i.original,i.modified,i.innerChanges?i.innerChanges.map(t=>se(t,n,e)):void 0)),moves:p.moves,identical:p.identical,quitEarly:p.quitEarly}}function se(p,n,e){let i=p.originalRange,t=p.modifiedRange;return i.startColumn===1&&t.startColumn===1&&(i.endColumn!==1||t.endColumn!==1)&&i.endColumn===n.getLineMaxColumn(i.endLineNumber)&&t.endColumn===e.getLineMaxColumn(t.endLineNumber)&&i.endLineNumber<n.getLineCount()&&t.endLineNumber<e.getLineCount()&&(i=i.setEndPosition(i.endLineNumber+1,1),t=t.setEndPosition(t.endLineNumber+1,1)),new ie(i,t)}class I{constructor(n,e,i,t){this.mappings=n;this.movedTexts=e;this.identical=i;this.quitEarly=t}static fromDiffResult(n){return new I(n.changes.map(e=>new ae(e)),n.moves||[],n.identical,n.quitEarly)}}class ae{constructor(n){this.lineRangeMapping=n}}class T{constructor(n,e,i,t,o){this.originalLineNumber=n;this.modifiedLineNumber=e;this.lineCount=i;const f=Math.max(Math.min(t,this.lineCount),0),v=Math.max(Math.min(o,this.lineCount-t),0);O(t===f),O(o===v),this._visibleLineCountTop.set(f,void 0),this._visibleLineCountBottom.set(v,void 0)}static fromDiffs(n,e,i,t,o){const f=F.inverse(n,e,i),v=[];for(const d of f){let l=d.original.startLineNumber,u=d.modified.startLineNumber,r=d.original.length;const g=l===1&&u===1,s=l+r===e+1&&u+r===i+1;(g||s)&&r>=o+t?(g&&!s&&(r-=o),s&&!g&&(l+=o,u+=o,r-=o),v.push(new T(l,u,r,0,0))):r>=o*2+t&&(l+=o,u+=o,r-=o*2,v.push(new T(l,u,r,0,0)))}return v}get originalUnchangedRange(){return R.ofLength(this.originalLineNumber,this.lineCount)}get modifiedUnchangedRange(){return R.ofLength(this.modifiedLineNumber,this.lineCount)}_visibleLineCountTop=C(this,0);visibleLineCountTop=this._visibleLineCountTop;_visibleLineCountBottom=C(this,0);visibleLineCountBottom=this._visibleLineCountBottom;_shouldHideControls=y(this,n=>this.visibleLineCountTop.read(n)+this.visibleLineCountBottom.read(n)===this.lineCount&&!this.isDragged.read(n));isDragged=C(this,void 0);setVisibleRanges(n,e){const i=[],t=new Z(n.map(d=>d.modified)).subtractFrom(this.modifiedUnchangedRange);let o=this.originalLineNumber,f=this.modifiedLineNumber;const v=this.modifiedLineNumber+this.lineCount;if(t.ranges.length===0)this.showAll(e),i.push(this);else{let d=0;for(const l of t.ranges){const u=d===t.ranges.length-1;d++;const r=(u?v:l.endLineNumberExclusive)-f,g=new T(o,f,r,0,0);g.setHiddenModifiedRange(l,e),i.push(g),o=g.originalUnchangedRange.endLineNumberExclusive,f=g.modifiedUnchangedRange.endLineNumberExclusive}}return i}shouldHideControls(n){return this._shouldHideControls.read(n)}getHiddenOriginalRange(n){return R.ofLength(this.originalLineNumber+this._visibleLineCountTop.read(n),this.lineCount-this._visibleLineCountTop.read(n)-this._visibleLineCountBottom.read(n))}getHiddenModifiedRange(n){return R.ofLength(this.modifiedLineNumber+this._visibleLineCountTop.read(n),this.lineCount-this._visibleLineCountTop.read(n)-this._visibleLineCountBottom.read(n))}setHiddenModifiedRange(n,e){const i=n.startLineNumber-this.modifiedLineNumber,t=this.modifiedLineNumber+this.lineCount-n.endLineNumberExclusive;this.setState(i,t,e)}getMaxVisibleLineCountTop(){return this.lineCount-this._visibleLineCountBottom.get()}getMaxVisibleLineCountBottom(){return this.lineCount-this._visibleLineCountTop.get()}showMoreAbove(n=10,e){const i=this.getMaxVisibleLineCountTop();this._visibleLineCountTop.set(Math.min(this._visibleLineCountTop.get()+n,i),e)}showMoreBelow(n=10,e){const i=this.lineCount-this._visibleLineCountTop.get();this._visibleLineCountBottom.set(Math.min(this._visibleLineCountBottom.get()+n,i),e)}showAll(n){this._visibleLineCountBottom.set(this.lineCount-this._visibleLineCountTop.get(),n)}showModifiedLine(n,e,i){const t=n+1-(this.modifiedLineNumber+this._visibleLineCountTop.get()),o=this.modifiedLineNumber-this._visibleLineCountBottom.get()+this.lineCount-n;e===0&&t<o||e===1?this._visibleLineCountTop.set(this._visibleLineCountTop.get()+t,i):this._visibleLineCountBottom.set(this._visibleLineCountBottom.get()+o,i)}showOriginalLine(n,e,i){const t=n-this.originalLineNumber,o=this.originalLineNumber+this.lineCount-n;e===0&&t<o||e===1?this._visibleLineCountTop.set(Math.min(this._visibleLineCountTop.get()+o-t,this.getMaxVisibleLineCountTop()),i):this._visibleLineCountBottom.set(Math.min(this._visibleLineCountBottom.get()+t-o,this.getMaxVisibleLineCountBottom()),i)}collapseAll(n){this._visibleLineCountTop.set(0,n),this._visibleLineCountBottom.set(0,n)}setState(n,e,i){n=Math.max(Math.min(n,this.lineCount),0),e=Math.max(Math.min(e,this.lineCount-n),0),this._visibleLineCountTop.set(n,i),this._visibleLineCountBottom.set(e,i)}}var de=(i=>(i[i.FromCloserSide=0]="FromCloserSide",i[i.FromTop=1]="FromTop",i[i.FromBottom=2]="FromBottom",i))(de||{});function _e(p,n,e,i){}function Ie(p,n,e,i){}export{S as DiffEditorViewModel,ae as DiffMapping,I as DiffState,de as RevealPreference,T as UnchangedRegion};
