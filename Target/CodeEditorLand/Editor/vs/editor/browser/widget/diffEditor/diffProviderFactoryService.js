var p=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var l=(a,e,t,i)=>{for(var n=i>1?void 0:i?v(e,t):e,o=a.length-1,f;o>=0;o--)(f=a[o])&&(n=(i?f(e,t,n):f(n))||n);return i&&n&&p(e,t,n),n},d=(a,e)=>(t,i)=>e(t,i,a);import"../../../../../vs/base/common/cancellation.js";import{Emitter as D}from"../../../../../vs/base/common/event.js";import"../../../../../vs/base/common/lifecycle.js";import{StopWatch as I}from"../../../../../vs/base/common/stopwatch.js";import{LineRange as u}from"../../../../../vs/editor/common/core/lineRange.js";import"../../../../../vs/editor/common/diff/documentDiffProvider.js";import{DetailedLineRangeMapping as y,RangeMapping as S}from"../../../../../vs/editor/common/diff/rangeMapping.js";import"../../../../../vs/editor/common/model.js";import{IEditorWorkerService as C}from"../../../../../vs/editor/common/services/editorWorker.js";import{InstantiationType as A,registerSingleton as E}from"../../../../../vs/platform/instantiation/common/extensions.js";import{createDecorator as M,IInstantiationService as b}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{ITelemetryService as O}from"../../../../../vs/platform/telemetry/common/telemetry.js";const w=M("diffProviderFactoryService");let c=class{constructor(e){this.instantiationService=e}_serviceBrand;createDiffProvider(e){return this.instantiationService.createInstance(r,e)}};c=l([d(0,b)],c),E(w,c,A.Delayed);let r=class{constructor(e,t,i){this.editorWorkerService=t;this.telemetryService=i;this.setOptions(e)}onDidChangeEventEmitter=new D;onDidChange=this.onDidChangeEventEmitter.event;diffAlgorithm="advanced";diffAlgorithmOnDidChangeSubscription=void 0;static diffCache=new Map;dispose(){this.diffAlgorithmOnDidChangeSubscription?.dispose()}async computeDiff(e,t,i,n){if(typeof this.diffAlgorithm!="string")return this.diffAlgorithm.computeDiff(e,t,i,n);if(e.isDisposed()||t.isDisposed())return{changes:[],identical:!0,quitEarly:!1,moves:[]};if(e.getLineCount()===1&&e.getLineMaxColumn(1)===1)return t.getLineCount()===1&&t.getLineMaxColumn(1)===1?{changes:[],identical:!0,quitEarly:!1,moves:[]}:{changes:[new y(new u(1,2),new u(1,t.getLineCount()+1),[new S(e.getFullModelRange(),t.getFullModelRange())])],identical:!1,quitEarly:!1,moves:[]};const o=JSON.stringify([e.uri.toString(),t.uri.toString()]),f=JSON.stringify([e.id,t.id,e.getAlternativeVersionId(),t.getAlternativeVersionId(),JSON.stringify(i)]),m=r.diffCache.get(o);if(m&&m.context===f)return m.result;const h=I.create(),s=await this.editorWorkerService.computeDiff(e.uri,t.uri,i,this.diffAlgorithm),g=h.elapsed();if(this.telemetryService.publicLog2("diffEditor.computeDiff",{timeMs:g,timedOut:s?.quitEarly??!0,detectedMoves:i.computeMoves?s?.moves.length??0:-1}),n.isCancellationRequested)return{changes:[],identical:!1,quitEarly:!0,moves:[]};if(!s)throw new Error("no diff result available");return r.diffCache.size>10&&r.diffCache.delete(r.diffCache.keys().next().value),r.diffCache.set(o,{result:s,context:f}),s}setOptions(e){let t=!1;e.diffAlgorithm&&this.diffAlgorithm!==e.diffAlgorithm&&(this.diffAlgorithmOnDidChangeSubscription?.dispose(),this.diffAlgorithmOnDidChangeSubscription=void 0,this.diffAlgorithm=e.diffAlgorithm,typeof e.diffAlgorithm!="string"&&(this.diffAlgorithmOnDidChangeSubscription=e.diffAlgorithm.onDidChange(()=>this.onDidChangeEventEmitter.fire())),t=!0),t&&this.onDidChangeEventEmitter.fire()}};r=l([d(1,C),d(2,O)],r);export{w as IDiffProviderFactoryService,c as WorkerBasedDiffProviderFactoryService,r as WorkerBasedDocumentDiffProvider};
