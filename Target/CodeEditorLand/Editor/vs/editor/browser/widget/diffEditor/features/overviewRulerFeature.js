var A=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var w=(g,s,f,a)=>{for(var t=a>1?void 0:a?B(s,f):s,_=g.length-1,I;_>=0;_--)(I=g[_])&&(t=(a?I(s,f,t):I(t))||t);return a&&t&&A(s,f,t),t},H=(g,s)=>(f,a)=>s(f,a,g);import{EventType as N,addDisposableListener as U,addStandardDisposableListener as k,h as q}from"../../../../../base/browser/dom.js";import{createFastDomNode as G}from"../../../../../base/browser/fastDomNode.js";import{ScrollbarState as J}from"../../../../../base/browser/ui/scrollbar/scrollbarState.js";import{Disposable as K}from"../../../../../base/common/lifecycle.js";import{autorun as S,autorunWithStore as Q,derived as X,observableFromEvent as Y,observableSignalFromEvent as V}from"../../../../../base/common/observable.js";import{defaultInsertColor as $,defaultRemoveColor as ee,diffInserted as oe,diffOverviewRulerInserted as ie,diffOverviewRulerRemoved as te,diffRemoved as re}from"../../../../../platform/theme/common/colorRegistry.js";import{IThemeService as ne}from"../../../../../platform/theme/common/themeService.js";import{EditorOption as de}from"../../../../common/config/editorOptions.js";import{Position as M}from"../../../../common/core/position.js";import{OverviewRulerZone as se}from"../../../../common/viewModel/overviewZoneManager.js";import{appendRemoveOnDispose as W}from"../utils.js";let e=class extends K{constructor(f,a,t,_,I,ae,le){super();this._editors=f;this._rootElement=a;this._diffModel=t;this._rootWidth=_;this._rootHeight=I;this._modifiedEditorLayoutInfo=ae;this._themeService=le;const L=Y(this._themeService.onDidColorThemeChange,()=>this._themeService.getColorTheme()),Z=X(l=>{const i=L.read(l),C=i.getColor(ie)||(i.getColor(oe)||$).transparent(2),d=i.getColor(te)||(i.getColor(re)||ee).transparent(2);return{insertColor:C,removeColor:d}}),r=G(document.createElement("div"));r.setClassName("diffViewport"),r.setPosition("absolute");const n=q("div.diffOverview",{style:{position:"absolute",top:"0px",width:e.ENTIRE_DIFF_OVERVIEW_WIDTH+"px"}}).root;this._register(W(n,r.domNode)),this._register(k(n,N.POINTER_DOWN,l=>{this._editors.modified.delegateVerticalScrollbarPointerDown(l)})),this._register(U(n,N.MOUSE_WHEEL,l=>{this._editors.modified.delegateScrollFromMouseWheelEvent(l)},{passive:!1})),this._register(W(this._rootElement,n)),this._register(Q((l,i)=>{const C=this._diffModel.read(l),d=this._editors.original.createOverviewRuler("original diffOverviewRuler");d&&(i.add(d),i.add(W(n,d.getDomNode())));const h=this._editors.modified.createOverviewRuler("modified diffOverviewRuler");if(h&&(i.add(h),i.add(W(n,h.getDomNode()))),!d||!h)return;const P=V("viewZoneChanged",this._editors.original.onDidChangeViewZones),x=V("viewZoneChanged",this._editors.modified.onDidChangeViewZones),j=V("hiddenRangesChanged",this._editors.original.onDidChangeHiddenAreas),F=V("hiddenRangesChanged",this._editors.modified.onDidChangeHiddenAreas);i.add(S(o=>{P.read(o),x.read(o),j.read(o),F.read(o);const c=Z.read(o),v=C?.diff.read(o)?.mappings;function E(m,p,D){const u=D._getViewModel();return u?m.filter(b=>b.length>0).map(b=>{const y=u.coordinatesConverter.convertModelPositionToViewPosition(new M(b.startLineNumber,1)),O=u.coordinatesConverter.convertModelPositionToViewPosition(new M(b.endLineNumberExclusive,1)),z=O.lineNumber-y.lineNumber;return new se(y.lineNumber,O.lineNumber,z,p.toString())}):[]}const T=E((v||[]).map(m=>m.lineRangeMapping.original),c.removeColor,this._editors.original),R=E((v||[]).map(m=>m.lineRangeMapping.modified),c.insertColor,this._editors.modified);d?.setZones(T),h?.setZones(R)})),i.add(S(o=>{const c=this._rootHeight.read(o),v=this._rootWidth.read(o),E=this._modifiedEditorLayoutInfo.read(o);if(E){const T=e.ENTIRE_DIFF_OVERVIEW_WIDTH-2*e.ONE_OVERVIEW_WIDTH;d.setLayout({top:0,height:c,right:T+e.ONE_OVERVIEW_WIDTH,width:e.ONE_OVERVIEW_WIDTH}),h.setLayout({top:0,height:c,right:0,width:e.ONE_OVERVIEW_WIDTH});const R=this._editors.modifiedScrollTop.read(o),m=this._editors.modifiedScrollHeight.read(o),p=this._editors.modified.getOption(de.scrollbar),D=new J(p.verticalHasArrows?p.arrowSize:0,p.verticalScrollbarSize,0,E.height,m,R);r.setTop(D.getSliderPosition()),r.setHeight(D.getSliderSize())}else r.setTop(0),r.setHeight(0);n.style.height=c+"px",n.style.left=v-e.ENTIRE_DIFF_OVERVIEW_WIDTH+"px",r.setWidth(e.ENTIRE_DIFF_OVERVIEW_WIDTH)}))}))}static ONE_OVERVIEW_WIDTH=15;static ENTIRE_DIFF_OVERVIEW_WIDTH=this.ONE_OVERVIEW_WIDTH*2;width=e.ENTIRE_DIFF_OVERVIEW_WIDTH};e=w([H(6,ne)],e);export{e as OverviewRulerFeature};
