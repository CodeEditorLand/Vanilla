var B=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var N=(p,s,f,a)=>{for(var t=a>1?void 0:a?U(s,f):s,_=p.length-1,I;_>=0;_--)(I=p[_])&&(t=(a?I(s,f,t):I(t))||t);return a&&t&&B(s,f,t),t},w=(p,s)=>(f,a)=>s(f,a,p);import{addDisposableListener as j,addStandardDisposableListener as k,EventType as S,h as q}from"../../../../../../vs/base/browser/dom.js";import{createFastDomNode as G}from"../../../../../../vs/base/browser/fastDomNode.js";import"../../../../../../vs/base/browser/mouseEvent.js";import{ScrollbarState as J}from"../../../../../../vs/base/browser/ui/scrollbar/scrollbarState.js";import"../../../../../../vs/base/common/color.js";import{Disposable as K}from"../../../../../../vs/base/common/lifecycle.js";import{autorun as y,autorunWithStore as Q,derived as X,observableFromEvent as Y,observableSignalFromEvent as V}from"../../../../../../vs/base/common/observable.js";import"../../../../../../vs/editor/browser/widget/codeEditor/codeEditorWidget.js";import"../../../../../../vs/editor/browser/widget/diffEditor/components/diffEditorEditors.js";import"../../../../../../vs/editor/browser/widget/diffEditor/diffEditorViewModel.js";import{appendRemoveOnDispose as W}from"../../../../../../vs/editor/browser/widget/diffEditor/utils.js";import{EditorOption as $}from"../../../../../../vs/editor/common/config/editorOptions.js";import"../../../../../../vs/editor/common/core/lineRange.js";import{Position as L}from"../../../../../../vs/editor/common/core/position.js";import{OverviewRulerZone as ee}from"../../../../../../vs/editor/common/viewModel/overviewZoneManager.js";import{defaultInsertColor as oe,defaultRemoveColor as ie,diffInserted as te,diffOverviewRulerInserted as re,diffOverviewRulerRemoved as ne,diffRemoved as de}from"../../../../../../vs/platform/theme/common/colorRegistry.js";import{IThemeService as se}from"../../../../../../vs/platform/theme/common/themeService.js";let e=class extends K{constructor(f,a,t,_,I,ae,le){super();this._editors=f;this._rootElement=a;this._diffModel=t;this._rootWidth=_;this._rootHeight=I;this._modifiedEditorLayoutInfo=ae;this._themeService=le;const M=Y(this._themeService.onDidColorThemeChange,()=>this._themeService.getColorTheme()),Z=X(l=>{const i=M.read(l),b=i.getColor(re)||(i.getColor(te)||oe).transparent(2),d=i.getColor(ne)||(i.getColor(de)||ie).transparent(2);return{insertColor:b,removeColor:d}}),r=G(document.createElement("div"));r.setClassName("diffViewport"),r.setPosition("absolute");const n=q("div.diffOverview",{style:{position:"absolute",top:"0px",width:e.ENTIRE_DIFF_OVERVIEW_WIDTH+"px"}}).root;this._register(W(n,r.domNode)),this._register(k(n,S.POINTER_DOWN,l=>{this._editors.modified.delegateVerticalScrollbarPointerDown(l)})),this._register(j(n,S.MOUSE_WHEEL,l=>{this._editors.modified.delegateScrollFromMouseWheelEvent(l)},{passive:!1})),this._register(W(this._rootElement,n)),this._register(Q((l,i)=>{const b=this._diffModel.read(l),d=this._editors.original.createOverviewRuler("original diffOverviewRuler");d&&(i.add(d),i.add(W(n,d.getDomNode())));const h=this._editors.modified.createOverviewRuler("modified diffOverviewRuler");if(h&&(i.add(h),i.add(W(n,h.getDomNode()))),!d||!h)return;const P=V("viewZoneChanged",this._editors.original.onDidChangeViewZones),x=V("viewZoneChanged",this._editors.modified.onDidChangeViewZones),F=V("hiddenRangesChanged",this._editors.original.onDidChangeHiddenAreas),z=V("hiddenRangesChanged",this._editors.modified.onDidChangeHiddenAreas);i.add(y(o=>{P.read(o),x.read(o),F.read(o),z.read(o);const c=Z.read(o),v=b?.diff.read(o)?.mappings;function E(m,g,D){const R=D._getViewModel();return R?m.filter(C=>C.length>0).map(C=>{const u=R.coordinatesConverter.convertModelPositionToViewPosition(new L(C.startLineNumber,1)),H=R.coordinatesConverter.convertModelPositionToViewPosition(new L(C.endLineNumberExclusive,1)),A=H.lineNumber-u.lineNumber;return new ee(u.lineNumber,H.lineNumber,A,g.toString())}):[]}const T=E((v||[]).map(m=>m.lineRangeMapping.original),c.removeColor,this._editors.original),O=E((v||[]).map(m=>m.lineRangeMapping.modified),c.insertColor,this._editors.modified);d?.setZones(T),h?.setZones(O)})),i.add(y(o=>{const c=this._rootHeight.read(o),v=this._rootWidth.read(o),E=this._modifiedEditorLayoutInfo.read(o);if(E){const T=e.ENTIRE_DIFF_OVERVIEW_WIDTH-2*e.ONE_OVERVIEW_WIDTH;d.setLayout({top:0,height:c,right:T+e.ONE_OVERVIEW_WIDTH,width:e.ONE_OVERVIEW_WIDTH}),h.setLayout({top:0,height:c,right:0,width:e.ONE_OVERVIEW_WIDTH});const O=this._editors.modifiedScrollTop.read(o),m=this._editors.modifiedScrollHeight.read(o),g=this._editors.modified.getOption($.scrollbar),D=new J(g.verticalHasArrows?g.arrowSize:0,g.verticalScrollbarSize,0,E.height,m,O);r.setTop(D.getSliderPosition()),r.setHeight(D.getSliderSize())}else r.setTop(0),r.setHeight(0);n.style.height=c+"px",n.style.left=v-e.ENTIRE_DIFF_OVERVIEW_WIDTH+"px",r.setWidth(e.ENTIRE_DIFF_OVERVIEW_WIDTH)}))}))}static ONE_OVERVIEW_WIDTH=15;static ENTIRE_DIFF_OVERVIEW_WIDTH=this.ONE_OVERVIEW_WIDTH*2;width=e.ENTIRE_DIFF_OVERVIEW_WIDTH};e=N([w(6,se)],e);export{e as OverviewRulerFeature};
