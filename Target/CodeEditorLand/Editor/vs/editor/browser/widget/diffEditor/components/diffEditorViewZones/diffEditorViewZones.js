var ge=Object.defineProperty;var fe=Object.getOwnPropertyDescriptor;var J=(t,l,_,p)=>{for(var c=p>1?void 0:p?fe(l,_):l,v=t.length-1,b;v>=0;v--)(b=t[v])&&(c=(p?b(l,_,c):b(c))||c);return p&&c&&ge(l,_,c),c},X=(t,l)=>(_,p)=>l(_,p,t);import{$ as me,addDisposableListener as K}from"../../../../../../base/browser/dom.js";import{ArrayQueue as Y}from"../../../../../../base/common/arrays.js";import{RunOnceScheduler as ue}from"../../../../../../base/common/async.js";import{Codicon as he}from"../../../../../../base/common/codicons.js";import{Disposable as pe,DisposableStore as ce}from"../../../../../../base/common/lifecycle.js";import{autorun as $,derived as ee,derivedWithStore as be,observableFromEvent as j,observableValue as V}from"../../../../../../base/common/observable.js";import{ThemeIcon as ie}from"../../../../../../base/common/themables.js";import{assertIsDefined as _e}from"../../../../../../base/common/types.js";import{applyFontInfo as Ie}from"../../../../config/domFontInfo.js";import"../../../codeEditor/codeEditorWidget.js";import{diffDeleteDecoration as Le,diffRemoveIcon as Ne}from"../../registrations.contribution.js";import"../diffEditorEditors.js";import{DiffMapping as ve}from"../../diffEditorViewModel.js";import"../../diffEditorWidget.js";import{InlineDiffDeletedCodeMargin as we}from"./inlineDiffDeletedCodeMargin.js";import{LineSource as Re,RenderOptions as Te,renderLines as Se}from"./renderLines.js";import{animatedObservable as ne,joinCombine as Ce}from"../../utils.js";import{EditorOption as R}from"../../../../../common/config/editorOptions.js";import{LineRange as F}from"../../../../../common/core/lineRange.js";import{Position as Me}from"../../../../../common/core/position.js";import"../../../../../common/diff/rangeMapping.js";import{ScrollType as oe}from"../../../../../common/editorCommon.js";import{BackgroundTokenizationState as xe}from"../../../../../common/tokenizationTextModelPart.js";import{InlineDecoration as Pe,InlineDecorationType as De}from"../../../../../common/viewModel.js";import{IClipboardService as Oe}from"../../../../../../platform/clipboard/common/clipboardService.js";import{IContextMenuService as Ae}from"../../../../../../platform/contextview/browser/contextView.js";import"../../diffEditorOptions.js";import{Range as ye}from"../../../../../common/core/range.js";let U=class extends pe{constructor(_,p,c,v,b,S,d,N,Z,A){super();this._targetWindow=_;this._editors=p;this._diffModel=c;this._options=v;this._diffEditorWidget=b;this._canIgnoreViewZoneUpdateEvent=S;this._origViewZonesToIgnore=d;this._modViewZonesToIgnore=N;this._clipboardService=Z;this._contextMenuService=A;const w=V("invalidateAlignmentsState",0),T=this._register(new ue(()=>{w.set(w.get()+1,void 0)},0));this._register(this._editors.original.onDidChangeViewZones(e=>{this._canIgnoreViewZoneUpdateEvent()||T.schedule()})),this._register(this._editors.modified.onDidChangeViewZones(e=>{this._canIgnoreViewZoneUpdateEvent()||T.schedule()})),this._register(this._editors.original.onDidChangeConfiguration(e=>{(e.hasChanged(R.wrappingInfo)||e.hasChanged(R.lineHeight))&&T.schedule()})),this._register(this._editors.modified.onDidChangeConfiguration(e=>{(e.hasChanged(R.wrappingInfo)||e.hasChanged(R.lineHeight))&&T.schedule()}));const G=this._diffModel.map(e=>e?j(this,e.model.original.onDidChangeTokens,()=>e.model.original.tokenization.backgroundTokenizationState===xe.Completed):void 0).map((e,i)=>e?.read(i)),C=ee(e=>{const i=this._diffModel.read(e),o=i?.diff.read(e);if(!i||!o)return null;w.read(e);const m=this._options.renderSideBySide.read(e);return te(this._editors.original,this._editors.modified,o.mappings,this._origViewZonesToIgnore,this._modViewZonesToIgnore,m)}),h=ee(e=>{const i=this._diffModel.read(e)?.movedTextToCompare.read(e);if(!i)return null;w.read(e);const o=i.changes.map(a=>new ve(a));return te(this._editors.original,this._editors.modified,o,this._origViewZonesToIgnore,this._modViewZonesToIgnore,!0)});function r(){const e=document.createElement("div");return e.className="diagonal-fill",e}const s=this._register(new ce);this.viewZones=be(this,(e,i)=>{s.clear();const o=C.read(e)||[],a=[],m=[],M=this._modifiedTopPadding.read(e);M>0&&m.push({afterLineNumber:0,domNode:document.createElement("div"),heightInPx:M,showInHiddenAreas:!0,suppressMouseDown:!0});const k=this._originalTopPadding.read(e);k>0&&a.push({afterLineNumber:0,domNode:document.createElement("div"),heightInPx:k,showInHiddenAreas:!0,suppressMouseDown:!0});const W=this._options.renderSideBySide.read(e),I=W?void 0:this._editors.modified._getViewModel()?.createLineBreaksComputer();if(I){const n=this._editors.original.getModel();for(const u of o)if(u.diff)for(let L=u.originalRange.startLineNumber;L<u.originalRange.endLineNumberExclusive;L++){if(L>n.getLineCount())return{orig:a,mod:m};I?.addRequest(n.getLineContent(L),null,null)}}const y=I?.finalize()??[];let se=0;const B=this._editors.modified.getOption(R.lineHeight),z=this._diffModel.read(e)?.movedTextToCompare.read(e),ae=this._editors.original.getModel()?.mightContainNonBasicASCII()??!1,le=this._editors.original.getModel()?.mightContainRTL()??!1,q=Te.fromEditor(this._editors.modified);for(const n of o)if(n.diff&&!W&&(!this._options.useTrueInlineDiffRendering.read(e)||!Ee(n.diff))){if(!n.originalRange.isEmpty){G.read(e);const L=document.createElement("div");L.classList.add("view-lines","line-delete","monaco-mouse-cursor-text");const E=this._editors.original.getModel();if(n.originalRange.endLineNumberExclusive-1>E.getLineCount())return{orig:a,mod:m};const x=new Re(n.originalRange.mapToLineArray(g=>E.tokenization.getLineTokens(g)),n.originalRange.mapToLineArray(g=>y[se++]),ae,le),P=[];for(const g of n.diff.innerChanges||[])P.push(new Pe(g.originalRange.delta(-(n.diff.original.startLineNumber-1)),Le.className,De.Regular));const D=Se(x,q,P,L),H=document.createElement("div");if(H.className="inline-deleted-margin-view-zone",Ie(H,q.fontInfo),this._options.renderIndicators.read(e))for(let g=0;g<D.heightInLines;g++){const O=document.createElement("div");O.className=`delete-sign ${ie.asClassName(Ne)}`,O.setAttribute("style",`position:absolute;top:${g*B}px;width:${q.lineDecorationsWidth}px;height:${B}px;right:0;`),H.appendChild(O)}let Q;s.add(new we(()=>_e(Q),H,this._editors.modified,n.diff,this._diffEditorWidget,D.viewLineCounts,this._editors.original.getModel(),this._contextMenuService,this._clipboardService));for(let g=0;g<D.viewLineCounts.length;g++){const O=D.viewLineCounts[g];O>1&&a.push({afterLineNumber:n.originalRange.startLineNumber+g,domNode:r(),heightInPx:(O-1)*B,showInHiddenAreas:!0,suppressMouseDown:!0})}m.push({afterLineNumber:n.modifiedRange.startLineNumber-1,domNode:L,heightInPx:D.heightInLines*B,minWidthInPx:D.minWidthInPx,marginDomNode:H,setZoneId(g){Q=g},showInHiddenAreas:!0,suppressMouseDown:!0})}const u=document.createElement("div");u.className="gutter-delete",a.push({afterLineNumber:n.originalRange.endLineNumberExclusive-1,domNode:r(),heightInPx:n.modifiedHeightInPx,marginDomNode:u,showInHiddenAreas:!0,suppressMouseDown:!0})}else{const u=n.modifiedHeightInPx-n.originalHeightInPx;if(u>0){if(z?.lineRangeMapping.original.delta(-1).deltaLength(2).contains(n.originalRange.endLineNumberExclusive-1))continue;a.push({afterLineNumber:n.originalRange.endLineNumberExclusive-1,domNode:r(),heightInPx:u,showInHiddenAreas:!0,suppressMouseDown:!0})}else{let L=function(){const x=document.createElement("div");return x.className="arrow-revert-change "+ie.asClassName(he.arrowRight),i.add(K(x,"mousedown",P=>P.stopPropagation())),i.add(K(x,"click",P=>{P.stopPropagation(),b.revert(n.diff)})),me("div",{},x)};var He=L;if(z?.lineRangeMapping.modified.delta(-1).deltaLength(2).contains(n.modifiedRange.endLineNumberExclusive-1))continue;let E;n.diff&&n.diff.modified.isEmpty&&this._options.shouldRenderOldRevertArrows.read(e)&&(E=L()),m.push({afterLineNumber:n.modifiedRange.endLineNumberExclusive-1,domNode:r(),heightInPx:-u,marginDomNode:E,showInHiddenAreas:!0,suppressMouseDown:!0})}}for(const n of h.read(e)??[]){if(!z?.lineRangeMapping.original.intersect(n.originalRange)||!z?.lineRangeMapping.modified.intersect(n.modifiedRange))continue;const u=n.modifiedHeightInPx-n.originalHeightInPx;u>0?a.push({afterLineNumber:n.originalRange.endLineNumberExclusive-1,domNode:r(),heightInPx:u,showInHiddenAreas:!0,suppressMouseDown:!0}):m.push({afterLineNumber:n.modifiedRange.endLineNumberExclusive-1,domNode:r(),heightInPx:-u,showInHiddenAreas:!0,suppressMouseDown:!0})}return{orig:a,mod:m}});let f=!1;this._register(this._editors.original.onDidScrollChange(e=>{e.scrollLeftChanged&&!f&&(f=!0,this._editors.modified.setScrollLeft(e.scrollLeft),f=!1)})),this._register(this._editors.modified.onDidScrollChange(e=>{e.scrollLeftChanged&&!f&&(f=!0,this._editors.original.setScrollLeft(e.scrollLeft),f=!1)})),this._originalScrollTop=j(this._editors.original.onDidScrollChange,()=>this._editors.original.getScrollTop()),this._modifiedScrollTop=j(this._editors.modified.onDidScrollChange,()=>this._editors.modified.getScrollTop()),this._register($(e=>{const i=this._originalScrollTop.read(e)-(this._originalScrollOffsetAnimated.get()-this._modifiedScrollOffsetAnimated.read(e))-(this._originalTopPadding.get()-this._modifiedTopPadding.read(e));i!==this._editors.modified.getScrollTop()&&this._editors.modified.setScrollTop(i,oe.Immediate)})),this._register($(e=>{const i=this._modifiedScrollTop.read(e)-(this._modifiedScrollOffsetAnimated.get()-this._originalScrollOffsetAnimated.read(e))-(this._modifiedTopPadding.get()-this._originalTopPadding.read(e));i!==this._editors.original.getScrollTop()&&this._editors.original.setScrollTop(i,oe.Immediate)})),this._register($(e=>{const i=this._diffModel.read(e)?.movedTextToCompare.read(e);let o=0;if(i){const a=this._editors.original.getTopForLineNumber(i.lineRangeMapping.original.startLineNumber,!0)-this._originalTopPadding.get();o=this._editors.modified.getTopForLineNumber(i.lineRangeMapping.modified.startLineNumber,!0)-this._modifiedTopPadding.get()-a}o>0?(this._modifiedTopPadding.set(0,void 0),this._originalTopPadding.set(o,void 0)):o<0?(this._modifiedTopPadding.set(-o,void 0),this._originalTopPadding.set(0,void 0)):setTimeout(()=>{this._modifiedTopPadding.set(0,void 0),this._originalTopPadding.set(0,void 0)},400),this._editors.modified.hasTextFocus()?this._originalScrollOffset.set(this._modifiedScrollOffset.get()-o,void 0,!0):this._modifiedScrollOffset.set(this._originalScrollOffset.get()+o,void 0,!0)}))}_originalTopPadding=V(this,0);_originalScrollTop;_originalScrollOffset=V(this,0);_originalScrollOffsetAnimated=ne(this._targetWindow,this._originalScrollOffset,this._store);_modifiedTopPadding=V(this,0);_modifiedScrollTop;_modifiedScrollOffset=V(this,0);_modifiedScrollOffsetAnimated=ne(this._targetWindow,this._modifiedScrollOffset,this._store);viewZones};U=J([X(8,Oe),X(9,Ae)],U);function te(t,l,_,p,c,v){const b=new Y(re(t,p)),S=new Y(re(l,c)),d=t.getOption(R.lineHeight),N=l.getOption(R.lineHeight),Z=[];let A=0,w=0;function T(C,h){for(;;){let r=b.peek(),s=S.peek();if(r&&r.lineNumber>=C&&(r=void 0),s&&s.lineNumber>=h&&(s=void 0),!r&&!s)break;const f=r?r.lineNumber-A:Number.MAX_VALUE,e=s?s.lineNumber-w:Number.MAX_VALUE;f<e?(b.dequeue(),s={lineNumber:r.lineNumber-A+w,heightInPx:0}):f>e?(S.dequeue(),r={lineNumber:s.lineNumber-w+A,heightInPx:0}):(b.dequeue(),S.dequeue()),Z.push({originalRange:F.ofLength(r.lineNumber,1),modifiedRange:F.ofLength(s.lineNumber,1),originalHeightInPx:d+r.heightInPx,modifiedHeightInPx:N+s.heightInPx,diff:void 0})}}for(const C of _){let e=function(i,o,a=!1){if(i<f||o<s)return;if(r)r=!1;else if(!a&&(i===f||o===s))return;const m=new F(f,i),M=new F(s,o);if(m.isEmpty&&M.isEmpty)return;const k=b.takeWhile(I=>I.lineNumber<i)?.reduce((I,y)=>I+y.heightInPx,0)??0,W=S.takeWhile(I=>I.lineNumber<o)?.reduce((I,y)=>I+y.heightInPx,0)??0;Z.push({originalRange:m,modifiedRange:M,originalHeightInPx:m.length*d+k,modifiedHeightInPx:M.length*N+W,diff:C.lineRangeMapping}),f=i,s=o};var G=e;const h=C.lineRangeMapping;T(h.original.startLineNumber,h.modified.startLineNumber);let r=!0,s=h.modified.startLineNumber,f=h.original.startLineNumber;if(v)for(const i of h.innerChanges||[]){i.originalRange.startColumn>1&&i.modifiedRange.startColumn>1&&e(i.originalRange.startLineNumber,i.modifiedRange.startLineNumber);const o=t.getModel(),a=i.originalRange.endLineNumber<=o.getLineCount()?o.getLineMaxColumn(i.originalRange.endLineNumber):Number.MAX_SAFE_INTEGER;i.originalRange.endColumn<a&&e(i.originalRange.endLineNumber,i.modifiedRange.endLineNumber)}e(h.original.endLineNumberExclusive,h.modified.endLineNumberExclusive,!0),A=h.original.endLineNumberExclusive,w=h.modified.endLineNumberExclusive}return T(Number.MAX_VALUE,Number.MAX_VALUE),Z}function re(t,l){const _=[],p=[],c=t.getOption(R.wrappingInfo).wrappingColumn!==-1,v=t._getViewModel().coordinatesConverter,b=t.getOption(R.lineHeight);if(c)for(let d=1;d<=t.getModel().getLineCount();d++){const N=v.getModelLineViewLineCount(d);N>1&&p.push({lineNumber:d,heightInPx:b*(N-1)})}for(const d of t.getWhitespaces()){if(l.has(d.id))continue;const N=d.afterLineNumber===0?0:v.convertViewPositionToModelPosition(new Me(d.afterLineNumber,1)).lineNumber;_.push({lineNumber:N,heightInPx:d.height})}return Ce(_,p,d=>d.lineNumber,(d,N)=>({lineNumber:d.lineNumber,heightInPx:d.heightInPx+N.heightInPx}))}function Ee(t){return t.innerChanges?t.innerChanges.every(l=>de(l.modifiedRange)&&de(l.originalRange)||l.originalRange.equalsRange(new ye(1,1,1,1))):!1}function de(t){return t.startLineNumber===t.endLineNumber}export{U as DiffEditorViewZones,Ee as allowsTrueInlineDiffRendering};
