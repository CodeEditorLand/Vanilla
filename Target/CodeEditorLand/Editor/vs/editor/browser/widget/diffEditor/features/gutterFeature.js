var H=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var w=(h,p,e,i)=>{for(var t=i>1?void 0:i?V(p,e):p,n=h.length-1,r;n>=0;n--)(r=h[n])&&(t=(i?r(p,e,t):r(t))||t);return i&&t&&H(p,e,t),t},g=(h,p)=>(e,i)=>p(e,i,h);import{EventType as U,addDisposableListener as E,h as I}from"../../../../../base/browser/dom.js";import{ActionsOrientation as W}from"../../../../../base/browser/ui/actionbar/actionbar.js";import{HoverPosition as k}from"../../../../../base/browser/ui/hover/hoverWidget.js";import{Disposable as D}from"../../../../../base/common/lifecycle.js";import{autorun as G,autorunWithStore as j,derived as c,derivedDisposable as P,derivedWithSetter as F,observableFromEvent as K,observableValue as N}from"../../../../../base/common/observable.js";import{HiddenItemStrategy as B,MenuWorkbenchToolBar as z}from"../../../../../platform/actions/browser/toolbar.js";import{IMenuService as $,MenuId as M}from"../../../../../platform/actions/common/actions.js";import{IContextKeyService as q}from"../../../../../platform/contextkey/common/contextkey.js";import{WorkbenchHoverDelegate as J}from"../../../../../platform/hover/browser/hover.js";import{IInstantiationService as L}from"../../../../../platform/instantiation/common/instantiation.js";import{EditorOption as Q}from"../../../../common/config/editorOptions.js";import{LineRange as X,LineRangeSet as Y}from"../../../../common/core/lineRange.js";import{OffsetRange as x}from"../../../../common/core/offsetRange.js";import{Range as Z}from"../../../../common/core/range.js";import{TextEdit as ee}from"../../../../common/core/textEdit.js";import{DetailedLineRangeMapping as te}from"../../../../common/diff/rangeMapping.js";import{TextModelText as O}from"../../../../common/model/textModelText.js";import{ActionRunnerWithContext as ie}from"../../multiDiffEditor/utils.js";import{DiffEditorSash as ne}from"../components/diffEditorSash.js";import{appendRemoveOnDispose as se,applyStyle as re,prependRemoveOnDispose as oe}from"../utils.js";import{EditorGutter as ae}from"../utils/editorGutter.js";const R=[],b=35;let S=class extends D{constructor(e,i,t,n,r,a,o,s,m){super();this._diffModel=i;this._editors=t;this._options=n;this._sashLayout=r;this._boundarySashes=a;this._instantiationService=o;this._contextKeyService=s;this._menuService=m;this._register(oe(e,this.elements.root)),this._register(E(this.elements.root,"click",()=>{this._editors.modified.focus()})),this._register(re(this.elements.root,{display:this._hasActions.map(d=>d?"block":"none")})),P(this,d=>this._showSash.read(d)?new ne(e,this._sashLayout.dimensions,this._options.enableSplitViewResizing,this._boundarySashes,F(this,u=>this._sashLayout.sashLeft.read(u)-b,(u,y)=>this._sashLayout.sashLeft.set(u+b,y)),()=>this._sashLayout.resetSash()):void 0).recomputeInitiallyAndOnChange(this._store);const f=c(this,d=>{const l=this._diffModel.read(d);if(!l)return[];const u=l.diff.read(d);if(!u)return[];const y=this._selectedDiffs.read(d);if(y.length>0){const v=te.fromRangeMappings(y.flatMap(T=>T.rangeMappings));return[new C(v,!0,M.DiffEditorSelectionToolbar,void 0,l.model.original.uri,l.model.modified.uri)]}const A=this._currentDiff.read(d);return u.mappings.map(v=>new C(v.lineRangeMapping.withInnerChangesFromLineRanges(),v.lineRangeMapping===A?.lineRangeMapping,M.DiffEditorHunkToolbar,void 0,l.model.original.uri,l.model.modified.uri))});this._register(new ae(this._editors.modified,this.elements.root,{getIntersectingGutterItems:(d,l)=>f.read(l),createView:(d,l)=>this._instantiationService.createInstance(_,d,l,this)})),this._register(E(this.elements.gutter,U.MOUSE_WHEEL,d=>{this._editors.modified.getOption(Q.scrollbar).handleMouseWheel&&this._editors.modified.delegateScrollFromMouseWheelEvent(d)},{passive:!1}))}_menu=this._register(this._menuService.createMenu(M.DiffEditorHunkToolbar,this._contextKeyService));_actions=K(this,this._menu.onDidChange,()=>this._menu.getActions());_hasActions=this._actions.map(e=>e.length>0);_showSash=c(this,e=>this._options.renderSideBySide.read(e)&&this._hasActions.read(e));width=c(this,e=>this._hasActions.read(e)?b:0);elements=I("div.gutter@gutter",{style:{position:"absolute",height:"100%",width:b+"px"}},[]);computeStagedValue(e){const i=e.innerChanges??[],t=new O(this._editors.modifiedModel.get()),n=new O(this._editors.original.getModel());return new ee(i.map(o=>o.toTextEdit(t))).apply(n)}_currentDiff=c(this,e=>{const i=this._diffModel.read(e);if(!i)return;const t=i.diff.read(e)?.mappings,n=this._editors.modifiedCursor.read(e);if(n)return t?.find(r=>r.lineRangeMapping.modified.contains(n.lineNumber))});_selectedDiffs=c(this,e=>{const t=this._diffModel.read(e)?.diff.read(e);if(!t)return R;const n=this._editors.modifiedSelections.read(e);if(n.every(s=>s.isEmpty()))return R;const r=new Y(n.map(s=>X.fromRangeInclusive(s))),o=t.mappings.filter(s=>s.lineRangeMapping.innerChanges&&r.intersects(s.lineRangeMapping.modified)).map(s=>({mapping:s,rangeMappings:s.lineRangeMapping.innerChanges.filter(m=>n.some(f=>Z.areIntersecting(m.modifiedRange,f)))}));return o.length===0||o.every(s=>s.rangeMappings.length===0)?R:o});layout(e){this.elements.gutter.style.left=e+"px"}};S=w([g(6,L),g(7,q),g(8,$)],S);class C{constructor(p,e,i,t,n,r){this.mapping=p;this.showAlways=e;this.menuId=i;this.rangeOverride=t;this.originalUri=n;this.modifiedUri=r}get id(){return this.mapping.modified.toString()}get range(){return this.rangeOverride??this.mapping.modified}}let _=class extends D{constructor(e,i,t,n){super();this._item=e;const r=this._register(n.createInstance(J,"element",!0,{position:{hoverPosition:k.RIGHT}}));this._register(se(i,this._elements.root)),this._register(G(a=>{const o=this._showAlways.read(a);this._elements.root.classList.toggle("noTransition",!0),this._elements.root.classList.toggle("showAlways",o),setTimeout(()=>{this._elements.root.classList.toggle("noTransition",!1)},0)})),this._register(j((a,o)=>{this._elements.buttons.replaceChildren();const s=o.add(n.createInstance(z,this._elements.buttons,this._menuId.read(a),{orientation:W.VERTICAL,hoverDelegate:r,toolbarOptions:{primaryGroup:m=>m.startsWith("primary")},overflowBehavior:{maxItems:this._isSmall.read(a)?1:3},hiddenItemStrategy:B.Ignore,actionRunner:new ie(()=>{const m=this._item.get(),f=m.mapping;return{mapping:f,originalWithModifiedChanges:t.computeStagedValue(f),originalUri:m.originalUri,modifiedUri:m.modifiedUri}}),menuOptions:{shouldForwardArgs:!0}}));o.add(s.onDidChangeMenuItems(()=>{this._lastItemRange&&this.layout(this._lastItemRange,this._lastViewRange)}))}))}_elements=I("div.gutterItem",{style:{height:"20px",width:"34px"}},[I("div.background@background",{},[]),I("div.buttons@buttons",{},[])]);_showAlways=this._item.map(this,e=>e.showAlways);_menuId=this._item.map(this,e=>e.menuId);_isSmall=N(this,!1);_lastItemRange=void 0;_lastViewRange=void 0;layout(e,i){this._lastItemRange=e,this._lastViewRange=i;let t=this._elements.buttons.clientHeight;this._isSmall.set(this._item.get().mapping.original.startLineNumber===1&&e.length<30,void 0),t=this._elements.buttons.clientHeight;const n=e.length/2-t/2,r=t;let a=e.start+n;const o=x.tryCreate(r,i.endExclusive-r-t),s=x.tryCreate(e.start+r,e.endExclusive-t-r);s&&o&&s.start<s.endExclusive&&(a=o.clip(a),a=s.clip(a)),this._elements.buttons.style.top=`${a-e.start}px`}};_=w([g(3,L)],_);export{S as DiffEditorGutter};
