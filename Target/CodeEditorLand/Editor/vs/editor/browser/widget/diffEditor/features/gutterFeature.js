var H=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var S=(h,m,e,i)=>{for(var t=i>1?void 0:i?U(m,e):m,n=h.length-1,s;n>=0;n--)(s=h[n])&&(t=(i?s(m,e,t):s(t))||t);return i&&t&&H(m,e,t),t},u=(h,m)=>(e,i)=>m(e,i,h);import{addDisposableListener as E,EventType as V,h as v}from"../../../../../../vs/base/browser/dom.js";import"../../../../../../vs/base/browser/mouseEvent.js";import{ActionsOrientation as W}from"../../../../../../vs/base/browser/ui/actionbar/actionbar.js";import{HoverPosition as k}from"../../../../../../vs/base/browser/ui/hover/hoverWidget.js";import"../../../../../../vs/base/browser/ui/sash/sash.js";import{Disposable as D}from"../../../../../../vs/base/common/lifecycle.js";import{autorun as G,autorunWithStore as P,derived as y,observableFromEvent as F,observableValue as K}from"../../../../../../vs/base/common/observable.js";import{derivedDisposable as N,derivedWithSetter as B}from"../../../../../../vs/base/common/observableInternal/derived.js";import"../../../../../../vs/base/common/uri.js";import"../../../../../../vs/editor/browser/widget/diffEditor/components/diffEditorEditors.js";import{DiffEditorSash as z}from"../../../../../../vs/editor/browser/widget/diffEditor/components/diffEditorSash.js";import"../../../../../../vs/editor/browser/widget/diffEditor/diffEditorOptions.js";import"../../../../../../vs/editor/browser/widget/diffEditor/diffEditorViewModel.js";import{appendRemoveOnDispose as $,applyStyle as j,prependRemoveOnDispose as q}from"../../../../../../vs/editor/browser/widget/diffEditor/utils.js";import{EditorGutter as J}from"../../../../../../vs/editor/browser/widget/diffEditor/utils/editorGutter.js";import{ActionRunnerWithContext as Q}from"../../../../../../vs/editor/browser/widget/multiDiffEditor/utils.js";import{EditorOption as X}from"../../../../../../vs/editor/common/config/editorOptions.js";import{LineRange as Y,LineRangeSet as Z}from"../../../../../../vs/editor/common/core/lineRange.js";import{OffsetRange as L}from"../../../../../../vs/editor/common/core/offsetRange.js";import{Range as ee}from"../../../../../../vs/editor/common/core/range.js";import{TextEdit as te}from"../../../../../../vs/editor/common/core/textEdit.js";import{DetailedLineRangeMapping as ie}from"../../../../../../vs/editor/common/diff/rangeMapping.js";import{TextModelText as x}from"../../../../../../vs/editor/common/model/textModelText.js";import{HiddenItemStrategy as ne,MenuWorkbenchToolBar as re}from"../../../../../../vs/platform/actions/browser/toolbar.js";import{IMenuService as se,MenuId as M}from"../../../../../../vs/platform/actions/common/actions.js";import{IContextKeyService as oe}from"../../../../../../vs/platform/contextkey/common/contextkey.js";import{WorkbenchHoverDelegate as ae}from"../../../../../../vs/platform/hover/browser/hover.js";import{IInstantiationService as O}from"../../../../../../vs/platform/instantiation/common/instantiation.js";const w=[],I=35;let b=class extends D{constructor(e,i,t,n,s,a,o,r,p){super();this._diffModel=i;this._editors=t;this._options=n;this._sashLayout=s;this._boundarySashes=a;this._instantiationService=o;this._contextKeyService=r;this._menuService=p;this._register(q(e,this.elements.root)),this._register(E(this.elements.root,"click",()=>{this._editors.modified.focus()})),this._register(j(this.elements.root,{display:this._hasActions.map(d=>d?"block":"none")})),N(this,d=>this._showSash.read(d)?new z(e,this._sashLayout.dimensions,this._options.enableSplitViewResizing,this._boundarySashes,B(this,l=>this._sashLayout.sashLeft.read(l)-I,(l,c)=>this._sashLayout.sashLeft.set(l+I,c)),()=>this._sashLayout.resetSash()):void 0).recomputeInitiallyAndOnChange(this._store),this._register(new J(this._editors.modified,this.elements.root,{getIntersectingGutterItems:(d,f)=>{const l=this._diffModel.read(f);if(!l)return[];const c=l.diff.read(f);if(!c)return[];const R=this._selectedDiffs.read(f);if(R.length>0){const _=ie.fromRangeMappings(R.flatMap(T=>T.rangeMappings));return[new C(_,!0,M.DiffEditorSelectionToolbar,void 0,l.model.original.uri,l.model.modified.uri)]}const A=this._currentDiff.read(f);return c.mappings.map(_=>new C(_.lineRangeMapping.withInnerChangesFromLineRanges(),_.lineRangeMapping===A?.lineRangeMapping,M.DiffEditorHunkToolbar,void 0,l.model.original.uri,l.model.modified.uri))},createView:(d,f)=>this._instantiationService.createInstance(g,d,f,this)})),this._register(E(this.elements.gutter,V.MOUSE_WHEEL,d=>{this._editors.modified.getOption(X.scrollbar).handleMouseWheel&&this._editors.modified.delegateScrollFromMouseWheelEvent(d)},{passive:!1}))}_menu=this._register(this._menuService.createMenu(M.DiffEditorHunkToolbar,this._contextKeyService));_actions=F(this,this._menu.onDidChange,()=>this._menu.getActions());_hasActions=this._actions.map(e=>e.length>0);_showSash=y(this,e=>this._options.renderSideBySide.read(e)&&this._hasActions.read(e));width=y(this,e=>this._hasActions.read(e)?I:0);elements=v("div.gutter@gutter",{style:{position:"absolute",height:"100%",width:I+"px"}},[]);computeStagedValue(e){const i=e.innerChanges??[],t=new x(this._editors.modifiedModel.get()),n=new x(this._editors.original.getModel());return new te(i.map(o=>o.toTextEdit(t))).apply(n)}_currentDiff=y(this,e=>{const i=this._diffModel.read(e);if(!i)return;const t=i.diff.read(e)?.mappings,n=this._editors.modifiedCursor.read(e);if(n)return t?.find(s=>s.lineRangeMapping.modified.contains(n.lineNumber))});_selectedDiffs=y(this,e=>{const t=this._diffModel.read(e)?.diff.read(e);if(!t)return w;const n=this._editors.modifiedSelections.read(e);if(n.every(r=>r.isEmpty()))return w;const s=new Z(n.map(r=>Y.fromRangeInclusive(r))),o=t.mappings.filter(r=>r.lineRangeMapping.innerChanges&&s.intersects(r.lineRangeMapping.modified)).map(r=>({mapping:r,rangeMappings:r.lineRangeMapping.innerChanges.filter(p=>n.some(d=>ee.areIntersecting(p.modifiedRange,d)))}));return o.length===0||o.every(r=>r.rangeMappings.length===0)?w:o});layout(e){this.elements.gutter.style.left=e+"px"}};b=S([u(6,O),u(7,oe),u(8,se)],b);class C{constructor(m,e,i,t,n,s){this.mapping=m;this.showAlways=e;this.menuId=i;this.rangeOverride=t;this.originalUri=n;this.modifiedUri=s}get id(){return this.mapping.modified.toString()}get range(){return this.rangeOverride??this.mapping.modified}}let g=class extends D{constructor(e,i,t,n){super();this._item=e;const s=this._register(n.createInstance(ae,"element",!0,{position:{hoverPosition:k.RIGHT}}));this._register($(i,this._elements.root)),this._register(G(a=>{const o=this._showAlways.read(a);this._elements.root.classList.toggle("noTransition",!0),this._elements.root.classList.toggle("showAlways",o),setTimeout(()=>{this._elements.root.classList.toggle("noTransition",!1)},0)})),this._register(P((a,o)=>{this._elements.buttons.replaceChildren();const r=o.add(n.createInstance(re,this._elements.buttons,this._menuId.read(a),{orientation:W.VERTICAL,hoverDelegate:s,toolbarOptions:{primaryGroup:p=>p.startsWith("primary")},overflowBehavior:{maxItems:this._isSmall.read(a)?1:3},hiddenItemStrategy:ne.Ignore,actionRunner:new Q(()=>{const p=this._item.get(),d=p.mapping;return{mapping:d,originalWithModifiedChanges:t.computeStagedValue(d),originalUri:p.originalUri,modifiedUri:p.modifiedUri}}),menuOptions:{shouldForwardArgs:!0}}));o.add(r.onDidChangeMenuItems(()=>{this._lastItemRange&&this.layout(this._lastItemRange,this._lastViewRange)}))}))}_elements=v("div.gutterItem",{style:{height:"20px",width:"34px"}},[v("div.background@background",{},[]),v("div.buttons@buttons",{},[])]);_showAlways=this._item.map(this,e=>e.showAlways);_menuId=this._item.map(this,e=>e.menuId);_isSmall=K(this,!1);_lastItemRange=void 0;_lastViewRange=void 0;layout(e,i){this._lastItemRange=e,this._lastViewRange=i;let t=this._elements.buttons.clientHeight;this._isSmall.set(this._item.get().mapping.original.startLineNumber===1&&e.length<30,void 0),t=this._elements.buttons.clientHeight;const n=e.length/2-t/2,s=t;let a=e.start+n;const o=L.tryCreate(s,i.endExclusive-s-t),r=L.tryCreate(e.start+s,e.endExclusive-t-s);r&&o&&r.start<r.endExclusive&&(a=o.clip(a),a=r.clip(a)),this._elements.buttons.style.top=`${a-e.start}px`}};g=S([u(3,O)],g);export{b as DiffEditorGutter};
