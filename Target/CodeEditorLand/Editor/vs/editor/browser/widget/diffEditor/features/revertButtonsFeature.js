import{addDisposableListener as l,EventType as m,h as R}from"../../../../../../vs/base/browser/dom.js";import{renderIcon as b}from"../../../../../../vs/base/browser/ui/iconLabel/iconLabels.js";import{Codicon as D}from"../../../../../../vs/base/common/codicons.js";import{Disposable as u,toDisposable as E}from"../../../../../../vs/base/common/lifecycle.js";import{autorunWithStore as w,derived as N}from"../../../../../../vs/base/common/observable.js";import"../../../../../../vs/editor/browser/editorBrowser.js";import"../../../../../../vs/editor/browser/widget/diffEditor/components/diffEditorEditors.js";import"../../../../../../vs/editor/browser/widget/diffEditor/diffEditorOptions.js";import"../../../../../../vs/editor/browser/widget/diffEditor/diffEditorViewModel.js";import"../../../../../../vs/editor/browser/widget/diffEditor/diffEditorWidget.js";import{LineRange as W,LineRangeSet as C}from"../../../../../../vs/editor/common/core/lineRange.js";import{Range as I}from"../../../../../../vs/editor/common/core/range.js";import{LineRangeMapping as L}from"../../../../../../vs/editor/common/diff/rangeMapping.js";import{GlyphMarginLane as S}from"../../../../../../vs/editor/common/model.js";import{localize as _}from"../../../../../../vs/nls.js";const h=[];class te extends u{constructor(r,c,p,o){super();this._editors=r;this._diffModel=c;this._options=p;this._widget=o;this._register(w((e,f)=>{if(!this._options.shouldRenderOldRevertArrows.read(e))return;const n=this._diffModel.read(e),i=n?.diff.read(e);if(!n||!i||n.movedTextToCompare.read(e))return;const s=[],d=this._selectedDiffs.read(e),M=new Set(d.map(t=>t.mapping));if(d.length>0){const t=this._editors.modifiedSelections.read(e),a=f.add(new g(t[t.length-1].positionLineNumber,this._widget,d.flatMap(y=>y.rangeMappings),!0));this._editors.modified.addGlyphMarginWidget(a),s.push(a)}for(const t of i.mappings)if(!M.has(t)&&!t.lineRangeMapping.modified.isEmpty&&t.lineRangeMapping.innerChanges){const a=f.add(new g(t.lineRangeMapping.modified.startLineNumber,this._widget,t.lineRangeMapping,!1));this._editors.modified.addGlyphMarginWidget(a),s.push(a)}f.add(E(()=>{for(const t of s)this._editors.modified.removeGlyphMarginWidget(t)}))}))}_selectedDiffs=N(this,r=>{const p=this._diffModel.read(r)?.diff.read(r);if(!p)return h;const o=this._editors.modifiedSelections.read(r);if(o.every(i=>i.isEmpty()))return h;const e=new C(o.map(i=>W.fromRangeInclusive(i))),n=p.mappings.filter(i=>i.lineRangeMapping.innerChanges&&e.intersects(i.lineRangeMapping.modified)).map(i=>({mapping:i,rangeMappings:i.lineRangeMapping.innerChanges.filter(s=>o.some(d=>I.areIntersecting(s.modifiedRange,d)))}));return n.length===0||n.every(i=>i.rangeMappings.length===0)?h:n})}class g extends u{constructor(r,c,p,o){super();this._lineNumber=r;this._widget=c;this._diffs=p;this._revertSelection=o;this._register(l(this._domNode,m.MOUSE_DOWN,e=>{e.button!==2&&(e.stopPropagation(),e.preventDefault())})),this._register(l(this._domNode,m.MOUSE_UP,e=>{e.stopPropagation(),e.preventDefault()})),this._register(l(this._domNode,m.CLICK,e=>{this._diffs instanceof L?this._widget.revert(this._diffs):this._widget.revertRangeMappings(this._diffs),e.stopPropagation(),e.preventDefault()}))}static counter=0;_id=`revertButton${g.counter++}`;getId(){return this._id}_domNode=R("div.revertButton",{title:this._revertSelection?_("revertSelectedChanges","Revert Selected Changes"):_("revertChange","Revert Change")},[b(D.arrowRight)]).root;getDomNode(){return this._domNode}getPosition(){return{lane:S.Right,range:{startColumn:1,startLineNumber:this._lineNumber,endColumn:1,endLineNumber:this._lineNumber},zIndex:10001}}}export{g as RevertButton,te as RevertButtonsFeature};
