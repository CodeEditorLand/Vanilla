import{addStandardDisposableListener as M,getDomNodePagePosition as C}from"../../../../../../../vs/base/browser/dom.js";import{Action as u}from"../../../../../../../vs/base/common/actions.js";import{Codicon as w}from"../../../../../../../vs/base/common/codicons.js";import{Disposable as L}from"../../../../../../../vs/base/common/lifecycle.js";import{isIOS as D}from"../../../../../../../vs/base/common/platform.js";import{ThemeIcon as I}from"../../../../../../../vs/base/common/themables.js";import{MouseTargetType as h}from"../../../../../../../vs/editor/browser/editorBrowser.js";import"../../../../../../../vs/editor/browser/widget/codeEditor/codeEditorWidget.js";import"../../../../../../../vs/editor/browser/widget/diffEditor/diffEditorWidget.js";import{EditorOption as m}from"../../../../../../../vs/editor/common/config/editorOptions.js";import"../../../../../../../vs/editor/common/diff/rangeMapping.js";import{EndOfLineSequence as x}from"../../../../../../../vs/editor/common/model.js";import{localize as n}from"../../../../../../../vs/nls.js";import"../../../../../../../vs/platform/clipboard/common/clipboardService.js";import"../../../../../../../vs/platform/contextview/browser/contextView.js";class te extends L{constructor(o,v,i,t,y,p,b,g,l){super();this._getViewZoneId=o;this._marginDomNode=v;this._modifiedEditor=i;this._diff=t;this._editor=y;this._viewLineCounts=p;this._originalTextModel=b;this._contextMenuService=g;this._clipboardService=l;this._marginDomNode.style.zIndex="10",this._diffActions=document.createElement("div"),this._diffActions.className=I.asClassName(w.lightBulb)+" lightbulb-glyph",this._diffActions.style.position="absolute";const r=this._modifiedEditor.getOption(m.lineHeight);this._diffActions.style.right="0px",this._diffActions.style.visibility="hidden",this._diffActions.style.height=`${r}px`,this._diffActions.style.lineHeight=`${r}px`,this._marginDomNode.appendChild(this._diffActions);let a=0;const E=i.getOption(m.useShadowDOM)&&!D,_=(e,f)=>{this._contextMenuService.showContextMenu({domForShadowRoot:E?i.getDomNode()??void 0:void 0,getAnchor:()=>({x:e,y:f}),getActions:()=>{const s=[],c=t.modified.isEmpty;return s.push(new u("diff.clipboard.copyDeletedContent",c?t.original.length>1?n("diff.clipboard.copyDeletedLinesContent.label","Copy deleted lines"):n("diff.clipboard.copyDeletedLinesContent.single.label","Copy deleted line"):t.original.length>1?n("diff.clipboard.copyChangedLinesContent.label","Copy changed lines"):n("diff.clipboard.copyChangedLinesContent.single.label","Copy changed line"),void 0,!0,async()=>{const d=this._originalTextModel.getValueInRange(t.original.toExclusiveRange());await this._clipboardService.writeText(d)})),t.original.length>1&&s.push(new u("diff.clipboard.copyDeletedLineContent",c?n("diff.clipboard.copyDeletedLineContent.label","Copy deleted line ({0})",t.original.startLineNumber+a):n("diff.clipboard.copyChangedLineContent.label","Copy changed line ({0})",t.original.startLineNumber+a),void 0,!0,async()=>{let d=this._originalTextModel.getLineContent(t.original.startLineNumber+a);d===""&&(d=this._originalTextModel.getEndOfLineSequence()===x.LF?`
`:`\r
`),await this._clipboardService.writeText(d)})),i.getOption(m.readOnly)||s.push(new u("diff.inline.revertChange",n("diff.inline.revertChange.label","Revert this change"),void 0,!0,async()=>{this._editor.revert(this._diff)})),s},autoSelectFirstItem:!0})};this._register(M(this._diffActions,"mousedown",e=>{if(!e.leftButton)return;const{top:f,height:s}=C(this._diffActions),c=Math.floor(r/3);e.preventDefault(),_(e.posx,f+s+c)})),this._register(i.onMouseMove(e=>{(e.target.type===h.CONTENT_VIEW_ZONE||e.target.type===h.GUTTER_VIEW_ZONE)&&e.target.detail.viewZoneId===this._getViewZoneId()?(a=this._updateLightBulbPosition(this._marginDomNode,e.event.browserEvent.y,r),this.visibility=!0):this.visibility=!1})),this._register(i.onMouseDown(e=>{e.event.leftButton&&(e.target.type===h.CONTENT_VIEW_ZONE||e.target.type===h.GUTTER_VIEW_ZONE)&&e.target.detail.viewZoneId===this._getViewZoneId()&&(e.event.preventDefault(),a=this._updateLightBulbPosition(this._marginDomNode,e.event.browserEvent.y,r),_(e.event.posx,e.event.posy+r))}))}_diffActions;_visibility=!1;get visibility(){return this._visibility}set visibility(o){this._visibility!==o&&(this._visibility=o,this._diffActions.style.visibility=o?"visible":"hidden")}_updateLightBulbPosition(o,v,i){const{top:t}=C(o),y=v-t,p=Math.floor(y/i),b=p*i;if(this._diffActions.style.top=`${b}px`,this._viewLineCounts){let g=0;for(let l=0;l<this._viewLineCounts.length;l++)if(g+=this._viewLineCounts[l],p<g)return l}return p}}export{te as InlineDiffDeletedCodeMargin};
