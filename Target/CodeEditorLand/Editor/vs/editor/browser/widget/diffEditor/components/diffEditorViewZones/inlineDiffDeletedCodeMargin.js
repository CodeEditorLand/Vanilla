import{addStandardDisposableListener as w,getDomNodePagePosition as C}from"../../../../../../base/browser/dom.js";import{Action as u}from"../../../../../../base/common/actions.js";import{Codicon as M}from"../../../../../../base/common/codicons.js";import{Disposable as L}from"../../../../../../base/common/lifecycle.js";import{isIOS as x}from"../../../../../../base/common/platform.js";import{ThemeIcon as D}from"../../../../../../base/common/themables.js";import{localize as o}from"../../../../../../nls.js";import{EditorOption as m}from"../../../../../common/config/editorOptions.js";import{EndOfLineSequence as I}from"../../../../../common/model.js";import{MouseTargetType as g}from"../../../../editorBrowser.js";class $ extends L{constructor(n,y,i,t,v,p,b,h,l){super();this._getViewZoneId=n;this._marginDomNode=y;this._modifiedEditor=i;this._diff=t;this._editor=v;this._viewLineCounts=p;this._originalTextModel=b;this._contextMenuService=h;this._clipboardService=l;this._marginDomNode.style.zIndex="10",this._diffActions=document.createElement("div"),this._diffActions.className=D.asClassName(M.lightBulb)+" lightbulb-glyph",this._diffActions.style.position="absolute";const r=this._modifiedEditor.getOption(m.lineHeight);this._diffActions.style.right="0px",this._diffActions.style.visibility="hidden",this._diffActions.style.height=`${r}px`,this._diffActions.style.lineHeight=`${r}px`,this._marginDomNode.appendChild(this._diffActions);let d=0;const E=i.getOption(m.useShadowDOM)&&!x,_=(e,c)=>{this._contextMenuService.showContextMenu({domForShadowRoot:E?i.getDomNode()??void 0:void 0,getAnchor:()=>({x:e,y:c}),getActions:()=>{const s=[],f=t.modified.isEmpty;return s.push(new u("diff.clipboard.copyDeletedContent",f?t.original.length>1?o("diff.clipboard.copyDeletedLinesContent.label","Copy deleted lines"):o("diff.clipboard.copyDeletedLinesContent.single.label","Copy deleted line"):t.original.length>1?o("diff.clipboard.copyChangedLinesContent.label","Copy changed lines"):o("diff.clipboard.copyChangedLinesContent.single.label","Copy changed line"),void 0,!0,async()=>{const a=this._originalTextModel.getValueInRange(t.original.toExclusiveRange());await this._clipboardService.writeText(a)})),t.original.length>1&&s.push(new u("diff.clipboard.copyDeletedLineContent",f?o("diff.clipboard.copyDeletedLineContent.label","Copy deleted line ({0})",t.original.startLineNumber+d):o("diff.clipboard.copyChangedLineContent.label","Copy changed line ({0})",t.original.startLineNumber+d),void 0,!0,async()=>{let a=this._originalTextModel.getLineContent(t.original.startLineNumber+d);a===""&&(a=this._originalTextModel.getEndOfLineSequence()===I.LF?`
`:`\r
`),await this._clipboardService.writeText(a)})),i.getOption(m.readOnly)||s.push(new u("diff.inline.revertChange",o("diff.inline.revertChange.label","Revert this change"),void 0,!0,async()=>{this._editor.revert(this._diff)})),s},autoSelectFirstItem:!0})};this._register(w(this._diffActions,"mousedown",e=>{if(!e.leftButton)return;const{top:c,height:s}=C(this._diffActions),f=Math.floor(r/3);e.preventDefault(),_(e.posx,c+s+f)})),this._register(i.onMouseMove(e=>{(e.target.type===g.CONTENT_VIEW_ZONE||e.target.type===g.GUTTER_VIEW_ZONE)&&e.target.detail.viewZoneId===this._getViewZoneId()?(d=this._updateLightBulbPosition(this._marginDomNode,e.event.browserEvent.y,r),this.visibility=!0):this.visibility=!1})),this._register(i.onMouseDown(e=>{e.event.leftButton&&(e.target.type===g.CONTENT_VIEW_ZONE||e.target.type===g.GUTTER_VIEW_ZONE)&&e.target.detail.viewZoneId===this._getViewZoneId()&&(e.event.preventDefault(),d=this._updateLightBulbPosition(this._marginDomNode,e.event.browserEvent.y,r),_(e.event.posx,e.event.posy+r))}))}_diffActions;_visibility=!1;get visibility(){return this._visibility}set visibility(n){this._visibility!==n&&(this._visibility=n,this._diffActions.style.visibility=n?"visible":"hidden")}_updateLightBulbPosition(n,y,i){const{top:t}=C(n),v=y-t,p=Math.floor(v/i),b=p*i;if(this._diffActions.style.top=`${b}px`,this._viewLineCounts){let h=0;for(let l=0;l<this._viewLineCounts.length;l++)if(h+=this._viewLineCounts[l],p<h)return l}return p}}export{$ as InlineDiffDeletedCodeMargin};
