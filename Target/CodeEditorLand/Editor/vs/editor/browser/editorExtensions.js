import{getActiveElement as D}from"../../base/browser/dom.js";import{KeyCode as l,KeyMod as m}from"../../base/common/keyCodes.js";import{assertType as x}from"../../base/common/types.js";import{URI as _}from"../../base/common/uri.js";import*as p from"../../nls.js";import{Action2 as K,MenuId as u,MenuRegistry as N}from"../../platform/actions/common/actions.js";import{CommandsRegistry as A}from"../../platform/commands/common/commands.js";import{ContextKeyExpr as S,IContextKeyService as E}from"../../platform/contextkey/common/contextkey.js";import{IInstantiationService as P}from"../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as g,KeybindingsRegistry as R}from"../../platform/keybinding/common/keybindingsRegistry.js";import{ILogService as O}from"../../platform/log/common/log.js";import{Registry as F}from"../../platform/registry/common/platform.js";import{ITelemetryService as z}from"../../platform/telemetry/common/telemetry.js";import{Position as I}from"../common/core/position.js";import{IModelService as j}from"../common/services/model.js";import{ITextModelService as B}from"../common/services/resolverService.js";import{ICodeEditorService as M}from"./services/codeEditorService.js";var U=(o=>(o[o.Eager=0]="Eager",o[o.AfterFirstRender=1]="AfterFirstRender",o[o.BeforeFirstInteraction=2]="BeforeFirstInteraction",o[o.Eventually=3]="Eventually",o[o.Lazy=4]="Lazy",o))(U||{});class y{id;precondition;_kbOpts;_menuOpts;metadata;constructor(t){this.id=t.id,this.precondition=t.precondition,this._kbOpts=t.kbOpts,this._menuOpts=t.menuOpts,this.metadata=t.metadata}register(){if(Array.isArray(this._menuOpts)?this._menuOpts.forEach(this._registerMenuItem,this):this._menuOpts&&this._registerMenuItem(this._menuOpts),this._kbOpts){const t=Array.isArray(this._kbOpts)?this._kbOpts:[this._kbOpts];for(const e of t){let i=e.kbExpr;this.precondition&&(i?i=S.and(i,this.precondition):i=this.precondition);const n={id:this.id,weight:e.weight,args:e.args,when:i,primary:e.primary,secondary:e.secondary,win:e.win,linux:e.linux,mac:e.mac};R.registerKeybindingRule(n)}}A.registerCommand({id:this.id,handler:(t,e)=>this.runCommand(t,e),metadata:this.metadata})}_registerMenuItem(t){N.appendMenuItem(t.menuId,{group:t.group,command:{id:this.id,title:t.title,icon:t.icon,precondition:this.precondition},when:t.when,order:t.order})}}class h extends y{_implementations=[];addImplementation(t,e,i,n){return this._implementations.push({priority:t,name:e,implementation:i,when:n}),this._implementations.sort((o,s)=>s.priority-o.priority),{dispose:()=>{for(let o=0;o<this._implementations.length;o++)if(this._implementations[o].implementation===i){this._implementations.splice(o,1);return}}}}runCommand(t,e){const i=t.get(O),n=t.get(E);i.trace(`Executing Command '${this.id}' which has ${this._implementations.length} bound.`);for(const o of this._implementations){if(o.when){const a=n.getContext(D());if(!o.when.evaluate(a))continue}const s=o.implementation(t,e);if(s)return i.trace(`Command '${this.id}' was handled by '${o.name}'.`),typeof s=="boolean"?void 0:s}i.trace(`The Command '${this.id}' was not handled by any implementation.`)}}class T extends y{constructor(e,i){super(i);this.command=e}runCommand(e,i){return this.command.runCommand(e,i)}}class f extends y{static bindToContribution(t){return class extends f{_callback;constructor(i){super(i),this._callback=i.handler}runEditorCommand(i,n,o){const s=t(n);s&&this._callback(s,o)}}}static runEditorCommand(t,e,i,n){const o=t.get(M),s=o.getFocusedCodeEditor()||o.getActiveCodeEditor();if(s)return s.invokeWithinContext(a=>{if(a.get(E).contextMatchesRules(i??void 0))return n(a,s,e)})}runCommand(t,e){return f.runEditorCommand(t,e,this.precondition,(i,n,o)=>this.runEditorCommand(i,n,o))}}class v extends f{static convertOptions(t){let e;Array.isArray(t.menuOpts)?e=t.menuOpts:t.menuOpts?e=[t.menuOpts]:e=[];function i(n){return n.menuId||(n.menuId=u.EditorContext),n.title||(n.title=t.label),n.when=S.and(t.precondition,n.when),n}return Array.isArray(t.contextMenuOpts)?e.push(...t.contextMenuOpts.map(i)):t.contextMenuOpts&&e.push(i(t.contextMenuOpts)),t.menuOpts=e,t}label;alias;constructor(t){super(v.convertOptions(t)),this.label=t.label,this.alias=t.alias}runEditorCommand(t,e,i){return this.reportTelemetry(t,e),this.run(t,e,i||{})}reportTelemetry(t,e){t.get(z).publicLog2("editorActionInvoked",{name:this.label,id:this.id})}}class ct extends v{_implementations=[];addImplementation(t,e){return this._implementations.push([t,e]),this._implementations.sort((i,n)=>n[0]-i[0]),{dispose:()=>{for(let i=0;i<this._implementations.length;i++)if(this._implementations[i][1]===e){this._implementations.splice(i,1);return}}}}run(t,e,i){for(const n of this._implementations){const o=n[1](t,e,i);if(o)return typeof o=="boolean"?void 0:o}}}class mt extends K{run(t,...e){const i=t.get(M),n=i.getFocusedCodeEditor()||i.getActiveCodeEditor();if(n)return n.invokeWithinContext(o=>{const s=o.get(E),a=o.get(O);if(!s.contextMatchesRules(this.desc.precondition??void 0)){a.debug("[EditorAction2] NOT running command because its precondition is FALSE",this.desc.id,this.desc.precondition?.serialize());return}return this.runEditorCommand(o,n,...e)})}}function ut(r,t){A.registerCommand(r,(e,...i)=>{const n=e.get(P),[o,s]=i;x(_.isUri(o)),x(I.isIPosition(s));const a=e.get(j).getModel(o);if(a){const c=I.lift(s);return n.invokeFunction(t,a,c,...i.slice(2))}return e.get(B).createModelReference(o).then(c=>new Promise((w,k)=>{try{const b=n.invokeFunction(t,c.object.textEditorModel,I.lift(s),i.slice(2));w(b)}catch(b){k(b)}}).finally(()=>{c.dispose()}))})}function pt(r){return d.INSTANCE.registerEditorCommand(r),r}function lt(r){const t=new r;return d.INSTANCE.registerEditorAction(t),t}function Ct(r){return d.INSTANCE.registerEditorAction(r),r}function ft(r){d.INSTANCE.registerEditorAction(r)}function bt(r,t,e){d.INSTANCE.registerEditorContribution(r,t,e)}function Et(r,t){d.INSTANCE.registerDiffEditorContribution(r,t)}var $;(o=>{function r(s){return d.INSTANCE.getEditorCommand(s)}o.getEditorCommand=r;function t(){return d.INSTANCE.getEditorActions()}o.getEditorActions=t;function e(){return d.INSTANCE.getEditorContributions()}o.getEditorContributions=e;function i(s){return d.INSTANCE.getEditorContributions().filter(a=>s.indexOf(a.id)>=0)}o.getSomeEditorContributions=i;function n(){return d.INSTANCE.getDiffEditorContributions()}o.getDiffEditorContributions=n})($||={});const L={EditorCommonContributions:"editor.contributions"};class d{static INSTANCE=new d;editorContributions=[];diffEditorContributions=[];editorActions=[];editorCommands=Object.create(null);constructor(){}registerEditorContribution(t,e,i){this.editorContributions.push({id:t,ctor:e,instantiation:i})}getEditorContributions(){return this.editorContributions.slice(0)}registerDiffEditorContribution(t,e){this.diffEditorContributions.push({id:t,ctor:e})}getDiffEditorContributions(){return this.diffEditorContributions.slice(0)}registerEditorAction(t){t.register(),this.editorActions.push(t)}getEditorActions(){return this.editorActions}registerEditorCommand(t){t.register(),this.editorCommands[t.id]=t}getEditorCommand(t){return this.editorCommands[t]||null}}F.add(L.EditorCommonContributions,d.INSTANCE);function C(r){return r.register(),r}const W=C(new h({id:"undo",precondition:void 0,kbOpts:{weight:g.EditorCore,primary:m.CtrlCmd|l.KeyZ},menuOpts:[{menuId:u.MenubarEditMenu,group:"1_do",title:p.localize({key:"miUndo",comment:["&& denotes a mnemonic"]},"&&Undo"),order:1},{menuId:u.CommandPalette,group:"",title:p.localize("undo","Undo"),order:1}]}));C(new T(W,{id:"default:undo",precondition:void 0}));const Z=C(new h({id:"redo",precondition:void 0,kbOpts:{weight:g.EditorCore,primary:m.CtrlCmd|l.KeyY,secondary:[m.CtrlCmd|m.Shift|l.KeyZ],mac:{primary:m.CtrlCmd|m.Shift|l.KeyZ}},menuOpts:[{menuId:u.MenubarEditMenu,group:"1_do",title:p.localize({key:"miRedo",comment:["&& denotes a mnemonic"]},"&&Redo"),order:2},{menuId:u.CommandPalette,group:"",title:p.localize("redo","Redo"),order:1}]}));C(new T(Z,{id:"default:redo",precondition:void 0}));const gt=C(new h({id:"editor.action.selectAll",precondition:void 0,kbOpts:{weight:g.EditorCore,kbExpr:null,primary:m.CtrlCmd|l.KeyA},menuOpts:[{menuId:u.MenubarSelectionMenu,group:"1_basic",title:p.localize({key:"miSelectAll",comment:["&& denotes a mnemonic"]},"&&Select All"),order:1},{menuId:u.CommandPalette,group:"",title:p.localize("selectAll","Select All"),order:1}]}));export{y as Command,v as EditorAction,mt as EditorAction2,f as EditorCommand,U as EditorContributionInstantiation,$ as EditorExtensionsRegistry,h as MultiCommand,ct as MultiEditorAction,T as ProxyCommand,Z as RedoCommand,gt as SelectAllCommand,W as UndoCommand,Et as registerDiffEditorContribution,lt as registerEditorAction,pt as registerEditorCommand,bt as registerEditorContribution,ft as registerInstantiatedEditorAction,ut as registerModelAndPositionCommand,Ct as registerMultiEditorAction};
