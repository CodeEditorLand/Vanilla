import*as p from"../../nls.js";import{URI as D}from"../../base/common/uri.js";import"./editorBrowser.js";import{ICodeEditorService as x}from"./services/codeEditorService.js";import{Position as b}from"../common/core/position.js";import"../common/editorCommon.js";import"../common/model.js";import{IModelService as _}from"../common/services/model.js";import{ITextModelService as K}from"../common/services/resolverService.js";import{MenuId as m,MenuRegistry as N,Action2 as P}from"../../platform/actions/common/actions.js";import{CommandsRegistry as A}from"../../platform/commands/common/commands.js";import{ContextKeyExpr as S,IContextKeyService as g}from"../../platform/contextkey/common/contextkey.js";import{IInstantiationService as R}from"../../platform/instantiation/common/instantiation.js";import{KeybindingsRegistry as F,KeybindingWeight as I}from"../../platform/keybinding/common/keybindingsRegistry.js";import{Registry as z}from"../../platform/registry/common/platform.js";import{ITelemetryService as B}from"../../platform/telemetry/common/telemetry.js";import{assertType as O}from"../../base/common/types.js";import"../../base/common/themables.js";import"../../base/common/lifecycle.js";import{KeyMod as u,KeyCode as l}from"../../base/common/keyCodes.js";import{ILogService as M}from"../../platform/log/common/log.js";import{getActiveElement as U}from"../../base/browser/dom.js";var $=(o=>(o[o.Eager=0]="Eager",o[o.AfterFirstRender=1]="AfterFirstRender",o[o.BeforeFirstInteraction=2]="BeforeFirstInteraction",o[o.Eventually=3]="Eventually",o[o.Lazy=4]="Lazy",o))($||{});class h{id;precondition;_kbOpts;_menuOpts;metadata;constructor(t){this.id=t.id,this.precondition=t.precondition,this._kbOpts=t.kbOpts,this._menuOpts=t.menuOpts,this.metadata=t.metadata}register(){if(Array.isArray(this._menuOpts)?this._menuOpts.forEach(this._registerMenuItem,this):this._menuOpts&&this._registerMenuItem(this._menuOpts),this._kbOpts){const t=Array.isArray(this._kbOpts)?this._kbOpts:[this._kbOpts];for(const e of t){let i=e.kbExpr;this.precondition&&(i?i=S.and(i,this.precondition):i=this.precondition);const n={id:this.id,weight:e.weight,args:e.args,when:i,primary:e.primary,secondary:e.secondary,win:e.win,linux:e.linux,mac:e.mac};F.registerKeybindingRule(n)}}A.registerCommand({id:this.id,handler:(t,e)=>this.runCommand(t,e),metadata:this.metadata})}_registerMenuItem(t){N.appendMenuItem(t.menuId,{group:t.group,command:{id:this.id,title:t.title,icon:t.icon,precondition:this.precondition},when:t.when,order:t.order})}}class v extends h{_implementations=[];addImplementation(t,e,i,n){return this._implementations.push({priority:t,name:e,implementation:i,when:n}),this._implementations.sort((o,s)=>s.priority-o.priority),{dispose:()=>{for(let o=0;o<this._implementations.length;o++)if(this._implementations[o].implementation===i){this._implementations.splice(o,1);return}}}}runCommand(t,e){const i=t.get(M),n=t.get(g);i.trace(`Executing Command '${this.id}' which has ${this._implementations.length} bound.`);for(const o of this._implementations){if(o.when){const a=n.getContext(U());if(!o.when.evaluate(a))continue}const s=o.implementation(t,e);if(s)return i.trace(`Command '${this.id}' was handled by '${o.name}'.`),typeof s=="boolean"?void 0:s}i.trace(`The Command '${this.id}' was not handled by any implementation.`)}}class T extends h{constructor(e,i){super(i);this.command=e}runCommand(e,i){return this.command.runCommand(e,i)}}class f extends h{static bindToContribution(t){return class extends f{_callback;constructor(i){super(i),this._callback=i.handler}runEditorCommand(i,n,o){const s=t(n);s&&this._callback(s,o)}}}static runEditorCommand(t,e,i,n){const o=t.get(x),s=o.getFocusedCodeEditor()||o.getActiveCodeEditor();if(s)return s.invokeWithinContext(a=>{if(a.get(g).contextMatchesRules(i??void 0))return n(a,s,e)})}runCommand(t,e){return f.runEditorCommand(t,e,this.precondition,(i,n,o)=>this.runEditorCommand(i,n,o))}}class y extends f{static convertOptions(t){let e;Array.isArray(t.menuOpts)?e=t.menuOpts:t.menuOpts?e=[t.menuOpts]:e=[];function i(n){return n.menuId||(n.menuId=m.EditorContext),n.title||(n.title=t.label),n.when=S.and(t.precondition,n.when),n}return Array.isArray(t.contextMenuOpts)?e.push(...t.contextMenuOpts.map(i)):t.contextMenuOpts&&e.push(i(t.contextMenuOpts)),t.menuOpts=e,t}label;alias;constructor(t){super(y.convertOptions(t)),this.label=t.label,this.alias=t.alias}runEditorCommand(t,e,i){return this.reportTelemetry(t,e),this.run(t,e,i||{})}reportTelemetry(t,e){t.get(B).publicLog2("editorActionInvoked",{name:this.label,id:this.id})}}class Mt extends y{_implementations=[];addImplementation(t,e){return this._implementations.push([t,e]),this._implementations.sort((i,n)=>n[0]-i[0]),{dispose:()=>{for(let i=0;i<this._implementations.length;i++)if(this._implementations[i][1]===e){this._implementations.splice(i,1);return}}}}run(t,e,i){for(const n of this._implementations){const o=n[1](t,e,i);if(o)return typeof o=="boolean"?void 0:o}}}class Tt extends P{run(t,...e){const i=t.get(x),n=i.getFocusedCodeEditor()||i.getActiveCodeEditor();if(n)return n.invokeWithinContext(o=>{const s=o.get(g),a=o.get(M);if(!s.contextMatchesRules(this.desc.precondition??void 0)){a.debug("[EditorAction2] NOT running command because its precondition is FALSE",this.desc.id,this.desc.precondition?.serialize());return}return this.runEditorCommand(o,n,...e)})}}function wt(r,t){A.registerCommand(r,function(e,...i){const n=e.get(R),[o,s]=i;O(D.isUri(o)),O(b.isIPosition(s));const a=e.get(_).getModel(o);if(a){const c=b.lift(s);return n.invokeFunction(t,a,c,...i.slice(2))}return e.get(K).createModelReference(o).then(c=>new Promise((w,k)=>{try{const E=n.invokeFunction(t,c.object.textEditorModel,b.lift(s),i.slice(2));w(E)}catch(E){k(E)}}).finally(()=>{c.dispose()}))})}function kt(r){return d.INSTANCE.registerEditorCommand(r),r}function Dt(r){const t=new r;return d.INSTANCE.registerEditorAction(t),t}function _t(r){return d.INSTANCE.registerEditorAction(r),r}function Kt(r){d.INSTANCE.registerEditorAction(r)}function Nt(r,t,e){d.INSTANCE.registerEditorContribution(r,t,e)}function Pt(r,t){d.INSTANCE.registerDiffEditorContribution(r,t)}var L;(o=>{function r(s){return d.INSTANCE.getEditorCommand(s)}o.getEditorCommand=r;function t(){return d.INSTANCE.getEditorActions()}o.getEditorActions=t;function e(){return d.INSTANCE.getEditorContributions()}o.getEditorContributions=e;function i(s){return d.INSTANCE.getEditorContributions().filter(a=>s.indexOf(a.id)>=0)}o.getSomeEditorContributions=i;function n(){return d.INSTANCE.getDiffEditorContributions()}o.getDiffEditorContributions=n})(L||={});const W={EditorCommonContributions:"editor.contributions"};class d{static INSTANCE=new d;editorContributions=[];diffEditorContributions=[];editorActions=[];editorCommands=Object.create(null);constructor(){}registerEditorContribution(t,e,i){this.editorContributions.push({id:t,ctor:e,instantiation:i})}getEditorContributions(){return this.editorContributions.slice(0)}registerDiffEditorContribution(t,e){this.diffEditorContributions.push({id:t,ctor:e})}getDiffEditorContributions(){return this.diffEditorContributions.slice(0)}registerEditorAction(t){t.register(),this.editorActions.push(t)}getEditorActions(){return this.editorActions}registerEditorCommand(t){t.register(),this.editorCommands[t.id]=t}getEditorCommand(t){return this.editorCommands[t]||null}}z.add(W.EditorCommonContributions,d.INSTANCE);function C(r){return r.register(),r}const Z=C(new v({id:"undo",precondition:void 0,kbOpts:{weight:I.EditorCore,primary:u.CtrlCmd|l.KeyZ},menuOpts:[{menuId:m.MenubarEditMenu,group:"1_do",title:p.localize({key:"miUndo",comment:["&& denotes a mnemonic"]},"&&Undo"),order:1},{menuId:m.CommandPalette,group:"",title:p.localize("undo","Undo"),order:1}]}));C(new T(Z,{id:"default:undo",precondition:void 0}));const j=C(new v({id:"redo",precondition:void 0,kbOpts:{weight:I.EditorCore,primary:u.CtrlCmd|l.KeyY,secondary:[u.CtrlCmd|u.Shift|l.KeyZ],mac:{primary:u.CtrlCmd|u.Shift|l.KeyZ}},menuOpts:[{menuId:m.MenubarEditMenu,group:"1_do",title:p.localize({key:"miRedo",comment:["&& denotes a mnemonic"]},"&&Redo"),order:2},{menuId:m.CommandPalette,group:"",title:p.localize("redo","Redo"),order:1}]}));C(new T(j,{id:"default:redo",precondition:void 0}));const Rt=C(new v({id:"editor.action.selectAll",precondition:void 0,kbOpts:{weight:I.EditorCore,kbExpr:null,primary:u.CtrlCmd|l.KeyA},menuOpts:[{menuId:m.MenubarSelectionMenu,group:"1_basic",title:p.localize({key:"miSelectAll",comment:["&& denotes a mnemonic"]},"&&Select All"),order:1},{menuId:m.CommandPalette,group:"",title:p.localize("selectAll","Select All"),order:1}]}));export{h as Command,y as EditorAction,Tt as EditorAction2,f as EditorCommand,$ as EditorContributionInstantiation,L as EditorExtensionsRegistry,v as MultiCommand,Mt as MultiEditorAction,T as ProxyCommand,j as RedoCommand,Rt as SelectAllCommand,Z as UndoCommand,Pt as registerDiffEditorContribution,Dt as registerEditorAction,kt as registerEditorCommand,Nt as registerEditorContribution,Kt as registerInstantiatedEditorAction,wt as registerModelAndPositionCommand,_t as registerMultiEditorAction};
