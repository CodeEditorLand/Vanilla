import{equalsIfDefined as d,itemsEquals as a}from"../../base/common/equals.js";import{Disposable as b,DisposableStore as y,toDisposable as f}from"../../base/common/lifecycle.js";import{TransactionImpl as v,autorun as I,autorunOpts as m,derived as u,derivedOpts as l,derivedWithSetter as _,observableFromEvent as o,observableSignal as C,observableValue as T,observableValueOpts as h}from"../../base/common/observable.js";import{EditorOption as O}from"../common/config/editorOptions.js";import{Position as c}from"../common/core/position.js";import{Selection as p}from"../common/core/selection.js";import"../common/cursorEvents.js";import"../common/model.js";import"../common/textModelEvents.js";import"./editorBrowser.js";function G(g){return n.get(g)}class n extends b{constructor(e){super();this.editor=e;this._register(this.editor.onBeginUpdate(()=>this._beginUpdate())),this._register(this.editor.onEndUpdate(()=>this._endUpdate())),this._register(this.editor.onDidChangeModel(()=>{this._beginUpdate();try{this._model.set(this.editor.getModel(),this._currentTransaction),this._forceUpdate()}finally{this._endUpdate()}})),this._register(this.editor.onDidType(t=>{this._beginUpdate();try{this._forceUpdate(),this.onDidType.trigger(this._currentTransaction,t)}finally{this._endUpdate()}})),this._register(this.editor.onDidChangeModelContent(t=>{this._beginUpdate();try{this._versionId.set(this.editor.getModel()?.getVersionId()??null,this._currentTransaction,t),this._forceUpdate()}finally{this._endUpdate()}})),this._register(this.editor.onDidChangeCursorSelection(t=>{this._beginUpdate();try{this._selections.set(this.editor.getSelections(),this._currentTransaction,t),this._forceUpdate()}finally{this._endUpdate()}}))}static _map=new Map;static get(e){let t=n._map.get(e);if(!t){t=new n(e),n._map.set(e,t);const i=e.onDidDispose(()=>{const r=n._map.get(e);r&&(n._map.delete(e),r.dispose(),i.dispose())})}return t}_updateCounter=0;_currentTransaction=void 0;_beginUpdate(){this._updateCounter++,this._updateCounter===1&&(this._currentTransaction=new v(()=>{}))}_endUpdate(){if(this._updateCounter--,this._updateCounter===0){const e=this._currentTransaction;this._currentTransaction=void 0,e.finish()}}forceUpdate(e){this._beginUpdate();try{return this._forceUpdate(),e?e(this._currentTransaction):void 0}finally{this._endUpdate()}}_forceUpdate(){this._beginUpdate();try{this._model.set(this.editor.getModel(),this._currentTransaction),this._versionId.set(this.editor.getModel()?.getVersionId()??null,this._currentTransaction,void 0),this._selections.set(this.editor.getSelections(),this._currentTransaction,void 0)}finally{this._endUpdate()}}_model=T(this,this.editor.getModel());model=this._model;isReadonly=o(this,this.editor.onDidChangeConfiguration,()=>this.editor.getOption(O.readOnly));_versionId=h({owner:this,lazy:!0},this.editor.getModel()?.getVersionId()??null);versionId=this._versionId;_selections=h({owner:this,equalsFn:d(a(p.selectionsEqual)),lazy:!0},this.editor.getSelections()??null);selections=this._selections;positions=l({owner:this,equalsFn:d(a(c.equals))},e=>this.selections.read(e)?.map(t=>t.getStartPosition())??null);isFocused=o(this,e=>{const t=this.editor.onDidFocusEditorWidget(e),i=this.editor.onDidBlurEditorWidget(e);return{dispose(){t.dispose(),i.dispose()}}},()=>this.editor.hasWidgetFocus());value=_(this,e=>(this.versionId.read(e),this.model.read(e)?.getValue()??""),(e,t)=>{const i=this.model.get();i!==null&&e!==i.getValue()&&i.setValue(e)});valueIsEmpty=u(this,e=>(this.versionId.read(e),this.editor.getModel()?.getValueLength()===0));cursorSelection=l({owner:this,equalsFn:d(p.selectionsEqual)},e=>this.selections.read(e)?.[0]??null);cursorPosition=l({owner:this,equalsFn:c.equals},e=>this.selections.read(e)?.[0]?.getPosition()??null);cursorLineNumber=u(this,e=>this.cursorPosition.read(e)?.lineNumber??null);onDidType=C(this);scrollTop=o(this.editor.onDidScrollChange,()=>this.editor.getScrollTop());scrollLeft=o(this.editor.onDidScrollChange,()=>this.editor.getScrollLeft());layoutInfo=o(this.editor.onDidLayoutChange,()=>this.editor.getLayoutInfo());layoutInfoContentLeft=this.layoutInfo.map(e=>e.contentLeft);layoutInfoDecorationsLeft=this.layoutInfo.map(e=>e.decorationsLeft);contentWidth=o(this.editor.onDidContentSizeChange,()=>this.editor.getContentWidth());getOption(e){return o(this,t=>this.editor.onDidChangeConfiguration(i=>{i.hasChanged(e)&&t(void 0)}),()=>this.editor.getOption(e))}setDecorations(e){const t=new y,i=this.editor.createDecorationsCollection();return t.add(m({owner:this,debugName:()=>`Apply decorations from ${e.debugName}`},r=>{const s=e.read(r);i.set(s)})),t.add({dispose:()=>{i.clear()}}),t}_overlayWidgetCounter=0;createOverlayWidget(e){const t="observableOverlayWidget"+this._overlayWidgetCounter++,i={getDomNode:()=>e.domNode,getPosition:()=>e.position.get(),getId:()=>t,allowEditorOverflow:e.allowEditorOverflow,getMinContentWidthInPx:()=>e.minContentWidthInPx.get()};this.editor.addOverlayWidget(i);const r=I(s=>{e.position.read(s),e.minContentWidthInPx.read(s),this.editor.layoutOverlayWidget(i)});return f(()=>{r.dispose(),this.editor.removeOverlayWidget(i)})}}export{n as ObservableCodeEditor,G as observableCodeEditor};
