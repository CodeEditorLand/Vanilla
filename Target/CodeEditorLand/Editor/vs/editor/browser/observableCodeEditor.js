import{equalsIfDefined as l,itemsEquals as u}from"../../../vs/base/common/equals.js";import{Disposable as b,DisposableStore as p,toDisposable as v}from"../../../vs/base/common/lifecycle.js";import{autorun as y,autorunOpts as I,autorunWithStoreHandleChanges as m,derived as C,derivedOpts as h,observableFromEvent as n,observableSignal as _,observableValue as T,observableValueOpts as c}from"../../../vs/base/common/observable.js";import{TransactionImpl as O}from"../../../vs/base/common/observableInternal/base.js";import{derivedWithSetter as D}from"../../../vs/base/common/observableInternal/derived.js";import"../../../vs/editor/browser/editorBrowser.js";import{EditorOption as U}from"../../../vs/editor/common/config/editorOptions.js";import{Position as g}from"../../../vs/editor/common/core/position.js";import{Selection as f}from"../../../vs/editor/common/core/selection.js";import"../../../vs/editor/common/cursorEvents.js";import"../../../vs/editor/common/model.js";import"../../../vs/editor/common/textModelEvents.js";function X(s){return r.get(s)}class r extends b{constructor(e){super();this.editor=e;this._register(this.editor.onBeginUpdate(()=>this._beginUpdate())),this._register(this.editor.onEndUpdate(()=>this._endUpdate())),this._register(this.editor.onDidChangeModel(()=>{this._beginUpdate();try{this._model.set(this.editor.getModel(),this._currentTransaction),this._forceUpdate()}finally{this._endUpdate()}})),this._register(this.editor.onDidType(t=>{this._beginUpdate();try{this._forceUpdate(),this.onDidType.trigger(this._currentTransaction,t)}finally{this._endUpdate()}})),this._register(this.editor.onDidChangeModelContent(t=>{this._beginUpdate();try{this._versionId.set(this.editor.getModel()?.getVersionId()??null,this._currentTransaction,t),this._forceUpdate()}finally{this._endUpdate()}})),this._register(this.editor.onDidChangeCursorSelection(t=>{this._beginUpdate();try{this._selections.set(this.editor.getSelections(),this._currentTransaction,t),this._forceUpdate()}finally{this._endUpdate()}}))}static _map=new Map;static get(e){let t=r._map.get(e);if(!t){t=new r(e),r._map.set(e,t);const i=e.onDidDispose(()=>{const o=r._map.get(e);o&&(r._map.delete(e),o.dispose(),i.dispose())})}return t}_updateCounter=0;_currentTransaction=void 0;_beginUpdate(){this._updateCounter++,this._updateCounter===1&&(this._currentTransaction=new O(()=>{}))}_endUpdate(){if(this._updateCounter--,this._updateCounter===0){const e=this._currentTransaction;this._currentTransaction=void 0,e.finish()}}forceUpdate(e){this._beginUpdate();try{return this._forceUpdate(),e?e(this._currentTransaction):void 0}finally{this._endUpdate()}}_forceUpdate(){this._beginUpdate();try{this._model.set(this.editor.getModel(),this._currentTransaction),this._versionId.set(this.editor.getModel()?.getVersionId()??null,this._currentTransaction,void 0),this._selections.set(this.editor.getSelections(),this._currentTransaction,void 0)}finally{this._endUpdate()}}_model=T(this,this.editor.getModel());model=this._model;isReadonly=n(this,this.editor.onDidChangeConfiguration,()=>this.editor.getOption(U.readOnly));_versionId=c({owner:this,lazy:!0},this.editor.getModel()?.getVersionId()??null);versionId=this._versionId;_selections=c({owner:this,equalsFn:l(u(f.selectionsEqual)),lazy:!0},this.editor.getSelections()??null);selections=this._selections;positions=h({owner:this,equalsFn:l(u(g.equals))},e=>this.selections.read(e)?.map(t=>t.getStartPosition())??null);isFocused=n(this,e=>{const t=this.editor.onDidFocusEditorWidget(e),i=this.editor.onDidBlurEditorWidget(e);return{dispose(){t.dispose(),i.dispose()}}},()=>this.editor.hasWidgetFocus());value=D(this,e=>(this.versionId.read(e),this.model.read(e)?.getValue()??""),(e,t)=>{const i=this.model.get();i!==null&&e!==i.getValue()&&i.setValue(e)});valueIsEmpty=C(this,e=>(this.versionId.read(e),this.editor.getModel()?.getValueLength()===0));cursorSelection=h({owner:this,equalsFn:l(f.selectionsEqual)},e=>this.selections.read(e)?.[0]??null);cursorPosition=h({owner:this,equalsFn:g.equals},e=>this.selections.read(e)?.[0]?.getPosition()??null);onDidType=_(this);scrollTop=n(this.editor.onDidScrollChange,()=>this.editor.getScrollTop());scrollLeft=n(this.editor.onDidScrollChange,()=>this.editor.getScrollLeft());layoutInfo=n(this.editor.onDidLayoutChange,()=>this.editor.getLayoutInfo());layoutInfoContentLeft=this.layoutInfo.map(e=>e.contentLeft);layoutInfoDecorationsLeft=this.layoutInfo.map(e=>e.decorationsLeft);contentWidth=n(this.editor.onDidContentSizeChange,()=>this.editor.getContentWidth());getOption(e){return n(this,t=>this.editor.onDidChangeConfiguration(i=>{i.hasChanged(e)&&t(void 0)}),()=>this.editor.getOption(e))}setDecorations(e){const t=new p,i=this.editor.createDecorationsCollection();return t.add(I({owner:this,debugName:()=>`Apply decorations from ${e.debugName}`},o=>{const a=e.read(o);i.set(a)})),t.add({dispose:()=>{i.clear()}}),t}_overlayWidgetCounter=0;createOverlayWidget(e){const t="observableOverlayWidget"+this._overlayWidgetCounter++,i={getDomNode:()=>e.domNode,getPosition:()=>e.position.get(),getId:()=>t,allowEditorOverflow:e.allowEditorOverflow,getMinContentWidthInPx:()=>e.minContentWidthInPx.get()};this.editor.addOverlayWidget(i);const o=y(a=>{e.position.read(a),e.minContentWidthInPx.read(a),this.editor.layoutOverlayWidget(i)});return v(()=>{o.dispose(),this.editor.removeOverlayWidget(i)})}}function E(s,d){return m({createEmptyChangeSummary:()=>({deltas:[],didChange:!1}),handleChange:(e,t)=>{if(e.didChange(s)){const i=e.change;i!==void 0&&t.deltas.push(i),t.didChange=!0}return!0}},(e,t)=>{const i=s.read(e);t.didChange&&d(i,t.deltas)})}function Y(s,d){const e=new p,t=E(s,(i,o)=>{e.clear(),d(i,o,e)});return{dispose(){t.dispose(),e.dispose()}}}export{r as ObservableCodeEditor,X as observableCodeEditor,E as reactToChange,Y as reactToChangeWithStore};
