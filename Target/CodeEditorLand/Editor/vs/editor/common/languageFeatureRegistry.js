import{Emitter as c}from"../../base/common/event.js";import{toDisposable as f}from"../../base/common/lifecycle.js";import{shouldSynchronizeModel as _}from"./model.js";import{score as g}from"./languageSelector.js";function a(i){return typeof i=="string"?!1:Array.isArray(i)?i.every(a):!!i.exclusive}class d{constructor(e,r,t,o,n){this.uri=e;this.languageId=r;this.notebookUri=t;this.notebookType=o;this.recursive=n}equals(e){return this.notebookType===e.notebookType&&this.languageId===e.languageId&&this.uri.toString()===e.uri.toString()&&this.notebookUri?.toString()===e.notebookUri?.toString()&&this.recursive===e.recursive}}class l{constructor(e){this._notebookInfoResolver=e}_clock=0;_entries=[];_onDidChange=new c;onDidChange=this._onDidChange.event;register(e,r){let t={selector:e,provider:r,_score:-1,_time:this._clock++};return this._entries.push(t),this._lastCandidate=void 0,this._onDidChange.fire(this._entries.length),f(()=>{if(t){const o=this._entries.indexOf(t);o>=0&&(this._entries.splice(o,1),this._lastCandidate=void 0,this._onDidChange.fire(this._entries.length),t=void 0)}})}has(e){return this.all(e).length>0}all(e){if(!e)return[];this._updateScores(e,!1);const r=[];for(const t of this._entries)t._score>0&&r.push(t.provider);return r}allNoModel(){return this._entries.map(e=>e.provider)}ordered(e,r=!1){const t=[];return this._orderedForEach(e,r,o=>t.push(o.provider)),t}orderedGroups(e){const r=[];let t,o;return this._orderedForEach(e,!1,n=>{t&&o===n._score?t.push(n.provider):(o=n._score,t=[n.provider],r.push(t))}),r}_orderedForEach(e,r,t){this._updateScores(e,r);for(const o of this._entries)o._score>0&&t(o)}_lastCandidate;_updateScores(e,r){const t=this._notebookInfoResolver?.(e.uri),o=t?new d(e.uri,e.getLanguageId(),t.uri,t.type,r):new d(e.uri,e.getLanguageId(),void 0,void 0,r);if(!this._lastCandidate?.equals(o)){this._lastCandidate=o;for(const n of this._entries)if(n._score=g(n.selector,o.uri,o.languageId,_(e),o.notebookUri,o.notebookType),a(n.selector)&&n._score>0)if(r)n._score=0;else{for(const u of this._entries)u._score=0;n._score=1e3;break}this._entries.sort(l._compareByScoreAndTime)}}static _compareByScoreAndTime(e,r){return e._score<r._score?1:e._score>r._score?-1:s(e.selector)&&!s(r.selector)?1:!s(e.selector)&&s(r.selector)?-1:e._time<r._time?1:e._time>r._time?-1:0}}function s(i){return typeof i=="string"?!1:Array.isArray(i)?i.some(s):!!i.isBuiltin}export{l as LanguageFeatureRegistry};
