var E=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var p=(r,e,n,t)=>{for(var i=t>1?void 0:t?S(e,n):e,o=r.length-1,s;o>=0;o--)(s=r[o])&&(i=(t?s(e,n,i):s(i))||i);return t&&i&&E(e,n,i),i},l=(r,e)=>(n,t)=>e(n,t,r);import{Emitter as C}from"../../../base/common/event.js";import{Disposable as h,toDisposable as m}from"../../../base/common/lifecycle.js";import*as P from"../../../base/common/strings.js";import{IConfigurationService as R}from"../../../platform/configuration/common/configuration.js";import{InstantiationType as I,registerSingleton as w}from"../../../platform/instantiation/common/extensions.js";import{createDecorator as D}from"../../../platform/instantiation/common/instantiation.js";import{DEFAULT_WORD_REGEXP as B,ensureValidWordDefinition as A}from"../core/wordHelper.js";import{ILanguageService as x}from"./language.js";import{AutoClosingPairs as z}from"./languageConfiguration.js";import{PLAINTEXT_LANGUAGE_ID as T}from"./modesRegistry.js";import{CharacterPairSupport as N}from"./supports/characterPair.js";import{BracketElectricCharacterSupport as O}from"./supports/electricCharacter.js";import{IndentRulesSupport as M}from"./supports/indentRules.js";import{LanguageBracketsConfiguration as W}from"./supports/languageBracketsConfiguration.js";import{OnEnterSupport as j}from"./supports/onEnter.js";import{RichEditBrackets as F}from"./supports/richEditBrackets.js";class c{constructor(e){this.languageId=e}affects(e){return this.languageId?this.languageId===e:!0}}const G=D("languageConfigurationService");let g=class extends h{constructor(n,t){super();this.configurationService=n;this.languageService=t;const i=new Set(Object.values(d));this._register(this.configurationService.onDidChangeConfiguration(o=>{const s=o.change.keys.some(a=>i.has(a)),f=o.change.overrides.filter(([a,k])=>k.some(L=>i.has(L))).map(([a])=>a);if(s)this.configurations.clear(),this.onDidChangeEmitter.fire(new c(void 0));else for(const a of f)this.languageService.isRegisteredLanguageId(a)&&(this.configurations.delete(a),this.onDidChangeEmitter.fire(new c(a)))})),this._register(this._registry.onDidChange(o=>{this.configurations.delete(o.languageId),this.onDidChangeEmitter.fire(new c(o.languageId))}))}_serviceBrand;_registry=this._register(new X);onDidChangeEmitter=this._register(new C);onDidChange=this.onDidChangeEmitter.event;configurations=new Map;register(n,t,i){return this._registry.register(n,t,i)}getLanguageConfiguration(n){let t=this.configurations.get(n);return t||(t=V(n,this._registry,this.configurationService,this.languageService),this.configurations.set(n,t)),t}};g=p([l(0,R),l(1,x)],g);function V(r,e,n,t){let i=e.getLanguageConfiguration(r);if(!i){if(!t.isRegisteredLanguageId(r))return new u(r,{});i=new u(r,{})}const o=K(i.languageId,n),s=y([i.underlyingConfig,o]);return new u(i.languageId,s)}const d={brackets:"editor.language.brackets",colorizedBracketPairs:"editor.language.colorizedBracketPairs"};function K(r,e){const n=e.getValue(d.brackets,{overrideIdentifier:r}),t=e.getValue(d.colorizedBracketPairs,{overrideIdentifier:r});return{brackets:b(n),colorizedBracketPairs:b(t)}}function b(r){if(Array.isArray(r))return r.map(e=>{if(!(!Array.isArray(e)||e.length!==2))return[e[0],e[1]]}).filter(e=>!!e)}function ge(r,e,n){const t=r.getLineContent(e);let i=P.getLeadingWhitespace(t);return i.length>n-1&&(i=i.substring(0,n-1)),i}class U{constructor(e){this.languageId=e;this._entries=[],this._order=0,this._resolved=null}_entries;_order;_resolved=null;register(e,n){const t=new v(e,n,++this._order);return this._entries.push(t),this._resolved=null,m(()=>{for(let i=0;i<this._entries.length;i++)if(this._entries[i]===t){this._entries.splice(i,1),this._resolved=null;break}})}getResolvedConfiguration(){if(!this._resolved){const e=this._resolve();e&&(this._resolved=new u(this.languageId,e))}return this._resolved}_resolve(){return this._entries.length===0?null:(this._entries.sort(v.cmp),y(this._entries.map(e=>e.configuration)))}}function y(r){let e={comments:void 0,brackets:void 0,wordPattern:void 0,indentationRules:void 0,onEnterRules:void 0,autoClosingPairs:void 0,surroundingPairs:void 0,autoCloseBefore:void 0,folding:void 0,colorizedBracketPairs:void 0,__electricCharacterSupport:void 0};for(const n of r)e={comments:n.comments||e.comments,brackets:n.brackets||e.brackets,wordPattern:n.wordPattern||e.wordPattern,indentationRules:n.indentationRules||e.indentationRules,onEnterRules:n.onEnterRules||e.onEnterRules,autoClosingPairs:n.autoClosingPairs||e.autoClosingPairs,surroundingPairs:n.surroundingPairs||e.surroundingPairs,autoCloseBefore:n.autoCloseBefore||e.autoCloseBefore,folding:n.folding||e.folding,colorizedBracketPairs:n.colorizedBracketPairs||e.colorizedBracketPairs,__electricCharacterSupport:n.__electricCharacterSupport||e.__electricCharacterSupport};return e}class v{constructor(e,n,t){this.configuration=e;this.priority=n;this.order=t}static cmp(e,n){return e.priority===n.priority?e.order-n.order:e.priority-n.priority}}class _{constructor(e){this.languageId=e}}class X extends h{_entries=new Map;_onDidChange=this._register(new C);onDidChange=this._onDidChange.event;constructor(){super(),this._register(this.register(T,{brackets:[["(",")"],["[","]"],["{","}"]],surroundingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:"<",close:">"},{open:'"',close:'"'},{open:"'",close:"'"},{open:"`",close:"`"}],colorizedBracketPairs:[],folding:{offSide:!0}},0))}register(e,n,t=0){let i=this._entries.get(e);i||(i=new U(e),this._entries.set(e,i));const o=i.register(n,t);return this._onDidChange.fire(new _(e)),m(()=>{o.dispose(),this._onDidChange.fire(new _(e))})}getLanguageConfiguration(e){return this._entries.get(e)?.getResolvedConfiguration()||null}}class u{constructor(e,n){this.languageId=e;this.underlyingConfig=n;this._brackets=null,this._electricCharacter=null,this._onEnterSupport=this.underlyingConfig.brackets||this.underlyingConfig.indentationRules||this.underlyingConfig.onEnterRules?new j(this.underlyingConfig):null,this.comments=u._handleComments(this.underlyingConfig),this.characterPair=new N(this.underlyingConfig),this.wordDefinition=this.underlyingConfig.wordPattern||B,this.indentationRules=this.underlyingConfig.indentationRules,this.underlyingConfig.indentationRules?this.indentRulesSupport=new M(this.underlyingConfig.indentationRules):this.indentRulesSupport=null,this.foldingRules=this.underlyingConfig.folding||{},this.bracketsNew=new W(e,this.underlyingConfig)}_brackets;_electricCharacter;_onEnterSupport;comments;characterPair;wordDefinition;indentRulesSupport;indentationRules;foldingRules;bracketsNew;getWordDefinition(){return A(this.wordDefinition)}get brackets(){return!this._brackets&&this.underlyingConfig.brackets&&(this._brackets=new F(this.languageId,this.underlyingConfig.brackets)),this._brackets}get electricCharacter(){return this._electricCharacter||(this._electricCharacter=new O(this.brackets)),this._electricCharacter}onEnter(e,n,t,i){return this._onEnterSupport?this._onEnterSupport.onEnter(e,n,t,i):null}getAutoClosingPairs(){return new z(this.characterPair.getAutoClosingPairs())}getAutoCloseBeforeSet(e){return this.characterPair.getAutoCloseBeforeSet(e)}getSurroundingPairs(){return this.characterPair.getSurroundingPairs()}static _handleComments(e){const n=e.comments;if(!n)return null;const t={};if(n.lineComment&&(t.lineCommentToken=n.lineComment),n.blockComment){const[i,o]=n.blockComment;t.blockCommentStartToken=i,t.blockCommentEndToken=o}return t}}w(G,g,I.Delayed);export{G as ILanguageConfigurationService,_ as LanguageConfigurationChangeEvent,X as LanguageConfigurationRegistry,g as LanguageConfigurationService,c as LanguageConfigurationServiceChangeEvent,u as ResolvedLanguageConfiguration,ge as getIndentationAtPosition};
