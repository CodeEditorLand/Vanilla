import{CharCode as l}from"../../../base/common/charCode.js";import"../model.js";class x{spacesDiff=0;looksLikeAlignment=!1}function _(t,d,f,b,s){s.spacesDiff=0,s.looksLikeAlignment=!1;let n;for(n=0;n<d&&n<b;n++){const e=t.charCodeAt(n),a=f.charCodeAt(n);if(e!==a)break}let C=0,u=0;for(let e=n;e<d;e++)t.charCodeAt(e)===l.Space?C++:u++;let i=0,h=0;for(let e=n;e<b;e++)f.charCodeAt(e)===l.Space?i++:h++;if(C>0&&u>0||i>0&&h>0)return;const o=Math.abs(u-h),r=Math.abs(C-i);if(o===0){s.spacesDiff=r,r>0&&0<=i-1&&i-1<t.length&&i<f.length&&f.charCodeAt(i)!==l.Space&&t.charCodeAt(i-1)===l.Space&&t.charCodeAt(t.length-1)===l.Comma&&(s.looksLikeAlignment=!0);return}if(r%o===0){s.spacesDiff=r/o;return}}function W(t,d,f){const b=Math.min(t.getLineCount(),1e4);let s=0,n=0,C="",u=0;const i=[2,4,6,8,3,5,7],h=8,o=[0,0,0,0,0,0,0,0,0],r=new x;for(let c=1;c<=b;c++){const S=t.getLineLength(c),p=t.getLineContent(c),k=S<=65536;let A=!1,m=0,D=0,g=0;for(let L=0,E=S;L<E;L++){const T=k?p.charCodeAt(L):t.getLineCharCode(c,L);if(T===l.Tab)g++;else if(T===l.Space)D++;else{A=!0,m=L;break}}if(!A||(g>0?s++:D>1&&n++,_(C,u,p,m,r),r.looksLikeAlignment&&!(f&&d===r.spacesDiff)))continue;const I=r.spacesDiff;I<=h&&o[I]++,C=p,u=m}let e=f;s!==n&&(e=s<n);let a=d;if(e){let c=e?0:.1*b;i.forEach(S=>{const p=o[S];p>c&&(c=p,a=S)}),a===4&&o[4]>0&&o[2]>0&&o[2]>=o[4]/2&&(a=2)}return{insertSpaces:e,tabSize:a}}export{W as guessIndentation};
