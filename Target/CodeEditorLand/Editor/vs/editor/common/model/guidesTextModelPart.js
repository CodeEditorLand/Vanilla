import{findLast as O}from"../../../base/common/arraysFind.js";import{BugIndicatingError as N}from"../../../base/common/errors.js";import*as T from"../../../base/common/strings.js";import{CursorColumns as A}from"../core/cursorColumns.js";import{Range as G}from"../core/range.js";import{HorizontalGuidesState as y,IndentGuide as S,IndentGuideHorizontalLine as R}from"../textModelGuides.js";import{TextModelPart as E}from"./textModelPart.js";import{computeIndentLevel as F}from"./utils.js";class J extends E{constructor(e,l){super();this.textModel=e;this.languageConfigurationService=l}getLanguageConfiguration(e){return this.languageConfigurationService.getLanguageConfiguration(e)}_computeIndentLevel(e){return F(this.textModel.getLineContent(e+1),this.textModel.getOptions().tabSize)}getActiveIndentGuide(e,l,s){this.assertNotDisposed();const a=this.textModel.getLineCount();if(e<1||e>a)throw new N("Illegal value for lineNumber");const g=this.getLanguageConfiguration(this.textModel.getLanguageId()).foldingRules,k=!!(g&&g.offSide);let f=-2,h=-1,b=-2,m=-1;const n=u=>{if(f!==-1&&(f===-2||f>u-1)){f=-1,h=-1;for(let t=u-2;t>=0;t--){const o=this._computeIndentLevel(t);if(o>=0){f=t,h=o;break}}}if(b===-2){b=-1,m=-1;for(let t=u;t<a;t++){const o=this._computeIndentLevel(t);if(o>=0){b=t,m=o;break}}}};let i=-2,c=-1,d=-2,r=-1;const C=u=>{if(i===-2){i=-1,c=-1;for(let t=u-2;t>=0;t--){const o=this._computeIndentLevel(t);if(o>=0){i=t,c=o;break}}}if(d!==-1&&(d===-2||d<u-1)){d=-1,r=-1;for(let t=u;t<a;t++){const o=this._computeIndentLevel(t);if(o>=0){d=t,r=o;break}}}};let L=0,x=!0,I=0,v=!0,M=0,B=0;for(let u=0;x||v;u++){const t=e-u,o=e+u;u>1&&(t<1||t<l)&&(x=!1),u>1&&(o>a||o>s)&&(v=!1),u>5e4&&(x=!1,v=!1);let p=-1;if(x&&t>=1){const P=this._computeIndentLevel(t-1);P>=0?(b=t-1,m=P,p=Math.ceil(P/this.textModel.getOptions().indentSize)):(n(t),p=this._getIndentLevelForWhitespaceLine(k,h,m))}let w=-1;if(v&&o<=a){const P=this._computeIndentLevel(o-1);P>=0?(i=o-1,c=P,w=Math.ceil(P/this.textModel.getOptions().indentSize)):(C(o),w=this._getIndentLevelForWhitespaceLine(k,c,r))}if(u===0){B=p;continue}if(u===1){if(o<=a&&w>=0&&B+1===w){x=!1,L=o,I=o,M=w;continue}if(t>=1&&p>=0&&p-1===B){v=!1,L=t,I=t,M=p;continue}if(L=e,I=e,M=B,M===0)return{startLineNumber:L,endLineNumber:I,indent:M}}x&&(p>=M?L=t:x=!1),v&&(w>=M?I=o:v=!1)}return{startLineNumber:L,endLineNumber:I,indent:M}}getLinesBracketGuides(e,l,s,a){const g=[];for(let n=e;n<=l;n++)g.push([]);const k=!0,f=this.textModel.bracketPairs.getBracketPairsInRangeWithMinIndentation(new G(e,1,l,this.textModel.getLineMaxColumn(l))).toArray();let h;if(s&&f.length>0){const n=(e<=s.lineNumber&&s.lineNumber<=l?f:this.textModel.bracketPairs.getBracketPairsInRange(G.fromPositions(s)).toArray()).filter(i=>G.strictContainsPosition(i.range,s));h=O(n,i=>k||i.range.startLineNumber!==i.range.endLineNumber)?.range}const b=this.textModel.getOptions().bracketPairColorizationOptions.independentColorPoolPerBracketType,m=new W;for(const n of f){if(!n.closingBracketRange)continue;const i=h&&n.range.equalsRange(h);if(!i&&!a.includeInactive)continue;const c=m.getInlineClassName(n.nestingLevel,n.nestingLevelOfEqualBracketType,b)+(a.highlightActive&&i?" "+m.activeClassName:""),d=n.openingBracketRange.getStartPosition(),r=n.closingBracketRange.getStartPosition(),C=a.horizontalGuides===y.Enabled||a.horizontalGuides===y.EnabledForActive&&i;if(n.range.startLineNumber===n.range.endLineNumber){k&&C&&g[n.range.startLineNumber-e].push(new S(-1,n.openingBracketRange.getEndPosition().column,c,new R(!1,r.column),-1,-1));continue}const L=this.getVisibleColumnFromPosition(r),x=this.getVisibleColumnFromPosition(n.openingBracketRange.getStartPosition()),I=Math.min(x,L,n.minVisibleColumnIndentation+1);let v=!1;T.firstNonWhitespaceIndex(this.textModel.getLineContent(n.closingBracketRange.startLineNumber))<n.closingBracketRange.startColumn-1&&(v=!0);const u=Math.max(d.lineNumber,e),t=Math.min(r.lineNumber,l),o=v?1:0;for(let p=u;p<t+o;p++)g[p-e].push(new S(I,-1,c,null,p===d.lineNumber?d.column:-1,p===r.lineNumber?r.column:-1));C&&(d.lineNumber>=e&&x>I&&g[d.lineNumber-e].push(new S(I,-1,c,new R(!1,d.column),-1,-1)),r.lineNumber<=l&&L>I&&g[r.lineNumber-e].push(new S(I,-1,c,new R(!v,r.column),-1,-1)))}for(const n of g)n.sort((i,c)=>i.visibleColumn-c.visibleColumn);return g}getVisibleColumnFromPosition(e){return A.visibleColumnFromColumn(this.textModel.getLineContent(e.lineNumber),e.column,this.textModel.getOptions().tabSize)+1}getLinesIndentGuides(e,l){this.assertNotDisposed();const s=this.textModel.getLineCount();if(e<1||e>s)throw new Error("Illegal value for startLineNumber");if(l<1||l>s)throw new Error("Illegal value for endLineNumber");const a=this.textModel.getOptions(),g=this.getLanguageConfiguration(this.textModel.getLanguageId()).foldingRules,k=!!(g&&g.offSide),f=new Array(l-e+1);let h=-2,b=-1,m=-2,n=-1;for(let i=e;i<=l;i++){const c=i-e,d=this._computeIndentLevel(i-1);if(d>=0){h=i-1,b=d,f[c]=Math.ceil(d/a.indentSize);continue}if(h===-2){h=-1,b=-1;for(let r=i-2;r>=0;r--){const C=this._computeIndentLevel(r);if(C>=0){h=r,b=C;break}}}if(m!==-1&&(m===-2||m<i-1)){m=-1,n=-1;for(let r=i;r<s;r++){const C=this._computeIndentLevel(r);if(C>=0){m=r,n=C;break}}}f[c]=this._getIndentLevelForWhitespaceLine(k,b,n)}return f}_getIndentLevelForWhitespaceLine(e,l,s){const a=this.textModel.getOptions();return l===-1||s===-1?0:l<s?1+Math.floor(l/a.indentSize):l===s||e?Math.ceil(s/a.indentSize):1+Math.floor(s/a.indentSize)}}class W{activeClassName="indent-active";getInlineClassName(_,e,l){return this.getInlineClassNameOfLevel(l?e:_)}getInlineClassNameOfLevel(_){return`bracket-indent-guide lvl-${_%30}`}}export{W as BracketPairGuidesClassNames,J as GuidesTextModelPart};
