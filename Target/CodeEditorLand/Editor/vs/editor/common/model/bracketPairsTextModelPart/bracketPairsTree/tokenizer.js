import{NotSupportedError as w}from"../../../../../base/common/errors.js";import{StandardTokenType as E,TokenMetadata as b}from"../../../encodedTokenAttributes.js";import{TextAstNode as x}from"./ast.js";import{lengthAdd as I,lengthDiff as z,lengthGetColumnCountIfZeroLineCount as y,lengthToObj as S,lengthZero as v,toLength as r}from"./length.js";import{SmallImmutableSet as L}from"./smallImmutableSet.js";var A=(n=>(n[n.Text=0]="Text",n[n.OpeningBracket=1]="OpeningBracket",n[n.ClosingBracket=2]="ClosingBracket",n))(A||{});class m{constructor(e,i,n,a,s){this.length=e;this.kind=i;this.bracketId=n;this.bracketIds=a;this.astNode=s}}class q{constructor(e,i){this.textModel=e;this.bracketTokens=i;this.textBufferLineCount=e.getLineCount(),this.textBufferLastLineLength=e.getLineLength(this.textBufferLineCount)}textBufferLineCount;textBufferLastLineLength;reader=new N(this.textModel,this.bracketTokens);_offset=v;get offset(){return this._offset}get length(){return r(this.textBufferLineCount-1,this.textBufferLastLineLength)}getText(){return this.textModel.getValue()}skip(e){this.didPeek=!1,this._offset=I(this._offset,e);const i=S(this._offset);this.reader.setPosition(i.lineCount,i.columnCount)}didPeek=!1;peeked=null;read(){let e;return this.peeked?(this.didPeek=!1,e=this.peeked):e=this.reader.read(),e&&(this._offset=I(this._offset,e.length)),e}peek(){return this.didPeek||(this.peeked=this.reader.read(),this.didPeek=!0),this.peeked}}class N{constructor(e,i){this.textModel=e;this.bracketTokens=i;this.textBufferLineCount=e.getLineCount(),this.textBufferLastLineLength=e.getLineLength(this.textBufferLineCount)}textBufferLineCount;textBufferLastLineLength;lineIdx=0;line=null;lineCharOffset=0;lineTokens=null;lineTokenOffset=0;setPosition(e,i){e===this.lineIdx?(this.lineCharOffset=i,this.line!==null&&(this.lineTokenOffset=this.lineCharOffset===0?0:this.lineTokens.findTokenIndexAtOffset(this.lineCharOffset))):(this.lineIdx=e,this.lineCharOffset=i,this.line=null),this.peekedToken=null}peekedToken=null;read(){if(this.peekedToken){const s=this.peekedToken;return this.peekedToken=null,this.lineCharOffset+=y(s.length),s}if(this.lineIdx>this.textBufferLineCount-1||this.lineIdx===this.textBufferLineCount-1&&this.lineCharOffset>=this.textBufferLastLineLength)return null;this.line===null&&(this.lineTokens=this.textModel.tokenization.getLineTokens(this.lineIdx+1),this.line=this.lineTokens.getLineContent(),this.lineTokenOffset=this.lineCharOffset===0?0:this.lineTokens.findTokenIndexAtOffset(this.lineCharOffset));const e=this.lineIdx,i=this.lineCharOffset;let n=0;for(;;){const s=this.lineTokens,d=s.getCount();let o=null;if(this.lineTokenOffset<d){const f=s.getMetadata(this.lineTokenOffset);for(;this.lineTokenOffset+1<d&&f===s.getMetadata(this.lineTokenOffset+1);)this.lineTokenOffset++;const k=b.getTokenType(f)===E.Other,u=b.containsBalancedBrackets(f),h=s.getEndOffset(this.lineTokenOffset);if(u&&k&&this.lineCharOffset<h){const C=s.getLanguageId(this.lineTokenOffset),T=this.line.substring(this.lineCharOffset,h),t=this.bracketTokens.getSingleLanguageBracketTokens(C),g=t.regExpGlobal;if(g){g.lastIndex=0;const l=g.exec(T);l&&(o=t.getToken(l[0]),o&&(this.lineCharOffset+=l.index))}}if(n+=h-this.lineCharOffset,o)if(e!==this.lineIdx||i!==this.lineCharOffset){this.peekedToken=o;break}else return this.lineCharOffset+=y(o.length),o;else this.lineTokenOffset++,this.lineCharOffset=h}else if(this.lineIdx===this.textBufferLineCount-1||(this.lineIdx++,this.lineTokens=this.textModel.tokenization.getLineTokens(this.lineIdx+1),this.lineTokenOffset=0,this.line=this.lineTokens.getLineContent(),this.lineCharOffset=0,n+=33,n>1e3))break;if(n>1500)break}const a=z(e,i,this.lineIdx,this.lineCharOffset);return new m(a,0,-1,L.getEmpty(),new x(a))}}class J{constructor(e,i){this.text=e;const n=i.getRegExpStr(),a=n?new RegExp(n+`|
`,"gi"):null,s=[];let d,o=0,f=0,k=0,u=0;const h=[];for(let t=0;t<60;t++)h.push(new m(r(0,t),0,-1,L.getEmpty(),new x(r(0,t))));const C=[];for(let t=0;t<60;t++)C.push(new m(r(1,t),0,-1,L.getEmpty(),new x(r(1,t))));if(a)for(a.lastIndex=0;(d=a.exec(e))!==null;){const t=d.index,g=d[0];if(g===`
`)o++,f=t+1;else{if(k!==t){let l;if(u===o){const c=t-k;if(c<h.length)l=h[c];else{const p=r(0,c);l=new m(p,0,-1,L.getEmpty(),new x(p))}}else{const c=o-u,p=t-f;if(c===1&&p<C.length)l=C[p];else{const B=r(c,p);l=new m(B,0,-1,L.getEmpty(),new x(B))}}s.push(l)}s.push(i.getToken(g)),k=t+g.length,u=o}}const T=e.length;if(k!==T){const t=u===o?r(0,T-k):r(o-u,T-f);s.push(new m(t,0,-1,L.getEmpty(),new x(t)))}this.length=r(o,T-f),this.tokens=s}_offset=v;tokens;idx=0;get offset(){return this._offset}length;read(){return this.tokens[this.idx++]||null}peek(){return this.tokens[this.idx]||null}skip(e){throw new w}getText(){return this.text}}export{J as FastTokenizer,q as TextBufferTokenizer,m as Token,A as TokenKind};
