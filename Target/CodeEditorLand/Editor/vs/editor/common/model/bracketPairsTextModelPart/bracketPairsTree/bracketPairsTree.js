import{CallbackIterable as W}from"../../../../../base/common/arrays.js";import{Emitter as D}from"../../../../../base/common/event.js";import{Disposable as v}from"../../../../../base/common/lifecycle.js";import{BracketInfo as M,BracketPairWithMinIndentationInfo as y}from"../../../textModelBracketPairs.js";import{BackgroundTokenizationState as E}from"../../../tokenizationTextModelPart.js";import{AstNodeKind as c}from"./ast.js";import{TextEditInfo as F}from"./beforeEditPositionMapper.js";import{LanguageAgnosticBracketTokens as R}from"./brackets.js";import{combineTextEditInfos as w}from"./combineTextEditInfos.js";import{lengthAdd as m,lengthGreaterThanEqual as C,lengthLessThan as N,lengthLessThanEqual as f,lengthZero as x,lengthsToRange as T,positionToLength as I,toLength as B}from"./length.js";import{parseDocument as P}from"./parser.js";import{DenseKeyProvider as K}from"./smallImmutableSet.js";import{FastTokenizer as j,TextBufferTokenizer as Q}from"./tokenizer.js";class ot extends v{constructor(t,n){super();this.textModel=t;this.getLanguageConfiguration=n;if(t.tokenization.hasTokens)t.tokenization.backgroundTokenizationState===E.Completed?(this.initialAstWithoutTokens=void 0,this.astWithTokens=this.parseDocumentFromTextBuffer([],void 0,!1)):(this.initialAstWithoutTokens=this.parseDocumentFromTextBuffer([],void 0,!0),this.astWithTokens=this.initialAstWithoutTokens);else{const e=this.brackets.getSingleLanguageBracketTokens(this.textModel.getLanguageId()),s=new j(this.textModel.getValue(),e);this.initialAstWithoutTokens=P(s,[],void 0,!0),this.astWithTokens=this.initialAstWithoutTokens}}didChangeEmitter=new D;initialAstWithoutTokens;astWithTokens;denseKeyProvider=new K;brackets=new R(this.denseKeyProvider,this.getLanguageConfiguration);didLanguageChange(t){return this.brackets.didLanguageChange(t)}onDidChange=this.didChangeEmitter.event;queuedTextEditsForInitialAstWithoutTokens=[];queuedTextEdits=[];handleDidChangeBackgroundTokenizationState(){if(this.textModel.tokenization.backgroundTokenizationState===E.Completed){const t=this.initialAstWithoutTokens===void 0;this.initialAstWithoutTokens=void 0,t||this.didChangeEmitter.fire()}}handleDidChangeTokens({ranges:t}){const n=t.map(e=>new F(B(e.fromLineNumber-1,0),B(e.toLineNumber,0),B(e.toLineNumber-e.fromLineNumber+1,0)));this.handleEdits(n,!0),this.initialAstWithoutTokens||this.didChangeEmitter.fire()}handleContentChanged(t){const n=F.fromModelContentChanges(t.changes);this.handleEdits(n,!1)}handleEdits(t,n){const e=w(this.queuedTextEdits,t);this.queuedTextEdits=e,this.initialAstWithoutTokens&&!n&&(this.queuedTextEditsForInitialAstWithoutTokens=w(this.queuedTextEditsForInitialAstWithoutTokens,t))}flushQueue(){this.queuedTextEdits.length>0&&(this.astWithTokens=this.parseDocumentFromTextBuffer(this.queuedTextEdits,this.astWithTokens,!1),this.queuedTextEdits=[]),this.queuedTextEditsForInitialAstWithoutTokens.length>0&&(this.initialAstWithoutTokens&&(this.initialAstWithoutTokens=this.parseDocumentFromTextBuffer(this.queuedTextEditsForInitialAstWithoutTokens,this.initialAstWithoutTokens,!1)),this.queuedTextEditsForInitialAstWithoutTokens=[])}parseDocumentFromTextBuffer(t,n,e){const r=n,a=new Q(this.textModel,this.brackets);return P(a,t,r,e)}getBracketsInRange(t,n){this.flushQueue();const e=B(t.startLineNumber-1,t.startColumn-1),s=B(t.endLineNumber-1,t.endColumn-1);return new W(r=>{const a=this.initialAstWithoutTokens||this.astWithTokens;A(a,x,a.length,e,s,r,0,0,new Map,n)})}getBracketPairsInRange(t,n){this.flushQueue();const e=I(t.getStartPosition()),s=I(t.getEndPosition());return new W(r=>{const a=this.initialAstWithoutTokens||this.astWithTokens,u=new U(r,n,this.textModel);L(a,x,a.length,e,s,u,0,new Map)})}getFirstBracketAfter(t){this.flushQueue();const n=this.initialAstWithoutTokens||this.astWithTokens;return z(n,x,n.length,I(t))}getFirstBracketBefore(t){this.flushQueue();const n=this.initialAstWithoutTokens||this.astWithTokens;return q(n,x,n.length,I(t))}}function q(i,o,t,n){if(i.kind===c.List||i.kind===c.Pair){const e=[];for(const s of i.children)t=m(o,s.length),e.push({nodeOffsetStart:o,nodeOffsetEnd:t}),o=t;for(let s=e.length-1;s>=0;s--){const{nodeOffsetStart:r,nodeOffsetEnd:a}=e[s];if(N(r,n)){const u=q(i.children[s],r,a,n);if(u)return u}}return null}else{if(i.kind===c.UnexpectedClosingBracket)return null;if(i.kind===c.Bracket){const e=T(o,t);return{bracketInfo:i.bracketInfo,range:e}}}return null}function z(i,o,t,n){if(i.kind===c.List||i.kind===c.Pair){for(const e of i.children){if(t=m(o,e.length),N(n,t)){const s=z(e,o,t,n);if(s)return s}o=t}return null}else{if(i.kind===c.UnexpectedClosingBracket)return null;if(i.kind===c.Bracket){const e=T(o,t);return{bracketInfo:i.bracketInfo,range:e}}}return null}function A(i,o,t,n,e,s,r,a,u,g,k=!1){if(r>200)return!0;t:for(;;)switch(i.kind){case c.List:{const l=i.childrenLength;for(let h=0;h<l;h++){const b=i.getChild(h);if(b){if(t=m(o,b.length),f(o,e)&&C(t,n)){if(C(t,e)){i=b;continue t}if(!A(b,o,t,n,e,s,r,0,u,g))return!1}o=t}}return!0}case c.Pair:{const l=!g||!i.closingBracket||i.closingBracket.bracketInfo.closesColorized(i.openingBracket.bracketInfo);let h=0;if(u){let d=u.get(i.openingBracket.text);d===void 0&&(d=0),h=d,l&&(d++,u.set(i.openingBracket.text,d))}const b=i.childrenLength;for(let d=0;d<b;d++){const p=i.getChild(d);if(p){if(t=m(o,p.length),f(o,e)&&C(t,n)){if(C(t,e)&&p.kind!==c.Bracket){i=p,l?(r++,a=h+1):a=h;continue t}if((l||p.kind!==c.Bracket||!i.closingBracket)&&!A(p,o,t,n,e,s,l?r+1:r,l?h+1:h,u,g,!i.closingBracket))return!1}o=t}}return u?.set(i.openingBracket.text,h),!0}case c.UnexpectedClosingBracket:{const l=T(o,t);return s(new M(l,r-1,0,!0))}case c.Bracket:{const l=T(o,t);return s(new M(l,r-1,a-1,k))}case c.Text:return!0}}class U{constructor(o,t,n){this.push=o;this.includeMinIndentation=t;this.textModel=n}}function L(i,o,t,n,e,s,r,a){if(r>200)return!0;let u=!0;if(i.kind===c.Pair){let g=0;if(a){let h=a.get(i.openingBracket.text);h===void 0&&(h=0),g=h,h++,a.set(i.openingBracket.text,h)}const k=m(o,i.openingBracket.length);let l=-1;if(s.includeMinIndentation&&(l=i.computeMinIndentation(o,s.textModel)),u=s.push(new y(T(o,t),T(o,k),i.closingBracket?T(m(k,i.child?.length||x),t):void 0,r,g,i,l)),o=k,u&&i.child){const h=i.child;if(t=m(o,h.length),f(o,e)&&C(t,n)&&(u=L(h,o,t,n,e,s,r+1,a),!u))return!1}a?.set(i.openingBracket.text,g)}else{let g=o;for(const k of i.children){const l=g;if(g=m(g,k.length),f(l,e)&&f(n,g)&&(u=L(k,l,g,n,e,s,r,a),!u))return!1}}return u}export{ot as BracketPairsTree};
