import{filterValidationDecorations as N}from"../config/editorOptions.js";import{Position as I}from"../core/position.js";import{Range as f}from"../core/range.js";import{StandardTokenType as v}from"../encodedTokenAttributes.js";import{PositionAffinity as C}from"../model.js";import{InlineDecoration as b,InlineDecorationType as p,ViewModelDecoration as V}from"../viewModel.js";class E{editorId;model;configuration;_linesCollection;_coordinatesConverter;_decorationsCache;_cachedModelDecorationsResolver;_cachedModelDecorationsResolverViewRange;constructor(e,o,t,i,r){this.editorId=e,this.model=o,this.configuration=t,this._linesCollection=i,this._coordinatesConverter=r,this._decorationsCache=Object.create(null),this._cachedModelDecorationsResolver=null,this._cachedModelDecorationsResolverViewRange=null}_clearCachedModelDecorationsResolver(){this._cachedModelDecorationsResolver=null,this._cachedModelDecorationsResolverViewRange=null}dispose(){this._decorationsCache=Object.create(null),this._clearCachedModelDecorationsResolver()}reset(){this._decorationsCache=Object.create(null),this._clearCachedModelDecorationsResolver()}onModelDecorationsChanged(){this._decorationsCache=Object.create(null),this._clearCachedModelDecorationsResolver()}onLineMappingChanged(){this._decorationsCache=Object.create(null),this._clearCachedModelDecorationsResolver()}_getOrCreateViewModelDecoration(e){const o=e.id;let t=this._decorationsCache[o];if(!t){const i=e.range,r=e.options;let a;if(r.isWholeLine){const s=this._coordinatesConverter.convertModelPositionToViewPosition(new I(i.startLineNumber,1),C.Left,!1,!0),m=this._coordinatesConverter.convertModelPositionToViewPosition(new I(i.endLineNumber,this.model.getLineMaxColumn(i.endLineNumber)),C.Right);a=new f(s.lineNumber,s.column,m.lineNumber,m.column)}else a=this._coordinatesConverter.convertModelRangeToViewRange(i,C.Right);t=new V(a,r),this._decorationsCache[o]=t}return t}getMinimapDecorationsInRange(e){return this._getDecorationsInRange(e,!0,!1).decorations}getDecorationsViewportData(e){let o=this._cachedModelDecorationsResolver!==null;return o=o&&e.equalsRange(this._cachedModelDecorationsResolverViewRange),o||(this._cachedModelDecorationsResolver=this._getDecorationsInRange(e,!1,!1),this._cachedModelDecorationsResolverViewRange=e),this._cachedModelDecorationsResolver}getInlineDecorationsOnLine(e,o=!1,t=!1){const i=new f(e,this._linesCollection.getViewLineMinColumn(e),e,this._linesCollection.getViewLineMaxColumn(e));return this._getDecorationsInRange(i,o,t).inlineDecorations[0]}_getDecorationsInRange(e,o,t){const i=this._linesCollection.getDecorationsInRange(e,this.editorId,N(this.configuration.options),o,t),r=e.startLineNumber,a=e.endLineNumber,s=[];let m=0;const u=[];for(let c=r;c<=a;c++)u[c-r]=[];for(let c=0,L=i.length;c<L;c++){const D=i[c],d=D.options;if(!T(this.model,D))continue;const M=this._getOrCreateViewModelDecoration(D),n=M.range;if(s[m++]=M,d.inlineClassName){const h=new b(n,d.inlineClassName,d.inlineClassNameAffectsLetterSpacing?p.RegularAffectingLetterSpacing:p.Regular),w=Math.max(r,n.startLineNumber),_=Math.min(a,n.endLineNumber);for(let g=w;g<=_;g++)u[g-r].push(h)}if(d.beforeContentClassName&&r<=n.startLineNumber&&n.startLineNumber<=a){const h=new b(new f(n.startLineNumber,n.startColumn,n.startLineNumber,n.startColumn),d.beforeContentClassName,p.Before);u[n.startLineNumber-r].push(h)}if(d.afterContentClassName&&r<=n.endLineNumber&&n.endLineNumber<=a){const h=new b(new f(n.endLineNumber,n.endColumn,n.endLineNumber,n.endColumn),d.afterContentClassName,p.After);u[n.endLineNumber-r].push(h)}}return{decorations:s,inlineDecorations:u}}}function T(l,e){return!(e.options.hideInCommentTokens&&y(l,e)||e.options.hideInStringTokens&&x(l,e))}function y(l,e){return R(l,e.range,o=>o===v.Comment)}function x(l,e){return R(l,e.range,o=>o===v.String)}function R(l,e,o){for(let t=e.startLineNumber;t<=e.endLineNumber;t++){const i=l.tokenization.getLineTokens(t),r=t===e.startLineNumber,a=t===e.endLineNumber;let s=r?i.findTokenIndexAtOffset(e.startColumn-1):0;for(;s<i.getCount()&&!(a&&i.getStartOffset(s)>e.endColumn-1);){if(!o(i.getStandardTokenType(s)))return!1;s++}}return!0}export{E as ViewModelDecorations,y as isModelDecorationInComment,x as isModelDecorationInString,T as isModelDecorationVisible};
