import"../../../../vs/base/common/lifecycle.js";import"../../../../vs/editor/common/config/editorConfiguration.js";import{filterValidationDecorations as N}from"../../../../vs/editor/common/config/editorOptions.js";import{Position as I}from"../../../../vs/editor/common/core/position.js";import{Range as f}from"../../../../vs/editor/common/core/range.js";import{StandardTokenType as R}from"../../../../vs/editor/common/encodedTokenAttributes.js";import{PositionAffinity as g}from"../../../../vs/editor/common/model.js";import{InlineDecoration as b,InlineDecorationType as D,ViewModelDecoration as V}from"../../../../vs/editor/common/viewModel.js";import"../../../../vs/editor/common/viewModel/viewModelLines.js";class K{editorId;model;configuration;_linesCollection;_coordinatesConverter;_decorationsCache;_cachedModelDecorationsResolver;_cachedModelDecorationsResolverViewRange;constructor(e,o,t,i,r){this.editorId=e,this.model=o,this.configuration=t,this._linesCollection=i,this._coordinatesConverter=r,this._decorationsCache=Object.create(null),this._cachedModelDecorationsResolver=null,this._cachedModelDecorationsResolverViewRange=null}_clearCachedModelDecorationsResolver(){this._cachedModelDecorationsResolver=null,this._cachedModelDecorationsResolverViewRange=null}dispose(){this._decorationsCache=Object.create(null),this._clearCachedModelDecorationsResolver()}reset(){this._decorationsCache=Object.create(null),this._clearCachedModelDecorationsResolver()}onModelDecorationsChanged(){this._decorationsCache=Object.create(null),this._clearCachedModelDecorationsResolver()}onLineMappingChanged(){this._decorationsCache=Object.create(null),this._clearCachedModelDecorationsResolver()}_getOrCreateViewModelDecoration(e){const o=e.id;let t=this._decorationsCache[o];if(!t){const i=e.range,r=e.options;let a;if(r.isWholeLine){const s=this._coordinatesConverter.convertModelPositionToViewPosition(new I(i.startLineNumber,1),g.Left,!1,!0),m=this._coordinatesConverter.convertModelPositionToViewPosition(new I(i.endLineNumber,this.model.getLineMaxColumn(i.endLineNumber)),g.Right);a=new f(s.lineNumber,s.column,m.lineNumber,m.column)}else a=this._coordinatesConverter.convertModelRangeToViewRange(i,g.Right);t=new V(a,r),this._decorationsCache[o]=t}return t}getMinimapDecorationsInRange(e){return this._getDecorationsInRange(e,!0,!1).decorations}getDecorationsViewportData(e){let o=this._cachedModelDecorationsResolver!==null;return o=o&&e.equalsRange(this._cachedModelDecorationsResolverViewRange),o||(this._cachedModelDecorationsResolver=this._getDecorationsInRange(e,!1,!1),this._cachedModelDecorationsResolverViewRange=e),this._cachedModelDecorationsResolver}getInlineDecorationsOnLine(e,o=!1,t=!1){const i=new f(e,this._linesCollection.getViewLineMinColumn(e),e,this._linesCollection.getViewLineMaxColumn(e));return this._getDecorationsInRange(i,o,t).inlineDecorations[0]}_getDecorationsInRange(e,o,t){const i=this._linesCollection.getDecorationsInRange(e,this.editorId,N(this.configuration.options),o,t),r=e.startLineNumber,a=e.endLineNumber,s=[];let m=0;const u=[];for(let c=r;c<=a;c++)u[c-r]=[];for(let c=0,L=i.length;c<L;c++){const p=i[c],d=p.options;if(!T(this.model,p))continue;const M=this._getOrCreateViewModelDecoration(p),n=M.range;if(s[m++]=M,d.inlineClassName){const h=new b(n,d.inlineClassName,d.inlineClassNameAffectsLetterSpacing?D.RegularAffectingLetterSpacing:D.Regular),_=Math.max(r,n.startLineNumber),w=Math.min(a,n.endLineNumber);for(let C=_;C<=w;C++)u[C-r].push(h)}if(d.beforeContentClassName&&r<=n.startLineNumber&&n.startLineNumber<=a){const h=new b(new f(n.startLineNumber,n.startColumn,n.startLineNumber,n.startColumn),d.beforeContentClassName,D.Before);u[n.startLineNumber-r].push(h)}if(d.afterContentClassName&&r<=n.endLineNumber&&n.endLineNumber<=a){const h=new b(new f(n.endLineNumber,n.endColumn,n.endLineNumber,n.endColumn),d.afterContentClassName,D.After);u[n.endLineNumber-r].push(h)}}return{decorations:s,inlineDecorations:u}}}function T(l,e){return!(e.options.hideInCommentTokens&&x(l,e)||e.options.hideInStringTokens&&k(l,e))}function x(l,e){return v(l,e.range,o=>o===R.Comment)}function k(l,e){return v(l,e.range,o=>o===R.String)}function v(l,e,o){for(let t=e.startLineNumber;t<=e.endLineNumber;t++){const i=l.tokenization.getLineTokens(t),r=t===e.startLineNumber,a=t===e.endLineNumber;let s=r?i.findTokenIndexAtOffset(e.startColumn-1):0;for(;s<i.getCount()&&!(a&&i.getStartOffset(s)>e.endColumn-1);){if(!o(i.getStandardTokenType(s)))return!1;s++}}return!0}export{K as ViewModelDecorations,x as isModelDecorationInComment,k as isModelDecorationInString,T as isModelDecorationVisible};
