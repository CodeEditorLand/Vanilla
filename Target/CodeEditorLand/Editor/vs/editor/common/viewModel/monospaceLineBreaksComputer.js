import{CharCode as T}from"../../../../vs/base/common/charCode.js";import*as w from"../../../../vs/base/common/strings.js";import{EditorOption as Q,WrappingIndent as y}from"../../../../vs/editor/common/config/editorOptions.js";import"../../../../vs/editor/common/config/fontInfo.js";import{CharacterClassifier as Y}from"../../../../vs/editor/common/core/characterClassifier.js";import"../../../../vs/editor/common/model.js";import{ModelLineProjectionData as F}from"../../../../vs/editor/common/modelLineProjectionData.js";import{LineInjectedText as Z}from"../../../../vs/editor/common/textModelEvents.js";class X{static create(e){return new X(e.get(Q.wordWrapBreakBeforeCharacters),e.get(Q.wordWrapBreakAfterCharacters))}classifier;constructor(e,t){this.classifier=new z(e,t)}createLineBreaksComputer(e,t,r,n,o){const E=[],P=[],f=[];return{addRequest:(u,h,i)=>{E.push(u),P.push(h),f.push(i)},finalize:()=>{const u=e.typicalFullwidthCharacterWidth/e.typicalHalfwidthCharacterWidth,h=[];for(let i=0,v=E.length;i<v;i++){const L=P[i],I=f[i];I&&!I.injectionOptions&&!L?h[i]=ee(this.classifier,I,E[i],t,r,u,n,o):h[i]=te(this.classifier,E[i],L,t,r,u,n,o)}return G.length=0,q.length=0,h}}}}var $=(n=>(n[n.NONE=0]="NONE",n[n.BREAK_BEFORE=1]="BREAK_BEFORE",n[n.BREAK_AFTER=2]="BREAK_AFTER",n[n.BREAK_IDEOGRAPHIC=3]="BREAK_IDEOGRAPHIC",n))($||{});class z extends Y{constructor(e,t){super(0);for(let r=0;r<e.length;r++)this.set(e.charCodeAt(r),1);for(let r=0;r<t.length;r++)this.set(t.charCodeAt(r),2)}get(e){return e>=0&&e<256?this._asciiMap[e]:e>=12352&&e<=12543||e>=13312&&e<=19903||e>=19968&&e<=40959?3:this._map.get(e)||this._defaultValue}}let G=[],q=[];function ee(c,e,t,r,n,o,E,P){if(n===-1)return null;const f=t.length;if(f<=1)return null;const u=P==="keepAll",h=e.breakOffsets,i=e.breakOffsetsVisibleColumn,v=U(t,r,n,o,E),L=n-v,I=G,_=q;let A=0,p=0,B=0,d=n;const x=h.length;let s=0;if(s>=0){let g=Math.abs(i[s]-d);for(;s+1<x;){const b=Math.abs(i[s+1]-d);if(b>=g)break;g=b,s++}}for(;s<x;){let g=s<0?0:h[s],b=s<0?0:i[s];p>g&&(g=p,b=B);let C=0,l=0,W=0,k=0;if(b<=d){let a=b,M=g===0?T.Null:t.charCodeAt(g-1),V=g===0?0:c.get(M),H=!0;for(let O=g;O<f;O++){const R=O,m=t.charCodeAt(O);let N,j;if(w.isHighSurrogate(m)?(O++,N=0,j=2):(N=c.get(m),j=D(m,a,r,o)),R>p&&J(M,V,m,N,u)&&(C=R,l=a),a+=j,a>d){R>p?(W=R,k=a-j):(W=O+1,k=a),a-l>L&&(C=0),H=!1;break}M=m,V=N}if(H){A>0&&(I[A]=h[h.length-1],_[A]=i[h.length-1],A++);break}}if(C===0){let a=b,M=t.charCodeAt(g),V=c.get(M),H=!1;for(let O=g-1;O>=p;O--){const R=O+1,m=t.charCodeAt(O);if(m===T.Tab){H=!0;break}let N,j;if(w.isLowSurrogate(m)?(O--,N=0,j=2):(N=c.get(m),j=w.isFullWidthCharacter(m)?o:1),a<=d){if(W===0&&(W=R,k=a),a<=d-L)break;if(J(m,N,M,V,u)){C=R,l=a;break}}a-=j,M=m,V=N}if(C!==0){const O=L-(k-l);if(O<=r){const R=t.charCodeAt(W);let m;w.isHighSurrogate(R)?m=2:m=D(R,k,r,o),O-m<0&&(C=0)}}if(H){s--;continue}}if(C===0&&(C=W,l=k),C<=p){const a=t.charCodeAt(p);w.isHighSurrogate(a)?(C=p+2,l=B+2):(C=p+1,l=B+D(a,B,r,o))}for(p=C,I[A]=C,B=l,_[A]=l,A++,d=l+L;s<0||s<x&&i[s]<l;)s++;let K=Math.abs(i[s]-d);for(;s+1<x;){const a=Math.abs(i[s+1]-d);if(a>=K)break;K=a,s++}}return A===0?null:(I.length=A,_.length=A,G=e.breakOffsets,q=e.breakOffsetsVisibleColumn,e.breakOffsets=I,e.breakOffsetsVisibleColumn=_,e.wrappedTextIndentLength=v,e)}function te(c,e,t,r,n,o,E,P){const f=Z.applyInjectedText(e,t);let u,h;if(t&&t.length>0?(u=t.map(l=>l.options),h=t.map(l=>l.column-1)):(u=null,h=null),n===-1)return u?new F(h,u,[f.length],[],0):null;const i=f.length;if(i<=1)return u?new F(h,u,[f.length],[],0):null;const v=P==="keepAll",L=U(f,r,n,o,E),I=n-L,_=[],A=[];let p=0,B=0,d=0,x=n,s=f.charCodeAt(0),g=c.get(s),b=D(s,0,r,o),C=1;w.isHighSurrogate(s)&&(b+=1,s=f.charCodeAt(1),g=c.get(s),C++);for(let l=C;l<i;l++){const W=l,k=f.charCodeAt(l);let K,a;w.isHighSurrogate(k)?(l++,K=0,a=2):(K=c.get(k),a=D(k,b,r,o)),J(s,g,k,K,v)&&(B=W,d=b),b+=a,b>x&&((B===0||b-d>I)&&(B=W,d=b-a),_[p]=B,A[p]=d,p++,x=d+I,B=0),s=k,g=K}return p===0&&(!t||t.length===0)?null:(_[p]=i,A[p]=b,new F(h,u,_,A,L))}function D(c,e,t,r){return c===T.Tab?t-e%t:w.isFullWidthCharacter(c)||c<32?r:1}function S(c,e){return e-c%e}function J(c,e,t,r,n){return t!==T.Space&&(e===2&&r!==2||e!==1&&r===1||!n&&e===3&&r!==2||!n&&r===3&&e!==1)}function U(c,e,t,r,n){let o=0;if(n!==y.None){const E=w.firstNonWhitespaceIndex(c);if(E!==-1){for(let f=0;f<E;f++){const u=c.charCodeAt(f)===T.Tab?S(o,e):1;o+=u}const P=n===y.DeepIndent?2:n===y.Indent?1:0;for(let f=0;f<P;f++){const u=S(o,e);o+=u}o+r>t&&(o=0)}}return o}export{X as MonospaceLineBreaksComputerFactory};
