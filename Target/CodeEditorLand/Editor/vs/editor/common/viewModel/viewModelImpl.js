import{ArrayQueue as P}from"../../../base/common/arrays.js";import{RunOnceScheduler as O}from"../../../base/common/async.js";import{Color as A}from"../../../base/common/color.js";import"../../../base/common/event.js";import{Disposable as x}from"../../../base/common/lifecycle.js";import*as k from"../../../base/common/platform.js";import*as M from"../../../base/common/strings.js";import{EditorOption as m,EDITOR_FONT_DEFAULTS as I,filterValidationDecorations as F}from"../config/editorOptions.js";import{CursorsController as H}from"../cursor/cursor.js";import{CursorConfiguration as _}from"../cursorCommon.js";import{CursorChangeReason as B}from"../cursorEvents.js";import{Position as E}from"../core/position.js";import{Range as w}from"../core/range.js";import"../core/selection.js";import{ScrollType as V}from"../editorCommon.js";import"../config/editorConfiguration.js";import{EndOfLinePreference as y,TrackedRangeStickiness as S}from"../model.js";import"../textModelGuides.js";import"../model/textModel.js";import*as C from"../textModelEvents.js";import{TokenizationRegistry as G}from"../languages.js";import{ColorId as T}from"../encodedTokenAttributes.js";import"../languages/languageConfigurationRegistry.js";import{PLAINTEXT_LANGUAGE_ID as z}from"../languages/modesRegistry.js";import{tokenizeLineToHTML as W}from"../languages/textToHtmlTokenizer.js";import"../editorTheme.js";import*as h from"../viewEvents.js";import{ViewLayout as j}from"../viewLayout/viewLayout.js";import{MinimapTokensColorTracker as $}from"./minimapTokensColorTracker.js";import"../modelLineProjectionData.js";import"../viewEventHandler.js";import{MinimapLinesRenderingData as q,OverviewRulerDecorationsGroup as Q,ViewLineRenderingData as U}from"../viewModel.js";import{ViewModelDecorations as Z}from"./viewModelDecorations.js";import{FocusChangedEvent as J,HiddenAreasChangedEvent as X,ModelContentChangedEvent as Y,ModelDecorationsChangedEvent as K,ModelLanguageChangedEvent as ee,ModelLanguageConfigurationChangedEvent as te,ModelOptionsChangedEvent as ie,ModelTokensChangedEvent as ne,ReadOnlyEditAttemptEvent as oe,ScrollChangedEvent as re,ViewModelEventDispatcher as se,ViewZonesChangedEvent as ae}from"../viewModelEventDispatcher.js";import{ViewModelLinesFromModelAsIs as le,ViewModelLinesFromProjectedModel as ue}from"./viewModelLines.js";import"../../../platform/theme/common/themeService.js";import{GlyphMarginLanesModel as de}from"./glyphLanesModel.js";const ce=!0;class xt extends x{constructor(e,t,i,n,r,o,l,a,d,u){super();this.languageConfigurationService=l;this._themeService=a;this._attachedView=d;this._transactionalTarget=u;if(this._editorId=e,this._configuration=t,this.model=i,this._eventDispatcher=new se,this.onEvent=this._eventDispatcher.onEvent,this.cursorConfig=new _(this.model.getLanguageId(),this.model.getOptions(),this._configuration,this.languageConfigurationService),this._updateConfigurationViewLineCount=this._register(new O(()=>this._updateConfigurationViewLineCountNow(),0)),this._hasFocus=!1,this._viewportStart=D.create(this.model),this.glyphLanes=new de(0),ce&&this.model.isTooLargeForTokenization())this._lines=new le(this.model);else{const s=this._configuration.options,g=s.get(m.fontInfo),p=s.get(m.wrappingStrategy),f=s.get(m.wrappingInfo),b=s.get(m.wrappingIndent),L=s.get(m.wordBreak);this._lines=new ue(this._editorId,this.model,n,r,g,this.model.getOptions().tabSize,p,f.wrappingColumn,b,L)}this.coordinatesConverter=this._lines.createCoordinatesConverter(),this._cursor=this._register(new H(i,this,this.coordinatesConverter,this.cursorConfig)),this.viewLayout=this._register(new j(this._configuration,this.getLineCount(),o)),this._register(this.viewLayout.onDidScroll(s=>{s.scrollTopChanged&&this._handleVisibleLinesChanged(),s.scrollTopChanged&&this._viewportStart.invalidate(),this._eventDispatcher.emitSingleViewEvent(new h.ViewScrollChangedEvent(s)),this._eventDispatcher.emitOutgoingEvent(new re(s.oldScrollWidth,s.oldScrollLeft,s.oldScrollHeight,s.oldScrollTop,s.scrollWidth,s.scrollLeft,s.scrollHeight,s.scrollTop))})),this._register(this.viewLayout.onDidContentSizeChange(s=>{this._eventDispatcher.emitOutgoingEvent(s)})),this._decorations=new Z(this._editorId,this.model,this._configuration,this._lines,this.coordinatesConverter),this._registerModelEvents(),this._register(this._configuration.onDidChangeFast(s=>{try{const g=this._eventDispatcher.beginEmitViewEvents();this._onConfigurationChanged(g,s)}finally{this._eventDispatcher.endEmitViewEvents()}})),this._register($.getInstance().onDidChange(()=>{this._eventDispatcher.emitSingleViewEvent(new h.ViewTokensColorsChangedEvent)})),this._register(this._themeService.onDidColorThemeChange(s=>{this._invalidateDecorationsColorCache(),this._eventDispatcher.emitSingleViewEvent(new h.ViewThemeChangedEvent(s))})),this._updateConfigurationViewLineCountNow()}_editorId;_configuration;model;_eventDispatcher;onEvent;cursorConfig;_updateConfigurationViewLineCount;_hasFocus;_viewportStart;_lines;coordinatesConverter;viewLayout;_cursor;_decorations;glyphLanes;dispose(){super.dispose(),this._decorations.dispose(),this._lines.dispose(),this._viewportStart.dispose(),this._eventDispatcher.dispose()}createLineBreaksComputer(){return this._lines.createLineBreaksComputer()}addViewEventHandler(e){this._eventDispatcher.addViewEventHandler(e)}removeViewEventHandler(e){this._eventDispatcher.removeViewEventHandler(e)}_updateConfigurationViewLineCountNow(){this._configuration.setViewLineCount(this._lines.getViewLineCount())}getModelVisibleRanges(){const e=this.viewLayout.getLinesViewportData(),t=new w(e.startLineNumber,this.getLineMinColumn(e.startLineNumber),e.endLineNumber,this.getLineMaxColumn(e.endLineNumber));return this._toModelVisibleRanges(t)}visibleLinesStabilized(){const e=this.getModelVisibleRanges();this._attachedView.setVisibleLines(e,!0)}_handleVisibleLinesChanged(){const e=this.getModelVisibleRanges();this._attachedView.setVisibleLines(e,!1)}setHasFocus(e){this._hasFocus=e,this._cursor.setHasFocus(e),this._eventDispatcher.emitSingleViewEvent(new h.ViewFocusChangedEvent(e)),this._eventDispatcher.emitOutgoingEvent(new J(!e,e))}onCompositionStart(){this._eventDispatcher.emitSingleViewEvent(new h.ViewCompositionStartEvent)}onCompositionEnd(){this._eventDispatcher.emitSingleViewEvent(new h.ViewCompositionEndEvent)}_captureStableViewport(){if(this._viewportStart.isValid&&this.viewLayout.getCurrentScrollTop()>0){const e=new E(this._viewportStart.viewLineNumber,this.getLineMinColumn(this._viewportStart.viewLineNumber)),t=this.coordinatesConverter.convertViewPositionToModelPosition(e);return new N(t,this._viewportStart.startLineDelta)}return new N(null,0)}_onConfigurationChanged(e,t){const i=this._captureStableViewport(),n=this._configuration.options,r=n.get(m.fontInfo),o=n.get(m.wrappingStrategy),l=n.get(m.wrappingInfo),a=n.get(m.wrappingIndent),d=n.get(m.wordBreak);this._lines.setWrappingSettings(r,o,l.wrappingColumn,a,d)&&(e.emitViewEvent(new h.ViewFlushedEvent),e.emitViewEvent(new h.ViewLineMappingChangedEvent),e.emitViewEvent(new h.ViewDecorationsChangedEvent(null)),this._cursor.onLineMappingChanged(e),this._decorations.onLineMappingChanged(),this.viewLayout.onFlushed(this.getLineCount()),this._updateConfigurationViewLineCount.schedule()),t.hasChanged(m.readOnly)&&(this._decorations.reset(),e.emitViewEvent(new h.ViewDecorationsChangedEvent(null))),t.hasChanged(m.renderValidationDecorations)&&(this._decorations.reset(),e.emitViewEvent(new h.ViewDecorationsChangedEvent(null))),e.emitViewEvent(new h.ViewConfigurationChangedEvent(t)),this.viewLayout.onConfigurationChanged(t),i.recoverViewportStart(this.coordinatesConverter,this.viewLayout),_.shouldRecreate(t)&&(this.cursorConfig=new _(this.model.getLanguageId(),this.model.getOptions(),this._configuration,this.languageConfigurationService),this._cursor.updateConfiguration(this.cursorConfig))}_registerModelEvents(){this._register(this.model.onDidChangeContentOrInjectedText(e=>{try{const i=this._eventDispatcher.beginEmitViewEvents();let n=!1,r=!1;const o=e instanceof C.InternalModelContentChangeEvent?e.rawContentChangedEvent.changes:e.changes,l=e instanceof C.InternalModelContentChangeEvent?e.rawContentChangedEvent.versionId:null,a=this._lines.createLineBreaksComputer();for(const s of o)switch(s.changeType){case C.RawContentChangedType.LinesInserted:{for(let g=0;g<s.detail.length;g++){const p=s.detail[g];let f=s.injectedTexts[g];f&&(f=f.filter(b=>!b.ownerId||b.ownerId===this._editorId)),a.addRequest(p,f,null)}break}case C.RawContentChangedType.LineChanged:{let g=null;s.injectedText&&(g=s.injectedText.filter(p=>!p.ownerId||p.ownerId===this._editorId)),a.addRequest(s.detail,g,null);break}}const d=a.finalize(),u=new P(d);for(const s of o)switch(s.changeType){case C.RawContentChangedType.Flush:{this._lines.onModelFlushed(),i.emitViewEvent(new h.ViewFlushedEvent),this._decorations.reset(),this.viewLayout.onFlushed(this.getLineCount()),n=!0;break}case C.RawContentChangedType.LinesDeleted:{const g=this._lines.onModelLinesDeleted(l,s.fromLineNumber,s.toLineNumber);g!==null&&(i.emitViewEvent(g),this.viewLayout.onLinesDeleted(g.fromLineNumber,g.toLineNumber)),n=!0;break}case C.RawContentChangedType.LinesInserted:{const g=u.takeCount(s.detail.length),p=this._lines.onModelLinesInserted(l,s.fromLineNumber,s.toLineNumber,g);p!==null&&(i.emitViewEvent(p),this.viewLayout.onLinesInserted(p.fromLineNumber,p.toLineNumber)),n=!0;break}case C.RawContentChangedType.LineChanged:{const g=u.dequeue(),[p,f,b,L]=this._lines.onModelLineChanged(l,s.lineNumber,g);r=p,f&&i.emitViewEvent(f),b&&(i.emitViewEvent(b),this.viewLayout.onLinesInserted(b.fromLineNumber,b.toLineNumber)),L&&(i.emitViewEvent(L),this.viewLayout.onLinesDeleted(L.fromLineNumber,L.toLineNumber));break}case C.RawContentChangedType.EOLChanged:break}l!==null&&this._lines.acceptVersionId(l),this.viewLayout.onHeightMaybeChanged(),!n&&r&&(i.emitViewEvent(new h.ViewLineMappingChangedEvent),i.emitViewEvent(new h.ViewDecorationsChangedEvent(null)),this._cursor.onLineMappingChanged(i),this._decorations.onLineMappingChanged())}finally{this._eventDispatcher.endEmitViewEvents()}const t=this._viewportStart.isValid;if(this._viewportStart.invalidate(),this._configuration.setModelLineCount(this.model.getLineCount()),this._updateConfigurationViewLineCountNow(),!this._hasFocus&&this.model.getAttachedEditorCount()>=2&&t){const i=this.model._getTrackedRange(this._viewportStart.modelTrackedRange);if(i){const n=this.coordinatesConverter.convertModelPositionToViewPosition(i.getStartPosition()),r=this.viewLayout.getVerticalOffsetForLineNumber(n.lineNumber);this.viewLayout.setScrollPosition({scrollTop:r+this._viewportStart.startLineDelta},V.Immediate)}}try{const i=this._eventDispatcher.beginEmitViewEvents();e instanceof C.InternalModelContentChangeEvent&&i.emitOutgoingEvent(new Y(e.contentChangedEvent)),this._cursor.onModelContentChanged(i,e)}finally{this._eventDispatcher.endEmitViewEvents()}this._handleVisibleLinesChanged()})),this._register(this.model.onDidChangeTokens(e=>{const t=[];for(let i=0,n=e.ranges.length;i<n;i++){const r=e.ranges[i],o=this.coordinatesConverter.convertModelPositionToViewPosition(new E(r.fromLineNumber,1)).lineNumber,l=this.coordinatesConverter.convertModelPositionToViewPosition(new E(r.toLineNumber,this.model.getLineMaxColumn(r.toLineNumber))).lineNumber;t[i]={fromLineNumber:o,toLineNumber:l}}this._eventDispatcher.emitSingleViewEvent(new h.ViewTokensChangedEvent(t)),this._eventDispatcher.emitOutgoingEvent(new ne(e))})),this._register(this.model.onDidChangeLanguageConfiguration(e=>{this._eventDispatcher.emitSingleViewEvent(new h.ViewLanguageConfigurationEvent),this.cursorConfig=new _(this.model.getLanguageId(),this.model.getOptions(),this._configuration,this.languageConfigurationService),this._cursor.updateConfiguration(this.cursorConfig),this._eventDispatcher.emitOutgoingEvent(new te(e))})),this._register(this.model.onDidChangeLanguage(e=>{this.cursorConfig=new _(this.model.getLanguageId(),this.model.getOptions(),this._configuration,this.languageConfigurationService),this._cursor.updateConfiguration(this.cursorConfig),this._eventDispatcher.emitOutgoingEvent(new ee(e))})),this._register(this.model.onDidChangeOptions(e=>{if(this._lines.setTabSize(this.model.getOptions().tabSize)){try{const t=this._eventDispatcher.beginEmitViewEvents();t.emitViewEvent(new h.ViewFlushedEvent),t.emitViewEvent(new h.ViewLineMappingChangedEvent),t.emitViewEvent(new h.ViewDecorationsChangedEvent(null)),this._cursor.onLineMappingChanged(t),this._decorations.onLineMappingChanged(),this.viewLayout.onFlushed(this.getLineCount())}finally{this._eventDispatcher.endEmitViewEvents()}this._updateConfigurationViewLineCount.schedule()}this.cursorConfig=new _(this.model.getLanguageId(),this.model.getOptions(),this._configuration,this.languageConfigurationService),this._cursor.updateConfiguration(this.cursorConfig),this._eventDispatcher.emitOutgoingEvent(new ie(e))})),this._register(this.model.onDidChangeDecorations(e=>{this._decorations.onModelDecorationsChanged(),this._eventDispatcher.emitSingleViewEvent(new h.ViewDecorationsChangedEvent(e)),this._eventDispatcher.emitOutgoingEvent(new K(e))}))}hiddenAreasModel=new ge;previousHiddenAreas=[];setHiddenAreas(e,t,i){this.hiddenAreasModel.setHiddenAreas(t,e);const n=this.hiddenAreasModel.getMergedRanges();if(n===this.previousHiddenAreas&&!i)return;this.previousHiddenAreas=n;const r=this._captureStableViewport();let o=!1;try{const l=this._eventDispatcher.beginEmitViewEvents();o=this._lines.setHiddenAreas(n),o&&(l.emitViewEvent(new h.ViewFlushedEvent),l.emitViewEvent(new h.ViewLineMappingChangedEvent),l.emitViewEvent(new h.ViewDecorationsChangedEvent(null)),this._cursor.onLineMappingChanged(l),this._decorations.onLineMappingChanged(),this.viewLayout.onFlushed(this.getLineCount()),this.viewLayout.onHeightMaybeChanged());const a=r.viewportStartModelPosition?.lineNumber;a&&n.some(u=>u.startLineNumber<=a&&a<=u.endLineNumber)||r.recoverViewportStart(this.coordinatesConverter,this.viewLayout)}finally{this._eventDispatcher.endEmitViewEvents()}this._updateConfigurationViewLineCount.schedule(),o&&this._eventDispatcher.emitOutgoingEvent(new X)}getVisibleRangesPlusViewportAboveBelow(){const e=this._configuration.options.get(m.layoutInfo),t=this._configuration.options.get(m.lineHeight),i=Math.max(20,Math.round(e.height/t)),n=this.viewLayout.getLinesViewportData(),r=Math.max(1,n.completelyVisibleStartLineNumber-i),o=Math.min(this.getLineCount(),n.completelyVisibleEndLineNumber+i);return this._toModelVisibleRanges(new w(r,this.getLineMinColumn(r),o,this.getLineMaxColumn(o)))}getVisibleRanges(){const e=this.getCompletelyVisibleViewRange();return this._toModelVisibleRanges(e)}getHiddenAreas(){return this._lines.getHiddenAreas()}_toModelVisibleRanges(e){const t=this.coordinatesConverter.convertViewRangeToModelRange(e),i=this._lines.getHiddenAreas();if(i.length===0)return[t];const n=[];let r=0,o=t.startLineNumber,l=t.startColumn;const a=t.endLineNumber,d=t.endColumn;for(let u=0,s=i.length;u<s;u++){const g=i[u].startLineNumber,p=i[u].endLineNumber;p<o||g>a||(o<g&&(n[r++]=new w(o,l,g-1,this.model.getLineMaxColumn(g-1))),o=p+1,l=1)}return(o<a||o===a&&l<d)&&(n[r++]=new w(o,l,a,d)),n}getCompletelyVisibleViewRange(){const e=this.viewLayout.getLinesViewportData(),t=e.completelyVisibleStartLineNumber,i=e.completelyVisibleEndLineNumber;return new w(t,this.getLineMinColumn(t),i,this.getLineMaxColumn(i))}getCompletelyVisibleViewRangeAtScrollTop(e){const t=this.viewLayout.getLinesViewportDataAtScrollTop(e),i=t.completelyVisibleStartLineNumber,n=t.completelyVisibleEndLineNumber;return new w(i,this.getLineMinColumn(i),n,this.getLineMaxColumn(n))}saveState(){const e=this.viewLayout.saveState(),t=e.scrollTop,i=this.viewLayout.getLineNumberAtVerticalOffset(t),n=this.coordinatesConverter.convertViewPositionToModelPosition(new E(i,this.getLineMinColumn(i))),r=this.viewLayout.getVerticalOffsetForLineNumber(i)-t;return{scrollLeft:e.scrollLeft,firstPosition:n,firstPositionDeltaTop:r}}reduceRestoreState(e){if(typeof e.firstPosition>"u")return this._reduceRestoreStateCompatibility(e);const t=this.model.validatePosition(e.firstPosition),i=this.coordinatesConverter.convertModelPositionToViewPosition(t),n=this.viewLayout.getVerticalOffsetForLineNumber(i.lineNumber)-e.firstPositionDeltaTop;return{scrollLeft:e.scrollLeft,scrollTop:n}}_reduceRestoreStateCompatibility(e){return{scrollLeft:e.scrollLeft,scrollTop:e.scrollTopWithoutViewZones}}getTabSize(){return this.model.getOptions().tabSize}getLineCount(){return this._lines.getViewLineCount()}setViewport(e,t,i){this._viewportStart.update(this,e)}getActiveIndentGuide(e,t,i){return this._lines.getActiveIndentGuide(e,t,i)}getLinesIndentGuides(e,t){return this._lines.getViewLinesIndentGuides(e,t)}getBracketGuidesInRangeByLine(e,t,i,n){return this._lines.getViewLinesBracketGuides(e,t,i,n)}getLineContent(e){return this._lines.getViewLineContent(e)}getLineLength(e){return this._lines.getViewLineLength(e)}getLineMinColumn(e){return this._lines.getViewLineMinColumn(e)}getLineMaxColumn(e){return this._lines.getViewLineMaxColumn(e)}getLineFirstNonWhitespaceColumn(e){const t=M.firstNonWhitespaceIndex(this.getLineContent(e));return t===-1?0:t+1}getLineLastNonWhitespaceColumn(e){const t=M.lastNonWhitespaceIndex(this.getLineContent(e));return t===-1?0:t+2}getMinimapDecorationsInRange(e){return this._decorations.getMinimapDecorationsInRange(e)}getDecorationsInViewport(e){return this._decorations.getDecorationsViewportData(e).decorations}getInjectedTextAt(e){return this._lines.getInjectedTextAt(e)}getViewportViewLineRenderingData(e,t){const n=this._decorations.getDecorationsViewportData(e).inlineDecorations[t-e.startLineNumber];return this._getViewLineRenderingData(t,n)}getViewLineRenderingData(e){const t=this._decorations.getInlineDecorationsOnLine(e);return this._getViewLineRenderingData(e,t)}_getViewLineRenderingData(e,t){const i=this.model.mightContainRTL(),n=this.model.mightContainNonBasicASCII(),r=this.getTabSize(),o=this._lines.getViewLineData(e);return o.inlineDecorations&&(t=[...t,...o.inlineDecorations.map(l=>l.toInlineDecoration(e))]),new U(o.minColumn,o.maxColumn,o.content,o.continuesWithWrappedLine,i,n,o.tokens,t,r,o.startVisibleColumn)}getViewLineData(e){return this._lines.getViewLineData(e)}getMinimapLinesRenderingData(e,t,i){const n=this._lines.getViewLinesData(e,t,i);return new q(this.getTabSize(),n)}getAllOverviewRulerDecorations(e){const t=this.model.getOverviewRulerDecorations(this._editorId,F(this._configuration.options)),i=new he;for(const n of t){const r=n.options,o=r.overviewRuler;if(!o)continue;const l=o.position;if(l===0)continue;const a=o.getColor(e.value),d=this.coordinatesConverter.getViewLineNumberOfModelPosition(n.range.startLineNumber,n.range.startColumn),u=this.coordinatesConverter.getViewLineNumberOfModelPosition(n.range.endLineNumber,n.range.endColumn);i.accept(a,r.zIndex,d,u,l)}return i.asArray}_invalidateDecorationsColorCache(){const e=this.model.getOverviewRulerDecorations();for(const t of e)t.options.overviewRuler?.invalidateCachedColor(),t.options.minimap?.invalidateCachedColor()}getValueInRange(e,t){const i=this.coordinatesConverter.convertViewRangeToModelRange(e);return this.model.getValueInRange(i,t)}getValueLengthInRange(e,t){const i=this.coordinatesConverter.convertViewRangeToModelRange(e);return this.model.getValueLengthInRange(i,t)}modifyPosition(e,t){const i=this.coordinatesConverter.convertViewPositionToModelPosition(e),n=this.model.modifyPosition(i,t);return this.coordinatesConverter.convertModelPositionToViewPosition(n)}deduceModelPositionRelativeToViewPosition(e,t,i){const n=this.coordinatesConverter.convertViewPositionToModelPosition(e);this.model.getEOL().length===2&&(t<0?t-=i:t+=i);const o=this.model.getOffsetAt(n)+t;return this.model.getPositionAt(o)}getPlainTextToCopy(e,t,i){const n=i?`\r
`:this.model.getEOL();e=e.slice(0),e.sort(w.compareRangesUsingStarts);let r=!1,o=!1;for(const a of e)a.isEmpty()?r=!0:o=!0;if(!o){if(!t)return"";const a=e.map(u=>u.startLineNumber);let d="";for(let u=0;u<a.length;u++)u>0&&a[u-1]===a[u]||(d+=this.model.getLineContent(a[u])+n);return d}if(r&&t){const a=[];let d=0;for(const u of e){const s=u.startLineNumber;u.isEmpty()?s!==d&&a.push(this.model.getLineContent(s)):a.push(this.model.getValueInRange(u,i?y.CRLF:y.TextDefined)),d=s}return a.length===1?a[0]:a}const l=[];for(const a of e)a.isEmpty()||l.push(this.model.getValueInRange(a,i?y.CRLF:y.TextDefined));return l.length===1?l[0]:l}getRichTextToCopy(e,t){const i=this.model.getLanguageId();if(i===z||e.length!==1)return null;let n=e[0];if(n.isEmpty()){if(!t)return null;const u=n.startLineNumber;n=new w(u,this.model.getLineMinColumn(u),u,this.model.getLineMaxColumn(u))}const r=this._configuration.options.get(m.fontInfo),o=this._getColorMap(),a=/[:;\\\/<>]/.test(r.fontFamily)||r.fontFamily===I.fontFamily;let d;return a?d=I.fontFamily:(d=r.fontFamily,d=d.replace(/"/g,"'"),/[,']/.test(d)||/[+ ]/.test(d)&&(d=`'${d}'`),d=`${d}, ${I.fontFamily}`),{mode:i,html:`<div style="color: ${o[T.DefaultForeground]};background-color: ${o[T.DefaultBackground]};font-family: ${d};font-weight: ${r.fontWeight};font-size: ${r.fontSize}px;line-height: ${r.lineHeight}px;white-space: pre;">`+this._getHTMLToCopy(n,o)+"</div>"}}_getHTMLToCopy(e,t){const i=e.startLineNumber,n=e.startColumn,r=e.endLineNumber,o=e.endColumn,l=this.getTabSize();let a="";for(let d=i;d<=r;d++){const u=this.model.tokenization.getLineTokens(d),s=u.getLineContent(),g=d===i?n-1:0,p=d===r?o-1:s.length;s===""?a+="<br>":a+=W(s,u.inflate(),t,g,p,l,k.isWindows)}return a}_getColorMap(){const e=G.getColorMap(),t=["#000000"];if(e)for(let i=1,n=e.length;i<n;i++)t[i]=A.Format.CSS.formatHex(e[i]);return t}getPrimaryCursorState(){return this._cursor.getPrimaryCursorState()}getLastAddedCursorIndex(){return this._cursor.getLastAddedCursorIndex()}getCursorStates(){return this._cursor.getCursorStates()}setCursorStates(e,t,i){return this._withViewEventsCollector(n=>this._cursor.setStates(n,e,t,i))}getCursorColumnSelectData(){return this._cursor.getCursorColumnSelectData()}getCursorAutoClosedCharacters(){return this._cursor.getAutoClosedCharacters()}setCursorColumnSelectData(e){this._cursor.setCursorColumnSelectData(e)}getPrevEditOperationType(){return this._cursor.getPrevEditOperationType()}setPrevEditOperationType(e){this._cursor.setPrevEditOperationType(e)}getSelection(){return this._cursor.getSelection()}getSelections(){return this._cursor.getSelections()}getPosition(){return this._cursor.getPrimaryCursorState().modelState.position}setSelections(e,t,i=B.NotSet){this._withViewEventsCollector(n=>this._cursor.setSelections(n,e,t,i))}saveCursorState(){return this._cursor.saveState()}restoreCursorState(e){this._withViewEventsCollector(t=>this._cursor.restoreState(t,e))}_executeCursorEdit(e){if(this._cursor.context.cursorConfig.readOnly){this._eventDispatcher.emitOutgoingEvent(new oe);return}this._withViewEventsCollector(e)}executeEdits(e,t,i){this._executeCursorEdit(n=>this._cursor.executeEdits(n,e,t,i))}startComposition(){this._executeCursorEdit(e=>this._cursor.startComposition(e))}endComposition(e){this._executeCursorEdit(t=>this._cursor.endComposition(t,e))}type(e,t){this._executeCursorEdit(i=>this._cursor.type(i,e,t))}compositionType(e,t,i,n,r){this._executeCursorEdit(o=>this._cursor.compositionType(o,e,t,i,n,r))}paste(e,t,i,n){this._executeCursorEdit(r=>this._cursor.paste(r,e,t,i,n))}cut(e){this._executeCursorEdit(t=>this._cursor.cut(t,e))}executeCommand(e,t){this._executeCursorEdit(i=>this._cursor.executeCommand(i,e,t))}executeCommands(e,t){this._executeCursorEdit(i=>this._cursor.executeCommands(i,e,t))}revealAllCursors(e,t,i=!1){this._withViewEventsCollector(n=>this._cursor.revealAll(n,e,i,h.VerticalRevealType.Simple,t,V.Smooth))}revealPrimaryCursor(e,t,i=!1){this._withViewEventsCollector(n=>this._cursor.revealPrimary(n,e,i,h.VerticalRevealType.Simple,t,V.Smooth))}revealTopMostCursor(e){const t=this._cursor.getTopMostViewPosition(),i=new w(t.lineNumber,t.column,t.lineNumber,t.column);this._withViewEventsCollector(n=>n.emitViewEvent(new h.ViewRevealRangeRequestEvent(e,!1,i,null,h.VerticalRevealType.Simple,!0,V.Smooth)))}revealBottomMostCursor(e){const t=this._cursor.getBottomMostViewPosition(),i=new w(t.lineNumber,t.column,t.lineNumber,t.column);this._withViewEventsCollector(n=>n.emitViewEvent(new h.ViewRevealRangeRequestEvent(e,!1,i,null,h.VerticalRevealType.Simple,!0,V.Smooth)))}revealRange(e,t,i,n,r){this._withViewEventsCollector(o=>o.emitViewEvent(new h.ViewRevealRangeRequestEvent(e,!1,i,null,n,t,r)))}changeWhitespace(e){this.viewLayout.changeWhitespace(e)&&(this._eventDispatcher.emitSingleViewEvent(new h.ViewZonesChangedEvent),this._eventDispatcher.emitOutgoingEvent(new ae))}_withViewEventsCollector(e){return this._transactionalTarget.batchChanges(()=>{try{const t=this._eventDispatcher.beginEmitViewEvents();return e(t)}finally{this._eventDispatcher.endEmitViewEvents()}})}batchEvents(e){this._withViewEventsCollector(()=>{e()})}normalizePosition(e,t){return this._lines.normalizePosition(e,t)}getLineIndentColumn(e){return this._lines.getLineIndentColumn(e)}}class D{constructor(c,e,t,i,n){this._model=c;this._viewLineNumber=e;this._isValid=t;this._modelTrackedRange=i;this._startLineDelta=n}static create(c){const e=c._setTrackedRange(null,new w(1,1,1,1),S.NeverGrowsWhenTypingAtEdges);return new D(c,1,!1,e,0)}get viewLineNumber(){return this._viewLineNumber}get isValid(){return this._isValid}get modelTrackedRange(){return this._modelTrackedRange}get startLineDelta(){return this._startLineDelta}dispose(){this._model._setTrackedRange(this._modelTrackedRange,null,S.NeverGrowsWhenTypingAtEdges)}update(c,e){const t=c.coordinatesConverter.convertViewPositionToModelPosition(new E(e,c.getLineMinColumn(e))),i=c.model._setTrackedRange(this._modelTrackedRange,new w(t.lineNumber,t.column,t.lineNumber,t.column),S.NeverGrowsWhenTypingAtEdges),n=c.viewLayout.getVerticalOffsetForLineNumber(e),r=c.viewLayout.getCurrentScrollTop();this._viewLineNumber=e,this._isValid=!0,this._modelTrackedRange=i,this._startLineDelta=r-n}invalidate(){this._isValid=!1}}class he{_asMap=Object.create(null);asArray=[];accept(c,e,t,i,n){const r=this._asMap[c];if(r){const o=r.data,l=o[o.length-3],a=o[o.length-1];if(l===n&&a+1>=t){i>a&&(o[o.length-1]=i);return}o.push(n,t,i)}else{const o=new Q(c,e,[n,t,i]);this._asMap[c]=o,this.asArray.push(o)}}}class ge{hiddenAreas=new Map;shouldRecompute=!1;ranges=[];setHiddenAreas(c,e){const t=this.hiddenAreas.get(c);t&&R(t,e)||(this.hiddenAreas.set(c,e),this.shouldRecompute=!0)}getMergedRanges(){if(!this.shouldRecompute)return this.ranges;this.shouldRecompute=!1;const c=Array.from(this.hiddenAreas.values()).reduce((e,t)=>pe(e,t),[]);return R(this.ranges,c)?this.ranges:(this.ranges=c,this.ranges)}}function pe(v,c){const e=[];let t=0,i=0;for(;t<v.length&&i<c.length;){const n=v[t],r=c[i];if(n.endLineNumber<r.startLineNumber-1)e.push(v[t++]);else if(r.endLineNumber<n.startLineNumber-1)e.push(c[i++]);else{const o=Math.min(n.startLineNumber,r.startLineNumber),l=Math.max(n.endLineNumber,r.endLineNumber);e.push(new w(o,1,l,1)),t++,i++}}for(;t<v.length;)e.push(v[t++]);for(;i<c.length;)e.push(c[i++]);return e}function R(v,c){if(v.length!==c.length)return!1;for(let e=0;e<v.length;e++)if(!v[e].equalsRange(c[e]))return!1;return!0}class N{constructor(c,e){this.viewportStartModelPosition=c;this.startLineDelta=e}recoverViewportStart(c,e){if(!this.viewportStartModelPosition)return;const t=c.convertModelPositionToViewPosition(this.viewportStartModelPosition),i=e.getVerticalOffsetForLineNumber(t.lineNumber);e.setScrollPosition({scrollTop:i+this.startLineDelta},V.Immediate)}}export{xt as ViewModel};
