var h=class{unexpectedErrorHandler;listeners;constructor(){this.listeners=[],this.unexpectedErrorHandler=function(e){setTimeout(()=>{throw e.stack?g.isErrorNoTelemetry(e)?new g(e.message+`

`+e.stack):new Error(e.message+`

`+e.stack):e},0)}}addListener(e){return this.listeners.push(e),()=>{this._removeListener(e)}}emit(e){this.listeners.forEach(t=>{t(e)})}_removeListener(e){this.listeners.splice(this.listeners.indexOf(e),1)}setUnexpectedErrorHandler(e){this.unexpectedErrorHandler=e}getUnexpectedErrorHandler(){return this.unexpectedErrorHandler}onUnexpectedError(e){this.unexpectedErrorHandler(e),this.emit(e)}onUnexpectedExternalError(e){this.unexpectedErrorHandler(e)}},v=new h;var g=class s extends Error{name;constructor(e){super(e),this.name="CodeExpectedError"}static fromError(e){if(e instanceof s)return e;let t=new s;return t.message=e.message,t.stack=e.stack,t}static isErrorNoTelemetry(e){return e.name==="CodeExpectedError"}},d=class s extends Error{constructor(e){super(e||"An unexpected bug occurred."),Object.setPrototypeOf(this,s.prototype)}};var o=class s{constructor(e,t){this.start=e;this.endExclusive=t;if(e>t)throw new d(`Invalid range: ${this.toString()}`)}static addRange(e,t){let n=0;for(;n<t.length&&t[n].endExclusive<e.start;)n++;let r=n;for(;r<t.length&&t[r].start<=e.endExclusive;)r++;if(n===r)t.splice(n,0,e);else{let i=Math.min(e.start,t[n].start),u=Math.max(e.endExclusive,t[r-1].endExclusive);t.splice(n,r-n,new s(i,u))}}static tryCreate(e,t){if(!(e>t))return new s(e,t)}static ofLength(e){return new s(0,e)}static ofStartAndLength(e,t){return new s(e,e+t)}static emptyAt(e){return new s(e,e)}get isEmpty(){return this.start===this.endExclusive}delta(e){return new s(this.start+e,this.endExclusive+e)}deltaStart(e){return new s(this.start+e,this.endExclusive)}deltaEnd(e){return new s(this.start,this.endExclusive+e)}get length(){return this.endExclusive-this.start}toString(){return`[${this.start}, ${this.endExclusive})`}equals(e){return this.start===e.start&&this.endExclusive===e.endExclusive}containsRange(e){return this.start<=e.start&&e.endExclusive<=this.endExclusive}contains(e){return this.start<=e&&e<this.endExclusive}join(e){return new s(Math.min(this.start,e.start),Math.max(this.endExclusive,e.endExclusive))}intersect(e){let t=Math.max(this.start,e.start),n=Math.min(this.endExclusive,e.endExclusive);if(t<=n)return new s(t,n)}intersectionLength(e){let t=Math.max(this.start,e.start),n=Math.min(this.endExclusive,e.endExclusive);return Math.max(0,n-t)}intersects(e){let t=Math.max(this.start,e.start),n=Math.min(this.endExclusive,e.endExclusive);return t<n}intersectsOrTouches(e){let t=Math.max(this.start,e.start),n=Math.min(this.endExclusive,e.endExclusive);return t<=n}isBefore(e){return this.endExclusive<=e.start}isAfter(e){return this.start>=e.endExclusive}slice(e){return e.slice(this.start,this.endExclusive)}substring(e){return e.substring(this.start,this.endExclusive)}clip(e){if(this.isEmpty)throw new d(`Invalid clipping range: ${this.toString()}`);return Math.max(this.start,Math.min(this.endExclusive-1,e))}clipCyclic(e){if(this.isEmpty)throw new d(`Invalid clipping range: ${this.toString()}`);return e<this.start?this.endExclusive-(this.start-e)%this.length:e>=this.endExclusive?this.start+(e-this.start)%this.length:e}map(e){let t=[];for(let n=this.start;n<this.endExclusive;n++)t.push(e(n));return t}forEach(e){for(let t=this.start;t<this.endExclusive;t++)e(t)}};var E=class s{constructor(e){this.edits=e;let t=-1;for(let n of e){if(!(n.replaceRange.start>=t))throw new d(`Edits must be disjoint and sorted. Found ${n} after ${t}`);t=n.replaceRange.endExclusive}}static empty=new s([]);static fromJson(e){return new s(e.map(c.fromJson))}static replace(e,t){return new s([new c(e,t)])}static insert(e,t){return s.replace(o.emptyAt(e),t)}normalize(){let e=[],t;for(let n of this.edits)n.newText.length===0&&n.replaceRange.length===0||(t&&t.replaceRange.endExclusive===n.replaceRange.start?t=new c(t.replaceRange.join(n.replaceRange),t.newText+n.newText):(t&&e.push(t),t=n));return t&&e.push(t),new s(e)}toString(){return`[${this.edits.map(t=>t.toString()).join(", ")}]`}apply(e){let t=[],n=0;for(let r of this.edits)t.push(e.substring(n,r.replaceRange.start)),t.push(r.newText),n=r.replaceRange.endExclusive;return t.push(e.substring(n)),t.join("")}compose(e){return w(this,e)}inverse(e){let t=[],n=0;for(let r of this.edits)t.push(new c(o.ofStartAndLength(r.replaceRange.start+n,r.newText.length),e.substring(r.replaceRange.start,r.replaceRange.endExclusive))),n+=r.newText.length-r.replaceRange.length;return new s(t)}getNewTextRanges(){let e=[],t=0;for(let n of this.edits)e.push(o.ofStartAndLength(n.replaceRange.start+t,n.newText.length)),t+=n.newText.length-n.replaceRange.length;return e}get isEmpty(){return this.edits.length===0}tryRebase(e){let t=[],n=0,r=0,i=0;for(;r<this.edits.length||n<e.edits.length;){let u=e.edits[n],l=this.edits[r];if(l)u?l.replaceRange.intersects(u.replaceRange)?r++:l.replaceRange.start<u.replaceRange.start?(t.push(new c(l.replaceRange.delta(i),l.newText)),r++):(n++,i+=u.newText.length-u.replaceRange.length):(t.push(new c(l.replaceRange.delta(i),l.newText)),r++);else break}return new s(t)}applyToOffset(e){let t=0;for(let n of this.edits)if(n.replaceRange.start<=e){if(e<n.replaceRange.endExclusive)return n.replaceRange.start+t;t+=n.newText.length-n.replaceRange.length}else break;return e+t}applyToOffsetRange(e){return new o(this.applyToOffset(e.start),this.applyToOffset(e.endExclusive))}applyInverseToOffset(e){let t=0;for(let n of this.edits){let r=n.newText.length;if(n.replaceRange.start<=e-t){if(e-t<n.replaceRange.start+r)return n.replaceRange.start;t+=r-n.replaceRange.length}else break}return e-t}},c=class s{constructor(e,t){this.replaceRange=e;this.newText=t}static fromJson(e){return new s(o.ofStartAndLength(e.pos,e.len),e.txt)}static insert(e,t){return new s(o.emptyAt(e),t)}toString(){return`${this.replaceRange} -> "${this.newText}"`}get isEmpty(){return this.newText.length===0&&this.replaceRange.length===0}};function w(s,e){if(s=s.normalize(),e=e.normalize(),s.isEmpty)return e;if(e.isEmpty)return s;let t=[...s.edits],n=[],r=0;for(let i of e.edits){for(;;){let a=t[0];if(!a||a.replaceRange.start+r+a.newText.length>=i.replaceRange.start)break;t.shift(),n.push(a),r+=a.newText.length-a.replaceRange.length}let u=r,l,f;for(;;){let a=t[0];if(!a||a.replaceRange.start+r>i.replaceRange.endExclusive)break;l||(l=a),f=a,t.shift(),r+=a.newText.length-a.replaceRange.length}if(!l)n.push(new c(i.replaceRange.delta(-r),i.newText));else{let a="",x=i.replaceRange.start-(l.replaceRange.start+u);x>0&&(a=l.newText.slice(0,x));let m=f.replaceRange.endExclusive+r-i.replaceRange.endExclusive;if(m>0){let p=new c(o.ofStartAndLength(f.replaceRange.endExclusive,0),f.newText.slice(-m));t.unshift(p),r-=p.newText.length-p.replaceRange.length}let b=a+i.newText,R=new o(Math.min(l.replaceRange.start,i.replaceRange.start-u),i.replaceRange.endExclusive-r);n.push(new c(R,b))}}for(;;){let i=t.shift();if(!i)break;n.push(i)}return new E(n).normalize()}export{E as OffsetEdit,c as SingleOffsetEdit};
