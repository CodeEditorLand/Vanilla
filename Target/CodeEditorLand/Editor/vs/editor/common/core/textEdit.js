import{assert as x,assertFn as R,checkAdjacentItems as P}from"../../../../vs/base/common/assert.js";import{BugIndicatingError as E}from"../../../../vs/base/common/errors.js";import"../../../../vs/editor/common/core/editOperation.js";import{Position as u}from"../../../../vs/editor/common/core/position.js";import{PositionOffsetTransformer as N}from"../../../../vs/editor/common/core/positionToOffset.js";import{Range as b}from"../../../../vs/editor/common/core/range.js";import{TextLength as d}from"../../../../vs/editor/common/core/textLength.js";class m{constructor(t){this.edits=t;R(()=>P(t,(e,n)=>e.range.getEndPosition().isBeforeOrEqual(n.range.getStartPosition())))}static single(t,e){return new m([new f(t,e)])}normalize(){const t=[];for(const e of this.edits)if(t.length>0&&t[t.length-1].range.getEndPosition().equals(e.range.getStartPosition())){const n=t[t.length-1];t[t.length-1]=new f(n.range.plusRange(e.range),n.text+e.text)}else e.isEmpty||t.push(e);return new m(t)}mapPosition(t){let e=0,n=0,i=0;for(const s of this.edits){const r=s.range.getStartPosition(),g=s.range.getEndPosition();if(t.isBeforeOrEqual(r))break;const o=d.ofText(s.text);if(t.isBefore(g)){const l=new u(r.lineNumber+e,r.column+(r.lineNumber+e===n?i:0)),p=o.addToPosition(l);return c(l,p)}e+=o.lineCount-(s.range.endLineNumber-s.range.startLineNumber),o.lineCount===0?g.lineNumber!==r.lineNumber?i+=o.columnCount-(g.column-1):i+=o.columnCount-(g.column-r.column):i=o.columnCount,n=g.lineNumber+e}return new u(t.lineNumber+e,t.column+(t.lineNumber+e===n?i:0))}mapRange(t){function e(r){return r instanceof u?r:r.getStartPosition()}function n(r){return r instanceof u?r:r.getEndPosition()}const i=e(this.mapPosition(t.getStartPosition())),s=n(this.mapPosition(t.getEndPosition()));return c(i,s)}inverseMapPosition(t,e){return this.inverse(e).mapPosition(t)}inverseMapRange(t,e){return this.inverse(e).mapRange(t)}apply(t){let e="",n=new u(1,1);for(const s of this.edits){const r=s.range,g=r.getStartPosition(),o=r.getEndPosition(),l=c(n,g);l.isEmpty()||(e+=t.getValueOfRange(l)),e+=s.text,n=o}const i=c(n,t.endPositionExclusive);return i.isEmpty()||(e+=t.getValueOfRange(i)),e}applyToString(t){const e=new T(t);return this.apply(e)}inverse(t){const e=this.getNewRanges();return new m(this.edits.map((n,i)=>new f(e[i],t.getValueOfRange(n.range))))}getNewRanges(){const t=[];let e=0,n=0,i=0;for(const s of this.edits){const r=d.ofText(s.text),g=u.lift({lineNumber:s.range.startLineNumber+n,column:s.range.startColumn+(s.range.startLineNumber===e?i:0)}),o=r.createRange(g);t.push(o),n=o.endLineNumber-s.range.endLineNumber,i=o.endColumn-s.range.endColumn,e=s.range.endLineNumber}return t}}class f{constructor(t,e){this.range=t;this.text=e}get isEmpty(){return this.range.isEmpty()&&this.text.length===0}static equals(t,e){return t.range.equalsRange(e.range)&&t.text===e.text}toSingleEditOperation(){return{range:this.range,text:this.text}}}function c(a,t){if(a.lineNumber===t.lineNumber&&a.column===Number.MAX_SAFE_INTEGER)return b.fromPositions(t,t);if(!a.isBeforeOrEqual(t))throw new E("start must be before end");return new b(a.lineNumber,a.column,t.lineNumber,t.column)}class h{get endPositionExclusive(){return this.length.addToPosition(new u(1,1))}getValue(){return this.getValueOfRange(this.length.toRange())}}class L extends h{constructor(e,n){x(n>=1);super();this._getLineContent=e;this._lineCount=n}getValueOfRange(e){if(e.startLineNumber===e.endLineNumber)return this._getLineContent(e.startLineNumber).substring(e.startColumn-1,e.endColumn-1);let n=this._getLineContent(e.startLineNumber).substring(e.startColumn-1);for(let i=e.startLineNumber+1;i<e.endLineNumber;i++)n+=`
`+this._getLineContent(i);return n+=`
`+this._getLineContent(e.endLineNumber).substring(0,e.endColumn-1),n}get length(){const e=this._getLineContent(this._lineCount);return new d(this._lineCount-1,e.length)}}class V extends L{constructor(t){super(e=>t[e-1],t.length)}}class T extends h{constructor(e){super();this.value=e}_t=new N(this.value);getValueOfRange(e){return this._t.getOffsetRange(e).substring(this.value)}get length(){return this._t.textLength}}export{h as AbstractText,V as ArrayText,L as LineBasedText,f as SingleTextEdit,T as StringText,m as TextEdit};
