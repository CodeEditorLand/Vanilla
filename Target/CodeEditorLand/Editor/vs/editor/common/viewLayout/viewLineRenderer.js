import*as K from"../../../nls.js";import{CharCode as m}from"../../../base/common/charCode.js";import*as H from"../../../base/common/strings.js";import"../tokens/lineTokens.js";import{StringBuilder as $}from"../core/stringBuilder.js";import{LineDecoration as X,LineDecorationsNormalizer as Q}from"./lineDecorations.js";import{InlineDecorationType as B}from"../viewModel.js";import{LinePart as b,LinePartMetadata as U}from"./linePart.js";var J=(t=>(t[t.None=0]="None",t[t.Boundary=1]="Boundary",t[t.Selection=2]="Selection",t[t.Trailing=3]="Trailing",t[t.All=4]="All",t))(J||{});class Se{startOffset;endOffset;constructor(e,r){this.startOffset=e,this.endOffset=r}equals(e){return this.startOffset===e.startOffset&&this.endOffset===e.endOffset}}class Te{useMonospaceOptimizations;canUseHalfwidthRightwardsArrow;lineContent;continuesWithWrappedLine;isBasicASCII;containsRTL;fauxIndentLength;lineTokens;lineDecorations;tabSize;startVisibleColumn;spaceWidth;renderSpaceWidth;renderSpaceCharCode;stopRenderingLineAfter;renderWhitespace;renderControlCharacters;fontLigatures;selectionsOnLine;constructor(e,r,a,i,t,o,f,l,s,g,u,C,c,p,d,I,x,L,v){this.useMonospaceOptimizations=e,this.canUseHalfwidthRightwardsArrow=r,this.lineContent=a,this.continuesWithWrappedLine=i,this.isBasicASCII=t,this.containsRTL=o,this.fauxIndentLength=f,this.lineTokens=l,this.lineDecorations=s.sort(X.compare),this.tabSize=g,this.startVisibleColumn=u,this.spaceWidth=C,this.stopRenderingLineAfter=d,this.renderWhitespace=I==="all"?4:I==="boundary"?1:I==="selection"?2:I==="trailing"?3:0,this.renderControlCharacters=x,this.fontLigatures=L,this.selectionsOnLine=v&&v.sort((y,w)=>y.startOffset<w.startOffset?-1:1);const S=Math.abs(p-C),W=Math.abs(c-C);S<W?(this.renderSpaceWidth=p,this.renderSpaceCharCode=11825):(this.renderSpaceWidth=c,this.renderSpaceCharCode=183)}sameSelection(e){if(this.selectionsOnLine===null)return e===null;if(e===null||e.length!==this.selectionsOnLine.length)return!1;for(let r=0;r<this.selectionsOnLine.length;r++)if(!this.selectionsOnLine[r].equals(e[r]))return!1;return!0}equals(e){return this.useMonospaceOptimizations===e.useMonospaceOptimizations&&this.canUseHalfwidthRightwardsArrow===e.canUseHalfwidthRightwardsArrow&&this.lineContent===e.lineContent&&this.continuesWithWrappedLine===e.continuesWithWrappedLine&&this.isBasicASCII===e.isBasicASCII&&this.containsRTL===e.containsRTL&&this.fauxIndentLength===e.fauxIndentLength&&this.tabSize===e.tabSize&&this.startVisibleColumn===e.startVisibleColumn&&this.spaceWidth===e.spaceWidth&&this.renderSpaceWidth===e.renderSpaceWidth&&this.renderSpaceCharCode===e.renderSpaceCharCode&&this.stopRenderingLineAfter===e.stopRenderingLineAfter&&this.renderWhitespace===e.renderWhitespace&&this.renderControlCharacters===e.renderControlCharacters&&this.fontLigatures===e.fontLigatures&&X.equalsArr(this.lineDecorations,e.lineDecorations)&&this.lineTokens.equals(e.lineTokens)&&this.sameSelection(e.selectionsOnLine)}}var Y=(i=>(i[i.PART_INDEX_MASK=4294901760]="PART_INDEX_MASK",i[i.CHAR_INDEX_MASK=65535]="CHAR_INDEX_MASK",i[i.CHAR_INDEX_OFFSET=0]="CHAR_INDEX_OFFSET",i[i.PART_INDEX_OFFSET=16]="PART_INDEX_OFFSET",i))(Y||{});class Z{constructor(e,r){this.partIndex=e;this.charIndex=r}}class D{static getPartIndex(e){return(e&4294901760)>>>16}static getCharIndex(e){return(e&65535)>>>0}length;_data;_horizontalOffset;constructor(e,r){this.length=e,this._data=new Uint32Array(this.length),this._horizontalOffset=new Uint32Array(this.length)}setColumnInfo(e,r,a,i){const t=(r<<16|a<<0)>>>0;this._data[e-1]=t,this._horizontalOffset[e-1]=i}getHorizontalOffset(e){return this._horizontalOffset.length===0?0:this._horizontalOffset[e-1]}charOffsetToPartData(e){return this.length===0?0:e<0?this._data[0]:e>=this.length?this._data[this.length-1]:this._data[e]}getDomPosition(e){const r=this.charOffsetToPartData(e-1),a=D.getPartIndex(r),i=D.getCharIndex(r);return new Z(a,i)}getColumn(e,r){return this.partDataToCharOffset(e.partIndex,r,e.charIndex)+1}partDataToCharOffset(e,r,a){if(this.length===0)return 0;const i=(e<<16|a<<0)>>>0;let t=0,o=this.length-1;for(;t+1<o;){const d=t+o>>>1,I=this._data[d];if(I===i)return d;I>i?o=d:t=d}if(t===o)return t;const f=this._data[t],l=this._data[o];if(f===i)return t;if(l===i)return o;const s=D.getPartIndex(f),g=D.getCharIndex(f),u=D.getPartIndex(l);let C;s!==u?C=r:C=D.getCharIndex(l);const c=a-g,p=C-a;return c<=p?t:o}inflate(){const e=[];for(let r=0;r<this.length;r++){const a=this._data[r],i=D.getPartIndex(a),t=D.getCharIndex(a),o=this._horizontalOffset[r];e.push([i,t,o])}return e}}var ee=(a=>(a[a.None=0]="None",a[a.Before=1]="Before",a[a.After=2]="After",a))(ee||{});class q{_renderLineOutputBrand=void 0;characterMapping;containsRTL;containsForeignElements;constructor(e,r,a){this.characterMapping=e,this.containsRTL=r,this.containsForeignElements=a}}function ne(n,e){if(n.lineContent.length===0){if(n.lineDecorations.length>0){e.appendString("<span>");let r=0,a=0,i=0;for(const o of n.lineDecorations)(o.type===B.Before||o.type===B.After)&&(e.appendString('<span class="'),e.appendString(o.className),e.appendString('"></span>'),o.type===B.Before&&(i|=1,r++),o.type===B.After&&(i|=2,a++));e.appendString("</span>");const t=new D(1,r+a);return t.setColumnInfo(1,r,0,0),new q(t,!1,i)}return e.appendString("<span><span></span></span>"),new q(new D(0,0),!1,0)}return fe(ae(n),e)}class te{constructor(e,r,a,i){this.characterMapping=e;this.html=r;this.containsRTL=a;this.containsForeignElements=i}}function xe(n){const e=new $(1e4),r=ne(n,e);return new te(r.characterMapping,e.build(),r.containsRTL,r.containsForeignElements)}class re{constructor(e,r,a,i,t,o,f,l,s,g,u,C,c,p,d,I){this.fontIsMonospace=e;this.canUseHalfwidthRightwardsArrow=r;this.lineContent=a;this.len=i;this.isOverflowing=t;this.overflowingCharCount=o;this.parts=f;this.containsForeignElements=l;this.fauxIndentLength=s;this.tabSize=g;this.startVisibleColumn=u;this.containsRTL=C;this.spaceWidth=c;this.renderSpaceCharCode=p;this.renderWhitespace=d;this.renderControlCharacters=I}}function ae(n){const e=n.lineContent;let r,a,i;n.stopRenderingLineAfter!==-1&&n.stopRenderingLineAfter<e.length?(r=!0,a=e.length-n.stopRenderingLineAfter,i=n.stopRenderingLineAfter):(r=!1,a=0,i=e.length);let t=ie(e,n.containsRTL,n.lineTokens,n.fauxIndentLength,i);n.renderControlCharacters&&!n.isBasicASCII&&(t=le(e,t)),(n.renderWhitespace===4||n.renderWhitespace===1||n.renderWhitespace===2&&n.selectionsOnLine||n.renderWhitespace===3&&!n.continuesWithWrappedLine)&&(t=ce(n,e,i,t));let o=0;if(n.lineDecorations.length>0){for(let f=0,l=n.lineDecorations.length;f<l;f++){const s=n.lineDecorations[f];s.type===B.RegularAffectingLetterSpacing||s.type===B.Before?o|=1:s.type===B.After&&(o|=2)}t=de(e,i,t,n.lineDecorations)}return n.containsRTL||(t=se(e,t,!n.isBasicASCII||n.fontLigatures)),new re(n.useMonospaceOptimizations,n.canUseHalfwidthRightwardsArrow,e,i,r,a,t,o,n.fauxIndentLength,n.tabSize,n.startVisibleColumn,n.containsRTL,n.spaceWidth,n.renderSpaceCharCode,n.renderWhitespace,n.renderControlCharacters)}function ie(n,e,r,a,i){const t=[];let o=0;a>0&&(t[o++]=new b(a,"",0,!1));let f=a;for(let l=0,s=r.getCount();l<s;l++){const g=r.getEndOffset(l);if(g<=a)continue;const u=r.getClassName(l);if(g>=i){const c=e?H.containsRTL(n.substring(f,i)):!1;t[o++]=new b(i,u,0,c);break}const C=e?H.containsRTL(n.substring(f,g)):!1;t[o++]=new b(g,u,0,C),f=g}return t}var oe=(e=>(e[e.LongToken=50]="LongToken",e))(oe||{});function se(n,e,r){let a=0;const i=[];let t=0;if(r)for(let o=0,f=e.length;o<f;o++){const l=e[o],s=l.endIndex;if(a+50<s){const g=l.type,u=l.metadata,C=l.containsRTL;let c=-1,p=a;for(let d=a;d<s;d++)n.charCodeAt(d)===m.Space&&(c=d),c!==-1&&d-p>=50&&(i[t++]=new b(c+1,g,u,C),p=c+1,c=-1);p!==s&&(i[t++]=new b(s,g,u,C))}else i[t++]=l;a=s}else for(let o=0,f=e.length;o<f;o++){const l=e[o],s=l.endIndex,g=s-a;if(g>50){const u=l.type,C=l.metadata,c=l.containsRTL,p=Math.ceil(g/50);for(let d=1;d<p;d++){const I=a+d*50;i[t++]=new b(I,u,C,c)}i[t++]=new b(s,u,C,c)}else i[t++]=l;a=s}return i}function G(n){return n<32?n!==m.Tab:n===127||n>=8234&&n<=8238||n>=8294&&n<=8297||n>=8206&&n<=8207||n===1564}function le(n,e){const r=[];let a=new b(0,"",0,!1),i=0;for(const t of e){const o=t.endIndex;for(;i<o;i++){const f=n.charCodeAt(i);G(f)&&(i>a.endIndex&&(a=new b(i,t.type,t.metadata,t.containsRTL),r.push(a)),a=new b(i+1,"mtkcontrol",t.metadata,!1),r.push(a))}i>a.endIndex&&(a=new b(o,t.type,t.metadata,t.containsRTL),r.push(a))}return r}function ce(n,e,r,a){const i=n.continuesWithWrappedLine,t=n.fauxIndentLength,o=n.tabSize,f=n.startVisibleColumn,l=n.useMonospaceOptimizations,s=n.selectionsOnLine,g=n.renderWhitespace===1,u=n.renderWhitespace===3,C=n.renderSpaceWidth!==n.spaceWidth,c=[];let p=0,d=0,I=a[d].type,x=a[d].containsRTL,L=a[d].endIndex;const v=a.length;let S=!1,W=H.firstNonWhitespaceIndex(e),y;W===-1?(S=!0,W=r,y=r):y=H.lastNonWhitespaceIndex(e);let w=!1,P=0,A=s&&s[P],_=f%o;for(let h=t;h<r;h++){const R=e.charCodeAt(h);A&&h>=A.endOffset&&(P++,A=s&&s[P]);let T;if(h<W||h>y)T=!0;else if(R===m.Tab)T=!0;else if(R===m.Space)if(g)if(w)T=!0;else{const z=h+1<r?e.charCodeAt(h+1):m.Null;T=z===m.Space||z===m.Tab}else T=!0;else T=!1;if(T&&s&&(T=!!A&&A.startOffset<=h&&A.endOffset>h),T&&u&&(T=S||h>y),T&&x&&h>=W&&h<=y&&(T=!1),w){if(!T||!l&&_>=o){if(C){const z=p>0?c[p-1].endIndex:t;for(let M=z+1;M<=h;M++)c[p++]=new b(M,"mtkw",U.IS_WHITESPACE,!1)}else c[p++]=new b(h,"mtkw",U.IS_WHITESPACE,!1);_=_%o}}else(h===L||T&&h>t)&&(c[p++]=new b(h,I,0,x),_=_%o);for(R===m.Tab?_=o:H.isFullWidthCharacter(R)?_+=2:_++,w=T;h===L&&(d++,d<v);)I=a[d].type,x=a[d].containsRTL,L=a[d].endIndex}let F=!1;if(w)if(i&&g){const h=r>0?e.charCodeAt(r-1):m.Null,R=r>1?e.charCodeAt(r-2):m.Null;h===m.Space&&R!==m.Space&&R!==m.Tab||(F=!0)}else F=!0;if(F)if(C){const h=p>0?c[p-1].endIndex:t;for(let R=h+1;R<=r;R++)c[p++]=new b(R,"mtkw",U.IS_WHITESPACE,!1)}else c[p++]=new b(r,"mtkw",U.IS_WHITESPACE,!1);else c[p++]=new b(r,I,0,x);return c}function de(n,e,r,a){a.sort(X.compare);const i=Q.normalize(n,a),t=i.length;let o=0;const f=[];let l=0,s=0;for(let u=0,C=r.length;u<C;u++){const c=r[u],p=c.endIndex,d=c.type,I=c.metadata,x=c.containsRTL;for(;o<t&&i[o].startOffset<p;){const L=i[o];if(L.startOffset>s&&(s=L.startOffset,f[l++]=new b(s,d,I,x)),L.endOffset+1<=p)s=L.endOffset+1,f[l++]=new b(s,d+" "+L.className,I|L.metadata,x),o++;else{s=p,f[l++]=new b(s,d+" "+L.className,I|L.metadata,x);break}}p>s&&(s=p,f[l++]=new b(s,d,I,x))}const g=r[r.length-1].endIndex;if(o<t&&i[o].startOffset===g)for(;o<t&&i[o].startOffset===g;){const u=i[o];f[l++]=new b(s,u.className,u.metadata,!1),o++}return f}function fe(n,e){const r=n.fontIsMonospace,a=n.canUseHalfwidthRightwardsArrow,i=n.containsForeignElements,t=n.lineContent,o=n.len,f=n.isOverflowing,l=n.overflowingCharCount,s=n.parts,g=n.fauxIndentLength,u=n.tabSize,C=n.startVisibleColumn,c=n.containsRTL,p=n.spaceWidth,d=n.renderSpaceCharCode,I=n.renderWhitespace,x=n.renderControlCharacters,L=new D(o+1,s.length);let v=!1,S=0,W=C,y=0,w=0,P=0;c?e.appendString('<span dir="ltr">'):e.appendString("<span>");for(let A=0,_=s.length;A<_;A++){const F=s[A],h=F.endIndex,R=F.type,T=F.containsRTL,z=I!==0&&F.isWhitespace(),M=z&&!r&&(R==="mtkw"||!i),j=S===h&&F.isPseudoAfter();if(y=0,e.appendString("<span "),T&&e.appendString('style="unicode-bidi:isolate" '),e.appendString('class="'),e.appendString(M?"mtkz":R),e.appendASCIICharCode(m.DoubleQuote),z){let k=0;{let O=S,E=W;for(;O<h;O++){const V=(t.charCodeAt(O)===m.Tab?u-E%u:1)|0;k+=V,O>=g&&(E+=V)}}for(M&&(e.appendString(' style="width:'),e.appendString(String(p*k)),e.appendString('px"')),e.appendASCIICharCode(m.GreaterThan);S<h;S++){L.setColumnInfo(S+1,A-P,y,w),P=0;const O=t.charCodeAt(S);let E,N;if(O===m.Tab){E=u-W%u|0,N=E,!a||N>1?e.appendCharCode(8594):e.appendCharCode(65515);for(let V=2;V<=N;V++)e.appendCharCode(160)}else E=2,N=1,e.appendCharCode(d),e.appendCharCode(8204);y+=E,w+=N,S>=g&&(W+=N)}}else for(e.appendASCIICharCode(m.GreaterThan);S<h;S++){L.setColumnInfo(S+1,A-P,y,w),P=0;const k=t.charCodeAt(S);let O=1,E=1;switch(k){case m.Tab:O=u-W%u,E=O;for(let N=1;N<=O;N++)e.appendCharCode(160);break;case m.Space:e.appendCharCode(160);break;case m.LessThan:e.appendString("&lt;");break;case m.GreaterThan:e.appendString("&gt;");break;case m.Ampersand:e.appendString("&amp;");break;case m.Null:x?e.appendCharCode(9216):e.appendString("&#00;");break;case m.UTF8_BOM:case m.LINE_SEPARATOR:case m.PARAGRAPH_SEPARATOR:case m.NEXT_LINE:e.appendCharCode(65533);break;default:H.isFullWidthCharacter(k)&&E++,x&&k<32?e.appendCharCode(9216+k):x&&k===127?e.appendCharCode(9249):x&&G(k)?(e.appendString("[U+"),e.appendString(pe(k)),e.appendString("]"),O=8,E=O):e.appendCharCode(k)}y+=O,w+=E,S>=g&&(W+=E)}j?P++:P=0,S>=o&&!v&&F.isPseudoAfter()&&(v=!0,L.setColumnInfo(S+1,A,y,w)),e.appendString("</span>")}return v||L.setColumnInfo(o+1,s.length-1,y,w),f&&(e.appendString('<span class="mtkoverflow">'),e.appendString(K.localize("showMore","Show more ({0})",ue(l))),e.appendString("</span>")),e.appendString("</span>"),new q(L,c,i)}function pe(n){return n.toString(16).toUpperCase().padStart(4,"0")}function ue(n){return n<1024?K.localize("overflow.chars","{0} chars",n):n<1024*1024?`${(n/1024).toFixed(1)} KB`:`${(n/1024/1024).toFixed(1)} MB`}export{D as CharacterMapping,Z as DomPosition,ee as ForeignElementType,Se as LineRange,Te as RenderLineInput,q as RenderLineOutput,te as RenderLineOutput2,J as RenderWhitespace,ne as renderViewLine,xe as renderViewLine2};
