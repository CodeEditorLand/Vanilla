var f=Object.defineProperty;var _=Object.getOwnPropertyDescriptor;var g=(o,e,t,n)=>{for(var r=n>1?void 0:n?_(e,t):e,a=o.length-1,i;a>=0;a--)(i=o[a])&&(r=(n?i(e,t,r):i(r))||r);return n&&r&&f(e,t,r),r},l=(o,e)=>(t,n)=>e(t,n,o);import{doHash as p}from"../../../base/common/hash.js";import{LRUCache as b}from"../../../base/common/map.js";import{clamp as m,MovingAverage as v,SlidingWindowAverage as h}from"../../../base/common/numbers.js";import{IEnvironmentService as I}from"../../../platform/environment/common/environment.js";import{InstantiationType as y,registerSingleton as x}from"../../../platform/instantiation/common/extensions.js";import{createDecorator as D}from"../../../platform/instantiation/common/instantiation.js";import{ILogService as S}from"../../../platform/log/common/log.js";import{matchesScheme as F}from"../../../base/common/network.js";const w=D("ILanguageFeatureDebounceService");var c;(n=>{const o=new WeakMap;let e=0;function t(r){let a=o.get(r);return a===void 0&&(a=++e,o.set(r,a)),a}n.of=t})(c||={});class M{constructor(e){this._default=e}get(e){return this._default}update(e,t){return this._default}default(){return this._default}}class L{constructor(e,t,n,r,a,i){this._logService=e;this._name=t;this._registry=n;this._default=r;this._min=a;this._max=i}_cache=new b(50,.7);_key(e){return e.id+this._registry.all(e).reduce((t,n)=>p(c.of(n),t),0)}get(e){const t=this._key(e),n=this._cache.get(t);return n?m(n.value,this._min,this._max):this.default()}update(e,t){const n=this._key(e);let r=this._cache.get(n);r||(r=new h(6),this._cache.set(n,r));const a=m(r.update(t),this._min,this._max);return F(e.uri,"output")||this._logService.trace(`[DEBOUNCE: ${this._name}] for ${e.uri.toString()} is ${a}ms`),a}_overall(){const e=new v;for(const[,t]of this._cache)e.update(t.value);return e.value}default(){const e=this._overall()|0||this._default;return m(e,this._min,this._max)}}let s=class{constructor(e,t){this._logService=e;this._isDev=t.isExtensionDevelopment||!t.isBuilt}_data=new Map;_isDev;for(e,t,n){const r=n?.min??50,a=n?.max??r**2,i=n?.key??void 0,d=`${c.of(e)},${r}${i?","+i:""}`;let u=this._data.get(d);return u||(this._isDev?(this._logService.debug(`[DEBOUNCE: ${t}] is disabled in developed mode`),u=new M(r*1.5)):u=new L(this._logService,t,e,this._overallAverage()|0||r*1.5,r,a),this._data.set(d,u)),u}_overallAverage(){const e=new v;for(const t of this._data.values())e.update(t.default());return e.value}};s=g([l(0,S),l(1,I)],s),x(w,s,y.Delayed);export{w as ILanguageFeatureDebounceService,s as LanguageFeatureDebounceService};
