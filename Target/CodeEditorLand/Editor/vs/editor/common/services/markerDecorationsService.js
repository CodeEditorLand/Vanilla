var k=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var D=(c,a,e,t)=>{for(var r=t>1?void 0:t?v(a,e):a,o=c.length-1,i;o>=0;o--)(i=c[o])&&(r=(t?i(a,e,r):i(r))||r);return t&&r&&k(a,e,r),r},h=(c,a)=>(e,t)=>a(e,t,c);import{diffSets as I}from"../../../../vs/base/common/collections.js";import{Emitter as C}from"../../../../vs/base/common/event.js";import{Disposable as _,toDisposable as R}from"../../../../vs/base/common/lifecycle.js";import{BidirectionalMap as E,ResourceMap as b}from"../../../../vs/base/common/map.js";import{Schemas as g}from"../../../../vs/base/common/network.js";import"../../../../vs/base/common/themables.js";import"../../../../vs/base/common/uri.js";import{overviewRulerError as y,overviewRulerInfo as T,overviewRulerWarning as x}from"../../../../vs/editor/common/core/editorColorRegistry.js";import{Range as f}from"../../../../vs/editor/common/core/range.js";import{MinimapPosition as M,OverviewRulerLane as L,TrackedRangeStickiness as N}from"../../../../vs/editor/common/model.js";import{ClassName as d}from"../../../../vs/editor/common/model/intervalTree.js";import"../../../../vs/editor/common/services/markerDecorations.js";import{IModelService as S}from"../../../../vs/editor/common/services/model.js";import{IMarkerService as w,MarkerSeverity as p,MarkerTag as l}from"../../../../vs/platform/markers/common/markers.js";import{minimapError as O,minimapInfo as U,minimapWarning as A}from"../../../../vs/platform/theme/common/colorRegistry.js";import{themeColorFromId as m}from"../../../../vs/platform/theme/common/themeService.js";let u=class extends _{constructor(e,t){super();this._markerService=t;e.getModels().forEach(r=>this._onModelAdded(r)),this._register(e.onModelAdded(this._onModelAdded,this)),this._register(e.onModelRemoved(this._onModelRemoved,this)),this._register(this._markerService.onMarkerChanged(this._handleMarkerChange,this))}_onDidChangeMarker=this._register(new C);onDidChangeMarker=this._onDidChangeMarker.event;_markerDecorations=new b;dispose(){super.dispose(),this._markerDecorations.forEach(e=>e.dispose()),this._markerDecorations.clear()}getMarker(e,t){const r=this._markerDecorations.get(e);return r&&r.getMarker(t)||null}getLiveMarkers(e){const t=this._markerDecorations.get(e);return t?t.getMarkers():[]}_handleMarkerChange(e){e.forEach(t=>{const r=this._markerDecorations.get(t);r&&this._updateDecorations(r)})}_onModelAdded(e){const t=new W(e);this._markerDecorations.set(e.uri,t),this._updateDecorations(t)}_onModelRemoved(e){const t=this._markerDecorations.get(e.uri);t&&(t.dispose(),this._markerDecorations.delete(e.uri)),(e.uri.scheme===g.inMemory||e.uri.scheme===g.internal||e.uri.scheme===g.vscode)&&this._markerService?.read({resource:e.uri}).map(r=>r.owner).forEach(r=>this._markerService.remove(r,[e.uri]))}_updateDecorations(e){const t=this._markerService.read({resource:e.model.uri,take:500});e.update(t)&&this._onDidChangeMarker.fire(e.model)}};u=D([h(0,S),h(1,w)],u);class W extends _{constructor(e){super();this.model=e;this._register(R(()=>{this.model.deltaDecorations([...this._map.values()],[]),this._map.clear()}))}_map=new E;update(e){const{added:t,removed:r}=I(new Set(this._map.keys()),new Set(e));if(t.length===0&&r.length===0)return!1;const o=r.map(n=>this._map.get(n)),i=t.map(n=>({range:this._createDecorationRange(this.model,n),options:this._createDecorationOption(n)})),s=this.model.deltaDecorations(o,i);for(const n of r)this._map.delete(n);for(let n=0;n<s.length;n++)this._map.set(t[n],s[n]);return!0}getMarker(e){return this._map.getKey(e.id)}getMarkers(){const e=[];return this._map.forEach((t,r)=>{const o=this.model.getDecorationRange(t);o&&e.push([o,r])}),e}_createDecorationRange(e,t){let r=f.lift(t);if(t.severity===p.Hint&&!this._hasMarkerTag(t,l.Unnecessary)&&!this._hasMarkerTag(t,l.Deprecated)&&(r=r.setEndPosition(r.startLineNumber,r.startColumn+2)),r=e.validateRange(r),r.isEmpty()){const o=e.getLineLastNonWhitespaceColumn(r.startLineNumber)||e.getLineMaxColumn(r.startLineNumber);if(o===1||r.endColumn>=o)return r;const i=e.getWordAtPosition(r.getStartPosition());i&&(r=new f(r.startLineNumber,i.startColumn,r.endLineNumber,i.endColumn))}else if(t.endColumn===Number.MAX_VALUE&&t.startColumn===1&&r.startLineNumber===r.endLineNumber){const o=e.getLineFirstNonWhitespaceColumn(t.startLineNumber);o<r.endColumn&&(r=new f(r.startLineNumber,o,r.endLineNumber,r.endColumn),t.startColumn=o)}return r}_createDecorationOption(e){let t,r,o,i,s;switch(e.severity){case p.Hint:this._hasMarkerTag(e,l.Deprecated)?t=void 0:this._hasMarkerTag(e,l.Unnecessary)?t=d.EditorUnnecessaryDecoration:t=d.EditorHintDecoration,o=0;break;case p.Info:t=d.EditorInfoDecoration,r=m(T),o=10,s={color:m(U),position:M.Inline};break;case p.Warning:t=d.EditorWarningDecoration,r=m(x),o=20,s={color:m(A),position:M.Inline};break;case p.Error:default:t=d.EditorErrorDecoration,r=m(y),o=30,s={color:m(O),position:M.Inline};break}return e.tags&&(e.tags.indexOf(l.Unnecessary)!==-1&&(i=d.EditorUnnecessaryInlineDecoration),e.tags.indexOf(l.Deprecated)!==-1&&(i=d.EditorDeprecatedInlineDecoration)),{description:"marker-decoration",stickiness:N.NeverGrowsWhenTypingAtEdges,className:t,showIfCollapsed:!0,overviewRuler:{color:r,position:L.Right},minimap:s,zIndex:o,inlineClassName:i}}_hasMarkerTag(e,t){return e.tags?e.tags.indexOf(t)>=0:!1}}export{u as MarkerDecorationsService};
