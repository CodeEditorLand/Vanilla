import{stringDiff as w}from"../../../base/common/diff/diff.js";import{BugIndicatingError as D}from"../../../base/common/errors.js";import"../../../base/common/lifecycle.js";import{FileAccess as _}from"../../../base/common/network.js";import{createProxyObject as P,getAllMethodNames as v}from"../../../base/common/objects.js";import{StopWatch as E}from"../../../base/common/stopwatch.js";import"../../../base/common/uri.js";import"../../../base/common/worker/simpleWorker.js";import{Position as T}from"../core/position.js";import{Range as f}from"../core/range.js";import"../diff/documentDiffProvider.js";import{DiffComputer as k}from"../diff/legacyLinesDiffComputer.js";import"../diff/linesDiffComputer.js";import{linesDiffComputers as N}from"../diff/linesDiffComputers.js";import"../diff/rangeMapping.js";import"../languages.js";import{computeDefaultDocumentColors as H}from"../languages/defaultDocumentColorsComputer.js";import{computeLinks as $}from"../languages/linkComputer.js";import{BasicInplaceReplace as A}from"../languages/supports/inplaceReplaceSupport.js";import"../model.js";import"../model/mirrorTextModel.js";import{createMonacoBaseAPI as W}from"./editorBaseApi.js";import"./editorWorker.js";import{EditorWorkerHost as O}from"./editorWorkerHost.js";import{findSectionHeaders as q}from"./findSectionHeaders.js";import{WorkerTextModelSyncServer as F}from"./textModelSync/textModelSync.impl.js";import"./textModelSync/textModelSync.protocol.js";import{UnicodeTextModelHighlighter as U}from"./unicodeTextModelHighlighter.js";const V=!0;class B{_requestHandlerBrand;_workerTextModelSyncServer=new F;constructor(){}dispose(){}_getModel(t){return this._workerTextModelSyncServer.getModel(t)}_getModels(){return this._workerTextModelSyncServer.getModels()}$acceptNewModel(t){this._workerTextModelSyncServer.$acceptNewModel(t)}$acceptModelChanged(t,e){this._workerTextModelSyncServer.$acceptModelChanged(t,e)}$acceptRemovedModel(t){this._workerTextModelSyncServer.$acceptRemovedModel(t)}async $computeUnicodeHighlights(t,e,l){const r=this._getModel(t);return r?U.computeUnicodeHighlights(r,e,l):{ranges:[],hasMore:!1,ambiguousCharacterCount:0,invisibleCharacterCount:0,nonBasicAsciiCharacterCount:0}}async $findSectionHeaders(t,e){const l=this._getModel(t);return l?q(l,e):[]}async $computeDiff(t,e,l,r){const s=this._getModel(t),c=this._getModel(e);return!s||!c?null:L.computeDiff(s,c,l,r)}static computeDiff(t,e,l,r){const s=r==="advanced"?N.getDefault():N.getLegacy(),c=t.getLinesContent(),a=e.getLinesContent(),o=s.computeDiff(c,a,l),n=o.changes.length>0?!1:this._modelsAreIdentical(t,e);function i(u){return u.map(m=>[m.original.startLineNumber,m.original.endLineNumberExclusive,m.modified.startLineNumber,m.modified.endLineNumberExclusive,m.innerChanges?.map(g=>[g.originalRange.startLineNumber,g.originalRange.startColumn,g.originalRange.endLineNumber,g.originalRange.endColumn,g.modifiedRange.startLineNumber,g.modifiedRange.startColumn,g.modifiedRange.endLineNumber,g.modifiedRange.endColumn])])}return{identical:n,quitEarly:o.hitTimeout,changes:i(o.changes),moves:o.moves.map(u=>[u.lineRangeMapping.original.startLineNumber,u.lineRangeMapping.original.endLineNumberExclusive,u.lineRangeMapping.modified.startLineNumber,u.lineRangeMapping.modified.endLineNumberExclusive,i(u.changes)])}}static _modelsAreIdentical(t,e){const l=t.getLineCount(),r=e.getLineCount();if(l!==r)return!1;for(let s=1;s<=l;s++){const c=t.getLineContent(s),a=e.getLineContent(s);if(c!==a)return!1}return!0}async $computeDirtyDiff(t,e,l){const r=this._getModel(t),s=this._getModel(e);if(!r||!s)return null;const c=r.getLinesContent(),a=s.getLinesContent();return new k(c,a,{shouldComputeCharChanges:!1,shouldPostProcessCharChanges:!1,shouldIgnoreTrimWhitespace:l,shouldMakePrettyDiff:!0,maxComputationTime:1e3}).computeDiff().changes}static _diffLimit=1e5;async $computeMoreMinimalEdits(t,e,l){const r=this._getModel(t);if(!r)return e;const s=[];let c;e=e.slice(0).sort((o,n)=>{if(o.range&&n.range)return f.compareRangesUsingStarts(o.range,n.range);const i=o.range?0:1,u=n.range?0:1;return i-u});let a=0;for(let o=1;o<e.length;o++)f.getEndPosition(e[a].range).equals(f.getStartPosition(e[o].range))?(e[a].range=f.fromPositions(f.getStartPosition(e[a].range),f.getEndPosition(e[o].range)),e[a].text+=e[o].text):(a++,e[a]=e[o]);e.length=a+1;for(let{range:o,text:n,eol:i}of e){if(typeof i=="number"&&(c=i),f.isEmpty(o)&&!n)continue;const u=r.getValueInRange(o);if(n=n.replace(/\r\n|\n|\r/g,r.eol),u===n)continue;if(Math.max(n.length,u.length)>L._diffLimit){s.push({range:o,text:n});continue}const m=w(u,n,l),g=r.offsetAt(f.lift(o).getStartPosition());for(const p of m){const R=r.positionAt(g+p.originalStart),I=r.positionAt(g+p.originalStart+p.originalLength),h={text:n.substr(p.modifiedStart,p.modifiedLength),range:{startLineNumber:R.lineNumber,startColumn:R.column,endLineNumber:I.lineNumber,endColumn:I.column}};r.getValueInRange(h.range)!==h.text&&s.push(h)}}return typeof c=="number"&&s.push({eol:c,text:"",range:{startLineNumber:0,startColumn:0,endLineNumber:0,endColumn:0}}),s}$computeHumanReadableDiff(t,e,l){const r=this._getModel(t);if(!r)return e;const s=[];let c;e=e.slice(0).sort((n,i)=>{if(n.range&&i.range)return f.compareRangesUsingStarts(n.range,i.range);const u=n.range?0:1,m=i.range?0:1;return u-m});for(let{range:n,text:i,eol:u}of e){let h=function(M,d){return new T(M.lineNumber+d.lineNumber-1,d.lineNumber===1?M.column+d.column-1:d.column)},S=function(M,d){const b=[];for(let C=d.startLineNumber;C<=d.endLineNumber;C++){const x=M[C-1];C===d.startLineNumber&&C===d.endLineNumber?b.push(x.substring(d.startColumn-1,d.endColumn-1)):C===d.startLineNumber?b.push(x.substring(d.startColumn-1)):C===d.endLineNumber?b.push(x.substring(0,d.endColumn-1)):b.push(x)}return b};var a=h,o=S;if(typeof u=="number"&&(c=u),f.isEmpty(n)&&!i)continue;const m=r.getValueInRange(n);if(i=i.replace(/\r\n|\n|\r/g,r.eol),m===i)continue;if(Math.max(i.length,m.length)>L._diffLimit){s.push({range:n,text:i});continue}const g=m.split(/\r\n|\n|\r/),p=i.split(/\r\n|\n|\r/),R=N.getDefault().computeDiff(g,p,l),I=f.lift(n).getStartPosition();for(const M of R.changes)if(M.innerChanges)for(const d of M.innerChanges)s.push({range:f.fromPositions(h(I,d.originalRange.getStartPosition()),h(I,d.originalRange.getEndPosition())),text:S(p,d.modifiedRange).join(r.eol)});else throw new D("The experimental diff algorithm always produces inner changes")}return typeof c=="number"&&s.push({eol:c,text:"",range:{startLineNumber:0,startColumn:0,endLineNumber:0,endColumn:0}}),s}async $computeLinks(t){const e=this._getModel(t);return e?$(e):null}async $computeDefaultDocumentColors(t){const e=this._getModel(t);return e?H(e):null}static _suggestionsLimit=1e4;async $textualSuggest(t,e,l,r){const s=new E,c=new RegExp(l,r),a=new Set;e:for(const o of t){const n=this._getModel(o);if(n){for(const i of n.words(c))if(!(i===e||!isNaN(Number(i)))&&(a.add(i),a.size>L._suggestionsLimit))break e}}return{words:Array.from(a),duration:s.elapsed()}}async $computeWordRanges(t,e,l,r){const s=this._getModel(t);if(!s)return Object.create(null);const c=new RegExp(l,r),a=Object.create(null);for(let o=e.startLineNumber;o<e.endLineNumber;o++){const n=s.getLineWords(o,c);for(const i of n){if(!isNaN(Number(i.word)))continue;let u=a[i.word];u||(u=[],a[i.word]=u),u.push({startLineNumber:o,startColumn:i.startColumn,endLineNumber:o,endColumn:i.endColumn})}}return a}async $navigateValueSet(t,e,l,r,s){const c=this._getModel(t);if(!c)return null;const a=new RegExp(r,s);e.startColumn===e.endColumn&&(e={startLineNumber:e.startLineNumber,startColumn:e.startColumn,endLineNumber:e.endLineNumber,endColumn:e.endColumn+1});const o=c.getValueInRange(e),n=c.getWordAtPosition({lineNumber:e.startLineNumber,column:e.startColumn},a);if(!n)return null;const i=c.getValueInRange(n);return A.INSTANCE.navigateValueSet(e,o,n,i,l)}}class L extends B{constructor(e,l){super();this._host=e;this._foreignModuleFactory=l}_foreignModule=null;async $ping(){return"pong"}$loadForeignModule(e,l,r){const a={host:P(r,(o,n)=>this._host.$fhr(o,n)),getMirrorModels:()=>this._getModels()};return this._foreignModuleFactory?(this._foreignModule=this._foreignModuleFactory(a,l),Promise.resolve(v(this._foreignModule))):new Promise((o,n)=>{const i=u=>{this._foreignModule=u.create(a,l),o(v(this._foreignModule))};V?import(`${_.asBrowserUri(`${e}.js`).toString(!0)}`).then(i).catch(n):require([`${e}`],i,n)})}$fmr(e,l){if(!this._foreignModule||typeof this._foreignModule[e]!="function")return Promise.reject(new Error("Missing requestHandler or method: "+e));try{return Promise.resolve(this._foreignModule[e].apply(this._foreignModule,l))}catch(r){return Promise.reject(r)}}}function Je(y){return new L(O.getChannel(y),null)}typeof importScripts=="function"&&(globalThis.monaco=W());export{B as BaseEditorSimpleWorker,L as EditorSimpleWorker,Je as create};
