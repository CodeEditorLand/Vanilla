import{createTrustedTypesPolicy as S}from"../../../base/browser/trustedTypes.js";import*as L from"../../../base/common/strings.js";import{ColorId as h,FontStyle as k,MetadataConsts as I}from"../../common/encodedTokenAttributes.js";import{TokenizationRegistry as b}from"../../common/languages.js";import{LineTokens as d}from"../../common/tokens/lineTokens.js";import{RenderLineInput as T,renderViewLine2 as p}from"../../common/viewLayout/viewLineRenderer.js";import{ViewLineRenderingData as m}from"../../common/viewModel.js";import{MonarchTokenizer as y}from"../common/monarch/monarchLexer.js";const R=S("standaloneColorizer",{createHTML:c=>c});class _{static colorizeElement(i,t,n,o){o=o||{};const s=o.theme||"vs",e=o.mimeType||n.getAttribute("lang")||n.getAttribute("data-lang");if(!e)return Promise.resolve();const a=t.getLanguageIdByMimeType(e)||e;i.setTheme(s);const r=n.firstChild?n.firstChild.nodeValue:"";n.className+=" "+s;const u=l=>{const g=R?.createHTML(l)??l;n.innerHTML=g};return this.colorize(t,r||"",a,o).then(u,l=>{})}static async colorize(i,t,n,o){const s=i.languageIdCodec;let e=4;o&&typeof o.tabSize=="number"&&(e=o.tabSize),L.startsWithUTF8BOM(t)&&(t=t.substr(1));const a=L.splitLines(t);if(!i.isRegisteredLanguageId(n))return C(a,e,s);const r=await b.getOrCreate(n);return r?O(a,e,r,s):C(a,e,s)}static colorizeLine(i,t,n,o,s=4){const e=m.isBasicASCII(i,t),a=m.containsRTL(i,e,n);return p(new T(!1,!0,i,!1,e,a,0,o,[],s,0,0,0,0,-1,"none",!1,!1,null)).html}static colorizeModelLine(i,t,n=4){const o=i.getLineContent(t);i.tokenization.forceTokenization(t);const e=i.tokenization.getLineTokens(t).inflate();return this.colorizeLine(o,i.mightContainNonBasicASCII(),i.mightContainRTL(),e,n)}}function O(c,i,t,n){return new Promise((o,s)=>{const e=()=>{const a=w(c,i,t,n);if(t instanceof y){const r=t.getLoadStatus();if(r.loaded===!1){r.promise.then(e,s);return}}o(a)};e()})}function C(c,i,t){let n=[];const o=(k.None<<I.FONT_STYLE_OFFSET|h.DefaultForeground<<I.FOREGROUND_OFFSET|h.DefaultBackground<<I.BACKGROUND_OFFSET)>>>0,s=new Uint32Array(2);s[0]=0,s[1]=o;for(let e=0,a=c.length;e<a;e++){const r=c[e];s[0]=r.length;const u=new d(s,r,t),l=m.isBasicASCII(r,!0),g=m.containsRTL(r,l,!0),f=p(new T(!1,!0,r,!1,l,g,0,u,[],i,0,0,0,0,-1,"none",!1,!1,null));n=n.concat(f.html),n.push("<br/>")}return n.join("")}function w(c,i,t,n){let o=[],s=t.getInitialState();for(let e=0,a=c.length;e<a;e++){const r=c[e],u=t.tokenizeEncoded(r,!0,s);d.convertToEndOffset(u.tokens,r.length);const l=new d(u.tokens,r,n),g=m.isBasicASCII(r,!0),f=m.containsRTL(r,g,!0),z=p(new T(!1,!0,r,!1,g,f,0,l.inflate(),[],i,0,0,0,0,-1,"none",!1,!1,null));o=o.concat(z.html),o.push("<br/>"),s=u.endState}return o.join("")}export{_ as Colorizer};
