function d(n){return!n}function p(n,t){return n.ignoreCase&&t?t.toLowerCase():t}function g(n,t){return new Error(`${n.languageId}: ${t}`)}function y(n,t,e,r,i){let l=/\$((\$)|(#)|(\d\d?)|[sS](\d\d?)|@(\w+))/g,s=null;return t.replace(l,function(o,f,a,c,u,m,h,b,R){return d(a)?d(c)?!d(u)&&u<r.length?p(n,r[u]):!d(h)&&n&&typeof n[h]=="string"?n[h]:(s===null&&(s=i.split("."),s.unshift(i)),!d(m)&&m<s.length?p(n,s[m]):""):p(n,e):"$"})}function z(n,t,e){let r=/\$[sS](\d\d?)/g,i=null;return t.replace(r,function(l,s){return i===null&&(i=e.split("."),i.unshift(e)),!d(s)&&s<i.length?p(n,i[s]):""})}function A(n,t){let e=t;for(;e&&e.length>0;){if(n.stateNames[e])return!0;let i=e.lastIndexOf(".");i<0?e=null:e=e.substr(0,i)}return!1}function F(n,t){if(!t||!Array.isArray(t))return!1;for(let e of t)if(!n(e))return!1;return!0}function x(n,t){return typeof n=="boolean"?n:t}function I(n,t){return typeof n=="string"?n:t}function S(n){let t={};for(let e of n)t[e]=!0;return t}function L(n,t=!1){t&&(n=n.map(function(r){return r.toLowerCase()}));let e=S(n);return t?function(r){return e[r.toLowerCase()]!==void 0&&e.hasOwnProperty(r.toLowerCase())}:function(r){return e[r]!==void 0&&e.hasOwnProperty(r)}}function k(n,t,e){t=t.replace(/@@/g,"");let r=0,i;do i=!1,t=t.replace(/@(\w+)/g,function(s,o){i=!0;let f="";if(typeof n[o]=="string")f=n[o];else if(n[o]&&n[o]instanceof RegExp)f=n[o].source;else throw n[o]===void 0?g(n,"language definition does not contain attribute '"+o+"', used at: "+t):g(n,"attribute reference '"+o+"' must be a string, used at: "+t);return d(f)?"":"(?:"+f+")"}),r++;while(i&&r<5);t=t.replace(/\x01/g,"@");let l=(n.ignoreCase?"i":"")+(n.unicode?"u":"");if(e&&t.match(/\$[sS](\d\d?)/g)){let o=null,f=null;return a=>(f&&o===a||(o=a,f=new RegExp(z(n,t,a),l)),f)}return new RegExp(t,l)}function $(n,t,e,r){if(r<0)return n;if(r<t.length)return t[r];if(r>=100){r=r-100;let i=e.split(".");if(i.unshift(e),r<i.length)return i[r]}return null}function O(n,t,e,r){let i=-1,l=e,s=e.match(/^\$(([sS]?)(\d\d?)|#)(.*)$/);s&&(s[3]&&(i=parseInt(s[3]),s[2]&&(i=i+100)),l=s[4]);let o="~",f=l;!l||l.length===0?(o="!=",f=""):/^\w*$/.test(f)?o="==":(s=l.match(/^(@|!@|~|!~|==|!=)(.*)$/),s&&(o=s[1],f=s[2]));let a;if((o==="~"||o==="!~")&&/^(\w|\|)*$/.test(f)){let c=L(f.split("|"),n.ignoreCase);a=function(u){return o==="~"?c(u):!c(u)}}else if(o==="@"||o==="!@"){let c=n[f];if(!c)throw g(n,"the @ match target '"+f+"' is not defined, in rule: "+t);if(!F(function(m){return typeof m=="string"},c))throw g(n,"the @ match target '"+f+"' must be an array of strings, in rule: "+t);let u=L(c,n.ignoreCase);a=function(m){return o==="@"?u(m):!u(m)}}else if(o==="~"||o==="!~")if(f.indexOf("$")<0){let c=k(n,"^"+f+"$",!1);a=function(u){return o==="~"?c.test(u):!c.test(u)}}else a=function(c,u,m,h){return k(n,"^"+y(n,f,u,m,h)+"$",!1).test(c)};else if(f.indexOf("$")<0){let c=p(n,f);a=function(u){return o==="=="?u===c:u!==c}}else{let c=p(n,f);a=function(u,m,h,b,R){let w=y(n,c,m,h,b);return o==="=="?u===w:u!==w}}return i===-1?{name:e,value:r,test:function(c,u,m,h){return a(c,c,u,m,h)}}:{name:e,value:r,test:function(c,u,m,h){let b=$(c,u,m,i);return a(b||"",c,u,m,h)}}}function C(n,t,e){if(e){if(typeof e=="string")return e;if(e.token||e.token===""){if(typeof e.token!="string")throw g(n,"a 'token' attribute must be of type string, in rule: "+t);{let r={token:e.token};if(e.token.indexOf("$")>=0&&(r.tokenSubst=!0),typeof e.bracket=="string")if(e.bracket==="@open")r.bracket=1;else if(e.bracket==="@close")r.bracket=-1;else throw g(n,"a 'bracket' attribute must be either '@open' or '@close', in rule: "+t);if(e.next){if(typeof e.next!="string")throw g(n,"the next state must be a string value in rule: "+t);{let i=e.next;if(!/^(@pop|@push|@popall)$/.test(i)&&(i[0]==="@"&&(i=i.substr(1)),i.indexOf("$")<0&&!A(n,y(n,i,"",[],""))))throw g(n,"the next state '"+e.next+"' is not defined in rule: "+t);r.next=i}}return typeof e.goBack=="number"&&(r.goBack=e.goBack),typeof e.switchTo=="string"&&(r.switchTo=e.switchTo),typeof e.log=="string"&&(r.log=e.log),typeof e.nextEmbedded=="string"&&(r.nextEmbedded=e.nextEmbedded,n.usesEmbedded=!0),r}}else if(Array.isArray(e)){let r=[];for(let i=0,l=e.length;i<l;i++)r[i]=C(n,t,e[i]);return{group:r}}else if(e.cases){let r=[];for(let l in e.cases)if(e.cases.hasOwnProperty(l)){let s=C(n,t,e.cases[l]);l==="@default"||l==="@"||l===""?r.push({test:void 0,value:s,name:l}):l==="@eos"?r.push({test:function(o,f,a,c){return c},value:s,name:l}):r.push(O(n,t,l,s))}let i=n.defaultToken;return{test:function(l,s,o,f){for(let a of r)if(!a.test||a.test(l,s,o,f))return a.value;return i}}}else throw g(n,"an action must be a string, an object with a 'token' or 'cases' attribute, or an array of actions; in rule: "+t)}else return{token:""}}var E=class{regex=new RegExp("");action={token:""};matchOnlyAtLineStart=!1;name="";constructor(t){this.name=t}setRegex(t,e){let r;if(typeof e=="string")r=e;else if(e instanceof RegExp)r=e.source;else throw g(t,"rules must start with a match string or regular expression: "+this.name);this.matchOnlyAtLineStart=r.length>0&&r[0]==="^",this.name=this.name+": "+r,this.regex=k(t,"^(?:"+(this.matchOnlyAtLineStart?r.substr(1):r)+")",!0)}setAction(t,e){this.action=C(t,this.name,e)}resolveRegex(t){return this.regex instanceof RegExp?this.regex:this.regex(t)}};function v(n,t){if(!t||typeof t!="object")throw new Error("Monarch: expecting a language definition object");let e={languageId:n,includeLF:x(t.includeLF,!1),noThrow:!1,maxStack:100,start:typeof t.start=="string"?t.start:null,ignoreCase:x(t.ignoreCase,!1),unicode:x(t.unicode,!1),tokenPostfix:I(t.tokenPostfix,"."+n),defaultToken:I(t.defaultToken,"source"),usesEmbedded:!1,stateNames:{},tokenizer:{},brackets:[]},r=t;r.languageId=n,r.includeLF=e.includeLF,r.ignoreCase=e.ignoreCase,r.unicode=e.unicode,r.noThrow=e.noThrow,r.usesEmbedded=e.usesEmbedded,r.stateNames=t.tokenizer,r.defaultToken=e.defaultToken;function i(s,o,f){for(let a of f){let c=a.include;if(c){if(typeof c!="string")throw g(e,"an 'include' attribute must be a string at: "+s);if(c[0]==="@"&&(c=c.substr(1)),!t.tokenizer[c])throw g(e,"include target '"+c+"' is not defined at: "+s);i(s+"."+c,o,t.tokenizer[c])}else{let u=new E(s);if(Array.isArray(a)&&a.length>=1&&a.length<=3)if(u.setRegex(r,a[0]),a.length>=3)if(typeof a[1]=="string")u.setAction(r,{token:a[1],next:a[2]});else if(typeof a[1]=="object"){let m=a[1];m.next=a[2],u.setAction(r,m)}else throw g(e,"a next state as the last element of a rule can only be given if the action is either an object or a string, at: "+s);else u.setAction(r,a[1]);else{if(!a.regex)throw g(e,"a rule must either be an array, or an object with a 'regex' or 'include' field at: "+s);a.name&&typeof a.name=="string"&&(u.name=a.name),a.matchOnlyAtStart&&(u.matchOnlyAtLineStart=x(a.matchOnlyAtLineStart,!1)),u.setRegex(r,a.regex),u.setAction(r,a.action)}o.push(u)}}}if(!t.tokenizer||typeof t.tokenizer!="object")throw g(e,"a language definition must define the 'tokenizer' attribute as an object");e.tokenizer=[];for(let s in t.tokenizer)if(t.tokenizer.hasOwnProperty(s)){e.start||(e.start=s);let o=t.tokenizer[s];e.tokenizer[s]=new Array,i("tokenizer."+s,e.tokenizer[s],o)}if(e.usesEmbedded=r.usesEmbedded,t.brackets){if(!Array.isArray(t.brackets))throw g(e,"the 'brackets' attribute must be defined as an array")}else t.brackets=[{open:"{",close:"}",token:"delimiter.curly"},{open:"[",close:"]",token:"delimiter.square"},{open:"(",close:")",token:"delimiter.parenthesis"},{open:"<",close:">",token:"delimiter.angle"}];let l=[];for(let s of t.brackets){let o=s;if(o&&Array.isArray(o)&&o.length===3&&(o={token:o[2],open:o[0],close:o[1]}),o.open===o.close)throw g(e,"open and close brackets in a 'brackets' attribute must be different: "+o.open+`
 hint: use the 'bracket' attribute if matching on equal brackets is required.`);if(typeof o.open=="string"&&typeof o.token=="string"&&typeof o.close=="string")l.push({token:o.token+e.tokenPostfix,open:p(e,o.open),close:p(e,o.close)});else throw g(e,"every element in the 'brackets' array must be a '{open,close,token}' object or array")}return e.brackets=l,e.noThrow=!0,e}export{v as compile};
