import a from"assert";import"../../../../base/common/lifecycle.js";import{ensureNoDisposablesAreLeakedInTestSuite as h}from"../../../../base/test/common/utils.js";import"../../../common/core/editOperation.js";import{Range as r}from"../../../common/core/range.js";import{EndOfLinePreference as p,EndOfLineSequence as m}from"../../../common/model.js";import{MirrorTextModel as g}from"../../../common/model/mirrorTextModel.js";import"../../../common/textModelEvents.js";import{assertSyncedModels as y,testApplyEditsWithSyncedModels as n}from"./editableTextModelTestUtils.js";import{createTextModel as c}from"../testTextModel.js";suite("EditorModel - EditableTextModel.applyEdits updates mightContainRTL",()=>{h();function e(t,i,o,d){const s=c(t.join(`
`));s.setEOL(m.LF),a.strictEqual(s.mightContainRTL(),o),s.applyEdits(i),a.strictEqual(s.mightContainRTL(),d),s.dispose()}function l(t,i,o,d,s){return{range:new r(t,i,o,d),text:s.join(`
`)}}test("start with RTL, insert LTR",()=>{e([`Hello,
\u05D6\u05D5\u05D4\u05D9 \u05E2\u05D5\u05D1\u05D3\u05D4 \u05DE\u05D1\u05D5\u05E1\u05E1\u05EA \u05E9\u05D3\u05E2\u05EA\u05D5`],[l(1,1,1,1,["hello"])],!0,!0)}),test("start with RTL, delete RTL",()=>{e([`Hello,
\u05D6\u05D5\u05D4\u05D9 \u05E2\u05D5\u05D1\u05D3\u05D4 \u05DE\u05D1\u05D5\u05E1\u05E1\u05EA \u05E9\u05D3\u05E2\u05EA\u05D5`],[l(1,1,10,10,[""])],!0,!0)}),test("start with RTL, insert RTL",()=>{e([`Hello,
\u05D6\u05D5\u05D4\u05D9 \u05E2\u05D5\u05D1\u05D3\u05D4 \u05DE\u05D1\u05D5\u05E1\u05E1\u05EA \u05E9\u05D3\u05E2\u05EA\u05D5`],[l(1,1,1,1,["\u0647\u0646\u0627\u0643 \u062D\u0642\u064A\u0642\u0629 \u0645\u062B\u0628\u062A\u0629 \u0645\u0646\u0630 \u0632\u0645\u0646 \u0637\u0648\u064A\u0644"])],!0,!0)}),test("start with LTR, insert LTR",()=>{e([`Hello,
world!`],[l(1,1,1,1,["hello"])],!1,!1)}),test("start with LTR, insert RTL 1",()=>{e([`Hello,
world!`],[l(1,1,1,1,["\u0647\u0646\u0627\u0643 \u062D\u0642\u064A\u0642\u0629 \u0645\u062B\u0628\u062A\u0629 \u0645\u0646\u0630 \u0632\u0645\u0646 \u0637\u0648\u064A\u0644"])],!1,!0)}),test("start with LTR, insert RTL 2",()=>{e([`Hello,
world!`],[l(1,1,1,1,["\u05D6\u05D5\u05D4\u05D9 \u05E2\u05D5\u05D1\u05D3\u05D4 \u05DE\u05D1\u05D5\u05E1\u05E1\u05EA \u05E9\u05D3\u05E2\u05EA\u05D5"])],!1,!0)})}),suite("EditorModel - EditableTextModel.applyEdits updates mightContainNonBasicASCII",()=>{h();function e(t,i,o,d){const s=c(t.join(`
`));s.setEOL(m.LF),a.strictEqual(s.mightContainNonBasicASCII(),o),s.applyEdits(i),a.strictEqual(s.mightContainNonBasicASCII(),d),s.dispose()}function l(t,i,o,d,s){return{range:new r(t,i,o,d),text:s.join(`
`)}}test("start with NON-ASCII, insert ASCII",()=>{e([`Hello,
Z\xFCrich`],[l(1,1,1,1,["hello","second line"])],!0,!0)}),test("start with NON-ASCII, delete NON-ASCII",()=>{e([`Hello,
Z\xFCrich`],[l(1,1,10,10,[""])],!0,!0)}),test("start with NON-ASCII, insert NON-ASCII",()=>{e([`Hello,
Z\xFCrich`],[l(1,1,1,1,["Z\xFCrich"])],!0,!0)}),test("start with ASCII, insert ASCII",()=>{e([`Hello,
world!`],[l(1,1,1,1,["hello","second line"])],!1,!1)}),test("start with ASCII, insert NON-ASCII",()=>{e([`Hello,
world!`],[l(1,1,1,1,["Z\xFCrich","Z\xFCrich"])],!1,!0)})}),suite("EditorModel - EditableTextModel.applyEdits",()=>{h();function e(t,i,o,d,s){return{range:new r(t,i,o,d),text:s.join(`
`),forceMoveMarkers:!1}}test("high-low surrogates 1",()=>{n(["\u{1F4DA}some","very nice","text"],[e(1,2,1,2,["a"])],["a\u{1F4DA}some","very nice","text"],!0)}),test("high-low surrogates 2",()=>{n(["\u{1F4DA}some","very nice","text"],[e(1,2,1,3,["a"])],["asome","very nice","text"],!0)}),test("high-low surrogates 3",()=>{n(["\u{1F4DA}some","very nice","text"],[e(1,1,1,2,["a"])],["asome","very nice","text"],!0)}),test("high-low surrogates 4",()=>{n(["\u{1F4DA}some","very nice","text"],[e(1,1,1,3,["a"])],["asome","very nice","text"],!0)}),test("Bug 19872: Undo is funky",()=>{n(["something"," A",""," B","something else"],[e(2,1,2,2,[""]),e(3,1,4,2,[""])],["something","A","B","something else"])}),test("Bug 19872: Undo is funky (2)",()=>{n(["something","A","B","something else"],[e(2,1,2,1,[" "]),e(3,1,3,1,[""," "])],["something"," A",""," B","something else"])}),test("insert empty text",()=>{n(["My First Line","		My Second Line","    Third Line","","1"],[e(1,1,1,1,[""])],["My First Line","		My Second Line","    Third Line","","1"])}),test("last op is no-op",()=>{n(["My First Line","		My Second Line","    Third Line","","1"],[e(1,1,1,2,[""]),e(4,1,4,1,[""])],["y First Line","		My Second Line","    Third Line","","1"])}),test("insert text without newline 1",()=>{n(["My First Line","		My Second Line","    Third Line","","1"],[e(1,1,1,1,["foo "])],["foo My First Line","		My Second Line","    Third Line","","1"])}),test("insert text without newline 2",()=>{n(["My First Line","		My Second Line","    Third Line","","1"],[e(1,3,1,3,[" foo"])],["My foo First Line","		My Second Line","    Third Line","","1"])}),test("insert one newline",()=>{n(["My First Line","		My Second Line","    Third Line","","1"],[e(1,4,1,4,["",""])],["My ","First Line","		My Second Line","    Third Line","","1"])}),test("insert text with one newline",()=>{n(["My First Line","		My Second Line","    Third Line","","1"],[e(1,3,1,3,[" new line","No longer"])],["My new line","No longer First Line","		My Second Line","    Third Line","","1"])}),test("insert text with two newlines",()=>{n(["My First Line","		My Second Line","    Third Line","","1"],[e(1,3,1,3,[" new line","One more line in the middle","No longer"])],["My new line","One more line in the middle","No longer First Line","		My Second Line","    Third Line","","1"])}),test("insert text with many newlines",()=>{n(["My First Line","		My Second Line","    Third Line","","1"],[e(1,3,1,3,["","","","",""])],["My","","",""," First Line","		My Second Line","    Third Line","","1"])}),test("insert multiple newlines",()=>{n(["My First Line","		My Second Line","    Third Line","","1"],[e(1,3,1,3,["","","","",""]),e(3,15,3,15,["a","b"])],["My","","",""," First Line","		My Second Line","    Third Linea","b","","1"])}),test("delete empty text",()=>{n(["My First Line","		My Second Line","    Third Line","","1"],[e(1,1,1,1,[""])],["My First Line","		My Second Line","    Third Line","","1"])}),test("delete text from one line",()=>{n(["My First Line","		My Second Line","    Third Line","","1"],[e(1,1,1,2,[""])],["y First Line","		My Second Line","    Third Line","","1"])}),test("delete text from one line 2",()=>{n(["My First Line","		My Second Line","    Third Line","","1"],[e(1,1,1,3,["a"])],["a First Line","		My Second Line","    Third Line","","1"])}),test("delete all text from a line",()=>{n(["My First Line","		My Second Line","    Third Line","","1"],[e(1,1,1,14,[""])],["","		My Second Line","    Third Line","","1"])}),test("delete text from two lines",()=>{n(["My First Line","		My Second Line","    Third Line","","1"],[e(1,4,2,6,[""])],["My Second Line","    Third Line","","1"])}),test("delete text from many lines",()=>{n(["My First Line","		My Second Line","    Third Line","","1"],[e(1,4,3,5,[""])],["My Third Line","","1"])}),test("delete everything",()=>{n(["My First Line","		My Second Line","    Third Line","","1"],[e(1,1,5,2,[""])],[""])}),test("two unrelated edits",()=>{n(["My First Line","		My Second Line","    Third Line","","123"],[e(2,1,2,3,["	"]),e(3,1,3,5,[""])],["My First Line","	My Second Line","Third Line","","123"])}),test("two edits on one line",()=>{n(["		first	    ","		second line","	third line","fourth line","		<!@#fifth#@!>		"],[e(5,3,5,7,[""]),e(5,12,5,16,[""])],["		first	    ","		second line","	third line","fourth line","		fifth		"])}),test("many edits",()=>{n(['{"x" : 1}'],[e(1,2,1,2,[`
  `]),e(1,5,1,6,[""]),e(1,9,1,9,[`
`])],["{",'  "x": 1',"}"])}),test("many edits reversed",()=>{n(["{",'  "x": 1',"}"],[e(1,2,2,3,[""]),e(2,6,2,6,[" "]),e(2,9,3,1,[""])],['{"x" : 1}'])}),test("replacing newlines 1",()=>{n(["{",'"a": true,',"",'"b": true',"}"],[e(1,2,2,1,["","	"]),e(2,11,4,1,["","	"])],["{",'	"a": true,','	"b": true',"}"])}),test("replacing newlines 2",()=>{n(["some text","some more text","now comes an empty line","","after empty line","and the last line"],[e(1,5,3,1,[" text","some more text","some more text"]),e(3,2,4,1,["o more lines","asd","asd","asd"]),e(5,1,5,6,["zzzzzzzz"]),e(5,11,6,16,["1","2","3","4"])],["some text","some more text","some more textno more lines","asd","asd","asd","zzzzzzzz empt1","2","3","4ne"])}),test("advanced 1",()=>{n([' {       "d": [',"             null","        ] /*comment*/",'        ,"e": /*comment*/ [null] }'],[e(1,1,1,2,[""]),e(1,3,1,10,["","  "]),e(1,16,2,14,["","    "]),e(2,18,3,9,["","  "]),e(3,22,4,9,[""]),e(4,10,4,10,["","  "]),e(4,28,4,28,["","    "]),e(4,32,4,32,["","  "]),e(4,33,4,34,["",""])],["{",'  "d": [',"    null","  ] /*comment*/,",'  "e": /*comment*/ [',"    null","  ]","}"])}),test("advanced simplified",()=>{n(["   abc"," ,def"],[e(1,1,1,4,[""]),e(1,7,2,2,[""]),e(2,3,2,3,["",""])],["abc,","def"])}),test("issue #144",()=>{n(["package caddy","","func main() {",'	fmt.Println("Hello World! :)")',"}",""],[e(1,1,6,1,["package caddy","",'import "fmt"',"","func main() {",'	fmt.Println("Hello World! :)")',"}",""])],["package caddy","",'import "fmt"',"","func main() {",'	fmt.Println("Hello World! :)")',"}",""])}),test("issue #2586 Replacing selected end-of-line with newline locks up the document",()=>{n(["something","interesting"],[e(1,10,2,1,["",""])],["something","interesting"])}),test("issue #3980",()=>{n(["class A {","    someProperty = false;","    someMethod() {","    this.someMethod();","    }","}"],[e(1,8,1,9,["",""]),e(3,17,3,18,["",""]),e(3,18,3,18,["    "]),e(4,5,4,5,["    "])],["class A","{","    someProperty = false;","    someMethod()","    {","        this.someMethod();","    }","}"])});function l(t,i){const o=c(t.join(`
`));let d=!1;try{o.applyEdits(i)}catch{d=!0}a.ok(d,"expected model.applyEdits to fail."),o.dispose()}test("touching edits: two inserts at the same position",()=>{n(["hello world"],[e(1,1,1,1,["a"]),e(1,1,1,1,["b"])],["abhello world"])}),test("touching edits: insert and replace touching",()=>{n(["hello world"],[e(1,1,1,1,["b"]),e(1,1,1,3,["ab"])],["babllo world"])}),test("overlapping edits: two overlapping replaces",()=>{l(["hello world"],[e(1,1,1,2,["b"]),e(1,1,1,3,["ab"])])}),test("overlapping edits: two overlapping deletes",()=>{l(["hello world"],[e(1,1,1,2,[""]),e(1,1,1,3,[""])])}),test("touching edits: two touching replaces",()=>{n(["hello world"],[e(1,1,1,2,["H"]),e(1,2,1,3,["E"])],["HEllo world"])}),test("touching edits: two touching deletes",()=>{n(["hello world"],[e(1,1,1,2,[""]),e(1,2,1,3,[""])],["llo world"])}),test("touching edits: insert and replace",()=>{n(["hello world"],[e(1,1,1,1,["H"]),e(1,1,1,3,["e"])],["Hello world"])}),test("touching edits: replace and insert",()=>{n(["hello world"],[e(1,1,1,3,["H"]),e(1,3,1,3,["e"])],["Hello world"])}),test("change while emitting events 1",()=>{let t;y("Hello",(i,o)=>{i.applyEdits([{range:new r(1,6,1,6),text:" world!"}]),o()},i=>{let o=!0;t=i.onDidChangeContent(()=>{o&&(o=!1,i.applyEdits([{range:new r(1,13,1,13),text:" How are you?"}]))})}),t.dispose()}),test("change while emitting events 2",()=>{let t;y("Hello",(i,o)=>{i.applyEdits([{range:new r(1,6,1,6),text:" world!"}]),o()},i=>{let o=!0;t=i.onDidChangeContent(d=>{o&&(o=!1,i.applyEdits([{range:new r(1,13,1,13),text:" How are you?"}]))})}),t.dispose()}),test("issue #1580: Changes in line endings are not correctly reflected in the extension host, leading to invalid offsets sent to external refactoring tools",()=>{const t=c(`Hello
World!`);a.strictEqual(t.getEOL(),`
`);const i=new g(null,t.getLinesContent(),t.getEOL(),t.getVersionId());let o=t.getVersionId();const d=t.onDidChangeContent(u=>{const L=u.versionId;L<o&&console.warn("Model version id did not advance between edits (2)"),o=L,i.onEvents(u)}),s=()=>{a.strictEqual(i.getText(),t.getValue(),"mirror model 2 text OK"),a.strictEqual(i.version,t.getVersionId(),"mirror model 2 version OK")};t.setEOL(m.CRLF),s(),d.dispose(),t.dispose(),i.dispose()}),test("issue #47733: Undo mangles unicode characters",()=>{const t=c("'\u{1F441}'");t.applyEdits([{range:new r(1,1,1,1),text:'"'},{range:new r(1,2,1,2),text:'"'}]),a.strictEqual(t.getValue(p.LF),`"'"\u{1F441}'`),a.deepStrictEqual(t.validateRange(new r(1,3,1,4)),new r(1,3,1,4)),t.applyEdits([{range:new r(1,1,1,2),text:null},{range:new r(1,3,1,4),text:null}]),a.strictEqual(t.getValue(p.LF),"'\u{1F441}'"),t.dispose()}),test("issue #48741: Broken undo stack with move lines up with multiple cursors",()=>{const t=c(["line1","line2","line3",""].join(`
`)),i=t.applyEdits([{range:new r(4,1,4,1),text:"line3"},{range:new r(3,1,3,6),text:null},{range:new r(2,1,3,1),text:null},{range:new r(3,6,3,6),text:`
line2`}],!0);t.applyEdits(i),a.deepStrictEqual(t.getValue(),`line1
line2
line3
`),t.dispose()})});
