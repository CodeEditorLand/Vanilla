import h from"assert";import{ensureNoDisposablesAreLeakedInTestSuite as b}from"../../../../base/test/common/utils.js";import{Range as s}from"../../../common/core/range.js";import{MetadataConsts as I}from"../../../common/encodedTokenAttributes.js";import{EncodedTokenizationResult as z,TokenizationRegistry as p}from"../../../common/languages.js";import"../../../common/model.js";import{computeIndentLevel as E}from"../../../common/model/utils.js";import{ContiguousMultilineTokensBuilder as S}from"../../../common/tokens/contiguousMultilineTokensBuilder.js";import{LineTokens as m}from"../../../common/tokens/lineTokens.js";import{TestLineTokenFactory as v}from"../core/testLineToken.js";import{createTextModel as T}from"../testTextModel.js";function C(t,n){const w=e.toTokens(n);m.convertToEndOffset(w,t.getLineContent().length);const l=v.inflateArr(w),o=t.inflate(),i=[];for(let r=0,x=o.getCount();r<x;r++)i[r]={endIndex:o.getEndOffset(r),type:o.getClassName(r)};const d=r=>({endIndex:r.endIndex,type:r.getType()});h.deepStrictEqual(i,l.map(d))}suite("ModelLine - getIndentLevel",()=>{b();function t(n,w,l=4){const o=E(n,l);h.strictEqual(o,w,n)}test("getIndentLevel",()=>{t("",-1),t(" ",-1),t("   	",-1),t("Hello",0),t(" Hello",1),t("   Hello",3),t("	Hello",4),t(" 	Hello",4),t("  	Hello",4),t("   	Hello",4),t("    	Hello",8),t("     	Hello",8),t("	 Hello",5),t("	 	Hello",8)})});class e{startOffset;color;constructor(n,w){this.startOffset=n,this.color=w}static toTokens(n){if(n===null)return null;const w=n.length,l=new Uint32Array(w<<1);for(let o=0;o<w;o++){const i=n[o];l[o<<1]=i.startOffset,l[(o<<1)+1]=i.color<<I.FOREGROUND_OFFSET>>>0}return l}}class L{tokens=new Map;stores=new Set;setLineTokens(n,w){const l=new S;l.add(n,w);for(const o of this.stores)o.setTokens(l.finalize())}getInitialState(){return new y(1)}tokenize(n,w,l){throw new Error}tokenizeEncoded(n,w,l){const o=l;return new z(this.tokens.get(o.lineNumber),new y(o.lineNumber+1))}createBackgroundTokenizer(n,w){return this.stores.add(w),{dispose:()=>{this.stores.delete(w)},requestTokens(l,o){}}}}class y{constructor(n){this.lineNumber=n}clone(){return this}equals(n){return n.lineNumber===this.lineNumber}}suite("ModelLinesTokens",()=>{b();function t(o,i,d){const r=o.map(a=>a.text).join(`
`),x=new L,u=p.register("test",x),c=T(r,"test");c.onBeforeAttached();for(let a=0;a<o.length;a++){const k=o[a].tokens,g=c.getLineMaxColumn(a+1)-1,f=e.toTokens(k);m.convertToEndOffset(f,g),x.setLineTokens(a+1,f)}c.applyEdits(i.map(a=>({identifier:null,range:a.range,text:a.text,forceMoveMarkers:!1})));for(let a=0;a<d.length;a++){const k=c.getLineContent(a+1),g=c.tokenization.getLineTokens(a+1);h.strictEqual(k,d[a].text),C(g,d[a].tokens)}c.dispose(),u.dispose()}test("single delete 1",()=>{t([{text:"hello world",tokens:[new e(0,1),new e(5,2),new e(6,3)]}],[{range:new s(1,1,1,2),text:""}],[{text:"ello world",tokens:[new e(0,1),new e(4,2),new e(5,3)]}])}),test("single delete 2",()=>{t([{text:"helloworld",tokens:[new e(0,1),new e(5,2)]}],[{range:new s(1,3,1,8),text:""}],[{text:"herld",tokens:[new e(0,1),new e(2,2)]}])}),test("single delete 3",()=>{t([{text:"hello world",tokens:[new e(0,1),new e(5,2),new e(6,3)]}],[{range:new s(1,1,1,6),text:""}],[{text:" world",tokens:[new e(0,2),new e(1,3)]}])}),test("single delete 4",()=>{t([{text:"hello world",tokens:[new e(0,1),new e(5,2),new e(6,3)]}],[{range:new s(1,2,1,7),text:""}],[{text:"hworld",tokens:[new e(0,1),new e(1,3)]}])}),test("single delete 5",()=>{t([{text:"hello world",tokens:[new e(0,1),new e(5,2),new e(6,3)]}],[{range:new s(1,1,1,12),text:""}],[{text:"",tokens:[new e(0,1)]}])}),test("multi delete 6",()=>{t([{text:"hello world",tokens:[new e(0,1),new e(5,2),new e(6,3)]},{text:"hello world",tokens:[new e(0,4),new e(5,5),new e(6,6)]},{text:"hello world",tokens:[new e(0,7),new e(5,8),new e(6,9)]}],[{range:new s(1,6,3,6),text:""}],[{text:"hello world",tokens:[new e(0,1),new e(5,8),new e(6,9)]}])}),test("multi delete 7",()=>{t([{text:"hello world",tokens:[new e(0,1),new e(5,2),new e(6,3)]},{text:"hello world",tokens:[new e(0,4),new e(5,5),new e(6,6)]},{text:"hello world",tokens:[new e(0,7),new e(5,8),new e(6,9)]}],[{range:new s(1,12,3,12),text:""}],[{text:"hello world",tokens:[new e(0,1),new e(5,2),new e(6,3)]}])}),test("multi delete 8",()=>{t([{text:"hello world",tokens:[new e(0,1),new e(5,2),new e(6,3)]},{text:"hello world",tokens:[new e(0,4),new e(5,5),new e(6,6)]},{text:"hello world",tokens:[new e(0,7),new e(5,8),new e(6,9)]}],[{range:new s(1,1,3,1),text:""}],[{text:"hello world",tokens:[new e(0,7),new e(5,8),new e(6,9)]}])}),test("multi delete 9",()=>{t([{text:"hello world",tokens:[new e(0,1),new e(5,2),new e(6,3)]},{text:"hello world",tokens:[new e(0,4),new e(5,5),new e(6,6)]},{text:"hello world",tokens:[new e(0,7),new e(5,8),new e(6,9)]}],[{range:new s(1,12,3,1),text:""}],[{text:"hello worldhello world",tokens:[new e(0,1),new e(5,2),new e(6,3),new e(11,7),new e(16,8),new e(17,9)]}])}),test("single insert 1",()=>{t([{text:"hello world",tokens:[new e(0,1),new e(5,2),new e(6,3)]}],[{range:new s(1,1,1,1),text:"xx"}],[{text:"xxhello world",tokens:[new e(0,1),new e(7,2),new e(8,3)]}])}),test("single insert 2",()=>{t([{text:"hello world",tokens:[new e(0,1),new e(5,2),new e(6,3)]}],[{range:new s(1,2,1,2),text:"xx"}],[{text:"hxxello world",tokens:[new e(0,1),new e(7,2),new e(8,3)]}])}),test("single insert 3",()=>{t([{text:"hello world",tokens:[new e(0,1),new e(5,2),new e(6,3)]}],[{range:new s(1,6,1,6),text:"xx"}],[{text:"helloxx world",tokens:[new e(0,1),new e(7,2),new e(8,3)]}])}),test("single insert 4",()=>{t([{text:"hello world",tokens:[new e(0,1),new e(5,2),new e(6,3)]}],[{range:new s(1,7,1,7),text:"xx"}],[{text:"hello xxworld",tokens:[new e(0,1),new e(5,2),new e(8,3)]}])}),test("single insert 5",()=>{t([{text:"hello world",tokens:[new e(0,1),new e(5,2),new e(6,3)]}],[{range:new s(1,12,1,12),text:"xx"}],[{text:"hello worldxx",tokens:[new e(0,1),new e(5,2),new e(6,3)]}])}),test("multi insert 6",()=>{t([{text:"hello world",tokens:[new e(0,1),new e(5,2),new e(6,3)]}],[{range:new s(1,1,1,1),text:`
`}],[{text:"",tokens:[new e(0,1)]},{text:"hello world",tokens:[new e(0,1)]}])}),test("multi insert 7",()=>{t([{text:"hello world",tokens:[new e(0,1),new e(5,2),new e(6,3)]}],[{range:new s(1,12,1,12),text:`
`}],[{text:"hello world",tokens:[new e(0,1),new e(5,2),new e(6,3)]},{text:"",tokens:[new e(0,1)]}])}),test("multi insert 8",()=>{t([{text:"hello world",tokens:[new e(0,1),new e(5,2),new e(6,3)]}],[{range:new s(1,7,1,7),text:`
`}],[{text:"hello ",tokens:[new e(0,1),new e(5,2)]},{text:"world",tokens:[new e(0,1)]}])}),test("multi insert 9",()=>{t([{text:"hello world",tokens:[new e(0,1),new e(5,2),new e(6,3)]},{text:"hello world",tokens:[new e(0,4),new e(5,5),new e(6,6)]}],[{range:new s(1,7,1,7),text:`xx
yy`}],[{text:"hello xx",tokens:[new e(0,1),new e(5,2)]},{text:"yyworld",tokens:[new e(0,1)]},{text:"hello world",tokens:[new e(0,4),new e(5,5),new e(6,6)]}])});function n(o,i,d,r,x){t([{text:o,tokens:i}],d.map(u=>({range:new s(1,u.startColumn,1,u.endColumn),text:u.text})),[{text:r,tokens:x}])}test("insertion on empty line",()=>{const o=new L,i=p.register("test",o),d=T("some text","test"),r=e.toTokens([new e(0,1)]);m.convertToEndOffset(r,d.getLineMaxColumn(1)-1),o.setLineTokens(1,r),d.applyEdits([{range:new s(1,1,1,10),text:""}]),o.setLineTokens(1,new Uint32Array(0)),d.applyEdits([{range:new s(1,1,1,1),text:"a"}]);const x=d.tokenization.getLineTokens(1);C(x,[new e(0,1)]),d.dispose(),i.dispose()}),test("updates tokens on insertion 1",()=>{n("abcd efgh",[new e(0,1),new e(4,2),new e(5,3)],[{startColumn:1,endColumn:1,text:"a"}],"aabcd efgh",[new e(0,1),new e(5,2),new e(6,3)])}),test("updates tokens on insertion 2",()=>{n("aabcd efgh",[new e(0,1),new e(5,2),new e(6,3)],[{startColumn:2,endColumn:2,text:"x"}],"axabcd efgh",[new e(0,1),new e(6,2),new e(7,3)])}),test("updates tokens on insertion 3",()=>{n("axabcd efgh",[new e(0,1),new e(6,2),new e(7,3)],[{startColumn:3,endColumn:3,text:"stu"}],"axstuabcd efgh",[new e(0,1),new e(9,2),new e(10,3)])}),test("updates tokens on insertion 4",()=>{n("axstuabcd efgh",[new e(0,1),new e(9,2),new e(10,3)],[{startColumn:10,endColumn:10,text:"	"}],"axstuabcd	 efgh",[new e(0,1),new e(10,2),new e(11,3)])}),test("updates tokens on insertion 5",()=>{n("axstuabcd	 efgh",[new e(0,1),new e(10,2),new e(11,3)],[{startColumn:12,endColumn:12,text:"dd"}],"axstuabcd	 ddefgh",[new e(0,1),new e(10,2),new e(13,3)])}),test("updates tokens on insertion 6",()=>{n("axstuabcd	 ddefgh",[new e(0,1),new e(10,2),new e(13,3)],[{startColumn:18,endColumn:18,text:"xyz"}],"axstuabcd	 ddefghxyz",[new e(0,1),new e(10,2),new e(13,3)])}),test("updates tokens on insertion 7",()=>{n("axstuabcd	 ddefghxyz",[new e(0,1),new e(10,2),new e(13,3)],[{startColumn:1,endColumn:1,text:"x"}],"xaxstuabcd	 ddefghxyz",[new e(0,1),new e(11,2),new e(14,3)])}),test("updates tokens on insertion 8",()=>{n("xaxstuabcd	 ddefghxyz",[new e(0,1),new e(11,2),new e(14,3)],[{startColumn:22,endColumn:22,text:"x"}],"xaxstuabcd	 ddefghxyzx",[new e(0,1),new e(11,2),new e(14,3)])}),test("updates tokens on insertion 9",()=>{n("xaxstuabcd	 ddefghxyzx",[new e(0,1),new e(11,2),new e(14,3)],[{startColumn:2,endColumn:2,text:""}],"xaxstuabcd	 ddefghxyzx",[new e(0,1),new e(11,2),new e(14,3)])}),test("updates tokens on insertion 10",()=>{n("",[],[{startColumn:1,endColumn:1,text:"a"}],"a",[new e(0,1)])}),test("delete second token 2",()=>{n("abcdefghij",[new e(0,1),new e(3,2),new e(6,3)],[{startColumn:4,endColumn:7,text:""}],"abcghij",[new e(0,1),new e(3,3)])}),test("insert right before second token",()=>{n("abcdefghij",[new e(0,1),new e(3,2),new e(6,3)],[{startColumn:4,endColumn:4,text:"hello"}],"abchellodefghij",[new e(0,1),new e(8,2),new e(11,3)])}),test("delete first char",()=>{n("abcd efgh",[new e(0,1),new e(4,2),new e(5,3)],[{startColumn:1,endColumn:2,text:""}],"bcd efgh",[new e(0,1),new e(3,2),new e(4,3)])}),test("delete 2nd and 3rd chars",()=>{n("abcd efgh",[new e(0,1),new e(4,2),new e(5,3)],[{startColumn:2,endColumn:4,text:""}],"ad efgh",[new e(0,1),new e(2,2),new e(3,3)])}),test("delete first token",()=>{n("abcd efgh",[new e(0,1),new e(4,2),new e(5,3)],[{startColumn:1,endColumn:5,text:""}]," efgh",[new e(0,2),new e(1,3)])}),test("delete second token",()=>{n("abcd efgh",[new e(0,1),new e(4,2),new e(5,3)],[{startColumn:5,endColumn:6,text:""}],"abcdefgh",[new e(0,1),new e(4,3)])}),test("delete second token + a bit of the third one",()=>{n("abcd efgh",[new e(0,1),new e(4,2),new e(5,3)],[{startColumn:5,endColumn:7,text:""}],"abcdfgh",[new e(0,1),new e(4,3)])}),test("delete second and third token",()=>{n("abcd efgh",[new e(0,1),new e(4,2),new e(5,3)],[{startColumn:5,endColumn:10,text:""}],"abcd",[new e(0,1)])}),test("delete everything",()=>{n("abcd efgh",[new e(0,1),new e(4,2),new e(5,3)],[{startColumn:1,endColumn:10,text:""}],"",[new e(0,1)])}),test("noop",()=>{n("abcd efgh",[new e(0,1),new e(4,2),new e(5,3)],[{startColumn:1,endColumn:1,text:""}],"abcd efgh",[new e(0,1),new e(4,2),new e(5,3)])}),test("equivalent to deleting first two chars",()=>{n("abcd efgh",[new e(0,1),new e(4,2),new e(5,3)],[{startColumn:1,endColumn:3,text:""}],"cd efgh",[new e(0,1),new e(2,2),new e(3,3)])}),test("equivalent to deleting from 5 to the end",()=>{n("abcd efgh",[new e(0,1),new e(4,2),new e(5,3)],[{startColumn:5,endColumn:10,text:""}],"abcd",[new e(0,1)])}),test("updates tokens on replace 1",()=>{n("Hello world, ciao",[new e(0,1),new e(5,0),new e(6,2),new e(11,0),new e(13,0)],[{startColumn:1,endColumn:6,text:"Hi"}],"Hi world, ciao",[new e(0,0),new e(3,2),new e(8,0),new e(10,0)])}),test("updates tokens on replace 2",()=>{n("Hello world, ciao",[new e(0,1),new e(5,0),new e(6,2),new e(11,0),new e(13,0)],[{startColumn:1,endColumn:6,text:"Hi"},{startColumn:8,endColumn:12,text:"my friends"}],"Hi wmy friends, ciao",[new e(0,0),new e(3,2),new e(14,0),new e(16,0)])});function w(o,i,d,r,x,u){t([{text:o,tokens:i}],[{range:new s(1,d,1,d),text:`
`}],[{text:r,tokens:u},{text:x,tokens:[new e(0,1)]}])}test("split at the beginning",()=>{w("abcd efgh",[new e(0,1),new e(4,2),new e(5,3)],1,"","abcd efgh",[new e(0,1)])}),test("split at the end",()=>{w("abcd efgh",[new e(0,1),new e(4,2),new e(5,3)],10,"abcd efgh","",[new e(0,1),new e(4,2),new e(5,3)])}),test("split inthe middle 1",()=>{w("abcd efgh",[new e(0,1),new e(4,2),new e(5,3)],5,"abcd"," efgh",[new e(0,1)])}),test("split inthe middle 2",()=>{w("abcd efgh",[new e(0,1),new e(4,2),new e(5,3)],6,"abcd ","efgh",[new e(0,1),new e(4,2)])});function l(o,i,d,r,x,u){t([{text:o,tokens:i},{text:d,tokens:r}],[{range:new s(1,o.length+1,2,1),text:""}],[{text:x,tokens:u}])}test("append empty 1",()=>{l("abcd efgh",[new e(0,1),new e(4,2),new e(5,3)],"",[],"abcd efgh",[new e(0,1),new e(4,2),new e(5,3)])}),test("append empty 2",()=>{l("",[],"abcd efgh",[new e(0,1),new e(4,2),new e(5,3)],"abcd efgh",[new e(0,1),new e(4,2),new e(5,3)])}),test("append 1",()=>{l("abcd efgh",[new e(0,1),new e(4,2),new e(5,3)],"abcd efgh",[new e(0,4),new e(4,5),new e(5,6)],"abcd efghabcd efgh",[new e(0,1),new e(4,2),new e(5,3),new e(9,4),new e(13,5),new e(14,6)])}),test("append 2",()=>{l("abcd ",[new e(0,1),new e(4,2)],"efgh",[new e(0,3)],"abcd efgh",[new e(0,1),new e(4,2),new e(5,3)])}),test("append 3",()=>{l("abcd",[new e(0,1)]," efgh",[new e(0,2),new e(1,3)],"abcd efgh",[new e(0,1),new e(4,2),new e(5,3)])})});
