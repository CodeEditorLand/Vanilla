import u from"assert";import{ensureNoDisposablesAreLeakedInTestSuite as m}from"../../../../../base/test/common/utils.js";import{Range as a}from"../../../../common/core/range.js";import{DefaultEndOfLine as g}from"../../../../common/model.js";import{PieceTreeTextBuffer as c}from"../../../../common/model/pieceTreeTextBuffer/pieceTreeTextBuffer.js";import{createTextBufferFactory as f}from"../../../../common/model/textModel.js";suite("PieceTreeTextBuffer._getInverseEdits",()=>{m();function e(l,r,s,d,i){return{sortIndex:0,identifier:null,range:new a(l,r,s,d),rangeOffset:0,rangeLength:0,text:i?i.join(`
`):"",eolCount:i?i.length-1:0,firstLineLength:i?i[0].length:0,lastLineLength:i?i[i.length-1].length:0,forceMoveMarkers:!1,isAutoWhitespaceEdit:!1}}function t(l,r,s,d){return new a(l,r,s,d)}function n(l,r){const s=c._getInverseEditRanges(l);u.deepStrictEqual(s,r)}test("single insert",()=>{n([e(1,1,1,1,["hello"])],[t(1,1,1,6)])}),test("Bug 19872: Undo is funky",()=>{n([e(2,1,2,2,[""]),e(3,1,4,2,[""])],[t(2,1,2,1),t(3,1,3,1)])}),test("two single unrelated inserts",()=>{n([e(1,1,1,1,["hello"]),e(2,1,2,1,["world"])],[t(1,1,1,6),t(2,1,2,6)])}),test("two single inserts 1",()=>{n([e(1,1,1,1,["hello"]),e(1,2,1,2,["world"])],[t(1,1,1,6),t(1,7,1,12)])}),test("two single inserts 2",()=>{n([e(1,1,1,1,["hello"]),e(1,4,1,4,["world"])],[t(1,1,1,6),t(1,9,1,14)])}),test("multiline insert",()=>{n([e(1,1,1,1,["hello","world"])],[t(1,1,2,6)])}),test("two unrelated multiline inserts",()=>{n([e(1,1,1,1,["hello","world"]),e(2,1,2,1,["how","are","you?"])],[t(1,1,2,6),t(3,1,5,5)])}),test("two multiline inserts 1",()=>{n([e(1,1,1,1,["hello","world"]),e(1,2,1,2,["how","are","you?"])],[t(1,1,2,6),t(2,7,4,5)])}),test("single delete",()=>{n([e(1,1,1,6,null)],[t(1,1,1,1)])}),test("two single unrelated deletes",()=>{n([e(1,1,1,6,null),e(2,1,2,6,null)],[t(1,1,1,1),t(2,1,2,1)])}),test("two single deletes 1",()=>{n([e(1,1,1,6,null),e(1,7,1,12,null)],[t(1,1,1,1),t(1,2,1,2)])}),test("two single deletes 2",()=>{n([e(1,1,1,6,null),e(1,9,1,14,null)],[t(1,1,1,1),t(1,4,1,4)])}),test("multiline delete",()=>{n([e(1,1,2,6,null)],[t(1,1,1,1)])}),test("two unrelated multiline deletes",()=>{n([e(1,1,2,6,null),e(3,1,5,5,null)],[t(1,1,1,1),t(2,1,2,1)])}),test("two multiline deletes 1",()=>{n([e(1,1,2,6,null),e(2,7,4,5,null)],[t(1,1,1,1),t(1,2,1,2)])}),test("single replace",()=>{n([e(1,1,1,6,["Hello world"])],[t(1,1,1,12)])}),test("two replaces",()=>{n([e(1,1,1,6,["Hello world"]),e(1,7,1,8,["How are you?"])],[t(1,1,1,12),t(1,13,1,25)])}),test("many edits",()=>{n([e(1,2,1,2,["","  "]),e(1,5,1,6,[""]),e(1,9,1,9,["",""])],[t(1,2,2,3),t(2,6,2,6),t(2,9,3,1)])})}),suite("PieceTreeTextBuffer._toSingleEditOperation",()=>{m();function e(n,l,r,s,d,i,o){return{sortIndex:0,identifier:null,range:new a(n,l,r,s),rangeOffset:d,rangeLength:i,text:o?o.join(`
`):"",eolCount:o?o.length-1:0,firstLineLength:o?o[0].length:0,lastLineLength:o?o[o.length-1].length:0,forceMoveMarkers:!1,isAutoWhitespaceEdit:!1}}function t(n,l,r){const{disposable:s,textBuffer:d}=f(n.join(`
`)).create(g.LF),i=d._toSingleEditOperation(l);u.deepStrictEqual(i,r),s.dispose()}test("one edit op is unchanged",()=>{t(["My First Line","		My Second Line","    Third Line","","1"],[e(1,3,1,3,2,0,[" new line","No longer"])],e(1,3,1,3,2,0,[" new line","No longer"]))}),test("two edits on one line",()=>{t(["My First Line","		My Second Line","    Third Line","","1"],[e(1,1,1,3,0,2,["Your"]),e(1,4,1,4,3,0,["Interesting "]),e(2,3,2,6,16,3,null)],e(1,1,2,6,0,19,["Your Interesting First Line","		"]))}),test("insert multiple newlines",()=>{t(["My First Line","		My Second Line","    Third Line","","1"],[e(1,3,1,3,2,0,["","","","",""]),e(3,15,3,15,45,0,["a","b"])],e(1,3,3,15,2,43,["","","",""," First Line","		My Second Line","    Third Linea","b"]))}),test("delete empty text",()=>{t(["My First Line","		My Second Line","    Third Line","","1"],[e(1,1,1,1,0,0,[""])],e(1,1,1,1,0,0,[""]))}),test("two unrelated edits",()=>{t(["My First Line","		My Second Line","    Third Line","","123"],[e(2,1,2,3,14,2,["	"]),e(3,1,3,5,31,4,[""])],e(2,1,3,5,14,21,["	My Second Line",""]))}),test("many edits",()=>{t(['{"x" : 1}'],[e(1,2,1,2,1,0,[`
  `]),e(1,5,1,6,4,1,[""]),e(1,9,1,9,8,0,[`
`])],e(1,2,1,9,1,7,["",'  "x": 1',""]))}),test("many edits reversed",()=>{t(["{",'  "x": 1',"}"],[e(1,2,2,3,1,3,[""]),e(2,6,2,6,7,0,[" "]),e(2,9,3,1,10,1,[""])],e(1,2,3,1,1,10,['"x" : 1']))}),test("replacing newlines 1",()=>{t(["{",'"a": true,',"",'"b": true',"}"],[e(1,2,2,1,1,1,["","	"]),e(2,11,4,1,12,2,["","	"])],e(1,2,4,1,1,13,["",'	"a": true,',"	"]))}),test("replacing newlines 2",()=>{t(["some text","some more text","now comes an empty line","","after empty line","and the last line"],[e(1,5,3,1,4,21,[" text","some more text","some more text"]),e(3,2,4,1,26,23,["o more lines","asd","asd","asd"]),e(5,1,5,6,50,5,["zzzzzzzz"]),e(5,11,6,16,60,22,["1","2","3","4"])],e(1,5,6,16,4,78,[" text","some more text","some more textno more lines","asd","asd","asd","zzzzzzzz empt1","2","3","4"]))}),test("advanced",()=>{t([' {       "d": [',"             null","        ] /*comment*/",'        ,"e": /*comment*/ [null] }'],[e(1,1,1,2,0,1,[""]),e(1,3,1,10,2,7,["","  "]),e(1,16,2,14,15,14,["","    "]),e(2,18,3,9,33,9,["","  "]),e(3,22,4,9,55,9,[""]),e(4,10,4,10,65,0,["","  "]),e(4,28,4,28,83,0,["","    "]),e(4,32,4,32,87,0,["","  "]),e(4,33,4,34,88,1,["",""])],e(1,1,4,34,0,89,["{",'  "d": [',"    null","  ] /*comment*/,",'  "e": /*comment*/ [',"    null","  ]",""]))}),test("advanced simplified",()=>{t(["   abc"," ,def"],[e(1,1,1,4,0,3,[""]),e(1,7,2,2,6,2,[""]),e(2,3,2,3,9,0,["",""])],e(1,1,2,3,0,9,["abc,",""]))})});
