import l from"assert";import{CharCode as w}from"../../../../base/common/charCode.js";import*as h from"../../../../base/common/platform.js";import{URI as a}from"../../../../base/common/uri.js";import{EditOperation as g}from"../../../common/core/editOperation.js";import{Range as c}from"../../../common/core/range.js";import{Selection as p}from"../../../common/core/selection.js";import{StringBuilder as S}from"../../../common/core/stringBuilder.js";import{DefaultEndOfLine as d}from"../../../common/model.js";import{createTextBuffer as b}from"../../../common/model/textModel.js";import{ModelService as f}from"../../../common/services/modelService.js";import{TestConfigurationService as T}from"../../../../platform/configuration/test/common/testConfigurationService.js";import{createModelServices as M,createTextModel as u}from"../testTextModel.js";import{DisposableStore as j}from"../../../../base/common/lifecycle.js";import{IModelService as I}from"../../../common/services/model.js";import{IConfigurationService as O}from"../../../../platform/configuration/common/configuration.js";import"../../../../platform/instantiation/test/common/instantiationServiceMock.js";import{ensureNoDisposablesAreLeakedInTestSuite as q}from"../../../../base/test/common/utils.js";const L=!1;suite("ModelService",()=>{let i,n,s;setup(()=>{i=new j;const e=new T;e.setUserConfiguration("files",{eol:`
`}),e.setUserConfiguration("files",{eol:`\r
`},a.file(h.isWindows?"c:\\myroot":"/myroot")),s=M(i,[[O,e]]),n=s.get(I)}),teardown(()=>{i.dispose()}),q(),test("EOL setting respected depending on root",()=>{const e=n.createModel("farboo",null),t=n.createModel("farboo",null,a.file(h.isWindows?"c:\\myroot\\myfile.txt":"/myroot/myfile.txt")),o=n.createModel("farboo",null,a.file(h.isWindows?"c:\\other\\myfile.txt":"/other/myfile.txt"));l.strictEqual(e.getOptions().defaultEOL,d.LF),l.strictEqual(t.getOptions().defaultEOL,d.CRLF),l.strictEqual(o.getOptions().defaultEOL,d.LF),e.dispose(),t.dispose(),o.dispose()}),test("_computeEdits no change",function(){const e=i.add(u(["This is line one","and this is line number two","it is followed by #3","and finished with the fourth."].join(`
`))),t=m(i,["This is line one","and this is line number two","it is followed by #3","and finished with the fourth."].join(`
`),d.LF),o=f._computeEdits(e,t);l.deepStrictEqual(o,[])}),test("_computeEdits first line changed",function(){const e=i.add(u(["This is line one","and this is line number two","it is followed by #3","and finished with the fourth."].join(`
`))),t=m(i,["This is line One","and this is line number two","it is followed by #3","and finished with the fourth."].join(`
`),d.LF),o=f._computeEdits(e,t);l.deepStrictEqual(o,[g.replaceMove(new c(1,1,2,1),`This is line One
`)])}),test("_computeEdits EOL changed",function(){const e=i.add(u(["This is line one","and this is line number two","it is followed by #3","and finished with the fourth."].join(`
`))),t=m(i,["This is line one","and this is line number two","it is followed by #3","and finished with the fourth."].join(`\r
`),d.LF),o=f._computeEdits(e,t);l.deepStrictEqual(o,[])}),test("_computeEdits EOL and other change 1",function(){const e=i.add(u(["This is line one","and this is line number two","it is followed by #3","and finished with the fourth."].join(`
`))),t=m(i,["This is line One","and this is line number two","It is followed by #3","and finished with the fourth."].join(`\r
`),d.LF),o=f._computeEdits(e,t);l.deepStrictEqual(o,[g.replaceMove(new c(1,1,4,1),["This is line One","and this is line number two","It is followed by #3",""].join(`\r
`))])}),test("_computeEdits EOL and other change 2",function(){const e=i.add(u(["package main","func foo() {","}"].join(`
`))),t=m(i,["package main","func foo() {","}",""].join(`\r
`),d.LF),o=f._computeEdits(e,t);l.deepStrictEqual(o,[g.replaceMove(new c(3,2,3,2),`\r
`)])}),test("generated1",()=>{r(["pram","okctibad","pjuwtemued","knnnm","u",""],["tcnr","rxwlicro","vnzy","","","pjzcogzur","ptmxyp","dfyshia","pee","ygg"])}),test("generated2",()=>{r(["","itls","hrilyhesv",""],["vdl","","tchgz","bhx","nyl"])}),test("generated3",()=>{r(["ubrbrcv","wv","xodspybszt","s","wednjxm","fklajt","fyfc","lvejgge","rtpjlodmmk","arivtgmjdm"],["s","qj","tu","ur","qerhjjhyvx","t"])}),test("generated4",()=>{r(["ig","kh","hxegci","smvker","pkdmjjdqnv","vgkkqqx","","jrzeb"],["yk",""])}),test("does insertions in the middle of the document",()=>{r(["line 1","line 2","line 3"],["line 1","line 2","line 5","line 3"])}),test("does insertions at the end of the document",()=>{r(["line 1","line 2","line 3"],["line 1","line 2","line 3","line 4"])}),test("does insertions at the beginning of the document",()=>{r(["line 1","line 2","line 3"],["line 0","line 1","line 2","line 3"])}),test("does replacements",()=>{r(["line 1","line 2","line 3"],["line 1","line 7","line 3"])}),test("does deletions",()=>{r(["line 1","line 2","line 3"],["line 1","line 3"])}),test("does insert, replace, and delete",()=>{r(["line 1","line 2","line 3","line 4","line 5"],["line 0","line 1","replace line 2","line 3","line 5"])}),test("maintains undo for same resource and same content",()=>{const e=a.parse("file://test.txt"),t=n.createModel("text",null,e);t.pushEditOperations(null,[{range:new c(1,5,1,5),text:"1"}],()=>[new p(1,5,1,5)]),l.strictEqual(t.getValue(),"text1"),n.destroyModel(e);const o=n.createModel("text1",null,e);o.undo(),l.strictEqual(o.getValue(),"text"),n.destroyModel(e)}),test("maintains version id and alternative version id for same resource and same content",()=>{const e=a.parse("file://test.txt"),t=n.createModel("text",null,e);t.pushEditOperations(null,[{range:new c(1,5,1,5),text:"1"}],()=>[new p(1,5,1,5)]),l.strictEqual(t.getValue(),"text1");const o=t.getVersionId(),v=t.getAlternativeVersionId();n.destroyModel(e);const x=n.createModel("text1",null,e);l.strictEqual(x.getVersionId(),o),l.strictEqual(x.getAlternativeVersionId(),v),n.destroyModel(e)}),test("does not maintain undo for same resource and different content",()=>{const e=a.parse("file://test.txt"),t=n.createModel("text",null,e);t.pushEditOperations(null,[{range:new c(1,5,1,5),text:"1"}],()=>[new p(1,5,1,5)]),l.strictEqual(t.getValue(),"text1"),n.destroyModel(e);const o=n.createModel("text2",null,e);o.undo(),l.strictEqual(o.getValue(),"text2"),n.destroyModel(e)}),test("setValue should clear undo stack",()=>{const e=a.parse("file://test.txt"),t=n.createModel("text",null,e);t.pushEditOperations(null,[{range:new c(1,5,1,5),text:"1"}],()=>[new p(1,5,1,5)]),l.strictEqual(t.getValue(),"text1"),t.setValue("text2"),t.undo(),l.strictEqual(t.getValue(),"text2"),n.destroyModel(e)})});function r(i,n){const s=u(i.join(`
`)),{disposable:e,textBuffer:t}=b(n.join(`
`),d.LF),o=f._computeEdits(s,t);s.pushEditOperations([],o,null),l.strictEqual(s.getValue(),n.join(`
`)),e.dispose(),s.dispose()}function E(i,n){return Math.floor(Math.random()*(n-i+1))+i}function k(i,n){const s=E(i,n),e=new S(s);for(let t=0;t<s;t++)e.appendASCIICharCode(E(w.a,w.z));return e.build()}function y(i){const n=E(1,i?3:1e4),s=[];for(let e=0;e<n;e++)s.push(k(0,i?3:1e4));return s}if(L){let i=1;for(;;){console.log("------TEST: "+i++);const n=y(!0),s=y(!0);console.log("------TEST GENERATED");try{r(n,s)}catch(e){console.log(e),console.log(`
const file1 = ${JSON.stringify(n).replace(/"/g,"'")};
const file2 = ${JSON.stringify(s).replace(/"/g,"'")};
assertComputeEdits(file1, file2);
`);break}}}function m(i,n,s){const{disposable:e,textBuffer:t}=b(n,s);return i.add(e),t}
