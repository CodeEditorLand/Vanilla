import t from"assert";import{ensureNoDisposablesAreLeakedInTestSuite as a}from"../../../../base/test/common/utils.js";import{MetadataConsts as u}from"../../../common/encodedTokenAttributes.js";import{LanguageIdCodec as I}from"../../../common/services/languagesRegistry.js";import{LineTokens as x}from"../../../common/tokens/lineTokens.js";suite("LineTokens",()=>{a();function l(e,n){const f=new Uint32Array(n.length<<1);for(let d=0,o=n.length;d<o;d++)f[d<<1]=d+1<o?n[d+1].startIndex:e.length,f[(d<<1)+1]=n[d].foreground<<u.FOREGROUND_OFFSET>>>0;return new x(f,e,new I)}function s(){return l("Hello world, this is a lovely day",[{startIndex:0,foreground:1},{startIndex:6,foreground:2},{startIndex:13,foreground:3},{startIndex:18,foreground:4},{startIndex:21,foreground:5},{startIndex:23,foreground:6},{startIndex:30,foreground:7}])}function i(e){let n="";const f=e.getLineContent();let d=0;for(let o=0;o<e.getCount();o++)n+=f.substring(d,e.getEndOffset(o)),n+=`(${e.getMetadata(o)})`,d=e.getEndOffset(o);return n}test("withInserted 1",()=>{const e=s();t.strictEqual(i(e),"Hello (32768)world, (65536)this (98304)is (131072)a (163840)lovely (196608)day(229376)");const n=e.withInserted([{offset:0,text:"1",tokenMetadata:0},{offset:6,text:"2",tokenMetadata:0},{offset:9,text:"3",tokenMetadata:0}]);t.strictEqual(i(n),"1(0)Hello (32768)2(0)wor(65536)3(0)ld, (65536)this (98304)is (131072)a (163840)lovely (196608)day(229376)")}),test("withInserted (tokens at the same position)",()=>{const e=s();t.strictEqual(i(e),"Hello (32768)world, (65536)this (98304)is (131072)a (163840)lovely (196608)day(229376)");const n=e.withInserted([{offset:0,text:"1",tokenMetadata:0},{offset:0,text:"2",tokenMetadata:0},{offset:0,text:"3",tokenMetadata:0}]);t.strictEqual(i(n),"1(0)2(0)3(0)Hello (32768)world, (65536)this (98304)is (131072)a (163840)lovely (196608)day(229376)")}),test("withInserted (tokens at the end)",()=>{const e=s();t.strictEqual(i(e),"Hello (32768)world, (65536)this (98304)is (131072)a (163840)lovely (196608)day(229376)");const n=e.withInserted([{offset:32,text:"1",tokenMetadata:0},{offset:33,text:"2",tokenMetadata:0}]);t.strictEqual(i(n),"Hello (32768)world, (65536)this (98304)is (131072)a (163840)lovely (196608)da(229376)1(0)y(229376)2(0)")}),test("basics",()=>{const e=s();t.strictEqual(e.getLineContent(),"Hello world, this is a lovely day"),t.strictEqual(e.getLineContent().length,33),t.strictEqual(e.getCount(),7),t.strictEqual(e.getStartOffset(0),0),t.strictEqual(e.getEndOffset(0),6),t.strictEqual(e.getStartOffset(1),6),t.strictEqual(e.getEndOffset(1),13),t.strictEqual(e.getStartOffset(2),13),t.strictEqual(e.getEndOffset(2),18),t.strictEqual(e.getStartOffset(3),18),t.strictEqual(e.getEndOffset(3),21),t.strictEqual(e.getStartOffset(4),21),t.strictEqual(e.getEndOffset(4),23),t.strictEqual(e.getStartOffset(5),23),t.strictEqual(e.getEndOffset(5),30),t.strictEqual(e.getStartOffset(6),30),t.strictEqual(e.getEndOffset(6),33)}),test("findToken",()=>{const e=s();t.strictEqual(e.findTokenIndexAtOffset(0),0),t.strictEqual(e.findTokenIndexAtOffset(1),0),t.strictEqual(e.findTokenIndexAtOffset(2),0),t.strictEqual(e.findTokenIndexAtOffset(3),0),t.strictEqual(e.findTokenIndexAtOffset(4),0),t.strictEqual(e.findTokenIndexAtOffset(5),0),t.strictEqual(e.findTokenIndexAtOffset(6),1),t.strictEqual(e.findTokenIndexAtOffset(7),1),t.strictEqual(e.findTokenIndexAtOffset(8),1),t.strictEqual(e.findTokenIndexAtOffset(9),1),t.strictEqual(e.findTokenIndexAtOffset(10),1),t.strictEqual(e.findTokenIndexAtOffset(11),1),t.strictEqual(e.findTokenIndexAtOffset(12),1),t.strictEqual(e.findTokenIndexAtOffset(13),2),t.strictEqual(e.findTokenIndexAtOffset(14),2),t.strictEqual(e.findTokenIndexAtOffset(15),2),t.strictEqual(e.findTokenIndexAtOffset(16),2),t.strictEqual(e.findTokenIndexAtOffset(17),2),t.strictEqual(e.findTokenIndexAtOffset(18),3),t.strictEqual(e.findTokenIndexAtOffset(19),3),t.strictEqual(e.findTokenIndexAtOffset(20),3),t.strictEqual(e.findTokenIndexAtOffset(21),4),t.strictEqual(e.findTokenIndexAtOffset(22),4),t.strictEqual(e.findTokenIndexAtOffset(23),5),t.strictEqual(e.findTokenIndexAtOffset(24),5),t.strictEqual(e.findTokenIndexAtOffset(25),5),t.strictEqual(e.findTokenIndexAtOffset(26),5),t.strictEqual(e.findTokenIndexAtOffset(27),5),t.strictEqual(e.findTokenIndexAtOffset(28),5),t.strictEqual(e.findTokenIndexAtOffset(29),5),t.strictEqual(e.findTokenIndexAtOffset(30),6),t.strictEqual(e.findTokenIndexAtOffset(31),6),t.strictEqual(e.findTokenIndexAtOffset(32),6),t.strictEqual(e.findTokenIndexAtOffset(33),6),t.strictEqual(e.findTokenIndexAtOffset(34),6)});function r(e,n){const f=[];for(let d=0,o=e.getCount();d<o;d++)f[d]={endIndex:e.getEndOffset(d),foreground:e.getForeground(d)};t.deepStrictEqual(f,n)}test("inflate",()=>{const e=s();r(e.inflate(),[{endIndex:6,foreground:1},{endIndex:13,foreground:2},{endIndex:18,foreground:3},{endIndex:21,foreground:4},{endIndex:23,foreground:5},{endIndex:30,foreground:6},{endIndex:33,foreground:7}])}),test("sliceAndInflate",()=>{const e=s();r(e.sliceAndInflate(0,33,0),[{endIndex:6,foreground:1},{endIndex:13,foreground:2},{endIndex:18,foreground:3},{endIndex:21,foreground:4},{endIndex:23,foreground:5},{endIndex:30,foreground:6},{endIndex:33,foreground:7}]),r(e.sliceAndInflate(0,32,0),[{endIndex:6,foreground:1},{endIndex:13,foreground:2},{endIndex:18,foreground:3},{endIndex:21,foreground:4},{endIndex:23,foreground:5},{endIndex:30,foreground:6},{endIndex:32,foreground:7}]),r(e.sliceAndInflate(0,30,0),[{endIndex:6,foreground:1},{endIndex:13,foreground:2},{endIndex:18,foreground:3},{endIndex:21,foreground:4},{endIndex:23,foreground:5},{endIndex:30,foreground:6}]),r(e.sliceAndInflate(0,30,1),[{endIndex:7,foreground:1},{endIndex:14,foreground:2},{endIndex:19,foreground:3},{endIndex:22,foreground:4},{endIndex:24,foreground:5},{endIndex:31,foreground:6}]),r(e.sliceAndInflate(6,18,0),[{endIndex:7,foreground:2},{endIndex:12,foreground:3}]),r(e.sliceAndInflate(7,18,0),[{endIndex:6,foreground:2},{endIndex:11,foreground:3}]),r(e.sliceAndInflate(6,17,0),[{endIndex:7,foreground:2},{endIndex:11,foreground:3}]),r(e.sliceAndInflate(6,19,0),[{endIndex:7,foreground:2},{endIndex:12,foreground:3},{endIndex:13,foreground:4}])})});
