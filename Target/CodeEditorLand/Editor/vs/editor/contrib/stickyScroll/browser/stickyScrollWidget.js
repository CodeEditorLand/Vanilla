import*as p from"../../../../base/browser/dom.js";import{createTrustedTypesPolicy as H}from"../../../../base/browser/trustedTypes.js";import{equals as f}from"../../../../base/common/arrays.js";import{Disposable as W,DisposableStore as F}from"../../../../base/common/lifecycle.js";import{ThemeIcon as M}from"../../../../base/common/themables.js";import"./stickyScroll.css";import{OverlayWidgetPositionPreference as R}from"../../../browser/editorBrowser.js";import{getColumnOfNodeOffset as w}from"../../../browser/viewParts/viewLines/viewLine.js";import{EmbeddedCodeEditorWidget as O}from"../../../browser/widget/codeEditor/embeddedCodeEditorWidget.js";import{EditorOption as m,RenderLineNumbersType as L}from"../../../common/config/editorOptions.js";import{Position as S}from"../../../common/core/position.js";import{StringBuilder as P}from"../../../common/core/stringBuilder.js";import{LineDecoration as A}from"../../../common/viewLayout/lineDecorations.js";import{RenderLineInput as $,renderViewLine as V}from"../../../common/viewLayout/viewLineRenderer.js";import{foldingCollapsedIcon as Z,foldingExpandedIcon as G}from"../../folding/browser/foldingDecorations.js";import"../../folding/browser/foldingModel.js";class k{constructor(d,e,i,t=null){this.startLineNumbers=d;this.endLineNumbers=e;this.lastLineRelativePosition=i;this.showEndForLine=t}equals(d){return!!d&&this.lastLineRelativePosition===d.lastLineRelativePosition&&this.showEndForLine===d.showEndForLine&&f(this.startLineNumbers,d.startLineNumbers)&&f(this.endLineNumbers,d.endLineNumbers)}static get Empty(){return new k([],[],0)}}const v=H("stickyScrollViewLayer",{createHTML:g=>g}),N="data-sticky-line-index",I="data-sticky-is-line",K="data-sticky-is-line-number",D="data-sticky-is-folding-icon";class pe extends W{constructor(e){super();this._editor=e;this._lineNumbersDomNode.className="sticky-widget-line-numbers",this._lineNumbersDomNode.setAttribute("role","none"),this._linesDomNode.className="sticky-widget-lines",this._linesDomNode.setAttribute("role","list"),this._linesDomNodeScrollable.className="sticky-widget-lines-scrollable",this._linesDomNodeScrollable.appendChild(this._linesDomNode),this._rootDomNode.className="sticky-widget",this._rootDomNode.classList.toggle("peek",e instanceof O),this._rootDomNode.appendChild(this._lineNumbersDomNode),this._rootDomNode.appendChild(this._linesDomNodeScrollable);const i=()=>{this._linesDomNode.style.left=this._editor.getOption(m.stickyScroll).scrollWithEditor?`-${this._editor.getScrollLeft()}px`:"0px"};this._register(this._editor.onDidChangeConfiguration(t=>{t.hasChanged(m.stickyScroll)&&i(),t.hasChanged(m.lineHeight)&&(this._lineHeight=this._editor.getOption(m.lineHeight))})),this._register(this._editor.onDidScrollChange(t=>{t.scrollLeftChanged&&i(),t.scrollWidthChanged&&this._updateWidgetWidth()})),this._register(this._editor.onDidChangeModel(()=>{i(),this._updateWidgetWidth()})),this._register(this._foldingIconStore),i(),this._register(this._editor.onDidLayoutChange(t=>{this._updateWidgetWidth()})),this._updateWidgetWidth()}_foldingIconStore=new F;_rootDomNode=document.createElement("div");_lineNumbersDomNode=document.createElement("div");_linesDomNodeScrollable=document.createElement("div");_linesDomNode=document.createElement("div");_previousState;_lineHeight=this._editor.getOption(m.lineHeight);_renderedStickyLines=[];_lineNumbers=[];_lastLineRelativePosition=0;_minContentWidthInPx=0;_isOnGlyphMargin=!1;get lineNumbers(){return this._lineNumbers}get lineNumberCount(){return this._lineNumbers.length}getRenderedStickyLine(e){return this._renderedStickyLines.find(i=>i.lineNumber===e)}getCurrentLines(){return this._lineNumbers}setState(e,i,t){if(t===void 0&&(!this._previousState&&!e||this._previousState&&this._previousState.equals(e)))return;const n=this._isWidgetHeightZero(e),r=n?void 0:e,s=n?0:this._findLineToRebuildWidgetFrom(e,t);this._renderRootNode(r,i,s),this._previousState=e}_isWidgetHeightZero(e){if(!e)return!0;const i=e.startLineNumbers.length*this._lineHeight+e.lastLineRelativePosition;if(i>0){this._lastLineRelativePosition=e.lastLineRelativePosition;const t=[...e.startLineNumbers];e.showEndForLine!==null&&(t[e.showEndForLine]=e.endLineNumbers[e.showEndForLine]),this._lineNumbers=t}else this._lastLineRelativePosition=0,this._lineNumbers=[];return i===0}_findLineToRebuildWidgetFrom(e,i){if(!e||!this._previousState)return 0;if(i!==void 0)return i;const t=this._previousState,n=e.startLineNumbers.findIndex(r=>!t.startLineNumbers.includes(r));return n===-1?0:n}_updateWidgetWidth(){const e=this._editor.getLayoutInfo(),i=e.contentLeft;this._lineNumbersDomNode.style.width=`${i}px`,this._linesDomNodeScrollable.style.setProperty("--vscode-editorStickyScroll-scrollableWidth",`${this._editor.getScrollWidth()-e.verticalScrollbarWidth}px`),this._rootDomNode.style.width=`${e.width-e.verticalScrollbarWidth}px`}_clearStickyLinesFromLine(e){this._foldingIconStore.clear();for(let i=e;i<this._renderedStickyLines.length;i++){const t=this._renderedStickyLines[i];t.lineNumberDomNode.remove(),t.lineDomNode.remove()}this._renderedStickyLines=this._renderedStickyLines.slice(0,e),this._rootDomNode.style.display="none"}_useFoldingOpacityTransition(e){this._lineNumbersDomNode.style.setProperty("--vscode-editorStickyScroll-foldingOpacityTransition",`opacity ${e?.5:0}s`)}_setFoldingIconsVisibility(e){for(const i of this._renderedStickyLines){const t=i.foldingIcon;t&&t.setVisible(e?!0:t.isCollapsed)}}async _renderRootNode(e,i,t){if(this._clearStickyLinesFromLine(t),!e)return;for(const o of this._renderedStickyLines)this._updateTopAndZIndexOfStickyLine(o);const n=this._editor.getLayoutInfo(),r=this._lineNumbers.slice(t);for(const[o,c]of r.entries()){const l=this._renderChildNode(o+t,c,i,n);l&&(this._linesDomNode.appendChild(l.lineDomNode),this._lineNumbersDomNode.appendChild(l.lineNumberDomNode),this._renderedStickyLines.push(l))}i&&(this._setFoldingHoverListeners(),this._useFoldingOpacityTransition(!this._isOnGlyphMargin));const s=this._lineNumbers.length*this._lineHeight+this._lastLineRelativePosition;this._rootDomNode.style.display="block",this._lineNumbersDomNode.style.height=`${s}px`,this._linesDomNodeScrollable.style.height=`${s}px`,this._rootDomNode.style.height=`${s}px`,this._rootDomNode.style.marginLeft="0px",this._minContentWidthInPx=Math.max(...this._renderedStickyLines.map(o=>o.scrollWidth))+n.verticalScrollbarWidth,this._editor.layoutOverlayWidget(this)}_setFoldingHoverListeners(){this._editor.getOption(m.showFoldingControls)==="mouseover"&&(this._foldingIconStore.add(p.addDisposableListener(this._lineNumbersDomNode,p.EventType.MOUSE_ENTER,()=>{this._isOnGlyphMargin=!0,this._setFoldingIconsVisibility(!0)})),this._foldingIconStore.add(p.addDisposableListener(this._lineNumbersDomNode,p.EventType.MOUSE_LEAVE,()=>{this._isOnGlyphMargin=!1,this._useFoldingOpacityTransition(!0),this._setFoldingIconsVisibility(!1)})))}_renderChildNode(e,i,t,n){const r=this._editor._getViewModel();if(!r)return;const s=r.coordinatesConverter.convertModelPositionToViewPosition(new S(i,1)).lineNumber,o=r.getViewLineRenderingData(s),c=this._editor.getOption(m.lineNumbers);let l;try{l=A.filter(o.inlineDecorations,s,o.minColumn,o.maxColumn)}catch{l=[]}const T=new $(!0,!0,o.content,o.continuesWithWrappedLine,o.isBasicASCII,o.containsRTL,0,o.tokens,l,o.tabSize,o.startVisibleColumn,1,1,1,500,"none",!0,!0,null),_=new P(2e3),C=V(T,_);let b;v?b=v.createHTML(_.build()):b=_.build();const a=document.createElement("span");a.setAttribute(N,String(e)),a.setAttribute(I,""),a.setAttribute("role","listitem"),a.tabIndex=0,a.className="sticky-line-content",a.classList.add(`stickyLine${i}`),a.style.lineHeight=`${this._lineHeight}px`,a.innerHTML=b;const u=document.createElement("span");u.setAttribute(N,String(e)),u.setAttribute(K,""),u.className="sticky-line-number",u.style.lineHeight=`${this._lineHeight}px`;const E=n.contentLeft;u.style.width=`${E}px`;const h=document.createElement("span");c.renderType===L.On||c.renderType===L.Interval&&i%10===0?h.innerText=i.toString():c.renderType===L.Relative&&(h.innerText=Math.abs(i-this._editor.getPosition().lineNumber).toString()),h.className="sticky-line-number-inner",h.style.lineHeight=`${this._lineHeight}px`,h.style.width=`${n.lineNumbersWidth}px`,h.style.paddingLeft=`${n.lineNumbersLeft}px`,u.appendChild(h);const y=this._renderFoldingIconForLine(t,i);y&&u.appendChild(y.domNode),this._editor.applyFontInfo(a),this._editor.applyFontInfo(h),u.style.lineHeight=`${this._lineHeight}px`,a.style.lineHeight=`${this._lineHeight}px`,u.style.height=`${this._lineHeight}px`,a.style.height=`${this._lineHeight}px`;const x=new Y(e,i,a,u,y,C.characterMapping,a.scrollWidth);return this._updateTopAndZIndexOfStickyLine(x)}_updateTopAndZIndexOfStickyLine(e){const i=e.index,t=e.lineDomNode,n=e.lineNumberDomNode,r=i===this._lineNumbers.length-1,s="0",o="1";t.style.zIndex=r?s:o,n.style.zIndex=r?s:o;const c=`${i*this._lineHeight+this._lastLineRelativePosition+(e.foldingIcon?.isCollapsed?1:0)}px`,l=`${i*this._lineHeight}px`;return t.style.top=r?c:l,n.style.top=r?c:l,e}_renderFoldingIconForLine(e,i){const t=this._editor.getOption(m.showFoldingControls);if(!e||t==="never")return;const n=e.regions,r=n.findRange(i),s=n.getStartLineNumber(r);if(!(i===s))return;const c=n.isCollapsed(r),l=new q(c,s,n.getEndLineNumber(r),this._lineHeight);return l.setVisible(this._isOnGlyphMargin?!0:c||t==="always"),l.domNode.setAttribute(D,""),l}getId(){return"editor.contrib.stickyScrollWidget"}getDomNode(){return this._rootDomNode}getPosition(){return{preference:R.TOP_CENTER,stackOridinal:10}}getMinContentWidthInPx(){return this._minContentWidthInPx}focusLineWithIndex(e){0<=e&&e<this._renderedStickyLines.length&&this._renderedStickyLines[e].lineDomNode.focus()}getEditorPositionFromNode(e){if(!e||e.children.length>0)return null;const i=this._getRenderedStickyLineFromChildDomNode(e);if(!i)return null;const t=w(i.characterMapping,e,0);return new S(i.lineNumber,t)}getLineNumberFromChildDomNode(e){return this._getRenderedStickyLineFromChildDomNode(e)?.lineNumber??null}_getRenderedStickyLineFromChildDomNode(e){const i=this.getLineIndexFromChildDomNode(e);return i===null||i<0||i>=this._renderedStickyLines.length?null:this._renderedStickyLines[i]}getLineIndexFromChildDomNode(e){const i=this._getAttributeValue(e,N);return i?parseInt(i,10):null}isInStickyLine(e){return this._getAttributeValue(e,I)!==void 0}isInFoldingIconDomNode(e){return this._getAttributeValue(e,D)!==void 0}_getAttributeValue(e,i){for(;e&&e!==this._rootDomNode;){const t=e.getAttribute(i);if(t!==null)return t;e=e.parentElement}}}class Y{constructor(d,e,i,t,n,r,s){this.index=d;this.lineNumber=e;this.lineDomNode=i;this.lineNumberDomNode=t;this.foldingIcon=n;this.characterMapping=r;this.scrollWidth=s}}class q{constructor(d,e,i,t){this.isCollapsed=d;this.foldingStartLine=e;this.foldingEndLine=i;this.dimension=t;this.domNode=document.createElement("div"),this.domNode.style.width=`${t}px`,this.domNode.style.height=`${t}px`,this.domNode.className=M.asClassName(d?Z:G)}domNode;setVisible(d){this.domNode.style.cursor=d?"pointer":"default",this.domNode.style.opacity=d?"1":"0"}}export{pe as StickyScrollWidget,k as StickyScrollWidgetState};
