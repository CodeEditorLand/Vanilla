import{Emitter as m}from"../../../../base/common/event.js";import{hash as h}from"../../../../base/common/hash.js";import"../../../common/model.js";import"./folding.js";import{FoldingRegions as d,FoldSource as c}from"./foldingRanges.js";class A{_textModel;_decorationProvider;_regions;_editorDecorationIds;_updateEventEmitter=new m;onDidChange=this._updateEventEmitter.event;get regions(){return this._regions}get textModel(){return this._textModel}get decorationProvider(){return this._decorationProvider}constructor(n,e){this._textModel=n,this._decorationProvider=e,this._regions=new d(new Uint32Array(0),new Uint32Array(0)),this._editorDecorationIds=[]}toggleCollapseState(n){if(!n.length)return;n=n.sort((o,t)=>o.regionIndex-t.regionIndex);const e={};this._decorationProvider.changeDecorations(o=>{let t=0,r=-1,i=-1;const l=g=>{for(;t<g;){const a=this._regions.getEndLineNumber(t),u=this._regions.isCollapsed(t);if(a<=r){const p=this.regions.getSource(t)!==c.provider;o.changeDecorationOptions(this._editorDecorationIds[t],this._decorationProvider.getDecorationOption(u,a<=i,p))}u&&a>i&&(i=a),t++}};for(const g of n){const a=g.regionIndex,u=this._editorDecorationIds[a];if(u&&!e[u]){e[u]=!0,l(a);const p=!this._regions.isCollapsed(a);this._regions.setCollapsed(a,p),r=Math.max(r,this._regions.getEndLineNumber(a))}}l(this._regions.length)}),this._updateEventEmitter.fire({model:this,collapseStateChanged:n})}removeManualRanges(n){const e=new Array,o=t=>{for(const r of n)if(!(r.startLineNumber>t.endLineNumber||t.startLineNumber>r.endLineNumber))return!0;return!1};for(let t=0;t<this._regions.length;t++){const r=this._regions.toFoldRange(t);(r.source===c.provider||!o(r))&&e.push(r)}this.updatePost(d.fromFoldRanges(e))}update(n,e){const o=this._currentFoldedOrManualRanges(e),t=d.sanitizeAndMerge(n,o,this._textModel.getLineCount(),e);this.updatePost(d.fromFoldRanges(t))}updatePost(n){const e=[];let o=-1;for(let t=0,r=n.length;t<r;t++){const i=n.getStartLineNumber(t),l=n.getEndLineNumber(t),g=n.isCollapsed(t),a=n.getSource(t)!==c.provider,u={startLineNumber:i,startColumn:this._textModel.getLineMaxColumn(i),endLineNumber:l,endColumn:this._textModel.getLineMaxColumn(l)+1};e.push({range:u,options:this._decorationProvider.getDecorationOption(g,l<=o,a)}),g&&l>o&&(o=l)}this._decorationProvider.changeDecorations(t=>this._editorDecorationIds=t.deltaDecorations(this._editorDecorationIds,e)),this._regions=n,this._updateEventEmitter.fire({model:this})}_currentFoldedOrManualRanges(n){const e=[];for(let o=0,t=this._regions.length;o<t;o++){let r=this.regions.isCollapsed(o);const i=this.regions.getSource(o);if(r||i!==c.provider){const l=this._regions.toFoldRange(o),g=this._textModel.getDecorationRange(this._editorDecorationIds[o]);g&&(r&&n?.startsInside(g.startLineNumber+1,g.endLineNumber)&&(r=!1),e.push({startLineNumber:g.startLineNumber,endLineNumber:g.endLineNumber,type:l.type,isCollapsed:r,source:i}))}}return e}getMemento(){const n=this._currentFoldedOrManualRanges(),e=[],o=this._textModel.getLineCount();for(let t=0,r=n.length;t<r;t++){const i=n[t];if(i.startLineNumber>=i.endLineNumber||i.startLineNumber<1||i.endLineNumber>o)continue;const l=this._getLinesChecksum(i.startLineNumber+1,i.endLineNumber);e.push({startLineNumber:i.startLineNumber,endLineNumber:i.endLineNumber,isCollapsed:i.isCollapsed,source:i.source,checksum:l})}return e.length>0?e:void 0}applyMemento(n){if(!Array.isArray(n))return;const e=[],o=this._textModel.getLineCount();for(const r of n){if(r.startLineNumber>=r.endLineNumber||r.startLineNumber<1||r.endLineNumber>o)continue;const i=this._getLinesChecksum(r.startLineNumber+1,r.endLineNumber);(!r.checksum||i===r.checksum)&&e.push({startLineNumber:r.startLineNumber,endLineNumber:r.endLineNumber,type:void 0,isCollapsed:r.isCollapsed??!0,source:r.source??c.provider})}const t=d.sanitizeAndMerge(this._regions,e,o);this.updatePost(d.fromFoldRanges(t))}_getLinesChecksum(n,e){return h(this._textModel.getLineContent(n)+this._textModel.getLineContent(e))%1e6}dispose(){this._decorationProvider.removeDecorations(this._editorDecorationIds)}getAllRegionsAtLine(n,e){const o=[];if(this._regions){let t=this._regions.findRange(n),r=1;for(;t>=0;){const i=this._regions.toRegion(t);(!e||e(i,r))&&o.push(i),r++,t=i.parentIndex}}return o}getRegionAtLine(n){if(this._regions){const e=this._regions.findRange(n);if(e>=0)return this._regions.toRegion(e)}return null}getRegionsInside(n,e){const o=[],t=n?n.regionIndex+1:0,r=n?n.endLineNumber:Number.MAX_VALUE;if(e&&e.length===2){const i=[];for(let l=t,g=this._regions.length;l<g;l++){const a=this._regions.toRegion(l);if(this._regions.getStartLineNumber(l)<r){for(;i.length>0&&!a.containedBy(i[i.length-1]);)i.pop();i.push(a),e(a,i.length)&&o.push(a)}else break}}else for(let i=t,l=this._regions.length;i<l;i++){const g=this._regions.toRegion(i);if(this._regions.getStartLineNumber(i)<r)(!e||e(g))&&o.push(g);else break}return o}}function y(s,n,e){const o=[];for(const t of e){const r=s.getRegionAtLine(t);if(r){const i=!r.isCollapsed;if(o.push(r),n>1){const l=s.getRegionsInside(r,(g,a)=>g.isCollapsed!==i&&a<n);o.push(...l)}}}s.toggleCollapseState(o)}function E(s,n,e=Number.MAX_VALUE,o){const t=[];if(o&&o.length>0)for(const r of o){const i=s.getRegionAtLine(r);if(i&&(i.isCollapsed!==n&&t.push(i),e>1)){const l=s.getRegionsInside(i,(g,a)=>g.isCollapsed!==n&&a<e);t.push(...l)}}else{const r=s.getRegionsInside(null,(i,l)=>i.isCollapsed!==n&&l<e);t.push(...r)}s.toggleCollapseState(t)}function P(s,n,e,o){const t=[];for(const r of o){const i=s.getAllRegionsAtLine(r,(l,g)=>l.isCollapsed!==n&&g<=e);t.push(...i)}s.toggleCollapseState(t)}function T(s,n,e){const o=[];for(const t of e){const r=s.getAllRegionsAtLine(t,i=>i.isCollapsed!==n);r.length>0&&o.push(r[0])}s.toggleCollapseState(o)}function k(s,n,e,o){const t=(i,l)=>l===n&&i.isCollapsed!==e&&!o.some(g=>i.containsLine(g)),r=s.getRegionsInside(null,t);s.toggleCollapseState(r)}function w(s,n,e){const o=[];for(const i of e){const l=s.getAllRegionsAtLine(i,void 0);l.length>0&&o.push(l[0])}const t=i=>o.every(l=>!l.containedBy(i)&&!i.containedBy(l))&&i.isCollapsed!==n,r=s.getRegionsInside(null,t);s.toggleCollapseState(r)}function O(s,n,e){const o=s.textModel,t=s.regions,r=[];for(let i=t.length-1;i>=0;i--)if(e!==t.isCollapsed(i)){const l=t.getStartLineNumber(i);n.test(o.getLineContent(l))&&r.push(t.toRegion(i))}s.toggleCollapseState(r)}function U(s,n,e){const o=s.regions,t=[];for(let r=o.length-1;r>=0;r--)e!==o.isCollapsed(r)&&n===o.getType(r)&&t.push(o.toRegion(r));s.toggleCollapseState(t)}function B(s,n){let e=null;const o=n.getRegionAtLine(s);if(o!==null&&(e=o.startLineNumber,s===e)){const t=o.parentIndex;t!==-1?e=n.regions.getStartLineNumber(t):e=null}return e}function H(s,n){let e=n.getRegionAtLine(s);if(e!==null&&e.startLineNumber===s){if(s!==e.startLineNumber)return e.startLineNumber;{const o=e.parentIndex;let t=0;for(o!==-1&&(t=n.regions.getStartLineNumber(e.parentIndex));e!==null;)if(e.regionIndex>0){if(e=n.regions.toRegion(e.regionIndex-1),e.startLineNumber<=t)return null;if(e.parentIndex===o)return e.startLineNumber}else return null}}else if(n.regions.length>0)for(e=n.regions.toRegion(n.regions.length-1);e!==null;){if(e.startLineNumber<s)return e.startLineNumber;e.regionIndex>0?e=n.regions.toRegion(e.regionIndex-1):e=null}return null}function z(s,n){let e=n.getRegionAtLine(s);if(e!==null&&e.startLineNumber===s){const o=e.parentIndex;let t=0;if(o!==-1)t=n.regions.getEndLineNumber(e.parentIndex);else{if(n.regions.length===0)return null;t=n.regions.getEndLineNumber(n.regions.length-1)}for(;e!==null;)if(e.regionIndex<n.regions.length){if(e=n.regions.toRegion(e.regionIndex+1),e.startLineNumber>=t)return null;if(e.parentIndex===o)return e.startLineNumber}else return null}else if(n.regions.length>0)for(e=n.regions.toRegion(0);e!==null;){if(e.startLineNumber>s)return e.startLineNumber;e.regionIndex<n.regions.length?e=n.regions.toRegion(e.regionIndex+1):e=null}return null}export{A as FoldingModel,z as getNextFoldLine,B as getParentFoldLine,H as getPreviousFoldLine,k as setCollapseStateAtLevel,O as setCollapseStateForMatchingLines,w as setCollapseStateForRest,U as setCollapseStateForType,E as setCollapseStateLevelsDown,P as setCollapseStateLevelsUp,T as setCollapseStateUp,y as toggleCollapseState};
