var X=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var z=(c,t,e,o)=>{for(var i=o>1?void 0:o?$(t,e):t,r=c.length-1,n;r>=0;r--)(n=c[r])&&(i=(o?n(t,e,i):n(i))||i);return o&&i&&X(t,e,i),i},W=(c,t)=>(e,o)=>t(e,o,c);import{status as j}from"../../../../base/browser/ui/aria/aria.js";import{RunOnceScheduler as q}from"../../../../base/common/async.js";import{KeyChord as J,KeyCode as p,KeyMod as d}from"../../../../base/common/keyCodes.js";import{Disposable as V,DisposableStore as Q}from"../../../../base/common/lifecycle.js";import{Constants as N}from"../../../../base/common/uint.js";import{EditorAction as M,EditorContributionInstantiation as B,registerEditorAction as m,registerEditorContribution as H}from"../../../browser/editorExtensions.js";import{EditorOption as C}from"../../../common/config/editorOptions.js";import{CursorChangeReason as y}from"../../../common/cursorEvents.js";import{CursorMoveCommands as K}from"../../../common/cursor/cursorMoveCommands.js";import{Range as O}from"../../../common/core/range.js";import{Selection as g}from"../../../common/core/selection.js";import{ScrollType as L}from"../../../common/editorCommon.js";import{EditorContextKeys as f}from"../../../common/editorContextKeys.js";import{CommonFindController as R}from"../../find/browser/findController.js";import{FindOptionOverride as F}from"../../find/browser/findState.js";import*as a from"../../../../nls.js";import{MenuId as w}from"../../../../platform/actions/common/actions.js";import{ContextKeyExpr as Y}from"../../../../platform/contextkey/common/contextkey.js";import{KeybindingWeight as b}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{ILanguageFeaturesService as Z}from"../../../common/services/languageFeatures.js";import{getSelectionHighlightDecorationOptions as ee}from"../../wordHighlighter/browser/highlightDecorations.js";import{IInstantiationService as te}from"../../../../platform/instantiation/common/instantiation.js";function _(c,t){const e=t.filter(o=>!c.find(i=>i.equals(o)));if(e.length>=1){const o=e.map(r=>`line ${r.viewState.position.lineNumber} column ${r.viewState.position.column}`).join(", "),i=e.length===1?a.localize("cursorAdded","Cursor added: {0}",o):a.localize("cursorsAdded","Cursors added: {0}",o);j(i)}}class oe extends M{constructor(){super({id:"editor.action.insertCursorAbove",label:a.localize("mutlicursor.insertAbove","Add Cursor Above"),alias:"Add Cursor Above",precondition:void 0,kbOpts:{kbExpr:f.editorTextFocus,primary:d.CtrlCmd|d.Alt|p.UpArrow,linux:{primary:d.Shift|d.Alt|p.UpArrow,secondary:[d.CtrlCmd|d.Shift|p.UpArrow]},weight:b.EditorContrib},menuOpts:{menuId:w.MenubarSelectionMenu,group:"3_multi",title:a.localize({key:"miInsertCursorAbove",comment:["&& denotes a mnemonic"]},"&&Add Cursor Above"),order:2}})}run(t,e,o){if(!e.hasModel())return;let i=!0;o&&o.logicalLine===!1&&(i=!1);const r=e._getViewModel();if(r.cursorConfig.readOnly)return;r.model.pushStackElement();const n=r.getCursorStates();r.setCursorStates(o.source,y.Explicit,K.addCursorUp(r,n,i)),r.revealTopMostCursor(o.source),_(n,r.getCursorStates())}}class ie extends M{constructor(){super({id:"editor.action.insertCursorBelow",label:a.localize("mutlicursor.insertBelow","Add Cursor Below"),alias:"Add Cursor Below",precondition:void 0,kbOpts:{kbExpr:f.editorTextFocus,primary:d.CtrlCmd|d.Alt|p.DownArrow,linux:{primary:d.Shift|d.Alt|p.DownArrow,secondary:[d.CtrlCmd|d.Shift|p.DownArrow]},weight:b.EditorContrib},menuOpts:{menuId:w.MenubarSelectionMenu,group:"3_multi",title:a.localize({key:"miInsertCursorBelow",comment:["&& denotes a mnemonic"]},"A&&dd Cursor Below"),order:3}})}run(t,e,o){if(!e.hasModel())return;let i=!0;o&&o.logicalLine===!1&&(i=!1);const r=e._getViewModel();if(r.cursorConfig.readOnly)return;r.model.pushStackElement();const n=r.getCursorStates();r.setCursorStates(o.source,y.Explicit,K.addCursorDown(r,n,i)),r.revealBottomMostCursor(o.source),_(n,r.getCursorStates())}}class re extends M{constructor(){super({id:"editor.action.insertCursorAtEndOfEachLineSelected",label:a.localize("mutlicursor.insertAtEndOfEachLineSelected","Add Cursors to Line Ends"),alias:"Add Cursors to Line Ends",precondition:void 0,kbOpts:{kbExpr:f.editorTextFocus,primary:d.Shift|d.Alt|p.KeyI,weight:b.EditorContrib},menuOpts:{menuId:w.MenubarSelectionMenu,group:"3_multi",title:a.localize({key:"miInsertCursorAtEndOfEachLineSelected",comment:["&& denotes a mnemonic"]},"Add C&&ursors to Line Ends"),order:4}})}getCursorsForSelection(t,e,o){if(!t.isEmpty()){for(let i=t.startLineNumber;i<t.endLineNumber;i++){const r=e.getLineMaxColumn(i);o.push(new g(i,r,i,r))}t.endColumn>1&&o.push(new g(t.endLineNumber,t.endColumn,t.endLineNumber,t.endColumn))}}run(t,e){if(!e.hasModel())return;const o=e.getModel(),i=e.getSelections(),r=e._getViewModel(),n=r.getCursorStates(),s=[];i.forEach(l=>this.getCursorsForSelection(l,o,s)),s.length>0&&e.setSelections(s),_(n,r.getCursorStates())}}class ne extends M{constructor(){super({id:"editor.action.addCursorsToBottom",label:a.localize("mutlicursor.addCursorsToBottom","Add Cursors To Bottom"),alias:"Add Cursors To Bottom",precondition:void 0})}run(t,e){if(!e.hasModel())return;const o=e.getSelections(),i=e.getModel().getLineCount(),r=[];for(let l=o[0].startLineNumber;l<=i;l++)r.push(new g(l,o[0].startColumn,l,o[0].endColumn));const n=e._getViewModel(),s=n.getCursorStates();r.length>0&&e.setSelections(r),_(s,n.getCursorStates())}}class se extends M{constructor(){super({id:"editor.action.addCursorsToTop",label:a.localize("mutlicursor.addCursorsToTop","Add Cursors To Top"),alias:"Add Cursors To Top",precondition:void 0})}run(t,e){if(!e.hasModel())return;const o=e.getSelections(),i=[];for(let s=o[0].startLineNumber;s>=1;s--)i.push(new g(s,o[0].startColumn,s,o[0].endColumn));const r=e._getViewModel(),n=r.getCursorStates();i.length>0&&e.setSelections(i),_(n,r.getCursorStates())}}class P{constructor(t,e,o){this.selections=t;this.revealRange=e;this.revealScrollType=o}}class I{constructor(t,e,o,i,r,n,s){this._editor=t;this.findController=e;this.isDisconnectedFromFindController=o;this.searchText=i;this.wholeWord=r;this.matchCase=n;this.currentMatch=s}static create(t,e){if(!t.hasModel())return null;const o=e.getState();if(!t.hasTextFocus()&&o.isRevealed&&o.searchString.length>0)return new I(t,e,!1,o.searchString,o.wholeWord,o.matchCase,null);let i=!1,r,n;const s=t.getSelections();s.length===1&&s[0].isEmpty()?(i=!0,r=!0,n=!0):(r=o.wholeWord,n=o.matchCase);const l=t.getSelection();let h,S=null;if(l.isEmpty()){const u=t.getConfiguredWordAtPosition(l.getStartPosition());if(!u)return null;h=u.word,S=new g(l.startLineNumber,u.startColumn,l.startLineNumber,u.endColumn)}else h=t.getModel().getValueInRange(l).replace(/\r\n/g,`
`);return new I(t,e,i,h,r,n,S)}addSelectionToNextFindMatch(){if(!this._editor.hasModel())return null;const t=this._getNextMatch();if(!t)return null;const e=this._editor.getSelections();return new P(e.concat(t),t,L.Smooth)}moveSelectionToNextFindMatch(){if(!this._editor.hasModel())return null;const t=this._getNextMatch();if(!t)return null;const e=this._editor.getSelections();return new P(e.slice(0,e.length-1).concat(t),t,L.Smooth)}_getNextMatch(){if(!this._editor.hasModel())return null;if(this.currentMatch){const i=this.currentMatch;return this.currentMatch=null,i}this.findController.highlightFindOptions();const t=this._editor.getSelections(),e=t[t.length-1],o=this._editor.getModel().findNextMatch(this.searchText,e.getEndPosition(),!1,this.matchCase,this.wholeWord?this._editor.getOption(C.wordSeparators):null,!1);return o?new g(o.range.startLineNumber,o.range.startColumn,o.range.endLineNumber,o.range.endColumn):null}addSelectionToPreviousFindMatch(){if(!this._editor.hasModel())return null;const t=this._getPreviousMatch();if(!t)return null;const e=this._editor.getSelections();return new P(e.concat(t),t,L.Smooth)}moveSelectionToPreviousFindMatch(){if(!this._editor.hasModel())return null;const t=this._getPreviousMatch();if(!t)return null;const e=this._editor.getSelections();return new P(e.slice(0,e.length-1).concat(t),t,L.Smooth)}_getPreviousMatch(){if(!this._editor.hasModel())return null;if(this.currentMatch){const i=this.currentMatch;return this.currentMatch=null,i}this.findController.highlightFindOptions();const t=this._editor.getSelections(),e=t[t.length-1],o=this._editor.getModel().findPreviousMatch(this.searchText,e.getStartPosition(),!1,this.matchCase,this.wholeWord?this._editor.getOption(C.wordSeparators):null,!1);return o?new g(o.range.startLineNumber,o.range.startColumn,o.range.endLineNumber,o.range.endColumn):null}selectAll(t){if(!this._editor.hasModel())return[];this.findController.highlightFindOptions();const e=this._editor.getModel();return t?e.findMatches(this.searchText,t,!1,this.matchCase,this.wholeWord?this._editor.getOption(C.wordSeparators):null,!1,N.MAX_SAFE_SMALL_INTEGER):e.findMatches(this.searchText,!0,!1,this.matchCase,this.wholeWord?this._editor.getOption(C.wordSeparators):null,!1,N.MAX_SAFE_SMALL_INTEGER)}}class A extends V{static ID="editor.contrib.multiCursorController";_editor;_ignoreSelectionChange;_session;_sessionDispose=this._register(new Q);static get(t){return t.getContribution(A.ID)}constructor(t){super(),this._editor=t,this._ignoreSelectionChange=!1,this._session=null}dispose(){this._endSession(),super.dispose()}_beginSessionIfNeeded(t){if(!this._session){const e=I.create(this._editor,t);if(!e)return;this._session=e;const o={searchString:this._session.searchText};this._session.isDisconnectedFromFindController&&(o.wholeWordOverride=F.True,o.matchCaseOverride=F.True,o.isRegexOverride=F.False),t.getState().change(o,!1),this._sessionDispose.add(this._editor.onDidChangeCursorSelection(i=>{this._ignoreSelectionChange||this._endSession()})),this._sessionDispose.add(this._editor.onDidBlurEditorText(()=>{this._endSession()})),this._sessionDispose.add(t.getState().onFindReplaceStateChange(i=>{(i.matchCase||i.wholeWord)&&this._endSession()}))}}_endSession(){if(this._sessionDispose.clear(),this._session&&this._session.isDisconnectedFromFindController){const t={wholeWordOverride:F.NotSet,matchCaseOverride:F.NotSet,isRegexOverride:F.NotSet};this._session.findController.getState().change(t,!1)}this._session=null}_setSelections(t){this._ignoreSelectionChange=!0,this._editor.setSelections(t),this._ignoreSelectionChange=!1}_expandEmptyToWord(t,e){if(!e.isEmpty())return e;const o=this._editor.getConfiguredWordAtPosition(e.getStartPosition());return o?new g(e.startLineNumber,o.startColumn,e.startLineNumber,o.endColumn):e}_applySessionResult(t){t&&(this._setSelections(t.selections),t.revealRange&&this._editor.revealRangeInCenterIfOutsideViewport(t.revealRange,t.revealScrollType))}getSession(t){return this._session}addSelectionToNextFindMatch(t){if(this._editor.hasModel()){if(!this._session){const e=this._editor.getSelections();if(e.length>1){const i=t.getState().matchCase;if(!U(this._editor.getModel(),e,i)){const n=this._editor.getModel(),s=[];for(let l=0,h=e.length;l<h;l++)s[l]=this._expandEmptyToWord(n,e[l]);this._editor.setSelections(s);return}}}this._beginSessionIfNeeded(t),this._session&&this._applySessionResult(this._session.addSelectionToNextFindMatch())}}addSelectionToPreviousFindMatch(t){this._beginSessionIfNeeded(t),this._session&&this._applySessionResult(this._session.addSelectionToPreviousFindMatch())}moveSelectionToNextFindMatch(t){this._beginSessionIfNeeded(t),this._session&&this._applySessionResult(this._session.moveSelectionToNextFindMatch())}moveSelectionToPreviousFindMatch(t){this._beginSessionIfNeeded(t),this._session&&this._applySessionResult(this._session.moveSelectionToPreviousFindMatch())}selectAll(t){if(!this._editor.hasModel())return;let e=null;const o=t.getState();if(o.isRevealed&&o.searchString.length>0&&o.isRegex){const i=this._editor.getModel();o.searchScope?e=i.findMatches(o.searchString,o.searchScope,o.isRegex,o.matchCase,o.wholeWord?this._editor.getOption(C.wordSeparators):null,!1,N.MAX_SAFE_SMALL_INTEGER):e=i.findMatches(o.searchString,!0,o.isRegex,o.matchCase,o.wholeWord?this._editor.getOption(C.wordSeparators):null,!1,N.MAX_SAFE_SMALL_INTEGER)}else{if(this._beginSessionIfNeeded(t),!this._session)return;e=this._session.selectAll(o.searchScope)}if(e.length>0){const i=this._editor.getSelection();for(let r=0,n=e.length;r<n;r++){const s=e[r];if(s.range.intersectRanges(i)){e[r]=e[0],e[0]=s;break}}this._setSelections(e.map(r=>new g(r.range.startLineNumber,r.range.startColumn,r.range.endLineNumber,r.range.endColumn)))}}selectAllUsingSelections(t){t.length>0&&this._setSelections(t)}}class T extends M{run(t,e){const o=A.get(e);if(!o)return;const i=e._getViewModel();if(i){const r=i.getCursorStates(),n=R.get(e);if(n)this._run(o,n);else{const s=t.get(te).createInstance(R,e);this._run(o,s),s.dispose()}_(r,i.getCursorStates())}}}class le extends T{constructor(){super({id:"editor.action.addSelectionToNextFindMatch",label:a.localize("addSelectionToNextFindMatch","Add Selection To Next Find Match"),alias:"Add Selection To Next Find Match",precondition:void 0,kbOpts:{kbExpr:f.focus,primary:d.CtrlCmd|p.KeyD,weight:b.EditorContrib},menuOpts:{menuId:w.MenubarSelectionMenu,group:"3_multi",title:a.localize({key:"miAddSelectionToNextFindMatch",comment:["&& denotes a mnemonic"]},"Add &&Next Occurrence"),order:5}})}_run(t,e){t.addSelectionToNextFindMatch(e)}}class ce extends T{constructor(){super({id:"editor.action.addSelectionToPreviousFindMatch",label:a.localize("addSelectionToPreviousFindMatch","Add Selection To Previous Find Match"),alias:"Add Selection To Previous Find Match",precondition:void 0,menuOpts:{menuId:w.MenubarSelectionMenu,group:"3_multi",title:a.localize({key:"miAddSelectionToPreviousFindMatch",comment:["&& denotes a mnemonic"]},"Add P&&revious Occurrence"),order:6}})}_run(t,e){t.addSelectionToPreviousFindMatch(e)}}class ae extends T{constructor(){super({id:"editor.action.moveSelectionToNextFindMatch",label:a.localize("moveSelectionToNextFindMatch","Move Last Selection To Next Find Match"),alias:"Move Last Selection To Next Find Match",precondition:void 0,kbOpts:{kbExpr:f.focus,primary:J(d.CtrlCmd|p.KeyK,d.CtrlCmd|p.KeyD),weight:b.EditorContrib}})}_run(t,e){t.moveSelectionToNextFindMatch(e)}}class de extends T{constructor(){super({id:"editor.action.moveSelectionToPreviousFindMatch",label:a.localize("moveSelectionToPreviousFindMatch","Move Last Selection To Previous Find Match"),alias:"Move Last Selection To Previous Find Match",precondition:void 0})}_run(t,e){t.moveSelectionToPreviousFindMatch(e)}}class ue extends T{constructor(){super({id:"editor.action.selectHighlights",label:a.localize("selectAllOccurrencesOfFindMatch","Select All Occurrences of Find Match"),alias:"Select All Occurrences of Find Match",precondition:void 0,kbOpts:{kbExpr:f.focus,primary:d.CtrlCmd|d.Shift|p.KeyL,weight:b.EditorContrib},menuOpts:{menuId:w.MenubarSelectionMenu,group:"3_multi",title:a.localize({key:"miSelectHighlights",comment:["&& denotes a mnemonic"]},"Select All &&Occurrences"),order:7}})}_run(t,e){t.selectAll(e)}}class he extends T{constructor(){super({id:"editor.action.changeAll",label:a.localize("changeAll.label","Change All Occurrences"),alias:"Change All Occurrences",precondition:Y.and(f.writable,f.editorTextFocus),kbOpts:{kbExpr:f.editorTextFocus,primary:d.CtrlCmd|p.F2,weight:b.EditorContrib},contextMenuOpts:{group:"1_modification",order:1.2}})}_run(t,e){t.selectAll(e)}}class Se{constructor(t,e,o,i,r){this._model=t;this._searchText=e;this._matchCase=o;this._wordSeparators=i;r&&this._model===r._model&&this._searchText===r._searchText&&this._matchCase===r._matchCase&&this._wordSeparators===r._wordSeparators&&this._modelVersionId===r._modelVersionId&&(this._cachedFindMatches=r._cachedFindMatches)}_modelVersionId=this._model.getVersionId();_cachedFindMatches=null;findMatches(){return this._cachedFindMatches===null&&(this._cachedFindMatches=this._model.findMatches(this._searchText,!0,!1,this._matchCase,this._wordSeparators,!1).map(t=>t.range),this._cachedFindMatches.sort(O.compareRangesUsingStarts)),this._cachedFindMatches}}let v=class extends V{constructor(e,o){super();this._languageFeaturesService=o;this.editor=e,this._isEnabled=e.getOption(C.selectionHighlight),this._decorations=e.createDecorationsCollection(),this.updateSoon=this._register(new q(()=>this._update(),300)),this.state=null,this._register(e.onDidChangeConfiguration(r=>{this._isEnabled=e.getOption(C.selectionHighlight)})),this._register(e.onDidChangeCursorSelection(r=>{this._isEnabled&&(r.selection.isEmpty()?r.reason===y.Explicit?(this.state&&this._setState(null),this.updateSoon.schedule()):this._setState(null):this._update())})),this._register(e.onDidChangeModel(r=>{this._setState(null)})),this._register(e.onDidChangeModelContent(r=>{this._isEnabled&&this.updateSoon.schedule()}));const i=R.get(e);i&&this._register(i.getState().onFindReplaceStateChange(r=>{this._update()})),this.updateSoon.schedule()}static ID="editor.contrib.selectionHighlighter";editor;_isEnabled;_decorations;updateSoon;state;_update(){this._setState(v._createState(this.state,this._isEnabled,this.editor))}static _createState(e,o,i){if(!o||!i.hasModel())return null;const r=i.getSelection();if(r.startLineNumber!==r.endLineNumber)return null;const n=A.get(i);if(!n)return null;const s=R.get(i);if(!s)return null;let l=n.getSession(s);if(!l){const u=i.getSelections();if(u.length>1){const D=s.getState().matchCase;if(!U(i.getModel(),u,D))return null}l=I.create(i,s)}if(!l||l.currentMatch||/^[ \t]+$/.test(l.searchText)||l.searchText.length>200)return null;const h=s.getState(),S=h.matchCase;if(h.isRevealed){let u=h.searchString;S||(u=u.toLowerCase());let x=l.searchText;if(S||(x=x.toLowerCase()),u===x&&l.matchCase===h.matchCase&&l.wholeWord===h.wholeWord&&!h.isRegex)return null}return new Se(i.getModel(),l.searchText,l.matchCase,l.wholeWord?i.getOption(C.wordSeparators):null,e)}_setState(e){if(this.state=e,!this.state){this._decorations.clear();return}if(!this.editor.hasModel())return;const o=this.editor.getModel();if(o.isTooLargeForTokenization())return;const i=this.state.findMatches(),r=this.editor.getSelections();r.sort(O.compareRangesUsingStarts);const n=[];for(let S=0,u=0,x=i.length,D=r.length;S<x;){const E=i[S];if(u>=D)n.push(E),S++;else{const k=O.compareRangesUsingStarts(E,r[u]);k<0?((r[u].isEmpty()||!O.areIntersecting(E,r[u]))&&n.push(E),S++):(k>0||S++,u++)}}const s=this.editor.getOption(C.occurrencesHighlight)!=="off",l=this._languageFeaturesService.documentHighlightProvider.has(o)&&s,h=n.map(S=>({range:S,options:ee(l)}));this._decorations.set(h)}dispose(){this._setState(null),super.dispose()}};v=z([W(1,Z)],v);function U(c,t,e){const o=G(c,t[0],!e);for(let i=1,r=t.length;i<r;i++){const n=t[i];if(n.isEmpty())return!1;const s=G(c,n,!e);if(o!==s)return!1}return!0}function G(c,t,e){const o=c.getValueInRange(t);return e?o.toLowerCase():o}class me extends M{constructor(){super({id:"editor.action.focusNextCursor",label:a.localize("mutlicursor.focusNextCursor","Focus Next Cursor"),metadata:{description:a.localize("mutlicursor.focusNextCursor.description","Focuses the next cursor"),args:[]},alias:"Focus Next Cursor",precondition:void 0})}run(t,e,o){if(!e.hasModel())return;const i=e._getViewModel();if(i.cursorConfig.readOnly)return;i.model.pushStackElement();const r=Array.from(i.getCursorStates()),n=r.shift();n&&(r.push(n),i.setCursorStates(o.source,y.Explicit,r),i.revealPrimaryCursor(o.source,!0),_(r,i.getCursorStates()))}}class pe extends M{constructor(){super({id:"editor.action.focusPreviousCursor",label:a.localize("mutlicursor.focusPreviousCursor","Focus Previous Cursor"),metadata:{description:a.localize("mutlicursor.focusPreviousCursor.description","Focuses the previous cursor"),args:[]},alias:"Focus Previous Cursor",precondition:void 0})}run(t,e,o){if(!e.hasModel())return;const i=e._getViewModel();if(i.cursorConfig.readOnly)return;i.model.pushStackElement();const r=Array.from(i.getCursorStates()),n=r.pop();n&&(r.unshift(n),i.setCursorStates(o.source,y.Explicit,r),i.revealPrimaryCursor(o.source,!0),_(r,i.getCursorStates()))}}H(A.ID,A,B.Lazy),H(v.ID,v,B.AfterFirstRender),m(oe),m(ie),m(re),m(le),m(ce),m(ae),m(de),m(ue),m(he),m(ne),m(se),m(me),m(pe);export{le as AddSelectionToNextFindMatchAction,ce as AddSelectionToPreviousFindMatchAction,he as CompatChangeAll,me as FocusNextCursor,pe as FocusPreviousCursor,oe as InsertCursorAbove,ie as InsertCursorBelow,ae as MoveSelectionToNextFindMatchAction,de as MoveSelectionToPreviousFindMatchAction,A as MultiCursorSelectionController,T as MultiCursorSelectionControllerAction,I as MultiCursorSession,P as MultiCursorSessionResult,ue as SelectHighlightsAction,v as SelectionHighlighter};
