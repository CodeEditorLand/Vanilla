import{asArray as G,isNonEmptyArray as W}from"../../../../base/common/arrays.js";import{CancellationToken as M}from"../../../../base/common/cancellation.js";import{onUnexpectedExternalError as C}from"../../../../base/common/errors.js";import{Iterable as H}from"../../../../base/common/iterator.js";import"../../../../base/common/lifecycle.js";import{LinkedList as J}from"../../../../base/common/linkedList.js";import{assertType as P}from"../../../../base/common/types.js";import{URI as b}from"../../../../base/common/uri.js";import{CodeEditorStateFlag as D,EditorStateCancellationTokenSource as U,TextModelCancellationTokenSource as q}from"../../editorState/browser/editorState.js";import{isCodeEditor as S}from"../../../browser/editorBrowser.js";import"../../../browser/editorExtensions.js";import{Position as j}from"../../../common/core/position.js";import{Range as p}from"../../../common/core/range.js";import{Selection as h}from"../../../common/core/selection.js";import{ScrollType as V}from"../../../common/editorCommon.js";import"../../../common/model.js";import"../../../common/languages.js";import{IEditorWorkerService as y}from"../../../common/services/editorWorker.js";import{ITextModelService as L}from"../../../common/services/resolverService.js";import{FormattingEdit as _}from"./formattingEdit.js";import{CommandsRegistry as A}from"../../../../platform/commands/common/commands.js";import{ExtensionIdentifierSet as Q}from"../../../../platform/extensions/common/extensions.js";import{IInstantiationService as K}from"../../../../platform/instantiation/common/instantiation.js";import"../../../../platform/progress/common/progress.js";import{ILanguageFeaturesService as w}from"../../../common/services/languageFeatures.js";import"../../../common/languageFeatureRegistry.js";import{ILogService as X}from"../../../../platform/log/common/log.js";import{AccessibilitySignal as z,IAccessibilitySignalService as B}from"../../../../platform/accessibilitySignal/browser/accessibilitySignalService.js";function N(o,t,e){const a=[],i=new Q,s=o.ordered(e);for(const n of s)a.push(n),n.extensionId&&i.add(n.extensionId);const u=t.ordered(e);for(const n of u){if(n.extensionId){if(i.has(n.extensionId))continue;i.add(n.extensionId)}a.push({displayName:n.displayName,extensionId:n.extensionId,provideDocumentFormattingEdits(c,m,g){return n.provideDocumentRangeFormattingEdits(c,c.getFullModelRange(),m,g)}})}return a}var Y=(e=>(e[e.File=1]="File",e[e.Selection=2]="Selection",e))(Y||{}),Z=(e=>(e[e.Explicit=1]="Explicit",e[e.Silent=2]="Silent",e))(Z||{});class R{static _selectors=new J;static setFormatterSelector(t){return{dispose:R._selectors.unshift(t)}}static async select(t,e,a,i){if(t.length===0)return;const s=H.first(R._selectors);if(s)return await s(t,e,a,i)}}async function Ke(o,t,e,a,i,s,u){const n=o.get(K),{documentRangeFormattingEditProvider:c}=o.get(w),m=S(t)?t.getModel():t,g=c.ordered(m),d=await R.select(g,m,a,2);d&&(i.report(d),await n.invokeFunction($,d,t,e,s,u))}async function $(o,t,e,a,i,s){const u=o.get(y),n=o.get(X),c=o.get(B);let m,g;S(e)?(m=e.getModel(),g=new U(e,D.Value|D.Position,void 0,i)):(m=e,g=new q(e,i));const d=[];let E=0;for(const r of G(a).sort(p.compareRangesUsingStarts))E>0&&p.areIntersectingOrTouching(d[E-1],r)?d[E-1]=p.fromPositions(d[E-1].getStartPosition(),r.getEndPosition()):E=d.push(r);const x=async r=>{n.trace("[format][provideDocumentRangeFormattingEdits] (request)",t.extensionId?.value,r);const l=await t.provideDocumentRangeFormattingEdits(m,r,m.getFormattingOptions(),g.token)||[];return n.trace("[format][provideDocumentRangeFormattingEdits] (response)",t.extensionId?.value,l),l},I=(r,l)=>{if(!r.length||!l.length)return!1;const v=r.reduce((f,k)=>p.plusRange(f,k.range),r[0].range);if(!l.some(f=>p.intersectRanges(v,f.range)))return!1;for(const f of r)for(const k of l)if(p.intersectRanges(f.range,k.range))return!0;return!1},T=[],F=[];try{if(typeof t.provideDocumentRangesFormattingEdits=="function"){n.trace("[format][provideDocumentRangeFormattingEdits] (request)",t.extensionId?.value,d);const r=await t.provideDocumentRangesFormattingEdits(m,d,m.getFormattingOptions(),g.token)||[];n.trace("[format][provideDocumentRangeFormattingEdits] (response)",t.extensionId?.value,r),F.push(r)}else{for(const r of d){if(g.token.isCancellationRequested)return!0;F.push(await x(r))}for(let r=0;r<d.length;++r)for(let l=r+1;l<d.length;++l){if(g.token.isCancellationRequested)return!0;if(I(F[r],F[l])){const v=p.plusRange(d[r],d[l]),f=await x(v);d.splice(l,1),d.splice(r,1),d.push(v),F.splice(l,1),F.splice(r,1),F.push(f),r=0,l=0}}}for(const r of F){if(g.token.isCancellationRequested)return!0;const l=await u.computeMoreMinimalEdits(m.uri,r);l&&T.push(...l)}}finally{g.dispose()}if(T.length===0)return!1;if(S(e))_.execute(e,T,!0),e.revealPositionInCenterIfOutsideViewport(e.getPosition(),V.Immediate);else{const[{range:r}]=T,l=new h(r.startLineNumber,r.startColumn,r.endLineNumber,r.endColumn);m.pushEditOperations([l],T.map(v=>({text:v.text,range:p.lift(v.range),forceMoveMarkers:!0})),v=>{for(const{range:f}of v)if(p.areIntersectingOrTouching(f,l))return[new h(f.startLineNumber,f.startColumn,f.endLineNumber,f.endColumn)];return null})}return c.playSignal(z.format,{userGesture:s}),!0}async function ze(o,t,e,a,i,s){const u=o.get(K),n=o.get(w),c=S(t)?t.getModel():t,m=N(n.documentFormattingEditProvider,n.documentRangeFormattingEditProvider,c),g=await R.select(m,c,e,1);g&&(a.report(g),await u.invokeFunction(O,g,t,e,i,s))}async function O(o,t,e,a,i,s){const u=o.get(y),n=o.get(B);let c,m;S(e)?(c=e.getModel(),m=new U(e,D.Value|D.Position,void 0,i)):(c=e,m=new q(e,i));let g;try{const d=await t.provideDocumentFormattingEdits(c,c.getFormattingOptions(),m.token);if(g=await u.computeMoreMinimalEdits(c.uri,d),m.token.isCancellationRequested)return!0}finally{m.dispose()}if(!g||g.length===0)return!1;if(S(e))_.execute(e,g,a!==2),a!==2&&e.revealPositionInCenterIfOutsideViewport(e.getPosition(),V.Immediate);else{const[{range:d}]=g,E=new h(d.startLineNumber,d.startColumn,d.endLineNumber,d.endColumn);c.pushEditOperations([E],g.map(x=>({text:x.text,range:p.lift(x.range),forceMoveMarkers:!0})),x=>{for(const{range:I}of x)if(p.areIntersectingOrTouching(I,E))return[new h(I.startLineNumber,I.startColumn,I.endLineNumber,I.endColumn)];return null})}return n.playSignal(z.format,{userGesture:s}),!0}async function ee(o,t,e,a,i,s){const u=t.documentRangeFormattingEditProvider.ordered(e);for(const n of u){const c=await Promise.resolve(n.provideDocumentRangeFormattingEdits(e,a,i,s)).catch(C);if(W(c))return await o.computeMoreMinimalEdits(e.uri,c)}}async function te(o,t,e,a,i){const s=N(t.documentFormattingEditProvider,t.documentRangeFormattingEditProvider,e);for(const u of s){const n=await Promise.resolve(u.provideDocumentFormattingEdits(e,a,i)).catch(C);if(W(n))return await o.computeMoreMinimalEdits(e.uri,n)}}async function Be(o,t,e,a,i){const s=S(e)?e.getModel():e,u=N(t.documentFormattingEditProvider,t.documentRangeFormattingEditProvider,s),n=await R.select(u,s,a,1);if(n){const c=await Promise.resolve(n.provideDocumentFormattingEdits(s,s.getOptions(),i)).catch(C);return await o.computeMoreMinimalEdits(s.uri,c)}}function ne(o,t,e,a,i,s,u){const n=t.onTypeFormattingEditProvider.ordered(e);return n.length===0||n[0].autoFormatTriggerCharacters.indexOf(i)<0?Promise.resolve(void 0):Promise.resolve(n[0].provideOnTypeFormattingEdits(e,a,i,s,u)).catch(C).then(c=>o.computeMoreMinimalEdits(e.uri,c))}A.registerCommand("_executeFormatRangeProvider",async function(o,...t){const[e,a,i]=t;P(b.isUri(e)),P(p.isIRange(a));const s=o.get(L),u=o.get(y),n=o.get(w),c=await s.createModelReference(e);try{return ee(u,n,c.object.textEditorModel,p.lift(a),i,M.None)}finally{c.dispose()}}),A.registerCommand("_executeFormatDocumentProvider",async function(o,...t){const[e,a]=t;P(b.isUri(e));const i=o.get(L),s=o.get(y),u=o.get(w),n=await i.createModelReference(e);try{return te(s,u,n.object.textEditorModel,a,M.None)}finally{n.dispose()}}),A.registerCommand("_executeFormatOnTypeProvider",async function(o,...t){const[e,a,i,s]=t;P(b.isUri(e)),P(j.isIPosition(a)),P(typeof i=="string");const u=o.get(L),n=o.get(y),c=o.get(w),m=await u.createModelReference(e);try{return ne(n,c,m.object.textEditorModel,j.lift(a),i,s,M.None)}finally{m.dispose()}});export{R as FormattingConflicts,Y as FormattingKind,Z as FormattingMode,$ as formatDocumentRangesWithProvider,Ke as formatDocumentRangesWithSelectedProvider,O as formatDocumentWithProvider,ze as formatDocumentWithSelectedProvider,te as getDocumentFormattingEditsUntilResult,Be as getDocumentFormattingEditsWithSelectedProvider,ee as getDocumentRangeFormattingEditsUntilResult,ne as getOnTypeFormattingEdits,N as getRealAndSyntheticDocumentFormattersOrdered};
