var A=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var u=(n,e,t,o)=>{for(var i=o>1?void 0:o?N(e,t):e,r=n.length-1,s;r>=0;r--)(s=n[r])&&(i=(o?s(e,t,i):s(i))||i);return o&&i&&A(e,t,i),i},c=(n,e)=>(t,o)=>e(t,o,n);import{isNonEmptyArray as P}from"../../../../base/common/arrays.js";import{CancellationToken as f,CancellationTokenSource as K}from"../../../../base/common/cancellation.js";import{onUnexpectedError as L}from"../../../../base/common/errors.js";import{KeyChord as T,KeyCode as g,KeyMod as l}from"../../../../base/common/keyCodes.js";import{DisposableStore as h}from"../../../../base/common/lifecycle.js";import"../../../browser/editorBrowser.js";import{EditorAction as y,EditorContributionInstantiation as b,registerEditorAction as E,registerEditorContribution as D}from"../../../browser/editorExtensions.js";import{ICodeEditorService as R}from"../../../browser/services/codeEditorService.js";import{EditorOption as v}from"../../../common/config/editorOptions.js";import{CharacterSet as W}from"../../../common/core/characterClassifier.js";import{Range as z}from"../../../common/core/range.js";import"../../../common/editorCommon.js";import{EditorContextKeys as d}from"../../../common/editorContextKeys.js";import{IEditorWorkerService as B}from"../../../common/services/editorWorker.js";import{ILanguageFeaturesService as I}from"../../../common/services/languageFeatures.js";import{formatDocumentRangesWithSelectedProvider as F,formatDocumentWithSelectedProvider as q,FormattingMode as S,getOnTypeFormattingEdits as G}from"./format.js";import{FormattingEdit as U}from"./formattingEdit.js";import*as M from"../../../../nls.js";import{AccessibilitySignal as j,IAccessibilitySignalService as H}from"../../../../platform/accessibilitySignal/browser/accessibilitySignalService.js";import{CommandsRegistry as J,ICommandService as Q}from"../../../../platform/commands/common/commands.js";import{ContextKeyExpr as w}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as C}from"../../../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as x}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{IEditorProgressService as O,Progress as _}from"../../../../platform/progress/common/progress.js";let m=class{constructor(e,t,o,i){this._editor=e;this._languageFeaturesService=t;this._workerService=o;this._accessibilitySignalService=i;this._disposables.add(t.onTypeFormattingEditProvider.onDidChange(this._update,this)),this._disposables.add(e.onDidChangeModel(()=>this._update())),this._disposables.add(e.onDidChangeModelLanguage(()=>this._update())),this._disposables.add(e.onDidChangeConfiguration(r=>{r.hasChanged(v.formatOnType)&&this._update()})),this._update()}static ID="editor.contrib.autoFormat";_disposables=new h;_sessionDisposables=new h;dispose(){this._disposables.dispose(),this._sessionDisposables.dispose()}_update(){if(this._sessionDisposables.clear(),!this._editor.getOption(v.formatOnType)||!this._editor.hasModel())return;const e=this._editor.getModel(),[t]=this._languageFeaturesService.onTypeFormattingEditProvider.ordered(e);if(!t||!t.autoFormatTriggerCharacters)return;const o=new W;for(const i of t.autoFormatTriggerCharacters)o.add(i.charCodeAt(0));this._sessionDisposables.add(this._editor.onDidType(i=>{const r=i.charCodeAt(i.length-1);o.has(r)&&this._trigger(String.fromCharCode(r))}))}_trigger(e){if(!this._editor.hasModel()||this._editor.getSelections().length>1||!this._editor.getSelection().isEmpty())return;const t=this._editor.getModel(),o=this._editor.getPosition(),i=new K,r=this._editor.onDidChangeModelContent(s=>{if(s.isFlush){i.cancel(),r.dispose();return}for(let a=0,k=s.changes.length;a<k;a++)if(s.changes[a].range.endLineNumber<=o.lineNumber){i.cancel(),r.dispose();return}});G(this._workerService,this._languageFeaturesService,t,o,e,t.getFormattingOptions(),i.token).then(s=>{i.token.isCancellationRequested||P(s)&&(this._accessibilitySignalService.playSignal(j.format,{userGesture:!1}),U.execute(this._editor,s,!0))}).finally(()=>{r.dispose()})}};m=u([c(1,I),c(2,B),c(3,H)],m);let p=class{constructor(e,t,o){this.editor=e;this._languageFeaturesService=t;this._instantiationService=o;this._callOnDispose.add(e.onDidChangeConfiguration(()=>this._update())),this._callOnDispose.add(e.onDidChangeModel(()=>this._update())),this._callOnDispose.add(e.onDidChangeModelLanguage(()=>this._update())),this._callOnDispose.add(t.documentRangeFormattingEditProvider.onDidChange(this._update,this))}static ID="editor.contrib.formatOnPaste";_callOnDispose=new h;_callOnModel=new h;dispose(){this._callOnDispose.dispose(),this._callOnModel.dispose()}_update(){this._callOnModel.clear(),this.editor.getOption(v.formatOnPaste)&&this.editor.hasModel()&&this._languageFeaturesService.documentRangeFormattingEditProvider.has(this.editor.getModel())&&this._callOnModel.add(this.editor.onDidPaste(({range:e})=>this._trigger(e)))}_trigger(e){this.editor.hasModel()&&(this.editor.getSelections().length>1||this._instantiationService.invokeFunction(F,this.editor,e,S.Silent,_.None,f.None,!1).catch(L))}};p=u([c(1,I),c(2,C)],p);class V extends y{constructor(){super({id:"editor.action.formatDocument",label:M.localize("formatDocument.label","Format Document"),alias:"Format Document",precondition:w.and(d.notInCompositeEditor,d.writable,d.hasDocumentFormattingProvider),kbOpts:{kbExpr:d.editorTextFocus,primary:l.Shift|l.Alt|g.KeyF,linux:{primary:l.CtrlCmd|l.Shift|g.KeyI},weight:x.EditorContrib},contextMenuOpts:{group:"1_modification",order:1.3}})}async run(e,t){if(t.hasModel()){const o=e.get(C);await e.get(O).showWhile(o.invokeFunction(q,t,S.Explicit,_.None,f.None,!0),250)}}}class X extends y{constructor(){super({id:"editor.action.formatSelection",label:M.localize("formatSelection.label","Format Selection"),alias:"Format Selection",precondition:w.and(d.writable,d.hasDocumentSelectionFormattingProvider),kbOpts:{kbExpr:d.editorTextFocus,primary:T(l.CtrlCmd|g.KeyK,l.CtrlCmd|g.KeyF),weight:x.EditorContrib},contextMenuOpts:{when:d.hasNonEmptySelection,group:"1_modification",order:1.31}})}async run(e,t){if(!t.hasModel())return;const o=e.get(C),i=t.getModel(),r=t.getSelections().map(a=>a.isEmpty()?new z(a.startLineNumber,1,a.startLineNumber,i.getLineMaxColumn(a.startLineNumber)):a);await e.get(O).showWhile(o.invokeFunction(F,t,r,S.Explicit,_.None,f.None,!0),250)}}D(m.ID,m,b.BeforeFirstInteraction),D(p.ID,p,b.BeforeFirstInteraction),E(V),E(X),J.registerCommand("editor.action.format",async n=>{const e=n.get(R).getFocusedCodeEditor();if(!e||!e.hasModel())return;const t=n.get(Q);e.getSelection().isEmpty()?await t.executeCommand("editor.action.formatDocument"):await t.executeCommand("editor.action.formatSelection")});export{m as FormatOnType};
