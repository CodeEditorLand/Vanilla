{
  "version": 3,
  "sources": ["../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/editor/contrib/sectionHeaders/browser/sectionHeaders.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { CancelablePromise, RunOnceScheduler } from '../../../../base/common/async.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { ICodeEditor } from '../../../browser/editorBrowser.js';\nimport { EditorContributionInstantiation, registerEditorContribution } from '../../../browser/editorExtensions.js';\nimport { EditorOption, IEditorMinimapOptions } from '../../../common/config/editorOptions.js';\nimport { IEditorContribution } from '../../../common/editorCommon.js';\nimport { StandardTokenType } from '../../../common/encodedTokenAttributes.js';\nimport { ILanguageConfigurationService } from '../../../common/languages/languageConfigurationRegistry.js';\nimport { IModelDeltaDecoration, MinimapPosition, MinimapSectionHeaderStyle, TrackedRangeStickiness } from '../../../common/model.js';\nimport { ModelDecorationOptions } from '../../../common/model/textModel.js';\nimport { IEditorWorkerService } from '../../../common/services/editorWorker.js';\nimport { FindSectionHeaderOptions, SectionHeader } from '../../../common/services/findSectionHeaders.js';\n\nexport class SectionHeaderDetector extends Disposable implements IEditorContribution {\n\n\tpublic static readonly ID: string = 'editor.sectionHeaderDetector';\n\n\tprivate options: FindSectionHeaderOptions | undefined;\n\tprivate decorations = this.editor.createDecorationsCollection();\n\tprivate computeSectionHeaders: RunOnceScheduler;\n\tprivate computePromise: CancelablePromise<SectionHeader[]> | null;\n\tprivate currentOccurrences: { [decorationId: string]: SectionHeaderOccurrence };\n\n\tconstructor(\n\t\tprivate readonly editor: ICodeEditor,\n\t\t@ILanguageConfigurationService private readonly languageConfigurationService: ILanguageConfigurationService,\n\t\t@IEditorWorkerService private readonly editorWorkerService: IEditorWorkerService,\n\t) {\n\t\tsuper();\n\n\t\tthis.options = this.createOptions(editor.getOption(EditorOption.minimap));\n\t\tthis.computePromise = null;\n\t\tthis.currentOccurrences = {};\n\n\t\tthis._register(editor.onDidChangeModel((e) => {\n\t\t\tthis.currentOccurrences = {};\n\t\t\tthis.options = this.createOptions(editor.getOption(EditorOption.minimap));\n\t\t\tthis.stop();\n\t\t\tthis.computeSectionHeaders.schedule(0);\n\t\t}));\n\n\t\tthis._register(editor.onDidChangeModelLanguage((e) => {\n\t\t\tthis.currentOccurrences = {};\n\t\t\tthis.options = this.createOptions(editor.getOption(EditorOption.minimap));\n\t\t\tthis.stop();\n\t\t\tthis.computeSectionHeaders.schedule(0);\n\t\t}));\n\n\t\tthis._register(languageConfigurationService.onDidChange((e) => {\n\t\t\tconst editorLanguageId = this.editor.getModel()?.getLanguageId();\n\t\t\tif (editorLanguageId && e.affects(editorLanguageId)) {\n\t\t\t\tthis.currentOccurrences = {};\n\t\t\t\tthis.options = this.createOptions(editor.getOption(EditorOption.minimap));\n\t\t\t\tthis.stop();\n\t\t\t\tthis.computeSectionHeaders.schedule(0);\n\t\t\t}\n\t\t}));\n\n\t\tthis._register(editor.onDidChangeConfiguration(e => {\n\t\t\tif (this.options && !e.hasChanged(EditorOption.minimap)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.options = this.createOptions(editor.getOption(EditorOption.minimap));\n\n\t\t\t// Remove any links (for the getting disabled case)\n\t\t\tthis.updateDecorations([]);\n\n\t\t\t// Stop any computation (for the getting disabled case)\n\t\t\tthis.stop();\n\n\t\t\t// Start computing (for the getting enabled case)\n\t\t\tthis.computeSectionHeaders.schedule(0);\n\t\t}));\n\n\t\tthis._register(this.editor.onDidChangeModelContent(e => {\n\t\t\tthis.computeSectionHeaders.schedule();\n\t\t}));\n\n\t\tthis._register(editor.onDidChangeModelTokens((e) => {\n\t\t\tif (!this.computeSectionHeaders.isScheduled()) {\n\t\t\t\tthis.computeSectionHeaders.schedule(1000);\n\t\t\t}\n\t\t}));\n\n\t\tthis.computeSectionHeaders = this._register(new RunOnceScheduler(() => {\n\t\t\tthis.findSectionHeaders();\n\t\t}, 250));\n\n\t\tthis.computeSectionHeaders.schedule(0);\n\t}\n\n\tprivate createOptions(minimap: Readonly<Required<IEditorMinimapOptions>>): FindSectionHeaderOptions | undefined {\n\t\tif (!minimap || !this.editor.hasModel()) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst languageId = this.editor.getModel().getLanguageId();\n\t\tif (!languageId) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst commentsConfiguration = this.languageConfigurationService.getLanguageConfiguration(languageId).comments;\n\t\tconst foldingRules = this.languageConfigurationService.getLanguageConfiguration(languageId).foldingRules;\n\n\t\tif (!commentsConfiguration && !foldingRules?.markers) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\treturn {\n\t\t\tfoldingRules,\n\t\t\tfindMarkSectionHeaders: minimap.showMarkSectionHeaders,\n\t\t\tfindRegionSectionHeaders: minimap.showRegionSectionHeaders,\n\t\t};\n\t}\n\n\tprivate findSectionHeaders() {\n\t\tif (!this.editor.hasModel()\n\t\t\t|| (!this.options?.findMarkSectionHeaders && !this.options?.findRegionSectionHeaders)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst model = this.editor.getModel();\n\t\tif (model.isDisposed() || model.isTooLargeForSyncing()) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst modelVersionId = model.getVersionId();\n\t\tthis.editorWorkerService.findSectionHeaders(model.uri, this.options)\n\t\t\t.then((sectionHeaders) => {\n\t\t\t\tif (model.isDisposed() || model.getVersionId() !== modelVersionId) {\n\t\t\t\t\t// model changed in the meantime\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tthis.updateDecorations(sectionHeaders);\n\t\t\t});\n\t}\n\n\tprivate updateDecorations(sectionHeaders: SectionHeader[]): void {\n\n\t\tconst model = this.editor.getModel();\n\t\tif (model) {\n\t\t\t// Remove all section headers that should be in comments and are not in comments\n\t\t\tsectionHeaders = sectionHeaders.filter((sectionHeader) => {\n\t\t\t\tif (!sectionHeader.shouldBeInComments) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\tconst validRange = model.validateRange(sectionHeader.range);\n\t\t\t\tconst tokens = model.tokenization.getLineTokens(validRange.startLineNumber);\n\t\t\t\tconst idx = tokens.findTokenIndexAtOffset(validRange.startColumn - 1);\n\t\t\t\tconst tokenType = tokens.getStandardTokenType(idx);\n\t\t\t\tconst languageId = tokens.getLanguageId(idx);\n\t\t\t\treturn (languageId === model.getLanguageId() && tokenType === StandardTokenType.Comment);\n\t\t\t});\n\t\t}\n\n\t\tconst oldDecorations = Object.values(this.currentOccurrences).map(occurrence => occurrence.decorationId);\n\t\tconst newDecorations = sectionHeaders.map(sectionHeader => decoration(sectionHeader));\n\n\t\tthis.editor.changeDecorations((changeAccessor) => {\n\t\t\tconst decorations = changeAccessor.deltaDecorations(oldDecorations, newDecorations);\n\n\t\t\tthis.currentOccurrences = {};\n\t\t\tfor (let i = 0, len = decorations.length; i < len; i++) {\n\t\t\t\tconst occurrence = { sectionHeader: sectionHeaders[i], decorationId: decorations[i] };\n\t\t\t\tthis.currentOccurrences[occurrence.decorationId] = occurrence;\n\t\t\t}\n\t\t});\n\t}\n\n\tprivate stop(): void {\n\t\tthis.computeSectionHeaders.cancel();\n\t\tif (this.computePromise) {\n\t\t\tthis.computePromise.cancel();\n\t\t\tthis.computePromise = null;\n\t\t}\n\t}\n\n\tpublic override dispose(): void {\n\t\tsuper.dispose();\n\t\tthis.stop();\n\t\tthis.decorations.clear();\n\t}\n\n}\n\ninterface SectionHeaderOccurrence {\n\treadonly sectionHeader: SectionHeader;\n\treadonly decorationId: string;\n}\n\nfunction decoration(sectionHeader: SectionHeader): IModelDeltaDecoration {\n\treturn {\n\t\trange: sectionHeader.range,\n\t\toptions: ModelDecorationOptions.createDynamic({\n\t\t\tdescription: 'section-header',\n\t\t\tstickiness: TrackedRangeStickiness.GrowsOnlyWhenTypingAfter,\n\t\t\tcollapseOnReplaceEdit: true,\n\t\t\tminimap: {\n\t\t\t\tcolor: undefined,\n\t\t\t\tposition: MinimapPosition.Inline,\n\t\t\t\tsectionHeaderStyle: sectionHeader.hasSeparatorLine ? MinimapSectionHeaderStyle.Underlined : MinimapSectionHeaderStyle.Normal,\n\t\t\t\tsectionHeaderText: sectionHeader.text,\n\t\t\t},\n\t\t})\n\t};\n}\n\nregisterEditorContribution(SectionHeaderDetector.ID, SectionHeaderDetector, EditorContributionInstantiation.AfterFirstRender);\n"],
  "mappings": "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",
  "names": []
}
