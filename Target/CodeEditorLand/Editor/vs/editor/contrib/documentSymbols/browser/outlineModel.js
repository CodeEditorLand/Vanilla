var T=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var v=(c,o,e,n)=>{for(var r=n>1?void 0:n?M(o,e):o,t=c.length-1,i;t>=0;t--)(i=c[t])&&(r=(n?i(o,e,r):i(r))||r);return n&&r&&T(o,e,r),r},h=(c,o)=>(e,n)=>o(e,n,c);import{binarySearch as C,coalesceInPlace as w,equals as S}from"../../../../base/common/arrays.js";import{CancellationTokenSource as E}from"../../../../base/common/cancellation.js";import{onUnexpectedExternalError as R}from"../../../../base/common/errors.js";import{Iterable as _}from"../../../../base/common/iterator.js";import{DisposableStore as L}from"../../../../base/common/lifecycle.js";import{LRUCache as $}from"../../../../base/common/map.js";import{commonPrefixLength as F}from"../../../../base/common/strings.js";import{InstantiationType as x,registerSingleton as U}from"../../../../platform/instantiation/common/extensions.js";import{createDecorator as z}from"../../../../platform/instantiation/common/instantiation.js";import{Position as O}from"../../../common/core/position.js";import{Range as a}from"../../../common/core/range.js";import{ILanguageFeatureDebounceService as B}from"../../../common/services/languageFeatureDebounce.js";import{ILanguageFeaturesService as G}from"../../../common/services/languageFeatures.js";import{IModelService as N}from"../../../common/services/model.js";class l{remove(){this.parent?.children.delete(this.id)}static findId(o,e){let n;typeof o=="string"?n=`${e.id}/${o}`:(n=`${e.id}/${o.name}`,e.children.get(n)!==void 0&&(n=`${e.id}/${o.name}_${o.range.startLineNumber}_${o.range.startColumn}`));let r=n;for(let t=0;e.children.get(r)!==void 0;t++)r=`${n}_${t}`;return r}static getElementById(o,e){if(!o)return;const n=F(o,e.id);if(n===o.length)return e;if(!(n<e.id.length))for(const[,r]of e.children){const t=l.getElementById(o,r);if(t)return t}}static size(o){let e=1;for(const[,n]of o.children)e+=l.size(n);return e}static empty(o){return o.children.size===0}}class k extends l{constructor(e,n,r){super();this.id=e;this.parent=n;this.symbol=r}children=new Map;marker}class D extends l{constructor(e,n,r,t){super();this.id=e;this.parent=n;this.label=r;this.order=t}children=new Map;getItemEnclosingPosition(e){return e?this._getItemEnclosingPosition(e,this.children):void 0}_getItemEnclosingPosition(e,n){for(const[,r]of n)if(!(!r.symbol.range||!a.containsPosition(r.symbol.range,e)))return this._getItemEnclosingPosition(e,r.children)||r}updateMarker(e){for(const[,n]of this.children)this._updateMarker(e,n)}_updateMarker(e,n){n.marker=void 0;const r=C(e,n.symbol.range,a.compareRangesUsingStarts);let t;r<0?(t=~r,t>0&&a.areIntersecting(e[t-1],n.symbol.range)&&(t-=1)):t=r;const i=[];let s;for(;t<e.length&&a.areIntersecting(n.symbol.range,e[t]);t++){const d=e[t];i.push(d),e[t]=void 0,(!s||d.severity>s)&&(s=d.severity)}for(const[,d]of n.children)this._updateMarker(i,d);s&&(n.marker={count:i.length,topSev:s}),w(e)}}class u extends l{constructor(e){super();this.uri=e;this.id="root",this.parent=void 0}static create(e,n,r){const t=new E(r),i=new u(n.uri),s=e.ordered(n),d=s.map((g,b)=>{const I=l.findId(`provider_${b}`,i),y=new D(I,i,g.displayName??"Unknown Outline Provider",b);return Promise.resolve(g.provideDocumentSymbols(n,t.token)).then(m=>{for(const P of m||[])u._makeOutlineElement(P,y);return y},m=>(R(m),y)).then(m=>{l.empty(m)?m.remove():i._groups.set(I,m)})}),f=e.onDidChange(()=>{const g=e.ordered(n);S(g,s)||t.cancel()});return Promise.all(d).then(()=>t.token.isCancellationRequested&&!r.isCancellationRequested?u.create(e,n,r):i._compact()).finally(()=>{t.dispose(),f.dispose(),t.dispose()})}static _makeOutlineElement(e,n){const r=l.findId(e,n),t=new k(r,n,e);if(e.children)for(const i of e.children)u._makeOutlineElement(i,t);n.children.set(t.id,t)}static get(e){for(;e;){if(e instanceof u)return e;e=e.parent}}id="root";parent=void 0;_groups=new Map;children=new Map;_compact(){let e=0;for(const[n,r]of this._groups)r.children.size===0?this._groups.delete(n):e+=1;if(e!==1)this.children=this._groups;else{const n=_.first(this._groups.values());for(const[,r]of n.children)r.parent=this,this.children.set(r.id,r)}return this}merge(e){return this.uri.toString()!==e.uri.toString()||this._groups.size!==e._groups.size?!1:(this._groups=e._groups,this.children=e.children,!0)}getItemEnclosingPosition(e,n){let r;if(n){let i=n.parent;for(;i&&!r;)i instanceof D&&(r=i),i=i.parent}let t;for(const[,i]of this._groups)if(t=i.getItemEnclosingPosition(e),t&&(!r||r===i))break;return t}getItemById(e){return l.getElementById(e,this)}updateMarker(e){e.sort(a.compareRangesUsingStarts);for(const[,n]of this._groups)n.updateMarker(e.slice(0))}getTopLevelSymbols(){const e=[];for(const n of this.children.values())n instanceof k?e.push(n.symbol):e.push(..._.map(n.children.values(),r=>r.symbol));return e.sort((n,r)=>a.compareRangesUsingStarts(n.range,r.range))}asListOfDocumentSymbols(){const e=this.getTopLevelSymbols(),n=[];return u._flattenDocumentSymbols(n,e,""),n.sort((r,t)=>O.compare(a.getStartPosition(r.range),a.getStartPosition(t.range))||O.compare(a.getEndPosition(t.range),a.getEndPosition(r.range)))}static _flattenDocumentSymbols(e,n,r){for(const t of n)e.push({kind:t.kind,tags:t.tags,name:t.name,detail:t.detail,containerName:t.containerName||r,range:t.range,selectionRange:t.selectionRange,children:void 0}),t.children&&u._flattenDocumentSymbols(e,t.children,t.name)}}const j=z("IOutlineModelService");let p=class{constructor(o,e,n){this._languageFeaturesService=o;this._debounceInformation=e.for(o.documentSymbolProvider,"DocumentSymbols",{min:350}),this._disposables.add(n.onModelRemoved(r=>{this._cache.delete(r.id)}))}_disposables=new L;_debounceInformation;_cache=new $(10,.7);dispose(){this._disposables.dispose()}async getOrCreate(o,e){const n=this._languageFeaturesService.documentSymbolProvider,r=n.ordered(o);let t=this._cache.get(o.id);if(!t||t.versionId!==o.getVersionId()||!S(t.provider,r)){const s=new E;t={versionId:o.getVersionId(),provider:r,promiseCnt:0,source:s,promise:u.create(n,o,s.token),model:void 0},this._cache.set(o.id,t);const d=Date.now();t.promise.then(f=>{t.model=f,this._debounceInformation.update(o,Date.now()-d)}).catch(f=>{this._cache.delete(o.id)})}if(t.model)return t.model;t.promiseCnt+=1;const i=e.onCancellationRequested(()=>{--t.promiseCnt===0&&(t.source.cancel(),this._cache.delete(o.id))});try{return await t.promise}finally{i.dispose()}}getDebounceValue(o){return this._debounceInformation.get(o)}};p=v([h(0,G),h(1,B),h(2,N)],p),U(j,p,x.Delayed);export{j as IOutlineModelService,k as OutlineElement,D as OutlineGroup,u as OutlineModel,p as OutlineModelService,l as TreeElement};
