var f=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var m=(s,r,o,e)=>{for(var t=e>1?void 0:e?I(r,o):r,i=s.length-1,n;i>=0;i--)(n=s[i])&&(t=(e?n(r,o,t):n(t))||t);return e&&t&&f(r,o,t),t},g=(s,r)=>(o,e)=>r(o,e,s);import*as a from"../../../../base/browser/dom.js";import{disposableTimeout as C}from"../../../../base/common/async.js";import{Codicon as y}from"../../../../base/common/codicons.js";import{Disposable as u,MutableDisposable as v}from"../../../../base/common/lifecycle.js";import{noBreakWhitespace as _}from"../../../../base/common/strings.js";import{ThemeIcon as D}from"../../../../base/common/themables.js";import"./inlineProgressWidget.css";import{ContentWidgetPositionPreference as w}from"../../../browser/editorBrowser.js";import{EditorOption as l}from"../../../common/config/editorOptions.js";import{Range as P}from"../../../common/core/range.js";import{TrackedRangeStickiness as N}from"../../../common/model.js";import{ModelDecorationOptions as W}from"../../../common/model/textModel.js";import{IInstantiationService as b}from"../../../../platform/instantiation/common/instantiation.js";const E=W.register({description:"inline-progress-widget",stickiness:N.NeverGrowsWhenTypingAtEdges,showIfCollapsed:!0,after:{content:_,inlineClassName:"inline-editor-progress-decoration",inlineClassNameAffectsLetterSpacing:!0}});class c extends u{constructor(o,e,t,i,n){super();this.typeId=o;this.editor=e;this.range=t;this.delegate=n;this.create(i),this.editor.addContentWidget(this),this.editor.layoutContentWidget(this)}static baseId="editor.widget.inlineProgressWidget";allowEditorOverflow=!1;suppressMouseDown=!0;domNode;create(o){this.domNode=a.$(".inline-progress-widget"),this.domNode.role="button",this.domNode.title=o;const e=a.$("span.icon");this.domNode.append(e),e.classList.add(...D.asClassNameArray(y.loading),"codicon-modifier-spin");const t=()=>{const i=this.editor.getOption(l.lineHeight);this.domNode.style.height=`${i}px`,this.domNode.style.width=`${Math.ceil(.8*i)}px`};t(),this._register(this.editor.onDidChangeConfiguration(i=>{(i.hasChanged(l.fontSize)||i.hasChanged(l.lineHeight))&&t()})),this._register(a.addDisposableListener(this.domNode,a.EventType.CLICK,i=>{this.delegate.cancel()}))}getId(){return c.baseId+"."+this.typeId}getDomNode(){return this.domNode}getPosition(){return{position:{lineNumber:this.range.startLineNumber,column:this.range.startColumn},preference:[w.EXACT]}}dispose(){super.dispose(),this.editor.removeContentWidget(this)}}let d=class extends u{constructor(o,e,t){super();this.id=o;this._editor=e;this._instantiationService=t;this._currentDecorations=e.createDecorationsCollection()}_showDelay=500;_showPromise=this._register(new v);_currentDecorations;_currentWidget=this._register(new v);_operationIdPool=0;_currentOperation;dispose(){super.dispose(),this._currentDecorations.clear()}async showWhile(o,e,t,i,n){const p=this._operationIdPool++;this._currentOperation=p,this.clear(),this._showPromise.value=C(()=>{const h=P.fromPositions(o);this._currentDecorations.set([{range:h,options:E}]).length>0&&(this._currentWidget.value=this._instantiationService.createInstance(c,this.id,this._editor,h,e,i))},n??this._showDelay);try{return await t}finally{this._currentOperation===p&&(this.clear(),this._currentOperation=void 0)}}clear(){this._showPromise.clear(),this._currentDecorations.clear(),this._currentWidget.clear()}};d=m([g(2,b)],d);export{d as InlineProgressManager};
