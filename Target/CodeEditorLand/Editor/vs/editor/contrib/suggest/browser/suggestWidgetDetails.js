var E=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var L=(a,e,i,o)=>{for(var s=o>1?void 0:o?W(e,i):e,t=a.length-1,r;t>=0;t--)(r=a[t])&&(s=(o?r(e,i,s):r(s))||s);return o&&s&&E(e,i,s),s},T=(a,e)=>(i,o)=>e(i,o,a);import*as n from"../../../../base/browser/dom.js";import{ResizableHTMLElement as M}from"../../../../base/browser/ui/resizable/resizable.js";import{DomScrollableElement as $}from"../../../../base/browser/ui/scrollbar/scrollableElement.js";import{Codicon as A}from"../../../../base/common/codicons.js";import{Emitter as x}from"../../../../base/common/event.js";import{MarkdownString as O}from"../../../../base/common/htmlContent.js";import{DisposableStore as v}from"../../../../base/common/lifecycle.js";import{ThemeIcon as R}from"../../../../base/common/themables.js";import*as N from"../../../../nls.js";import{IInstantiationService as k}from"../../../../platform/instantiation/common/instantiation.js";import{MarkdownRenderer as F}from"../../../browser/widget/markdownRenderer/browser/markdownRenderer.js";import{EditorOption as b}from"../../../common/config/editorOptions.js";function j(a){return!!a&&!!(a.completion.documentation||a.completion.detail&&a.completion.detail!==a.completion.label)}let u=class{constructor(e,i){this._editor=e;this.domNode=n.$(".suggest-details"),this.domNode.classList.add("no-docs"),this._markdownRenderer=i.createInstance(F,{editor:e}),this._body=n.$(".body"),this._scrollbar=new $(this._body,{alwaysConsumeMouseWheel:!0}),n.append(this.domNode,this._scrollbar.getDomNode()),this._disposables.add(this._scrollbar),this._header=n.append(this._body,n.$(".header")),this._close=n.append(this._header,n.$("span"+R.asCSSSelector(A.close))),this._close.title=N.localize("details.close","Close"),this._close.role="button",this._close.tabIndex=-1,this._type=n.append(this._header,n.$("p.type")),this._docs=n.append(this._body,n.$("p.docs")),this._configureFont(),this._disposables.add(this._editor.onDidChangeConfiguration(o=>{o.hasChanged(b.fontInfo)&&this._configureFont()}))}domNode;_onDidClose=new x;onDidClose=this._onDidClose.event;_onDidChangeContents=new x;onDidChangeContents=this._onDidChangeContents.event;_close;_scrollbar;_body;_header;_type;_docs;_disposables=new v;_markdownRenderer;_renderDisposeable=new v;_borderWidth=1;_size=new n.Dimension(330,0);dispose(){this._disposables.dispose(),this._renderDisposeable.dispose()}_configureFont(){const e=this._editor.getOptions(),i=e.get(b.fontInfo),o=i.getMassagedFontFamily(),s=e.get(b.suggestFontSize)||i.fontSize,t=e.get(b.suggestLineHeight)||i.lineHeight,r=i.fontWeight,l=`${s}px`,p=`${t}px`;this.domNode.style.fontSize=l,this.domNode.style.lineHeight=`${t/s}`,this.domNode.style.fontWeight=r,this.domNode.style.fontFeatureSettings=i.fontFeatureSettings,this._type.style.fontFamily=o,this._close.style.height=p,this._close.style.width=p}getLayoutInfo(){const e=this._editor.getOption(b.suggestLineHeight)||this._editor.getOption(b.fontInfo).lineHeight,i=this._borderWidth,o=i*2;return{lineHeight:e,borderWidth:i,borderHeight:o,verticalPadding:22,horizontalPadding:14}}renderLoading(){this._type.textContent=N.localize("loading","Loading..."),this._docs.textContent="",this.domNode.classList.remove("no-docs","no-type"),this.layout(this.size.width,this.getLayoutInfo().lineHeight*2),this._onDidChangeContents.fire(this)}renderItem(e,i){this._renderDisposeable.clear();let{detail:o,documentation:s}=e.completion;if(i){let t="";t+=`score: ${e.score[0]}
`,t+=`prefix: ${e.word??"(no prefix)"}
`,t+=`word: ${e.completion.filterText?e.completion.filterText+" (filterText)":e.textLabel}
`,t+=`distance: ${e.distance} (localityBonus-setting)
`,t+=`index: ${e.idx}, based on ${e.completion.sortText&&`sortText: "${e.completion.sortText}"`||"label"}
`,t+=`commit_chars: ${e.completion.commitCharacters?.join("")}
`,s=new O().appendCodeblock("empty",t),o=`Provider: ${e.provider._debugDisplayName}`}if(!i&&!j(e)){this.clearContents();return}if(this.domNode.classList.remove("no-docs","no-type"),o){const t=o.length>1e5?`${o.substr(0,1e5)}\u2026`:o;this._type.textContent=t,this._type.title=t,n.show(this._type),this._type.classList.toggle("auto-wrap",!/\r?\n^\s+/gim.test(t))}else n.clearNode(this._type),this._type.title="",n.hide(this._type),this.domNode.classList.add("no-type");if(n.clearNode(this._docs),typeof s=="string")this._docs.classList.remove("markdown-docs"),this._docs.textContent=s;else if(s){this._docs.classList.add("markdown-docs"),n.clearNode(this._docs);const t=this._markdownRenderer.render(s);this._docs.appendChild(t.element),this._renderDisposeable.add(t),this._renderDisposeable.add(this._markdownRenderer.onDidRenderAsync(()=>{this.layout(this._size.width,this._type.clientHeight+this._docs.clientHeight),this._onDidChangeContents.fire(this)}))}this.domNode.style.userSelect="text",this.domNode.tabIndex=-1,this._close.onmousedown=t=>{t.preventDefault(),t.stopPropagation()},this._close.onclick=t=>{t.preventDefault(),t.stopPropagation(),this._onDidClose.fire()},this._body.scrollTop=0,this.layout(this._size.width,this._type.clientHeight+this._docs.clientHeight),this._onDidChangeContents.fire(this)}clearContents(){this.domNode.classList.add("no-docs"),this._type.textContent="",this._docs.textContent=""}get isEmpty(){return this.domNode.classList.contains("no-docs")}get size(){return this._size}layout(e,i){const o=new n.Dimension(e,i);n.Dimension.equals(o,this._size)||(this._size=o,n.size(this.domNode,e,i)),this._scrollbar.scanDomNode()}scrollDown(e=8){this._body.scrollTop+=e}scrollUp(e=8){this._body.scrollTop-=e}scrollTop(){this._body.scrollTop=0}scrollBottom(){this._body.scrollTop=this._body.scrollHeight}pageDown(){this.scrollDown(80)}pageUp(){this.scrollUp(80)}set borderWidth(e){this._borderWidth=e}get borderWidth(){return this._borderWidth}focus(){this.domNode.focus()}};u=L([T(1,k)],u);class ee{constructor(e,i){this.widget=e;this._editor=i;this._resizable=new M,this._resizable.domNode.classList.add("suggest-details-container"),this._resizable.domNode.appendChild(e.domNode),this._resizable.enableSashes(!1,!0,!0,!1);let o,s,t=0,r=0;this._disposables.add(this._resizable.onDidWillResize(()=>{o=this._topLeft,s=this._resizable.size})),this._disposables.add(this._resizable.onDidResize(l=>{if(o&&s){this.widget.layout(l.dimension.width,l.dimension.height);let p=!1;l.west&&(r=s.width-l.dimension.width,p=!0),l.north&&(t=s.height-l.dimension.height,p=!0),p&&this._applyTopLeft({top:o.top+t,left:o.left+r})}l.done&&(o=void 0,s=void 0,t=0,r=0,this._userSize=l.dimension)})),this._disposables.add(this.widget.onDidChangeContents(()=>{this._anchorBox&&this._placeAtAnchor(this._anchorBox,this._userSize??this.widget.size,this._preferAlignAtTop)}))}allowEditorOverflow=!0;_disposables=new v;_resizable;_added=!1;_anchorBox;_preferAlignAtTop=!0;_userSize;_topLeft;dispose(){this._resizable.dispose(),this._disposables.dispose(),this.hide()}getId(){return"suggest.details"}getDomNode(){return this._resizable.domNode}getPosition(){return this._topLeft?{preference:this._topLeft}:null}show(){this._added||(this._editor.addOverlayWidget(this),this._added=!0)}hide(e=!1){this._resizable.clearSashHoverState(),this._added&&(this._editor.removeOverlayWidget(this),this._added=!1,this._anchorBox=void 0,this._topLeft=void 0),e&&(this._userSize=void 0,this.widget.clearContents())}placeAtAnchor(e,i){const o=e.getBoundingClientRect();this._anchorBox=o,this._preferAlignAtTop=i,this._placeAtAnchor(this._anchorBox,this._userSize??this.widget.size,i)}_placeAtAnchor(e,i,o){const s=n.getClientArea(this.getDomNode().ownerDocument.body),t=this.widget.getLayoutInfo(),r=new n.Dimension(220,2*t.lineHeight),l=e.top,p=(()=>{const d=s.width-(e.left+e.width+t.borderWidth+t.horizontalPadding),g=-t.borderWidth+e.left+e.width,m=new n.Dimension(d,s.height-e.top-t.borderHeight-t.verticalPadding),w=m.with(void 0,e.top+e.height-t.borderHeight-t.verticalPadding);return{top:l,left:g,fit:d-i.width,maxSizeTop:m,maxSizeBottom:w,minSize:r.with(Math.min(d,r.width))}})(),H=(()=>{const d=e.left-t.borderWidth-t.horizontalPadding,g=Math.max(t.horizontalPadding,e.left-i.width-t.borderWidth),m=new n.Dimension(d,s.height-e.top-t.borderHeight-t.verticalPadding),w=m.with(void 0,e.top+e.height-t.borderHeight-t.verticalPadding);return{top:l,left:g,fit:d-i.width,maxSizeTop:m,maxSizeBottom:w,minSize:r.with(Math.min(d,r.width))}})(),P=(()=>{const d=e.left,g=-t.borderWidth+e.top+e.height,m=new n.Dimension(e.width-t.borderHeight,s.height-e.top-e.height-t.verticalPadding);return{top:g,left:d,fit:m.height-i.height,maxSizeBottom:m,maxSizeTop:m,minSize:r.with(m.width)}})(),z=[p,H,P],h=z.find(d=>d.fit>=0)??z.sort((d,g)=>g.fit-d.fit)[0],I=e.top+e.height-t.borderHeight;let c,_=i.height;const D=Math.max(h.maxSizeTop.height,h.maxSizeBottom.height);_>D&&(_=D);let f;o?_<=h.maxSizeTop.height?(c=!0,f=h.maxSizeTop):(c=!1,f=h.maxSizeBottom):_<=h.maxSizeBottom.height?(c=!1,f=h.maxSizeBottom):(c=!0,f=h.maxSizeTop);let{top:y,left:S}=h;!c&&_>e.height&&(y=I-_);const C=this._editor.getDomNode();if(C){const d=C.getBoundingClientRect();y-=d.top,S-=d.left}this._applyTopLeft({left:S,top:y}),this._resizable.enableSashes(!c,h===p,c,h!==p),this._resizable.minSize=h.minSize,this._resizable.maxSize=f,this._resizable.layout(_,Math.min(f.width,i.width)),this.widget.layout(this._resizable.size.width,this._resizable.size.height)}_applyTopLeft(e){this._topLeft=e,this._editor.layoutOverlayWidget(this)}}export{ee as SuggestDetailsOverlay,u as SuggestDetailsWidget,j as canExpandCompletionItem};
