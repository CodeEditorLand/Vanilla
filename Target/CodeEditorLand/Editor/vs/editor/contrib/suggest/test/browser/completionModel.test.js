import n from"assert";import{ensureNoDisposablesAreLeakedInTestSuite as b}from"../../../../../base/test/common/utils.js";import{EditorOptions as l}from"../../../../common/config/editorOptions.js";import"../../../../common/core/position.js";import*as r from"../../../../common/languages.js";import{CompletionModel as a}from"../../browser/completionModel.js";import{CompletionItem as w,getSuggestionComparator as f,SnippetSortOrder as h}from"../../browser/suggest.js";import{WordDistance as u}from"../../browser/wordDistance.js";function e(m,t,o=r.CompletionItemKind.Property,i=!1,s={lineNumber:1,column:1},c,p){const d={label:m,sortText:c,filterText:p,range:{startLineNumber:s.lineNumber,startColumn:s.column-t,endLineNumber:s.lineNumber,endColumn:s.column},insertText:typeof m=="string"?m:m.label,kind:o},g={incomplete:i,suggestions:[d]},C={_debugDisplayName:"test",provideCompletionItems(){}};return new w(s,d,g,C)}suite("CompletionModel",function(){const m={insertMode:"insert",snippetsPreventQuickSuggestions:!0,filterGraceful:!0,localityBonus:!1,shareSuggestSelections:!1,showIcons:!0,showMethods:!0,showFunctions:!0,showConstructors:!0,showDeprecated:!0,showFields:!0,showVariables:!0,showClasses:!0,showStructs:!0,showInterfaces:!0,showModules:!0,showProperties:!0,showEvents:!0,showOperators:!0,showUnits:!0,showValues:!0,showConstants:!0,showEnums:!0,showEnumMembers:!0,showKeywords:!0,showWords:!0,showColors:!0,showFiles:!0,showReferences:!0,showFolders:!0,showTypeParameters:!0,showSnippets:!0};let t;setup(function(){t=new a([e("foo",3),e("Foo",3),e("foo",2)],1,{leadingLineContent:"foo",characterCountDelta:0},u.None,l.suggest.defaultValue,l.snippetSuggestions.defaultValue,void 0)}),b(),test("filtering - cached",function(){const o=t.items;let i=t.items;n.ok(o===i),t.lineContext={leadingLineContent:"foo",characterCountDelta:0},i=t.items,n.ok(o===i),t.lineContext={leadingLineContent:"foo1",characterCountDelta:1},i=t.items,n.ok(o!==i)}),test("complete/incomplete",()=>{n.strictEqual(t.getIncompleteProvider().size,0);const o=new a([e("foo",3,void 0,!0),e("foo",2)],1,{leadingLineContent:"foo",characterCountDelta:0},u.None,l.suggest.defaultValue,l.snippetSuggestions.defaultValue,void 0);n.strictEqual(o.getIncompleteProvider().size,1)}),test("Fuzzy matching of snippets stopped working with inline snippet suggestions #49895",function(){const o=e("foobar1",1,void 0,!1,{lineNumber:1,column:2}),i=e("foobar2",1,void 0,!1,{lineNumber:1,column:2}),s=e("foobar3",1,void 0,!1,{lineNumber:1,column:2}),c=e("foobar4",1,void 0,!1,{lineNumber:1,column:2}),p=e("foobar5",1,void 0,!1,{lineNumber:1,column:2}),d=e("foofoo1",1,void 0,!0,{lineNumber:1,column:2}),g=new a([o,i,s,c,p,d],2,{leadingLineContent:"f",characterCountDelta:0},u.None,l.suggest.defaultValue,l.snippetSuggestions.defaultValue,void 0);n.strictEqual(g.getIncompleteProvider().size,1),n.strictEqual(g.items.length,6)}),test("proper current word when length=0, #16380",function(){t=new a([e("    </div",4),e("a",0),e("p",0),e("    </tag",4),e("    XYZ",4)],1,{leadingLineContent:"   <",characterCountDelta:0},u.None,l.suggest.defaultValue,l.snippetSuggestions.defaultValue,void 0),n.strictEqual(t.items.length,4);const[o,i,s,c]=t.items;n.strictEqual(o.completion.label,"    </div"),n.strictEqual(i.completion.label,"    </tag"),n.strictEqual(s.completion.label,"a"),n.strictEqual(c.completion.label,"p")}),test("keep snippet sorting with prefix: top, #25495",function(){t=new a([e("Snippet1",1,r.CompletionItemKind.Snippet),e("tnippet2",1,r.CompletionItemKind.Snippet),e("semver",1,r.CompletionItemKind.Property)],1,{leadingLineContent:"s",characterCountDelta:0},u.None,m,"top",void 0),n.strictEqual(t.items.length,2);const[o,i]=t.items;n.strictEqual(o.completion.label,"Snippet1"),n.strictEqual(i.completion.label,"semver"),n.ok(o.score<i.score)}),test("keep snippet sorting with prefix: bottom, #25495",function(){t=new a([e("snippet1",1,r.CompletionItemKind.Snippet),e("tnippet2",1,r.CompletionItemKind.Snippet),e("Semver",1,r.CompletionItemKind.Property)],1,{leadingLineContent:"s",characterCountDelta:0},u.None,m,"bottom",void 0),n.strictEqual(t.items.length,2);const[o,i]=t.items;n.strictEqual(o.completion.label,"Semver"),n.strictEqual(i.completion.label,"snippet1"),n.ok(o.score<i.score)}),test("keep snippet sorting with prefix: inline, #25495",function(){t=new a([e("snippet1",1,r.CompletionItemKind.Snippet),e("tnippet2",1,r.CompletionItemKind.Snippet),e("Semver",1)],1,{leadingLineContent:"s",characterCountDelta:0},u.None,m,"inline",void 0),n.strictEqual(t.items.length,2);const[o,i]=t.items;n.strictEqual(o.completion.label,"snippet1"),n.strictEqual(i.completion.label,"Semver"),n.ok(o.score>i.score)}),test("filterText seems ignored in autocompletion, #26874",function(){const o=e("Map - java.util",1,void 0,void 0,void 0,void 0,"Map"),i=e("Map - java.util",1);t=new a([o,i],1,{leadingLineContent:"M",characterCountDelta:0},u.None,l.suggest.defaultValue,l.snippetSuggestions.defaultValue,void 0),n.strictEqual(t.items.length,2),t.lineContext={leadingLineContent:"Map ",characterCountDelta:3},n.strictEqual(t.items.length,1)}),test("Vscode 1.12 no longer obeys 'sortText' in completion items (from language server), #26096",function(){const o=e("<- groups",2,r.CompletionItemKind.Property,!1,{lineNumber:1,column:3},"00002","  groups"),i=e("source",0,r.CompletionItemKind.Property,!1,{lineNumber:1,column:3},"00001","source"),s=[o,i].sort(f(h.Inline));t=new a(s,3,{leadingLineContent:"  ",characterCountDelta:0},u.None,l.suggest.defaultValue,l.snippetSuggestions.defaultValue,void 0),n.strictEqual(t.items.length,2);const[c,p]=t.items;n.strictEqual(c.completion.label,"source"),n.strictEqual(p.completion.label,"<- groups")}),test("Completion item sorting broken when using label details #153026",function(){const o=e({label:"ZZZ"},0,r.CompletionItemKind.Operator,!1),i=e({label:"AAA"},0,r.CompletionItemKind.Operator,!1),s=e("III",0,r.CompletionItemKind.Operator,!1),c=f(h.Inline),p=[o,i,s].sort(c);n.deepStrictEqual(p,[i,s,o])}),test("Score only filtered items when typing more, score all when typing less",function(){t=new a([e("console",0),e("co_new",0),e("bar",0),e("car",0),e("foo",0)],1,{leadingLineContent:"",characterCountDelta:0},u.None,l.suggest.defaultValue,l.snippetSuggestions.defaultValue,void 0),n.strictEqual(t.items.length,5),t.lineContext={leadingLineContent:"c",characterCountDelta:1},n.strictEqual(t.items.length,3),t.lineContext={leadingLineContent:"cn",characterCountDelta:2},n.strictEqual(t.items.length,2),t.lineContext={leadingLineContent:"",characterCountDelta:0},n.strictEqual(t.items.length,5)}),test("Have more relaxed suggest matching algorithm #15419",function(){t=new a([e("result",0),e("replyToUser",0),e("randomLolut",0),e("car",0),e("foo",0)],1,{leadingLineContent:"",characterCountDelta:0},u.None,l.suggest.defaultValue,l.snippetSuggestions.defaultValue,void 0),t.lineContext={leadingLineContent:"rlut",characterCountDelta:4},n.strictEqual(t.items.length,3);const[o,i,s]=t.items;n.strictEqual(o.completion.label,"result"),n.strictEqual(i.completion.label,"replyToUser"),n.strictEqual(s.completion.label,"randomLolut")}),test("Emmet suggestion not appearing at the top of the list in jsx files, #39518",function(){t=new a([e("from",0),e("form",0),e("form:get",0),e("testForeignMeasure",0),e("fooRoom",0)],1,{leadingLineContent:"",characterCountDelta:0},u.None,l.suggest.defaultValue,l.snippetSuggestions.defaultValue,void 0),t.lineContext={leadingLineContent:"form",characterCountDelta:4},n.strictEqual(t.items.length,5);const[o,i,s]=t.items;n.strictEqual(o.completion.label,"form"),n.strictEqual(i.completion.label,"form:get"),n.strictEqual(s.completion.label,"from")})});export{e as createSuggestItem};
