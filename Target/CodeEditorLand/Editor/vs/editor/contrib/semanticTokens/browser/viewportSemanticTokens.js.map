{
  "version": 3,
  "sources": ["../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/editor/contrib/semanticTokens/browser/viewportSemanticTokens.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport {\n\ttype CancelablePromise,\n\tRunOnceScheduler,\n\tcreateCancelablePromise,\n} from \"../../../../base/common/async.js\";\nimport { Disposable } from \"../../../../base/common/lifecycle.js\";\nimport { StopWatch } from \"../../../../base/common/stopwatch.js\";\nimport { IConfigurationService } from \"../../../../platform/configuration/common/configuration.js\";\nimport { IThemeService } from \"../../../../platform/theme/common/themeService.js\";\nimport type { ICodeEditor } from \"../../../browser/editorBrowser.js\";\nimport {\n\tEditorContributionInstantiation,\n\tregisterEditorContribution,\n} from \"../../../browser/editorExtensions.js\";\nimport type { Range } from \"../../../common/core/range.js\";\nimport type { IEditorContribution } from \"../../../common/editorCommon.js\";\nimport type { LanguageFeatureRegistry } from \"../../../common/languageFeatureRegistry.js\";\nimport type { DocumentRangeSemanticTokensProvider } from \"../../../common/languages.js\";\nimport type { ITextModel } from \"../../../common/model.js\";\nimport {\n\ttype IFeatureDebounceInformation,\n\tILanguageFeatureDebounceService,\n} from \"../../../common/services/languageFeatureDebounce.js\";\nimport { ILanguageFeaturesService } from \"../../../common/services/languageFeatures.js\";\nimport { toMultilineTokens2 } from \"../../../common/services/semanticTokensProviderStyling.js\";\nimport { ISemanticTokensStylingService } from \"../../../common/services/semanticTokensStyling.js\";\nimport {\n\tgetDocumentRangeSemanticTokens,\n\thasDocumentRangeSemanticTokensProvider,\n} from \"../common/getSemanticTokens.js\";\nimport {\n\tSEMANTIC_HIGHLIGHTING_SETTING_ID,\n\tisSemanticColoringEnabled,\n} from \"../common/semanticTokensConfig.js\";\n\nexport class ViewportSemanticTokensContribution\n\textends Disposable\n\timplements IEditorContribution\n{\n\tpublic static readonly ID = \"editor.contrib.viewportSemanticTokens\";\n\n\tpublic static get(\n\t\teditor: ICodeEditor,\n\t): ViewportSemanticTokensContribution | null {\n\t\treturn editor.getContribution<ViewportSemanticTokensContribution>(\n\t\t\tViewportSemanticTokensContribution.ID,\n\t\t);\n\t}\n\n\tprivate readonly _editor: ICodeEditor;\n\tprivate readonly _provider: LanguageFeatureRegistry<DocumentRangeSemanticTokensProvider>;\n\tprivate readonly _debounceInformation: IFeatureDebounceInformation;\n\tprivate readonly _tokenizeViewport: RunOnceScheduler;\n\tprivate _outstandingRequests: CancelablePromise<any>[];\n\n\tconstructor(\n\t\teditor: ICodeEditor,\n\t\t@ISemanticTokensStylingService\n\t\tprivate readonly _semanticTokensStylingService: ISemanticTokensStylingService,\n\t\t@IThemeService private readonly _themeService: IThemeService,\n\t\t@IConfigurationService\n\t\tprivate readonly _configurationService: IConfigurationService,\n\t\t@ILanguageFeatureDebounceService\n\t\tlanguageFeatureDebounceService: ILanguageFeatureDebounceService,\n\t\t@ILanguageFeaturesService\n\t\tlanguageFeaturesService: ILanguageFeaturesService,\n\t) {\n\t\tsuper();\n\t\tthis._editor = editor;\n\t\tthis._provider =\n\t\t\tlanguageFeaturesService.documentRangeSemanticTokensProvider;\n\t\tthis._debounceInformation = languageFeatureDebounceService.for(\n\t\t\tthis._provider,\n\t\t\t\"DocumentRangeSemanticTokens\",\n\t\t\t{ min: 100, max: 500 },\n\t\t);\n\t\tthis._tokenizeViewport = this._register(\n\t\t\tnew RunOnceScheduler(() => this._tokenizeViewportNow(), 100),\n\t\t);\n\t\tthis._outstandingRequests = [];\n\t\tconst scheduleTokenizeViewport = () => {\n\t\t\tif (this._editor.hasModel()) {\n\t\t\t\tthis._tokenizeViewport.schedule(\n\t\t\t\t\tthis._debounceInformation.get(this._editor.getModel()),\n\t\t\t\t);\n\t\t\t}\n\t\t};\n\t\tthis._register(\n\t\t\tthis._editor.onDidScrollChange(() => {\n\t\t\t\tscheduleTokenizeViewport();\n\t\t\t}),\n\t\t);\n\t\tthis._register(\n\t\t\tthis._editor.onDidChangeModel(() => {\n\t\t\t\tthis._cancelAll();\n\t\t\t\tscheduleTokenizeViewport();\n\t\t\t}),\n\t\t);\n\t\tthis._register(\n\t\t\tthis._editor.onDidChangeModelContent((e) => {\n\t\t\t\tthis._cancelAll();\n\t\t\t\tscheduleTokenizeViewport();\n\t\t\t}),\n\t\t);\n\t\tthis._register(\n\t\t\tthis._provider.onDidChange(() => {\n\t\t\t\tthis._cancelAll();\n\t\t\t\tscheduleTokenizeViewport();\n\t\t\t}),\n\t\t);\n\t\tthis._register(\n\t\t\tthis._configurationService.onDidChangeConfiguration((e) => {\n\t\t\t\tif (e.affectsConfiguration(SEMANTIC_HIGHLIGHTING_SETTING_ID)) {\n\t\t\t\t\tthis._cancelAll();\n\t\t\t\t\tscheduleTokenizeViewport();\n\t\t\t\t}\n\t\t\t}),\n\t\t);\n\t\tthis._register(\n\t\t\tthis._themeService.onDidColorThemeChange(() => {\n\t\t\t\tthis._cancelAll();\n\t\t\t\tscheduleTokenizeViewport();\n\t\t\t}),\n\t\t);\n\t\tscheduleTokenizeViewport();\n\t}\n\n\tprivate _cancelAll(): void {\n\t\tfor (const request of this._outstandingRequests) {\n\t\t\trequest.cancel();\n\t\t}\n\t\tthis._outstandingRequests = [];\n\t}\n\n\tprivate _removeOutstandingRequest(req: CancelablePromise<any>): void {\n\t\tfor (let i = 0, len = this._outstandingRequests.length; i < len; i++) {\n\t\t\tif (this._outstandingRequests[i] === req) {\n\t\t\t\tthis._outstandingRequests.splice(i, 1);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate _tokenizeViewportNow(): void {\n\t\tif (!this._editor.hasModel()) {\n\t\t\treturn;\n\t\t}\n\t\tconst model = this._editor.getModel();\n\t\tif (model.tokenization.hasCompleteSemanticTokens()) {\n\t\t\treturn;\n\t\t}\n\t\tif (\n\t\t\t!isSemanticColoringEnabled(\n\t\t\t\tmodel,\n\t\t\t\tthis._themeService,\n\t\t\t\tthis._configurationService,\n\t\t\t)\n\t\t) {\n\t\t\tif (model.tokenization.hasSomeSemanticTokens()) {\n\t\t\t\tmodel.tokenization.setSemanticTokens(null, false);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\t\tif (!hasDocumentRangeSemanticTokensProvider(this._provider, model)) {\n\t\t\tif (model.tokenization.hasSomeSemanticTokens()) {\n\t\t\t\tmodel.tokenization.setSemanticTokens(null, false);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\t\tconst visibleRanges =\n\t\t\tthis._editor.getVisibleRangesPlusViewportAboveBelow();\n\n\t\tthis._outstandingRequests = this._outstandingRequests.concat(\n\t\t\tvisibleRanges.map((range) => this._requestRange(model, range)),\n\t\t);\n\t}\n\n\tprivate _requestRange(\n\t\tmodel: ITextModel,\n\t\trange: Range,\n\t): CancelablePromise<any> {\n\t\tconst requestVersionId = model.getVersionId();\n\t\tconst request = createCancelablePromise((token) =>\n\t\t\tPromise.resolve(\n\t\t\t\tgetDocumentRangeSemanticTokens(\n\t\t\t\t\tthis._provider,\n\t\t\t\t\tmodel,\n\t\t\t\t\trange,\n\t\t\t\t\ttoken,\n\t\t\t\t),\n\t\t\t),\n\t\t);\n\t\tconst sw = new StopWatch(false);\n\t\trequest\n\t\t\t.then((r) => {\n\t\t\t\tthis._debounceInformation.update(model, sw.elapsed());\n\t\t\t\tif (\n\t\t\t\t\t!r ||\n\t\t\t\t\t!r.tokens ||\n\t\t\t\t\tmodel.isDisposed() ||\n\t\t\t\t\tmodel.getVersionId() !== requestVersionId\n\t\t\t\t) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconst { provider, tokens: result } = r;\n\t\t\t\tconst styling =\n\t\t\t\t\tthis._semanticTokensStylingService.getStyling(provider);\n\t\t\t\tmodel.tokenization.setPartialSemanticTokens(\n\t\t\t\t\trange,\n\t\t\t\t\ttoMultilineTokens2(result, styling, model.getLanguageId()),\n\t\t\t\t);\n\t\t\t})\n\t\t\t.then(\n\t\t\t\t() => this._removeOutstandingRequest(request),\n\t\t\t\t() => this._removeOutstandingRequest(request),\n\t\t\t);\n\t\treturn request;\n\t}\n}\n\nregisterEditorContribution(\n\tViewportSemanticTokensContribution.ID,\n\tViewportSemanticTokensContribution,\n\tEditorContributionInstantiation.AfterFirstRender,\n);\n"],
  "mappings": "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",
  "names": []
}
