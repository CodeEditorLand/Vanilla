var h=Object.defineProperty;var _=Object.getOwnPropertyDescriptor;var m=(d,s,e,t)=>{for(var i=t>1?void 0:t?_(s,e):s,o=d.length-1,a;o>=0;o--)(a=d[o])&&(i=(t?a(s,e,i):a(i))||i);return t&&i&&h(s,e,i),i},u=(d,s)=>(e,t)=>s(e,t,d);import{createCancelablePromise as p,RunOnceScheduler as f}from"../../../../base/common/async.js";import{Disposable as v}from"../../../../base/common/lifecycle.js";import{StopWatch as S}from"../../../../base/common/stopwatch.js";import{IConfigurationService as I}from"../../../../platform/configuration/common/configuration.js";import{IThemeService as k}from"../../../../platform/theme/common/themeService.js";import"../../../browser/editorBrowser.js";import{EditorContributionInstantiation as R,registerEditorContribution as C}from"../../../browser/editorExtensions.js";import"../../../common/core/range.js";import"../../../common/editorCommon.js";import"../../../common/languageFeatureRegistry.js";import"../../../common/languages.js";import"../../../common/model.js";import{ILanguageFeatureDebounceService as T}from"../../../common/services/languageFeatureDebounce.js";import{ILanguageFeaturesService as b}from"../../../common/services/languageFeatures.js";import{toMultilineTokens2 as D}from"../../../common/services/semanticTokensProviderStyling.js";import{ISemanticTokensStylingService as y}from"../../../common/services/semanticTokensStyling.js";import{getDocumentRangeSemanticTokens as q,hasDocumentRangeSemanticTokensProvider as w}from"../common/getSemanticTokens.js";import{isSemanticColoringEnabled as z,SEMANTIC_HIGHLIGHTING_SETTING_ID as P}from"../common/semanticTokensConfig.js";let r=class extends v{constructor(e,t,i,o,a,c){super();this._semanticTokensStylingService=t;this._themeService=i;this._configurationService=o;this._editor=e,this._provider=c.documentRangeSemanticTokensProvider,this._debounceInformation=a.for(this._provider,"DocumentRangeSemanticTokens",{min:100,max:500}),this._tokenizeViewport=this._register(new f(()=>this._tokenizeViewportNow(),100)),this._outstandingRequests=[];const n=()=>{this._editor.hasModel()&&this._tokenizeViewport.schedule(this._debounceInformation.get(this._editor.getModel()))};this._register(this._editor.onDidScrollChange(()=>{n()})),this._register(this._editor.onDidChangeModel(()=>{this._cancelAll(),n()})),this._register(this._editor.onDidChangeModelContent(l=>{this._cancelAll(),n()})),this._register(this._provider.onDidChange(()=>{this._cancelAll(),n()})),this._register(this._configurationService.onDidChangeConfiguration(l=>{l.affectsConfiguration(P)&&(this._cancelAll(),n())})),this._register(this._themeService.onDidColorThemeChange(()=>{this._cancelAll(),n()})),n()}static ID="editor.contrib.viewportSemanticTokens";static get(e){return e.getContribution(r.ID)}_editor;_provider;_debounceInformation;_tokenizeViewport;_outstandingRequests;_cancelAll(){for(const e of this._outstandingRequests)e.cancel();this._outstandingRequests=[]}_removeOutstandingRequest(e){for(let t=0,i=this._outstandingRequests.length;t<i;t++)if(this._outstandingRequests[t]===e){this._outstandingRequests.splice(t,1);return}}_tokenizeViewportNow(){if(!this._editor.hasModel())return;const e=this._editor.getModel();if(e.tokenization.hasCompleteSemanticTokens())return;if(!z(e,this._themeService,this._configurationService)){e.tokenization.hasSomeSemanticTokens()&&e.tokenization.setSemanticTokens(null,!1);return}if(!w(this._provider,e)){e.tokenization.hasSomeSemanticTokens()&&e.tokenization.setSemanticTokens(null,!1);return}const t=this._editor.getVisibleRangesPlusViewportAboveBelow();this._outstandingRequests=this._outstandingRequests.concat(t.map(i=>this._requestRange(e,i)))}_requestRange(e,t){const i=e.getVersionId(),o=p(c=>Promise.resolve(q(this._provider,e,t,c))),a=new S(!1);return o.then(c=>{if(this._debounceInformation.update(e,a.elapsed()),!c||!c.tokens||e.isDisposed()||e.getVersionId()!==i)return;const{provider:n,tokens:l}=c,g=this._semanticTokensStylingService.getStyling(n);e.tokenization.setPartialSemanticTokens(t,D(l,g,e.getLanguageId()))}).then(()=>this._removeOutstandingRequest(o),()=>this._removeOutstandingRequest(o)),o}};r=m([u(1,y),u(2,k),u(3,I),u(4,T),u(5,b)],r),C(r.ID,r,R.AfterFirstRender);export{r as ViewportSemanticTokensContribution};
