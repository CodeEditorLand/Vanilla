var b=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var D=(p,l,n,e)=>{for(var o=e>1?void 0:e?L(l,n):l,u=p.length-1,i;u>=0;u--)(i=p[u])&&(o=(e?i(l,n,o):i(o))||o);return e&&o&&b(l,n,o),o},d=(p,l)=>(n,e)=>l(n,e,p);import{RunOnceScheduler as q}from"../../../../base/common/async.js";import{CancellationTokenSource as w}from"../../../../base/common/cancellation.js";import*as v from"../../../../base/common/errors.js";import{Disposable as I,dispose as k}from"../../../../base/common/lifecycle.js";import{StopWatch as M}from"../../../../base/common/stopwatch.js";import{IConfigurationService as P}from"../../../../platform/configuration/common/configuration.js";import{IThemeService as C}from"../../../../platform/theme/common/themeService.js";import{registerEditorFeature as x}from"../../../common/editorFeatures.js";import{ILanguageFeatureDebounceService as R}from"../../../common/services/languageFeatureDebounce.js";import{ILanguageFeaturesService as y}from"../../../common/services/languageFeatures.js";import{IModelService as A}from"../../../common/services/model.js";import{toMultilineTokens2 as U}from"../../../common/services/semanticTokensProviderStyling.js";import{ISemanticTokensStylingService as E}from"../../../common/services/semanticTokensStyling.js";import{getDocumentSemanticTokens as F,hasDocumentSemanticTokensProvider as N,isSemanticTokens as z,isSemanticTokensEdits as j}from"../common/getSemanticTokens.js";import{SEMANTIC_HIGHLIGHTING_SETTING_ID as Q,isSemanticColoringEnabled as T}from"../common/semanticTokensConfig.js";let S=class extends I{_watchers;constructor(l,n,e,o,u,i){super(),this._watchers=Object.create(null);const c=t=>{this._watchers[t.uri.toString()]=new h(t,l,e,u,i)},a=(t,r)=>{r.dispose(),delete this._watchers[t.uri.toString()]},s=()=>{for(const t of n.getModels()){const r=this._watchers[t.uri.toString()];T(t,e,o)?r||c(t):r&&a(t,r)}};n.getModels().forEach(t=>{T(t,e,o)&&c(t)}),this._register(n.onModelAdded(t=>{T(t,e,o)&&c(t)})),this._register(n.onModelRemoved(t=>{const r=this._watchers[t.uri.toString()];r&&a(t,r)})),this._register(o.onDidChangeConfiguration(t=>{t.affectsConfiguration(Q)&&s()})),this._register(e.onDidColorThemeChange(s))}dispose(){for(const l of Object.values(this._watchers))l.dispose();super.dispose()}};S=D([d(0,E),d(1,A),d(2,C),d(3,P),d(4,R),d(5,y)],S);let h=class extends I{constructor(n,e,o,u,i){super();this._semanticTokensStylingService=e;this._isDisposed=!1,this._model=n,this._provider=i.documentSemanticTokensProvider,this._debounceInformation=u.for(this._provider,"DocumentSemanticTokens",{min:h.REQUEST_MIN_DELAY,max:h.REQUEST_MAX_DELAY}),this._fetchDocumentSemanticTokens=this._register(new q(()=>this._fetchDocumentSemanticTokensNow(),h.REQUEST_MIN_DELAY)),this._currentDocumentResponse=null,this._currentDocumentRequestCancellationTokenSource=null,this._documentProvidersChangeListeners=[],this._providersChangedDuringRequest=!1,this._register(this._model.onDidChangeContent(()=>{this._fetchDocumentSemanticTokens.isScheduled()||this._fetchDocumentSemanticTokens.schedule(this._debounceInformation.get(this._model))})),this._register(this._model.onDidChangeAttached(()=>{this._fetchDocumentSemanticTokens.isScheduled()||this._fetchDocumentSemanticTokens.schedule(this._debounceInformation.get(this._model))})),this._register(this._model.onDidChangeLanguage(()=>{this._currentDocumentResponse&&(this._currentDocumentResponse.dispose(),this._currentDocumentResponse=null),this._currentDocumentRequestCancellationTokenSource&&(this._currentDocumentRequestCancellationTokenSource.cancel(),this._currentDocumentRequestCancellationTokenSource=null),this._setDocumentSemanticTokens(null,null,null,[]),this._fetchDocumentSemanticTokens.schedule(0)}));const c=()=>{k(this._documentProvidersChangeListeners),this._documentProvidersChangeListeners=[];for(const a of this._provider.all(n))typeof a.onDidChange=="function"&&this._documentProvidersChangeListeners.push(a.onDidChange(()=>{if(this._currentDocumentRequestCancellationTokenSource){this._providersChangedDuringRequest=!0;return}this._fetchDocumentSemanticTokens.schedule(0)}))};c(),this._register(this._provider.onDidChange(()=>{c(),this._fetchDocumentSemanticTokens.schedule(this._debounceInformation.get(this._model))})),this._register(o.onDidColorThemeChange(a=>{this._setDocumentSemanticTokens(null,null,null,[]),this._fetchDocumentSemanticTokens.schedule(this._debounceInformation.get(this._model))})),this._fetchDocumentSemanticTokens.schedule(0)}static REQUEST_MIN_DELAY=300;static REQUEST_MAX_DELAY=2e3;_isDisposed;_model;_provider;_debounceInformation;_fetchDocumentSemanticTokens;_currentDocumentResponse;_currentDocumentRequestCancellationTokenSource;_documentProvidersChangeListeners;_providersChangedDuringRequest;dispose(){this._currentDocumentResponse&&(this._currentDocumentResponse.dispose(),this._currentDocumentResponse=null),this._currentDocumentRequestCancellationTokenSource&&(this._currentDocumentRequestCancellationTokenSource.cancel(),this._currentDocumentRequestCancellationTokenSource=null),k(this._documentProvidersChangeListeners),this._documentProvidersChangeListeners=[],this._setDocumentSemanticTokens(null,null,null,[]),this._isDisposed=!0,super.dispose()}_fetchDocumentSemanticTokensNow(){if(this._currentDocumentRequestCancellationTokenSource)return;if(!N(this._provider,this._model)){this._currentDocumentResponse&&this._model.tokenization.setSemanticTokens(null,!1);return}if(!this._model.isAttachedToEditor())return;const n=new w,e=this._currentDocumentResponse?this._currentDocumentResponse.provider:null,o=this._currentDocumentResponse&&this._currentDocumentResponse.resultId||null,u=F(this._provider,this._model,e,o,n.token);this._currentDocumentRequestCancellationTokenSource=n,this._providersChangedDuringRequest=!1;const i=[],c=this._model.onDidChangeContent(s=>{i.push(s)}),a=new M(!1);u.then(s=>{if(this._debounceInformation.update(this._model,a.elapsed()),this._currentDocumentRequestCancellationTokenSource=null,c.dispose(),s){const{provider:t,tokens:r}=s,g=this._semanticTokensStylingService.getStyling(t);this._setDocumentSemanticTokens(t,r||null,g,i)}else this._setDocumentSemanticTokens(null,null,null,i)},s=>{s&&(v.isCancellationError(s)||typeof s.message=="string"&&s.message.indexOf("busy")!==-1)||v.onUnexpectedError(s),this._currentDocumentRequestCancellationTokenSource=null,c.dispose(),(i.length>0||this._providersChangedDuringRequest)&&(this._fetchDocumentSemanticTokens.isScheduled()||this._fetchDocumentSemanticTokens.schedule(this._debounceInformation.get(this._model)))})}static _copy(n,e,o,u,i){i=Math.min(i,o.length-u,n.length-e);for(let c=0;c<i;c++)o[u+c]=n[e+c]}_setDocumentSemanticTokens(n,e,o,u){const i=this._currentDocumentResponse,c=()=>{(u.length>0||this._providersChangedDuringRequest)&&!this._fetchDocumentSemanticTokens.isScheduled()&&this._fetchDocumentSemanticTokens.schedule(this._debounceInformation.get(this._model))};if(this._currentDocumentResponse&&(this._currentDocumentResponse.dispose(),this._currentDocumentResponse=null),this._isDisposed){n&&e&&n.releaseDocumentSemanticTokens(e.resultId);return}if(!n||!o){this._model.tokenization.setSemanticTokens(null,!1);return}if(!e){this._model.tokenization.setSemanticTokens(null,!0),c();return}if(j(e)){if(!i){this._model.tokenization.setSemanticTokens(null,!0);return}if(e.edits.length===0)e={resultId:e.resultId,data:i.data};else{let a=0;for(const _ of e.edits)a+=(_.data?_.data.length:0)-_.deleteCount;const s=i.data,t=new Uint32Array(s.length+a);let r=s.length,g=t.length;for(let _=e.edits.length-1;_>=0;_--){const m=e.edits[_];if(m.start>s.length){o.warnInvalidEditStart(i.resultId,e.resultId,_,m.start,s.length),this._model.tokenization.setSemanticTokens(null,!0);return}const f=r-(m.start+m.deleteCount);f>0&&(h._copy(s,r-f,t,g-f,f),g-=f),m.data&&(h._copy(m.data,0,t,g-m.data.length,m.data.length),g-=m.data.length),r=m.start}r>0&&h._copy(s,0,t,0,r),e={resultId:e.resultId,data:t}}}if(z(e)){this._currentDocumentResponse=new Y(n,e.resultId,e.data);const a=U(e,o,this._model.getLanguageId());if(u.length>0)for(const s of u)for(const t of a)for(const r of s.changes)t.applyEdit(r.range,r.text);this._model.tokenization.setSemanticTokens(a,!0)}else this._model.tokenization.setSemanticTokens(null,!0);c()}};h=D([d(1,E),d(2,C),d(3,R),d(4,y)],h);class Y{constructor(l,n,e){this.provider=l;this.resultId=n;this.data=e}dispose(){this.provider.releaseDocumentSemanticTokens(this.resultId)}}x(S);export{S as DocumentSemanticTokensFeature};
