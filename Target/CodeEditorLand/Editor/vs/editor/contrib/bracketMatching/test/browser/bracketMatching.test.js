import o from"assert";import{Position as n}from"../../../../common/core/position.js";import{Selection as i}from"../../../../common/core/selection.js";import{ILanguageConfigurationService as p}from"../../../../common/languages/languageConfigurationRegistry.js";import{BracketMatchingController as a}from"../../browser/bracketMatching.js";import{createCodeEditorServices as S,instantiateTestCodeEditor as w}from"../../../../test/browser/testCodeEditor.js";import{instantiateTextModel as m}from"../../../../test/common/testTextModel.js";import{DisposableStore as k}from"../../../../../base/common/lifecycle.js";import"../../../../../platform/instantiation/test/common/instantiationServiceMock.js";import{ILanguageService as E}from"../../../../common/languages/language.js";import{ensureNoDisposablesAreLeakedInTestSuite as P}from"../../../../../base/test/common/utils.js";suite("bracket matching",()=>{let r,l,u,d;setup(()=>{r=new k,l=S(r),u=l.get(p),d=l.get(E)}),teardown(()=>{r.dispose()}),P();function g(e){const t="bracketMode";return r.add(d.registerLanguage({id:t})),r.add(u.register(t,{brackets:[["{","}"],["[","]"],["(",")"]]})),r.add(m(l,e,t))}function c(e){return r.add(w(l,g(e)))}test("issue #183: jump to matching bracket position",()=>{const e=c("var x = (3 + (5-7)) + ((5+3)+5);"),t=r.add(e.registerAndInstantiateContribution(a.ID,a));e.setPosition(new n(1,20)),t.jumpToBracket(),o.deepStrictEqual(e.getPosition(),new n(1,9)),t.jumpToBracket(),o.deepStrictEqual(e.getPosition(),new n(1,19)),t.jumpToBracket(),o.deepStrictEqual(e.getPosition(),new n(1,9)),e.setPosition(new n(1,23)),t.jumpToBracket(),o.deepStrictEqual(e.getPosition(),new n(1,31)),t.jumpToBracket(),o.deepStrictEqual(e.getPosition(),new n(1,23)),t.jumpToBracket(),o.deepStrictEqual(e.getPosition(),new n(1,31))}),test("Jump to next bracket",()=>{const e=c("var x = (3 + (5-7)); y();"),t=r.add(e.registerAndInstantiateContribution(a.ID,a));e.setPosition(new n(1,16)),t.jumpToBracket(),o.deepStrictEqual(e.getPosition(),new n(1,18)),t.jumpToBracket(),o.deepStrictEqual(e.getPosition(),new n(1,14)),t.jumpToBracket(),o.deepStrictEqual(e.getPosition(),new n(1,18)),e.setPosition(new n(1,21)),t.jumpToBracket(),o.deepStrictEqual(e.getPosition(),new n(1,23)),t.jumpToBracket(),o.deepStrictEqual(e.getPosition(),new n(1,24)),t.jumpToBracket(),o.deepStrictEqual(e.getPosition(),new n(1,23)),e.setPosition(new n(1,26)),t.jumpToBracket(),o.deepStrictEqual(e.getPosition(),new n(1,26))}),test("Select to next bracket",()=>{const e=c("var x = (3 + (5-7)); y();"),t=r.add(e.registerAndInstantiateContribution(a.ID,a));e.setPosition(new n(1,9)),t.selectToBracket(!0),o.deepStrictEqual(e.getPosition(),new n(1,20)),o.deepStrictEqual(e.getSelection(),new i(1,9,1,20)),e.setPosition(new n(1,20)),t.selectToBracket(!0),o.deepStrictEqual(e.getPosition(),new n(1,9)),o.deepStrictEqual(e.getSelection(),new i(1,20,1,9)),e.setPosition(new n(1,16)),t.selectToBracket(!0),o.deepStrictEqual(e.getPosition(),new n(1,19)),o.deepStrictEqual(e.getSelection(),new i(1,14,1,19)),e.setPosition(new n(1,21)),t.selectToBracket(!0),o.deepStrictEqual(e.getPosition(),new n(1,25)),o.deepStrictEqual(e.getSelection(),new i(1,23,1,25)),e.setPosition(new n(1,26)),t.selectToBracket(!0),o.deepStrictEqual(e.getPosition(),new n(1,26)),o.deepStrictEqual(e.getSelection(),new i(1,26,1,26))}),test("issue #1772: jump to enclosing brackets",()=>{const e=["const x = {","    something: [0, 1, 2],","    another: true,","    somethingmore: [0, 2, 4]","};"].join(`
`),t=c(e),s=r.add(t.registerAndInstantiateContribution(a.ID,a));t.setPosition(new n(3,5)),s.jumpToBracket(),o.deepStrictEqual(t.getSelection(),new i(5,1,5,1))}),test("issue #43371: argument to not select brackets",()=>{const e=["const x = {","    something: [0, 1, 2],","    another: true,","    somethingmore: [0, 2, 4]","};"].join(`
`),t=c(e),s=r.add(t.registerAndInstantiateContribution(a.ID,a));t.setPosition(new n(3,5)),s.selectToBracket(!1),o.deepStrictEqual(t.getSelection(),new i(1,12,5,1))}),test("issue #45369: Select to Bracket with multicursor",()=>{const e=c("{  }   {   }   { }"),t=r.add(e.registerAndInstantiateContribution(a.ID,a));e.setSelections([new i(1,3,1,3),new i(1,10,1,10),new i(1,17,1,17)]),t.selectToBracket(!0),o.deepStrictEqual(e.getSelections(),[new i(1,1,1,5),new i(1,8,1,13),new i(1,16,1,19)]),e.setSelections([new i(1,1,1,1),new i(1,6,1,6),new i(1,14,1,14)]),t.selectToBracket(!0),o.deepStrictEqual(e.getSelections(),[new i(1,1,1,5),new i(1,8,1,13),new i(1,16,1,19)]),e.setSelections([new i(1,5,1,5),new i(1,13,1,13),new i(1,19,1,19)]),t.selectToBracket(!0),o.deepStrictEqual(e.getSelections(),[new i(1,5,1,1),new i(1,13,1,8),new i(1,19,1,16)])}),test("Removes brackets",()=>{const e=c("var x = (3 + (5-7)); y();"),t=r.add(e.registerAndInstantiateContribution(a.ID,a));function s(){t.removeBrackets()}e.setPosition(new n(1,9)),s(),o.deepStrictEqual(e.getModel().getValue(),"var x = 3 + (5-7); y();"),e.getModel().setValue("var x = (3 + (5-7)); y();"),e.setPosition(new n(1,16)),s(),o.deepStrictEqual(e.getModel().getValue(),"var x = (3 + 5-7); y();"),s(),o.deepStrictEqual(e.getModel().getValue(),"var x = 3 + 5-7; y();"),s(),o.deepStrictEqual(e.getModel().getValue(),"var x = 3 + 5-7; y();")})});
