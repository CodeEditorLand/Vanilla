var B=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var R=(D,y,e,t)=>{for(var i=t>1?void 0:t?U(y,e):y,r=D.length-1,a;r>=0;r--)(a=D[r])&&(i=(t?a(y,e,i):a(i))||i);return t&&i&&B(y,e,i),i},v=(D,y)=>(e,t)=>y(e,t,D);import{addDisposableListener as T,getActiveDocument as J}from"../../../../base/browser/dom.js";import{coalesce as V}from"../../../../base/common/arrays.js";import{createCancelablePromise as x,DeferredPromise as z,raceCancellation as Y}from"../../../../base/common/async.js";import{CancellationTokenSource as G}from"../../../../base/common/cancellation.js";import{UriList as X,createStringDataTransferItem as Z,matchesMimeType as $}from"../../../../base/common/dataTransfer.js";import{HierarchicalKind as b}from"../../../../base/common/hierarchicalKind.js";import{Disposable as j,DisposableStore as A}from"../../../../base/common/lifecycle.js";import{Mimes as M}from"../../../../base/common/mime.js";import*as ee from"../../../../base/common/platform.js";import{generateUuid as te}from"../../../../base/common/uuid.js";import{toExternalVSDataTransfer as ie,toVSDataTransfer as re}from"../../../browser/dnd.js";import"../../../browser/editorBrowser.js";import{IBulkEditService as ae}from"../../../browser/services/bulkEditService.js";import{EditorOption as w}from"../../../common/config/editorOptions.js";import{Range as oe}from"../../../common/core/range.js";import"../../../common/core/selection.js";import{Handler as se}from"../../../common/editorCommon.js";import{DocumentPasteTriggerKind as N}from"../../../common/languages.js";import"../../../common/model.js";import{ILanguageFeaturesService as ne}from"../../../common/services/languageFeatures.js";import{DefaultTextPasteOrDropEditProvider as F}from"./defaultProviders.js";import{createCombinedWorkspaceEdit as de,sortEditsByYieldTo as le}from"./edit.js";import{CodeEditorStateFlag as I,EditorStateCancellationTokenSource as q}from"../../editorState/browser/editorState.js";import{InlineProgressManager as ce}from"../../inlineProgress/browser/inlineProgress.js";import{MessageController as H}from"../../message/browser/messageController.js";import{localize as C}from"../../../../nls.js";import{IClipboardService as pe}from"../../../../platform/clipboard/common/clipboardService.js";import{RawContextKey as ue}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as me}from"../../../../platform/instantiation/common/instantiation.js";import{IProgressService as Pe,ProgressLocation as fe}from"../../../../platform/progress/common/progress.js";import{IQuickInputService as he}from"../../../../platform/quickinput/common/quickInput.js";import{PostEditWidgetManager as ge}from"./postEditWidget.js";import{CancellationError as ye,isCancellationError as ve}from"../../../../base/common/errors.js";import{ClipboardEventUtils as Ce}from"../../../browser/controller/editContext/textArea/textAreaEditContextInput.js";const Ee="editor.changePasteType",Se=new ue("pasteWidgetVisible",!1,C("pasteWidgetVisible","Whether the paste widget is showing")),k="application/vnd.code.copyMetadata";let h=class extends j{constructor(e,t,i,r,a,d,l){super();this._bulkEditService=i;this._clipboardService=r;this._languageFeaturesService=a;this._quickInputService=d;this._progressService=l;this._editor=e;const s=e.getContainerDomNode();this._register(T(s,"copy",o=>this.handleCopy(o))),this._register(T(s,"cut",o=>this.handleCopy(o))),this._register(T(s,"paste",o=>this.handlePaste(o),!0)),this._pasteProgressManager=this._register(new ce("pasteIntoEditor",e,t)),this._postPasteWidgetManager=this._register(t.createInstance(ge,"pasteIntoEditor",e,Se,{id:Ee,label:C("postPasteWidgetTitle","Show paste options...")}))}static ID="editor.contrib.copyPasteActionController";static get(e){return e.getContribution(h.ID)}static _currentCopyOperation;_editor;_currentPasteOperation;_pasteAsActionContext;_pasteProgressManager;_postPasteWidgetManager;changePasteType(){this._postPasteWidgetManager.tryShowSelector()}pasteAs(e){this._editor.focus();try{this._pasteAsActionContext={preferred:e},J().execCommand("paste")}finally{this._pasteAsActionContext=void 0}}clearWidgets(){this._postPasteWidgetManager.clear()}isPasteAsEnabled(){return this._editor.getOption(w.pasteAs).enabled}async finishedPaste(){await this._currentPasteOperation}handleCopy(e){if(!this._editor.hasTextFocus()||(this._clipboardService.clearInternalState?.(),!e.clipboardData||!this.isPasteAsEnabled()))return;const t=this._editor.getModel(),i=this._editor.getSelections();if(!t||!i?.length)return;const r=this._editor.getOption(w.emptySelectionClipboard);let a=i;const d=i.length===1&&i[0].isEmpty();if(d){if(!r)return;a=[new oe(a[0].startLineNumber,1,a[0].startLineNumber,1+t.getLineLength(a[0].startLineNumber))]}const l=this._editor._getViewModel()?.getPlainTextToCopy(i,r,ee.isWindows),o={multicursorText:Array.isArray(l)?l:null,pasteOnNewLine:d,mode:null},n=this._languageFeaturesService.documentPasteEditProvider.ordered(t).filter(m=>!!m.prepareDocumentPaste);if(!n.length){this.setCopyMetadata(e.clipboardData,{defaultPastePayload:o});return}const c=re(e.clipboardData),P=n.flatMap(m=>m.copyMimeTypes??[]),g=te();this.setCopyMetadata(e.clipboardData,{id:g,providerCopyMimeTypes:P,defaultPastePayload:o});const p=x(async m=>{const E=V(await Promise.all(n.map(async u=>{try{return await u.prepareDocumentPaste(t,a,c,m)}catch{return}})));E.reverse();for(const u of E)for(const[f,S]of u)c.replace(f,S);return c});h._currentCopyOperation?.dataTransferPromise.cancel(),h._currentCopyOperation={handle:g,dataTransferPromise:p}}async handlePaste(e){if(!e.clipboardData||!this._editor.hasTextFocus())return;H.get(this._editor)?.closeMessage(),this._currentPasteOperation?.cancel(),this._currentPasteOperation=void 0;const t=this._editor.getModel(),i=this._editor.getSelections();if(!i?.length||!t||this._editor.getOption(w.readOnly)||!this.isPasteAsEnabled()&&!this._pasteAsActionContext)return;const r=this.fetchCopyMetadata(e),a=ie(e.clipboardData);a.delete(k);const d=Array.from(e.clipboardData.files).map(o=>o.type),l=[...e.clipboardData.types,...d,...r?.providerCopyMimeTypes??[],M.uriList],s=this._languageFeaturesService.documentPasteEditProvider.ordered(t).filter(o=>{const n=this._pasteAsActionContext?.preferred;return n&&o.providedPasteEditKinds&&!this.providerMatchesPreference(o,n)?!1:o.pasteMimeTypes?.some(c=>$(c,l))});if(!s.length){this._pasteAsActionContext?.preferred&&this.showPasteAsNoEditMessage(i,this._pasteAsActionContext.preferred);return}e.preventDefault(),e.stopImmediatePropagation(),this._pasteAsActionContext?this.showPasteAsPick(this._pasteAsActionContext.preferred,s,i,a,r):this.doPasteInline(s,i,a,r,e)}showPasteAsNoEditMessage(e,t){H.get(this._editor)?.showMessage(C("pasteAsError","No paste edits for '{0}' found",t instanceof b?t.value:t.providerId),e[0].getStartPosition())}doPasteInline(e,t,i,r,a){const d=this._editor;if(!d.hasModel())return;const l=new q(d,I.Value|I.Selection,void 0),s=x(async o=>{const n=this._editor;if(!n.hasModel())return;const c=n.getModel(),P=new A,g=P.add(new G(o));P.add(l.token.onCancellationRequested(()=>g.cancel()));const p=g.token;try{if(await this.mergeInDataFromCopy(i,r,p),p.isCancellationRequested)return;const m=e.filter(f=>this.isSupportedPasteProvider(f,i));if(!m.length||m.length===1&&m[0]instanceof F)return this.applyDefaultPasteHandler(i,r,p,a);const E={triggerKind:N.Automatic},u=await this.getPasteEdits(m,i,c,t,E,p);if(P.add(u),p.isCancellationRequested)return;if(u.edits.length===1&&u.edits[0].provider instanceof F)return this.applyDefaultPasteHandler(i,r,p,a);if(u.edits.length){const f=n.getOption(w.pasteAs).showPasteSelector==="afterPaste";return this._postPasteWidgetManager.applyEditAndShowIfNeeded(t,{activeEditIndex:0,allEdits:u.edits},f,(S,K)=>new Promise((Q,O)=>{(async()=>{try{const _=S.provider.resolveDocumentPasteEdit?.(S,K),W=new z,L=_&&await this._pasteProgressManager.showWhile(t[0].getEndPosition(),C("resolveProcess","Resolving paste edit. Click to cancel"),Promise.race([W.p,_]),{cancel:()=>(W.cancel(),O(new ye))},0);return L&&(S.additionalEdit=L.additionalEdit),Q(S)}catch(_){return O(_)}})()}),p)}await this.applyDefaultPasteHandler(i,r,p,a)}finally{P.dispose(),this._currentPasteOperation===s&&(this._currentPasteOperation=void 0)}});this._pasteProgressManager.showWhile(t[0].getEndPosition(),C("pasteIntoEditorProgress","Running paste handlers. Click to cancel and do basic paste"),s,{cancel:async()=>{try{if(s.cancel(),l.token.isCancellationRequested)return;await this.applyDefaultPasteHandler(i,r,l.token,a)}finally{l.dispose()}}}).then(()=>{l.dispose()}),this._currentPasteOperation=s}showPasteAsPick(e,t,i,r,a){const d=x(async l=>{const s=this._editor;if(!s.hasModel())return;const o=s.getModel(),n=new A,c=n.add(new q(s,I.Value|I.Selection,void 0,l));try{if(await this.mergeInDataFromCopy(r,a,c.token),c.token.isCancellationRequested)return;let P=t.filter(u=>this.isSupportedPasteProvider(u,r,e));e&&(P=P.filter(u=>this.providerMatchesPreference(u,e)));const g={triggerKind:N.PasteAs,only:e&&e instanceof b?e:void 0};let p=n.add(await this.getPasteEdits(P,r,o,i,g,c.token));if(c.token.isCancellationRequested)return;if(e&&(p={edits:p.edits.filter(u=>e instanceof b?e.contains(u.kind):e.providerId===u.provider.id),dispose:p.dispose}),!p.edits.length){g.only&&this.showPasteAsNoEditMessage(i,g.only);return}let m;if(e?m=p.edits.at(0):m=(await this._quickInputService.pick(p.edits.map(f=>({label:f.title,description:f.kind?.value,edit:f})),{placeHolder:C("pasteAsPickerPlaceholder","Select Paste Action")}))?.edit,!m)return;const E=de(o.uri,i,m);await this._bulkEditService.apply(E,{editor:this._editor})}finally{n.dispose(),this._currentPasteOperation===d&&(this._currentPasteOperation=void 0)}});this._progressService.withProgress({location:fe.Window,title:C("pasteAsProgress","Running paste handlers")},()=>d)}setCopyMetadata(e,t){e.setData(k,JSON.stringify(t))}fetchCopyMetadata(e){if(!e.clipboardData)return;const t=e.clipboardData.getData(k);if(t)try{return JSON.parse(t)}catch{return}const[i,r]=Ce.getTextData(e.clipboardData);if(r)return{defaultPastePayload:{mode:r.mode,multicursorText:r.multicursorText??null,pasteOnNewLine:!!r.isFromEmptySelection}}}async mergeInDataFromCopy(e,t,i){if(t?.id&&h._currentCopyOperation?.handle===t.id){const r=await h._currentCopyOperation.dataTransferPromise;if(i.isCancellationRequested)return;for(const[a,d]of r)e.replace(a,d)}if(!e.has(M.uriList)){const r=await this._clipboardService.readResources();if(i.isCancellationRequested)return;r.length&&e.append(M.uriList,Z(X.create(r)))}}async getPasteEdits(e,t,i,r,a,d){const l=new A,s=await Y(Promise.all(e.map(async n=>{try{const c=await n.provideDocumentPasteEdits?.(i,r,t,a,d);return c&&l.add(c),c?.edits?.map(P=>({...P,provider:n}))}catch(c){ve(c);return}})),d),o=V(s??[]).flat().filter(n=>!a.only||a.only.contains(n.kind));return{edits:le(o),dispose:()=>l.dispose()}}async applyDefaultPasteHandler(e,t,i,r){const d=await(e.get(M.text)??e.get("text"))?.asString()??"";if(i.isCancellationRequested)return;const l={clipboardEvent:r,text:d,pasteOnNewLine:t?.defaultPastePayload.pasteOnNewLine??!1,multicursorText:t?.defaultPastePayload.multicursorText??null,mode:null};this._editor.trigger("keyboard",se.Paste,l)}isSupportedPasteProvider(e,t,i){return e.pasteMimeTypes?.some(r=>t.matches(r))?!i||this.providerMatchesPreference(e,i):!1}providerMatchesPreference(e,t){return t instanceof b?e.providedPasteEditKinds?e.providedPasteEditKinds.some(i=>t.contains(i)):!0:e.id===t.providerId}};h=R([v(1,me),v(2,ae),v(3,pe),v(4,ne),v(5,he),v(6,Pe)],h);export{h as CopyPasteController,Ee as changePasteTypeCommandId,Se as pasteWidgetVisibleCtx};
