{
  "version": 3,
  "sources": ["../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/editor/contrib/dropOrPasteInto/browser/postEditWidget.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as dom from \"../../../../base/browser/dom.js\";\nimport { Button } from \"../../../../base/browser/ui/button/button.js\";\nimport { toAction } from \"../../../../base/common/actions.js\";\nimport type { CancellationToken } from \"../../../../base/common/cancellation.js\";\nimport { toErrorMessage } from \"../../../../base/common/errorMessage.js\";\nimport { isCancellationError } from \"../../../../base/common/errors.js\";\nimport { Event } from \"../../../../base/common/event.js\";\nimport {\n\tDisposable,\n\tMutableDisposable,\n\ttoDisposable,\n} from \"../../../../base/common/lifecycle.js\";\nimport \"./postEditWidget.css\";\nimport { localize } from \"../../../../nls.js\";\nimport {\n\ttype IContextKey,\n\tIContextKeyService,\n\ttype RawContextKey,\n} from \"../../../../platform/contextkey/common/contextkey.js\";\nimport { IContextMenuService } from \"../../../../platform/contextview/browser/contextView.js\";\nimport { IInstantiationService } from \"../../../../platform/instantiation/common/instantiation.js\";\nimport { IKeybindingService } from \"../../../../platform/keybinding/common/keybinding.js\";\nimport { INotificationService } from \"../../../../platform/notification/common/notification.js\";\nimport {\n\tContentWidgetPositionPreference,\n\ttype ICodeEditor,\n\ttype IContentWidget,\n\ttype IContentWidgetPosition,\n} from \"../../../browser/editorBrowser.js\";\nimport {\n\ttype IBulkEditResult,\n\tIBulkEditService,\n} from \"../../../browser/services/bulkEditService.js\";\nimport type { Range } from \"../../../common/core/range.js\";\nimport type {\n\tDocumentDropEdit,\n\tDocumentPasteEdit,\n} from \"../../../common/languages.js\";\nimport { TrackedRangeStickiness } from \"../../../common/model.js\";\nimport { createCombinedWorkspaceEdit } from \"./edit.js\";\n\ninterface EditSet<Edit extends DocumentPasteEdit | DocumentDropEdit> {\n\treadonly activeEditIndex: number;\n\treadonly allEdits: ReadonlyArray<Edit>;\n}\n\ninterface ShowCommand {\n\treadonly id: string;\n\treadonly label: string;\n}\n\nclass PostEditWidget<T extends DocumentPasteEdit | DocumentDropEdit>\n\textends Disposable\n\timplements IContentWidget\n{\n\tprivate static readonly baseId = \"editor.widget.postEditWidget\";\n\n\treadonly allowEditorOverflow = true;\n\treadonly suppressMouseDown = true;\n\n\tprivate domNode!: HTMLElement;\n\tprivate button!: Button;\n\n\tprivate readonly visibleContext: IContextKey<boolean>;\n\n\tconstructor(\n\t\tprivate readonly typeId: string,\n\t\tprivate readonly editor: ICodeEditor,\n\t\tvisibleContext: RawContextKey<boolean>,\n\t\tprivate readonly showCommand: ShowCommand,\n\t\tprivate readonly range: Range,\n\t\tprivate readonly edits: EditSet<T>,\n\t\tprivate readonly onSelectNewEdit: (editIndex: number) => void,\n\t\t@IContextMenuService private readonly _contextMenuService: IContextMenuService,\n\t\t@IContextKeyService contextKeyService: IContextKeyService,\n\t\t@IKeybindingService private readonly _keybindingService: IKeybindingService,\n\t) {\n\t\tsuper();\n\n\t\tthis.create();\n\n\t\tthis.visibleContext = visibleContext.bindTo(contextKeyService);\n\t\tthis.visibleContext.set(true);\n\t\tthis._register(toDisposable(() => this.visibleContext.reset()));\n\n\t\tthis.editor.addContentWidget(this);\n\t\tthis.editor.layoutContentWidget(this);\n\n\t\tthis._register(toDisposable((() => this.editor.removeContentWidget(this))));\n\n\t\tthis._register(this.editor.onDidChangeCursorPosition(e => {\n\t\t\tif (!range.containsPosition(e.position)) {\n\t\t\t\tthis.dispose();\n\t\t\t}\n\t\t}));\n\n\t\tthis._register(Event.runAndSubscribe(_keybindingService.onDidUpdateKeybindings, () => {\n\t\t\tthis._updateButtonTitle();\n\t\t}));\n\t}\n\n\tprivate _updateButtonTitle() {\n\t\tconst binding = this._keybindingService\n\t\t\t.lookupKeybinding(this.showCommand.id)\n\t\t\t?.getLabel();\n\t\tthis.button.element.title =\n\t\t\tthis.showCommand.label + (binding ? ` (${binding})` : \"\");\n\t}\n\n\tprivate create(): void {\n\t\tthis.domNode = dom.$(\".post-edit-widget\");\n\n\t\tthis.button = this._register(\n\t\t\tnew Button(this.domNode, {\n\t\t\t\tsupportIcons: true,\n\t\t\t}),\n\t\t);\n\t\tthis.button.label = \"$(insert)\";\n\n\t\tthis._register(\n\t\t\tdom.addDisposableListener(this.domNode, dom.EventType.CLICK, () =>\n\t\t\t\tthis.showSelector(),\n\t\t\t),\n\t\t);\n\t}\n\n\tgetId(): string {\n\t\treturn PostEditWidget.baseId + \".\" + this.typeId;\n\t}\n\n\tgetDomNode(): HTMLElement {\n\t\treturn this.domNode;\n\t}\n\n\tgetPosition(): IContentWidgetPosition | null {\n\t\treturn {\n\t\t\tposition: this.range.getEndPosition(),\n\t\t\tpreference: [ContentWidgetPositionPreference.BELOW],\n\t\t};\n\t}\n\n\tshowSelector() {\n\t\tthis._contextMenuService.showContextMenu({\n\t\t\tgetAnchor: () => {\n\t\t\t\tconst pos = dom.getDomNodePagePosition(this.button.element);\n\t\t\t\treturn { x: pos.left + pos.width, y: pos.top + pos.height };\n\t\t\t},\n\t\t\tgetActions: () => {\n\t\t\t\treturn this.edits.allEdits.map((edit, i) =>\n\t\t\t\t\ttoAction({\n\t\t\t\t\t\tid: \"\",\n\t\t\t\t\t\tlabel: edit.title,\n\t\t\t\t\t\tchecked: i === this.edits.activeEditIndex,\n\t\t\t\t\t\trun: () => {\n\t\t\t\t\t\t\tif (i !== this.edits.activeEditIndex) {\n\t\t\t\t\t\t\t\treturn this.onSelectNewEdit(i);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t}),\n\t\t\t\t);\n\t\t\t},\n\t\t});\n\t}\n}\n\nexport class PostEditWidgetManager<\n\tT extends DocumentPasteEdit | DocumentDropEdit,\n> extends Disposable {\n\tprivate readonly _currentWidget = this._register(\n\t\tnew MutableDisposable<PostEditWidget<T>>(),\n\t);\n\n\tconstructor(\n\t\tprivate readonly _id: string,\n\t\tprivate readonly _editor: ICodeEditor,\n\t\tprivate readonly _visibleContext: RawContextKey<boolean>,\n\t\tprivate readonly _showCommand: ShowCommand,\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t\t@IBulkEditService private readonly _bulkEditService: IBulkEditService,\n\t\t@INotificationService private readonly _notificationService: INotificationService,\n\t) {\n\t\tsuper();\n\n\t\tthis._register(Event.any(\n\t\t\t_editor.onDidChangeModel,\n\t\t\t_editor.onDidChangeModelContent,\n\t\t)(() => this.clear()));\n\t}\n\n\tpublic async applyEditAndShowIfNeeded(\n\t\tranges: readonly Range[],\n\t\tedits: EditSet<T>,\n\t\tcanShowWidget: boolean,\n\t\tresolve: (edit: T, token: CancellationToken) => Promise<T>,\n\t\ttoken: CancellationToken,\n\t) {\n\t\tconst model = this._editor.getModel();\n\t\tif (!model || !ranges.length) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst edit = edits.allEdits.at(edits.activeEditIndex);\n\t\tif (!edit) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst onDidSelectEdit = async (newEditIndex: number) => {\n\t\t\tconst model = this._editor.getModel();\n\t\t\tif (!model) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tawait model.undo();\n\t\t\tthis.applyEditAndShowIfNeeded(\n\t\t\t\tranges,\n\t\t\t\t{ activeEditIndex: newEditIndex, allEdits: edits.allEdits },\n\t\t\t\tcanShowWidget,\n\t\t\t\tresolve,\n\t\t\t\ttoken,\n\t\t\t);\n\t\t};\n\n\t\tconst handleError = (e: Error, message: string) => {\n\t\t\tif (isCancellationError(e)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis._notificationService.error(message);\n\t\t\tif (canShowWidget) {\n\t\t\t\tthis.show(ranges[0], edits, onDidSelectEdit);\n\t\t\t}\n\t\t};\n\n\t\tlet resolvedEdit: T;\n\t\ttry {\n\t\t\tresolvedEdit = await resolve(edit, token);\n\t\t} catch (e) {\n\t\t\treturn handleError(\n\t\t\t\te,\n\t\t\t\tlocalize(\n\t\t\t\t\t\"resolveError\",\n\t\t\t\t\t\"Error resolving edit '{0}':\\n{1}\",\n\t\t\t\t\tedit.title,\n\t\t\t\t\ttoErrorMessage(e),\n\t\t\t\t),\n\t\t\t);\n\t\t}\n\n\t\tif (token.isCancellationRequested) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst combinedWorkspaceEdit = createCombinedWorkspaceEdit(\n\t\t\tmodel.uri,\n\t\t\tranges,\n\t\t\tresolvedEdit,\n\t\t);\n\n\t\t// Use a decoration to track edits around the trigger range\n\t\tconst primaryRange = ranges[0];\n\t\tconst editTrackingDecoration = model.deltaDecorations(\n\t\t\t[],\n\t\t\t[\n\t\t\t\t{\n\t\t\t\t\trange: primaryRange,\n\t\t\t\t\toptions: {\n\t\t\t\t\t\tdescription: \"paste-line-suffix\",\n\t\t\t\t\t\tstickiness:\n\t\t\t\t\t\t\tTrackedRangeStickiness.AlwaysGrowsWhenTypingAtEdges,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t],\n\t\t);\n\n\t\tthis._editor.focus();\n\t\tlet editResult: IBulkEditResult;\n\t\tlet editRange: Range | null;\n\t\ttry {\n\t\t\teditResult = await this._bulkEditService.apply(\n\t\t\t\tcombinedWorkspaceEdit,\n\t\t\t\t{ editor: this._editor, token },\n\t\t\t);\n\t\t\teditRange = model.getDecorationRange(editTrackingDecoration[0]);\n\t\t} catch (e) {\n\t\t\treturn handleError(\n\t\t\t\te,\n\t\t\t\tlocalize(\n\t\t\t\t\t\"applyError\",\n\t\t\t\t\t\"Error applying edit '{0}':\\n{1}\",\n\t\t\t\t\tedit.title,\n\t\t\t\t\ttoErrorMessage(e),\n\t\t\t\t),\n\t\t\t);\n\t\t} finally {\n\t\t\tmodel.deltaDecorations(editTrackingDecoration, []);\n\t\t}\n\n\t\tif (token.isCancellationRequested) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (\n\t\t\tcanShowWidget &&\n\t\t\teditResult.isApplied &&\n\t\t\tedits.allEdits.length > 1\n\t\t) {\n\t\t\tthis.show(editRange ?? primaryRange, edits, onDidSelectEdit);\n\t\t}\n\t}\n\n\tpublic show(\n\t\trange: Range,\n\t\tedits: EditSet<T>,\n\t\tonDidSelectEdit: (newIndex: number) => void,\n\t) {\n\t\tthis.clear();\n\n\t\tif (this._editor.hasModel()) {\n\t\t\tthis._currentWidget.value =\n\t\t\t\tthis._instantiationService.createInstance(\n\t\t\t\t\tPostEditWidget<T>,\n\t\t\t\t\tthis._id,\n\t\t\t\t\tthis._editor,\n\t\t\t\t\tthis._visibleContext,\n\t\t\t\t\tthis._showCommand,\n\t\t\t\t\trange,\n\t\t\t\t\tedits,\n\t\t\t\t\tonDidSelectEdit,\n\t\t\t\t);\n\t\t}\n\t}\n\n\tpublic clear() {\n\t\tthis._currentWidget.clear();\n\t}\n\n\tpublic tryShowSelector() {\n\t\tthis._currentWidget.value?.showSelector();\n\t}\n}\n"],
  "mappings": "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",
  "names": ["model"]
}
