var R=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var b=(p,r,e,t)=>{for(var i=t>1?void 0:t?k(r,e):r,s=p.length-1,o;s>=0;s--)(o=p[s])&&(i=(t?o(r,e,i):o(i))||i);return t&&i&&R(r,e,i),i},a=(p,r)=>(e,t)=>r(e,t,p);import*as y from"../../../../base/browser/dom.js";import{Button as N}from"../../../../base/browser/ui/button/button.js";import{toAction as K}from"../../../../base/common/actions.js";import{toErrorMessage as w}from"../../../../base/common/errorMessage.js";import{isCancellationError as M}from"../../../../base/common/errors.js";import{Event as x}from"../../../../base/common/event.js";import{Disposable as _,MutableDisposable as A,toDisposable as D}from"../../../../base/common/lifecycle.js";import"./postEditWidget.css";import{localize as T}from"../../../../nls.js";import{IContextKeyService as B}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as P}from"../../../../platform/contextview/browser/contextView.js";import{IInstantiationService as W}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as L}from"../../../../platform/keybinding/common/keybinding.js";import{INotificationService as j}from"../../../../platform/notification/common/notification.js";import{ContentWidgetPositionPreference as $}from"../../../browser/editorBrowser.js";import{IBulkEditService as q}from"../../../browser/services/bulkEditService.js";import{TrackedRangeStickiness as H}from"../../../common/model.js";import{createCombinedWorkspaceEdit as O}from"./edit.js";let l=class extends _{constructor(e,t,i,s,o,d,c,g,m,h){super();this.typeId=e;this.editor=t;this.showCommand=s;this.range=o;this.edits=d;this.onSelectNewEdit=c;this._contextMenuService=g;this._keybindingService=h;this.create(),this.visibleContext=i.bindTo(m),this.visibleContext.set(!0),this._register(D(()=>this.visibleContext.reset())),this.editor.addContentWidget(this),this.editor.layoutContentWidget(this),this._register(D(()=>this.editor.removeContentWidget(this))),this._register(this.editor.onDidChangeCursorPosition(E=>{o.containsPosition(E.position)||this.dispose()})),this._register(x.runAndSubscribe(h.onDidUpdateKeybindings,()=>{this._updateButtonTitle()}))}static baseId="editor.widget.postEditWidget";allowEditorOverflow=!0;suppressMouseDown=!0;domNode;button;visibleContext;_updateButtonTitle(){const e=this._keybindingService.lookupKeybinding(this.showCommand.id)?.getLabel();this.button.element.title=this.showCommand.label+(e?` (${e})`:"")}create(){this.domNode=y.$(".post-edit-widget"),this.button=this._register(new N(this.domNode,{supportIcons:!0})),this.button.label="$(insert)",this._register(y.addDisposableListener(this.domNode,y.EventType.CLICK,()=>this.showSelector()))}getId(){return l.baseId+"."+this.typeId}getDomNode(){return this.domNode}getPosition(){return{position:this.range.getEndPosition(),preference:[$.BELOW]}}showSelector(){this._contextMenuService.showContextMenu({getAnchor:()=>{const e=y.getDomNodePagePosition(this.button.element);return{x:e.left+e.width,y:e.top+e.height}},getActions:()=>this.edits.allEdits.map((e,t)=>K({id:"",label:e.title,checked:t===this.edits.activeEditIndex,run:()=>{if(t!==this.edits.activeEditIndex)return this.onSelectNewEdit(t)}}))})}};l=b([a(7,P),a(8,B),a(9,L)],l);let v=class extends _{constructor(e,t,i,s,o,d,c){super();this._id=e;this._editor=t;this._visibleContext=i;this._showCommand=s;this._instantiationService=o;this._bulkEditService=d;this._notificationService=c;this._register(x.any(t.onDidChangeModel,t.onDidChangeModelContent)(()=>this.clear()))}_currentWidget=this._register(new A);async applyEditAndShowIfNeeded(e,t,i,s,o){const d=this._editor.getModel();if(!d||!e.length)return;const c=t.allEdits.at(t.activeEditIndex);if(!c)return;const g=async n=>{const u=this._editor.getModel();u&&(await u.undo(),this.applyEditAndShowIfNeeded(e,{activeEditIndex:n,allEdits:t.allEdits},i,s,o))},m=(n,u)=>{M(n)||(this._notificationService.error(u),i&&this.show(e[0],t,g))};let h;try{h=await s(c,o)}catch(n){return m(n,T("resolveError",`Error resolving edit '{0}':
{1}`,c.title,w(n)))}if(o.isCancellationRequested)return;const E=O(d.uri,e,h),C=e[0],f=d.deltaDecorations([],[{range:C,options:{description:"paste-line-suffix",stickiness:H.AlwaysGrowsWhenTypingAtEdges}}]);this._editor.focus();let I,S;try{I=await this._bulkEditService.apply(E,{editor:this._editor,token:o}),S=d.getDecorationRange(f[0])}catch(n){return m(n,T("applyError",`Error applying edit '{0}':
{1}`,c.title,w(n)))}finally{d.deltaDecorations(f,[])}o.isCancellationRequested||i&&I.isApplied&&t.allEdits.length>1&&this.show(S??C,t,g)}show(e,t,i){this.clear(),this._editor.hasModel()&&(this._currentWidget.value=this._instantiationService.createInstance(l,this._id,this._editor,this._visibleContext,this._showCommand,e,t,i))}clear(){this._currentWidget.clear()}tryShowSelector(){this._currentWidget.value?.showSelector()}};v=b([a(4,W),a(5,q),a(6,j)],v);export{v as PostEditWidgetManager};
