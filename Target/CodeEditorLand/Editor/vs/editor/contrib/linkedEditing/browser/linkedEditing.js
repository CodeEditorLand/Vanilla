var q=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var y=(u,a,i,e)=>{for(var t=e>1?void 0:e?A(a,i):a,o=u.length-1,r;o>=0;o--)(r=u[o])&&(t=(e?r(a,i,t):r(t))||t);return e&&t&&q(a,i,t),t},_=(u,a)=>(i,e)=>a(i,e,u);import*as O from"../../../../base/common/arrays.js";import{Delayer as P,first as N}from"../../../../base/common/async.js";import{CancellationToken as V,CancellationTokenSource as K}from"../../../../base/common/cancellation.js";import{Color as f}from"../../../../base/common/color.js";import{isCancellationError as U,onUnexpectedError as I,onUnexpectedExternalError as W}from"../../../../base/common/errors.js";import{Event as F}from"../../../../base/common/event.js";import{KeyCode as v,KeyMod as b}from"../../../../base/common/keyCodes.js";import{Disposable as z,DisposableStore as D}from"../../../../base/common/lifecycle.js";import*as k from"../../../../base/common/strings.js";import{URI as B}from"../../../../base/common/uri.js";import"../../../browser/editorBrowser.js";import{EditorAction as H,EditorCommand as G,EditorContributionInstantiation as X,registerEditorAction as Y,registerEditorCommand as j,registerEditorContribution as J,registerModelAndPositionCommand as Q}from"../../../browser/editorExtensions.js";import{ICodeEditorService as Z}from"../../../browser/services/codeEditorService.js";import{EditorOption as C}from"../../../common/config/editorOptions.js";import{Position as $}from"../../../common/core/position.js";import{Range as T}from"../../../common/core/range.js";import"../../../common/editorCommon.js";import{EditorContextKeys as R}from"../../../common/editorContextKeys.js";import{TrackedRangeStickiness as ee}from"../../../common/model.js";import{ModelDecorationOptions as te}from"../../../common/model/textModel.js";import"../../../common/languages.js";import{ILanguageConfigurationService as ie}from"../../../common/languages/languageConfigurationRegistry.js";import*as S from"../../../../nls.js";import{ContextKeyExpr as re,IContextKeyService as ne,RawContextKey as oe}from"../../../../platform/contextkey/common/contextkey.js";import{KeybindingWeight as L}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{ILanguageFeaturesService as x}from"../../../common/services/languageFeatures.js";import{registerColor as se}from"../../../../platform/theme/common/colorRegistry.js";import"../../../common/languageFeatureRegistry.js";import"../../../common/core/editOperation.js";import{ILanguageFeatureDebounceService as ae}from"../../../common/services/languageFeatureDebounce.js";import{StopWatch as de}from"../../../../base/common/stopwatch.js";import"./linkedEditing.css";const w=new oe("LinkedEditingInputVisible",!1),ge="linked-editing-decoration";let l=class extends z{constructor(i,e,t,o,r){super();this.languageConfigurationService=o;this._editor=i,this._providers=t.linkedEditingRangeProvider,this._enabled=!1,this._visibleContextKey=w.bindTo(e),this._debounceInformation=r.for(this._providers,"Linked Editing",{max:200}),this._currentDecorations=this._editor.createDecorationsCollection(),this._languageWordPattern=null,this._currentWordPattern=null,this._ignoreChangeEvent=!1,this._localToDispose=this._register(new D),this._rangeUpdateTriggerPromise=null,this._rangeSyncTriggerPromise=null,this._currentRequestCts=null,this._currentRequestPosition=null,this._currentRequestModelVersion=null,this._register(this._editor.onDidChangeModel(()=>this.reinitialize(!0))),this._register(this._editor.onDidChangeConfiguration(n=>{(n.hasChanged(C.linkedEditing)||n.hasChanged(C.renameOnType))&&this.reinitialize(!1)})),this._register(this._providers.onDidChange(()=>this.reinitialize(!1))),this._register(this._editor.onDidChangeModelLanguage(()=>this.reinitialize(!0))),this.reinitialize(!0)}static ID="editor.contrib.linkedEditing";static DECORATION=te.register({description:"linked-editing",stickiness:ee.AlwaysGrowsWhenTypingAtEdges,className:ge});static get(i){return i.getContribution(l.ID)}_debounceDuration;_editor;_providers;_enabled;_visibleContextKey;_debounceInformation;_rangeUpdateTriggerPromise;_rangeSyncTriggerPromise;_currentRequestCts;_currentRequestPosition;_currentRequestModelVersion;_currentDecorations;_syncRangesToken=0;_languageWordPattern;_currentWordPattern;_ignoreChangeEvent;_localToDispose=this._register(new D);reinitialize(i){const e=this._editor.getModel(),t=e!==null&&(this._editor.getOption(C.linkedEditing)||this._editor.getOption(C.renameOnType))&&this._providers.has(e);if(t===this._enabled&&!i||(this._enabled=t,this.clearRanges(),this._localToDispose.clear(),!t||e===null))return;this._localToDispose.add(F.runAndSubscribe(e.onDidChangeLanguageConfiguration,()=>{this._languageWordPattern=this.languageConfigurationService.getLanguageConfiguration(e.getLanguageId()).getWordDefinition()}));const o=new P(this._debounceInformation.get(e)),r=()=>{this._rangeUpdateTriggerPromise=o.trigger(()=>this.updateRanges(),this._debounceDuration??this._debounceInformation.get(e))},n=new P(0),h=s=>{this._rangeSyncTriggerPromise=n.trigger(()=>this._syncRanges(s))};this._localToDispose.add(this._editor.onDidChangeCursorPosition(()=>{r()})),this._localToDispose.add(this._editor.onDidChangeModelContent(s=>{if(!this._ignoreChangeEvent&&this._currentDecorations.length>0){const d=this._currentDecorations.getRange(0);if(d&&s.changes.every(g=>d.intersectRanges(g.range))){h(this._syncRangesToken);return}}r()})),this._localToDispose.add({dispose:()=>{o.dispose(),n.dispose()}}),this.updateRanges()}_syncRanges(i){if(!this._editor.hasModel()||i!==this._syncRangesToken||this._currentDecorations.length===0)return;const e=this._editor.getModel(),t=this._currentDecorations.getRange(0);if(!t||t.startLineNumber!==t.endLineNumber)return this.clearRanges();const o=e.getValueInRange(t);if(this._currentWordPattern){const n=o.match(this._currentWordPattern);if((n?n[0].length:0)!==o.length)return this.clearRanges()}const r=[];for(let n=1,h=this._currentDecorations.length;n<h;n++){const s=this._currentDecorations.getRange(n);if(s)if(s.startLineNumber!==s.endLineNumber)r.push({range:s,text:o});else{let d=e.getValueInRange(s),g=o,c=s.startColumn,p=s.endColumn;const m=k.commonPrefixLength(d,g);c+=m,d=d.substr(m),g=g.substr(m);const E=k.commonSuffixLength(d,g);p-=E,d=d.substr(0,d.length-E),g=g.substr(0,g.length-E),(c!==p||g.length!==0)&&r.push({range:new T(s.startLineNumber,c,s.endLineNumber,p),text:g})}}if(r.length!==0)try{this._editor.popUndoStop(),this._ignoreChangeEvent=!0;const n=this._editor._getViewModel().getPrevEditOperationType();this._editor.executeEdits("linkedEditing",r),this._editor._getViewModel().setPrevEditOperationType(n)}finally{this._ignoreChangeEvent=!1}}dispose(){this.clearRanges(),super.dispose()}clearRanges(){this._visibleContextKey.set(!1),this._currentDecorations.clear(),this._currentRequestCts&&(this._currentRequestCts.cancel(),this._currentRequestCts=null,this._currentRequestPosition=null)}get currentUpdateTriggerPromise(){return this._rangeUpdateTriggerPromise||Promise.resolve()}get currentSyncTriggerPromise(){return this._rangeSyncTriggerPromise||Promise.resolve()}async updateRanges(i=!1){if(!this._editor.hasModel()){this.clearRanges();return}const e=this._editor.getPosition();if(!this._enabled&&!i||this._editor.getSelections().length>1){this.clearRanges();return}const t=this._editor.getModel(),o=t.getVersionId();if(this._currentRequestPosition&&this._currentRequestModelVersion===o){if(e.equals(this._currentRequestPosition))return;if(this._currentDecorations.length>0){const n=this._currentDecorations.getRange(0);if(n&&n.containsPosition(e))return}}this.clearRanges(),this._currentRequestPosition=e,this._currentRequestModelVersion=o;const r=this._currentRequestCts=new K;try{const n=new de(!1),h=await M(this._providers,t,e,r.token);if(this._debounceInformation.update(t,n.elapsed()),r!==this._currentRequestCts||(this._currentRequestCts=null,o!==t.getVersionId()))return;let s=[];h?.ranges&&(s=h.ranges),this._currentWordPattern=h?.wordPattern||this._languageWordPattern;let d=!1;for(let c=0,p=s.length;c<p;c++)if(T.containsPosition(s[c],e)){if(d=!0,c!==0){const m=s[c];s.splice(c,1),s.unshift(m)}break}if(!d){this.clearRanges();return}const g=s.map(c=>({range:c,options:l.DECORATION}));this._visibleContextKey.set(!0),this._currentDecorations.set(g),this._syncRangesToken++}catch(n){U(n)||I(n),(this._currentRequestCts===r||!this._currentRequestCts)&&this.clearRanges()}}setDebounceDuration(i){this._debounceDuration=i}};l=y([_(1,ne),_(2,x),_(3,ie),_(4,ae)],l);class ce extends H{constructor(){super({id:"editor.action.linkedEditing",label:S.localize("linkedEditing.label","Start Linked Editing"),alias:"Start Linked Editing",precondition:re.and(R.writable,R.hasRenameProvider),kbOpts:{kbExpr:R.editorTextFocus,primary:b.CtrlCmd|b.Shift|v.F2,weight:L.EditorContrib}})}runCommand(a,i){const e=a.get(Z),[t,o]=Array.isArray(i)&&i||[void 0,void 0];return B.isUri(t)&&$.isIPosition(o)?e.openCodeEditor({resource:t},e.getActiveCodeEditor()).then(r=>{r&&(r.setPosition(o),r.invokeWithinContext(n=>(this.reportTelemetry(n,r),this.run(n,r))))},I):super.runCommand(a,i)}run(a,i){const e=l.get(i);return e?Promise.resolve(e.updateRanges(!0)):Promise.resolve()}}const ue=G.bindToContribution(l.get);j(new ue({id:"cancelLinkedEditingInput",precondition:w,handler:u=>u.clearRanges(),kbOpts:{kbExpr:R.editorTextFocus,weight:L.EditorContrib+99,primary:v.Escape,secondary:[b.Shift|v.Escape]}}));function M(u,a,i,e){const t=u.ordered(a);return N(t.map(o=>async()=>{try{return await o.provideLinkedEditingRanges(a,i,e)}catch(r){W(r);return}}),o=>!!o&&O.isNonEmptyArray(o?.ranges))}const it=se("editor.linkedEditingBackground",{dark:f.fromHex("#f00").transparent(.3),light:f.fromHex("#f00").transparent(.3),hcDark:f.fromHex("#f00").transparent(.3),hcLight:f.white},S.localize("editorLinkedEditingBackground","Background color when the editor auto renames on type."));Q("_executeLinkedEditingProvider",(u,a,i)=>{const{linkedEditingRangeProvider:e}=u.get(x);return M(e,a,i,V.None)}),J(l.ID,l,X.AfterFirstRender),Y(ce);export{w as CONTEXT_ONTYPE_RENAME_INPUT_VISIBLE,ce as LinkedEditingAction,l as LinkedEditingContribution,it as editorLinkedEditingBackground};
