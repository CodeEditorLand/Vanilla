{
  "version": 3,
  "sources": ["../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/editor/contrib/links/browser/getLinks.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { coalesce } from '../../../../base/common/arrays.js';\nimport { CancellationToken } from '../../../../base/common/cancellation.js';\nimport { onUnexpectedExternalError } from '../../../../base/common/errors.js';\nimport { DisposableStore, isDisposable } from '../../../../base/common/lifecycle.js';\nimport { assertType } from '../../../../base/common/types.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { IRange, Range } from '../../../common/core/range.js';\nimport { ITextModel } from '../../../common/model.js';\nimport { ILink, ILinksList, LinkProvider } from '../../../common/languages.js';\nimport { IModelService } from '../../../common/services/model.js';\nimport { CommandsRegistry } from '../../../../platform/commands/common/commands.js';\nimport { LanguageFeatureRegistry } from '../../../common/languageFeatureRegistry.js';\nimport { ILanguageFeaturesService } from '../../../common/services/languageFeatures.js';\n\nexport class Link implements ILink {\n\n\tprivate _link: ILink;\n\tprivate readonly _provider: LinkProvider;\n\n\tconstructor(link: ILink, provider: LinkProvider) {\n\t\tthis._link = link;\n\t\tthis._provider = provider;\n\t}\n\n\ttoJSON(): ILink {\n\t\treturn {\n\t\t\trange: this.range,\n\t\t\turl: this.url,\n\t\t\ttooltip: this.tooltip\n\t\t};\n\t}\n\n\tget range(): IRange {\n\t\treturn this._link.range;\n\t}\n\n\tget url(): URI | string | undefined {\n\t\treturn this._link.url;\n\t}\n\n\tget tooltip(): string | undefined {\n\t\treturn this._link.tooltip;\n\t}\n\n\tasync resolve(token: CancellationToken): Promise<URI | string> {\n\t\tif (this._link.url) {\n\t\t\treturn this._link.url;\n\t\t}\n\n\t\tif (typeof this._provider.resolveLink === 'function') {\n\t\t\treturn Promise.resolve(this._provider.resolveLink(this._link, token)).then(value => {\n\t\t\t\tthis._link = value || this._link;\n\t\t\t\tif (this._link.url) {\n\t\t\t\t\t// recurse\n\t\t\t\t\treturn this.resolve(token);\n\t\t\t\t}\n\n\t\t\t\treturn Promise.reject(new Error('missing'));\n\t\t\t});\n\t\t}\n\n\t\treturn Promise.reject(new Error('missing'));\n\t}\n}\n\nexport class LinksList {\n\n\treadonly links: Link[];\n\n\tprivate readonly _disposables = new DisposableStore();\n\n\tconstructor(tuples: [ILinksList, LinkProvider][]) {\n\n\t\tlet links: Link[] = [];\n\t\tfor (const [list, provider] of tuples) {\n\t\t\t// merge all links\n\t\t\tconst newLinks = list.links.map(link => new Link(link, provider));\n\t\t\tlinks = LinksList._union(links, newLinks);\n\t\t\t// register disposables\n\t\t\tif (isDisposable(list)) {\n\t\t\t\tthis._disposables.add(list);\n\t\t\t}\n\t\t}\n\t\tthis.links = links;\n\t}\n\n\tdispose(): void {\n\t\tthis._disposables.dispose();\n\t\tthis.links.length = 0;\n\t}\n\n\tprivate static _union(oldLinks: Link[], newLinks: Link[]): Link[] {\n\t\t// reunite oldLinks with newLinks and remove duplicates\n\t\tconst result: Link[] = [];\n\t\tlet oldIndex: number;\n\t\tlet oldLen: number;\n\t\tlet newIndex: number;\n\t\tlet newLen: number;\n\n\t\tfor (oldIndex = 0, newIndex = 0, oldLen = oldLinks.length, newLen = newLinks.length; oldIndex < oldLen && newIndex < newLen;) {\n\t\t\tconst oldLink = oldLinks[oldIndex];\n\t\t\tconst newLink = newLinks[newIndex];\n\n\t\t\tif (Range.areIntersectingOrTouching(oldLink.range, newLink.range)) {\n\t\t\t\t// Remove the oldLink\n\t\t\t\toldIndex++;\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst comparisonResult = Range.compareRangesUsingStarts(oldLink.range, newLink.range);\n\n\t\t\tif (comparisonResult < 0) {\n\t\t\t\t// oldLink is before\n\t\t\t\tresult.push(oldLink);\n\t\t\t\toldIndex++;\n\t\t\t} else {\n\t\t\t\t// newLink is before\n\t\t\t\tresult.push(newLink);\n\t\t\t\tnewIndex++;\n\t\t\t}\n\t\t}\n\n\t\tfor (; oldIndex < oldLen; oldIndex++) {\n\t\t\tresult.push(oldLinks[oldIndex]);\n\t\t}\n\t\tfor (; newIndex < newLen; newIndex++) {\n\t\t\tresult.push(newLinks[newIndex]);\n\t\t}\n\n\t\treturn result;\n\t}\n\n}\n\nexport function getLinks(providers: LanguageFeatureRegistry<LinkProvider>, model: ITextModel, token: CancellationToken): Promise<LinksList> {\n\n\tconst lists: [ILinksList, LinkProvider][] = [];\n\n\t// ask all providers for links in parallel\n\tconst promises = providers.ordered(model).reverse().map((provider, i) => {\n\t\treturn Promise.resolve(provider.provideLinks(model, token)).then(result => {\n\t\t\tif (result) {\n\t\t\t\tlists[i] = [result, provider];\n\t\t\t}\n\t\t}, onUnexpectedExternalError);\n\t});\n\n\treturn Promise.all(promises).then(() => {\n\t\tconst result = new LinksList(coalesce(lists));\n\t\tif (!token.isCancellationRequested) {\n\t\t\treturn result;\n\t\t}\n\t\tresult.dispose();\n\t\treturn new LinksList([]);\n\t});\n}\n\n\nCommandsRegistry.registerCommand('_executeLinkProvider', async (accessor, ...args): Promise<ILink[]> => {\n\tlet [uri, resolveCount] = args;\n\tassertType(uri instanceof URI);\n\n\tif (typeof resolveCount !== 'number') {\n\t\tresolveCount = 0;\n\t}\n\n\tconst { linkProvider } = accessor.get(ILanguageFeaturesService);\n\tconst model = accessor.get(IModelService).getModel(uri);\n\tif (!model) {\n\t\treturn [];\n\t}\n\tconst list = await getLinks(linkProvider, model, CancellationToken.None);\n\tif (!list) {\n\t\treturn [];\n\t}\n\n\t// resolve links\n\tfor (let i = 0; i < Math.min(resolveCount, list.links.length); i++) {\n\t\tawait list.links[i].resolve(CancellationToken.None);\n\t}\n\n\tconst result = list.links.slice(0);\n\tlist.dispose();\n\treturn result;\n});\n"],
  "mappings": "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",
  "names": []
}
