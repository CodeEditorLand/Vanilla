var S=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var D=(a,i,e,t)=>{for(var r=t>1?void 0:t?R(i,e):i,s=a.length-1,o;s>=0;s--)(o=a[s])&&(r=(t?o(i,e,r):o(r))||r);return t&&r&&S(i,e,r),r},w=(a,i)=>(e,t)=>i(e,t,a);import{h as y,svgElem as _}from"../../../../base/browser/dom.js";import{DEFAULT_FONT_FAMILY as N}from"../../../../base/browser/fonts.js";import{Disposable as P,DisposableStore as A}from"../../../../base/common/lifecycle.js";import{autorun as x,constObservable as W,derived as f}from"../../../../base/common/observable.js";import{derivedWithSetter as $}from"../../../../base/common/observableInternal/derived.js";import"./inlineEditsWidget.css";import{MenuWorkbenchToolBar as F}from"../../../../platform/actions/browser/toolbar.js";import{MenuId as X}from"../../../../platform/actions/common/actions.js";import{IInstantiationService as k}from"../../../../platform/instantiation/common/instantiation.js";import"../../../browser/editorBrowser.js";import{EditorExtensionsRegistry as H}from"../../../browser/editorExtensions.js";import{observableCodeEditor as E}from"../../../browser/observableCodeEditor.js";import{EmbeddedCodeEditorWidget as L}from"../../../browser/widget/codeEditor/embeddedCodeEditorWidget.js";import{diffAddDecoration as B,diffAddDecorationEmpty as G,diffDeleteDecoration as U,diffDeleteDecorationEmpty as z,diffLineAddDecorationBackgroundWithIndicator as j,diffLineDeleteDecorationBackgroundWithIndicator as q,diffWholeLineAddDecoration as V,diffWholeLineDeleteDecoration as Y}from"../../../browser/widget/diffEditor/registrations.contribution.js";import{appendRemoveOnDispose as J,applyStyle as K}from"../../../browser/widget/diffEditor/utils.js";import{EditorOption as Q}from"../../../common/config/editorOptions.js";import"../../../common/core/lineRange.js";import"../../../common/diff/rangeMapping.js";import{PLAINTEXT_LANGUAGE_ID as O}from"../../../common/languages/modesRegistry.js";import"../../../common/model.js";import{TextModel as I}from"../../../common/model/textModel.js";import{ContextMenuController as Z}from"../../contextmenu/browser/contextmenu.js";import{PlaceholderTextContribution as ee}from"../../placeholderText/browser/placeholderTextContribution.js";import{SuggestController as te}from"../../suggest/browser/suggestController.js";class $e{constructor(i,e,t){this.range=i;this.newLines=e;this.changes=t}}let T=class extends P{constructor(e,t,r,s){super();this._editor=e;this._edit=t;this._userPrompt=r;this._instantiationService=s;const o=f(this,n=>this._edit.read(n)!==void 0||this._userPrompt.read(n)!==void 0);this._register(K(this._elements.root,{display:f(this,n=>o.read(n)?"block":"none")})),this._register(J(this._editor.getDomNode(),this._elements.root)),this._register(E(e).createOverlayWidget({domNode:this._elements.root,position:W(null),allowEditorOverflow:!1,minContentWidthInPx:f(n=>{const l=this._layout1.read(n)?.left;if(l===void 0)return 0;const d=this._previewEditorObs.contentWidth.read(n);return l+d})})),this._previewEditor.setModel(this._previewTextModel),this._register(this._previewEditorObs.setDecorations(this._decorations)),this._register(x(n=>{const l=this._layout.read(n);if(!l)return;const{topCode:d,bottomCode:c,topEdit:p,bottomEdit:m,editHeight:v}=l,h=10,g=0,b=40,C=new oe().moveTo(d).lineTo(d.deltaX(h)).curveTo(d.deltaX(h+b),p.deltaX(-b-g),p.deltaX(-g)).lineTo(p).lineTo(m).lineTo(m.deltaX(-g)).curveTo(m.deltaX(-b-g),c.deltaX(h+b),c.deltaX(h)).lineTo(c).build();this._elements.path.setAttribute("d",C),this._elements.editorContainer.style.top=`${p.y}px`,this._elements.editorContainer.style.left=`${p.x}px`,this._elements.editorContainer.style.height=`${v}px`;const M=this._previewEditorObs.contentWidth.read(n);this._previewEditor.layout({height:v,width:M})})),this._promptEditor.setModel(this._promptTextModel),this._promptEditor.layout(),this._register(ne(ie(this._userPrompt,n=>n??"",n=>n),E(this._promptEditor).value)),this._register(x(n=>{const l=E(this._promptEditor).isFocused.read(n);this._elements.root.classList.toggle("focused",l)}))}_editorObs=E(this._editor);_elements=y("div.inline-edits-widget",{style:{position:"absolute",overflow:"visible",top:"0px",left:"0px"}},[y("div@editorContainer",{style:{position:"absolute",top:"0px",left:"0px",width:"500px",height:"500px"}},[y("div.toolbar@toolbar",{style:{position:"absolute",top:"-25px",left:"0px"}}),y("div.promptEditor@promptEditor",{style:{position:"absolute",top:"-25px",left:"80px",width:"300px",height:"22px"}}),y("div.preview@editor",{style:{position:"absolute",top:"0px",left:"0px"}})]),_("svg",{style:{overflow:"visible",pointerEvents:"none"}},[_("defs",[_("linearGradient",{id:"Gradient2",x1:"0",y1:"0",x2:"1",y2:"0"},[_("stop",{offset:"0%",class:"gradient-stop"}),_("stop",{offset:"100%",class:"gradient-stop"})])]),_("path@path",{d:"",fill:"url(#Gradient2)"})])]);_toolbar=this._register(this._instantiationService.createInstance(F,this._elements.toolbar,X.InlineEditsActions,{toolbarOptions:{primaryGroup:e=>e.startsWith("primary")}}));_previewTextModel=this._register(this._instantiationService.createInstance(I,"",O,I.DEFAULT_CREATION_OPTIONS,null));_setText=f(e=>{const t=this._edit.read(e);t&&this._previewTextModel.setValue(t.newLines.join(`
`))}).recomputeInitiallyAndOnChange(this._store);_promptTextModel=this._register(this._instantiationService.createInstance(I,"",O,I.DEFAULT_CREATION_OPTIONS,null));_promptEditor=this._register(this._instantiationService.createInstance(L,this._elements.promptEditor,{glyphMargin:!1,lineNumbers:"off",minimap:{enabled:!1},guides:{indentation:!1,bracketPairs:!1,bracketPairsHorizontal:!1,highlightActiveIndentation:!1},folding:!1,selectOnLineNumbers:!1,selectionHighlight:!1,columnSelection:!1,overviewRulerBorder:!1,overviewRulerLanes:0,lineDecorationsWidth:0,lineNumbersMinChars:0,placeholder:"Describe the change you want...",fontFamily:N},{contributions:H.getSomeEditorContributions([te.ID,ee.ID,Z.ID]),isSimpleWidget:!0},this._editor));_previewEditor=this._register(this._instantiationService.createInstance(L,this._elements.editor,{glyphMargin:!1,lineNumbers:"off",minimap:{enabled:!1},guides:{indentation:!1,bracketPairs:!1,bracketPairsHorizontal:!1,highlightActiveIndentation:!1},folding:!1,selectOnLineNumbers:!1,selectionHighlight:!1,columnSelection:!1,overviewRulerBorder:!1,overviewRulerLanes:0,lineDecorationsWidth:0,lineNumbersMinChars:0},{contributions:[]},this._editor));_previewEditorObs=E(this._previewEditor);_decorations=f(this,e=>{this._setText.read(e);const t=this._edit.read(e)?.changes;if(!t)return[];const r=[],s=[];if(t.length===1&&t[0].innerChanges[0].modifiedRange.equalsRange(this._previewTextModel.getFullModelRange()))return[];for(const o of t)if(o.original.isEmpty||r.push({range:o.original.toInclusiveRange(),options:q}),o.modified.isEmpty||s.push({range:o.modified.toInclusiveRange(),options:j}),o.modified.isEmpty||o.original.isEmpty)o.original.isEmpty||r.push({range:o.original.toInclusiveRange(),options:Y}),o.modified.isEmpty||s.push({range:o.modified.toInclusiveRange(),options:V});else for(const n of o.innerChanges||[])o.original.contains(n.originalRange.startLineNumber)&&r.push({range:n.originalRange,options:n.originalRange.isEmpty()?z:U}),o.modified.contains(n.modifiedRange.startLineNumber)&&s.push({range:n.modifiedRange,options:n.modifiedRange.isEmpty()?G:B});return s});_layout1=f(this,e=>{const t=this._editor.getModel(),r=this._edit.read(e);if(!r)return null;const s=r.range;let o=0;for(let d=s.startLineNumber;d<s.endLineNumberExclusive;d++){const c=t.getLineMaxColumn(d),p=this._editor.getOffsetForColumn(d,c);o=Math.max(o,p)}return{left:this._editor.getLayoutInfo().contentLeft+o}});_layout=f(this,e=>{const t=this._edit.read(e);if(!t)return null;const r=t.range,s=this._editorObs.scrollLeft.read(e),o=this._layout1.read(e).left+20-s,n=this._editor.getTopForLineNumber(r.startLineNumber)-this._editorObs.scrollTop.read(e),l=this._editor.getTopForLineNumber(r.endLineNumberExclusive)-this._editorObs.scrollTop.read(e),d=new u(o,n),c=new u(o,l),p=l-n,m=50,v=this._editor.getOption(Q.lineHeight)*t.newLines.length,h=p-v,g=new u(o+m,n+h/2),b=new u(o+m,l-h/2);return{topCode:d,bottomCode:c,codeHeight:p,topEdit:g,bottomEdit:b,editHeight:v}})};T=D([w(3,k)],T);function ie(a,i,e){return $(void 0,t=>i(a.read(t)),(t,r)=>a.set(e(t),r))}class u{constructor(i,e){this.x=i;this.y=e}add(i){return new u(this.x+i.x,this.y+i.y)}deltaX(i){return new u(this.x+i,this.y)}}class oe{_data="";moveTo(i){return this._data+=`M ${i.x} ${i.y} `,this}lineTo(i){return this._data+=`L ${i.x} ${i.y} `,this}curveTo(i,e,t){return this._data+=`C ${i.x} ${i.y} ${e.x} ${e.y} ${t.x} ${t.y} `,this}build(){return this._data}}function ne(a,i){const e=new A;return e.add(x(t=>{const r=a.read(t);i.set(r,void 0)})),e.add(x(t=>{const r=i.read(t);a.set(r,void 0)})),e}export{$e as InlineEdit,T as InlineEditsWidget};
