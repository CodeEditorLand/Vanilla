var J=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var $=(I,e,t,i)=>{for(var n=i>1?void 0:i?Q(e,t):e,a=I.length-1,o;a>=0;a--)(o=I[a])&&(n=(i?o(e,t,n):o(n))||n);return i&&n&&J(e,t,n),n},x=(I,e)=>(t,i)=>e(t,i,I);import{ModifierKeyEmitter as Y,isHTMLElement as Z}from"../../../../base/browser/dom.js";import{isNonEmptyArray as U}from"../../../../base/common/arrays.js";import{RunOnceScheduler as ee,disposableTimeout as te}from"../../../../base/common/async.js";import{CancellationToken as W,CancellationTokenSource as B}from"../../../../base/common/cancellation.js";import{onUnexpectedError as ne}from"../../../../base/common/errors.js";import{DisposableStore as k,MutableDisposable as ie,toDisposable as E}from"../../../../base/common/lifecycle.js";import{LRUCache as oe}from"../../../../base/common/map.js";import{assertType as K}from"../../../../base/common/types.js";import{URI as ae}from"../../../../base/common/uri.js";import{CommandsRegistry as se,ICommandService as re}from"../../../../platform/commands/common/commands.js";import{InstantiationType as de,registerSingleton as le}from"../../../../platform/instantiation/common/extensions.js";import{IInstantiationService as ce,createDecorator as he}from"../../../../platform/instantiation/common/instantiation.js";import{INotificationService as pe,Severity as me}from"../../../../platform/notification/common/notification.js";import*as L from"../../../../platform/theme/common/colorRegistry.js";import{themeColorFromId as w}from"../../../../platform/theme/common/themeService.js";import{MouseTargetType as ue}from"../../../browser/editorBrowser.js";import{DynamicCssRules as fe}from"../../../browser/editorDom.js";import{StableEditorScrollState as ge}from"../../../browser/stableEditorScroll.js";import{EDITOR_FONT_DEFAULTS as ye,EditorOption as S}from"../../../common/config/editorOptions.js";import{EditOperation as Ie}from"../../../common/core/editOperation.js";import{Range as D}from"../../../common/core/range.js";import*as A from"../../../common/languages.js";import{InjectedTextCursorStops as T,TrackedRangeStickiness as _e}from"../../../common/model.js";import{ModelDecorationInjectedTextOptions as ve}from"../../../common/model/textModel.js";import{ILanguageFeatureDebounceService as be}from"../../../common/services/languageFeatureDebounce.js";import{ILanguageFeaturesService as G}from"../../../common/services/languageFeatures.js";import{ITextModelService as He}from"../../../common/services/resolverService.js";import{ClickLinkGesture as De}from"../../gotoSymbol/browser/link/clickLinkGesture.js";import{InlayHintAnchor as Ce,InlayHintsFragments as z}from"./inlayHints.js";import{goToDefinitionWithLocation as Re,showGoToContextMenu as Me}from"./inlayHintsLocations.js";class N{_entries=new oe(50);get(e){const t=N._key(e);return this._entries.get(t)}set(e,t){const i=N._key(e);this._entries.set(i,t)}static _key(e){return`${e.uri.toString()}/${e.getVersionId()}`}}const V=he("IInlayHintsCache");le(V,N,de.Delayed);class X{constructor(e,t){this.item=e;this.index=t}get part(){const e=this.item.hint.label;return typeof e=="string"?{label:e}:e[this.index]}}class xe{constructor(e,t){this.part=e;this.hasTriggerModifier=t}}var Le=(t=>(t[t.Normal=0]="Normal",t[t.Invisible=1]="Invisible",t))(Le||{});let H=class{constructor(e,t,i,n,a,o,d){this._editor=e;this._languageFeaturesService=t;this._inlayHintsCache=n;this._commandService=a;this._notificationService=o;this._instaService=d;this._debounceInfo=i.for(t.inlayHintsProvider,"InlayHint",{min:25}),this._disposables.add(t.inlayHintsProvider.onDidChange(()=>this._update())),this._disposables.add(e.onDidChangeModel(()=>this._update())),this._disposables.add(e.onDidChangeModelLanguage(()=>this._update())),this._disposables.add(e.onDidChangeConfiguration(c=>{c.hasChanged(S.inlayHints)&&this._update()})),this._update()}static ID="editor.contrib.InlayHints";static _MAX_DECORATORS=1500;static _whitespaceData={};static get(e){return e.getContribution(H.ID)??void 0}_disposables=new k;_sessionDisposables=new k;_debounceInfo;_decorationsMetadata=new Map;_ruleFactory=new fe(this._editor);_cursorInfo;_activeRenderMode=0;_activeInlayHintPart;dispose(){this._sessionDisposables.dispose(),this._removeAllDecorations(),this._disposables.dispose()}_update(){this._sessionDisposables.clear(),this._removeAllDecorations();const e=this._editor.getOption(S.inlayHints);if(e.enabled==="off")return;const t=this._editor.getModel();if(!t||!this._languageFeaturesService.inlayHintsProvider.has(t))return;if(e.enabled==="on")this._activeRenderMode=0;else{let c,g;e.enabled==="onUnlessPressed"?(c=0,g=1):(c=1,g=0),this._activeRenderMode=c,this._sessionDisposables.add(Y.getInstance().event(m=>{if(!this._editor.hasModel())return;const p=m.altKey&&m.ctrlKey&&!(m.shiftKey||m.metaKey)?g:c;if(p!==this._activeRenderMode){this._activeRenderMode=p;const v=this._editor.getModel(),C=this._copyInlayHintsWithCurrentAnchor(v);this._updateHintsDecorators([v.getFullModelRange()],C),o.schedule(0)}}))}const i=this._inlayHintsCache.get(t);i&&this._updateHintsDecorators([t.getFullModelRange()],i),this._sessionDisposables.add(E(()=>{t.isDisposed()||this._cacheHintsForFastRestore(t)}));let n;const a=new Set,o=new ee(async()=>{const c=Date.now();n?.dispose(!0),n=new B;const g=t.onWillDispose(()=>n?.cancel());try{const m=n.token,p=await z.create(this._languageFeaturesService.inlayHintsProvider,t,this._getHintsRanges(),m);if(o.delay=this._debounceInfo.update(t,Date.now()-c),m.isCancellationRequested){p.dispose();return}for(const v of p.provider)typeof v.onDidChangeInlayHints=="function"&&!a.has(v)&&(a.add(v),this._sessionDisposables.add(v.onDidChangeInlayHints(()=>{o.isScheduled()||o.schedule()})));this._sessionDisposables.add(p),this._updateHintsDecorators(p.ranges,p.items),this._cacheHintsForFastRestore(t)}catch(m){ne(m)}finally{n.dispose(),g.dispose()}},this._debounceInfo.get(t));this._sessionDisposables.add(o),this._sessionDisposables.add(E(()=>n?.dispose(!0))),o.schedule(0),this._sessionDisposables.add(this._editor.onDidScrollChange(c=>{(c.scrollTopChanged||!o.isScheduled())&&o.schedule()}));const d=this._sessionDisposables.add(new ie);this._sessionDisposables.add(this._editor.onDidChangeModelContent(c=>{n?.cancel();const g=Math.max(o.delay,800);this._cursorInfo={position:this._editor.getPosition(),notEarlierThan:Date.now()+g},d.value=te(()=>o.schedule(0),g),o.schedule()})),this._sessionDisposables.add(this._editor.onDidChangeConfiguration(c=>{c.hasChanged(S.inlayHints)&&o.schedule()})),this._sessionDisposables.add(this._installDblClickGesture(()=>o.schedule(0))),this._sessionDisposables.add(this._installLinkGesture()),this._sessionDisposables.add(this._installContextMenu())}_installLinkGesture(){const e=new k,t=e.add(new De(this._editor)),i=new k;return e.add(i),e.add(t.onMouseMoveOrRelevantKeyDown(n=>{const[a]=n,o=this._getInlayHintLabelPart(a),d=this._editor.getModel();if(!o||!d){i.clear();return}const c=new B;i.add(E(()=>c.dispose(!0))),o.item.resolve(c.token),this._activeInlayHintPart=o.part.command||o.part.location?new xe(o,a.hasTriggerModifier):void 0;const g=d.validatePosition(o.item.hint.position).lineNumber,m=new D(g,1,g,d.getLineMaxColumn(g)),p=this._getInlineHintsForRange(m);this._updateHintsDecorators([m],p),i.add(E(()=>{this._activeInlayHintPart=void 0,this._updateHintsDecorators([m],p)}))})),e.add(t.onCancel(()=>i.clear())),e.add(t.onExecute(async n=>{const a=this._getInlayHintLabelPart(n);if(a){const o=a.part;o.location?this._instaService.invokeFunction(Re,n,this._editor,o.location):A.Command.is(o.command)&&await this._invokeCommand(o.command,a.item)}})),e}_getInlineHintsForRange(e){const t=new Set;for(const i of this._decorationsMetadata.values())e.containsRange(i.item.anchor.range)&&t.add(i.item);return Array.from(t)}_installDblClickGesture(e){return this._editor.onMouseUp(async t=>{if(t.event.detail!==2)return;const i=this._getInlayHintLabelPart(t);if(i&&(t.event.preventDefault(),await i.item.resolve(W.None),U(i.item.hint.textEdits))){const n=i.item.hint.textEdits.map(a=>Ie.replace(D.lift(a.range),a.text));this._editor.executeEdits("inlayHint.default",n),e()}})}_installContextMenu(){return this._editor.onContextMenu(async e=>{if(!Z(e.event.target))return;const t=this._getInlayHintLabelPart(e);t&&await this._instaService.invokeFunction(Me,this._editor,e.event.target,t)})}_getInlayHintLabelPart(e){if(e.target.type!==ue.CONTENT_TEXT)return;const t=e.target.detail.injectedText?.options;if(t instanceof ve&&t?.attachedData instanceof X)return t.attachedData}async _invokeCommand(e,t){try{await this._commandService.executeCommand(e.id,...e.arguments??[])}catch(i){this._notificationService.notify({severity:me.Error,source:t.provider.displayName,message:i})}}_cacheHintsForFastRestore(e){const t=this._copyInlayHintsWithCurrentAnchor(e);this._inlayHintsCache.set(e,t)}_copyInlayHintsWithCurrentAnchor(e){const t=new Map;for(const[i,n]of this._decorationsMetadata){if(t.has(n.item))continue;const a=e.getDecorationRange(i);if(a){const o=new Ce(a,n.item.anchor.direction),d=n.item.with({anchor:o});t.set(n.item,d)}}return Array.from(t.values())}_getHintsRanges(){const t=this._editor.getModel(),i=this._editor.getVisibleRangesPlusViewportAboveBelow(),n=[];for(const a of i.sort(D.compareRangesUsingStarts)){const o=t.validateRange(new D(a.startLineNumber-30,a.startColumn,a.endLineNumber+30,a.endColumn));n.length===0||!D.areIntersectingOrTouching(n[n.length-1],o)?n.push(o):n[n.length-1]=D.plusRange(n[n.length-1],o)}return n}_updateHintsDecorators(e,t){const i=new Map;if(this._cursorInfo&&this._cursorInfo.notEarlierThan>Date.now()&&e.some(r=>r.containsPosition(this._cursorInfo.position))){const{position:r}=this._cursorInfo;this._cursorInfo=void 0;const s=new Map;for(const l of this._editor.getLineDecorations(r.lineNumber)??[]){const y=this._decorationsMetadata.get(l.id);if(l.range.startColumn>r.column)continue;const b=y?.decoration.options[y.item.anchor.direction];if(b&&b.attachedData!==H._whitespaceData){const R=s.get(y.item)??0;s.set(y.item,R+b.content.length)}}const h=t.filter(l=>l.anchor.range.startLineNumber===r.lineNumber&&l.anchor.range.endColumn<=r.column),u=Array.from(s.values());let _;for(;;){const l=h.shift(),y=u.shift();if(!y&&!l)break;if(l)i.set(l,y??0),_=l;else if(_&&y){let b=i.get(_);b+=y,b+=u.reduce((R,f)=>R+f,0),u.length=0;break}}}const n=[],a=(r,s,h,u,_)=>{const l={content:h,inlineClassNameAffectsLetterSpacing:!0,inlineClassName:s.className,cursorStops:u,attachedData:_};n.push({item:r,classNameRef:s,decoration:{range:r.anchor.range,options:{description:"InlayHint",showIfCollapsed:r.anchor.range.isEmpty(),collapseOnReplaceEdit:!r.anchor.range.isEmpty(),stickiness:_e.AlwaysGrowsWhenTypingAtEdges,[r.anchor.direction]:this._activeRenderMode===0?l:void 0}}})},o=(r,s)=>{const h=this._ruleFactory.createClassNameRef({width:`${d/3|0}px`,display:"inline-block"});a(r,h,"\u200A",s?T.Right:T.None,H._whitespaceData)},{fontSize:d,fontFamily:c,padding:g,isUniform:m}=this._getLayoutInfo(),p=this._editor.getOption(S.inlayHints).maximumLength,v="--code-editorInlayHintsFontFamily";this._editor.getContainerDomNode().style.setProperty(v,c);let C={line:0,totalLen:0};for(let r=0;r<t.length;r++){const s=t[r];if(C.line!==s.anchor.range.startLineNumber&&(C={line:s.anchor.range.startLineNumber,totalLen:0}),p&&C.totalLen>p)continue;s.hint.paddingLeft&&o(s,!1);const h=typeof s.hint.label=="string"?[{label:s.hint.label}]:s.hint.label,u=i.get(s);let _=0;for(let l=0;l<h.length;l++){const y=h[l],b=l===0,R=l===h.length-1,f={fontSize:`${d}px`,fontFamily:`var(${v}), ${ye.fontFamily}`,verticalAlign:m?"baseline":"middle",unicodeBidi:"isolate"};U(s.hint.textEdits)&&(f.cursor="default"),this._fillInColors(f,s.hint),(y.command||y.location)&&this._activeInlayHintPart?.part.item===s&&this._activeInlayHintPart.part.index===l&&(f.textDecoration="underline",this._activeInlayHintPart.hasTriggerModifier&&(f.color=w(L.editorActiveLinkForeground),f.cursor="pointer"));let M=y.label;C.totalLen+=M.length;let F=!1;const j=p!==0?C.totalLen-p:0;j>0&&(M=M.slice(0,-j)+"\u2026",F=!0),_+=M.length;const P=u!==void 0?_-u:0;if(P>0&&(_-=P,M=M.slice(0,-(1+P))+"\u2026",F=!0),g&&(b&&(R||F)?(f.padding=`1px ${Math.max(1,d/4)|0}px`,f.borderRadius=`${d/4|0}px`):b?(f.padding=`1px 0 1px ${Math.max(1,d/4)|0}px`,f.borderRadius=`${d/4|0}px 0 0 ${d/4|0}px`):R||F?(f.padding=`1px ${Math.max(1,d/4)|0}px 1px 0`,f.borderRadius=`0 ${d/4|0}px ${d/4|0}px 0`):f.padding="1px 0 1px 0"),a(s,this._ruleFactory.createClassNameRef(f),we(M),R&&!s.hint.paddingRight?T.Right:T.None,new X(s,l)),F)break}if(u!==void 0&&_<u){const l=u-_;a(s,this._ruleFactory.createClassNameRef({}),"\u200A".repeat(l),T.None)}if(s.hint.paddingRight&&o(s,!0),n.length>H._MAX_DECORATORS)break}const O=[];for(const[r,s]of this._decorationsMetadata){const h=this._editor.getModel()?.getDecorationRange(r);h&&e.some(u=>u.containsRange(h))&&(O.push(r),s.classNameRef.dispose(),this._decorationsMetadata.delete(r))}const q=ge.capture(this._editor);this._editor.changeDecorations(r=>{const s=r.deltaDecorations(O,n.map(h=>h.decoration));for(let h=0;h<s.length;h++){const u=n[h];this._decorationsMetadata.set(s[h],u)}}),q.restore(this._editor)}_fillInColors(e,t){t.kind===A.InlayHintKind.Parameter?(e.backgroundColor=w(L.editorInlayHintParameterBackground),e.color=w(L.editorInlayHintParameterForeground)):t.kind===A.InlayHintKind.Type?(e.backgroundColor=w(L.editorInlayHintTypeBackground),e.color=w(L.editorInlayHintTypeForeground)):(e.backgroundColor=w(L.editorInlayHintBackground),e.color=w(L.editorInlayHintForeground))}_getLayoutInfo(){const e=this._editor.getOption(S.inlayHints),t=e.padding,i=this._editor.getOption(S.fontSize),n=this._editor.getOption(S.fontFamily);let a=e.fontSize;(!a||a<5||a>i)&&(a=i);const o=e.fontFamily||n;return{fontSize:a,fontFamily:o,padding:t,isUniform:!t&&o===n&&a===i}}_removeAllDecorations(){this._editor.removeDecorations(Array.from(this._decorationsMetadata.keys()));for(const e of this._decorationsMetadata.values())e.classNameRef.dispose();this._decorationsMetadata.clear()}getInlayHintsForLine(e){if(!this._editor.hasModel())return[];const t=new Set,i=[];for(const n of this._editor.getLineDecorations(e)){const a=this._decorationsMetadata.get(n.id);a&&!t.has(a.item.hint)&&(t.add(a.item.hint),i.push(a.item))}return i}};H=$([x(1,G),x(2,be),x(3,V),x(4,re),x(5,pe),x(6,ce)],H);function we(I){return I.replace(/[ \t]/g,"\xA0")}se.registerCommand("_executeInlayHintProvider",async(I,...e)=>{const[t,i]=e;K(ae.isUri(t)),K(D.isIRange(i));const{inlayHintsProvider:n}=I.get(G),a=await I.get(He).createModelReference(t);try{const o=await z.create(n,a.object.textEditorModel,[D.lift(i)],W.None),d=o.items.map(c=>c.hint);return setTimeout(()=>o.dispose(),0),d}finally{a.dispose()}});export{H as InlayHintsController,X as RenderedInlayHintLabelPart};
