import*as a from"../../../../base/browser/dom.js";import{renderLabelWithIcons as p}from"../../../../base/browser/ui/iconLabel/iconLabels.js";import{Constants as f}from"../../../../base/common/uint.js";import"./codelensWidget.css";import{ContentWidgetPositionPreference as v}from"../../../browser/editorBrowser.js";import{Range as l}from"../../../common/core/range.js";import"../../../common/model.js";import{ModelDecorationOptions as C}from"../../../common/model/textModel.js";import"../../../common/languages.js";import"./codelens.js";class I{suppressMouseDown;domNode;afterLineNumber;afterColumn=f.MAX_SAFE_SMALL_INTEGER;heightInPx;_lastHeight;_onHeight;constructor(e,t,o){this.afterLineNumber=e,this.heightInPx=t,this._onHeight=o,this.suppressMouseDown=!0,this.domNode=document.createElement("div")}onComputedHeight(e){this._lastHeight===void 0?this._lastHeight=e:this._lastHeight!==e&&(this._lastHeight=e,this._onHeight())}isVisible(){return this._lastHeight!==0&&this.domNode.hasAttribute("monaco-visible-view-zone")}}class m{static _idPool=0;allowEditorOverflow=!1;suppressMouseDown=!0;_id;_domNode;_editor;_commands=new Map;_widgetPosition;_isEmpty=!0;constructor(e,t){this._editor=e,this._id=`codelens.widget-${m._idPool++}`,this.updatePosition(t),this._domNode=document.createElement("span"),this._domNode.className="codelens-decoration"}withCommands(e,t){this._commands.clear();const o=[];let i=!1;for(let s=0;s<e.length;s++){const n=e[s];if(n&&(i=!0,n.command)){const d=p(n.command.title.trim());if(n.command.id){const r=`c${m._idPool++}`;o.push(a.$("a",{id:r,title:n.command.tooltip,role:"button"},...d)),this._commands.set(r,n.command)}else o.push(a.$("span",{title:n.command.tooltip},...d));s+1<e.length&&o.push(a.$("span",void 0,"\xA0|\xA0"))}}i?(a.reset(this._domNode,...o),this._isEmpty&&t&&this._domNode.classList.add("fadein"),this._isEmpty=!1):a.reset(this._domNode,a.$("span",void 0,"no commands"))}getCommand(e){return e.parentElement===this._domNode?this._commands.get(e.id):void 0}getId(){return this._id}getDomNode(){return this._domNode}updatePosition(e){const t=this._editor.getModel().getLineFirstNonWhitespaceColumn(e);this._widgetPosition={position:{lineNumber:e,column:t},preference:[v.ABOVE]}}getPosition(){return this._widgetPosition||null}}class S{_removeDecorations;_addDecorations;_addDecorationsCallbacks;constructor(){this._removeDecorations=[],this._addDecorations=[],this._addDecorationsCallbacks=[]}addDecoration(e,t){this._addDecorations.push(e),this._addDecorationsCallbacks.push(t)}removeDecoration(e){this._removeDecorations.push(e)}commit(e){const t=e.deltaDecorations(this._removeDecorations,this._addDecorations);for(let o=0,i=t.length;o<i;o++)this._addDecorationsCallbacks[o](t[o])}}const _=C.register({collapseOnReplaceEdit:!0,description:"codelens"});class F{_editor;_viewZone;_viewZoneId;_contentWidget;_decorationIds;_data;_isDisposed=!1;constructor(e,t,o,i,s,n){this._editor=t,this._data=e,this._decorationIds=[];let d;const r=[];this._data.forEach((c,g)=>{c.symbol.command&&r.push(c.symbol),o.addDecoration({range:c.symbol.range,options:_},u=>this._decorationIds[g]=u),d?d=l.plusRange(d,c.symbol.range):d=l.lift(c.symbol.range)}),this._viewZone=new I(d.startLineNumber-1,s,n),this._viewZoneId=i.addZone(this._viewZone),r.length>0&&(this._createContentWidgetIfNecessary(),this._contentWidget.withCommands(r,!1))}_createContentWidgetIfNecessary(){this._contentWidget?this._editor.layoutContentWidget(this._contentWidget):(this._contentWidget=new m(this._editor,this._viewZone.afterLineNumber+1),this._editor.addContentWidget(this._contentWidget))}dispose(e,t){this._decorationIds.forEach(e.removeDecoration,e),this._decorationIds=[],t?.removeZone(this._viewZoneId),this._contentWidget&&(this._editor.removeContentWidget(this._contentWidget),this._contentWidget=void 0),this._isDisposed=!0}isDisposed(){return this._isDisposed}isValid(){return this._decorationIds.some((e,t)=>{const o=this._editor.getModel().getDecorationRange(e),i=this._data[t].symbol;return!!(o&&l.isEmpty(i.range)===o.isEmpty())})}updateCodeLensSymbols(e,t){this._decorationIds.forEach(t.removeDecoration,t),this._decorationIds=[],this._data=e,this._data.forEach((o,i)=>{t.addDecoration({range:o.symbol.range,options:_},s=>this._decorationIds[i]=s)})}updateHeight(e,t){this._viewZone.heightInPx=e,t.layoutZone(this._viewZoneId),this._contentWidget&&this._editor.layoutContentWidget(this._contentWidget)}computeIfNecessary(e){if(!this._viewZone.isVisible())return null;for(let t=0;t<this._decorationIds.length;t++){const o=e.getDecorationRange(this._decorationIds[t]);o&&(this._data[t].symbol.range=o)}return this._data}updateCommands(e){this._createContentWidgetIfNecessary(),this._contentWidget.withCommands(e,!0);for(let t=0;t<this._data.length;t++){const o=e[t];if(o){const{symbol:i}=this._data[t];i.command=o.command||i.command}}}getCommand(e){return this._contentWidget?.getCommand(e)}getLineNumber(){const e=this._editor.getModel().getDecorationRange(this._decorationIds[0]);return e?e.startLineNumber:-1}update(e){if(this.isValid()){const t=this._editor.getModel().getDecorationRange(this._decorationIds[0]);t&&(this._viewZone.afterLineNumber=t.startLineNumber-1,e.layoutZone(this._viewZoneId),this._contentWidget&&(this._contentWidget.updatePosition(t.startLineNumber),this._editor.layoutContentWidget(this._contentWidget)))}}getItems(){return this._data}}export{S as CodeLensHelper,F as CodeLensWidget};
