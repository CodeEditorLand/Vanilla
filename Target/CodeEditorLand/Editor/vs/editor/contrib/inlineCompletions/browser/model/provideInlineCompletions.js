import{assertNever as E}from"../../../../../../vs/base/common/assert.js";import{DeferredPromise as N}from"../../../../../../vs/base/common/async.js";import{CancellationToken as k}from"../../../../../../vs/base/common/cancellation.js";import{onUnexpectedExternalError as w}from"../../../../../../vs/base/common/errors.js";import"../../../../../../vs/base/common/lifecycle.js";import{SetMap as M}from"../../../../../../vs/base/common/map.js";import"../../../../../../vs/editor/common/core/editOperation.js";import{Position as S}from"../../../../../../vs/editor/common/core/position.js";import{Range as h}from"../../../../../../vs/editor/common/core/range.js";import{SingleTextEdit as B}from"../../../../../../vs/editor/common/core/textEdit.js";import"../../../../../../vs/editor/common/languageFeatureRegistry.js";import"../../../../../../vs/editor/common/languages.js";import"../../../../../../vs/editor/common/languages/languageConfigurationRegistry.js";import"../../../../../../vs/editor/common/model.js";import{fixBracketsInLine as A}from"../../../../../../vs/editor/common/model/bracketPairsTextModelPart/fixBrackets.js";import{SnippetParser as D,Text as G}from"../../../../../../vs/editor/contrib/snippet/browser/snippetParser.js";import{getReadonlyEmptyArray as z}from"../utils.js";async function Ie(r,e,i,a,f=k.None,d){const l=e instanceof S?j(e,i):e,p=r.all(i),o=new M;for(const n of p)n.groupId&&o.add(n.groupId,n);function u(n){if(!n.yieldsToGroupIds)return[];const s=[];for(const m of n.yieldsToGroupIds||[]){const c=o.get(m);for(const t of c)s.push(t)}return s}const I=new Map,g=new Set;function P(n,s){if(s=[...s,n],g.has(n))return s;g.add(n);try{const m=u(n);for(const c of m){const t=P(c,s);if(t)return t}}finally{g.delete(n)}}function x(n){const s=I.get(n);if(s)return s;const m=P(n,[]);m&&w(new Error(`Inline completions: cyclic yield-to dependency detected. Path: ${m.map(t=>t.toString?t.toString():""+t).join(" -> ")}`));const c=new N;return I.set(n,c.p),(async()=>{if(!m){const t=u(n);for(const R of t){const v=await x(R);if(v&&v.items.length>0)return}}try{return e instanceof S?await n.provideInlineCompletions(i,e,a,f):await n.provideInlineEdits?.(i,e,a,f)}catch(t){w(t);return}})().then(t=>c.complete(t),t=>c.error(t)),c.p}const b=await Promise.all(p.map(async n=>({provider:n,completions:await x(n)}))),y=new Map,T=[];for(const n of b){const s=n.completions;if(!s)continue;const m=new W(s,n.provider);T.push(m);for(const c of s.items){const t=C.from(c,m,l,i,d);y.set(t.hash(),t)}}return new F(Array.from(y.values()),new Set(y.keys()),T)}class F{constructor(e,i,a){this.completions=e;this.hashs=i;this.providerResults=a}has(e){return this.hashs.has(e.hash())}dispose(){for(const e of this.providerResults)e.removeRef()}}class W{constructor(e,i){this.inlineCompletions=e;this.provider=i}refCount=1;addRef(){this.refCount++}removeRef(){this.refCount--,this.refCount===0&&this.provider.freeInlineCompletions(this.inlineCompletions)}}class C{constructor(e,i,a,f,d,l,p,o){this.filterText=e;this.command=i;this.range=a;this.insertText=f;this.snippetInfo=d;this.additionalTextEdits=l;this.sourceInlineCompletion=p;this.source=o;e=e.replace(/\r\n|\r/g,`
`),f=e.replace(/\r\n|\r/g,`
`)}static from(e,i,a,f,d){let l,p,o=e.range?h.lift(e.range):a;if(typeof e.insertText=="string"){if(l=e.insertText,d&&e.completeBracketPairs){l=L(l,o.getStartPosition(),f,d);const u=l.length-e.insertText.length;u!==0&&(o=new h(o.startLineNumber,o.startColumn,o.endLineNumber,o.endColumn+u))}p=void 0}else if("snippet"in e.insertText){const u=e.insertText.snippet.length;if(d&&e.completeBracketPairs){e.insertText.snippet=L(e.insertText.snippet,o.getStartPosition(),f,d);const g=e.insertText.snippet.length-u;g!==0&&(o=new h(o.startLineNumber,o.startColumn,o.endLineNumber,o.endColumn+g))}const I=new D().parse(e.insertText.snippet);I.children.length===1&&I.children[0]instanceof G?(l=I.children[0].value,p=void 0):(l=I.toString(),p={snippet:e.insertText.snippet,range:o})}else E(e.insertText);return new C(l,e.command,o,l,p,e.additionalTextEdits||z(),e,i)}withRange(e){return new C(this.filterText,this.command,e,this.insertText,this.snippetInfo,this.additionalTextEdits,this.sourceInlineCompletion,this.source)}hash(){return JSON.stringify({insertText:this.insertText,range:this.range.toString()})}toSingleTextEdit(){return new B(this.range,this.insertText)}}function j(r,e){const i=e.getWordAtPosition(r),a=e.getLineMaxColumn(r.lineNumber);return i?new h(r.lineNumber,i.startColumn,r.lineNumber,a):h.fromPositions(r,r.with(void 0,a))}function L(r,e,i,a){const d=i.getLineContent(e.lineNumber).substring(0,e.column-1)+r,p=i.tokenization.tokenizeLineWithEdit(e,d.length-(e.column-1),r)?.sliceAndInflate(e.column-1,d.length,0);return p?A(p,a):r}export{C as InlineCompletionItem,W as InlineCompletionList,F as InlineCompletionProviderResult,Ie as provideInlineCompletions};
