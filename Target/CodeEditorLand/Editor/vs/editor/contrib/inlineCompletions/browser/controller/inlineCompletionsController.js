var R=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var I=(m,a,e,t)=>{for(var o=t>1?void 0:t?W(a,e):a,n=m.length-1,g;n>=0;n--)(g=m[n])&&(o=(t?g(a,e,o):g(o))||o);return t&&o&&R(a,e,o),o},s=(m,a)=>(e,t)=>a(e,t,m);import{createStyleSheetFromObservable as F}from"../../../../../base/browser/domObservable.js";import{alert as E}from"../../../../../base/browser/ui/aria/aria.js";import{timeout as K}from"../../../../../base/common/async.js";import{cancelOnDispose as C}from"../../../../../base/common/cancellation.js";import{readHotReloadableExport as L}from"../../../../../base/common/hotReloadHelpers.js";import{Disposable as M,toDisposable as G}from"../../../../../base/common/lifecycle.js";import{autorun as O,constObservable as P,derived as b,derivedDisposable as x,derivedObservableWithCache as U,mapObservableArrayCached as H,observableFromEvent as l,observableSignal as k,observableValue as w,runOnChange as A,runOnChangeWithStore as z,transaction as _,waitForState as B}from"../../../../../base/common/observable.js";import{isUndefined as N}from"../../../../../base/common/types.js";import{localize as j}from"../../../../../nls.js";import{IAccessibilityService as Z}from"../../../../../platform/accessibility/common/accessibility.js";import{AccessibilitySignal as $,IAccessibilitySignalService as q}from"../../../../../platform/accessibilitySignal/browser/accessibilitySignalService.js";import{ICommandService as J}from"../../../../../platform/commands/common/commands.js";import{IConfigurationService as Q}from"../../../../../platform/configuration/common/configuration.js";import{IContextKeyService as X}from"../../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as Y}from"../../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as ee}from"../../../../../platform/keybinding/common/keybinding.js";import{CoreEditingCommands as y}from"../../../../browser/coreCommands.js";import{observableCodeEditor as te}from"../../../../browser/observableCodeEditor.js";import{EditorOption as c}from"../../../../common/config/editorOptions.js";import{Position as D}from"../../../../common/core/position.js";import{CursorChangeReason as ie}from"../../../../common/cursorEvents.js";import{ILanguageFeatureDebounceService as oe}from"../../../../common/services/languageFeatureDebounce.js";import{ILanguageFeaturesService as ne}from"../../../../common/services/languageFeatures.js";import{InlineCompletionsHintsWidget as re,InlineSuggestionHintsContentWidget as se}from"../hintsWidget/inlineCompletionsHintsWidget.js";import{InlineCompletionsModel as ae}from"../model/inlineCompletionsModel.js";import{SuggestWidgetAdaptor as de}from"../model/suggestWidgetAdaptor.js";import{GhostTextView as le}from"../view/ghostTextView.js";import{inlineSuggestCommitId as ce}from"./commandIds.js";import{InlineCompletionContextKeys as ge}from"./inlineCompletionContextKeys.js";let p=class extends M{constructor(e,t,o,n,g,d,f,me,pe,ue){super();this.editor=e;this._instantiationService=t;this._contextKeyService=o;this._configurationService=n;this._commandService=g;this._debounceService=d;this._languageFeaturesService=f;this._accessibilitySignalService=me;this._keybindingService=pe;this._accessibilityService=ue;this._register(new ge(this._contextKeyService,this.model)),this._register(A(this._editorObs.onDidType,(i,r)=>{this._enabled.get()&&this.model.get()?.trigger()})),this._register(this._commandService.onDidExecuteCommand(i=>{new Set([y.Tab.id,y.DeleteLeft.id,y.DeleteRight.id,ce,"acceptSelectedSuggestion"]).has(i.commandId)&&e.hasTextFocus()&&this._enabled.get()&&this._editorObs.forceUpdate(u=>{this.model.get()?.trigger(u)})})),this._register(A(this._editorObs.selections,(i,r,u)=>{u.some(h=>h.reason===ie.Explicit||h.source==="api")&&this.model.get()?.stop()})),this._register(this.editor.onDidBlurEditorWidget(()=>{this._contextKeyService.getContextKeyValue("accessibleViewIsShown")||this._configurationService.getValue("editor.inlineSuggest.keepOnBlur")||e.getOption(c.inlineSuggest).keepOnBlur||se.dropDownVisible||_(i=>{this.model.get()?.stop(i)})})),this._register(O(i=>{const r=this.model.read(i)?.state.read(i);r?.suggestItem?r.primaryGhostText.lineCount>=2&&this._suggestWidgetAdaptor.forceRenderingAbove():this._suggestWidgetAdaptor.stopForceRenderingAbove()})),this._register(G(()=>{this._suggestWidgetAdaptor.stopForceRenderingAbove()}));const T=U(this,(i,r)=>{const h=this.model.read(i)?.state.read(i);return this._suggestWidgetSelectedItem.get()?r:h?.inlineCompletion?.semanticId});this._register(z(b(i=>(this._playAccessibilitySignal.read(i),T.read(i),{})),async(i,r,u,h)=>{const v=this.model.get(),S=v?.state.get();if(!S||!v)return;const V=v.textModel.getLineContent(S.primaryGhostText.lineNumber);await K(50,C(h)),await B(this._suggestWidgetSelectedItem,N,()=>!1,C(h)),await this._accessibilitySignalService.playSignal($.inlineSuggestion),this.editor.getOption(c.screenReaderAnnounceInlineSuggestion)&&this._provideScreenReaderUpdate(S.primaryGhostText.renderForScreenReader(V))})),this._register(new re(this.editor,this.model,this._instantiationService)),this._register(F(b(i=>{const r=this._fontFamily.read(i);return r===""||r==="default"?"":`
.monaco-editor .ghost-text-decoration,
.monaco-editor .ghost-text-decoration-preview,
.monaco-editor .ghost-text {
	font-family: ${r};
}`}))),this._register(this._configurationService.onDidChangeConfiguration(i=>{i.affectsConfiguration("accessibility.verbosity.inlineCompletions")&&this.editor.updateOptions({inlineCompletionsAccessibilityVerbose:this._configurationService.getValue("accessibility.verbosity.inlineCompletions")})})),this.editor.updateOptions({inlineCompletionsAccessibilityVerbose:this._configurationService.getValue("accessibility.verbosity.inlineCompletions")})}static ID="editor.contrib.inlineCompletionsController";static get(e){return e.getContribution(p.ID)}_editorObs=te(this.editor);_positions=b(this,e=>this._editorObs.selections.read(e)?.map(t=>t.getEndPosition())??[new D(1,1)]);_suggestWidgetAdaptor=this._register(new de(this.editor,()=>(this._editorObs.forceUpdate(),this.model.get()?.selectedInlineCompletion.get()?.toSingleTextEdit(void 0)),e=>this._editorObs.forceUpdate(t=>{this.model.get()?.handleSuggestAccepted(e)})));_suggestWidgetSelectedItem=l(this,e=>this._suggestWidgetAdaptor.onDidSelectedItemChange(()=>{this._editorObs.forceUpdate(t=>e(void 0))}),()=>this._suggestWidgetAdaptor.selectedItem);_enabledInConfig=l(this,this.editor.onDidChangeConfiguration,()=>this.editor.getOption(c.inlineSuggest).enabled);_isScreenReaderEnabled=l(this,this._accessibilityService.onDidChangeScreenReaderOptimized,()=>this._accessibilityService.isScreenReaderOptimized());_editorDictationInProgress=l(this,this._contextKeyService.onDidChangeContext,()=>this._contextKeyService.getContext(this.editor.getDomNode()).getValue("editorDictation.inProgress")===!0);_enabled=b(this,e=>this._enabledInConfig.read(e)&&(!this._isScreenReaderEnabled.read(e)||!this._editorDictationInProgress.read(e)));_debounceValue=this._debounceService.for(this._languageFeaturesService.inlineCompletionsProvider,"InlineCompletionsDebounce",{min:50,max:50});model=x(this,e=>{if(this._editorObs.isReadonly.read(e))return;const t=this._editorObs.model.read(e);return t?this._instantiationService.createInstance(ae,t,this._suggestWidgetSelectedItem,this._editorObs.versionId,this._positions,this._debounceValue,l(this.editor.onDidChangeConfiguration,()=>this.editor.getOption(c.suggest).preview),l(this.editor.onDidChangeConfiguration,()=>this.editor.getOption(c.suggest).previewMode),l(this.editor.onDidChangeConfiguration,()=>this.editor.getOption(c.inlineSuggest).mode),this._enabled):void 0}).recomputeInitiallyAndOnChange(this._store);_ghostTexts=b(this,e=>this.model.read(e)?.ghostTexts.read(e)??[]);_stablizedGhostTexts=he(this._ghostTexts,this._store);_ghostTextWidgets=H(this,this._stablizedGhostTexts,(e,t)=>x(o=>this._instantiationService.createInstance(L(le,o),this.editor,{ghostText:e,minReservedLineCount:P(0),targetTextModel:this.model.map(n=>n?.textModel)})).recomputeInitiallyAndOnChange(t)).recomputeInitiallyAndOnChange(this._store);_playAccessibilitySignal=k(this);_fontFamily=l(this,this.editor.onDidChangeConfiguration,()=>this.editor.getOption(c.inlineSuggest).fontFamily);playAccessibilitySignal(e){this._playAccessibilitySignal.trigger(e)}_provideScreenReaderUpdate(e){const t=this._contextKeyService.getContextKeyValue("accessibleViewIsShown"),o=this._keybindingService.lookupKeybinding("editor.action.accessibleView");let n;!t&&o&&this.editor.getOption(c.inlineCompletionsAccessibilityVerbose)&&(n=j("showAccessibleViewHint","Inspect this in the accessible view ({0})",o.getAriaLabel())),E(n?e+", "+n:e)}shouldShowHoverAt(e){const t=this.model.get()?.primaryGhostText.get();return t?t.parts.some(o=>e.containsPosition(new D(t.lineNumber,o.column))):!1}shouldShowHoverAtViewZone(e){return this._ghostTextWidgets.get()[0]?.get().ownsViewZone(e)??!1}hide(){_(e=>{this.model.get()?.stop(e)})}};p=I([s(1,Y),s(2,X),s(3,Q),s(4,J),s(5,oe),s(6,ne),s(7,q),s(8,ee),s(9,Z)],p);function he(m,a){const e=w("result",[]),t=[];return a.add(O(o=>{const n=m.read(o);_(g=>{if(n.length!==t.length){t.length=n.length;for(let d=0;d<t.length;d++)t[d]||(t[d]=w("item",n[d]));e.set([...t],g)}t.forEach((d,f)=>d.set(n[f],g))})})),e}export{p as InlineCompletionsController};
