var $=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var W=(h,p,e,t)=>{for(var i=t>1?void 0:t?H(p,e):p,n=h.length-1,o;n>=0;n--)(o=h[n])&&(i=(t?o(p,e,i):o(i))||i);return t&&i&&$(p,e,i),i},P=(h,p)=>(e,t)=>p(e,t,h);import{mapFindFirst as j}from"../../../../../base/common/arraysFind.js";import{itemsEquals as O}from"../../../../../base/common/equals.js";import{BugIndicatingError as S,onUnexpectedError as z,onUnexpectedExternalError as J}from"../../../../../base/common/errors.js";import{Disposable as Q}from"../../../../../base/common/lifecycle.js";import{autorun as X,derived as x,derivedHandleChanges as Y,derivedOpts as v,observableSignal as V,observableValue as k,recomputeInitiallyAndOnChange as Z,subtransaction as G,transaction as ee}from"../../../../../base/common/observable.js";import{commonPrefixLength as te}from"../../../../../base/common/strings.js";import{isDefined as w}from"../../../../../base/common/types.js";import{ICommandService as ie}from"../../../../../platform/commands/common/commands.js";import{IInstantiationService as ne}from"../../../../../platform/instantiation/common/instantiation.js";import"../../../../browser/editorBrowser.js";import{EditOperation as R}from"../../../../common/core/editOperation.js";import{Position as q}from"../../../../common/core/position.js";import{Range as E}from"../../../../common/core/range.js";import{Selection as L}from"../../../../common/core/selection.js";import{SingleTextEdit as K}from"../../../../common/core/textEdit.js";import{TextLength as oe}from"../../../../common/core/textLength.js";import{ScrollType as se}from"../../../../common/editorCommon.js";import{InlineCompletionTriggerKind as A,PartialAcceptTriggerKind as M}from"../../../../common/languages.js";import{ILanguageConfigurationService as re}from"../../../../common/languages/languageConfigurationRegistry.js";import{EndOfLinePreference as le}from"../../../../common/model.js";import"../../../../common/services/languageFeatureDebounce.js";import"../../../../common/textModelEvents.js";import{SnippetController2 as de}from"../../../snippet/browser/snippetController2.js";import{addPositions as ae,getEndPositionsAfterApplying as F,substringPos as ce,subtractPositions as N}from"../utils.js";import{computeGhostText as D}from"./computeGhostText.js";import{GhostText as pe,ghostTextOrReplacementEquals as me,ghostTextsOrReplacementsEqual as B}from"./ghostText.js";import{InlineCompletionsSource as ue}from"./inlineCompletionsSource.js";import{InlineEdit as ge}from"./inlineEdit.js";import"./provideInlineCompletions.js";import{singleTextEditAugments as he,singleTextRemoveCommonPrefix as T}from"./singleTextEditHelpers.js";import"./suggestWidgetAdaptor.js";let b=class extends Q{constructor(e,t,i,n,o,s,d,r,a,l,c,m){super();this.textModel=e;this.selectedSuggestItem=t;this._textModelVersionId=i;this._positions=n;this._debounceValue=o;this._suggestPreviewEnabled=s;this._suggestPreviewMode=d;this._inlineSuggestMode=r;this._enabled=a;this._instantiationService=l;this._commandService=c;this._languageConfigurationService=m;this._register(Z(this._fetchInlineCompletionsPromise));let u;this._register(X(f=>{const g=this.state.read(f)?.inlineCompletion;if(g?.semanticId!==u?.semanticId&&(u=g,g)){const C=g.inlineCompletion,_=C.source;_.provider.handleItemDidShow?.(_.inlineCompletions,C.sourceInlineCompletion,C.insertText)}}))}_source=this._register(this._instantiationService.createInstance(ue,this.textModel,this._textModelVersionId,this._debounceValue));_isActive=k(this,!1);_forceUpdateExplicitlySignal=V(this);_selectedInlineCompletionId=k(this,void 0);_primaryPosition=x(this,e=>this._positions.read(e)[0]??new q(1,1));_isAcceptingPartially=!1;get isAcceptingPartially(){return this._isAcceptingPartially}_preserveCurrentCompletionReasons=new Set([1,0,2]);_getReason(e){return e?.isUndoing?0:e?.isRedoing?1:this.isAcceptingPartially?2:3}dontRefetchSignal=V(this);_fetchInlineCompletionsPromise=Y({owner:this,createEmptyChangeSummary:()=>({dontRefetch:!1,preserveCurrentCompletion:!1,inlineCompletionTriggerKind:A.Automatic}),handleChange:(e,t)=>(e.didChange(this._textModelVersionId)&&this._preserveCurrentCompletionReasons.has(this._getReason(e.change))?t.preserveCurrentCompletion=!0:e.didChange(this._forceUpdateExplicitlySignal)?t.inlineCompletionTriggerKind=A.Explicit:e.didChange(this.dontRefetchSignal)&&(t.dontRefetch=!0),!0)},(e,t)=>{if(this.dontRefetchSignal.read(e),this._forceUpdateExplicitlySignal.read(e),!(this._enabled.read(e)&&this.selectedSuggestItem.read(e)||this._isActive.read(e))){this._source.cancelUpdate();return}this._textModelVersionId.read(e);const n=this._source.suggestWidgetInlineCompletions.get(),o=this.selectedSuggestItem.read(e);if(n&&!o){const l=this._source.inlineCompletions.get();ee(c=>{(!l||n.request.versionId>l.request.versionId)&&this._source.inlineCompletions.set(n.clone(),c),this._source.clearSuggestWidgetInlineCompletions(c)})}const s=this._primaryPosition.read(e);if(t.dontRefetch)return Promise.resolve(!0);const d={triggerKind:t.inlineCompletionTriggerKind,selectedSuggestionInfo:o?.toSelectedSuggestionInfo()},r=this.selectedInlineCompletion.get(),a=t.preserveCurrentCompletion||r?.forwardStable?r:void 0;return this._source.fetch(s,d,a)});async trigger(e){this._isActive.set(!0,e),await this._fetchInlineCompletionsPromise.get()}async triggerExplicitly(e){G(e,t=>{this._isActive.set(!0,t),this._forceUpdateExplicitlySignal.trigger(t)}),await this._fetchInlineCompletionsPromise.get()}stop(e){G(e,t=>{this._isActive.set(!1,t),this._source.clear(t)})}_inlineCompletionItems=v({owner:this},e=>{const t=this._source.inlineCompletions.read(e);if(!t)return;const i=this._primaryPosition.read(e);let n;const o=[];for(const s of t.inlineCompletions)s.inlineCompletion.sourceInlineCompletion.isInlineEdit?o.length===0&&s.inlineCompletion.sourceInlineCompletion.isInlineEdit&&(n=s):s.isVisible(this.textModel,i,e)&&o.push(s);return{items:o,inlineEditCompletion:n}});_filteredInlineCompletionItems=v({owner:this,equalsFn:O()},e=>this._inlineCompletionItems.read(e)?.items??[]);selectedInlineCompletionIndex=x(this,e=>{const t=this._selectedInlineCompletionId.read(e),i=this._filteredInlineCompletionItems.read(e),n=this._selectedInlineCompletionId===void 0?-1:i.findIndex(o=>o.semanticId===t);return n===-1?(this._selectedInlineCompletionId.set(void 0,void 0),0):n});selectedInlineCompletion=x(this,e=>{const t=this._filteredInlineCompletionItems.read(e),i=this.selectedInlineCompletionIndex.read(e);return t[i]});activeCommands=v({owner:this,equalsFn:O()},e=>this.selectedInlineCompletion.read(e)?.inlineCompletion.source.inlineCompletions.commands??[]);lastTriggerKind=this._source.inlineCompletions.map(this,e=>e?.request.context.triggerKind);inlineCompletionsCount=x(this,e=>{if(this.lastTriggerKind.read(e)===A.Explicit)return this._filteredInlineCompletionItems.read(e).length});stateWithInlineEdit=v({owner:this,equalsFn:(e,t)=>!e||!t?e===t:e.kind==="ghostText"&&t.kind==="ghostText"?B(e.ghostTexts,t.ghostTexts)&&e.inlineCompletion===t.inlineCompletion&&e.suggestItem===t.suggestItem:e.kind==="inlineEdit"&&t.kind==="inlineEdit"?e.inlineEdit.edit.equals(t.inlineEdit.edit):!1},e=>{const t=this.textModel,i=this._inlineCompletionItems.read(e);if(i?.inlineEditCompletion){let o=i.inlineEditCompletion.toSingleTextEdit(e);return o=T(o,t),{kind:"inlineEdit",inlineEdit:new ge(o),inlineCompletion:i.inlineEditCompletion,edits:[o]}}const n=this.selectedSuggestItem.read(e);if(n){const o=T(n.toSingleTextEdit(),t),s=this._computeAugmentation(o,e);if(!this._suggestPreviewEnabled.read(e)&&!s)return;const r=s?.edit??o,a=s?s.edit.text.length-o.text.length:0,l=this._suggestPreviewMode.read(e),c=this._positions.read(e),m=[r,...U(this.textModel,c,r)],u=m.map((I,g)=>D(I,t,l,c[g],a)).filter(w),f=u[0]??new pe(r.range.endLineNumber,[]);return{kind:"ghostText",edits:m,primaryGhostText:f,ghostTexts:u,inlineCompletion:s?.completion,suggestItem:n}}else{if(!this._isActive.read(e))return;const o=this.selectedInlineCompletion.read(e);if(!o)return;const s=o.toSingleTextEdit(e),d=this._inlineSuggestMode.read(e),r=this._positions.read(e),a=[s,...U(this.textModel,r,s)],l=a.map((c,m)=>D(c,t,d,r[m],0)).filter(w);return l[0]?{kind:"ghostText",edits:a,primaryGhostText:l[0],ghostTexts:l,inlineCompletion:o,suggestItem:void 0}:void 0}});state=x(e=>{const t=this.stateWithInlineEdit.read(e);if(!(!t||t.kind!=="ghostText"))return t});stateInlineEdit=x(e=>{const t=this.stateWithInlineEdit.read(e);if(!(!t||t.kind!=="inlineEdit"))return t});_computeAugmentation(e,t){const i=this.textModel,n=this._source.suggestWidgetInlineCompletions.read(t),o=n?n.inlineCompletions:[this.selectedInlineCompletion.read(t)].filter(w);return j(o,d=>{let r=d.toSingleTextEdit(t);return r=T(r,i,E.fromPositions(r.range.getStartPosition(),e.range.getEndPosition())),he(r,e)?{completion:d,edit:r}:void 0})}ghostTexts=v({owner:this,equalsFn:B},e=>{const t=this.state.read(e);if(t)return t.ghostTexts});primaryGhostText=v({owner:this,equalsFn:me},e=>{const t=this.state.read(e);if(t)return t?.primaryGhostText});async _deltaSelectedInlineCompletionIndex(e){await this.triggerExplicitly();const t=this._filteredInlineCompletionItems.get()||[];if(t.length>0){const i=(this.selectedInlineCompletionIndex.get()+e+t.length)%t.length;this._selectedInlineCompletionId.set(t[i].semanticId,void 0)}else this._selectedInlineCompletionId.set(void 0,void 0)}async next(){await this._deltaSelectedInlineCompletionIndex(1)}async previous(){await this._deltaSelectedInlineCompletionIndex(-1)}async accept(e){if(e.getModel()!==this.textModel)throw new S;let t;const i=this.stateWithInlineEdit.get();if(i?.kind==="ghostText"){if(!i||i.primaryGhostText.isEmpty()||!i.inlineCompletion)return;t=i.inlineCompletion.toInlineCompletion(void 0)}else if(i?.kind==="inlineEdit")t=i.inlineCompletion.toInlineCompletion(void 0);else return;if(t.command&&t.source.addRef(),e.pushUndoStop(),t.snippetInfo)e.executeEdits("inlineSuggestion.accept",[R.replace(t.range,""),...t.additionalTextEdits]),e.setPosition(t.snippetInfo.range.getStartPosition(),"inlineCompletionAccept"),de.get(e)?.insert(t.snippetInfo.snippet,{undoStopBefore:!1});else{const n=i.edits,o=F(n).map(s=>L.fromPositions(s));e.executeEdits("inlineSuggestion.accept",[...n.map(s=>R.replace(s.range,s.text)),...t.additionalTextEdits]),e.setSelections(o,"inlineCompletionAccept")}this.stop(),t.command&&(await this._commandService.executeCommand(t.command.id,...t.command.arguments||[]).then(void 0,J),t.source.removeRef())}async acceptNextWord(e){await this._acceptNext(e,(t,i)=>{const n=this.textModel.getLanguageIdAtPosition(t.lineNumber,t.column),o=this._languageConfigurationService.getLanguageConfiguration(n),s=new RegExp(o.wordDefinition.source,o.wordDefinition.flags.replace("g","")),d=i.match(s);let r=0;d&&d.index!==void 0?d.index===0?r=d[0].length:r=d.index:r=i.length;const l=/\s+/g.exec(i);return l&&l.index!==void 0&&l.index+l[0].length<r&&(r=l.index+l[0].length),r},M.Word)}async acceptNextLine(e){await this._acceptNext(e,(t,i)=>{const n=i.match(/\n/);return n&&n.index!==void 0?n.index+1:i.length},M.Line)}async _acceptNext(e,t,i){if(e.getModel()!==this.textModel)throw new S;const n=this.state.get();if(!n||n.primaryGhostText.isEmpty()||!n.inlineCompletion)return;const o=n.primaryGhostText,s=n.inlineCompletion.toInlineCompletion(void 0);if(s.snippetInfo||s.filterText!==s.insertText){await this.accept(e);return}const d=o.parts[0],r=new q(o.lineNumber,d.column),a=d.text,l=t(r,a);if(l===a.length&&o.parts.length===1){this.accept(e);return}const c=a.substring(0,l),m=this._positions.get(),u=m[0];s.source.addRef();try{this._isAcceptingPartially=!0;try{e.pushUndoStop();const f=E.fromPositions(u,r),I=e.getModel().getValueInRange(f)+c,g=new K(f,I),C=[g,...U(this.textModel,m,g)],_=F(C).map(y=>L.fromPositions(y));e.executeEdits("inlineSuggestion.accept",C.map(y=>R.replace(y.range,y.text))),e.setSelections(_,"inlineCompletionPartialAccept"),e.revealPositionInCenterIfOutsideViewport(e.getPosition(),se.Immediate)}finally{this._isAcceptingPartially=!1}if(s.source.provider.handlePartialAccept){const f=E.fromPositions(s.range.getStartPosition(),oe.ofText(c).addToPosition(r)),I=e.getModel().getValueInRange(f,le.LF);s.source.provider.handlePartialAccept(s.source.inlineCompletions,s.sourceInlineCompletion,I.length,{kind:i})}}finally{s.source.removeRef()}}handleSuggestAccepted(e){const t=T(e.toSingleTextEdit(),this.textModel),i=this._computeAugmentation(t,void 0);if(!i)return;const n=i.completion.inlineCompletion;n.source.provider.handlePartialAccept?.(n.source.inlineCompletions,n.sourceInlineCompletion,t.text.length,{kind:M.Suggest})}};b=W([P(9,ne),P(10,ie),P(11,re)],b);var fe=(i=>(i[i.Undo=0]="Undo",i[i.Redo=1]="Redo",i[i.AcceptWord=2]="AcceptWord",i[i.Other=3]="Other",i))(fe||{});function U(h,p,e){if(p.length===1)return[];const t=p[0],i=p.slice(1),n=e.range.getStartPosition(),o=e.range.getEndPosition(),s=h.getValueInRange(E.fromPositions(t,o)),d=N(t,n);if(d.lineNumber<1)return z(new S(`positionWithinTextEdit line number should be bigger than 0.
			Invalid subtraction between ${t.toString()} and ${n.toString()}`)),[];const r=ce(e.text,d);return i.map(a=>{const l=ae(N(a,n),o),c=h.getValueInRange(E.fromPositions(a,l)),m=te(s,c),u=E.fromPositions(a,a.delta(0,m));return new K(u,r)})}export{b as InlineCompletionsModel,fe as VersionIdChangeReason,U as getSecondaryEdits};
