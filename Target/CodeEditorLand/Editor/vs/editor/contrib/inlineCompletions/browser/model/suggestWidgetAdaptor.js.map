{
  "version": 3,
  "sources": ["../../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/editor/contrib/inlineCompletions/browser/model/suggestWidgetAdaptor.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { compareBy, numberComparator } from '../../../../../base/common/arrays.js';\nimport { findFirstMax } from '../../../../../base/common/arraysFind.js';\nimport { Emitter, Event } from '../../../../../base/common/event.js';\nimport { Disposable } from '../../../../../base/common/lifecycle.js';\nimport { ICodeEditor } from '../../../../browser/editorBrowser.js';\nimport { Position } from '../../../../common/core/position.js';\nimport { Range } from '../../../../common/core/range.js';\nimport { SingleTextEdit } from '../../../../common/core/textEdit.js';\nimport { CompletionItemInsertTextRule, CompletionItemKind, SelectedSuggestionInfo } from '../../../../common/languages.js';\nimport { ITextModel } from '../../../../common/model.js';\nimport { singleTextEditAugments, singleTextRemoveCommonPrefix } from './singleTextEdit.js';\nimport { SnippetParser } from '../../../snippet/browser/snippetParser.js';\nimport { SnippetSession } from '../../../snippet/browser/snippetSession.js';\nimport { CompletionItem } from '../../../suggest/browser/suggest.js';\nimport { SuggestController } from '../../../suggest/browser/suggestController.js';\n\nexport class SuggestWidgetAdaptor extends Disposable {\n\tprivate isSuggestWidgetVisible: boolean = false;\n\tprivate isShiftKeyPressed = false;\n\tprivate _isActive = false;\n\tprivate _currentSuggestItemInfo: SuggestItemInfo | undefined = undefined;\n\tpublic get selectedItem(): SuggestItemInfo | undefined {\n\t\treturn this._currentSuggestItemInfo;\n\t}\n\tprivate _onDidSelectedItemChange = this._register(new Emitter<void>());\n\tpublic readonly onDidSelectedItemChange: Event<void> = this._onDidSelectedItemChange.event;\n\n\tconstructor(\n\t\tprivate readonly editor: ICodeEditor,\n\t\tprivate readonly suggestControllerPreselector: () => SingleTextEdit | undefined,\n\t\tprivate readonly onWillAccept: (item: SuggestItemInfo) => void,\n\t) {\n\t\tsuper();\n\n\t\t// See the command acceptAlternativeSelectedSuggestion that is bound to shift+tab\n\t\tthis._register(editor.onKeyDown(e => {\n\t\t\tif (e.shiftKey && !this.isShiftKeyPressed) {\n\t\t\t\tthis.isShiftKeyPressed = true;\n\t\t\t\tthis.update(this._isActive);\n\t\t\t}\n\t\t}));\n\t\tthis._register(editor.onKeyUp(e => {\n\t\t\tif (e.shiftKey && this.isShiftKeyPressed) {\n\t\t\t\tthis.isShiftKeyPressed = false;\n\t\t\t\tthis.update(this._isActive);\n\t\t\t}\n\t\t}));\n\n\t\tconst suggestController = SuggestController.get(this.editor);\n\t\tif (suggestController) {\n\t\t\tthis._register(suggestController.registerSelector({\n\t\t\t\tpriority: 100,\n\t\t\t\tselect: (model, pos, suggestItems) => {\n\t\t\t\t\tconst textModel = this.editor.getModel();\n\t\t\t\t\tif (!textModel) {\n\t\t\t\t\t\t// Should not happen\n\t\t\t\t\t\treturn -1;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst i = this.suggestControllerPreselector();\n\t\t\t\t\tconst itemToPreselect = i ? singleTextRemoveCommonPrefix(i, textModel) : undefined;\n\t\t\t\t\tif (!itemToPreselect) {\n\t\t\t\t\t\treturn -1;\n\t\t\t\t\t}\n\t\t\t\t\tconst position = Position.lift(pos);\n\n\t\t\t\t\tconst candidates = suggestItems\n\t\t\t\t\t\t.map((suggestItem, index) => {\n\t\t\t\t\t\t\tconst suggestItemInfo = SuggestItemInfo.fromSuggestion(suggestController, textModel, position, suggestItem, this.isShiftKeyPressed);\n\t\t\t\t\t\t\tconst suggestItemTextEdit = singleTextRemoveCommonPrefix(suggestItemInfo.toSingleTextEdit(), textModel);\n\t\t\t\t\t\t\tconst valid = singleTextEditAugments(itemToPreselect, suggestItemTextEdit);\n\t\t\t\t\t\t\treturn { index, valid, prefixLength: suggestItemTextEdit.text.length, suggestItem };\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.filter(item => item && item.valid && item.prefixLength > 0);\n\n\t\t\t\t\tconst result = findFirstMax(\n\t\t\t\t\t\tcandidates,\n\t\t\t\t\t\tcompareBy(s => s!.prefixLength, numberComparator)\n\t\t\t\t\t);\n\t\t\t\t\treturn result ? result.index : - 1;\n\t\t\t\t}\n\t\t\t}));\n\n\t\t\tlet isBoundToSuggestWidget = false;\n\t\t\tconst bindToSuggestWidget = () => {\n\t\t\t\tif (isBoundToSuggestWidget) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tisBoundToSuggestWidget = true;\n\n\t\t\t\tthis._register(suggestController.widget.value.onDidShow(() => {\n\t\t\t\t\tthis.isSuggestWidgetVisible = true;\n\t\t\t\t\tthis.update(true);\n\t\t\t\t}));\n\t\t\t\tthis._register(suggestController.widget.value.onDidHide(() => {\n\t\t\t\t\tthis.isSuggestWidgetVisible = false;\n\t\t\t\t\tthis.update(false);\n\t\t\t\t}));\n\t\t\t\tthis._register(suggestController.widget.value.onDidFocus(() => {\n\t\t\t\t\tthis.isSuggestWidgetVisible = true;\n\t\t\t\t\tthis.update(true);\n\t\t\t\t}));\n\t\t\t};\n\n\t\t\tthis._register(Event.once(suggestController.model.onDidTrigger)(e => {\n\t\t\t\tbindToSuggestWidget();\n\t\t\t}));\n\n\t\t\tthis._register(suggestController.onWillInsertSuggestItem(e => {\n\t\t\t\tconst position = this.editor.getPosition();\n\t\t\t\tconst model = this.editor.getModel();\n\t\t\t\tif (!position || !model) { return undefined; }\n\n\t\t\t\tconst suggestItemInfo = SuggestItemInfo.fromSuggestion(\n\t\t\t\t\tsuggestController,\n\t\t\t\t\tmodel,\n\t\t\t\t\tposition,\n\t\t\t\t\te.item,\n\t\t\t\t\tthis.isShiftKeyPressed\n\t\t\t\t);\n\n\t\t\t\tthis.onWillAccept(suggestItemInfo);\n\t\t\t}));\n\t\t}\n\t\tthis.update(this._isActive);\n\t}\n\n\tprivate update(newActive: boolean): void {\n\t\tconst newInlineCompletion = this.getSuggestItemInfo();\n\n\t\tif (this._isActive !== newActive || !suggestItemInfoEquals(this._currentSuggestItemInfo, newInlineCompletion)) {\n\t\t\tthis._isActive = newActive;\n\t\t\tthis._currentSuggestItemInfo = newInlineCompletion;\n\n\t\t\tthis._onDidSelectedItemChange.fire();\n\t\t}\n\t}\n\n\tprivate getSuggestItemInfo(): SuggestItemInfo | undefined {\n\t\tconst suggestController = SuggestController.get(this.editor);\n\t\tif (!suggestController || !this.isSuggestWidgetVisible) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst focusedItem = suggestController.widget.value.getFocusedItem();\n\t\tconst position = this.editor.getPosition();\n\t\tconst model = this.editor.getModel();\n\n\t\tif (!focusedItem || !position || !model) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\treturn SuggestItemInfo.fromSuggestion(\n\t\t\tsuggestController,\n\t\t\tmodel,\n\t\t\tposition,\n\t\t\tfocusedItem.item,\n\t\t\tthis.isShiftKeyPressed\n\t\t);\n\t}\n\n\tpublic stopForceRenderingAbove(): void {\n\t\tconst suggestController = SuggestController.get(this.editor);\n\t\tsuggestController?.stopForceRenderingAbove();\n\t}\n\n\tpublic forceRenderingAbove(): void {\n\t\tconst suggestController = SuggestController.get(this.editor);\n\t\tsuggestController?.forceRenderingAbove();\n\t}\n}\n\nexport class SuggestItemInfo {\n\tpublic static fromSuggestion(suggestController: SuggestController, model: ITextModel, position: Position, item: CompletionItem, toggleMode: boolean): SuggestItemInfo {\n\t\tlet { insertText } = item.completion;\n\t\tlet isSnippetText = false;\n\t\tif (item.completion.insertTextRules! & CompletionItemInsertTextRule.InsertAsSnippet) {\n\t\t\tconst snippet = new SnippetParser().parse(insertText);\n\n\t\t\tif (snippet.children.length < 100) {\n\t\t\t\t// Adjust whitespace is expensive.\n\t\t\t\tSnippetSession.adjustWhitespace(model, position, true, snippet);\n\t\t\t}\n\n\t\t\tinsertText = snippet.toString();\n\t\t\tisSnippetText = true;\n\t\t}\n\n\t\tconst info = suggestController.getOverwriteInfo(item, toggleMode);\n\n\t\treturn new SuggestItemInfo(\n\t\t\tRange.fromPositions(\n\t\t\t\tposition.delta(0, -info.overwriteBefore),\n\t\t\t\tposition.delta(0, Math.max(info.overwriteAfter, 0))\n\t\t\t),\n\t\t\tinsertText,\n\t\t\titem.completion.kind,\n\t\t\tisSnippetText,\n\t\t);\n\t}\n\n\tprivate constructor(\n\t\tpublic readonly range: Range,\n\t\tpublic readonly insertText: string,\n\t\tpublic readonly completionItemKind: CompletionItemKind,\n\t\tpublic readonly isSnippetText: boolean,\n\t) { }\n\n\tpublic equals(other: SuggestItemInfo): boolean {\n\t\treturn this.range.equalsRange(other.range)\n\t\t\t&& this.insertText === other.insertText\n\t\t\t&& this.completionItemKind === other.completionItemKind\n\t\t\t&& this.isSnippetText === other.isSnippetText;\n\t}\n\n\tpublic toSelectedSuggestionInfo(): SelectedSuggestionInfo {\n\t\treturn new SelectedSuggestionInfo(this.range, this.insertText, this.completionItemKind, this.isSnippetText);\n\t}\n\n\tpublic toSingleTextEdit(): SingleTextEdit {\n\t\treturn new SingleTextEdit(this.range, this.insertText);\n\t}\n}\n\nfunction suggestItemInfoEquals(a: SuggestItemInfo | undefined, b: SuggestItemInfo | undefined): boolean {\n\tif (a === b) {\n\t\treturn true;\n\t}\n\tif (!a || !b) {\n\t\treturn false;\n\t}\n\treturn a.equals(b);\n}\n"],
  "mappings": "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",
  "names": []
}
