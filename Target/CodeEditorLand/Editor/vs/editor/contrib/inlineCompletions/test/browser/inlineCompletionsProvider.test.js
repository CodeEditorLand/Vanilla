import o from"assert";import{timeout as n}from"../../../../../base/common/async.js";import{DisposableStore as b}from"../../../../../base/common/lifecycle.js";import{runWithFakedTimers as S}from"../../../../../base/test/common/timeTravelScheduler.js";import{ensureNoDisposablesAreLeakedInTestSuite as C}from"../../../../../base/test/common/utils.js";import{Range as l}from"../../../../common/core/range.js";import"../../../../common/languages.js";import{ILanguageFeaturesService as E}from"../../../../common/services/languageFeatures.js";import{LanguageFeaturesService as T}from"../../../../common/services/languageFeaturesService.js";import"../../../../common/viewModel/viewModelImpl.js";import{InlineCompletionsController as k}from"../../browser/controller/inlineCompletionsController.js";import"../../browser/model/inlineCompletionsModel.js";import{SingleTextEdit as V}from"../../../../common/core/textEdit.js";import{GhostTextContext as q,MockInlineCompletionsProvider as d}from"./utils.js";import{withAsyncTestCodeEditor as m}from"../../../../test/browser/testCodeEditor.js";import{createTextModel as x}from"../../../../test/common/testTextModel.js";import{IAccessibilitySignalService as A}from"../../../../../platform/accessibilitySignal/browser/accessibilitySignalService.js";import{ServiceCollection as h}from"../../../../../platform/instantiation/common/serviceCollection.js";import{Selection as c}from"../../../../common/core/selection.js";import{computeGhostText as v}from"../../browser/model/singleTextEdit.js";suite("Inline Completions",()=>{C(),suite("inlineCompletionToGhostText",()=>{function e(i,a){const r=i.indexOf("["),t=i.indexOf("]")-1,s=i.replace("[","").replace("]",""),f=x(s),g=l.fromPositions(f.getPositionAt(r),f.getPositionAt(t)),y=["prefix","subword"],p={};for(const w of y)p[w]=v(new V(g,a),f,w)?.render(s,!0);return f.dispose(),new Set(Object.values(p)).size===1?Object.values(p)[0]:p}test("Basic",()=>{o.deepStrictEqual(e("[foo]baz","foobar"),"foo[bar]baz"),o.deepStrictEqual(e("[aaa]aaa","aaaaaa"),"aaa[aaa]aaa"),o.deepStrictEqual(e("[foo]baz","boobar"),void 0),o.deepStrictEqual(e("[foo]foo","foofoo"),"foo[foo]foo"),o.deepStrictEqual(e("foo[]",`bar
hello`),`foo[bar
hello]`)}),test("Empty ghost text",()=>{o.deepStrictEqual(e("[foo]","foo"),"foo")}),test("Whitespace (indentation)",()=>{o.deepStrictEqual(e("[ foo]","foobar")," foo[bar]"),o.deepStrictEqual(e("[	foo]","foobar"),"	foo[bar]"),o.deepStrictEqual(e("[	 foo]","	foobar"),"	 foo[bar]"),o.deepStrictEqual(e("[	foo]","		foobar"),{prefix:void 0,subword:"	[	]foo[bar]"}),o.deepStrictEqual(e("[	]","		foobar"),"	[	foobar]"),o.deepStrictEqual(e("	[]","	"),"	[	]"),o.deepStrictEqual(e("	[	]",""),"		"),o.deepStrictEqual(e("[ ]","return 1")," [return 1]")}),test("Whitespace (outside of indentation)",()=>{o.deepStrictEqual(e("bar[ foo]","foobar"),void 0),o.deepStrictEqual(e("bar[	foo]","foobar"),void 0)}),test("Unsupported Case",()=>{o.deepStrictEqual(e(`fo[o
]`,`x
bar`),void 0)}),test("New Line",()=>{o.deepStrictEqual(e(`fo[o
]`,`o
bar`),`foo
[bar]`)}),test("Multi Part Diffing",()=>{o.deepStrictEqual(e("foo[()]","(x);"),{prefix:void 0,subword:"foo([x])[;]"}),o.deepStrictEqual(e("[	foo]","		foobar"),{prefix:void 0,subword:"	[	]foo[bar]"}),o.deepStrictEqual(e("[(y ===)]","(y === 1) { f(); }"),{prefix:void 0,subword:"(y ===[ 1])[ { f(); }]"}),o.deepStrictEqual(e("[(y ==)]","(y === 1) { f(); }"),{prefix:void 0,subword:"(y ==[= 1])[ { f(); }]"}),o.deepStrictEqual(e("[(y ==)]","(y === 1) { f(); }"),{prefix:void 0,subword:"(y ==[= 1])[ { f(); }]"})}),test("Multi Part Diffing 1",()=>{o.deepStrictEqual(e("[if () ()]","if (1 == f()) ()"),{prefix:void 0,subword:"if ([1 == f()]) ()"})}),test("Multi Part Diffing 2",()=>{o.deepStrictEqual(e("[)]","())"),{prefix:void 0,subword:"[(])[)]"}),o.deepStrictEqual(e("[))]","(())"),{prefix:void 0,subword:"[((]))"})}),test("Parenthesis Matching",()=>{o.deepStrictEqual(e("[console.log()]",'console.log({ label: "(" })'),{prefix:void 0,subword:'console.log([{ label: "(" }])'})})}),test("Does not trigger automatically if disabled",async function(){const e=new d;await u("",{fakeClock:!0,provider:e,inlineSuggest:{enabled:!1}},async({editor:i,editorViewModel:a,model:r,context:t})=>{t.keyboardType("foo"),await n(1e3),o.deepStrictEqual(e.getAndClearCallHistory(),[]),o.deepStrictEqual(t.getAndClearViewStates(),[""])})}),test("Ghost text is shown after trigger",async function(){const e=new d;await u("",{fakeClock:!0,provider:e},async({editor:i,editorViewModel:a,model:r,context:t})=>{t.keyboardType("foo"),e.setReturnValue({insertText:"foobar",range:new l(1,1,1,4)}),r.triggerExplicitly(),await n(1e3),o.deepStrictEqual(e.getAndClearCallHistory(),[{position:"(1,4)",text:"foo",triggerKind:1}]),o.deepStrictEqual(t.getAndClearViewStates(),["","foo[bar]"])})}),test("Ghost text is shown automatically when configured",async function(){const e=new d;await u("",{fakeClock:!0,provider:e,inlineSuggest:{enabled:!0}},async({editor:i,editorViewModel:a,model:r,context:t})=>{t.keyboardType("foo"),e.setReturnValue({insertText:"foobar",range:new l(1,1,1,4)}),await n(1e3),o.deepStrictEqual(e.getAndClearCallHistory(),[{position:"(1,4)",text:"foo",triggerKind:0}]),o.deepStrictEqual(t.getAndClearViewStates(),["","foo[bar]"])})}),test("Ghost text is updated automatically",async function(){const e=new d;await u("",{fakeClock:!0,provider:e},async({editor:i,editorViewModel:a,model:r,context:t})=>{e.setReturnValue({insertText:"foobar",range:new l(1,1,1,4)}),t.keyboardType("foo"),r.triggerExplicitly(),await n(1e3),e.setReturnValue({insertText:"foobizz",range:new l(1,1,1,6)}),t.keyboardType("b"),t.keyboardType("i"),await n(1e3),o.deepStrictEqual(e.getAndClearCallHistory(),[{position:"(1,4)",text:"foo",triggerKind:1},{position:"(1,6)",text:"foobi",triggerKind:0}]),o.deepStrictEqual(t.getAndClearViewStates(),["","foo[bar]","foob[ar]","foobi","foobi[zz]"])})}),test("Unindent whitespace",async function(){const e=new d;await u("",{fakeClock:!0,provider:e},async({editor:i,editorViewModel:a,model:r,context:t})=>{t.keyboardType("  "),e.setReturnValue({insertText:"foo",range:new l(1,2,1,3)}),r.triggerExplicitly(),await n(1e3),o.deepStrictEqual(t.getAndClearViewStates(),["","  [foo]"]),r.accept(i),o.deepStrictEqual(e.getAndClearCallHistory(),[{position:"(1,3)",text:"  ",triggerKind:1}]),o.deepStrictEqual(t.getAndClearViewStates(),[" foo"])})}),test("Unindent tab",async function(){const e=new d;await u("",{fakeClock:!0,provider:e},async({editor:i,editorViewModel:a,model:r,context:t})=>{t.keyboardType("		"),e.setReturnValue({insertText:"foo",range:new l(1,2,1,3)}),r.triggerExplicitly(),await n(1e3),o.deepStrictEqual(t.getAndClearViewStates(),["","		[foo]"]),r.accept(i),o.deepStrictEqual(e.getAndClearCallHistory(),[{position:"(1,3)",text:"		",triggerKind:1}]),o.deepStrictEqual(t.getAndClearViewStates(),["	foo"])})}),test("No unindent after indentation",async function(){const e=new d;await u("",{fakeClock:!0,provider:e},async({editor:i,editorViewModel:a,model:r,context:t})=>{t.keyboardType("buzz  "),e.setReturnValue({insertText:"foo",range:new l(1,6,1,7)}),r.triggerExplicitly(),await n(1e3),o.deepStrictEqual(t.getAndClearViewStates(),[""]),r.accept(i),o.deepStrictEqual(e.getAndClearCallHistory(),[{position:"(1,7)",text:"buzz  ",triggerKind:1}]),o.deepStrictEqual(t.getAndClearViewStates(),[])})}),test("Next/previous",async function(){const e=new d;await u("",{fakeClock:!0,provider:e},async({editor:i,editorViewModel:a,model:r,context:t})=>{t.keyboardType("foo"),e.setReturnValue({insertText:"foobar1",range:new l(1,1,1,4)}),r.trigger(),await n(1e3),o.deepStrictEqual(t.getAndClearViewStates(),["","foo[bar1]"]),e.setReturnValues([{insertText:"foobar1",range:new l(1,1,1,4)},{insertText:"foobizz2",range:new l(1,1,1,4)},{insertText:"foobuzz3",range:new l(1,1,1,4)}]),r.next(),await n(1e3),o.deepStrictEqual(t.getAndClearViewStates(),["foo[bizz2]"]),r.next(),await n(1e3),o.deepStrictEqual(t.getAndClearViewStates(),["foo[buzz3]"]),r.next(),await n(1e3),o.deepStrictEqual(t.getAndClearViewStates(),["foo[bar1]"]),r.previous(),await n(1e3),o.deepStrictEqual(t.getAndClearViewStates(),["foo[buzz3]"]),r.previous(),await n(1e3),o.deepStrictEqual(t.getAndClearViewStates(),["foo[bizz2]"]),r.previous(),await n(1e3),o.deepStrictEqual(t.getAndClearViewStates(),["foo[bar1]"]),o.deepStrictEqual(e.getAndClearCallHistory(),[{position:"(1,4)",text:"foo",triggerKind:0},{position:"(1,4)",text:"foo",triggerKind:1}])})}),test("Calling the provider is debounced",async function(){const e=new d;await u("",{fakeClock:!0,provider:e},async({editor:i,editorViewModel:a,model:r,context:t})=>{r.trigger(),t.keyboardType("f"),await n(40),t.keyboardType("o"),await n(40),t.keyboardType("o"),await n(40),o.deepStrictEqual(e.getAndClearCallHistory(),[]),await n(400),o.deepStrictEqual(e.getAndClearCallHistory(),[{position:"(1,4)",text:"foo",triggerKind:0}]),e.assertNotCalledTwiceWithin50ms()})}),test("Backspace is debounced",async function(){const e=new d;await u("",{fakeClock:!0,provider:e,inlineSuggest:{enabled:!0}},async({editor:i,editorViewModel:a,model:r,context:t})=>{t.keyboardType("foo"),e.setReturnValue({insertText:"foobar",range:new l(1,1,1,4)}),await n(1e3);for(let s=0;s<2;s++){for(let f=0;f<3;f++)t.leftDelete(),await n(5);t.keyboardType("bar")}await n(400),e.assertNotCalledTwiceWithin50ms()})}),test("Forward stability",async function(){const e=new d;await u("",{fakeClock:!0,provider:e},async({editor:i,editorViewModel:a,model:r,context:t})=>{e.setReturnValue({insertText:"foobar",range:new l(1,1,1,4)}),t.keyboardType("foo"),r.trigger(),await n(1e3),o.deepStrictEqual(e.getAndClearCallHistory(),[{position:"(1,4)",text:"foo",triggerKind:0}]),o.deepStrictEqual(t.getAndClearViewStates(),["","foo[bar]"]),e.setReturnValue({insertText:"foobar",range:new l(1,1,1,5)}),t.keyboardType("b"),o.deepStrictEqual(t.currentPrettyViewState,"foob[ar]"),await n(1e3),o.deepStrictEqual(e.getAndClearCallHistory(),[{position:"(1,5)",text:"foob",triggerKind:0}]),o.deepStrictEqual(t.getAndClearViewStates(),["foob[ar]"]),e.setReturnValue({insertText:"foobar",range:new l(1,1,1,6)}),t.keyboardType("a"),o.deepStrictEqual(t.currentPrettyViewState,"fooba[r]"),await n(1e3),o.deepStrictEqual(e.getAndClearCallHistory(),[{position:"(1,6)",text:"fooba",triggerKind:0}]),o.deepStrictEqual(t.getAndClearViewStates(),["fooba[r]"])})}),test("Support forward instability",async function(){const e=new d;await u("",{fakeClock:!0,provider:e},async({editor:i,editorViewModel:a,model:r,context:t})=>{e.setReturnValue({insertText:"foobar",range:new l(1,1,1,4)}),t.keyboardType("foo"),r.triggerExplicitly(),await n(100),o.deepStrictEqual(e.getAndClearCallHistory(),[{position:"(1,4)",text:"foo",triggerKind:1}]),o.deepStrictEqual(t.getAndClearViewStates(),["","foo[bar]"]),e.setReturnValue({insertText:"foobaz",range:new l(1,1,1,5)}),t.keyboardType("b"),o.deepStrictEqual(t.currentPrettyViewState,"foob[ar]"),await n(100),o.deepStrictEqual(e.getAndClearCallHistory(),[{position:"(1,5)",text:"foob",triggerKind:0}]),o.deepStrictEqual(t.getAndClearViewStates(),["foob[ar]","foob[az]"])})}),test("Support backward instability",async function(){const e=new d;await u("",{fakeClock:!0,provider:e},async({editor:i,editorViewModel:a,model:r,context:t})=>{t.keyboardType("fooba"),e.setReturnValue({insertText:"foobar",range:new l(1,1,1,6)}),r.triggerExplicitly(),await n(1e3),o.deepStrictEqual(e.getAndClearCallHistory(),[{position:"(1,6)",text:"fooba",triggerKind:1}]),o.deepStrictEqual(t.getAndClearViewStates(),["","fooba[r]"]),e.setReturnValue({insertText:"foobaz",range:new l(1,1,1,5)}),t.leftDelete(),await n(1e3),o.deepStrictEqual(e.getAndClearCallHistory(),[{position:"(1,5)",text:"foob",triggerKind:0}]),o.deepStrictEqual(t.getAndClearViewStates(),["foob[ar]","foob[az]"])})}),test("No race conditions",async function(){const e=new d;await u("",{fakeClock:!0,provider:e},async({editor:i,editorViewModel:a,model:r,context:t})=>{t.keyboardType("h"),e.setReturnValue({insertText:"helloworld",range:new l(1,1,1,2)},1e3),r.triggerExplicitly(),await n(1030),t.keyboardType("ello"),e.setReturnValue({insertText:"helloworld",range:new l(1,1,1,6)},1e3),await n(2e3),o.deepStrictEqual(t.getAndClearViewStates(),["","hello[world]"])})}),test("Do not reuse cache from previous session (#132516)",async function(){const e=new d;await u("",{fakeClock:!0,provider:e,inlineSuggest:{enabled:!0}},async({editor:i,editorViewModel:a,model:r,context:t})=>{t.keyboardType(`hello
`),t.cursorLeft(),t.keyboardType("x"),t.leftDelete(),e.setReturnValue({insertText:"helloworld",range:new l(1,1,1,6)},1e3),await n(2e3),o.deepStrictEqual(e.getAndClearCallHistory(),[{position:"(1,6)",text:`hello
`,triggerKind:0}]),e.setReturnValue({insertText:"helloworld",range:new l(2,1,2,6)},1e3),t.cursorDown(),t.keyboardType("hello"),await n(40),o.deepStrictEqual(e.getAndClearCallHistory(),[]),t.keyboardType("w"),t.leftDelete(),await n(2e3),o.deepStrictEqual(e.getAndClearCallHistory(),[{position:"(2,6)",triggerKind:0,text:`hello
hello`}]),o.deepStrictEqual(t.getAndClearViewStates(),["",`hello[world]
`,`hello
`,`hello
hello[world]`])})}),test("Additional Text Edits",async function(){const e=new d;await u("",{fakeClock:!0,provider:e},async({editor:i,editorViewModel:a,model:r,context:t})=>{t.keyboardType(`buzz
baz`),e.setReturnValue({insertText:"bazz",range:new l(2,1,2,4),additionalTextEdits:[{range:new l(1,1,1,5),text:"bla"}]}),r.triggerExplicitly(),await n(1e3),r.accept(i),o.deepStrictEqual(e.getAndClearCallHistory(),[{position:"(2,4)",triggerKind:1,text:`buzz
baz`}]),o.deepStrictEqual(t.getAndClearViewStates(),["",`buzz
baz[z]`,`bla
bazz`])})}),suite("inlineCompletionMultiCursor",()=>{test("Basic",async function(){const i=new d;await u("",{fakeClock:!0,provider:i},async({editor:a,editorViewModel:r,model:t,context:s})=>{s.keyboardType(`console
console
`),a.setSelections([new c(1,1e3,1,1e3),new c(2,1e3,2,1e3)]),i.setReturnValue({insertText:'console.log("hello");',range:new l(1,1,1,1e3)}),t.triggerExplicitly(),await n(1e3),t.accept(a),o.deepStrictEqual(a.getValue(),['console.log("hello");','console.log("hello");',""].join(`
`))})}),test("Multi Part",async function(){const i=new d;await u("",{fakeClock:!0,provider:i},async({editor:a,editorViewModel:r,model:t,context:s})=>{s.keyboardType(`console.log()
console.log
`),a.setSelections([new c(1,12,1,12),new c(2,1e3,2,1e3)]),i.setReturnValue({insertText:'console.log("hello");',range:new l(1,1,1,1e3)}),t.triggerExplicitly(),await n(1e3),t.accept(a),o.deepStrictEqual(a.getValue(),['console.log("hello");','console.log("hello");',""].join(`
`))})}),test("Multi Part and Different Cursor Columns",async function(){const i=new d;await u("",{fakeClock:!0,provider:i},async({editor:a,editorViewModel:r,model:t,context:s})=>{s.keyboardType(`console.log()
console.warn
`),a.setSelections([new c(1,12,1,12),new c(2,14,2,14)]),i.setReturnValue({insertText:'console.log("hello");',range:new l(1,1,1,1e3)}),t.triggerExplicitly(),await n(1e3),t.accept(a),o.deepStrictEqual(a.getValue(),['console.log("hello");','console.warn("hello");',""].join(`
`))})});async function e(i,a,r=1){for(let t=0;t<r;t++)i.triggerExplicitly(),await n(1e3),await i.acceptNextWord(a)}test("Basic Partial Completion",async function(){const i=new d;await u("",{fakeClock:!0,provider:i},async({editor:a,editorViewModel:r,model:t,context:s})=>{s.keyboardType(`let
let
`),a.setSelections([new c(1,1e3,1,1e3),new c(2,1e3,2,1e3)]),i.setReturnValue({insertText:"let a = 'some word'; ",range:new l(1,1,1,1e3)}),await e(t,a,2),o.deepStrictEqual(a.getValue(),["let a","let a",""].join(`
`))})}),test("Partial Multi-Part Completion",async function(){const i=new d;await u("",{fakeClock:!0,provider:i},async({editor:a,editorViewModel:r,model:t,context:s})=>{s.keyboardType(`for ()
for 
`),a.setSelections([new c(1,5,1,5),new c(2,1e3,2,1e3)]),i.setReturnValue({insertText:"for (let i = 0; i < 10; i++) {",range:new l(1,1,1,1e3)}),t.triggerExplicitly(),await n(1e3),await e(t,a,3),o.deepStrictEqual(a.getValue(),["for (let i)","for (let i",""].join(`
`))})}),test("Partial Mutli-Part and Different Cursor Columns Completion",async function(){const i=new d;await u("",{fakeClock:!0,provider:i},async({editor:a,editorViewModel:r,model:t,context:s})=>{s.keyboardType(`console.log()
console.warnnnn
`),a.setSelections([new c(1,12,1,12),new c(2,16,2,16)]),i.setReturnValue({insertText:'console.log("hello" + " " + "world");',range:new l(1,1,1,1e3)}),t.triggerExplicitly(),await n(1e3),await e(t,a,4),o.deepStrictEqual(a.getValue(),['console.log("hello" + )','console.warnnnn("hello" + ',""].join(`
`))})})})});async function u(e,i,a){return await S({useFakeTimers:i.fakeClock},async()=>{const r=new b;try{if(i.provider){const s=new T;i.serviceCollection||(i.serviceCollection=new h),i.serviceCollection.set(E,s),i.serviceCollection.set(A,{playSignal:async()=>{},isSoundEnabled(g){return!1}});const f=s.inlineCompletionsProvider.register({pattern:"**"},i.provider);r.add(f)}let t;return await m(e,i,async(s,f,g)=>{const y=g.createInstance(k,s),p=y.model.get(),w=new q(p,s);try{t=await a({editor:s,editorViewModel:f,model:p,context:w})}finally{w.dispose(),p.dispose(),y.dispose()}}),i.provider instanceof d&&i.provider.assertNotCalledTwiceWithin50ms(),t}finally{r.dispose()}})}
