var F=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var P=(l,i,e,n)=>{for(var c=n>1?void 0:n?O(i,e):i,t=l.length-1,o;t>=0;t--)(o=l[t])&&(c=(n?o(i,e,c):o(c))||c);return n&&c&&F(i,e,c),c},C=(l,i)=>(e,n)=>i(e,n,l);import*as x from"../../../../base/common/arrays.js";import{CancellationToken as E}from"../../../../base/common/cancellation.js";import{onUnexpectedExternalError as q}from"../../../../base/common/errors.js";import{KeyCode as b,KeyMod as a}from"../../../../base/common/keyCodes.js";import"../../../../base/common/lifecycle.js";import{assertType as D}from"../../../../base/common/types.js";import{URI as z}from"../../../../base/common/uri.js";import*as _ from"../../../../nls.js";import{MenuId as w}from"../../../../platform/actions/common/actions.js";import{CommandsRegistry as I}from"../../../../platform/commands/common/commands.js";import{KeybindingWeight as A}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import"../../../browser/editorBrowser.js";import{EditorAction as B,EditorContributionInstantiation as K,registerEditorAction as N,registerEditorContribution as U}from"../../../browser/editorExtensions.js";import{EditorOption as G}from"../../../common/config/editorOptions.js";import{Position as v}from"../../../common/core/position.js";import{Range as h}from"../../../common/core/range.js";import{Selection as j}from"../../../common/core/selection.js";import"../../../common/editorCommon.js";import{EditorContextKeys as k}from"../../../common/editorContextKeys.js";import"../../../common/languageFeatureRegistry.js";import"../../../common/languages.js";import"../../../common/model.js";import{ILanguageFeaturesService as M}from"../../../common/services/languageFeatures.js";import{ITextModelService as H}from"../../../common/services/resolverService.js";import{BracketSelectionRangeProvider as J}from"./bracketSelections.js";import{WordSelectionRangeProvider as Q}from"./wordSelections.js";class L{constructor(i,e){this.index=i;this.ranges=e}mov(i){const e=this.index+(i?1:-1);if(e<0||e>=this.ranges.length)return this;const n=new L(e,this.ranges);return n.ranges[e].equalsRange(this.ranges[this.index])?n.mov(i):n}}let u=class{constructor(i,e){this._editor=i;this._languageFeaturesService=e}static ID="editor.contrib.smartSelectController";static get(i){return i.getContribution(u.ID)}_state;_selectionListener;_ignoreSelection=!1;dispose(){this._selectionListener?.dispose()}async run(i){if(!this._editor.hasModel())return;const e=this._editor.getSelections(),n=this._editor.getModel();if(this._state||await T(this._languageFeaturesService.selectionRangeProvider,n,e.map(t=>t.getPosition()),this._editor.getOption(G.smartSelect),E.None).then(t=>{if(!(!x.isNonEmptyArray(t)||t.length!==e.length)&&!(!this._editor.hasModel()||!x.equals(this._editor.getSelections(),e,(o,g)=>o.equalsSelection(g)))){for(let o=0;o<t.length;o++)t[o]=t[o].filter(g=>g.containsPosition(e[o].getStartPosition())&&g.containsPosition(e[o].getEndPosition())),t[o].unshift(e[o]);this._state=t.map(o=>new L(0,o)),this._selectionListener?.dispose(),this._selectionListener=this._editor.onDidChangeCursorPosition(()=>{this._ignoreSelection||(this._selectionListener?.dispose(),this._state=void 0)})}}),!this._state)return;this._state=this._state.map(t=>t.mov(i));const c=this._state.map(t=>j.fromPositions(t.ranges[t.index].getStartPosition(),t.ranges[t.index].getEndPosition()));this._ignoreSelection=!0;try{this._editor.setSelections(c)}finally{this._ignoreSelection=!1}}};u=P([C(1,M)],u);class W extends B{_forward;constructor(i,e){super(e),this._forward=i}async run(i,e){const n=u.get(e);n&&await n.run(this._forward)}}class V extends W{constructor(){super(!0,{id:"editor.action.smartSelect.expand",label:_.localize("smartSelect.expand","Expand Selection"),alias:"Expand Selection",precondition:void 0,kbOpts:{kbExpr:k.editorTextFocus,primary:a.Shift|a.Alt|b.RightArrow,mac:{primary:a.CtrlCmd|a.WinCtrl|a.Shift|b.RightArrow,secondary:[a.WinCtrl|a.Shift|b.RightArrow]},weight:A.EditorContrib},menuOpts:{menuId:w.MenubarSelectionMenu,group:"1_basic",title:_.localize({key:"miSmartSelectGrow",comment:["&& denotes a mnemonic"]},"&&Expand Selection"),order:2}})}}I.registerCommandAlias("editor.action.smartSelect.grow","editor.action.smartSelect.expand");class X extends W{constructor(){super(!1,{id:"editor.action.smartSelect.shrink",label:_.localize("smartSelect.shrink","Shrink Selection"),alias:"Shrink Selection",precondition:void 0,kbOpts:{kbExpr:k.editorTextFocus,primary:a.Shift|a.Alt|b.LeftArrow,mac:{primary:a.CtrlCmd|a.WinCtrl|a.Shift|b.LeftArrow,secondary:[a.WinCtrl|a.Shift|b.LeftArrow]},weight:A.EditorContrib},menuOpts:{menuId:w.MenubarSelectionMenu,group:"1_basic",title:_.localize({key:"miSmartSelectShrink",comment:["&& denotes a mnemonic"]},"&&Shrink Selection"),order:3}})}}U(u.ID,u,K.Lazy),N(V),N(X);async function T(l,i,e,n,c){const t=l.all(i).concat(new Q(n.selectSubwords));t.length===1&&t.unshift(new J);const o=[],g=[];for(const y of t)o.push(Promise.resolve(y.provideSelectionRanges(i,e,c)).then(m=>{if(x.isNonEmptyArray(m)&&m.length===e.length)for(let d=0;d<e.length;d++){g[d]||(g[d]=[]);for(const p of m[d])h.isIRange(p.range)&&h.containsPosition(p.range,e[d])&&g[d].push(h.lift(p.range))}},q));return await Promise.all(o),g.map(y=>{if(y.length===0)return[];y.sort((s,r)=>v.isBefore(s.getStartPosition(),r.getStartPosition())?1:v.isBefore(r.getStartPosition(),s.getStartPosition())||v.isBefore(s.getEndPosition(),r.getEndPosition())?-1:v.isBefore(r.getEndPosition(),s.getEndPosition())?1:0);const m=[];let d;for(const s of y)(!d||h.containsRange(s,d)&&!h.equalsRange(s,d))&&(m.push(s),d=s);if(!n.selectLeadingAndTrailingWhitespace)return m;const p=[m[0]];for(let s=1;s<m.length;s++){const r=m[s-1],f=m[s];if(f.startLineNumber!==r.startLineNumber||f.endLineNumber!==r.endLineNumber){const S=new h(r.startLineNumber,i.getLineFirstNonWhitespaceColumn(r.startLineNumber),r.endLineNumber,i.getLineLastNonWhitespaceColumn(r.endLineNumber));S.containsRange(r)&&!S.equalsRange(r)&&f.containsRange(S)&&!f.equalsRange(S)&&p.push(S);const R=new h(r.startLineNumber,1,r.endLineNumber,i.getLineMaxColumn(r.endLineNumber));R.containsRange(r)&&!R.equalsRange(S)&&f.containsRange(R)&&!f.equalsRange(R)&&p.push(R)}p.push(f)}return p})}I.registerCommand("_executeSelectionRangeProvider",async function(l,...i){const[e,n]=i;D(z.isUri(e));const c=l.get(M).selectionRangeProvider,t=await l.get(H).createModelReference(e);try{return T(c,t.object.textEditorModel,n,{selectLeadingAndTrailingWhitespace:!0,selectSubwords:!0},E.None)}finally{t.dispose()}});export{u as SmartSelectController,T as provideSelectionRanges};
