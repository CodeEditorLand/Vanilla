var F=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var L=(l,i,e,o)=>{for(var c=o>1?void 0:o?O(i,e):i,t=l.length-1,n;t>=0;t--)(n=l[t])&&(c=(o?n(i,e,c):n(c))||c);return o&&c&&F(i,e,c),c},P=(l,i)=>(e,o)=>i(e,o,l);import*as x from"../../../../base/common/arrays.js";import{CancellationToken as E}from"../../../../base/common/cancellation.js";import{onUnexpectedExternalError as q}from"../../../../base/common/errors.js";import{KeyCode as y,KeyMod as a}from"../../../../base/common/keyCodes.js";import{assertType as j}from"../../../../base/common/types.js";import{URI as B}from"../../../../base/common/uri.js";import*as _ from"../../../../nls.js";import{MenuId as w}from"../../../../platform/actions/common/actions.js";import{CommandsRegistry as I}from"../../../../platform/commands/common/commands.js";import{KeybindingWeight as A}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{EditorAction as D,EditorContributionInstantiation as z,registerEditorAction as N,registerEditorContribution as K}from"../../../browser/editorExtensions.js";import{EditorOption as U}from"../../../common/config/editorOptions.js";import{Position as v}from"../../../common/core/position.js";import{Range as h}from"../../../common/core/range.js";import{Selection as G}from"../../../common/core/selection.js";import{EditorContextKeys as k}from"../../../common/editorContextKeys.js";import{ILanguageFeaturesService as M}from"../../../common/services/languageFeatures.js";import{ITextModelService as H}from"../../../common/services/resolverService.js";import{BracketSelectionRangeProvider as J}from"./bracketSelections.js";import{WordSelectionRangeProvider as Q}from"./wordSelections.js";class C{constructor(i,e){this.index=i;this.ranges=e}mov(i){const e=this.index+(i?1:-1);if(e<0||e>=this.ranges.length)return this;const o=new C(e,this.ranges);return o.ranges[e].equalsRange(this.ranges[this.index])?o.mov(i):o}}let u=class{constructor(i,e){this._editor=i;this._languageFeaturesService=e}static ID="editor.contrib.smartSelectController";static get(i){return i.getContribution(u.ID)}_state;_selectionListener;_ignoreSelection=!1;dispose(){this._selectionListener?.dispose()}async run(i){if(!this._editor.hasModel())return;const e=this._editor.getSelections(),o=this._editor.getModel();if(this._state||await T(this._languageFeaturesService.selectionRangeProvider,o,e.map(t=>t.getPosition()),this._editor.getOption(U.smartSelect),E.None).then(t=>{if(!(!x.isNonEmptyArray(t)||t.length!==e.length)&&!(!this._editor.hasModel()||!x.equals(this._editor.getSelections(),e,(n,g)=>n.equalsSelection(g)))){for(let n=0;n<t.length;n++)t[n]=t[n].filter(g=>g.containsPosition(e[n].getStartPosition())&&g.containsPosition(e[n].getEndPosition())),t[n].unshift(e[n]);this._state=t.map(n=>new C(0,n)),this._selectionListener?.dispose(),this._selectionListener=this._editor.onDidChangeCursorPosition(()=>{this._ignoreSelection||(this._selectionListener?.dispose(),this._state=void 0)})}}),!this._state)return;this._state=this._state.map(t=>t.mov(i));const c=this._state.map(t=>G.fromPositions(t.ranges[t.index].getStartPosition(),t.ranges[t.index].getEndPosition()));this._ignoreSelection=!0;try{this._editor.setSelections(c)}finally{this._ignoreSelection=!1}}};u=L([P(1,M)],u);class W extends D{_forward;constructor(i,e){super(e),this._forward=i}async run(i,e){const o=u.get(e);o&&await o.run(this._forward)}}class V extends W{constructor(){super(!0,{id:"editor.action.smartSelect.expand",label:_.localize("smartSelect.expand","Expand Selection"),alias:"Expand Selection",precondition:void 0,kbOpts:{kbExpr:k.editorTextFocus,primary:a.Shift|a.Alt|y.RightArrow,mac:{primary:a.CtrlCmd|a.WinCtrl|a.Shift|y.RightArrow,secondary:[a.WinCtrl|a.Shift|y.RightArrow]},weight:A.EditorContrib},menuOpts:{menuId:w.MenubarSelectionMenu,group:"1_basic",title:_.localize({key:"miSmartSelectGrow",comment:["&& denotes a mnemonic"]},"&&Expand Selection"),order:2}})}}I.registerCommandAlias("editor.action.smartSelect.grow","editor.action.smartSelect.expand");class X extends W{constructor(){super(!1,{id:"editor.action.smartSelect.shrink",label:_.localize("smartSelect.shrink","Shrink Selection"),alias:"Shrink Selection",precondition:void 0,kbOpts:{kbExpr:k.editorTextFocus,primary:a.Shift|a.Alt|y.LeftArrow,mac:{primary:a.CtrlCmd|a.WinCtrl|a.Shift|y.LeftArrow,secondary:[a.WinCtrl|a.Shift|y.LeftArrow]},weight:A.EditorContrib},menuOpts:{menuId:w.MenubarSelectionMenu,group:"1_basic",title:_.localize({key:"miSmartSelectShrink",comment:["&& denotes a mnemonic"]},"&&Shrink Selection"),order:3}})}}K(u.ID,u,z.Lazy),N(V),N(X);async function T(l,i,e,o,c){const t=l.all(i).concat(new Q(o.selectSubwords));t.length===1&&t.unshift(new J);const n=[],g=[];for(const b of t)n.push(Promise.resolve(b.provideSelectionRanges(i,e,c)).then(m=>{if(x.isNonEmptyArray(m)&&m.length===e.length)for(let d=0;d<e.length;d++){g[d]||(g[d]=[]);for(const p of m[d])h.isIRange(p.range)&&h.containsPosition(p.range,e[d])&&g[d].push(h.lift(p.range))}},q));return await Promise.all(n),g.map(b=>{if(b.length===0)return[];b.sort((s,r)=>v.isBefore(s.getStartPosition(),r.getStartPosition())?1:v.isBefore(r.getStartPosition(),s.getStartPosition())||v.isBefore(s.getEndPosition(),r.getEndPosition())?-1:v.isBefore(r.getEndPosition(),s.getEndPosition())?1:0);const m=[];let d;for(const s of b)(!d||h.containsRange(s,d)&&!h.equalsRange(s,d))&&(m.push(s),d=s);if(!o.selectLeadingAndTrailingWhitespace)return m;const p=[m[0]];for(let s=1;s<m.length;s++){const r=m[s-1],f=m[s];if(f.startLineNumber!==r.startLineNumber||f.endLineNumber!==r.endLineNumber){const S=new h(r.startLineNumber,i.getLineFirstNonWhitespaceColumn(r.startLineNumber),r.endLineNumber,i.getLineLastNonWhitespaceColumn(r.endLineNumber));S.containsRange(r)&&!S.equalsRange(r)&&f.containsRange(S)&&!f.equalsRange(S)&&p.push(S);const R=new h(r.startLineNumber,1,r.endLineNumber,i.getLineMaxColumn(r.endLineNumber));R.containsRange(r)&&!R.equalsRange(S)&&f.containsRange(R)&&!f.equalsRange(R)&&p.push(R)}p.push(f)}return p})}I.registerCommand("_executeSelectionRangeProvider",async(l,...i)=>{const[e,o]=i;j(B.isUri(e));const c=l.get(M).selectionRangeProvider,t=await l.get(H).createModelReference(e);try{return T(c,t.object.textEditorModel,o,{selectLeadingAndTrailingWhitespace:!0,selectSubwords:!0},E.None)}finally{t.dispose()}});export{u as SmartSelectController,T as provideSelectionRanges};
