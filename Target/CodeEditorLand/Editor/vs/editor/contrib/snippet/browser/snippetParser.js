import{CharCode as a}from"../../../../base/common/charCode.js";var M=(i=>(i[i.Dollar=0]="Dollar",i[i.Colon=1]="Colon",i[i.Comma=2]="Comma",i[i.CurlyOpen=3]="CurlyOpen",i[i.CurlyClose=4]="CurlyClose",i[i.Backslash=5]="Backslash",i[i.Forwardslash=6]="Forwardslash",i[i.Pipe=7]="Pipe",i[i.Int=8]="Int",i[i.VariableName=9]="VariableName",i[i.Format=10]="Format",i[i.Plus=11]="Plus",i[i.Dash=12]="Dash",i[i.QuestionMark=13]="QuestionMark",i[i.EOF=14]="EOF",i))(M||{});class h{static _table={[a.DollarSign]:0,[a.Colon]:1,[a.Comma]:2,[a.OpenCurlyBrace]:3,[a.CloseCurlyBrace]:4,[a.Backslash]:5,[a.Slash]:6,[a.Pipe]:7,[a.Plus]:11,[a.Dash]:12,[a.QuestionMark]:13};static isDigitCharacter(t){return t>=a.Digit0&&t<=a.Digit9}static isVariableCharacter(t){return t===a.Underline||t>=a.a&&t<=a.z||t>=a.A&&t<=a.Z}value="";pos=0;text(t){this.value=t,this.pos=0}tokenText(t){return this.value.substr(t.pos,t.len)}next(){if(this.pos>=this.value.length)return{type:14,pos:this.pos,len:0};const t=this.pos;let e=0,r=this.value.charCodeAt(t),n;if(n=h._table[r],typeof n=="number")return this.pos+=1,{type:n,pos:t,len:1};if(h.isDigitCharacter(r)){n=8;do e+=1,r=this.value.charCodeAt(t+e);while(h.isDigitCharacter(r));return this.pos+=e,{type:n,pos:t,len:e}}if(h.isVariableCharacter(r)){n=9;do r=this.value.charCodeAt(t+ ++e);while(h.isVariableCharacter(r)||h.isDigitCharacter(r));return this.pos+=e,{type:n,pos:t,len:e}}n=10;do e+=1,r=this.value.charCodeAt(t+e);while(!isNaN(r)&&typeof h._table[r]>"u"&&!h.isDigitCharacter(r)&&!h.isVariableCharacter(r));return this.pos+=e,{type:n,pos:t,len:e}}}class T{_markerBrand;parent;_children=[];appendChild(t){return t instanceof o&&this._children[this._children.length-1]instanceof o?this._children[this._children.length-1].value+=t.value:(t.parent=this,this._children.push(t)),this}replace(t,e){const{parent:r}=t,n=r.children.indexOf(t),s=r.children.slice(0);s.splice(n,1,...e),r._children=s,function p(C,l){for(const d of C)d.parent=l,p(d.children,d)}(e,r)}get children(){return this._children}get rightMostDescendant(){return this._children.length>0?this._children[this._children.length-1].rightMostDescendant:this}get snippet(){let t=this;for(;;){if(!t)return;if(t instanceof g)return t;t=t.parent}}toString(){return this.children.reduce((t,e)=>t+e.toString(),"")}len(){return 0}}class o extends T{constructor(e){super();this.value=e}static escape(e){return e.replace(/\$|}|\\/g,"\\$&")}toString(){return this.value}toTextmateString(){return o.escape(this.value)}len(){return this.value.length}clone(){return new o(this.value)}}class w extends T{transform}class u extends w{constructor(e){super();this.index=e}static compareByIndex(e,r){return e.index===r.index?0:e.isFinalTabstop?1:r.isFinalTabstop||e.index<r.index?-1:e.index>r.index?1:0}get isFinalTabstop(){return this.index===0}get choice(){return this._children.length===1&&this._children[0]instanceof _?this._children[0]:void 0}toTextmateString(){let e="";return this.transform&&(e=this.transform.toTextmateString()),this.children.length===0&&!this.transform?`$${this.index}`:this.children.length===0?`\${${this.index}${e}}`:this.choice?`\${${this.index}|${this.choice.toTextmateString()}|${e}}`:`\${${this.index}:${this.children.map(r=>r.toTextmateString()).join("")}${e}}`}clone(){const e=new u(this.index);return this.transform&&(e.transform=this.transform.clone()),e._children=this.children.map(r=>r.clone()),e}}class _ extends T{options=[];appendChild(t){return t instanceof o&&(t.parent=this,this.options.push(t)),this}toString(){return this.options[0].value}toTextmateString(){return this.options.map(t=>t.value.replace(/\||,|\\/g,"\\$&")).join(",")}len(){return this.options[0].len()}clone(){const t=new _;return this.options.forEach(t.appendChild,t),t}}class y extends T{regexp=new RegExp("");resolve(t){const e=this;let r=!1,n=t.replace(this.regexp,function(){return r=!0,e._replace(Array.prototype.slice.call(arguments,0,-2))});return!r&&this._children.some(s=>s instanceof c&&!!s.elseValue)&&(n=this._replace([])),n}_replace(t){let e="";for(const r of this._children)if(r instanceof c){let n=t[r.index]||"";n=r.resolve(n),e+=n}else e+=r.toString();return e}toString(){return""}toTextmateString(){return`/${this.regexp.source}/${this.children.map(t=>t.toTextmateString())}/${(this.regexp.ignoreCase?"i":"")+(this.regexp.global?"g":"")}`}clone(){const t=new y;return t.regexp=new RegExp(this.regexp.source,(this.regexp.ignoreCase?"i":"")+(this.regexp.global?"g":"")),t._children=this.children.map(e=>e.clone()),t}}class c extends T{constructor(e,r,n,s){super();this.index=e;this.shorthandName=r;this.ifValue=n;this.elseValue=s}resolve(e){return this.shorthandName==="upcase"?e?e.toLocaleUpperCase():"":this.shorthandName==="downcase"?e?e.toLocaleLowerCase():"":this.shorthandName==="capitalize"?e?e[0].toLocaleUpperCase()+e.substr(1):"":this.shorthandName==="pascalcase"?e?this._toPascalCase(e):"":this.shorthandName==="camelcase"?e?this._toCamelCase(e):"":e&&typeof this.ifValue=="string"?this.ifValue:!e&&typeof this.elseValue=="string"?this.elseValue:e||""}_toPascalCase(e){const r=e.match(/[a-z0-9]+/gi);return r?r.map(n=>n.charAt(0).toUpperCase()+n.substr(1)).join(""):e}_toCamelCase(e){const r=e.match(/[a-z0-9]+/gi);return r?r.map((n,s)=>s===0?n.charAt(0).toLowerCase()+n.substr(1):n.charAt(0).toUpperCase()+n.substr(1)).join(""):e}toTextmateString(){let e="${";return e+=this.index,this.shorthandName?e+=`:/${this.shorthandName}`:this.ifValue&&this.elseValue?e+=`:?${this.ifValue}:${this.elseValue}`:this.ifValue?e+=`:+${this.ifValue}`:this.elseValue&&(e+=`:-${this.elseValue}`),e+="}",e}clone(){return new c(this.index,this.shorthandName,this.ifValue,this.elseValue)}}class k extends w{constructor(e){super();this.name=e}resolve(e){let r=e.resolve(this);return this.transform&&(r=this.transform.resolve(r||"")),r!==void 0?(this._children=[new o(r)],!0):!1}toTextmateString(){let e="";return this.transform&&(e=this.transform.toTextmateString()),this.children.length===0?`\${${this.name}${e}}`:`\${${this.name}:${this.children.map(r=>r.toTextmateString()).join("")}${e}}`}clone(){const e=new k(this.name);return this.transform&&(e.transform=this.transform.clone()),e._children=this.children.map(r=>r.clone()),e}}function v(m,t){const e=[...m];for(;e.length>0;){const r=e.shift();if(!t(r))break;e.unshift(...r.children)}}class g extends T{_placeholders;get placeholderInfo(){if(!this._placeholders){const t=[];let e;this.walk(function(r){return r instanceof u&&(t.push(r),e=!e||e.index<r.index?r:e),!0}),this._placeholders={all:t,last:e}}return this._placeholders}get placeholders(){const{all:t}=this.placeholderInfo;return t}offset(t){let e=0,r=!1;return this.walk(n=>n===t?(r=!0,!1):(e+=n.len(),!0)),r?e:-1}fullLen(t){let e=0;return v([t],r=>(e+=r.len(),!0)),e}enclosingPlaceholders(t){const e=[];let{parent:r}=t;for(;r;)r instanceof u&&e.push(r),r=r.parent;return e}resolveVariables(t){return this.walk(e=>(e instanceof k&&e.resolve(t)&&(this._placeholders=void 0),!0)),this}appendChild(t){return this._placeholders=void 0,super.appendChild(t)}replace(t,e){return this._placeholders=void 0,super.replace(t,e)}toTextmateString(){return this.children.reduce((t,e)=>t+e.toTextmateString(),"")}clone(){const t=new g;return this._children=this.children.map(e=>e.clone()),t}walk(t){v(this.children,t)}}class V{static escape(t){return t.replace(/\$|}|\\/g,"\\$&")}static asInsertText(t){return new V().parse(t).toString()}static guessNeedsClipboard(t){return/\${?CLIPBOARD/.test(t)}_scanner=new h;_token={type:14,pos:0,len:0};parse(t,e,r){const n=new g;return this.parseFragment(t,n),this.ensureFinalTabstop(n,r??!1,e??!1),n}parseFragment(t,e){const r=e.children.length;for(this._scanner.text(t),this._token=this._scanner.next();this._parse(e););const n=new Map,s=[];e.walk(l=>(l instanceof u&&(l.isFinalTabstop?n.set(0,void 0):!n.has(l.index)&&l.children.length>0?n.set(l.index,l.children):s.push(l)),!0));const p=(l,d)=>{const x=n.get(l.index);if(!x)return;const b=new u(l.index);b.transform=l.transform;for(const $ of x){const f=$.clone();b.appendChild(f),f instanceof u&&n.has(f.index)&&!d.has(f.index)&&(d.add(f.index),p(f,d),d.delete(f.index))}e.replace(l,[b])},C=new Set;for(const l of s)p(l,C);return e.children.slice(r)}ensureFinalTabstop(t,e,r){(e||r&&t.placeholders.length>0)&&(t.placeholders.find(s=>s.index===0)||t.appendChild(new u(0)))}_accept(t,e){if(t===void 0||this._token.type===t){const r=e?this._scanner.tokenText(this._token):!0;return this._token=this._scanner.next(),r}return!1}_backTo(t){return this._scanner.pos=t.pos+t.len,this._token=t,!1}_until(t){const e=this._token;for(;this._token.type!==t;){if(this._token.type===14)return!1;if(this._token.type===5){const n=this._scanner.next();if(n.type!==0&&n.type!==4&&n.type!==5)return!1}this._token=this._scanner.next()}const r=this._scanner.value.substring(e.pos,this._token.pos).replace(/\\(\$|}|\\)/g,"$1");return this._token=this._scanner.next(),r}_parse(t){return this._parseEscaped(t)||this._parseTabstopOrVariableName(t)||this._parseComplexPlaceholder(t)||this._parseComplexVariable(t)||this._parseAnything(t)}_parseEscaped(t){let e;return(e=this._accept(5,!0))?(e=this._accept(0,!0)||this._accept(4,!0)||this._accept(5,!0)||e,t.appendChild(new o(e)),!0):!1}_parseTabstopOrVariableName(t){let e;const r=this._token;return this._accept(0)&&(e=this._accept(9,!0)||this._accept(8,!0))?(t.appendChild(/^\d+$/.test(e)?new u(Number(e)):new k(e)),!0):this._backTo(r)}_parseComplexPlaceholder(t){let e;const r=this._token;if(!(this._accept(0)&&this._accept(3)&&(e=this._accept(8,!0))))return this._backTo(r);const s=new u(Number(e));if(this._accept(1))for(;;){if(this._accept(4))return t.appendChild(s),!0;if(!this._parse(s))return t.appendChild(new o("${"+e+":")),s.children.forEach(t.appendChild,t),!0}else if(s.index>0&&this._accept(7)){const p=new _;for(;;){if(this._parseChoiceElement(p)){if(this._accept(2))continue;if(this._accept(7)&&(s.appendChild(p),this._accept(4)))return t.appendChild(s),!0}return this._backTo(r),!1}}else return this._accept(6)?this._parseTransform(s)?(t.appendChild(s),!0):(this._backTo(r),!1):this._accept(4)?(t.appendChild(s),!0):this._backTo(r)}_parseChoiceElement(t){const e=this._token,r=[];for(;!(this._token.type===2||this._token.type===7);){let n;if((n=this._accept(5,!0))?n=this._accept(2,!0)||this._accept(7,!0)||this._accept(5,!0)||n:n=this._accept(void 0,!0),!n)return this._backTo(e),!1;r.push(n)}return r.length===0?(this._backTo(e),!1):(t.appendChild(new o(r.join(""))),!0)}_parseComplexVariable(t){let e;const r=this._token;if(!(this._accept(0)&&this._accept(3)&&(e=this._accept(9,!0))))return this._backTo(r);const s=new k(e);if(this._accept(1))for(;;){if(this._accept(4))return t.appendChild(s),!0;if(!this._parse(s))return t.appendChild(new o("${"+e+":")),s.children.forEach(t.appendChild,t),!0}else return this._accept(6)?this._parseTransform(s)?(t.appendChild(s),!0):(this._backTo(r),!1):this._accept(4)?(t.appendChild(s),!0):this._backTo(r)}_parseTransform(t){const e=new y;let r="",n="";for(;!this._accept(6);){let s;if(s=this._accept(5,!0)){s=this._accept(6,!0)||s,r+=s;continue}if(this._token.type!==14){r+=this._accept(void 0,!0);continue}return!1}for(;!this._accept(6);){let s;if(s=this._accept(5,!0)){s=this._accept(5,!0)||this._accept(6,!0)||s,e.appendChild(new o(s));continue}if(!(this._parseFormatString(e)||this._parseAnything(e)))return!1}for(;!this._accept(4);){if(this._token.type!==14){n+=this._accept(void 0,!0);continue}return!1}try{e.regexp=new RegExp(r,n)}catch{return!1}return t.transform=e,!0}_parseFormatString(t){const e=this._token;if(!this._accept(0))return!1;let r=!1;this._accept(3)&&(r=!0);const n=this._accept(8,!0);if(n)if(r){if(this._accept(4))return t.appendChild(new c(Number(n))),!0;if(!this._accept(1))return this._backTo(e),!1}else return t.appendChild(new c(Number(n))),!0;else return this._backTo(e),!1;if(this._accept(6)){const s=this._accept(9,!0);return!s||!this._accept(4)?(this._backTo(e),!1):(t.appendChild(new c(Number(n),s)),!0)}else if(this._accept(11)){const s=this._until(4);if(s)return t.appendChild(new c(Number(n),void 0,s,void 0)),!0}else if(this._accept(12)){const s=this._until(4);if(s)return t.appendChild(new c(Number(n),void 0,void 0,s)),!0}else if(this._accept(13)){const s=this._until(1);if(s){const p=this._until(4);if(p)return t.appendChild(new c(Number(n),void 0,s,p)),!0}}else{const s=this._until(4);if(s)return t.appendChild(new c(Number(n),void 0,void 0,s)),!0}return this._backTo(e),!1}_parseAnything(t){return this._token.type!==14?(t.appendChild(new o(this._scanner.tokenText(this._token))),this._accept(void 0),!0):!1}}export{_ as Choice,c as FormatString,T as Marker,u as Placeholder,h as Scanner,V as SnippetParser,o as Text,g as TextmateSnippet,M as TokenType,y as Transform,w as TransformableMarker,k as Variable};
