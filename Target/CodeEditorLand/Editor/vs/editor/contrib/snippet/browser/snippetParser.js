var O=(l=>(l[l.Dollar=0]="Dollar",l[l.Colon=1]="Colon",l[l.Comma=2]="Comma",l[l.CurlyOpen=3]="CurlyOpen",l[l.CurlyClose=4]="CurlyClose",l[l.Backslash=5]="Backslash",l[l.Forwardslash=6]="Forwardslash",l[l.Pipe=7]="Pipe",l[l.Int=8]="Int",l[l.VariableName=9]="VariableName",l[l.Format=10]="Format",l[l.Plus=11]="Plus",l[l.Dash=12]="Dash",l[l.QuestionMark=13]="QuestionMark",l[l.EOF=14]="EOF",l))(O||{}),R=class s{static _table={36:0,58:1,44:2,123:3,125:4,92:5,47:6,124:7,43:11,45:12,63:13};static isDigitCharacter(e){return e>=48&&e<=57}static isVariableCharacter(e){return e===95||e>=97&&e<=122||e>=65&&e<=90}value="";pos=0;text(e){this.value=e,this.pos=0}tokenText(e){return this.value.substr(e.pos,e.len)}next(){if(this.pos>=this.value.length)return{type:14,pos:this.pos,len:0};let e=this.pos,t=0,n=this.value.charCodeAt(e),i;if(i=s._table[n],typeof i=="number")return this.pos+=1,{type:i,pos:e,len:1};if(s.isDigitCharacter(n)){i=8;do t+=1,n=this.value.charCodeAt(e+t);while(s.isDigitCharacter(n));return this.pos+=t,{type:i,pos:e,len:t}}if(s.isVariableCharacter(n)){i=9;do n=this.value.charCodeAt(e+ ++t);while(s.isVariableCharacter(n)||s.isDigitCharacter(n));return this.pos+=t,{type:i,pos:e,len:t}}i=10;do t+=1,n=this.value.charCodeAt(e+t);while(!isNaN(n)&&typeof s._table[n]>"u"&&!s.isDigitCharacter(n)&&!s.isVariableCharacter(n));return this.pos+=t,{type:i,pos:e,len:t}}},x=class{_markerBrand;parent;_children=[];appendChild(e){return e instanceof r&&this._children[this._children.length-1]instanceof r?this._children[this._children.length-1].value+=e.value:(e.parent=this,this._children.push(e)),this}replace(e,t){let{parent:n}=e,i=n.children.indexOf(e),_=n.children.slice(0);_.splice(i,1,...t),n._children=_,function p(U,c){for(let g of U)g.parent=c,p(g.children,g)}(t,n)}get children(){return this._children}get rightMostDescendant(){return this._children.length>0?this._children[this._children.length-1].rightMostDescendant:this}get snippet(){let e=this;for(;;){if(!e)return;if(e instanceof o)return e;e=e.parent}}toString(){return this.children.reduce((e,t)=>e+t.toString(),"")}len(){return 0}},r=class s extends x{constructor(t){super();this.value=t}static escape(t){return t.replace(/\$|}|\\/g,"\\$&")}toString(){return this.value}toTextmateString(){return s.escape(this.value)}len(){return this.value.length}clone(){return new s(this.value)}},b=class extends x{transform},T=class s extends b{constructor(t){super();this.index=t}static compareByIndex(t,n){return t.index===n.index?0:t.isFinalTabstop?1:n.isFinalTabstop||t.index<n.index?-1:t.index>n.index?1:0}get isFinalTabstop(){return this.index===0}get choice(){return this._children.length===1&&this._children[0]instanceof f?this._children[0]:void 0}toTextmateString(){let t="";return this.transform&&(t=this.transform.toTextmateString()),this.children.length===0&&!this.transform?`$${this.index}`:this.children.length===0?`\${${this.index}${t}}`:this.choice?`\${${this.index}|${this.choice.toTextmateString()}|${t}}`:`\${${this.index}:${this.children.map(n=>n.toTextmateString()).join("")}${t}}`}clone(){let t=new s(this.index);return this.transform&&(t.transform=this.transform.clone()),t._children=this.children.map(n=>n.clone()),t}},f=class s extends x{options=[];appendChild(e){return e instanceof r&&(e.parent=this,this.options.push(e)),this}toString(){return this.options[0].value}toTextmateString(){return this.options.map(e=>e.value.replace(/\||,|\\/g,"\\$&")).join(",")}len(){return this.options[0].len()}clone(){let e=new s;return this.options.forEach(e.appendChild,e),e}},A=class s extends x{regexp=new RegExp("");resolve(e){let t=this,n=!1,i=e.replace(this.regexp,function(){return n=!0,t._replace(Array.prototype.slice.call(arguments,0,-2))});return!n&&this._children.some(_=>_ instanceof u&&!!_.elseValue)&&(i=this._replace([])),i}_replace(e){let t="";for(let n of this._children)if(n instanceof u){let i=e[n.index]||"";i=n.resolve(i),t+=i}else t+=n.toString();return t}toString(){return""}toTextmateString(){return`/${this.regexp.source}/${this.children.map(e=>e.toTextmateString())}/${(this.regexp.ignoreCase?"i":"")+(this.regexp.global?"g":"")}`}clone(){let e=new s;return e.regexp=new RegExp(this.regexp.source,(this.regexp.ignoreCase?"i":"")+(this.regexp.global?"g":"")),e._children=this.children.map(t=>t.clone()),e}},u=class s extends x{constructor(t,n,i,_){super();this.index=t;this.shorthandName=n;this.ifValue=i;this.elseValue=_}resolve(t){return this.shorthandName==="upcase"?t?t.toLocaleUpperCase():"":this.shorthandName==="downcase"?t?t.toLocaleLowerCase():"":this.shorthandName==="capitalize"?t?t[0].toLocaleUpperCase()+t.substr(1):"":this.shorthandName==="pascalcase"?t?this._toPascalCase(t):"":this.shorthandName==="camelcase"?t?this._toCamelCase(t):"":t&&typeof this.ifValue=="string"?this.ifValue:!t&&typeof this.elseValue=="string"?this.elseValue:t||""}_toPascalCase(t){let n=t.match(/[a-z0-9]+/gi);return n?n.map(i=>i.charAt(0).toUpperCase()+i.substr(1)).join(""):t}_toCamelCase(t){let n=t.match(/[a-z0-9]+/gi);return n?n.map((i,_)=>_===0?i.charAt(0).toLowerCase()+i.substr(1):i.charAt(0).toUpperCase()+i.substr(1)).join(""):t}toTextmateString(){let t="${";return t+=this.index,this.shorthandName?t+=`:/${this.shorthandName}`:this.ifValue&&this.elseValue?t+=`:?${this.ifValue}:${this.elseValue}`:this.ifValue?t+=`:+${this.ifValue}`:this.elseValue&&(t+=`:-${this.elseValue}`),t+="}",t}clone(){return new s(this.index,this.shorthandName,this.ifValue,this.elseValue)}},m=class s extends b{constructor(t){super();this.name=t}resolve(t){let n=t.resolve(this);return this.transform&&(n=this.transform.resolve(n||"")),n!==void 0?(this._children=[new r(n)],!0):!1}toTextmateString(){let t="";return this.transform&&(t=this.transform.toTextmateString()),this.children.length===0?`\${${this.name}${t}}`:`\${${this.name}:${this.children.map(n=>n.toTextmateString()).join("")}${t}}`}clone(){let t=new s(this.name);return this.transform&&(t.transform=this.transform.clone()),t._children=this.children.map(n=>n.clone()),t}};function k(s,e){let t=[...s];for(;t.length>0;){let n=t.shift();if(!e(n))break;t.unshift(...n.children)}}var o=class s extends x{_placeholders;get placeholderInfo(){if(!this._placeholders){let e=[],t;this.walk(function(n){return n instanceof T&&(e.push(n),t=!t||t.index<n.index?n:t),!0}),this._placeholders={all:e,last:t}}return this._placeholders}get placeholders(){let{all:e}=this.placeholderInfo;return e}offset(e){let t=0,n=!1;return this.walk(i=>i===e?(n=!0,!1):(t+=i.len(),!0)),n?t:-1}fullLen(e){let t=0;return k([e],n=>(t+=n.len(),!0)),t}enclosingPlaceholders(e){let t=[],{parent:n}=e;for(;n;)n instanceof T&&t.push(n),n=n.parent;return t}resolveVariables(e){return this.walk(t=>(t instanceof m&&t.resolve(e)&&(this._placeholders=void 0),!0)),this}appendChild(e){return this._placeholders=void 0,super.appendChild(e)}replace(e,t){return this._placeholders=void 0,super.replace(e,t)}toTextmateString(){return this.children.reduce((e,t)=>e+t.toTextmateString(),"")}clone(){let e=new s;return this._children=this.children.map(t=>t.clone()),e}walk(e){k(this.children,e)}},I=class s{static escape(e){return e.replace(/\$|}|\\/g,"\\$&")}static asInsertText(e){return new s().parse(e).toString()}static guessNeedsClipboard(e){return/\${?CLIPBOARD/.test(e)}_scanner=new R;_token={type:14,pos:0,len:0};parse(e,t,n){let i=new o;return this.parseFragment(e,i),this.ensureFinalTabstop(i,n??!1,t??!1),i}parseFragment(e,t){let n=t.children.length;for(this._scanner.text(e),this._token=this._scanner.next();this._parse(t););let i=new Map,_=[];t.walk(c=>(c instanceof T&&(c.isFinalTabstop?i.set(0,void 0):!i.has(c.index)&&c.children.length>0?i.set(c.index,c.children):_.push(c)),!0));let p=(c,g)=>{let D=i.get(c.index);if(!D)return;let a=new T(c.index);a.transform=c.transform;for(let L of D){let E=L.clone();a.appendChild(E),E instanceof T&&i.has(E.index)&&!g.has(E.index)&&(g.add(E.index),p(E,g),g.delete(E.index))}t.replace(c,[a])},U=new Set;for(let c of _)p(c,U);return t.children.slice(n)}ensureFinalTabstop(e,t,n){(t||n&&e.placeholders.length>0)&&(e.placeholders.find(_=>_.index===0)||e.appendChild(new T(0)))}_accept(e,t){if(e===void 0||this._token.type===e){let n=t?this._scanner.tokenText(this._token):!0;return this._token=this._scanner.next(),n}return!1}_backTo(e){return this._scanner.pos=e.pos+e.len,this._token=e,!1}_until(e){let t=this._token;for(;this._token.type!==e;){if(this._token.type===14)return!1;if(this._token.type===5){let i=this._scanner.next();if(i.type!==0&&i.type!==4&&i.type!==5)return!1}this._token=this._scanner.next()}let n=this._scanner.value.substring(t.pos,this._token.pos).replace(/\\(\$|}|\\)/g,"$1");return this._token=this._scanner.next(),n}_parse(e){return this._parseEscaped(e)||this._parseTabstopOrVariableName(e)||this._parseComplexPlaceholder(e)||this._parseComplexVariable(e)||this._parseAnything(e)}_parseEscaped(e){let t;return(t=this._accept(5,!0))?(t=this._accept(0,!0)||this._accept(4,!0)||this._accept(5,!0)||t,e.appendChild(new r(t)),!0):!1}_parseTabstopOrVariableName(e){let t,n=this._token;return this._accept(0)&&(t=this._accept(9,!0)||this._accept(8,!0))?(e.appendChild(/^\d+$/.test(t)?new T(Number(t)):new m(t)),!0):this._backTo(n)}_parseComplexPlaceholder(e){let t,n=this._token;if(!(this._accept(0)&&this._accept(3)&&(t=this._accept(8,!0))))return this._backTo(n);let _=new T(Number(t));if(this._accept(1))for(;;){if(this._accept(4))return e.appendChild(_),!0;if(!this._parse(_))return e.appendChild(new r("${"+t+":")),_.children.forEach(e.appendChild,e),!0}else if(_.index>0&&this._accept(7)){let p=new f;for(;;){if(this._parseChoiceElement(p)){if(this._accept(2))continue;if(this._accept(7)&&(_.appendChild(p),this._accept(4)))return e.appendChild(_),!0}return this._backTo(n),!1}}else return this._accept(6)?this._parseTransform(_)?(e.appendChild(_),!0):(this._backTo(n),!1):this._accept(4)?(e.appendChild(_),!0):this._backTo(n)}_parseChoiceElement(e){let t=this._token,n=[];for(;!(this._token.type===2||this._token.type===7);){let i;if((i=this._accept(5,!0))?i=this._accept(2,!0)||this._accept(7,!0)||this._accept(5,!0)||i:i=this._accept(void 0,!0),!i)return this._backTo(t),!1;n.push(i)}return n.length===0?(this._backTo(t),!1):(e.appendChild(new r(n.join(""))),!0)}_parseComplexVariable(e){let t,n=this._token;if(!(this._accept(0)&&this._accept(3)&&(t=this._accept(9,!0))))return this._backTo(n);let _=new m(t);if(this._accept(1))for(;;){if(this._accept(4))return e.appendChild(_),!0;if(!this._parse(_))return e.appendChild(new r("${"+t+":")),_.children.forEach(e.appendChild,e),!0}else return this._accept(6)?this._parseTransform(_)?(e.appendChild(_),!0):(this._backTo(n),!1):this._accept(4)?(e.appendChild(_),!0):this._backTo(n)}_parseTransform(e){let t=new A,n="",i="";for(;!this._accept(6);){let _;if(_=this._accept(5,!0)){_=this._accept(6,!0)||_,n+=_;continue}if(this._token.type!==14){n+=this._accept(void 0,!0);continue}return!1}for(;!this._accept(6);){let _;if(_=this._accept(5,!0)){_=this._accept(5,!0)||this._accept(6,!0)||_,t.appendChild(new r(_));continue}if(!(this._parseFormatString(t)||this._parseAnything(t)))return!1}for(;!this._accept(4);){if(this._token.type!==14){i+=this._accept(void 0,!0);continue}return!1}try{t.regexp=new RegExp(n,i)}catch{return!1}return e.transform=t,!0}_parseFormatString(e){let t=this._token;if(!this._accept(0))return!1;let n=!1;this._accept(3)&&(n=!0);let i=this._accept(8,!0);if(i)if(n){if(this._accept(4))return e.appendChild(new u(Number(i))),!0;if(!this._accept(1))return this._backTo(t),!1}else return e.appendChild(new u(Number(i))),!0;else return this._backTo(t),!1;if(this._accept(6)){let _=this._accept(9,!0);return!_||!this._accept(4)?(this._backTo(t),!1):(e.appendChild(new u(Number(i),_)),!0)}else if(this._accept(11)){let _=this._until(4);if(_)return e.appendChild(new u(Number(i),void 0,_,void 0)),!0}else if(this._accept(12)){let _=this._until(4);if(_)return e.appendChild(new u(Number(i),void 0,void 0,_)),!0}else if(this._accept(13)){let _=this._until(1);if(_){let p=this._until(4);if(p)return e.appendChild(new u(Number(i),void 0,_,p)),!0}}else{let _=this._until(4);if(_)return e.appendChild(new u(Number(i),void 0,void 0,_)),!0}return this._backTo(t),!1}_parseAnything(e){return this._token.type!==14?(e.appendChild(new r(this._scanner.tokenText(this._token))),this._accept(void 0),!0):!1}};export{f as Choice,u as FormatString,x as Marker,T as Placeholder,R as Scanner,I as SnippetParser,r as Text,o as TextmateSnippet,O as TokenType,A as Transform,b as TransformableMarker,m as Variable};
