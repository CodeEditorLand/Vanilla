var te=Object.defineProperty;var ie=Object.getOwnPropertyDescriptor;var y=(x,e,t,o)=>{for(var i=o>1?void 0:o?ie(e,t):e,n=x.length-1,a;n>=0;n--)(a=x[n])&&(i=(o?a(e,t,i):a(i))||i);return o&&i&&te(e,t,i),i},F=(x,e)=>(t,o)=>e(t,o,x);import{groupBy as O}from"../../../../base/common/arrays.js";import{CharCode as N}from"../../../../base/common/charCode.js";import{dispose as ne}from"../../../../base/common/lifecycle.js";import{getLeadingWhitespace as oe}from"../../../../base/common/strings.js";import"./snippetSession.css";import"../../../browser/editorBrowser.js";import{EditorOption as V}from"../../../common/config/editorOptions.js";import{EditOperation as M}from"../../../common/core/editOperation.js";import"../../../common/core/position.js";import{Range as v}from"../../../common/core/range.js";import{Selection as w}from"../../../common/core/selection.js";import"../../../common/core/textChange.js";import{ILanguageConfigurationService as se}from"../../../common/languages/languageConfigurationRegistry.js";import{TrackedRangeStickiness as L}from"../../../common/model.js";import{ModelDecorationOptions as E}from"../../../common/model/textModel.js";import"../../suggest/browser/suggestOvertypingCapturer.js";import{ILabelService as j}from"../../../../platform/label/common/label.js";import{IWorkspaceContextService as k}from"../../../../platform/workspace/common/workspace.js";import{Choice as B,Placeholder as A,SnippetParser as z,Text as G,TextmateSnippet as re}from"./snippetParser.js";import{ClipboardBasedVariableResolver as U,CommentBasedVariableResolver as $,CompositeSnippetVariableResolver as q,ModelBasedVariableResolver as H,RandomBasedVariableResolver as J,SelectionBasedVariableResolver as K,TimeBasedVariableResolver as Q,WorkspaceBasedVariableResolver as X}from"./snippetVariables.js";class m{constructor(e,t,o){this._editor=e;this._snippet=t;this._snippetLineLeadingWhitespace=o;this._placeholderGroups=O(t.placeholders,A.compareByIndex),this._placeholderGroupsIdx=-1}_placeholderDecorations;_placeholderGroups;_offset=-1;_placeholderGroupsIdx;_nestingLevel=1;static _decor={active:E.register({description:"snippet-placeholder-1",stickiness:L.AlwaysGrowsWhenTypingAtEdges,className:"snippet-placeholder"}),inactive:E.register({description:"snippet-placeholder-2",stickiness:L.NeverGrowsWhenTypingAtEdges,className:"snippet-placeholder"}),activeFinal:E.register({description:"snippet-placeholder-3",stickiness:L.NeverGrowsWhenTypingAtEdges,className:"finish-snippet-placeholder"}),inactiveFinal:E.register({description:"snippet-placeholder-4",stickiness:L.NeverGrowsWhenTypingAtEdges,className:"finish-snippet-placeholder"})};initialize(e){this._offset=e.newPosition}dispose(){this._placeholderDecorations&&this._editor.removeDecorations([...this._placeholderDecorations.values()]),this._placeholderGroups.length=0}_initDecorations(){if(this._offset===-1)throw new Error("Snippet not initialized!");if(this._placeholderDecorations)return;this._placeholderDecorations=new Map;const e=this._editor.getModel();this._editor.changeDecorations(t=>{for(const o of this._snippet.placeholders){const i=this._snippet.offset(o),n=this._snippet.fullLen(o),a=v.fromPositions(e.getPositionAt(this._offset+i),e.getPositionAt(this._offset+i+n)),l=o.isFinalTabstop?m._decor.inactiveFinal:m._decor.inactive,s=t.addDecoration(a,l);this._placeholderDecorations.set(o,s)}})}move(e){if(!this._editor.hasModel())return[];if(this._initDecorations(),this._placeholderGroupsIdx>=0){const i=[];for(const n of this._placeholderGroups[this._placeholderGroupsIdx])if(n.transform){const a=this._placeholderDecorations.get(n),l=this._editor.getModel().getDecorationRange(a),s=this._editor.getModel().getValueInRange(l),r=n.transform.resolve(s).split(/\r\n|\r|\n/);for(let c=1;c<r.length;c++)r[c]=this._editor.getModel().normalizeIndentation(this._snippetLineLeadingWhitespace+r[c]);i.push(M.replace(l,r.join(this._editor.getModel().getEOL())))}i.length>0&&this._editor.executeEdits("snippet.placeholderTransform",i)}let t=!1;e===!0&&this._placeholderGroupsIdx<this._placeholderGroups.length-1?(this._placeholderGroupsIdx+=1,t=!0):e===!1&&this._placeholderGroupsIdx>0&&(this._placeholderGroupsIdx-=1,t=!0);const o=this._editor.getModel().changeDecorations(i=>{const n=new Set,a=[];for(const l of this._placeholderGroups[this._placeholderGroupsIdx]){const s=this._placeholderDecorations.get(l),r=this._editor.getModel().getDecorationRange(s);a.push(new w(r.startLineNumber,r.startColumn,r.endLineNumber,r.endColumn)),t=t&&this._hasPlaceholderBeenCollapsed(l),i.changeDecorationOptions(s,l.isFinalTabstop?m._decor.activeFinal:m._decor.active),n.add(l);for(const c of this._snippet.enclosingPlaceholders(l)){const h=this._placeholderDecorations.get(c);i.changeDecorationOptions(h,c.isFinalTabstop?m._decor.activeFinal:m._decor.active),n.add(c)}}for(const[l,s]of this._placeholderDecorations)n.has(l)||i.changeDecorationOptions(s,l.isFinalTabstop?m._decor.inactiveFinal:m._decor.inactive);return a});return t?this.move(e):o??[]}_hasPlaceholderBeenCollapsed(e){let t=e;for(;t;){if(t instanceof A){const o=this._placeholderDecorations.get(t);if(this._editor.getModel().getDecorationRange(o).isEmpty()&&t.toString().length>0)return!0}t=t.parent}return!1}get isAtFirstPlaceholder(){return this._placeholderGroupsIdx<=0||this._placeholderGroups.length===0}get isAtLastPlaceholder(){return this._placeholderGroupsIdx===this._placeholderGroups.length-1}get hasPlaceholder(){return this._snippet.placeholders.length>0}get isTrivialSnippet(){if(this._snippet.placeholders.length===0)return!0;if(this._snippet.placeholders.length===1){const[e]=this._snippet.placeholders;if(e.isFinalTabstop&&this._snippet.rightMostDescendant===e)return!0}return!1}computePossibleSelections(){const e=new Map;for(const t of this._placeholderGroups){let o;for(const i of t){if(i.isFinalTabstop)break;o||(o=[],e.set(i.index,o));const n=this._placeholderDecorations.get(i),a=this._editor.getModel().getDecorationRange(n);if(!a){e.delete(i.index);break}o.push(a)}}return e}get activeChoice(){if(!this._placeholderDecorations)return;const e=this._placeholderGroups[this._placeholderGroupsIdx][0];if(!e?.choice)return;const t=this._placeholderDecorations.get(e);if(!t)return;const o=this._editor.getModel().getDecorationRange(t);if(o)return{range:o,choice:e.choice}}get hasChoice(){let e=!1;return this._snippet.walk(t=>(e=t instanceof B,!e)),e}merge(e){const t=this._editor.getModel();this._nestingLevel*=10,this._editor.changeDecorations(o=>{for(const i of this._placeholderGroups[this._placeholderGroupsIdx]){const n=e.shift();console.assert(n._offset!==-1),console.assert(!n._placeholderDecorations);const a=n._snippet.placeholderInfo.last.index;for(const s of n._snippet.placeholderInfo.all)s.isFinalTabstop?s.index=i.index+(a+1)/this._nestingLevel:s.index=i.index+s.index/this._nestingLevel;this._snippet.replace(i,n._snippet.children);const l=this._placeholderDecorations.get(i);o.removeDecoration(l),this._placeholderDecorations.delete(i);for(const s of n._snippet.placeholders){const r=n._snippet.offset(s),c=n._snippet.fullLen(s),h=v.fromPositions(t.getPositionAt(n._offset+r),t.getPositionAt(n._offset+r+c)),p=o.addDecoration(h,m._decor.inactive);this._placeholderDecorations.set(s,p)}}this._placeholderGroups=O(this._snippet.placeholders,A.compareByIndex)})}getEnclosingRange(){let e;const t=this._editor.getModel();for(const o of this._placeholderDecorations.values()){const i=t.getDecorationRange(o)??void 0;e?e=e.plusRange(i):e=i}return e}}const Y={overwriteBefore:0,overwriteAfter:0,adjustWhitespace:!0,clipboardText:void 0,overtypingCapturer:void 0};let f=class{constructor(e,t,o=Y,i){this._editor=e;this._template=t;this._options=o;this._languageConfigurationService=i}static adjustWhitespace(e,t,o,i,n){const a=e.getLineContent(t.lineNumber),l=oe(a,0,t.column-1);let s;return i.walk(r=>{if(!(r instanceof G)||r.parent instanceof B||n&&!n.has(r))return!0;const c=r.value.split(/\r\n|\r|\n/);if(o){const p=i.offset(r);if(p===0)c[0]=e.normalizeIndentation(c[0]);else{s=s??i.toString();const _=s.charCodeAt(p-1);(_===N.LineFeed||_===N.CarriageReturn)&&(c[0]=e.normalizeIndentation(l+c[0]))}for(let _=1;_<c.length;_++)c[_]=e.normalizeIndentation(l+c[_])}const h=c.join(e.getEOL());return h!==r.value&&(r.parent.replace(r,[new G(h)]),s=void 0),!0}),l}static adjustSelection(e,t,o,i){if(o!==0||i!==0){const{positionLineNumber:n,positionColumn:a}=t,l=a-o,s=a+i,r=e.validateRange({startLineNumber:n,startColumn:l,endLineNumber:n,endColumn:s});t=w.createWithDirection(r.startLineNumber,r.startColumn,r.endLineNumber,r.endColumn,t.getDirection())}return t}static createEditsAndSnippetsFromSelections(e,t,o,i,n,a,l,s,r){const c=[],h=[];if(!e.hasModel())return{edits:c,snippets:h};const p=e.getModel(),_=e.invokeWithinContext(d=>d.get(k)),g=e.invokeWithinContext(d=>new H(d.get(j),p)),I=()=>l,D=p.getValueInRange(f.adjustSelection(p,e.getSelection(),o,0)),T=p.getValueInRange(f.adjustSelection(p,e.getSelection(),0,i)),C=p.getLineFirstNonWhitespaceColumn(e.getSelection().positionLineNumber),P=e.getSelections().map((d,u)=>({selection:d,idx:u})).sort((d,u)=>v.compareRangesUsingStarts(d.selection,u.selection));for(const{selection:d,idx:u}of P){let b=f.adjustSelection(p,d,o,0),S=f.adjustSelection(p,d,0,i);D!==p.getValueInRange(b)&&(b=d),T!==p.getValueInRange(S)&&(S=d);const W=d.setStartPosition(b.startLineNumber,b.startColumn).setEndPosition(S.endLineNumber,S.endColumn),R=new z().parse(t,!0,n),Z=W.getStartPosition(),ee=f.adjustWhitespace(p,Z,a||u>0&&C!==p.getLineFirstNonWhitespaceColumn(d.positionLineNumber),R);R.resolveVariables(new q([g,new U(I,u,P.length,e.getOption(V.multiCursorPaste)==="spread"),new K(p,d,u,s),new $(p,d,r),new Q,new X(_),new J])),c[u]=M.replace(W,R.toString()),c[u].identifier={major:u,minor:0},c[u]._isTracked=!0,h[u]=new m(e,R,ee)}return{edits:c,snippets:h}}static createEditsAndSnippetsFromEdits(e,t,o,i,n,a,l){if(!e.hasModel()||t.length===0)return{edits:[],snippets:[]};const s=[],r=e.getModel(),c=new z,h=new re,p=new q([e.invokeWithinContext(g=>new H(g.get(j),r)),new U(()=>n,0,e.getSelections().length,e.getOption(V.multiCursorPaste)==="spread"),new K(r,e.getSelection(),0,a),new $(r,e.getSelection(),l),new Q,new X(e.invokeWithinContext(g=>g.get(k))),new J]);t=t.sort((g,I)=>v.compareRangesUsingStarts(g.range,I.range));let _=0;for(let g=0;g<t.length;g++){const{range:I,template:D}=t[g];if(g>0){const u=t[g-1].range,b=v.fromPositions(u.getEndPosition(),I.getStartPosition()),S=new G(r.getValueInRange(b));h.appendChild(S),_+=S.value.length}const T=c.parseFragment(D,h);f.adjustWhitespace(r,I.getStartPosition(),!0,h,new Set(T)),h.resolveVariables(p);const C=h.toString(),P=C.slice(_);_=C.length;const d=M.replace(I,P);d.identifier={major:g,minor:0},d._isTracked=!0,s.push(d)}return c.ensureFinalTabstop(h,o,!0),{edits:s,snippets:[new m(e,h,"")]}}_templateMerges=[];_snippets=[];dispose(){ne(this._snippets)}_logInfo(){return`template="${this._template}", merged_templates="${this._templateMerges.join(" -> ")}"`}insert(){if(!this._editor.hasModel())return;const{edits:e,snippets:t}=typeof this._template=="string"?f.createEditsAndSnippetsFromSelections(this._editor,this._template,this._options.overwriteBefore,this._options.overwriteAfter,!1,this._options.adjustWhitespace,this._options.clipboardText,this._options.overtypingCapturer,this._languageConfigurationService):f.createEditsAndSnippetsFromEdits(this._editor,this._template,!1,this._options.adjustWhitespace,this._options.clipboardText,this._options.overtypingCapturer,this._languageConfigurationService);this._snippets=t,this._editor.executeEdits("snippet",e,o=>{const i=o.filter(n=>!!n.identifier);for(let n=0;n<t.length;n++)t[n].initialize(i[n].textChange);return this._snippets[0].hasPlaceholder?this._move(!0):i.map(n=>w.fromPositions(n.range.getEndPosition()))}),this._editor.revealRange(this._editor.getSelections()[0])}merge(e,t=Y){if(!this._editor.hasModel())return;this._templateMerges.push([this._snippets[0]._nestingLevel,this._snippets[0]._placeholderGroupsIdx,e]);const{edits:o,snippets:i}=f.createEditsAndSnippetsFromSelections(this._editor,e,t.overwriteBefore,t.overwriteAfter,!0,t.adjustWhitespace,t.clipboardText,t.overtypingCapturer,this._languageConfigurationService);this._editor.executeEdits("snippet",o,n=>{const a=n.filter(s=>!!s.identifier);for(let s=0;s<i.length;s++)i[s].initialize(a[s].textChange);const l=i[0].isTrivialSnippet;if(!l){for(const s of this._snippets)s.merge(i);console.assert(i.length===0)}return this._snippets[0].hasPlaceholder&&!l?this._move(void 0):a.map(s=>w.fromPositions(s.range.getEndPosition()))})}next(){const e=this._move(!0);this._editor.setSelections(e),this._editor.revealPositionInCenterIfOutsideViewport(e[0].getPosition())}prev(){const e=this._move(!1);this._editor.setSelections(e),this._editor.revealPositionInCenterIfOutsideViewport(e[0].getPosition())}_move(e){const t=[];for(const o of this._snippets){const i=o.move(e);t.push(...i)}return t}get isAtFirstPlaceholder(){return this._snippets[0].isAtFirstPlaceholder}get isAtLastPlaceholder(){return this._snippets[0].isAtLastPlaceholder}get hasPlaceholder(){return this._snippets[0].hasPlaceholder}get hasChoice(){return this._snippets[0].hasChoice}get activeChoice(){return this._snippets[0].activeChoice}isSelectionWithinPlaceholders(){if(!this.hasPlaceholder)return!1;const e=this._editor.getSelections();if(e.length<this._snippets.length)return!1;const t=new Map;for(const o of this._snippets){const i=o.computePossibleSelections();if(t.size===0)for(const[n,a]of i){a.sort(v.compareRangesUsingStarts);for(const l of e)if(a[0].containsRange(l)){t.set(n,[]);break}}if(t.size===0)return!1;t.forEach((n,a)=>{n.push(...i.get(a))})}e.sort(v.compareRangesUsingStarts);for(const[o,i]of t){if(i.length!==e.length){t.delete(o);continue}i.sort(v.compareRangesUsingStarts);for(let n=0;n<i.length;n++)if(!i[n].containsRange(e[n])){t.delete(o);continue}}return t.size>0}getEnclosingRange(){let e;for(const t of this._snippets){const o=t.getEnclosingRange();e?e=e.plusRange(o):e=o}return e}};f=y([F(3,se)],f);export{m as OneSnippet,f as SnippetSession};
