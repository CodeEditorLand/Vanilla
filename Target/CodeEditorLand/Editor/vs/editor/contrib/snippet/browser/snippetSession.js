var te=Object.defineProperty;var ie=Object.getOwnPropertyDescriptor;var W=(x,e,t,n)=>{for(var i=n>1?void 0:n?ie(e,t):e,o=x.length-1,a;o>=0;o--)(a=x[o])&&(i=(n?a(e,t,i):a(i))||i);return n&&i&&te(e,t,i),i},O=(x,e)=>(t,n)=>e(t,n,x);import{groupBy as F}from"../../../../base/common/arrays.js";import{CharCode as N}from"../../../../base/common/charCode.js";import{dispose as ne}from"../../../../base/common/lifecycle.js";import{getLeadingWhitespace as oe}from"../../../../base/common/strings.js";import"./snippetSession.css";import{ILabelService as j}from"../../../../platform/label/common/label.js";import{IWorkspaceContextService as V}from"../../../../platform/workspace/common/workspace.js";import{EditorOption as B}from"../../../common/config/editorOptions.js";import{EditOperation as y}from"../../../common/core/editOperation.js";import{Range as v}from"../../../common/core/range.js";import{Selection as R}from"../../../common/core/selection.js";import{ILanguageConfigurationService as se}from"../../../common/languages/languageConfigurationRegistry.js";import{TrackedRangeStickiness as L}from"../../../common/model.js";import{ModelDecorationOptions as E}from"../../../common/model/textModel.js";import{Choice as k,Placeholder as M,SnippetParser as z,Text as A,TextmateSnippet as re}from"./snippetParser.js";import{ClipboardBasedVariableResolver as U,CommentBasedVariableResolver as $,CompositeSnippetVariableResolver as q,ModelBasedVariableResolver as H,RandomBasedVariableResolver as J,SelectionBasedVariableResolver as K,TimeBasedVariableResolver as Q,WorkspaceBasedVariableResolver as X}from"./snippetVariables.js";class m{constructor(e,t,n){this._editor=e;this._snippet=t;this._snippetLineLeadingWhitespace=n;this._placeholderGroups=F(t.placeholders,M.compareByIndex),this._placeholderGroupsIdx=-1}_placeholderDecorations;_placeholderGroups;_offset=-1;_placeholderGroupsIdx;_nestingLevel=1;static _decor={active:E.register({description:"snippet-placeholder-1",stickiness:L.AlwaysGrowsWhenTypingAtEdges,className:"snippet-placeholder"}),inactive:E.register({description:"snippet-placeholder-2",stickiness:L.NeverGrowsWhenTypingAtEdges,className:"snippet-placeholder"}),activeFinal:E.register({description:"snippet-placeholder-3",stickiness:L.NeverGrowsWhenTypingAtEdges,className:"finish-snippet-placeholder"}),inactiveFinal:E.register({description:"snippet-placeholder-4",stickiness:L.NeverGrowsWhenTypingAtEdges,className:"finish-snippet-placeholder"})};initialize(e){this._offset=e.newPosition}dispose(){this._placeholderDecorations&&this._editor.removeDecorations([...this._placeholderDecorations.values()]),this._placeholderGroups.length=0}_initDecorations(){if(this._offset===-1)throw new Error("Snippet not initialized!");if(this._placeholderDecorations)return;this._placeholderDecorations=new Map;const e=this._editor.getModel();this._editor.changeDecorations(t=>{for(const n of this._snippet.placeholders){const i=this._snippet.offset(n),o=this._snippet.fullLen(n),a=v.fromPositions(e.getPositionAt(this._offset+i),e.getPositionAt(this._offset+i+o)),l=n.isFinalTabstop?m._decor.inactiveFinal:m._decor.inactive,s=t.addDecoration(a,l);this._placeholderDecorations.set(n,s)}})}move(e){if(!this._editor.hasModel())return[];if(this._initDecorations(),this._placeholderGroupsIdx>=0){const i=[];for(const o of this._placeholderGroups[this._placeholderGroupsIdx])if(o.transform){const a=this._placeholderDecorations.get(o),l=this._editor.getModel().getDecorationRange(a),s=this._editor.getModel().getValueInRange(l),r=o.transform.resolve(s).split(/\r\n|\r|\n/);for(let c=1;c<r.length;c++)r[c]=this._editor.getModel().normalizeIndentation(this._snippetLineLeadingWhitespace+r[c]);i.push(y.replace(l,r.join(this._editor.getModel().getEOL())))}i.length>0&&this._editor.executeEdits("snippet.placeholderTransform",i)}let t=!1;e===!0&&this._placeholderGroupsIdx<this._placeholderGroups.length-1?(this._placeholderGroupsIdx+=1,t=!0):e===!1&&this._placeholderGroupsIdx>0&&(this._placeholderGroupsIdx-=1,t=!0);const n=this._editor.getModel().changeDecorations(i=>{const o=new Set,a=[];for(const l of this._placeholderGroups[this._placeholderGroupsIdx]){const s=this._placeholderDecorations.get(l),r=this._editor.getModel().getDecorationRange(s);a.push(new R(r.startLineNumber,r.startColumn,r.endLineNumber,r.endColumn)),t=t&&this._hasPlaceholderBeenCollapsed(l),i.changeDecorationOptions(s,l.isFinalTabstop?m._decor.activeFinal:m._decor.active),o.add(l);for(const c of this._snippet.enclosingPlaceholders(l)){const h=this._placeholderDecorations.get(c);i.changeDecorationOptions(h,c.isFinalTabstop?m._decor.activeFinal:m._decor.active),o.add(c)}}for(const[l,s]of this._placeholderDecorations)o.has(l)||i.changeDecorationOptions(s,l.isFinalTabstop?m._decor.inactiveFinal:m._decor.inactive);return a});return t?this.move(e):n??[]}_hasPlaceholderBeenCollapsed(e){let t=e;for(;t;){if(t instanceof M){const n=this._placeholderDecorations.get(t);if(this._editor.getModel().getDecorationRange(n).isEmpty()&&t.toString().length>0)return!0}t=t.parent}return!1}get isAtFirstPlaceholder(){return this._placeholderGroupsIdx<=0||this._placeholderGroups.length===0}get isAtLastPlaceholder(){return this._placeholderGroupsIdx===this._placeholderGroups.length-1}get hasPlaceholder(){return this._snippet.placeholders.length>0}get isTrivialSnippet(){if(this._snippet.placeholders.length===0)return!0;if(this._snippet.placeholders.length===1){const[e]=this._snippet.placeholders;if(e.isFinalTabstop&&this._snippet.rightMostDescendant===e)return!0}return!1}computePossibleSelections(){const e=new Map;for(const t of this._placeholderGroups){let n;for(const i of t){if(i.isFinalTabstop)break;n||(n=[],e.set(i.index,n));const o=this._placeholderDecorations.get(i),a=this._editor.getModel().getDecorationRange(o);if(!a){e.delete(i.index);break}n.push(a)}}return e}get activeChoice(){if(!this._placeholderDecorations)return;const e=this._placeholderGroups[this._placeholderGroupsIdx][0];if(!e?.choice)return;const t=this._placeholderDecorations.get(e);if(!t)return;const n=this._editor.getModel().getDecorationRange(t);if(n)return{range:n,choice:e.choice}}get hasChoice(){let e=!1;return this._snippet.walk(t=>(e=t instanceof k,!e)),e}merge(e){const t=this._editor.getModel();this._nestingLevel*=10,this._editor.changeDecorations(n=>{for(const i of this._placeholderGroups[this._placeholderGroupsIdx]){const o=e.shift(),a=o._snippet.placeholderInfo.last.index;for(const s of o._snippet.placeholderInfo.all)s.isFinalTabstop?s.index=i.index+(a+1)/this._nestingLevel:s.index=i.index+s.index/this._nestingLevel;this._snippet.replace(i,o._snippet.children);const l=this._placeholderDecorations.get(i);n.removeDecoration(l),this._placeholderDecorations.delete(i);for(const s of o._snippet.placeholders){const r=o._snippet.offset(s),c=o._snippet.fullLen(s),h=v.fromPositions(t.getPositionAt(o._offset+r),t.getPositionAt(o._offset+r+c)),p=n.addDecoration(h,m._decor.inactive);this._placeholderDecorations.set(s,p)}}this._placeholderGroups=F(this._snippet.placeholders,M.compareByIndex)})}getEnclosingRange(){let e;const t=this._editor.getModel();for(const n of this._placeholderDecorations.values()){const i=t.getDecorationRange(n)??void 0;e?e=e.plusRange(i):e=i}return e}}const Y={overwriteBefore:0,overwriteAfter:0,adjustWhitespace:!0,clipboardText:void 0,overtypingCapturer:void 0};let f=class{constructor(e,t,n=Y,i){this._editor=e;this._template=t;this._options=n;this._languageConfigurationService=i}static adjustWhitespace(e,t,n,i,o){const a=e.getLineContent(t.lineNumber),l=oe(a,0,t.column-1);let s;return i.walk(r=>{if(!(r instanceof A)||r.parent instanceof k||o&&!o.has(r))return!0;const c=r.value.split(/\r\n|\r|\n/);if(n){const p=i.offset(r);if(p===0)c[0]=e.normalizeIndentation(c[0]);else{s=s??i.toString();const _=s.charCodeAt(p-1);(_===N.LineFeed||_===N.CarriageReturn)&&(c[0]=e.normalizeIndentation(l+c[0]))}for(let _=1;_<c.length;_++)c[_]=e.normalizeIndentation(l+c[_])}const h=c.join(e.getEOL());return h!==r.value&&(r.parent.replace(r,[new A(h)]),s=void 0),!0}),l}static adjustSelection(e,t,n,i){if(n!==0||i!==0){const{positionLineNumber:o,positionColumn:a}=t,l=a-n,s=a+i,r=e.validateRange({startLineNumber:o,startColumn:l,endLineNumber:o,endColumn:s});t=R.createWithDirection(r.startLineNumber,r.startColumn,r.endLineNumber,r.endColumn,t.getDirection())}return t}static createEditsAndSnippetsFromSelections(e,t,n,i,o,a,l,s,r){const c=[],h=[];if(!e.hasModel())return{edits:c,snippets:h};const p=e.getModel(),_=e.invokeWithinContext(d=>d.get(V)),g=e.invokeWithinContext(d=>new H(d.get(j),p)),I=()=>l,D=p.getValueInRange(f.adjustSelection(p,e.getSelection(),n,0)),T=p.getValueInRange(f.adjustSelection(p,e.getSelection(),0,i)),C=p.getLineFirstNonWhitespaceColumn(e.getSelection().positionLineNumber),P=e.getSelections().map((d,u)=>({selection:d,idx:u})).sort((d,u)=>v.compareRangesUsingStarts(d.selection,u.selection));for(const{selection:d,idx:u}of P){let b=f.adjustSelection(p,d,n,0),S=f.adjustSelection(p,d,0,i);D!==p.getValueInRange(b)&&(b=d),T!==p.getValueInRange(S)&&(S=d);const G=d.setStartPosition(b.startLineNumber,b.startColumn).setEndPosition(S.endLineNumber,S.endColumn),w=new z().parse(t,!0,o),Z=G.getStartPosition(),ee=f.adjustWhitespace(p,Z,a||u>0&&C!==p.getLineFirstNonWhitespaceColumn(d.positionLineNumber),w);w.resolveVariables(new q([g,new U(I,u,P.length,e.getOption(B.multiCursorPaste)==="spread"),new K(p,d,u,s),new $(p,d,r),new Q,new X(_),new J])),c[u]=y.replace(G,w.toString()),c[u].identifier={major:u,minor:0},c[u]._isTracked=!0,h[u]=new m(e,w,ee)}return{edits:c,snippets:h}}static createEditsAndSnippetsFromEdits(e,t,n,i,o,a,l){if(!e.hasModel()||t.length===0)return{edits:[],snippets:[]};const s=[],r=e.getModel(),c=new z,h=new re,p=new q([e.invokeWithinContext(g=>new H(g.get(j),r)),new U(()=>o,0,e.getSelections().length,e.getOption(B.multiCursorPaste)==="spread"),new K(r,e.getSelection(),0,a),new $(r,e.getSelection(),l),new Q,new X(e.invokeWithinContext(g=>g.get(V))),new J]);t=t.sort((g,I)=>v.compareRangesUsingStarts(g.range,I.range));let _=0;for(let g=0;g<t.length;g++){const{range:I,template:D}=t[g];if(g>0){const u=t[g-1].range,b=v.fromPositions(u.getEndPosition(),I.getStartPosition()),S=new A(r.getValueInRange(b));h.appendChild(S),_+=S.value.length}const T=c.parseFragment(D,h);f.adjustWhitespace(r,I.getStartPosition(),!0,h,new Set(T)),h.resolveVariables(p);const C=h.toString(),P=C.slice(_);_=C.length;const d=y.replace(I,P);d.identifier={major:g,minor:0},d._isTracked=!0,s.push(d)}return c.ensureFinalTabstop(h,n,!0),{edits:s,snippets:[new m(e,h,"")]}}_templateMerges=[];_snippets=[];dispose(){ne(this._snippets)}_logInfo(){return`template="${this._template}", merged_templates="${this._templateMerges.join(" -> ")}"`}insert(){if(!this._editor.hasModel())return;const{edits:e,snippets:t}=typeof this._template=="string"?f.createEditsAndSnippetsFromSelections(this._editor,this._template,this._options.overwriteBefore,this._options.overwriteAfter,!1,this._options.adjustWhitespace,this._options.clipboardText,this._options.overtypingCapturer,this._languageConfigurationService):f.createEditsAndSnippetsFromEdits(this._editor,this._template,!1,this._options.adjustWhitespace,this._options.clipboardText,this._options.overtypingCapturer,this._languageConfigurationService);this._snippets=t,this._editor.executeEdits("snippet",e,n=>{const i=n.filter(o=>!!o.identifier);for(let o=0;o<t.length;o++)t[o].initialize(i[o].textChange);return this._snippets[0].hasPlaceholder?this._move(!0):i.map(o=>R.fromPositions(o.range.getEndPosition()))}),this._editor.revealRange(this._editor.getSelections()[0])}merge(e,t=Y){if(!this._editor.hasModel())return;this._templateMerges.push([this._snippets[0]._nestingLevel,this._snippets[0]._placeholderGroupsIdx,e]);const{edits:n,snippets:i}=f.createEditsAndSnippetsFromSelections(this._editor,e,t.overwriteBefore,t.overwriteAfter,!0,t.adjustWhitespace,t.clipboardText,t.overtypingCapturer,this._languageConfigurationService);this._editor.executeEdits("snippet",n,o=>{const a=o.filter(s=>!!s.identifier);for(let s=0;s<i.length;s++)i[s].initialize(a[s].textChange);const l=i[0].isTrivialSnippet;if(!l)for(const s of this._snippets)s.merge(i);return this._snippets[0].hasPlaceholder&&!l?this._move(void 0):a.map(s=>R.fromPositions(s.range.getEndPosition()))})}next(){const e=this._move(!0);this._editor.setSelections(e),this._editor.revealPositionInCenterIfOutsideViewport(e[0].getPosition())}prev(){const e=this._move(!1);this._editor.setSelections(e),this._editor.revealPositionInCenterIfOutsideViewport(e[0].getPosition())}_move(e){const t=[];for(const n of this._snippets){const i=n.move(e);t.push(...i)}return t}get isAtFirstPlaceholder(){return this._snippets[0].isAtFirstPlaceholder}get isAtLastPlaceholder(){return this._snippets[0].isAtLastPlaceholder}get hasPlaceholder(){return this._snippets[0].hasPlaceholder}get hasChoice(){return this._snippets[0].hasChoice}get activeChoice(){return this._snippets[0].activeChoice}isSelectionWithinPlaceholders(){if(!this.hasPlaceholder)return!1;const e=this._editor.getSelections();if(e.length<this._snippets.length)return!1;const t=new Map;for(const n of this._snippets){const i=n.computePossibleSelections();if(t.size===0)for(const[o,a]of i){a.sort(v.compareRangesUsingStarts);for(const l of e)if(a[0].containsRange(l)){t.set(o,[]);break}}if(t.size===0)return!1;t.forEach((o,a)=>{o.push(...i.get(a))})}e.sort(v.compareRangesUsingStarts);for(const[n,i]of t){if(i.length!==e.length){t.delete(n);continue}i.sort(v.compareRangesUsingStarts);for(let o=0;o<i.length;o++)if(!i[o].containsRange(e[o])){t.delete(n);continue}}return t.size>0}getEnclosingRange(){let e;for(const t of this._snippets){const n=t.getEnclosingRange();e?e=e.plusRange(n):e=n}return e}};f=W([O(3,se)],f);export{m as OneSnippet,f as SnippetSession};
