var L=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var x=(n,e,i,o)=>{for(var s=o>1?void 0:o?N(e,i):e,r=n.length-1,a;r>=0;r--)(a=n[r])&&(s=(o?a(e,i,s):a(s))||s);return o&&s&&L(e,i,s),s},h=(n,e)=>(i,o)=>e(i,o,n);import{KeyCode as l,KeyMod as y}from"../../../../base/common/keyCodes.js";import{DisposableStore as O}from"../../../../base/common/lifecycle.js";import{assertType as k}from"../../../../base/common/types.js";import"../../../browser/editorBrowser.js";import{EditorCommand as A,EditorContributionInstantiation as K,registerEditorCommand as c,registerEditorContribution as D}from"../../../browser/editorExtensions.js";import{Position as F}from"../../../common/core/position.js";import"../../../common/core/range.js";import"../../../common/editorCommon.js";import{EditorContextKeys as f}from"../../../common/editorContextKeys.js";import{CompletionItemKind as V}from"../../../common/languages.js";import{ILanguageConfigurationService as B}from"../../../common/languages/languageConfigurationRegistry.js";import"../../../common/model.js";import{ILanguageFeaturesService as R}from"../../../common/services/languageFeatures.js";import"./snippetParser.js";import{showSimpleSuggestions as W}from"../../suggest/browser/suggest.js";import"../../suggest/browser/suggestOvertypingCapturer.js";import{localize as u}from"../../../../nls.js";import{ContextKeyExpr as T,IContextKeyService as H,RawContextKey as v}from"../../../../platform/contextkey/common/contextkey.js";import{KeybindingWeight as S}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{ILogService as j}from"../../../../platform/log/common/log.js";import{SnippetSession as q}from"./snippetSession.js";const _={overwriteBefore:0,overwriteAfter:0,undoStopBefore:!0,undoStopAfter:!0,adjustWhitespace:!0,clipboardText:void 0,overtypingCapturer:void 0};let t=class{constructor(e,i,o,s,r){this._editor=e;this._logService=i;this._languageFeaturesService=o;this._languageConfigurationService=r;this._inSnippet=t.InSnippetMode.bindTo(s),this._hasNextTabstop=t.HasNextTabstop.bindTo(s),this._hasPrevTabstop=t.HasPrevTabstop.bindTo(s)}static ID="snippetController2";static get(e){return e.getContribution(t.ID)}static InSnippetMode=new v("inSnippetMode",!1,u("inSnippetMode","Whether the editor in current in snippet mode"));static HasNextTabstop=new v("hasNextTabstop",!1,u("hasNextTabstop","Whether there is a next tab stop when in snippet mode"));static HasPrevTabstop=new v("hasPrevTabstop",!1,u("hasPrevTabstop","Whether there is a previous tab stop when in snippet mode"));_inSnippet;_hasNextTabstop;_hasPrevTabstop;_session;_snippetListener=new O;_modelVersionId=-1;_currentChoice;_choiceCompletions;dispose(){this._inSnippet.reset(),this._hasPrevTabstop.reset(),this._hasNextTabstop.reset(),this._session?.dispose(),this._snippetListener.dispose()}apply(e,i){try{this._doInsert(e,typeof i>"u"?_:{..._,...i})}catch(o){this.cancel(),this._logService.error(o),this._logService.error("snippet_error"),this._logService.error("insert_edits=",e),this._logService.error("existing_template=",this._session?this._session._logInfo():"<no_session>")}}insert(e,i){try{this._doInsert(e,typeof i>"u"?_:{..._,...i})}catch(o){this.cancel(),this._logService.error(o),this._logService.error("snippet_error"),this._logService.error("insert_template=",e),this._logService.error("existing_template=",this._session?this._session._logInfo():"<no_session>")}}_doInsert(e,i){if(this._editor.hasModel()){if(this._snippetListener.clear(),i.undoStopBefore&&this._editor.getModel().pushStackElement(),this._session&&typeof e!="string"&&this.cancel(),this._session?(k(typeof e=="string"),this._session.merge(e,i)):(this._modelVersionId=this._editor.getModel().getAlternativeVersionId(),this._session=new q(this._editor,e,i,this._languageConfigurationService),this._session.insert()),i.undoStopAfter&&this._editor.getModel().pushStackElement(),this._session?.hasChoice){const o={_debugDisplayName:"snippetChoiceCompletions",provideCompletionItems:(b,M)=>{if(!this._session||b!==this._editor.getModel()||!F.equals(this._editor.getPosition(),M))return;const{activeChoice:p}=this._session;if(!p||p.choice.options.length===0)return;const I=b.getValueInRange(p.range),w=!!p.choice.options.find(d=>d.value===I),C=[];for(let d=0;d<p.choice.options.length;d++){const m=p.choice.options[d];C.push({kind:V.Value,label:m.value,insertText:m.value,sortText:"a".repeat(d+1),range:p.range,filterText:w?`${I}_${m.value}`:void 0,command:{id:"jumpToNextSnippetPlaceholder",title:u("next","Go to next placeholder...")}})}return{suggestions:C}}},s=this._editor.getModel();let r,a=!1;const P=()=>{r?.dispose(),a=!1},E=()=>{a||(r=this._languageFeaturesService.completionProvider.register({language:s.getLanguageId(),pattern:s.uri.fsPath,scheme:s.uri.scheme,exclusive:!0},o),this._snippetListener.add(r),a=!0)};this._choiceCompletions={provider:o,enable:E,disable:P}}this._updateState(),this._snippetListener.add(this._editor.onDidChangeModelContent(o=>o.isFlush&&this.cancel())),this._snippetListener.add(this._editor.onDidChangeModel(()=>this.cancel())),this._snippetListener.add(this._editor.onDidChangeCursorSelection(()=>this._updateState()))}}_updateState(){if(!(!this._session||!this._editor.hasModel())){if(this._modelVersionId===this._editor.getModel().getAlternativeVersionId())return this.cancel();if(!this._session.hasPlaceholder)return this.cancel();if(this._session.isAtLastPlaceholder||!this._session.isSelectionWithinPlaceholders())return this._editor.getModel().pushStackElement(),this.cancel();this._inSnippet.set(!0),this._hasPrevTabstop.set(!this._session.isAtFirstPlaceholder),this._hasNextTabstop.set(!this._session.isAtLastPlaceholder),this._handleChoice()}}_handleChoice(){if(!this._session||!this._editor.hasModel()){this._currentChoice=void 0;return}const{activeChoice:e}=this._session;if(!e||!this._choiceCompletions){this._choiceCompletions?.disable(),this._currentChoice=void 0;return}this._currentChoice!==e.choice&&(this._currentChoice=e.choice,this._choiceCompletions.enable(),queueMicrotask(()=>{W(this._editor,this._choiceCompletions.provider)}))}finish(){for(;this._inSnippet.get();)this.next()}cancel(e=!1){this._inSnippet.reset(),this._hasPrevTabstop.reset(),this._hasNextTabstop.reset(),this._snippetListener.clear(),this._currentChoice=void 0,this._session?.dispose(),this._session=void 0,this._modelVersionId=-1,e&&this._editor.setSelections([this._editor.getSelection()])}prev(){this._session?.prev(),this._updateState()}next(){this._session?.next(),this._updateState()}isInSnippet(){return!!this._inSnippet.get()}getSessionEnclosingRange(){if(this._session)return this._session.getEnclosingRange()}};t=x([h(1,j),h(2,R),h(3,H),h(4,B)],t),D(t.ID,t,K.Lazy);const g=A.bindToContribution(t.get);c(new g({id:"jumpToNextSnippetPlaceholder",precondition:T.and(t.InSnippetMode,t.HasNextTabstop),handler:n=>n.next(),kbOpts:{weight:S.EditorContrib+30,kbExpr:f.textInputFocus,primary:l.Tab}})),c(new g({id:"jumpToPrevSnippetPlaceholder",precondition:T.and(t.InSnippetMode,t.HasPrevTabstop),handler:n=>n.prev(),kbOpts:{weight:S.EditorContrib+30,kbExpr:f.textInputFocus,primary:y.Shift|l.Tab}})),c(new g({id:"leaveSnippet",precondition:t.InSnippetMode,handler:n=>n.cancel(!0),kbOpts:{weight:S.EditorContrib+30,kbExpr:f.textInputFocus,primary:l.Escape,secondary:[y.Shift|l.Escape]}})),c(new g({id:"acceptSnippet",precondition:t.InSnippetMode,handler:n=>n.finish()}));export{t as SnippetController2};
