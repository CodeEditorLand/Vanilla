import i from"assert";import{mock as g}from"../../../../../base/test/common/mock.js";import{CoreEditingCommands as m}from"../../../../browser/coreCommands.js";import"../../../../browser/editorBrowser.js";import{Selection as e}from"../../../../common/core/selection.js";import{Range as p}from"../../../../common/core/range.js";import{Handler as b}from"../../../../common/editorCommon.js";import"../../../../common/model/textModel.js";import{SnippetController2 as l}from"../../browser/snippetController2.js";import{createTestCodeEditor as E}from"../../../../test/browser/testCodeEditor.js";import{createTextModel as x}from"../../../../test/common/testTextModel.js";import{IContextKeyService as I}from"../../../../../platform/contextkey/common/contextkey.js";import"../../../../../platform/instantiation/common/instantiation.js";import{InstantiationService as h}from"../../../../../platform/instantiation/common/instantiationService.js";import{ServiceCollection as q}from"../../../../../platform/instantiation/common/serviceCollection.js";import{MockContextKeyService as v}from"../../../../../platform/keybinding/test/common/mockKeybindingService.js";import{ILabelService as V}from"../../../../../platform/label/common/label.js";import{ILogService as C,NullLogService as N}from"../../../../../platform/log/common/log.js";import{IWorkspaceContextService as y}from"../../../../../platform/workspace/common/workspace.js";import{EndOfLineSequence as T}from"../../../../common/model.js";import{ensureNoDisposablesAreLeakedInTestSuite as O}from"../../../../../base/test/common/utils.js";suite("SnippetController2",function(){function a(u,...w){for(const d of u.getSelections()){const S=w.shift();i.ok(d.equalsSelection(S),`actual=${d.toString()} <> expected=${S.toString()}`)}i.strictEqual(w.length,0)}function r(u,w,d,S){const $=f(u);i.strictEqual($.inSnippet,w,"inSnippetMode"),i.strictEqual($.hasPrev,d,"HasPrevTabstop"),i.strictEqual($.hasNext,S,"HasNextTabstop")}function f(u=s){return{inSnippet:l.InSnippetMode.getValue(u),hasPrev:l.HasPrevTabstop.getValue(u),hasNext:l.HasNextTabstop.getValue(u)}}let n,t,o,s,c;setup(function(){s=new v,o=x(`if
    $state
fi`);const u=new q([V,new class extends g(){}],[y,new class extends g(){getWorkspace(){return{id:"foo",folders:[]}}}],[C,new N],[I,s]);c=new h(u),t=E(o,{serviceCollection:u}),t.setSelections([new e(1,1,1,1),new e(2,5,2,5)]),i.strictEqual(o.getEOL(),`
`)}),teardown(function(){o.dispose(),n.dispose()}),O(),test("creation",()=>{n=c.createInstance(l,t),r(s,!1,!1,!1)}),test("insert, insert -> abort",function(){n=c.createInstance(l,t),n.insert("foo${1:bar}foo$0"),r(s,!0,!1,!0),a(t,new e(1,4,1,7),new e(2,8,2,11)),n.cancel(),r(s,!1,!1,!1),a(t,new e(1,4,1,7),new e(2,8,2,11))}),test("insert, insert -> tab, tab, done",function(){n=c.createInstance(l,t),n.insert("${1:one}${2:two}$0"),r(s,!0,!1,!0),n.next(),r(s,!0,!0,!0),n.next(),r(s,!1,!1,!1),t.trigger("test","type",{text:"	"}),i.strictEqual(l.InSnippetMode.getValue(s),!1),i.strictEqual(l.HasNextTabstop.getValue(s),!1),i.strictEqual(l.HasPrevTabstop.getValue(s),!1)}),test("insert, insert -> cursor moves out (left/right)",function(){n=c.createInstance(l,t),n.insert("foo${1:bar}foo$0"),r(s,!0,!1,!0),a(t,new e(1,4,1,7),new e(2,8,2,11)),t.setSelections([new e(1,12,1,12),new e(2,16,2,16)]),r(s,!1,!1,!1)}),test("insert, insert -> cursor moves out (up/down)",function(){n=c.createInstance(l,t),n.insert("foo${1:bar}foo$0"),r(s,!0,!1,!0),a(t,new e(1,4,1,7),new e(2,8,2,11)),t.setSelections([new e(2,4,2,7),new e(3,8,3,11)]),r(s,!1,!1,!1)}),test("insert, insert -> cursors collapse",function(){n=c.createInstance(l,t),n.insert("foo${1:bar}foo$0"),i.strictEqual(l.InSnippetMode.getValue(s),!0),a(t,new e(1,4,1,7),new e(2,8,2,11)),t.setSelections([new e(1,4,1,7)]),r(s,!1,!1,!1)}),test("insert, insert plain text -> no snippet mode",function(){n=c.createInstance(l,t),n.insert("foobar"),r(s,!1,!1,!1),a(t,new e(1,7,1,7),new e(2,11,2,11))}),test("insert, delete snippet text",function(){n=c.createInstance(l,t),n.insert("${1:foobar}$0"),r(s,!0,!1,!0),a(t,new e(1,1,1,7),new e(2,5,2,11)),t.trigger("test","cut",{}),r(s,!0,!1,!0),a(t,new e(1,1,1,1),new e(2,5,2,5)),t.trigger("test","type",{text:"abc"}),r(s,!0,!1,!0),n.next(),r(s,!1,!1,!1),t.trigger("test","tab",{}),r(s,!1,!1,!1)}),test("insert, nested trivial snippet",function(){n=c.createInstance(l,t),n.insert("${1:foo}bar$0"),r(s,!0,!1,!0),a(t,new e(1,1,1,4),new e(2,5,2,8)),n.insert("FOO$0"),a(t,new e(1,4,1,4),new e(2,8,2,8)),r(s,!0,!1,!0),n.next(),a(t,new e(1,7,1,7),new e(2,11,2,11)),r(s,!1,!1,!1)}),test("insert, nested snippet",function(){n=c.createInstance(l,t),n.insert("${1:foobar}$0"),r(s,!0,!1,!0),a(t,new e(1,1,1,7),new e(2,5,2,11)),n.insert("far$1boo$0"),a(t,new e(1,4,1,4),new e(2,8,2,8)),r(s,!0,!1,!0),n.next(),a(t,new e(1,7,1,7),new e(2,11,2,11)),r(s,!0,!0,!0),n.next(),a(t,new e(1,7,1,7),new e(2,11,2,11)),r(s,!1,!1,!1)}),test("insert, nested plain text",function(){n=c.createInstance(l,t),n.insert("${1:foobar}$0"),r(s,!0,!1,!0),a(t,new e(1,1,1,7),new e(2,5,2,11)),n.insert("farboo"),a(t,new e(1,7,1,7),new e(2,11,2,11)),r(s,!0,!1,!0),n.next(),a(t,new e(1,7,1,7),new e(2,11,2,11)),r(s,!1,!1,!1)}),test("Nested snippets without final placeholder jumps to next outer placeholder, #27898",function(){n=c.createInstance(l,t),n.insert("for(const ${1:element} of ${2:array}) {$0}"),r(s,!0,!1,!0),a(t,new e(1,11,1,18),new e(2,15,2,22)),n.next(),r(s,!0,!0,!0),a(t,new e(1,22,1,27),new e(2,26,2,31)),n.insert("document"),r(s,!0,!0,!0),a(t,new e(1,30,1,30),new e(2,34,2,34)),n.next(),r(s,!1,!1,!1)}),test("Inconsistent tab stop behaviour with recursive snippets and tab / shift tab, #27543",function(){n=c.createInstance(l,t),n.insert("1_calize(${1:nl}, '${2:value}')$0"),r(s,!0,!1,!0),a(t,new e(1,10,1,12),new e(2,14,2,16)),n.insert("2_calize(${1:nl}, '${2:value}')$0"),a(t,new e(1,19,1,21),new e(2,23,2,25)),n.next(),a(t,new e(1,24,1,29),new e(2,28,2,33)),n.next(),a(t,new e(1,31,1,31),new e(2,35,2,35)),n.next(),a(t,new e(1,34,1,39),new e(2,38,2,43)),n.prev(),a(t,new e(1,31,1,31),new e(2,35,2,35))}),test("Snippet tabstop selecting content of previously entered variable only works when separated by space, #23728",function(){n=c.createInstance(l,t),o.setValue(""),t.setSelection(new e(1,1,1,1)),n.insert("import ${2:${1:module}} from '${1:module}'$0"),r(s,!0,!1,!0),a(t,new e(1,8,1,14),new e(1,21,1,27)),n.insert("foo"),a(t,new e(1,11,1,11),new e(1,21,1,21)),n.next(),a(t,new e(1,8,1,11))}),test("HTML Snippets Combine, #32211",function(){n=c.createInstance(l,t),o.setValue(""),o.updateOptions({insertSpaces:!1,tabSize:4,trimAutoWhitespace:!1}),t.setSelection(new e(1,1,1,1)),n.insert(`
			<!DOCTYPE html>
			<html lang="en">
			<head>
				<meta charset="UTF-8">
				<meta name="viewport" content="width=\${2:device-width}, initial-scale=\${3:1.0}">
				<meta http-equiv="X-UA-Compatible" content="\${5:ie=edge}">
				<title>\${7:Document}</title>
			</head>
			<body>
				\${8}
			</body>
			</html>
		`),n.next(),n.next(),n.next(),n.next(),a(t,new e(11,5,11,5)),n.insert('<input type="${2:text}">'),a(t,new e(11,18,11,22))}),test("Problems with nested snippet insertion #39594",function(){n=c.createInstance(l,t),o.setValue(""),t.setSelection(new e(1,1,1,1)),n.insert("$1 = ConvertTo-Json $1"),a(t,new e(1,1,1,1),new e(1,19,1,19)),t.setSelection(new e(1,19,1,19)),r(s,!1,!1,!1)}),test("Problems with nested snippet insertion #39594 (part2)",function(){n=c.createInstance(l,t),o.setValue(`a-
aaa-`),t.setSelections([new e(2,5,2,5),new e(1,3,1,3)]),n.insert("log($1);$0"),a(t,new e(2,9,2,9),new e(1,7,1,7)),r(s,!0,!1,!0)}),test("\u201CNested\u201D snippets terminating abruptly in VSCode 1.19.2. #42012",function(){n=c.createInstance(l,t),o.setValue(""),t.setSelection(new e(1,1,1,1)),n.insert("var ${2:${1:name}} = ${1:name} + 1;${0}"),a(t,new e(1,5,1,9),new e(1,12,1,16)),r(s,!0,!1,!0),n.next(),r(s,!0,!0,!0)}),test("Placeholders order #58267",function(){n=c.createInstance(l,t),o.setValue(""),t.setSelection(new e(1,1,1,1)),n.insert("\\pth{$1}$0"),a(t,new e(1,6,1,6)),r(s,!0,!1,!0),n.insert("\\itv{${1:left}}{${2:right}}{${3:left_value}}{${4:right_value}}$0"),a(t,new e(1,11,1,15)),n.next(),a(t,new e(1,17,1,22)),n.next(),a(t,new e(1,24,1,34)),n.next(),a(t,new e(1,36,1,47)),n.next(),a(t,new e(1,48,1,48)),n.next(),a(t,new e(1,49,1,49)),r(s,!1,!1,!1)}),test("Must tab through deleted tab stops in snippets #31619",function(){n=c.createInstance(l,t),o.setValue(""),t.setSelection(new e(1,1,1,1)),n.insert("foo${1:a${2:bar}baz}end$0"),a(t,new e(1,4,1,11)),t.trigger("test",b.Cut,null),a(t,new e(1,4,1,4)),n.next(),a(t,new e(1,7,1,7)),r(s,!1,!1,!1)}),test("Cancelling snippet mode should discard added cursors #68512 (soft cancel)",function(){n=c.createInstance(l,t),o.setValue(""),t.setSelection(new e(1,1,1,1)),n.insert(".REGION ${2:FUNCTION_NAME}\nCREATE.FUNCTION ${1:VOID} ${2:FUNCTION_NAME}(${3:})\n	${4:}\nEND\n.ENDREGION$0"),a(t,new e(2,17,2,21)),n.next(),a(t,new e(1,9,1,22),new e(2,22,2,35)),r(s,!0,!0,!0),t.setSelections([new e(1,22,1,22),new e(2,35,2,35)]),r(s,!0,!0,!0),t.setSelections([new e(2,1,2,1),new e(2,36,2,36)]),r(s,!1,!1,!1),a(t,new e(2,1,2,1),new e(2,36,2,36))}),test("Cancelling snippet mode should discard added cursors #68512 (hard cancel)",function(){n=c.createInstance(l,t),o.setValue(""),t.setSelection(new e(1,1,1,1)),n.insert(".REGION ${2:FUNCTION_NAME}\nCREATE.FUNCTION ${1:VOID} ${2:FUNCTION_NAME}(${3:})\n	${4:}\nEND\n.ENDREGION$0"),a(t,new e(2,17,2,21)),n.next(),a(t,new e(1,9,1,22),new e(2,22,2,35)),r(s,!0,!0,!0),t.setSelections([new e(1,22,1,22),new e(2,35,2,35)]),r(s,!0,!0,!0),n.cancel(!0),r(s,!1,!1,!1),a(t,new e(1,22,1,22))}),test("User defined snippet tab stops ignored #72862",function(){n=c.createInstance(l,t),o.setValue(""),t.setSelection(new e(1,1,1,1)),n.insert("export default $1"),r(s,!0,!1,!0)}),test("Optional tabstop in snippets #72358",function(){n=c.createInstance(l,t),o.setValue(""),t.setSelection(new e(1,1,1,1)),n.insert("${1:prop: {$2\\},}\nmore$0"),r(s,!0,!1,!0),a(t,new e(1,1,1,10)),t.trigger("test",b.Cut,{}),a(t,new e(1,1,1,1)),n.next(),a(t,new e(2,5,2,5)),r(s,!1,!1,!1)}),test("issue #90135: confusing trim whitespace edits",function(){n=c.createInstance(l,t),o.setValue(""),m.Tab.runEditorCommand(null,t,null),n.insert(`
foo`),a(t,new e(2,8,2,8))}),test("issue #145727: insertSnippet can put snippet selections in wrong positions (1 of 2)",function(){n=c.createInstance(l,t),o.setValue(""),m.Tab.runEditorCommand(null,t,null),n.insert("\naProperty: aClass<${2:boolean}> = new aClass<${2:boolean}>();\n",{adjustWhitespace:!1}),a(t,new e(2,19,2,26),new e(2,41,2,48))}),test("issue #145727: insertSnippet can put snippet selections in wrong positions (2 of 2)",function(){n=c.createInstance(l,t),o.setValue(""),m.Tab.runEditorCommand(null,t,null),n.insert("\naProperty: aClass<${2:boolean}> = new aClass<${2:boolean}>();\n"),a(t,new e(2,23,2,30),new e(2,45,2,52))}),test("leading TAB by snippets won't replace by spaces #101870",function(){n=c.createInstance(l,t),o.setValue(""),o.updateOptions({insertSpaces:!0,tabSize:4}),n.insert(`	Hello World
	New Line`),i.strictEqual(o.getValue(),`    Hello World
    New Line`)}),test("leading TAB by snippets won't replace by spaces #101870 (part 2)",function(){n=c.createInstance(l,t),o.setValue(""),o.updateOptions({insertSpaces:!0,tabSize:4}),n.insert(`	Hello World
	New Line
\${1:	more}`),i.strictEqual(o.getValue(),`    Hello World
    New Line
    more`)}),test.skip("Snippet transformation does not work after inserting variable using intellisense, #112362",function(){n=c.createInstance(l,t),o.setValue(""),o.updateOptions({insertSpaces:!0,tabSize:4}),n.insert(`$1

\${1/([A-Za-z0-9]+): ([A-Za-z]+).*/$1: '$2',/gm}`),a(t,new e(1,1,1,1),new e(3,1,3,1)),t.trigger("test","type",{text:"foo: number;"}),n.next(),i.strictEqual(o.getValue(),`foo: number;

foo: 'number',`),n=c.createInstance(l,t),o.setValue(""),o.updateOptions({insertSpaces:!0,tabSize:4}),n.insert(`$1

\${1/([A-Za-z0-9]+): ([A-Za-z]+).*/$1: '$2',/gm}`),a(t,new e(1,1,1,1),new e(3,1,3,1)),t.trigger("test","type",{text:"foo: "}),n.insert("number;"),n.next(),i.strictEqual(o.getValue(),`foo: number;

foo: 'number',`)}),suite("createEditsAndSnippetsFromEdits",function(){test("apply, tab, done",function(){n=c.createInstance(l,t),o.setValue('foo("bar")'),n.apply([{range:new p(1,5,1,10),template:"$1"},{range:new p(1,1,1,1),template:'const ${1:new_const} = "bar";\n'}]),i.strictEqual(o.getValue(),`const new_const = "bar";
foo(new_const)`),r(s,!0,!1,!0),i.deepStrictEqual(t.getSelections(),[new e(1,7,1,16),new e(2,5,2,14)]),n.next(),r(s,!1,!1,!1),i.deepStrictEqual(t.getSelections(),[new e(2,14,2,14)])}),test("apply, tab, done with special final tabstop",function(){o.setValue('foo("bar")'),n=c.createInstance(l,t),n.apply([{range:new p(1,5,1,10),template:"$1"},{range:new p(1,1,1,1),template:'const ${1:new_const}$0 = "bar";\n'}]),i.strictEqual(o.getValue(),`const new_const = "bar";
foo(new_const)`),r(s,!0,!1,!0),i.deepStrictEqual(t.getSelections(),[new e(1,7,1,16),new e(2,5,2,14)]),n.next(),r(s,!1,!1,!1),i.deepStrictEqual(t.getSelections(),[new e(1,16,1,16)])}),test("apply, tab, tab, done",function(){o.setValue(`foo
bar`),n=c.createInstance(l,t),n.apply([{range:new p(1,4,1,4),template:"${3}"},{range:new p(2,4,2,4),template:"$3"},{range:new p(1,1,1,1),template:"### ${2:Header}\n"}]),i.strictEqual(o.getValue(),`### Header
foo
bar`),i.deepStrictEqual(f(),{inSnippet:!0,hasPrev:!1,hasNext:!0}),i.deepStrictEqual(t.getSelections(),[new e(1,5,1,11)]),n.next(),i.deepStrictEqual(f(),{inSnippet:!0,hasPrev:!0,hasNext:!0}),i.deepStrictEqual(t.getSelections(),[new e(2,4,2,4),new e(3,4,3,4)]),n.next(),i.deepStrictEqual(f(),{inSnippet:!1,hasPrev:!1,hasNext:!1}),i.deepStrictEqual(t.getSelections(),[new e(3,4,3,4)])}),test("nested into apply works",function(){n=c.createInstance(l,t),o.setValue("onetwo"),t.setSelections([new e(1,1,1,1),new e(2,1,2,1)]),n.apply([{range:new p(1,7,1,7),template:"$0${1:three}"}]),i.strictEqual(o.getValue(),"onetwothree"),i.deepStrictEqual(f(),{inSnippet:!0,hasPrev:!1,hasNext:!0}),i.deepStrictEqual(t.getSelections(),[new e(1,7,1,12)]),n.insert("foo$1bar$1"),i.strictEqual(o.getValue(),"onetwofoobar"),i.deepStrictEqual(t.getSelections(),[new e(1,10,1,10),new e(1,13,1,13)]),i.deepStrictEqual(f(),{inSnippet:!0,hasPrev:!1,hasNext:!0}),n.next(),i.deepStrictEqual(f(),{inSnippet:!0,hasPrev:!0,hasNext:!0}),i.deepStrictEqual(t.getSelections(),[new e(1,13,1,13)]),n.next(),i.deepStrictEqual(f(),{inSnippet:!1,hasPrev:!1,hasNext:!1}),i.deepStrictEqual(t.getSelections(),[new e(1,7,1,7)])}),test('nested into insert abort "outer" snippet',function(){n=c.createInstance(l,t),o.setValue(`one
two`),t.setSelections([new e(1,1,1,1),new e(2,1,2,1)]),n.insert("foo${1:bar}bazz${1:bang}"),i.deepStrictEqual(t.getSelections(),[new e(1,4,1,7),new e(1,11,1,14),new e(2,4,2,7),new e(2,11,2,14)]),i.deepStrictEqual(f(),{inSnippet:!0,hasPrev:!1,hasNext:!0}),n.apply([{range:new p(1,4,1,7),template:"$0A"}]),i.strictEqual(o.getValue(),`fooAbazzbarone
foobarbazzbartwo`),i.deepStrictEqual(f(),{inSnippet:!1,hasPrev:!1,hasNext:!1}),i.deepStrictEqual(t.getSelections(),[new e(1,4,1,4)])}),test('nested into "insert" abort "outer" snippet (2)',function(){n=c.createInstance(l,t),o.setValue(`one
two`),t.setSelections([new e(1,1,1,1),new e(2,1,2,1)]),n.insert("foo${1:bar}bazz${1:bang}"),i.deepStrictEqual(t.getSelections(),[new e(1,4,1,7),new e(1,11,1,14),new e(2,4,2,7),new e(2,11,2,14)]),i.deepStrictEqual(f(),{inSnippet:!0,hasPrev:!1,hasNext:!0});const u=[{range:new p(1,4,1,7),template:"A"},{range:new p(1,11,1,14),template:"B"},{range:new p(2,4,2,7),template:"C"},{range:new p(2,11,2,14),template:"D"}];n.apply(u),i.strictEqual(o.getValue(),`fooAbazzBone
fooCbazzDtwo`),i.deepStrictEqual(f(),{inSnippet:!1,hasPrev:!1,hasNext:!1}),i.deepStrictEqual(t.getSelections(),[new e(1,5,1,5),new e(1,10,1,10),new e(2,5,2,5),new e(2,10,2,10)])})}),test("Bug: cursor position $0 with user snippets #163808",function(){n=c.createInstance(l,t),o.setValue(""),n.insert(`<Element1 Attr1="foo" $1>
  <Element2 Attr1="$2"/>
$0"
</Element1>`),i.deepStrictEqual(t.getSelections(),[new e(1,23,1,23)]),n.insert('Qualifier="$0"'),i.strictEqual(o.getValue(),`<Element1 Attr1="foo" Qualifier="">
  <Element2 Attr1=""/>
"
</Element1>`),i.deepStrictEqual(t.getSelections(),[new e(1,34,1,34)])}),test("EOL-Sequence (CRLF) shifts tab stop in isFileTemplate snippets #167386",function(){n=c.createInstance(l,t),o.setValue(""),o.setEOL(T.CRLF),n.apply([{range:o.getFullModelRange(),template:`line 54321\${1:FOO}
line 54321\${1:FOO}
(no tab stop)
line 54321\${1:FOO}
line 54321`}]),i.deepStrictEqual(t.getSelections(),[new e(1,11,1,14),new e(2,11,2,14),new e(4,11,4,14)])}),test('"Surround With" code action snippets use incorrect indentation levels and styles #169319',function(){o.setValue(`function foo(f, x, condition) {
    f();
    return x;
}`);const u=new p(2,5,3,14);t.setSelection(u),n=c.createInstance(l,t),n.apply([{range:u,template:`if (\${1:condition}) {
	$TM_SELECTED_TEXT$0
}`}]),i.strictEqual(o.getValue(),`function foo(f, x, condition) {
    if (condition) {
        f();
        return x;
    }
}`)})});
