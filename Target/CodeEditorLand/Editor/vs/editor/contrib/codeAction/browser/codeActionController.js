var T=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var S=(h,a,i,e)=>{for(var o=e>1?void 0:e?w(a,i):a,t=h.length-1,r;t>=0;t--)(r=h[t])&&(o=(e?r(a,i,o):r(o))||o);return e&&o&&T(a,i,o),o},c=(h,a)=>(i,e)=>a(i,e,h);import{getDomNodePagePosition as M}from"../../../../base/browser/dom.js";import*as x from"../../../../base/browser/ui/aria/aria.js";import"../../../../base/browser/ui/contextview/contextview.js";import"../../../../base/common/actions.js";import"../../../../base/common/cancellation.js";import"../../../../base/common/color.js";import{onUnexpectedError as P}from"../../../../base/common/errors.js";import{Lazy as W}from"../../../../base/common/lazy.js";import{Disposable as R,MutableDisposable as B}from"../../../../base/common/lifecycle.js";import"../../../browser/editorBrowser.js";import{Position as F}from"../../../common/core/position.js";import{ScrollType as k}from"../../../common/editorCommon.js";import{CodeActionTriggerType as b}from"../../../common/languages.js";import"../../../common/model.js";import{ModelDecorationOptions as N}from"../../../common/model/textModel.js";import{ILanguageFeaturesService as E}from"../../../common/services/languageFeatures.js";import{ApplyCodeActionReason as f,applyCodeAction as H}from"./codeAction.js";import{CodeActionKeybindingResolver as O}from"./codeActionKeybindingResolver.js";import{toMenuItems as K}from"./codeActionMenu.js";import{LightBulbWidget as V}from"./lightBulbWidget.js";import{MessageController as I}from"../../message/browser/messageController.js";import{localize as _}from"../../../../nls.js";import"../../../../platform/actionWidget/browser/actionList.js";import{IActionWidgetService as q}from"../../../../platform/actionWidget/browser/actionWidget.js";import{ICommandService as z}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as $}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as G}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as D}from"../../../../platform/instantiation/common/instantiation.js";import{IMarkerService as Q}from"../../../../platform/markers/common/markers.js";import{IEditorProgressService as U}from"../../../../platform/progress/common/progress.js";import{editorFindMatchHighlight as j,editorFindMatchHighlightBorder as J}from"../../../../platform/theme/common/colorRegistry.js";import{isHighContrast as X}from"../../../../platform/theme/common/theme.js";import{registerThemingParticipant as Y}from"../../../../platform/theme/common/themeService.js";import{CodeActionAutoApply as v,CodeActionKind as m,CodeActionTriggerSource as Z}from"../common/types.js";import{CodeActionModel as ii,CodeActionsState as ei}from"./codeActionModel.js";import{HierarchicalKind as ti}from"../../../../base/common/hierarchicalKind.js";import{ITelemetryService as oi}from"../../../../platform/telemetry/common/telemetry.js";const ri="quickfix-edit-highlight";let g=class extends R{constructor(i,e,o,t,r,u,y,C,d,p,l){super();this._commandService=y;this._configurationService=C;this._actionWidgetService=d;this._instantiationService=p;this._telemetryService=l;this._editor=i,this._model=this._register(new ii(this._editor,r.codeActionProvider,e,o,u,C,this._telemetryService)),this._register(this._model.onDidChangeState(s=>this.update(s))),this._lightBulbWidget=new W(()=>{const s=this._editor.getContribution(V.ID);return s&&this._register(s.onClick(n=>this.showCodeActionsFromLightbulb(n.actions,n))),s}),this._resolver=t.createInstance(O),this._register(this._editor.onDidLayoutChange(()=>this._actionWidgetService.hide()))}static ID="editor.contrib.codeActionController";static get(i){return i.getContribution(g.ID)}_editor;_model;_lightBulbWidget;_activeCodeActions=this._register(new B);_showDisabled=!1;_resolver;_disposed=!1;dispose(){this._disposed=!0,super.dispose()}async showCodeActionsFromLightbulb(i,e){if(i.allAIFixes&&i.validActions.length===1){const o=i.validActions[0],t=o.action.command;t&&t.id==="inlineChat.start"&&t.arguments&&t.arguments.length>=1&&(t.arguments[0]={...t.arguments[0],autoSend:!1}),await this._applyCodeAction(o,!1,!1,f.FromAILightbulb);return}await this.showCodeActionList(i,e,{includeDisabledActions:!1,fromLightbulb:!0})}showCodeActions(i,e,o){return this.showCodeActionList(e,o,{includeDisabledActions:!1,fromLightbulb:!1})}hideCodeActions(){this._actionWidgetService.hide()}manualTriggerAtCurrentPosition(i,e,o,t){if(!this._editor.hasModel())return;I.get(this._editor)?.closeMessage();const r=this._editor.getPosition();this._trigger({type:b.Invoke,triggerAction:e,filter:o,autoApply:t,context:{notAvailableMessage:i,position:r}})}_trigger(i){return this._model.trigger(i)}async _applyCodeAction(i,e,o,t){try{await this._instantiationService.invokeFunction(H,i,t,{preview:o,editor:this._editor})}finally{e&&this._trigger({type:b.Auto,triggerAction:Z.QuickFix,filter:{}})}}hideLightBulbWidget(){this._lightBulbWidget.rawValue?.hide(),this._lightBulbWidget.rawValue?.gutterHide()}async update(i){if(i.type!==ei.Type.Triggered){this.hideLightBulbWidget();return}let e;try{e=await i.actions}catch(t){P(t);return}if(!(this._disposed||this._editor.getSelection()?.startLineNumber!==i.position.lineNumber))if(this._lightBulbWidget.value?.update(e,i.trigger,i.position),i.trigger.type===b.Invoke){if(i.trigger.filter?.include){const r=this.tryGetValidActionToApply(i.trigger,e);if(r){try{this.hideLightBulbWidget(),await this._applyCodeAction(r,!1,!1,f.FromCodeActions)}finally{e.dispose()}return}if(i.trigger.context){const u=this.getInvalidActionThatWouldHaveBeenApplied(i.trigger,e);if(u&&u.action.disabled){I.get(this._editor)?.showMessage(u.action.disabled,i.trigger.context.position),e.dispose();return}}}const t=!!i.trigger.filter?.include;if(i.trigger.context&&(!e.allActions.length||!t&&!e.validActions.length)){I.get(this._editor)?.showMessage(i.trigger.context.notAvailableMessage,i.trigger.context.position),this._activeCodeActions.value=e,e.dispose();return}this._activeCodeActions.value=e,this.showCodeActionList(e,this.toCoords(i.position),{includeDisabledActions:t,fromLightbulb:!1})}else this._actionWidgetService.isVisible?e.dispose():this._activeCodeActions.value=e}getInvalidActionThatWouldHaveBeenApplied(i,e){if(e.allActions.length&&(i.autoApply===v.First&&e.validActions.length===0||i.autoApply===v.IfSingle&&e.allActions.length===1))return e.allActions.find(({action:o})=>o.disabled)}tryGetValidActionToApply(i,e){if(e.validActions.length&&(i.autoApply===v.First&&e.validActions.length>0||i.autoApply===v.IfSingle&&e.validActions.length===1))return e.validActions[0]}static DECORATION=N.register({description:"quickfix-highlight",className:ri});async showCodeActionList(i,e,o){const t=this._editor.createDecorationsCollection(),r=this._editor.getDomNode();if(!r)return;const u=o.includeDisabledActions&&(this._showDisabled||i.validActions.length===0)?i.allActions:i.validActions;if(!u.length)return;const y=F.isIPosition(e)?this.toCoords(e):e,C={onSelect:async(d,p)=>{this._applyCodeAction(d,!0,!!p,o.fromLightbulb?f.FromAILightbulb:f.FromCodeActions),this._actionWidgetService.hide(!1),t.clear()},onHide:d=>{this._editor?.focus(),t.clear()},onHover:async(d,p)=>{if(p.isCancellationRequested)return;let l=!1;const s=d.action.kind;if(s){const n=new ti(s);l=[m.RefactorExtract,m.RefactorInline,m.RefactorRewrite,m.RefactorMove,m.Source].some(L=>L.contains(n))}return{canPreview:l||!!d.action.edit?.edits.length}},onFocus:d=>{if(d&&d.action){const p=d.action.ranges,l=d.action.diagnostics;if(t.clear(),p&&p.length>0){const s=l&&l?.length>1?l.map(n=>({range:n,options:g.DECORATION})):p.map(n=>({range:n,options:g.DECORATION}));t.set(s)}else if(l&&l.length>0){const s=l.map(A=>({range:A,options:g.DECORATION}));t.set(s);const n=l[0];if(n.startLineNumber&&n.startColumn){const A=this._editor.getModel()?.getWordAtPosition({lineNumber:n.startLineNumber,column:n.startColumn})?.word;x.status(_("editingNewSelection","Context: {0} at line {1} and column {2}.",A,n.startLineNumber,n.startColumn))}}}else t.clear()}};this._actionWidgetService.show("codeActionWidget",!0,K(u,this._shouldShowHeaders(),this._resolver.getResolver()),C,y,r,this._getActionBarActions(i,e,o))}toCoords(i){if(!this._editor.hasModel())return{x:0,y:0};this._editor.revealPosition(i,k.Immediate),this._editor.render();const e=this._editor.getScrolledVisiblePosition(i),o=M(this._editor.getDomNode()),t=o.left+e.left,r=o.top+e.top+e.height;return{x:t,y:r}}_shouldShowHeaders(){const i=this._editor?.getModel();return this._configurationService.getValue("editor.codeActionWidget.showHeaders",{resource:i?.uri})}_getActionBarActions(i,e,o){if(o.fromLightbulb)return[];const t=i.documentation.map(r=>({id:r.id,label:r.title,tooltip:r.tooltip??"",class:void 0,enabled:!0,run:()=>this._commandService.executeCommand(r.id,...r.arguments??[])}));return o.includeDisabledActions&&i.validActions.length>0&&i.allActions.length!==i.validActions.length&&t.push(this._showDisabled?{id:"hideMoreActions",label:_("hideMoreActions","Hide Disabled"),enabled:!0,tooltip:"",class:void 0,run:()=>(this._showDisabled=!1,this.showCodeActionList(i,e,o))}:{id:"showMoreActions",label:_("showMoreActions","Show Disabled"),enabled:!0,tooltip:"",class:void 0,run:()=>(this._showDisabled=!0,this.showCodeActionList(i,e,o))}),t}};g=S([c(1,Q),c(2,G),c(3,D),c(4,E),c(5,U),c(6,z),c(7,$),c(8,q),c(9,D),c(10,oi)],g),Y((h,a)=>{((o,t)=>{t&&a.addRule(`.monaco-editor ${o} { background-color: ${t}; }`)})(".quickfix-edit-highlight",h.getColor(j));const e=h.getColor(J);e&&a.addRule(`.monaco-editor .quickfix-edit-highlight { border: 1px ${X(h.type)?"dotted":"solid"} ${e}; box-sizing: border-box; }`)});export{g as CodeActionController};
