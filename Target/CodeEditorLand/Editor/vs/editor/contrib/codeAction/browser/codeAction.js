import{coalesce as T,equals as R,isNonEmptyArray as v}from"../../../../base/common/arrays.js";import{CancellationToken as h}from"../../../../base/common/cancellation.js";import{illegalArgument as w,isCancellationError as E,onUnexpectedExternalError as M}from"../../../../base/common/errors.js";import{HierarchicalKind as g}from"../../../../base/common/hierarchicalKind.js";import{Disposable as D,DisposableStore as K}from"../../../../base/common/lifecycle.js";import{URI as L}from"../../../../base/common/uri.js";import*as N from"../../../../nls.js";import{CommandsRegistry as q,ICommandService as j}from"../../../../platform/commands/common/commands.js";import{INotificationService as z}from"../../../../platform/notification/common/notification.js";import{Progress as B}from"../../../../platform/progress/common/progress.js";import{ITelemetryService as H}from"../../../../platform/telemetry/common/telemetry.js";import{IBulkEditService as U}from"../../../browser/services/bulkEditService.js";import{Range as V}from"../../../common/core/range.js";import{Selection as x}from"../../../common/core/selection.js";import*as P from"../../../common/languages.js";import{ILanguageFeaturesService as O}from"../../../common/services/languageFeatures.js";import{IModelService as Q}from"../../../common/services/model.js";import{TextModelCancellationTokenSource as W}from"../../editorState/browser/editorState.js";import{CodeActionItem as _,CodeActionKind as b,CodeActionTriggerSource as G,filtersAction as J,mayIncludeActionsOfKind as X}from"../common/types.js";const ve="editor.action.codeAction",he="editor.action.quickFix",we="editor.action.autoFix",xe="editor.action.refactor",Pe="editor.action.refactor.preview",be="editor.action.sourceAction",ke="editor.action.organizeImports",Se="editor.action.fixAll";class A extends D{constructor(e,t,o){super();this.documentation=t;this._register(o),this.allActions=[...e].sort(A.codeActionsComparator),this.validActions=this.allActions.filter(({action:r})=>!r.disabled)}static codeActionsPreferredComparator(e,t){return e.isPreferred&&!t.isPreferred?-1:!e.isPreferred&&t.isPreferred?1:0}static codeActionsComparator({action:e},{action:t}){return e.isAI&&!t.isAI?1:!e.isAI&&t.isAI?-1:v(e.diagnostics)?v(t.diagnostics)?A.codeActionsPreferredComparator(e,t):-1:v(t.diagnostics)?1:A.codeActionsPreferredComparator(e,t)}validActions;allActions;get hasAutoFix(){return this.validActions.some(({action:e})=>!!e.kind&&b.QuickFix.contains(new g(e.kind))&&!!e.isPreferred)}get hasAIFix(){return this.validActions.some(({action:e})=>!!e.isAI)}get allAIFixes(){return this.validActions.every(({action:e})=>!!e.isAI)}}const k={actions:[],documentation:void 0};async function Y(i,n,e,t,o,r){const a=t.filter||{},u={...a,excludes:[...a.excludes||[],b.Notebook]},f={only:a.include?.value,trigger:t.type},c=new W(n,r),m=t.type===P.CodeActionTriggerType.Auto,C=Z(i,n,m?u:a),l=new K,S=C.map(async d=>{try{o.report(d);const s=await d.provideCodeActions(n,e,f,c.token);if(s&&l.add(s),c.token.isCancellationRequested)return k;const y=(s?.actions||[]).filter(I=>I&&J(a,I)),p=ee(d,y,a.include);return{actions:y.map(I=>new _(I,d)),documentation:p}}catch(s){if(E(s))throw s;return M(s),k}}),F=i.onDidChange(()=>{const d=i.all(n);R(d,C)||c.cancel()});try{const d=await Promise.all(S),s=d.flatMap(p=>p.actions),y=[...T(d.map(p=>p.documentation)),...$(i,n,t,s)];return new A(s,y,l)}finally{F.dispose(),c.dispose()}}function Z(i,n,e){return i.all(n).filter(t=>t.providedCodeActionKinds?t.providedCodeActionKinds.some(o=>X(e,new g(o))):!0)}function*$(i,n,e,t){if(n&&t.length)for(const o of i.all(n))o._getAdditionalMenuItems&&(yield*o._getAdditionalMenuItems?.({trigger:e.type,only:e.filter?.include?.value},t.map(r=>r.action)))}function ee(i,n,e){if(!i.documentation)return;const t=i.documentation.map(o=>({kind:new g(o.kind),command:o.command}));if(e){let o;for(const r of t)r.kind.contains(e)&&(o?o.kind.contains(r.kind)&&(o=r):o=r);if(o)return o?.command}for(const o of n)if(o.kind){for(const r of t)if(r.kind.contains(new g(o.kind)))return r.command}}var oe=(o=>(o.OnSave="onSave",o.FromProblemsView="fromProblemsView",o.FromCodeActions="fromCodeActions",o.FromAILightbulb="fromAILightbulb",o))(oe||{});async function Fe(i,n,e,t,o=h.None){const r=i.get(U),a=i.get(j),u=i.get(H),f=i.get(z);if(u.publicLog2("codeAction.applyCodeAction",{codeActionTitle:n.action.title,codeActionKind:n.action.kind,codeActionIsPreferred:!!n.action.isPreferred,reason:e}),await n.resolve(o),!o.isCancellationRequested&&!(n.action.edit?.edits.length&&!(await r.apply(n.action.edit,{editor:t?.editor,label:n.action.title,quotableLabel:n.action.title,code:"undoredo.codeAction",respectAutoSaveConfig:e!=="onSave",showPreview:t?.preview})).isApplied)&&n.action.command)try{await a.executeCommand(n.action.command.id,...n.action.command.arguments||[])}catch(c){const m=te(c);f.error(typeof m=="string"?m:N.localize("applyCodeActionFailed","An unknown error occurred while applying the code action"))}}function te(i){return typeof i=="string"?i:i instanceof Error&&typeof i.message=="string"?i.message:void 0}q.registerCommand("_executeCodeActionProvider",async(i,n,e,t,o)=>{if(!(n instanceof L))throw w();const{codeActionProvider:r}=i.get(O),a=i.get(Q).getModel(n);if(!a)throw w();const u=x.isISelection(e)?x.liftSelection(e):V.isIRange(e)?a.validateRange(e):void 0;if(!u)throw w();const f=typeof t=="string"?new g(t):void 0,c=await Y(r,a,u,{type:P.CodeActionTriggerType.Invoke,triggerAction:G.Default,filter:{includeSourceActions:!0,include:f}},B.None,h.None),m=[],C=Math.min(c.validActions.length,typeof o=="number"?o:0);for(let l=0;l<C;l++)m.push(c.validActions[l].resolve(h.None));try{return await Promise.all(m),c.validActions.map(l=>l.action)}finally{setTimeout(()=>c.dispose(),100)}});export{oe as ApplyCodeActionReason,Fe as applyCodeAction,we as autoFixCommandId,ve as codeActionCommandId,Se as fixAllCommandId,Y as getCodeActions,ke as organizeImportsCommandId,he as quickFixCommandId,xe as refactorCommandId,Pe as refactorPreviewCommandId,be as sourceActionCommandId};
