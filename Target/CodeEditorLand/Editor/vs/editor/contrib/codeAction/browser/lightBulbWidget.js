var X=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var x=(p,c,t,i)=>{for(var e=i>1?void 0:i?$(c,t):c,s=p.length-1,o;s>=0;s--)(o=p[s])&&(e=(i?o(c,t,e):o(e))||e);return i&&e&&X(c,t,e),e},N=(p,c)=>(t,i)=>c(t,i,p);import*as f from"../../../../../vs/base/browser/dom.js";import{Gesture as Q}from"../../../../../vs/base/browser/touch.js";import{Codicon as r}from"../../../../../vs/base/common/codicons.js";import{Emitter as j,Event as J}from"../../../../../vs/base/common/event.js";import{Disposable as V}from"../../../../../vs/base/common/lifecycle.js";import{ThemeIcon as D}from"../../../../../vs/base/common/themables.js";import"vs/css!./lightBulbWidget";import{ContentWidgetPositionPreference as Y}from"../../../../../vs/editor/browser/editorBrowser.js";import{EditorOption as v}from"../../../../../vs/editor/common/config/editorOptions.js";import"../../../../../vs/editor/common/core/position.js";import{Range as k}from"../../../../../vs/editor/common/core/range.js";import{GlyphMarginLane as E,TrackedRangeStickiness as F}from"../../../../../vs/editor/common/model.js";import{ModelDecorationOptions as G}from"../../../../../vs/editor/common/model/textModel.js";import{computeIndentLevel as Z}from"../../../../../vs/editor/common/model/utils.js";import{autoFixCommandId as tt,quickFixCommandId as et}from"../../../../../vs/editor/contrib/codeAction/browser/codeAction.js";import"../../../../../vs/editor/contrib/codeAction/common/types.js";import*as h from"../../../../../vs/nls.js";import{IKeybindingService as it}from"../../../../../vs/platform/keybinding/common/keybinding.js";import{registerIcon as _}from"../../../../../vs/platform/theme/common/iconRegistry.js";const P=_("gutter-lightbulb",r.lightBulb,h.localize("gutterLightbulbWidget","Icon which spawns code actions menu from the gutter when there is no space in the editor.")),H=_("gutter-lightbulb-auto-fix",r.lightbulbAutofix,h.localize("gutterLightbulbAutoFixWidget","Icon which spawns code actions menu from the gutter when there is no space in the editor and a quick fix is available.")),O=_("gutter-lightbulb-sparkle",r.lightbulbSparkle,h.localize("gutterLightbulbAIFixWidget","Icon which spawns code actions menu from the gutter when there is no space in the editor and an AI fix is available.")),M=_("gutter-lightbulb-aifix-auto-fix",r.lightbulbSparkleAutofix,h.localize("gutterLightbulbAIFixAutoFixWidget","Icon which spawns code actions menu from the gutter when there is no space in the editor and an AI fix and a quick fix is available.")),B=_("gutter-lightbulb-sparkle-filled",r.sparkleFilled,h.localize("gutterLightbulbSparkleFilledWidget","Icon which spawns code actions menu from the gutter when there is no space in the editor and an AI fix and a quick fix is available."));var a;(i=>{let p;(o=>(o[o.Hidden=0]="Hidden",o[o.Showing=1]="Showing"))(p=i.Type||={}),i.Hidden={type:0};class t{constructor(s,o,n,u){this.actions=s;this.trigger=o;this.editorPosition=n;this.widgetPosition=u}type=1}i.Showing=t})(a||={});let l=class extends V{constructor(t,i){super();this._editor=t;this._keybindingService=i;this._domNode=f.$("div.lightBulbWidget"),this._domNode.role="listbox",this._register(Q.ignoreTarget(this._domNode)),this._editor.addContentWidget(this),this._register(this._editor.onDidChangeModelContent(e=>{const s=this._editor.getModel();(this.state.type!==1||!s||this.state.editorPosition.lineNumber>=s.getLineCount())&&this.hide(),(this.gutterState.type!==1||!s||this.gutterState.editorPosition.lineNumber>=s.getLineCount())&&this.gutterHide()})),this._register(f.addStandardDisposableGenericMouseDownListener(this._domNode,e=>{if(this.state.type!==1)return;this._editor.focus(),e.preventDefault();const{top:s,height:o}=f.getDomNodePagePosition(this._domNode),n=this._editor.getOption(v.lineHeight);let u=Math.floor(n/3);this.state.widgetPosition.position!==null&&this.state.widgetPosition.position.lineNumber<this.state.editorPosition.lineNumber&&(u+=n),this._onClick.fire({x:e.posx,y:s+o+u,actions:this.state.actions,trigger:this.state.trigger})})),this._register(f.addDisposableListener(this._domNode,"mouseenter",e=>{(e.buttons&1)===1&&this.hide()})),this._register(J.runAndSubscribe(this._keybindingService.onDidUpdateKeybindings,()=>{this._preferredKbLabel=this._keybindingService.lookupKeybinding(tt)?.getLabel()??void 0,this._quickFixKbLabel=this._keybindingService.lookupKeybinding(et)?.getLabel()??void 0,this._updateLightBulbTitleAndIcon()})),this._register(this._editor.onMouseDown(async e=>{const s=["codicon-"+P.id,"codicon-"+M.id,"codicon-"+H.id,"codicon-"+O.id,"codicon-"+B.id];if(!e.target.element||!s.some(S=>e.target.element&&e.target.element.classList.contains(S))||this.gutterState.type!==1)return;this._editor.focus();const{top:o,height:n}=f.getDomNodePagePosition(e.target.element),u=this._editor.getOption(v.lineHeight);let I=Math.floor(u/3);this.gutterState.widgetPosition.position!==null&&this.gutterState.widgetPosition.position.lineNumber<this.gutterState.editorPosition.lineNumber&&(I+=u),this._onClick.fire({x:e.event.posx,y:o+n+I,actions:this.gutterState.actions,trigger:this.gutterState.trigger})}))}_gutterDecorationID;static GUTTER_DECORATION=G.register({description:"codicon-gutter-lightbulb-decoration",glyphMarginClassName:D.asClassName(r.lightBulb),glyphMargin:{position:E.Left},stickiness:F.NeverGrowsWhenTypingAtEdges});static ID="editor.contrib.lightbulbWidget";static _posPref=[Y.EXACT];_domNode;_onClick=this._register(new j);onClick=this._onClick.event;_state=a.Hidden;_gutterState=a.Hidden;_iconClasses=[];_preferredKbLabel;_quickFixKbLabel;gutterDecoration=l.GUTTER_DECORATION;dispose(){super.dispose(),this._editor.removeContentWidget(this),this._gutterDecorationID&&this._removeGutterDecoration(this._gutterDecorationID)}getId(){return"LightBulbWidget"}getDomNode(){return this._domNode}getPosition(){return this._state.type===1?this._state.widgetPosition:null}update(t,i,e){if(t.validActions.length<=0)return this.gutterHide(),this.hide();if(!this._editor.getOptions().get(v.lightbulb).enabled)return this.gutterHide(),this.hide();const o=this._editor.getModel();if(!o)return this.gutterHide(),this.hide();const{lineNumber:n,column:u}=o.validatePosition(e),I=o.getOptions().tabSize,S=this._editor.getOptions().get(v.fontInfo),R=o.getLineContent(n),W=Z(R,I),K=S.spaceWidth*W>22,y=d=>d>2&&this._editor.getTopForLineNumber(d)===this._editor.getTopForLineNumber(d-1);let g=n,b=1;if(!K){const d=L=>{const m=o.getLineContent(L);return/^\s*$|^\s+/.test(m)||m.length<=b};if(n>1&&!y(n-1)){const L=o.getLineCount(),m=n===L,C=n>1&&d(n-1),A=!m&&d(n+1),T=d(n),w=!A&&!C,q=!!this._editor.getLineDecorations(n)?.length;if(!A&&!C&&!q)return this.gutterState=new a.Showing(t,i,e,{position:{lineNumber:g,column:b},preference:l._posPref}),this.renderGutterLightbub(),this.hide();C||m||w&&!T?g-=1:(A||w&&T)&&(g+=1)}else{if(n===1&&(n===o.getLineCount()||!d(n+1)&&!d(n)))return this.gutterState=new a.Showing(t,i,e,{position:{lineNumber:g,column:b},preference:l._posPref}),this.renderGutterLightbub(),this.hide();if(n<o.getLineCount()&&!y(n+1))g+=1;else if(u*S.spaceWidth<22)return this.hide()}b=/^\S\s*$/.test(o.getLineContent(g))?2:1}this.state=new a.Showing(t,i,e,{position:{lineNumber:g,column:b},preference:l._posPref}),this._gutterDecorationID&&(this._removeGutterDecoration(this._gutterDecorationID),this.gutterHide());const U=t.validActions,z=t.validActions[0].action.kind;if(U.length!==1||!z){this._editor.layoutContentWidget(this);return}this._editor.layoutContentWidget(this)}hide(){this.state!==a.Hidden&&(this.state=a.Hidden,this._editor.layoutContentWidget(this))}gutterHide(){this.gutterState!==a.Hidden&&(this._gutterDecorationID&&this._removeGutterDecoration(this._gutterDecorationID),this.gutterState=a.Hidden)}get state(){return this._state}set state(t){this._state=t,this._updateLightBulbTitleAndIcon()}get gutterState(){return this._gutterState}set gutterState(t){this._gutterState=t,this._updateGutterLightBulbTitleAndIcon()}_updateLightBulbTitleAndIcon(){if(this._domNode.classList.remove(...this._iconClasses),this._iconClasses=[],this.state.type!==1)return;let t,i=!1;this.state.actions.allAIFixes?(t=r.sparkleFilled,this.state.actions.validActions.length===1&&(i=!0)):this.state.actions.hasAutoFix?this.state.actions.hasAIFix?t=r.lightbulbSparkleAutofix:t=r.lightbulbAutofix:this.state.actions.hasAIFix?t=r.lightbulbSparkle:t=r.lightBulb,this._updateLightbulbTitle(this.state.actions.hasAutoFix,i),this._iconClasses=D.asClassNameArray(t),this._domNode.classList.add(...this._iconClasses)}_updateGutterLightBulbTitleAndIcon(){if(this.gutterState.type!==1)return;let t,i=!1;this.gutterState.actions.allAIFixes?(t=B,this.gutterState.actions.validActions.length===1&&(i=!0)):this.gutterState.actions.hasAutoFix?this.gutterState.actions.hasAIFix?t=M:t=H:this.gutterState.actions.hasAIFix?t=O:t=P,this._updateLightbulbTitle(this.gutterState.actions.hasAutoFix,i);const e=G.register({description:"codicon-gutter-lightbulb-decoration",glyphMarginClassName:D.asClassName(t),glyphMargin:{position:E.Left},stickiness:F.NeverGrowsWhenTypingAtEdges});this.gutterDecoration=e}renderGutterLightbub(){const t=this._editor.getSelection();t&&(this._gutterDecorationID===void 0?this._addGutterDecoration(t.startLineNumber):this._updateGutterDecoration(this._gutterDecorationID,t.startLineNumber))}_addGutterDecoration(t){this._editor.changeDecorations(i=>{this._gutterDecorationID=i.addDecoration(new k(t,0,t,0),this.gutterDecoration)})}_removeGutterDecoration(t){this._editor.changeDecorations(i=>{i.removeDecoration(t),this._gutterDecorationID=void 0})}_updateGutterDecoration(t,i){this._editor.changeDecorations(e=>{e.changeDecoration(t,new k(i,0,i,0)),e.changeDecorationOptions(t,this.gutterDecoration)})}_updateLightbulbTitle(t,i){this.state.type===1&&(i?this.title=h.localize("codeActionAutoRun","Run: {0}",this.state.actions.validActions[0].action.title):t&&this._preferredKbLabel?this.title=h.localize("preferredcodeActionWithKb","Show Code Actions. Preferred Quick Fix Available ({0})",this._preferredKbLabel):!t&&this._quickFixKbLabel?this.title=h.localize("codeActionWithKb","Show Code Actions ({0})",this._quickFixKbLabel):t||(this.title=h.localize("codeAction","Show Code Actions")))}set title(t){this._domNode.title=t}};l=x([N(1,it)],l);export{l as LightBulbWidget};
