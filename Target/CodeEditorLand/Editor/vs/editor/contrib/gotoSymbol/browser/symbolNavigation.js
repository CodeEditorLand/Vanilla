var E=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var m=(o,e,t,i)=>{for(var r=i>1?void 0:i?x(e,t):e,c=o.length-1,s;c>=0;c--)(s=o[c])&&(r=(i?s(e,t,r):s(r))||r);return i&&r&&E(e,t,r),r},n=(o,e)=>(t,i)=>e(t,i,o);import{Emitter as D}from"../../../../base/common/event.js";import{KeyCode as y}from"../../../../base/common/keyCodes.js";import{combinedDisposable as b,DisposableStore as M,dispose as R}from"../../../../base/common/lifecycle.js";import{isEqual as w}from"../../../../base/common/resources.js";import"../../../browser/editorBrowser.js";import{EditorCommand as K,registerEditorCommand as N}from"../../../browser/editorExtensions.js";import{ICodeEditorService as C}from"../../../browser/services/codeEditorService.js";import{Range as I}from"../../../common/core/range.js";import"./referencesModel.js";import{localize as p}from"../../../../nls.js";import{IContextKeyService as k,RawContextKey as A}from"../../../../platform/contextkey/common/contextkey.js";import{TextEditorSelectionRevealType as P}from"../../../../platform/editor/common/editor.js";import{InstantiationType as T,registerSingleton as O}from"../../../../platform/instantiation/common/extensions.js";import{createDecorator as H}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as F}from"../../../../platform/keybinding/common/keybinding.js";import{KeybindingsRegistry as B,KeybindingWeight as S}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{INotificationService as W}from"../../../../platform/notification/common/notification.js";const _=new A("hasSymbols",!1,p("hasSymbols","Whether there are symbol locations that can be navigated via keyboard-only.")),f=H("ISymbolNavigationService");let d=class{constructor(e,t,i,r){this._editorService=t;this._notificationService=i;this._keybindingService=r;this._ctxHasSymbols=_.bindTo(e)}_ctxHasSymbols;_currentModel=void 0;_currentIdx=-1;_currentState;_currentMessage;_ignoreEditorChange=!1;reset(){this._ctxHasSymbols.reset(),this._currentState?.dispose(),this._currentMessage?.dispose(),this._currentModel=void 0,this._currentIdx=-1}put(e){const t=e.parent.parent;if(t.references.length<=1){this.reset();return}this._currentModel=t,this._currentIdx=t.references.indexOf(e),this._ctxHasSymbols.set(!0),this._showMessage();const i=new a(this._editorService),r=i.onDidChange(c=>{if(this._ignoreEditorChange)return;const s=this._editorService.getActiveCodeEditor();if(!s)return;const v=s.getModel(),g=s.getPosition();if(!v||!g)return;let l=!1,h=!1;for(const u of t.references)if(w(u.uri,v.uri))l=!0,h=h||I.containsPosition(u.range,g);else if(l)break;(!l||!h)&&this.reset()});this._currentState=b(i,r)}revealNext(e){if(!this._currentModel)return Promise.resolve();this._currentIdx+=1,this._currentIdx%=this._currentModel.references.length;const t=this._currentModel.references[this._currentIdx];return this._showMessage(),this._ignoreEditorChange=!0,this._editorService.openCodeEditor({resource:t.uri,options:{selection:I.collapseToStart(t.range),selectionRevealType:P.NearTopIfOutsideViewport}},e).finally(()=>{this._ignoreEditorChange=!1})}_showMessage(){this._currentMessage?.dispose();const e=this._keybindingService.lookupKeybinding("editor.gotoNextSymbolFromResult"),t=e?p("location.kb","Symbol {0} of {1}, {2} for next",this._currentIdx+1,this._currentModel.references.length,e.getLabel()):p("location","Symbol {0} of {1}",this._currentIdx+1,this._currentModel.references.length);this._currentMessage=this._notificationService.status(t)}};d=m([n(0,k),n(1,C),n(2,W),n(3,F)],d),O(f,d,T.Delayed),N(new class extends K{constructor(){super({id:"editor.gotoNextSymbolFromResult",precondition:_,kbOpts:{weight:S.EditorContrib,primary:y.F12}})}runEditorCommand(o,e){return o.get(f).revealNext(e)}}),B.registerCommandAndKeybindingRule({id:"editor.gotoNextSymbolFromResult.cancel",weight:S.EditorContrib,when:_,primary:y.Escape,handler(o){o.get(f).reset()}});let a=class{_listener=new Map;_disposables=new M;_onDidChange=new D;onDidChange=this._onDidChange.event;constructor(e){this._disposables.add(e.onCodeEditorRemove(this._onDidRemoveEditor,this)),this._disposables.add(e.onCodeEditorAdd(this._onDidAddEditor,this)),e.listCodeEditors().forEach(this._onDidAddEditor,this)}dispose(){this._disposables.dispose(),this._onDidChange.dispose(),R(this._listener.values())}_onDidAddEditor(e){this._listener.set(e,b(e.onDidChangeCursorPosition(t=>this._onDidChange.fire({editor:e})),e.onDidChangeModelContent(t=>this._onDidChange.fire({editor:e}))))}_onDidRemoveEditor(e){this._listener.get(e)?.dispose(),this._listener.delete(e)}};a=m([n(0,C)],a);export{f as ISymbolNavigationService,_ as ctxHasSymbols};
