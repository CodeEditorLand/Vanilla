import{alert as se}from"../../../../base/browser/ui/aria/aria.js";import{createCancelablePromise as j,raceCancellation as de}from"../../../../base/common/async.js";import{Iterable as ce}from"../../../../base/common/iterator.js";import{KeyChord as q,KeyCode as g,KeyMod as f}from"../../../../base/common/keyCodes.js";import{assertType as k}from"../../../../base/common/types.js";import{URI as D}from"../../../../base/common/uri.js";import*as i from"../../../../nls.js";import{MenuId as s,MenuRegistry as le,registerAction2 as I}from"../../../../platform/actions/common/actions.js";import{CommandsRegistry as A,ICommandService as me}from"../../../../platform/commands/common/commands.js";import{ContextKeyExpr as u}from"../../../../platform/contextkey/common/contextkey.js";import{IsWebContext as B}from"../../../../platform/contextkey/common/contextkeys.js";import{TextEditorSelectionRevealType as pe,TextEditorSelectionSource as ue}from"../../../../platform/editor/common/editor.js";import{IInstantiationService as U}from"../../../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as P}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{INotificationService as ge}from"../../../../platform/notification/common/notification.js";import{IEditorProgressService as fe}from"../../../../platform/progress/common/progress.js";import{isCodeEditor as H}from"../../../browser/editorBrowser.js";import{EditorAction2 as Ie}from"../../../browser/editorExtensions.js";import{ICodeEditorService as _}from"../../../browser/services/codeEditorService.js";import{EmbeddedCodeEditorWidget as ve}from"../../../browser/widget/codeEditor/embeddedCodeEditorWidget.js";import{EditorOption as v}from"../../../common/config/editorOptions.js";import*as M from"../../../common/core/position.js";import{Range as J}from"../../../common/core/range.js";import{ScrollType as ye}from"../../../common/editorCommon.js";import{EditorContextKeys as r}from"../../../common/editorContextKeys.js";import{isLocationLink as Pe}from"../../../common/languages.js";import{ILanguageFeaturesService as Q}from"../../../common/services/languageFeatures.js";import{CodeEditorStateFlag as X,EditorStateCancellationTokenSource as Ce}from"../../editorState/browser/editorState.js";import{MessageController as Te}from"../../message/browser/messageController.js";import{PeekContext as b}from"../../peekView/browser/peekView.js";import{getDeclarationsAtPosition as he,getDefinitionsAtPosition as ke,getImplementationsAtPosition as Ae,getReferencesAtPosition as N,getTypeDefinitionsAtPosition as be}from"./goToSymbol.js";import{ReferencesController as Y}from"./peek/referencesController.js";import{ReferencesModel as C}from"./referencesModel.js";import{ISymbolNavigationService as Ee}from"./symbolNavigation.js";le.appendMenuItem(s.EditorContext,{submenu:s.EditorContextPeek,title:i.localize("peek.submenu","Peek"),group:"navigation",order:100});class x{constructor(e,o){this.model=e;this.position=o}static is(e){return!e||typeof e!="object"?!1:!!(e instanceof x||M.Position.isIPosition(e.position)&&e.model)}}class m extends Ie{static _allSymbolNavigationCommands=new Map;static _activeAlternativeCommands=new Set;static all(){return m._allSymbolNavigationCommands.values()}static _patchConfig(e){const o={...e,f1:!0};if(o.menu)for(const t of ce.wrap(o.menu))(t.id===s.EditorContext||t.id===s.EditorContextPeek)&&(t.when=u.and(e.precondition,t.when));return o}configuration;constructor(e,o){super(m._patchConfig(o)),this.configuration=e,m._allSymbolNavigationCommands.set(o.id,this)}runEditorCommand(e,o,t,n){if(!o.hasModel())return Promise.resolve(void 0);const d=e.get(ge),a=e.get(_),l=e.get(fe),p=e.get(Ee),y=e.get(Q),E=e.get(U),S=o.getModel(),w=o.getPosition(),W=x.is(t)?t:new x(S,w),R=new Ce(o,X.Value|X.Position),V=de(this._getLocationModel(y,W.model,W.position,R.token),R.token).then(async T=>{if(!T||R.token.isCancellationRequested)return;se(T.ariaMessage);let L;if(T.referenceAt(S.uri,w)){const h=this._getAlternativeCommand(o);!m._activeAlternativeCommands.has(h)&&m._allSymbolNavigationCommands.has(h)&&(L=m._allSymbolNavigationCommands.get(h))}const K=T.references.length;if(K===0){if(!this.configuration.muteMessage){const h=S.getWordAtPosition(w);Te.get(o)?.showMessage(this._getNoResultFoundMessage(h),w)}}else if(K===1&&L)m._activeAlternativeCommands.add(this.desc.id),E.invokeFunction(h=>L.runEditorCommand(h,o,t,n).finally(()=>{m._activeAlternativeCommands.delete(this.desc.id)}));else return this._onResult(a,p,o,T,n)},T=>{d.error(T)}).finally(()=>{R.dispose()});return l.showWhile(V,250),V}async _onResult(e,o,t,n,d){const a=this._getGoToPreference(t);if(!(t instanceof ve)&&(this.configuration.openInPeek||a==="peek"&&n.references.length>1))this._openInPeek(t,n,d);else{const l=n.firstReference(),p=n.references.length>1&&a==="gotoAndPeek",y=await this._openReference(t,e,l,this.configuration.openToSide,!p);p&&y?this._openInPeek(y,n,d):n.dispose(),a==="goto"&&o.put(l)}}async _openReference(e,o,t,n,d){let a;if(Pe(t)&&(a=t.targetSelectionRange),a||(a=t.range),!a)return;const l=await o.openCodeEditor({resource:t.uri,options:{selection:J.collapseToStart(a),selectionRevealType:pe.NearTopIfOutsideViewport,selectionSource:ue.JUMP}},e,n);if(l){if(d){const p=l.getModel(),y=l.createDecorationsCollection([{range:a,options:{description:"symbol-navigate-action-highlight",className:"symbolHighlight"}}]);setTimeout(()=>{l.getModel()===p&&y.clear()},350)}return l}}_openInPeek(e,o,t){const n=Y.get(e);n&&e.hasModel()?n.toggleWidget(t??e.getSelection(),j(d=>Promise.resolve(o)),this.configuration.openInPeek):o.dispose()}}class F extends m{async _getLocationModel(e,o,t,n){return new C(await ke(e.definitionProvider,o,t,!1,n),i.localize("def.title","Definitions"))}_getNoResultFoundMessage(e){return e&&e.word?i.localize("noResultWord","No definition found for '{0}'",e.word):i.localize("generic.noResults","No definition found")}_getAlternativeCommand(e){return e.getOption(v.gotoLocation).alternativeDefinitionCommand}_getGoToPreference(e){return e.getOption(v.gotoLocation).multipleDefinitions}}I(class G extends F{static id="editor.action.revealDefinition";constructor(){super({openToSide:!1,openInPeek:!1,muteMessage:!1},{id:G.id,title:{...i.localize2("actions.goToDecl.label","Go to Definition"),mnemonicTitle:i.localize({key:"miGotoDefinition",comment:["&& denotes a mnemonic"]},"Go to &&Definition")},precondition:r.hasDefinitionProvider,keybinding:[{when:r.editorTextFocus,primary:g.F12,weight:P.EditorContrib},{when:u.and(r.editorTextFocus,B),primary:f.CtrlCmd|g.F12,weight:P.EditorContrib}],menu:[{id:s.EditorContext,group:"navigation",order:1.1},{id:s.MenubarGoMenu,precondition:null,group:"4_symbol_nav",order:2}]}),A.registerCommandAlias("editor.action.goToDeclaration",G.id)}}),I(class z extends F{static id="editor.action.revealDefinitionAside";constructor(){super({openToSide:!0,openInPeek:!1,muteMessage:!1},{id:z.id,title:i.localize2("actions.goToDeclToSide.label","Open Definition to the Side"),precondition:u.and(r.hasDefinitionProvider,r.isInEmbeddedEditor.toNegated()),keybinding:[{when:r.editorTextFocus,primary:q(f.CtrlCmd|g.KeyK,g.F12),weight:P.EditorContrib},{when:u.and(r.editorTextFocus,B),primary:q(f.CtrlCmd|g.KeyK,f.CtrlCmd|g.F12),weight:P.EditorContrib}]}),A.registerCommandAlias("editor.action.openDeclarationToTheSide",z.id)}}),I(class O extends F{static id="editor.action.peekDefinition";constructor(){super({openToSide:!1,openInPeek:!0,muteMessage:!1},{id:O.id,title:i.localize2("actions.previewDecl.label","Peek Definition"),precondition:u.and(r.hasDefinitionProvider,b.notInPeekEditor,r.isInEmbeddedEditor.toNegated()),keybinding:{when:r.editorTextFocus,primary:f.Alt|g.F12,linux:{primary:f.CtrlCmd|f.Shift|g.F10},weight:P.EditorContrib},menu:{id:s.EditorContextPeek,group:"peek",order:2}}),A.registerCommandAlias("editor.action.previewDeclaration",O.id)}});class Z extends m{async _getLocationModel(e,o,t,n){return new C(await he(e.declarationProvider,o,t,!1,n),i.localize("decl.title","Declarations"))}_getNoResultFoundMessage(e){return e&&e.word?i.localize("decl.noResultWord","No declaration found for '{0}'",e.word):i.localize("decl.generic.noResults","No declaration found")}_getAlternativeCommand(e){return e.getOption(v.gotoLocation).alternativeDeclarationCommand}_getGoToPreference(e){return e.getOption(v.gotoLocation).multipleDeclarations}}I(class te extends Z{static id="editor.action.revealDeclaration";constructor(){super({openToSide:!1,openInPeek:!1,muteMessage:!1},{id:te.id,title:{...i.localize2("actions.goToDeclaration.label","Go to Declaration"),mnemonicTitle:i.localize({key:"miGotoDeclaration",comment:["&& denotes a mnemonic"]},"Go to &&Declaration")},precondition:u.and(r.hasDeclarationProvider,r.isInEmbeddedEditor.toNegated()),menu:[{id:s.EditorContext,group:"navigation",order:1.3},{id:s.MenubarGoMenu,precondition:null,group:"4_symbol_nav",order:3}]})}_getNoResultFoundMessage(e){return e&&e.word?i.localize("decl.noResultWord","No declaration found for '{0}'",e.word):i.localize("decl.generic.noResults","No declaration found")}}),I(class extends Z{constructor(){super({openToSide:!1,openInPeek:!0,muteMessage:!1},{id:"editor.action.peekDeclaration",title:i.localize2("actions.peekDecl.label","Peek Declaration"),precondition:u.and(r.hasDeclarationProvider,b.notInPeekEditor,r.isInEmbeddedEditor.toNegated()),menu:{id:s.EditorContextPeek,group:"peek",order:3}})}});class $ extends m{async _getLocationModel(e,o,t,n){return new C(await be(e.typeDefinitionProvider,o,t,!1,n),i.localize("typedef.title","Type Definitions"))}_getNoResultFoundMessage(e){return e&&e.word?i.localize("goToTypeDefinition.noResultWord","No type definition found for '{0}'",e.word):i.localize("goToTypeDefinition.generic.noResults","No type definition found")}_getAlternativeCommand(e){return e.getOption(v.gotoLocation).alternativeTypeDefinitionCommand}_getGoToPreference(e){return e.getOption(v.gotoLocation).multipleTypeDefinitions}}I(class ie extends ${static ID="editor.action.goToTypeDefinition";constructor(){super({openToSide:!1,openInPeek:!1,muteMessage:!1},{id:ie.ID,title:{...i.localize2("actions.goToTypeDefinition.label","Go to Type Definition"),mnemonicTitle:i.localize({key:"miGotoTypeDefinition",comment:["&& denotes a mnemonic"]},"Go to &&Type Definition")},precondition:r.hasTypeDefinitionProvider,keybinding:{when:r.editorTextFocus,primary:0,weight:P.EditorContrib},menu:[{id:s.EditorContext,group:"navigation",order:1.4},{id:s.MenubarGoMenu,precondition:null,group:"4_symbol_nav",order:3}]})}}),I(class ne extends ${static ID="editor.action.peekTypeDefinition";constructor(){super({openToSide:!1,openInPeek:!0,muteMessage:!1},{id:ne.ID,title:i.localize2("actions.peekTypeDefinition.label","Peek Type Definition"),precondition:u.and(r.hasTypeDefinitionProvider,b.notInPeekEditor,r.isInEmbeddedEditor.toNegated()),menu:{id:s.EditorContextPeek,group:"peek",order:4}})}});class ee extends m{async _getLocationModel(e,o,t,n){return new C(await Ae(e.implementationProvider,o,t,!1,n),i.localize("impl.title","Implementations"))}_getNoResultFoundMessage(e){return e&&e.word?i.localize("goToImplementation.noResultWord","No implementation found for '{0}'",e.word):i.localize("goToImplementation.generic.noResults","No implementation found")}_getAlternativeCommand(e){return e.getOption(v.gotoLocation).alternativeImplementationCommand}_getGoToPreference(e){return e.getOption(v.gotoLocation).multipleImplementations}}I(class re extends ee{static ID="editor.action.goToImplementation";constructor(){super({openToSide:!1,openInPeek:!1,muteMessage:!1},{id:re.ID,title:{...i.localize2("actions.goToImplementation.label","Go to Implementations"),mnemonicTitle:i.localize({key:"miGotoImplementation",comment:["&& denotes a mnemonic"]},"Go to &&Implementations")},precondition:r.hasImplementationProvider,keybinding:{when:r.editorTextFocus,primary:f.CtrlCmd|g.F12,weight:P.EditorContrib},menu:[{id:s.EditorContext,group:"navigation",order:1.45},{id:s.MenubarGoMenu,precondition:null,group:"4_symbol_nav",order:4}]})}}),I(class ae extends ee{static ID="editor.action.peekImplementation";constructor(){super({openToSide:!1,openInPeek:!0,muteMessage:!1},{id:ae.ID,title:i.localize2("actions.peekImplementation.label","Peek Implementations"),precondition:u.and(r.hasImplementationProvider,b.notInPeekEditor,r.isInEmbeddedEditor.toNegated()),keybinding:{when:r.editorTextFocus,primary:f.CtrlCmd|f.Shift|g.F12,weight:P.EditorContrib},menu:{id:s.EditorContextPeek,group:"peek",order:5}})}});class oe extends m{_getNoResultFoundMessage(e){return e?i.localize("references.no","No references found for '{0}'",e.word):i.localize("references.noGeneric","No references found")}_getAlternativeCommand(e){return e.getOption(v.gotoLocation).alternativeReferenceCommand}_getGoToPreference(e){return e.getOption(v.gotoLocation).multipleReferences}}I(class extends oe{constructor(){super({openToSide:!1,openInPeek:!1,muteMessage:!1},{id:"editor.action.goToReferences",title:{...i.localize2("goToReferences.label","Go to References"),mnemonicTitle:i.localize({key:"miGotoReference",comment:["&& denotes a mnemonic"]},"Go to &&References")},precondition:u.and(r.hasReferenceProvider,b.notInPeekEditor,r.isInEmbeddedEditor.toNegated()),keybinding:{when:r.editorTextFocus,primary:f.Shift|g.F12,weight:P.EditorContrib},menu:[{id:s.EditorContext,group:"navigation",order:1.45},{id:s.MenubarGoMenu,precondition:null,group:"4_symbol_nav",order:5}]})}async _getLocationModel(e,o,t,n){return new C(await N(e.referenceProvider,o,t,!0,!1,n),i.localize("ref.title","References"))}}),I(class extends oe{constructor(){super({openToSide:!1,openInPeek:!0,muteMessage:!1},{id:"editor.action.referenceSearch.trigger",title:i.localize2("references.action.label","Peek References"),precondition:u.and(r.hasReferenceProvider,b.notInPeekEditor,r.isInEmbeddedEditor.toNegated()),menu:{id:s.EditorContextPeek,group:"peek",order:6}})}async _getLocationModel(e,o,t,n){return new C(await N(e.referenceProvider,o,t,!1,!1,n),i.localize("ref.title","References"))}});class Me extends m{constructor(o,t,n){super(o,{id:"editor.action.goToLocation",title:i.localize2("label.generic","Go to Any Symbol"),precondition:u.and(b.notInPeekEditor,r.isInEmbeddedEditor.toNegated())});this._references=t;this._gotoMultipleBehaviour=n}async _getLocationModel(o,t,n,d){return new C(this._references,i.localize("generic.title","Locations"))}_getNoResultFoundMessage(o){return o&&i.localize("generic.noResult","No results for '{0}'",o.word)||""}_getGoToPreference(o){return this._gotoMultipleBehaviour??o.getOption(v.gotoLocation).multipleReferences}_getAlternativeCommand(){return""}}A.registerCommand({id:"editor.action.goToLocations",metadata:{description:"Go to locations from a position in a file",args:[{name:"uri",description:"The text document in which to start",constraint:D},{name:"position",description:"The position at which to start",constraint:M.Position.isIPosition},{name:"locations",description:"An array of locations.",constraint:Array},{name:"multiple",description:"Define what to do when having multiple results, either `peek`, `gotoAndPeek`, or `goto`"},{name:"noResultsMessage",description:"Human readable message that shows when locations is empty."}]},handler:async(c,e,o,t,n,d,a)=>{k(D.isUri(e)),k(M.Position.isIPosition(o)),k(Array.isArray(t)),k(typeof n>"u"||typeof n=="string"),k(typeof a>"u"||typeof a=="boolean");const l=c.get(_),p=await l.openCodeEditor({resource:e},l.getFocusedCodeEditor());if(H(p))return p.setPosition(o),p.revealPositionInCenterIfOutsideViewport(o,ye.Smooth),p.invokeWithinContext(y=>{const E=new class extends Me{_getNoResultFoundMessage(S){return d||super._getNoResultFoundMessage(S)}}({muteMessage:!d,openInPeek:!!a,openToSide:!1},t,n);y.get(U).invokeFunction(E.run.bind(E),p)})}}),A.registerCommand({id:"editor.action.peekLocations",metadata:{description:"Peek locations from a position in a file",args:[{name:"uri",description:"The text document in which to start",constraint:D},{name:"position",description:"The position at which to start",constraint:M.Position.isIPosition},{name:"locations",description:"An array of locations.",constraint:Array},{name:"multiple",description:"Define what to do when having multiple results, either `peek`, `gotoAndPeek`, or `goto`"}]},handler:async(c,e,o,t,n)=>{c.get(me).executeCommand("editor.action.goToLocations",e,o,t,n,void 0,!0)}}),A.registerCommand({id:"editor.action.findReferences",handler:(c,e,o)=>{k(D.isUri(e)),k(M.Position.isIPosition(o));const t=c.get(Q),n=c.get(_);return n.openCodeEditor({resource:e},n.getFocusedCodeEditor()).then(d=>{if(!H(d)||!d.hasModel())return;const a=Y.get(d);if(!a)return;const l=j(y=>N(t.referenceProvider,d.getModel(),M.Position.lift(o),!1,!1,y).then(E=>new C(E,i.localize("ref.title","References")))),p=new J(o.lineNumber,o.column,o.lineNumber,o.column);return Promise.resolve(a.toggleWidget(p,l,!1))})}}),A.registerCommandAlias("editor.action.showReferences","editor.action.peekLocations");export{F as DefinitionAction,m as SymbolNavigationAction,x as SymbolNavigationAnchor};
