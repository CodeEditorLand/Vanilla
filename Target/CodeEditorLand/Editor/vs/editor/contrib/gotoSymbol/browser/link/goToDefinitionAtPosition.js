var y=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var v=(d,e,i,t)=>{for(var o=t>1?void 0:t?P(e,i):e,r=d.length-1,n;r>=0;r--)(n=d[r])&&(o=(t?n(e,i,o):n(o))||o);return t&&o&&y(e,i,o),o},c=(d,e)=>(i,t)=>e(i,t,d);import{createCancelablePromise as L}from"../../../../../base/common/async.js";import{onUnexpectedError as f}from"../../../../../base/common/errors.js";import{MarkdownString as k}from"../../../../../base/common/htmlContent.js";import{DisposableStore as I}from"../../../../../base/common/lifecycle.js";import"./goToDefinitionAtPosition.css";import*as b from"../../../../../nls.js";import{IContextKeyService as D}from"../../../../../platform/contextkey/common/contextkey.js";import{MouseTargetType as C}from"../../../../browser/editorBrowser.js";import{EditorContributionInstantiation as S,registerEditorContribution as E}from"../../../../browser/editorExtensions.js";import{EditorOption as M}from"../../../../common/config/editorOptions.js";import{Range as u}from"../../../../common/core/range.js";import{ILanguageService as w}from"../../../../common/languages/language.js";import{ModelDecorationInjectedTextOptions as F}from"../../../../common/model/textModel.js";import{ILanguageFeaturesService as R}from"../../../../common/services/languageFeatures.js";import{ITextModelService as W}from"../../../../common/services/resolverService.js";import{CodeEditorStateFlag as m,EditorState as T}from"../../../editorState/browser/editorState.js";import{PeekContext as U}from"../../../peekView/browser/peekView.js";import{DefinitionAction as x}from"../goToCommands.js";import{getDefinitionsAtPosition as A}from"../goToSymbol.js";import{ClickLinkGesture as N}from"./clickLinkGesture.js";let a=class{constructor(e,i,t,o){this.textModelResolverService=i;this.languageService=t;this.languageFeaturesService=o;this.editor=e,this.linkDecorations=this.editor.createDecorationsCollection();const r=new N(e);this.toUnhook.add(r),this.toUnhook.add(r.onMouseMoveOrRelevantKeyDown(([n,s])=>{this.startFindDefinitionFromMouse(n,s??void 0)})),this.toUnhook.add(r.onExecute(n=>{this.isEnabled(n)&&this.gotoDefinition(n.target.position,n.hasSideBySideModifier).catch(s=>{f(s)}).finally(()=>{this.removeLinkDecorations()})})),this.toUnhook.add(r.onCancel(()=>{this.removeLinkDecorations(),this.currentWordAtPosition=null}))}static ID="editor.contrib.gotodefinitionatposition";static MAX_SOURCE_PREVIEW_LINES=8;editor;toUnhook=new I;toUnhookForKeyboard=new I;linkDecorations;currentWordAtPosition=null;previousPromise=null;static get(e){return e.getContribution(a.ID)}async startFindDefinitionFromCursor(e){await this.startFindDefinition(e),this.toUnhookForKeyboard.add(this.editor.onDidChangeCursorPosition(()=>{this.currentWordAtPosition=null,this.removeLinkDecorations(),this.toUnhookForKeyboard.clear()})),this.toUnhookForKeyboard.add(this.editor.onKeyDown(i=>{i&&(this.currentWordAtPosition=null,this.removeLinkDecorations(),this.toUnhookForKeyboard.clear())}))}startFindDefinitionFromMouse(e,i){if(e.target.type===C.CONTENT_WIDGET&&this.linkDecorations.length>0)return;if(!this.editor.hasModel()||!this.isEnabled(e,i)){this.currentWordAtPosition=null,this.removeLinkDecorations();return}const t=e.target.position;this.startFindDefinition(t)}async startFindDefinition(e){this.toUnhookForKeyboard.clear();const i=e?this.editor.getModel()?.getWordAtPosition(e):null;if(!i){this.currentWordAtPosition=null,this.removeLinkDecorations();return}if(this.currentWordAtPosition&&this.currentWordAtPosition.startColumn===i.startColumn&&this.currentWordAtPosition.endColumn===i.endColumn&&this.currentWordAtPosition.word===i.word)return;this.currentWordAtPosition=i;const t=new T(this.editor,m.Position|m.Value|m.Selection|m.Scroll);this.previousPromise&&(this.previousPromise.cancel(),this.previousPromise=null),this.previousPromise=L(n=>this.findDefinition(e,n));let o;try{o=await this.previousPromise}catch(n){f(n);return}if(!o||!o.length||!t.validate(this.editor)){this.removeLinkDecorations();return}const r=o[0].originSelectionRange?u.lift(o[0].originSelectionRange):new u(e.lineNumber,i.startColumn,e.lineNumber,i.endColumn);if(o.length>1){let n=r;for(const{originSelectionRange:s}of o)s&&(n=u.plusRange(n,s));this.addDecoration(n,new k().appendText(b.localize("multipleResults","Click to show {0} definitions.",o.length)))}else{const n=o[0];if(!n.uri)return;this.textModelResolverService.createModelReference(n.uri).then(s=>{if(!s.object||!s.object.textEditorModel){s.dispose();return}const{object:{textEditorModel:l}}=s,{startLineNumber:p}=n.range;if(p<1||p>l.getLineCount()){s.dispose();return}const h=this.getPreviewValue(l,p,n),g=this.languageService.guessLanguageIdByFilepathOrFirstLine(l.uri);this.addDecoration(r,h?new k().appendCodeblock(g||"",h):void 0),s.dispose()})}}getPreviewValue(e,i,t){let o=t.range;return o.endLineNumber-o.startLineNumber>=a.MAX_SOURCE_PREVIEW_LINES&&(o=this.getPreviewRangeBasedOnIndentation(e,i)),this.stripIndentationFromPreviewRange(e,i,o)}stripIndentationFromPreviewRange(e,i,t){let r=e.getLineFirstNonWhitespaceColumn(i);for(let s=i+1;s<t.endLineNumber;s++){const l=e.getLineFirstNonWhitespaceColumn(s);r=Math.min(r,l)}return e.getValueInRange(t).replace(new RegExp(`^\\s{${r-1}}`,"gm"),"").trim()}getPreviewRangeBasedOnIndentation(e,i){const t=e.getLineFirstNonWhitespaceColumn(i),o=Math.min(e.getLineCount(),i+a.MAX_SOURCE_PREVIEW_LINES);let r=i+1;for(;r<o;r++){const n=e.getLineFirstNonWhitespaceColumn(r);if(t===n)break}return new u(i,1,r+1,1)}addDecoration(e,i){const t={range:e,options:{description:"goto-definition-link",inlineClassName:"goto-definition-link",hoverMessage:i}};this.linkDecorations.set([t])}removeLinkDecorations(){this.linkDecorations.clear()}isEnabled(e,i){return this.editor.hasModel()&&e.isLeftClick&&e.isNoneOrSingleMouseDown&&e.target.type===C.CONTENT_TEXT&&!(e.target.detail.injectedText?.options instanceof F)&&(e.hasTriggerModifier||(i?i.keyCodeIsTriggerKey:!1))&&this.languageFeaturesService.definitionProvider.has(this.editor.getModel())}findDefinition(e,i){const t=this.editor.getModel();return t?A(this.languageFeaturesService.definitionProvider,t,e,!1,i):Promise.resolve(null)}gotoDefinition(e,i){return this.editor.setPosition(e),this.editor.invokeWithinContext(t=>{const o=!i&&this.editor.getOption(M.definitionLinkOpensInPeek)&&!this.isInPeekEditor(t);return new x({openToSide:i,openInPeek:o,muteMessage:!0},{title:{value:"",original:""},id:"",precondition:void 0}).run(t)})}isInPeekEditor(e){const i=e.get(D);return U.inPeekEditor.getValue(i)}dispose(){this.toUnhook.dispose(),this.toUnhookForKeyboard.dispose()}};a=v([c(1,W),c(2,w),c(3,R)],a),E(a.ID,a,S.BeforeFirstInteraction);export{a as GotoDefinitionAtPositionEditorContribution};
