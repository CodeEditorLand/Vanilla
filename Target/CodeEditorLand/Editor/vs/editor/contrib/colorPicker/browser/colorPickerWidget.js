import*as e from"../../../../base/browser/dom.js";import{GlobalPointerMoveMonitor as m}from"../../../../base/browser/globalPointerMoveMonitor.js";import{PixelRatio as y}from"../../../../base/browser/pixelRatio.js";import{Widget as N}from"../../../../base/browser/ui/widget.js";import{Codicon as f}from"../../../../base/common/codicons.js";import{Color as d,HSVA as c,RGBA as u}from"../../../../base/common/color.js";import{Emitter as h}from"../../../../base/common/event.js";import{Disposable as p}from"../../../../base/common/lifecycle.js";import{ThemeIcon as D}from"../../../../base/common/themables.js";import"./colorPicker.css";import{localize as g}from"../../../../nls.js";import{editorHoverBackground as C}from"../../../../platform/theme/common/colorRegistry.js";import{registerIcon as k}from"../../../../platform/theme/common/iconRegistry.js";import"../../../../platform/theme/common/themeService.js";import"../../hover/browser/hoverTypes.js";import"./colorPickerModel.js";const n=e.$;class L extends p{constructor(t,o,i,r=!1){super();this.model=o;this.showingStandaloneColorPicker=r;this._domNode=n(".colorpicker-header"),e.append(t,this._domNode),this._pickedColorNode=e.append(this._domNode,n(".picked-color")),e.append(this._pickedColorNode,n("span.codicon.codicon-color-mode")),this._pickedColorPresentation=e.append(this._pickedColorNode,document.createElement("span")),this._pickedColorPresentation.classList.add("picked-color-presentation");const a=g("clickToToggleColorOptions","Click to toggle color options (rgb/hsl/hex)");this._pickedColorNode.setAttribute("title",a),this._originalColorNode=e.append(this._domNode,n(".original-color")),this._originalColorNode.style.backgroundColor=d.Format.CSS.format(this.model.originalColor)||"",this.backgroundColor=i.getColorTheme().getColor(C)||d.white,this._register(i.onDidColorThemeChange(b=>{this.backgroundColor=b.getColor(C)||d.white})),this._register(e.addDisposableListener(this._pickedColorNode,e.EventType.CLICK,()=>this.model.selectNextColorPresentation())),this._register(e.addDisposableListener(this._originalColorNode,e.EventType.CLICK,()=>{this.model.color=this.model.originalColor,this.model.flushColor()})),this._register(o.onDidChangeColor(this.onDidChangeColor,this)),this._register(o.onDidChangePresentation(this.onDidChangePresentation,this)),this._pickedColorNode.style.backgroundColor=d.Format.CSS.format(o.color)||"",this._pickedColorNode.classList.toggle("light",o.color.rgba.a<.5?this.backgroundColor.isLighter():o.color.isLighter()),this.onDidChangeColor(this.model.color),this.showingStandaloneColorPicker&&(this._domNode.classList.add("standalone-colorpicker"),this._closeButton=this._register(new E(this._domNode)))}_domNode;_pickedColorNode;_pickedColorPresentation;_originalColorNode;_closeButton=null;backgroundColor;get domNode(){return this._domNode}get closeButton(){return this._closeButton}get pickedColorNode(){return this._pickedColorNode}get originalColorNode(){return this._originalColorNode}onDidChangeColor(t){this._pickedColorNode.style.backgroundColor=d.Format.CSS.format(t)||"",this._pickedColorNode.classList.toggle("light",t.rgba.a<.5?this.backgroundColor.isLighter():t.isLighter()),this.onDidChangePresentation()}onDidChangePresentation(){this._pickedColorPresentation.textContent=this.model.presentation?this.model.presentation.label:""}}class E extends p{_button;_onClicked=this._register(new h);onClicked=this._onClicked.event;constructor(s){super(),this._button=document.createElement("div"),this._button.classList.add("close-button"),e.append(s,this._button);const t=document.createElement("div");t.classList.add("close-button-inner-div"),e.append(this._button,t),e.append(t,n(".button"+D.asCSSSelector(k("color-picker-close",f.close,g("closeIcon","Icon to close the color picker"))))).classList.add("close-icon"),this._register(e.addDisposableListener(this._button,e.EventType.CLICK,()=>{this._onClicked.fire()}))}}class S extends p{constructor(t,o,i,r=!1){super();this.model=o;this.pixelRatio=i;this._domNode=n(".colorpicker-body"),e.append(t,this._domNode),this._saturationBox=new M(this._domNode,this.model,this.pixelRatio),this._register(this._saturationBox),this._register(this._saturationBox.onDidChange(this.onDidSaturationValueChange,this)),this._register(this._saturationBox.onColorFlushed(this.flushColor,this)),this._opacityStrip=new T(this._domNode,this.model,r),this._register(this._opacityStrip),this._register(this._opacityStrip.onDidChange(this.onDidOpacityChange,this)),this._register(this._opacityStrip.onColorFlushed(this.flushColor,this)),this._hueStrip=new w(this._domNode,this.model,r),this._register(this._hueStrip),this._register(this._hueStrip.onDidChange(this.onDidHueChange,this)),this._register(this._hueStrip.onColorFlushed(this.flushColor,this)),r&&(this._insertButton=this._register(new P(this._domNode)),this._domNode.classList.add("standalone-colorpicker"))}_domNode;_saturationBox;_hueStrip;_opacityStrip;_insertButton=null;flushColor(){this.model.flushColor()}onDidSaturationValueChange({s:t,v:o}){const i=this.model.color.hsva;this.model.color=new d(new c(i.h,t,o,i.a))}onDidOpacityChange(t){const o=this.model.color.hsva;this.model.color=new d(new c(o.h,o.s,o.v,t))}onDidHueChange(t){const o=this.model.color.hsva,i=(1-t)*360;this.model.color=new d(new c(i===360?0:i,o.s,o.v,o.a))}get domNode(){return this._domNode}get saturationBox(){return this._saturationBox}get opacityStrip(){return this._opacityStrip}get hueStrip(){return this._hueStrip}get enterButton(){return this._insertButton}layout(){this._saturationBox.layout(),this._opacityStrip.layout(),this._hueStrip.layout()}}class M extends p{constructor(t,o,i){super();this.model=o;this.pixelRatio=i;this._domNode=n(".saturation-wrap"),e.append(t,this._domNode),this._canvas=document.createElement("canvas"),this._canvas.className="saturation-box",e.append(this._domNode,this._canvas),this.selection=n(".saturation-selection"),e.append(this._domNode,this.selection),this.layout(),this._register(e.addDisposableListener(this._domNode,e.EventType.POINTER_DOWN,r=>this.onPointerDown(r))),this._register(this.model.onDidChangeColor(this.onDidChangeColor,this)),this.monitor=null}_domNode;selection;_canvas;width;height;monitor;_onDidChange=new h;onDidChange=this._onDidChange.event;_onColorFlushed=new h;onColorFlushed=this._onColorFlushed.event;get domNode(){return this._domNode}get canvas(){return this._canvas}onPointerDown(t){if(!t.target||!(t.target instanceof Element))return;this.monitor=this._register(new m);const o=e.getDomNodePagePosition(this._domNode);t.target!==this.selection&&this.onDidChangePosition(t.offsetX,t.offsetY),this.monitor.startMonitoring(t.target,t.pointerId,t.buttons,r=>this.onDidChangePosition(r.pageX-o.left,r.pageY-o.top),()=>null);const i=e.addDisposableListener(t.target.ownerDocument,e.EventType.POINTER_UP,()=>{this._onColorFlushed.fire(),i.dispose(),this.monitor&&(this.monitor.stopMonitoring(!0),this.monitor=null)},!0)}onDidChangePosition(t,o){const i=Math.max(0,Math.min(1,t/this.width)),r=Math.max(0,Math.min(1,1-o/this.height));this.paintSelection(i,r),this._onDidChange.fire({s:i,v:r})}layout(){this.width=this._domNode.offsetWidth,this.height=this._domNode.offsetHeight,this._canvas.width=this.width*this.pixelRatio,this._canvas.height=this.height*this.pixelRatio,this.paint();const t=this.model.color.hsva;this.paintSelection(t.s,t.v)}paint(){const t=this.model.color.hsva,o=new d(new c(t.h,1,1,1)),i=this._canvas.getContext("2d"),r=i.createLinearGradient(0,0,this._canvas.width,0);r.addColorStop(0,"rgba(255, 255, 255, 1)"),r.addColorStop(.5,"rgba(255, 255, 255, 0.5)"),r.addColorStop(1,"rgba(255, 255, 255, 0)");const a=i.createLinearGradient(0,0,0,this._canvas.height);a.addColorStop(0,"rgba(0, 0, 0, 0)"),a.addColorStop(1,"rgba(0, 0, 0, 1)"),i.rect(0,0,this._canvas.width,this._canvas.height),i.fillStyle=d.Format.CSS.format(o),i.fill(),i.fillStyle=r,i.fill(),i.fillStyle=a,i.fill()}paintSelection(t,o){this.selection.style.left=`${t*this.width}px`,this.selection.style.top=`${this.height-o*this.height}px`}onDidChangeColor(t){if(this.monitor&&this.monitor.isMonitoring())return;this.paint();const o=t.hsva;this.paintSelection(o.s,o.v)}}class _ extends p{constructor(t,o,i=!1){super();this.model=o;i?(this.domNode=e.append(t,n(".standalone-strip")),this.overlay=e.append(this.domNode,n(".standalone-overlay"))):(this.domNode=e.append(t,n(".strip")),this.overlay=e.append(this.domNode,n(".overlay"))),this.slider=e.append(this.domNode,n(".slider")),this.slider.style.top="0px",this._register(e.addDisposableListener(this.domNode,e.EventType.POINTER_DOWN,r=>this.onPointerDown(r))),this._register(o.onDidChangeColor(this.onDidChangeColor,this)),this.layout()}domNode;overlay;slider;height;_onDidChange=new h;onDidChange=this._onDidChange.event;_onColorFlushed=new h;onColorFlushed=this._onColorFlushed.event;layout(){this.height=this.domNode.offsetHeight-this.slider.offsetHeight;const t=this.getValue(this.model.color);this.updateSliderPosition(t)}onDidChangeColor(t){const o=this.getValue(t);this.updateSliderPosition(o)}onPointerDown(t){if(!t.target||!(t.target instanceof Element))return;const o=this._register(new m),i=e.getDomNodePagePosition(this.domNode);this.domNode.classList.add("grabbing"),t.target!==this.slider&&this.onDidChangeTop(t.offsetY),o.startMonitoring(t.target,t.pointerId,t.buttons,a=>this.onDidChangeTop(a.pageY-i.top),()=>null);const r=e.addDisposableListener(t.target.ownerDocument,e.EventType.POINTER_UP,()=>{this._onColorFlushed.fire(),r.dispose(),o.stopMonitoring(!0),this.domNode.classList.remove("grabbing")},!0)}onDidChangeTop(t){const o=Math.max(0,Math.min(1,1-t/this.height));this.updateSliderPosition(o),this._onDidChange.fire(o)}updateSliderPosition(t){this.slider.style.top=`${(1-t)*this.height}px`}}class T extends _{constructor(s,t,o=!1){super(s,t,o),this.domNode.classList.add("opacity-strip"),this.onDidChangeColor(this.model.color)}onDidChangeColor(s){super.onDidChangeColor(s);const{r:t,g:o,b:i}=s.rgba,r=new d(new u(t,o,i,1)),a=new d(new u(t,o,i,0));this.overlay.style.background=`linear-gradient(to bottom, ${r} 0%, ${a} 100%)`}getValue(s){return s.hsva.a}}class w extends _{constructor(s,t,o=!1){super(s,t,o),this.domNode.classList.add("hue-strip")}getValue(s){return 1-s.hsva.h/360}}class P extends p{_button;_onClicked=this._register(new h);onClicked=this._onClicked.event;constructor(s){super(),this._button=e.append(s,document.createElement("button")),this._button.classList.add("insert-button"),this._button.textContent="Insert",this._register(e.addDisposableListener(this._button,e.EventType.CLICK,()=>{this._onClicked.fire()}))}get button(){return this._button}}class v extends N{constructor(t,o,i,r,a=!1){super();this.model=o;this.pixelRatio=i;this._register(y.getInstance(e.getWindow(t)).onDidChange(()=>this.layout())),this._domNode=n(".colorpicker-widget"),t.appendChild(this._domNode),this.header=this._register(new L(this._domNode,this.model,r,a)),this.body=this._register(new S(this._domNode,this.model,this.pixelRatio,a))}static ID="editor.contrib.colorPickerWidget";_domNode;body;header;getId(){return v.ID}layout(){this.body.layout()}get domNode(){return this._domNode}}export{S as ColorPickerBody,L as ColorPickerHeader,v as ColorPickerWidget,P as InsertButton};
