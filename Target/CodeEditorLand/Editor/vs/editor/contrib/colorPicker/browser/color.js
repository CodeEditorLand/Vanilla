import{CancellationToken as C}from"../../../../../vs/base/common/cancellation.js";import{illegalArgument as d,onUnexpectedExternalError as p}from"../../../../../vs/base/common/errors.js";import{URI as D}from"../../../../../vs/base/common/uri.js";import"../../../../../vs/editor/browser/editorExtensions.js";import{Range as v}from"../../../../../vs/editor/common/core/range.js";import"../../../../../vs/editor/common/languageFeatureRegistry.js";import"../../../../../vs/editor/common/languages.js";import"../../../../../vs/editor/common/model.js";import{ILanguageFeaturesService as y}from"../../../../../vs/editor/common/services/languageFeatures.js";import{IModelService as x}from"../../../../../vs/editor/common/services/model.js";import{DefaultDocumentColorProvider as T}from"../../../../../vs/editor/contrib/colorPicker/browser/defaultDocumentColorProvider.js";import{CommandsRegistry as I}from"../../../../../vs/platform/commands/common/commands.js";import{IConfigurationService as b}from"../../../../../vs/platform/configuration/common/configuration.js";async function Q(n,r,o,t=!0){return f(new A,n,r,o,t)}function W(n,r,o,t){return Promise.resolve(o.provideColorPresentations(n,r,t))}class A{constructor(){}async compute(r,o,t,a){const e=await r.provideDocumentColors(o,t);if(Array.isArray(e))for(const l of e)a.push({colorInfo:l,provider:r});return Array.isArray(e)}}class R{constructor(){}async compute(r,o,t,a){const e=await r.provideDocumentColors(o,t);if(Array.isArray(e))for(const l of e)a.push({range:l.range,color:[l.color.red,l.color.green,l.color.blue,l.color.alpha]});return Array.isArray(e)}}class h{constructor(r){this.colorInfo=r}async compute(r,o,t,a){const e=await r.provideColorPresentations(o,this.colorInfo,C.None);return Array.isArray(e)&&a.push(...e),Array.isArray(e)}}async function f(n,r,o,t,a){let e=!1,l;const i=[],u=r.ordered(o);for(let c=u.length-1;c>=0;c--){const s=u[c];if(s instanceof T)l=s;else try{await n.compute(s,o,t,i)&&(e=!0)}catch(m){p(m)}}return e?i:l&&a?(await n.compute(l,o,t,i),i):[]}function g(n,r){const{colorProvider:o}=n.get(y),t=n.get(x).getModel(r);if(!t)throw d();const a=n.get(b).getValue("editor.defaultColorDecorators",{resource:r});return{model:t,colorProviderRegistry:o,isDefaultColorDecoratorsEnabled:a}}I.registerCommand("_executeDocumentColorProvider",function(n,...r){const[o]=r;if(!(o instanceof D))throw d();const{model:t,colorProviderRegistry:a,isDefaultColorDecoratorsEnabled:e}=g(n,o);return f(new R,a,t,C.None,e)}),I.registerCommand("_executeColorPresentationProvider",function(n,...r){const[o,t]=r,{uri:a,range:e}=t;if(!(a instanceof D)||!Array.isArray(o)||o.length!==4||!v.isIRange(e))throw d();const{model:l,colorProviderRegistry:i,isDefaultColorDecoratorsEnabled:u}=g(n,a),[c,s,m,P]=o;return f(new h({range:e,color:{red:c,green:s,blue:m,alpha:P}}),i,l,C.None,u)});export{W as getColorPresentations,Q as getColors};
