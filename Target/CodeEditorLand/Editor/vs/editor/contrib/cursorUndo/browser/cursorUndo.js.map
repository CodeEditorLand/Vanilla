{
  "version": 3,
  "sources": ["../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/editor/contrib/cursorUndo/browser/cursorUndo.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { KeyCode, KeyMod } from '../../../../base/common/keyCodes.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { ICodeEditor } from '../../../browser/editorBrowser.js';\nimport { EditorAction, EditorContributionInstantiation, registerEditorAction, registerEditorContribution, ServicesAccessor } from '../../../browser/editorExtensions.js';\nimport { Selection } from '../../../common/core/selection.js';\nimport { IEditorContribution } from '../../../common/editorCommon.js';\nimport { EditorContextKeys } from '../../../common/editorContextKeys.js';\nimport * as nls from '../../../../nls.js';\nimport { KeybindingWeight } from '../../../../platform/keybinding/common/keybindingsRegistry.js';\n\nclass CursorState {\n\treadonly selections: readonly Selection[];\n\n\tconstructor(selections: readonly Selection[]) {\n\t\tthis.selections = selections;\n\t}\n\n\tpublic equals(other: CursorState): boolean {\n\t\tconst thisLen = this.selections.length;\n\t\tconst otherLen = other.selections.length;\n\t\tif (thisLen !== otherLen) {\n\t\t\treturn false;\n\t\t}\n\t\tfor (let i = 0; i < thisLen; i++) {\n\t\t\tif (!this.selections[i].equalsSelection(other.selections[i])) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n}\n\nclass StackElement {\n\tconstructor(\n\t\tpublic readonly cursorState: CursorState,\n\t\tpublic readonly scrollTop: number,\n\t\tpublic readonly scrollLeft: number\n\t) { }\n}\n\nexport class CursorUndoRedoController extends Disposable implements IEditorContribution {\n\n\tpublic static readonly ID = 'editor.contrib.cursorUndoRedoController';\n\n\tpublic static get(editor: ICodeEditor): CursorUndoRedoController | null {\n\t\treturn editor.getContribution<CursorUndoRedoController>(CursorUndoRedoController.ID);\n\t}\n\n\tprivate readonly _editor: ICodeEditor;\n\tprivate _isCursorUndoRedo: boolean;\n\n\tprivate _undoStack: StackElement[];\n\tprivate _redoStack: StackElement[];\n\n\tconstructor(editor: ICodeEditor) {\n\t\tsuper();\n\t\tthis._editor = editor;\n\t\tthis._isCursorUndoRedo = false;\n\n\t\tthis._undoStack = [];\n\t\tthis._redoStack = [];\n\n\t\tthis._register(editor.onDidChangeModel((e) => {\n\t\t\tthis._undoStack = [];\n\t\t\tthis._redoStack = [];\n\t\t}));\n\t\tthis._register(editor.onDidChangeModelContent((e) => {\n\t\t\tthis._undoStack = [];\n\t\t\tthis._redoStack = [];\n\t\t}));\n\t\tthis._register(editor.onDidChangeCursorSelection((e) => {\n\t\t\tif (this._isCursorUndoRedo) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (!e.oldSelections) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (e.oldModelVersionId !== e.modelVersionId) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst prevState = new CursorState(e.oldSelections);\n\t\t\tconst isEqualToLastUndoStack = (this._undoStack.length > 0 && this._undoStack[this._undoStack.length - 1].cursorState.equals(prevState));\n\t\t\tif (!isEqualToLastUndoStack) {\n\t\t\t\tthis._undoStack.push(new StackElement(prevState, editor.getScrollTop(), editor.getScrollLeft()));\n\t\t\t\tthis._redoStack = [];\n\t\t\t\tif (this._undoStack.length > 50) {\n\t\t\t\t\t// keep the cursor undo stack bounded\n\t\t\t\t\tthis._undoStack.shift();\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\t}\n\n\tpublic cursorUndo(): void {\n\t\tif (!this._editor.hasModel() || this._undoStack.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._redoStack.push(new StackElement(new CursorState(this._editor.getSelections()), this._editor.getScrollTop(), this._editor.getScrollLeft()));\n\t\tthis._applyState(this._undoStack.pop()!);\n\t}\n\n\tpublic cursorRedo(): void {\n\t\tif (!this._editor.hasModel() || this._redoStack.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._undoStack.push(new StackElement(new CursorState(this._editor.getSelections()), this._editor.getScrollTop(), this._editor.getScrollLeft()));\n\t\tthis._applyState(this._redoStack.pop()!);\n\t}\n\n\tprivate _applyState(stackElement: StackElement): void {\n\t\tthis._isCursorUndoRedo = true;\n\t\tthis._editor.setSelections(stackElement.cursorState.selections);\n\t\tthis._editor.setScrollPosition({\n\t\t\tscrollTop: stackElement.scrollTop,\n\t\t\tscrollLeft: stackElement.scrollLeft\n\t\t});\n\t\tthis._isCursorUndoRedo = false;\n\t}\n}\n\nexport class CursorUndo extends EditorAction {\n\tconstructor() {\n\t\tsuper({\n\t\t\tid: 'cursorUndo',\n\t\t\tlabel: nls.localize('cursor.undo', \"Cursor Undo\"),\n\t\t\talias: 'Cursor Undo',\n\t\t\tprecondition: undefined,\n\t\t\tkbOpts: {\n\t\t\t\tkbExpr: EditorContextKeys.textInputFocus,\n\t\t\t\tprimary: KeyMod.CtrlCmd | KeyCode.KeyU,\n\t\t\t\tweight: KeybindingWeight.EditorContrib\n\t\t\t}\n\t\t});\n\t}\n\n\tpublic run(accessor: ServicesAccessor, editor: ICodeEditor, args: any): void {\n\t\tCursorUndoRedoController.get(editor)?.cursorUndo();\n\t}\n}\n\nexport class CursorRedo extends EditorAction {\n\tconstructor() {\n\t\tsuper({\n\t\t\tid: 'cursorRedo',\n\t\t\tlabel: nls.localize('cursor.redo', \"Cursor Redo\"),\n\t\t\talias: 'Cursor Redo',\n\t\t\tprecondition: undefined\n\t\t});\n\t}\n\n\tpublic run(accessor: ServicesAccessor, editor: ICodeEditor, args: any): void {\n\t\tCursorUndoRedoController.get(editor)?.cursorRedo();\n\t}\n}\n\nregisterEditorContribution(CursorUndoRedoController.ID, CursorUndoRedoController, EditorContributionInstantiation.Eager); // eager because it needs to listen to record cursor state ASAP\nregisterEditorAction(CursorUndo);\nregisterEditorAction(CursorRedo);\n"],
  "mappings": "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",
  "names": []
}
