import"../../../../base/common/lifecycle.js";import"../../../browser/editorBrowser.js";import"../../../common/core/position.js";import{Range as p}from"../../../common/core/range.js";import{MinimapPosition as f,OverviewRulerLane as D,TrackedRangeStickiness as d}from"../../../common/model.js";import{ModelDecorationOptions as c}from"../../../common/model/textModel.js";import{minimapFindMatch as N,overviewRulerFindMatchForeground as I}from"../../../../platform/theme/common/colorRegistry.js";import{themeColorFromId as g}from"../../../../platform/theme/common/themeService.js";class s{_editor;_decorations;_overviewRulerApproximateDecorations;_findScopeDecorationIds;_rangeHighlightDecorationId;_highlightedDecorationId;_startPosition;constructor(e){this._editor=e,this._decorations=[],this._overviewRulerApproximateDecorations=[],this._findScopeDecorationIds=[],this._rangeHighlightDecorationId=null,this._highlightedDecorationId=null,this._startPosition=this._editor.getPosition()}dispose(){this._editor.removeDecorations(this._allDecorations()),this._decorations=[],this._overviewRulerApproximateDecorations=[],this._findScopeDecorationIds=[],this._rangeHighlightDecorationId=null,this._highlightedDecorationId=null}reset(){this._decorations=[],this._overviewRulerApproximateDecorations=[],this._findScopeDecorationIds=[],this._rangeHighlightDecorationId=null,this._highlightedDecorationId=null}getCount(){return this._decorations.length}getFindScope(){return this._findScopeDecorationIds[0]?this._editor.getModel().getDecorationRange(this._findScopeDecorationIds[0]):null}getFindScopes(){if(this._findScopeDecorationIds.length){const e=this._findScopeDecorationIds.map(i=>this._editor.getModel().getDecorationRange(i)).filter(i=>!!i);if(e.length)return e}return null}getStartPosition(){return this._startPosition}setStartPosition(e){this._startPosition=e,this.setCurrentFindMatch(null)}_getDecorationIndex(e){const i=this._decorations.indexOf(e);return i>=0?i+1:1}getDecorationRangeAt(e){const i=e<this._decorations.length?this._decorations[e]:null;return i?this._editor.getModel().getDecorationRange(i):null}getCurrentMatchesPosition(e){const i=this._editor.getModel().getDecorationsInRange(e);for(const n of i){const t=n.options;if(t===s._FIND_MATCH_DECORATION||t===s._CURRENT_FIND_MATCH_DECORATION)return this._getDecorationIndex(n.id)}return 0}setCurrentFindMatch(e){let i=null,n=0;if(e)for(let t=0,o=this._decorations.length;t<o;t++){const a=this._editor.getModel().getDecorationRange(this._decorations[t]);if(e.equalsRange(a)){i=this._decorations[t],n=t+1;break}}return(this._highlightedDecorationId!==null||i!==null)&&this._editor.changeDecorations(t=>{if(this._highlightedDecorationId!==null&&(t.changeDecorationOptions(this._highlightedDecorationId,s._FIND_MATCH_DECORATION),this._highlightedDecorationId=null),i!==null&&(this._highlightedDecorationId=i,t.changeDecorationOptions(this._highlightedDecorationId,s._CURRENT_FIND_MATCH_DECORATION)),this._rangeHighlightDecorationId!==null&&(t.removeDecoration(this._rangeHighlightDecorationId),this._rangeHighlightDecorationId=null),i!==null){let o=this._editor.getModel().getDecorationRange(i);if(o.startLineNumber!==o.endLineNumber&&o.endColumn===1){const a=o.endLineNumber-1,r=this._editor.getModel().getLineMaxColumn(a);o=new p(o.startLineNumber,o.startColumn,a,r)}this._rangeHighlightDecorationId=t.addDecoration(o,s._RANGE_HIGHLIGHT_DECORATION)}}),n}set(e,i){this._editor.changeDecorations(n=>{let t=s._FIND_MATCH_DECORATION;const o=[];if(e.length>1e3){t=s._FIND_MATCH_NO_OVERVIEW_DECORATION;const r=this._editor.getModel().getLineCount(),R=this._editor.getLayoutInfo().height/r,v=Math.max(2,Math.ceil(3/R));let u=e[0].range.startLineNumber,l=e[0].range.endLineNumber;for(let _=1,C=e.length;_<C;_++){const h=e[_].range;l+v>=h.startLineNumber?h.endLineNumber>l&&(l=h.endLineNumber):(o.push({range:new p(u,1,l,1),options:s._FIND_MATCH_ONLY_OVERVIEW_DECORATION}),u=h.startLineNumber,l=h.endLineNumber)}o.push({range:new p(u,1,l,1),options:s._FIND_MATCH_ONLY_OVERVIEW_DECORATION})}const a=new Array(e.length);for(let r=0,m=e.length;r<m;r++)a[r]={range:e[r].range,options:t};this._decorations=n.deltaDecorations(this._decorations,a),this._overviewRulerApproximateDecorations=n.deltaDecorations(this._overviewRulerApproximateDecorations,o),this._rangeHighlightDecorationId&&(n.removeDecoration(this._rangeHighlightDecorationId),this._rangeHighlightDecorationId=null),this._findScopeDecorationIds.length&&(this._findScopeDecorationIds.forEach(r=>n.removeDecoration(r)),this._findScopeDecorationIds=[]),i?.length&&(this._findScopeDecorationIds=i.map(r=>n.addDecoration(r,s._FIND_SCOPE_DECORATION)))})}matchBeforePosition(e){if(this._decorations.length===0)return null;for(let i=this._decorations.length-1;i>=0;i--){const n=this._decorations[i],t=this._editor.getModel().getDecorationRange(n);if(!(!t||t.endLineNumber>e.lineNumber)){if(t.endLineNumber<e.lineNumber)return t;if(!(t.endColumn>e.column))return t}}return this._editor.getModel().getDecorationRange(this._decorations[this._decorations.length-1])}matchAfterPosition(e){if(this._decorations.length===0)return null;for(let i=0,n=this._decorations.length;i<n;i++){const t=this._decorations[i],o=this._editor.getModel().getDecorationRange(t);if(!(!o||o.startLineNumber<e.lineNumber)){if(o.startLineNumber>e.lineNumber)return o;if(!(o.startColumn<e.column))return o}}return this._editor.getModel().getDecorationRange(this._decorations[0])}_allDecorations(){let e=[];return e=e.concat(this._decorations),e=e.concat(this._overviewRulerApproximateDecorations),this._findScopeDecorationIds.length&&e.push(...this._findScopeDecorationIds),this._rangeHighlightDecorationId&&e.push(this._rangeHighlightDecorationId),e}static _CURRENT_FIND_MATCH_DECORATION=c.register({description:"current-find-match",stickiness:d.NeverGrowsWhenTypingAtEdges,zIndex:13,className:"currentFindMatch",inlineClassName:"currentFindMatchInline",showIfCollapsed:!0,overviewRuler:{color:g(I),position:D.Center},minimap:{color:g(N),position:f.Inline}});static _FIND_MATCH_DECORATION=c.register({description:"find-match",stickiness:d.NeverGrowsWhenTypingAtEdges,zIndex:10,className:"findMatch",inlineClassName:"findMatchInline",showIfCollapsed:!0,overviewRuler:{color:g(I),position:D.Center},minimap:{color:g(N),position:f.Inline}});static _FIND_MATCH_NO_OVERVIEW_DECORATION=c.register({description:"find-match-no-overview",stickiness:d.NeverGrowsWhenTypingAtEdges,className:"findMatch",showIfCollapsed:!0});static _FIND_MATCH_ONLY_OVERVIEW_DECORATION=c.register({description:"find-match-only-overview",stickiness:d.NeverGrowsWhenTypingAtEdges,overviewRuler:{color:g(I),position:D.Center}});static _RANGE_HIGHLIGHT_DECORATION=c.register({description:"find-range-highlight",stickiness:d.NeverGrowsWhenTypingAtEdges,className:"rangeHighlight",isWholeLine:!0});static _FIND_SCOPE_DECORATION=c.register({description:"find-scope",className:"findScope",isWholeLine:!0})}export{s as FindDecorations};
