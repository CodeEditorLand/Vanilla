import{minimapFindMatch as f,overviewRulerFindMatchForeground as p}from"../../../../platform/theme/common/colorRegistry.js";import{themeColorFromId as d}from"../../../../platform/theme/common/themeService.js";import{Range as D}from"../../../common/core/range.js";import{MinimapPosition as N,OverviewRulerLane as I,TrackedRangeStickiness as g}from"../../../common/model.js";import{ModelDecorationOptions as c}from"../../../common/model/textModel.js";class s{_editor;_decorations;_overviewRulerApproximateDecorations;_findScopeDecorationIds;_rangeHighlightDecorationId;_highlightedDecorationId;_startPosition;constructor(e){this._editor=e,this._decorations=[],this._overviewRulerApproximateDecorations=[],this._findScopeDecorationIds=[],this._rangeHighlightDecorationId=null,this._highlightedDecorationId=null,this._startPosition=this._editor.getPosition()}dispose(){this._editor.removeDecorations(this._allDecorations()),this._decorations=[],this._overviewRulerApproximateDecorations=[],this._findScopeDecorationIds=[],this._rangeHighlightDecorationId=null,this._highlightedDecorationId=null}reset(){this._decorations=[],this._overviewRulerApproximateDecorations=[],this._findScopeDecorationIds=[],this._rangeHighlightDecorationId=null,this._highlightedDecorationId=null}getCount(){return this._decorations.length}getFindScope(){return this._findScopeDecorationIds[0]?this._editor.getModel().getDecorationRange(this._findScopeDecorationIds[0]):null}getFindScopes(){if(this._findScopeDecorationIds.length){const e=this._findScopeDecorationIds.map(t=>this._editor.getModel().getDecorationRange(t)).filter(t=>!!t);if(e.length)return e}return null}getStartPosition(){return this._startPosition}setStartPosition(e){this._startPosition=e,this.setCurrentFindMatch(null)}_getDecorationIndex(e){const t=this._decorations.indexOf(e);return t>=0?t+1:1}getDecorationRangeAt(e){const t=e<this._decorations.length?this._decorations[e]:null;return t?this._editor.getModel().getDecorationRange(t):null}getCurrentMatchesPosition(e){const t=this._editor.getModel().getDecorationsInRange(e);for(const n of t){const i=n.options;if(i===s._FIND_MATCH_DECORATION||i===s._CURRENT_FIND_MATCH_DECORATION)return this._getDecorationIndex(n.id)}return 0}setCurrentFindMatch(e){let t=null,n=0;if(e)for(let i=0,o=this._decorations.length;i<o;i++){const a=this._editor.getModel().getDecorationRange(this._decorations[i]);if(e.equalsRange(a)){t=this._decorations[i],n=i+1;break}}return(this._highlightedDecorationId!==null||t!==null)&&this._editor.changeDecorations(i=>{if(this._highlightedDecorationId!==null&&(i.changeDecorationOptions(this._highlightedDecorationId,s._FIND_MATCH_DECORATION),this._highlightedDecorationId=null),t!==null&&(this._highlightedDecorationId=t,i.changeDecorationOptions(this._highlightedDecorationId,s._CURRENT_FIND_MATCH_DECORATION)),this._rangeHighlightDecorationId!==null&&(i.removeDecoration(this._rangeHighlightDecorationId),this._rangeHighlightDecorationId=null),t!==null){let o=this._editor.getModel().getDecorationRange(t);if(o.startLineNumber!==o.endLineNumber&&o.endColumn===1){const a=o.endLineNumber-1,r=this._editor.getModel().getLineMaxColumn(a);o=new D(o.startLineNumber,o.startColumn,a,r)}this._rangeHighlightDecorationId=i.addDecoration(o,s._RANGE_HIGHLIGHT_DECORATION)}}),n}set(e,t){this._editor.changeDecorations(n=>{let i=s._FIND_MATCH_DECORATION;const o=[];if(e.length>1e3){i=s._FIND_MATCH_NO_OVERVIEW_DECORATION;const r=this._editor.getModel().getLineCount(),R=this._editor.getLayoutInfo().height/r,v=Math.max(2,Math.ceil(3/R));let u=e[0].range.startLineNumber,l=e[0].range.endLineNumber;for(let _=1,C=e.length;_<C;_++){const h=e[_].range;l+v>=h.startLineNumber?h.endLineNumber>l&&(l=h.endLineNumber):(o.push({range:new D(u,1,l,1),options:s._FIND_MATCH_ONLY_OVERVIEW_DECORATION}),u=h.startLineNumber,l=h.endLineNumber)}o.push({range:new D(u,1,l,1),options:s._FIND_MATCH_ONLY_OVERVIEW_DECORATION})}const a=new Array(e.length);for(let r=0,m=e.length;r<m;r++)a[r]={range:e[r].range,options:i};this._decorations=n.deltaDecorations(this._decorations,a),this._overviewRulerApproximateDecorations=n.deltaDecorations(this._overviewRulerApproximateDecorations,o),this._rangeHighlightDecorationId&&(n.removeDecoration(this._rangeHighlightDecorationId),this._rangeHighlightDecorationId=null),this._findScopeDecorationIds.length&&(this._findScopeDecorationIds.forEach(r=>n.removeDecoration(r)),this._findScopeDecorationIds=[]),t?.length&&(this._findScopeDecorationIds=t.map(r=>n.addDecoration(r,s._FIND_SCOPE_DECORATION)))})}matchBeforePosition(e){if(this._decorations.length===0)return null;for(let t=this._decorations.length-1;t>=0;t--){const n=this._decorations[t],i=this._editor.getModel().getDecorationRange(n);if(!(!i||i.endLineNumber>e.lineNumber)){if(i.endLineNumber<e.lineNumber)return i;if(!(i.endColumn>e.column))return i}}return this._editor.getModel().getDecorationRange(this._decorations[this._decorations.length-1])}matchAfterPosition(e){if(this._decorations.length===0)return null;for(let t=0,n=this._decorations.length;t<n;t++){const i=this._decorations[t],o=this._editor.getModel().getDecorationRange(i);if(!(!o||o.startLineNumber<e.lineNumber)){if(o.startLineNumber>e.lineNumber)return o;if(!(o.startColumn<e.column))return o}}return this._editor.getModel().getDecorationRange(this._decorations[0])}_allDecorations(){let e=[];return e=e.concat(this._decorations),e=e.concat(this._overviewRulerApproximateDecorations),this._findScopeDecorationIds.length&&e.push(...this._findScopeDecorationIds),this._rangeHighlightDecorationId&&e.push(this._rangeHighlightDecorationId),e}static _CURRENT_FIND_MATCH_DECORATION=c.register({description:"current-find-match",stickiness:g.NeverGrowsWhenTypingAtEdges,zIndex:13,className:"currentFindMatch",inlineClassName:"currentFindMatchInline",showIfCollapsed:!0,overviewRuler:{color:d(p),position:I.Center},minimap:{color:d(f),position:N.Inline}});static _FIND_MATCH_DECORATION=c.register({description:"find-match",stickiness:g.NeverGrowsWhenTypingAtEdges,zIndex:10,className:"findMatch",inlineClassName:"findMatchInline",showIfCollapsed:!0,overviewRuler:{color:d(p),position:I.Center},minimap:{color:d(f),position:N.Inline}});static _FIND_MATCH_NO_OVERVIEW_DECORATION=c.register({description:"find-match-no-overview",stickiness:g.NeverGrowsWhenTypingAtEdges,className:"findMatch",showIfCollapsed:!0});static _FIND_MATCH_ONLY_OVERVIEW_DECORATION=c.register({description:"find-match-only-overview",stickiness:g.NeverGrowsWhenTypingAtEdges,overviewRuler:{color:d(p),position:I.Center}});static _RANGE_HIGHLIGHT_DECORATION=c.register({description:"find-range-highlight",stickiness:g.NeverGrowsWhenTypingAtEdges,className:"rangeHighlight",isWholeLine:!0});static _FIND_SCOPE_DECORATION=c.register({description:"find-scope",className:"findScope",isWholeLine:!0})}export{s as FindDecorations};
