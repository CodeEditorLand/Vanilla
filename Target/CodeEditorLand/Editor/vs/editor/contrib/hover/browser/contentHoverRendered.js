import*as l from"../../../../base/browser/dom.js";import{BugIndicatingError as C}from"../../../../base/common/errors.js";import{Disposable as h,DisposableStore as b,toDisposable as f}from"../../../../base/common/lifecycle.js";import{localize as P}from"../../../../nls.js";import{Position as g}from"../../../common/core/position.js";import{Range as w}from"../../../common/core/range.js";import{ModelDecorationOptions as A}from"../../../common/model/textModel.js";import{HoverColorPickerParticipant as E}from"../../colorPicker/browser/hoverColorPicker/hoverColorPickerParticipant.js";import{InlayHintsHover as S}from"../../inlayHints/browser/inlayHintsHover.js";import{EditorHoverStatusBar as x}from"./contentHoverStatusBar.js";import{RenderedHoverParts as R}from"./hoverTypes.js";import{MarkdownHoverParticipant as M}from"./markdownHoverParticipant.js";class I extends h{closestMouseDistance;initialMousePosX;initialMousePosY;showAtPosition;showAtSecondaryPosition;shouldFocus;source;shouldAppearBeforeContent;_renderedHoverParts;constructor(t,e,r,n,o){super();const i=e.hoverParts;this._renderedHoverParts=this._register(new m(t,r,i,o,n));const c=e.options,s=c.anchor,{showAtPosition:v,showAtSecondaryPosition:a}=I.computeHoverPositions(t,s.range,i);this.shouldAppearBeforeContent=i.some(d=>d.isBeforeContent),this.showAtPosition=v,this.showAtSecondaryPosition=a,this.initialMousePosX=s.initialMousePosX,this.initialMousePosY=s.initialMousePosY,this.shouldFocus=c.shouldFocus,this.source=c.source}get domNode(){return this._renderedHoverParts.domNode}get domNodeHasChildren(){return this._renderedHoverParts.domNodeHasChildren}get focusedHoverPartIndex(){return this._renderedHoverParts.focusedHoverPartIndex}focusHoverPartWithIndex(t){this._renderedHoverParts.focusHoverPartWithIndex(t)}getAccessibleWidgetContent(){return this._renderedHoverParts.getAccessibleContent()}getAccessibleWidgetContentAtIndex(t){return this._renderedHoverParts.getAccessibleHoverContentAtIndex(t)}async updateHoverVerbosityLevel(t,e,r){this._renderedHoverParts.updateHoverVerbosityLevel(t,e,r)}doesHoverAtIndexSupportVerbosityAction(t,e){return this._renderedHoverParts.doesHoverAtIndexSupportVerbosityAction(t,e)}isColorPickerVisible(){return this._renderedHoverParts.isColorPickerVisible()}static computeHoverPositions(t,e,r){let n=1;if(t.hasModel()){const a=t._getViewModel(),d=a.coordinatesConverter,u=d.convertModelRangeToViewRange(e),p=a.getLineMinColumn(u.startLineNumber),H=new g(u.startLineNumber,p);n=d.convertViewPositionToModelPosition(H).column}const o=e.startLineNumber;let i=e.startColumn,c;for(const a of r){const d=a.range,u=d.startLineNumber===o,p=d.endLineNumber===o;if(u&&p){const _=d.startColumn,y=Math.min(i,_);i=Math.max(y,n)}a.forceShowAtRange&&(c=d)}let s,v;if(c){const a=c.getStartPosition();s=a,v=a}else s=e.getStartPosition(),v=new g(o,i);return{showAtPosition:s,showAtSecondaryPosition:v}}}class k{constructor(t,e){this._statusBar=e;t.appendChild(this._statusBar.hoverElement)}get hoverElement(){return this._statusBar.hoverElement}get actions(){return this._statusBar.actions}dispose(){this._statusBar.dispose()}}class m extends h{static _DECORATION_OPTIONS=A.register({description:"content-hover-highlight",className:"hoverHighlight"});_renderedParts=[];_fragment;_context;_markdownHoverParticipant;_colorHoverParticipant;_focusedHoverPartIndex=-1;constructor(t,e,r,n,o){super(),this._context=o,this._fragment=document.createDocumentFragment(),this._register(this._renderParts(e,r,o,n)),this._register(this._registerListenersOnRenderedParts()),this._register(this._createEditorDecorations(t,r)),this._updateMarkdownAndColorParticipantInfo(e)}_createEditorDecorations(t,e){if(e.length===0)return h.None;let r=e[0].range;for(const o of e){const i=o.range;r=w.plusRange(r,i)}const n=t.createDecorationsCollection();return n.set([{range:r,options:m._DECORATION_OPTIONS}]),f(()=>{n.clear()})}_renderParts(t,e,r,n){const o=new x(n),i={fragment:this._fragment,statusBar:o,...r},c=new b;for(const v of t){const a=this._renderHoverPartsForParticipant(e,v,i);c.add(a);for(const d of a.renderedHoverParts)this._renderedParts.push({type:"hoverPart",participant:v,hoverPart:d.hoverPart,hoverElement:d.hoverElement})}const s=this._renderStatusBar(this._fragment,o);return s&&(c.add(s),this._renderedParts.push({type:"statusBar",hoverElement:s.hoverElement,actions:s.actions})),f(()=>{c.dispose()})}_renderHoverPartsForParticipant(t,e,r){const n=t.filter(i=>i.owner===e);return n.length>0?e.renderHoverParts(r,n):new R([])}_renderStatusBar(t,e){if(e.hasContent)return new k(t,e)}_registerListenersOnRenderedParts(){const t=new b;return this._renderedParts.forEach((e,r)=>{const n=e.hoverElement;n.tabIndex=0,t.add(l.addDisposableListener(n,l.EventType.FOCUS_IN,o=>{o.stopPropagation(),this._focusedHoverPartIndex=r})),t.add(l.addDisposableListener(n,l.EventType.FOCUS_OUT,o=>{o.stopPropagation(),this._focusedHoverPartIndex=-1}))}),t}_updateMarkdownAndColorParticipantInfo(t){const e=t.find(r=>r instanceof M&&!(r instanceof S));e&&(this._markdownHoverParticipant=e),this._colorHoverParticipant=t.find(r=>r instanceof E)}focusHoverPartWithIndex(t){t<0||t>=this._renderedParts.length||this._renderedParts[t].hoverElement.focus()}getAccessibleContent(){const t=[];for(let e=0;e<this._renderedParts.length;e++)t.push(this.getAccessibleHoverContentAtIndex(e));return t.join(`

`)}getAccessibleHoverContentAtIndex(t){const e=this._renderedParts[t];if(!e)return"";if(e.type==="statusBar"){const r=[P("hoverAccessibilityStatusBar","This is a hover status bar.")];for(const n of e.actions){const o=n.actionKeybindingLabel;o?r.push(P("hoverAccessibilityStatusBarActionWithKeybinding","It has an action with label {0} and keybinding {1}.",n.actionLabel,o)):r.push(P("hoverAccessibilityStatusBarActionWithoutKeybinding","It has an action with label {0}.",n.actionLabel))}return r.join(`
`)}return e.participant.getAccessibleContent(e.hoverPart)}async updateHoverVerbosityLevel(t,e,r){if(!this._markdownHoverParticipant)return;const n=this._normalizedIndexToMarkdownHoverIndexRange(this._markdownHoverParticipant,e);if(n===void 0)return;const o=await this._markdownHoverParticipant.updateMarkdownHoverVerbosityLevel(t,n,r);o&&(this._renderedParts[e]={type:"hoverPart",participant:this._markdownHoverParticipant,hoverPart:o.hoverPart,hoverElement:o.hoverElement},this._context.onContentsChanged())}doesHoverAtIndexSupportVerbosityAction(t,e){if(!this._markdownHoverParticipant)return!1;const r=this._normalizedIndexToMarkdownHoverIndexRange(this._markdownHoverParticipant,t);return r===void 0?!1:this._markdownHoverParticipant.doesMarkdownHoverAtIndexSupportVerbosityAction(r,e)}isColorPickerVisible(){return this._colorHoverParticipant?.isColorPickerVisible()??!1}_normalizedIndexToMarkdownHoverIndexRange(t,e){const r=this._renderedParts[e];if(!r||r.type!=="hoverPart"||!(r.participant===t))return;const o=this._renderedParts.findIndex(i=>i.type==="hoverPart"&&i.participant===t);if(o===-1)throw new C;return e-o}get domNode(){return this._fragment}get domNodeHasChildren(){return this._fragment.hasChildNodes()}get focusedHoverPartIndex(){return this._focusedHoverPartIndex}}export{I as RenderedContentHover};
