var f=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var l=(s,n,e,t)=>{for(var i=t>1?void 0:t?b(n,e):n,o=s.length-1,r;o>=0;o--)(r=s[o])&&(i=(t?r(n,e,i):r(i))||i);return t&&i&&f(n,e,i),i},c=(s,n)=>(e,t)=>n(e,t,s);import*as h from"../../../../../vs/base/browser/dom.js";import{Emitter as C}from"../../../../../vs/base/common/event.js";import{KeyCode as R}from"../../../../../vs/base/common/keyCodes.js";import{Disposable as I}from"../../../../../vs/base/common/lifecycle.js";import{MouseTargetType as v}from"../../../../../vs/editor/browser/editorBrowser.js";import{EditorOption as p}from"../../../../../vs/editor/common/config/editorOptions.js";import"../../../../../vs/editor/common/core/range.js";import{TokenizationRegistry as y}from"../../../../../vs/editor/common/languages.js";import"../../../../../vs/editor/common/standalone/standaloneEnums.js";import{ContentHoverComputer as W}from"../../../../../vs/editor/contrib/hover/browser/contentHoverComputer.js";import{RenderedContentHover as A}from"../../../../../vs/editor/contrib/hover/browser/contentHoverRendered.js";import{HoverResult as P}from"../../../../../vs/editor/contrib/hover/browser/contentHoverTypes.js";import{ContentHoverWidget as S}from"../../../../../vs/editor/contrib/hover/browser/contentHoverWidget.js";import{HoverOperation as M,HoverStartMode as _,HoverStartSource as g}from"../../../../../vs/editor/contrib/hover/browser/hoverOperation.js";import{HoverParticipantRegistry as O,HoverRangeAnchor as d}from"../../../../../vs/editor/contrib/hover/browser/hoverTypes.js";import{isMousePositionWithinElement as E}from"../../../../../vs/editor/contrib/hover/browser/hoverUtils.js";import{IInstantiationService as w}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{IKeybindingService as T}from"../../../../../vs/platform/keybinding/common/keybinding.js";let a=class extends I{constructor(e,t,i){super();this._editor=e;this._instantiationService=t;this._keybindingService=i;this._contentHoverWidget=this._register(this._instantiationService.createInstance(S,this._editor)),this._participants=this._initializeHoverParticipants(),this._computer=new W(this._editor,this._participants),this._hoverOperation=this._register(new M(this._editor,this._computer)),this._registerListeners()}_currentResult=null;_renderedContentHover;_computer;_contentHoverWidget;_participants;_hoverOperation;_onContentsChanged=this._register(new C);onContentsChanged=this._onContentsChanged.event;_initializeHoverParticipants(){const e=[];for(const t of O.getAll()){const i=this._instantiationService.createInstance(t,this._editor);e.push(i)}return e.sort((t,i)=>t.hoverOrdinal-i.hoverOrdinal),this._register(this._contentHoverWidget.onDidResize(()=>{this._participants.forEach(t=>t.handleResize?.())})),e}_registerListeners(){this._register(this._hoverOperation.onResult(t=>{if(!this._computer.anchor)return;const i=t.hasLoadingMessage?this._addLoadingMessage(t.value):t.value;this._withResult(new P(this._computer.anchor,i,t.isComplete))}));const e=this._contentHoverWidget.getDomNode();this._register(h.addStandardDisposableListener(e,"keydown",t=>{t.equals(R.Escape)&&this.hide()})),this._register(h.addStandardDisposableListener(e,"mouseleave",t=>{this._onMouseLeave(t)})),this._register(y.onDidChange(()=>{this._contentHoverWidget.position&&this._currentResult&&this._setCurrentResult(this._currentResult)}))}_startShowingOrUpdateHover(e,t,i,o,r){if(!(this._contentHoverWidget.position&&this._currentResult))return e?(this._startHoverOperationIfNecessary(e,t,i,o,!1),!0):!1;const H=this._editor.getOption(p.hover).sticky,m=r&&this._contentHoverWidget.isMouseGettingCloser(r.event.posx,r.event.posy);return H&&m?(e&&this._startHoverOperationIfNecessary(e,t,i,o,!0),!0):e?this._currentResult.anchor.equals(e)?!0:e.canAdoptVisibleHover(this._currentResult.anchor,this._contentHoverWidget.position)?(this._setCurrentResult(this._currentResult.filter(e)),this._startHoverOperationIfNecessary(e,t,i,o,!1),!0):(this._setCurrentResult(null),this._startHoverOperationIfNecessary(e,t,i,o,!1),!0):(this._setCurrentResult(null),!1)}_startHoverOperationIfNecessary(e,t,i,o,r){this._computer.anchor&&this._computer.anchor.equals(e)||(this._hoverOperation.cancel(),this._computer.anchor=e,this._computer.shouldFocus=o,this._computer.source=i,this._computer.insistOnKeepingHoverVisible=r,this._hoverOperation.start(t))}_setCurrentResult(e){let t=e;if(this._currentResult===t)return;t&&t.hoverParts.length===0&&(t=null),this._currentResult=t,this._currentResult?this._showHover(this._currentResult):this._hideHover()}_addLoadingMessage(e){if(!this._computer.anchor)return e;for(const t of this._participants){if(!t.createLoadingMessage)continue;const i=t.createLoadingMessage(this._computer.anchor);if(i)return e.slice(0).concat([i])}return e}_withResult(e){if(this._contentHoverWidget.position&&this._currentResult&&this._currentResult.isComplete||this._setCurrentResult(e),!e.isComplete)return;const o=e.hoverParts.length===0,r=this._computer.insistOnKeepingHoverVisible;o&&r||this._setCurrentResult(e)}_showHover(e){const t=this._getHoverContext();this._renderedContentHover=new A(this._editor,e,this._participants,this._computer,t,this._keybindingService),this._renderedContentHover.domNodeHasChildren?this._contentHoverWidget.show(this._renderedContentHover):this._renderedContentHover.dispose()}_hideHover(){this._contentHoverWidget.hide()}_getHoverContext(){return{hide:()=>{this.hide()},onContentsChanged:()=>{this._onContentsChanged.fire(),this._contentHoverWidget.onContentsChanged()},setMinimumDimensions:o=>{this._contentHoverWidget.setMinimumDimensions(o)}}}showsOrWillShow(e){if(this._contentHoverWidget.isResizing)return!0;const i=this._findHoverAnchorCandidates(e);if(!(i.length>0))return this._startShowingOrUpdateHover(null,_.Delayed,g.Mouse,!1,e);const r=i[0];return this._startShowingOrUpdateHover(r,_.Delayed,g.Mouse,!1,e)}_findHoverAnchorCandidates(e){const t=[];for(const o of this._participants){if(!o.suggestHoverAnchor)continue;const r=o.suggestHoverAnchor(e);r&&t.push(r)}const i=e.target;switch(i.type){case v.CONTENT_TEXT:{t.push(new d(0,i.range,e.event.posx,e.event.posy));break}case v.CONTENT_EMPTY:{const o=this._editor.getOption(p.fontInfo).typicalHalfwidthCharacterWidth/2;if(!(!i.detail.isAfterLines&&typeof i.detail.horizontalDistanceToText=="number"&&i.detail.horizontalDistanceToText<o))break;t.push(new d(0,i.range,e.event.posx,e.event.posy));break}}return t.sort((o,r)=>r.priority-o.priority),t}_onMouseLeave(e){const t=this._editor.getDomNode();(!t||!E(t,e.x,e.y))&&this.hide()}startShowingAtRange(e,t,i,o){this._startShowingOrUpdateHover(new d(0,e,void 0,void 0),t,i,o,null)}getWidgetContent(){const e=this._contentHoverWidget.getDomNode();if(e.textContent)return e.textContent}async updateHoverVerbosityLevel(e,t,i){this._renderedContentHover?.updateHoverVerbosityLevel(e,t,i)}doesHoverAtIndexSupportVerbosityAction(e,t){return this._renderedContentHover?.doesHoverAtIndexSupportVerbosityAction(e,t)??!1}getAccessibleWidgetContent(){return this._renderedContentHover?.getAccessibleWidgetContent()}getAccessibleWidgetContentAtIndex(e){return this._renderedContentHover?.getAccessibleWidgetContentAtIndex(e)}focusedHoverPartIndex(){return this._renderedContentHover?.focusedHoverPartIndex??-1}containsNode(e){return e?this._contentHoverWidget.getDomNode().contains(e):!1}focus(){this._contentHoverWidget.focus()}focusHoverPartWithIndex(e){this._renderedContentHover?.focusHoverPartWithIndex(e)}scrollUp(){this._contentHoverWidget.scrollUp()}scrollDown(){this._contentHoverWidget.scrollDown()}scrollLeft(){this._contentHoverWidget.scrollLeft()}scrollRight(){this._contentHoverWidget.scrollRight()}pageUp(){this._contentHoverWidget.pageUp()}pageDown(){this._contentHoverWidget.pageDown()}goToTop(){this._contentHoverWidget.goToTop()}goToBottom(){this._contentHoverWidget.goToBottom()}hide(){this._computer.anchor=null,this._hoverOperation.cancel(),this._setCurrentResult(null)}getDomNode(){return this._contentHoverWidget.getDomNode()}get isColorPickerVisible(){return this._renderedContentHover?.isColorPickerVisible()??!1}get isVisibleFromKeyboard(){return this._contentHoverWidget.isVisibleFromKeyboard}get isVisible(){return this._contentHoverWidget.isVisible}get isFocused(){return this._contentHoverWidget.isFocused}get isResizing(){return this._contentHoverWidget.isResizing}get widget(){return this._contentHoverWidget}};a=l([c(1,w),c(2,T)],a);export{a as ContentHoverWidgetWrapper};
