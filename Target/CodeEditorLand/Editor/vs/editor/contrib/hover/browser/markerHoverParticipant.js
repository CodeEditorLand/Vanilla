var F=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var x=(m,e,o,n)=>{for(var r=n>1?void 0:n?N(e,o):e,i=m.length-1,s;i>=0;i--)(s=m[i])&&(r=(n?s(e,o,r):s(r))||r);return n&&r&&F(e,o,r),r},h=(m,e)=>(o,n)=>e(o,n,m);import*as d from"../../../../base/browser/dom.js";import{isNonEmptyArray as R}from"../../../../base/common/arrays.js";import{createCancelablePromise as O,disposableTimeout as $}from"../../../../base/common/async.js";import{onUnexpectedError as H}from"../../../../base/common/errors.js";import{Disposable as q,DisposableStore as S,toDisposable as E}from"../../../../base/common/lifecycle.js";import{basename as Q}from"../../../../base/common/resources.js";import*as k from"../../../../nls.js";import{IMarkerData as P,MarkerSeverity as y}from"../../../../platform/markers/common/markers.js";import{IOpenerService as z}from"../../../../platform/opener/common/opener.js";import{Progress as B}from"../../../../platform/progress/common/progress.js";import{EditorOption as j}from"../../../common/config/editorOptions.js";import{Range as w}from"../../../common/core/range.js";import{CodeActionTriggerType as K}from"../../../common/languages.js";import{ILanguageFeaturesService as U}from"../../../common/services/languageFeatures.js";import{IMarkerDecorationsService as V}from"../../../common/services/markerDecorations.js";import{getCodeActions as G,quickFixCommandId as W}from"../../codeAction/browser/codeAction.js";import{CodeActionController as J}from"../../codeAction/browser/codeActionController.js";import{CodeActionKind as X,CodeActionTriggerSource as Y}from"../../codeAction/common/types.js";import{MarkerController as Z,NextMarkerAction as ee}from"../../gotoError/browser/gotoError.js";import{HoverAnchorType as _,RenderedHoverParts as D}from"./hoverTypes.js";const c=d.$;class re{constructor(e,o,n){this.owner=e;this.range=o;this.marker=n}isValidForHoverAnchor(e){return e.type===_.Range&&this.range.startColumn<=e.range.startColumn&&this.range.endColumn>=e.range.endColumn}}const T={type:K.Invoke,filter:{include:X.QuickFix},triggerAction:Y.QuickFixHover};let I=class{constructor(e,o,n,r){this._editor=e;this._markerDecorationsService=o;this._openerService=n;this._languageFeaturesService=r}hoverOrdinal=1;recentMarkerCodeActionsInfo=void 0;computeSync(e,o){if(!this._editor.hasModel()||e.type!==_.Range&&!e.supportsMarkerHover)return[];const n=this._editor.getModel(),r=e.range.startLineNumber,i=n.getLineMaxColumn(r),s=[];for(const t of o){const l=t.range.startLineNumber===r?t.range.startColumn:1,u=t.range.endLineNumber===r?t.range.endColumn:i,g=this._markerDecorationsService.getMarker(n.uri,t);if(!g)continue;const a=new w(e.range.startLineNumber,l,e.range.startLineNumber,u);s.push(new re(this,a,g))}return s}renderHoverParts(e,o){if(!o.length)return new D([]);const n=new S,r=[];o.forEach(s=>{const t=this._renderMarkerHover(s);e.fragment.appendChild(t.hoverElement),r.push(t)});const i=o.length===1?o[0]:o.sort((s,t)=>y.compare(s.marker.severity,t.marker.severity))[0];return this.renderMarkerStatusbar(e,i,n),new D(r)}getAccessibleContent(e){return e.marker.message}_renderMarkerHover(e){const o=new S,n=c("div.hover-row"),r=d.append(n,c("div.marker.hover-contents")),{source:i,message:s,code:t,relatedInformation:l}=e.marker;this._editor.applyFontInfo(r);const u=d.append(r,c("span"));if(u.style.whiteSpace="pre-wrap",u.innerText=s,i||t)if(t&&typeof t!="string"){const a=c("span");if(i){const p=d.append(a,c("span"));p.innerText=i}const f=d.append(a,c("a.code-link"));f.setAttribute("href",t.target.toString(!0)),o.add(d.addDisposableListener(f,"click",p=>{this._openerService.open(t.target,{allowCommands:!0}),p.preventDefault(),p.stopPropagation()}));const C=d.append(f,c("span"));C.innerText=t.value;const v=d.append(r,a);v.style.opacity="0.6",v.style.paddingLeft="6px"}else{const a=d.append(r,c("span"));a.style.opacity="0.6",a.style.paddingLeft="6px",a.innerText=i&&t?`${i}(${t})`:i||`(${t})`}if(R(l))for(const{message:a,resource:f,startLineNumber:C,startColumn:v}of l){const p=d.append(r,c("div"));p.style.marginTop="8px";const b=d.append(p,c("a"));b.innerText=`${Q(f)}(${C}, ${v}): `,b.style.cursor="pointer",o.add(d.addDisposableListener(b,"click",M=>{if(M.stopPropagation(),M.preventDefault(),this._openerService){const L={selection:{startLineNumber:C,startColumn:v}};this._openerService.open(f,{fromUserGesture:!0,editorOptions:L}).catch(H)}}));const A=d.append(p,c("span"));A.innerText=a,this._editor.applyFontInfo(A)}return{hoverPart:e,hoverElement:n,dispose:()=>o.dispose()}}renderMarkerStatusbar(e,o,n){if(o.marker.severity===y.Error||o.marker.severity===y.Warning||o.marker.severity===y.Info){const r=Z.get(this._editor);r&&e.statusBar.addAction({label:k.localize("view problem","View Problem"),commandId:ee.ID,run:()=>{e.hide(),r.showAtMarker(o.marker),this._editor.focus()}})}if(!this._editor.getOption(j.readOnly)){const r=e.statusBar.append(c("div"));this.recentMarkerCodeActionsInfo&&(P.makeKey(this.recentMarkerCodeActionsInfo.marker)===P.makeKey(o.marker)?this.recentMarkerCodeActionsInfo.hasCodeActions||(r.textContent=k.localize("noQuickFixes","No quick fixes available")):this.recentMarkerCodeActionsInfo=void 0);const i=this.recentMarkerCodeActionsInfo&&!this.recentMarkerCodeActionsInfo.hasCodeActions?q.None:$(()=>r.textContent=k.localize("checkingForQuickFixes","Checking for quick fixes..."),200,n);r.textContent||(r.textContent="\xA0");const s=this.getCodeActions(o.marker);n.add(E(()=>s.cancel())),s.then(t=>{if(i.dispose(),this.recentMarkerCodeActionsInfo={marker:o.marker,hasCodeActions:t.validActions.length>0},!this.recentMarkerCodeActionsInfo.hasCodeActions){t.dispose(),r.textContent=k.localize("noQuickFixes","No quick fixes available");return}r.style.display="none";let l=!1;n.add(E(()=>{l||t.dispose()})),e.statusBar.addAction({label:k.localize("quick fixes","Quick Fix..."),commandId:W,run:u=>{l=!0;const g=J.get(this._editor),a=d.getDomNodePagePosition(u);e.hide(),g?.showCodeActions(T,t,{x:a.left,y:a.top,width:a.width,height:a.height})}})},H)}}getCodeActions(e){return O(o=>G(this._languageFeaturesService.codeActionProvider,this._editor.getModel(),new w(e.startLineNumber,e.startColumn,e.endLineNumber,e.endColumn),T,B.None,o))}};I=x([h(1,V),h(2,z),h(3,U)],I);export{re as MarkerHover,I as MarkerHoverParticipant};
