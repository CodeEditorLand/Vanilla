var g=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var p=(a,t,e,o)=>{for(var i=o>1?void 0:o?f(t,e):t,r=a.length-1,s;r>=0;r--)(s=a[r])&&(i=(o?s(t,e,i):s(i))||i);return o&&i&&g(t,e,i),i},h=(a,t)=>(e,o)=>t(e,o,a);import*as l from"../../../../../vs/base/browser/dom.js";import{HoverWidget as b}from"../../../../../vs/base/browser/ui/hover/hoverWidget.js";import{Disposable as y,DisposableStore as N}from"../../../../../vs/base/common/lifecycle.js";import{MouseTargetType as _}from"../../../../../vs/editor/browser/editorBrowser.js";import{MarkdownRenderer as D}from"../../../../../vs/editor/browser/widget/markdownRenderer/browser/markdownRenderer.js";import{EditorOption as m}from"../../../../../vs/editor/common/config/editorOptions.js";import{ILanguageService as M}from"../../../../../vs/editor/common/languages/language.js";import{HoverOperation as I,HoverStartMode as v}from"../../../../../vs/editor/contrib/hover/browser/hoverOperation.js";import"../../../../../vs/editor/contrib/hover/browser/hoverTypes.js";import{isMousePositionWithinElement as C}from"../../../../../vs/editor/contrib/hover/browser/hoverUtils.js";import{MarginHoverComputer as O}from"../../../../../vs/editor/contrib/hover/browser/marginHoverComputer.js";import{IOpenerService as E}from"../../../../../vs/platform/opener/common/opener.js";const c=l.$;let n=class extends y{static ID="editor.contrib.modesGlyphHoverWidget";_editor;_hover;_isVisible;_messages;_markdownRenderer;_computer;_hoverOperation;_renderDisposeables=this._register(new N);constructor(t,e,o){super(),this._editor=t,this._isVisible=!1,this._messages=[],this._hover=this._register(new b),this._hover.containerDomNode.classList.toggle("hidden",!this._isVisible),this._markdownRenderer=this._register(new D({editor:this._editor},e,o)),this._computer=new O(this._editor),this._hoverOperation=this._register(new I(this._editor,this._computer)),this._register(this._hoverOperation.onResult(i=>{this._withResult(i.value)})),this._register(this._editor.onDidChangeModelDecorations(()=>this._onModelDecorationsChanged())),this._register(this._editor.onDidChangeConfiguration(i=>{i.hasChanged(m.fontInfo)&&this._updateFont()})),this._register(l.addStandardDisposableListener(this._hover.containerDomNode,"mouseleave",i=>{this._onMouseLeave(i)})),this._editor.addOverlayWidget(this)}dispose(){this._editor.removeOverlayWidget(this),super.dispose()}getId(){return n.ID}getDomNode(){return this._hover.containerDomNode}getPosition(){return null}_updateFont(){Array.prototype.slice.call(this._hover.contentsDomNode.getElementsByClassName("code")).forEach(e=>this._editor.applyFontInfo(e))}_onModelDecorationsChanged(){this._isVisible&&(this._hoverOperation.cancel(),this._hoverOperation.start(v.Delayed))}showsOrWillShow(t){const e=t.target;return e.type===_.GUTTER_GLYPH_MARGIN&&e.detail.glyphMarginLane?(this._startShowingAt(e.position.lineNumber,e.detail.glyphMarginLane),!0):e.type===_.GUTTER_LINE_NUMBERS?(this._startShowingAt(e.position.lineNumber,"lineNo"),!0):!1}_startShowingAt(t,e){this._computer.lineNumber===t&&this._computer.lane===e||(this._hoverOperation.cancel(),this.hide(),this._computer.lineNumber=t,this._computer.lane=e,this._hoverOperation.start(v.Delayed))}hide(){this._computer.lineNumber=-1,this._hoverOperation.cancel(),this._isVisible&&(this._isVisible=!1,this._hover.containerDomNode.classList.toggle("hidden",!this._isVisible))}_withResult(t){this._messages=t,this._messages.length>0?this._renderMessages(this._computer.lineNumber,this._messages):this.hide()}_renderMessages(t,e){this._renderDisposeables.clear();const o=document.createDocumentFragment();for(const i of e){const r=c("div.hover-row.markdown-hover"),s=l.append(r,c("div.hover-contents")),d=this._renderDisposeables.add(this._markdownRenderer.render(i.value));s.appendChild(d.element),o.appendChild(r)}this._updateContents(o),this._showAt(t)}_updateContents(t){this._hover.contentsDomNode.textContent="",this._hover.contentsDomNode.appendChild(t),this._updateFont()}_showAt(t){this._isVisible||(this._isVisible=!0,this._hover.containerDomNode.classList.toggle("hidden",!this._isVisible));const e=this._editor.getLayoutInfo(),o=this._editor.getTopForLineNumber(t),i=this._editor.getScrollTop(),r=this._editor.getOption(m.lineHeight),s=this._hover.containerDomNode.clientHeight,d=o-i-(s-r)/2,u=e.glyphMarginLeft+e.glyphMarginWidth+(this._computer.lane==="lineNo"?e.lineNumbersWidth:0);this._hover.containerDomNode.style.left=`${u}px`,this._hover.containerDomNode.style.top=`${Math.max(Math.round(d),0)}px`}_onMouseLeave(t){const e=this._editor.getDomNode();(!e||!C(e,t.x,t.y))&&this.hide()}};n=p([h(1,M),h(2,E)],n);export{n as MarginHoverWidget};
