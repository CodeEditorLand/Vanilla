var C=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var _=(c,s,e,t)=>{for(var o=t>1?void 0:t?b(s,e):s,i=c.length-1,n;i>=0;i--)(n=c[i])&&(o=(t?n(s,e,o):n(o))||o);return t&&o&&C(s,e,o),o},v=(c,s)=>(e,t)=>s(e,t,c);import{DECREASE_HOVER_VERBOSITY_ACTION_ID as W,INCREASE_HOVER_VERBOSITY_ACTION_ID as E,SHOW_OR_FOCUS_HOVER_ACTION_ID as S}from"./hoverActionIds.js";import"../../../../base/browser/keyboardEvent.js";import{KeyCode as h}from"../../../../base/common/keyCodes.js";import{Disposable as M,DisposableStore as f}from"../../../../base/common/lifecycle.js";import"../../../browser/editorBrowser.js";import{EditorOption as g}from"../../../common/config/editorOptions.js";import"../../../common/core/range.js";import"../../../common/editorCommon.js";import"./hoverOperation.js";import{IInstantiationService as H}from"../../../../platform/instantiation/common/instantiation.js";import"./hoverTypes.js";import{InlineSuggestionHintsContentWidget as m}from"../../inlineCompletions/browser/hintsWidget/inlineCompletionsHintsWidget.js";import{IKeybindingService as I}from"../../../../platform/keybinding/common/keybinding.js";import{ResultKind as p}from"../../../../platform/keybinding/common/keybindingResolver.js";import"../../../common/languages.js";import{RunOnceScheduler as y}from"../../../../base/common/async.js";import{isMousePositionWithinElement as D}from"./hoverUtils.js";import{ContentHoverWidgetWrapper as O}from"./contentHoverWidgetWrapper.js";import"./hover.css";import{Emitter as k}from"../../../../base/common/event.js";const l=!1;let a=class extends M{constructor(e,t,o){super();this._editor=e;this._instantiationService=t;this._keybindingService=o;this._reactToEditorMouseMoveRunner=this._register(new y(()=>this._reactToEditorMouseMove(this._mouseMoveEvent),0)),this._hookListeners(),this._register(this._editor.onDidChangeConfiguration(i=>{i.hasChanged(g.hover)&&(this._unhookListeners(),this._hookListeners())}))}_onHoverContentsChanged=this._register(new k);onHoverContentsChanged=this._onHoverContentsChanged.event;static ID="editor.contrib.contentHover";shouldKeepOpenOnEditorMouseMoveOrLeave=!1;_listenersStore=new f;_contentWidget;_mouseMoveEvent;_reactToEditorMouseMoveRunner;_hoverSettings;_hoverState={mouseDown:!1,activatedByDecoratorClick:!1};static get(e){return e.getContribution(a.ID)}_hookListeners(){const e=this._editor.getOption(g.hover);this._hoverSettings={enabled:e.enabled,sticky:e.sticky,hidingDelay:e.hidingDelay},e.enabled?(this._listenersStore.add(this._editor.onMouseDown(t=>this._onEditorMouseDown(t))),this._listenersStore.add(this._editor.onMouseUp(()=>this._onEditorMouseUp())),this._listenersStore.add(this._editor.onMouseMove(t=>this._onEditorMouseMove(t))),this._listenersStore.add(this._editor.onKeyDown(t=>this._onKeyDown(t)))):(this._listenersStore.add(this._editor.onMouseMove(t=>this._onEditorMouseMove(t))),this._listenersStore.add(this._editor.onKeyDown(t=>this._onKeyDown(t)))),this._listenersStore.add(this._editor.onMouseLeave(t=>this._onEditorMouseLeave(t))),this._listenersStore.add(this._editor.onDidChangeModel(()=>{this._cancelScheduler(),this._hideWidgets()})),this._listenersStore.add(this._editor.onDidChangeModelContent(()=>this._cancelScheduler())),this._listenersStore.add(this._editor.onDidScrollChange(t=>this._onEditorScrollChanged(t)))}_unhookListeners(){this._listenersStore.clear()}_cancelScheduler(){this._mouseMoveEvent=void 0,this._reactToEditorMouseMoveRunner.cancel()}_onEditorScrollChanged(e){(e.scrollTopChanged||e.scrollLeftChanged)&&this._hideWidgets()}_onEditorMouseDown(e){this._hoverState.mouseDown=!0,!this._shouldNotHideCurrentHoverWidget(e)&&this._hideWidgets()}_shouldNotHideCurrentHoverWidget(e){return this._isMouseOnContentHoverWidget(e)||this._isContentWidgetResizing()}_isMouseOnContentHoverWidget(e){const t=this._contentWidget?.getDomNode();return t?D(t,e.event.posx,e.event.posy):!1}_onEditorMouseUp(){this._hoverState.mouseDown=!1}_onEditorMouseLeave(e){this.shouldKeepOpenOnEditorMouseMoveOrLeave||(this._cancelScheduler(),this._shouldNotHideCurrentHoverWidget(e))||l||this._hideWidgets()}_shouldNotRecomputeCurrentHoverWidget(e){const t=this._hoverSettings.sticky,o=(r,d)=>{const u=this._isMouseOnContentHoverWidget(r);return d&&u},i=r=>{const d=this._isMouseOnContentHoverWidget(r),u=this._contentWidget?.isColorPickerVisible??!1;return d&&u},n=(r,d)=>(d&&this._contentWidget?.containsNode(r.event.browserEvent.view?.document.activeElement)&&!r.event.browserEvent.view?.getSelection()?.isCollapsed)??!1;return o(e,t)||i(e)||n(e,t)}_onEditorMouseMove(e){if(this.shouldKeepOpenOnEditorMouseMoveOrLeave||(this._mouseMoveEvent=e,this._contentWidget?.isFocused||this._contentWidget?.isResizing))return;const t=this._hoverSettings.sticky;if(t&&this._contentWidget?.isVisibleFromKeyboard)return;if(this._shouldNotRecomputeCurrentHoverWidget(e)){this._reactToEditorMouseMoveRunner.cancel();return}const i=this._hoverSettings.hidingDelay;if(this._contentWidget?.isVisible&&t&&i>0){this._reactToEditorMouseMoveRunner.isScheduled()||this._reactToEditorMouseMoveRunner.schedule(i);return}this._reactToEditorMouseMove(e)}_reactToEditorMouseMove(e){if(!e)return;const o=e.target.element?.classList.contains("colorpicker-color-decoration"),i=this._editor.getOption(g.colorDecoratorsActivatedOn),n=this._hoverSettings.enabled,r=this._hoverState.activatedByDecoratorClick;if(o&&(i==="click"&&!r||i==="hover"&&!n&&!l||i==="clickAndHover"&&!n&&!r)||!o&&!n&&!r){this._hideWidgets();return}this._tryShowHoverWidget(e)||l||this._hideWidgets()}_tryShowHoverWidget(e){return this._getOrCreateContentWidget().showsOrWillShow(e)}_onKeyDown(e){if(!this._editor.hasModel())return;const t=this._keybindingService.softDispatch(e,this._editor.getDomNode()),o=t.kind===p.MoreChordsNeeded||t.kind===p.KbFound&&(t.commandId===S||t.commandId===E||t.commandId===W)&&this._contentWidget?.isVisible;e.keyCode===h.Ctrl||e.keyCode===h.Alt||e.keyCode===h.Meta||e.keyCode===h.Shift||o||this._hideWidgets()}_hideWidgets(){l||this._hoverState.mouseDown&&this._contentWidget?.isColorPickerVisible||m.dropDownVisible||(this._hoverState.activatedByDecoratorClick=!1,this._contentWidget?.hide())}_getOrCreateContentWidget(){return this._contentWidget||(this._contentWidget=this._instantiationService.createInstance(O,this._editor),this._listenersStore.add(this._contentWidget.onContentsChanged(()=>this._onHoverContentsChanged.fire()))),this._contentWidget}hideContentHover(){this._hideWidgets()}showContentHover(e,t,o,i,n=!1){this._hoverState.activatedByDecoratorClick=n,this._getOrCreateContentWidget().startShowingAtRange(e,t,o,i)}_isContentWidgetResizing(){return this._contentWidget?.widget.isResizing||!1}focusedHoverPartIndex(){return this._getOrCreateContentWidget().focusedHoverPartIndex()}doesHoverAtIndexSupportVerbosityAction(e,t){return this._getOrCreateContentWidget().doesHoverAtIndexSupportVerbosityAction(e,t)}updateHoverVerbosityLevel(e,t,o){this._getOrCreateContentWidget().updateHoverVerbosityLevel(e,t,o)}focus(){this._contentWidget?.focus()}focusHoverPartWithIndex(e){this._contentWidget?.focusHoverPartWithIndex(e)}scrollUp(){this._contentWidget?.scrollUp()}scrollDown(){this._contentWidget?.scrollDown()}scrollLeft(){this._contentWidget?.scrollLeft()}scrollRight(){this._contentWidget?.scrollRight()}pageUp(){this._contentWidget?.pageUp()}pageDown(){this._contentWidget?.pageDown()}goToTop(){this._contentWidget?.goToTop()}goToBottom(){this._contentWidget?.goToBottom()}getWidgetContent(){return this._contentWidget?.getWidgetContent()}getAccessibleWidgetContent(){return this._contentWidget?.getAccessibleWidgetContent()}getAccessibleWidgetContentAtIndex(e){return this._contentWidget?.getAccessibleWidgetContentAtIndex(e)}get isColorPickerVisible(){return this._contentWidget?.isColorPickerVisible}get isHoverVisible(){return this._contentWidget?.isVisible}dispose(){super.dispose(),this._unhookListeners(),this._listenersStore.dispose(),this._contentWidget?.dispose()}};a=_([v(1,H),v(2,I)],a);export{a as ContentHoverController};
