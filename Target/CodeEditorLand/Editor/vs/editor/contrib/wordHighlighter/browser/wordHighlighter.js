var N=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var v=(d,e,o,i)=>{for(var t=i>1?void 0:i?F(e,o):e,r=d.length-1,n;r>=0;r--)(n=d[r])&&(t=(i?n(e,o,t):n(t))||t);return i&&t&&N(e,o,t),t},g=(d,e)=>(o,i)=>e(o,i,d);import{alert as R}from"../../../../base/browser/ui/aria/aria.js";import{createCancelablePromise as L,Delayer as O,first as b}from"../../../../base/common/async.js";import{CancellationToken as V}from"../../../../base/common/cancellation.js";import{onUnexpectedError as U,onUnexpectedExternalError as y}from"../../../../base/common/errors.js";import{KeyCode as P,KeyMod as K}from"../../../../base/common/keyCodes.js";import{Disposable as $,DisposableStore as B}from"../../../../base/common/lifecycle.js";import{ResourceMap as h}from"../../../../base/common/map.js";import{matchesScheme as z,Schemas as m}from"../../../../base/common/network.js";import{isEqual as H}from"../../../../base/common/resources.js";import*as D from"../../../../nls.js";import{IContextKeyService as G,RawContextKey as W}from"../../../../platform/contextkey/common/contextkey.js";import"../../../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as I}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{isDiffEditor as Q}from"../../../browser/editorBrowser.js";import{EditorAction as T,EditorContributionInstantiation as j,registerEditorAction as w,registerEditorContribution as J,registerModelAndPositionCommand as X}from"../../../browser/editorExtensions.js";import{ICodeEditorService as x}from"../../../browser/services/codeEditorService.js";import{EditorOption as f}from"../../../common/config/editorOptions.js";import"../../../common/core/position.js";import{Range as k}from"../../../common/core/range.js";import"../../../common/core/selection.js";import"../../../common/core/wordHelper.js";import{CursorChangeReason as Y}from"../../../common/cursorEvents.js";import"../../../common/editorCommon.js";import{EditorContextKeys as C}from"../../../common/editorContextKeys.js";import{registerEditorFeature as Z}from"../../../common/editorFeatures.js";import"../../../common/languageFeatureRegistry.js";import"../../../common/languages.js";import{score as ee}from"../../../common/languageSelector.js";import{shouldSynchronizeModel as te}from"../../../common/model.js";import{ILanguageFeaturesService as _}from"../../../common/services/languageFeatures.js";import{getHighlightDecorationOptions as oe}from"./highlightDecorations.js";import{TextualMultiDocumentHighlightFeature as ie}from"./textualHighlightProvider.js";const M=new W("hasWordHighlights",!1);function S(d,e,o,i){const t=d.ordered(e);return b(t.map(r=>()=>Promise.resolve(r.provideDocumentHighlights(e,o,i)).then(void 0,y)),r=>r!=null).then(r=>{if(r){const n=new h;return n.set(e.uri,r),n}return new h})}function re(d,e,o,i,t,r){const n=d.ordered(e);return b(n.map(l=>()=>{const u=r.filter(c=>te(c)).filter(c=>ee(l.selector,c.uri,c.getLanguageId(),!0,void 0,void 0)>0);return Promise.resolve(l.provideMultiDocumentHighlights(e,o,u,t)).then(void 0,y)}),l=>l!=null)}class q{constructor(e,o,i){this._model=e;this._selection=o;this._wordSeparators=i;this._wordRange=this._getCurrentWordRange(e,o),this._result=null}_wordRange;_result;get result(){return this._result||(this._result=L(e=>this._compute(this._model,this._selection,this._wordSeparators,e))),this._result}_getCurrentWordRange(e,o){const i=e.getWordAtPosition(o.getPosition());return i?new k(o.startLineNumber,i.startColumn,o.startLineNumber,i.endColumn):null}isValid(e,o,i){const t=o.startLineNumber,r=o.startColumn,n=o.endColumn,l=this._getCurrentWordRange(e,o);let u=!!(this._wordRange&&this._wordRange.equalsRange(l));for(let c=0,A=i.length;!u&&c<A;c++){const p=i.getRange(c);p&&p.startLineNumber===t&&p.startColumn<=r&&p.endColumn>=n&&(u=!0)}return u}cancel(){this.result.cancel()}}class ne extends q{_providers;constructor(e,o,i,t){super(e,o,i),this._providers=t}_compute(e,o,i,t){return S(this._providers,e,o.getPosition(),t).then(r=>r||new h)}}class se extends q{_providers;_otherModels;constructor(e,o,i,t,r){super(e,o,i),this._providers=t,this._otherModels=r}_compute(e,o,i,t){return re(this._providers,e,o.getPosition(),i,t,this._otherModels).then(r=>r||new h)}}function le(d,e,o,i,t){return new ne(e,o,t,d)}function de(d,e,o,i,t,r){return new se(e,o,t,d,r)}X("_executeDocumentHighlights",async(d,e,o)=>{const i=d.get(_);return(await S(i.documentHighlightProvider,e,o,V.None))?.get(e.uri)});let s=class{editor;providers;multiDocumentProviders;model;decorations;toUnhook=new B;codeEditorService;occurrencesHighlight;workerRequestTokenId=0;workerRequest;workerRequestCompleted=!1;workerRequestValue=new h;lastCursorPositionChangeTime=0;renderDecorationsTimer=-1;_hasWordHighlights;_ignorePositionChangeEvent;runDelayer=this.toUnhook.add(new O(50));static storedDecorationIDs=new h;static query=null;constructor(e,o,i,t,r){this.editor=e,this.providers=o,this.multiDocumentProviders=i,this.codeEditorService=r,this._hasWordHighlights=M.bindTo(t),this._ignorePositionChangeEvent=!1,this.occurrencesHighlight=this.editor.getOption(f.occurrencesHighlight),this.model=this.editor.getModel(),this.toUnhook.add(e.onDidChangeCursorPosition(n=>{this._ignorePositionChangeEvent||this.occurrencesHighlight!=="off"&&this.runDelayer.trigger(()=>{this._onPositionChanged(n)})})),this.toUnhook.add(e.onDidFocusEditorText(n=>{this.occurrencesHighlight!=="off"&&(this.workerRequest||this.runDelayer.trigger(()=>{this._run()}))})),this.toUnhook.add(e.onDidChangeModelContent(n=>{z(this.model.uri,"output")||this._stopAll()})),this.toUnhook.add(e.onDidChangeModel(n=>{!n.newModelUrl&&n.oldModelUrl?this._stopSingular():s.query&&this._run()})),this.toUnhook.add(e.onDidChangeConfiguration(n=>{const l=this.editor.getOption(f.occurrencesHighlight);if(this.occurrencesHighlight!==l)switch(this.occurrencesHighlight=l,l){case"off":this._stopAll();break;case"singleFile":this._stopAll(s.query?.modelInfo?.model);break;case"multiFile":s.query&&this._run(!0);break;default:console.warn("Unknown occurrencesHighlight setting value:",l);break}})),this.decorations=this.editor.createDecorationsCollection(),this.workerRequestTokenId=0,this.workerRequest=null,this.workerRequestCompleted=!1,this.lastCursorPositionChangeTime=0,this.renderDecorationsTimer=-1,s.query&&this._run()}hasDecorations(){return this.decorations.length>0}restore(){this.occurrencesHighlight!=="off"&&(this.runDelayer.cancel(),this._run())}stop(){this.occurrencesHighlight!=="off"&&this._stopAll()}_getSortedHighlights(){return this.decorations.getRanges().sort(k.compareRangesUsingStarts)}moveNext(){const e=this._getSortedHighlights(),i=(e.findIndex(r=>r.containsPosition(this.editor.getPosition()))+1)%e.length,t=e[i];try{this._ignorePositionChangeEvent=!0,this.editor.setPosition(t.getStartPosition()),this.editor.revealRangeInCenterIfOutsideViewport(t);const r=this._getWord();if(r){const n=this.editor.getModel().getLineContent(t.startLineNumber);R(`${n}, ${i+1} of ${e.length} for '${r.word}'`)}}finally{this._ignorePositionChangeEvent=!1}}moveBack(){const e=this._getSortedHighlights(),i=(e.findIndex(r=>r.containsPosition(this.editor.getPosition()))-1+e.length)%e.length,t=e[i];try{this._ignorePositionChangeEvent=!0,this.editor.setPosition(t.getStartPosition()),this.editor.revealRangeInCenterIfOutsideViewport(t);const r=this._getWord();if(r){const n=this.editor.getModel().getLineContent(t.startLineNumber);R(`${n}, ${i+1} of ${e.length} for '${r.word}'`)}}finally{this._ignorePositionChangeEvent=!1}}_removeSingleDecorations(){if(!this.editor.hasModel())return;const e=s.storedDecorationIDs.get(this.editor.getModel().uri);e&&(this.editor.removeDecorations(e),s.storedDecorationIDs.delete(this.editor.getModel().uri),this.decorations.length>0&&(this.decorations.clear(),this._hasWordHighlights.set(!1)))}_removeAllDecorations(e){const o=this.codeEditorService.listCodeEditors(),i=[];for(const t of o){if(!t.hasModel()||H(t.getModel().uri,e?.uri))continue;const r=s.storedDecorationIDs.get(t.getModel().uri);if(!r)continue;t.removeDecorations(r),i.push(t.getModel().uri);const n=a.get(t);n?.wordHighlighter&&n.wordHighlighter.decorations.length>0&&(n.wordHighlighter.decorations.clear(),n.wordHighlighter.workerRequest=null,n.wordHighlighter._hasWordHighlights.set(!1))}for(const t of i)s.storedDecorationIDs.delete(t)}_stopSingular(){this._removeSingleDecorations(),this.editor.hasTextFocus()&&(this.editor.getModel()?.uri.scheme!==m.vscodeNotebookCell&&s.query?.modelInfo?.model.uri.scheme!==m.vscodeNotebookCell?(s.query=null,this._run()):s.query?.modelInfo&&(s.query.modelInfo=null)),this.renderDecorationsTimer!==-1&&(clearTimeout(this.renderDecorationsTimer),this.renderDecorationsTimer=-1),this.workerRequest!==null&&(this.workerRequest.cancel(),this.workerRequest=null),this.workerRequestCompleted||(this.workerRequestTokenId++,this.workerRequestCompleted=!0)}_stopAll(e){this._removeAllDecorations(e),this.renderDecorationsTimer!==-1&&(clearTimeout(this.renderDecorationsTimer),this.renderDecorationsTimer=-1),this.workerRequest!==null&&(this.workerRequest.cancel(),this.workerRequest=null),this.workerRequestCompleted||(this.workerRequestTokenId++,this.workerRequestCompleted=!0)}_onPositionChanged(e){if(this.occurrencesHighlight==="off"){this._stopAll();return}if(e.reason!==Y.Explicit&&this.editor.getModel()?.uri.scheme!==m.vscodeNotebookCell){this._stopAll();return}this._run()}_getWord(){const e=this.editor.getSelection(),o=e.startLineNumber,i=e.startColumn;return this.model.isDisposed()?null:this.model.getWordAtPosition({lineNumber:o,column:i})}getOtherModelsToHighlight(e){if(!e)return[];if(e.uri.scheme===m.vscodeNotebookCell){const r=[],n=this.codeEditorService.listCodeEditors();for(const l of n){const u=l.getModel();u&&u!==e&&u.uri.scheme===m.vscodeNotebookCell&&r.push(u)}return r}const i=[],t=this.codeEditorService.listCodeEditors();for(const r of t){if(!Q(r))continue;const n=r.getModel();n&&e===n.modified&&i.push(n.modified)}if(i.length)return i;if(this.occurrencesHighlight==="singleFile")return[];for(const r of t){const n=r.getModel();n&&n!==e&&i.push(n)}return i}_run(e){let o;if(this.editor.hasTextFocus()){const t=this.editor.getSelection();if(!t||t.startLineNumber!==t.endLineNumber){s.query=null,this._stopAll();return}const r=t.startColumn,n=t.endColumn,l=this._getWord();if(!l||l.startColumn>r||l.endColumn<n){s.query=null,this._stopAll();return}o=this.workerRequest&&this.workerRequest.isValid(this.model,t,this.decorations),s.query={modelInfo:{model:this.model,selection:t},word:l}}else if(!s.query){this._stopAll();return}if(this.lastCursorPositionChangeTime=new Date().getTime(),o)this.workerRequestCompleted&&this.renderDecorationsTimer!==-1&&(clearTimeout(this.renderDecorationsTimer),this.renderDecorationsTimer=-1,this._beginRenderDecorations());else if(H(this.editor.getModel().uri,s.query.modelInfo?.model.uri)){if(!e){const n=this.decorations.getRanges();for(const l of n)if(l.containsPosition(this.editor.getPosition()))return}this._stopAll(e?this.model:void 0);const t=++this.workerRequestTokenId;this.workerRequestCompleted=!1;const r=this.getOtherModelsToHighlight(this.editor.getModel());if(!s.query||!s.query.modelInfo||s.query.modelInfo.model.isDisposed())return;this.workerRequest=this.computeWithModel(s.query.modelInfo.model,s.query.modelInfo.selection,s.query.word,r),this.workerRequest?.result.then(n=>{t===this.workerRequestTokenId&&(this.workerRequestCompleted=!0,this.workerRequestValue=n||[],this._beginRenderDecorations())},U)}}computeWithModel(e,o,i,t){return t.length?de(this.multiDocumentProviders,e,o,i,this.editor.getOption(f.wordSeparators),t):le(this.providers,e,o,i,this.editor.getOption(f.wordSeparators))}_beginRenderDecorations(){const e=new Date().getTime(),o=this.lastCursorPositionChangeTime+250;e>=o?(this.renderDecorationsTimer=-1,this.renderDecorations()):this.renderDecorationsTimer=setTimeout(()=>{this.renderDecorations()},o-e)}renderDecorations(){this.renderDecorationsTimer=-1;const e=this.codeEditorService.listCodeEditors();for(const o of e){const i=a.get(o);if(!i)continue;const t=[],r=o.getModel()?.uri;if(r&&this.workerRequestValue.has(r)){const n=s.storedDecorationIDs.get(r),l=this.workerRequestValue.get(r);if(l)for(const c of l)c.range&&t.push({range:c.range,options:oe(c.kind)});let u=[];o.changeDecorations(c=>{u=c.deltaDecorations(n??[],t)}),s.storedDecorationIDs=s.storedDecorationIDs.set(r,u),t.length>0&&(i.wordHighlighter?.decorations.set(t),i.wordHighlighter?._hasWordHighlights.set(!0))}}}dispose(){this._stopSingular(),this.toUnhook.dispose()}};s=v([g(4,x)],s);let a=class extends ${static ID="editor.contrib.wordHighlighter";static get(e){return e.getContribution(a.ID)}_wordHighlighter;constructor(e,o,i,t){super(),this._wordHighlighter=null;const r=()=>{e.hasModel()&&!e.getModel().isTooLargeForTokenization()&&(this._wordHighlighter=new s(e,i.documentHighlightProvider,i.multiDocumentHighlightProvider,o,t))};this._register(e.onDidChangeModel(n=>{this._wordHighlighter&&(this._wordHighlighter.dispose(),this._wordHighlighter=null),r()})),r()}get wordHighlighter(){return this._wordHighlighter}saveViewState(){return!!(this._wordHighlighter&&this._wordHighlighter.hasDecorations())}moveNext(){this._wordHighlighter?.moveNext()}moveBack(){this._wordHighlighter?.moveBack()}restoreViewState(e){this._wordHighlighter&&e&&this._wordHighlighter.restore()}stopHighlighting(){this._wordHighlighter?.stop()}dispose(){this._wordHighlighter&&(this._wordHighlighter.dispose(),this._wordHighlighter=null),super.dispose()}};a=v([g(1,G),g(2,_),g(3,x)],a);class E extends T{_isNext;constructor(e,o){super(o),this._isNext=e}run(e,o){const i=a.get(o);i&&(this._isNext?i.moveNext():i.moveBack())}}class ce extends E{constructor(){super(!0,{id:"editor.action.wordHighlight.next",label:D.localize("wordHighlight.next.label","Go to Next Symbol Highlight"),alias:"Go to Next Symbol Highlight",precondition:M,kbOpts:{kbExpr:C.editorTextFocus,primary:P.F7,weight:I.EditorContrib}})}}class ue extends E{constructor(){super(!1,{id:"editor.action.wordHighlight.prev",label:D.localize("wordHighlight.previous.label","Go to Previous Symbol Highlight"),alias:"Go to Previous Symbol Highlight",precondition:M,kbOpts:{kbExpr:C.editorTextFocus,primary:K.Shift|P.F7,weight:I.EditorContrib}})}}class ae extends T{constructor(){super({id:"editor.action.wordHighlight.trigger",label:D.localize("wordHighlight.trigger.label","Trigger Symbol Highlight"),alias:"Trigger Symbol Highlight",precondition:void 0,kbOpts:{kbExpr:C.editorTextFocus,primary:0,weight:I.EditorContrib}})}run(e,o,i){const t=a.get(o);t&&t.restoreViewState(!0)}}J(a.ID,a,j.Eager),w(ce),w(ue),w(ae),Z(ie);export{a as WordHighlighterContribution,re as getOccurrencesAcrossMultipleModels,S as getOccurrencesAtPosition};
