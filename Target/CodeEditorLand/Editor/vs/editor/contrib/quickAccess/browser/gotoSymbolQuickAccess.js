var W=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var B=(x,S,o,t)=>{for(var e=t>1?void 0:t?X(S,o):S,n=x.length-1,c;n>=0;n--)(c=x[n])&&(e=(t?c(S,o,e):c(e))||e);return t&&e&&W(S,o,e),e},T=(x,S)=>(o,t)=>S(o,t,x);import{findLast as $}from"../../../../base/common/arraysFind.js";import{DeferredPromise as z}from"../../../../base/common/async.js";import{CancellationTokenSource as Y}from"../../../../base/common/cancellation.js";import{Codicon as G}from"../../../../base/common/codicons.js";import{pieceToQuery as _,prepareQuery as V,scoreFuzzy2 as E}from"../../../../base/common/fuzzyScorer.js";import{Disposable as A,DisposableStore as K,toDisposable as q}from"../../../../base/common/lifecycle.js";import{format as H,trim as U}from"../../../../base/common/strings.js";import{ThemeIcon as w}from"../../../../base/common/themables.js";import{localize as i}from"../../../../nls.js";import{Range as j}from"../../../common/core/range.js";import{ScrollType as J}from"../../../common/editorCommon.js";import{SymbolKind as r,SymbolKinds as Z,SymbolTag as ee,getAriaLabelForSymbol as te}from"../../../common/languages.js";import{ILanguageFeaturesService as oe}from"../../../common/services/languageFeatures.js";import{IOutlineModelService as ie}from"../../documentSymbols/browser/outlineModel.js";import{AbstractEditorNavigationQuickAccessProvider as re}from"./editorNavigationQuickAccess.js";let P=class extends re{constructor(o,t,e=Object.create(null)){super(e);this._languageFeaturesService=o;this._outlineModelService=t;this.options=e,this.options.canAcceptInBackground=!0}static PREFIX="@";static SCOPE_PREFIX=":";static PREFIX_BY_CATEGORY=`${this.PREFIX}${this.SCOPE_PREFIX}`;options;provideWithoutTextEditor(o){return this.provideLabelPick(o,i("cannotRunGotoSymbolWithoutEditor","To go to a symbol, first open a text editor with symbol information.")),A.None}provideWithTextEditor(o,t,e,n){const c=o.editor,l=this.getModel(c);return l?this._languageFeaturesService.documentSymbolProvider.has(l)?this.doProvideWithEditorSymbols(o,l,t,e,n):this.doProvideWithoutEditorSymbols(o,l,t,e):A.None}doProvideWithoutEditorSymbols(o,t,e,n){const c=new K;return this.provideLabelPick(e,i("cannotRunGotoSymbolWithoutSymbolProvider","The active text editor does not provide symbol information.")),(async()=>!await this.waitForLanguageSymbolRegistry(t,c)||n.isCancellationRequested||c.add(this.doProvideWithEditorSymbols(o,t,e,n)))(),c}provideLabelPick(o,t){o.items=[{label:t,index:0,kind:r.String}],o.ariaLabel=t}async waitForLanguageSymbolRegistry(o,t){if(this._languageFeaturesService.documentSymbolProvider.has(o))return!0;const e=new z,n=t.add(this._languageFeaturesService.documentSymbolProvider.onDidChange(()=>{this._languageFeaturesService.documentSymbolProvider.has(o)&&(n.dispose(),e.complete(!0))}));return t.add(q(()=>e.complete(!1))),e.p}doProvideWithEditorSymbols(o,t,e,n,c){const l=o.editor,m=new K;m.add(e.onDidAccept(a=>{const[d]=e.selectedItems;d&&d.range&&(this.gotoLocation(o,{range:d.range.selection,keyMods:e.keyMods,preserveFocus:a.inBackground}),c?.handleAccept?.(d),a.inBackground||e.hide())})),m.add(e.onDidTriggerItemButton(({item:a})=>{a&&a.range&&(this.gotoLocation(o,{range:a.range.selection,keyMods:e.keyMods,forceSideBySide:!0}),e.hide())}));const C=this.getDocumentSymbols(t,n);let p;const g=async a=>{p?.dispose(!0),e.busy=!1,p=new Y(n),e.busy=!0;try{const d=V(e.value.substr(P.PREFIX.length).trim()),k=await this.doGetSymbolPicks(C,d,void 0,p.token,t);if(n.isCancellationRequested)return;if(k.length>0){if(e.items=k,a&&d.original.length===0){const v=$(k,y=>!!(y.type!=="separator"&&y.range&&j.containsPosition(y.range.decoration,a)));v&&(e.activeItems=[v])}}else d.original.length>0?this.provideLabelPick(e,i("noMatchingSymbolResults","No matching editor symbols")):this.provideLabelPick(e,i("noSymbolResults","No editor symbols"))}finally{n.isCancellationRequested||(e.busy=!1)}};return m.add(e.onDidChangeValue(()=>g(void 0))),g(l.getSelection()?.getPosition()),m.add(e.onDidChangeActive(()=>{const[a]=e.activeItems;a&&a.range&&(l.revealRangeInCenter(a.range.selection,J.Smooth),this.addDecorations(l,a.range.decoration))})),m}async doGetSymbolPicks(o,t,e,n,c){const l=await o;if(n.isCancellationRequested)return[];const m=t.original.indexOf(P.SCOPE_PREFIX)===0,C=m?1:0;let p,g;t.values&&t.values.length>1?(p=_(t.values[0]),g=_(t.values.slice(1))):p=t;let a;const d=this.options?.openSideBySideDirection?.();d&&(a=[{iconClass:d==="right"?w.asClassName(G.splitHorizontal):w.asClassName(G.splitVertical),tooltip:d==="right"?i("openToSide","Open to the Side"):i("openToBottom","Open to the Bottom")}]);const k=[];for(let u=0;u<l.length;u++){const s=l[u],f=U(s.name),b=`$(${Z.toIcon(s.kind).id}) ${f}`,Q=b.length-f.length;let h=s.containerName;e?.extraContainerLabel&&(h?h=`${e.extraContainerLabel} \u2022 ${h}`:h=e.extraContainerLabel);let I,L,R,O;if(t.original.length>C){let N=!1;if(p!==t&&([I,L]=E(b,{...t,values:void 0},C,Q),typeof I=="number"&&(N=!0)),typeof I!="number"&&([I,L]=E(b,p,C,Q),typeof I!="number"))continue;if(!N&&g){if(h&&g.original.length>0&&([R,O]=E(h,g)),typeof R!="number")continue;typeof I=="number"&&(I+=R)}}const F=s.tags&&s.tags.indexOf(ee.Deprecated)>=0;k.push({index:u,kind:s.kind,score:I,label:b,ariaLabel:te(s.name,s.kind),description:h,highlights:F?void 0:{label:L,description:O},range:{selection:j.collapseToStart(s.selectionRange),decoration:s.range},uri:c.uri,symbolName:f,strikethrough:F,buttons:a})}const v=k.sort((u,s)=>m?this.compareByKindAndScore(u,s):this.compareByScore(u,s));let y=[];if(m){let b=function(){s&&typeof u=="number"&&f>0&&(s.label=H(M[u]||D,f))};var ne=b;let u,s,f=0;for(const Q of v)u!==Q.kind?(b(),u=Q.kind,f=1,s={type:"separator"},y.push(s)):f++,y.push(Q);b()}else v.length>0&&(y=[{label:i("symbols","symbols ({0})",k.length),type:"separator"},...v]);return y}compareByScore(o,t){if(typeof o.score!="number"&&typeof t.score=="number")return 1;if(typeof o.score=="number"&&typeof t.score!="number")return-1;if(typeof o.score=="number"&&typeof t.score=="number"){if(o.score>t.score)return-1;if(o.score<t.score)return 1}return o.index<t.index?-1:o.index>t.index?1:0}compareByKindAndScore(o,t){const e=M[o.kind]||D,n=M[t.kind]||D,c=e.localeCompare(n);return c===0?this.compareByScore(o,t):c}async getDocumentSymbols(o,t){const e=await this._outlineModelService.getOrCreate(o,t);return t.isCancellationRequested?[]:e.asListOfDocumentSymbols()}};P=B([T(0,oe),T(1,ie)],P);const D=i("property","properties ({0})"),M={[r.Method]:i("method","methods ({0})"),[r.Function]:i("function","functions ({0})"),[r.Constructor]:i("_constructor","constructors ({0})"),[r.Variable]:i("variable","variables ({0})"),[r.Class]:i("class","classes ({0})"),[r.Struct]:i("struct","structs ({0})"),[r.Event]:i("event","events ({0})"),[r.Operator]:i("operator","operators ({0})"),[r.Interface]:i("interface","interfaces ({0})"),[r.Namespace]:i("namespace","namespaces ({0})"),[r.Package]:i("package","packages ({0})"),[r.TypeParameter]:i("typeParameter","type parameters ({0})"),[r.Module]:i("modules","modules ({0})"),[r.Property]:i("property","properties ({0})"),[r.Enum]:i("enum","enumerations ({0})"),[r.EnumMember]:i("enumMember","enumeration members ({0})"),[r.String]:i("string","strings ({0})"),[r.File]:i("file","files ({0})"),[r.Array]:i("array","arrays ({0})"),[r.Number]:i("number","numbers ({0})"),[r.Boolean]:i("boolean","booleans ({0})"),[r.Object]:i("object","objects ({0})"),[r.Key]:i("key","keys ({0})"),[r.Field]:i("field","fields ({0})"),[r.Constant]:i("constant","constants ({0})")};export{P as AbstractGotoSymbolQuickAccessProvider};
