var x=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var M=(k,o,e,t)=>{for(var i=t>1?void 0:t?z(o,e):o,r=k.length-1,a;r>=0;r--)(a=k[r])&&(i=(t?a(o,e,i):a(i))||i);return t&&i&&x(o,e,i),i},g=(k,o)=>(e,t)=>o(e,t,k);import*as h from"../../../../base/browser/dom.js";import{ScrollableElement as $}from"../../../../base/browser/ui/scrollbar/scrollableElement.js";import{isNonEmptyArray as R}from"../../../../base/common/arrays.js";import{Color as F}from"../../../../base/common/color.js";import{Emitter as O}from"../../../../base/common/event.js";import{DisposableStore as B,dispose as P}from"../../../../base/common/lifecycle.js";import{basename as K}from"../../../../base/common/resources.js";import{ScrollbarVisibility as T}from"../../../../base/common/scrollable.js";import{splitLines as V}from"../../../../base/common/strings.js";import"./media/gotoErrorWidget.css";import{EditorOption as w}from"../../../common/config/editorOptions.js";import{Range as q}from"../../../common/core/range.js";import{ScrollType as U}from"../../../common/editorCommon.js";import{peekViewTitleForeground as j,peekViewTitleInfoForeground as G,PeekViewWidget as J}from"../../peekView/browser/peekView.js";import*as s from"../../../../nls.js";import{createAndFillInActionBarActions as Q}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{IMenuService as X,MenuId as Y}from"../../../../platform/actions/common/actions.js";import{IContextKeyService as Z}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as ee}from"../../../../platform/instantiation/common/instantiation.js";import{ILabelService as te}from"../../../../platform/label/common/label.js";import{MarkerSeverity as p}from"../../../../platform/markers/common/markers.js";import{IOpenerService as ie}from"../../../../platform/opener/common/opener.js";import{SeverityIcon as re}from"../../../../platform/severityIcon/browser/severityIcon.js";import{contrastBorder as _,editorBackground as oe,editorErrorBorder as ae,editorErrorForeground as ne,editorInfoBorder as se,editorInfoForeground as le,editorWarningBorder as de,editorWarningForeground as ce,oneOf as L,registerColor as m,transparent as u}from"../../../../platform/theme/common/colorRegistry.js";import{IThemeService as he}from"../../../../platform/theme/common/themeService.js";class pe{constructor(o,e,t,i,r){this._openerService=i;this._labelService=r;this._editor=e;const a=document.createElement("div");a.className="descriptioncontainer",this._messageBlock=document.createElement("div"),this._messageBlock.classList.add("message"),this._messageBlock.setAttribute("aria-live","assertive"),this._messageBlock.setAttribute("role","alert"),a.appendChild(this._messageBlock),this._relatedBlock=document.createElement("div"),a.appendChild(this._relatedBlock),this._disposables.add(h.addStandardDisposableListener(this._relatedBlock,"click",l=>{l.preventDefault();const c=this._relatedDiagnostics.get(l.target);c&&t(c)})),this._scrollable=new $(a,{horizontal:T.Auto,vertical:T.Auto,useShadows:!1,horizontalScrollbarSize:6,verticalScrollbarSize:6}),o.appendChild(this._scrollable.getDomNode()),this._disposables.add(this._scrollable.onScroll(l=>{a.style.left=`-${l.scrollLeft}px`,a.style.top=`-${l.scrollTop}px`})),this._disposables.add(this._scrollable)}_lines=0;_longestLineLength=0;_editor;_messageBlock;_relatedBlock;_scrollable;_relatedDiagnostics=new WeakMap;_disposables=new B;_codeLink;dispose(){P(this._disposables)}update(o){const{source:e,message:t,relatedInformation:i,code:r}=o;let a=(e?.length||0)+2;r&&(typeof r=="string"?a+=r.length:a+=r.value.length);const l=V(t);this._lines=l.length,this._longestLineLength=0;for(const d of l)this._longestLineLength=Math.max(d.length+a,this._longestLineLength);h.clearNode(this._messageBlock),this._messageBlock.setAttribute("aria-label",this.getAriaLabel(o)),this._editor.applyFontInfo(this._messageBlock);let c=this._messageBlock;for(const d of l)c=document.createElement("div"),c.innerText=d,d===""&&(c.style.height=this._messageBlock.style.lineHeight),this._messageBlock.appendChild(c);if(e||r){const d=document.createElement("span");if(d.classList.add("details"),c.appendChild(d),e){const n=document.createElement("span");n.innerText=e,n.classList.add("source"),d.appendChild(n)}if(r)if(typeof r=="string"){const n=document.createElement("span");n.innerText=`(${r})`,n.classList.add("code"),d.appendChild(n)}else{this._codeLink=h.$("a.code-link"),this._codeLink.setAttribute("href",`${r.target.toString()}`),this._codeLink.onclick=v=>{this._openerService.open(r.target,{allowCommands:!0}),v.preventDefault(),v.stopPropagation()};const n=h.append(this._codeLink,h.$("span"));n.innerText=r.value,d.appendChild(this._codeLink)}}if(h.clearNode(this._relatedBlock),this._editor.applyFontInfo(this._relatedBlock),R(i)){const d=this._relatedBlock.appendChild(document.createElement("div"));d.style.paddingTop=`${Math.floor(this._editor.getOption(w.lineHeight)*.66)}px`,this._lines+=1;for(const n of i){const v=document.createElement("div"),b=document.createElement("a");b.classList.add("filename"),b.innerText=`${this._labelService.getUriBasenameLabel(n.resource)}(${n.startLineNumber}, ${n.startColumn}): `,b.title=this._labelService.getUriLabel(n.resource),this._relatedDiagnostics.set(b,n);const S=document.createElement("span");S.innerText=n.message,v.appendChild(b),v.appendChild(S),this._lines+=1,d.appendChild(v)}}const y=this._editor.getOption(w.fontInfo),A=Math.ceil(y.typicalFullwidthCharacterWidth*this._longestLineLength*.75),W=y.lineHeight*this._lines;this._scrollable.setScrollDimensions({scrollWidth:A,scrollHeight:W})}layout(o,e){this._scrollable.getDomNode().style.height=`${o}px`,this._scrollable.getDomNode().style.width=`${e}px`,this._scrollable.setScrollDimensions({width:e,height:o})}getHeightInLines(){return Math.min(17,this._lines)}getAriaLabel(o){let e="";switch(o.severity){case p.Error:e=s.localize("Error","Error");break;case p.Warning:e=s.localize("Warning","Warning");break;case p.Info:e=s.localize("Info","Info");break;case p.Hint:e=s.localize("Hint","Hint");break}let t=s.localize("marker aria","{0} at {1}. ",e,o.startLineNumber+":"+o.startColumn);const i=this._editor.getModel();return i&&o.startLineNumber<=i.getLineCount()&&o.startLineNumber>=1&&(t=`${i.getLineContent(o.startLineNumber)}, ${t}`),t}}let f=class extends J{constructor(e,t,i,r,a,l,c){super(e,{showArrow:!0,showFrame:!0,isAccessible:!0,frameWidth:1},a);this._themeService=t;this._openerService=i;this._menuService=r;this._contextKeyService=l;this._labelService=c;this._severity=p.Warning,this._backgroundColor=F.white,this._applyTheme(t.getColorTheme()),this._callOnDispose.add(t.onDidColorThemeChange(this._applyTheme.bind(this))),this.create()}static TitleMenu=new Y("gotoErrorTitleMenu");_parentContainer;_container;_icon;_message;_callOnDispose=new B;_severity;_backgroundColor;_onDidSelectRelatedInformation=new O;_heightInPixel;onDidSelectRelatedInformation=this._onDidSelectRelatedInformation.event;_applyTheme(e){this._backgroundColor=e.getColor(ve);let t=C,i=ge;this._severity===p.Warning?(t=I,i=me):this._severity===p.Info&&(t=E,i=ue);const r=e.getColor(t),a=e.getColor(i);this.style({arrowColor:r,frameColor:r,headerBackgroundColor:a,primaryHeadingColor:e.getColor(j),secondaryHeadingColor:e.getColor(G)})}_applyStyles(){this._parentContainer&&(this._parentContainer.style.backgroundColor=this._backgroundColor?this._backgroundColor.toString():""),super._applyStyles()}dispose(){this._callOnDispose.dispose(),super.dispose()}focus(){this._parentContainer.focus()}_fillHead(e){super._fillHead(e),this._disposables.add(this._actionbarWidget.actionRunner.onWillRun(r=>this.editor.focus()));const t=[],i=this._menuService.getMenuActions(f.TitleMenu,this._contextKeyService);Q(i,t),this._actionbarWidget.push(t,{label:!1,icon:!0,index:0})}_fillTitleIcon(e){this._icon=h.append(e,h.$(""))}_fillBody(e){this._parentContainer=e,e.classList.add("marker-widget"),this._parentContainer.tabIndex=0,this._parentContainer.setAttribute("role","tooltip"),this._container=document.createElement("div"),e.appendChild(this._container),this._message=new pe(this._container,this.editor,t=>this._onDidSelectRelatedInformation.fire(t),this._openerService,this._labelService),this._disposables.add(this._message)}show(){throw new Error("call showAtMarker")}showAtMarker(e,t,i){this._container.classList.remove("stale"),this._message.update(e),this._severity=e.severity,this._applyTheme(this._themeService.getColorTheme());const r=q.lift(e),a=this.editor.getPosition(),l=a&&r.containsPosition(a)?a:r.getStartPosition();super.show(l,this.computeRequiredHeight());const c=this.editor.getModel();if(c){const y=i>1?s.localize("problems","{0} of {1} problems",t,i):s.localize("change","{0} of {1} problem",t,i);this.setTitle(K(c.uri),y)}this._icon.className=`codicon ${re.className(p.toSeverity(this._severity))}`,this.editor.revealPositionNearTop(l,U.Smooth),this.editor.focus()}updateMarker(e){this._container.classList.remove("stale"),this._message.update(e)}showStale(){this._container.classList.add("stale"),this._relayout()}_doLayoutBody(e,t){super._doLayoutBody(e,t),this._heightInPixel=e,this._message.layout(e,t),this._container.style.height=`${e}px`}_onWidth(e){this._message.layout(this._heightInPixel,e)}_relayout(){super._relayout(this.computeRequiredHeight())}computeRequiredHeight(){return 3+this._message.getHeightInLines()}};f=M([g(1,he),g(2,ie),g(3,X),g(4,ee),g(5,Z),g(6,te)],f);const N=L(ne,ae),D=L(ce,de),H=L(le,se),C=m("editorMarkerNavigationError.background",{dark:N,light:N,hcDark:_,hcLight:_},s.localize("editorMarkerNavigationError","Editor marker navigation widget error color.")),ge=m("editorMarkerNavigationError.headerBackground",{dark:u(C,.1),light:u(C,.1),hcDark:null,hcLight:null},s.localize("editorMarkerNavigationErrorHeaderBackground","Editor marker navigation widget error heading background.")),I=m("editorMarkerNavigationWarning.background",{dark:D,light:D,hcDark:_,hcLight:_},s.localize("editorMarkerNavigationWarning","Editor marker navigation widget warning color.")),me=m("editorMarkerNavigationWarning.headerBackground",{dark:u(I,.1),light:u(I,.1),hcDark:"#0C141F",hcLight:u(I,.2)},s.localize("editorMarkerNavigationWarningBackground","Editor marker navigation widget warning heading background.")),E=m("editorMarkerNavigationInfo.background",{dark:H,light:H,hcDark:_,hcLight:_},s.localize("editorMarkerNavigationInfo","Editor marker navigation widget info color.")),ue=m("editorMarkerNavigationInfo.headerBackground",{dark:u(E,.1),light:u(E,.1),hcDark:null,hcLight:null},s.localize("editorMarkerNavigationInfoHeaderBackground","Editor marker navigation widget info heading background.")),ve=m("editorMarkerNavigation.background",oe,s.localize("editorMarkerNavigationBackground","Editor marker navigation widget background."));export{f as MarkerNavigationWidget};
