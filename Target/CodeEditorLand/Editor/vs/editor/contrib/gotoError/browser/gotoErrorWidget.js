var x=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var M=(k,r,e,t)=>{for(var i=t>1?void 0:t?z(r,e):r,o=k.length-1,a;o>=0;o--)(a=k[o])&&(i=(t?a(r,e,i):a(i))||i);return t&&i&&x(r,e,i),i},g=(k,r)=>(e,t)=>r(e,t,k);import*as h from"../../../../base/browser/dom.js";import{ScrollableElement as $}from"../../../../base/browser/ui/scrollbar/scrollableElement.js";import{isNonEmptyArray as R}from"../../../../base/common/arrays.js";import{Color as F}from"../../../../base/common/color.js";import{Emitter as O}from"../../../../base/common/event.js";import{DisposableStore as B,dispose as P}from"../../../../base/common/lifecycle.js";import{basename as K}from"../../../../base/common/resources.js";import{ScrollbarVisibility as T}from"../../../../base/common/scrollable.js";import{splitLines as V}from"../../../../base/common/strings.js";import"./media/gotoErrorWidget.css";import*as s from"../../../../nls.js";import{createAndFillInActionBarActions as q}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{IMenuService as j,MenuId as U}from"../../../../platform/actions/common/actions.js";import{IContextKeyService as G}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as J}from"../../../../platform/instantiation/common/instantiation.js";import{ILabelService as Q}from"../../../../platform/label/common/label.js";import{MarkerSeverity as p}from"../../../../platform/markers/common/markers.js";import{IOpenerService as X}from"../../../../platform/opener/common/opener.js";import{SeverityIcon as Y}from"../../../../platform/severityIcon/browser/severityIcon.js";import{contrastBorder as u,editorBackground as Z,editorErrorBorder as ee,editorErrorForeground as te,editorInfoBorder as ie,editorInfoForeground as oe,editorWarningBorder as re,editorWarningForeground as ae,oneOf as L,registerColor as m,transparent as v}from"../../../../platform/theme/common/colorRegistry.js";import{IThemeService as ne}from"../../../../platform/theme/common/themeService.js";import{EditorOption as w}from"../../../common/config/editorOptions.js";import{Range as se}from"../../../common/core/range.js";import{ScrollType as le}from"../../../common/editorCommon.js";import{PeekViewWidget as de,peekViewTitleForeground as ce,peekViewTitleInfoForeground as he}from"../../peekView/browser/peekView.js";class pe{constructor(r,e,t,i,o){this._openerService=i;this._labelService=o;this._editor=e;const a=document.createElement("div");a.className="descriptioncontainer",this._messageBlock=document.createElement("div"),this._messageBlock.classList.add("message"),this._messageBlock.setAttribute("aria-live","assertive"),this._messageBlock.setAttribute("role","alert"),a.appendChild(this._messageBlock),this._relatedBlock=document.createElement("div"),a.appendChild(this._relatedBlock),this._disposables.add(h.addStandardDisposableListener(this._relatedBlock,"click",l=>{l.preventDefault();const c=this._relatedDiagnostics.get(l.target);c&&t(c)})),this._scrollable=new $(a,{horizontal:T.Auto,vertical:T.Auto,useShadows:!1,horizontalScrollbarSize:6,verticalScrollbarSize:6}),r.appendChild(this._scrollable.getDomNode()),this._disposables.add(this._scrollable.onScroll(l=>{a.style.left=`-${l.scrollLeft}px`,a.style.top=`-${l.scrollTop}px`})),this._disposables.add(this._scrollable)}_lines=0;_longestLineLength=0;_editor;_messageBlock;_relatedBlock;_scrollable;_relatedDiagnostics=new WeakMap;_disposables=new B;_codeLink;dispose(){P(this._disposables)}update(r){const{source:e,message:t,relatedInformation:i,code:o}=r;let a=(e?.length||0)+2;o&&(typeof o=="string"?a+=o.length:a+=o.value.length);const l=V(t);this._lines=l.length,this._longestLineLength=0;for(const d of l)this._longestLineLength=Math.max(d.length+a,this._longestLineLength);h.clearNode(this._messageBlock),this._messageBlock.setAttribute("aria-label",this.getAriaLabel(r)),this._editor.applyFontInfo(this._messageBlock);let c=this._messageBlock;for(const d of l)c=document.createElement("div"),c.innerText=d,d===""&&(c.style.height=this._messageBlock.style.lineHeight),this._messageBlock.appendChild(c);if(e||o){const d=document.createElement("span");if(d.classList.add("details"),c.appendChild(d),e){const n=document.createElement("span");n.innerText=e,n.classList.add("source"),d.appendChild(n)}if(o)if(typeof o=="string"){const n=document.createElement("span");n.innerText=`(${o})`,n.classList.add("code"),d.appendChild(n)}else{this._codeLink=h.$("a.code-link"),this._codeLink.setAttribute("href",`${o.target.toString()}`),this._codeLink.onclick=_=>{this._openerService.open(o.target,{allowCommands:!0}),_.preventDefault(),_.stopPropagation()};const n=h.append(this._codeLink,h.$("span"));n.innerText=o.value,d.appendChild(this._codeLink)}}if(h.clearNode(this._relatedBlock),this._editor.applyFontInfo(this._relatedBlock),R(i)){const d=this._relatedBlock.appendChild(document.createElement("div"));d.style.paddingTop=`${Math.floor(this._editor.getOption(w.lineHeight)*.66)}px`,this._lines+=1;for(const n of i){const _=document.createElement("div"),b=document.createElement("a");b.classList.add("filename"),b.innerText=`${this._labelService.getUriBasenameLabel(n.resource)}(${n.startLineNumber}, ${n.startColumn}): `,b.title=this._labelService.getUriLabel(n.resource),this._relatedDiagnostics.set(b,n);const S=document.createElement("span");S.innerText=n.message,_.appendChild(b),_.appendChild(S),this._lines+=1,d.appendChild(_)}}const y=this._editor.getOption(w.fontInfo),A=Math.ceil(y.typicalFullwidthCharacterWidth*this._longestLineLength*.75),W=y.lineHeight*this._lines;this._scrollable.setScrollDimensions({scrollWidth:A,scrollHeight:W})}layout(r,e){this._scrollable.getDomNode().style.height=`${r}px`,this._scrollable.getDomNode().style.width=`${e}px`,this._scrollable.setScrollDimensions({width:e,height:r})}getHeightInLines(){return Math.min(17,this._lines)}getAriaLabel(r){let e="";switch(r.severity){case p.Error:e=s.localize("Error","Error");break;case p.Warning:e=s.localize("Warning","Warning");break;case p.Info:e=s.localize("Info","Info");break;case p.Hint:e=s.localize("Hint","Hint");break}let t=s.localize("marker aria","{0} at {1}. ",e,r.startLineNumber+":"+r.startColumn);const i=this._editor.getModel();return i&&r.startLineNumber<=i.getLineCount()&&r.startLineNumber>=1&&(t=`${i.getLineContent(r.startLineNumber)}, ${t}`),t}}let f=class extends de{constructor(e,t,i,o,a,l,c){super(e,{showArrow:!0,showFrame:!0,isAccessible:!0,frameWidth:1},a);this._themeService=t;this._openerService=i;this._menuService=o;this._contextKeyService=l;this._labelService=c;this._severity=p.Warning,this._backgroundColor=F.white,this._applyTheme(t.getColorTheme()),this._callOnDispose.add(t.onDidColorThemeChange(this._applyTheme.bind(this))),this.create()}static TitleMenu=new U("gotoErrorTitleMenu");_parentContainer;_container;_icon;_message;_callOnDispose=new B;_severity;_backgroundColor;_onDidSelectRelatedInformation=new O;_heightInPixel;onDidSelectRelatedInformation=this._onDidSelectRelatedInformation.event;_applyTheme(e){this._backgroundColor=e.getColor(_e);let t=C,i=ge;this._severity===p.Warning?(t=I,i=me):this._severity===p.Info&&(t=E,i=ve);const o=e.getColor(t),a=e.getColor(i);this.style({arrowColor:o,frameColor:o,headerBackgroundColor:a,primaryHeadingColor:e.getColor(ce),secondaryHeadingColor:e.getColor(he)})}_applyStyles(){this._parentContainer&&(this._parentContainer.style.backgroundColor=this._backgroundColor?this._backgroundColor.toString():""),super._applyStyles()}dispose(){this._callOnDispose.dispose(),super.dispose()}focus(){this._parentContainer.focus()}_fillHead(e){super._fillHead(e),this._disposables.add(this._actionbarWidget.actionRunner.onWillRun(o=>this.editor.focus()));const t=[],i=this._menuService.getMenuActions(f.TitleMenu,this._contextKeyService);q(i,t),this._actionbarWidget.push(t,{label:!1,icon:!0,index:0})}_fillTitleIcon(e){this._icon=h.append(e,h.$(""))}_fillBody(e){this._parentContainer=e,e.classList.add("marker-widget"),this._parentContainer.tabIndex=0,this._parentContainer.setAttribute("role","tooltip"),this._container=document.createElement("div"),e.appendChild(this._container),this._message=new pe(this._container,this.editor,t=>this._onDidSelectRelatedInformation.fire(t),this._openerService,this._labelService),this._disposables.add(this._message)}show(){throw new Error("call showAtMarker")}showAtMarker(e,t,i){this._container.classList.remove("stale"),this._message.update(e),this._severity=e.severity,this._applyTheme(this._themeService.getColorTheme());const o=se.lift(e),a=this.editor.getPosition(),l=a&&o.containsPosition(a)?a:o.getStartPosition();super.show(l,this.computeRequiredHeight());const c=this.editor.getModel();if(c){const y=i>1?s.localize("problems","{0} of {1} problems",t,i):s.localize("change","{0} of {1} problem",t,i);this.setTitle(K(c.uri),y)}this._icon.className=`codicon ${Y.className(p.toSeverity(this._severity))}`,this.editor.revealPositionNearTop(l,le.Smooth),this.editor.focus()}updateMarker(e){this._container.classList.remove("stale"),this._message.update(e)}showStale(){this._container.classList.add("stale"),this._relayout()}_doLayoutBody(e,t){super._doLayoutBody(e,t),this._heightInPixel=e,this._message.layout(e,t),this._container.style.height=`${e}px`}_onWidth(e){this._message.layout(this._heightInPixel,e)}_relayout(){super._relayout(this.computeRequiredHeight())}computeRequiredHeight(){return 3+this._message.getHeightInLines()}};f=M([g(1,ne),g(2,X),g(3,j),g(4,J),g(5,G),g(6,Q)],f);const N=L(te,ee),D=L(ae,re),H=L(oe,ie),C=m("editorMarkerNavigationError.background",{dark:N,light:N,hcDark:u,hcLight:u},s.localize("editorMarkerNavigationError","Editor marker navigation widget error color.")),ge=m("editorMarkerNavigationError.headerBackground",{dark:v(C,.1),light:v(C,.1),hcDark:null,hcLight:null},s.localize("editorMarkerNavigationErrorHeaderBackground","Editor marker navigation widget error heading background.")),I=m("editorMarkerNavigationWarning.background",{dark:D,light:D,hcDark:u,hcLight:u},s.localize("editorMarkerNavigationWarning","Editor marker navigation widget warning color.")),me=m("editorMarkerNavigationWarning.headerBackground",{dark:v(I,.1),light:v(I,.1),hcDark:"#0C141F",hcLight:v(I,.2)},s.localize("editorMarkerNavigationWarningBackground","Editor marker navigation widget warning heading background.")),E=m("editorMarkerNavigationInfo.background",{dark:H,light:H,hcDark:u,hcLight:u},s.localize("editorMarkerNavigationInfo","Editor marker navigation widget info color.")),ve=m("editorMarkerNavigationInfo.headerBackground",{dark:v(E,.1),light:v(E,.1),hcDark:null,hcLight:null},s.localize("editorMarkerNavigationInfoHeaderBackground","Editor marker navigation widget info heading background.")),_e=m("editorMarkerNavigation.background",Z,s.localize("editorMarkerNavigationBackground","Editor marker navigation widget background."));export{f as MarkerNavigationWidget};
