var x=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var u=(d,e,i,r)=>{for(var n=r>1?void 0:r?S(e,i):e,s=d.length-1,o;s>=0;s--)(o=d[s])&&(n=(r?o(e,i,n):o(n))||n);return r&&n&&x(e,i,n),n},f=(d,e)=>(i,r)=>e(i,r,d);import{binarySearch as M}from"../../../../base/common/arrays.js";import{Emitter as y}from"../../../../base/common/event.js";import{DisposableStore as b,toDisposable as P}from"../../../../base/common/lifecycle.js";import{LinkedList as C}from"../../../../base/common/linkedList.js";import{compare as I}from"../../../../base/common/strings.js";import{URI as g}from"../../../../base/common/uri.js";import{Range as h}from"../../../common/core/range.js";import{InstantiationType as L,registerSingleton as U}from"../../../../platform/instantiation/common/extensions.js";import{createDecorator as D}from"../../../../platform/instantiation/common/instantiation.js";import{IMarkerService as k,MarkerSeverity as m}from"../../../../platform/markers/common/markers.js";import{IConfigurationService as p}from"../../../../platform/configuration/common/configuration.js";class v{constructor(e,i,r){this.marker=e;this.index=i;this.total=r}}let c=class{constructor(e,i,r){this._markerService=i;this._configService=r;g.isUri(e)?this._resourceFilter=t=>t.toString()===e.toString():e&&(this._resourceFilter=e);const n=this._configService.getValue("problems.sortOrder"),s=(t,a)=>{let _=I(t.resource.toString(),a.resource.toString());return _===0&&(n==="position"?_=h.compareRangesUsingStarts(t,a)||m.compare(t.severity,a.severity):_=m.compare(t.severity,a.severity)||h.compareRangesUsingStarts(t,a)),_},o=()=>{this._markers=this._markerService.read({resource:g.isUri(e)?e:void 0,severities:m.Error|m.Warning|m.Info}),typeof e=="function"&&(this._markers=this._markers.filter(t=>this._resourceFilter(t.resource))),this._markers.sort(s)};o(),this._dispoables.add(i.onMarkerChanged(t=>{(!this._resourceFilter||t.some(a=>this._resourceFilter(a)))&&(o(),this._nextIdx=-1,this._onDidChange.fire())}))}_onDidChange=new y;onDidChange=this._onDidChange.event;_resourceFilter;_dispoables=new b;_markers=[];_nextIdx=-1;dispose(){this._dispoables.dispose(),this._onDidChange.dispose()}matches(e){return!this._resourceFilter&&!e?!0:!this._resourceFilter||!e?!1:this._resourceFilter(e)}get selected(){const e=this._markers[this._nextIdx];return e&&new v(e,this._nextIdx+1,this._markers.length)}_initIdx(e,i,r){let n=!1,s=this._markers.findIndex(o=>o.resource.toString()===e.uri.toString());s<0&&(s=M(this._markers,{resource:e.uri},(o,t)=>I(o.resource.toString(),t.resource.toString())),s<0&&(s=~s));for(let o=s;o<this._markers.length;o++){let t=h.lift(this._markers[o]);if(t.isEmpty()){const a=e.getWordAtPosition(t.getStartPosition());a&&(t=new h(t.startLineNumber,a.startColumn,t.startLineNumber,a.endColumn))}if(i&&(t.containsPosition(i)||i.isBeforeOrEqual(t.getStartPosition()))){this._nextIdx=o,n=!0;break}if(this._markers[o].resource.toString()!==e.uri.toString())break}n||(this._nextIdx=r?0:this._markers.length-1),this._nextIdx<0&&(this._nextIdx=this._markers.length-1)}resetIndex(){this._nextIdx=-1}move(e,i,r){if(this._markers.length===0)return!1;const n=this._nextIdx;return this._nextIdx===-1?this._initIdx(i,r,e):e?this._nextIdx=(this._nextIdx+1)%this._markers.length:e||(this._nextIdx=(this._nextIdx-1+this._markers.length)%this._markers.length),n!==this._nextIdx}find(e,i){let r=this._markers.findIndex(n=>n.resource.toString()===e.toString());if(!(r<0)){for(;r<this._markers.length;r++)if(h.containsPosition(this._markers[r],i))return new v(this._markers[r],r+1,this._markers.length)}}};c=u([f(1,k),f(2,p)],c);const R=D("IMarkerNavigationService");let l=class{constructor(e,i){this._markerService=e;this._configService=i}_serviceBrand;_provider=new C;registerProvider(e){const i=this._provider.unshift(e);return P(()=>i())}getMarkerList(e){for(const i of this._provider){const r=i.getMarkerList(e);if(r)return r}return new c(e,this._markerService,this._configService)}};l=u([f(0,k),f(1,p)],l),U(R,l,L.Delayed);export{R as IMarkerNavigationService,v as MarkerCoordinate,c as MarkerList};
