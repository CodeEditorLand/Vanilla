var x=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var u=(d,e,t,r)=>{for(var o=r>1?void 0:r?S(e,t):e,s=d.length-1,n;s>=0;s--)(n=d[s])&&(o=(r?n(e,t,o):n(o))||o);return r&&o&&x(e,t,o),o},m=(d,e)=>(t,r)=>e(t,r,d);import{binarySearch as y}from"../../../../base/common/arrays.js";import{Emitter as M}from"../../../../base/common/event.js";import{DisposableStore as b,toDisposable as P}from"../../../../base/common/lifecycle.js";import{LinkedList as C}from"../../../../base/common/linkedList.js";import{compare as p}from"../../../../base/common/strings.js";import{URI as I}from"../../../../base/common/uri.js";import{IConfigurationService as g}from"../../../../platform/configuration/common/configuration.js";import{InstantiationType as L,registerSingleton as U}from"../../../../platform/instantiation/common/extensions.js";import{createDecorator as D}from"../../../../platform/instantiation/common/instantiation.js";import{IMarkerService as k,MarkerSeverity as f}from"../../../../platform/markers/common/markers.js";import{Range as h}from"../../../common/core/range.js";class v{constructor(e,t,r){this.marker=e;this.index=t;this.total=r}}let c=class{constructor(e,t,r){this._markerService=t;this._configService=r;I.isUri(e)?this._resourceFilter=i=>i.toString()===e.toString():e&&(this._resourceFilter=e);const o=this._configService.getValue("problems.sortOrder"),s=(i,a)=>{let _=p(i.resource.toString(),a.resource.toString());return _===0&&(o==="position"?_=h.compareRangesUsingStarts(i,a)||f.compare(i.severity,a.severity):_=f.compare(i.severity,a.severity)||h.compareRangesUsingStarts(i,a)),_},n=()=>{this._markers=this._markerService.read({resource:I.isUri(e)?e:void 0,severities:f.Error|f.Warning|f.Info}),typeof e=="function"&&(this._markers=this._markers.filter(i=>this._resourceFilter(i.resource))),this._markers.sort(s)};n(),this._dispoables.add(t.onMarkerChanged(i=>{(!this._resourceFilter||i.some(a=>this._resourceFilter(a)))&&(n(),this._nextIdx=-1,this._onDidChange.fire())}))}_onDidChange=new M;onDidChange=this._onDidChange.event;_resourceFilter;_dispoables=new b;_markers=[];_nextIdx=-1;dispose(){this._dispoables.dispose(),this._onDidChange.dispose()}matches(e){return!this._resourceFilter&&!e?!0:!this._resourceFilter||!e?!1:this._resourceFilter(e)}get selected(){const e=this._markers[this._nextIdx];return e&&new v(e,this._nextIdx+1,this._markers.length)}_initIdx(e,t,r){let o=!1,s=this._markers.findIndex(n=>n.resource.toString()===e.uri.toString());s<0&&(s=y(this._markers,{resource:e.uri},(n,i)=>p(n.resource.toString(),i.resource.toString())),s<0&&(s=~s));for(let n=s;n<this._markers.length;n++){let i=h.lift(this._markers[n]);if(i.isEmpty()){const a=e.getWordAtPosition(i.getStartPosition());a&&(i=new h(i.startLineNumber,a.startColumn,i.startLineNumber,a.endColumn))}if(t&&(i.containsPosition(t)||t.isBeforeOrEqual(i.getStartPosition()))){this._nextIdx=n,o=!0;break}if(this._markers[n].resource.toString()!==e.uri.toString())break}o||(this._nextIdx=r?0:this._markers.length-1),this._nextIdx<0&&(this._nextIdx=this._markers.length-1)}resetIndex(){this._nextIdx=-1}move(e,t,r){if(this._markers.length===0)return!1;const o=this._nextIdx;return this._nextIdx===-1?this._initIdx(t,r,e):e?this._nextIdx=(this._nextIdx+1)%this._markers.length:e||(this._nextIdx=(this._nextIdx-1+this._markers.length)%this._markers.length),o!==this._nextIdx}find(e,t){let r=this._markers.findIndex(o=>o.resource.toString()===e.toString());if(!(r<0)){for(;r<this._markers.length;r++)if(h.containsPosition(this._markers[r],t))return new v(this._markers[r],r+1,this._markers.length)}}};c=u([m(1,k),m(2,g)],c);const R=D("IMarkerNavigationService");let l=class{constructor(e,t){this._markerService=e;this._configService=t}_serviceBrand;_provider=new C;registerProvider(e){const t=this._provider.unshift(e);return P(()=>t())}getMarkerList(e){for(const t of this._provider){const r=t.getMarkerList(e);if(r)return r}return new c(e,this._markerService,this._configService)}};l=u([m(0,k),m(1,g)],l),U(R,l,L.Delayed);export{R as IMarkerNavigationService,v as MarkerCoordinate,c as MarkerList};
