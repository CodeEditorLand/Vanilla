import{VSBuffer as i}from"../../../common/buffer.js";import{Emitter as c,Event as r}from"../../../common/event.js";import{assertType as l}from"../../../common/types.js";import{isUtilityProcess as g}from"../../sandbox/node/electronTypes.js";import{IPCServer as m}from"../common/ipc.js";class v{constructor(e){this.port=e;e.start()}onMessage=r.fromNodeEventEmitter(this.port,"message",e=>e.data?i.wrap(e.data):i.alloc(0));send(e){this.port.postMessage(e.buffer)}disconnect(){this.port.close()}}class a extends m{static getOnDidClientConnect(e){l(g(process),"Electron Utility Process");const o=new c;return process.parentPort.on("message",t=>{if(e?.handledClientConnection(t))return;const n=t.ports.at(0);n&&o.fire(n)}),r.map(o.event,t=>({protocol:new v(t),onDidClientDisconnect:r.fromNodeEventEmitter(t,"close")}))}constructor(e){super(a.getOnDidClientConnect(e))}}function u(s,e,o){const t=n=>{n.data===e&&(s.removeListener("message",t),o())};s.on("message",t)}export{a as Server,u as once};
