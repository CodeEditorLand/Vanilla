import{getNLSLanguage as p,getNLSMessages as m}from"../../nls.js";import{coalesce as k}from"../common/arrays.js";import{onUnexpectedError as f}from"../common/errors.js";import{Disposable as y,toDisposable as W}from"../common/lifecycle.js";import{COI as h,FileAccess as b}from"../common/network.js";import{SimpleWorkerClient as I,logOnceWebWorkerWarning as T}from"../common/worker/simpleWorker.js";import{createTrustedTypesPolicy as E}from"./trustedTypes.js";const l=!0;let a;typeof self=="object"&&self.constructor&&self.constructor.name==="DedicatedWorkerGlobalScope"&&globalThis.workerttPolicy!==void 0?a=globalThis.workerttPolicy:a=E("defaultWorkerFactory",{createScriptURL:r=>r});function j(r,e){if(!r.startsWith("blob:"))throw new URIError("Not a blob-url: "+r);return new Worker(a?a.createScriptURL(r):r,{...e,type:l?"module":void 0})}function L(r,e){const t=globalThis.MonacoEnvironment;if(t){if(typeof t.getWorker=="function")return t.getWorker("workerMain.js",e);if(typeof t.getWorkerUrl=="function"){const o=t.getWorkerUrl("workerMain.js",e);return new Worker(a?a.createScriptURL(o):o,{name:e,type:l?"module":void 0})}}if(r){const o=w(e,r.toString(!0)),n=new Worker(a?a.createScriptURL(o):o,{name:e,type:l?"module":void 0});return l?S(n):n}throw new Error("You must define a function MonacoEnvironment.getWorkerUrl or MonacoEnvironment.getWorker")}function w(r,e,t){if(!(/^((http:)|(https:)|(file:))/.test(e)&&e.substring(0,globalThis.origin.length)!==globalThis.origin)){const n=e.lastIndexOf("?"),s=e.lastIndexOf("#",n),c=n>0?new URLSearchParams(e.substring(n+1,~s?s:void 0)):new URLSearchParams;h.addSearchParam(c,!0,!0),c.toString()?e=`${e}?${c.toString()}#${r}`:e=`${e}#${r}`}const o=new Blob([k([`/*${r}*/`,t?`globalThis.MonacoEnvironment = { baseUrl: ${JSON.stringify(t)} };`:void 0,`globalThis._VSCODE_NLS_MESSAGES = ${JSON.stringify(m())};`,`globalThis._VSCODE_NLS_LANGUAGE = ${JSON.stringify(p())};`,`globalThis._VSCODE_FILE_ROOT = ${JSON.stringify(globalThis._VSCODE_FILE_ROOT)};`,"const ttPolicy = globalThis.trustedTypes?.createPolicy('defaultWorkerFactory', { createScriptURL: value => value });","globalThis.workerttPolicy = ttPolicy;",l?`await import(ttPolicy?.createScriptURL(${JSON.stringify(e)}) ?? ${JSON.stringify(e)});`:`importScripts(ttPolicy?.createScriptURL(${JSON.stringify(e)}) ?? ${JSON.stringify(e)});`,l?"globalThis.postMessage({ type: 'vscode-worker-ready' });":void 0,`/*${r}*/`]).join("")],{type:"application/javascript"});return URL.createObjectURL(o)}function S(r){return new Promise((e,t)=>{r.onmessage=o=>{o.data.type==="vscode-worker-ready"&&(r.onmessage=null,e(r))},r.onerror=t})}function R(r){return typeof r.then=="function"}class v extends y{id;label;worker;constructor(e,t,o,n,s,c){super(),this.id=o,this.label=n;const u=L(e,n);R(u)?this.worker=u:this.worker=Promise.resolve(u),this.postMessage(t,[]),this.worker.then(i=>{i.onmessage=g=>{s(g.data)},i.onmessageerror=c,typeof i.addEventListener=="function"&&i.addEventListener("error",c)}),this._register(W(()=>{this.worker?.then(i=>{i.onmessage=null,i.onmessageerror=null,i.removeEventListener("error",c),i.terminate()}),this.worker=null}))}getId(){return this.id}postMessage(e,t){this.worker?.then(o=>{try{o.postMessage(e,t)}catch(n){f(n),f(new Error(`FAILED to post message to '${this.label}'-worker`,{cause:n}))}})}}class O{constructor(e,t){this.amdModuleId=e;this.label=t;this.esmModuleLocation=l?b.asBrowserUri(`${e}.esm.js`):void 0}esmModuleLocation}class d{static LAST_WORKER_ID=0;_webWorkerFailedBeforeError;constructor(){this._webWorkerFailedBeforeError=!1}create(e,t,o){const n=++d.LAST_WORKER_ID;if(this._webWorkerFailedBeforeError)throw this._webWorkerFailedBeforeError;return new v(e.esmModuleLocation,e.amdModuleId,n,e.label||"anonymous"+n,t,s=>{T(s),this._webWorkerFailedBeforeError=s,o(s)})}}function x(r,e){const t=typeof r=="string"?new O(r,e):r;return new I(new d,t)}export{O as WorkerDescriptor,j as createBlobWorker,x as createWebWorker};
