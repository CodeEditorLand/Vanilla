import{Action as E}from"../../../common/actions.js";import{Codicon as u}from"../../../common/codicons.js";import{KeyCode as p,KeyMod as x}from"../../../common/keyCodes.js";import{mnemonicButtonLabel as w}from"../../../common/labels.js";import{Disposable as v}from"../../../common/lifecycle.js";import{isLinux as B,isMacintosh as I,isWindows as T}from"../../../common/platform.js";import{ThemeIcon as h}from"../../../common/themables.js";import{$ as r,EventHelper as b,EventType as L,addDisposableListener as f,clearNode as S,getWindow as A,hide as D,isActiveElement as M,isAncestor as k,show as F}from"../../dom.js";import{StandardKeyboardEvent as C}from"../../keyboardEvent.js";import{ActionBar as H}from"../actionbar/actionbar.js";import{ButtonBar as R,ButtonWithDescription as q}from"../button/button.js";import{InputBox as N}from"../inputbox/inputBox.js";import{Checkbox as _}from"../toggle/toggle.js";import"./dialog.css";import*as m from"../../../../nls.js";class te extends v{constructor(o,d,s,c){super();this.container=o;this.message=d;this.options=c;this.modalElement=this.container.appendChild(r(".monaco-dialog-modal-block.dimmed")),this.shadowElement=this.modalElement.appendChild(r(".dialog-shadow")),this.element=this.shadowElement.appendChild(r(".monaco-dialog-box")),this.element.setAttribute("role","dialog"),this.element.tabIndex=-1,D(this.element),this.buttonStyles=c.buttonStyles,Array.isArray(s)&&s.length>0?this.buttons=s:this.options.disableDefaultAction?this.buttons=[]:this.buttons=[m.localize("ok","OK")];const g=this.element.appendChild(r(".dialog-buttons-row"));this.buttonsContainer=g.appendChild(r(".dialog-buttons"));const n=this.element.appendChild(r(".dialog-message-row"));if(this.iconElement=n.appendChild(r("#monaco-dialog-icon.dialog-icon")),this.iconElement.setAttribute("aria-label",this.getIconAriaLabel()),this.messageContainer=n.appendChild(r(".dialog-message-container")),this.options.detail||this.options.renderBody){const e=this.messageContainer.appendChild(r(".dialog-message")).appendChild(r("#monaco-dialog-message-text.dialog-message-text"));e.innerText=this.message}if(this.messageDetailElement=this.messageContainer.appendChild(r("#monaco-dialog-message-detail.dialog-message-detail")),this.options.detail||!this.options.renderBody?this.messageDetailElement.innerText=this.options.detail?this.options.detail:d:this.messageDetailElement.style.display="none",this.options.renderBody){const a=this.messageContainer.appendChild(r("#monaco-dialog-message-body.dialog-message-body"));this.options.renderBody(a);for(const e of this.messageContainer.querySelectorAll("a"))e.tabIndex=0}if(this.options.inputs?this.inputs=this.options.inputs.map(a=>{const e=this.messageContainer.appendChild(r(".dialog-message-input")),i=this._register(new N(e,void 0,{placeholder:a.placeholder,type:a.type??"text",inputBoxStyles:c.inputBoxStyles}));return a.value&&(i.value=a.value),i}):this.inputs=[],this.options.checkboxLabel){const a=this.messageContainer.appendChild(r(".dialog-checkbox-row")),e=this.checkbox=this._register(new _(this.options.checkboxLabel,!!this.options.checkboxChecked,c.checkboxStyles));a.appendChild(e.domNode);const i=a.appendChild(r(".dialog-checkbox-message"));i.innerText=this.options.checkboxLabel,this._register(f(i,L.CLICK,()=>e.checked=!e.checked))}const t=this.element.appendChild(r(".dialog-toolbar-row"));this.toolbarContainer=t.appendChild(r(".dialog-toolbar")),this.applyStyles()}element;shadowElement;modalElement;buttonsContainer;messageDetailElement;messageContainer;iconElement;checkbox;toolbarContainer;buttonBar;focusToReturn;inputs;buttons;buttonStyles;getIconAriaLabel(){let o=m.localize("dialogInfoMessage","Info");switch(this.options.type){case"error":o=m.localize("dialogErrorMessage","Error");break;case"warning":o=m.localize("dialogWarningMessage","Warning");break;case"pending":o=m.localize("dialogPendingMessage","In Progress");break;case"none":case"info":case"question":default:break}return o}updateMessage(o){this.messageDetailElement.innerText=o}async show(){return this.focusToReturn=this.container.ownerDocument.activeElement,new Promise(o=>{S(this.buttonsContainer);const d=this.buttonBar=this._register(new R(this.buttonsContainer)),s=this.rearrangeButtons(this.buttons,this.options.cancelId);s.forEach((n,t)=>{const a=s[t].index===0,e=this.options.buttonDetails?this._register(d.addButtonWithDescription({secondary:!a,...this.buttonStyles})):this._register(d.addButton({secondary:!a,...this.buttonStyles}));e.label=w(s[t].label,!0),e instanceof q&&(e.description=this.options.buttonDetails[s[t].index]),this._register(e.onDidClick(i=>{i&&b.stop(i),o({button:s[t].index,checkboxChecked:this.checkbox?this.checkbox.checked:void 0,values:this.inputs.length>0?this.inputs.map(l=>l.value):void 0})}))});const c=A(this.container);this._register(f(c,"keydown",n=>{const t=new C(n);if(t.equals(x.Alt)&&t.preventDefault(),t.equals(p.Enter)){this.inputs.some(e=>e.hasFocus())&&(b.stop(n),o({button:s.find(e=>e.index!==this.options.cancelId)?.index??0,checkboxChecked:this.checkbox?this.checkbox.checked:void 0,values:this.inputs.length>0?this.inputs.map(e=>e.value):void 0}));return}if(t.equals(p.Space))return;let a=!1;if(t.equals(p.Tab)||t.equals(p.RightArrow)||t.equals(x.Shift|p.Tab)||t.equals(p.LeftArrow)){const e=[];let i=-1;if(this.messageContainer){const l=this.messageContainer.querySelectorAll("a");for(const y of l)e.push(y),M(y)&&(i=e.length-1)}for(const l of this.inputs)e.push(l),l.hasFocus()&&(i=e.length-1);if(this.checkbox&&(e.push(this.checkbox),this.checkbox.hasFocus()&&(i=e.length-1)),this.buttonBar)for(const l of this.buttonBar.buttons)e.push(l),l.hasFocus()&&(i=e.length-1);if(t.equals(p.Tab)||t.equals(p.RightArrow)){i===-1&&(i=0);const l=(i+1)%e.length;e[l].focus()}else{i===-1&&(i=e.length);let l=i-1;l===-1&&(l=e.length-1),e[l].focus()}a=!0}a?b.stop(n,!0):this.options.keyEventProcessor&&this.options.keyEventProcessor(t)},!0)),this._register(f(c,"keyup",n=>{b.stop(n,!0);const t=new C(n);!this.options.disableCloseAction&&t.equals(p.Escape)&&o({button:this.options.cancelId||0,checkboxChecked:this.checkbox?this.checkbox.checked:void 0})},!0)),this._register(f(this.element,"focusout",n=>{n.relatedTarget&&this.element&&(k(n.relatedTarget,this.element)||(this.focusToReturn=n.relatedTarget,n.target&&(n.target.focus(),b.stop(n,!0))))},!1));const g="codicon-modifier-spin";if(this.iconElement.classList.remove(...h.asClassNameArray(u.dialogError),...h.asClassNameArray(u.dialogWarning),...h.asClassNameArray(u.dialogInfo),...h.asClassNameArray(u.loading),g),this.options.icon)this.iconElement.classList.add(...h.asClassNameArray(this.options.icon));else switch(this.options.type){case"error":this.iconElement.classList.add(...h.asClassNameArray(u.dialogError));break;case"warning":this.iconElement.classList.add(...h.asClassNameArray(u.dialogWarning));break;case"pending":this.iconElement.classList.add(...h.asClassNameArray(u.loading),g);break;case"none":this.iconElement.classList.add("no-codicon");break;case"info":case"question":default:this.iconElement.classList.add(...h.asClassNameArray(u.dialogInfo));break}if(!this.options.disableCloseAction){const n=this._register(new H(this.toolbarContainer,{})),t=this._register(new E("dialog.close",m.localize("dialogClose","Close Dialog"),h.asClassName(u.dialogClose),!0,async()=>{o({button:this.options.cancelId||0,checkboxChecked:this.checkbox?this.checkbox.checked:void 0})}));n.push(t,{icon:!0,label:!1})}this.applyStyles(),this.element.setAttribute("aria-modal","true"),this.element.setAttribute("aria-labelledby","monaco-dialog-icon monaco-dialog-message-text"),this.element.setAttribute("aria-describedby","monaco-dialog-icon monaco-dialog-message-text monaco-dialog-message-detail monaco-dialog-message-body"),F(this.element),this.inputs.length>0?(this.inputs[0].focus(),this.inputs[0].select()):s.forEach((n,t)=>{n.index===0&&d.buttons[t].focus()})})}applyStyles(){const o=this.options.dialogStyles,d=o.dialogForeground,s=o.dialogBackground,c=o.dialogShadow?`0 0px 8px ${o.dialogShadow}`:"",g=o.dialogBorder?`1px solid ${o.dialogBorder}`:"",n=o.textLinkForeground;if(this.shadowElement.style.boxShadow=c,this.element.style.color=d??"",this.element.style.backgroundColor=s??"",this.element.style.border=g,n)for(const a of this.messageContainer.getElementsByTagName("a"))a.style.color=n;let t;switch(this.options.type){case"error":t=o.errorIconForeground;break;case"warning":t=o.warningIconForeground;break;default:t=o.infoIconForeground;break}t&&(this.iconElement.style.color=t)}dispose(){super.dispose(),this.modalElement&&(this.modalElement.remove(),this.modalElement=void 0),this.focusToReturn&&k(this.focusToReturn,this.container.ownerDocument.body)&&(this.focusToReturn.focus(),this.focusToReturn=void 0)}rearrangeButtons(o,d){const s=o.map((c,g)=>({label:c,index:g}));if(o.length<2)return s;if(I||B){if(typeof d=="number"&&s[d]){const c=s.splice(d,1)[0];s.splice(1,0,c)}s.reverse()}else if(T&&typeof d=="number"&&s[d]){const c=s.splice(d,1)[0];s.push(c)}return s}}export{te as Dialog};
