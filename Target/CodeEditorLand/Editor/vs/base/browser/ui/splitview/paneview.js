import{Color as I,RGBA as _}from"../../../common/color.js";import{Emitter as p,Event as o}from"../../../common/event.js";import{KeyCode as d}from"../../../common/keyCodes.js";import{Disposable as g,DisposableStore as c}from"../../../common/lifecycle.js";import"../../../common/scrollable.js";import{isFirefox as w}from"../../browser.js";import{DataTransfers as T}from"../../dnd.js";import{$ as l,addDisposableListener as h,append as m,clearNode as z,EventHelper as C,EventType as L,getWindow as u,isHTMLElement as B,trackFocus as P}from"../../dom.js";import{DomEmitter as y}from"../../event.js";import{StandardKeyboardEvent as D}from"../../keyboardEvent.js";import{Gesture as H,EventType as O}from"../../touch.js";import{Orientation as s}from"../sash/sash.js";import"./paneview.css";import{localize as A}from"../../../../nls.js";import{Sizing as V,SplitView as S}from"./splitview.js";class b extends g{static HEADER_SIZE=22;element;header;body;_expanded;_orientation;expandedSize=void 0;_headerVisible=!0;_collapsible=!0;_bodyRendered=!1;_minimumBodySize;_maximumBodySize;_ariaHeaderLabel;styles={dropBackground:void 0,headerBackground:void 0,headerBorder:void 0,headerForeground:void 0,leftBorder:void 0};animationTimer=void 0;_onDidChange=this._register(new p);onDidChange=this._onDidChange.event;_onDidChangeExpansionState=this._register(new p);onDidChangeExpansionState=this._onDidChangeExpansionState.event;get ariaHeaderLabel(){return this._ariaHeaderLabel}set ariaHeaderLabel(e){this._ariaHeaderLabel=e,this.header.setAttribute("aria-label",this.ariaHeaderLabel)}get draggableElement(){return this.header}get dropTargetElement(){return this.element}get dropBackground(){return this.styles.dropBackground}get minimumBodySize(){return this._minimumBodySize}set minimumBodySize(e){this._minimumBodySize=e,this._onDidChange.fire(void 0)}get maximumBodySize(){return this._maximumBodySize}set maximumBodySize(e){this._maximumBodySize=e,this._onDidChange.fire(void 0)}get headerSize(){return this.headerVisible?b.HEADER_SIZE:0}get minimumSize(){const e=this.headerSize,i=!this.headerVisible||this.isExpanded()?this.minimumBodySize:0;return e+i}get maximumSize(){const e=this.headerSize,i=!this.headerVisible||this.isExpanded()?this.maximumBodySize:0;return e+i}orthogonalSize=0;constructor(e){super(),this._expanded=typeof e.expanded>"u"?!0:!!e.expanded,this._orientation=typeof e.orientation>"u"?s.VERTICAL:e.orientation,this._ariaHeaderLabel=A("viewSection","{0} Section",e.title),this._minimumBodySize=typeof e.minimumBodySize=="number"?e.minimumBodySize:this._orientation===s.HORIZONTAL?200:120,this._maximumBodySize=typeof e.maximumBodySize=="number"?e.maximumBodySize:Number.POSITIVE_INFINITY,this.element=l(".pane")}isExpanded(){return this._expanded}setExpanded(e){return!e&&!this.collapsible||this._expanded===!!e?!1:(this.element?.classList.toggle("expanded",e),this._expanded=!!e,this.updateHeader(),e?(this._bodyRendered||(this.renderBody(this.body),this._bodyRendered=!0),typeof this.animationTimer=="number"&&u(this.element).clearTimeout(this.animationTimer),m(this.element,this.body)):this.animationTimer=u(this.element).setTimeout(()=>{this.body.remove()},200),this._onDidChangeExpansionState.fire(e),this._onDidChange.fire(e?this.expandedSize:void 0),!0)}get headerVisible(){return this._headerVisible}set headerVisible(e){this._headerVisible!==!!e&&(this._headerVisible=!!e,this.updateHeader(),this._onDidChange.fire(void 0))}get collapsible(){return this._collapsible}set collapsible(e){this._collapsible!==!!e&&(this._collapsible=!!e,this.updateHeader())}get orientation(){return this._orientation}set orientation(e){this._orientation!==e&&(this._orientation=e,this.element&&(this.element.classList.toggle("horizontal",this.orientation===s.HORIZONTAL),this.element.classList.toggle("vertical",this.orientation===s.VERTICAL)),this.header&&this.updateHeader())}render(){this.element.classList.toggle("expanded",this.isExpanded()),this.element.classList.toggle("horizontal",this.orientation===s.HORIZONTAL),this.element.classList.toggle("vertical",this.orientation===s.VERTICAL),this.header=l(".pane-header"),m(this.element,this.header),this.header.setAttribute("tabindex","0"),this.header.setAttribute("role","button"),this.header.setAttribute("aria-label",this.ariaHeaderLabel),this.renderHeader(this.header);const e=P(this.header);this._register(e),this._register(e.onDidFocus(()=>this.header.classList.add("focused"),null)),this._register(e.onDidBlur(()=>this.header.classList.remove("focused"),null)),this.updateHeader();const t=this._register(new c),i=this._register(new y(this.header,"keydown")),r=o.map(i.event,n=>new D(n),t);this._register(o.filter(r,n=>n.keyCode===d.Enter||n.keyCode===d.Space,t)(()=>this.setExpanded(!this.isExpanded()),null)),this._register(o.filter(r,n=>n.keyCode===d.LeftArrow,t)(()=>this.setExpanded(!1),null)),this._register(o.filter(r,n=>n.keyCode===d.RightArrow,t)(()=>this.setExpanded(!0),null)),this._register(H.addTarget(this.header)),[L.CLICK,O.Tap].forEach(n=>{this._register(h(this.header,n,a=>{a.defaultPrevented||this.setExpanded(!this.isExpanded())}))}),this.body=m(this.element,l(".pane-body")),!this._bodyRendered&&this.isExpanded()&&(this.renderBody(this.body),this._bodyRendered=!0),this.isExpanded()||this.body.remove()}layout(e){const t=this.headerVisible?b.HEADER_SIZE:0,i=this._orientation===s.VERTICAL?this.orthogonalSize:e,r=this._orientation===s.VERTICAL?e-t:this.orthogonalSize-t;this.isExpanded()&&(this.body.classList.toggle("wide",i>=600),this.layoutBody(r,i),this.expandedSize=e)}style(e){this.styles=e,this.header&&this.updateHeader()}updateHeader(){const e=!this.headerVisible||this.isExpanded();this.collapsible?(this.header.setAttribute("tabindex","0"),this.header.setAttribute("role","button")):(this.header.removeAttribute("tabindex"),this.header.removeAttribute("role")),this.header.style.lineHeight=`${this.headerSize}px`,this.header.classList.toggle("hidden",!this.headerVisible),this.header.classList.toggle("expanded",e),this.header.classList.toggle("not-collapsible",!this.collapsible),this.header.setAttribute("aria-expanded",String(e)),this.header.style.color=this.collapsible?this.styles.headerForeground??"":"",this.header.style.backgroundColor=(this.collapsible?this.styles.headerBackground:"transparent")??"",this.header.style.borderTop=this.styles.headerBorder&&this.orientation===s.VERTICAL?`1px solid ${this.styles.headerBorder}`:"",this.element.style.borderLeft=this.styles.leftBorder&&this.orientation===s.HORIZONTAL?`1px solid ${this.styles.leftBorder}`:""}}class f extends g{constructor(t,i,r){super();this.pane=t;this.dnd=i;this.context=r;t.draggableElement.draggable=!0,this._register(h(t.draggableElement,"dragstart",n=>this.onDragStart(n))),this._register(h(t.dropTargetElement,"dragenter",n=>this.onDragEnter(n))),this._register(h(t.dropTargetElement,"dragleave",n=>this.onDragLeave(n))),this._register(h(t.dropTargetElement,"dragend",n=>this.onDragEnd(n))),this._register(h(t.dropTargetElement,"drop",n=>this.onDrop(n)))}static DefaultDragOverBackgroundColor=new I(new _(128,128,128,.5));dragOverCounter=0;_onDidDrop=this._register(new p);onDidDrop=this._onDidDrop.event;onDragStart(t){if(!this.dnd.canDrag(this.pane)||!t.dataTransfer){t.preventDefault(),t.stopPropagation();return}t.dataTransfer.effectAllowed="move",w&&t.dataTransfer?.setData(T.TEXT,this.pane.draggableElement.textContent||"");const i=m(this.pane.element.ownerDocument.body,l(".monaco-drag-image",{},this.pane.draggableElement.textContent||""));t.dataTransfer.setDragImage(i,-10,-10),setTimeout(()=>i.remove(),0),this.context.draggable=this}onDragEnter(t){!this.context.draggable||this.context.draggable===this||this.dnd.canDrop(this.context.draggable.pane,this.pane)&&(this.dragOverCounter++,this.render())}onDragLeave(t){!this.context.draggable||this.context.draggable===this||this.dnd.canDrop(this.context.draggable.pane,this.pane)&&(this.dragOverCounter--,this.dragOverCounter===0&&this.render())}onDragEnd(t){this.context.draggable&&(this.dragOverCounter=0,this.render(),this.context.draggable=null)}onDrop(t){this.context.draggable&&(C.stop(t),this.dragOverCounter=0,this.render(),this.dnd.canDrop(this.context.draggable.pane,this.pane)&&this.context.draggable!==this&&this._onDidDrop.fire({from:this.context.draggable.pane,to:this.pane}),this.context.draggable=null)}render(){let t=null;this.dragOverCounter>0&&(t=this.pane.dropBackground??f.DefaultDragOverBackgroundColor.toString()),this.pane.dropTargetElement.style.backgroundColor=t||""}}class ie{canDrag(e){return!0}canDrop(e,t){return!0}}class ne extends g{dnd;dndContext={draggable:null};element;paneItems=[];orthogonalSize=0;size=0;splitview;animationTimer=void 0;_onDidDrop=this._register(new p);onDidDrop=this._onDidDrop.event;orientation;boundarySashes;onDidSashChange;onDidSashReset;onDidScroll;constructor(e,t={}){super(),this.dnd=t.dnd,this.orientation=t.orientation??s.VERTICAL,this.element=m(e,l(".monaco-pane-view")),this.splitview=this._register(new S(this.element,{orientation:this.orientation})),this.onDidSashReset=this.splitview.onDidSashReset,this.onDidSashChange=this.splitview.onDidSashChange,this.onDidScroll=this.splitview.onDidScroll;const i=this._register(new c),r=this._register(new y(this.element,"keydown")),n=o.map(o.filter(r.event,a=>B(a.target)&&a.target.classList.contains("pane-header"),i),a=>new D(a),i);this._register(o.filter(n,a=>a.keyCode===d.UpArrow,i)(()=>this.focusPrevious())),this._register(o.filter(n,a=>a.keyCode===d.DownArrow,i)(()=>this.focusNext()))}addPane(e,t,i=this.splitview.length){const r=new c;e.onDidChangeExpansionState(this.setupAnimation,this,r);const n={pane:e,disposable:r};if(this.paneItems.splice(i,0,n),e.orientation=this.orientation,e.orthogonalSize=this.orthogonalSize,this.splitview.addView(e,t,i),this.dnd){const a=new f(e,this.dnd,this.dndContext);r.add(a),r.add(a.onDidDrop(this._onDidDrop.fire,this._onDidDrop))}}removePane(e){const t=this.paneItems.findIndex(r=>r.pane===e);if(t===-1)return;this.splitview.removeView(t,e.isExpanded()?V.Distribute:void 0),this.paneItems.splice(t,1)[0].disposable.dispose()}movePane(e,t){const i=this.paneItems.findIndex(a=>a.pane===e),r=this.paneItems.findIndex(a=>a.pane===t);if(i===-1||r===-1)return;const[n]=this.paneItems.splice(i,1);this.paneItems.splice(r,0,n),this.splitview.moveView(i,r)}resizePane(e,t){const i=this.paneItems.findIndex(r=>r.pane===e);i!==-1&&this.splitview.resizeView(i,t)}getPaneSize(e){const t=this.paneItems.findIndex(i=>i.pane===e);return t===-1?-1:this.splitview.getViewSize(t)}layout(e,t){this.orthogonalSize=this.orientation===s.VERTICAL?t:e,this.size=this.orientation===s.HORIZONTAL?t:e;for(const i of this.paneItems)i.pane.orthogonalSize=this.orthogonalSize;this.splitview.layout(this.size)}setBoundarySashes(e){this.boundarySashes=e,this.updateSplitviewOrthogonalSashes(e)}updateSplitviewOrthogonalSashes(e){this.orientation===s.VERTICAL?(this.splitview.orthogonalStartSash=e?.left,this.splitview.orthogonalEndSash=e?.right):this.splitview.orthogonalEndSash=e?.bottom}flipOrientation(e,t){this.orientation=this.orientation===s.VERTICAL?s.HORIZONTAL:s.VERTICAL;const i=this.paneItems.map(a=>this.getPaneSize(a.pane));this.splitview.dispose(),z(this.element),this.splitview=this._register(new S(this.element,{orientation:this.orientation})),this.updateSplitviewOrthogonalSashes(this.boundarySashes);const r=this.orientation===s.VERTICAL?t:e,n=this.orientation===s.HORIZONTAL?t:e;this.paneItems.forEach((a,v)=>{a.pane.orthogonalSize=r,a.pane.orientation=this.orientation;const x=this.size===0?0:n*i[v]/this.size;this.splitview.addView(a.pane,x,v)}),this.size=n,this.orthogonalSize=r,this.splitview.layout(this.size)}setupAnimation(){typeof this.animationTimer=="number"&&u(this.element).clearTimeout(this.animationTimer),this.element.classList.add("animated"),this.animationTimer=u(this.element).setTimeout(()=>{this.animationTimer=void 0,this.element.classList.remove("animated")},200)}getPaneHeaderElements(){return[...this.element.querySelectorAll(".pane-header")]}focusPrevious(){const e=this.getPaneHeaderElements(),t=e.indexOf(this.element.ownerDocument.activeElement);t!==-1&&e[Math.max(t-1,0)].focus()}focusNext(){const e=this.getPaneHeaderElements(),t=e.indexOf(this.element.ownerDocument.activeElement);t!==-1&&e[Math.min(t+1,e.length-1)].focus()}dispose(){super.dispose(),this.paneItems.forEach(e=>e.disposable.dispose())}}export{ie as DefaultPaneDndController,b as Pane,ne as PaneView};
