import"../../dnd.js";import{$ as F,append as _,clearNode as ge,createStyleSheet as fe,getWindow as J,h as O,hasParentWithClass as $,isActiveElement as ve,asCssValueWithDefault as Q,isKeyboardEvent as S,addDisposableListener as Z,isEditableElement as ee}from"../../dom.js";import{DomEmitter as N}from"../../event.js";import{StandardKeyboardEvent as G}from"../../keyboardEvent.js";import{ActionBar as me}from"../actionbar/actionbar.js";import"../contextview/contextview.js";import{FindInput as ye}from"../findinput/findInput.js";import{MessageType as te,unthemedInboxStyles as be}from"../inputbox/inputBox.js";import"../list/list.js";import{ElementsDragAndDropData as ie}from"../list/listView.js";import{isActionItem as De,isButton as Fe,isMonacoCustomToggle as Se,isMonacoEditor as Ie,isStickyScrollContainer as E,isStickyScrollElement as x,List as we,MouseController as Ce}from"../list/listWidget.js";import{Toggle as Ne,unthemedToggleStyles as Ee}from"../toggle/toggle.js";import{getVisibleState as xe,isFilterResult as Me}from"./indexTreeModel.js";import{TreeDragOverBubble as ke,TreeError as Le,TreeMouseEventTarget as M,TreeVisibility as k}from"./tree.js";import{Action as Re}from"../../../common/actions.js";import{distinct as oe,equals as K,range as Pe}from"../../../common/arrays.js";import{Delayer as Ae,disposableTimeout as _e,timeout as Oe}from"../../../common/async.js";import{Codicon as H}from"../../../common/codicons.js";import{ThemeIcon as ne}from"../../../common/themables.js";import{SetMap as He}from"../../../common/map.js";import{Emitter as f,Event as u,EventBufferer as Ve,Relay as L}from"../../../common/event.js";import{fuzzyScore as We,FuzzyScore as R}from"../../../common/filters.js";import{KeyCode as m}from"../../../common/keyCodes.js";import{Disposable as I,DisposableStore as v,dispose as U,toDisposable as q}from"../../../common/lifecycle.js";import{clamp as V}from"../../../common/numbers.js";import"../../../common/scrollable.js";import{isNumber as Be}from"../../../common/types.js";import"./media/tree.css";import{localize as y}from"../../../../nls.js";import"../hover/hoverDelegate.js";import{createInstantHoverDelegate as ze}from"../hover/hoverDelegateFactory.js";import{autorun as $e,constObservable as Ge}from"../../../common/observable.js";import{alert as se}from"../aria/aria.js";class Ke extends ie{constructor(e){super(e.elements.map(i=>i.element));this.data=e}set context(e){this.data.context=e}get context(){return this.data.context}}function Y(a){return a instanceof ie?new Ke(a):a}class Ue{constructor(t,e){this.modelProvider=t;this.dnd=e}autoExpandNode;autoExpandDisposable=I.None;disposables=new v;getDragURI(t){return this.dnd.getDragURI(t.element)}getDragLabel(t,e){if(this.dnd.getDragLabel)return this.dnd.getDragLabel(t.map(i=>i.element),e)}onDragStart(t,e){this.dnd.onDragStart?.(Y(t),e)}onDragOver(t,e,i,n,o,s=!0){const r=this.dnd.onDragOver(Y(t),e&&e.element,i,n,o),l=this.autoExpandNode!==e;if(l&&(this.autoExpandDisposable.dispose(),this.autoExpandNode=e),typeof e>"u")return r;if(l&&typeof r!="boolean"&&r.autoExpand&&(this.autoExpandDisposable=_e(()=>{const g=this.modelProvider(),b=g.getNodeLocation(e);g.isCollapsed(b)&&g.setCollapsed(b,!1),this.autoExpandNode=void 0},500,this.disposables)),typeof r=="boolean"||!r.accept||typeof r.bubble>"u"||r.feedback){if(!s){const g=typeof r=="boolean"?r:r.accept,b=typeof r=="boolean"?void 0:r.effect;return{accept:g,effect:b,feedback:[i]}}return r}if(r.bubble===ke.Up){const g=this.modelProvider(),b=g.getNodeLocation(e),c=g.getParentNodeLocation(b),T=g.getNode(c),D=c&&g.getListIndex(c);return this.onDragOver(t,T,D,n,o,!1)}const d=this.modelProvider(),h=d.getNodeLocation(e),p=d.getListIndex(h),C=d.getListRenderCount(h);return{...r,feedback:Pe(p,p+C)}}drop(t,e,i,n,o){this.autoExpandDisposable.dispose(),this.autoExpandNode=void 0,this.dnd.drop(Y(t),e&&e.element,i,n,o)}onDragEnd(t){this.dnd.onDragEnd?.(t)}dispose(){this.disposables.dispose(),this.dnd.dispose()}}function qe(a,t){return t&&{...t,identityProvider:t.identityProvider&&{getId(e){return t.identityProvider.getId(e.element)}},dnd:t.dnd&&new Ue(a,t.dnd),multipleSelectionController:t.multipleSelectionController&&{isSelectionSingleChangeEvent(e){return t.multipleSelectionController.isSelectionSingleChangeEvent({...e,element:e.element})},isSelectionRangeChangeEvent(e){return t.multipleSelectionController.isSelectionRangeChangeEvent({...e,element:e.element})}},accessibilityProvider:t.accessibilityProvider&&{...t.accessibilityProvider,getSetSize(e){const i=a(),n=i.getNodeLocation(e),o=i.getParentNodeLocation(n);return i.getNode(o).visibleChildrenCount},getPosInSet(e){return e.visibleChildIndex+1},isChecked:t.accessibilityProvider&&t.accessibilityProvider.isChecked?e=>t.accessibilityProvider.isChecked(e.element):void 0,getRole:t.accessibilityProvider&&t.accessibilityProvider.getRole?e=>t.accessibilityProvider.getRole(e.element):()=>"treeitem",getAriaLabel(e){return t.accessibilityProvider.getAriaLabel(e.element)},getWidgetAriaLabel(){return t.accessibilityProvider.getWidgetAriaLabel()},getWidgetRole:t.accessibilityProvider&&t.accessibilityProvider.getWidgetRole?()=>t.accessibilityProvider.getWidgetRole():()=>"tree",getAriaLevel:t.accessibilityProvider&&t.accessibilityProvider.getAriaLevel?e=>t.accessibilityProvider.getAriaLevel(e.element):e=>e.depth,getActiveDescendantId:t.accessibilityProvider.getActiveDescendantId&&(e=>t.accessibilityProvider.getActiveDescendantId(e.element))},keyboardNavigationLabelProvider:t.keyboardNavigationLabelProvider&&{...t.keyboardNavigationLabelProvider,getKeyboardNavigationLabel(e){return t.keyboardNavigationLabelProvider.getKeyboardNavigationLabel(e.element)}}}}class Ye{constructor(t){this.delegate=t}getHeight(t){return this.delegate.getHeight(t.element)}getTemplateId(t){return this.delegate.getTemplateId(t.element)}hasDynamicHeight(t){return!!this.delegate.hasDynamicHeight&&this.delegate.hasDynamicHeight(t.element)}setDynamicHeight(t,e){this.delegate.setDynamicHeight?.(t.element,e)}}class P{focus;selection;expanded;scrollTop;static lift(t){return t instanceof P?t:new P(t)}static empty(t=0){return new P({focus:[],selection:[],expanded:Object.create(null),scrollTop:t})}constructor(t){if(this.focus=new Set(t.focus),this.selection=new Set(t.selection),t.expanded instanceof Array){this.expanded=Object.create(null);for(const e of t.expanded)this.expanded[e]=1}else this.expanded=t.expanded;this.expanded=t.expanded,this.scrollTop=t.scrollTop}toJSON(){return{focus:Array.from(this.focus),selection:Array.from(this.selection),expanded:this.expanded,scrollTop:this.scrollTop}}}var Xe=(i=>(i.None="none",i.OnHover="onHover",i.Always="always",i))(Xe||{});class je{constructor(t,e=[]){this._elements=e;this.onDidChange=u.forEach(t,i=>this._elements=i,this.disposables)}disposables=new v;onDidChange;get elements(){return this._elements}dispose(){this.disposables.dispose()}}class B{constructor(t,e,i,n,o,s={}){this.renderer=t;this.model=e;this.activeNodes=n;this.renderedIndentGuides=o;this.templateId=t.templateId,this.updateOptions(s),u.map(i,r=>r.node)(this.onDidChangeNodeTwistieState,this,this.disposables),t.onDidChangeTwistieState?.(this.onDidChangeTwistieState,this,this.disposables)}static DefaultIndent=8;templateId;renderedElements=new Map;renderedNodes=new Map;indent=B.DefaultIndent;hideTwistiesOfChildlessElements=!1;shouldRenderIndentGuides=!1;activeIndentNodes=new Set;indentGuidesDisposable=I.None;disposables=new v;updateOptions(t={}){if(typeof t.indent<"u"){const e=V(t.indent,0,40);if(e!==this.indent){this.indent=e;for(const[i,n]of this.renderedNodes)this.renderTreeElement(i,n)}}if(typeof t.renderIndentGuides<"u"){const e=t.renderIndentGuides!=="none";if(e!==this.shouldRenderIndentGuides){this.shouldRenderIndentGuides=e;for(const[i,n]of this.renderedNodes)this._renderIndentGuides(i,n);if(this.indentGuidesDisposable.dispose(),e){const i=new v;this.activeNodes.onDidChange(this._onDidChangeActiveNodes,this,i),this.indentGuidesDisposable=i,this._onDidChangeActiveNodes(this.activeNodes.elements)}}}typeof t.hideTwistiesOfChildlessElements<"u"&&(this.hideTwistiesOfChildlessElements=t.hideTwistiesOfChildlessElements)}renderTemplate(t){const e=_(t,F(".monaco-tl-row")),i=_(e,F(".monaco-tl-indent")),n=_(e,F(".monaco-tl-twistie")),o=_(e,F(".monaco-tl-contents")),s=this.renderer.renderTemplate(o);return{container:t,indent:i,twistie:n,indentGuidesDisposable:I.None,templateData:s}}renderElement(t,e,i,n){this.renderedNodes.set(t,i),this.renderedElements.set(t.element,t),this.renderTreeElement(t,i),this.renderer.renderElement(t,e,i.templateData,n)}disposeElement(t,e,i,n){i.indentGuidesDisposable.dispose(),this.renderer.disposeElement?.(t,e,i.templateData,n),typeof n=="number"&&(this.renderedNodes.delete(t),this.renderedElements.delete(t.element))}disposeTemplate(t){this.renderer.disposeTemplate(t.templateData)}onDidChangeTwistieState(t){const e=this.renderedElements.get(t);e&&this.onDidChangeNodeTwistieState(e)}onDidChangeNodeTwistieState(t){const e=this.renderedNodes.get(t);e&&(this._onDidChangeActiveNodes(this.activeNodes.elements),this.renderTreeElement(t,e))}renderTreeElement(t,e){const i=B.DefaultIndent+(t.depth-1)*this.indent;e.twistie.style.paddingLeft=`${i}px`,e.indent.style.width=`${i+this.indent-16}px`,t.collapsible?e.container.setAttribute("aria-expanded",String(!t.collapsed)):e.container.removeAttribute("aria-expanded"),e.twistie.classList.remove(...ne.asClassNameArray(H.treeItemExpanded));let n=!1;this.renderer.renderTwistie&&(n=this.renderer.renderTwistie(t.element,e.twistie)),t.collapsible&&(!this.hideTwistiesOfChildlessElements||t.visibleChildrenCount>0)?(n||e.twistie.classList.add(...ne.asClassNameArray(H.treeItemExpanded)),e.twistie.classList.add("collapsible"),e.twistie.classList.toggle("collapsed",t.collapsed)):e.twistie.classList.remove("collapsible","collapsed"),this._renderIndentGuides(t,e)}_renderIndentGuides(t,e){if(ge(e.indent),e.indentGuidesDisposable.dispose(),!this.shouldRenderIndentGuides)return;const i=new v;for(;;){const n=this.model.getNodeLocation(t),o=this.model.getParentNodeLocation(n);if(!o)break;const s=this.model.getNode(o),r=F(".indent-guide",{style:`width: ${this.indent}px`});this.activeIndentNodes.has(s)&&r.classList.add("active"),e.indent.childElementCount===0?e.indent.appendChild(r):e.indent.insertBefore(r,e.indent.firstElementChild),this.renderedIndentGuides.add(s,r),i.add(q(()=>this.renderedIndentGuides.delete(s,r))),t=s}e.indentGuidesDisposable=i}_onDidChangeActiveNodes(t){if(!this.shouldRenderIndentGuides)return;const e=new Set;t.forEach(i=>{const n=this.model.getNodeLocation(i);try{const o=this.model.getParentNodeLocation(n);i.collapsible&&i.children.length>0&&!i.collapsed?e.add(i):o&&e.add(this.model.getNode(o))}catch{}}),this.activeIndentNodes.forEach(i=>{e.has(i)||this.renderedIndentGuides.forEach(i,n=>n.classList.remove("active"))}),e.forEach(i=>{this.activeIndentNodes.has(i)||this.renderedIndentGuides.forEach(i,n=>n.classList.add("active"))}),this.activeIndentNodes=e}setModel(t){this.model=t}dispose(){this.renderedNodes.clear(),this.renderedElements.clear(),this.indentGuidesDisposable.dispose(),U(this.disposables)}}class Je{constructor(t,e,i){this.tree=t;this.keyboardNavigationLabelProvider=e;this._filter=i;t.onWillRefilter(this.reset,this,this.disposables)}_totalCount=0;get totalCount(){return this._totalCount}_matchCount=0;get matchCount(){return this._matchCount}_pattern="";_lowercasePattern="";disposables=new v;set pattern(t){this._pattern=t,this._lowercasePattern=t.toLowerCase()}filter(t,e){let i=k.Visible;if(this._filter){const s=this._filter.filter(t,e);if(typeof s=="boolean"?i=s?k.Visible:k.Hidden:Me(s)?i=xe(s.visibility):i=s,i===k.Hidden)return!1}if(this._totalCount++,!this._pattern)return this._matchCount++,{data:R.Default,visibility:i};const n=this.keyboardNavigationLabelProvider.getKeyboardNavigationLabel(t),o=Array.isArray(n)?n:[n];for(const s of o){const r=s&&s.toString();if(typeof r>"u")return{data:R.Default,visibility:i};let l;if(this.tree.findMatchType===1){const d=r.toLowerCase().indexOf(this._lowercasePattern);if(d>-1){l=[Number.MAX_SAFE_INTEGER,0];for(let h=this._lowercasePattern.length;h>0;h--)l.push(d+h-1)}}else l=We(this._pattern,this._lowercasePattern,0,r,r.toLowerCase(),0,{firstMatchCanBeWeak:!0,boostFullMatch:!0});if(l)return this._matchCount++,o.length===1?{data:l,visibility:i}:{data:{label:r,score:l},visibility:i}}return this.tree.findMode===1?typeof this.tree.options.defaultFindVisibility=="number"?this.tree.options.defaultFindVisibility:this.tree.options.defaultFindVisibility?this.tree.options.defaultFindVisibility(t):k.Recurse:{data:R.Default,visibility:i}}reset(){this._totalCount=0,this._matchCount=0}dispose(){U(this.disposables)}}class Qe extends Ne{id;constructor(t,e,i){super({icon:t.icon,title:t.title,isChecked:t.isChecked,inputActiveOptionBorder:e.inputActiveOptionBorder,inputActiveOptionForeground:e.inputActiveOptionForeground,inputActiveOptionBackground:e.inputActiveOptionBackground,hoverDelegate:i}),this.id=t.id}}class Ze{stateMap;constructor(t){this.stateMap=new Map(t.map(e=>[e.id,{...e}]))}states(){return Array.from(this.stateMap.values())}get(t){const e=this.stateMap.get(t);if(e===void 0)throw new Error(`No state found for toggle id ${t}`);return e.isChecked}set(t,e){const i=this.stateMap.get(t);if(i===void 0)throw new Error(`No state found for toggle id ${t}`);return i.isChecked===e?!1:(i.isChecked=e,!0)}}const et={inputBoxStyles:be,toggleStyles:Ee,listFilterWidgetBackground:void 0,listFilterWidgetNoMatchesOutline:void 0,listFilterWidgetOutline:void 0,listFilterWidgetShadow:void 0};var tt=(e=>(e[e.Highlight=0]="Highlight",e[e.Filter=1]="Filter",e))(tt||{}),it=(e=>(e[e.Fuzzy=0]="Fuzzy",e[e.Contiguous=1]="Contiguous",e))(it||{});class ot extends I{constructor(e,i,n,o,s=[],r){super();this.tree=i;e.appendChild(this.elements.root),this._register(q(()=>this.elements.root.remove()));const l=r?.styles??et;l.listFilterWidgetBackground&&(this.elements.root.style.backgroundColor=l.listFilterWidgetBackground),l.listFilterWidgetShadow&&(this.elements.root.style.boxShadow=`0 0 8px 2px ${l.listFilterWidgetShadow}`);const d=this._register(ze());this.toggles=s.map(c=>this._register(new Qe(c,l.toggleStyles,d))),this.onDidToggleChange=u.any(...this.toggles.map(c=>u.map(c.onChange,()=>({id:c.id,isChecked:c.checked})))),this.findInput=this._register(new ye(this.elements.findInput,n,{label:y("type to search","Type to search"),placeholder:o,additionalToggles:this.toggles,showCommonFindToggles:!1,inputBoxStyles:l.inputBoxStyles,toggleStyles:l.toggleStyles,history:r?.history})),this.actionbar=this._register(new me(this.elements.actionbar));const h=this._register(new N(this.findInput.inputBox.inputElement,"keydown")),p=u.chain(h.event,c=>c.map(T=>new G(T)));this._register(p(c=>{if(c.equals(m.Enter)){c.preventDefault(),c.stopPropagation(),this.findInput.inputBox.addToHistory(),this.tree.domFocus();return}if(c.equals(m.DownArrow)){c.preventDefault(),c.stopPropagation(),this.findInput.inputBox.isAtLastInHistory()||this.findInput.inputBox.isNowhereInHistory()?(this.findInput.inputBox.addToHistory(),this.tree.domFocus()):this.findInput.inputBox.showNextValue();return}if(c.equals(m.UpArrow)){c.preventDefault(),c.stopPropagation(),this.findInput.inputBox.showPreviousValue();return}}));const C=this._register(new Re("close",y("close","Close"),"codicon codicon-close",!0,()=>this.dispose()));this.actionbar.push(C,{icon:!0,label:!1});const g=this._register(new N(this.elements.grab,"mousedown"));this._register(g.event(c=>{const T=new v,D=T.add(new N(J(c),"mousemove")),z=T.add(new N(J(c),"mouseup")),ae=this.right,de=c.pageX,ce=this.top,he=c.pageY;this.elements.grab.classList.add("grabbing");const ue=this.elements.root.style.transition;this.elements.root.style.transition="unset";const j=A=>{const Te=A.pageX-de;this.right=ae-Te;const pe=A.pageY-he;this.top=ce+pe,this.layout()};T.add(D.event(j)),T.add(z.event(A=>{j(A),this.elements.grab.classList.remove("grabbing"),this.elements.root.style.transition=ue,T.dispose()}))}));const b=u.chain(this._register(new N(this.elements.grab,"keydown")).event,c=>c.map(T=>new G(T)));this._register(b(c=>{let T,D;if(c.keyCode===m.LeftArrow?T=Number.POSITIVE_INFINITY:c.keyCode===m.RightArrow?T=0:c.keyCode===m.Space&&(T=this.right===0?Number.POSITIVE_INFINITY:0),c.keyCode===m.UpArrow?D=0:c.keyCode===m.DownArrow&&(D=Number.POSITIVE_INFINITY),T!==void 0&&(c.preventDefault(),c.stopPropagation(),this.right=T,this.layout()),D!==void 0){c.preventDefault(),c.stopPropagation(),this.top=D;const z=this.elements.root.style.transition;this.elements.root.style.transition="unset",this.layout(),setTimeout(()=>{this.elements.root.style.transition=z},0)}})),this.onDidChangeValue=this.findInput.onDidChange}elements=O(".monaco-tree-type-filter",[O(".monaco-tree-type-filter-grab.codicon.codicon-debug-gripper@grab",{tabIndex:0}),O(".monaco-tree-type-filter-input@findInput"),O(".monaco-tree-type-filter-actionbar@actionbar")]);get value(){return this.findInput.inputBox.value}set value(e){this.findInput.inputBox.value=e}findInput;actionbar;toggles=[];width=0;right=0;top=0;_onDidDisable=new f;onDidDisable=this._onDidDisable.event;onDidChangeValue;onDidToggleChange;setToggleState(e,i){const n=this.toggles.find(o=>o.id===e);n&&(n.checked=i)}setPlaceHolder(e){this.findInput.inputBox.setPlaceHolder(e)}getHistory(){return this.findInput.inputBox.getHistory()}focus(){this.findInput.focus()}select(){this.findInput.select(),this.findInput.inputBox.addToHistory(!0)}layout(e=this.width){this.width=e,this.right=V(this.right,0,Math.max(0,e-212)),this.elements.root.style.right=`${this.right}px`,this.top=V(this.top,0,24),this.elements.root.style.top=`${this.top}px`}showMessage(e){this.findInput.showMessage(e)}clearMessage(){this.findInput.clearMessage()}async dispose(){this._onDidDisable.fire(),this.elements.root.classList.add("disabled"),await Oe(300),super.dispose()}}var nt=(e=>(e.Mode="mode",e.MatchType="matchType",e))(nt||{});class st{constructor(t,e,i,n={}){this.tree=t;this.filter=e;this.contextViewProvider=i;this.options=n;this.toggles=new Ze(n.toggles??[]),this._placeholder=n.placeholder??y("type to search","Type to search")}_history;_pattern="";get pattern(){return this._pattern}previousPattern="";toggles;_placeholder;get placeholder(){return this._placeholder}set placeholder(t){this._placeholder=t,this.widget?.setPlaceHolder(t)}widget;width=0;_onDidChangePattern=new f;onDidChangePattern=this._onDidChangePattern.event;_onDidChangeOpenState=new f;onDidChangeOpenState=this._onDidChangeOpenState.event;enabledDisposables=new v;disposables=new v;isOpened(){return!!this.widget}open(){if(this.widget){this.widget.focus(),this.widget.select();return}this.widget=new ot(this.tree.getHTMLElement(),this.tree,this.contextViewProvider,this.placeholder,this.toggles.states(),{...this.options,history:this._history}),this.enabledDisposables.add(this.widget),this.widget.onDidChangeValue(this.onDidChangeValue,this,this.enabledDisposables),this.widget.onDidDisable(this.close,this,this.enabledDisposables),this.widget.onDidToggleChange(this.onDidToggleChange,this,this.enabledDisposables),this.widget.layout(this.width),this.widget.focus(),this.widget.value=this.previousPattern,this.widget.select(),this._onDidChangeOpenState.fire(!0)}close(){this.widget&&(this._history=this.widget.getHistory(),this.widget=void 0,this.enabledDisposables.clear(),this.previousPattern=this.pattern,this.onDidChangeValue(""),this.tree.domFocus(),this._onDidChangeOpenState.fire(!1))}onDidChangeValue(t){this._pattern=t,this._onDidChangePattern.fire(t),this.filter.pattern=t,this.applyPattern(t)}onDidToggleChange(t){this.toggles.set(t.id,t.isChecked)}updateToggleState(t,e){this.toggles.set(t,e),this.widget?.setToggleState(t,e)}renderMessage(t){t?this.tree.options.showNotFoundMessage??!0?this.widget?.showMessage({type:te.WARNING,content:y("not found","No results found.")}):this.widget?.showMessage({type:te.WARNING}):this.widget?.clearMessage()}alertResults(t){t?se(y("foundResults","{0} results",t)):se(y("replFindNoResults","No results"))}layout(t){this.width=t,this.widget?.layout(t)}dispose(){this._history=void 0,this._onDidChangePattern.dispose(),this.enabledDisposables.dispose(),this.disposables.dispose()}}class rt extends st{constructor(e,i,n,o={}){const s=o.defaultFindMode??0,r=o.defaultFindMatchType??0,l=[{id:"mode",icon:H.listFilter,title:y("filter","Filter"),isChecked:s===1},{id:"matchType",icon:H.searchFuzzy,title:y("fuzzySearch","Fuzzy Match"),isChecked:r===0}];super(e,i,n,{...o,toggles:l});this.filter=i;this.disposables.add(this.tree.onDidChangeModel(()=>{this.isOpened()&&(this.pattern.length!==0&&this.tree.refilter(),this.render())}))}get mode(){return this.toggles.get("mode")?1:0}set mode(e){if(e===this.mode)return;const i=e===1;this.updateToggleState("mode",i),this.placeholder=i?y("type to filter","Type to filter"):y("type to search","Type to search"),this.tree.refilter(),this.render(),this._onDidChangeMode.fire(e)}get matchType(){return this.toggles.get("matchType")?0:1}set matchType(e){e!==this.matchType&&(this.updateToggleState("matchType",e===0),this.tree.refilter(),this.render(),this._onDidChangeMatchType.fire(e))}_onDidChangeMode=new f;onDidChangeMode=this._onDidChangeMode.event;_onDidChangeMatchType=new f;onDidChangeMatchType=this._onDidChangeMatchType.event;updateOptions(e={}){e.defaultFindMode!==void 0&&(this.mode=e.defaultFindMode),e.defaultFindMatchType!==void 0&&(this.matchType=e.defaultFindMatchType)}applyPattern(e){this.tree.refilter(),e&&this.tree.focusNext(0,!0,void 0,n=>!R.isDefault(n.filterData));const i=this.tree.getFocus();if(i.length>0){const n=i[0];this.tree.getRelativeTop(n)===null&&this.tree.reveal(n,.5)}this.render()}shouldAllowFocus(e){return!this.isOpened()||!this.pattern||this.filter.totalCount>0&&this.filter.matchCount<=1?!0:!R.isDefault(e.filterData)}onDidToggleChange(e){e.id==="mode"?this.mode=e.isChecked?1:0:e.id==="matchType"&&(this.matchType=e.isChecked?0:1)}render(){const i=this.filter.matchCount===0&&this.filter.totalCount>0&&this.pattern.length>0;this.renderMessage(i),this.pattern.length&&this.alertResults(this.filter.matchCount)}}function lt(a,t){return a.position===t.position&&re(a,t)}function re(a,t){return a.node.element===t.node.element&&a.startIndex===t.startIndex&&a.height===t.height&&a.endIndex===t.endIndex}class at{constructor(t=[]){this.stickyNodes=t}get count(){return this.stickyNodes.length}equal(t){return K(this.stickyNodes,t.stickyNodes,lt)}lastNodePartiallyVisible(){if(this.count===0)return!1;const t=this.stickyNodes[this.count-1];if(this.count===1)return t.position!==0;const e=this.stickyNodes[this.count-2];return e.position+e.height!==t.position}animationStateChanged(t){if(!K(this.stickyNodes,t.stickyNodes,re)||this.count===0)return!1;const e=this.stickyNodes[this.count-1],i=t.stickyNodes[t.count-1];return e.position!==i.position}}class dt{constrainStickyScrollNodes(t,e,i){for(let n=0;n<t.length;n++){const o=t[n];if(o.position+o.height>i||n>=e)return t.slice(0,n)}return t}}class le extends I{constructor(e,i,n,o,s,r={}){super();this.tree=e;this.model=i;this.view=n;this.treeDelegate=s;const l=this.validateStickySettings(r);this.stickyScrollMaxItemCount=l.stickyScrollMaxItemCount,this.stickyScrollDelegate=r.stickyScrollDelegate??new dt,this._widget=this._register(new ct(n.getScrollableElement(),n,e,o,s,r.accessibilityProvider)),this.onDidChangeHasFocus=this._widget.onDidChangeHasFocus,this.onContextMenu=this._widget.onContextMenu,this._register(n.onDidScroll(()=>this.update())),this._register(n.onDidChangeContentHeight(()=>this.update())),this._register(e.onDidChangeCollapseState(()=>this.update())),this.update()}onDidChangeHasFocus;onContextMenu;stickyScrollDelegate;stickyScrollMaxItemCount;maxWidgetViewRatio=.4;_widget;get height(){return this._widget.height}get count(){return this._widget.count}getNode(e){return this._widget.getNode(e)}getNodeAtHeight(e){let i;if(e===0?i=this.view.firstVisibleIndex:i=this.view.indexAt(e+this.view.scrollTop),!(i<0||i>=this.view.length))return this.view.element(i)}update(){const e=this.getNodeAtHeight(0);if(!e||this.tree.scrollTop===0){this._widget.setState(void 0);return}const i=this.findStickyState(e);this._widget.setState(i)}findStickyState(e){const i=[];let n=e,o=0,s=this.getNextStickyNode(n,void 0,o);for(;s&&(i.push(s),o+=s.height,!(i.length<=this.stickyScrollMaxItemCount&&(n=this.getNextVisibleNode(s),!n)));)s=this.getNextStickyNode(n,s.node,o);const r=this.constrainStickyNodes(i);return r.length?new at(r):void 0}getNextVisibleNode(e){return this.getNodeAtHeight(e.position+e.height)}getNextStickyNode(e,i,n){const o=this.getAncestorUnderPrevious(e,i);if(o&&!(o===e&&(!this.nodeIsUncollapsedParent(e)||this.nodeTopAlignsWithStickyNodesBottom(e,n))))return this.createStickyScrollNode(o,n)}nodeTopAlignsWithStickyNodesBottom(e,i){const n=this.getNodeIndex(e),o=this.view.getElementTop(n),s=i;return this.view.scrollTop===o-s}createStickyScrollNode(e,i){const n=this.treeDelegate.getHeight(e),{startIndex:o,endIndex:s}=this.getNodeRange(e),r=this.calculateStickyNodePosition(s,i,n);return{node:e,position:r,height:n,startIndex:o,endIndex:s}}getAncestorUnderPrevious(e,i=void 0){let n=e,o=this.getParentNode(n);for(;o;){if(o===i)return n;n=o,o=this.getParentNode(n)}if(i===void 0)return n}calculateStickyNodePosition(e,i,n){let o=this.view.getRelativeTop(e);if(o===null&&this.view.firstVisibleIndex===e&&e+1<this.view.length){const h=this.treeDelegate.getHeight(this.view.element(e)),p=this.view.getRelativeTop(e+1);o=p?p-h/this.view.renderHeight:null}if(o===null)return i;const s=this.view.element(e),r=this.treeDelegate.getHeight(s),d=o*this.view.renderHeight+r;return i+n>d&&i<=d?d-n:i}constrainStickyNodes(e){if(e.length===0)return[];const i=this.view.renderHeight*this.maxWidgetViewRatio,n=e[e.length-1];if(e.length<=this.stickyScrollMaxItemCount&&n.position+n.height<=i)return e;const o=this.stickyScrollDelegate.constrainStickyScrollNodes(e,this.stickyScrollMaxItemCount,i);if(!o.length)return[];const s=o[o.length-1];if(o.length>this.stickyScrollMaxItemCount||s.position+s.height>i)throw new Error("stickyScrollDelegate violates constraints");return o}getParentNode(e){const i=this.model.getNodeLocation(e),n=this.model.getParentNodeLocation(i);return n?this.model.getNode(n):void 0}nodeIsUncollapsedParent(e){const i=this.model.getNodeLocation(e);return this.model.getListRenderCount(i)>1}getNodeIndex(e){const i=this.model.getNodeLocation(e);return this.model.getListIndex(i)}getNodeRange(e){const i=this.model.getNodeLocation(e),n=this.model.getListIndex(i);if(n<0)throw new Error("Node not found in tree");const o=this.model.getListRenderCount(i),s=n+o-1;return{startIndex:n,endIndex:s}}nodePositionTopBelowWidget(e){const i=[];let n=this.getParentNode(e);for(;n;)i.push(n),n=this.getParentNode(n);let o=0;for(let s=0;s<i.length&&s<this.stickyScrollMaxItemCount;s++)o+=this.treeDelegate.getHeight(i[s]);return o}getFocus(){return this._widget.getFocus()}domFocus(){this._widget.domFocus()}focusedLast(){return this._widget.focusedLast()}updateOptions(e={}){if(!e.stickyScrollMaxItemCount)return;const i=this.validateStickySettings(e);this.stickyScrollMaxItemCount!==i.stickyScrollMaxItemCount&&(this.stickyScrollMaxItemCount=i.stickyScrollMaxItemCount,this.update())}validateStickySettings(e){let i=7;return typeof e.stickyScrollMaxItemCount=="number"&&(i=Math.max(e.stickyScrollMaxItemCount,1)),{stickyScrollMaxItemCount:i}}setModel(e){this.model=e}}class ct{constructor(t,e,i,n,o,s){this.view=e;this.tree=i;this.treeRenderers=n;this.treeDelegate=o;this.accessibilityProvider=s;this._rootDomNode=F(".monaco-tree-sticky-container.empty"),t.appendChild(this._rootDomNode);const r=F(".monaco-tree-sticky-container-shadow");this._rootDomNode.appendChild(r),this.stickyScrollFocus=new ht(this._rootDomNode,e),this.onDidChangeHasFocus=this.stickyScrollFocus.onDidChangeHasFocus,this.onContextMenu=this.stickyScrollFocus.onContextMenu}_rootDomNode;_previousState;_previousElements=[];_previousStateDisposables=new v;stickyScrollFocus;onDidChangeHasFocus;onContextMenu;get height(){if(!this._previousState)return 0;const t=this._previousState.stickyNodes[this._previousState.count-1];return t.position+t.height}get count(){return this._previousState?.count??0}getNode(t){return this._previousState?.stickyNodes.find(e=>e.node===t)}setState(t){const e=!!this._previousState&&this._previousState.count>0,i=!!t&&t.count>0;if(!e&&!i||e&&i&&this._previousState.equal(t))return;if(e!==i&&this.setVisible(i),!i){this._previousState=void 0,this._previousElements=[],this._previousStateDisposables.clear();return}const n=t.stickyNodes[t.count-1];if(this._previousState&&t.animationStateChanged(this._previousState))this._previousElements[this._previousState.count-1].style.top=`${n.position}px`;else{this._previousStateDisposables.clear();const o=Array(t.count);for(let s=t.count-1;s>=0;s--){const r=t.stickyNodes[s],{element:l,disposable:d}=this.createElement(r,s,t.count);o[s]=l,this._rootDomNode.appendChild(l),this._previousStateDisposables.add(d)}this.stickyScrollFocus.updateElements(o,t),this._previousElements=o}this._previousState=t,this._rootDomNode.style.height=`${n.position+n.height}px`}createElement(t,e,i){const n=t.startIndex,o=document.createElement("div");o.style.top=`${t.position}px`,this.tree.options.setRowHeight!==!1&&(o.style.height=`${t.height}px`),this.tree.options.setRowLineHeight!==!1&&(o.style.lineHeight=`${t.height}px`),o.classList.add("monaco-tree-sticky-row"),o.classList.add("monaco-list-row"),o.setAttribute("data-index",`${n}`),o.setAttribute("data-parity",n%2===0?"even":"odd"),o.setAttribute("id",this.view.getElementID(n));const s=this.setAccessibilityAttributes(o,t.node.element,e,i),r=this.treeDelegate.getTemplateId(t.node),l=this.treeRenderers.find(C=>C.templateId===r);if(!l)throw new Error(`No renderer found for template id ${r}`);let d=t.node;d===this.tree.getNode(this.tree.getNodeLocation(t.node))&&(d=new Proxy(t.node,{}));const h=l.renderTemplate(o);l.renderElement(d,t.startIndex,h,t.height);const p=q(()=>{s.dispose(),l.disposeElement(d,t.startIndex,h,t.height),l.disposeTemplate(h),o.remove()});return{element:o,disposable:p}}setAccessibilityAttributes(t,e,i,n){if(!this.accessibilityProvider)return I.None;this.accessibilityProvider.getSetSize&&t.setAttribute("aria-setsize",String(this.accessibilityProvider.getSetSize(e,i,n))),this.accessibilityProvider.getPosInSet&&t.setAttribute("aria-posinset",String(this.accessibilityProvider.getPosInSet(e,i))),this.accessibilityProvider.getRole&&t.setAttribute("role",this.accessibilityProvider.getRole(e)??"treeitem");const o=this.accessibilityProvider.getAriaLabel(e),s=o&&typeof o!="string"?o:Ge(o),r=$e(d=>{const h=d.readObservable(s);h?t.setAttribute("aria-label",h):t.removeAttribute("aria-label")});typeof o=="string"||o&&t.setAttribute("aria-label",o.get());const l=this.accessibilityProvider.getAriaLevel&&this.accessibilityProvider.getAriaLevel(e);return typeof l=="number"&&t.setAttribute("aria-level",`${l}`),t.setAttribute("aria-selected",String(!1)),r}setVisible(t){this._rootDomNode.classList.toggle("empty",!t),t||this.stickyScrollFocus.updateElements([],void 0)}getFocus(){return this.stickyScrollFocus.getFocus()}domFocus(){this.stickyScrollFocus.domFocus()}focusedLast(){return this.stickyScrollFocus.focusedLast()}dispose(){this.stickyScrollFocus.dispose(),this._previousStateDisposables.dispose(),this._rootDomNode.remove()}}class ht extends I{constructor(e,i){super();this.container=e;this.view=i;this._register(Z(this.container,"focus",()=>this.onFocus())),this._register(Z(this.container,"blur",()=>this.onBlur())),this._register(this.view.onDidFocus(()=>this.toggleStickyScrollFocused(!1))),this._register(this.view.onKeyDown(n=>this.onKeyDown(n))),this._register(this.view.onMouseDown(n=>this.onMouseDown(n))),this._register(this.view.onContextMenu(n=>this.handleContextMenu(n)))}focusedIndex=-1;elements=[];state;_onDidChangeHasFocus=new f;onDidChangeHasFocus=this._onDidChangeHasFocus.event;_onContextMenu=new f;onContextMenu=this._onContextMenu.event;_domHasFocus=!1;get domHasFocus(){return this._domHasFocus}set domHasFocus(e){e!==this._domHasFocus&&(this._onDidChangeHasFocus.fire(e),this._domHasFocus=e)}handleContextMenu(e){const i=e.browserEvent.target;if(!E(i)&&!x(i)){this.focusedLast()&&this.view.domFocus();return}if(!S(e.browserEvent)){if(!this.state)throw new Error("Context menu should not be triggered when state is undefined");const r=this.state.stickyNodes.findIndex(l=>l.node.element===e.element?.element);if(r===-1)throw new Error("Context menu should not be triggered when element is not in sticky scroll widget");this.container.focus(),this.setFocus(r);return}if(!this.state||this.focusedIndex<0)throw new Error("Context menu key should not be triggered when focus is not in sticky scroll widget");const o=this.state.stickyNodes[this.focusedIndex].node.element,s=this.elements[this.focusedIndex];this._onContextMenu.fire({element:o,anchor:s,browserEvent:e.browserEvent,isStickyScroll:!0})}onKeyDown(e){if(this.domHasFocus&&this.state){if(e.key==="ArrowUp")this.setFocusedElement(Math.max(0,this.focusedIndex-1)),e.preventDefault(),e.stopPropagation();else if(e.key==="ArrowDown"||e.key==="ArrowRight"){if(this.focusedIndex>=this.state.count-1){const i=this.state.stickyNodes[this.state.count-1].startIndex+1;this.view.domFocus(),this.view.setFocus([i]),this.scrollNodeUnderWidget(i,this.state)}else this.setFocusedElement(this.focusedIndex+1);e.preventDefault(),e.stopPropagation()}}}onMouseDown(e){const i=e.browserEvent.target;!E(i)&&!x(i)||(e.browserEvent.preventDefault(),e.browserEvent.stopPropagation())}updateElements(e,i){if(i&&i.count===0)throw new Error("Sticky scroll state must be undefined when there are no sticky nodes");if(i&&i.count!==e.length)throw new Error("Sticky scroll focus received illigel state");const n=this.focusedIndex;if(this.removeFocus(),this.elements=e,this.state=i,i){const o=V(n,0,i.count-1);this.setFocus(o)}else this.domHasFocus&&this.view.domFocus();this.container.tabIndex=i?0:-1}setFocusedElement(e){const i=this.state;if(!i)throw new Error("Cannot set focus when state is undefined");if(this.setFocus(e),!(e<i.count-1)&&i.lastNodePartiallyVisible()){const n=i.stickyNodes[e];this.scrollNodeUnderWidget(n.endIndex+1,i)}}scrollNodeUnderWidget(e,i){const n=i.stickyNodes[i.count-1],o=i.count>1?i.stickyNodes[i.count-2]:void 0,s=this.view.getElementTop(e),r=o?o.position+o.height+n.height:n.height;this.view.scrollTop=s-r}getFocus(){if(!(!this.state||this.focusedIndex===-1))return this.state.stickyNodes[this.focusedIndex].node.element}domFocus(){if(!this.state)throw new Error("Cannot focus when state is undefined");this.container.focus()}focusedLast(){return this.state?this.view.getHTMLElement().classList.contains("sticky-scroll-focused"):!1}removeFocus(){this.focusedIndex!==-1&&(this.toggleElementFocus(this.elements[this.focusedIndex],!1),this.focusedIndex=-1)}setFocus(e){if(0>e)throw new Error("addFocus() can not remove focus");if(!this.state&&e>=0)throw new Error("Cannot set focus index when state is undefined");if(this.state&&e>=this.state.count)throw new Error("Cannot set focus index to an index that does not exist");const i=this.focusedIndex;i>=0&&this.toggleElementFocus(this.elements[i],!1),e>=0&&this.toggleElementFocus(this.elements[e],!0),this.focusedIndex=e}toggleElementFocus(e,i){this.toggleElementActiveFocus(e,i&&this.domHasFocus),this.toggleElementPassiveFocus(e,i)}toggleCurrentElementActiveFocus(e){this.focusedIndex!==-1&&this.toggleElementActiveFocus(this.elements[this.focusedIndex],e)}toggleElementActiveFocus(e,i){e.classList.toggle("focused",i)}toggleElementPassiveFocus(e,i){e.classList.toggle("passive-focused",i)}toggleStickyScrollFocused(e){this.view.getHTMLElement().classList.toggle("sticky-scroll-focused",e)}onFocus(){if(!this.state||this.elements.length===0)throw new Error("Cannot focus when state is undefined or elements are empty");this.domHasFocus=!0,this.toggleStickyScrollFocused(!0),this.toggleCurrentElementActiveFocus(!0),this.focusedIndex===-1&&this.setFocus(0)}onBlur(){this.domHasFocus=!1,this.toggleCurrentElementActiveFocus(!1)}dispose(){this.toggleStickyScrollFocused(!1),this._onDidChangeHasFocus.fire(!1),super.dispose()}}function w(a){let t=M.Unknown;return $(a.browserEvent.target,"monaco-tl-twistie","monaco-tl-row")?t=M.Twistie:$(a.browserEvent.target,"monaco-tl-contents","monaco-tl-row")?t=M.Element:$(a.browserEvent.target,"monaco-tree-type-filter","monaco-list")&&(t=M.Filter),{browserEvent:a.browserEvent,element:a.element?a.element.element:null,target:t}}function ut(a){const t=E(a.browserEvent.target);return{element:a.element?a.element.element:null,browserEvent:a.browserEvent,anchor:a.anchor,isStickyScroll:t}}function W(a,t){t(a),a.children.forEach(e=>W(e,t))}class X{constructor(t,e){this.getFirstViewElementWithTrait=t;this.identityProvider=e}nodes=[];elements;_onDidChange=new f;onDidChange=this._onDidChange.event;_nodeSet;get nodeSet(){return this._nodeSet||(this._nodeSet=this.createNodeSet()),this._nodeSet}set(t,e){!e?.__forceEvent&&K(this.nodes,t)||this._set(t,!1,e)}_set(t,e,i){if(this.nodes=[...t],this.elements=void 0,this._nodeSet=void 0,!e){const n=this;this._onDidChange.fire({get elements(){return n.get()},browserEvent:i})}}get(){return this.elements||(this.elements=this.nodes.map(t=>t.element)),[...this.elements]}getNodes(){return this.nodes}has(t){return this.nodeSet.has(t)}onDidModelSplice({insertedNodes:t,deletedNodes:e}){if(!this.identityProvider){const l=this.createNodeSet(),d=h=>l.delete(h);e.forEach(h=>W(h,d)),this.set([...l.values()]);return}const i=new Set,n=l=>i.add(this.identityProvider.getId(l.element).toString());e.forEach(l=>W(l,n));const o=new Map,s=l=>o.set(this.identityProvider.getId(l.element).toString(),l);t.forEach(l=>W(l,s));const r=[];for(const l of this.nodes){const d=this.identityProvider.getId(l.element).toString();if(!i.has(d))r.push(l);else{const p=o.get(d);p&&p.visible&&r.push(p)}}if(this.nodes.length>0&&r.length===0){const l=this.getFirstViewElementWithTrait();l&&r.push(l)}this._set(r,!0)}createNodeSet(){const t=new Set;for(const e of this.nodes)t.add(e);return t}}class Tt extends Ce{constructor(e,i,n){super(e);this.tree=i;this.stickyScrollProvider=n}onViewPointer(e){if(Fe(e.browserEvent.target)||ee(e.browserEvent.target)||Ie(e.browserEvent.target)||e.browserEvent.isHandledByList)return;const i=e.element;if(!i)return super.onViewPointer(e);if(this.isSelectionRangeChangeEvent(e)||this.isSelectionSingleChangeEvent(e))return super.onViewPointer(e);const n=e.browserEvent.target,o=n.classList.contains("monaco-tl-twistie")||n.classList.contains("monaco-icon-label")&&n.classList.contains("folder-icon")&&e.browserEvent.offsetX<16,s=x(e.browserEvent.target);let r=!1;if(s?r=!0:typeof this.tree.expandOnlyOnTwistieClick=="function"?r=this.tree.expandOnlyOnTwistieClick(i.element):r=!!this.tree.expandOnlyOnTwistieClick,s)this.handleStickyScrollMouseEvent(e,i);else{if(r&&!o&&e.browserEvent.detail!==2)return super.onViewPointer(e);if(!this.tree.expandOnDoubleClick&&e.browserEvent.detail===2)return super.onViewPointer(e)}if(i.collapsible&&(!s||o)){const l=this.tree.getNodeLocation(i),d=e.browserEvent.altKey;if(this.tree.setFocus([l]),this.tree.toggleCollapsed(l,d),o){e.browserEvent.isHandledByList=!0;return}}s||super.onViewPointer(e)}handleStickyScrollMouseEvent(e,i){if(Se(e.browserEvent.target)||De(e.browserEvent.target))return;const n=this.stickyScrollProvider();if(!n)throw new Error("Sticky scroll controller not found");const o=this.list.indexOf(i),s=this.list.getElementTop(o),r=n.nodePositionTopBelowWidget(i);this.tree.scrollTop=s-r,this.list.domFocus(),this.list.setFocus([o]),this.list.setSelection([o])}onDoubleClick(e){e.browserEvent.target.classList.contains("monaco-tl-twistie")||!this.tree.expandOnDoubleClick||e.browserEvent.isHandledByList||super.onDoubleClick(e)}onMouseDown(e){const i=e.browserEvent.target;if(!E(i)&&!x(i)){super.onMouseDown(e);return}}onContextMenu(e){const i=e.browserEvent.target;if(!E(i)&&!x(i)){super.onContextMenu(e);return}}}class pt extends we{constructor(e,i,n,o,s,r,l,d){super(e,i,n,o,d);this.focusTrait=s;this.selectionTrait=r;this.anchorTrait=l}createMouseController(e){return new Tt(this,e.tree,e.stickyScrollProvider)}splice(e,i,n=[]){if(super.splice(e,i,n),n.length===0)return;const o=[],s=[];let r;n.forEach((l,d)=>{this.focusTrait.has(l)&&o.push(e+d),this.selectionTrait.has(l)&&s.push(e+d),this.anchorTrait.has(l)&&(r=e+d)}),o.length>0&&super.setFocus(oe([...super.getFocus(),...o])),s.length>0&&super.setSelection(oe([...super.getSelection(),...s])),typeof r=="number"&&super.setAnchor(r)}setFocus(e,i,n=!1){super.setFocus(e,i),n||this.focusTrait.set(e.map(o=>this.element(o)),i)}setSelection(e,i,n=!1){super.setSelection(e,i),n||this.selectionTrait.set(e.map(o=>this.element(o)),i)}setAnchor(e,i=!1){super.setAnchor(e),i||(typeof e>"u"?this.anchorTrait.set([]):this.anchorTrait.set([this.element(e)]))}}var gt=(e=>(e[e.Tree=0]="Tree",e[e.StickyScroll=1]="StickyScroll",e))(gt||{});class Mi{constructor(t,e,i,n,o={}){this._user=t;this._options=o;o.keyboardNavigationLabelProvider&&(this.findFilter=new Je(this,o.keyboardNavigationLabelProvider,o.filter),o={...o,filter:this.findFilter},this.disposables.add(this.findFilter)),this.model=this.createModel(t,o),this.treeDelegate=new Ye(i);const s=this.disposables.add(new je(this.onDidChangeActiveNodesRelay.event)),r=new He;this.renderers=n.map(l=>new B(l,this.model,this.onDidChangeCollapseStateRelay.event,s,r,o));for(const l of this.renderers)this.disposables.add(l);if(this.focus=new X(()=>this.view.getFocusedElements()[0],o.identityProvider),this.selection=new X(()=>this.view.getSelectedElements()[0],o.identityProvider),this.anchor=new X(()=>this.view.getAnchorElement(),o.identityProvider),this.view=new pt(t,e,this.treeDelegate,this.renderers,this.focus,this.selection,this.anchor,{...qe(()=>this.model,o),tree:this,stickyScrollProvider:()=>this.stickyScrollController}),this.setupModel(this.model),o.keyboardSupport!==!1){const l=u.chain(this.view.onKeyDown,d=>d.filter(h=>!ee(h.target)).map(h=>new G(h)));u.chain(l,d=>d.filter(h=>h.keyCode===m.LeftArrow))(this.onLeftArrow,this,this.disposables),u.chain(l,d=>d.filter(h=>h.keyCode===m.RightArrow))(this.onRightArrow,this,this.disposables),u.chain(l,d=>d.filter(h=>h.keyCode===m.Space))(this.onSpace,this,this.disposables)}if((o.findWidgetEnabled??!0)&&o.keyboardNavigationLabelProvider&&o.contextViewProvider){const l={styles:o.findWidgetStyles,defaultFindMode:o.defaultFindMode,defaultFindMatchType:o.defaultFindMatchType,showNotFoundMessage:o.showNotFoundMessage};this.findController=this.disposables.add(new rt(this,this.findFilter,o.contextViewProvider,l)),this.focusNavigationFilter=d=>this.findController.shouldAllowFocus(d),this.onDidChangeFindOpenState=this.findController.onDidChangeOpenState,this.onDidChangeFindMode=this.findController.onDidChangeMode,this.onDidChangeFindMatchType=this.findController.onDidChangeMatchType}else this.onDidChangeFindMode=u.None,this.onDidChangeFindMatchType=u.None;o.enableStickyScroll&&(this.stickyScrollController=new le(this,this.model,this.view,this.renderers,this.treeDelegate,o),this.onDidChangeStickyScrollFocused=this.stickyScrollController.onDidChangeHasFocus),this.styleElement=fe(this.view.getHTMLElement()),this.getHTMLElement().classList.toggle("always",this._options.renderIndentGuides==="always")}view;renderers;model;treeDelegate;focus;selection;anchor;eventBufferer=new Ve;findController;findFilter;onDidChangeFindOpenState=u.None;onDidChangeStickyScrollFocused=u.None;focusNavigationFilter;stickyScrollController;styleElement;disposables=new v;get onDidScroll(){return this.view.onDidScroll}get onDidChangeFocus(){return this.eventBufferer.wrapEvent(this.focus.onDidChange)}get onDidChangeSelection(){return this.eventBufferer.wrapEvent(this.selection.onDidChange)}get onMouseClick(){return u.map(this.view.onMouseClick,w)}get onMouseDblClick(){return u.filter(u.map(this.view.onMouseDblClick,w),t=>t.target!==M.Filter)}get onMouseOver(){return u.map(this.view.onMouseOver,w)}get onMouseOut(){return u.map(this.view.onMouseOut,w)}get onContextMenu(){return u.any(u.filter(u.map(this.view.onContextMenu,ut),t=>!t.isStickyScroll),this.stickyScrollController?.onContextMenu??u.None)}get onTap(){return u.map(this.view.onTap,w)}get onPointer(){return u.map(this.view.onPointer,w)}get onKeyDown(){return this.view.onKeyDown}get onKeyUp(){return this.view.onKeyUp}get onKeyPress(){return this.view.onKeyPress}get onDidFocus(){return this.view.onDidFocus}get onDidBlur(){return this.view.onDidBlur}onDidSwapModel=this.disposables.add(new f);onDidChangeModelRelay=this.disposables.add(new L);onDidSpliceModelRelay=this.disposables.add(new L);onDidChangeCollapseStateRelay=this.disposables.add(new L);onDidChangeRenderNodeCountRelay=this.disposables.add(new L);onDidChangeActiveNodesRelay=this.disposables.add(new L);get onDidChangeModel(){return u.any(this.onDidChangeModelRelay.event,this.onDidSwapModel.event)}get onDidChangeCollapseState(){return this.onDidChangeCollapseStateRelay.event}get onDidChangeRenderNodeCount(){return this.onDidChangeRenderNodeCountRelay.event}_onWillRefilter=new f;onWillRefilter=this._onWillRefilter.event;get findMode(){return this.findController?.mode??0}set findMode(t){this.findController&&(this.findController.mode=t)}onDidChangeFindMode;get findMatchType(){return this.findController?.matchType??0}set findMatchType(t){this.findController&&(this.findController.matchType=t)}onDidChangeFindMatchType;get onDidChangeFindPattern(){return this.findController?this.findController.onDidChangePattern:u.None}get expandOnDoubleClick(){return typeof this._options.expandOnDoubleClick>"u"?!0:this._options.expandOnDoubleClick}get expandOnlyOnTwistieClick(){return typeof this._options.expandOnlyOnTwistieClick>"u"?!0:this._options.expandOnlyOnTwistieClick}_onDidUpdateOptions=new f;onDidUpdateOptions=this._onDidUpdateOptions.event;get onDidDispose(){return this.view.onDidDispose}updateOptions(t={}){this._options={...this._options,...t};for(const e of this.renderers)e.updateOptions(t);this.view.updateOptions(this._options),this.findController?.updateOptions(t),this.updateStickyScroll(t),this._onDidUpdateOptions.fire(this._options),this.getHTMLElement().classList.toggle("always",this._options.renderIndentGuides==="always")}get options(){return this._options}updateStickyScroll(t){!this.stickyScrollController&&this._options.enableStickyScroll?(this.stickyScrollController=new le(this,this.model,this.view,this.renderers,this.treeDelegate,this._options),this.onDidChangeStickyScrollFocused=this.stickyScrollController.onDidChangeHasFocus):this.stickyScrollController&&!this._options.enableStickyScroll&&(this.onDidChangeStickyScrollFocused=u.None,this.stickyScrollController.dispose(),this.stickyScrollController=void 0),this.stickyScrollController?.updateOptions(t)}updateWidth(t){const e=this.model.getListIndex(t);e!==-1&&this.view.updateWidth(e)}getHTMLElement(){return this.view.getHTMLElement()}get contentHeight(){return this.view.contentHeight}get contentWidth(){return this.view.contentWidth}get onDidChangeContentHeight(){return this.view.onDidChangeContentHeight}get onDidChangeContentWidth(){return this.view.onDidChangeContentWidth}get scrollTop(){return this.view.scrollTop}set scrollTop(t){this.view.scrollTop=t}get scrollLeft(){return this.view.scrollLeft}set scrollLeft(t){this.view.scrollLeft=t}get scrollHeight(){return this.view.scrollHeight}get renderHeight(){return this.view.renderHeight}get firstVisibleElement(){let t=this.view.firstVisibleIndex;return this.stickyScrollController&&(t+=this.stickyScrollController.count),t<0||t>=this.view.length?void 0:this.view.element(t).element}get lastVisibleElement(){const t=this.view.lastVisibleIndex;return this.view.element(t).element}get ariaLabel(){return this.view.ariaLabel}set ariaLabel(t){this.view.ariaLabel=t}get selectionSize(){return this.selection.getNodes().length}domFocus(){this.stickyScrollController?.focusedLast()?this.stickyScrollController.domFocus():this.view.domFocus()}isDOMFocused(){return ve(this.getHTMLElement())}layout(t,e){this.view.layout(t,e),Be(e)&&this.findController?.layout(e)}style(t){const e=`.${this.view.domId}`,i=[];t.treeIndentGuidesStroke&&(i.push(`.monaco-list${e}:hover .monaco-tl-indent > .indent-guide, .monaco-list${e}.always .monaco-tl-indent > .indent-guide  { border-color: ${t.treeInactiveIndentGuidesStroke}; }`),i.push(`.monaco-list${e} .monaco-tl-indent > .indent-guide.active { border-color: ${t.treeIndentGuidesStroke}; }`));const n=t.treeStickyScrollBackground??t.listBackground;n&&(i.push(`.monaco-list${e} .monaco-scrollable-element .monaco-tree-sticky-container { background-color: ${n}; }`),i.push(`.monaco-list${e} .monaco-scrollable-element .monaco-tree-sticky-container .monaco-tree-sticky-row { background-color: ${n}; }`)),t.treeStickyScrollBorder&&i.push(`.monaco-list${e} .monaco-scrollable-element .monaco-tree-sticky-container { border-bottom: 1px solid ${t.treeStickyScrollBorder}; }`),t.treeStickyScrollShadow&&i.push(`.monaco-list${e} .monaco-scrollable-element .monaco-tree-sticky-container .monaco-tree-sticky-container-shadow { box-shadow: ${t.treeStickyScrollShadow} 0 6px 6px -6px inset; height: 3px; }`),t.listFocusForeground&&(i.push(`.monaco-list${e}.sticky-scroll-focused .monaco-scrollable-element .monaco-tree-sticky-container:focus .monaco-list-row.focused { color: ${t.listFocusForeground}; }`),i.push(`.monaco-list${e}:not(.sticky-scroll-focused) .monaco-scrollable-element .monaco-tree-sticky-container .monaco-list-row.focused { color: inherit; }`));const o=Q(t.listFocusAndSelectionOutline,Q(t.listSelectionOutline,t.listFocusOutline??""));o&&(i.push(`.monaco-list${e}.sticky-scroll-focused .monaco-scrollable-element .monaco-tree-sticky-container:focus .monaco-list-row.focused.selected { outline: 1px solid ${o}; outline-offset: -1px;}`),i.push(`.monaco-list${e}:not(.sticky-scroll-focused) .monaco-scrollable-element .monaco-tree-sticky-container .monaco-list-row.focused.selected { outline: inherit;}`)),t.listFocusOutline&&(i.push(`.monaco-list${e}.sticky-scroll-focused .monaco-scrollable-element .monaco-tree-sticky-container:focus .monaco-list-row.focused { outline: 1px solid ${t.listFocusOutline}; outline-offset: -1px; }`),i.push(`.monaco-list${e}:not(.sticky-scroll-focused) .monaco-scrollable-element .monaco-tree-sticky-container .monaco-list-row.focused { outline: inherit; }`),i.push(`.monaco-workbench.context-menu-visible .monaco-list${e}.last-focused.sticky-scroll-focused .monaco-scrollable-element .monaco-tree-sticky-container .monaco-list-row.passive-focused { outline: 1px solid ${t.listFocusOutline}; outline-offset: -1px; }`),i.push(`.monaco-workbench.context-menu-visible .monaco-list${e}.last-focused.sticky-scroll-focused .monaco-list-rows .monaco-list-row.focused { outline: inherit; }`),i.push(`.monaco-workbench.context-menu-visible .monaco-list${e}.last-focused:not(.sticky-scroll-focused) .monaco-tree-sticky-container .monaco-list-rows .monaco-list-row.focused { outline: inherit; }`)),this.styleElement.textContent=i.join(`
`),this.view.style(t)}getParentElement(t){const e=this.model.getParentNodeLocation(t);return this.model.getNode(e).element}getFirstElementChild(t){return this.model.getFirstElementChild(t)}getNode(t){return this.model.getNode(t)}getNodeLocation(t){return this.model.getNodeLocation(t)}collapse(t,e=!1){return this.model.setCollapsed(t,!0,e)}expand(t,e=!1){return this.model.setCollapsed(t,!1,e)}toggleCollapsed(t,e=!1){return this.model.setCollapsed(t,void 0,e)}expandAll(){this.model.setCollapsed(this.model.rootRef,!1,!0)}collapseAll(){this.model.setCollapsed(this.model.rootRef,!0,!0)}isCollapsible(t){return this.model.isCollapsible(t)}setCollapsible(t,e){return this.model.setCollapsible(t,e)}isCollapsed(t){return this.model.isCollapsed(t)}expandTo(t){this.model.expandTo(t)}triggerTypeNavigation(){this.view.triggerTypeNavigation()}openFind(){this.findController?.open()}closeFind(){this.findController?.close()}refilter(){this._onWillRefilter.fire(void 0),this.model.refilter()}setAnchor(t){if(typeof t>"u")return this.view.setAnchor(void 0);this.eventBufferer.bufferEvents(()=>{const e=this.model.getNode(t);this.anchor.set([e]);const i=this.model.getListIndex(t);i>-1&&this.view.setAnchor(i,!0)})}getAnchor(){return this.anchor.get().at(0)}setSelection(t,e){this.eventBufferer.bufferEvents(()=>{const i=t.map(o=>this.model.getNode(o));this.selection.set(i,e);const n=t.map(o=>this.model.getListIndex(o)).filter(o=>o>-1);this.view.setSelection(n,e,!0)})}getSelection(){return this.selection.get()}setFocus(t,e){this.eventBufferer.bufferEvents(()=>{const i=t.map(o=>this.model.getNode(o));this.focus.set(i,e);const n=t.map(o=>this.model.getListIndex(o)).filter(o=>o>-1);this.view.setFocus(n,e,!0)})}focusNext(t=1,e=!1,i,n=S(i)&&i.altKey?void 0:this.focusNavigationFilter){this.view.focusNext(t,e,i,n)}focusPrevious(t=1,e=!1,i,n=S(i)&&i.altKey?void 0:this.focusNavigationFilter){this.view.focusPrevious(t,e,i,n)}focusNextPage(t,e=S(t)&&t.altKey?void 0:this.focusNavigationFilter){return this.view.focusNextPage(t,e)}focusPreviousPage(t,e=S(t)&&t.altKey?void 0:this.focusNavigationFilter){return this.view.focusPreviousPage(t,e,()=>this.stickyScrollController?.height??0)}focusLast(t,e=S(t)&&t.altKey?void 0:this.focusNavigationFilter){this.view.focusLast(t,e)}focusFirst(t,e=S(t)&&t.altKey?void 0:this.focusNavigationFilter){this.view.focusFirst(t,e)}getFocus(){return this.focus.get()}getStickyScrollFocus(){const t=this.stickyScrollController?.getFocus();return t!==void 0?[t]:[]}getFocusedPart(){return this.stickyScrollController?.focusedLast()?1:0}reveal(t,e){this.model.expandTo(t);const i=this.model.getListIndex(t);if(i!==-1)if(!this.stickyScrollController)this.view.reveal(i,e);else{const n=this.stickyScrollController.nodePositionTopBelowWidget(this.getNode(t));this.view.reveal(i,e,n)}}getRelativeTop(t){const e=this.model.getListIndex(t);if(e===-1)return null;const i=this.stickyScrollController?.getNode(this.getNode(t));return this.view.getRelativeTop(e,i?.position??this.stickyScrollController?.height)}getViewState(t=this.options.identityProvider){if(!t)throw new Le(this._user,"Can't get tree view state without an identity provider");const e=s=>t.getId(s).toString(),i=P.empty(this.scrollTop);for(const s of this.getFocus())i.focus.add(e(s));for(const s of this.getSelection())i.selection.add(e(s));const n=this.model.getNode(),o=[n];for(;o.length>0;){const s=o.shift();s!==n&&s.collapsible&&(i.expanded[e(s.element)]=s.collapsed?0:1),o.push(...s.children)}return i}onLeftArrow(t){t.preventDefault(),t.stopPropagation();const e=this.view.getFocusedElements();if(e.length===0)return;const i=e[0],n=this.model.getNodeLocation(i);if(!this.model.setCollapsed(n,!0)){const s=this.model.getParentNodeLocation(n);if(!s)return;const r=this.model.getListIndex(s);this.view.reveal(r),this.view.setFocus([r])}}onRightArrow(t){t.preventDefault(),t.stopPropagation();const e=this.view.getFocusedElements();if(e.length===0)return;const i=e[0],n=this.model.getNodeLocation(i);if(!this.model.setCollapsed(n,!1)){if(!i.children.some(l=>l.visible))return;const[s]=this.view.getFocus(),r=s+1;this.view.reveal(r),this.view.setFocus([r])}}onSpace(t){t.preventDefault(),t.stopPropagation();const e=this.view.getFocusedElements();if(e.length===0)return;const i=e[0],n=this.model.getNodeLocation(i),o=t.browserEvent.altKey;this.model.setCollapsed(n,void 0,o)}createNewModel(t={}){return this.createModel(this._user,{...this._options,filter:this.findFilter,...t})}modelDisposables=new v;setupModel(t){this.modelDisposables.clear(),this.modelDisposables.add(t.onDidSpliceRenderedNodes(({start:o,deleteCount:s,elements:r})=>this.view.splice(o,s,r)));const e=u.forEach(t.onDidSpliceModel,o=>{this.eventBufferer.bufferEvents(()=>{this.focus.onDidModelSplice(o),this.selection.onDidModelSplice(o)})},this.modelDisposables);e(()=>null,null,this.modelDisposables);const i=this.modelDisposables.add(new f),n=this.modelDisposables.add(new Ae(0));this.modelDisposables.add(u.any(e,this.focus.onDidChange,this.selection.onDidChange)(()=>{n.trigger(()=>{const o=new Set;for(const s of this.focus.getNodes())o.add(s);for(const s of this.selection.getNodes())o.add(s);i.fire([...o.values()])})})),this.onDidChangeActiveNodesRelay.input=i.event,this.onDidChangeModelRelay.input=u.signal(t.onDidSpliceModel),this.onDidChangeCollapseStateRelay.input=t.onDidChangeCollapseState,this.onDidChangeRenderNodeCountRelay.input=t.onDidChangeRenderNodeCount,this.onDidSpliceModelRelay.input=t.onDidSpliceModel}setModel(t){const e=this.model;this.model=t,this.setupModel(t),this.renderers.forEach(i=>i.setModel(t)),this.stickyScrollController?.setModel(t),this.focus.set([]),this.selection.set([]),this.anchor.set([]),this.view.splice(0,e.getListRenderCount(e.rootRef)),t.refilter(),this.onDidSwapModel.fire()}getModel(){return this.model}navigate(t){return new ft(this.view,this.model,t)}dispose(){U(this.disposables),this.stickyScrollController?.dispose(),this.view.dispose(),this.modelDisposables.dispose()}}class ft{constructor(t,e,i){this.view=t;this.model=e;i?this.index=this.model.getListIndex(i):this.index=-1}index;current(){return this.index<0||this.index>=this.view.length?null:this.view.element(this.index).element}previous(){return this.index--,this.current()}next(){return this.index++,this.current()}first(){return this.index=0,this.current()}last(){return this.index=this.view.length-1,this.current()}}export{st as AbstractFindController,Mi as AbstractTree,gt as AbstractTreePart,P as AbstractTreeViewState,Ye as ComposedTreeDelegate,Ze as FindToggles,Xe as RenderIndentGuides,it as TreeFindMatchType,tt as TreeFindMode,B as TreeRenderer};
