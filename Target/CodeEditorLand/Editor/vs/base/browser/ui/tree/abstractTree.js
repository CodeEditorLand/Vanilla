import"../../../../../vs/base/browser/dnd.js";import{$ as I,addDisposableListener as j,append as P,asCssValueWithDefault as J,clearNode as ve,createStyleSheet as me,getWindow as Q,h as R,hasParentWithClass as z,isActiveElement as ye,isKeyboardEvent as F}from"../../../../../vs/base/browser/dom.js";import{DomEmitter as N}from"../../../../../vs/base/browser/event.js";import{StandardKeyboardEvent as $}from"../../../../../vs/base/browser/keyboardEvent.js";import{ActionBar as be}from"../../../../../vs/base/browser/ui/actionbar/actionbar.js";import"../../../../../vs/base/browser/ui/contextview/contextview.js";import{FindInput as De}from"../../../../../vs/base/browser/ui/findinput/findInput.js";import{MessageType as Z,unthemedInboxStyles as Se}from"../../../../../vs/base/browser/ui/inputbox/inputBox.js";import"../../../../../vs/base/browser/ui/list/list.js";import{ElementsDragAndDropData as ee}from"../../../../../vs/base/browser/ui/list/listView.js";import{isActionItem as Ie,isButton as Fe,isInputElement as te,isMonacoCustomToggle as we,isMonacoEditor as Ce,isStickyScrollContainer as E,isStickyScrollElement as x,List as Ne,MouseController as Ee}from"../../../../../vs/base/browser/ui/list/listWidget.js";import{Toggle as ie,unthemedToggleStyles as xe}from"../../../../../vs/base/browser/ui/toggle/toggle.js";import{getVisibleState as ke,isFilterResult as Me}from"../../../../../vs/base/browser/ui/tree/indexTreeModel.js";import{TreeDragOverBubble as Le,TreeError as _e,TreeMouseEventTarget as k,TreeVisibility as M}from"../../../../../vs/base/browser/ui/tree/tree.js";import{Action as Ae}from"../../../../../vs/base/common/actions.js";import{distinct as oe,equals as G,firstOrDefault as Pe,range as Re}from"../../../../../vs/base/common/arrays.js";import{Delayer as Oe,disposableTimeout as He,timeout as Ve}from"../../../../../vs/base/common/async.js";import{Codicon as O}from"../../../../../vs/base/common/codicons.js";import{Emitter as v,Event as h,EventBufferer as Be,Relay as ne}from"../../../../../vs/base/common/event.js";import{fuzzyScore as We,FuzzyScore as L}from"../../../../../vs/base/common/filters.js";import{KeyCode as m}from"../../../../../vs/base/common/keyCodes.js";import{Disposable as w,DisposableStore as y,dispose as K,toDisposable as U}from"../../../../../vs/base/common/lifecycle.js";import{SetMap as ze}from"../../../../../vs/base/common/map.js";import{clamp as H}from"../../../../../vs/base/common/numbers.js";import"../../../../../vs/base/common/scrollable.js";import"../../../../../vs/base/common/sequence.js";import{ThemeIcon as se}from"../../../../../vs/base/common/themables.js";import{isNumber as $e}from"../../../../../vs/base/common/types.js";import"vs/css!./media/tree";import{alert as re}from"../../../../../vs/base/browser/ui/aria/aria.js";import"../../../../../vs/base/browser/ui/hover/hoverDelegate.js";import{createInstantHoverDelegate as Ge,getDefaultHoverDelegate as le}from"../../../../../vs/base/browser/ui/hover/hoverDelegateFactory.js";import{autorun as Ke,constObservable as Ue}from"../../../../../vs/base/common/observable.js";import{localize as b}from"../../../../../vs/nls.js";class qe extends ee{constructor(e){super(e.elements.map(i=>i.element));this.data=e}set context(e){this.data.context=e}get context(){return this.data.context}}function q(a){return a instanceof ee?new qe(a):a}class Ye{constructor(t,e){this.modelProvider=t;this.dnd=e}autoExpandNode;autoExpandDisposable=w.None;disposables=new y;getDragURI(t){return this.dnd.getDragURI(t.element)}getDragLabel(t,e){if(this.dnd.getDragLabel)return this.dnd.getDragLabel(t.map(i=>i.element),e)}onDragStart(t,e){this.dnd.onDragStart?.(q(t),e)}onDragOver(t,e,i,o,n,s=!0){const r=this.dnd.onDragOver(q(t),e&&e.element,i,o,n),l=this.autoExpandNode!==e;if(l&&(this.autoExpandDisposable.dispose(),this.autoExpandNode=e),typeof e>"u")return r;if(l&&typeof r!="boolean"&&r.autoExpand&&(this.autoExpandDisposable=He(()=>{const f=this.modelProvider(),p=f.getNodeLocation(e);f.isCollapsed(p)&&f.setCollapsed(p,!1),this.autoExpandNode=void 0},500,this.disposables)),typeof r=="boolean"||!r.accept||typeof r.bubble>"u"||r.feedback){if(!s){const f=typeof r=="boolean"?r:r.accept,p=typeof r=="boolean"?void 0:r.effect;return{accept:f,effect:p,feedback:[i]}}return r}if(r.bubble===Le.Up){const f=this.modelProvider(),p=f.getNodeLocation(e),d=f.getParentNodeLocation(p),T=f.getNode(d),S=d&&f.getListIndex(d);return this.onDragOver(t,T,S,o,n,!1)}const c=this.modelProvider(),u=c.getNodeLocation(e),g=c.getListIndex(u),D=c.getListRenderCount(u);return{...r,feedback:Re(g,g+D)}}drop(t,e,i,o,n){this.autoExpandDisposable.dispose(),this.autoExpandNode=void 0,this.dnd.drop(q(t),e&&e.element,i,o,n)}onDragEnd(t){this.dnd.onDragEnd?.(t)}dispose(){this.disposables.dispose(),this.dnd.dispose()}}function Xe(a,t){return t&&{...t,identityProvider:t.identityProvider&&{getId(e){return t.identityProvider.getId(e.element)}},dnd:t.dnd&&new Ye(a,t.dnd),multipleSelectionController:t.multipleSelectionController&&{isSelectionSingleChangeEvent(e){return t.multipleSelectionController.isSelectionSingleChangeEvent({...e,element:e.element})},isSelectionRangeChangeEvent(e){return t.multipleSelectionController.isSelectionRangeChangeEvent({...e,element:e.element})}},accessibilityProvider:t.accessibilityProvider&&{...t.accessibilityProvider,getSetSize(e){const i=a(),o=i.getNodeLocation(e),n=i.getParentNodeLocation(o);return i.getNode(n).visibleChildrenCount},getPosInSet(e){return e.visibleChildIndex+1},isChecked:t.accessibilityProvider&&t.accessibilityProvider.isChecked?e=>t.accessibilityProvider.isChecked(e.element):void 0,getRole:t.accessibilityProvider&&t.accessibilityProvider.getRole?e=>t.accessibilityProvider.getRole(e.element):()=>"treeitem",getAriaLabel(e){return t.accessibilityProvider.getAriaLabel(e.element)},getWidgetAriaLabel(){return t.accessibilityProvider.getWidgetAriaLabel()},getWidgetRole:t.accessibilityProvider&&t.accessibilityProvider.getWidgetRole?()=>t.accessibilityProvider.getWidgetRole():()=>"tree",getAriaLevel:t.accessibilityProvider&&t.accessibilityProvider.getAriaLevel?e=>t.accessibilityProvider.getAriaLevel(e.element):e=>e.depth,getActiveDescendantId:t.accessibilityProvider.getActiveDescendantId&&(e=>t.accessibilityProvider.getActiveDescendantId(e.element))},keyboardNavigationLabelProvider:t.keyboardNavigationLabelProvider&&{...t.keyboardNavigationLabelProvider,getKeyboardNavigationLabel(e){return t.keyboardNavigationLabelProvider.getKeyboardNavigationLabel(e.element)}}}}class je{constructor(t){this.delegate=t}getHeight(t){return this.delegate.getHeight(t.element)}getTemplateId(t){return this.delegate.getTemplateId(t.element)}hasDynamicHeight(t){return!!this.delegate.hasDynamicHeight&&this.delegate.hasDynamicHeight(t.element)}setDynamicHeight(t,e){this.delegate.setDynamicHeight?.(t.element,e)}}class _{focus;selection;expanded;scrollTop;static lift(t){return t instanceof _?t:new _(t)}static empty(t=0){return new _({focus:[],selection:[],expanded:Object.create(null),scrollTop:t})}constructor(t){if(this.focus=new Set(t.focus),this.selection=new Set(t.selection),t.expanded instanceof Array){this.expanded=Object.create(null);for(const e of t.expanded)this.expanded[e]=1}else this.expanded=t.expanded;this.expanded=t.expanded,this.scrollTop=t.scrollTop}toJSON(){return{focus:Array.from(this.focus),selection:Array.from(this.selection),expanded:this.expanded,scrollTop:this.scrollTop}}}var Je=(i=>(i.None="none",i.OnHover="onHover",i.Always="always",i))(Je||{});class Qe{constructor(t,e=[]){this._elements=e;this.onDidChange=h.forEach(t,i=>this._elements=i,this.disposables)}disposables=new y;onDidChange;get elements(){return this._elements}dispose(){this.disposables.dispose()}}class B{constructor(t,e,i,o,n,s={}){this.renderer=t;this.modelProvider=e;this.activeNodes=o;this.renderedIndentGuides=n;this.templateId=t.templateId,this.updateOptions(s),h.map(i,r=>r.node)(this.onDidChangeNodeTwistieState,this,this.disposables),t.onDidChangeTwistieState?.(this.onDidChangeTwistieState,this,this.disposables)}static DefaultIndent=8;templateId;renderedElements=new Map;renderedNodes=new Map;indent=B.DefaultIndent;hideTwistiesOfChildlessElements=!1;shouldRenderIndentGuides=!1;activeIndentNodes=new Set;indentGuidesDisposable=w.None;disposables=new y;updateOptions(t={}){if(typeof t.indent<"u"){const e=H(t.indent,0,40);if(e!==this.indent){this.indent=e;for(const[i,o]of this.renderedNodes)this.renderTreeElement(i,o)}}if(typeof t.renderIndentGuides<"u"){const e=t.renderIndentGuides!=="none";if(e!==this.shouldRenderIndentGuides){this.shouldRenderIndentGuides=e;for(const[i,o]of this.renderedNodes)this._renderIndentGuides(i,o);if(this.indentGuidesDisposable.dispose(),e){const i=new y;this.activeNodes.onDidChange(this._onDidChangeActiveNodes,this,i),this.indentGuidesDisposable=i,this._onDidChangeActiveNodes(this.activeNodes.elements)}}}typeof t.hideTwistiesOfChildlessElements<"u"&&(this.hideTwistiesOfChildlessElements=t.hideTwistiesOfChildlessElements)}renderTemplate(t){const e=P(t,I(".monaco-tl-row")),i=P(e,I(".monaco-tl-indent")),o=P(e,I(".monaco-tl-twistie")),n=P(e,I(".monaco-tl-contents")),s=this.renderer.renderTemplate(n);return{container:t,indent:i,twistie:o,indentGuidesDisposable:w.None,templateData:s}}renderElement(t,e,i,o){this.renderedNodes.set(t,i),this.renderedElements.set(t.element,t),this.renderTreeElement(t,i),this.renderer.renderElement(t,e,i.templateData,o)}disposeElement(t,e,i,o){i.indentGuidesDisposable.dispose(),this.renderer.disposeElement?.(t,e,i.templateData,o),typeof o=="number"&&(this.renderedNodes.delete(t),this.renderedElements.delete(t.element))}disposeTemplate(t){this.renderer.disposeTemplate(t.templateData)}onDidChangeTwistieState(t){const e=this.renderedElements.get(t);e&&this.onDidChangeNodeTwistieState(e)}onDidChangeNodeTwistieState(t){const e=this.renderedNodes.get(t);e&&(this._onDidChangeActiveNodes(this.activeNodes.elements),this.renderTreeElement(t,e))}renderTreeElement(t,e){const i=B.DefaultIndent+(t.depth-1)*this.indent;e.twistie.style.paddingLeft=`${i}px`,e.indent.style.width=`${i+this.indent-16}px`,t.collapsible?e.container.setAttribute("aria-expanded",String(!t.collapsed)):e.container.removeAttribute("aria-expanded"),e.twistie.classList.remove(...se.asClassNameArray(O.treeItemExpanded));let o=!1;this.renderer.renderTwistie&&(o=this.renderer.renderTwistie(t.element,e.twistie)),t.collapsible&&(!this.hideTwistiesOfChildlessElements||t.visibleChildrenCount>0)?(o||e.twistie.classList.add(...se.asClassNameArray(O.treeItemExpanded)),e.twistie.classList.add("collapsible"),e.twistie.classList.toggle("collapsed",t.collapsed)):e.twistie.classList.remove("collapsible","collapsed"),this._renderIndentGuides(t,e)}_renderIndentGuides(t,e){if(ve(e.indent),e.indentGuidesDisposable.dispose(),!this.shouldRenderIndentGuides)return;const i=new y,o=this.modelProvider();for(;;){const n=o.getNodeLocation(t),s=o.getParentNodeLocation(n);if(!s)break;const r=o.getNode(s),l=I(".indent-guide",{style:`width: ${this.indent}px`});this.activeIndentNodes.has(r)&&l.classList.add("active"),e.indent.childElementCount===0?e.indent.appendChild(l):e.indent.insertBefore(l,e.indent.firstElementChild),this.renderedIndentGuides.add(r,l),i.add(U(()=>this.renderedIndentGuides.delete(r,l))),t=r}e.indentGuidesDisposable=i}_onDidChangeActiveNodes(t){if(!this.shouldRenderIndentGuides)return;const e=new Set,i=this.modelProvider();t.forEach(o=>{const n=i.getNodeLocation(o);try{const s=i.getParentNodeLocation(n);o.collapsible&&o.children.length>0&&!o.collapsed?e.add(o):s&&e.add(i.getNode(s))}catch{}}),this.activeIndentNodes.forEach(o=>{e.has(o)||this.renderedIndentGuides.forEach(o,n=>n.classList.remove("active"))}),e.forEach(o=>{this.activeIndentNodes.has(o)||this.renderedIndentGuides.forEach(o,n=>n.classList.add("active"))}),this.activeIndentNodes=e}dispose(){this.renderedNodes.clear(),this.renderedElements.clear(),this.indentGuidesDisposable.dispose(),K(this.disposables)}}class Ze{constructor(t,e,i){this.tree=t;this.keyboardNavigationLabelProvider=e;this._filter=i;t.onWillRefilter(this.reset,this,this.disposables)}_totalCount=0;get totalCount(){return this._totalCount}_matchCount=0;get matchCount(){return this._matchCount}_pattern="";_lowercasePattern="";disposables=new y;set pattern(t){this._pattern=t,this._lowercasePattern=t.toLowerCase()}filter(t,e){let i=M.Visible;if(this._filter){const s=this._filter.filter(t,e);if(typeof s=="boolean"?i=s?M.Visible:M.Hidden:Me(s)?i=ke(s.visibility):i=s,i===M.Hidden)return!1}if(this._totalCount++,!this._pattern)return this._matchCount++,{data:L.Default,visibility:i};const o=this.keyboardNavigationLabelProvider.getKeyboardNavigationLabel(t),n=Array.isArray(o)?o:[o];for(const s of n){const r=s&&s.toString();if(typeof r>"u")return{data:L.Default,visibility:i};let l;if(this.tree.findMatchType===1){const c=r.toLowerCase().indexOf(this._lowercasePattern);if(c>-1){l=[Number.MAX_SAFE_INTEGER,0];for(let u=this._lowercasePattern.length;u>0;u--)l.push(c+u-1)}}else l=We(this._pattern,this._lowercasePattern,0,r,r.toLowerCase(),0,{firstMatchCanBeWeak:!0,boostFullMatch:!0});if(l)return this._matchCount++,n.length===1?{data:l,visibility:i}:{data:{label:r,score:l},visibility:i}}return this.tree.findMode===1?typeof this.tree.options.defaultFindVisibility=="number"?this.tree.options.defaultFindVisibility:this.tree.options.defaultFindVisibility?this.tree.options.defaultFindVisibility(t):M.Recurse:{data:L.Default,visibility:i}}reset(){this._totalCount=0,this._matchCount=0}dispose(){K(this.disposables)}}class et extends ie{constructor(t){super({icon:O.listFilter,title:b("filter","Filter"),isChecked:t.isChecked??!1,hoverDelegate:t.hoverDelegate??le("element"),inputActiveOptionBorder:t.inputActiveOptionBorder,inputActiveOptionForeground:t.inputActiveOptionForeground,inputActiveOptionBackground:t.inputActiveOptionBackground})}}class tt extends ie{constructor(t){super({icon:O.searchFuzzy,title:b("fuzzySearch","Fuzzy Match"),isChecked:t.isChecked??!1,hoverDelegate:t.hoverDelegate??le("element"),inputActiveOptionBorder:t.inputActiveOptionBorder,inputActiveOptionForeground:t.inputActiveOptionForeground,inputActiveOptionBackground:t.inputActiveOptionBackground})}}const it={inputBoxStyles:Se,toggleStyles:xe,listFilterWidgetBackground:void 0,listFilterWidgetNoMatchesOutline:void 0,listFilterWidgetOutline:void 0,listFilterWidgetShadow:void 0};var ot=(e=>(e[e.Highlight=0]="Highlight",e[e.Filter=1]="Filter",e))(ot||{}),nt=(e=>(e[e.Fuzzy=0]="Fuzzy",e[e.Contiguous=1]="Contiguous",e))(nt||{});class st extends w{constructor(e,i,o,n,s,r){super();this.tree=i;e.appendChild(this.elements.root),this._register(U(()=>this.elements.root.remove()));const l=r?.styles??it;l.listFilterWidgetBackground&&(this.elements.root.style.backgroundColor=l.listFilterWidgetBackground),l.listFilterWidgetShadow&&(this.elements.root.style.boxShadow=`0 0 8px 2px ${l.listFilterWidgetShadow}`);const c=this._register(Ge());this.modeToggle=this._register(new et({...l.toggleStyles,isChecked:n===1,hoverDelegate:c})),this.matchTypeToggle=this._register(new tt({...l.toggleStyles,isChecked:s===0,hoverDelegate:c})),this.onDidChangeMode=h.map(this.modeToggle.onChange,()=>this.modeToggle.checked?1:0,this._store),this.onDidChangeMatchType=h.map(this.matchTypeToggle.onChange,()=>this.matchTypeToggle.checked?0:1,this._store),this.findInput=this._register(new De(this.elements.findInput,o,{label:b("type to search","Type to search"),additionalToggles:[this.modeToggle,this.matchTypeToggle],showCommonFindToggles:!1,inputBoxStyles:l.inputBoxStyles,toggleStyles:l.toggleStyles,history:r?.history})),this.actionbar=this._register(new be(this.elements.actionbar)),this.mode=n;const u=this._register(new N(this.findInput.inputBox.inputElement,"keydown")),g=h.chain(u.event,d=>d.map(T=>new $(T)));this._register(g(d=>{if(d.equals(m.Enter)){d.preventDefault(),d.stopPropagation(),this.findInput.inputBox.addToHistory(),this.tree.domFocus();return}if(d.equals(m.DownArrow)){d.preventDefault(),d.stopPropagation(),this.findInput.inputBox.isAtLastInHistory()||this.findInput.inputBox.isNowhereInHistory()?(this.findInput.inputBox.addToHistory(),this.tree.domFocus()):this.findInput.inputBox.showNextValue();return}if(d.equals(m.UpArrow)){d.preventDefault(),d.stopPropagation(),this.findInput.inputBox.showPreviousValue();return}}));const D=this._register(new Ae("close",b("close","Close"),"codicon codicon-close",!0,()=>this.dispose()));this.actionbar.push(D,{icon:!0,label:!1});const f=this._register(new N(this.elements.grab,"mousedown"));this._register(f.event(d=>{const T=new y,S=T.add(new N(Q(d),"mousemove")),W=T.add(new N(Q(d),"mouseup")),ce=this.right,he=d.pageX,ue=this.top,Te=d.pageY;this.elements.grab.classList.add("grabbing");const pe=this.elements.root.style.transition;this.elements.root.style.transition="unset";const X=A=>{const ge=A.pageX-he;this.right=ce-ge;const fe=A.pageY-Te;this.top=ue+fe,this.layout()};T.add(S.event(X)),T.add(W.event(A=>{X(A),this.elements.grab.classList.remove("grabbing"),this.elements.root.style.transition=pe,T.dispose()}))}));const p=h.chain(this._register(new N(this.elements.grab,"keydown")).event,d=>d.map(T=>new $(T)));this._register(p(d=>{let T,S;if(d.keyCode===m.LeftArrow?T=Number.POSITIVE_INFINITY:d.keyCode===m.RightArrow?T=0:d.keyCode===m.Space&&(T=this.right===0?Number.POSITIVE_INFINITY:0),d.keyCode===m.UpArrow?S=0:d.keyCode===m.DownArrow&&(S=Number.POSITIVE_INFINITY),T!==void 0&&(d.preventDefault(),d.stopPropagation(),this.right=T,this.layout()),S!==void 0){d.preventDefault(),d.stopPropagation(),this.top=S;const W=this.elements.root.style.transition;this.elements.root.style.transition="unset",this.layout(),setTimeout(()=>{this.elements.root.style.transition=W},0)}})),this.onDidChangeValue=this.findInput.onDidChange}elements=R(".monaco-tree-type-filter",[R(".monaco-tree-type-filter-grab.codicon.codicon-debug-gripper@grab",{tabIndex:0}),R(".monaco-tree-type-filter-input@findInput"),R(".monaco-tree-type-filter-actionbar@actionbar")]);set mode(e){this.modeToggle.checked=e===1,this.findInput.inputBox.setPlaceHolder(e===1?b("type to filter","Type to filter"):b("type to search","Type to search"))}set matchType(e){this.matchTypeToggle.checked=e===0}get value(){return this.findInput.inputBox.value}set value(e){this.findInput.inputBox.value=e}modeToggle;matchTypeToggle;findInput;actionbar;width=0;right=0;top=0;_onDidDisable=new v;onDidDisable=this._onDidDisable.event;onDidChangeValue;onDidChangeMode;onDidChangeMatchType;getHistory(){return this.findInput.inputBox.getHistory()}focus(){this.findInput.focus()}select(){this.findInput.select(),this.findInput.inputBox.addToHistory(!0)}layout(e=this.width){this.width=e,this.right=H(this.right,0,Math.max(0,e-212)),this.elements.root.style.right=`${this.right}px`,this.top=H(this.top,0,24),this.elements.root.style.top=`${this.top}px`}showMessage(e){this.findInput.showMessage(e)}clearMessage(){this.findInput.clearMessage()}async dispose(){this._onDidDisable.fire(),this.elements.root.classList.add("disabled"),await Ve(300),super.dispose()}}class rt{constructor(t,e,i,o,n,s={}){this.tree=t;this.view=i;this.filter=o;this.contextViewProvider=n;this.options=s;this._mode=t.options.defaultFindMode??0,this._matchType=t.options.defaultFindMatchType??0,e.onDidSplice(this.onDidSpliceModel,this,this.disposables)}_history;_pattern="";get pattern(){return this._pattern}previousPattern="";_mode;get mode(){return this._mode}set mode(t){t!==this._mode&&(this._mode=t,this.widget&&(this.widget.mode=this._mode),this.tree.refilter(),this.render(),this._onDidChangeMode.fire(t))}_matchType;get matchType(){return this._matchType}set matchType(t){t!==this._matchType&&(this._matchType=t,this.widget&&(this.widget.matchType=this._matchType),this.tree.refilter(),this.render(),this._onDidChangeMatchType.fire(t))}widget;width=0;_onDidChangeMode=new v;onDidChangeMode=this._onDidChangeMode.event;_onDidChangeMatchType=new v;onDidChangeMatchType=this._onDidChangeMatchType.event;_onDidChangePattern=new v;onDidChangePattern=this._onDidChangePattern.event;_onDidChangeOpenState=new v;onDidChangeOpenState=this._onDidChangeOpenState.event;enabledDisposables=new y;disposables=new y;updateOptions(t={}){t.defaultFindMode!==void 0&&(this.mode=t.defaultFindMode),t.defaultFindMatchType!==void 0&&(this.matchType=t.defaultFindMatchType)}open(){if(this.widget){this.widget.focus(),this.widget.select();return}this.widget=new st(this.view.getHTMLElement(),this.tree,this.contextViewProvider,this.mode,this.matchType,{...this.options,history:this._history}),this.enabledDisposables.add(this.widget),this.widget.onDidChangeValue(this.onDidChangeValue,this,this.enabledDisposables),this.widget.onDidChangeMode(t=>this.mode=t,void 0,this.enabledDisposables),this.widget.onDidChangeMatchType(t=>this.matchType=t,void 0,this.enabledDisposables),this.widget.onDidDisable(this.close,this,this.enabledDisposables),this.widget.layout(this.width),this.widget.focus(),this.widget.value=this.previousPattern,this.widget.select(),this._onDidChangeOpenState.fire(!0)}close(){this.widget&&(this._history=this.widget.getHistory(),this.widget=void 0,this.enabledDisposables.clear(),this.previousPattern=this.pattern,this.onDidChangeValue(""),this.tree.domFocus(),this._onDidChangeOpenState.fire(!1))}onDidChangeValue(t){this._pattern=t,this._onDidChangePattern.fire(t),this.filter.pattern=t,this.tree.refilter(),t&&this.tree.focusNext(0,!0,void 0,i=>!L.isDefault(i.filterData));const e=this.tree.getFocus();if(e.length>0){const i=e[0];this.tree.getRelativeTop(i)===null&&this.tree.reveal(i,.5)}this.render()}onDidSpliceModel(){!this.widget||this.pattern.length===0||(this.tree.refilter(),this.render())}render(){const t=this.filter.totalCount>0&&this.filter.matchCount===0;this.pattern&&t?(re(b("replFindNoResults","No results")),this.tree.options.showNotFoundMessage??!0?this.widget?.showMessage({type:Z.WARNING,content:b("not found","No elements found.")}):this.widget?.showMessage({type:Z.WARNING})):(this.widget?.clearMessage(),this.pattern&&re(b("replFindResults","{0} results",this.filter.matchCount)))}shouldAllowFocus(t){return!this.widget||!this.pattern||this.filter.totalCount>0&&this.filter.matchCount<=1?!0:!L.isDefault(t.filterData)}layout(t){this.width=t,this.widget?.layout(t)}dispose(){this._history=void 0,this._onDidChangePattern.dispose(),this.enabledDisposables.dispose(),this.disposables.dispose()}}function lt(a,t){return a.position===t.position&&ae(a,t)}function ae(a,t){return a.node.element===t.node.element&&a.startIndex===t.startIndex&&a.height===t.height&&a.endIndex===t.endIndex}class at{constructor(t=[]){this.stickyNodes=t}get count(){return this.stickyNodes.length}equal(t){return G(this.stickyNodes,t.stickyNodes,lt)}lastNodePartiallyVisible(){if(this.count===0)return!1;const t=this.stickyNodes[this.count-1];if(this.count===1)return t.position!==0;const e=this.stickyNodes[this.count-2];return e.position+e.height!==t.position}animationStateChanged(t){if(!G(this.stickyNodes,t.stickyNodes,ae)||this.count===0)return!1;const e=this.stickyNodes[this.count-1],i=t.stickyNodes[t.count-1];return e.position!==i.position}}class dt{constrainStickyScrollNodes(t,e,i){for(let o=0;o<t.length;o++){const n=t[o];if(n.position+n.height>i||o>=e)return t.slice(0,o)}return t}}class de extends w{constructor(e,i,o,n,s,r={}){super();this.tree=e;this.model=i;this.view=o;this.treeDelegate=s;const l=this.validateStickySettings(r);this.stickyScrollMaxItemCount=l.stickyScrollMaxItemCount,this.stickyScrollDelegate=r.stickyScrollDelegate??new dt,this._widget=this._register(new ct(o.getScrollableElement(),o,e,n,s,r.accessibilityProvider)),this.onDidChangeHasFocus=this._widget.onDidChangeHasFocus,this.onContextMenu=this._widget.onContextMenu,this._register(o.onDidScroll(()=>this.update())),this._register(o.onDidChangeContentHeight(()=>this.update())),this._register(e.onDidChangeCollapseState(()=>this.update())),this.update()}onDidChangeHasFocus;onContextMenu;stickyScrollDelegate;stickyScrollMaxItemCount;maxWidgetViewRatio=.4;_widget;get height(){return this._widget.height}get count(){return this._widget.count}getNode(e){return this._widget.getNode(e)}getNodeAtHeight(e){let i;if(e===0?i=this.view.firstVisibleIndex:i=this.view.indexAt(e+this.view.scrollTop),!(i<0||i>=this.view.length))return this.view.element(i)}update(){const e=this.getNodeAtHeight(0);if(!e||this.tree.scrollTop===0){this._widget.setState(void 0);return}const i=this.findStickyState(e);this._widget.setState(i)}findStickyState(e){const i=[];let o=e,n=0,s=this.getNextStickyNode(o,void 0,n);for(;s&&(i.push(s),n+=s.height,!(i.length<=this.stickyScrollMaxItemCount&&(o=this.getNextVisibleNode(s),!o)));)s=this.getNextStickyNode(o,s.node,n);const r=this.constrainStickyNodes(i);return r.length?new at(r):void 0}getNextVisibleNode(e){return this.getNodeAtHeight(e.position+e.height)}getNextStickyNode(e,i,o){const n=this.getAncestorUnderPrevious(e,i);if(n&&!(n===e&&(!this.nodeIsUncollapsedParent(e)||this.nodeTopAlignsWithStickyNodesBottom(e,o))))return this.createStickyScrollNode(n,o)}nodeTopAlignsWithStickyNodesBottom(e,i){const o=this.getNodeIndex(e),n=this.view.getElementTop(o),s=i;return this.view.scrollTop===n-s}createStickyScrollNode(e,i){const o=this.treeDelegate.getHeight(e),{startIndex:n,endIndex:s}=this.getNodeRange(e),r=this.calculateStickyNodePosition(s,i,o);return{node:e,position:r,height:o,startIndex:n,endIndex:s}}getAncestorUnderPrevious(e,i=void 0){let o=e,n=this.getParentNode(o);for(;n;){if(n===i)return o;o=n,n=this.getParentNode(o)}if(i===void 0)return o}calculateStickyNodePosition(e,i,o){let n=this.view.getRelativeTop(e);if(n===null&&this.view.firstVisibleIndex===e&&e+1<this.view.length){const u=this.treeDelegate.getHeight(this.view.element(e)),g=this.view.getRelativeTop(e+1);n=g?g-u/this.view.renderHeight:null}if(n===null)return i;const s=this.view.element(e),r=this.treeDelegate.getHeight(s),c=n*this.view.renderHeight+r;return i+o>c&&i<=c?c-o:i}constrainStickyNodes(e){if(e.length===0)return[];const i=this.view.renderHeight*this.maxWidgetViewRatio,o=e[e.length-1];if(e.length<=this.stickyScrollMaxItemCount&&o.position+o.height<=i)return e;const n=this.stickyScrollDelegate.constrainStickyScrollNodes(e,this.stickyScrollMaxItemCount,i);if(!n.length)return[];const s=n[n.length-1];if(n.length>this.stickyScrollMaxItemCount||s.position+s.height>i)throw new Error("stickyScrollDelegate violates constraints");return n}getParentNode(e){const i=this.model.getNodeLocation(e),o=this.model.getParentNodeLocation(i);return o?this.model.getNode(o):void 0}nodeIsUncollapsedParent(e){const i=this.model.getNodeLocation(e);return this.model.getListRenderCount(i)>1}getNodeIndex(e){const i=this.model.getNodeLocation(e);return this.model.getListIndex(i)}getNodeRange(e){const i=this.model.getNodeLocation(e),o=this.model.getListIndex(i);if(o<0)throw new Error("Node not found in tree");const n=this.model.getListRenderCount(i),s=o+n-1;return{startIndex:o,endIndex:s}}nodePositionTopBelowWidget(e){const i=[];let o=this.getParentNode(e);for(;o;)i.push(o),o=this.getParentNode(o);let n=0;for(let s=0;s<i.length&&s<this.stickyScrollMaxItemCount;s++)n+=this.treeDelegate.getHeight(i[s]);return n}getFocus(){return this._widget.getFocus()}domFocus(){this._widget.domFocus()}focusedLast(){return this._widget.focusedLast()}updateOptions(e={}){if(!e.stickyScrollMaxItemCount)return;const i=this.validateStickySettings(e);this.stickyScrollMaxItemCount!==i.stickyScrollMaxItemCount&&(this.stickyScrollMaxItemCount=i.stickyScrollMaxItemCount,this.update())}validateStickySettings(e){let i=7;return typeof e.stickyScrollMaxItemCount=="number"&&(i=Math.max(e.stickyScrollMaxItemCount,1)),{stickyScrollMaxItemCount:i}}}class ct{constructor(t,e,i,o,n,s){this.view=e;this.tree=i;this.treeRenderers=o;this.treeDelegate=n;this.accessibilityProvider=s;this._rootDomNode=I(".monaco-tree-sticky-container.empty"),t.appendChild(this._rootDomNode);const r=I(".monaco-tree-sticky-container-shadow");this._rootDomNode.appendChild(r),this.stickyScrollFocus=new ht(this._rootDomNode,e),this.onDidChangeHasFocus=this.stickyScrollFocus.onDidChangeHasFocus,this.onContextMenu=this.stickyScrollFocus.onContextMenu}_rootDomNode;_previousState;_previousElements=[];_previousStateDisposables=new y;stickyScrollFocus;onDidChangeHasFocus;onContextMenu;get height(){if(!this._previousState)return 0;const t=this._previousState.stickyNodes[this._previousState.count-1];return t.position+t.height}get count(){return this._previousState?.count??0}getNode(t){return this._previousState?.stickyNodes.find(e=>e.node===t)}setState(t){const e=!!this._previousState&&this._previousState.count>0,i=!!t&&t.count>0;if(!e&&!i||e&&i&&this._previousState.equal(t))return;if(e!==i&&this.setVisible(i),!i){this._previousState=void 0,this._previousElements=[],this._previousStateDisposables.clear();return}const o=t.stickyNodes[t.count-1];if(this._previousState&&t.animationStateChanged(this._previousState))this._previousElements[this._previousState.count-1].style.top=`${o.position}px`;else{this._previousStateDisposables.clear();const n=Array(t.count);for(let s=t.count-1;s>=0;s--){const r=t.stickyNodes[s],{element:l,disposable:c}=this.createElement(r,s,t.count);n[s]=l,this._rootDomNode.appendChild(l),this._previousStateDisposables.add(c)}this.stickyScrollFocus.updateElements(n,t),this._previousElements=n}this._previousState=t,this._rootDomNode.style.height=`${o.position+o.height}px`}createElement(t,e,i){const o=t.startIndex,n=document.createElement("div");n.style.top=`${t.position}px`,this.tree.options.setRowHeight!==!1&&(n.style.height=`${t.height}px`),this.tree.options.setRowLineHeight!==!1&&(n.style.lineHeight=`${t.height}px`),n.classList.add("monaco-tree-sticky-row"),n.classList.add("monaco-list-row"),n.setAttribute("data-index",`${o}`),n.setAttribute("data-parity",o%2===0?"even":"odd"),n.setAttribute("id",this.view.getElementID(o));const s=this.setAccessibilityAttributes(n,t.node.element,e,i),r=this.treeDelegate.getTemplateId(t.node),l=this.treeRenderers.find(D=>D.templateId===r);if(!l)throw new Error(`No renderer found for template id ${r}`);let c=t.node;c===this.tree.getNode(this.tree.getNodeLocation(t.node))&&(c=new Proxy(t.node,{}));const u=l.renderTemplate(n);l.renderElement(c,t.startIndex,u,t.height);const g=U(()=>{s.dispose(),l.disposeElement(c,t.startIndex,u,t.height),l.disposeTemplate(u),n.remove()});return{element:n,disposable:g}}setAccessibilityAttributes(t,e,i,o){if(!this.accessibilityProvider)return w.None;this.accessibilityProvider.getSetSize&&t.setAttribute("aria-setsize",String(this.accessibilityProvider.getSetSize(e,i,o))),this.accessibilityProvider.getPosInSet&&t.setAttribute("aria-posinset",String(this.accessibilityProvider.getPosInSet(e,i))),this.accessibilityProvider.getRole&&t.setAttribute("role",this.accessibilityProvider.getRole(e)??"treeitem");const n=this.accessibilityProvider.getAriaLabel(e),s=n&&typeof n!="string"?n:Ue(n),r=Ke(c=>{const u=c.readObservable(s);u?t.setAttribute("aria-label",u):t.removeAttribute("aria-label")});typeof n=="string"||n&&t.setAttribute("aria-label",n.get());const l=this.accessibilityProvider.getAriaLevel&&this.accessibilityProvider.getAriaLevel(e);return typeof l=="number"&&t.setAttribute("aria-level",`${l}`),t.setAttribute("aria-selected",String(!1)),r}setVisible(t){this._rootDomNode.classList.toggle("empty",!t),t||this.stickyScrollFocus.updateElements([],void 0)}getFocus(){return this.stickyScrollFocus.getFocus()}domFocus(){this.stickyScrollFocus.domFocus()}focusedLast(){return this.stickyScrollFocus.focusedLast()}dispose(){this.stickyScrollFocus.dispose(),this._previousStateDisposables.dispose(),this._rootDomNode.remove()}}class ht extends w{constructor(e,i){super();this.container=e;this.view=i;this._register(j(this.container,"focus",()=>this.onFocus())),this._register(j(this.container,"blur",()=>this.onBlur())),this._register(this.view.onDidFocus(()=>this.toggleStickyScrollFocused(!1))),this._register(this.view.onKeyDown(o=>this.onKeyDown(o))),this._register(this.view.onMouseDown(o=>this.onMouseDown(o))),this._register(this.view.onContextMenu(o=>this.handleContextMenu(o)))}focusedIndex=-1;elements=[];state;_onDidChangeHasFocus=new v;onDidChangeHasFocus=this._onDidChangeHasFocus.event;_onContextMenu=new v;onContextMenu=this._onContextMenu.event;_domHasFocus=!1;get domHasFocus(){return this._domHasFocus}set domHasFocus(e){e!==this._domHasFocus&&(this._onDidChangeHasFocus.fire(e),this._domHasFocus=e)}handleContextMenu(e){const i=e.browserEvent.target;if(!E(i)&&!x(i)){this.focusedLast()&&this.view.domFocus();return}if(!F(e.browserEvent)){if(!this.state)throw new Error("Context menu should not be triggered when state is undefined");const r=this.state.stickyNodes.findIndex(l=>l.node.element===e.element?.element);if(r===-1)throw new Error("Context menu should not be triggered when element is not in sticky scroll widget");this.container.focus(),this.setFocus(r);return}if(!this.state||this.focusedIndex<0)throw new Error("Context menu key should not be triggered when focus is not in sticky scroll widget");const n=this.state.stickyNodes[this.focusedIndex].node.element,s=this.elements[this.focusedIndex];this._onContextMenu.fire({element:n,anchor:s,browserEvent:e.browserEvent,isStickyScroll:!0})}onKeyDown(e){if(this.domHasFocus&&this.state){if(e.key==="ArrowUp")this.setFocusedElement(Math.max(0,this.focusedIndex-1)),e.preventDefault(),e.stopPropagation();else if(e.key==="ArrowDown"||e.key==="ArrowRight"){if(this.focusedIndex>=this.state.count-1){const i=this.state.stickyNodes[this.state.count-1].startIndex+1;this.view.domFocus(),this.view.setFocus([i]),this.scrollNodeUnderWidget(i,this.state)}else this.setFocusedElement(this.focusedIndex+1);e.preventDefault(),e.stopPropagation()}}}onMouseDown(e){const i=e.browserEvent.target;!E(i)&&!x(i)||(e.browserEvent.preventDefault(),e.browserEvent.stopPropagation())}updateElements(e,i){if(i&&i.count===0)throw new Error("Sticky scroll state must be undefined when there are no sticky nodes");if(i&&i.count!==e.length)throw new Error("Sticky scroll focus received illigel state");const o=this.focusedIndex;if(this.removeFocus(),this.elements=e,this.state=i,i){const n=H(o,0,i.count-1);this.setFocus(n)}else this.domHasFocus&&this.view.domFocus();this.container.tabIndex=i?0:-1}setFocusedElement(e){const i=this.state;if(!i)throw new Error("Cannot set focus when state is undefined");if(this.setFocus(e),!(e<i.count-1)&&i.lastNodePartiallyVisible()){const o=i.stickyNodes[e];this.scrollNodeUnderWidget(o.endIndex+1,i)}}scrollNodeUnderWidget(e,i){const o=i.stickyNodes[i.count-1],n=i.count>1?i.stickyNodes[i.count-2]:void 0,s=this.view.getElementTop(e),r=n?n.position+n.height+o.height:o.height;this.view.scrollTop=s-r}getFocus(){if(!(!this.state||this.focusedIndex===-1))return this.state.stickyNodes[this.focusedIndex].node.element}domFocus(){if(!this.state)throw new Error("Cannot focus when state is undefined");this.container.focus()}focusedLast(){return this.state?this.view.getHTMLElement().classList.contains("sticky-scroll-focused"):!1}removeFocus(){this.focusedIndex!==-1&&(this.toggleElementFocus(this.elements[this.focusedIndex],!1),this.focusedIndex=-1)}setFocus(e){if(0>e)throw new Error("addFocus() can not remove focus");if(!this.state&&e>=0)throw new Error("Cannot set focus index when state is undefined");if(this.state&&e>=this.state.count)throw new Error("Cannot set focus index to an index that does not exist");const i=this.focusedIndex;i>=0&&this.toggleElementFocus(this.elements[i],!1),e>=0&&this.toggleElementFocus(this.elements[e],!0),this.focusedIndex=e}toggleElementFocus(e,i){this.toggleElementActiveFocus(e,i&&this.domHasFocus),this.toggleElementPassiveFocus(e,i)}toggleCurrentElementActiveFocus(e){this.focusedIndex!==-1&&this.toggleElementActiveFocus(this.elements[this.focusedIndex],e)}toggleElementActiveFocus(e,i){e.classList.toggle("focused",i)}toggleElementPassiveFocus(e,i){e.classList.toggle("passive-focused",i)}toggleStickyScrollFocused(e){this.view.getHTMLElement().classList.toggle("sticky-scroll-focused",e)}onFocus(){if(!this.state||this.elements.length===0)throw new Error("Cannot focus when state is undefined or elements are empty");this.domHasFocus=!0,this.toggleStickyScrollFocused(!0),this.toggleCurrentElementActiveFocus(!0),this.focusedIndex===-1&&this.setFocus(0)}onBlur(){this.domHasFocus=!1,this.toggleCurrentElementActiveFocus(!1)}dispose(){this.toggleStickyScrollFocused(!1),this._onDidChangeHasFocus.fire(!1),super.dispose()}}function C(a){let t=k.Unknown;return z(a.browserEvent.target,"monaco-tl-twistie","monaco-tl-row")?t=k.Twistie:z(a.browserEvent.target,"monaco-tl-contents","monaco-tl-row")?t=k.Element:z(a.browserEvent.target,"monaco-tree-type-filter","monaco-list")&&(t=k.Filter),{browserEvent:a.browserEvent,element:a.element?a.element.element:null,target:t}}function ut(a){const t=E(a.browserEvent.target);return{element:a.element?a.element.element:null,browserEvent:a.browserEvent,anchor:a.anchor,isStickyScroll:t}}function V(a,t){t(a),a.children.forEach(e=>V(e,t))}class Y{constructor(t,e){this.getFirstViewElementWithTrait=t;this.identityProvider=e}nodes=[];elements;_onDidChange=new v;onDidChange=this._onDidChange.event;_nodeSet;get nodeSet(){return this._nodeSet||(this._nodeSet=this.createNodeSet()),this._nodeSet}set(t,e){!e?.__forceEvent&&G(this.nodes,t)||this._set(t,!1,e)}_set(t,e,i){if(this.nodes=[...t],this.elements=void 0,this._nodeSet=void 0,!e){const o=this;this._onDidChange.fire({get elements(){return o.get()},browserEvent:i})}}get(){return this.elements||(this.elements=this.nodes.map(t=>t.element)),[...this.elements]}getNodes(){return this.nodes}has(t){return this.nodeSet.has(t)}onDidModelSplice({insertedNodes:t,deletedNodes:e}){if(!this.identityProvider){const l=this.createNodeSet(),c=u=>l.delete(u);e.forEach(u=>V(u,c)),this.set([...l.values()]);return}const i=new Set,o=l=>i.add(this.identityProvider.getId(l.element).toString());e.forEach(l=>V(l,o));const n=new Map,s=l=>n.set(this.identityProvider.getId(l.element).toString(),l);t.forEach(l=>V(l,s));const r=[];for(const l of this.nodes){const c=this.identityProvider.getId(l.element).toString();if(!i.has(c))r.push(l);else{const g=n.get(c);g&&g.visible&&r.push(g)}}if(this.nodes.length>0&&r.length===0){const l=this.getFirstViewElementWithTrait();l&&r.push(l)}this._set(r,!0)}createNodeSet(){const t=new Set;for(const e of this.nodes)t.add(e);return t}}class Tt extends Ee{constructor(e,i,o){super(e);this.tree=i;this.stickyScrollProvider=o}onViewPointer(e){if(Fe(e.browserEvent.target)||te(e.browserEvent.target)||Ce(e.browserEvent.target)||e.browserEvent.isHandledByList)return;const i=e.element;if(!i)return super.onViewPointer(e);if(this.isSelectionRangeChangeEvent(e)||this.isSelectionSingleChangeEvent(e))return super.onViewPointer(e);const o=e.browserEvent.target,n=o.classList.contains("monaco-tl-twistie")||o.classList.contains("monaco-icon-label")&&o.classList.contains("folder-icon")&&e.browserEvent.offsetX<16,s=x(e.browserEvent.target);let r=!1;if(s?r=!0:typeof this.tree.expandOnlyOnTwistieClick=="function"?r=this.tree.expandOnlyOnTwistieClick(i.element):r=!!this.tree.expandOnlyOnTwistieClick,s)this.handleStickyScrollMouseEvent(e,i);else{if(r&&!n&&e.browserEvent.detail!==2)return super.onViewPointer(e);if(!this.tree.expandOnDoubleClick&&e.browserEvent.detail===2)return super.onViewPointer(e)}if(i.collapsible&&(!s||n)){const l=this.tree.getNodeLocation(i),c=e.browserEvent.altKey;if(this.tree.setFocus([l]),this.tree.toggleCollapsed(l,c),n){e.browserEvent.isHandledByList=!0;return}}s||super.onViewPointer(e)}handleStickyScrollMouseEvent(e,i){if(we(e.browserEvent.target)||Ie(e.browserEvent.target))return;const o=this.stickyScrollProvider();if(!o)throw new Error("Sticky scroll controller not found");const n=this.list.indexOf(i),s=this.list.getElementTop(n),r=o.nodePositionTopBelowWidget(i);this.tree.scrollTop=s-r,this.list.domFocus(),this.list.setFocus([n]),this.list.setSelection([n])}onDoubleClick(e){e.browserEvent.target.classList.contains("monaco-tl-twistie")||!this.tree.expandOnDoubleClick||e.browserEvent.isHandledByList||super.onDoubleClick(e)}onMouseDown(e){const i=e.browserEvent.target;if(!E(i)&&!x(i)){super.onMouseDown(e);return}}onContextMenu(e){const i=e.browserEvent.target;if(!E(i)&&!x(i)){super.onContextMenu(e);return}}}class pt extends Ne{constructor(e,i,o,n,s,r,l,c){super(e,i,o,n,c);this.focusTrait=s;this.selectionTrait=r;this.anchorTrait=l}createMouseController(e){return new Tt(this,e.tree,e.stickyScrollProvider)}splice(e,i,o=[]){if(super.splice(e,i,o),o.length===0)return;const n=[],s=[];let r;o.forEach((l,c)=>{this.focusTrait.has(l)&&n.push(e+c),this.selectionTrait.has(l)&&s.push(e+c),this.anchorTrait.has(l)&&(r=e+c)}),n.length>0&&super.setFocus(oe([...super.getFocus(),...n])),s.length>0&&super.setSelection(oe([...super.getSelection(),...s])),typeof r=="number"&&super.setAnchor(r)}setFocus(e,i,o=!1){super.setFocus(e,i),o||this.focusTrait.set(e.map(n=>this.element(n)),i)}setSelection(e,i,o=!1){super.setSelection(e,i),o||this.selectionTrait.set(e.map(n=>this.element(n)),i)}setAnchor(e,i=!1){super.setAnchor(e),i||(typeof e>"u"?this.anchorTrait.set([]):this.anchorTrait.set([this.element(e)]))}}var gt=(e=>(e[e.Tree=0]="Tree",e[e.StickyScroll=1]="StickyScroll",e))(gt||{});class Li{constructor(t,e,i,o,n={}){this._user=t;this._options=n;this.treeDelegate=new je(i);const s=new ne,r=new ne,l=this.disposables.add(new Qe(r.event)),c=new ze;this.renderers=o.map(p=>new B(p,()=>this.model,s.event,l,c,n));for(const p of this.renderers)this.disposables.add(p);let u;n.keyboardNavigationLabelProvider&&(u=new Ze(this,n.keyboardNavigationLabelProvider,n.filter),n={...n,filter:u},this.disposables.add(u)),this.focus=new Y(()=>this.view.getFocusedElements()[0],n.identityProvider),this.selection=new Y(()=>this.view.getSelectedElements()[0],n.identityProvider),this.anchor=new Y(()=>this.view.getAnchorElement(),n.identityProvider),this.view=new pt(t,e,this.treeDelegate,this.renderers,this.focus,this.selection,this.anchor,{...Xe(()=>this.model,n),tree:this,stickyScrollProvider:()=>this.stickyScrollController}),this.model=this.createModel(t,this.view,n),s.input=this.model.onDidChangeCollapseState;const g=h.forEach(this.model.onDidSplice,p=>{this.eventBufferer.bufferEvents(()=>{this.focus.onDidModelSplice(p),this.selection.onDidModelSplice(p)})},this.disposables);g(()=>null,null,this.disposables);const D=this.disposables.add(new v),f=this.disposables.add(new Oe(0));if(this.disposables.add(h.any(g,this.focus.onDidChange,this.selection.onDidChange)(()=>{f.trigger(()=>{const p=new Set;for(const d of this.focus.getNodes())p.add(d);for(const d of this.selection.getNodes())p.add(d);D.fire([...p.values()])})})),r.input=D.event,n.keyboardSupport!==!1){const p=h.chain(this.view.onKeyDown,d=>d.filter(T=>!te(T.target)).map(T=>new $(T)));h.chain(p,d=>d.filter(T=>T.keyCode===m.LeftArrow))(this.onLeftArrow,this,this.disposables),h.chain(p,d=>d.filter(T=>T.keyCode===m.RightArrow))(this.onRightArrow,this,this.disposables),h.chain(p,d=>d.filter(T=>T.keyCode===m.Space))(this.onSpace,this,this.disposables)}if((n.findWidgetEnabled??!0)&&n.keyboardNavigationLabelProvider&&n.contextViewProvider){const p=this.options.findWidgetStyles?{styles:this.options.findWidgetStyles}:void 0;this.findController=new rt(this,this.model,this.view,u,n.contextViewProvider,p),this.focusNavigationFilter=d=>this.findController.shouldAllowFocus(d),this.onDidChangeFindOpenState=this.findController.onDidChangeOpenState,this.disposables.add(this.findController),this.onDidChangeFindMode=this.findController.onDidChangeMode,this.onDidChangeFindMatchType=this.findController.onDidChangeMatchType}else this.onDidChangeFindMode=h.None,this.onDidChangeFindMatchType=h.None;n.enableStickyScroll&&(this.stickyScrollController=new de(this,this.model,this.view,this.renderers,this.treeDelegate,n),this.onDidChangeStickyScrollFocused=this.stickyScrollController.onDidChangeHasFocus),this.styleElement=me(this.view.getHTMLElement()),this.getHTMLElement().classList.toggle("always",this._options.renderIndentGuides==="always")}view;renderers;model;treeDelegate;focus;selection;anchor;eventBufferer=new Be;findController;onDidChangeFindOpenState=h.None;onDidChangeStickyScrollFocused=h.None;focusNavigationFilter;stickyScrollController;styleElement;disposables=new y;get onDidScroll(){return this.view.onDidScroll}get onDidChangeFocus(){return this.eventBufferer.wrapEvent(this.focus.onDidChange)}get onDidChangeSelection(){return this.eventBufferer.wrapEvent(this.selection.onDidChange)}get onMouseClick(){return h.map(this.view.onMouseClick,C)}get onMouseDblClick(){return h.filter(h.map(this.view.onMouseDblClick,C),t=>t.target!==k.Filter)}get onMouseOver(){return h.map(this.view.onMouseOver,C)}get onMouseOut(){return h.map(this.view.onMouseOut,C)}get onContextMenu(){return h.any(h.filter(h.map(this.view.onContextMenu,ut),t=>!t.isStickyScroll),this.stickyScrollController?.onContextMenu??h.None)}get onTap(){return h.map(this.view.onTap,C)}get onPointer(){return h.map(this.view.onPointer,C)}get onKeyDown(){return this.view.onKeyDown}get onKeyUp(){return this.view.onKeyUp}get onKeyPress(){return this.view.onKeyPress}get onDidFocus(){return this.view.onDidFocus}get onDidBlur(){return this.view.onDidBlur}get onDidChangeModel(){return h.signal(this.model.onDidSplice)}get onDidChangeCollapseState(){return this.model.onDidChangeCollapseState}get onDidChangeRenderNodeCount(){return this.model.onDidChangeRenderNodeCount}_onWillRefilter=new v;onWillRefilter=this._onWillRefilter.event;get findMode(){return this.findController?.mode??0}set findMode(t){this.findController&&(this.findController.mode=t)}onDidChangeFindMode;get findMatchType(){return this.findController?.matchType??0}set findMatchType(t){this.findController&&(this.findController.matchType=t)}onDidChangeFindMatchType;get onDidChangeFindPattern(){return this.findController?this.findController.onDidChangePattern:h.None}get expandOnDoubleClick(){return typeof this._options.expandOnDoubleClick>"u"?!0:this._options.expandOnDoubleClick}get expandOnlyOnTwistieClick(){return typeof this._options.expandOnlyOnTwistieClick>"u"?!0:this._options.expandOnlyOnTwistieClick}_onDidUpdateOptions=new v;onDidUpdateOptions=this._onDidUpdateOptions.event;get onDidDispose(){return this.view.onDidDispose}updateOptions(t={}){this._options={...this._options,...t};for(const e of this.renderers)e.updateOptions(t);this.view.updateOptions(this._options),this.findController?.updateOptions(t),this.updateStickyScroll(t),this._onDidUpdateOptions.fire(this._options),this.getHTMLElement().classList.toggle("always",this._options.renderIndentGuides==="always")}get options(){return this._options}updateStickyScroll(t){!this.stickyScrollController&&this._options.enableStickyScroll?(this.stickyScrollController=new de(this,this.model,this.view,this.renderers,this.treeDelegate,this._options),this.onDidChangeStickyScrollFocused=this.stickyScrollController.onDidChangeHasFocus):this.stickyScrollController&&!this._options.enableStickyScroll&&(this.onDidChangeStickyScrollFocused=h.None,this.stickyScrollController.dispose(),this.stickyScrollController=void 0),this.stickyScrollController?.updateOptions(t)}updateWidth(t){const e=this.model.getListIndex(t);e!==-1&&this.view.updateWidth(e)}getHTMLElement(){return this.view.getHTMLElement()}get contentHeight(){return this.view.contentHeight}get contentWidth(){return this.view.contentWidth}get onDidChangeContentHeight(){return this.view.onDidChangeContentHeight}get onDidChangeContentWidth(){return this.view.onDidChangeContentWidth}get scrollTop(){return this.view.scrollTop}set scrollTop(t){this.view.scrollTop=t}get scrollLeft(){return this.view.scrollLeft}set scrollLeft(t){this.view.scrollLeft=t}get scrollHeight(){return this.view.scrollHeight}get renderHeight(){return this.view.renderHeight}get firstVisibleElement(){let t=this.view.firstVisibleIndex;return this.stickyScrollController&&(t+=this.stickyScrollController.count),t<0||t>=this.view.length?void 0:this.view.element(t).element}get lastVisibleElement(){const t=this.view.lastVisibleIndex;return this.view.element(t).element}get ariaLabel(){return this.view.ariaLabel}set ariaLabel(t){this.view.ariaLabel=t}get selectionSize(){return this.selection.getNodes().length}domFocus(){this.stickyScrollController?.focusedLast()?this.stickyScrollController.domFocus():this.view.domFocus()}isDOMFocused(){return ye(this.getHTMLElement())}layout(t,e){this.view.layout(t,e),$e(e)&&this.findController?.layout(e)}style(t){const e=`.${this.view.domId}`,i=[];t.treeIndentGuidesStroke&&(i.push(`.monaco-list${e}:hover .monaco-tl-indent > .indent-guide, .monaco-list${e}.always .monaco-tl-indent > .indent-guide  { border-color: ${t.treeInactiveIndentGuidesStroke}; }`),i.push(`.monaco-list${e} .monaco-tl-indent > .indent-guide.active { border-color: ${t.treeIndentGuidesStroke}; }`));const o=t.treeStickyScrollBackground??t.listBackground;o&&(i.push(`.monaco-list${e} .monaco-scrollable-element .monaco-tree-sticky-container { background-color: ${o}; }`),i.push(`.monaco-list${e} .monaco-scrollable-element .monaco-tree-sticky-container .monaco-tree-sticky-row { background-color: ${o}; }`)),t.treeStickyScrollBorder&&i.push(`.monaco-list${e} .monaco-scrollable-element .monaco-tree-sticky-container { border-bottom: 1px solid ${t.treeStickyScrollBorder}; }`),t.treeStickyScrollShadow&&i.push(`.monaco-list${e} .monaco-scrollable-element .monaco-tree-sticky-container .monaco-tree-sticky-container-shadow { box-shadow: ${t.treeStickyScrollShadow} 0 6px 6px -6px inset; height: 3px; }`),t.listFocusForeground&&(i.push(`.monaco-list${e}.sticky-scroll-focused .monaco-scrollable-element .monaco-tree-sticky-container:focus .monaco-list-row.focused { color: ${t.listFocusForeground}; }`),i.push(`.monaco-list${e}:not(.sticky-scroll-focused) .monaco-scrollable-element .monaco-tree-sticky-container .monaco-list-row.focused { color: inherit; }`));const n=J(t.listFocusAndSelectionOutline,J(t.listSelectionOutline,t.listFocusOutline??""));n&&(i.push(`.monaco-list${e}.sticky-scroll-focused .monaco-scrollable-element .monaco-tree-sticky-container:focus .monaco-list-row.focused.selected { outline: 1px solid ${n}; outline-offset: -1px;}`),i.push(`.monaco-list${e}:not(.sticky-scroll-focused) .monaco-scrollable-element .monaco-tree-sticky-container .monaco-list-row.focused.selected { outline: inherit;}`)),t.listFocusOutline&&(i.push(`.monaco-list${e}.sticky-scroll-focused .monaco-scrollable-element .monaco-tree-sticky-container:focus .monaco-list-row.focused { outline: 1px solid ${t.listFocusOutline}; outline-offset: -1px; }`),i.push(`.monaco-list${e}:not(.sticky-scroll-focused) .monaco-scrollable-element .monaco-tree-sticky-container .monaco-list-row.focused { outline: inherit; }`),i.push(`.monaco-workbench.context-menu-visible .monaco-list${e}.last-focused.sticky-scroll-focused .monaco-scrollable-element .monaco-tree-sticky-container .monaco-list-row.passive-focused { outline: 1px solid ${t.listFocusOutline}; outline-offset: -1px; }`),i.push(`.monaco-workbench.context-menu-visible .monaco-list${e}.last-focused.sticky-scroll-focused .monaco-list-rows .monaco-list-row.focused { outline: inherit; }`),i.push(`.monaco-workbench.context-menu-visible .monaco-list${e}.last-focused:not(.sticky-scroll-focused) .monaco-tree-sticky-container .monaco-list-rows .monaco-list-row.focused { outline: inherit; }`)),this.styleElement.textContent=i.join(`
`),this.view.style(t)}getParentElement(t){const e=this.model.getParentNodeLocation(t);return this.model.getNode(e).element}getFirstElementChild(t){return this.model.getFirstElementChild(t)}getNode(t){return this.model.getNode(t)}getNodeLocation(t){return this.model.getNodeLocation(t)}collapse(t,e=!1){return this.model.setCollapsed(t,!0,e)}expand(t,e=!1){return this.model.setCollapsed(t,!1,e)}toggleCollapsed(t,e=!1){return this.model.setCollapsed(t,void 0,e)}expandAll(){this.model.setCollapsed(this.model.rootRef,!1,!0)}collapseAll(){this.model.setCollapsed(this.model.rootRef,!0,!0)}isCollapsible(t){return this.model.isCollapsible(t)}setCollapsible(t,e){return this.model.setCollapsible(t,e)}isCollapsed(t){return this.model.isCollapsed(t)}expandTo(t){this.model.expandTo(t)}triggerTypeNavigation(){this.view.triggerTypeNavigation()}openFind(){this.findController?.open()}closeFind(){this.findController?.close()}refilter(){this._onWillRefilter.fire(void 0),this.model.refilter()}setAnchor(t){if(typeof t>"u")return this.view.setAnchor(void 0);this.eventBufferer.bufferEvents(()=>{const e=this.model.getNode(t);this.anchor.set([e]);const i=this.model.getListIndex(t);i>-1&&this.view.setAnchor(i,!0)})}getAnchor(){return Pe(this.anchor.get(),void 0)}setSelection(t,e){this.eventBufferer.bufferEvents(()=>{const i=t.map(n=>this.model.getNode(n));this.selection.set(i,e);const o=t.map(n=>this.model.getListIndex(n)).filter(n=>n>-1);this.view.setSelection(o,e,!0)})}getSelection(){return this.selection.get()}setFocus(t,e){this.eventBufferer.bufferEvents(()=>{const i=t.map(n=>this.model.getNode(n));this.focus.set(i,e);const o=t.map(n=>this.model.getListIndex(n)).filter(n=>n>-1);this.view.setFocus(o,e,!0)})}focusNext(t=1,e=!1,i,o=F(i)&&i.altKey?void 0:this.focusNavigationFilter){this.view.focusNext(t,e,i,o)}focusPrevious(t=1,e=!1,i,o=F(i)&&i.altKey?void 0:this.focusNavigationFilter){this.view.focusPrevious(t,e,i,o)}focusNextPage(t,e=F(t)&&t.altKey?void 0:this.focusNavigationFilter){return this.view.focusNextPage(t,e)}focusPreviousPage(t,e=F(t)&&t.altKey?void 0:this.focusNavigationFilter){return this.view.focusPreviousPage(t,e,()=>this.stickyScrollController?.height??0)}focusLast(t,e=F(t)&&t.altKey?void 0:this.focusNavigationFilter){this.view.focusLast(t,e)}focusFirst(t,e=F(t)&&t.altKey?void 0:this.focusNavigationFilter){this.view.focusFirst(t,e)}getFocus(){return this.focus.get()}getStickyScrollFocus(){const t=this.stickyScrollController?.getFocus();return t!==void 0?[t]:[]}getFocusedPart(){return this.stickyScrollController?.focusedLast()?1:0}reveal(t,e){this.model.expandTo(t);const i=this.model.getListIndex(t);if(i!==-1)if(!this.stickyScrollController)this.view.reveal(i,e);else{const o=this.stickyScrollController.nodePositionTopBelowWidget(this.getNode(t));this.view.reveal(i,e,o)}}getRelativeTop(t){const e=this.model.getListIndex(t);if(e===-1)return null;const i=this.stickyScrollController?.getNode(this.getNode(t));return this.view.getRelativeTop(e,i?.position??this.stickyScrollController?.height)}getViewState(t=this.options.identityProvider){if(!t)throw new _e(this._user,"Can't get tree view state without an identity provider");const e=s=>t.getId(s).toString(),i=_.empty(this.scrollTop);for(const s of this.getFocus())i.focus.add(e(s));for(const s of this.getSelection())i.selection.add(e(s));const o=this.model.getNode(),n=[o];for(;n.length>0;){const s=n.shift();s!==o&&s.collapsible&&(i.expanded[e(s.element)]=s.collapsed?0:1),n.push(...s.children)}return i}onLeftArrow(t){t.preventDefault(),t.stopPropagation();const e=this.view.getFocusedElements();if(e.length===0)return;const i=e[0],o=this.model.getNodeLocation(i);if(!this.model.setCollapsed(o,!0)){const s=this.model.getParentNodeLocation(o);if(!s)return;const r=this.model.getListIndex(s);this.view.reveal(r),this.view.setFocus([r])}}onRightArrow(t){t.preventDefault(),t.stopPropagation();const e=this.view.getFocusedElements();if(e.length===0)return;const i=e[0],o=this.model.getNodeLocation(i);if(!this.model.setCollapsed(o,!1)){if(!i.children.some(l=>l.visible))return;const[s]=this.view.getFocus(),r=s+1;this.view.reveal(r),this.view.setFocus([r])}}onSpace(t){t.preventDefault(),t.stopPropagation();const e=this.view.getFocusedElements();if(e.length===0)return;const i=e[0],o=this.model.getNodeLocation(i),n=t.browserEvent.altKey;this.model.setCollapsed(o,void 0,n)}navigate(t){return new ft(this.view,this.model,t)}dispose(){K(this.disposables),this.stickyScrollController?.dispose(),this.view.dispose()}}class ft{constructor(t,e,i){this.view=t;this.model=e;i?this.index=this.model.getListIndex(i):this.index=-1}index;current(){return this.index<0||this.index>=this.view.length?null:this.view.element(this.index).element}previous(){return this.index--,this.current()}next(){return this.index++,this.current()}first(){return this.index=0,this.current()}last(){return this.index=this.view.length-1,this.current()}}export{Li as AbstractTree,gt as AbstractTreePart,_ as AbstractTreeViewState,je as ComposedTreeDelegate,tt as FuzzyToggle,et as ModeToggle,Je as RenderIndentGuides,nt as TreeFindMatchType,ot as TreeFindMode,B as TreeRenderer};
