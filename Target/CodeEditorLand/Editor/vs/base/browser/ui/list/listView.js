var Y=Object.defineProperty;var j=Object.getOwnPropertyDescriptor;var D=(b,e,t,i)=>{for(var s=i>1?void 0:i?j(e,t):e,o=b.length-1,n;o>=0;o--)(n=b[o])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&Y(e,t,s),s};import{distinct as q,equals as X}from"../../../common/arrays.js";import{Delayer as J,disposableTimeout as x}from"../../../common/async.js";import{memoize as E}from"../../../common/decorators.js";import{BugIndicatingError as K}from"../../../common/errors.js";import{Emitter as z,Event as p}from"../../../common/event.js";import{Disposable as M,DisposableStore as Q,toDisposable as k}from"../../../common/lifecycle.js";import{clamp as Z}from"../../../common/numbers.js";import{Range as y}from"../../../common/range.js";import{Scrollable as ee,ScrollbarVisibility as P}from"../../../common/scrollable.js";import{DataTransfers as te}from"../../dnd.js";import{$ as ie,addDisposableListener as w,animate as se,getContentHeight as ne,getContentWidth as L,getTopLeftOffset as oe,getWindow as R,isAncestor as re,isHTMLElement as le,isSVGElement as ae,scheduleAtNextAnimationFrame as F}from"../../dom.js";import{DomEmitter as v}from"../../event.js";import{Gesture as de,EventType as A}from"../../touch.js";import{SmoothScrollableElement as he}from"../scrollbar/scrollableElement.js";import{ListDragOverEffectPosition as C,ListDragOverEffectType as me}from"./list.js";import{RangeMap as ce,shift as U}from"./rangeMap.js";import{RowCache as pe}from"./rowCache.js";const S={CurrentDragAndDropData:void 0};var ue=(s=>(s[s.TOP=0]="TOP",s[s.CENTER_TOP=1]="CENTER_TOP",s[s.CENTER_BOTTOM=2]="CENTER_BOTTOM",s[s.BOTTOM=3]="BOTTOM",s))(ue||{});const T={useShadows:!0,verticalScrollMode:P.Auto,setRowLineHeight:!0,setRowHeight:!0,supportDynamicHeights:!1,dnd:{getDragElements(b){return[b]},getDragURI(){return null},onDragStart(){},onDragOver(){return!1},drop(){},dispose(){}},horizontalScrolling:!1,transformOptimization:!0,alwaysConsumeMouseWheel:!0};class ge{elements;_context;get context(){return this._context}set context(e){this._context=e}constructor(e){this.elements=e}update(){}getData(){return this.elements}}class fe{elements;constructor(e){this.elements=e}update(){}getData(){return this.elements}}class be{types;files;constructor(){this.types=[],this.files=[]}update(e){if(e.types&&this.types.splice(0,this.types.length,...e.types),e.files){this.files.splice(0,this.files.length);for(let t=0;t<e.files.length;t++){const i=e.files.item(t);i&&(i.size||i.type)&&this.files.push(i)}}}getData(){return{types:this.types,files:this.files}}}function De(b,e){return Array.isArray(b)&&Array.isArray(e)?X(b,e):b===e}class ve{getSetSize;getPosInSet;getRole;isChecked;constructor(e){e?.getSetSize?this.getSetSize=e.getSetSize.bind(e):this.getSetSize=(t,i,s)=>s,e?.getPosInSet?this.getPosInSet=e.getPosInSet.bind(e):this.getPosInSet=(t,i)=>i+1,e?.getRole?this.getRole=e.getRole.bind(e):this.getRole=t=>"listitem",e?.isChecked?this.isChecked=e.isChecked.bind(e):this.isChecked=t=>{}}}const g=class g{constructor(e,t,i,s=T){this.virtualDelegate=t;if(s.horizontalScrolling&&s.supportDynamicHeights)throw new Error("Horizontal scrolling and dynamic heights not supported simultaneously");this.items=[],this.itemId=0,this.rangeMap=this.createRangeMap(s.paddingTop??0);for(const n of i)this.renderers.set(n.templateId,n);this.cache=this.disposables.add(new pe(this.renderers)),this.lastRenderTop=0,this.lastRenderHeight=0,this.domNode=document.createElement("div"),this.domNode.className="monaco-list",this.domNode.classList.add(this.domId),this.domNode.tabIndex=0,this.domNode.classList.toggle("mouse-support",typeof s.mouseSupport=="boolean"?s.mouseSupport:!0),this._horizontalScrolling=s.horizontalScrolling??T.horizontalScrolling,this.domNode.classList.toggle("horizontal-scrolling",this._horizontalScrolling),this.paddingBottom=typeof s.paddingBottom>"u"?0:s.paddingBottom,this.accessibilityProvider=new ve(s.accessibilityProvider),this.rowsContainer=document.createElement("div"),this.rowsContainer.className="monaco-list-rows",(s.transformOptimization??T.transformOptimization)&&(this.rowsContainer.style.transform="translate3d(0px, 0px, 0px)",this.rowsContainer.style.overflow="hidden",this.rowsContainer.style.contain="strict"),this.disposables.add(de.addTarget(this.rowsContainer)),this.scrollable=this.disposables.add(new ee({forceIntegerValues:!0,smoothScrollDuration:s.smoothScrolling??!1?125:0,scheduleAtNextAnimationFrame:n=>F(R(this.domNode),n)})),this.scrollableElement=this.disposables.add(new he(this.rowsContainer,{alwaysConsumeMouseWheel:s.alwaysConsumeMouseWheel??T.alwaysConsumeMouseWheel,horizontal:P.Auto,vertical:s.verticalScrollMode??T.verticalScrollMode,useShadows:s.useShadows??T.useShadows,mouseWheelScrollSensitivity:s.mouseWheelScrollSensitivity,fastScrollSensitivity:s.fastScrollSensitivity,scrollByPage:s.scrollByPage},this.scrollable)),this.domNode.appendChild(this.scrollableElement.getDomNode()),e.appendChild(this.domNode),this.scrollableElement.onScroll(this.onScroll,this,this.disposables),this.disposables.add(w(this.rowsContainer,A.Change,n=>this.onTouchChange(n))),this.disposables.add(w(this.scrollableElement.getDomNode(),"scroll",n=>n.target.scrollTop=0)),this.disposables.add(w(this.domNode,"dragover",n=>this.onDragOver(this.toDragEvent(n)))),this.disposables.add(w(this.domNode,"drop",n=>this.onDrop(this.toDragEvent(n)))),this.disposables.add(w(this.domNode,"dragleave",n=>this.onDragLeave(this.toDragEvent(n)))),this.disposables.add(w(this.domNode,"dragend",n=>this.onDragEnd(n))),this.setRowLineHeight=s.setRowLineHeight??T.setRowLineHeight,this.setRowHeight=s.setRowHeight??T.setRowHeight,this.supportDynamicHeights=s.supportDynamicHeights??T.supportDynamicHeights,this.dnd=s.dnd??this.disposables.add(T.dnd),this.layout(s.initialSize?.height,s.initialSize?.width)}static InstanceCount=0;domId=`list_id_${++g.InstanceCount}`;domNode;items;itemId;rangeMap;cache;renderers=new Map;lastRenderTop;lastRenderHeight;renderWidth=0;rowsContainer;scrollable;scrollableElement;_scrollHeight=0;scrollableElementUpdateDisposable=null;scrollableElementWidthDelayer=new J(50);splicing=!1;dragOverAnimationDisposable;dragOverAnimationStopDisposable=M.None;dragOverMouseY=0;setRowLineHeight;setRowHeight;supportDynamicHeights;paddingBottom;accessibilityProvider;scrollWidth;dnd;canDrop=!1;currentDragData;currentDragFeedback;currentDragFeedbackPosition;currentDragFeedbackDisposable=M.None;onDragLeaveTimeout=M.None;disposables=new Q;_onDidChangeContentHeight=new z;_onDidChangeContentWidth=new z;onDidChangeContentHeight=p.latch(this._onDidChangeContentHeight.event,void 0,this.disposables);onDidChangeContentWidth=p.latch(this._onDidChangeContentWidth.event,void 0,this.disposables);get contentHeight(){return this.rangeMap.size}get contentWidth(){return this.scrollWidth??0}get onDidScroll(){return this.scrollableElement.onScroll}get onWillScroll(){return this.scrollableElement.onWillScroll}get containerDomNode(){return this.rowsContainer}get scrollableElementDomNode(){return this.scrollableElement.getDomNode()}_horizontalScrolling=!1;get horizontalScrolling(){return this._horizontalScrolling}set horizontalScrolling(e){if(e!==this._horizontalScrolling){if(e&&this.supportDynamicHeights)throw new Error("Horizontal scrolling and dynamic heights not supported simultaneously");if(this._horizontalScrolling=e,this.domNode.classList.toggle("horizontal-scrolling",this._horizontalScrolling),this._horizontalScrolling){for(const t of this.items)this.measureItemWidth(t);this.updateScrollWidth(),this.scrollableElement.setScrollDimensions({width:L(this.domNode)}),this.rowsContainer.style.width=`${Math.max(this.scrollWidth||0,this.renderWidth)}px`}else this.scrollableElementWidthDelayer.cancel(),this.scrollableElement.setScrollDimensions({width:this.renderWidth,scrollWidth:this.renderWidth}),this.rowsContainer.style.width=""}}updateOptions(e){e.paddingBottom!==void 0&&(this.paddingBottom=e.paddingBottom,this.scrollableElement.setScrollDimensions({scrollHeight:this.scrollHeight})),e.smoothScrolling!==void 0&&this.scrollable.setSmoothScrollDuration(e.smoothScrolling?125:0),e.horizontalScrolling!==void 0&&(this.horizontalScrolling=e.horizontalScrolling);let t;if(e.scrollByPage!==void 0&&(t={...t??{},scrollByPage:e.scrollByPage}),e.mouseWheelScrollSensitivity!==void 0&&(t={...t??{},mouseWheelScrollSensitivity:e.mouseWheelScrollSensitivity}),e.fastScrollSensitivity!==void 0&&(t={...t??{},fastScrollSensitivity:e.fastScrollSensitivity}),t&&this.scrollableElement.updateOptions(t),e.paddingTop!==void 0&&e.paddingTop!==this.rangeMap.paddingTop){const i=this.getRenderRange(this.lastRenderTop,this.lastRenderHeight),s=e.paddingTop-this.rangeMap.paddingTop;this.rangeMap.paddingTop=e.paddingTop,this.render(i,Math.max(0,this.lastRenderTop+s),this.lastRenderHeight,void 0,void 0,!0),this.setScrollTop(this.lastRenderTop),this.eventuallyUpdateScrollDimensions(),this.supportDynamicHeights&&this._rerender(this.lastRenderTop,this.lastRenderHeight)}}delegateScrollFromMouseWheelEvent(e){this.scrollableElement.delegateScrollFromMouseWheelEvent(e)}delegateVerticalScrollbarPointerDown(e){this.scrollableElement.delegateVerticalScrollbarPointerDown(e)}updateElementHeight(e,t,i){if(e<0||e>=this.items.length)return;const s=this.items[e].size;if(typeof t>"u"){if(!this.supportDynamicHeights)return;this.items[e].lastDynamicHeightWidth=void 0,t=s+this.probeDynamicHeight(e)}if(s===t)return;const o=this.getRenderRange(this.lastRenderTop,this.lastRenderHeight);let n=0;e<o.start||i!==null&&i>e&&i<o.end?n=t-s:n=0,this.rangeMap.splice(e,1,[{size:t}]),this.items[e].size=t,this.render(o,Math.max(0,this.lastRenderTop+n),this.lastRenderHeight,void 0,void 0,!0),this.setScrollTop(this.lastRenderTop),this.eventuallyUpdateScrollDimensions(),this.supportDynamicHeights&&this._rerender(this.lastRenderTop,this.lastRenderHeight)}createRangeMap(e){return new ce(e)}splice(e,t,i=[]){if(this.splicing)throw new Error("Can't run recursive splices.");this.splicing=!0;try{return this._splice(e,t,i)}finally{this.splicing=!1,this._onDidChangeContentHeight.fire(this.contentHeight)}}_splice(e,t,i=[]){const s=this.getRenderRange(this.lastRenderTop,this.lastRenderHeight),o={start:e,end:e+t},n=y.intersect(s,o),h=new Map;for(let r=n.end-1;r>=n.start;r--){const d=this.items[r];if(d.dragStartDisposable.dispose(),d.checkedDisposable.dispose(),d.row){let I=h.get(d.templateId);I||(I=[],h.set(d.templateId,I));const H=this.renderers.get(d.templateId);H&&H.disposeElement&&H.disposeElement(d.element,r,d.row.templateData,d.size),I.unshift(d.row)}d.row=null,d.stale=!0}const l={start:e+t,end:this.items.length},u=y.intersect(l,s),m=y.relativeComplement(l,s),a=i.map(r=>({id:String(this.itemId++),element:r,templateId:this.virtualDelegate.getTemplateId(r),size:this.virtualDelegate.getHeight(r),width:void 0,hasDynamicHeight:!!this.virtualDelegate.hasDynamicHeight&&this.virtualDelegate.hasDynamicHeight(r),lastDynamicHeightWidth:void 0,row:null,uri:void 0,dropTarget:!1,dragStartDisposable:M.None,checkedDisposable:M.None,stale:!1}));let c;e===0&&t>=this.items.length?(this.rangeMap=this.createRangeMap(this.rangeMap.paddingTop),this.rangeMap.splice(0,0,a),c=this.items,this.items=a):(this.rangeMap.splice(e,t,a),c=this.items.splice(e,t,...a));const f=i.length-t,N=this.getRenderRange(this.lastRenderTop,this.lastRenderHeight),W=U(u,f),O=y.intersect(N,W);for(let r=O.start;r<O.end;r++)this.updateItemInDOM(this.items[r],r);const V=y.relativeComplement(W,N);for(const r of V)for(let d=r.start;d<r.end;d++)this.removeItemFromDOM(d);const B=m.map(r=>U(r,f)),G=[{start:e,end:e+i.length},...B].map(r=>y.intersect(N,r)).reverse();for(const r of G)for(let d=r.end-1;d>=r.start;d--){const I=this.items[d],$=h.get(I.templateId)?.pop();this.insertItemInDOM(d,$)}for(const r of h.values())for(const d of r)this.cache.release(d);return this.eventuallyUpdateScrollDimensions(),this.supportDynamicHeights&&this._rerender(this.scrollTop,this.renderHeight),c.map(r=>r.element)}eventuallyUpdateScrollDimensions(){this._scrollHeight=this.contentHeight,this.rowsContainer.style.height=`${this._scrollHeight}px`,this.scrollableElementUpdateDisposable||(this.scrollableElementUpdateDisposable=F(R(this.domNode),()=>{this.scrollableElement.setScrollDimensions({scrollHeight:this.scrollHeight}),this.updateScrollWidth(),this.scrollableElementUpdateDisposable=null}))}eventuallyUpdateScrollWidth(){if(!this.horizontalScrolling){this.scrollableElementWidthDelayer.cancel();return}this.scrollableElementWidthDelayer.trigger(()=>this.updateScrollWidth())}updateScrollWidth(){if(!this.horizontalScrolling)return;let e=0;for(const t of this.items)typeof t.width<"u"&&(e=Math.max(e,t.width));this.scrollWidth=e,this.scrollableElement.setScrollDimensions({scrollWidth:e===0?0:e+10}),this._onDidChangeContentWidth.fire(this.scrollWidth)}updateWidth(e){if(!this.horizontalScrolling||typeof this.scrollWidth>"u")return;const t=this.items[e];this.measureItemWidth(t),typeof t.width<"u"&&t.width>this.scrollWidth&&(this.scrollWidth=t.width,this.scrollableElement.setScrollDimensions({scrollWidth:this.scrollWidth+10}),this._onDidChangeContentWidth.fire(this.scrollWidth))}rerender(){if(this.supportDynamicHeights){for(const e of this.items)e.lastDynamicHeightWidth=void 0;this._rerender(this.lastRenderTop,this.lastRenderHeight)}}get length(){return this.items.length}get renderHeight(){return this.scrollableElement.getScrollDimensions().height}get firstVisibleIndex(){return this.getRenderRange(this.lastRenderTop,this.lastRenderHeight).start}get firstMostlyVisibleIndex(){const e=this.firstVisibleIndex,t=this.rangeMap.positionAt(e),i=this.rangeMap.positionAt(e+1);return i!==-1&&(i-t)/2+t<this.scrollTop?e+1:e}get lastVisibleIndex(){return this.getRenderRange(this.lastRenderTop,this.lastRenderHeight).end-1}element(e){return this.items[e].element}indexOf(e){return this.items.findIndex(t=>t.element===e)}domElement(e){const t=this.items[e].row;return t&&t.domNode}elementHeight(e){return this.items[e].size}elementTop(e){return this.rangeMap.positionAt(e)}indexAt(e){return this.rangeMap.indexAt(e)}indexAfter(e){return this.rangeMap.indexAfter(e)}layout(e,t){const i={height:typeof e=="number"?e:ne(this.domNode)};this.scrollableElementUpdateDisposable&&(this.scrollableElementUpdateDisposable.dispose(),this.scrollableElementUpdateDisposable=null,i.scrollHeight=this.scrollHeight),this.scrollableElement.setScrollDimensions(i),typeof t<"u"&&(this.renderWidth=t,this.supportDynamicHeights&&this._rerender(this.scrollTop,this.renderHeight)),this.horizontalScrolling&&this.scrollableElement.setScrollDimensions({width:typeof t=="number"?t:L(this.domNode)})}render(e,t,i,s,o,n=!1){const h=this.getRenderRange(t,i),l=y.relativeComplement(h,e).reverse(),u=y.relativeComplement(e,h);if(n){const m=y.intersect(e,h);for(let a=m.start;a<m.end;a++)this.updateItemInDOM(this.items[a],a)}this.cache.transact(()=>{for(const m of u)for(let a=m.start;a<m.end;a++)this.removeItemFromDOM(a);for(const m of l)for(let a=m.end-1;a>=m.start;a--)this.insertItemInDOM(a)}),s!==void 0&&(this.rowsContainer.style.left=`-${s}px`),this.rowsContainer.style.top=`-${t}px`,this.horizontalScrolling&&o!==void 0&&(this.rowsContainer.style.width=`${Math.max(o,this.renderWidth)}px`),this.lastRenderTop=t,this.lastRenderHeight=i}insertItemInDOM(e,t){const i=this.items[e];if(!i.row)if(t)i.row=t,i.stale=!0;else{const l=this.cache.alloc(i.templateId);i.row=l.row,i.stale||=l.isReusingConnectedDomNode}const s=this.accessibilityProvider.getRole(i.element)||"listitem";i.row.domNode.setAttribute("role",s);const o=this.accessibilityProvider.isChecked(i.element);if(typeof o=="boolean")i.row.domNode.setAttribute("aria-checked",String(!!o));else if(o){const l=u=>i.row.domNode.setAttribute("aria-checked",String(!!u));l(o.value),i.checkedDisposable=o.onDidChange(()=>l(o.value))}if(i.stale||!i.row.domNode.parentElement){const l=this.items.at(e+1)?.row?.domNode??null;(i.row.domNode.parentElement!==this.rowsContainer||i.row.domNode.nextElementSibling!==l)&&this.rowsContainer.insertBefore(i.row.domNode,l),i.stale=!1}this.updateItemInDOM(i,e);const n=this.renderers.get(i.templateId);if(!n)throw new Error(`No renderer found for template id ${i.templateId}`);n?.renderElement(i.element,e,i.row.templateData,i.size);const h=this.dnd.getDragURI(i.element);i.dragStartDisposable.dispose(),i.row.domNode.draggable=!!h,h&&(i.dragStartDisposable=w(i.row.domNode,"dragstart",l=>this.onDragStart(i.element,h,l))),this.horizontalScrolling&&(this.measureItemWidth(i),this.eventuallyUpdateScrollWidth())}measureItemWidth(e){if(!e.row||!e.row.domNode)return;e.row.domNode.style.width="fit-content",e.width=L(e.row.domNode);const t=R(e.row.domNode).getComputedStyle(e.row.domNode);t.paddingLeft&&(e.width+=Number.parseFloat(t.paddingLeft)),t.paddingRight&&(e.width+=Number.parseFloat(t.paddingRight)),e.row.domNode.style.width=""}updateItemInDOM(e,t){e.row.domNode.style.top=`${this.elementTop(t)}px`,this.setRowHeight&&(e.row.domNode.style.height=`${e.size}px`),this.setRowLineHeight&&(e.row.domNode.style.lineHeight=`${e.size}px`),e.row.domNode.setAttribute("data-index",`${t}`),e.row.domNode.setAttribute("data-last-element",t===this.length-1?"true":"false"),e.row.domNode.setAttribute("data-parity",t%2===0?"even":"odd"),e.row.domNode.setAttribute("aria-setsize",String(this.accessibilityProvider.getSetSize(e.element,t,this.length))),e.row.domNode.setAttribute("aria-posinset",String(this.accessibilityProvider.getPosInSet(e.element,t))),e.row.domNode.setAttribute("id",this.getElementDomId(t)),e.row.domNode.classList.toggle("drop-target",e.dropTarget)}removeItemFromDOM(e){const t=this.items[e];if(t.dragStartDisposable.dispose(),t.checkedDisposable.dispose(),t.row){const i=this.renderers.get(t.templateId);i&&i.disposeElement&&i.disposeElement(t.element,e,t.row.templateData,t.size),this.cache.release(t.row),t.row=null}this.horizontalScrolling&&this.eventuallyUpdateScrollWidth()}getScrollTop(){return this.scrollableElement.getScrollPosition().scrollTop}setScrollTop(e,t){this.scrollableElementUpdateDisposable&&(this.scrollableElementUpdateDisposable.dispose(),this.scrollableElementUpdateDisposable=null,this.scrollableElement.setScrollDimensions({scrollHeight:this.scrollHeight})),this.scrollableElement.setScrollPosition({scrollTop:e,reuseAnimation:t})}getScrollLeft(){return this.scrollableElement.getScrollPosition().scrollLeft}setScrollLeft(e){this.scrollableElementUpdateDisposable&&(this.scrollableElementUpdateDisposable.dispose(),this.scrollableElementUpdateDisposable=null,this.scrollableElement.setScrollDimensions({scrollWidth:this.scrollWidth})),this.scrollableElement.setScrollPosition({scrollLeft:e})}get scrollTop(){return this.getScrollTop()}set scrollTop(e){this.setScrollTop(e)}get scrollHeight(){return this._scrollHeight+(this.horizontalScrolling?10:0)+this.paddingBottom}get onMouseClick(){return p.map(this.disposables.add(new v(this.domNode,"click")).event,e=>this.toMouseEvent(e),this.disposables)}get onMouseDblClick(){return p.map(this.disposables.add(new v(this.domNode,"dblclick")).event,e=>this.toMouseEvent(e),this.disposables)}get onMouseMiddleClick(){return p.filter(p.map(this.disposables.add(new v(this.domNode,"auxclick")).event,e=>this.toMouseEvent(e),this.disposables),e=>e.browserEvent.button===1,this.disposables)}get onMouseUp(){return p.map(this.disposables.add(new v(this.domNode,"mouseup")).event,e=>this.toMouseEvent(e),this.disposables)}get onMouseDown(){return p.map(this.disposables.add(new v(this.domNode,"mousedown")).event,e=>this.toMouseEvent(e),this.disposables)}get onMouseOver(){return p.map(this.disposables.add(new v(this.domNode,"mouseover")).event,e=>this.toMouseEvent(e),this.disposables)}get onMouseMove(){return p.map(this.disposables.add(new v(this.domNode,"mousemove")).event,e=>this.toMouseEvent(e),this.disposables)}get onMouseOut(){return p.map(this.disposables.add(new v(this.domNode,"mouseout")).event,e=>this.toMouseEvent(e),this.disposables)}get onContextMenu(){return p.any(p.map(this.disposables.add(new v(this.domNode,"contextmenu")).event,e=>this.toMouseEvent(e),this.disposables),p.map(this.disposables.add(new v(this.domNode,A.Contextmenu)).event,e=>this.toGestureEvent(e),this.disposables))}get onTouchStart(){return p.map(this.disposables.add(new v(this.domNode,"touchstart")).event,e=>this.toTouchEvent(e),this.disposables)}get onTap(){return p.map(this.disposables.add(new v(this.rowsContainer,A.Tap)).event,e=>this.toGestureEvent(e),this.disposables)}toMouseEvent(e){const t=this.getItemIndexFromEventTarget(e.target||null),i=typeof t>"u"?void 0:this.items[t],s=i&&i.element;return{browserEvent:e,index:t,element:s}}toTouchEvent(e){const t=this.getItemIndexFromEventTarget(e.target||null),i=typeof t>"u"?void 0:this.items[t],s=i&&i.element;return{browserEvent:e,index:t,element:s}}toGestureEvent(e){const t=this.getItemIndexFromEventTarget(e.initialTarget||null),i=typeof t>"u"?void 0:this.items[t],s=i&&i.element;return{browserEvent:e,index:t,element:s}}toDragEvent(e){const t=this.getItemIndexFromEventTarget(e.target||null),i=typeof t>"u"?void 0:this.items[t],s=i&&i.element,o=this.getTargetSector(e,t);return{browserEvent:e,index:t,element:s,sector:o}}onScroll(e){try{const t=this.getRenderRange(this.lastRenderTop,this.lastRenderHeight);this.render(t,e.scrollTop,e.height,e.scrollLeft,e.scrollWidth),this.supportDynamicHeights&&this._rerender(e.scrollTop,e.height,e.inSmoothScrolling)}catch(t){throw t}}onTouchChange(e){e.preventDefault(),e.stopPropagation(),this.scrollTop-=e.translationY}onDragStart(e,t,i){if(!i.dataTransfer)return;const s=this.dnd.getDragElements(e);if(i.dataTransfer.effectAllowed="copyMove",i.dataTransfer.setData(te.TEXT,t),i.dataTransfer.setDragImage){let o;this.dnd.getDragLabel&&(o=this.dnd.getDragLabel(s,i)),typeof o>"u"&&(o=String(s.length));const n=ie(".monaco-drag-image");n.textContent=o,(u=>{for(;u&&!u.classList.contains("monaco-workbench");)u=u.parentElement;return u||this.domNode.ownerDocument})(this.domNode).appendChild(n),i.dataTransfer.setDragImage(n,-10,-10),setTimeout(()=>n.remove(),0)}this.domNode.classList.add("dragging"),this.currentDragData=new ge(s),S.CurrentDragAndDropData=new fe(s),this.dnd.onDragStart?.(this.currentDragData,i)}onDragOver(e){if(e.browserEvent.preventDefault(),this.onDragLeaveTimeout.dispose(),S.CurrentDragAndDropData&&S.CurrentDragAndDropData.getData()==="vscode-ui"||(this.setupDragAndDropScrollTopAnimation(e.browserEvent),!e.browserEvent.dataTransfer))return!1;if(!this.currentDragData)if(S.CurrentDragAndDropData)this.currentDragData=S.CurrentDragAndDropData;else{if(!e.browserEvent.dataTransfer.types)return!1;this.currentDragData=new be}const t=this.dnd.onDragOver(this.currentDragData,e.element,e.index,e.sector,e.browserEvent);if(this.canDrop=typeof t=="boolean"?t:t.accept,!this.canDrop)return this.currentDragFeedback=void 0,this.currentDragFeedbackDisposable.dispose(),!1;e.browserEvent.dataTransfer.dropEffect=typeof t!="boolean"&&t.effect?.type===me.Copy?"copy":"move";let i;typeof t!="boolean"&&t.feedback?i=t.feedback:typeof e.index>"u"?i=[-1]:i=[e.index],i=q(i).filter(o=>o>=-1&&o<this.length).sort((o,n)=>o-n),i=i[0]===-1?[-1]:i;let s=typeof t!="boolean"&&t.effect&&t.effect.position?t.effect.position:C.Over;if(De(this.currentDragFeedback,i)&&this.currentDragFeedbackPosition===s)return!0;if(this.currentDragFeedback=i,this.currentDragFeedbackPosition=s,this.currentDragFeedbackDisposable.dispose(),i[0]===-1)this.domNode.classList.add(s),this.rowsContainer.classList.add(s),this.currentDragFeedbackDisposable=k(()=>{this.domNode.classList.remove(s),this.rowsContainer.classList.remove(s)});else{if(i.length>1&&s!==C.Over)throw new Error("Can't use multiple feedbacks with position different than 'over'");s===C.After&&i[0]<this.length-1&&(i[0]+=1,s=C.Before);for(const o of i){const n=this.items[o];n.dropTarget=!0,n.row?.domNode.classList.add(s)}this.currentDragFeedbackDisposable=k(()=>{for(const o of i){const n=this.items[o];n.dropTarget=!1,n.row?.domNode.classList.remove(s)}})}return!0}onDragLeave(e){this.onDragLeaveTimeout.dispose(),this.onDragLeaveTimeout=x(()=>this.clearDragOverFeedback(),100,this.disposables),this.currentDragData&&this.dnd.onDragLeave?.(this.currentDragData,e.element,e.index,e.browserEvent)}onDrop(e){if(!this.canDrop)return;const t=this.currentDragData;this.teardownDragAndDropScrollTopAnimation(),this.clearDragOverFeedback(),this.domNode.classList.remove("dragging"),this.currentDragData=void 0,S.CurrentDragAndDropData=void 0,!(!t||!e.browserEvent.dataTransfer)&&(e.browserEvent.preventDefault(),t.update(e.browserEvent.dataTransfer),this.dnd.drop(t,e.element,e.index,e.sector,e.browserEvent))}onDragEnd(e){this.canDrop=!1,this.teardownDragAndDropScrollTopAnimation(),this.clearDragOverFeedback(),this.domNode.classList.remove("dragging"),this.currentDragData=void 0,S.CurrentDragAndDropData=void 0,this.dnd.onDragEnd?.(e)}clearDragOverFeedback(){this.currentDragFeedback=void 0,this.currentDragFeedbackPosition=void 0,this.currentDragFeedbackDisposable.dispose(),this.currentDragFeedbackDisposable=M.None}setupDragAndDropScrollTopAnimation(e){if(!this.dragOverAnimationDisposable){const t=oe(this.domNode).top;this.dragOverAnimationDisposable=se(R(this.domNode),this.animateDragAndDropScrollTop.bind(this,t))}this.dragOverAnimationStopDisposable.dispose(),this.dragOverAnimationStopDisposable=x(()=>{this.dragOverAnimationDisposable&&(this.dragOverAnimationDisposable.dispose(),this.dragOverAnimationDisposable=void 0)},1e3,this.disposables),this.dragOverMouseY=e.pageY}animateDragAndDropScrollTop(e){if(this.dragOverMouseY===void 0)return;const t=this.dragOverMouseY-e,i=this.renderHeight-35;t<35?this.scrollTop+=Math.max(-14,Math.floor(.3*(t-35))):t>i&&(this.scrollTop+=Math.min(14,Math.floor(.3*(t-i))))}teardownDragAndDropScrollTopAnimation(){this.dragOverAnimationStopDisposable.dispose(),this.dragOverAnimationDisposable&&(this.dragOverAnimationDisposable.dispose(),this.dragOverAnimationDisposable=void 0)}getTargetSector(e,t){if(t===void 0)return;const i=e.offsetY/this.items[t].size,s=Math.floor(i/.25);return Z(s,0,3)}getItemIndexFromEventTarget(e){const t=this.scrollableElement.getDomNode();let i=e;for(;(le(i)||ae(i))&&i!==this.rowsContainer&&t.contains(i);){const s=i.getAttribute("data-index");if(s){const o=Number(s);if(!isNaN(o))return o}i=i.parentElement}}getRenderRange(e,t){return{start:this.rangeMap.indexAt(e),end:this.rangeMap.indexAfter(e+t-1)}}_rerender(e,t,i){const s=this.getRenderRange(e,t);let o,n;e===this.elementTop(s.start)?(o=s.start,n=0):s.end-s.start>1&&(o=s.start+1,n=this.elementTop(o)-e);let h=0;for(;;){const l=this.getRenderRange(e,t);let u=!1;for(let m=l.start;m<l.end;m++){const a=this.probeDynamicHeight(m);a!==0&&this.rangeMap.splice(m,1,[this.items[m]]),h+=a,u=u||a!==0}if(!u){h!==0&&this.eventuallyUpdateScrollDimensions();const m=y.relativeComplement(s,l);for(const c of m)for(let f=c.start;f<c.end;f++)this.items[f].row&&this.removeItemFromDOM(f);const a=y.relativeComplement(l,s).reverse();for(const c of a)for(let f=c.end-1;f>=c.start;f--)this.insertItemInDOM(f);for(let c=l.start;c<l.end;c++)this.items[c].row&&this.updateItemInDOM(this.items[c],c);if(typeof o=="number"){const c=this.scrollable.getFutureScrollPosition().scrollTop-e,f=this.elementTop(o)-n+c;this.setScrollTop(f,i)}this._onDidChangeContentHeight.fire(this.contentHeight);return}}}probeDynamicHeight(e){const t=this.items[e];if(this.virtualDelegate.getDynamicHeight){const n=this.virtualDelegate.getDynamicHeight(t.element);if(n!==null){const h=t.size;return t.size=n,t.lastDynamicHeightWidth=this.renderWidth,n-h}}if(!t.hasDynamicHeight||t.lastDynamicHeightWidth===this.renderWidth||this.virtualDelegate.hasDynamicHeight&&!this.virtualDelegate.hasDynamicHeight(t.element))return 0;const i=t.size;if(t.row)return t.row.domNode.style.height="",t.size=t.row.domNode.offsetHeight,t.size===0&&re(t.row.domNode,R(t.row.domNode).document.body),t.lastDynamicHeightWidth=this.renderWidth,t.size-i;const{row:s}=this.cache.alloc(t.templateId);s.domNode.style.height="",this.rowsContainer.appendChild(s.domNode);const o=this.renderers.get(t.templateId);if(!o)throw new K("Missing renderer for templateId: "+t.templateId);return o.renderElement(t.element,e,s.templateData,void 0),t.size=s.domNode.offsetHeight,o.disposeElement?.(t.element,e,s.templateData,void 0),this.virtualDelegate.setDynamicHeight?.(t.element,t.size),t.lastDynamicHeightWidth=this.renderWidth,s.domNode.remove(),this.cache.release(s),t.size-i}getElementDomId(e){return`${this.domId}_${e}`}dispose(){for(const e of this.items)if(e.dragStartDisposable.dispose(),e.checkedDisposable.dispose(),e.row){const t=this.renderers.get(e.row.templateId);t&&(t.disposeElement?.(e.element,-1,e.row.templateData,void 0),t.disposeTemplate(e.row.templateData))}this.items=[],this.domNode?.remove(),this.dragOverAnimationDisposable?.dispose(),this.disposables.dispose()}};D([E],g.prototype,"onMouseClick",1),D([E],g.prototype,"onMouseDblClick",1),D([E],g.prototype,"onMouseMiddleClick",1),D([E],g.prototype,"onMouseUp",1),D([E],g.prototype,"onMouseDown",1),D([E],g.prototype,"onMouseOver",1),D([E],g.prototype,"onMouseMove",1),D([E],g.prototype,"onMouseOut",1),D([E],g.prototype,"onContextMenu",1),D([E],g.prototype,"onTouchStart",1),D([E],g.prototype,"onTap",1);let _=g;export{ge as ElementsDragAndDropData,fe as ExternalElementsDragAndDropData,_ as ListView,ue as ListViewTargetSector,be as NativeDragAndDropData};
