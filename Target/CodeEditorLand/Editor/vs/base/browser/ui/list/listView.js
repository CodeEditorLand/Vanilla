var Y=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var D=(b,e,t,i)=>{for(var n=i>1?void 0:i?q(e,t):e,o=b.length-1,s;o>=0;o--)(s=b[o])&&(n=(i?s(e,t,n):s(n))||n);return i&&n&&Y(e,t,n),n};import{DataTransfers as X}from"../../dnd.js";import{$ as j,addDisposableListener as w,animate as J,getContentHeight as K,getContentWidth as L,getTopLeftOffset as Q,getWindow as R,isAncestor as Z,isHTMLElement as ee,isSVGElement as te,scheduleAtNextAnimationFrame as z}from"../../dom.js";import{DomEmitter as v}from"../../event.js";import{EventType as A,Gesture as ie}from"../../touch.js";import{SmoothScrollableElement as ne}from"../scrollbar/scrollableElement.js";import{distinct as se,equals as oe}from"../../../common/arrays.js";import{Delayer as re,disposableTimeout as k}from"../../../common/async.js";import{memoize as E}from"../../../common/decorators.js";import{Emitter as P,Event as p}from"../../../common/event.js";import{Disposable as M,DisposableStore as le,toDisposable as F}from"../../../common/lifecycle.js";import{Range as T}from"../../../common/range.js";import{Scrollable as ae,ScrollbarVisibility as _}from"../../../common/scrollable.js";import{ListDragOverEffectPosition as C,ListDragOverEffectType as de}from"./list.js";import{RangeMap as he,shift as U}from"./rangeMap.js";import{RowCache as me}from"./rowCache.js";import{BugIndicatingError as ce}from"../../../common/errors.js";import{clamp as pe}from"../../../common/numbers.js";const S={CurrentDragAndDropData:void 0};var ue=(n=>(n[n.TOP=0]="TOP",n[n.CENTER_TOP=1]="CENTER_TOP",n[n.CENTER_BOTTOM=2]="CENTER_BOTTOM",n[n.BOTTOM=3]="BOTTOM",n))(ue||{});const y={useShadows:!0,verticalScrollMode:_.Auto,setRowLineHeight:!0,setRowHeight:!0,supportDynamicHeights:!1,dnd:{getDragElements(b){return[b]},getDragURI(){return null},onDragStart(){},onDragOver(){return!1},drop(){},dispose(){}},horizontalScrolling:!1,transformOptimization:!0,alwaysConsumeMouseWheel:!0};class ge{elements;_context;get context(){return this._context}set context(e){this._context=e}constructor(e){this.elements=e}update(){}getData(){return this.elements}}class fe{elements;constructor(e){this.elements=e}update(){}getData(){return this.elements}}class be{types;files;constructor(){this.types=[],this.files=[]}update(e){if(e.types&&this.types.splice(0,this.types.length,...e.types),e.files){this.files.splice(0,this.files.length);for(let t=0;t<e.files.length;t++){const i=e.files.item(t);i&&(i.size||i.type)&&this.files.push(i)}}}getData(){return{types:this.types,files:this.files}}}function De(b,e){return Array.isArray(b)&&Array.isArray(e)?oe(b,e):b===e}class ve{getSetSize;getPosInSet;getRole;isChecked;constructor(e){e?.getSetSize?this.getSetSize=e.getSetSize.bind(e):this.getSetSize=(t,i,n)=>n,e?.getPosInSet?this.getPosInSet=e.getPosInSet.bind(e):this.getPosInSet=(t,i)=>i+1,e?.getRole?this.getRole=e.getRole.bind(e):this.getRole=t=>"listitem",e?.isChecked?this.isChecked=e.isChecked.bind(e):this.isChecked=t=>{}}}const W=class{constructor(e,t,i,n=y){this.virtualDelegate=t;if(n.horizontalScrolling&&n.supportDynamicHeights)throw new Error("Horizontal scrolling and dynamic heights not supported simultaneously");this.items=[],this.itemId=0,this.rangeMap=this.createRangeMap(n.paddingTop??0);for(const s of i)this.renderers.set(s.templateId,s);this.cache=this.disposables.add(new me(this.renderers)),this.lastRenderTop=0,this.lastRenderHeight=0,this.domNode=document.createElement("div"),this.domNode.className="monaco-list",this.domNode.classList.add(this.domId),this.domNode.tabIndex=0,this.domNode.classList.toggle("mouse-support",typeof n.mouseSupport=="boolean"?n.mouseSupport:!0),this._horizontalScrolling=n.horizontalScrolling??y.horizontalScrolling,this.domNode.classList.toggle("horizontal-scrolling",this._horizontalScrolling),this.paddingBottom=typeof n.paddingBottom>"u"?0:n.paddingBottom,this.accessibilityProvider=new ve(n.accessibilityProvider),this.rowsContainer=document.createElement("div"),this.rowsContainer.className="monaco-list-rows",(n.transformOptimization??y.transformOptimization)&&(this.rowsContainer.style.transform="translate3d(0px, 0px, 0px)",this.rowsContainer.style.overflow="hidden",this.rowsContainer.style.contain="strict"),this.disposables.add(ie.addTarget(this.rowsContainer)),this.scrollable=this.disposables.add(new ae({forceIntegerValues:!0,smoothScrollDuration:n.smoothScrolling??!1?125:0,scheduleAtNextAnimationFrame:s=>z(R(this.domNode),s)})),this.scrollableElement=this.disposables.add(new ne(this.rowsContainer,{alwaysConsumeMouseWheel:n.alwaysConsumeMouseWheel??y.alwaysConsumeMouseWheel,horizontal:_.Auto,vertical:n.verticalScrollMode??y.verticalScrollMode,useShadows:n.useShadows??y.useShadows,mouseWheelScrollSensitivity:n.mouseWheelScrollSensitivity,fastScrollSensitivity:n.fastScrollSensitivity,scrollByPage:n.scrollByPage},this.scrollable)),this.domNode.appendChild(this.scrollableElement.getDomNode()),e.appendChild(this.domNode),this.scrollableElement.onScroll(this.onScroll,this,this.disposables),this.disposables.add(w(this.rowsContainer,A.Change,s=>this.onTouchChange(s))),this.disposables.add(w(this.scrollableElement.getDomNode(),"scroll",s=>s.target.scrollTop=0)),this.disposables.add(w(this.domNode,"dragover",s=>this.onDragOver(this.toDragEvent(s)))),this.disposables.add(w(this.domNode,"drop",s=>this.onDrop(this.toDragEvent(s)))),this.disposables.add(w(this.domNode,"dragleave",s=>this.onDragLeave(this.toDragEvent(s)))),this.disposables.add(w(this.domNode,"dragend",s=>this.onDragEnd(s))),this.setRowLineHeight=n.setRowLineHeight??y.setRowLineHeight,this.setRowHeight=n.setRowHeight??y.setRowHeight,this.supportDynamicHeights=n.supportDynamicHeights??y.supportDynamicHeights,this.dnd=n.dnd??this.disposables.add(y.dnd),this.layout(n.initialSize?.height,n.initialSize?.width)}static InstanceCount=0;domId=`list_id_${++W.InstanceCount}`;domNode;items;itemId;rangeMap;cache;renderers=new Map;lastRenderTop;lastRenderHeight;renderWidth=0;rowsContainer;scrollable;scrollableElement;_scrollHeight=0;scrollableElementUpdateDisposable=null;scrollableElementWidthDelayer=new re(50);splicing=!1;dragOverAnimationDisposable;dragOverAnimationStopDisposable=M.None;dragOverMouseY=0;setRowLineHeight;setRowHeight;supportDynamicHeights;paddingBottom;accessibilityProvider;scrollWidth;dnd;canDrop=!1;currentDragData;currentDragFeedback;currentDragFeedbackPosition;currentDragFeedbackDisposable=M.None;onDragLeaveTimeout=M.None;disposables=new le;_onDidChangeContentHeight=new P;_onDidChangeContentWidth=new P;onDidChangeContentHeight=p.latch(this._onDidChangeContentHeight.event,void 0,this.disposables);onDidChangeContentWidth=p.latch(this._onDidChangeContentWidth.event,void 0,this.disposables);get contentHeight(){return this.rangeMap.size}get contentWidth(){return this.scrollWidth??0}get onDidScroll(){return this.scrollableElement.onScroll}get onWillScroll(){return this.scrollableElement.onWillScroll}get containerDomNode(){return this.rowsContainer}get scrollableElementDomNode(){return this.scrollableElement.getDomNode()}_horizontalScrolling=!1;get horizontalScrolling(){return this._horizontalScrolling}set horizontalScrolling(e){if(e!==this._horizontalScrolling){if(e&&this.supportDynamicHeights)throw new Error("Horizontal scrolling and dynamic heights not supported simultaneously");if(this._horizontalScrolling=e,this.domNode.classList.toggle("horizontal-scrolling",this._horizontalScrolling),this._horizontalScrolling){for(const t of this.items)this.measureItemWidth(t);this.updateScrollWidth(),this.scrollableElement.setScrollDimensions({width:L(this.domNode)}),this.rowsContainer.style.width=`${Math.max(this.scrollWidth||0,this.renderWidth)}px`}else this.scrollableElementWidthDelayer.cancel(),this.scrollableElement.setScrollDimensions({width:this.renderWidth,scrollWidth:this.renderWidth}),this.rowsContainer.style.width=""}}updateOptions(e){e.paddingBottom!==void 0&&(this.paddingBottom=e.paddingBottom,this.scrollableElement.setScrollDimensions({scrollHeight:this.scrollHeight})),e.smoothScrolling!==void 0&&this.scrollable.setSmoothScrollDuration(e.smoothScrolling?125:0),e.horizontalScrolling!==void 0&&(this.horizontalScrolling=e.horizontalScrolling);let t;if(e.scrollByPage!==void 0&&(t={...t??{},scrollByPage:e.scrollByPage}),e.mouseWheelScrollSensitivity!==void 0&&(t={...t??{},mouseWheelScrollSensitivity:e.mouseWheelScrollSensitivity}),e.fastScrollSensitivity!==void 0&&(t={...t??{},fastScrollSensitivity:e.fastScrollSensitivity}),t&&this.scrollableElement.updateOptions(t),e.paddingTop!==void 0&&e.paddingTop!==this.rangeMap.paddingTop){const i=this.getRenderRange(this.lastRenderTop,this.lastRenderHeight),n=e.paddingTop-this.rangeMap.paddingTop;this.rangeMap.paddingTop=e.paddingTop,this.render(i,Math.max(0,this.lastRenderTop+n),this.lastRenderHeight,void 0,void 0,!0),this.setScrollTop(this.lastRenderTop),this.eventuallyUpdateScrollDimensions(),this.supportDynamicHeights&&this._rerender(this.lastRenderTop,this.lastRenderHeight)}}delegateScrollFromMouseWheelEvent(e){this.scrollableElement.delegateScrollFromMouseWheelEvent(e)}delegateVerticalScrollbarPointerDown(e){this.scrollableElement.delegateVerticalScrollbarPointerDown(e)}updateElementHeight(e,t,i){if(e<0||e>=this.items.length)return;const n=this.items[e].size;if(typeof t>"u"){if(!this.supportDynamicHeights){console.warn("Dynamic heights not supported",new Error().stack);return}this.items[e].lastDynamicHeightWidth=void 0,t=n+this.probeDynamicHeight(e)}if(n===t)return;const o=this.getRenderRange(this.lastRenderTop,this.lastRenderHeight);let s=0;e<o.start||i!==null&&i>e&&i<o.end?s=t-n:s=0,this.rangeMap.splice(e,1,[{size:t}]),this.items[e].size=t,this.render(o,Math.max(0,this.lastRenderTop+s),this.lastRenderHeight,void 0,void 0,!0),this.setScrollTop(this.lastRenderTop),this.eventuallyUpdateScrollDimensions(),this.supportDynamicHeights&&this._rerender(this.lastRenderTop,this.lastRenderHeight)}createRangeMap(e){return new he(e)}splice(e,t,i=[]){if(this.splicing)throw new Error("Can't run recursive splices.");this.splicing=!0;try{return this._splice(e,t,i)}finally{this.splicing=!1,this._onDidChangeContentHeight.fire(this.contentHeight)}}_splice(e,t,i=[]){const n=this.getRenderRange(this.lastRenderTop,this.lastRenderHeight),o={start:e,end:e+t},s=T.intersect(n,o),h=new Map;for(let r=s.end-1;r>=s.start;r--){const d=this.items[r];if(d.dragStartDisposable.dispose(),d.checkedDisposable.dispose(),d.row){let I=h.get(d.templateId);I||(I=[],h.set(d.templateId,I));const H=this.renderers.get(d.templateId);H&&H.disposeElement&&H.disposeElement(d.element,r,d.row.templateData,d.size),I.unshift(d.row)}d.row=null,d.stale=!0}const l={start:e+t,end:this.items.length},u=T.intersect(l,n),m=T.relativeComplement(l,n),a=i.map(r=>({id:String(this.itemId++),element:r,templateId:this.virtualDelegate.getTemplateId(r),size:this.virtualDelegate.getHeight(r),width:void 0,hasDynamicHeight:!!this.virtualDelegate.hasDynamicHeight&&this.virtualDelegate.hasDynamicHeight(r),lastDynamicHeightWidth:void 0,row:null,uri:void 0,dropTarget:!1,dragStartDisposable:M.None,checkedDisposable:M.None,stale:!1}));let c;e===0&&t>=this.items.length?(this.rangeMap=this.createRangeMap(this.rangeMap.paddingTop),this.rangeMap.splice(0,0,a),c=this.items,this.items=a):(this.rangeMap.splice(e,t,a),c=this.items.splice(e,t,...a));const g=i.length-t,N=this.getRenderRange(this.lastRenderTop,this.lastRenderHeight),x=U(u,g),O=T.intersect(N,x);for(let r=O.start;r<O.end;r++)this.updateItemInDOM(this.items[r],r);const V=T.relativeComplement(x,N);for(const r of V)for(let d=r.start;d<r.end;d++)this.removeItemFromDOM(d);const B=m.map(r=>U(r,g)),G=[{start:e,end:e+i.length},...B].map(r=>T.intersect(N,r)).reverse();for(const r of G)for(let d=r.end-1;d>=r.start;d--){const I=this.items[d],$=h.get(I.templateId)?.pop();this.insertItemInDOM(d,$)}for(const r of h.values())for(const d of r)this.cache.release(d);return this.eventuallyUpdateScrollDimensions(),this.supportDynamicHeights&&this._rerender(this.scrollTop,this.renderHeight),c.map(r=>r.element)}eventuallyUpdateScrollDimensions(){this._scrollHeight=this.contentHeight,this.rowsContainer.style.height=`${this._scrollHeight}px`,this.scrollableElementUpdateDisposable||(this.scrollableElementUpdateDisposable=z(R(this.domNode),()=>{this.scrollableElement.setScrollDimensions({scrollHeight:this.scrollHeight}),this.updateScrollWidth(),this.scrollableElementUpdateDisposable=null}))}eventuallyUpdateScrollWidth(){if(!this.horizontalScrolling){this.scrollableElementWidthDelayer.cancel();return}this.scrollableElementWidthDelayer.trigger(()=>this.updateScrollWidth())}updateScrollWidth(){if(!this.horizontalScrolling)return;let e=0;for(const t of this.items)typeof t.width<"u"&&(e=Math.max(e,t.width));this.scrollWidth=e,this.scrollableElement.setScrollDimensions({scrollWidth:e===0?0:e+10}),this._onDidChangeContentWidth.fire(this.scrollWidth)}updateWidth(e){if(!this.horizontalScrolling||typeof this.scrollWidth>"u")return;const t=this.items[e];this.measureItemWidth(t),typeof t.width<"u"&&t.width>this.scrollWidth&&(this.scrollWidth=t.width,this.scrollableElement.setScrollDimensions({scrollWidth:this.scrollWidth+10}),this._onDidChangeContentWidth.fire(this.scrollWidth))}rerender(){if(this.supportDynamicHeights){for(const e of this.items)e.lastDynamicHeightWidth=void 0;this._rerender(this.lastRenderTop,this.lastRenderHeight)}}get length(){return this.items.length}get renderHeight(){return this.scrollableElement.getScrollDimensions().height}get firstVisibleIndex(){return this.getRenderRange(this.lastRenderTop,this.lastRenderHeight).start}get firstMostlyVisibleIndex(){const e=this.firstVisibleIndex,t=this.rangeMap.positionAt(e),i=this.rangeMap.positionAt(e+1);return i!==-1&&(i-t)/2+t<this.scrollTop?e+1:e}get lastVisibleIndex(){return this.getRenderRange(this.lastRenderTop,this.lastRenderHeight).end-1}element(e){return this.items[e].element}indexOf(e){return this.items.findIndex(t=>t.element===e)}domElement(e){const t=this.items[e].row;return t&&t.domNode}elementHeight(e){return this.items[e].size}elementTop(e){return this.rangeMap.positionAt(e)}indexAt(e){return this.rangeMap.indexAt(e)}indexAfter(e){return this.rangeMap.indexAfter(e)}layout(e,t){const i={height:typeof e=="number"?e:K(this.domNode)};this.scrollableElementUpdateDisposable&&(this.scrollableElementUpdateDisposable.dispose(),this.scrollableElementUpdateDisposable=null,i.scrollHeight=this.scrollHeight),this.scrollableElement.setScrollDimensions(i),typeof t<"u"&&(this.renderWidth=t,this.supportDynamicHeights&&this._rerender(this.scrollTop,this.renderHeight)),this.horizontalScrolling&&this.scrollableElement.setScrollDimensions({width:typeof t=="number"?t:L(this.domNode)})}render(e,t,i,n,o,s=!1){const h=this.getRenderRange(t,i),l=T.relativeComplement(h,e).reverse(),u=T.relativeComplement(e,h);if(s){const m=T.intersect(e,h);for(let a=m.start;a<m.end;a++)this.updateItemInDOM(this.items[a],a)}this.cache.transact(()=>{for(const m of u)for(let a=m.start;a<m.end;a++)this.removeItemFromDOM(a);for(const m of l)for(let a=m.end-1;a>=m.start;a--)this.insertItemInDOM(a)}),n!==void 0&&(this.rowsContainer.style.left=`-${n}px`),this.rowsContainer.style.top=`-${t}px`,this.horizontalScrolling&&o!==void 0&&(this.rowsContainer.style.width=`${Math.max(o,this.renderWidth)}px`),this.lastRenderTop=t,this.lastRenderHeight=i}insertItemInDOM(e,t){const i=this.items[e];if(!i.row)if(t)i.row=t,i.stale=!0;else{const l=this.cache.alloc(i.templateId);i.row=l.row,i.stale||=l.isReusingConnectedDomNode}const n=this.accessibilityProvider.getRole(i.element)||"listitem";i.row.domNode.setAttribute("role",n);const o=this.accessibilityProvider.isChecked(i.element);if(typeof o=="boolean")i.row.domNode.setAttribute("aria-checked",String(!!o));else if(o){const l=u=>i.row.domNode.setAttribute("aria-checked",String(!!u));l(o.value),i.checkedDisposable=o.onDidChange(()=>l(o.value))}if(i.stale||!i.row.domNode.parentElement){const l=this.items.at(e+1)?.row?.domNode??null;(i.row.domNode.parentElement!==this.rowsContainer||i.row.domNode.nextElementSibling!==l)&&this.rowsContainer.insertBefore(i.row.domNode,l),i.stale=!1}this.updateItemInDOM(i,e);const s=this.renderers.get(i.templateId);if(!s)throw new Error(`No renderer found for template id ${i.templateId}`);s?.renderElement(i.element,e,i.row.templateData,i.size);const h=this.dnd.getDragURI(i.element);i.dragStartDisposable.dispose(),i.row.domNode.draggable=!!h,h&&(i.dragStartDisposable=w(i.row.domNode,"dragstart",l=>this.onDragStart(i.element,h,l))),this.horizontalScrolling&&(this.measureItemWidth(i),this.eventuallyUpdateScrollWidth())}measureItemWidth(e){if(!e.row||!e.row.domNode)return;e.row.domNode.style.width="fit-content",e.width=L(e.row.domNode);const t=R(e.row.domNode).getComputedStyle(e.row.domNode);t.paddingLeft&&(e.width+=parseFloat(t.paddingLeft)),t.paddingRight&&(e.width+=parseFloat(t.paddingRight)),e.row.domNode.style.width=""}updateItemInDOM(e,t){e.row.domNode.style.top=`${this.elementTop(t)}px`,this.setRowHeight&&(e.row.domNode.style.height=`${e.size}px`),this.setRowLineHeight&&(e.row.domNode.style.lineHeight=`${e.size}px`),e.row.domNode.setAttribute("data-index",`${t}`),e.row.domNode.setAttribute("data-last-element",t===this.length-1?"true":"false"),e.row.domNode.setAttribute("data-parity",t%2===0?"even":"odd"),e.row.domNode.setAttribute("aria-setsize",String(this.accessibilityProvider.getSetSize(e.element,t,this.length))),e.row.domNode.setAttribute("aria-posinset",String(this.accessibilityProvider.getPosInSet(e.element,t))),e.row.domNode.setAttribute("id",this.getElementDomId(t)),e.row.domNode.classList.toggle("drop-target",e.dropTarget)}removeItemFromDOM(e){const t=this.items[e];if(t.dragStartDisposable.dispose(),t.checkedDisposable.dispose(),t.row){const i=this.renderers.get(t.templateId);i&&i.disposeElement&&i.disposeElement(t.element,e,t.row.templateData,t.size),this.cache.release(t.row),t.row=null}this.horizontalScrolling&&this.eventuallyUpdateScrollWidth()}getScrollTop(){return this.scrollableElement.getScrollPosition().scrollTop}setScrollTop(e,t){this.scrollableElementUpdateDisposable&&(this.scrollableElementUpdateDisposable.dispose(),this.scrollableElementUpdateDisposable=null,this.scrollableElement.setScrollDimensions({scrollHeight:this.scrollHeight})),this.scrollableElement.setScrollPosition({scrollTop:e,reuseAnimation:t})}getScrollLeft(){return this.scrollableElement.getScrollPosition().scrollLeft}setScrollLeft(e){this.scrollableElementUpdateDisposable&&(this.scrollableElementUpdateDisposable.dispose(),this.scrollableElementUpdateDisposable=null,this.scrollableElement.setScrollDimensions({scrollWidth:this.scrollWidth})),this.scrollableElement.setScrollPosition({scrollLeft:e})}get scrollTop(){return this.getScrollTop()}set scrollTop(e){this.setScrollTop(e)}get scrollHeight(){return this._scrollHeight+(this.horizontalScrolling?10:0)+this.paddingBottom}get onMouseClick(){return p.map(this.disposables.add(new v(this.domNode,"click")).event,e=>this.toMouseEvent(e),this.disposables)}get onMouseDblClick(){return p.map(this.disposables.add(new v(this.domNode,"dblclick")).event,e=>this.toMouseEvent(e),this.disposables)}get onMouseMiddleClick(){return p.filter(p.map(this.disposables.add(new v(this.domNode,"auxclick")).event,e=>this.toMouseEvent(e),this.disposables),e=>e.browserEvent.button===1,this.disposables)}get onMouseUp(){return p.map(this.disposables.add(new v(this.domNode,"mouseup")).event,e=>this.toMouseEvent(e),this.disposables)}get onMouseDown(){return p.map(this.disposables.add(new v(this.domNode,"mousedown")).event,e=>this.toMouseEvent(e),this.disposables)}get onMouseOver(){return p.map(this.disposables.add(new v(this.domNode,"mouseover")).event,e=>this.toMouseEvent(e),this.disposables)}get onMouseMove(){return p.map(this.disposables.add(new v(this.domNode,"mousemove")).event,e=>this.toMouseEvent(e),this.disposables)}get onMouseOut(){return p.map(this.disposables.add(new v(this.domNode,"mouseout")).event,e=>this.toMouseEvent(e),this.disposables)}get onContextMenu(){return p.any(p.map(this.disposables.add(new v(this.domNode,"contextmenu")).event,e=>this.toMouseEvent(e),this.disposables),p.map(this.disposables.add(new v(this.domNode,A.Contextmenu)).event,e=>this.toGestureEvent(e),this.disposables))}get onTouchStart(){return p.map(this.disposables.add(new v(this.domNode,"touchstart")).event,e=>this.toTouchEvent(e),this.disposables)}get onTap(){return p.map(this.disposables.add(new v(this.rowsContainer,A.Tap)).event,e=>this.toGestureEvent(e),this.disposables)}toMouseEvent(e){const t=this.getItemIndexFromEventTarget(e.target||null),i=typeof t>"u"?void 0:this.items[t],n=i&&i.element;return{browserEvent:e,index:t,element:n}}toTouchEvent(e){const t=this.getItemIndexFromEventTarget(e.target||null),i=typeof t>"u"?void 0:this.items[t],n=i&&i.element;return{browserEvent:e,index:t,element:n}}toGestureEvent(e){const t=this.getItemIndexFromEventTarget(e.initialTarget||null),i=typeof t>"u"?void 0:this.items[t],n=i&&i.element;return{browserEvent:e,index:t,element:n}}toDragEvent(e){const t=this.getItemIndexFromEventTarget(e.target||null),i=typeof t>"u"?void 0:this.items[t],n=i&&i.element,o=this.getTargetSector(e,t);return{browserEvent:e,index:t,element:n,sector:o}}onScroll(e){try{const t=this.getRenderRange(this.lastRenderTop,this.lastRenderHeight);this.render(t,e.scrollTop,e.height,e.scrollLeft,e.scrollWidth),this.supportDynamicHeights&&this._rerender(e.scrollTop,e.height,e.inSmoothScrolling)}catch(t){throw console.error("Got bad scroll event:",e),t}}onTouchChange(e){e.preventDefault(),e.stopPropagation(),this.scrollTop-=e.translationY}onDragStart(e,t,i){if(!i.dataTransfer)return;const n=this.dnd.getDragElements(e);if(i.dataTransfer.effectAllowed="copyMove",i.dataTransfer.setData(X.TEXT,t),i.dataTransfer.setDragImage){let o;this.dnd.getDragLabel&&(o=this.dnd.getDragLabel(n,i)),typeof o>"u"&&(o=String(n.length));const s=j(".monaco-drag-image");s.textContent=o,(u=>{for(;u&&!u.classList.contains("monaco-workbench");)u=u.parentElement;return u||this.domNode.ownerDocument})(this.domNode).appendChild(s),i.dataTransfer.setDragImage(s,-10,-10),setTimeout(()=>s.remove(),0)}this.domNode.classList.add("dragging"),this.currentDragData=new ge(n),S.CurrentDragAndDropData=new fe(n),this.dnd.onDragStart?.(this.currentDragData,i)}onDragOver(e){if(e.browserEvent.preventDefault(),this.onDragLeaveTimeout.dispose(),S.CurrentDragAndDropData&&S.CurrentDragAndDropData.getData()==="vscode-ui"||(this.setupDragAndDropScrollTopAnimation(e.browserEvent),!e.browserEvent.dataTransfer))return!1;if(!this.currentDragData)if(S.CurrentDragAndDropData)this.currentDragData=S.CurrentDragAndDropData;else{if(!e.browserEvent.dataTransfer.types)return!1;this.currentDragData=new be}const t=this.dnd.onDragOver(this.currentDragData,e.element,e.index,e.sector,e.browserEvent);if(this.canDrop=typeof t=="boolean"?t:t.accept,!this.canDrop)return this.currentDragFeedback=void 0,this.currentDragFeedbackDisposable.dispose(),!1;e.browserEvent.dataTransfer.dropEffect=typeof t!="boolean"&&t.effect?.type===de.Copy?"copy":"move";let i;typeof t!="boolean"&&t.feedback?i=t.feedback:typeof e.index>"u"?i=[-1]:i=[e.index],i=se(i).filter(o=>o>=-1&&o<this.length).sort((o,s)=>o-s),i=i[0]===-1?[-1]:i;let n=typeof t!="boolean"&&t.effect&&t.effect.position?t.effect.position:C.Over;if(De(this.currentDragFeedback,i)&&this.currentDragFeedbackPosition===n)return!0;if(this.currentDragFeedback=i,this.currentDragFeedbackPosition=n,this.currentDragFeedbackDisposable.dispose(),i[0]===-1)this.domNode.classList.add(n),this.rowsContainer.classList.add(n),this.currentDragFeedbackDisposable=F(()=>{this.domNode.classList.remove(n),this.rowsContainer.classList.remove(n)});else{if(i.length>1&&n!==C.Over)throw new Error("Can't use multiple feedbacks with position different than 'over'");n===C.After&&i[0]<this.length-1&&(i[0]+=1,n=C.Before);for(const o of i){const s=this.items[o];s.dropTarget=!0,s.row?.domNode.classList.add(n)}this.currentDragFeedbackDisposable=F(()=>{for(const o of i){const s=this.items[o];s.dropTarget=!1,s.row?.domNode.classList.remove(n)}})}return!0}onDragLeave(e){this.onDragLeaveTimeout.dispose(),this.onDragLeaveTimeout=k(()=>this.clearDragOverFeedback(),100,this.disposables),this.currentDragData&&this.dnd.onDragLeave?.(this.currentDragData,e.element,e.index,e.browserEvent)}onDrop(e){if(!this.canDrop)return;const t=this.currentDragData;this.teardownDragAndDropScrollTopAnimation(),this.clearDragOverFeedback(),this.domNode.classList.remove("dragging"),this.currentDragData=void 0,S.CurrentDragAndDropData=void 0,!(!t||!e.browserEvent.dataTransfer)&&(e.browserEvent.preventDefault(),t.update(e.browserEvent.dataTransfer),this.dnd.drop(t,e.element,e.index,e.sector,e.browserEvent))}onDragEnd(e){this.canDrop=!1,this.teardownDragAndDropScrollTopAnimation(),this.clearDragOverFeedback(),this.domNode.classList.remove("dragging"),this.currentDragData=void 0,S.CurrentDragAndDropData=void 0,this.dnd.onDragEnd?.(e)}clearDragOverFeedback(){this.currentDragFeedback=void 0,this.currentDragFeedbackPosition=void 0,this.currentDragFeedbackDisposable.dispose(),this.currentDragFeedbackDisposable=M.None}setupDragAndDropScrollTopAnimation(e){if(!this.dragOverAnimationDisposable){const t=Q(this.domNode).top;this.dragOverAnimationDisposable=J(R(this.domNode),this.animateDragAndDropScrollTop.bind(this,t))}this.dragOverAnimationStopDisposable.dispose(),this.dragOverAnimationStopDisposable=k(()=>{this.dragOverAnimationDisposable&&(this.dragOverAnimationDisposable.dispose(),this.dragOverAnimationDisposable=void 0)},1e3,this.disposables),this.dragOverMouseY=e.pageY}animateDragAndDropScrollTop(e){if(this.dragOverMouseY===void 0)return;const t=this.dragOverMouseY-e,i=this.renderHeight-35;t<35?this.scrollTop+=Math.max(-14,Math.floor(.3*(t-35))):t>i&&(this.scrollTop+=Math.min(14,Math.floor(.3*(t-i))))}teardownDragAndDropScrollTopAnimation(){this.dragOverAnimationStopDisposable.dispose(),this.dragOverAnimationDisposable&&(this.dragOverAnimationDisposable.dispose(),this.dragOverAnimationDisposable=void 0)}getTargetSector(e,t){if(t===void 0)return;const i=e.offsetY/this.items[t].size,n=Math.floor(i/.25);return pe(n,0,3)}getItemIndexFromEventTarget(e){const t=this.scrollableElement.getDomNode();let i=e;for(;(ee(i)||te(i))&&i!==this.rowsContainer&&t.contains(i);){const n=i.getAttribute("data-index");if(n){const o=Number(n);if(!isNaN(o))return o}i=i.parentElement}}getRenderRange(e,t){return{start:this.rangeMap.indexAt(e),end:this.rangeMap.indexAfter(e+t-1)}}_rerender(e,t,i){const n=this.getRenderRange(e,t);let o,s;e===this.elementTop(n.start)?(o=n.start,s=0):n.end-n.start>1&&(o=n.start+1,s=this.elementTop(o)-e);let h=0;for(;;){const l=this.getRenderRange(e,t);let u=!1;for(let m=l.start;m<l.end;m++){const a=this.probeDynamicHeight(m);a!==0&&this.rangeMap.splice(m,1,[this.items[m]]),h+=a,u=u||a!==0}if(!u){h!==0&&this.eventuallyUpdateScrollDimensions();const m=T.relativeComplement(n,l);for(const c of m)for(let g=c.start;g<c.end;g++)this.items[g].row&&this.removeItemFromDOM(g);const a=T.relativeComplement(l,n).reverse();for(const c of a)for(let g=c.end-1;g>=c.start;g--)this.insertItemInDOM(g);for(let c=l.start;c<l.end;c++)this.items[c].row&&this.updateItemInDOM(this.items[c],c);if(typeof o=="number"){const c=this.scrollable.getFutureScrollPosition().scrollTop-e,g=this.elementTop(o)-s+c;this.setScrollTop(g,i)}this._onDidChangeContentHeight.fire(this.contentHeight);return}}}probeDynamicHeight(e){const t=this.items[e];if(this.virtualDelegate.getDynamicHeight){const s=this.virtualDelegate.getDynamicHeight(t.element);if(s!==null){const h=t.size;return t.size=s,t.lastDynamicHeightWidth=this.renderWidth,s-h}}if(!t.hasDynamicHeight||t.lastDynamicHeightWidth===this.renderWidth||this.virtualDelegate.hasDynamicHeight&&!this.virtualDelegate.hasDynamicHeight(t.element))return 0;const i=t.size;if(t.row)return t.row.domNode.style.height="",t.size=t.row.domNode.offsetHeight,t.size===0&&!Z(t.row.domNode,R(t.row.domNode).document.body)&&console.warn("Measuring item node that is not in DOM! Add ListView to the DOM before measuring row height!",new Error().stack),t.lastDynamicHeightWidth=this.renderWidth,t.size-i;const{row:n}=this.cache.alloc(t.templateId);n.domNode.style.height="",this.rowsContainer.appendChild(n.domNode);const o=this.renderers.get(t.templateId);if(!o)throw new ce("Missing renderer for templateId: "+t.templateId);return o.renderElement(t.element,e,n.templateData,void 0),t.size=n.domNode.offsetHeight,o.disposeElement?.(t.element,e,n.templateData,void 0),this.virtualDelegate.setDynamicHeight?.(t.element,t.size),t.lastDynamicHeightWidth=this.renderWidth,n.domNode.remove(),this.cache.release(n),t.size-i}getElementDomId(e){return`${this.domId}_${e}`}dispose(){for(const e of this.items)if(e.dragStartDisposable.dispose(),e.checkedDisposable.dispose(),e.row){const t=this.renderers.get(e.row.templateId);t&&(t.disposeElement?.(e.element,-1,e.row.templateData,void 0),t.disposeTemplate(e.row.templateData))}this.items=[],this.domNode?.remove(),this.dragOverAnimationDisposable?.dispose(),this.disposables.dispose()}};let f=W;D([E],f.prototype,"onMouseClick",1),D([E],f.prototype,"onMouseDblClick",1),D([E],f.prototype,"onMouseMiddleClick",1),D([E],f.prototype,"onMouseUp",1),D([E],f.prototype,"onMouseDown",1),D([E],f.prototype,"onMouseOver",1),D([E],f.prototype,"onMouseMove",1),D([E],f.prototype,"onMouseOut",1),D([E],f.prototype,"onContextMenu",1),D([E],f.prototype,"onTouchStart",1),D([E],f.prototype,"onTap",1);export{ge as ElementsDragAndDropData,fe as ExternalElementsDragAndDropData,f as ListView,ue as ListViewTargetSector,be as NativeDragAndDropData};
