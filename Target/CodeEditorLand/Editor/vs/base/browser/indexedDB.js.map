{
  "version": 3,
  "sources": ["../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/base/browser/indexedDB.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { toErrorMessage } from '../common/errorMessage.js';\nimport { ErrorNoTelemetry, getErrorMessage } from '../common/errors.js';\nimport { mark } from '../common/performance.js';\n\nclass MissingStoresError extends Error {\n\tconstructor(readonly db: IDBDatabase) {\n\t\tsuper('Missing stores');\n\t}\n}\n\nexport class DBClosedError extends Error {\n\treadonly code = 'DBClosed';\n\tconstructor(dbName: string) {\n\t\tsuper(`IndexedDB database '${dbName}' is closed.`);\n\t}\n}\n\nexport class IndexedDB {\n\n\tstatic async create(name: string, version: number | undefined, stores: string[]): Promise<IndexedDB> {\n\t\tconst database = await IndexedDB.openDatabase(name, version, stores);\n\t\treturn new IndexedDB(database, name);\n\t}\n\n\tprivate static async openDatabase(name: string, version: number | undefined, stores: string[]): Promise<IDBDatabase> {\n\t\tmark(`code/willOpenDatabase/${name}`);\n\t\ttry {\n\t\t\treturn await IndexedDB.doOpenDatabase(name, version, stores);\n\t\t} catch (err) {\n\t\t\tif (err instanceof MissingStoresError) {\n\t\t\t\tconsole.info(`Attempting to recreate the IndexedDB once.`, name);\n\n\t\t\t\ttry {\n\t\t\t\t\t// Try to delete the db\n\t\t\t\t\tawait IndexedDB.deleteDatabase(err.db);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconsole.error(`Error while deleting the IndexedDB`, getErrorMessage(error));\n\t\t\t\t\tthrow error;\n\t\t\t\t}\n\n\t\t\t\treturn await IndexedDB.doOpenDatabase(name, version, stores);\n\t\t\t}\n\n\t\t\tthrow err;\n\t\t} finally {\n\t\t\tmark(`code/didOpenDatabase/${name}`);\n\t\t}\n\t}\n\n\tprivate static doOpenDatabase(name: string, version: number | undefined, stores: string[]): Promise<IDBDatabase> {\n\t\treturn new Promise((c, e) => {\n\t\t\tconst request = indexedDB.open(name, version);\n\t\t\trequest.onerror = () => e(request.error);\n\t\t\trequest.onsuccess = () => {\n\t\t\t\tconst db = request.result;\n\t\t\t\tfor (const store of stores) {\n\t\t\t\t\tif (!db.objectStoreNames.contains(store)) {\n\t\t\t\t\t\tconsole.error(`Error while opening IndexedDB. Could not find '${store}'' object store`);\n\t\t\t\t\t\te(new MissingStoresError(db));\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tc(db);\n\t\t\t};\n\t\t\trequest.onupgradeneeded = () => {\n\t\t\t\tconst db = request.result;\n\t\t\t\tfor (const store of stores) {\n\t\t\t\t\tif (!db.objectStoreNames.contains(store)) {\n\t\t\t\t\t\tdb.createObjectStore(store);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t});\n\t}\n\n\tprivate static deleteDatabase(database: IDBDatabase): Promise<void> {\n\t\treturn new Promise((c, e) => {\n\t\t\t// Close any opened connections\n\t\t\tdatabase.close();\n\n\t\t\t// Delete the db\n\t\t\tconst deleteRequest = indexedDB.deleteDatabase(database.name);\n\t\t\tdeleteRequest.onerror = (err) => e(deleteRequest.error);\n\t\t\tdeleteRequest.onsuccess = () => c();\n\t\t});\n\t}\n\n\tprivate database: IDBDatabase | null = null;\n\tprivate readonly pendingTransactions: IDBTransaction[] = [];\n\n\tconstructor(database: IDBDatabase, private readonly name: string) {\n\t\tthis.database = database;\n\t}\n\n\thasPendingTransactions(): boolean {\n\t\treturn this.pendingTransactions.length > 0;\n\t}\n\n\tclose(): void {\n\t\tif (this.pendingTransactions.length) {\n\t\t\tthis.pendingTransactions.splice(0, this.pendingTransactions.length).forEach(transaction => transaction.abort());\n\t\t}\n\t\tthis.database?.close();\n\t\tthis.database = null;\n\t}\n\n\trunInTransaction<T>(store: string, transactionMode: IDBTransactionMode, dbRequestFn: (store: IDBObjectStore) => IDBRequest<T>[]): Promise<T[]>;\n\trunInTransaction<T>(store: string, transactionMode: IDBTransactionMode, dbRequestFn: (store: IDBObjectStore) => IDBRequest<T>): Promise<T>;\n\tasync runInTransaction<T>(store: string, transactionMode: IDBTransactionMode, dbRequestFn: (store: IDBObjectStore) => IDBRequest<T> | IDBRequest<T>[]): Promise<T | T[]> {\n\t\tif (!this.database) {\n\t\t\tthrow new DBClosedError(this.name);\n\t\t}\n\t\tconst transaction = this.database.transaction(store, transactionMode);\n\t\tthis.pendingTransactions.push(transaction);\n\t\treturn new Promise<T | T[]>((c, e) => {\n\t\t\ttransaction.oncomplete = () => {\n\t\t\t\tif (Array.isArray(request)) {\n\t\t\t\t\tc(request.map(r => r.result));\n\t\t\t\t} else {\n\t\t\t\t\tc(request.result);\n\t\t\t\t}\n\t\t\t};\n\t\t\ttransaction.onerror = () => e(transaction.error ? ErrorNoTelemetry.fromError(transaction.error) : new ErrorNoTelemetry('unknown error'));\n\t\t\ttransaction.onabort = () => e(transaction.error ? ErrorNoTelemetry.fromError(transaction.error) : new ErrorNoTelemetry('unknown error'));\n\t\t\tconst request = dbRequestFn(transaction.objectStore(store));\n\t\t}).finally(() => this.pendingTransactions.splice(this.pendingTransactions.indexOf(transaction), 1));\n\t}\n\n\tasync getKeyValues<V>(store: string, isValid: (value: unknown) => value is V): Promise<Map<string, V>> {\n\t\tif (!this.database) {\n\t\t\tthrow new DBClosedError(this.name);\n\t\t}\n\t\tconst transaction = this.database.transaction(store, 'readonly');\n\t\tthis.pendingTransactions.push(transaction);\n\t\treturn new Promise<Map<string, V>>(resolve => {\n\t\t\tconst items = new Map<string, V>();\n\n\t\t\tconst objectStore = transaction.objectStore(store);\n\n\t\t\t// Open a IndexedDB Cursor to iterate over key/values\n\t\t\tconst cursor = objectStore.openCursor();\n\t\t\tif (!cursor) {\n\t\t\t\treturn resolve(items); // this means the `ItemTable` was empty\n\t\t\t}\n\n\t\t\t// Iterate over rows of `ItemTable` until the end\n\t\t\tcursor.onsuccess = () => {\n\t\t\t\tif (cursor.result) {\n\n\t\t\t\t\t// Keep cursor key/value in our map\n\t\t\t\t\tif (isValid(cursor.result.value)) {\n\t\t\t\t\t\titems.set(cursor.result.key.toString(), cursor.result.value);\n\t\t\t\t\t}\n\n\t\t\t\t\t// Advance cursor to next row\n\t\t\t\t\tcursor.result.continue();\n\t\t\t\t} else {\n\t\t\t\t\tresolve(items); // reached end of table\n\t\t\t\t}\n\t\t\t};\n\n\t\t\t// Error handlers\n\t\t\tconst onError = (error: Error | null) => {\n\t\t\t\tconsole.error(`IndexedDB getKeyValues(): ${toErrorMessage(error, true)}`);\n\n\t\t\t\tresolve(items);\n\t\t\t};\n\t\t\tcursor.onerror = () => onError(cursor.error);\n\t\t\ttransaction.onerror = () => onError(transaction.error);\n\t\t}).finally(() => this.pendingTransactions.splice(this.pendingTransactions.indexOf(transaction), 1));\n\t}\n}\n"],
  "mappings": "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",
  "names": []
}
