import{onUnexpectedError as j}from"../common/errors.js";import{Event as F}from"../common/event.js";import{escapeDoubleQuotes as L,parseHrefAndDimensions as K,removeMarkdownEscapes as E}from"../common/htmlContent.js";import{markdownEscapeEscapedIcons as V}from"../common/iconLabels.js";import{defaultGenerator as O}from"../common/idGenerator.js";import{KeyCode as D}from"../common/keyCodes.js";import{Lazy as $}from"../common/lazy.js";import{DisposableStore as z,toDisposable as Z}from"../common/lifecycle.js";import*as g from"../common/marked/marked.js";import{parse as G}from"../common/marshalling.js";import{FileAccess as J,Schemas as p}from"../common/network.js";import{cloneAndChange as Q}from"../common/objects.js";import{dirname as Y,resolvePath as P}from"../common/resources.js";import{escape as R}from"../common/strings.js";import{URI as b}from"../common/uri.js";import*as T from"./dom.js";import*as A from"./dompurify/dompurify.js";import{DomEmitter as _}from"./event.js";import{createElement as X}from"./formattedTextRenderer.js";import{StandardKeyboardEvent as ee}from"./keyboardEvent.js";import{StandardMouseEvent as te}from"./mouseEvent.js";import{renderLabelWithIcons as re}from"./ui/iconLabel/iconLabels.js";const M=Object.freeze({image:({href:e,title:t,text:n})=>{let a=[],i=[];return e&&({href:e,dimensions:a}=K(e),i.push(`src="${L(e)}"`)),n&&i.push(`alt="${L(n)}"`),t&&i.push(`title="${L(t)}"`),a.length&&(i=i.concat(a)),"<img "+i.join(" ")+">"},paragraph({tokens:e}){return`<p>${this.parser.parseInline(e)}</p>`},link({href:e,title:t,tokens:n}){let a=this.parser.parseInline(n);return typeof e!="string"?"":(e===a&&(a=E(a)),t=typeof t=="string"?L(E(t)):"",e=E(e),e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"),`<a href="${e}" title="${t||e}" draggable="false">${a}</a>`)}});function je(e,t={},n={}){const a=new z;let i=!1;const r=X(t),d=s=>{let o;try{o=G(decodeURIComponent(s))}catch{}return o?(o=Q(o,c=>{if(e.uris&&e.uris[c])return b.revive(e.uris[c])}),encodeURIComponent(JSON.stringify(o))):s},m=(s,o)=>{const c=e.uris&&e.uris[s];let l=b.revive(c);return o?s.startsWith(p.data+":")?s:(l||(l=b.parse(s)),J.uriToBrowserUri(l).toString(!0)):!l||b.parse(s).toString()===l.toString()?s:(l.query&&(l=l.with({query:d(l.query)})),l.toString())},f=new g.Renderer;f.image=M.image,f.link=M.link,f.paragraph=M.paragraph;const h=[],x=[];if(t.codeBlockRendererSync?f.code=({text:s,lang:o})=>{const c=O.nextId(),l=t.codeBlockRendererSync(B(o),s);return x.push([c,l]),`<div class="code" data-code="${c}">${R(s)}</div>`}:t.codeBlockRenderer&&(f.code=({text:s,lang:o})=>{const c=O.nextId(),l=t.codeBlockRenderer(B(o),s);return h.push(l.then(u=>[c,u])),`<div class="code" data-code="${c}">${R(s)}</div>`}),t.actionHandler){const s=l=>{const u=l.target.closest("a[data-href]");if(T.isHTMLElement(u))try{let I=u.dataset.href;I&&(e.baseUri&&(I=C(b.from(e.baseUri),I)),t.actionHandler.callback(I,l))}catch(I){j(I)}finally{l.preventDefault()}},o=t.actionHandler.disposables.add(new _(r,"click")),c=t.actionHandler.disposables.add(new _(r,"auxclick"));t.actionHandler.disposables.add(F.any(o.event,c.event)(l=>{const u=new te(T.getWindow(r),l);!u.leftButton&&!u.middleButton||s(u)})),t.actionHandler.disposables.add(T.addDisposableListener(r,"keydown",l=>{const u=new ee(l);!u.equals(D.Space)&&!u.equals(D.Enter)||s(u)}))}e.supportHtml||(f.html=({text:s})=>t.sanitizerOptions?.replaceWithPlaintext?R(s):(e.isTrusted?s.match(/^(<span[^>]+>)|(<\/\s*span>)$/):void 0)?s:""),n.renderer=f;let k=e.value??"";k.length>1e5&&(k=`${k.substr(0,1e5)}\u2026`),e.supportThemeIcons&&(k=V(k));let w;if(t.fillInIncompleteTokens){const s={...g.defaults,...n},o=g.lexer(k,s),c=fe(o);w=g.parser(c,s)}else w=g.parse(k,{...n,async:!1});e.supportThemeIcons&&(w=re(w).map(o=>typeof o=="string"?o:o.outerHTML).join(""));const S=new DOMParser().parseFromString(H({isTrusted:e.isTrusted,...t.sanitizerOptions},w),"text/html");if(S.body.querySelectorAll("img, audio, video, source").forEach(s=>{const o=s.getAttribute("src");if(o){let c=o;try{e.baseUri&&(c=C(b.from(e.baseUri),c))}catch{}if(s.setAttribute("src",m(c,!0)),t.remoteImageIsAllowed){const l=b.parse(c);l.scheme!==p.file&&l.scheme!==p.data&&!t.remoteImageIsAllowed(l)&&s.replaceWith(T.$("",void 0,s.outerHTML))}}}),S.body.querySelectorAll("a").forEach(s=>{const o=s.getAttribute("href");if(s.setAttribute("href",""),!o||/^data:|javascript:/i.test(o)||/^command:/i.test(o)&&!e.isTrusted||/^command:(\/\/\/)?_workbench\.downloadResource/i.test(o))s.replaceWith(...s.childNodes);else{let c=m(o,!1);e.baseUri&&(c=C(b.from(e.baseUri),o)),s.dataset.href=c}}),r.innerHTML=H({isTrusted:e.isTrusted,...t.sanitizerOptions},S.body.innerHTML),h.length>0)Promise.all(h).then(s=>{if(i)return;const o=new Map(s),c=r.querySelectorAll("div[data-code]");for(const l of c){const u=o.get(l.dataset.code??"");u&&T.reset(l,u)}t.asyncRenderCallback?.()});else if(x.length>0){const s=new Map(x),o=r.querySelectorAll("div[data-code]");for(const c of o){const l=s.get(c.dataset.code??"");l&&T.reset(c,l)}}if(t.asyncRenderCallback)for(const s of r.getElementsByTagName("img")){const o=a.add(T.addDisposableListener(s,"load",()=>{o.dispose(),t.asyncRenderCallback()}))}return{element:r,dispose:()=>{i=!0,a.dispose()}}}function B(e){if(!e)return"";const t=e.split(/[\s+|:|,|{|?]/,1);return t.length?t[0]:e}function C(e,t){return/^\w[\w\d+.-]*:/.test(t)?t:e.path.endsWith("/")?P(e,t).toString():P(Y(e),t).toString()}const ne=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"];function H(e,t){const{config:n,allowedSchemes:a}=se(e),i=new z;i.add(q("uponSanitizeAttribute",(r,d)=>{if(d.attrName==="style"||d.attrName==="class"){if(r.tagName==="SPAN"){if(d.attrName==="style"){d.keepAttr=/^(color:(#[0-9a-fA-F]+|var\(--vscode(-[a-zA-Z0-9]+)+\));)?(background-color:(#[0-9a-fA-F]+|var\(--vscode(-[a-zA-Z0-9]+)+\));)?(border-radius:[0-9]+px;)?$/.test(d.attrValue);return}else if(d.attrName==="class"){d.keepAttr=/^codicon codicon-[a-z-]+( codicon-modifier-[a-z-]+)?$/.test(d.attrValue);return}}d.keepAttr=!1;return}else if(r.tagName==="INPUT"&&r.attributes.getNamedItem("type")?.value==="checkbox"){if(d.attrName==="type"&&d.attrValue==="checkbox"||d.attrName==="disabled"||d.attrName==="checked"){d.keepAttr=!0;return}d.keepAttr=!1}})),i.add(q("uponSanitizeElement",(r,d)=>{if(d.tagName==="input"&&(r.attributes.getNamedItem("type")?.value==="checkbox"?r.setAttribute("disabled",""):e.replaceWithPlaintext||r.remove()),e.replaceWithPlaintext&&!d.allowedTags[d.tagName]&&d.tagName!=="body"&&r.parentElement){let m,f;if(d.tagName==="#comment")m=`<!--${r.textContent}-->`;else{const w=ne.includes(d.tagName),N=r.attributes.length?" "+Array.from(r.attributes).map(S=>`${S.name}="${S.value}"`).join(" "):"";m=`<${d.tagName}${N}>`,w||(f=`</${d.tagName}>`)}const h=document.createDocumentFragment(),x=r.parentElement.ownerDocument.createTextNode(m);h.appendChild(x);const k=f?r.parentElement.ownerDocument.createTextNode(f):void 0;for(;r.firstChild;)h.appendChild(r.firstChild);k&&h.appendChild(k),r.parentElement.replaceChild(h,r)}})),i.add(T.hookDomPurifyHrefAndSrcSanitizer(a));try{return A.sanitize(t,{...n,RETURN_TRUSTED_TYPE:!0})}finally{i.dispose()}}const ae=["align","autoplay","alt","checked","class","colspan","controls","data-code","data-href","disabled","draggable","height","href","loop","muted","playsinline","poster","rowspan","src","style","target","title","type","width","start"];function se(e){const t=[p.http,p.https,p.mailto,p.data,p.file,p.vscodeFileResource,p.vscodeRemote,p.vscodeRemoteResource];return e.isTrusted&&t.push(p.command),{config:{ALLOWED_TAGS:e.allowedTags??[...T.basicMarkupHtmlTags],ALLOWED_ATTR:ae,ALLOW_UNKNOWN_PROTOCOLS:!0},allowedSchemes:t}}function Fe(e){return typeof e=="string"?e:ie(e)}function ie(e,t){let n=e.value??"";n.length>1e5&&(n=`${n.substr(0,1e5)}\u2026`);const a=g.parse(n,{async:!1,renderer:t?le.value:de.value});return H({isTrusted:!1},a).toString().replace(/&(#\d+|[a-zA-Z]+);/g,i=>oe.get(i)??i)}const oe=new Map([["&quot;",'"'],["&nbsp;"," "],["&amp;","&"],["&#39;","'"],["&lt;","<"],["&gt;",">"]]);function U(){const e=new g.Renderer;return e.code=({text:t})=>t,e.blockquote=({text:t})=>t+`
`,e.html=t=>"",e.heading=function({tokens:t}){return this.parser.parseInline(t)+`
`},e.hr=()=>"",e.list=function({items:t}){return t.map(n=>this.listitem(n)).join(`
`)+`
`},e.listitem=({text:t})=>t+`
`,e.paragraph=function({tokens:t}){return this.parser.parseInline(t)+`
`},e.table=function({header:t,rows:n}){return t.map(a=>this.tablecell(a)).join(" ")+`
`+n.map(a=>a.map(i=>this.tablecell(i)).join(" ")).join(`
`)+`
`},e.tablerow=({text:t})=>t,e.tablecell=function({tokens:t}){return this.parser.parseInline(t)},e.strong=({text:t})=>t,e.em=({text:t})=>t,e.codespan=({text:t})=>t,e.br=t=>`
`,e.del=({text:t})=>t,e.image=t=>"",e.text=({text:t})=>t,e.link=({text:t})=>t,e}const de=new $(e=>U()),le=new $(()=>{const e=U();return e.code=({text:t})=>`
\`\`\`
${t}
\`\`\`
`,e});function v(e){let t="";return e.forEach(n=>{t+=n.raw}),t}function W(e){if(e.tokens)for(let t=e.tokens.length-1;t>=0;t--){const n=e.tokens[t];if(n.type==="text"){const a=n.raw.split(`
`),i=a[a.length-1];if(i.includes("`"))return ge(e);if(i.includes("**"))return Se(e);if(i.match(/\*\w/))return Te(e);if(i.match(/(^|\s)__\w/))return Ie(e);if(i.match(/(^|\s)_\w/))return he(e);if(ce(i)||ue(i)&&e.tokens.slice(0,t).some(r=>r.type==="text"&&r.raw.match(/\[[^\]]*$/))){const r=e.tokens.slice(t+1);return r[0]?.type==="link"&&r[1]?.type==="text"&&r[1].raw.match(/^ *"[^"]*$/)||i.match(/^[^"]* +"[^"]*$/)?ye(e):be(e)}else if(i.match(/(^|\s)\[\w*/))return we(e)}}}function ce(e){return!!e.match(/(^|\s)\[.*\]\(\w*/)}function ue(e){return!!e.match(/^[^[]*\]\([^)]*$/)}function me(e){const t=e.items[e.items.length-1],n=t.tokens?t.tokens[t.tokens.length-1]:void 0;let a;if(n?.type==="text"&&!("inRawBlock"in t)&&(a=W(n)),!a||a.type!=="paragraph")return;const i=v(e.items.slice(0,-1)),r=t.raw.match(/^(\s*(-|\d+\.|\*) +)/)?.[0];if(!r)return;const d=r+v(t.tokens.slice(0,-1))+a.raw,m=g.lexer(i+d)[0];if(m.type==="list")return m}const pe=3;function fe(e){for(let t=0;t<pe;t++){const n=ke(e);if(n)e=n;else break}return e}function ke(e){let t,n;for(t=0;t<e.length;t++){const a=e[t];if(a.type==="paragraph"&&a.raw.match(/(\n|^)\|/)){n=xe(e.slice(t));break}if(t===e.length-1&&a.type==="list"){const i=me(a);if(i){n=[i];break}}if(t===e.length-1&&a.type==="paragraph"){const i=W(a);if(i){n=[i];break}}}if(n){const a=[...e.slice(0,t),...n];return a.links=e.links,a}return null}function ge(e){return y(e,"`")}function Te(e){return y(e,"*")}function he(e){return y(e,"_")}function be(e){return y(e,")")}function ye(e){return y(e,'")')}function we(e){return y(e,"](https://microsoft.com)")}function Se(e){return y(e,"**")}function Ie(e){return y(e,"__")}function y(e,t){const n=v(Array.isArray(e)?e:[e]);return g.lexer(n+t)[0]}function xe(e){const t=v(e),n=t.split(`
`);let a,i=!1;for(let r=0;r<n.length;r++){const d=n[r].trim();if(typeof a>"u"&&d.match(/^\s*\|/)){const m=d.match(/(\|[^|]+)(?=\||$)/g);m&&(a=m.length)}else if(typeof a=="number")if(d.match(/^\s*\|/)){if(r!==n.length-1)return;i=!0}else return}if(typeof a=="number"&&a>0){const r=i?n.slice(0,-1).join(`
`):t,d=!!r.match(/\|\s*$/),m=r+(d?"":"|")+`
|${" --- |".repeat(a)}`;return g.lexer(m)}}function q(e,t){return A.addHook(e,t),Z(()=>A.removeHook(e))}export{ae as allowedMarkdownAttr,fe as fillInIncompleteTokens,je as renderMarkdown,ie as renderMarkdownAsPlaintext,Fe as renderStringAsPlaintext};
