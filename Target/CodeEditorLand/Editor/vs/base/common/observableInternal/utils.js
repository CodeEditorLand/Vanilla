import{strictEquals as h}from"../../../../vs/base/common/equals.js";import{BugIndicatingError as D}from"../../../../vs/base/common/errors.js";import{Event as w}from"../../../../vs/base/common/event.js";import{DisposableStore as T,toDisposable as f}from"../../../../vs/base/common/lifecycle.js";import{autorun as p,autorunOpts as _}from"../../../../vs/base/common/observableInternal/autorun.js";import{_setKeepObserved as E,_setRecomputeInitiallyAndOnChange as V,BaseObservable as v,ConvenientObservable as x,observableValue as c,subtransaction as S,transaction as g}from"../../../../vs/base/common/observableInternal/base.js";import{DebugNameData as b,getDebugName as N}from"../../../../vs/base/common/observableInternal/debugName.js";import{derived as A,derivedOpts as m}from"../../../../vs/base/common/observableInternal/derived.js";import{getLogger as O}from"../../../../vs/base/common/observableInternal/logging.js";function ae(t){return new F(t)}class F extends x{constructor(e){super();this.value=e}get debugName(){return this.toString()}get(){return this.value}addObserver(e){}removeObserver(e){}toString(){return`Const: ${this.value}`}}function se(t){const n=c("promiseValue",{});return t.then(e=>{n.set({value:e},void 0)}),n}function l(...t){let n,e,r;return t.length===3?[n,e,r]=t:[e,r]=t,new u(new b(n,void 0,r),e,r,()=>u.globalTransaction,h)}function ie(t,n,e){return new u(new b(t.owner,t.debugName,t.debugReferenceFn??e),n,e,()=>u.globalTransaction,t.equalsFn??h)}class u extends v{constructor(e,r,a,s,i){super();this._debugNameData=e;this.event=r;this._getValue=a;this._getTransaction=s;this._equalityComparator=i}static globalTransaction;value;hasValue=!1;subscription;getDebugName(){return this._debugNameData.getDebugName(this)}get debugName(){const e=this.getDebugName();return"From Event"+(e?`: ${e}`:"")}onFirstObserverAdded(){this.subscription=this.event(this.handleEvent)}handleEvent=e=>{const r=this._getValue(e),a=this.value,s=!this.hasValue||!this._equalityComparator(a,r);let i=!1;s&&(this.value=r,this.hasValue&&(i=!0,S(this._getTransaction(),o=>{O()?.handleFromEventObservableTriggered(this,{oldValue:a,newValue:r,change:void 0,didChange:s,hadValue:this.hasValue});for(const d of this.observers)o.updateObserver(d,this),d.handleChange(this,void 0)},()=>{const o=this.getDebugName();return"Event fired"+(o?`: ${o}`:"")})),this.hasValue=!0),i||O()?.handleFromEventObservableTriggered(this,{oldValue:a,newValue:r,change:void 0,didChange:s,hadValue:this.hasValue})};onLastObserverRemoved(){this.subscription.dispose(),this.subscription=void 0,this.hasValue=!1,this.value=void 0}get(){return this.subscription?(this.hasValue||this.handleEvent(void 0),this.value):this._getValue(void 0)}}(e=>{e.Observer=u;function n(r,a){let s=!1;u.globalTransaction===void 0&&(u.globalTransaction=r,s=!0);try{a()}finally{s&&(u.globalTransaction=void 0)}}e.batchEventsGlobally=n})(l||={});function oe(t,n){return new R(t,n)}class R extends v{constructor(e,r){super();this.debugName=e;this.event=r}subscription;onFirstObserverAdded(){this.subscription=this.event(this.handleEvent)}handleEvent=()=>{g(e=>{for(const r of this.observers)e.updateObserver(r,this),r.handleChange(this,void 0)},()=>this.debugName)};onLastObserverRemoved(){this.subscription.dispose(),this.subscription=void 0}get(){}}function k(t){return typeof t=="string"?new I(t):new I(void 0,t)}class I extends v{constructor(e,r){super();this._debugName=e;this._owner=r}get debugName(){return new b(this._owner,this._debugName,void 0).getDebugName(this)??"Observable Signal"}toString(){return this.debugName}trigger(e,r){if(!e){g(a=>{this.trigger(a,r)},()=>`Trigger signal ${this.debugName}`);return}for(const a of this.observers)e.updateObserver(a,this),a.handleChange(this,r)}get(){}}function de(t,n,e){const r=c("debounced",void 0);let a;return e.add(p(s=>{const i=t.read(s);a&&clearTimeout(a),a=setTimeout(()=>{g(o=>{r.set(i,o)})},n)})),r}function ue(t,n){let e=!1,r,a;return l(s=>{const i=p(o=>{const d=t.read(o);e?(a&&clearTimeout(a),a=setTimeout(()=>{r=d,s()},n)):(e=!0,r=d)});return{dispose(){i.dispose(),e=!1,r=void 0}}},()=>e?r:t.get())}function le(t,n,e){const r=c("triggeredRecently",!1);let a;return e.add(t(()=>{r.set(!0,void 0),a&&clearTimeout(a),a=setTimeout(()=>{r.set(!1,void 0)},n)})),r}function W(t){const n=new y(!1,void 0);return t.addObserver(n),f(()=>{t.removeObserver(n)})}E(W);function q(t,n){const e=new y(!0,n);return t.addObserver(e),n?n(t.get()):t.reportChanges(),f(()=>{t.removeObserver(e)})}V(q);class y{constructor(n,e){this._forceRecompute=n;this._handleValue=e}_counter=0;beginUpdate(n){this._counter++}endUpdate(n){this._counter--,this._counter===0&&this._forceRecompute&&(this._handleValue?this._handleValue(n.get()):n.reportChanges())}handlePossibleChange(n){}handleChange(n,e){}}function K(t,n){let e;return m({owner:t,debugReferenceFn:n},a=>(e=n(a,e),e))}function be(t,n){let e;const r=k("derivedObservableWithWritableCache"),a=A(t,s=>(r.read(s),e=n(s,e),e));return Object.assign(a,{clearCache:s=>{e=void 0,r.trigger(s)},setCache:(s,i)=>{e=s,r.trigger(i)}})}function ve(t,n,e,r){let a=new C(e,r);return m({debugReferenceFn:e,owner:t,onLastObserverRemoved:()=>{a.dispose(),a=new C(e)}},i=>(a.setItems(n.read(i)),a.getItems()))}class C{constructor(n,e){this._map=n;this._keySelector=e}_cache=new Map;_items=[];dispose(){this._cache.forEach(n=>n.store.dispose()),this._cache.clear()}setItems(n){const e=[],r=new Set(this._cache.keys());for(const a of n){const s=this._keySelector?this._keySelector(a):a;let i=this._cache.get(s);if(i)r.delete(s);else{const o=new T;i={out:this._map(a,o),store:o},this._cache.set(s,i)}e.push(i.out)}for(const a of r)this._cache.get(a).store.dispose(),this._cache.delete(a);this._items=e}getItems(){return this._items}}class L{constructor(n){this.observable=n}get onDidChange(){return w.fromObservableLight(this.observable)}get value(){return this.observable.get()}}function ce(t,n){return n instanceof L?n.observable:l(t,n.onDidChange,()=>n.value)}function ge(t,n){if(n.length===0)throw new D;let e=!1,r;const a=l(t,s=>{const i=new T;for(const o of n)i.add(_({debugName:()=>N(a,new b(t,void 0,void 0))+".updateLastChangedValue"},d=>{e=!0,r=o.read(d),s()}));return i.add({dispose(){e=!1,r=void 0}}),i},()=>e?r:n[n.length-1].get());return a}function he(t,n){return K(t,(e,r)=>r??n(e))}export{u as FromEventObservable,y as KeepAliveObserver,L as ValueWithChangeEventFromObservable,ae as constObservable,de as debouncedObservable,ue as debouncedObservable2,he as derivedConstOnceDefined,K as derivedObservableWithCache,be as derivedObservableWithWritableCache,W as keepObserved,ge as latestChangedValue,ve as mapObservableArrayCached,l as observableFromEvent,ie as observableFromEventOpts,se as observableFromPromise,ce as observableFromValueWithChangeEvent,k as observableSignal,oe as observableSignalFromEvent,q as recomputeInitiallyAndOnChange,le as wasEventTriggeredRecently};
