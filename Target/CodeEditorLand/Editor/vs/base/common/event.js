import{onUnexpectedError as L}from"./errors.js";import{createSingleCallFunction as Y}from"./functional.js";import{combinedDisposable as J,Disposable as C,DisposableMap as X,DisposableStore as Q,toDisposable as U}from"./lifecycle.js";import{LinkedList as z}from"./linkedList.js";import{StopWatch as Z}from"./stopwatch.js";const ee=!1,N=!1,te=!1;var W;(_=>{_.None=()=>C.None;function e(i){if(te){const{onDidAddListener:t}=i,s=I.create();let n=0;i.onDidAddListener=()=>{++n===2&&(console.warn("snapshotted emitter LIKELY used public and SHOULD HAVE BEEN created with DisposableStore. snapshotted here"),s.print()),t?.()}}}function r(i,t){return j(i,()=>{},0,void 0,!0,void 0,t)}_.defer=r;function l(i){return(t,s=null,n)=>{let o=!1,a;return a=i(h=>{if(!o)return a?a.dispose():o=!0,t.call(s,h)},null,n),o&&a.dispose(),a}}_.once=l;function u(i,t){return _.once(_.filter(i,t))}_.onceIf=u;function c(i,t,s){return O((n,o=null,a)=>i(h=>n.call(o,t(h)),null,a),s)}_.map=c;function f(i,t,s){return O((n,o=null,a)=>i(h=>{t(h),n.call(o,h)},null,a),s)}_.forEach=f;function p(i,t,s){return O((n,o=null,a)=>i(h=>t(h)&&n.call(o,h),null,a),s)}_.filter=p;function d(i){return i}_.signal=d;function m(...i){return(t,s=null,n)=>{const o=J(...i.map(a=>a(h=>t.call(s,h))));return H(o,n)}}_.any=m;function A(i,t,s,n){let o=s;return c(i,a=>(o=t(o,a),o),n)}_.reduce=A;function O(i,t){let s;const n={onWillAddFirstListener(){s=i(o.fire,o)},onDidRemoveLastListener(){s?.dispose()}};t||e(n);const o=new b(n);return t?.add(o),o.event}function H(i,t){return t instanceof Array?t.push(i):t&&t.add(i),i}function j(i,t,s=100,n=!1,o=!1,a,h){let T,E,y,w=0,g;const P={leakWarningThreshold:a,onWillAddFirstListener(){T=i(K=>{w++,E=t(E,K),n&&!y&&(x.fire(E),E=void 0),g=()=>{const B=E;E=void 0,y=void 0,(!n||w>1)&&x.fire(B),w=0},typeof s=="number"?(clearTimeout(y),y=setTimeout(g,s)):y===void 0&&(y=0,queueMicrotask(g))})},onWillRemoveListener(){o&&w>0&&g?.()},onDidRemoveLastListener(){g=void 0,T.dispose()}};h||e(P);const x=new b(P);return h?.add(x),x.event}_.debounce=j;function ue(i,t=0,s){return _.debounce(i,(n,o)=>n?(n.push(o),n):[o],t,void 0,!0,void 0,s)}_.accumulate=ue;function de(i,t=(n,o)=>n===o,s){let n=!0,o;return p(i,a=>{const h=n||!t(a,o);return n=!1,o=a,h},s)}_.latch=de;function he(i,t,s){return[_.filter(i,t,s),_.filter(i,n=>!t(n),s)]}_.split=he;function ve(i,t=!1,s=[],n){let o=s.slice(),a=i(E=>{o?o.push(E):T.fire(E)});n&&n.add(a);const h=()=>{o?.forEach(E=>T.fire(E)),o=null},T=new b({onWillAddFirstListener(){a||(a=i(E=>T.fire(E)),n&&n.add(a))},onDidAddFirstListener(){o&&(t?setTimeout(h):h())},onDidRemoveLastListener(){a&&a.dispose(),a=null}});return n&&n.add(T),T.event}_.buffer=ve;function ce(i,t){return(n,o,a)=>{const h=t(new V);return i(function(T){const E=h.evaluate(T);E!==k&&n.call(o,E)},void 0,a)}}_.chain=ce;const k=Symbol("HaltChainable");class V{steps=[];map(t){return this.steps.push(t),this}forEach(t){return this.steps.push(s=>(t(s),s)),this}filter(t){return this.steps.push(s=>t(s)?s:k),this}reduce(t,s){let n=s;return this.steps.push(o=>(n=t(n,o),n)),this}latch(t=(s,n)=>s===n){let s=!0,n;return this.steps.push(o=>{const a=s||!t(o,n);return s=!1,n=o,a?o:k}),this}evaluate(t){for(const s of this.steps)if(t=s(t),t===k)break;return t}}function pe(i,t,s=n=>n){const n=(...T)=>h.fire(s(...T)),o=()=>i.on(t,n),a=()=>i.removeListener(t,n),h=new b({onWillAddFirstListener:o,onDidRemoveLastListener:a});return h.event}_.fromNodeEventEmitter=pe;function fe(i,t,s=n=>n){const n=(...T)=>h.fire(s(...T)),o=()=>i.addEventListener(t,n),a=()=>i.removeEventListener(t,n),h=new b({onWillAddFirstListener:o,onDidRemoveLastListener:a});return h.event}_.fromDOMEventEmitter=fe;function Te(i){return new Promise(t=>l(i)(t))}_.toPromise=Te;function me(i){const t=new b;return i.then(s=>{t.fire(s)},()=>{t.fire(void 0)}).finally(()=>{t.dispose()}),t.event}_.fromPromise=me;function Ee(i,t){return i(s=>t.fire(s))}_.forward=Ee;function be(i,t,s){return t(s),i(n=>t(n))}_.runAndSubscribe=be;class G{constructor(t,s){this._observable=t;const n={onWillAddFirstListener:()=>{t.addObserver(this),this._observable.reportChanges()},onDidRemoveLastListener:()=>{t.removeObserver(this)}};s||e(n),this.emitter=new b(n),s&&s.add(this.emitter)}emitter;_counter=0;_hasChanged=!1;beginUpdate(t){this._counter++}handlePossibleChange(t){}handleChange(t,s){this._hasChanged=!0}endUpdate(t){this._counter--,this._counter===0&&(this._observable.reportChanges(),this._hasChanged&&(this._hasChanged=!1,this.emitter.fire(this._observable.get())))}}function _e(i,t){return new G(i,t).emitter.event}_.fromObservable=_e;function ye(i){return(t,s,n)=>{let o=0,a=!1;const h={beginUpdate(){o++},endUpdate(){o--,o===0&&(i.reportChanges(),a&&(a=!1,t.call(s)))},handlePossibleChange(){},handleChange(){a=!0}};i.addObserver(h),i.reportChanges();const T={dispose(){i.removeObserver(h)}};return n instanceof Q?n.add(T):Array.isArray(n)&&n.push(T),T}}_.fromObservableLight=ye})(W||={});class F{static all=new Set;static _idPool=0;name;listenerCount=0;invocationCount=0;elapsedOverall=0;durations=[];_stopWatch;constructor(e){this.name=`${e}_${F._idPool++}`,F.all.add(this)}start(e){this._stopWatch=new Z,this.listenerCount=e}stop(){if(this._stopWatch){const e=this._stopWatch.elapsed();this.durations.push(e),this.elapsedOverall+=e,this.invocationCount+=1,this._stopWatch=void 0}}}let D=-1;function We(v){const e=D;return D=v,{dispose(){D=e}}}class M{constructor(e,r,l=(M._idPool++).toString(16).padStart(3,"0")){this._errorHandler=e;this.threshold=r;this.name=l}static _idPool=1;_stacks;_warnCountdown=0;dispose(){this._stacks?.clear()}check(e,r){const l=this.threshold;if(l<=0||r<l)return;this._stacks||(this._stacks=new Map);const u=this._stacks.get(e.value)||0;if(this._stacks.set(e.value,u+1),this._warnCountdown-=1,this._warnCountdown<=0){this._warnCountdown=l*.5;const[c,f]=this.getMostFrequentStack(),p=`[${this.name}] potential listener LEAK detected, having ${r} listeners already. MOST frequent listener (${f}):`;console.warn(p),console.warn(c);const d=new ne(p,c);this._errorHandler(d)}return()=>{const c=this._stacks.get(e.value)||0;this._stacks.set(e.value,c-1)}}getMostFrequentStack(){if(!this._stacks)return;let e,r=0;for(const[l,u]of this._stacks)(!e||r<u)&&(e=[l,u],r=u);return e}}class I{constructor(e){this.value=e}static create(){const e=new Error;return new I(e.stack??"")}print(){console.warn(this.value.split(`
`).slice(2).join(`
`))}}class ne extends Error{constructor(e,r){super(e),this.name="ListenerLeakError",this.stack=r}}class ie extends Error{constructor(e,r){super(e),this.name="ListenerRefusalError",this.stack=r}}let se=0;class S{constructor(e){this.value=e}stack;id=se++}const re=2,q=(v,e)=>{if(v instanceof S)e(v);else for(let r=0;r<v.length;r++){const l=v[r];l&&e(l)}};let R;if(ee){const v=[];setInterval(()=>{v.length!==0&&(console.warn("[LEAKING LISTENERS] GC'ed these listeners that were NOT yet disposed:"),console.warn(v.join(`
`)),v.length=0)},3e3),R=new FinalizationRegistry(e=>{typeof e=="string"&&v.push(e)})}class b{_options;_leakageMon;_perfMon;_disposed;_event;_listeners;_deliveryQueue;_size=0;constructor(e){this._options=e,this._leakageMon=D>0||this._options?.leakWarningThreshold?new M(e?.onListenerError??L,this._options?.leakWarningThreshold??D):void 0,this._perfMon=this._options?._profName?new F(this._options._profName):void 0,this._deliveryQueue=this._options?.deliveryQueue}dispose(){if(!this._disposed){if(this._disposed=!0,this._deliveryQueue?.current===this&&this._deliveryQueue.reset(),this._listeners){if(N){const e=this._listeners;queueMicrotask(()=>{q(e,r=>r.stack?.print())})}this._listeners=void 0,this._size=0}this._options?.onDidRemoveLastListener?.(),this._leakageMon?.dispose()}}get event(){return this._event??=(e,r,l)=>{if(this._leakageMon&&this._size>this._leakageMon.threshold**2){const d=`[${this._leakageMon.name}] REFUSES to accept new listeners because it exceeded its threshold by far (${this._size} vs ${this._leakageMon.threshold})`;console.warn(d);const m=this._leakageMon.getMostFrequentStack()??["UNKNOWN stack",-1],A=new ie(`${d}. HINT: Stack shows most frequent listener (${m[1]}-times)`,m[0]);return(this._options?.onListenerError||L)(A),C.None}if(this._disposed)return C.None;r&&(e=e.bind(r));const u=new S(e);let c,f;this._leakageMon&&this._size>=Math.ceil(this._leakageMon.threshold*.2)&&(u.stack=I.create(),c=this._leakageMon.check(u.stack,this._size+1)),N&&(u.stack=f??I.create()),this._listeners?this._listeners instanceof S?(this._deliveryQueue??=new $,this._listeners=[this._listeners,u]):this._listeners.push(u):(this._options?.onWillAddFirstListener?.(this),this._listeners=u,this._options?.onDidAddFirstListener?.(this)),this._size++;const p=U(()=>{R?.unregister(p),c?.(),this._removeListener(u)});if(l instanceof Q?l.add(p):Array.isArray(l)&&l.push(p),R){const d=new Error().stack.split(`
`).slice(2,3).join(`
`).trim(),m=/(file:|vscode-file:\/\/vscode-app)?(\/[^:]*:\d+:\d+)/.exec(d);R.register(p,m?.[2]??d,p)}return p},this._event}_removeListener(e){if(this._options?.onWillRemoveListener?.(this),!this._listeners)return;if(this._size===1){this._listeners=void 0,this._options?.onDidRemoveLastListener?.(this),this._size=0;return}const r=this._listeners,l=r.indexOf(e);if(l===-1)throw console.log("disposed?",this._disposed),console.log("size?",this._size),console.log("arr?",JSON.stringify(this._listeners)),new Error("Attempted to dispose unknown listener");this._size--,r[l]=void 0;const u=this._deliveryQueue.current===this;if(this._size*re<=r.length){let c=0;for(let f=0;f<r.length;f++)r[f]?r[c++]=r[f]:u&&(this._deliveryQueue.end--,c<this._deliveryQueue.i&&this._deliveryQueue.i--);r.length=c}}_deliver(e,r){if(!e)return;const l=this._options?.onListenerError||L;if(!l){e.value(r);return}try{e.value(r)}catch(u){l(u)}}_deliverQueue(e){const r=e.current._listeners;for(;e.i<e.end;)this._deliver(r[e.i++],e.value);e.reset()}fire(e){if(this._deliveryQueue?.current&&(this._deliverQueue(this._deliveryQueue),this._perfMon?.stop()),this._perfMon?.start(this._size),this._listeners)if(this._listeners instanceof S)this._deliver(this._listeners,e);else{const r=this._deliveryQueue;r.enqueue(this,e,this._listeners.length),this._deliverQueue(r)}this._perfMon?.stop()}hasListeners(){return this._size>0}}const Me=()=>new $;class ${i=-1;end=0;current;value;enqueue(e,r,l){this.i=0,this.end=l,this.current=e,this.value=r}reset(){this.i=this.end,this.current=void 0,this.value=void 0}}class Ae extends b{_asyncDeliveryQueue;async fireAsync(e,r,l){if(this._listeners)for(this._asyncDeliveryQueue||(this._asyncDeliveryQueue=new z),q(this._listeners,u=>this._asyncDeliveryQueue.push([u.value,e]));this._asyncDeliveryQueue.size>0&&!r.isCancellationRequested;){const[u,c]=this._asyncDeliveryQueue.shift(),f=[],p={...c,token:r,waitUntil:d=>{if(Object.isFrozen(f))throw new Error("waitUntil can NOT be called asynchronous");l&&(d=l(d,u)),f.push(d)}};try{u(p)}catch(d){L(d);continue}Object.freeze(f),await Promise.allSettled(f).then(d=>{for(const m of d)m.status==="rejected"&&L(m.reason)})}}}class oe extends b{_isPaused=0;_eventQueue=new z;_mergeFn;get isPaused(){return this._isPaused!==0}constructor(e){super(e),this._mergeFn=e?.merge}pause(){this._isPaused++}resume(){if(this._isPaused!==0&&--this._isPaused===0)if(this._mergeFn){if(this._eventQueue.size>0){const e=Array.from(this._eventQueue);this._eventQueue.clear(),super.fire(this._mergeFn(e))}}else for(;!this._isPaused&&this._eventQueue.size!==0;)super.fire(this._eventQueue.shift())}fire(e){this._size&&(this._isPaused!==0?this._eventQueue.push(e):super.fire(e))}}class Pe extends oe{_delay;_handle;constructor(e){super(e),this._delay=e.delay??100}fire(e){this._handle||(this.pause(),this._handle=setTimeout(()=>{this._handle=void 0,this.resume()},this._delay)),super.fire(e)}}class Ue extends b{_queuedEvents=[];_mergeFn;constructor(e){super(e),this._mergeFn=e?.merge}fire(e){this.hasListeners()&&(this._queuedEvents.push(e),this._queuedEvents.length===1&&queueMicrotask(()=>{this._mergeFn?super.fire(this._mergeFn(this._queuedEvents)):this._queuedEvents.forEach(r=>super.fire(r)),this._queuedEvents=[]}))}}class ae{emitter;hasListeners=!1;events=[];constructor(){this.emitter=new b({onWillAddFirstListener:()=>this.onFirstListenerAdd(),onDidRemoveLastListener:()=>this.onLastListenerRemove()})}get event(){return this.emitter.event}add(e){const r={event:e,listener:null};return this.events.push(r),this.hasListeners&&this.hook(r),U(Y(()=>{this.hasListeners&&this.unhook(r);const u=this.events.indexOf(r);this.events.splice(u,1)}))}onFirstListenerAdd(){this.hasListeners=!0,this.events.forEach(e=>this.hook(e))}onLastListenerRemove(){this.hasListeners=!1,this.events.forEach(e=>this.unhook(e))}hook(e){e.listener=e.event(r=>this.emitter.fire(r))}unhook(e){e.listener?.dispose(),e.listener=null}dispose(){this.emitter.dispose();for(const e of this.events)e.listener?.dispose();this.events=[]}}class ze{_store=new Q;event;constructor(e,r,l,u){const c=this._store.add(new ae),f=this._store.add(new X);function p(d){f.set(d,c.add(u(d)))}for(const d of e)p(d);this._store.add(r(d=>{p(d)})),this._store.add(l(d=>{f.deleteAndDispose(d)})),this.event=c.event}dispose(){this._store.dispose()}}class Ne{data=[];wrapEvent(e,r,l){return(u,c,f)=>e(p=>{const d=this.data[this.data.length-1];if(!r){d?d.buffers.push(()=>u.call(c,p)):u.call(c,p);return}const m=d;if(!m){u.call(c,r(l,p));return}m.items??=[],m.items.push(p),m.buffers.length===0&&d.buffers.push(()=>{m.reducedResult??=l?m.items.reduce(r,l):m.items.reduce(r),u.call(c,m.reducedResult)})},void 0,f)}bufferEvents(e){const r={buffers:new Array};this.data.push(r);const l=e();return this.data.pop(),r.buffers.forEach(u=>u()),l}}class qe{listening=!1;inputEvent=W.None;inputEventListener=C.None;emitter=new b({onDidAddFirstListener:()=>{this.listening=!0,this.inputEventListener=this.inputEvent(this.emitter.fire,this.emitter)},onDidRemoveLastListener:()=>{this.listening=!1,this.inputEventListener.dispose()}});event=this.emitter.event;set input(e){this.inputEvent=e,this.listening&&(this.inputEventListener.dispose(),this.inputEventListener=e(this.emitter.fire,this.emitter))}dispose(){this.inputEventListener.dispose(),this.emitter.dispose()}}class $e{constructor(e){this._value=e}static const(e){return new le(e)}_onDidChange=new b;onDidChange=this._onDidChange.event;get value(){return this._value}set value(e){e!==this._value&&(this._value=e,this._onDidChange.fire(void 0))}}class le{constructor(e){this.value=e}onDidChange=W.None}export{Ae as AsyncEmitter,Pe as DebounceEmitter,ze as DynamicListEventMultiplexer,b as Emitter,W as Event,Ne as EventBufferer,ae as EventMultiplexer,F as EventProfiling,ne as ListenerLeakError,ie as ListenerRefusalError,Ue as MicrotaskEmitter,oe as PauseableEmitter,qe as Relay,$e as ValueWithChangeEvent,Me as createEventDeliveryQueue,We as setGlobalLeakWarningThreshold};
