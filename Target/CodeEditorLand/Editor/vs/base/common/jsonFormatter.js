import{createScanner as w,ScanError as F,SyntaxKind as e}from"./json.js";function K(t,o,r){let l,f,s,u,T;if(o){for(u=o.offset,T=u+o.length,s=u;s>0&&!L(t,s-1);)s--;let i=T;for(;i<t.length&&!L(t,i);)i++;f=t.substring(s,i),l=y(f,r)}else f=t,l=0,s=0,u=0,T=t.length;const v=z(r,t);let g=!1,b=0,h;r.insertSpaces?h=C(" ",r.tabSize||4):h="	";const c=w(f,!1);let d=!1;function k(){return v+C(h,l+b)}function S(){let i=c.scan();for(g=!1;i===e.Trivia||i===e.LineBreakTrivia;)g=g||i===e.LineBreakTrivia,i=c.scan();return d=i===e.Unknown||c.getTokenError()!==F.None,i}const O=[];function p(i,n,a){!d&&n<T&&a>u&&t.substring(n,a)!==i&&O.push({offset:n,length:a-n,content:i})}let m=S();if(m!==e.EOF){const i=c.getTokenOffset()+s,n=C(h,l);p(n,s,i)}for(;m!==e.EOF;){let i=c.getTokenOffset()+c.getTokenLength()+s,n=S(),a="";for(;!g&&(n===e.LineCommentTrivia||n===e.BlockCommentTrivia);){const E=c.getTokenOffset()+s;p(" ",i,E),i=c.getTokenOffset()+c.getTokenLength()+s,a=n===e.LineCommentTrivia?k():"",n=S()}if(n===e.CloseBraceToken)m!==e.OpenBraceToken&&(b--,a=k());else if(n===e.CloseBracketToken)m!==e.OpenBracketToken&&(b--,a=k());else{switch(m){case e.OpenBracketToken:case e.OpenBraceToken:b++,a=k();break;case e.CommaToken:case e.LineCommentTrivia:a=k();break;case e.BlockCommentTrivia:g?a=k():a=" ";break;case e.ColonToken:a=" ";break;case e.StringLiteral:if(n===e.ColonToken){a="";break}case e.NullKeyword:case e.TrueKeyword:case e.FalseKeyword:case e.NumericLiteral:case e.CloseBraceToken:case e.CloseBracketToken:n===e.LineCommentTrivia||n===e.BlockCommentTrivia?a=" ":n!==e.CommaToken&&n!==e.EOF&&(d=!0);break;case e.Unknown:d=!0;break}g&&(n===e.LineCommentTrivia||n===e.BlockCommentTrivia)&&(a=k())}const B=c.getTokenOffset()+s;p(a,i,B),m=n}return O}function N(t,o){const r=JSON.stringify(t,void 0,o.insertSpaces?o.tabSize||4:"	");return o.eol!==void 0?r.replace(/\r\n|\r|\n/g,o.eol):r}function C(t,o){let r="";for(let l=0;l<o;l++)r+=t;return r}function y(t,o){let r=0,l=0;const f=o.tabSize||4;for(;r<t.length;){const s=t.charAt(r);if(s===" ")l++;else if(s==="	")l+=f;else break;r++}return Math.floor(l/f)}function z(t,o){for(let r=0;r<o.length;r++){const l=o.charAt(r);if(l==="\r")return r+1<o.length&&o.charAt(r+1)===`
`?`\r
`:"\r";if(l===`
`)return`
`}return t&&t.eol||`
`}function L(t,o){return`\r
`.indexOf(t.charAt(o))!==-1}export{K as format,z as getEOL,L as isEOL,N as toFormattedString};
