import l from"assert";import{ObjectTreeModel as a}from"../../../../browser/ui/tree/objectTreeModel.js";import{ObjectTreeElementCollapseState as p,TreeVisibility as m}from"../../../../browser/ui/tree/tree.js";import{timeout as u}from"../../../../common/async.js";import{ensureNoDisposablesAreLeakedInTestSuite as h}from"../../../common/utils.js";import"../../../../common/lifecycle.js";function d(t,e){return e.onDidSpliceRenderedNodes(({start:s,deleteCount:r,elements:o})=>{t.splice(s,r,...o)})}function n(t){return t.map(e=>e.element)}suite("ObjectTreeModel",function(){h(),test("ctor",()=>{const t=[],e=new a("test"),s=d(t,e);l(e),l.strictEqual(t.length,0),l.strictEqual(e.size,0),s.dispose()}),test("flat",()=>{const t=[],e=new a("test"),s=d(t,e);e.setChildren(null,[{element:0},{element:1},{element:2}]),l.deepStrictEqual(n(t),[0,1,2]),l.strictEqual(e.size,3),e.setChildren(null,[{element:3},{element:4},{element:5}]),l.deepStrictEqual(n(t),[3,4,5]),l.strictEqual(e.size,3),e.setChildren(null),l.deepStrictEqual(n(t),[]),l.strictEqual(e.size,0),s.dispose()}),test("nested",()=>{const t=[],e=new a("test"),s=d(t,e);e.setChildren(null,[{element:0,children:[{element:10},{element:11},{element:12}]},{element:1},{element:2}]),l.deepStrictEqual(n(t),[0,10,11,12,1,2]),l.strictEqual(e.size,6),e.setChildren(12,[{element:120},{element:121}]),l.deepStrictEqual(n(t),[0,10,11,12,120,121,1,2]),l.strictEqual(e.size,8),e.setChildren(0),l.deepStrictEqual(n(t),[0,1,2]),l.strictEqual(e.size,3),e.setChildren(null),l.deepStrictEqual(n(t),[]),l.strictEqual(e.size,0),s.dispose()}),test("setChildren on collapsed node",()=>{const t=[],e=new a("test"),s=d(t,e);e.setChildren(null,[{element:0,collapsed:!0}]),l.deepStrictEqual(n(t),[0]),e.setChildren(0,[{element:1},{element:2}]),l.deepStrictEqual(n(t),[0]),e.setCollapsed(0,!1),l.deepStrictEqual(n(t),[0,1,2]),s.dispose()}),test("setChildren on expanded, unrevealed node",()=>{const t=[],e=new a("test"),s=d(t,e);e.setChildren(null,[{element:1,collapsed:!0,children:[{element:11,collapsed:!1}]},{element:2}]),l.deepStrictEqual(n(t),[1,2]),e.setChildren(11,[{element:111},{element:112}]),l.deepStrictEqual(n(t),[1,2]),e.setCollapsed(1,!1),l.deepStrictEqual(n(t),[1,11,111,112,2]),s.dispose()}),test("collapse state is preserved with strict identity",()=>{const t=[],e=new a("test",{collapseByDefault:!0}),s=[{element:"father",children:[{element:"child"}]}],r=d(t,e);e.setChildren(null,s),l.deepStrictEqual(n(t),["father"]),e.setCollapsed("father",!1),l.deepStrictEqual(n(t),["father","child"]),e.setChildren(null,s),l.deepStrictEqual(n(t),["father","child"]);const o=[{element:"father",children:[{element:"child"}]},{element:"uncle"}];e.setChildren(null,o),l.deepStrictEqual(n(t),["father","child","uncle"]),e.setChildren(null,[{element:"uncle"}]),l.deepStrictEqual(n(t),["uncle"]),e.setChildren(null,o),l.deepStrictEqual(n(t),["father","uncle"]),e.setChildren(null,s),l.deepStrictEqual(n(t),["father"]),r.dispose()}),test("collapse state can be optionally preserved with strict identity",()=>{const t=[],e=new a("test",{collapseByDefault:!0}),s=[{element:"father",collapsed:p.PreserveOrExpanded,children:[{element:"child"}]}],r=d(t,e);e.setChildren(null,s),l.deepStrictEqual(n(t),["father","child"]),e.setCollapsed("father",!0),l.deepStrictEqual(n(t),["father"]),e.setChildren(null,s),l.deepStrictEqual(n(t),["father"]),e.setCollapsed("father",!1),l.deepStrictEqual(n(t),["father","child"]),e.setChildren(null,s),l.deepStrictEqual(n(t),["father","child"]),r.dispose()}),test("sorter",()=>{const t=(i,c)=>i<c?-1:1,e=[],s=new a("test",{sorter:{compare(i,c){return t(i,c)}}}),r=[{element:"cars",children:[{element:"sedan"},{element:"convertible"},{element:"compact"}]},{element:"airplanes",children:[{element:"passenger"},{element:"jet"}]},{element:"bicycles",children:[{element:"dutch"},{element:"mountain"},{element:"electric"}]}],o=d(e,s);s.setChildren(null,r),l.deepStrictEqual(n(e),["airplanes","jet","passenger","bicycles","dutch","electric","mountain","cars","compact","convertible","sedan"]),o.dispose()}),test("resort",()=>{let t=()=>0;const e=[],s=new a("test",{sorter:{compare(i,c){return t(i,c)}}}),r=[{element:"cars",children:[{element:"sedan"},{element:"convertible"},{element:"compact"}]},{element:"airplanes",children:[{element:"passenger"},{element:"jet"}]},{element:"bicycles",children:[{element:"dutch"},{element:"mountain"},{element:"electric"}]}],o=d(e,s);s.setChildren(null,r),l.deepStrictEqual(n(e),["cars","sedan","convertible","compact","airplanes","passenger","jet","bicycles","dutch","mountain","electric"]),t=(i,c)=>i<c?-1:1,s.resort(null,!1),l.deepStrictEqual(n(e),["airplanes","passenger","jet","bicycles","dutch","mountain","electric","cars","sedan","convertible","compact"]),s.resort(),l.deepStrictEqual(n(e),["airplanes","jet","passenger","bicycles","dutch","electric","mountain","cars","compact","convertible","sedan"]),t=(i,c)=>i<c?1:-1,s.resort("cars"),l.deepStrictEqual(n(e),["airplanes","jet","passenger","bicycles","dutch","electric","mountain","cars","sedan","convertible","compact"]),s.resort(),l.deepStrictEqual(n(e),["cars","sedan","convertible","compact","bicycles","mountain","electric","dutch","airplanes","passenger","jet"]),o.dispose()}),test("expandTo",()=>{const t=[],e=new a("test",{collapseByDefault:!0}),s=d(t,e);e.setChildren(null,[{element:0,children:[{element:10,children:[{element:100,children:[{element:1e3}]}]},{element:11},{element:12}]},{element:1},{element:2}]),l.deepStrictEqual(n(t),[0,1,2]),e.expandTo(1e3),l.deepStrictEqual(n(t),[0,10,100,1e3,11,12,1,2]),s.dispose()}),test("issue #95641",async()=>{const t=[];let e=i=>!0;const s=new class{filter(i,c){return i==="file"?m.Recurse:e(i)?m.Visible:c}},r=new a("test",{filter:s}),o=d(t,r);r.setChildren(null,[{element:"file",children:[{element:"hello"}]}]),l.deepStrictEqual(n(t),["file","hello"]),e=i=>i==="world",r.refilter(),l.deepStrictEqual(n(t),[]),r.setChildren("file",[{element:"world"}]),await u(0),l.deepStrictEqual(n(t),["file","world"]),r.setChildren("file",[{element:"hello"}]),await u(0),l.deepStrictEqual(n(t),[]),r.setChildren("file",[{element:"world"}]),await u(0),l.deepStrictEqual(n(t),["file","world"]),o.dispose()})});
