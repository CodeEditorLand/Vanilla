import e from"assert";import{disposableTimeout as p}from"../../common/async.js";import{CancellationToken as v,CancellationTokenSource as R}from"../../common/cancellation.js";import{CancellationError as u,isCancellationError as m}from"../../common/errors.js";import{PagedModel as t}from"../../common/paging.js";import{ensureNoDisposablesAreLeakedInTestSuite as k}from"./utils.js";function P(n,o){return o.isCancellationRequested?Promise.reject(new u):Promise.resolve([0,1,2,3,4].map(s=>s+n*5))}class i{firstPage=[0,1,2,3,4];pageSize=5;total=100;getPage;constructor(o){this.getPage=o||P}}suite("PagedModel",()=>{const n=k();test("isResolved",()=>{const o=new i,s=new t(o);e(s.isResolved(0)),e(s.isResolved(1)),e(s.isResolved(2)),e(s.isResolved(3)),e(s.isResolved(4)),e(!s.isResolved(5)),e(!s.isResolved(6)),e(!s.isResolved(7)),e(!s.isResolved(8)),e(!s.isResolved(9)),e(!s.isResolved(10)),e(!s.isResolved(99))}),test("resolve single",async()=>{const o=new i,s=new t(o);e(!s.isResolved(5)),await s.resolve(5,v.None),e(s.isResolved(5))}),test("resolve page",async()=>{const o=new i,s=new t(o);e(!s.isResolved(5)),e(!s.isResolved(6)),e(!s.isResolved(7)),e(!s.isResolved(8)),e(!s.isResolved(9)),e(!s.isResolved(10)),await s.resolve(5,v.None),e(s.isResolved(5)),e(s.isResolved(6)),e(s.isResolved(7)),e(s.isResolved(8)),e(s.isResolved(9)),e(!s.isResolved(10))}),test("resolve page 2",async()=>{const o=new i,s=new t(o);e(!s.isResolved(5)),e(!s.isResolved(6)),e(!s.isResolved(7)),e(!s.isResolved(8)),e(!s.isResolved(9)),e(!s.isResolved(10)),await s.resolve(10,v.None),e(!s.isResolved(5)),e(!s.isResolved(6)),e(!s.isResolved(7)),e(!s.isResolved(8)),e(!s.isResolved(9)),e(s.isResolved(10))}),test("preemptive cancellation works",async function(){const o=new i(()=>{e(!1)}),s=new t(o);try{return await s.resolve(5,v.Cancelled),e(!1)}catch(l){return e(m(l))}}),test("cancellation works",function(){const o=new i((d,c)=>new Promise((g,r)=>{n.add(c.onCancellationRequested(()=>r(new u)))})),s=new t(o),l=n.add(new R),a=s.resolve(5,l.token).then(()=>e(!1),d=>e(m(d)));return setTimeout(()=>l.cancel(),10),a}),test("same page cancellation works",function(){let o="idle";const s=new i((r,w)=>(o="resolving",new Promise((C,f)=>{n.add(w.onCancellationRequested(()=>{o="idle",f(new u)}))}))),l=new t(s);e.strictEqual(o,"idle");const a=new R,d=l.resolve(5,a.token).then(()=>e(!1),r=>e(m(r)));e.strictEqual(o,"resolving");const c=new R,g=l.resolve(6,c.token).then(()=>e(!1),r=>e(m(r)));return e.strictEqual(o,"resolving"),n.add(p(()=>{e.strictEqual(o,"resolving"),a.cancel(),e.strictEqual(o,"resolving"),n.add(p(()=>{e.strictEqual(o,"resolving"),c.cancel(),e.strictEqual(o,"idle")},10))},10)),Promise.all([d,g])})});
