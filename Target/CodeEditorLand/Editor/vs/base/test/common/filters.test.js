import s from"assert";import{anyScore as S,createMatches as P,fuzzyScore as a,fuzzyScoreGraceful as z,fuzzyScoreGracefulAggressive as L,matchesCamelCase as c,matchesContiguousSubString as T,matchesPrefix as g,matchesStrictPrefix as p,matchesSubString as k,matchesWords as f,or as y}from"../../common/filters.js";import{ensureNoDisposablesAreLeakedInTestSuite as _}from"./utils.js";function e(t,n,r,o){const i=t(n,r);s(i,`${n} didn't match ${r}`),o&&s.deepStrictEqual(i,o)}function b(t,n,r){s(!t(n,r),`${n} matched ${r}`)}suite("Filters",()=>{_(),test("or",()=>{let r,o;const i=function(l,j){return function(){return o[l]++,j}};o=[0,0],r=y(i(0,!1),i(1,!1)),b(r,"anything","anything"),s.deepStrictEqual(o,[1,1]),o=[0,0],r=y(i(0,!0),i(1,!1)),e(r,"anything","anything"),s.deepStrictEqual(o,[1,0]),o=[0,0],r=y(i(0,!0),i(1,!0)),e(r,"anything","anything"),s.deepStrictEqual(o,[1,0]),o=[0,0],r=y(i(0,!1),i(1,!0)),e(r,"anything","anything"),s.deepStrictEqual(o,[1,1])}),test("PrefixFilter - case sensitive",function(){b(p,"",""),e(p,"","anything",[]),e(p,"alpha","alpha",[{start:0,end:5}]),e(p,"alpha","alphasomething",[{start:0,end:5}]),b(p,"alpha","alp"),e(p,"a","alpha",[{start:0,end:1}]),b(p,"x","alpha"),b(p,"A","alpha"),b(p,"AlPh","alPHA")}),test("PrefixFilter - ignore case",function(){e(g,"alpha","alpha",[{start:0,end:5}]),e(g,"alpha","alphasomething",[{start:0,end:5}]),b(g,"alpha","alp"),e(g,"a","alpha",[{start:0,end:1}]),e(g,"\xE4","\xC4lpha",[{start:0,end:1}]),b(g,"x","alpha"),e(g,"A","alpha",[{start:0,end:1}]),e(g,"AlPh","alPHA",[{start:0,end:4}]),b(g,"T","4")}),test("CamelCaseFilter",()=>{b(c,"",""),e(c,"","anything",[]),e(c,"alpha","alpha",[{start:0,end:5}]),e(c,"AlPhA","alpha",[{start:0,end:5}]),e(c,"alpha","alphasomething",[{start:0,end:5}]),b(c,"alpha","alp"),e(c,"c","CamelCaseRocks",[{start:0,end:1}]),e(c,"cc","CamelCaseRocks",[{start:0,end:1},{start:5,end:6}]),e(c,"ccr","CamelCaseRocks",[{start:0,end:1},{start:5,end:6},{start:9,end:10}]),e(c,"cacr","CamelCaseRocks",[{start:0,end:2},{start:5,end:6},{start:9,end:10}]),e(c,"cacar","CamelCaseRocks",[{start:0,end:2},{start:5,end:7},{start:9,end:10}]),e(c,"ccarocks","CamelCaseRocks",[{start:0,end:1},{start:5,end:7},{start:9,end:14}]),e(c,"cr","CamelCaseRocks",[{start:0,end:1},{start:9,end:10}]),e(c,"fba","FooBarAbe",[{start:0,end:1},{start:3,end:5}]),e(c,"fbar","FooBarAbe",[{start:0,end:1},{start:3,end:6}]),e(c,"fbara","FooBarAbe",[{start:0,end:1},{start:3,end:7}]),e(c,"fbaa","FooBarAbe",[{start:0,end:1},{start:3,end:5},{start:6,end:7}]),e(c,"fbaab","FooBarAbe",[{start:0,end:1},{start:3,end:5},{start:6,end:8}]),e(c,"c2d","canvasCreation2D",[{start:0,end:1},{start:14,end:16}]),e(c,"cce","_canvasCreationEvent",[{start:1,end:2},{start:7,end:8},{start:15,end:16}])}),test("CamelCaseFilter - #19256",function(){s(c("Debug Console","Open: Debug Console")),s(c("Debug console","Open: Debug Console")),s(c("debug console","Open: Debug Console"))}),test("matchesContiguousSubString",()=>{e(T,"cela","cancelAnimationFrame()",[{start:3,end:7}])}),test("matchesSubString",()=>{e(k,"cmm","cancelAnimationFrame()",[{start:0,end:1},{start:9,end:10},{start:18,end:19}]),e(k,"abc","abcabc",[{start:0,end:3}]),e(k,"abc","aaabbbccc",[{start:0,end:1},{start:3,end:4},{start:6,end:7}])}),test("matchesSubString performance (#35346)",function(){b(k,"aaaaaaaaaaaaaaaaaaaax","aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa")}),test("WordFilter",()=>{e(f,"alpha","alpha",[{start:0,end:5}]),e(f,"alpha","alphasomething",[{start:0,end:5}]),b(f,"alpha","alp"),e(f,"a","alpha",[{start:0,end:1}]),b(f,"x","alpha"),e(f,"A","alpha",[{start:0,end:1}]),e(f,"AlPh","alPHA",[{start:0,end:4}]),s(f("Debug Console","Open: Debug Console")),e(f,"gp","Git: Pull",[{start:0,end:1},{start:5,end:6}]),e(f,"g p","Git: Pull",[{start:0,end:1},{start:5,end:6}]),e(f,"gipu","Git: Pull",[{start:0,end:2},{start:5,end:7}]),e(f,"gp","Category: Git: Pull",[{start:10,end:11},{start:15,end:16}]),e(f,"g p","Category: Git: Pull",[{start:10,end:11},{start:15,end:16}]),e(f,"gipu","Category: Git: Pull",[{start:10,end:12},{start:15,end:17}]),b(f,"it","Git: Pull"),b(f,"ll","Git: Pull"),e(f,"git: \u30D7\u30EB","git: \u30D7\u30EB",[{start:0,end:7}]),e(f,"git \u30D7\u30EB","git: \u30D7\u30EB",[{start:0,end:3},{start:5,end:7}]),e(f,"\xF6\xE4k","\xD6hm: \xC4lles Klar",[{start:0,end:1},{start:5,end:6},{start:11,end:12}]),e(f,"C++","C/C++: command",[{start:2,end:5}]),e(f,".",":",[]),e(f,".",".",[{start:0,end:1}]),e(f,"bar","foo-bar"),e(f,"bar test","foo-bar test"),e(f,"fbt","foo-bar test"),e(f,"bar test","foo-bar (test)"),e(f,"foo bar","foo (bar)"),b(f,"bar est","foo-bar test"),b(f,"fo ar","foo-bar test"),b(f,"for","foo-bar test"),e(f,"foo bar","foo-bar"),e(f,"foo bar","123 foo-bar 456"),e(f,"foo-bar","foo bar"),e(f,"foo:bar","foo:bar")});function t(r,o,i,l,j={}){const d=l(r,r.toLowerCase(),j.patternPos||0,o,o.toLowerCase(),j.wordPos||0,{firstMatchCanBeWeak:j.firstMatchCanBeWeak??!1,boostFullMatch:!0});if(s.ok(!i==!d),d){const h=P(d);let u="",C=0;for(const m of h)u+=o.substring(C,m.start),u+="^"+o.substring(m.start,m.end).split("").join("^"),C=m.end;u+=o.substring(C),s.strictEqual(u,i)}}test("fuzzyScore, #23215",function(){t("tit","win.tit","win.^t^i^t",a),t("title","win.title","win.^t^i^t^l^e",a),t("WordCla","WordCharacterClassifier","^W^o^r^dCharacter^C^l^assifier",a),t("WordCCla","WordCharacterClassifier","^W^o^r^d^Character^C^l^assifier",a)}),test("fuzzyScore, #23332",function(){t("dete",'"editor.quickSuggestionsDelay"',void 0,a)}),test("fuzzyScore, #23190",function(){t("c:\\do","& 'C:\\Documents and Settings'","& '^C^:^\\^D^ocuments and Settings'",a),t("c:\\do","& 'c:\\Documents and Settings'","& '^c^:^\\^D^ocuments and Settings'",a)}),test("fuzzyScore, #23581",function(){t("close","css.lint.importStatement","^css.^lint.imp^ort^Stat^ement",a),t("close","css.colorDecorators.enable","^css.co^l^orDecorator^s.^enable",a),t("close","workbench.quickOpen.closeOnFocusOut","workbench.quickOpen.^c^l^o^s^eOnFocusOut",a),n(a,"close",2,"css.lint.importStatement","css.colorDecorators.enable","workbench.quickOpen.closeOnFocusOut")}),test("fuzzyScore, #23458",function(){t("highlight","editorHoverHighlight","editorHover^H^i^g^h^l^i^g^h^t",a),t("hhighlight","editorHoverHighlight","editor^Hover^H^i^g^h^l^i^g^h^t",a),t("dhhighlight","editorHoverHighlight",void 0,a)}),test("fuzzyScore, #23746",function(){t("-moz","-moz-foo","^-^m^o^z-foo",a),t("moz","-moz-foo","-^m^o^z-foo",a),t("moz","-moz-animation","-^m^o^z-animation",a),t("moza","-moz-animation","-^m^o^z-^animation",a)}),test("fuzzyScore",()=>{t("ab","abA","^a^bA",a),t("ccm","cacmelCase","^ca^c^melCase",a),t("bti","the_black_knight",void 0,a),t("ccm","camelCase",void 0,a),t("cmcm","camelCase",void 0,a),t("BK","the_black_knight","the_^black_^knight",a),t("KeyboardLayout=","KeyboardLayout",void 0,a),t("LLL","SVisualLoggerLogsList","SVisual^Logger^Logs^List",a),t("LLLL","SVilLoLosLi",void 0,a),t("LLLL","SVisualLoggerLogsList",void 0,a),t("TEdit","TextEdit","^Text^E^d^i^t",a),t("TEdit","TextEditor","^Text^E^d^i^tor",a),t("TEdit","Textedit","^Text^e^d^i^t",a),t("TEdit","text_edit","^text_^e^d^i^t",a),t("TEditDit","TextEditorDecorationType","^Text^E^d^i^tor^Decorat^ion^Type",a),t("TEdit","TextEditorDecorationType","^Text^E^d^i^torDecorationType",a),t("Tedit","TextEdit","^Text^E^d^i^t",a),t("ba","?AB?",void 0,a),t("bkn","the_black_knight","the_^black_^k^night",a),t("bt","the_black_knight","the_^black_knigh^t",a),t("ccm","camelCasecm","^camel^Casec^m",a),t("fdm","findModel","^fin^d^Model",a),t("fob","foobar","^f^oo^bar",a),t("fobz","foobar",void 0,a),t("foobar","foobar","^f^o^o^b^a^r",a),t("form","editor.formatOnSave","editor.^f^o^r^matOnSave",a),t("g p","Git: Pull","^Git:^ ^Pull",a),t("g p","Git: Pull","^Git:^ ^Pull",a),t("gip","Git: Pull","^G^it: ^Pull",a),t("gip","Git: Pull","^G^it: ^Pull",a),t("gp","Git: Pull","^Git: ^Pull",a),t("gp","Git_Git_Pull","^Git_Git_^Pull",a),t("is","ImportStatement","^Import^Statement",a),t("is","isValid","^i^sValid",a),t("lowrd","lowWord","^l^o^wWo^r^d",a),t("myvable","myvariable","^m^y^v^aria^b^l^e",a),t("no","",void 0,a),t("no","match",void 0,a),t("ob","foobar",void 0,a),t("sl","SVisualLoggerLogsList","^SVisual^LoggerLogsList",a),t("sllll","SVisualLoggerLogsList","^SVisua^l^Logger^Logs^List",a),t("Three","HTMLHRElement",void 0,a),t("Three","Three","^T^h^r^e^e",a),t("fo","barfoo",void 0,a),t("fo","bar_foo","bar_^f^oo",a),t("fo","bar_Foo","bar_^F^oo",a),t("fo","bar foo","bar ^f^oo",a),t("fo","bar.foo","bar.^f^oo",a),t("fo","bar/foo","bar/^f^oo",a),t("fo","bar\\foo","bar\\^f^oo",a)}),test("fuzzyScore (first match can be weak)",function(){t("Three","HTMLHRElement","H^TML^H^R^El^ement",a,{firstMatchCanBeWeak:!0}),t("tor","constructor","construc^t^o^r",a,{firstMatchCanBeWeak:!0}),t("ur","constructor","constr^ucto^r",a,{firstMatchCanBeWeak:!0}),n(a,"tor",2,"constructor","Thor","cTor")}),test("fuzzyScore, many matches",function(){t("aaaaaa","aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa","^a^a^a^a^a^aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",a)}),test("Freeze when fjfj -> jfjf, https://github.com/microsoft/vscode/issues/91807",function(){t("jfjfj","fjfjfjfjfjfjfjfjfjfjfj",void 0,a),t("jfjfjfjfjfjfjfjfjfj","fjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfj",void 0,a),t("jfjfjfjfjfjfjfjfjfjjfjfjfjfjfjfjfjfjfjjfjfjfjfjfjfjfjfjfjjfjfjfjfjfjfjfjfjfjjfjfjfjfjfjfjfjfjfjjfjfjfjfjfjfjfjfjfj","fjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfj",void 0,a),t("jfjfjfjfjfjfjfjfjfj","fJfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfj","f^J^f^j^f^j^f^j^f^j^f^j^f^j^f^j^f^j^f^jfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfj",a),t("jfjfjfjfjfjfjfjfjfj","fjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfj","f^j^f^j^f^j^f^j^f^j^f^j^f^j^f^j^f^j^f^jfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfjfj",a,{firstMatchCanBeWeak:!0})}),test("fuzzyScore, issue #26423",function(){t("baba","abababab",void 0,a),t("fsfsfs","dsafdsafdsafdsafdsafdsafdsafasdfdsa",void 0,a),t("fsfsfsfsfsfsfsf","dsafdsafdsafdsafdsafdsafdsafasdfdsafdsafdsafdsafdsfdsafdsfdfdfasdnfdsajfndsjnafjndsajlknfdsa",void 0,a)}),test("Fuzzy IntelliSense matching vs Haxe metadata completion, #26995",function(){t("f",":Foo",":^Foo",a),t("f",":foo",":^foo",a)}),test("Separator only match should not be weak #79558",function(){t(".","foo.bar","foo^.bar",a)}),test("Cannot set property '1' of undefined, #26511",function(){const r=new Array(123).join("a"),o=new Array(120).join("a");a(o,o.toLowerCase(),0,r,r.toLowerCase(),0),s.ok(!0)}),test("Vscode 1.12 no longer obeys 'sortText' in completion items (from language server), #26096",function(){t("  ","  group",void 0,a,{patternPos:2}),t("  g","  group","  ^group",a,{patternPos:2}),t("g","  group","  ^group",a),t("g g","  groupGroup",void 0,a),t("g g","  group Group","  ^group^ ^Group",a),t(" g g","  group Group","  ^group^ ^Group",a,{patternPos:1}),t("zz","zzGroup","^z^zGroup",a),t("zzg","zzGroup","^z^z^Group",a),t("g","zzGroup","zz^Group",a)}),test("patternPos isn't working correctly #79815",function(){t(":p".substr(1),"prop","^prop",a,{patternPos:0}),t(":p","prop","^prop",a,{patternPos:1}),t(":p","prop",void 0,a,{patternPos:2}),t(":p","proP","pro^P",a,{patternPos:1,wordPos:1}),t(":p","aprop","a^prop",a,{patternPos:1,firstMatchCanBeWeak:!0}),t(":p","aprop",void 0,a,{patternPos:1,firstMatchCanBeWeak:!1})});function n(r,o,i,...l){let j=-1e3,d=0;for(let h=0;h<l.length;h++){const u=l[h],C=r(o,o.toLowerCase(),0,u,u.toLowerCase(),0);if(C){const[m]=C;m>j&&(j=m,d=h)}}s.strictEqual(d,i,`${o} -> actual=${l[d]} <> expected=${l[i]}`)}test("topScore - fuzzyScore",function(){n(a,"cons",2,"ArrayBufferConstructor","Console","console"),n(a,"Foo",1,"foo","Foo","foo"),n(a,"onMess",1,"onmessage","onMessage","onThisMegaEscape"),n(a,"CC",1,"camelCase","CamelCase"),n(a,"cC",0,"camelCase","CamelCase"),n(a,"p",4,"parse","posix","pafdsa","path","p"),n(a,"pa",0,"parse","pafdsa","path"),n(a,"log",3,"HTMLOptGroupElement","ScrollLogicalPosition","SVGFEMorphologyElement","log","logger"),n(a,"e",2,"AbstractWorker","ActiveXObject","else"),n(a,"workbench.sideb",1,"workbench.editor.defaultSideBySideLayout","workbench.sideBar.location"),n(a,"editor.r",2,"diffEditor.renderSideBySide","editor.overviewRulerlanes","editor.renderControlCharacter","editor.renderWhitespace"),n(a,"-mo",1,"-ms-ime-mode","-moz-columns"),n(a,"convertModelPosition",0,"convertModelPositionToViewPosition","convertViewToModelPosition"),n(a,"is",0,"isValidViewletId","import statement"),n(a,"title",1,"files.trimTrailingWhitespace","window.title"),n(a,"const",1,"constructor","const","cuOnstrul")}),test("Unexpected suggestion scoring, #28791",function(){n(a,"_lines",1,"_lineStarts","_lines"),n(a,"_lines",1,"_lineS","_lines"),n(a,"_lineS",0,"_lineS","_lines")}),test.skip('Bad completion ranking changes valid variable name to class name when pressing "." #187055',function(){n(a,"a",1,"A","a"),n(a,"theme",1,"Theme","theme")}),test("HTML closing tag proposal filtered out #38880",function(){t("		<","		</body>","^	^	^</body>",a,{patternPos:0}),t("		<","		</body>","		^</body>",a,{patternPos:2}),t("	<","	</body>","	^</body>",a,{patternPos:1})}),test("fuzzyScoreGraceful",()=>{t("rlut","result",void 0,a),t("rlut","result","^res^u^l^t",z),t("cno","console","^co^ns^ole",a),t("cno","console","^co^ns^ole",z),t("cno","console","^c^o^nsole",L),t("cno","co_new","^c^o_^new",z),t("cno","co_new","^c^o_^new",L)}),test("List highlight filter: Not all characters from match are highlighterd #66923",()=>{t("foo","barbarbarbarbarbarbarbarbarbarbarbarbarbarbarbar_foo","barbarbarbarbarbarbarbarbarbarbarbarbarbarbarbar_^f^o^o",a)}),test("Autocompletion is matched against truncated filterText to 54 characters #74133",()=>{t("foo","ffffffffffffffffffffffffffffbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbar_foo","ffffffffffffffffffffffffffffbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbar_^f^o^o",a),t("Aoo","Affffffffffffffffffffffffffffbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbar_foo","^Affffffffffffffffffffffffffffbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbar_f^o^o",a),t("foo","Gffffffffffffffffffffffffffffbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbarbar_foo",void 0,a)}),test(`"Go to Symbol" with the exact method name doesn't work as expected #84787`,function(){const r=a(":get",":get",1,"get","get",0,{firstMatchCanBeWeak:!0,boostFullMatch:!0});s.ok(!!r)}),test("Wrong highlight after emoji #113404",function(){t("di",'\u2728div classname=""></div>','\u2728^d^iv classname=""></div>',a),t("di",'adiv classname=""></div>','adiv classname=""></^d^iv>',a)}),test("Suggestion is not highlighted #85826",function(){t("SemanticTokens","SemanticTokensEdits","^S^e^m^a^n^t^i^c^T^o^k^e^n^sEdits",a),t("SemanticTokens","SemanticTokensEdits","^S^e^m^a^n^t^i^c^T^o^k^e^n^sEdits",L)}),test("IntelliSense completion not correctly highlighting text in front of cursor #115250",function(){t("lo","log","^l^og",a),t(".lo","log","^l^og",S),t(".","log","log",S)}),test("anyScore should not require a strong first match",function(){t("bar","foobAr","foo^b^A^r",S),t("bar","foobar","foo^b^a^r",S)}),test("configurable full match boost",function(){const r="create",o="createModelServices",i="create";let l=a(r,r,0,o,o.toLowerCase(),0,{boostFullMatch:!0,firstMatchCanBeWeak:!0}),j=a(r,r,0,i,i.toLowerCase(),0,{boostFullMatch:!0,firstMatchCanBeWeak:!0});s.ok(l),s.ok(j),s.ok(l[0]<j[0]);const d="$(symbol-function) ";l=a(r,r,0,`${d}${o}`,`${d}${o}`.toLowerCase(),d.length,{boostFullMatch:!0,firstMatchCanBeWeak:!0}),j=a(r,r,0,`${d}${i}`,`${d}${i}`.toLowerCase(),d.length,{boostFullMatch:!0,firstMatchCanBeWeak:!0}),s.ok(l),s.ok(j),s.ok(l[0]<j[0]);const h=a(r,r,0,o,o.toLowerCase(),0,{boostFullMatch:!1,firstMatchCanBeWeak:!0}),u=a(r,r,0,i,i.toLowerCase(),0,{boostFullMatch:!1,firstMatchCanBeWeak:!0});s.ok(h),s.ok(u),s.ok(h[0]===u[0])}),test("Unexpected suggest highlighting ignores whole word match in favor of matching first letter#147423",function(){t("i","machine/{id}","machine/{^id}",a),t("ok","obobobf{ok}/user","^obobobf{o^k}/user",a)})});
