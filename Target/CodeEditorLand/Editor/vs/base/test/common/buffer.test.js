import r from"assert";import{timeout as i}from"../../common/async.js";import{bufferedStreamToBuffer as d,bufferToReadable as E,bufferToStream as c,decodeBase64 as f,encodeBase64 as m,newWriteableBufferStream as l,readableToBuffer as q,streamToBuffer as S,VSBuffer as s}from"../../common/buffer.js";import{peekStream as g}from"../../common/stream.js";import{ensureNoDisposablesAreLeakedInTestSuite as w}from"./utils.js";suite("Buffer",()=>{w(),test("issue #71993 - VSBuffer#toString returns numbers",()=>{const t=new Uint8Array([1,2,3,104,105,4,5]).buffer,e=s.wrap(new Uint8Array(t,3,2));r.deepStrictEqual(e.toString(),"hi")}),test("bufferToReadable / readableToBuffer",()=>{const t="Hello World",e=E(s.fromString(t));r.strictEqual(q(e).toString(),t)}),test("bufferToStream / streamToBuffer",async()=>{const t="Hello World",e=c(s.fromString(t));r.strictEqual((await S(e)).toString(),t)}),test("bufferedStreamToBuffer",async()=>{const t="Hello World",e=await g(c(s.fromString(t)),1);r.strictEqual((await d(e)).toString(),t)}),test("bufferWriteableStream - basics (no error)",async()=>{const t=l(),e=[];t.on("data",a=>{e.push(a)});let n=!1;t.on("end",()=>{n=!0});const o=[];t.on("error",a=>{o.push(a)}),await i(0),t.write(s.fromString("Hello")),await i(0),t.end(s.fromString("World")),r.strictEqual(e.length,2),r.strictEqual(e[0].toString(),"Hello"),r.strictEqual(e[1].toString(),"World"),r.strictEqual(n,!0),r.strictEqual(o.length,0)}),test("bufferWriteableStream - basics (error)",async()=>{const t=l(),e=[];t.on("data",a=>{e.push(a)});let n=!1;t.on("end",()=>{n=!0});const o=[];t.on("error",a=>{o.push(a)}),await i(0),t.write(s.fromString("Hello")),await i(0),t.error(new Error),t.end(),r.strictEqual(e.length,1),r.strictEqual(e[0].toString(),"Hello"),r.strictEqual(n,!0),r.strictEqual(o.length,1)}),test("bufferWriteableStream - buffers data when no listener",async()=>{const t=l();await i(0),t.write(s.fromString("Hello")),await i(0),t.end(s.fromString("World"));const e=[];t.on("data",a=>{e.push(a)});let n=!1;t.on("end",()=>{n=!0});const o=[];t.on("error",a=>{o.push(a)}),r.strictEqual(e.length,1),r.strictEqual(e[0].toString(),"HelloWorld"),r.strictEqual(n,!0),r.strictEqual(o.length,0)}),test("bufferWriteableStream - buffers errors when no listener",async()=>{const t=l();await i(0),t.write(s.fromString("Hello")),await i(0),t.error(new Error);const e=[];t.on("data",a=>{e.push(a)});const n=[];t.on("error",a=>{n.push(a)});let o=!1;t.on("end",()=>{o=!0}),t.end(),r.strictEqual(e.length,1),r.strictEqual(e[0].toString(),"Hello"),r.strictEqual(o,!0),r.strictEqual(n.length,1)}),test("bufferWriteableStream - buffers end when no listener",async()=>{const t=l();await i(0),t.write(s.fromString("Hello")),await i(0),t.end(s.fromString("World"));let e=!1;t.on("end",()=>{e=!0});const n=[];t.on("data",a=>{n.push(a)});const o=[];t.on("error",a=>{o.push(a)}),r.strictEqual(n.length,1),r.strictEqual(n[0].toString(),"HelloWorld"),r.strictEqual(e,!0),r.strictEqual(o.length,0)}),test("bufferWriteableStream - nothing happens after end()",async()=>{const t=l(),e=[];t.on("data",u=>{e.push(u)}),await i(0),t.write(s.fromString("Hello")),await i(0),t.end(s.fromString("World"));let n=!1;t.on("data",u=>{n=!0});let o=!1;t.on("error",u=>{o=!0});let a=!1;t.on("end",()=>{a=!0}),await i(0),t.write(s.fromString("Hello")),await i(0),t.error(new Error),await i(0),t.end(s.fromString("World")),r.strictEqual(n,!1),r.strictEqual(o,!1),r.strictEqual(a,!1),r.strictEqual(e.length,2),r.strictEqual(e[0].toString(),"Hello"),r.strictEqual(e[1].toString(),"World")}),test("bufferWriteableStream - pause/resume (simple)",async()=>{const t=l(),e=[];t.on("data",a=>{e.push(a)});let n=!1;t.on("end",()=>{n=!0});const o=[];t.on("error",a=>{o.push(a)}),t.pause(),await i(0),t.write(s.fromString("Hello")),await i(0),t.end(s.fromString("World")),r.strictEqual(e.length,0),r.strictEqual(o.length,0),r.strictEqual(n,!1),t.resume(),r.strictEqual(e.length,1),r.strictEqual(e[0].toString(),"HelloWorld"),r.strictEqual(n,!0),r.strictEqual(o.length,0)}),test("bufferWriteableStream - pause/resume (pause after first write)",async()=>{const t=l(),e=[];t.on("data",a=>{e.push(a)});let n=!1;t.on("end",()=>{n=!0});const o=[];t.on("error",a=>{o.push(a)}),await i(0),t.write(s.fromString("Hello")),t.pause(),await i(0),t.end(s.fromString("World")),r.strictEqual(e.length,1),r.strictEqual(e[0].toString(),"Hello"),r.strictEqual(o.length,0),r.strictEqual(n,!1),t.resume(),r.strictEqual(e.length,2),r.strictEqual(e[0].toString(),"Hello"),r.strictEqual(e[1].toString(),"World"),r.strictEqual(n,!0),r.strictEqual(o.length,0)}),test("bufferWriteableStream - pause/resume (error)",async()=>{const t=l(),e=[];t.on("data",a=>{e.push(a)});let n=!1;t.on("end",()=>{n=!0});const o=[];t.on("error",a=>{o.push(a)}),t.pause(),await i(0),t.write(s.fromString("Hello")),await i(0),t.error(new Error),t.end(),r.strictEqual(e.length,0),r.strictEqual(n,!1),r.strictEqual(o.length,0),t.resume(),r.strictEqual(e.length,1),r.strictEqual(e[0].toString(),"Hello"),r.strictEqual(n,!0),r.strictEqual(o.length,1)}),test("bufferWriteableStream - destroy",async()=>{const t=l(),e=[];t.on("data",a=>{e.push(a)});let n=!1;t.on("end",()=>{n=!0});const o=[];t.on("error",a=>{o.push(a)}),t.destroy(),await i(0),t.write(s.fromString("Hello")),await i(0),t.end(s.fromString("World")),r.strictEqual(e.length,0),r.strictEqual(n,!1),r.strictEqual(o.length,0)}),test("Performance issue with VSBuffer#slice #76076",function(){if(typeof Buffer<"u"){const t=Buffer.from([10,20,30,40]),e=t.slice(1,3);r.strictEqual(t[1],20),r.strictEqual(e[0],20),t[1]=17,r.strictEqual(t[1],17),r.strictEqual(e[0],17)}{const t=new Uint8Array([10,20,30,40]),e=t.slice(1,3);r.strictEqual(t[1],20),r.strictEqual(e[0],20),t[1]=17,r.strictEqual(t[1],17),r.strictEqual(e[0],20)}{const t=new Uint8Array([10,20,30,40]),e=t.subarray(1,3);r.strictEqual(t[1],20),r.strictEqual(e[0],20),t[1]=17,r.strictEqual(t[1],17),r.strictEqual(e[0],17)}}),test("indexOf",()=>{const t=s.fromString("abcaabbccaaabbbccc");r.strictEqual(t.indexOf(s.fromString("")),0),r.strictEqual(t.indexOf(s.fromString("a".repeat(100))),-1),r.strictEqual(t.indexOf(s.fromString("a")),0),r.strictEqual(t.indexOf(s.fromString("c")),2),r.strictEqual(t.indexOf(s.fromString("abcaa")),0),r.strictEqual(t.indexOf(s.fromString("caaab")),8),r.strictEqual(t.indexOf(s.fromString("ccc")),15),r.strictEqual(t.indexOf(s.fromString("cccb")),-1)}),suite("base64",()=>{const t=[[new Uint8Array([]),""],[new Uint8Array([56]),"OA=="],[new Uint8Array([209,4]),"0QQ="],[new Uint8Array([19,57,119]),"Ezl3"],[new Uint8Array([199,237,207,112]),"x+3PcA=="],[new Uint8Array([59,193,173,26,242]),"O8GtGvI="],[new Uint8Array([81,226,95,231,116,126]),"UeJf53R+"],[new Uint8Array([11,164,253,85,8,6,56]),"C6T9VQgGOA=="],[new Uint8Array([164,16,88,88,224,173,144,114]),"pBBYWOCtkHI="],[new Uint8Array([0,196,99,12,21,229,78,101,13]),"AMRjDBXlTmUN"],[new Uint8Array([167,114,225,116,226,83,51,48,88,114]),"p3LhdOJTMzBYcg=="],[new Uint8Array([75,33,118,10,77,5,168,194,59,47,59]),"SyF2Ck0FqMI7Lzs="],[new Uint8Array([203,182,165,51,208,27,123,223,112,198,127,147]),"y7alM9Abe99wxn+T"],[new Uint8Array([154,93,222,41,117,234,250,85,95,144,16,94,18]),"ml3eKXXq+lVfkBBeEg=="],[new Uint8Array([246,186,88,105,192,57,25,168,183,164,103,162,243,56]),"9rpYacA5Gai3pGei8zg="],[new Uint8Array([149,240,155,96,30,55,162,172,191,187,33,124,169,183,254]),"lfCbYB43oqy/uyF8qbf+"]];test("encodes",()=>{for(const[e,n]of t)r.strictEqual(m(s.wrap(e)),n)}),test("decodes",()=>{for(const[e,n]of t)r.deepStrictEqual(new Uint8Array(f(n).buffer),e)}),test("throws error on invalid encoding",()=>{r.throws(()=>f("invalid!"))})})});
