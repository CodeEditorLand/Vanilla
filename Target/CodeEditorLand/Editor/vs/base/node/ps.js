import{exec as h}from"child_process";import{FileAccess as b}from"../common/network.js";function N(l){return new Promise((a,u)=>{let f;const g=new Map;function m(r,t,i,p,s){const n=g.get(t);if(r===l||n){const e={name:d(i),cmd:i,pid:r,ppid:t,load:p,mem:s};g.set(r,e),r===l&&(f=e),n&&(n.children||(n.children=[]),n.children.push(e),n.children.length>1&&(n.children=n.children.sort((c,o)=>c.pid-o.pid)))}}function d(r){const t=/--utility-sub-type=network/i,i=/--crashes-directory/i,p=/\\pipe\\winpty-control/i,s=/conhost\.exe.+--headless/i,n=/--type=([a-zA-Z-]+)/;if(i.exec(r))return"electron-crash-reporter";if(p.exec(r))return"winpty-agent";if(s.exec(r))return"conpty-agent";let e=n.exec(r);if(e&&e.length===2)return e[1]==="renderer"?"window":e[1]==="utility"?t.exec(r)?"utility-network-service":"utility-process":e[1]==="extensionHost"?"extension-host":e[1];const c=/[a-zA-Z-]+\.js/g;let o="";do e=c.exec(r),e&&(o+=e+" ");while(e);return o&&r.indexOf("node ")<0&&r.indexOf("node.exe")<0?`electron-nodejs (${o})`:r}if(process.platform==="win32"){const r=t=>t.indexOf("\\\\?\\")===0||t.indexOf("\\??\\")===0?t.substring(4):t.indexOf('"\\\\?\\')===0||t.indexOf('"\\??\\')===0?'"'+t.substring(5):t;import("@vscode/windows-process-tree").then(t=>{t.getProcessList(l,i=>{if(!i){u(new Error(`Root process ${l} not found`));return}t.getProcessCpuUsage(i,p=>{const s=new Map;p.forEach(n=>{const e=r(n.commandLine||"");s.set(n.pid,{name:d(e),cmd:e,pid:n.pid,ppid:n.ppid,load:n.cpu||0,mem:n.memory||0})}),f=s.get(l),f?(s.forEach(n=>{const e=s.get(n.ppid);e&&(e.children||(e.children=[]),e.children.push(n))}),s.forEach(n=>{n.children&&(n.children=n.children.sort((e,c)=>e.pid-c.pid))}),a(f)):u(new Error(`Root process ${l} not found`))})},t.ProcessDataFlag.CommandLine|t.ProcessDataFlag.Memory)})}else{let r=function(){let t=[f];const i=[];for(;t.length;){const s=t.shift();s&&(i.push(s.pid),s.children&&(t=t.concat(s.children)))}let p=JSON.stringify(b.asFileUri("vs/base/node/cpuUsage.sh").fsPath);p+=" "+i.join(" "),h(p,{},(s,n,e)=>{if(s||e)u(s||new Error(e.toString()));else{const c=n.toString().split(`
`);for(let o=0;o<i.length;o++){const I=g.get(i[o]);I.load=Number.parseFloat(c[o])}if(!f){u(new Error(`Root process ${l} not found`));return}a(f)}})};var E=r;h("which ps",{},(t,i,p)=>{if(t||p)if(process.platform!=="linux")u(t||new Error(p.toString()));else{const s=JSON.stringify(b.asFileUri("vs/base/node/ps.sh").fsPath);h(s,{},(n,e,c)=>{n||c?u(n||new Error(c.toString())):(x(e,m),r())})}else{const s=i.toString().trim();h(`${s} -ax -o pid=,ppid=,pcpu=,pmem=,command=`,{maxBuffer:1e3*1024,env:{LC_NUMERIC:"en_US.UTF-8"}},(e,c,o)=>{e||o&&!o.includes("screen size is bogus")?u(e||new Error(o.toString())):(x(c,m),process.platform==="linux"?r():f?a(f):u(new Error(`Root process ${l} not found`)))})}})}})}function x(l,a){const u=/^\s*([0-9]+)\s+([0-9]+)\s+([0-9]+\.[0-9]+)\s+([0-9]+\.[0-9]+)\s+(.+)$/,f=l.toString().split(`
`);for(const g of f){const m=u.exec(g.trim());m&&m.length===6&&a(Number.parseInt(m[1]),Number.parseInt(m[2]),m[5],Number.parseFloat(m[3]),Number.parseFloat(m[4]))}}export{N as listProcesses};
