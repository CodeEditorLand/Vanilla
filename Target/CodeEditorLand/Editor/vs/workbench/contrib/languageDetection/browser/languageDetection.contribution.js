var L=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var h=(r,e,o,t)=>{for(var i=t>1?void 0:t?C(e,o):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(t?a(e,o,i):a(i))||i);return t&&i&&L(e,o,i),i},s=(r,e)=>(o,t)=>e(o,t,r);import{ThrottledDelayer as k}from"../../../../../vs/base/common/async.js";import{KeyCode as x,KeyMod as y}from"../../../../../vs/base/common/keyCodes.js";import{DisposableStore as f}from"../../../../../vs/base/common/lifecycle.js";import{Schemas as A}from"../../../../../vs/base/common/network.js";import{getCodeEditor as v}from"../../../../../vs/editor/browser/editorBrowser.js";import"../../../../../vs/editor/browser/editorExtensions.js";import{EditorContextKeys as K}from"../../../../../vs/editor/common/editorContextKeys.js";import{ILanguageService as T}from"../../../../../vs/editor/common/languages/language.js";import{localize as g,localize2 as W}from"../../../../../vs/nls.js";import{Action2 as w,registerAction2 as R}from"../../../../../vs/platform/actions/common/actions.js";import{IConfigurationService as M}from"../../../../../vs/platform/configuration/common/configuration.js";import{ContextKeyExpr as H}from"../../../../../vs/platform/contextkey/common/contextkey.js";import{IKeybindingService as N}from"../../../../../vs/platform/keybinding/common/keybinding.js";import{KeybindingWeight as U}from"../../../../../vs/platform/keybinding/common/keybindingsRegistry.js";import{INotificationService as B}from"../../../../../vs/platform/notification/common/notification.js";import{Registry as O}from"../../../../../vs/platform/registry/common/platform.js";import{Extensions as j}from"../../../../../vs/workbench/common/contributions.js";import{NOTEBOOK_EDITOR_EDITABLE as P}from"../../../../../vs/workbench/contrib/notebook/common/notebookContextKeys.js";import{IEditorService as _}from"../../../../../vs/workbench/services/editor/common/editorService.js";import{ILanguageDetectionService as S,LanguageDetectionLanguageEventSource as z}from"../../../../../vs/workbench/services/languageDetection/common/languageDetectionWorkerService.js";import{LifecyclePhase as G}from"../../../../../vs/workbench/services/lifecycle/common/lifecycle.js";import{IStatusbarService as $,StatusbarAlignment as E}from"../../../../../vs/workbench/services/statusbar/browser/statusbar.js";const l="editor.detectLanguage";let d=class{constructor(e,o,t,i,n,a){this._languageDetectionService=e;this._statusBarService=o;this._configurationService=t;this._editorService=i;this._languageService=n;this._keybindingService=a;i.onDidActiveEditorChange(()=>this._update(!0),this,this._disposables),this._update(!1)}static _id="status.languageDetectionStatus";_disposables=new f;_combinedEntry;_delayer=new k(1e3);_renderDisposables=new f;dispose(){this._disposables.dispose(),this._delayer.dispose(),this._combinedEntry?.dispose(),this._renderDisposables.dispose()}_update(e){e&&(this._combinedEntry?.dispose(),this._combinedEntry=void 0),this._delayer.trigger(()=>this._doUpdate())}async _doUpdate(){const e=v(this._editorService.activeTextEditorControl);this._renderDisposables.clear(),e?.onDidChangeModelLanguage(()=>this._update(!0),this,this._renderDisposables),e?.onDidChangeModelContent(()=>this._update(!1),this,this._renderDisposables);const o=e?.getModel(),t=o?.uri,i=o?.getLanguageId(),n=this._configurationService.getValue("workbench.editor.languageDetectionHints");if(!(typeof n=="object"&&n?.untitledEditors)||t?.scheme!==A.untitled||!i||!t)this._combinedEntry?.dispose(),this._combinedEntry=void 0;else{const c=await this._languageDetectionService.detectLanguage(t),I={jsonc:"json"},m=o.getLanguageId();if(c&&c!==m&&I[m]!==c){const D=this._languageService.getLanguageName(c)||c;let p=g("status.autoDetectLanguage","Accept Detected Language: {0}",D);const u=this._keybindingService.lookupKeybinding(l)?.getLabel();u&&(p+=` (${u})`);const b={name:g("langDetection.name","Language Detection"),ariaLabel:g("langDetection.aria","Change to Detected Language: {0}",c),tooltip:p,command:l,text:"$(lightbulb-autofix)"};this._combinedEntry?this._combinedEntry.update(b):this._combinedEntry=this._statusBarService.addEntry(b,d._id,E.RIGHT,{id:"status.editor.mode",alignment:E.RIGHT,compact:!0})}else this._combinedEntry?.dispose(),this._combinedEntry=void 0}}};d=h([s(0,S),s(1,$),s(2,M),s(3,_),s(4,T),s(5,N)],d),O.as(j.Workbench).registerWorkbenchContribution(d,G.Restored),R(class extends w{constructor(){super({id:l,title:W("detectlang","Detect Language from Content"),f1:!0,precondition:H.and(P.toNegated(),K.editorTextFocus),keybinding:{primary:x.KeyD|y.Alt|y.Shift,weight:U.WorkbenchContrib}})}async run(r){const e=r.get(_),o=r.get(S),t=v(e.activeTextEditorControl),i=r.get(B),n=t?.getModel()?.uri;if(n){const a=await o.detectLanguage(n);a?t.getModel()?.setLanguage(a,z):i.warn(g("noDetection","Unable to detect editor language"))}}});
