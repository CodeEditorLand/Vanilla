import s from"assert";import{isHTMLSpanElement as L}from"../../../../../base/browser/dom.js";import{Color as E,RGBA as l}from"../../../../../base/common/color.js";import{DisposableStore as w}from"../../../../../base/common/lifecycle.js";import{generateUuid as p}from"../../../../../base/common/uuid.js";import{ensureNoDisposablesAreLeakedInTestSuite as y}from"../../../../../base/test/common/utils.js";import"../../../../../platform/instantiation/test/common/instantiationServiceMock.js";import"../../../../../platform/theme/common/themeService.js";import{TestColorTheme as O,TestThemeService as D}from"../../../../../platform/theme/test/common/testThemeService.js";import{appendStylizedStringToContainer as x,calcANSI8bitColor as u,handleANSIOutput as k}from"../../browser/debugANSIHandling.js";import"../../browser/debugSession.js";import{LinkDetector as R}from"../../browser/linkDetector.js";import"../../common/debugModel.js";import{createTestSession as v}from"./callStack.test.js";import{createMockDebugModel as C}from"./mockDebugModel.js";import{ansiColorMap as q,registerColors as T}from"../../../terminal/common/terminalColorRegistry.js";import{workbenchInstantiationService as F}from"../../../../test/browser/workbenchTestServices.js";suite("Debug - ANSI Handling",()=>{let m,A,h,g,S;setup(()=>{m=new w,A=C(m),h=v(A),g=F(void 0,m).createInstance(R);const e={};for(const a in q)e[a]=q[a].defaults.dark;const t=new O(e);S=new D(t),T()}),teardown(()=>{m.dispose()}),y(),test("appendStylizedStringToContainer",()=>{const o=document.createElement("span");let e;s.strictEqual(0,o.children.length),x(o,"content1",["class1","class2"],g,h.root),x(o,"content2",["class2","class3"],g,h.root),s.strictEqual(2,o.children.length),e=o.firstChild,L(e)?(s.strictEqual("content1",e.textContent),s(e.classList.contains("class1")),s(e.classList.contains("class2"))):s.fail("Unexpected assertion error"),e=o.lastChild,L(e)?(s.strictEqual("content2",e.textContent),s(e.classList.contains("class2")),s(e.classList.contains("class3"))):s.fail("Unexpected assertion error")});function N(o){const e=k(o,g,S,h.root);s.strictEqual(1,e.children.length);const t=e.lastChild;if(L(t))return t;s.fail("Unexpected assertion error")}function n(o,e){const t=N(o+"content");s.strictEqual("content",t.textContent),e(t)}function c(o,e,t,a,r=!0){if(t!==void 0){const i=E.Format.CSS.formatRGB(new E(t));if(e==="background"){const f=o.style.backgroundColor;o.style.backgroundColor=i,s(f===o.style.backgroundColor===r,a||`Incorrect ${e} color style found (found color: ${f}, expected ${i}).`)}else if(e==="foreground"){const f=o.style.color;o.style.color=i,s(f===o.style.color===r,a||`Incorrect ${e} color style found (found color: ${f}, expected ${i}).`)}else{const f=o.style.textDecorationColor;o.style.textDecorationColor=i,s(f===o.style.textDecorationColor===r,a||`Incorrect ${e} color style found (found color: ${f}, expected ${i}).`)}}else e==="background"?s(!o.style.backgroundColor,a||`Defined ${e} color style found when it should not have been defined`):e==="foreground"?s(!o.style.color,a||`Defined ${e} color style found when it should not have been defined`):s(!o.style.textDecorationColor,a||`Defined ${e} color style found when it should not have been defined`)}test("Expected single sequence operation",()=>{n("\x1B[1m",o=>{s(o.classList.contains("code-bold"),"Bold formatting not detected after bold ANSI code.")}),n("\x1B[3m",o=>{s(o.classList.contains("code-italic"),"Italic formatting not detected after italic ANSI code.")}),n("\x1B[4m",o=>{s(o.classList.contains("code-underline"),"Underline formatting not detected after underline ANSI code.")});for(let o=30;o<=37;o++){const e="code-foreground-colored";n("\x1B["+o+"m",t=>{s(t.classList.contains(e),`Custom foreground class not found on element after foreground ANSI code #${o}.`)}),n("\x1B["+o+";39m",t=>{s(t.classList.contains(e)===!1,"Custom foreground class still found after foreground cancellation code."),c(t,"foreground",void 0,"Custom color style still found after foreground cancellation code.")})}for(let o=40;o<=47;o++){const e="code-background-colored";n("\x1B["+o+"m",t=>{s(t.classList.contains(e),`Custom background class not found on element after background ANSI code #${o}.`)}),n("\x1B["+o+";49m",t=>{s(t.classList.contains(e)===!1,"Custom background class still found after background cancellation code."),c(t,"foreground",void 0,"Custom color style still found after background cancellation code.")})}for(let o=0;o<=255;o++){const e="code-underline-colored";n("\x1B[58;5;"+o+"m",t=>{s(t.classList.contains(e),`Custom underline color class not found on element after underline color ANSI code 58;5;${o}m.`)}),n("\x1B[58;5;"+o+"m\x1B[59m",t=>{s(t.classList.contains(e)===!1,"Custom underline color class still found after underline color cancellation code 59m."),c(t,"underline",void 0,"Custom underline color style still found after underline color cancellation code 59m.")})}n("\x1B[1;3;4;30;41m",o=>{s.strictEqual(5,o.classList.length,"Incorrect number of classes found for different ANSI codes."),s(o.classList.contains("code-bold")),s(o.classList.contains("code-italic"),"Different ANSI codes should not cancel each other."),s(o.classList.contains("code-underline"),"Different ANSI codes should not cancel each other."),s(o.classList.contains("code-foreground-colored"),"Different ANSI codes should not cancel each other."),s(o.classList.contains("code-background-colored"),"Different ANSI codes should not cancel each other.")}),n("\x1B[1;1;2;2;3;3;4;4;5;5;6;6;8;8;9;9;21;21;53;53;73;73;74;74m",o=>{s(o.classList.contains("code-bold")),s(o.classList.contains("code-italic"),"italic missing Doubles of each Different ANSI codes should not cancel each other or accumulate."),s(o.classList.contains("code-underline")===!1,"underline PRESENT and double underline should have removed it- Doubles of each Different ANSI codes should not cancel each other or accumulate."),s(o.classList.contains("code-dim"),"dim missing Doubles of each Different ANSI codes should not cancel each other or accumulate."),s(o.classList.contains("code-blink"),"blink missing Doubles of each Different ANSI codes should not cancel each other or accumulate."),s(o.classList.contains("code-rapid-blink"),"rapid blink mkssing Doubles of each Different ANSI codes should not cancel each other or accumulate."),s(o.classList.contains("code-double-underline"),"double underline missing Doubles of each Different ANSI codes should not cancel each other or accumulate."),s(o.classList.contains("code-hidden"),"hidden missing Doubles of each Different ANSI codes should not cancel each other or accumulate."),s(o.classList.contains("code-strike-through"),"strike-through missing Doubles of each Different ANSI codes should not cancel each other or accumulate."),s(o.classList.contains("code-overline"),"overline missing Doubles of each Different ANSI codes should not cancel each other or accumulate."),s(o.classList.contains("code-superscript")===!1,"superscript PRESENT and subscript should have removed it- Doubles of each Different ANSI codes should not cancel each other or accumulate."),s(o.classList.contains("code-subscript"),"subscript missing Doubles of each Different ANSI codes should not cancel each other or accumulate."),s.strictEqual(10,o.classList.length,"Incorrect number of classes found for each style code sent twice ANSI codes.")}),n("\x1B[1;2;5;6;21;8;9m",o=>{s.strictEqual(7,o.classList.length,"Incorrect number of classes found for different ANSI codes."),s(o.classList.contains("code-bold")),s(o.classList.contains("code-dim"),"Different ANSI codes should not cancel each other."),s(o.classList.contains("code-blink"),"Different ANSI codes should not cancel each other."),s(o.classList.contains("code-rapid-blink"),"Different ANSI codes should not cancel each other."),s(o.classList.contains("code-double-underline"),"Different ANSI codes should not cancel each other."),s(o.classList.contains("code-hidden"),"Different ANSI codes should not cancel each other."),s(o.classList.contains("code-strike-through"),"Different ANSI codes should not cancel each other.")}),n("\x1B[40;31;42;33m",o=>{s.strictEqual(2,o.classList.length),s(o.classList.contains("code-background-colored"),"New foreground ANSI code should not cancel existing background formatting."),s(o.classList.contains("code-foreground-colored"),"New background ANSI code should not cancel existing foreground formatting.")}),n("\x1B[1;1;4;1;4;4;1;4m",o=>{s(o.classList.contains("code-bold"),"Duplicate formatting codes should have no effect."),s(o.classList.contains("code-underline"),"Duplicate formatting codes should have no effect.")}),n("\x1B[1;4;m",o=>{s(o.classList.contains("code-bold"),"Extra semicolon after ANSI codes should have no effect."),s(o.classList.contains("code-underline"),"Extra semicolon after ANSI codes should have no effect.")}),n("\x1B[1;4;30;41;32;43;34;45;36;47;0m",o=>{s.strictEqual(0,o.classList.length,"Cancellation ANSI code should clear ALL formatting."),c(o,"background",void 0,"Cancellation ANSI code should clear ALL formatting."),c(o,"foreground",void 0,"Cancellation ANSI code should clear ALL formatting.")})}),test("Expected single 8-bit color sequence operation",()=>{for(let o=0;o<=15;o++)n("\x1B[38;5;"+o+"m",e=>{s(e.classList.contains("code-foreground-colored"),`Custom color class not found after foreground 8-bit color code 38;5;${o}`)}),n("\x1B[48;5;"+o+"m",e=>{s(e.classList.contains("code-background-colored"),`Custom color class not found after background 8-bit color code 48;5;${o}`)});for(let o=16;o<=255;o++)n("\x1B[38;5;"+o+"m",e=>{s(e.classList.contains("code-foreground-colored"),`Custom color class not found after foreground 8-bit color code 38;5;${o}`),c(e,"foreground",u(o),`Incorrect or no color styling found after foreground 8-bit color code 38;5;${o}`)}),n("\x1B[48;5;"+o+"m",e=>{s(e.classList.contains("code-background-colored"),`Custom color class not found after background 8-bit color code 48;5;${o}`),c(e,"background",u(o),`Incorrect or no color styling found after background 8-bit color code 48;5;${o}`)}),n("\x1B[58;5;"+o+"m",e=>{s(e.classList.contains("code-underline-colored"),`Custom color class not found after underline 8-bit color code 58;5;${o}`),c(e,"underline",u(o),`Incorrect or no color styling found after underline 8-bit color code 58;5;${o}`)});n("\x1B[48;5;300m",o=>{s.strictEqual(0,o.classList.length,"Bad ANSI color codes should have no effect.")}),n("\x1B[48;5;100;42;77;99;4;24m",o=>{s(o.classList.contains("code-background-colored")),s.strictEqual(1,o.classList.length),c(o,"background",u(100))})}),test("Expected single 24-bit color sequence operation",()=>{for(let o=0;o<=255;o+=64)for(let e=0;e<=255;e+=64)for(let t=0;t<=255;t+=64){const a=new l(o,e,t);n(`\x1B[38;2;${o};${e};${t}m`,r=>{s(r.classList.contains("code-foreground-colored"),'DOM should have "code-foreground-colored" class for advanced ANSI colors.'),c(r,"foreground",a)}),n(`\x1B[48;2;${o};${e};${t}m`,r=>{s(r.classList.contains("code-background-colored"),'DOM should have "code-foreground-colored" class for advanced ANSI colors.'),c(r,"background",a)}),n(`\x1B[58;2;${o};${e};${t}m`,r=>{s(r.classList.contains("code-underline-colored"),'DOM should have "code-underline-colored" class for advanced ANSI colors.'),c(r,"underline",a)})}n("\x1B[38;2;4;4m",o=>{s.strictEqual(0,o.classList.length,`Invalid color code "38;2;4;4" should not add a class (classes found: ${o.classList}).`),s(!o.style.color,`Invalid color code "38;2;4;4" should not add a custom color CSS (found color: ${o.style.color}).`)}),n("\x1B[48;2;150;300;5m",o=>{s.strictEqual(0,o.classList.length,`Nonexistent color code "48;2;150;300;5" should not add a class (classes found: ${o.classList}).`)}),n("\x1B[48;2;100;42;77;99;200;75m",o=>{s(o.classList.contains("code-background-colored"),'Color code with extra (valid) items "48;2;100;42;77;99;200;75" should still treat initial part as valid code and add class "code-background-custom".'),s.strictEqual(1,o.classList.length,`Color code with extra items "48;2;100;42;77;99;200;75" should add one and only one class. (classes found: ${o.classList}).`),c(o,"background",new l(100,42,77),'Color code "48;2;100;42;77;99;200;75" should  style background-color as rgb(100,42,77).')})});function d(o,e,t){t===void 0&&(t=e.length);const a=k(o,g,S,h.root);s.strictEqual(t,a.children.length);for(let r=0;r<t;r++){const i=a.children[r];L(i)?e[r](i):s.fail("Unexpected assertion error")}}test("Expected multiple sequence operation",()=>{n("\x1B[1m\x1B[3m\x1B[4m\x1B[32m",o=>{s(o.classList.contains("code-bold"),"Bold class not found after multiple different ANSI codes."),s(o.classList.contains("code-italic"),"Italic class not found after multiple different ANSI codes."),s(o.classList.contains("code-underline"),"Underline class not found after multiple different ANSI codes."),s(o.classList.contains("code-foreground-colored"),"Foreground color class not found after multiple different ANSI codes.")}),d("\x1B[1mbold\x1B[32mgreen\x1B[4munderline\x1B[3mitalic\x1B[0mnothing",[o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-bold"),"Bold class not found after bold ANSI code.")},o=>{s.strictEqual(2,o.classList.length),s(o.classList.contains("code-bold"),"Bold class not found after both bold and color ANSI codes."),s(o.classList.contains("code-foreground-colored"),"Color class not found after color ANSI code.")},o=>{s.strictEqual(3,o.classList.length),s(o.classList.contains("code-bold"),"Bold class not found after bold, color, and underline ANSI codes."),s(o.classList.contains("code-foreground-colored"),"Color class not found after color and underline ANSI codes."),s(o.classList.contains("code-underline"),"Underline class not found after underline ANSI code.")},o=>{s.strictEqual(4,o.classList.length),s(o.classList.contains("code-bold"),"Bold class not found after bold, color, underline, and italic ANSI codes."),s(o.classList.contains("code-foreground-colored"),"Color class not found after color, underline, and italic ANSI codes."),s(o.classList.contains("code-underline"),"Underline class not found after underline and italic ANSI codes."),s(o.classList.contains("code-italic"),"Italic class not found after italic ANSI code.")},o=>{s.strictEqual(0,o.classList.length,"One or more style classes still found after reset ANSI code.")}],5),d("\x1B[1mbold\x1B[22m\x1B[32mgreen\x1B[4munderline\x1B[24m\x1B[3mitalic\x1B[23mjustgreen\x1B[0mnothing",[o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-bold"),"Bold class not found after bold ANSI code.")},o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-bold")===!1,"Bold class found after both bold WAS TURNED OFF with 22m"),s(o.classList.contains("code-foreground-colored"),"Color class not found after color ANSI code.")},o=>{s.strictEqual(2,o.classList.length),s(o.classList.contains("code-foreground-colored"),"Color class not found after color and underline ANSI codes."),s(o.classList.contains("code-underline"),"Underline class not found after underline ANSI code.")},o=>{s.strictEqual(2,o.classList.length),s(o.classList.contains("code-foreground-colored"),"Color class not found after color, underline, and italic ANSI codes."),s(o.classList.contains("code-underline")===!1,"Underline class found after underline WAS TURNED OFF with 24m"),s(o.classList.contains("code-italic"),"Italic class not found after italic ANSI code.")},o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-italic")===!1,"Italic class found after italic WAS TURNED OFF with 23m"),s(o.classList.contains("code-foreground-colored"),"Color class not found after color ANSI code.")},o=>{s.strictEqual(0,o.classList.length,"One or more style classes still found after reset ANSI code.")}],6),d("\x1B[2mdim\x1B[22m\x1B[32mgreen\x1B[5mslowblink\x1B[25m\x1B[6mrapidblink\x1B[25mjustgreen\x1B[0mnothing",[o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-dim"),"Dim class not found after dim ANSI code 2m.")},o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-dim")===!1,"Dim class found after dim WAS TURNED OFF with 22m"),s(o.classList.contains("code-foreground-colored"),"Color class not found after color ANSI code.")},o=>{s.strictEqual(2,o.classList.length),s(o.classList.contains("code-foreground-colored"),"Color class not found after color and blink ANSI codes."),s(o.classList.contains("code-blink"),"Blink class not found after underline ANSI code 5m.")},o=>{s.strictEqual(2,o.classList.length),s(o.classList.contains("code-foreground-colored"),"Color class not found after color, blink, and rapid blink ANSI codes."),s(o.classList.contains("code-blink")===!1,"blink class found after underline WAS TURNED OFF with 25m"),s(o.classList.contains("code-rapid-blink"),"Rapid blink class not found after rapid blink ANSI code 6m.")},o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-rapid-blink")===!1,"Rapid blink class found after rapid blink WAS TURNED OFF with 25m"),s(o.classList.contains("code-foreground-colored"),"Color class not found after color ANSI code.")},o=>{s.strictEqual(0,o.classList.length,"One or more style classes still found after reset ANSI code.")}],6),d("\x1B[8mhidden\x1B[28m\x1B[32mgreen\x1B[9mcrossedout\x1B[29m\x1B[21mdoubleunderline\x1B[24mjustgreen\x1B[0mnothing",[o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-hidden"),"Hidden class not found after dim ANSI code 8m.")},o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-hidden")===!1,"Hidden class found after Hidden WAS TURNED OFF with 28m"),s(o.classList.contains("code-foreground-colored"),"Color class not found after color ANSI code.")},o=>{s.strictEqual(2,o.classList.length),s(o.classList.contains("code-foreground-colored"),"Color class not found after color and hidden ANSI codes."),s(o.classList.contains("code-strike-through"),"strike-through class not found after crossout/strikethrough ANSI code 9m.")},o=>{s.strictEqual(2,o.classList.length),s(o.classList.contains("code-foreground-colored"),"Color class not found after color, hidden, and crossedout ANSI codes."),s(o.classList.contains("code-strike-through")===!1,"strike-through class found after strike-through WAS TURNED OFF with 29m"),s(o.classList.contains("code-double-underline"),"Double underline class not found after double underline ANSI code 21m.")},o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-double-underline")===!1,"Double underline class found after double underline WAS TURNED OFF with 24m"),s(o.classList.contains("code-foreground-colored"),"Color class not found after color ANSI code.")},o=>{s.strictEqual(0,o.classList.length,"One or more style classes still found after reset ANSI code.")}],6),d("\x1B[4munderline\x1B[21mdouble underline\x1B[24munderlineOff\x1B[21mdouble underline\x1B[4munderline\x1B[24munderlineOff",[o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-underline"),"Underline class not found after underline ANSI code 4m.")},o=>{s(o.classList.contains("code-underline")===!1,"Underline class found after double underline code 21m"),s(o.classList.contains("code-double-underline"),"Double underline class not found after double underline code 21m"),s.strictEqual(1,o.classList.length,"should have found only double underline")},o=>{s.strictEqual(0,o.classList.length,"One or more style classes still found after underline off code 4m.")},o=>{s(o.classList.contains("code-double-underline"),"Double underline class not found after double underline code 21m"),s.strictEqual(1,o.classList.length,"should have found only double underline")},o=>{s(o.classList.contains("code-double-underline")===!1,"Double underline class found after underline code 4m"),s(o.classList.contains("code-underline"),"Underline class not found after underline ANSI code 4m."),s.strictEqual(1,o.classList.length,"should have found only underline")},o=>{s.strictEqual(0,o.classList.length,"One or more style classes still found after underline off code 4m.")}],6),d("\x1B[4munderline\x1B[9mand strikethough\x1B[53mand overline\x1B[24munderlineOff\x1B[55moverlineOff\x1B[29mstriklethoughOff",[o=>{s.strictEqual(1,o.classList.length,"should have found only underline"),s(o.classList.contains("code-underline"),"Underline class not found after underline ANSI code 4m.")},o=>{s(o.classList.contains("code-underline"),"Underline class NOT found after strikethrough code 9m"),s(o.classList.contains("code-strike-through"),"Strike through class not found after strikethrough code 9m"),s.strictEqual(2,o.classList.length,"should have found underline and strikethrough")},o=>{s(o.classList.contains("code-underline"),"Underline class NOT found after overline code 53m"),s(o.classList.contains("code-strike-through"),"Strike through class not found after overline code 53m"),s(o.classList.contains("code-overline"),"Overline class not found after overline code 53m"),s.strictEqual(3,o.classList.length,"should have found underline,strikethrough and overline")},o=>{s(o.classList.contains("code-underline")===!1,"Underline class found after underline off code 24m"),s(o.classList.contains("code-strike-through"),"Strike through class not found after underline off code 24m"),s(o.classList.contains("code-overline"),"Overline class not found after underline off code 24m"),s.strictEqual(2,o.classList.length,"should have found strikethrough and overline")},o=>{s(o.classList.contains("code-underline")===!1,"Underline class found after overline off code 55m"),s(o.classList.contains("code-overline")===!1,"Overline class found after overline off code 55m"),s(o.classList.contains("code-strike-through"),"Strike through class not found after overline off code 55m"),s.strictEqual(1,o.classList.length,"should have found only strikethrough")},o=>{s(o.classList.contains("code-strike-through")===!1,"Strike through class found after strikethrough off code 29m"),s.strictEqual(0,o.classList.length,"One or more style classes still found after strikethough OFF code 29m")}],6),d("\x1B[21mdoubleunderline\x1B[9mand strikethough\x1B[53mand overline\x1B[29mstriklethoughOff\x1B[55moverlineOff\x1B[24munderlineOff",[o=>{s.strictEqual(1,o.classList.length,"should have found only doubleunderline"),s(o.classList.contains("code-double-underline"),"Double underline class not found after double underline ANSI code 21m.")},o=>{s(o.classList.contains("code-double-underline"),"Double nderline class NOT found after strikethrough code 9m"),s(o.classList.contains("code-strike-through"),"Strike through class not found after strikethrough code 9m"),s.strictEqual(2,o.classList.length,"should have found doubleunderline and strikethrough")},o=>{s(o.classList.contains("code-double-underline"),"Double underline class NOT found after overline code 53m"),s(o.classList.contains("code-strike-through"),"Strike through class not found after overline code 53m"),s(o.classList.contains("code-overline"),"Overline class not found after overline code 53m"),s.strictEqual(3,o.classList.length,"should have found doubleunderline,overline and strikethrough")},o=>{s(o.classList.contains("code-double-underline"),"Double underline class NOT found after strikethrough off code 29m"),s(o.classList.contains("code-overline"),"Overline class NOT found after strikethrough off code 29m"),s(o.classList.contains("code-strike-through")===!1,"Strike through class found after strikethrough off code 29m"),s.strictEqual(2,o.classList.length,"should have found doubleunderline and overline")},o=>{s(o.classList.contains("code-double-underline"),"Double underline class NOT found after overline off code 55m"),s(o.classList.contains("code-strike-through")===!1,"Strike through class found after overline off code 55m"),s(o.classList.contains("code-overline")===!1,"Overline class found after overline off code 55m"),s.strictEqual(1,o.classList.length,"Should have found only double underline")},o=>{s(o.classList.contains("code-double-underline")===!1,"Double underline class found after underline off code 24m"),s.strictEqual(0,o.classList.length,"One or more style classes still found after underline OFF code 24m")}],6),d("\x1B[73msuperscript\x1B[74msubscript\x1B[75mneither\x1B[74msubscript\x1B[73msuperscript\x1B[75mneither",[o=>{s.strictEqual(1,o.classList.length,"should only be superscript class"),s(o.classList.contains("code-superscript"),"Superscript class not found after superscript ANSI code 73m.")},o=>{s(o.classList.contains("code-superscript")===!1,"Superscript class found after subscript code 74m"),s(o.classList.contains("code-subscript"),"Subscript class not found after subscript code 74m"),s.strictEqual(1,o.classList.length,"should have found only subscript class")},o=>{s.strictEqual(0,o.classList.length,"One or more style classes still found after superscript/subscript off code 75m.")},o=>{s(o.classList.contains("code-subscript"),"Subscript class not found after subscript code 74m"),s.strictEqual(1,o.classList.length,"should have found only subscript class")},o=>{s(o.classList.contains("code-subscript")===!1,"Subscript class found after superscript code 73m"),s(o.classList.contains("code-superscript"),"Superscript class not found after superscript ANSI code 73m."),s.strictEqual(1,o.classList.length,"should have found only superscript class")},o=>{s.strictEqual(0,o.classList.length,"One or more style classes still found after superscipt/subscript off code 75m.")}],6),d("\x1B[11mFont1\x1B[12mFont2\x1B[13mFont3\x1B[14mFont4\x1B[15mFont5\x1B[10mdefaultFont",[o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-font-1"),"font 1 class NOT found after switch to font 1 with ANSI code 11m")},o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-font-1")===!1,"font 1 class found after switch to font 2 with ANSI code 12m"),s(o.classList.contains("code-font-2"),"font 2 class NOT found after switch to font 2 with ANSI code 12m")},o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-font-2")===!1,"font 2 class found after switch to font 3 with ANSI code 13m"),s(o.classList.contains("code-font-3"),"font 3 class NOT found after switch to font 3 with ANSI code 13m")},o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-font-3")===!1,"font 3 class found after switch to font 4 with ANSI code 14m"),s(o.classList.contains("code-font-4"),"font 4 class NOT found after switch to font 4 with ANSI code 14m")},o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-font-4")===!1,"font 4 class found after switch to font 5 with ANSI code 15m"),s(o.classList.contains("code-font-5"),"font 5 class NOT found after switch to font 5 with ANSI code 15m")},o=>{s.strictEqual(0,o.classList.length,"One or more font style classes still found after reset to default font with ANSI code 10m.")}],6),d("\x1B[16mFont6\x1B[17mFont7\x1B[18mFont8\x1B[19mFont9\x1B[20mFont10\x1B[10mdefaultFont",[o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-font-6"),"font 6 class NOT found after switch to font 6 with ANSI code 16m")},o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-font-6")===!1,"font 6 class found after switch to font 7 with ANSI code 17m"),s(o.classList.contains("code-font-7"),"font 7 class NOT found after switch to font 7 with ANSI code 17m")},o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-font-7")===!1,"font 7 class found after switch to font 8 with ANSI code 18m"),s(o.classList.contains("code-font-8"),"font 8 class NOT found after switch to font 8 with ANSI code 18m")},o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-font-8")===!1,"font 8 class found after switch to font 9 with ANSI code 19m"),s(o.classList.contains("code-font-9"),"font 9 class NOT found after switch to font 9 with ANSI code 19m")},o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-font-9")===!1,"font 9 class found after switch to font 10 with ANSI code 20m"),s(o.classList.contains("code-font-10"),`font 10 class NOT found after switch to font 10 with ANSI code 20m (${o.classList})`)},o=>{s.strictEqual(0,o.classList.length,"One or more font style classes (2nd series) still found after reset to default font with ANSI code 10m.")}],6),d("\x1B[3mitalic\x1B[20mfont10blacklatter\x1B[23mitalicAndBlackletterOff\x1B[20mFont10Again\x1B[11mFont1\x1B[10mdefaultFont",[o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-italic"),"italic class NOT found after italic code ANSI code 3m")},o=>{s.strictEqual(2,o.classList.length),s(o.classList.contains("code-italic"),"no itatic class found after switch to font 10 (blackletter) with ANSI code 20m"),s(o.classList.contains("code-font-10"),"font 10 class NOT found after switch to font 10 with ANSI code 20m")},o=>{s.strictEqual(0,o.classList.length,"italic or blackletter (font10) class found after both switched off with ANSI code 23m")},o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-font-10"),"font 10 class NOT found after switch to font 10 with ANSI code 20m")},o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-font-10")===!1,"font 10 class found after switch to font 1 with ANSI code 11m"),s(o.classList.contains("code-font-1"),"font 1 class NOT found after switch to font 1 with ANSI code 11m")},o=>{s.strictEqual(0,o.classList.length,"One or more font style classes (2nd series) still found after reset to default font with ANSI code 10m.")}],6),d("\x1B[3mitalic\x1B[12mfont2\x1B[23mitalicOff\x1B[3mitalicFont2\x1B[10mjustitalic\x1B[23mnothing",[o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-italic"),"italic class NOT found after italic code ANSI code 3m")},o=>{s.strictEqual(2,o.classList.length),s(o.classList.contains("code-italic"),"no itatic class found after switch to font 2 with ANSI code 12m"),s(o.classList.contains("code-font-2"),"font 2 class NOT found after switch to font 2 with ANSI code 12m")},o=>{s.strictEqual(1,o.classList.length,"italic class found after both switched off with ANSI code 23m"),s(o.classList.contains("code-italic")===!1,"itatic class found after switching it OFF with ANSI code 23m"),s(o.classList.contains("code-font-2"),"font 2 class NOT found after switching italic off with ANSI code 23m")},o=>{s.strictEqual(2,o.classList.length),s(o.classList.contains("code-italic"),"no itatic class found after italic ANSI code 3m"),s(o.classList.contains("code-font-2"),"font 2 class NOT found after italic ANSI code 3m")},o=>{s.strictEqual(1,o.classList.length),s(o.classList.contains("code-font-2")===!1,"font 2 class found after switch to default font with ANSI code 10m"),s(o.classList.contains("code-italic"),"italic class NOT found after switch to default font with ANSI code 10m")},o=>{s.strictEqual(0,o.classList.length,"One or more classes still found after final italic removal with ANSI code 23m.")}],6),d("\x1B[38;2;10;20;30mfg10,20,30\x1B[48;2;167;168;169mbg167,168,169\x1B[7m8ReverseVideo\x1B[7mDuplicateReverseVideo\x1B[27mReverseOff\x1B[27mDupReverseOff",[o=>{s.strictEqual(1,o.classList.length,"Foreground ANSI color code should add one class."),s(o.classList.contains("code-foreground-colored"),"Foreground ANSI color codes should add custom foreground color class."),c(o,"foreground",new l(10,20,30),"24-bit RGBA ANSI color code (10,20,30) should add matching color inline style.")},o=>{s.strictEqual(2,o.classList.length,"background ANSI color codes should only add a single class."),s(o.classList.contains("code-background-colored"),"Background ANSI color codes should add custom background color class."),c(o,"background",new l(167,168,169),"24-bit RGBA ANSI background color code (167,168,169) should add matching color inline style."),s(o.classList.contains("code-foreground-colored"),"Still Foreground ANSI color codes should add custom foreground color class."),c(o,"foreground",new l(10,20,30),"Still 24-bit RGBA ANSI color code (10,20,30) should add matching color inline style.")},o=>{s.strictEqual(2,o.classList.length,"background ANSI color codes should only add a single class."),s(o.classList.contains("code-background-colored"),"Background ANSI color codes should add custom background color class."),c(o,"foreground",new l(167,168,169),"Reversed 24-bit RGBA ANSI foreground color code (167,168,169) should add matching former background color inline style."),s(o.classList.contains("code-foreground-colored"),"Still Foreground ANSI color codes should add custom foreground color class."),c(o,"background",new l(10,20,30),"Reversed 24-bit RGBA ANSI background color code (10,20,30) should add matching former foreground color inline style.")},o=>{s.strictEqual(2,o.classList.length,"After second Reverse Video - background ANSI color codes should only add a single class."),s(o.classList.contains("code-background-colored"),"After second Reverse Video - Background ANSI color codes should add custom background color class."),c(o,"foreground",new l(167,168,169),"After second Reverse Video - Reversed 24-bit RGBA ANSI foreground color code (167,168,169) should add matching former background color inline style."),s(o.classList.contains("code-foreground-colored"),"After second Reverse Video - Still Foreground ANSI color codes should add custom foreground color class."),c(o,"background",new l(10,20,30),"After second Reverse Video - Reversed 24-bit RGBA ANSI background color code (10,20,30) should add matching former foreground color inline style.")},o=>{s.strictEqual(2,o.classList.length,"Reversed Back - background ANSI color codes should only add a single class."),s(o.classList.contains("code-background-colored"),"Reversed Back - Background ANSI color codes should add custom background color class."),c(o,"background",new l(167,168,169),"Reversed Back - 24-bit RGBA ANSI background color code (167,168,169) should add matching color inline style."),s(o.classList.contains("code-foreground-colored"),"Reversed Back -  Foreground ANSI color codes should add custom foreground color class."),c(o,"foreground",new l(10,20,30),"Reversed Back -  24-bit RGBA ANSI color code (10,20,30) should add matching color inline style.")},o=>{s.strictEqual(2,o.classList.length,"2nd Reversed Back - background ANSI color codes should only add a single class."),s(o.classList.contains("code-background-colored"),"2nd Reversed Back - Background ANSI color codes should add custom background color class."),c(o,"background",new l(167,168,169),"2nd Reversed Back - 24-bit RGBA ANSI background color code (167,168,169) should add matching color inline style."),s(o.classList.contains("code-foreground-colored"),"2nd Reversed Back -  Foreground ANSI color codes should add custom foreground color class."),c(o,"foreground",new l(10,20,30),"2nd Reversed Back -  24-bit RGBA ANSI color code (10,20,30) should add matching color inline style.")}],6),d("\x1B[38;2;10;20;30mfg10,20,30\x1B[7m8ReverseVideo\x1B[27mReverseOff",[o=>{s.strictEqual(1,o.classList.length,"Foreground ANSI color code should add one class."),s(o.classList.contains("code-foreground-colored"),"Foreground ANSI color codes should add custom foreground color class."),c(o,"foreground",new l(10,20,30),"24-bit RGBA ANSI color code (10,20,30) should add matching color inline style.")},o=>{s.strictEqual(1,o.classList.length,"Background ANSI color codes should only add a single class."),s(o.classList.contains("code-background-colored"),"Background ANSI color codes should add custom background color class."),s(o.classList.contains("code-foreground-colored")===!1,"After Reverse with NO background the Foreground ANSI color codes should NOT BE SET."),c(o,"background",new l(10,20,30),"Reversed 24-bit RGBA ANSI background color code (10,20,30) should add matching former foreground color inline style.")},o=>{s.strictEqual(1,o.classList.length,"Reversed Back - background ANSI color codes should only add a single class."),s(o.classList.contains("code-background-colored")===!1,"AFTER Reversed Back - Background ANSI color should NOT BE SET."),s(o.classList.contains("code-foreground-colored"),"Reversed Back -  Foreground ANSI color codes should add custom foreground color class."),c(o,"foreground",new l(10,20,30),"Reversed Back -  24-bit RGBA ANSI color code (10,20,30) should add matching color inline style.")}],3),d("\x1B[48;2;167;168;169mbg167,168,169\x1B[7m8ReverseVideo\x1B[27mReverseOff",[o=>{s.strictEqual(1,o.classList.length,"Background ANSI color code should add one class."),s(o.classList.contains("code-background-colored"),"Background ANSI color codes should add custom foreground color class."),c(o,"background",new l(167,168,169),"24-bit RGBA ANSI color code (167, 168, 169) should add matching background color inline style.")},o=>{s.strictEqual(1,o.classList.length,"After ReverseVideo Foreground ANSI color codes should only add a single class."),s(o.classList.contains("code-foreground-colored"),"After ReverseVideo Foreground ANSI color codes should add custom background color class."),s(o.classList.contains("code-background-colored")===!1,"After Reverse with NO foreground color the background ANSI color codes should BE SET."),c(o,"foreground",new l(167,168,169),"Reversed 24-bit RGBA ANSI background color code (10,20,30) should add matching former background color inline style.")},o=>{s.strictEqual(1,o.classList.length,"Reversed Back - background ANSI color codes should only add a single class."),s(o.classList.contains("code-foreground-colored")===!1,"AFTER Reversed Back - Foreground ANSI color should NOT BE SET."),s(o.classList.contains("code-background-colored"),"Reversed Back -  Background ANSI color codes should add custom background color class."),c(o,"background",new l(167,168,169),"Reversed Back -  24-bit RGBA ANSI color code (10,20,30) should add matching background color inline style.")}],3),d("\x1B[58;2;101;102;103m24bitUnderline101,102,103\x1B[58;5;3m8bitsimpleUnderline\x1B[58;2;104;105;106m24bitUnderline104,105,106\x1B[58;5;101m8bitadvanced\x1B[58;2;200;200;200munderline200,200,200\x1B[59mUnderlineColorResetToDefault",[o=>{s.strictEqual(1,o.classList.length,"Underline ANSI color codes should only add a single class (1)."),s(o.classList.contains("code-underline-colored"),"Underline ANSI color codes should add custom underline color class."),c(o,"underline",new l(101,102,103),"24-bit RGBA ANSI color code (101,102,103) should add matching color inline style.")},o=>{s.strictEqual(1,o.classList.length,"Multiple underline ANSI color codes should only add a single class (2)."),s(o.classList.contains("code-underline-colored"),"Underline ANSI color codes should add custom underline color class."),c(o,"underline",new l(101,102,103),"Change to theme color SHOULD NOT STILL BE 24-bit RGBA ANSI color code (101,102,103) should add matching color inline style.",!1)},o=>{s.strictEqual(1,o.classList.length,"Multiple underline ANSI color codes should only add a single class (3)."),s(o.classList.contains("code-underline-colored"),"Underline ANSI color codes should add custom underline color class."),c(o,"underline",new l(104,105,106),"24-bit RGBA ANSI color code (100,100,100) should add matching color inline style.")},o=>{s.strictEqual(1,o.classList.length,"Multiple underline ANSI color codes should only add a single class (4)."),s(o.classList.contains("code-underline-colored"),"Underline ANSI color codes should add custom underline color class."),c(o,"underline",new l(104,105,106),"Change to theme color SHOULD NOT BE 24-bit RGBA ANSI color code (104,105,106) should add matching color inline style.",!1)},o=>{s.strictEqual(1,o.classList.length,"Multiple underline ANSI color codes should only add a single class 4."),s(o.classList.contains("code-underline-colored"),"Underline ANSI color codes should add custom underline color class."),c(o,"underline",new l(200,200,200),"after change underline color SHOULD BE 24-bit RGBA ANSI color code (200,200,200) should add matching color inline style.")},o=>{s.strictEqual(0,o.classList.length,"After Underline Color reset to default NO underline color class should be set."),c(o,"underline",void 0,"after RESET TO DEFAULT underline color SHOULD NOT BE SET (no color inline style.)")}],6),d("\x1B[34msimple\x1B[38;2;101;102;103m24bit\x1B[38;5;3m8bitsimple\x1B[38;2;104;105;106m24bitAgain\x1B[38;5;101m8bitadvanced",[o=>{s.strictEqual(1,o.classList.length,"Foreground ANSI color code should add one class."),s(o.classList.contains("code-foreground-colored"),"Foreground ANSI color codes should add custom foreground color class.")},o=>{s.strictEqual(1,o.classList.length,"Multiple foreground ANSI color codes should only add a single class."),s(o.classList.contains("code-foreground-colored"),"Foreground ANSI color codes should add custom foreground color class."),c(o,"foreground",new l(101,102,103),"24-bit RGBA ANSI color code (101,102,103) should add matching color inline style.")},o=>{s.strictEqual(1,o.classList.length,"Multiple foreground ANSI color codes should only add a single class."),s(o.classList.contains("code-foreground-colored"),"Foreground ANSI color codes should add custom foreground color class."),c(o,"foreground",new l(101,102,103),"SHOULD NOT LONGER BE 24-bit RGBA ANSI color code (101,102,103) after simple color change.",!1)},o=>{s.strictEqual(1,o.classList.length,"Multiple foreground ANSI color codes should only add a single class."),s(o.classList.contains("code-foreground-colored"),"Foreground ANSI color codes should add custom foreground color class."),c(o,"foreground",new l(104,105,106),"24-bit RGBA ANSI color code (104,105,106) should add matching color inline style.")},o=>{s.strictEqual(1,o.classList.length,"Multiple foreground ANSI color codes should only add a single class."),s(o.classList.contains("code-foreground-colored"),"Foreground ANSI color codes should add custom foreground color class."),c(o,"foreground",new l(104,105,106),"SHOULD NOT LONGER BE 24-bit RGBA ANSI color code (104,105,106) after advanced color change.",!1)}],5)});function b(o){const e=N(o);s(e.textContent===o)}test("Invalid codes treated as regular text",()=>{b("\x1B"),b("["),b("\x1B[");for(let o=0;o<50;o++){const e=p();b(e)}});function I(o){const e=N(o+"content");s.strictEqual("content",e.textContent),s.strictEqual(0,e.classList.length)}test("Empty sequence output",()=>{["","\x1B[;m","\x1B[1;;m","\x1B[m","\x1B[99m"].forEach(t=>{I(t)}),"ABCDHIJKfhmpsu".split("").forEach(t=>{I("\x1B[content"+t)})}),test("calcANSI8bitColor",()=>{for(let o=-10;o<=15;o+=.5)s(u(o)===void 0,"Values less than 16 passed to calcANSI8bitColor should return undefined.");for(let o=16.5;o<254;o+=1)s(u(o)===void 0,"Floats passed to calcANSI8bitColor should return undefined.");for(let o=256;o<300;o+=.5)s(u(o)===void 0,"Values grather than 255 passed to calcANSI8bitColor should return undefined.");for(let o=0;o<=5;o++)for(let e=0;e<=5;e++)for(let t=0;t<=5;t++){const a=u(16+o*36+e*6+t);s(a.r===Math.round(o*(255/5)),"Incorrect red value encountered for color"),s(a.g===Math.round(e*(255/5)),"Incorrect green value encountered for color"),s(a.b===Math.round(t*(255/5)),"Incorrect balue value encountered for color")}for(let o=232;o<=255;o++){const e=u(o);s(e.r===e.g),s(e.r===e.b),s(e.r===Math.round((o-232)/23*255))}})});
