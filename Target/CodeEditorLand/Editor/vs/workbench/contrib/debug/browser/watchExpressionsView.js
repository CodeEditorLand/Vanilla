var X=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var b=(c,r,e,t)=>{for(var s=t>1?void 0:t?U(r,e):r,n=c.length-1,i;n>=0;n--)(i=c[n])&&(s=(t?i(r,e,s):i(s))||s);return t&&s&&X(r,e,s),s},a=(c,r)=>(e,t)=>r(e,t,c);import{ListDragOverEffectPosition as x,ListDragOverEffectType as j}from"../../../../base/browser/ui/list/list.js";import{ElementsDragAndDropData as C,ListViewTargetSector as h}from"../../../../base/browser/ui/list/listView.js";import{RunOnceScheduler as $}from"../../../../base/common/async.js";import{Codicon as q}from"../../../../base/common/codicons.js";import{localize as p}from"../../../../nls.js";import{createAndFillInContextMenuActions as V}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{Action2 as M,IMenuService as O,MenuId as g,registerAction2 as S}from"../../../../platform/actions/common/actions.js";import{IConfigurationService as _}from"../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as y,IContextKeyService as R}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as Y,IContextViewService as G}from"../../../../platform/contextview/browser/contextView.js";import{IHoverService as L}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as J}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as Q}from"../../../../platform/keybinding/common/keybinding.js";import{WorkbenchAsyncDataTree as Z}from"../../../../platform/list/browser/listService.js";import{IOpenerService as ee}from"../../../../platform/opener/common/opener.js";import{ITelemetryService as te}from"../../../../platform/telemetry/common/telemetry.js";import{IThemeService as ie}from"../../../../platform/theme/common/themeService.js";import{ViewAction as re,ViewPane as se}from"../../../browser/parts/views/viewPane.js";import{IViewDescriptorService as ne}from"../../../common/views.js";import{CONTEXT_CAN_VIEW_MEMORY as oe,CONTEXT_VARIABLE_IS_READONLY as ae,CONTEXT_WATCH_EXPRESSIONS_EXIST as w,CONTEXT_WATCH_EXPRESSIONS_FOCUSED as ce,CONTEXT_WATCH_ITEM_TYPE as W,IDebugService as f,WATCH_VIEW_ID as E}from"../common/debug.js";import{Expression as d,Variable as m,VisualizedExpression as N}from"../common/debugModel.js";import{AbstractExpressionDataSource as le,AbstractExpressionsRenderer as de,renderViewTree as pe}from"./baseDebugView.js";import{DebugExpressionRenderer as ue}from"./debugExpressionRenderer.js";import{watchExpressionsAdd as he,watchExpressionsRemoveAll as ge}from"./debugIcons.js";import{VariablesRenderer as P,VisualizedVariableRenderer as D}from"./variablesView.js";const ve=1024;let A=!1,T=!1,I=class extends se{constructor(e,t,s,n,i,o,v,l,k,z,H,F,K){super(e,n,t,v,l,o,i,k,z,H,F);this.debugService=s;this.menu=K.createMenu(g.DebugWatchContext,l),this._register(this.menu),this.watchExpressionsUpdatedScheduler=new $(()=>{this.needsRefresh=!1,this.tree.updateChildren()},50),this.watchExpressionsExist=w.bindTo(l),this.variableReadonly=ae.bindTo(l),this.watchExpressionsExist.set(this.debugService.getModel().getWatchExpressions().length>0),this.watchItemType=W.bindTo(l),this.expressionRenderer=i.createInstance(ue)}watchExpressionsUpdatedScheduler;needsRefresh=!1;tree;watchExpressionsExist;watchItemType;variableReadonly;menu;expressionRenderer;renderBody(e){super.renderBody(e),this.element.classList.add("debug-pane"),e.classList.add("debug-watch");const t=pe(e),s=this.instantiationService.createInstance(u,this.expressionRenderer);this.tree=this.instantiationService.createInstance(Z,"WatchExpressions",t,new fe,[s,this.instantiationService.createInstance(P,this.expressionRenderer),this.instantiationService.createInstance(D,this.expressionRenderer)],this.instantiationService.createInstance(Ee),{accessibilityProvider:new Ie,identityProvider:{getId:i=>i.getId()},keyboardNavigationLabelProvider:{getKeyboardNavigationLabel:i=>{if(i!==this.debugService.getViewModel().getSelectedExpression()?.expression)return i.name}},dnd:new be(this.debugService),overrideStyles:this.getLocationBasedColors().listOverrideStyles}),this.tree.setInput(this.debugService),ce.bindTo(this.tree.contextKeyService),this._register(D.rendererOnVisualizationRange(this.debugService.getViewModel(),this.tree)),this._register(this.tree.onContextMenu(i=>this.onContextMenu(i))),this._register(this.tree.onMouseDblClick(i=>this.onMouseDblClick(i))),this._register(this.debugService.getModel().onDidChangeWatchExpressions(async i=>{this.watchExpressionsExist.set(this.debugService.getModel().getWatchExpressions().length>0),this.isBodyVisible()?(i&&!i.name&&(T=!0),await this.tree.updateChildren(),T=!1,i instanceof d&&this.tree.reveal(i)):this.needsRefresh=!0})),this._register(this.debugService.getViewModel().onDidFocusStackFrame(()=>{if(!this.isBodyVisible()){this.needsRefresh=!0;return}this.watchExpressionsUpdatedScheduler.isScheduled()||this.watchExpressionsUpdatedScheduler.schedule()})),this._register(this.debugService.getViewModel().onWillUpdateViews(()=>{A||this.tree.updateChildren()})),this._register(this.onDidChangeBodyVisibility(i=>{i&&this.needsRefresh&&this.watchExpressionsUpdatedScheduler.schedule()}));let n;this._register(this.debugService.getViewModel().onDidSelectExpression(i=>{const o=i?.expression;o&&this.tree.hasNode(o)?(n=this.tree.options.horizontalScrolling,n&&this.tree.updateOptions({horizontalScrolling:!1}),o.name&&this.tree.rerender(o)):!o&&n!==void 0&&(this.tree.updateOptions({horizontalScrolling:n}),n=void 0)})),this._register(this.debugService.getViewModel().onDidEvaluateLazyExpression(async i=>{i instanceof m&&this.tree.hasNode(i)&&(await this.tree.updateChildren(i,!1,!0),await this.tree.expand(i))}))}layoutBody(e,t){super.layoutBody(e,t),this.tree.layout(e,t)}focus(){super.focus(),this.tree.domFocus()}collapseAll(){this.tree.collapseAll()}onMouseDblClick(e){if(e.browserEvent.target.className.indexOf("twistie")>=0)return;const t=e.element,s=this.debugService.getViewModel().getSelectedExpression();t instanceof d&&t!==s?.expression||t instanceof N&&t.treeItem.canEdit?this.debugService.getViewModel().setSelectedExpression(t,!1):t||this.debugService.addWatchExpression()}onContextMenu(e){const t=e.element,s=this.tree.getSelection();this.watchItemType.set(t instanceof d?"expression":t instanceof m?"variable":void 0);const n=[],i=t instanceof m?t.presentationHint?.attributes:void 0;this.variableReadonly.set(!!i&&i.indexOf("readOnly")>=0||!!t?.presentationHint?.lazy),V(this.menu,{arg:t,shouldForwardArgs:!0},n),this.contextMenuService.showContextMenu({getAnchor:()=>e.anchor,getActions:()=>n,getActionsContext:()=>t&&s.includes(t)?s:t?[t]:[]})}};I=b([a(1,Y),a(2,f),a(3,Q),a(4,J),a(5,ne),a(6,_),a(7,R),a(8,ee),a(9,ie),a(10,te),a(11,L),a(12,O)],I);class fe{getHeight(r){return 22}getTemplateId(r){return r instanceof d?u.ID:r instanceof N?D.ID:P.ID}}function B(c){return typeof c.getConfigurationManager=="function"}class Ee extends le{hasChildren(r){return B(r)||r.hasChildren}doGetChildren(r){if(B(r)){const e=r,t=e.getModel().getWatchExpressions(),s=e.getViewModel();return Promise.all(t.map(n=>n.name&&!T?n.evaluate(s.focusedSession,s.focusedStackFrame,"watch").then(()=>n):Promise.resolve(n)))}return r.getChildren()}}let u=class extends de{constructor(e,t,s,n,i,o,v){super(n,i,o);this.expressionRenderer=e;this.menuService=t;this.contextKeyService=s;this.configurationService=v}static ID="watchexpression";get templateId(){return u.ID}renderElement(e,t,s){s.elementDisposable.clear(),s.elementDisposable.add(this.configurationService.onDidChangeConfiguration(n=>{n.affectsConfiguration("debug.showVariableTypes")&&super.renderExpressionElement(e.element,e,s)})),super.renderExpressionElement(e.element,e,s)}renderExpression(e,t,s){let n;t.type.textContent="";const i=this.configurationService.getValue("debug").showVariableTypes;i&&e.type?(n=typeof e.value=="string"?`${e.name}: `:e.name,t.type.textContent=e.type+" ="):n=typeof e.value=="string"?`${e.name} =`:e.name;let o;e.type?i?o=`${e.name}`:o=e.type===e.value?e.type:`${e.type}`:o=e.value,t.label.set(n,s,o),t.elementDisposable.add(this.expressionRenderer.renderValue(t.value,e,{showChanged:!0,maxValueLength:ve,colorize:!0,session:e.getSession()}))}getInputBoxOptions(e,t){return t?{initialValue:e.value,ariaLabel:p("typeNewValue","Type new value"),onFinish:async(s,n)=>{if(n&&s){const i=this.debugService.getViewModel().focusedStackFrame;i&&(e instanceof m||e instanceof d)&&(await e.setExpression(s,i),this.debugService.getViewModel().updateViews())}}}:{initialValue:e.name?e.name:"",ariaLabel:p("watchExpressionInputAriaLabel","Type watch expression"),placeholder:p("watchExpressionPlaceholder","Expression to watch"),onFinish:(s,n)=>{n&&s?(this.debugService.renameWatchExpression(e.getId(),s),A=!0,this.debugService.getViewModel().updateViews(),A=!1):e.name||this.debugService.removeWatchExpressions(e.getId())}}}renderActionBar(e,t){const s=me(this.contextKeyService,t),n=t,i=this.menuService.getMenuActions(g.DebugWatchContext,s,{arg:n,shouldForwardArgs:!1}),o=[];V(i,{primary:o,secondary:[]},"inline"),e.clear(),e.context=n,e.push(o,{icon:!0,label:!1})}};u=b([a(1,O),a(2,R),a(3,f),a(4,G),a(5,L),a(6,_)],u);function me(c,r){return c.createOverlay([[oe.key,r.memoryReference!==void 0],[W.key,"expression"]])}class Ie{getWidgetAriaLabel(){return p({comment:["Debug is a noun in this context, not a verb."],key:"watchAriaTreeLabel"},"Debug Watch Expressions")}getAriaLabel(r){return r instanceof d?p("watchExpressionAriaLabel","{0}, value {1}",r.name,r.value):p("watchVariableAriaLabel","{0}, value {1}",r.name,r.value)}}class be{constructor(r){this.debugService=r}onDragOver(r,e,t,s,n){if(!(r instanceof C))return!1;const i=r.elements;if(!(i.length>0&&i[0]instanceof d))return!1;let o;if(t===void 0)o=x.After,t=-1;else switch(s){case h.TOP:case h.CENTER_TOP:o=x.Before;break;case h.CENTER_BOTTOM:case h.BOTTOM:o=x.After;break}return{accept:!0,effect:{type:j.Move,position:o},feedback:[t]}}getDragURI(r){return!(r instanceof d)||r===this.debugService.getViewModel().getSelectedExpression()?.expression?null:r.getId()}getDragLabel(r){if(r.length===1)return r[0].name}drop(r,e,t,s,n){if(!(r instanceof C))return;const i=r.elements[0];if(!(i instanceof d))throw new Error("Invalid dragged element");const o=this.debugService.getModel().getWatchExpressions(),v=o.indexOf(i);let l;if(e instanceof d){switch(l=o.indexOf(e),s){case h.BOTTOM:case h.CENTER_BOTTOM:l++;break}v<l&&l--}else l=o.length-1;this.debugService.moveWatchExpression(i.getId(),l)}dispose(){}}S(class extends re{constructor(){super({id:"watch.collapse",viewId:E,title:p("collapse","Collapse All"),f1:!1,icon:q.collapseAll,precondition:w,menu:{id:g.ViewTitle,order:30,group:"navigation",when:y.equals("view",E)}})}runInView(r,e){e.collapseAll()}});const xe="workbench.debug.viewlet.action.addWatchExpression",Se=p("addWatchExpression","Add Expression");S(class extends M{constructor(){super({id:xe,title:Se,f1:!1,icon:he,menu:{id:g.ViewTitle,group:"navigation",when:y.equals("view",E)}})}run(r){r.get(f).addWatchExpression()}});const ye="workbench.debug.viewlet.action.removeAllWatchExpressions",we=p("removeAllWatchExpressions","Remove All Expressions");S(class extends M{constructor(){super({id:ye,title:we,f1:!1,icon:ge,precondition:w,menu:{id:g.ViewTitle,order:20,group:"navigation",when:y.equals("view",E)}})}run(r){r.get(f).removeWatchExpressions()}});export{xe as ADD_WATCH_ID,Se as ADD_WATCH_LABEL,ye as REMOVE_WATCH_EXPRESSIONS_COMMAND_ID,we as REMOVE_WATCH_EXPRESSIONS_LABEL,u as WatchExpressionsRenderer,I as WatchExpressionsView};
