var b=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var u=(o,s,i,e)=>{for(var t=e>1?void 0:e?k(s,i):s,r=o.length-1,n;r>=0;r--)(n=o[r])&&(t=(e?n(s,i,t):n(t))||t);return e&&t&&b(s,i,t),t},l=(o,s)=>(i,e)=>s(i,e,o);import{distinct as N}from"../../../../base/common/arrays.js";import{Event as L}from"../../../../base/common/event.js";import{Disposable as y}from"../../../../base/common/lifecycle.js";import{ThemeIcon as f}from"../../../../base/common/themables.js";import{Constants as E}from"../../../../base/common/uint.js";import{Range as h}from"../../../../editor/common/core/range.js";import{GlyphMarginLane as I,OverviewRulerLane as S,TrackedRangeStickiness as A}from"../../../../editor/common/model.js";import{localize as C}from"../../../../nls.js";import{ILogService as R}from"../../../../platform/log/common/log.js";import{registerColor as M}from"../../../../platform/theme/common/colorRegistry.js";import{themeColorFromId as D}from"../../../../platform/theme/common/themeService.js";import{IUriIdentityService as _}from"../../../../platform/uriIdentity/common/uriIdentity.js";import{IDebugService as O}from"../common/debug.js";import{debugStackframe as F,debugStackframeFocused as T}from"./debugIcons.js";import"./media/callStackEditorContribution.css";const w=M("editor.stackFrameHighlightBackground",{dark:"#ffff0033",light:"#ffff6673",hcDark:"#ffff0033",hcLight:"#ffff6673"},C("topStackFrameLineHighlight","Background color for the highlight of line at the top stack frame position.")),x=M("editor.focusedStackFrameHighlightBackground",{dark:"#7abd7a4d",light:"#cee7ce73",hcDark:"#7abd7a4d",hcLight:"#cee7ce73"},C("focusedStackFrameLineHighlight","Background color for the highlight of line at focused stack frame position.")),g=A.NeverGrowsWhenTypingAtEdges,B={description:"top-stack-frame-margin",glyphMarginClassName:f.asClassName(F),glyphMargin:{position:I.Right},zIndex:9999,stickiness:g,overviewRuler:{position:S.Full,color:D(w)}},U={description:"focused-stack-frame-margin",glyphMarginClassName:f.asClassName(T),glyphMargin:{position:I.Right},zIndex:9999,stickiness:g,overviewRuler:{position:S.Full,color:D(x)}},G={description:"top-stack-frame-decoration",isWholeLine:!0,className:"debug-top-stack-frame-line",stickiness:g},$={description:"focused-stack-frame-decoration",isWholeLine:!0,className:"debug-focused-stack-frame-line",stickiness:g},H=o=>({description:"top-stack-frame-inline-decoration",before:{content:"\uEB8B",inlineClassName:o?"debug-top-stack-frame-column start-of-line":"debug-top-stack-frame-column",inlineClassNameAffectsLetterSpacing:!0}});function K(o,s,i){const e=[],t=new h(o.range.startLineNumber,o.range.startColumn,o.range.startLineNumber,E.MAX_SAFE_SMALL_INTEGER),r=new h(o.range.startLineNumber,o.range.startColumn,o.range.startLineNumber,o.range.startColumn+1),n=o.thread.getTopStackFrame();return o.getId()===n?.getId()?(s&&e.push({options:B,range:r}),e.push({options:G,range:t}),o.range.startColumn>1&&e.push({options:H(i),range:t})):(s&&e.push({options:U,range:r}),e.push({options:$,range:t})),e}let p=class extends y{constructor(i,e,t,r){super();this.editor=i;this.debugService=e;this.uriIdentityService=t;this.logService=r;const n=()=>this.decorations.set(this.createCallStackDecorations());this._register(L.any(this.debugService.getViewModel().onDidFocusStackFrame,this.debugService.getModel().onDidChangeCallStack)(()=>{n()})),this._register(this.editor.onDidChangeModel(c=>{c.newModelUrl&&n()})),n()}decorations=this.editor.createDecorationsCollection();createCallStackDecorations(){const i=this.editor;if(!i.hasModel())return[];const e=this.debugService.getViewModel().focusedStackFrame,t=[];return this.debugService.getModel().getSessions().forEach(r=>{const n=r===e?.thread.session;r.getAllThreads().forEach(c=>{if(c.stopped){const d=c.getCallStack(),m=[];d.length>0&&(e&&!e.equals(d[0])&&m.push(e),m.push(d[0])),m.forEach(a=>{if(a&&this.uriIdentityService.extUri.isEqual(a.source.uri,i.getModel()?.uri)){if(a.range.startLineNumber>i.getModel()?.getLineCount()||a.range.startLineNumber<1){this.logService.warn(`CallStackEditorContribution: invalid stack frame line number: ${a.range.startLineNumber}`);return}const v=i.getModel().getLineFirstNonWhitespaceColumn(a.range.startLineNumber)>=a.range.startColumn;t.push(...K(a,n,v))}})}})}),N(t,r=>`${r.options.className} ${r.options.glyphMarginClassName} ${r.range.startLineNumber} ${r.range.startColumn}`)}dispose(){super.dispose(),this.decorations.clear()}};p=u([l(1,O),l(2,_),l(3,R)],p);export{p as CallStackEditorContribution,$ as FOCUSED_STACK_FRAME_DECORATION,G as TOP_STACK_FRAME_DECORATION,K as createDecorationsForStackFrame,x as focusedStackFrameColor,H as makeStackFrameColumnDecoration,w as topStackFrameColor};
