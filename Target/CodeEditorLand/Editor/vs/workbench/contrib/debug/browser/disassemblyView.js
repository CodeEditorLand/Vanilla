var Q=Object.defineProperty;var Z=Object.getOwnPropertyDescriptor;var v=(p,n,e,t)=>{for(var s=t>1?void 0:t?Z(n,e):n,o=p.length-1,r;o>=0;o--)(r=p[o])&&(s=(t?r(n,e,s):r(s))||s);return t&&s&&Q(n,e,s),s},f=(p,n)=>(e,t)=>n(e,t,p);import{PixelRatio as ee}from"../../../../base/browser/pixelRatio.js";import{$ as B,addStandardDisposableListener as C,append as w}from"../../../../base/browser/dom.js";import"../../../../base/browser/ui/list/listWidget.js";import"../../../../base/browser/ui/table/table.js";import{binarySearch2 as F}from"../../../../base/common/arrays.js";import"../../../../base/common/color.js";import{Emitter as te}from"../../../../base/common/event.js";import{Disposable as se,dispose as O}from"../../../../base/common/lifecycle.js";import{isAbsolute as ie}from"../../../../base/common/path.js";import{Constants as V}from"../../../../base/common/uint.js";import{URI as G}from"../../../../base/common/uri.js";import{applyFontInfo as ne}from"../../../../editor/browser/config/domFontInfo.js";import{isCodeEditor as re}from"../../../../editor/browser/editorBrowser.js";import{BareFontInfo as oe}from"../../../../editor/common/config/fontInfo.js";import{Range as ae}from"../../../../editor/common/core/range.js";import{StringBuilder as W}from"../../../../editor/common/core/stringBuilder.js";import"../../../../editor/common/model.js";import{ITextModelService as de}from"../../../../editor/common/services/resolverService.js";import{localize as b}from"../../../../nls.js";import{IConfigurationService as ce}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as le}from"../../../../platform/contextkey/common/contextkey.js";import{TextEditorSelectionRevealType as ue}from"../../../../platform/editor/common/editor.js";import{IInstantiationService as me}from"../../../../platform/instantiation/common/instantiation.js";import{WorkbenchTable as fe}from"../../../../platform/list/browser/listService.js";import{ILogService as ge}from"../../../../platform/log/common/log.js";import{IStorageService as he}from"../../../../platform/storage/common/storage.js";import{ITelemetryService as Ie}from"../../../../platform/telemetry/common/telemetry.js";import{editorBackground as be}from"../../../../platform/theme/common/colorRegistry.js";import{IThemeService as $}from"../../../../platform/theme/common/themeService.js";import{IUriIdentityService as pe}from"../../../../platform/uriIdentity/common/uriIdentity.js";import{EditorPane as _e}from"../../../browser/parts/editor/editorPane.js";import"../../../common/contributions.js";import{focusedStackFrameColor as q,topStackFrameColor as j}from"./callStackEditorContribution.js";import*as T from"./debugIcons.js";import{CONTEXT_LANGUAGE_SUPPORTS_DISASSEMBLE_REQUEST as Se,DISASSEMBLY_VIEW_ID as ve,IDebugService as x,State as E}from"../common/debug.js";import{InstructionBreakpoint as U}from"../common/debugModel.js";import{getUriFromSource as Te}from"../common/debugSource.js";import{isUri as De,sourcesEqual as ye}from"../common/debugUtils.js";import{IEditorService as Y}from"../../../services/editor/common/editorService.js";import"../../../services/editor/common/editorGroupsService.js";const K={allowBreakpoint:!1,isBreakpointSet:!1,isBreakpointEnabled:!1,instructionReference:"",instructionOffset:0,instructionReferenceOffset:0,address:0n,instruction:{address:"-1",instruction:b("instructionNotAvailable","Disassembly not available.")}};let g=class extends _e{constructor(e,t,s,o,r,i,c){super(ve,e,t,s,o);this._configurationService=r;this._instantiationService=i;this._debugService=c;this._disassembledInstructions=void 0,this._onDidChangeStackFrame=this._register(new te({leakWarningThreshold:1e3})),this._previousDebuggingState=c.state,this._register(r.onDidChangeConfiguration(a=>{if(a.affectsConfiguration("debug")){const l=this._configurationService.getValue("debug").disassemblyView.showSourceCode;this._enableSourceCodeRender!==l?this._enableSourceCodeRender=l:this._disassembledInstructions?.rerender()}}))}static NUM_INSTRUCTIONS_TO_LOAD=50;_fontInfo;_disassembledInstructions;_onDidChangeStackFrame;_previousDebuggingState;_instructionBpList=[];_enableSourceCodeRender=!0;_loadingLock=!1;_referenceToMemoryAddress=new Map;get fontInfo(){return this._fontInfo||(this._fontInfo=this.createFontInfo(),this._register(this._configurationService.onDidChangeConfiguration(e=>{e.affectsConfiguration("editor")&&(this._fontInfo=this.createFontInfo())}))),this._fontInfo}createFontInfo(){return oe.createFromRawSettings(this._configurationService.getValue("editor"),ee.getInstance(this.window).value)}get currentInstructionAddresses(){return this._debugService.getModel().getSessions(!1).map(e=>e.getAllThreads()).reduce((e,t)=>e.concat(t),[]).map(e=>e.getTopStackFrame()).map(e=>e?.instructionPointerReference).map(e=>e?this.getReferenceAddress(e):void 0)}get focusedCurrentInstructionReference(){return this._debugService.getViewModel().focusedStackFrame?.thread.getTopStackFrame()?.instructionPointerReference}get focusedCurrentInstructionAddress(){const e=this.focusedCurrentInstructionReference;return e?this.getReferenceAddress(e):void 0}get focusedInstructionReference(){return this._debugService.getViewModel().focusedStackFrame?.instructionPointerReference}get focusedInstructionAddress(){const e=this.focusedInstructionReference;return e?this.getReferenceAddress(e):void 0}get isSourceCodeRender(){return this._enableSourceCodeRender}get debugSession(){return this._debugService.getViewModel().focusedSession}get onDidChangeStackFrame(){return this._onDidChangeStackFrame.event}get focusedAddressAndOffset(){const e=this._disassembledInstructions?.getFocusedElements()[0];if(!e)return;const t=e.instructionReference,s=Number(e.address-this.getReferenceAddress(t));return{reference:t,offset:s,address:e.address}}createEditor(e){this._enableSourceCodeRender=this._configurationService.getValue("debug").disassemblyView.showSourceCode;const t=this.fontInfo.lineHeight,s=this,o=new class{headerRowHeight=0;getHeight(i){return s.isSourceCodeRender&&i.showSourceLocation&&i.instruction.location?.path&&i.instruction.line?i.instruction.endLine?t*(i.instruction.endLine-i.instruction.line+2):t*2:t}},r=this._register(this._instantiationService.createInstance(h,this));this._disassembledInstructions=this._register(this._instantiationService.createInstance(fe,"DisassemblyView",e,o,[{label:"",tooltip:"",weight:0,minimumWidth:this.fontInfo.lineHeight,maximumWidth:this.fontInfo.lineHeight,templateId:I.TEMPLATE_ID,project(i){return i}},{label:b("disassemblyTableColumnLabel","instructions"),tooltip:"",weight:.3,templateId:h.TEMPLATE_ID,project(i){return i}}],[this._instantiationService.createInstance(I,this),r],{identityProvider:{getId:i=>i.instruction.address},horizontalScrolling:!1,overrideStyles:{listBackground:be},multipleSelectionSupport:!1,setRowLineHeight:!1,openOnSingleClick:!1,accessibilityProvider:new Ce,mouseSupport:!1})),this._disassembledInstructions.domNode.classList.add("disassembly-view"),this.focusedInstructionReference&&this.reloadDisassembly(this.focusedInstructionReference,0),this._register(this._disassembledInstructions.onDidScroll(i=>{if(!this._loadingLock)if(i.oldScrollTop>i.scrollTop&&i.scrollTop<i.height){this._loadingLock=!0;const c=Math.floor(i.scrollTop/this.fontInfo.lineHeight);this.scrollUp_LoadDisassembledInstructions(g.NUM_INSTRUCTIONS_TO_LOAD).then(a=>{a>0&&this._disassembledInstructions.reveal(c+a,0),this._loadingLock=!1})}else i.oldScrollTop<i.scrollTop&&i.scrollTop+i.height>i.scrollHeight-i.height&&(this._loadingLock=!0,this.scrollDown_LoadDisassembledInstructions(g.NUM_INSTRUCTIONS_TO_LOAD).then(()=>{this._loadingLock=!1}))})),this._register(this._debugService.getViewModel().onDidFocusStackFrame(({stackFrame:i})=>{this._disassembledInstructions&&i?.instructionPointerReference&&this.goToInstructionAndOffset(i.instructionPointerReference,0),this._onDidChangeStackFrame.fire()})),this._register(this._debugService.getModel().onDidChangeBreakpoints(i=>{if(i&&this._disassembledInstructions){let c=!1;i.added?.forEach(a=>{if(a instanceof U){const l=this.getIndexFromReferenceAndOffset(a.instructionReference,a.offset);l>=0&&(this._disassembledInstructions.row(l).isBreakpointSet=!0,this._disassembledInstructions.row(l).isBreakpointEnabled=a.enabled,c=!0)}}),i.removed?.forEach(a=>{if(a instanceof U){const l=this.getIndexFromReferenceAndOffset(a.instructionReference,a.offset);l>=0&&(this._disassembledInstructions.row(l).isBreakpointSet=!1,c=!0)}}),i.changed?.forEach(a=>{if(a instanceof U){const l=this.getIndexFromReferenceAndOffset(a.instructionReference,a.offset);l>=0&&this._disassembledInstructions.row(l).isBreakpointEnabled!==a.enabled&&(this._disassembledInstructions.row(l).isBreakpointEnabled=a.enabled,c=!0)}}),this._instructionBpList=this._debugService.getModel().getInstructionBreakpoints();for(const a of this._instructionBpList)this.primeMemoryReference(a.instructionReference);c&&this._onDidChangeStackFrame.fire()}})),this._register(this._debugService.onDidChangeState(i=>{(i===E.Running||i===E.Stopped)&&this._previousDebuggingState!==E.Running&&this._previousDebuggingState!==E.Stopped&&(this.clear(),this._enableSourceCodeRender=this._configurationService.getValue("debug").disassemblyView.showSourceCode),this._previousDebuggingState=i,this._onDidChangeStackFrame.fire()}))}layout(e){this._disassembledInstructions?.layout(e.height)}async goToInstructionAndOffset(e,t,s){let o=this._referenceToMemoryAddress.get(e);o===void 0&&(await this.loadDisassembledInstructions(e,0,-g.NUM_INSTRUCTIONS_TO_LOAD,g.NUM_INSTRUCTIONS_TO_LOAD*2),o=this._referenceToMemoryAddress.get(e)),o&&this.goToAddress(o+BigInt(t),s)}getReferenceAddress(e){return this._referenceToMemoryAddress.get(e)}goToAddress(e,t){if(!this._disassembledInstructions||!e)return!1;const s=this.getIndexFromAddress(e);return s>=0?(this._disassembledInstructions.reveal(s),t&&(this._disassembledInstructions.domFocus(),this._disassembledInstructions.setFocus([s])),!0):!1}async scrollUp_LoadDisassembledInstructions(e){const t=this._disassembledInstructions?.row(0);return t?this.loadDisassembledInstructions(t.instructionReference,t.instructionReferenceOffset,t.instructionOffset-e,e):0}async scrollDown_LoadDisassembledInstructions(e){const t=this._disassembledInstructions?.row(this._disassembledInstructions?.length-1);return t?this.loadDisassembledInstructions(t.instructionReference,t.instructionReferenceOffset,t.instructionOffset+1,e):0}async primeMemoryReference(e){if(this._referenceToMemoryAddress.has(e))return!0;const t=await this.debugSession?.disassemble(e,0,0,1);if(t&&t.length>0)try{return this._referenceToMemoryAddress.set(e,BigInt(t[0].address)),!0}catch{return!1}return!1}async loadDisassembledInstructions(e,t,s,o){const r=this.debugSession,i=await r?.disassemble(e,t,s,o);if(!this._referenceToMemoryAddress.has(e)&&s!==0&&await this.loadDisassembledInstructions(e,0,0,g.NUM_INSTRUCTIONS_TO_LOAD),r&&i&&this._disassembledInstructions){const c=[];let a,l;for(let d=0;d<i.length;d++){const u=i[d],y=s+d;if(u.location&&(a=u.location,l=void 0),u.line){const P={startLineNumber:u.line,startColumn:u.column??0,endLineNumber:u.endLine??u.line,endColumn:u.endColumn??0};ae.equalsRange(P,l??null)||(l=P,u.location=a)}let N;try{N=BigInt(u.address)}catch{continue}const J={allowBreakpoint:!0,isBreakpointSet:!1,isBreakpointEnabled:!1,instructionReference:e,instructionReferenceOffset:t,instructionOffset:y,instruction:u,address:N};c.push(J),t===0&&y===0&&this._referenceToMemoryAddress.set(e,N)}if(c.length===0)return 0;const _=this._referenceToMemoryAddress.get(e),D=this._instructionBpList.map(d=>{const u=this._referenceToMemoryAddress.get(d.instructionReference);if(u)return{enabled:d.enabled,address:u+BigInt(d.offset||0)}});if(_!==void 0)for(const d of c){const u=D.find(y=>y?.address===d.address);u&&(d.isBreakpointSet=!0,d.isBreakpointEnabled=u.enabled)}const m=this._disassembledInstructions;m.length===1&&this._disassembledInstructions.row(0)===K&&m.splice(0,1);const k=c[0].address,X=c[c.length-1].address,A=F(m.length,d=>Number(m.row(d).address-k)),M=A<0?~A:A,R=F(m.length,d=>Number(m.row(d).address-X)),H=(R<0?~R:R+1)-M;let S;for(let d=M-1;d>=0;d--){const{instruction:u}=m.row(d);if(u.location&&u.line!==void 0){S=u;break}}const z=d=>d.line!==void 0&&d.location!==void 0&&(!S||!ye(d.location,S.location)||d.line!==S.line);for(const d of c)z(d.instruction)&&(d.showSourceLocation=!0,S=d.instruction);return m.splice(M,H,c),c.length-H}return 0}getIndexFromReferenceAndOffset(e,t){const s=this._referenceToMemoryAddress.get(e);return s===void 0?-1:this.getIndexFromAddress(s+BigInt(t))}getIndexFromAddress(e){const t=this._disassembledInstructions;return t&&t.length>0?F(t.length,s=>{const o=t.row(s);return Number(o.address-e)}):-1}reloadDisassembly(e,t){this._disassembledInstructions&&(this._loadingLock=!0,this.clear(),this._instructionBpList=this._debugService.getModel().getInstructionBreakpoints(),this.loadDisassembledInstructions(e,t,-g.NUM_INSTRUCTIONS_TO_LOAD*4,g.NUM_INSTRUCTIONS_TO_LOAD*8).then(()=>{if(this._disassembledInstructions.length>0){const s=Math.floor(this._disassembledInstructions.length/2);this._disassembledInstructions.reveal(s,.5),this._disassembledInstructions.domFocus(),this._disassembledInstructions.setFocus([s])}this._loadingLock=!1}))}clear(){this._referenceToMemoryAddress.clear(),this._disassembledInstructions?.splice(0,this._disassembledInstructions.length,[K])}};g=v([f(1,Ie),f(2,$),f(3,he),f(4,ce),f(5,me),f(6,x)],g);let I=class{constructor(n,e){this._disassemblyView=n;this._debugService=e}static TEMPLATE_ID="breakpoint";templateId=I.TEMPLATE_ID;_breakpointIcon="codicon-"+T.breakpoint.regular.id;_breakpointDisabledIcon="codicon-"+T.breakpoint.disabled.id;_breakpointHintIcon="codicon-"+T.debugBreakpointHint.id;_debugStackframe="codicon-"+T.debugStackframe.id;_debugStackframeFocused="codicon-"+T.debugStackframeFocused.id;renderTemplate(n){n.style.alignSelf="flex-end";const e=w(n,B(".codicon"));e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.height=this._disassemblyView.fontInfo.lineHeight+"px";const t={element:void 0},s=[this._disassemblyView.onDidChangeStackFrame(()=>this.rerenderDebugStackframe(e,t.element)),C(n,"mouseover",()=>{t.element?.allowBreakpoint&&e.classList.add(this._breakpointHintIcon)}),C(n,"mouseout",()=>{t.element?.allowBreakpoint&&e.classList.remove(this._breakpointHintIcon)}),C(n,"click",()=>{if(t.element?.allowBreakpoint){e.classList.add(this._breakpointHintIcon);const o=t.element.instructionReference,r=Number(t.element.address-this._disassemblyView.getReferenceAddress(o));t.element.isBreakpointSet?this._debugService.removeInstructionBreakpoints(o,r):t.element.allowBreakpoint&&!t.element.isBreakpointSet&&this._debugService.addInstructionBreakpoint({instructionReference:o,offset:r,address:t.element.address,canPersist:!1})}})];return{currentElement:t,icon:e,disposables:s}}renderElement(n,e,t,s){t.currentElement.element=n,this.rerenderDebugStackframe(t.icon,n)}disposeTemplate(n){O(n.disposables),n.disposables=[]}rerenderDebugStackframe(n,e){e?.address===this._disassemblyView.focusedCurrentInstructionAddress?n.classList.add(this._debugStackframe):e?.address===this._disassemblyView.focusedInstructionAddress?n.classList.add(this._debugStackframeFocused):(n.classList.remove(this._debugStackframe),n.classList.remove(this._debugStackframeFocused)),n.classList.remove(this._breakpointHintIcon),e?.isBreakpointSet?e.isBreakpointEnabled?(n.classList.add(this._breakpointIcon),n.classList.remove(this._breakpointDisabledIcon)):(n.classList.remove(this._breakpointIcon),n.classList.add(this._breakpointDisabledIcon)):(n.classList.remove(this._breakpointIcon),n.classList.remove(this._breakpointDisabledIcon))}};I=v([f(1,x)],I);let h=class extends se{constructor(e,t,s,o,r,i){super();this._disassemblyView=e;this.editorService=s;this.textModelService=o;this.uriService=r;this.logService=i;this._topStackFrameColor=t.getColorTheme().getColor(j),this._focusedStackFrameColor=t.getColorTheme().getColor(q),this._register(t.onDidColorThemeChange(c=>{this._topStackFrameColor=c.getColor(j),this._focusedStackFrameColor=c.getColor(q)}))}static TEMPLATE_ID="instruction";static INSTRUCTION_ADDR_MIN_LENGTH=25;static INSTRUCTION_BYTES_MIN_LENGTH=30;templateId=h.TEMPLATE_ID;_topStackFrameColor;_focusedStackFrameColor;renderTemplate(e){const t=w(e,B(".sourcecode")),s=w(e,B(".instruction"));this.applyFontInfo(t),this.applyFontInfo(s);const o={element:void 0},r=[],i=[this._disassemblyView.onDidChangeStackFrame(()=>this.rerenderBackground(s,t,o.element)),C(t,"dblclick",()=>this.openSourceCode(o.element?.instruction))];return{currentElement:o,instruction:s,sourcecode:t,cellDisposable:r,disposables:i}}renderElement(e,t,s,o){this.renderElementInner(e,t,s,o)}async renderElementInner(e,t,s,o){s.currentElement.element=e;const r=e.instruction;s.sourcecode.innerText="";const i=new W(1e3);if(this._disassemblyView.isSourceCodeRender&&e.showSourceLocation&&r.location?.path&&r.line!==void 0){const a=this.getUriFromSource(r);if(a){let l;const _=new W(1e4),D=await this.textModelService.createModelReference(a);if(s.currentElement.element!==e)return;if(l=D.object.textEditorModel,s.cellDisposable.push(D),l&&s.currentElement.element===e){let m=r.line;for(;m&&m>=1&&m<=l.getLineCount();){const k=l.getLineContent(m);if(_.appendString(`  ${m}: `),_.appendString(k+`
`),r.endLine&&m<r.endLine){m++;continue}break}s.sourcecode.innerText=_.build()}}}let c=10;if(r.address!=="-1"){i.appendString(r.address),r.address.length<h.INSTRUCTION_ADDR_MIN_LENGTH&&(c=h.INSTRUCTION_ADDR_MIN_LENGTH-r.address.length);for(let a=0;a<c;a++)i.appendString(" ")}if(r.instructionBytes){i.appendString(r.instructionBytes),c=10,r.instructionBytes.length<h.INSTRUCTION_BYTES_MIN_LENGTH&&(c=h.INSTRUCTION_BYTES_MIN_LENGTH-r.instructionBytes.length);for(let a=0;a<c;a++)i.appendString(" ")}i.appendString(r.instruction),s.instruction.innerText=i.build(),this.rerenderBackground(s.instruction,s.sourcecode,e)}disposeElement(e,t,s,o){O(s.cellDisposable),s.cellDisposable=[]}disposeTemplate(e){O(e.disposables),e.disposables=[]}rerenderBackground(e,t,s){s&&this._disassemblyView.currentInstructionAddresses.includes(s.address)?e.style.background=this._topStackFrameColor?.toString()||"transparent":s?.address===this._disassemblyView.focusedInstructionAddress?e.style.background=this._focusedStackFrameColor?.toString()||"transparent":e.style.background="transparent"}openSourceCode(e){if(e){const t=this.getUriFromSource(e),s=e.endLine?{startLineNumber:e.line,endLineNumber:e.endLine,startColumn:e.column||1,endColumn:e.endColumn||V.MAX_SAFE_SMALL_INTEGER}:{startLineNumber:e.line,endLineNumber:e.line,startColumn:e.column||1,endColumn:e.endColumn||V.MAX_SAFE_SMALL_INTEGER};this.editorService.openEditor({resource:t,description:b("editorOpenedFromDisassemblyDescription","from disassembly"),options:{preserveFocus:!1,selection:s,revealIfOpened:!0,selectionRevealType:ue.CenterIfOutsideViewport,pinned:!1}})}}getUriFromSource(e){const t=e.location.path;return t&&De(t)?this.uriService.asCanonicalUri(G.parse(t)):t&&ie(t)?this.uriService.asCanonicalUri(G.file(t)):Te(e.location,e.location.path,this._disassemblyView.debugSession.getId(),this.uriService,this.logService)}applyFontInfo(e){ne(e,this._disassemblyView.fontInfo),e.style.whiteSpace="pre"}};h=v([f(1,$),f(2,Y),f(3,de),f(4,pe),f(5,ge)],h);class Ce{getWidgetAriaLabel(){return b("disassemblyView","Disassembly View")}getAriaLabel(n){let e="";const t=n.instruction;return t.address!=="-1"&&(e+=`${b("instructionAddress","Address")}: ${t.address}`),t.instructionBytes&&(e+=`, ${b("instructionBytes","Bytes")}: ${t.instructionBytes}`),e+=`, ${b("instructionText","Instruction")}: ${t.instruction}`,e}}let L=class{_onDidActiveEditorChangeListener;_onDidChangeModelLanguage;_languageSupportsDisassembleRequest;constructor(n,e,t){t.bufferChangeEvents(()=>{this._languageSupportsDisassembleRequest=Se.bindTo(t)});const s=()=>{this._onDidChangeModelLanguage&&(this._onDidChangeModelLanguage.dispose(),this._onDidChangeModelLanguage=void 0);const o=n.activeTextEditorControl;if(re(o)){const r=o.getModel()?.getLanguageId();this._languageSupportsDisassembleRequest?.set(!!r&&e.getAdapterManager().someDebuggerInterestedInLanguage(r)),this._onDidChangeModelLanguage=o.onDidChangeModelLanguage(i=>{this._languageSupportsDisassembleRequest?.set(e.getAdapterManager().someDebuggerInterestedInLanguage(i.newLanguage))})}else this._languageSupportsDisassembleRequest?.set(!1)};s(),this._onDidActiveEditorChangeListener=n.onDidActiveEditorChange(s)}dispose(){this._onDidActiveEditorChangeListener.dispose(),this._onDidChangeModelLanguage?.dispose()}};L=v([f(0,Y),f(1,x),f(2,le)],L);export{g as DisassemblyView,L as DisassemblyViewContribution};
