var J=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var x=(s,e,t,o)=>{for(var i=o>1?void 0:o?Q(e,t):e,r=s.length-1,n;r>=0;r--)(n=s[r])&&(i=(o?n(e,t,i):n(i))||i);return o&&i&&J(e,t,i),i},S=(s,e)=>(t,o)=>e(t,o,s);import{addDisposableListener as ee,isKeyboardEvent as te}from"../../../../base/browser/dom.js";import{DomEmitter as ie}from"../../../../base/browser/event.js";import{StandardKeyboardEvent as k}from"../../../../base/browser/keyboardEvent.js";import{RunOnceScheduler as N}from"../../../../base/common/async.js";import{CancellationToken as oe,CancellationTokenSource as ne}from"../../../../base/common/cancellation.js";import{memoize as H}from"../../../../base/common/decorators.js";import{illegalArgument as O,onUnexpectedExternalError as re}from"../../../../base/common/errors.js";import{Event as se}from"../../../../base/common/event.js";import{visit as ae}from"../../../../base/common/json.js";import{setProperty as A}from"../../../../base/common/jsonEdit.js";import{KeyCode as W}from"../../../../base/common/keyCodes.js";import{DisposableStore as de,MutableDisposable as R,dispose as le,toDisposable as ue}from"../../../../base/common/lifecycle.js";import{clamp as ce}from"../../../../base/common/numbers.js";import{basename as pe}from"../../../../base/common/path.js";import*as _ from"../../../../base/common/platform.js";import*as V from"../../../../base/common/strings.js";import{assertType as F,isDefined as K}from"../../../../base/common/types.js";import{Constants as he}from"../../../../base/common/uint.js";import{URI as ge}from"../../../../base/common/uri.js";import{CoreEditingCommands as ve}from"../../../../editor/browser/coreCommands.js";import{MouseTargetType as P}from"../../../../editor/browser/editorBrowser.js";import{EditorOption as fe}from"../../../../editor/common/config/editorOptions.js";import{EditOperation as me}from"../../../../editor/common/core/editOperation.js";import{Position as Ie}from"../../../../editor/common/core/position.js";import{Range as w}from"../../../../editor/common/core/range.js";import{DEFAULT_WORD_REGEXP as U}from"../../../../editor/common/core/wordHelper.js";import{ScrollType as be}from"../../../../editor/common/editorCommon.js";import{StandardTokenType as Se}from"../../../../editor/common/encodedTokenAttributes.js";import{InjectedTextCursorStops as B}from"../../../../editor/common/model.js";import{ILanguageFeatureDebounceService as ye}from"../../../../editor/common/services/languageFeatureDebounce.js";import{ILanguageFeaturesService as z}from"../../../../editor/common/services/languageFeatures.js";import{IModelService as Ce}from"../../../../editor/common/services/model.js";import{ContentHoverController as G}from"../../../../editor/contrib/hover/browser/contentHoverController.js";import{HoverStartMode as Ee,HoverStartSource as we}from"../../../../editor/contrib/hover/browser/hoverOperation.js";import*as j from"../../../../nls.js";import{CommandsRegistry as De,ICommandService as Le}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as Me}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as xe}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as We}from"../../../../platform/instantiation/common/instantiation.js";import{registerColor as X}from"../../../../platform/theme/common/colorRegistry.js";import{IUriIdentityService as Ve}from"../../../../platform/uriIdentity/common/uriIdentity.js";import{IHostService as Pe}from"../../../services/host/browser/host.js";import{CONTEXT_EXCEPTION_WIDGET_VISIBLE as Ne,IDebugService as He,State as q}from"../common/debug.js";import{Expression as Te}from"../common/debugModel.js";import{DebugHoverWidget as T,ShowDebugHoverResult as ke}from"./debugHover.js";import{ExceptionWidget as Oe}from"./exceptionWidget.js";const Ae=100,Y=150,Re=500,$=200,Tt=X("editor.inlineValuesForeground",{dark:"#ffffff80",light:"#00000080",hcDark:"#ffffff80",hcLight:"#00000080"},j.localize("editor.inlineValuesForeground","Color for the debug inline value text.")),kt=X("editor.inlineValuesBackground","#ffc80033",j.localize("editor.inlineValuesBackground","Color for the debug inline value background."));class _e{constructor(e,t){this.column=e;this.text=t}}function Z(s,e,t=he.MAX_SAFE_SMALL_INTEGER){return e.length>Y&&(e=e.substring(0,Y)+"..."),[{range:{startLineNumber:s,endLineNumber:s,startColumn:t,endColumn:t},options:{description:"debug-inline-value-decoration-spacer",after:{content:V.noBreakWhitespace,cursorStops:B.None},showIfCollapsed:!0}},{range:{startLineNumber:s,endLineNumber:s,startColumn:t,endColumn:t},options:{description:"debug-inline-value-decoration",after:{content:Fe(e),inlineClassName:"debug-inline-value",inlineClassNameAffectsLetterSpacing:!0,cursorStops:B.None},showIfCollapsed:!0}}]}function Fe(s){return s.replace(/[ \t]/g,V.noBreakWhitespace)}function Ke(s,e,t,o){const i=new Map;for(const n of s)if(i.set(n.name,n.value),i.size>=Ae)break;const r=new Map;return i.forEach((n,d)=>{const c=o.get(d);if(c)for(const a of c)e.some(l=>a>=l.startLineNumber&&a<=l.endLineNumber)&&(r.has(a)||r.set(a,[]),r.get(a).indexOf(d)===-1&&r.get(a).push(d))}),[...r].map(([n,d])=>({line:n,variables:d.sort((c,a)=>{const l=t.getLineContent(n);return l.indexOf(c)-l.indexOf(a)}).map(c=>({name:c,value:i.get(c)}))}))}function Ue(s,e,t){if(s.getLineLength(e)>Re)return;const i=s.getLineContent(e);s.tokenization.forceTokenization(e);const r=s.tokenization.getLineTokens(e);for(let n=0,d=r.getCount();n<d;n++)if(r.getStandardTokenType(n)===Se.Other){U.lastIndex=0;const a=r.getStartOffset(n),l=r.getEndOffset(n),h=i.substring(a,l),b=U.exec(h);if(b){const y=b[0];t.has(y)||t.set(y,[]),t.get(y).push(e)}}}let D=class{constructor(e,t,o,i,r,n,d,c,a,l){this.editor=e;this.debugService=t;this.instantiationService=o;this.commandService=i;this.configurationService=r;this.hostService=n;this.uriIdentityService=d;this.languageFeaturesService=a;this.debounceInfo=l.for(a.inlineValuesProvider,"InlineValues",{min:$}),this.hoverWidget=this.instantiationService.createInstance(T,this.editor),this.toDispose=[this.defaultHoverLockout,this.altListener,this.displayedStore],this.registerListeners(),this.exceptionWidgetVisible=Ne.bindTo(c),this.toggleExceptionWidget()}toDispose;hoverWidget;hoverPosition;mouseDown=!1;exceptionWidgetVisible;gutterIsHovered=!1;exceptionWidget;configurationWidget;altListener=new R;altPressed=!1;oldDecorations=this.editor.createDecorationsCollection();displayedStore=new de;editorHoverOptions;debounceInfo;defaultHoverLockout=new R;registerListeners(){this.toDispose.push(this.debugService.getViewModel().onDidFocusStackFrame(e=>this.onFocusStackFrame(e.stackFrame))),this.toDispose.push(this.editor.onMouseDown(e=>this.onEditorMouseDown(e))),this.toDispose.push(this.editor.onMouseUp(()=>this.mouseDown=!1)),this.toDispose.push(this.editor.onMouseMove(e=>this.onEditorMouseMove(e))),this.toDispose.push(this.editor.onMouseLeave(e=>{const t=this.hoverWidget.getDomNode();if(!t)return;const o=t.getBoundingClientRect();(e.event.posx<o.left||e.event.posx>o.right||e.event.posy<o.top||e.event.posy>o.bottom)&&this.hideHoverWidget()})),this.toDispose.push(this.editor.onKeyDown(e=>this.onKeyDown(e))),this.toDispose.push(this.editor.onDidChangeModelContent(()=>{this._wordToLineNumbersMap=void 0,this.updateInlineValuesScheduler.schedule()})),this.toDispose.push(this.debugService.getViewModel().onWillUpdateViews(()=>this.updateInlineValuesScheduler.schedule())),this.toDispose.push(this.debugService.getViewModel().onDidEvaluateLazyExpression(()=>this.updateInlineValuesScheduler.schedule())),this.toDispose.push(this.editor.onDidChangeModel(async()=>{this.addDocumentListeners(),this.toggleExceptionWidget(),this.hideHoverWidget(),this._wordToLineNumbersMap=void 0;const e=this.debugService.getViewModel().focusedStackFrame;await this.updateInlineValueDecorations(e)})),this.toDispose.push(this.editor.onDidScrollChange(()=>{this.hideHoverWidget();const e=this.editor.getModel();e&&this.languageFeaturesService.inlineValuesProvider.has(e)&&this.updateInlineValuesScheduler.schedule()})),this.toDispose.push(this.configurationService.onDidChangeConfiguration(e=>{e.affectsConfiguration("editor.hover")&&this.updateHoverConfiguration()})),this.toDispose.push(this.debugService.onDidChangeState(e=>{e!==q.Stopped&&this.toggleExceptionWidget()})),this.updateHoverConfiguration()}_wordToLineNumbersMap;updateHoverConfiguration(){const e=this.editor.getModel();e&&(this.editorHoverOptions=this.configurationService.getValue("editor.hover",{resource:e.uri,overrideIdentifier:e.getLanguageId()}))}addDocumentListeners(){const e=this.debugService.getViewModel().focusedStackFrame,t=this.editor.getModel();t&&this.applyDocumentListeners(t,e)}applyDocumentListeners(e,t){if(!t||!this.uriIdentityService.extUri.isEqual(e.uri,t.source.uri)){this.altListener.clear();return}const o=this.editor.getContainerDomNode().ownerDocument;this.altListener.value=ee(o,"keydown",i=>{if(new k(i).keyCode===W.Alt){this.altPressed=!0;const n=this.hoverWidget.isVisible();this.hoverWidget.hide(),this.defaultHoverLockout.clear(),n&&this.hoverPosition&&this.showEditorHover(this.hoverPosition.position,!1);const d=new ie(o,"keyup"),c=se.any(this.hostService.onDidChangeFocus,d.event)(a=>{let l;te(a)&&(l=new k(a)),(!l||l.keyCode===W.Alt)&&(this.altPressed=!1,this.preventDefaultEditorHover(),c.dispose(),d.dispose())})}})}async showHover(e,t,o){this.preventDefaultEditorHover();const i=this.debugService.getViewModel().focusedStackFrame,r=this.editor.getModel();i&&r&&this.uriIdentityService.extUri.isEqual(i.source.uri,r.uri)?await this.hoverWidget.showAt(e,t,o)===ke.NOT_AVAILABLE&&this.showEditorHover(e,t):this.showEditorHover(e,t)}preventDefaultEditorHover(){if(this.defaultHoverLockout.value||this.editorHoverOptions?.enabled===!1)return;this.editor.getContribution(G.ID)?.hideContentHover(),this.editor.updateOptions({hover:{enabled:!1}}),this.defaultHoverLockout.value={dispose:()=>{this.editor.updateOptions({hover:{enabled:this.editorHoverOptions?.enabled??!0}})}}}showEditorHover(e,t){const o=this.editor.getContribution(G.ID),i=new w(e.lineNumber,e.column,e.lineNumber,e.column);this.defaultHoverLockout.clear(),o?.showContentHover(i,Ee.Immediate,we.Mouse,t)}async onFocusStackFrame(e){const t=this.editor.getModel();t&&(this.applyDocumentListeners(t,e),e&&this.uriIdentityService.extUri.isEqual(e.source.uri,t.uri)?await this.toggleExceptionWidget():this.hideHoverWidget()),await this.updateInlineValueDecorations(e)}get hoverDelay(){const e=this.editorHoverOptions?.delay||0,t=ce(2-(e-300)/600,1,2);return e*t}get showHoverScheduler(){const e=new N(()=>{this.hoverPosition&&!this.altPressed&&this.showHover(this.hoverPosition.position,!1,this.hoverPosition.event)},this.hoverDelay);return this.toDispose.push(e),e}hideHoverWidget(){this.hoverWidget.willBeVisible()&&this.hoverWidget.hide(),this.showHoverScheduler.cancel(),this.defaultHoverLockout.clear()}onEditorMouseDown(e){this.mouseDown=!0,!(e.target.type===P.CONTENT_WIDGET&&e.target.detail===T.ID)&&this.hideHoverWidget()}onEditorMouseMove(e){if(this.debugService.state!==q.Stopped)return;const t=e.target,o=_.isMacintosh?"metaKey":"ctrlKey";this.altPressed||(t.type===P.GUTTER_GLYPH_MARGIN?(this.defaultHoverLockout.clear(),this.gutterIsHovered=!0):this.gutterIsHovered&&(this.gutterIsHovered=!1,this.updateHoverConfiguration())),!(t.type===P.CONTENT_WIDGET&&t.detail===T.ID&&!e.event[o]&&((this.editorHoverOptions?.sticky??!0)||this.hoverWidget.isShowingComplexValue))&&(t.type===P.CONTENT_TEXT?t.position&&!Ie.equals(t.position,this.hoverPosition?.position||null)&&!this.hoverWidget.isInSafeTriangle(e.event.posx,e.event.posy)&&(this.hoverPosition={position:t.position,event:e.event},this.preventDefaultEditorHover(),this.showHoverScheduler.schedule(this.hoverDelay)):this.mouseDown||this.hideHoverWidget())}onKeyDown(e){const t=_.isMacintosh?W.Meta:W.Ctrl;e.keyCode!==t&&e.keyCode!==W.Alt&&this.hideHoverWidget()}async toggleExceptionWidget(){const e=this.editor.getModel(),t=this.debugService.getViewModel().focusedStackFrame,o=t?t.thread.getCallStack():null;if(!e||!t||!o||o.length===0){this.closeExceptionWidget();return}const i=o.find(n=>!!(n&&n.source&&n.source.available&&n.source.presentationHint!=="deemphasize"));if(!i||i!==t){this.closeExceptionWidget();return}const r=this.uriIdentityService.extUri.isEqual(i.source.uri,e.uri);if(this.exceptionWidget&&!r)this.closeExceptionWidget();else if(r){const n=await t.thread.exceptionInfo;n&&this.showExceptionWidget(n,this.debugService.getViewModel().focusedSession,i.range.startLineNumber,i.range.startColumn)}}showExceptionWidget(e,t,o,i){this.exceptionWidget&&this.exceptionWidget.dispose(),this.exceptionWidget=this.instantiationService.createInstance(Oe,this.editor,e,t),this.exceptionWidget.show({lineNumber:o,column:i},0),this.exceptionWidget.focus(),this.editor.revealRangeInCenter({startLineNumber:o,startColumn:i,endLineNumber:o,endColumn:i}),this.exceptionWidgetVisible.set(!0)}closeExceptionWidget(){if(this.exceptionWidget){const e=this.exceptionWidget.hasFocus();this.exceptionWidget.dispose(),this.exceptionWidget=void 0,this.exceptionWidgetVisible.set(!1),e&&this.editor.focus()}}async addLaunchConfiguration(){const e=this.editor.getModel();if(!e)return;let t,o;const i=()=>{let n=0;ae(e.getValue(),{onObjectProperty:d=>{o=d},onArrayBegin:d=>{o==="configurations"&&n===0&&(t=e.getPositionAt(d+1)),n++},onArrayEnd:()=>{n--}})};if(i(),!t){const{tabSize:n,insertSpaces:d}=e.getOptions(),c=e.getEOL(),a=pe(e.uri.fsPath)==="launch.json"?A(e.getValue(),["configurations"],[],{tabSize:n,insertSpaces:d,eol:c})[0]:A(e.getValue(),["launch"],{configurations:[]},{tabSize:n,insertSpaces:d,eol:c})[0],l=e.getPositionAt(a.offset),h=l.lineNumber,b=new w(h,l.column,h,e.getLineMaxColumn(h));e.pushEditOperations(null,[me.replace(b,a.content)],()=>null),i()}if(!t)return;this.editor.focus(),await(n=>(e.getLineLastNonWhitespaceColumn(n.lineNumber)>n.column&&(this.editor.setPosition(n),ve.LineBreakInsert.runEditorCommand(null,this.editor,null)),this.editor.setPosition(n),this.commandService.executeCommand("editor.action.insertLineAfter")))(t),await this.commandService.executeCommand("editor.action.triggerSuggest")}get removeInlineValuesScheduler(){return new N(()=>{this.displayedStore.clear(),this.oldDecorations.clear()},100)}get updateInlineValuesScheduler(){const e=this.editor.getModel();return new N(async()=>await this.updateInlineValueDecorations(this.debugService.getViewModel().focusedStackFrame),e?this.debounceInfo.get(e):$)}async updateInlineValueDecorations(e){const t="{0} = {1}",o=", ",i=this.editor.getModel(),r=this.configurationService.getValue("debug").inlineValues;if(!(r===!0||r==="on"||r==="auto"&&i&&this.languageFeaturesService.inlineValuesProvider.has(i))||!i||!e||i.uri.toString()!==e.source.uri.toString()){this.removeInlineValuesScheduler.isScheduled()||this.removeInlineValuesScheduler.schedule();return}this.removeInlineValuesScheduler.cancel(),this.displayedStore.clear();const d=this.editor.getVisibleRangesPlusViewportAboveBelow();let c;const a=new ne;if(this.displayedStore.add(ue(()=>a.dispose(!0))),this.languageFeaturesService.inlineValuesProvider.has(i)){const h=async(m,C)=>{const f=await e.getMostSpecificScopes(e.range),u=C?m:m.toLowerCase();for(const v of f){const p=(await v.getChildren()).find(M=>C?M.name===u:M.name.toLowerCase()===u);if(p)return p.value}},b={frameId:e.frameId,stoppedLocation:new w(e.range.startLineNumber,e.range.startColumn+1,e.range.endLineNumber,e.range.endColumn+1)},y=this.languageFeaturesService.inlineValuesProvider.ordered(i).reverse();c=[];const I=new Map,L=y.flatMap(m=>d.map(C=>Promise.resolve(m.provideInlineValues(i,C,b,a.token)).then(async f=>{if(f)for(const u of f){let v;switch(u.type){case"text":v=u.text;break;case"variable":{let g=u.variableName;g||(g=i.getLineContent(u.range.startLineNumber).substring(u.range.startColumn-1,u.range.endColumn-1));const p=await h(g,u.caseSensitiveLookup);p&&(v=V.format(t,g,p));break}case"expression":{let g=u.expression;if(g||(g=i.getLineContent(u.range.startLineNumber).substring(u.range.startColumn-1,u.range.endColumn-1)),g){const p=new Te(g);await p.evaluate(e.thread.session,e,"watch",!0),p.available&&(v=V.format(t,g,p.value))}break}}if(v){const g=u.range.startLineNumber;let p=I.get(g);p||(p=[],I.set(g,p)),p.some(M=>M.text===v)||p.push(new _e(u.range.startColumn,v))}}},f=>{re(f)}))),E=Date.now();await Promise.all(L),this.updateInlineValuesScheduler.delay=this.debounceInfo.update(i,Date.now()-E),I.forEach((m,C)=>{if(m.length>0){m=m.sort((u,v)=>u.column-v.column);const f=m.map(u=>u.text).join(o);c.push(...Z(C,f))}})}else{const h=await e.getMostSpecificScopes(e.range),b=await Promise.all(h.map(async I=>({scope:I,variables:await I.getChildren()}))),y=new Map;for(const{scope:I,variables:L}of b){let E=new w(0,0,e.range.startLineNumber,e.range.startColumn);I.range&&(E=E.setStartPosition(I.range.startLineNumber,I.range.startColumn));const m=d.map(f=>f.intersectRanges(E)).filter(K);this._wordToLineNumbersMap??=new Be(i);for(const f of m)this._wordToLineNumbersMap.ensureRangePopulated(f);const C=Ke(L,m,i,this._wordToLineNumbersMap.value);for(const{line:f,variables:u}of C){let v=y.get(f);v||(v=new Map,y.set(f,v));for(const{name:g,value:p}of u)v.has(g)||v.set(g,p)}}c=[...y.entries()].flatMap(([I,L])=>Z(I,[...L].map(([E,m])=>`${E} = ${m}`).join(", ")))}if(a.token.isCancellationRequested)return;let l;if(this.editor.getOption(fe.wordWrap)!=="off"){const h=this.editor.getPosition();h&&this.editor.getVisibleRanges().some(b=>b.containsPosition(h))&&(l={position:h,top:this.editor.getTopForPosition(h.lineNumber,h.column)})}if(this.oldDecorations.set(c),l){const h=this.editor.getTopForPosition(l.position.lineNumber,l.position.column);this.editor.setScrollTop(this.editor.getScrollTop()-(l.top-h),be.Immediate)}}dispose(){this.hoverWidget&&this.hoverWidget.dispose(),this.configurationWidget&&this.configurationWidget.dispose(),this.toDispose=le(this.toDispose)}};x([H],D.prototype,"showHoverScheduler",1),x([H],D.prototype,"removeInlineValuesScheduler",1),x([H],D.prototype,"updateInlineValuesScheduler",1),D=x([S(1,He),S(2,We),S(3,Le),S(4,Me),S(5,Pe),S(6,Ve),S(7,xe),S(8,z),S(9,ye)],D);class Be{constructor(e){this.model=e;this.intervals=new Uint8Array(Math.ceil(e.getLineCount()/8))}intervals;value=new Map;ensureRangePopulated(e){for(let t=e.startLineNumber;t<=e.endLineNumber;t++){const o=t>>3,i=1<<(t&7);this.intervals[o]&i||(Ue(this.model,t,this.value),this.intervals[o]|=i)}}}De.registerCommand("_executeInlineValueProvider",async(s,e,t,o)=>{if(F(ge.isUri(e)),F(w.isIRange(t)),!o||typeof o.frameId!="number"||!w.isIRange(o.stoppedLocation))throw O("context");const i=s.get(Ce).getModel(e);if(!i)throw O("uri");const r=w.lift(t),{inlineValuesProvider:n}=s.get(z),d=n.ordered(i);return(await Promise.all(d.map(a=>a.provideInlineValues(i,r,o,oe.None)))).flat().filter(K)});export{D as DebugEditorContribution,kt as debugInlineBackground,Tt as debugInlineForeground};
