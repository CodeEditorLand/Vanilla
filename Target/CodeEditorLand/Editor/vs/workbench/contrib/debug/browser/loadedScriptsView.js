var V=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var y=(d,e,t,r)=>{for(var o=r>1?void 0:r?N(e,t):e,i=d.length-1,a;i>=0;i--)(a=d[i])&&(o=(r?a(e,t,o):a(o))||o);return r&&o&&V(e,t,o),o},c=(d,e)=>(t,r)=>e(t,r,d);import{TreeVisibility as S}from"../../../../base/browser/ui/tree/tree.js";import{RunOnceScheduler as A}from"../../../../base/common/async.js";import{Codicon as M}from"../../../../base/common/codicons.js";import{createMatches as k}from"../../../../base/common/filters.js";import{normalizeDriveLetter as W,tildify as H}from"../../../../base/common/labels.js";import{dispose as C}from"../../../../base/common/lifecycle.js";import{isAbsolute as j,normalize as w,posix as T}from"../../../../base/common/path.js";import{isWindows as K}from"../../../../base/common/platform.js";import{ltrim as $}from"../../../../base/common/strings.js";import{URI as D}from"../../../../base/common/uri.js";import*as I from"../../../../nls.js";import{MenuId as U,registerAction2 as X}from"../../../../platform/actions/common/actions.js";import{IConfigurationService as q}from"../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as G,IContextKeyService as Y}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as Z}from"../../../../platform/contextview/browser/contextView.js";import{FileKind as L}from"../../../../platform/files/common/files.js";import{IInstantiationService as J}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as Q}from"../../../../platform/keybinding/common/keybinding.js";import{ILabelService as ee}from"../../../../platform/label/common/label.js";import{WorkbenchCompressibleObjectTree as te}from"../../../../platform/list/browser/listService.js";import{IWorkspaceContextService as re}from"../../../../platform/workspace/common/workspace.js";import{ResourceLabels as ie}from"../../../browser/labels.js";import{ViewAction as se,ViewPane as oe}from"../../../browser/parts/views/viewPane.js";import{IEditorService as ne}from"../../../services/editor/common/editorService.js";import{CONTEXT_LOADED_SCRIPTS_ITEM_TYPE as ae,IDebugService as le,LOADED_SCRIPTS_VIEW_ID as R}from"../common/debug.js";import{DebugContentProvider as de}from"../common/debugContentProvider.js";import{renderViewTree as ce}from"./baseDebugView.js";import{TreeFindMode as pe}from"../../../../base/browser/ui/tree/abstractTree.js";import{IHoverService as he}from"../../../../platform/hover/browser/hover.js";import{IOpenerService as ue}from"../../../../platform/opener/common/opener.js";import{ITelemetryService as me}from"../../../../platform/telemetry/common/telemetry.js";import{IThemeService as fe}from"../../../../platform/theme/common/themeService.js";import{IViewDescriptorService as Ie}from"../../../common/views.js";import{IPathService as be}from"../../../services/path/common/pathService.js";const P=!0,Se=/^[a-zA-Z][a-zA-Z0-9+\-.]+:/;class u{constructor(e,t,r=!1){this._parent=e;this._label=t;this.isIncompressible=r;this._showedMoreThanOne=!1}_showedMoreThanOne;_children=new Map;_source;updateLabel(e){this._label=e}isLeaf(){return this._children.size===0}getSession(){if(this._parent)return this._parent.getSession()}setSource(e,t){if(this._source=t,this._children.clear(),t.raw&&t.raw.sources){for(const r of t.raw.sources)if(r.name&&r.path){const o=new u(this,r.name);this._children.set(r.path,o);const i=e.getSource(r);o.setSource(e,i)}}}createIfNeeded(e,t){let r=this._children.get(e);return r||(r=t(this,e),this._children.set(e,r)),r}getChild(e){return this._children.get(e)}remove(e){this._children.delete(e)}removeFromParent(){this._parent&&(this._parent.remove(this._label),this._parent._children.size===0&&this._parent.removeFromParent())}getTemplateId(){return"id"}getId(){const e=this.getParent();return e?`${e.getId()}/${this.getInternalId()}`:this.getInternalId()}getInternalId(){return this._label}getParent(){if(this._parent)return this._parent.isSkipped()?this._parent.getParent():this._parent}isSkipped(){return this._parent?!!this._parent.oneChild():!0}hasChildren(){const e=this.oneChild();return e?e.hasChildren():this._children.size>0}getChildren(){const e=this.oneChild();if(e)return e.getChildren();const t=[];for(const r of this._children.values())t.push(r);return t.sort((r,o)=>this.compare(r,o))}getLabel(e=!0){const t=this.oneChild();if(t){const r=this instanceof b&&e?" \u2022 ":T.sep;return`${this._label}${r}${t.getLabel()}`}return this._label}getHoverLabel(){if(this._source&&this._parent&&this._parent._source)return this._source.raw.path||this._source.raw.name;const e=this.getLabel(!1),t=this.getParent();if(t){const r=t.getHoverLabel();if(r)return`${r}/${e}`}return e}getSource(){const e=this.oneChild();return e?e.getSource():this._source}compare(e,t){return e._label&&t._label?e._label.localeCompare(t._label):0}oneChild(){if(!this._source&&!this._showedMoreThanOne&&this.skipOneChild()){if(this._children.size===1)return this._children.values().next().value;this._children.size>1&&(this._showedMoreThanOne=!0)}}skipOneChild(){return P?this instanceof F:!(this instanceof b)&&!(this instanceof m)}}class b extends u{constructor(t,r){super(t,r.name,!0);this.folder=r}}class F extends u{constructor(t,r,o){super(void 0,"Root");this._pathService=t;this._contextService=r;this._labelService=o}add(t){return this.createIfNeeded(t.getId(),()=>new m(this._labelService,this,t,this._pathService,this._contextService))}find(t){return this.getChild(t.getId())}}class m extends u{constructor(t,r,o,i,a){super(r,o.getLabel(),!0);this._pathService=i;this.rootProvider=a;this._labelService=t,this._session=o}static URL_REGEXP=/^(https?:\/\/[^/]+)(\/.*)$/;_session;_map=new Map;_labelService;getInternalId(){return this._session.getId()}getSession(){return this._session}getHoverLabel(){}hasChildren(){return!0}compare(t,r){const o=this.category(t),i=this.category(r);return o!==i?o-i:super.compare(t,r)}category(t){if(t instanceof b)return t.folder.index;const r=t.getLabel();return r&&/^<.+>$/.test(r)?1e3:999}async addPath(t){let r,o,i=t.raw.path;if(!i)return;this._labelService&&Se.test(i)&&(i=this._labelService.getUriLabel(D.parse(i)));const a=m.URL_REGEXP.exec(i);if(a&&a.length===3)o=a[1],i=decodeURI(a[2]);else if(j(i)){const h=D.file(i);r=this.rootProvider?this.rootProvider.getWorkspaceFolder(h):null,r?(i=w($(h.path.substring(r.uri.path.length),T.sep)),this.rootProvider.getWorkspace().folders.length>1?i=T.sep+i:r=null):(i=w(i),K?i=W(i):i=H(i,(await this._pathService.userHome()).fsPath))}let l=this;i.split(/[/\\]/).forEach((h,s)=>{if(s===0&&r){const n=r;l=l.createIfNeeded(r.name,p=>new b(p,n))}else s===0&&o?l=l.createIfNeeded(o,n=>new u(n,o)):l=l.createIfNeeded(h,n=>new u(n,h))}),l.setSource(this._session,t),t.raw.path&&this._map.set(t.raw.path,l)}removePath(t){if(t.raw.path){const r=this._map.get(t.raw.path);if(r)return r.removeFromParent(),!0}return!1}}function x(d,e){const t=d.getChildren(),r=e?!e.expanded.has(d.getId()):!(d instanceof m);return{element:d,collapsed:r,collapsible:d.hasChildren(),children:t.map(o=>x(o,e))}}let g=class extends oe{constructor(t,r,o,i,a,l,h,s,n,p,f,_,B,O,z,E){super(t,o,r,l,s,a,i,B,O,z,E);this.editorService=h;this.contextService=n;this.debugService=p;this.labelService=f;this.pathService=_;this.loadedScriptsItemType=ae.bindTo(s)}treeContainer;loadedScriptsItemType;tree;treeLabels;changeScheduler;treeNeedsRefreshOnVisible=!1;filter;renderBody(t){super.renderBody(t),this.element.classList.add("debug-pane"),t.classList.add("debug-loaded-scripts"),t.classList.add("show-file-icons"),this.treeContainer=ce(t),this.filter=new Te;const r=new F(this.pathService,this.contextService,this.labelService);this.treeLabels=this.instantiationService.createInstance(ie,{onDidChangeVisibility:this.onDidChangeBodyVisibility}),this._register(this.treeLabels),this.tree=this.instantiationService.createInstance(te,"LoadedScriptsView",this.treeContainer,new ge,[new v(this.treeLabels)],{compressionEnabled:P,collapseByDefault:!0,hideTwistiesOfChildlessElements:!0,identityProvider:{getId:s=>s.getId()},keyboardNavigationLabelProvider:{getKeyboardNavigationLabel:s=>s.getLabel(),getCompressedNodeKeyboardNavigationLabel:s=>s.map(n=>n.getLabel()).join("/")},filter:this.filter,accessibilityProvider:new ve,overrideStyles:this.getLocationBasedColors().listOverrideStyles});const o=s=>this.tree.setChildren(null,x(r,s).children);o(),this.changeScheduler=new A(()=>{this.treeNeedsRefreshOnVisible=!1,this.tree&&o()},300),this._register(this.changeScheduler),this._register(this.tree.onDidOpen(s=>{if(s.element instanceof u){const n=s.element.getSource();if(n&&n.available){const p={startLineNumber:0,startColumn:0,endLineNumber:0,endColumn:0};n.openInEditor(this.editorService,p,s.editorOptions.preserveFocus,s.sideBySide,s.editorOptions.pinned)}}})),this._register(this.tree.onDidChangeFocus(()=>{this.tree.getFocus()instanceof m?this.loadedScriptsItemType.set("session"):this.loadedScriptsItemType.reset()}));const i=()=>{this.isBodyVisible()?this.changeScheduler.schedule():this.treeNeedsRefreshOnVisible=!0},a=async s=>{if(s.capabilities.supportsLoadedSourcesRequest){const n=r.add(s),p=await s.getLoadedSources();for(const f of p)await n.addPath(f);i()}},l=s=>{this._register(s.onDidChangeName(async()=>{const n=r.find(s);n&&(n.updateLabel(s.getLabel()),i())})),this._register(s.onDidLoadedSource(async n=>{let p;switch(n.reason){case"new":case"changed":p=r.add(s),await p.addPath(n.source),i(),n.reason==="changed"&&de.refreshDebugContent(n.source.uri);break;case"removed":p=r.find(s),p&&p.removePath(n.source)&&i();break;default:this.filter.setFilter(n.source.name),this.tree.refilter();break}}))};this._register(this.debugService.onDidNewSession(l)),this.debugService.getModel().getSessions().forEach(l),this._register(this.debugService.onDidEndSession(({session:s})=>{r.remove(s.getId()),this.changeScheduler.schedule()})),this.changeScheduler.schedule(0),this._register(this.onDidChangeBodyVisibility(s=>{s&&this.treeNeedsRefreshOnVisible&&this.changeScheduler.schedule()}));let h;this._register(this.tree.onDidChangeFindPattern(s=>{if(this.tree.findMode!==pe.Highlight)if(!h&&s){const n=new Set,p=f=>{f.element&&!f.collapsed&&n.add(f.element.getId());for(const _ of f.children)p(_)};p(this.tree.getNode()),h={expanded:n},this.tree.expandAll()}else!s&&h&&(this.tree.setFocus([]),o(h),h=void 0)})),this.debugService.getModel().getSessions().forEach(s=>a(s))}layoutBody(t,r){super.layoutBody(t,r),this.tree.layout(t,r)}collapseAll(){this.tree.collapseAll()}dispose(){C(this.tree),C(this.treeLabels),super.dispose()}};g=y([c(1,Z),c(2,Q),c(3,J),c(4,Ie),c(5,q),c(6,ne),c(7,Y),c(8,re),c(9,le),c(10,ee),c(11,be),c(12,ue),c(13,fe),c(14,me),c(15,he)],g);class ge{getHeight(e){return 22}getTemplateId(e){return v.ID}}class v{constructor(e){this.labels=e}static ID="lsrenderer";get templateId(){return v.ID}renderTemplate(e){return{label:this.labels.create(e,{supportHighlights:!0})}}renderElement(e,t,r){const o=e.element,i=o.getLabel();this.render(o,i,r,e.filterData)}renderCompressedElements(e,t,r,o){const i=e.element.elements[e.element.elements.length-1],a=e.element.elements.map(l=>l.getLabel());this.render(i,a,r,e.filterData)}render(e,t,r,o){const i={name:t},a={title:e.getHoverLabel()};if(e instanceof b)a.fileKind=L.ROOT_FOLDER;else if(e instanceof m)a.title=I.localize("loadedScriptsSession","Debug Session"),a.hideIcon=!0;else if(e instanceof u){const l=e.getSource();l&&l.uri?(i.resource=l.uri,a.fileKind=L.FILE):a.fileKind=L.FOLDER}a.matches=k(o),r.label.setResource(i,a)}disposeTemplate(e){e.label.dispose()}}class ve{getWidgetAriaLabel(){return I.localize({comment:["Debug is a noun in this context, not a verb."],key:"loadedScriptsAriaLabel"},"Debug Loaded Scripts")}getAriaLabel(e){return e instanceof b?I.localize("loadedScriptsRootFolderAriaLabel","Workspace folder {0}, loaded script, debug",e.getLabel()):e instanceof m?I.localize("loadedScriptsSessionAriaLabel","Session {0}, loaded script, debug",e.getLabel()):e.hasChildren()?I.localize("loadedScriptsFolderAriaLabel","Folder {0}, loaded script, debug",e.getLabel()):I.localize("loadedScriptsSourceAriaLabel","{0}, loaded script, debug",e.getLabel())}}class Te{filterText;setFilter(e){this.filterText=e}filter(e,t){return this.filterText?e.isLeaf()?e.getLabel().indexOf(this.filterText)>=0?S.Visible:S.Hidden:S.Recurse:S.Visible}}X(class extends se{constructor(){super({id:"loadedScripts.collapse",viewId:R,title:I.localize("collapse","Collapse All"),f1:!1,icon:M.collapseAll,menu:{id:U.ViewTitle,order:30,group:"navigation",when:G.equals("view",R)}})}runInView(e,t){t.collapseAll()}});export{g as LoadedScriptsView};
