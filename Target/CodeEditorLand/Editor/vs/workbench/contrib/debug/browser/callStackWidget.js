var Q=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var d=(n,e,i,t)=>{for(var r=t>1?void 0:t?Y(e,i):e,o=n.length-1,a;o>=0;o--)(a=n[o])&&(r=(t?a(e,i,r):a(r))||r);return t&&r&&Q(e,i,r),r},c=(n,e)=>(i,t)=>e(i,t,n);import*as m from"../../../../base/browser/dom.js";import{Button as O}from"../../../../base/browser/ui/button/button.js";import"../../../../base/browser/ui/list/list.js";import"../../../../base/browser/ui/list/listWidget.js";import{assertNever as W}from"../../../../base/common/assert.js";import{CancellationTokenSource as N}from"../../../../base/common/cancellation.js";import{Codicon as C}from"../../../../base/common/codicons.js";import{Emitter as Z}from"../../../../base/common/event.js";import{Disposable as _,DisposableStore as y,toDisposable as S}from"../../../../base/common/lifecycle.js";import{autorun as H,autorunWithStore as $,derived as P,observableValue as E,transaction as ee}from"../../../../base/common/observable.js";import"../../../../base/common/themables.js";import{Constants as B}from"../../../../base/common/uint.js";import"../../../../base/common/uri.js";import{generateUuid as te}from"../../../../base/common/uuid.js";import"./media/callStackWidget.css";import"../../../../editor/browser/editorBrowser.js";import{EditorContributionInstantiation as ie}from"../../../../editor/browser/editorExtensions.js";import{CodeEditorWidget as re}from"../../../../editor/browser/widget/codeEditor/codeEditorWidget.js";import{EmbeddedCodeEditorWidget as oe}from"../../../../editor/browser/widget/codeEditor/embeddedCodeEditorWidget.js";import"../../../../editor/common/config/editorOptions.js";import{Position as ae}from"../../../../editor/common/core/position.js";import{Range as k}from"../../../../editor/common/core/range.js";import"../../../../editor/common/core/wordHelper.js";import"../../../../editor/common/editorCommon.js";import"../../../../editor/common/languages.js";import{ITextModelService as ne}from"../../../../editor/common/services/resolverService.js";import{ClickLinkGesture as se}from"../../../../editor/contrib/gotoSymbol/browser/link/clickLinkGesture.js";import{localize as D,localize2 as le}from"../../../../nls.js";import{createActionViewItem as ce}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{MenuWorkbenchToolBar as de}from"../../../../platform/actions/browser/toolbar.js";import{Action2 as me,MenuId as V,registerAction2 as pe}from"../../../../platform/actions/common/actions.js";import{TextEditorSelectionRevealType as G}from"../../../../platform/editor/common/editor.js";import{IInstantiationService as F}from"../../../../platform/instantiation/common/instantiation.js";import{ILabelService as ue}from"../../../../platform/label/common/label.js";import{WorkbenchList as he}from"../../../../platform/list/browser/listService.js";import{INotificationService as be}from"../../../../platform/notification/common/notification.js";import{defaultButtonStyles as Ie}from"../../../../platform/theme/browser/defaultStyles.js";import{ResourceLabel as U}from"../../../browser/labels.js";import{IEditorService as z,SIDE_GROUP as fe}from"../../../services/editor/common/editorService.js";import{makeStackFrameColumnDecoration as ge,TOP_STACK_FRAME_DECORATION as ve}from"./callStackEditorContribution.js";class w{constructor(e,i,t=1,r=1){this.name=e;this.source=i;this.line=t;this.column=r}}class M{constructor(e,i){this.label=e;this.load=i}}class Se{showHeader=E("CustomStackFrame.showHeader",!0);icon}class X extends w{editorHeight=E("WrappedCallStackFrame.height",this.source?100:0);collapsed=E("WrappedCallStackFrame.collapsed",!1);height=P(e=>this.collapsed.read(e)?R:R+this.editorHeight.read(e));constructor(e){super(e.name,e.source,e.line,e.column)}}class L{constructor(e){this.original=e}collapsed=E("WrappedCallStackFrame.collapsed",!1);height=P(e=>{const i=this.original.showHeader.read(e)?R:0;return this.collapsed.read(e)?i:i+this.original.height.read(e)})}const ke=n=>n instanceof X||n instanceof L,q="multiCallStackWidget";let A=class extends _{list;layoutEmitter=this._register(new Z);currentFramesDs=this._register(new y);cts;constructor(e,i,t){super(),e.classList.add(q),this._register(S(()=>e.classList.remove(q))),this.list=this._register(t.createInstance(he,"TestResultStackWidget",e,new Le,[t.createInstance(p,i,this.layoutEmitter.event),t.createInstance(u),t.createInstance(x),t.createInstance(h,r=>this.loadFrame(r))],{multipleSelectionSupport:!1,mouseSupport:!1,keyboardSupport:!1,setRowLineHeight:!1,accessibilityProvider:t.createInstance(T)}))}setFrames(e){this.currentFramesDs.clear(),this.cts=new N,this._register(S(()=>this.cts.dispose(!0))),this.list.splice(0,this.list.length,this.mapFrames(e))}layout(e,i){this.list.layout(e,i),this.layoutEmitter.fire()}collapseAll(){ee(e=>{for(let i=0;i<this.list.length;i++){const t=this.list.element(i);ke(t)&&t.collapsed.set(!0,e)}})}async loadFrame(e){if(!this.cts)return;const i=await e.load(this.cts.token);if(this.cts.token.isCancellationRequested)return;const t=this.list.indexOf(e);this.list.splice(t,1,this.mapFrames(i))}mapFrames(e){const i=[];for(const t of e){if(t instanceof M){i.push(t);continue}const r=t instanceof Se?new L(t):new X(t);i.push(r),this.currentFramesDs.add(H(o=>{const a=r.height.read(o),s=this.list.indexOf(r);s!==-1&&this.list.updateElementHeight(s,a)}))}return i}};A=d([c(2,F)],A);let T=class{constructor(e){this.labelService=e}getAriaLabel(e){if(e instanceof M)return e.label;if(e instanceof L)return e.original.label;if(e instanceof w)return e.source&&e.line?D({comment:["{0} is an extension-defined label, then line number and filename"],key:"stackTraceLabel"},"{0}, line {1} in {2}",e.name,e.line,this.labelService.getUriLabel(e.source,{relative:!0})):e.name;W(e)}getWidgetAriaLabel(){return D("stackTrace","Stack Trace")}};T=d([c(0,ue)],T);class Le{getHeight(e){if(e instanceof w||e instanceof L)return e.height.get();if(e instanceof M)return R;W(e)}getTemplateId(e){if(e instanceof w)return e.source?p.templateId:u.templateId;if(e instanceof M)return h.templateId;if(e instanceof L)return x.templateId;W(e)}}const K={scrollBeyondLastLine:!1,scrollbar:{vertical:"hidden",horizontal:"hidden",handleMouseWheel:!1,useShadows:!1},overviewRulerLanes:0,fixedOverflowWidgets:!0,overviewRulerBorder:!1,stickyScroll:{enabled:!1},minimap:{enabled:!1},readOnly:!0,automaticLayout:!1},j=()=>m.h("div.multiCallStackFrame",[m.h("div.header@header",[m.h("div.collapse-button@collapseButton"),m.h("div.title.show-file-icons@title"),m.h("div.actions@actions")]),m.h("div.editorParent",[m.h("div.editorContainer@editor")])]),R=24;let f=class{constructor(e){this.instantiationService=e}renderTemplate(e){const i=j();e.appendChild(i.root);const t=new y;e.classList.add("multiCallStackFrameContainer"),t.add(S(()=>{e.classList.remove("multiCallStackFrameContainer"),i.root.remove()}));const r=t.add(this.instantiationService.createInstance(U,i.title,{})),o=t.add(new O(i.collapseButton,{})),a=te();return i.editor.id=a,i.editor.role="region",i.collapseButton.setAttribute("aria-controls",a),this.finishRenderTemplate({container:e,decorations:[],elements:i,label:r,collapse:o,elementStore:t.add(new y),templateStore:t})}renderElement(e,i,t,r){const{elementStore:o}=t;o.clear();const a=e;this.setupCollapseButton(a,t)}setupCollapseButton(e,{elementStore:i,elements:t,collapse:r}){i.add(H(a=>{r.element.className="";const s=e.collapsed.read(a);r.icon=s?C.chevronRight:C.chevronDown,r.element.ariaExpanded=String(!s),t.root.classList.toggle("collapsed",s)}));const o=()=>e.collapsed.set(!e.collapsed.get(),void 0);i.add(r.onDidClick(o)),i.add(m.addDisposableListener(t.title,"click",o))}disposeElement(e,i,t,r){t.elementStore.clear()}disposeTemplate(e){e.templateStore.dispose()}};f=d([c(0,F)],f);const J=2;let p=class extends f{constructor(i,t,r,o){super(o);this.containingEditor=i;this.onLayout=t;this.modelService=r}static templateId="f";templateId=p.templateId;finishRenderTemplate(i){const t=[{id:g.ID,instantiation:ie.BeforeFirstInteraction,ctor:g}],r=this.containingEditor?this.instantiationService.createInstance(oe,i.elements.editor,K,{isSimpleWidget:!0,contributions:t},this.containingEditor):this.instantiationService.createInstance(re,i.elements.editor,K,{isSimpleWidget:!0,contributions:t});i.templateStore.add(r);const o=i.templateStore.add(this.instantiationService.createInstance(de,i.elements.actions,V.DebugCallStackToolbar,{menuOptions:{shouldForwardArgs:!0},actionViewItemProvider:(a,s)=>ce(this.instantiationService,a,s)}));return{...i,editor:r,toolbar:o}}renderElement(i,t,r,o){super.renderElement(i,t,r,o);const{elementStore:a,editor:s}=r,l=i,b=l.source;r.label.element.setFile(b);const I=new N;a.add(S(()=>I.dispose(!0))),this.modelService.createModelReference(b).then(v=>{if(I.token.isCancellationRequested)return v.dispose();a.add(v),s.setModel(v.object.textEditorModel),this.setupEditorAfterModel(l,r),this.setupEditorLayout(l,r)})}setupEditorLayout(i,{elementStore:t,container:r,editor:o}){const a=()=>{const s=o.getContentHeight();o.layout({width:r.clientWidth,height:s});const l=o.getContentHeight();l!==s&&o.layout({width:r.clientWidth,height:l}),i.editorHeight.set(l,void 0)};t.add(o.onDidChangeModelDecorations(a)),t.add(o.onDidChangeModelContent(a)),t.add(o.onDidChangeModelOptions(a)),t.add(this.onLayout(a)),a()}setupEditorAfterModel(i,t){const r=k.fromPositions({column:i.column??1,lineNumber:i.line??1});t.toolbar.context={uri:i.source,range:r},t.editor.setHiddenAreas([k.fromPositions({column:1,lineNumber:1},{column:1,lineNumber:Math.max(1,i.line-J-1)}),k.fromPositions({column:1,lineNumber:i.line+J+1},{column:1,lineNumber:B.MAX_SAFE_SMALL_INTEGER})]),t.editor.changeDecorations(o=>{for(const b of t.decorations)o.removeDecoration(b);t.decorations.length=0;const a=r.setStartPosition(r.startLineNumber,1),s=!!t.editor.getModel()?.getValueInRange(a).trim(),l=r.setEndPosition(r.startLineNumber,B.MAX_SAFE_SMALL_INTEGER);t.decorations.push(o.addDecoration(l,ge(!s))),t.decorations.push(o.addDecoration(l,ve))}),i.editorHeight.set(t.editor.getContentHeight(),void 0)}};p=d([c(2,ne),c(3,F)],p);let u=class{constructor(e){this.instantiationService=e}static templateId="m";templateId=u.templateId;renderTemplate(e){const i=j();i.root.classList.add("missing"),e.appendChild(i.root);const t=this.instantiationService.createInstance(U,i.title,{});return{elements:i,label:t}}renderElement(e,i,t){const r=e;t.label.element.setResource({name:r.name,description:D("stackFrameLocation","Line {0} column {1}",r.line,r.column),range:{startLineNumber:r.line,startColumn:r.column,endColumn:r.column,endLineNumber:r.line}},{icon:C.fileBinary})}disposeTemplate(e){e.label.dispose(),e.elements.root.remove()}};u=d([c(0,F)],u);class x extends f{static templateId="c";templateId=x.templateId;finishRenderTemplate(e){return e}renderElement(e,i,t,r){super.renderElement(e,i,t,r);const o=e,{elementStore:a,container:s,label:l}=t;l.element.setResource({name:o.original.label},{icon:o.original.icon}),a.add(H(I=>{t.elements.header.style.display=o.original.showHeader.read(I)?"":"none"})),a.add($((I,v)=>{o.collapsed.read(I)||v.add(o.original.render(s))}));const b=o.original.renderActions?.(t.elements.actions);b&&a.add(b)}}let h=class{constructor(e,i){this.loadFrames=e;this.notificationService=i}static templateId="s";templateId=h.templateId;renderTemplate(e){const i=new y,t=new O(e,{title:"",...Ie}),r={button:t,store:i};return i.add(t),i.add(t.onDidClick(()=>{!r.current||!t.enabled||(t.enabled=!1,this.loadFrames(r.current).catch(o=>{this.notificationService.error(D("failedToLoadFrames","Failed to load stack frames: {0}",o.message))}))})),r}renderElement(e,i,t,r){const o=e;t.button.enabled=!0,t.button.label=o.label,t.current=o}disposeTemplate(e){e.store.dispose()}};h=d([c(1,be)],h);let g=class extends _{constructor(i,t){super();this.editor=i;this.linkDecorations=i.createDecorationsCollection(),this._register(S(()=>this.linkDecorations.clear()));const r=this._register(new se(i));this._register(r.onMouseMoveOrRelevantKeyDown(([o,a])=>{this.onMove(o)})),this._register(r.onExecute(o=>{const a=this.editor.getModel();!this.current||!a||t.openEditor({resource:a.uri,options:{selection:k.fromPositions(new ae(this.current.line,this.current.word.startColumn)),selectionRevealType:G.CenterIfOutsideViewport}},o.hasSideBySideModifier?fe:void 0)}))}static ID="clickToLocation";linkDecorations;current;onMove(i){if(!i.hasTriggerModifier)return this.clear();const t=i.target.position,r=t&&this.editor.getModel()?.getWordAtPosition(t);if(!r)return this.clear();const o=this.current?.word;o&&o.startColumn===r.startColumn&&o.endColumn===r.endColumn&&o.word===r.word||(this.current={word:r,line:t.lineNumber},this.linkDecorations.set([{range:new k(t.lineNumber,r.startColumn,t.lineNumber,r.endColumn),options:{description:"call-stack-go-to-file-link",inlineClassName:"call-stack-go-to-file-link"}}]))}clear(){this.linkDecorations.clear(),this.current=void 0}};g=d([c(1,z)],g),pe(class extends me{constructor(){super({id:"callStackWidget.goToFile",title:le("goToFile","Open File"),icon:C.goToFile,menu:{id:V.DebugCallStackToolbar,order:22,group:"navigation"}})}async run(n,{uri:e,range:i}){await n.get(z).openEditor({resource:e,options:{selection:i,selectionRevealType:G.CenterIfOutsideViewport}})}});export{w as CallStackFrame,A as CallStackWidget,Se as CustomStackFrame,M as SkippedCallFrames};
