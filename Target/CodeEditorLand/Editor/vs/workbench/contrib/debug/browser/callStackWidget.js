var X=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var I=(n,e,r,t)=>{for(var i=t>1?void 0:t?q(e,r):e,a=n.length-1,o;a>=0;a--)(o=n[a])&&(i=(t?o(e,r,i):o(i))||i);return t&&i&&X(e,r,i),i},c=(n,e)=>(r,t)=>e(r,t,n);import*as p from"../../../../../vs/base/browser/dom.js";import{Button as H}from"../../../../../vs/base/browser/ui/button/button.js";import"../../../../../vs/base/browser/ui/list/list.js";import"../../../../../vs/base/browser/ui/list/listWidget.js";import{assertNever as R}from"../../../../../vs/base/common/assert.js";import{CancellationTokenSource as O}from"../../../../../vs/base/common/cancellation.js";import{Codicon as g}from"../../../../../vs/base/common/codicons.js";import{Emitter as j}from"../../../../../vs/base/common/event.js";import{Disposable as J,DisposableStore as T,toDisposable as L}from"../../../../../vs/base/common/lifecycle.js";import{autorun as W,autorunWithStore as Q,derived as N,observableValue as k}from"../../../../../vs/base/common/observable.js";import"../../../../../vs/base/common/themables.js";import{Constants as B}from"../../../../../vs/base/common/uint.js";import"../../../../../vs/base/common/uri.js";import{generateUuid as Y}from"../../../../../vs/base/common/uuid.js";import"vs/css!./media/callStackWidget";import"../../../../../vs/editor/browser/editorBrowser.js";import{ICodeEditorService as Z}from"../../../../../vs/editor/browser/services/codeEditorService.js";import{CodeEditorWidget as $}from"../../../../../vs/editor/browser/widget/codeEditor/codeEditorWidget.js";import{EmbeddedCodeEditorWidget as ee}from"../../../../../vs/editor/browser/widget/codeEditor/embeddedCodeEditorWidget.js";import"../../../../../vs/editor/common/config/editorOptions.js";import{Range as y}from"../../../../../vs/editor/common/core/range.js";import"../../../../../vs/editor/common/languages.js";import{ITextModelService as te}from"../../../../../vs/editor/common/services/resolverService.js";import{localize as F,localize2 as re}from"../../../../../vs/nls.js";import{createActionViewItem as ie}from"../../../../../vs/platform/actions/browser/menuEntryActionViewItem.js";import{MenuWorkbenchToolBar as ae}from"../../../../../vs/platform/actions/browser/toolbar.js";import{Action2 as oe,MenuId as _,registerAction2 as ne}from"../../../../../vs/platform/actions/common/actions.js";import{TextEditorSelectionRevealType as P}from"../../../../../vs/platform/editor/common/editor.js";import{IInstantiationService as E}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{ILabelService as se}from"../../../../../vs/platform/label/common/label.js";import{WorkbenchList as le}from"../../../../../vs/platform/list/browser/listService.js";import{INotificationService as ce}from"../../../../../vs/platform/notification/common/notification.js";import{defaultButtonStyles as de}from"../../../../../vs/platform/theme/browser/defaultStyles.js";import{ResourceLabel as V}from"../../../../../vs/workbench/browser/labels.js";import{makeStackFrameColumnDecoration as me,TOP_STACK_FRAME_DECORATION as pe}from"../../../../../vs/workbench/contrib/debug/browser/callStackEditorContribution.js";import{IEditorService as ue}from"../../../../../vs/workbench/services/editor/common/editorService.js";class C{constructor(e,r,t=1,i=1){this.name=e;this.source=r;this.line=t;this.column=i}}class D{constructor(e,r){this.label=e;this.load=r}}class be{showHeader=k("CustomStackFrame.showHeader",!0);icon}class he extends C{editorHeight=k("WrappedCallStackFrame.height",this.source?100:0);collapsed=k("WrappedCallStackFrame.collapsed",!1);height=N(e=>this.collapsed.read(e)?x:x+this.editorHeight.read(e));constructor(e){super(e.name,e.source,e.line,e.column)}}class A{constructor(e){this.original=e}collapsed=k("WrappedCallStackFrame.collapsed",!1);height=N(e=>{const r=this.original.showHeader.read(e)?x:0;return this.collapsed.read(e)?r:r+this.original.height.read(e)})}const G="multiCallStackWidget";let w=class extends J{list;layoutEmitter=this._register(new j);currentFramesDs=this._register(new T);cts;constructor(e,r,t){super(),e.classList.add(G),this._register(L(()=>e.classList.remove(G))),this.list=this._register(t.createInstance(le,"TestResultStackWidget",e,new Ie,[t.createInstance(u,r,this.layoutEmitter.event),t.createInstance(b),t.createInstance(M),t.createInstance(h,i=>this.loadFrame(i))],{multipleSelectionSupport:!1,mouseSupport:!1,keyboardSupport:!1,accessibilityProvider:t.createInstance(v)}))}setFrames(e){this.currentFramesDs.clear(),this.cts=new O,this._register(L(()=>this.cts.dispose(!0))),this.list.splice(0,this.list.length,this.mapFrames(e))}layout(e,r){this.list.layout(e,r),this.layoutEmitter.fire()}async loadFrame(e){if(!this.cts)return;const r=await e.load(this.cts.token);if(this.cts.token.isCancellationRequested)return;const t=this.list.indexOf(e);this.list.splice(t,1,this.mapFrames(r))}mapFrames(e){const r=[];for(const t of e){if(t instanceof D){r.push(t);continue}const i=t instanceof be?new A(t):new he(t);r.push(i),this.currentFramesDs.add(W(a=>{const o=i.height.read(a),l=this.list.indexOf(i);l!==-1&&this.list.updateElementHeight(l,o)}))}return r}};w=I([c(2,E)],w);let v=class{constructor(e){this.labelService=e}getAriaLabel(e){if(e instanceof D)return e.label;if(e instanceof A)return e.original.label;if(e instanceof C)return e.source&&e.line?F({comment:["{0} is an extension-defined label, then line number and filename"],key:"stackTraceLabel"},"{0}, line {1} in {2}",e.name,e.line,this.labelService.getUriLabel(e.source,{relative:!0})):e.name;R(e)}getWidgetAriaLabel(){return F("stackTrace","Stack Trace")}};v=I([c(0,se)],v);class Ie{getHeight(e){if(e instanceof C||e instanceof A)return e.height.get();if(e instanceof D)return x;R(e)}getTemplateId(e){if(e instanceof C)return e.source?u.templateId:b.templateId;if(e instanceof D)return h.templateId;if(e instanceof A)return M.templateId;R(e)}}const U={scrollBeyondLastLine:!1,scrollbar:{vertical:"hidden",horizontal:"hidden",handleMouseWheel:!1,useShadows:!1},overviewRulerLanes:0,fixedOverflowWidgets:!0,overviewRulerBorder:!1,stickyScroll:{enabled:!1},minimap:{enabled:!1},readOnly:!0,automaticLayout:!1},z=()=>p.h("div.multiCallStackFrame",[p.h("div.header@header",[p.h("div.collapse-button@collapseButton"),p.h("div.title.show-file-icons@title"),p.h("div.actions@actions")]),p.h("div.editorParent",[p.h("div.editorContainer@editor")])]),x=24;let S=class{constructor(e){this.instantiationService=e}renderTemplate(e){const r=z();e.appendChild(r.root);const t=new T;e.classList.add("multiCallStackFrameContainer"),t.add(L(()=>{e.classList.remove("multiCallStackFrameContainer"),r.root.remove()}));const i=t.add(this.instantiationService.createInstance(V,r.title,{})),a=t.add(new H(r.collapseButton,{})),o=Y();return r.editor.id=o,r.editor.role="region",r.collapseButton.setAttribute("aria-controls",o),this.finishRenderTemplate({container:e,decorations:[],elements:r,label:i,collapse:a,elementStore:t.add(new T),templateStore:t})}renderElement(e,r,t,i){const{elementStore:a}=t;a.clear();const o=e;this.setupCollapseButton(o,t)}setupCollapseButton(e,{elementStore:r,elements:t,collapse:i}){r.add(W(a=>{i.element.className="";const o=e.collapsed.read(a);i.icon=o?g.chevronRight:g.chevronDown,i.element.ariaExpanded=String(!o),t.root.classList.toggle("collapsed",o)})),r.add(i.onDidClick(()=>{e.collapsed.set(!e.collapsed.get(),void 0)}))}disposeElement(e,r,t,i){t.elementStore.clear()}disposeTemplate(e){e.templateStore.dispose()}};S=I([c(0,E)],S);const K=2;let u=class extends S{constructor(r,t,i,a,o){super(o);this.containingEditor=r;this.onLayout=t;this.modelService=i;this.editorService=a}static templateId="f";templateId=u.templateId;finishRenderTemplate(r){const t=this.containingEditor?this.instantiationService.createInstance(ee,r.elements.editor,U,{isSimpleWidget:!0},this.containingEditor):this.instantiationService.createInstance($,r.elements.editor,U,{isSimpleWidget:!0});r.templateStore.add(t);const i=r.templateStore.add(this.instantiationService.createInstance(ae,r.elements.actions,_.DebugCallStackToolbar,{menuOptions:{shouldForwardArgs:!0},actionViewItemProvider:(a,o)=>ie(this.instantiationService,a,o)}));return{...r,editor:t,toolbar:i}}renderElement(r,t,i,a){super.renderElement(r,t,i,a);const{elementStore:o,editor:l}=i,s=r,d=s.source;i.label.element.setFile(d),i.elements.title.role="link",o.add(p.addDisposableListener(i.elements.title,"click",m=>{this.editorService.openCodeEditor({resource:d,options:{selection:y.fromPositions({column:s.column??1,lineNumber:s.line??1}),selectionRevealType:P.CenterIfOutsideViewport}},this.containingEditor||null,m.ctrlKey||m.metaKey)}));const f=new O;o.add(L(()=>f.dispose(!0))),this.modelService.createModelReference(d).then(m=>{if(f.token.isCancellationRequested)return m.dispose();o.add(m),l.setModel(m.object.textEditorModel),this.setupEditorAfterModel(s,i),this.setupEditorLayout(s,i)})}setupEditorLayout(r,{elementStore:t,container:i,editor:a}){const o=()=>{const l=a.getContentHeight();a.layout({width:i.clientWidth,height:l});const s=a.getContentHeight();s!==l&&a.layout({width:i.clientWidth,height:s}),r.editorHeight.set(s,void 0)};t.add(a.onDidChangeModelDecorations(o)),t.add(a.onDidChangeModelContent(o)),t.add(a.onDidChangeModelOptions(o)),t.add(this.onLayout(o)),o()}setupEditorAfterModel(r,t){const i=y.fromPositions({column:r.column??1,lineNumber:r.line??1});t.toolbar.context={uri:r.source,range:i},t.editor.setHiddenAreas([y.fromPositions({column:1,lineNumber:1},{column:1,lineNumber:Math.max(1,r.line-K-1)}),y.fromPositions({column:1,lineNumber:r.line+K+1},{column:1,lineNumber:B.MAX_SAFE_SMALL_INTEGER})]),t.editor.changeDecorations(a=>{for(const d of t.decorations)a.removeDecoration(d);t.decorations.length=0;const o=i.setStartPosition(i.startLineNumber,1),l=!!t.editor.getModel()?.getValueInRange(o).trim(),s=i.setEndPosition(i.startLineNumber,B.MAX_SAFE_SMALL_INTEGER);t.decorations.push(a.addDecoration(s,me(!l))),t.decorations.push(a.addDecoration(s,pe))}),r.editorHeight.set(t.editor.getContentHeight(),void 0)}};u=I([c(2,te),c(3,Z),c(4,E)],u);let b=class{constructor(e){this.instantiationService=e}static templateId="m";templateId=b.templateId;renderTemplate(e){const r=z();r.root.classList.add("missing"),e.appendChild(r.root);const t=this.instantiationService.createInstance(V,r.title,{});return{elements:r,label:t}}renderElement(e,r,t){const i=e;t.label.element.setResource({name:i.name,description:F("stackFrameLocation","Line {0} column {1}",i.line,i.column),range:{startLineNumber:i.line,startColumn:i.column,endColumn:i.column,endLineNumber:i.line}},{icon:g.fileBinary})}disposeTemplate(e){e.label.dispose(),e.elements.root.remove()}};b=I([c(0,E)],b);class M extends S{static templateId="c";templateId=M.templateId;finishRenderTemplate(e){return e}renderElement(e,r,t,i){super.renderElement(e,r,t,i);const a=e,{elementStore:o,container:l,label:s}=t;s.element.setResource({name:a.original.label},{icon:a.original.icon}),o.add(W(f=>{t.elements.header.style.display=a.original.showHeader.read(f)?"":"none"})),o.add(Q((f,m)=>{a.collapsed.read(f)||m.add(a.original.render(l))}));const d=a.original.renderActions?.(t.elements.actions);d&&o.add(d)}}let h=class{constructor(e,r){this.loadFrames=e;this.notificationService=r}static templateId="s";templateId=h.templateId;renderTemplate(e){const r=new T,t=new H(e,{title:"",...de}),i={button:t,store:r};return r.add(t),r.add(t.onDidClick(()=>{!i.current||!t.enabled||(t.enabled=!1,this.loadFrames(i.current).catch(a=>{this.notificationService.error(F("failedToLoadFrames","Failed to load stack frames: {0}",a.message))}))})),i}renderElement(e,r,t,i){const a=e;t.button.enabled=!0,t.button.label=a.label,t.current=a}disposeTemplate(e){e.store.dispose()}};h=I([c(1,ce)],h),ne(class extends oe{constructor(){super({id:"callStackWidget.goToFile",title:re("goToFile","Open File"),icon:g.goToFile,menu:{id:_.DebugCallStackToolbar,order:22,group:"navigation"}})}async run(n,{uri:e,range:r}){await n.get(ue).openEditor({resource:e,options:{selection:r,selectionRevealType:P.CenterIfOutsideViewport}})}});export{C as CallStackFrame,w as CallStackWidget,be as CustomStackFrame,D as SkippedCallFrames};
