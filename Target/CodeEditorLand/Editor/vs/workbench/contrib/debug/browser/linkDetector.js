var I=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var y=(v,e,o,t)=>{for(var s=t>1?void 0:t?E(e,o):e,n=v.length-1,r;n>=0;n--)(r=v[n])&&(s=(t?r(e,o,s):r(s))||s);return t&&s&&I(e,o,s),s},u=(v,e)=>(o,t)=>e(o,t,v);import{getWindow as w}from"../../../../base/browser/dom.js";import{StandardKeyboardEvent as T}from"../../../../base/browser/keyboardEvent.js";import{getDefaultHoverDelegate as D}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import{KeyCode as g}from"../../../../base/common/keyCodes.js";import{Schemas as N}from"../../../../base/common/network.js";import*as h from"../../../../base/common/path.js";import*as m from"../../../../base/common/platform.js";import{URI as b}from"../../../../base/common/uri.js";import{localize as f}from"../../../../nls.js";import{IConfigurationService as H}from"../../../../platform/configuration/common/configuration.js";import{IFileService as C}from"../../../../platform/files/common/files.js";import{IHoverService as P}from"../../../../platform/hover/browser/hover.js";import{IOpenerService as _}from"../../../../platform/opener/common/opener.js";import{ITunnelService as M}from"../../../../platform/tunnel/common/tunnel.js";import{IEditorService as R}from"../../../services/editor/common/editorService.js";import{IWorkbenchEnvironmentService as W}from"../../../services/environment/common/environmentService.js";import{IPathService as A}from"../../../services/path/common/pathService.js";const S="\\u0000-\\u0020\\u007f-\\u009f",O=new RegExp("(?:[a-zA-Z][a-zA-Z0-9+.-]{2,}:\\/\\/|data:|www\\.)[^\\s"+S+'"]{2,}[^\\s'+S+`"')}\\],:;.!?]`,"ug"),K=/(?:[a-zA-Z]:(?:(?:\\|\/)[\w.-]*)+)/,x=/(?:(?:~|\.)(?:(?:\\|\/)[\w.-]*)+)/,B=new RegExp(`(${K.source}|${x.source})`),U=/((?:~|\.)?(?:\/[\w.-]*)+)/,F=/(?::([\d]+))?(?::([\d]+))?/,z=new RegExp(`${m.isWindows?B.source:U.source}${F.source}`,"g"),$=/:([\d]+)(?::([\d]+))?$/,X=2e3;var j=(t=>(t[t.Rich=0]="Rich",t[t.Basic=1]="Basic",t[t.None=2]="None",t))(j||{});let L=class{constructor(e,o,t,s,n,r,a,i){this.editorService=e;this.fileService=o;this.openerService=t;this.pathService=s;this.tunnelService=n;this.environmentService=r;this.configurationService=a;this.hoverService=i}linkify(e,o,t,s,n){return this._linkify(e,o,t,s,n)}_linkify(e,o,t,s,n,r){if(o){const i=e.split(`
`);for(let l=0;l<i.length-1;l++)i[l]=i[l]+`
`;i[i.length-1]||i.pop();const c=i.map(l=>this._linkify(l,!1,t,s,n,r));if(c.length===1)return c[0];const p=document.createElement("span");return c.forEach(l=>p.appendChild(l)),p}const a=document.createElement("span");for(const i of this.detectLinks(e))try{switch(i.kind){case"text":a.appendChild(r?this.linkifyLocation(i.value,r.locationReference,r.session,n):document.createTextNode(i.value));break;case"web":a.appendChild(this.createWebLink(s?e:void 0,i.value,n));break;case"path":{const c=i.captures[0],p=i.captures[1]?Number(i.captures[1]):0,l=i.captures[2]?Number(i.captures[2]):0;a.appendChild(this.createPathLink(s?e:void 0,i.value,c,p,l,t,n));break}}}catch{a.appendChild(document.createTextNode(i.value))}return a}linkifyLocation(e,o,t,s){const n=this.createLink(e);return this.decorateLink(n,void 0,e,s,async r=>{const a=await t.resolveLocationReference(o);await a.source.openInEditor(this.editorService,{startLineNumber:a.line,startColumn:a.column,endLineNumber:a.endLine??a.line,endColumn:a.endColumn??a.column},r)}),n}makeReferencedLinkDetector(e,o){return{linkify:(t,s,n,r,a)=>this._linkify(t,s,n,r,a,{locationReference:e,session:o}),linkifyLocation:this.linkifyLocation.bind(this)}}createWebLink(e,o,t){const s=this.createLink(o);let n=b.parse(o);const r=$.exec(n.path);return r&&(n=n.with({path:n.path.slice(0,r.index),fragment:`L${r[0].slice(1)}`})),this.decorateLink(s,n,e,t,async()=>{if(n.scheme===N.file){const a=n.fsPath,i=await this.pathService.path,c=h.normalize(i.sep===h.posix.sep&&m.isWindows?a.replace(/\\/g,h.posix.sep):a),p=b.parse(c);if(!await this.fileService.exists(p))return;await this.editorService.openEditor({resource:p,options:{pinned:!0,selection:r?{startLineNumber:+r[1],startColumn:+r[2]}:void 0}});return}this.openerService.open(o,{allowTunneling:!!this.environmentService.remoteAuthority&&this.configurationService.getValue("remote.forwardOnOpen")})}),s}createPathLink(e,o,t,s,n,r,a){if(t[0]==="/"&&t[1]==="/")return document.createTextNode(o);const i={selection:{startLineNumber:s,startColumn:n}};if(t[0]==="."){if(!r)return document.createTextNode(o);const l=r.toResource(t),d=this.createLink(o);return this.decorateLink(d,l,e,a,k=>this.editorService.openEditor({resource:l,options:{...i,preserveFocus:k}})),d}if(t[0]==="~"){const l=this.pathService.resolvedUserHome;l&&(t=h.join(l.fsPath,t.substring(1)))}const c=this.createLink(o);c.tabIndex=0;const p=b.file(h.normalize(t));return this.fileService.stat(p).then(l=>{l.isDirectory||this.decorateLink(c,p,e,a,d=>this.editorService.openEditor({resource:p,options:{...i,preserveFocus:d}}))}).catch(()=>{}),c}createLink(e){const o=document.createElement("a");return o.textContent=e,o}decorateLink(e,o,t,s,n){e.classList.add("link");const r=o&&this.tunnelService.canTunnel(o)?f("followForwardedLink","follow link using forwarded port"):f("followLink","follow link"),a=e.ariaLabel=t?m.isMacintosh?f("fileLinkWithPathMac",`Cmd + click to {0}
{1}`,r,t):f("fileLinkWithPath",`Ctrl + click to {0}
{1}`,r,t):m.isMacintosh?f("fileLinkMac","Cmd + click to {0}",r):f("fileLink","Ctrl + click to {0}",r);s?.type===0?s.store.add(this.hoverService.setupManagedHover(D("element"),e,a)):s?.type!==2&&(e.title=a),e.onmousemove=i=>{e.classList.toggle("pointer",m.isMacintosh?i.metaKey:i.ctrlKey)},e.onmouseleave=()=>e.classList.remove("pointer"),e.onclick=i=>{const c=w(e).getSelection();!c||c.type==="Range"||(m.isMacintosh?i.metaKey:i.ctrlKey)&&(i.preventDefault(),i.stopImmediatePropagation(),n(!1))},e.onkeydown=i=>{const c=new T(i);(c.keyCode===g.Enter||c.keyCode===g.Space)&&(c.preventDefault(),c.stopPropagation(),n(c.keyCode===g.Space))}}detectLinks(e){if(e.length>X)return[{kind:"text",value:e,captures:[]}];const o=[O,z],t=["web","path"],s=[],n=(r,a)=>{if(a>=o.length){s.push({value:r,kind:"text",captures:[]});return}const i=o[a];let c=0,p;for(i.lastIndex=0;(p=i.exec(r))!==null;){const d=r.substring(c,p.index);d&&n(d,a+1);const k=p[0];s.push({value:k,kind:t[a],captures:p.slice(1)}),c=p.index+k.length}const l=r.substring(c);l&&n(l,a+1)};return n(e,0),s}};L=y([u(0,R),u(1,C),u(2,_),u(3,A),u(4,M),u(5,W),u(6,H),u(7,P)],L);export{j as DebugLinkHoverBehavior,L as LinkDetector};
