var ee=Object.defineProperty;var te=Object.getOwnPropertyDescriptor;var W=(c,d,t,i)=>{for(var e=i>1?void 0:i?te(d,t):d,o=c.length-1,r;o>=0;o--)(r=c[o])&&(e=(i?r(d,t,e):r(e))||e);return i&&e&&ee(d,t,e),e},l=(c,d)=>(t,i)=>d(t,i,c);import*as n from"../../../../base/browser/dom.js";import{StandardMouseEvent as P}from"../../../../base/browser/mouseEvent.js";import{ActionBar as ie,ActionsOrientation as oe}from"../../../../base/browser/ui/actionbar/actionbar.js";import{Action as ne}from"../../../../base/common/actions.js";import*as re from"../../../../base/common/arrays.js";import{RunOnceScheduler as se}from"../../../../base/common/async.js";import*as ae from"../../../../base/common/errors.js";import{DisposableStore as de,dispose as ce,markAsSingleton as ue,MutableDisposable as x}from"../../../../base/common/lifecycle.js";import"../../../../base/common/uri.js";import"./media/debugToolBar.css";import"../../../../editor/browser/editorExtensions.js";import{localize as O}from"../../../../nls.js";import"../../../../platform/action/common/action.js";import{DropdownWithPrimaryActionViewItem as le}from"../../../../platform/actions/browser/dropdownWithPrimaryActionViewItem.js";import{createActionViewItem as he,createAndFillInActionBarActions as U}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{IMenuService as V,MenuId as u,MenuRegistry as v}from"../../../../platform/actions/common/actions.js";import{IConfigurationService as ge}from"../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as s,IContextKeyService as $}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as k}from"../../../../platform/instantiation/common/instantiation.js";import{INotificationService as pe}from"../../../../platform/notification/common/notification.js";import{IStorageService as me,StorageScope as _,StorageTarget as q}from"../../../../platform/storage/common/storage.js";import{ITelemetryService as ve}from"../../../../platform/telemetry/common/telemetry.js";import{widgetBorder as Se,widgetShadow as Ie}from"../../../../platform/theme/common/colorRegistry.js";import{IThemeService as Ee,Themable as Ce}from"../../../../platform/theme/common/themeService.js";import{ThemeIcon as fe}from"../../../../base/common/themables.js";import"../../../common/contributions.js";import{FocusSessionActionViewItem as be}from"./debugActionViewItems.js";import{debugToolBarBackground as Te,debugToolBarBorder as _e}from"./debugColors.js";import{CONTINUE_ID as Ae,CONTINUE_LABEL as De,DISCONNECT_AND_SUSPEND_ID as we,DISCONNECT_AND_SUSPEND_LABEL as ye,DISCONNECT_ID as A,DISCONNECT_LABEL as B,FOCUS_SESSION_ID as G,FOCUS_SESSION_LABEL as Oe,PAUSE_ID as Be,PAUSE_LABEL as Me,RESTART_LABEL as Ne,RESTART_SESSION_ID as Le,REVERSE_CONTINUE_ID as Re,STEP_BACK_ID as We,STEP_INTO_ID as Pe,STEP_INTO_LABEL as xe,STEP_OUT_ID as Ue,STEP_OUT_LABEL as Ve,STEP_OVER_ID as $e,STEP_OVER_LABEL as ke,STOP_ID as D,STOP_LABEL as M}from"./debugCommands.js";import*as a from"./debugIcons.js";import{CONTEXT_DEBUG_STATE as p,CONTEXT_FOCUSED_SESSION_IS_ATTACH as I,CONTEXT_FOCUSED_SESSION_IS_NO_DEBUG as qe,CONTEXT_IN_DEBUG_MODE as Ge,CONTEXT_MULTI_SESSION_DEBUG as Fe,CONTEXT_STEP_BACK_SUPPORTED as F,CONTEXT_SUSPEND_DEBUGGEE_SUPPORTED as K,CONTEXT_TERMINATE_DEBUGGEE_SUPPORTED as b,IDebugService as Ke,State as X,VIEWLET_ID as H}from"../common/debug.js";import{EditorTabsMode as Xe,IWorkbenchLayoutService as He,LayoutSettings as w,Parts as ze}from"../../../services/layout/browser/layoutService.js";import{Codicon as z}from"../../../../base/common/codicons.js";import{mainWindow as Ye}from"../../../../base/browser/window.js";import{clamp as Ze}from"../../../../base/common/numbers.js";import{PixelRatio as je}from"../../../../base/browser/pixelRatio.js";import"../../../../base/browser/ui/actionbar/actionViewItems.js";const Y="debug.actionswidgetposition",Z="debug.actionswidgety";let y=class extends Ce{constructor(t,i,e,o,r,g,S,C,L,J){super(S);this.notificationService=t;this.telemetryService=i;this.debugService=e;this.layoutService=o;this.storageService=r;this.configurationService=g;this.instantiationService=C;this.$el=n.$("div.debug-toolbar"),this.$el.style.top=`${o.mainContainerOffset.top}px`,this.dragArea=n.append(this.$el,n.$("div.drag-area"+fe.asCSSSelector(a.debugGripper)));const Q=n.append(this.$el,n.$("div.action-bar-container"));this.debugToolBarMenu=L.createMenu(u.DebugToolBar,J),this._register(this.debugToolBarMenu),this.activeActions=[],this.actionBar=this._register(new ie(Q,{orientation:oe.HORIZONTAL,actionViewItemProvider:(m,T)=>{if(m.id===G)return this.instantiationService.createInstance(be,m,void 0);if(m.id===D||m.id===A){this.stopActionViewItemDisposables.clear();const E=this.instantiationService.invokeFunction(f=>Je(m,this.stopActionViewItemDisposables,f,{hoverDelegate:T.hoverDelegate}));if(E)return E}return he(this.instantiationService,m,T)}})),this.updateScheduler=this._register(new se(()=>{const m=this.debugService.state,T=this.configurationService.getValue("debug").toolBarLocation;if(m===X.Inactive||T!=="floating"||this.debugService.getModel().getSessions().every(f=>f.suppressDebugToolbar)||m===X.Initializing&&this.debugService.initializingOptions?.suppressDebugToolbar)return this.hide();const E=[];U(this.debugToolBarMenu,{shouldForwardArgs:!0},E),re.equals(E,this.activeActions,(f,R)=>f.id===R.id&&f.enabled===R.enabled)||(this.actionBar.clear(),this.actionBar.push(E,{icon:!0,label:!1}),this.activeActions=E),this.show()},20)),this.updateStyles(),this.registerListeners(),this.hide()}$el;dragArea;actionBar;activeActions;updateScheduler;debugToolBarMenu;isVisible=!1;isBuilt=!1;stopActionViewItemDisposables=this._register(new de);auxWindowCoordinates=new WeakMap;trackPixelRatioListener=this._register(new x);registerListeners(){this._register(this.debugService.onDidChangeState(()=>this.updateScheduler.schedule())),this._register(this.configurationService.onDidChangeConfiguration(e=>{e.affectsConfiguration("debug.toolBarLocation")&&this.updateScheduler.schedule(),(e.affectsConfiguration(w.EDITOR_TABS_MODE)||e.affectsConfiguration(w.COMMAND_CENTER))&&(this._yRange=void 0,this.setCoordinates())})),this._register(this.debugToolBarMenu.onDidChange(()=>this.updateScheduler.schedule())),this._register(this.actionBar.actionRunner.onDidRun(e=>{e.error&&!ae.isCancellationError(e.error)&&this.notificationService.warn(e.error),this.telemetryService.publicLog2("workbenchActionExecuted",{id:e.action.id,from:"debugActionsWidget"})})),this._register(n.addDisposableGenericMouseUpListener(this.dragArea,e=>{const o=new P(n.getWindow(this.dragArea),e),r=n.getWindow(this.layoutService.activeContainer);if(o.detail===2){const g=this.$el.clientWidth;this.setCoordinates(.5*r.innerWidth-.5*g,this.yDefault),this.storePosition()}})),this._register(n.addDisposableGenericMouseDownListener(this.dragArea,e=>{this.dragArea.classList.add("dragged");const o=n.getWindow(this.layoutService.activeContainer),r=n.addDisposableGenericMouseMoveListener(o,S=>{const C=new P(o,S);C.preventDefault(),this.setCoordinates(C.posx-14,C.posy-14)}),g=n.addDisposableGenericMouseUpListener(o,S=>{this.storePosition(),this.dragArea.classList.remove("dragged"),r.dispose(),g.dispose()})})),this._register(this.layoutService.onDidChangePartVisibility(()=>this.setCoordinates()));const t=this._register(new x),i=()=>{t.value=this._register(n.addDisposableListener(n.getWindow(this.layoutService.activeContainer),n.EventType.RESIZE,()=>this.setCoordinates()))};this._register(this.layoutService.onDidChangeActiveContainer(async()=>{this._yRange=void 0,await this.layoutService.whenContainerStylesLoaded(n.getWindow(this.layoutService.activeContainer)),this.isBuilt&&(this.doShowInActiveContainer(),this.setCoordinates()),i()})),i()}storePosition(){const t=n.getWindow(this.layoutService.activeContainer),i=this.layoutService.activeContainer===this.layoutService.mainContainer,e=this.$el.getBoundingClientRect(),o=e.top,r=e.left/t.innerWidth;i?(this.storageService.store(Y,r,_.PROFILE,q.MACHINE),this.storageService.store(Z,o,_.PROFILE,q.MACHINE)):this.auxWindowCoordinates.set(t,{x:r,y:o})}updateStyles(){if(super.updateStyles(),this.$el){this.$el.style.backgroundColor=this.getColor(Te)||"";const t=this.getColor(Ie);this.$el.style.boxShadow=t?`0 0 8px 2px ${t}`:"";const i=this.getColor(Se),e=this.getColor(_e);i?this.$el.style.border=`1px solid ${i}`:(this.$el.style.border=e?`solid ${e}`:"none",this.$el.style.border="1px 0")}}setCoordinates(t,i){if(!this.isVisible)return;const e=this.$el.clientWidth,o=n.getWindow(this.layoutService.activeContainer),r=o===Ye;if(t===void 0){const g=r?Number(this.storageService.get(Y,_.PROFILE)):this.auxWindowCoordinates.get(o)?.x;t=g!==void 0&&!isNaN(g)?g*o.innerWidth:.5*o.innerWidth-.5*e}t=Ze(t,0,o.innerWidth-e),this.$el.style.left=`${t}px`,i===void 0&&(i=r?this.storageService.getNumber(Z,_.PROFILE):this.auxWindowCoordinates.get(o)?.y),this.setYCoordinate(i??this.yDefault)}setYCoordinate(t){const[i,e]=this.yRange;t=Math.max(i,Math.min(t,e)),this.$el.style.top=`${t}px`}get yDefault(){return this.layoutService.mainContainerOffset.top}_yRange;get yRange(){if(!this._yRange){const t=this.layoutService.isVisible(ze.TITLEBAR_PART,n.getWindow(this.layoutService.activeContainer)),i=t?0:this.layoutService.mainContainerOffset.top;let e=0;t&&(this.configurationService.getValue(w.COMMAND_CENTER)===!0?e+=35:e+=28),this.configurationService.getValue(w.EDITOR_TABS_MODE)!==Xe.NONE&&(e+=35),this._yRange=[i,e]}return this._yRange}show(){if(this.isVisible){this.setCoordinates();return}this.isBuilt||(this.isBuilt=!0,this.doShowInActiveContainer()),this.isVisible=!0,n.show(this.$el),this.setCoordinates()}doShowInActiveContainer(){this.layoutService.activeContainer.appendChild(this.$el),this.trackPixelRatioListener.value=je.getInstance(n.getWindow(this.$el)).onDidChange(()=>this.setCoordinates())}hide(){this.isVisible=!1,n.hide(this.$el)}dispose(){super.dispose(),this.$el?.remove()}};y=W([l(0,pe),l(1,ve),l(2,Ke),l(3,He),l(4,me),l(5,ge),l(6,Ee),l(7,k),l(8,V),l(9,$)],y);function Je(c,d,t,i){const e=t.get(V),o=t.get($),r=t.get(k),g=e.getMenuActions(u.DebugToolBarStop,o,{shouldForwardArgs:!0}),S=[];if(U(g,S),!S.length)return;const C=d.add(new ne("notebook.moreRunActions",O("notebook.moreRunActionsLabel","More..."),"codicon-chevron-down",!0));return r.createInstance(le,c,C,S,"debug-stop-actions",i)}const N=[],h=(c,d,t,i,e,o,r)=>{v.appendMenuItem(u.DebugToolBar,{group:"navigation",when:e,order:t,command:{id:c,title:d,icon:i,precondition:o},alt:r}),N.push(v.appendMenuItem(u.ViewContainerTitle,{group:"navigation",when:s.and(e,s.equals("viewContainer",H),p.notEqualsTo("inactive"),s.equals("config.debug.toolBarLocation","docked")),order:t,command:{id:c,title:d,icon:i,precondition:o}}))};ue(v.onDidChangeMenu(c=>{if(c.has(u.DebugToolBar)){ce(N);const d=v.getMenuItems(u.DebugToolBar);for(const t of d)N.push(v.appendMenuItem(u.ViewContainerTitle,{...t,when:s.and(t.when,s.equals("viewContainer",H),p.notEqualsTo("inactive"),s.equals("config.debug.toolBarLocation","docked"))}))}}));const j=s.equals("config.debug.toolBarLocation","commandCenter");v.appendMenuItem(u.CommandCenterCenter,{submenu:u.DebugToolBar,title:"Debug",icon:z.debug,order:1,when:s.and(Ge,j)}),h(Ae,De,10,a.debugContinue,p.isEqualTo("stopped")),h(Be,Me,10,a.debugPause,p.notEqualsTo("stopped"),s.and(p.isEqualTo("running"),qe.toNegated())),h(D,M,70,a.debugStop,I.toNegated(),void 0,{id:A,title:B,icon:a.debugDisconnect,precondition:s.and(I.toNegated(),b)}),h(A,B,70,a.debugDisconnect,I,void 0,{id:D,title:M,icon:a.debugStop,precondition:s.and(I,b)}),h($e,ke,20,a.debugStepOver,void 0,p.isEqualTo("stopped")),h(Pe,xe,30,a.debugStepInto,void 0,p.isEqualTo("stopped")),h(Ue,Ve,40,a.debugStepOut,void 0,p.isEqualTo("stopped")),h(Le,Ne,60,a.debugRestart),h(We,O("stepBackDebug","Step Back"),50,a.debugStepBack,F,p.isEqualTo("stopped")),h(Re,O("reverseContinue","Reverse"),55,a.debugReverseContinue,F,p.isEqualTo("stopped")),h(G,Oe,100,z.listTree,s.and(Fe,j.negate())),v.appendMenuItem(u.DebugToolBarStop,{group:"navigation",when:s.and(I.toNegated(),b),order:0,command:{id:A,title:B,icon:a.debugDisconnect}}),v.appendMenuItem(u.DebugToolBarStop,{group:"navigation",when:s.and(I,b),order:0,command:{id:D,title:M,icon:a.debugStop}}),v.appendMenuItem(u.DebugToolBarStop,{group:"navigation",when:s.or(s.and(I.toNegated(),K,b),s.and(I,K)),order:0,command:{id:we,title:ye,icon:a.debugDisconnect}});export{y as DebugToolBar,Je as createDisconnectMenuItemAction};
