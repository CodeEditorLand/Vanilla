var ee=Object.defineProperty;var te=Object.getOwnPropertyDescriptor;var P=(c,d,t,i)=>{for(var e=i>1?void 0:i?te(d,t):d,o=c.length-1,r;o>=0;o--)(r=c[o])&&(e=(i?r(d,t,e):r(e))||e);return i&&e&&ee(d,t,e),e},l=(c,d)=>(t,i)=>d(t,i,c);import*as n from"../../../../base/browser/dom.js";import{StandardMouseEvent as x}from"../../../../base/browser/mouseEvent.js";import{ActionBar as ie,ActionsOrientation as oe}from"../../../../base/browser/ui/actionbar/actionbar.js";import{Action as ne}from"../../../../base/common/actions.js";import*as re from"../../../../base/common/arrays.js";import{RunOnceScheduler as se}from"../../../../base/common/async.js";import*as ae from"../../../../base/common/errors.js";import{DisposableStore as de,MutableDisposable as U,dispose as ce,markAsSingleton as ue}from"../../../../base/common/lifecycle.js";import"./media/debugToolBar.css";import{PixelRatio as le}from"../../../../base/browser/pixelRatio.js";import{mainWindow as pe}from"../../../../base/browser/window.js";import{Codicon as V}from"../../../../base/common/codicons.js";import{clamp as he}from"../../../../base/common/numbers.js";import{ThemeIcon as ge}from"../../../../base/common/themables.js";import{localize as B}from"../../../../nls.js";import{DropdownWithPrimaryActionViewItem as me}from"../../../../platform/actions/browser/dropdownWithPrimaryActionViewItem.js";import{createActionViewItem as ve,createAndFillInActionBarActions as $}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{IMenuService as k,MenuId as u,MenuRegistry as v}from"../../../../platform/actions/common/actions.js";import{IConfigurationService as Se}from"../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as s,IContextKeyService as q}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as Ie}from"../../../../platform/contextview/browser/contextView.js";import{IInstantiationService as G}from"../../../../platform/instantiation/common/instantiation.js";import{INotificationService as Ee}from"../../../../platform/notification/common/notification.js";import{IStorageService as Ce,StorageScope as _,StorageTarget as F}from"../../../../platform/storage/common/storage.js";import{ITelemetryService as be}from"../../../../platform/telemetry/common/telemetry.js";import{widgetBorder as fe,widgetShadow as Te}from"../../../../platform/theme/common/colorRegistry.js";import{IThemeService as _e,Themable as Ae}from"../../../../platform/theme/common/themeService.js";import{EditorTabsMode as ye,IWorkbenchLayoutService as De,LayoutSettings as A,Parts as we}from"../../../services/layout/browser/layoutService.js";import{CONTEXT_DEBUG_STATE as g,CONTEXT_FOCUSED_SESSION_IS_ATTACH as I,CONTEXT_FOCUSED_SESSION_IS_NO_DEBUG as Oe,CONTEXT_IN_DEBUG_MODE as Be,CONTEXT_MULTI_SESSION_DEBUG as Me,CONTEXT_STEP_BACK_SUPPORTED as K,CONTEXT_SUSPEND_DEBUGGEE_SUPPORTED as X,CONTEXT_TERMINATE_DEBUGGEE_SUPPORTED as f,IDebugService as Ne,State as H,VIEWLET_ID as j}from"../common/debug.js";import{FocusSessionActionViewItem as Le}from"./debugActionViewItems.js";import{debugToolBarBackground as Re,debugToolBarBorder as We}from"./debugColors.js";import{CONTINUE_ID as Pe,CONTINUE_LABEL as xe,DISCONNECT_AND_SUSPEND_ID as Ue,DISCONNECT_AND_SUSPEND_LABEL as Ve,DISCONNECT_ID as y,DISCONNECT_LABEL as M,FOCUS_SESSION_ID as z,FOCUS_SESSION_LABEL as $e,PAUSE_ID as ke,PAUSE_LABEL as qe,RESTART_LABEL as Ge,RESTART_SESSION_ID as Fe,REVERSE_CONTINUE_ID as Ke,STEP_BACK_ID as Xe,STEP_INTO_ID as He,STEP_INTO_LABEL as je,STEP_OUT_ID as ze,STEP_OUT_LABEL as Ye,STEP_OVER_ID as Ze,STEP_OVER_LABEL as Je,STOP_ID as D,STOP_LABEL as N}from"./debugCommands.js";import*as a from"./debugIcons.js";const Y="debug.actionswidgetposition",Z="debug.actionswidgety";let w=class extends Ae{constructor(t,i,e,o,r,h,C,S,O,R){super(C);this.notificationService=t;this.telemetryService=i;this.debugService=e;this.layoutService=o;this.storageService=r;this.configurationService=h;this.instantiationService=S;this.$el=n.$("div.debug-toolbar"),this.$el.style.top=`${o.mainContainerOffset.top}px`,this.dragArea=n.append(this.$el,n.$("div.drag-area"+ge.asCSSSelector(a.debugGripper)));const Q=n.append(this.$el,n.$("div.action-bar-container"));this.debugToolBarMenu=O.createMenu(u.DebugToolBar,R),this._register(this.debugToolBarMenu),this.activeActions=[],this.actionBar=this._register(new ie(Q,{orientation:oe.HORIZONTAL,actionViewItemProvider:(m,T)=>{if(m.id===z)return this.instantiationService.createInstance(Le,m,void 0);if(m.id===D||m.id===y){this.stopActionViewItemDisposables.clear();const E=this.instantiationService.invokeFunction(b=>Qe(m,this.stopActionViewItemDisposables,b,{hoverDelegate:T.hoverDelegate}));if(E)return E}return ve(this.instantiationService,m,T)}})),this.updateScheduler=this._register(new se(()=>{const m=this.debugService.state,T=this.configurationService.getValue("debug").toolBarLocation;if(m===H.Inactive||T!=="floating"||this.debugService.getModel().getSessions().every(b=>b.suppressDebugToolbar)||m===H.Initializing&&this.debugService.initializingOptions?.suppressDebugToolbar)return this.hide();const E=[];$(this.debugToolBarMenu,{shouldForwardArgs:!0},E),re.equals(E,this.activeActions,(b,W)=>b.id===W.id&&b.enabled===W.enabled)||(this.actionBar.clear(),this.actionBar.push(E,{icon:!0,label:!1}),this.activeActions=E),this.show()},20)),this.updateStyles(),this.registerListeners(),this.hide()}$el;dragArea;actionBar;activeActions;updateScheduler;debugToolBarMenu;isVisible=!1;isBuilt=!1;stopActionViewItemDisposables=this._register(new de);auxWindowCoordinates=new WeakMap;trackPixelRatioListener=this._register(new U);registerListeners(){this._register(this.debugService.onDidChangeState(()=>this.updateScheduler.schedule())),this._register(this.configurationService.onDidChangeConfiguration(e=>{e.affectsConfiguration("debug.toolBarLocation")&&this.updateScheduler.schedule(),(e.affectsConfiguration(A.EDITOR_TABS_MODE)||e.affectsConfiguration(A.COMMAND_CENTER))&&(this._yRange=void 0,this.setCoordinates())})),this._register(this.debugToolBarMenu.onDidChange(()=>this.updateScheduler.schedule())),this._register(this.actionBar.actionRunner.onDidRun(e=>{e.error&&!ae.isCancellationError(e.error)&&this.notificationService.warn(e.error),this.telemetryService.publicLog2("workbenchActionExecuted",{id:e.action.id,from:"debugActionsWidget"})})),this._register(n.addDisposableGenericMouseUpListener(this.dragArea,e=>{const o=new x(n.getWindow(this.dragArea),e),r=n.getWindow(this.layoutService.activeContainer);if(o.detail===2){const h=this.$el.clientWidth;this.setCoordinates(.5*r.innerWidth-.5*h,this.yDefault),this.storePosition()}})),this._register(n.addDisposableGenericMouseDownListener(this.dragArea,e=>{this.dragArea.classList.add("dragged");const o=n.getWindow(this.layoutService.activeContainer),r=n.addDisposableGenericMouseMoveListener(o,C=>{const S=new x(o,C);S.preventDefault(),this.setCoordinates(S.posx-14,S.posy-14)}),h=n.addDisposableGenericMouseUpListener(o,C=>{this.storePosition(),this.dragArea.classList.remove("dragged"),r.dispose(),h.dispose()})})),this._register(this.layoutService.onDidChangePartVisibility(()=>this.setCoordinates()));const t=this._register(new U),i=()=>{t.value=this._register(n.addDisposableListener(n.getWindow(this.layoutService.activeContainer),n.EventType.RESIZE,()=>this.setCoordinates()))};this._register(this.layoutService.onDidChangeActiveContainer(async()=>{this._yRange=void 0,await this.layoutService.whenContainerStylesLoaded(n.getWindow(this.layoutService.activeContainer)),this.isBuilt&&(this.doShowInActiveContainer(),this.setCoordinates()),i()})),i()}storePosition(){const t=n.getWindow(this.layoutService.activeContainer),i=this.layoutService.activeContainer===this.layoutService.mainContainer,e=this.$el.getBoundingClientRect(),o=e.top,r=e.left/t.innerWidth;i?(this.storageService.store(Y,r,_.PROFILE,F.MACHINE),this.storageService.store(Z,o,_.PROFILE,F.MACHINE)):this.auxWindowCoordinates.set(t,{x:r,y:o})}updateStyles(){if(super.updateStyles(),this.$el){this.$el.style.backgroundColor=this.getColor(Re)||"";const t=this.getColor(Te);this.$el.style.boxShadow=t?`0 0 8px 2px ${t}`:"";const i=this.getColor(fe),e=this.getColor(We);i?this.$el.style.border=`1px solid ${i}`:(this.$el.style.border=e?`solid ${e}`:"none",this.$el.style.border="1px 0")}}setCoordinates(t,i){if(!this.isVisible)return;const e=this.$el.clientWidth,o=n.getWindow(this.layoutService.activeContainer),r=o===pe;if(t===void 0){const h=r?Number(this.storageService.get(Y,_.PROFILE)):this.auxWindowCoordinates.get(o)?.x;t=h!==void 0&&!isNaN(h)?h*o.innerWidth:.5*o.innerWidth-.5*e}t=he(t,0,o.innerWidth-e),this.$el.style.left=`${t}px`,i===void 0&&(i=r?this.storageService.getNumber(Z,_.PROFILE):this.auxWindowCoordinates.get(o)?.y),this.setYCoordinate(i??this.yDefault)}setYCoordinate(t){const[i,e]=this.yRange;t=Math.max(i,Math.min(t,e)),this.$el.style.top=`${t}px`}get yDefault(){return this.layoutService.mainContainerOffset.top}_yRange;get yRange(){if(!this._yRange){const t=this.layoutService.isVisible(we.TITLEBAR_PART,n.getWindow(this.layoutService.activeContainer)),i=t?0:this.layoutService.mainContainerOffset.top;let e=0;t&&(this.configurationService.getValue(A.COMMAND_CENTER)===!0?e+=35:e+=28),this.configurationService.getValue(A.EDITOR_TABS_MODE)!==ye.NONE&&(e+=35),this._yRange=[i,e]}return this._yRange}show(){if(this.isVisible){this.setCoordinates();return}this.isBuilt||(this.isBuilt=!0,this.doShowInActiveContainer()),this.isVisible=!0,n.show(this.$el),this.setCoordinates()}doShowInActiveContainer(){this.layoutService.activeContainer.appendChild(this.$el),this.trackPixelRatioListener.value=le.getInstance(n.getWindow(this.$el)).onDidChange(()=>this.setCoordinates())}hide(){this.isVisible=!1,n.hide(this.$el)}dispose(){super.dispose(),this.$el?.remove()}};w=P([l(0,Ee),l(1,be),l(2,Ne),l(3,De),l(4,Ce),l(5,Se),l(6,_e),l(7,G),l(8,k),l(9,q)],w);function Qe(c,d,t,i){const e=t.get(k),o=t.get(q),r=t.get(G),h=t.get(Ie),C=e.getMenuActions(u.DebugToolBarStop,o,{shouldForwardArgs:!0}),S=[];if($(C,S),!S.length)return;const O=d.add(new ne("notebook.moreRunActions",B("notebook.moreRunActionsLabel","More..."),"codicon-chevron-down",!0));return r.createInstance(me,c,O,S,"debug-stop-actions",h,i)}const L=[],p=(c,d,t,i,e,o,r)=>{v.appendMenuItem(u.DebugToolBar,{group:"navigation",when:e,order:t,command:{id:c,title:d,icon:i,precondition:o},alt:r}),L.push(v.appendMenuItem(u.ViewContainerTitle,{group:"navigation",when:s.and(e,s.equals("viewContainer",j),g.notEqualsTo("inactive"),s.equals("config.debug.toolBarLocation","docked")),order:t,command:{id:c,title:d,icon:i,precondition:o}}))};ue(v.onDidChangeMenu(c=>{if(c.has(u.DebugToolBar)){ce(L);const d=v.getMenuItems(u.DebugToolBar);for(const t of d)L.push(v.appendMenuItem(u.ViewContainerTitle,{...t,when:s.and(t.when,s.equals("viewContainer",j),g.notEqualsTo("inactive"),s.equals("config.debug.toolBarLocation","docked"))}))}}));const J=s.equals("config.debug.toolBarLocation","commandCenter");v.appendMenuItem(u.CommandCenterCenter,{submenu:u.DebugToolBar,title:"Debug",icon:V.debug,order:1,when:s.and(Be,J)}),p(Pe,xe,10,a.debugContinue,g.isEqualTo("stopped")),p(ke,qe,10,a.debugPause,g.notEqualsTo("stopped"),s.and(g.isEqualTo("running"),Oe.toNegated())),p(D,N,70,a.debugStop,I.toNegated(),void 0,{id:y,title:M,icon:a.debugDisconnect,precondition:s.and(I.toNegated(),f)}),p(y,M,70,a.debugDisconnect,I,void 0,{id:D,title:N,icon:a.debugStop,precondition:s.and(I,f)}),p(Ze,Je,20,a.debugStepOver,void 0,g.isEqualTo("stopped")),p(He,je,30,a.debugStepInto,void 0,g.isEqualTo("stopped")),p(ze,Ye,40,a.debugStepOut,void 0,g.isEqualTo("stopped")),p(Fe,Ge,60,a.debugRestart),p(Xe,B("stepBackDebug","Step Back"),50,a.debugStepBack,K,g.isEqualTo("stopped")),p(Ke,B("reverseContinue","Reverse"),55,a.debugReverseContinue,K,g.isEqualTo("stopped")),p(z,$e,100,V.listTree,s.and(Me,J.negate())),v.appendMenuItem(u.DebugToolBarStop,{group:"navigation",when:s.and(I.toNegated(),f),order:0,command:{id:y,title:M,icon:a.debugDisconnect}}),v.appendMenuItem(u.DebugToolBarStop,{group:"navigation",when:s.and(I,f),order:0,command:{id:D,title:N,icon:a.debugStop}}),v.appendMenuItem(u.DebugToolBarStop,{group:"navigation",when:s.or(s.and(I.toNegated(),X,f),s.and(I,X)),order:0,command:{id:Ue,title:Ve,icon:a.debugDisconnect}});export{w as DebugToolBar,Qe as createDisconnectMenuItemAction};
