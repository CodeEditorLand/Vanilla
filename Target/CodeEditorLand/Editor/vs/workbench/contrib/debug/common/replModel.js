import{Emitter as g}from"../../../../base/common/event.js";import I from"../../../../base/common/severity.js";import{isObject as p,isString as R}from"../../../../base/common/types.js";import{generateUuid as h}from"../../../../base/common/uuid.js";import*as C from"../../../../nls.js";import{ExpressionContainer as S}from"./debugModel.js";const E=1e4;let y=0;const c=()=>`topReplElement:${y++}`;class d{constructor(e,t,n,i,r,a){this.session=e;this.id=t;this.value=n;this.severity=i;this.sourceData=r;this.expression=a}_count=1;_onDidChangeCount=new g;toString(e=!1){let t=this.value;for(let i=1;i<this.count;i++)t+=(t.endsWith(`
`)?"":`
`)+this.value;const n=this.sourceData&&e?` ${this.sourceData.source.name}`:"";return t+n}getId(){return this.id}getChildren(){return this.expression?.getChildren()||Promise.resolve([])}set count(e){this._count=e,this._onDidChangeCount.fire()}get count(){return this._count}get onDidChangeCount(){return this._onDidChangeCount.event}get hasChildren(){return!!this.expression?.hasChildren}}class D{constructor(e,t,n,i){this.session=e;this.expression=t;this.severity=n;this.sourceData=i;this.hasChildren=t.hasChildren}hasChildren;id=h();getSession(){return this.session}getChildren(){return this.expression.getChildren()}toString(){return this.expression.toString()}getId(){return this.id}}class u{constructor(e,t,n,i,r){this.id=e;this.name=t;this.valueObj=n;this.sourceData=i;this.annotation=r}static MAX_CHILDREN=1e3;getId(){return this.id}getSession(){}get value(){return this.valueObj===null?"null":Array.isArray(this.valueObj)?`Array[${this.valueObj.length}]`:p(this.valueObj)?"Object":R(this.valueObj)?`"${this.valueObj}"`:String(this.valueObj)||""}get hasChildren(){return Array.isArray(this.valueObj)&&this.valueObj.length>0||p(this.valueObj)&&Object.getOwnPropertyNames(this.valueObj).length>0}evaluateLazy(){throw new Error("Method not implemented.")}getChildren(){let e=[];return Array.isArray(this.valueObj)?e=this.valueObj.slice(0,u.MAX_CHILDREN).map((t,n)=>new u(`${this.id}:${n}`,String(n),t)):p(this.valueObj)&&(e=Object.getOwnPropertyNames(this.valueObj).slice(0,u.MAX_CHILDREN).map((t,n)=>new u(`${this.id}:${n}`,t,this.valueObj[t]))),Promise.resolve(e)}toString(){return`${this.name}
${this.value}`}}class x{constructor(e){this.value=e;this.id=h()}id;toString(){return this.value}getId(){return this.id}}class O extends S{constructor(t){super(void 0,void 0,0,h());this.originalExpression=t}_available=!0;get available(){return this._available}async evaluateExpression(t,n,i,r){const a=await super.evaluateExpression(t,n,i,r);return this._available=a,a}toString(){return`${this.value}`}}class o{constructor(e,t,n,i){this.session=e;this.name=t;this.autoExpand=n;this.sourceData=i;this.id=`replGroup:${o.COUNTER++}`}children=[];id;ended=!1;static COUNTER=0;get hasChildren(){return!0}getId(){return this.id}toString(e=!1){const t=e&&this.sourceData?` ${this.sourceData.source.name}`:"";return this.name+t}addChild(e){const t=this.children.length?this.children[this.children.length-1]:void 0;t instanceof o&&!t.hasEnded?t.addChild(e):this.children.push(e)}getChildren(){return this.children}end(){const e=this.children.length?this.children[this.children.length-1]:void 0;e instanceof o&&!e.hasEnded?e.end():this.ended=!0}get hasEnded(){return this.ended}}function j(s,e){return!s&&!e?!0:s&&e?s.column===e.column&&s.lineNumber===e.lineNumber&&s.source.uri.toString()===e.source.uri.toString():!1}class v{constructor(e){this.configurationService=e}replElements=[];_onDidChangeElements=new g;onDidChangeElements=this._onDidChangeElements.event;getReplElements(){return this.replElements}async addReplExpression(e,t,n){this.addReplElement(new x(n));const i=new O(n);await i.evaluateExpression(n,e,t,"repl"),this.addReplElement(i)}appendToRepl(e,{output:t,expression:n,sev:i,source:r}){const a="\x1B[2J",m=t.lastIndexOf(a);if(m!==-1&&(this.removeReplExpressions(),this.appendToRepl(e,{output:C.localize("consoleCleared","Console was cleared"),sev:I.Ignore}),t=t.substring(m+a.length)),n){this.addReplElement(t?new d(e,c(),t,i,r,n):new D(e,n,i,r));return}const l=this.replElements.length?this.replElements[this.replElements.length-1]:void 0;if(l instanceof d&&l.severity===i){const f=this.configurationService.getValue("debug");if(l.value===t&&j(l.sourceData,r)&&f.console.collapseIdenticalLines){l.count++;return}if(!l.value.endsWith(`
`)&&!l.value.endsWith(`\r
`)&&l.count===1){this.replElements[this.replElements.length-1]=new d(e,c(),l.value+t,i,r),this._onDidChangeElements.fire(void 0);return}}const b=new d(e,c(),t,i,r);this.addReplElement(b)}startGroup(e,t,n,i){const r=new o(e,t,n,i);this.addReplElement(r)}endGroup(){const e=this.replElements[this.replElements.length-1];e instanceof o&&e.end()}addReplElement(e){const t=this.replElements.length?this.replElements[this.replElements.length-1]:void 0;t instanceof o&&!t.hasEnded?t.addChild(e):(this.replElements.push(e),this.replElements.length>E&&this.replElements.splice(0,this.replElements.length-E)),this._onDidChangeElements.fire(e)}removeReplExpressions(){this.replElements.length>0&&(this.replElements=[],this._onDidChangeElements.fire(void 0))}clone(){const e=new v(this.configurationService);return e.replElements=this.replElements.slice(),e}}export{u as RawObjectReplElement,x as ReplEvaluationInput,O as ReplEvaluationResult,o as ReplGroup,v as ReplModel,d as ReplOutputElement,D as ReplVariableElement};
