import{equalsIgnoreCase as l}from"../../../../base/common/strings.js";import"./debug.js";import{URI as c}from"../../../../base/common/uri.js";import{isAbsolute as k}from"../../../../base/common/path.js";import{deepClone as p}from"../../../../base/common/objects.js";import{Schemas as g}from"../../../../base/common/network.js";import"../../../services/editor/common/editorService.js";import"../../../../platform/configuration/common/configuration.js";import"../../../../editor/common/model.js";import"../../../../editor/common/core/position.js";import{Range as P}from"../../../../editor/common/core/range.js";import{CancellationToken as E}from"../../../../base/common/cancellation.js";import{coalesce as x}from"../../../../base/common/arrays.js";import"../../../../editor/common/services/languageFeatures.js";const y=/{([^}]+)}/g;function X(t,e,n){return t.replace(y,function(r,o){return e&&o.length>0&&o[0]!=="_"?r:n&&n.hasOwnProperty(o)?n[o]:r})}function Y(t){const e={};for(const n of Object.keys(t))n.startsWith("!")||(e[n]=t[n]);return e}function D(t){return t.configuration.request==="attach"&&!f(t)&&(!t.parentSession||D(t.parentSession))}function f(t){let e=t.configuration.type;if(e)return e==="vslsShare"&&(e=t.configuration.adapterProxy.configuration.type),l(e,"extensionhost")||l(e,"pwa-extensionhost")?t:t.parentSession?f(t.parentSession):void 0}function $(t){return t.type&&(t.label||t.program||t.runtime)}function v(t,e,n){let r,o=0;const s=/([^()\[\]{}<>\s+\-/%~#^;=|,`!]|\->)+/g;let i=null;for(;i=s.exec(t);){const a=i.index+1,u=a+i[0].length;if(a<=e&&u>=n){r=i[0],o=a;break}}if(r){const a=/(\w|\p{L})+/gu;let u=null;for(;(u=a.exec(r))&&!(u.index+1+o+u[0].length>=n););u&&(r=r.substring(0,a.lastIndex))}return r?{start:o,end:o+r.length-1}:{start:0,end:0}}async function ee(t,e,n,r){if(t.evaluatableExpressionProvider.has(e)){const o=t.evaluatableExpressionProvider.ordered(e),s=x(await Promise.all(o.map(async i=>{try{return await i.provideEvaluatableExpression(e,n,r??E.None)}catch{return}})));if(s.length>0){let i=s[0].expression;const a=s[0].range;return i||(i=e.getLineContent(n.lineNumber).substring(a.startColumn-1,a.endColumn-1)),{range:a,matchingExpression:i}}}else{const o=e.getLineContent(n.lineNumber),{start:s,end:i}=v(o,n.column,n.column),a=o.substring(s-1,i);return{matchingExpression:a,range:new P(n.lineNumber,s,n.lineNumber,s+a.length)}}return null}const C=/^[a-zA-Z][a-zA-Z0-9\+\-\.]+:/;function I(t){return!!(t&&t.match(C))}function b(t){if(typeof t.path=="string"&&!(typeof t.sourceReference=="number"&&t.sourceReference>0)){if(I(t.path))return c.parse(t.path);if(k(t.path))return c.file(t.path)}return t.path}function d(t){if(typeof t.path=="object"){const e=c.revive(t.path);if(e)return e.scheme===g.file?e.fsPath:e.toString()}return t.path}function te(t,e){const n=e?b:d,r=p(t);return m(r,(o,s)=>{o&&s&&(s.path=n(s))}),r}function ne(t,e){const n=e?b:d,r=p(t);return m(r,(o,s)=>{!o&&s&&(s.path=n(s))}),r}function m(t,e){switch(t.type){case"event":{const n=t;switch(n.event){case"output":e(!1,n.body.source);break;case"loadedSource":e(!1,n.body.source);break;case"breakpoint":e(!1,n.body.breakpoint.source);break;default:break}break}case"request":{const n=t;switch(n.command){case"setBreakpoints":e(!0,n.arguments.source);break;case"breakpointLocations":e(!0,n.arguments.source);break;case"source":e(!0,n.arguments.source);break;case"gotoTargets":e(!0,n.arguments.source);break;case"launchVSCode":n.arguments.args.forEach(r=>e(!1,r));break;default:break}break}case"response":{const n=t;if(n.success&&n.body)switch(n.command){case"stackTrace":n.body.stackFrames.forEach(r=>e(!1,r.source));break;case"loadedSources":n.body.sources.forEach(r=>e(!1,r));break;case"scopes":n.body.scopes.forEach(r=>e(!1,r.source));break;case"setFunctionBreakpoints":n.body.breakpoints.forEach(r=>e(!1,r.source));break;case"setBreakpoints":n.body.breakpoints.forEach(r=>e(!1,r.source));break;case"disassemble":n.body?.instructions.forEach(o=>e(!1,o.location));break;case"locations":e(!1,n.body?.source);break;default:break}break}}}function re(t){return t.filter(e=>!e.presentation?.hidden).sort((e,n)=>e.presentation?n.presentation?e.presentation.group?n.presentation.group?e.presentation.group!==n.presentation.group?e.presentation.group.localeCompare(n.presentation.group):h(e.presentation.order,n.presentation.order):-1:n.presentation.group?1:h(e.presentation.order,n.presentation.order):-1:n.presentation?1:0)}function h(t,e){return typeof t!="number"?typeof e!="number"?0:1:typeof e!="number"?-1:t-e}async function oe(t,e){const n=t.getValue("debug.saveBeforeStart",{overrideIdentifier:e.activeTextEditorLanguageId});if(n!=="none"&&(await e.saveAll(),n==="allEditorsInActiveGroup")){const r=e.activeEditorPane;r&&r.input.resource?.scheme===g.untitled&&await e.save({editor:r.input,groupId:r.group.id})}await t.reloadConfiguration()}const se=(t,e)=>!t||!e?t===e:t.name===e.name&&t.path===e.path&&t.sourceReference===e.sourceReference;export{te as convertToDAPaths,ne as convertToVSCPaths,Y as filterExceptionsFromTelemetry,X as formatPII,ee as getEvaluatableExpressionAtPosition,v as getExactExpressionStartAndEnd,f as getExtensionHostDebugSession,re as getVisibleAndSorted,$ as isDebuggerMainContribution,D as isSessionAttach,I as isUri,oe as saveAllBeforeDebugStart,se as sourcesEqual};
