var q=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var R=(o,n,e,t)=>{for(var i=t>1?void 0:t?K(n,e):n,s=o.length-1,r;s>=0;s--)(r=o[s])&&(i=(t?r(n,e,i):r(i))||i);return t&&i&&q(n,e,i),i},S=(o,n)=>(e,t)=>n(e,t,o);import{distinct as F}from"../../../../base/common/arrays.js";import{findLastIdx as Z}from"../../../../base/common/arraysFind.js";import{DeferredPromise as j,RunOnceScheduler as Y}from"../../../../base/common/async.js";import{VSBuffer as T,decodeBase64 as Q,encodeBase64 as X}from"../../../../base/common/buffer.js";import{CancellationTokenSource as ee}from"../../../../base/common/cancellation.js";import{Emitter as f}from"../../../../base/common/event.js";import{stringHash as te}from"../../../../base/common/hash.js";import{Disposable as L,DisposableMap as ie}from"../../../../base/common/lifecycle.js";import{mixin as ne}from"../../../../base/common/objects.js";import{autorun as N}from"../../../../base/common/observable.js";import*as E from"../../../../base/common/resources.js";import{isString as M,isUndefinedOrNull as se}from"../../../../base/common/types.js";import{URI as re}from"../../../../base/common/uri.js";import{generateUuid as p}from"../../../../base/common/uuid.js";import{Range as B}from"../../../../editor/common/core/range.js";import*as h from"../../../../nls.js";import{ILogService as ae}from"../../../../platform/log/common/log.js";import{IUriIdentityService as oe}from"../../../../platform/uriIdentity/common/uriIdentity.js";import{DEBUG_MEMORY_SCHEME as de,DataBreakpointSetType as A,DebugTreeItemCollapsibleState as le,MemoryRangeType as I,State as U,isFrameDeemphasized as ue}from"./debug.js";import{UNKNOWN_SOURCE_LABEL as ce,getUriFromSource as pe}from"./debugSource.js";import{DisassemblyViewInput as $}from"./disassemblyViewInput.js";import{ITextFileService as he}from"../../../services/textfile/common/textfiles.js";class u{constructor(n,e,t,i,s=0,r=0,a=void 0,d=0,l=void 0,c=void 0){this.session=n;this.threadId=e;this._reference=t;this.id=i;this.namedVariables=s;this.indexedVariables=r;this.memoryReference=a;this.startOfVariables=d;this.presentationHint=l;this.valueLocationReference=c}static allValues=new Map;static BASE_CHUNK_SIZE=100;type;valueChanged=!1;_value="";children;get reference(){return this._reference}set reference(n){this._reference=n,this.children=void 0}async evaluateLazy(){if(typeof this.reference>"u")return;const n=await this.session.variables(this.reference,this.threadId,void 0,void 0,void 0);if(!n||!n.body||!n.body.variables||n.body.variables.length!==1)return;const e=n.body.variables[0];this.reference=e.variablesReference,this._value=e.value,this.namedVariables=e.namedVariables,this.indexedVariables=e.indexedVariables,this.memoryReference=e.memoryReference,this.presentationHint=e.presentationHint,this.valueLocationReference=e.valueLocationReference,this.adoptLazyResponse(e)}adoptLazyResponse(n){}getChildren(){return this.children||(this.children=this.doGetChildren()),this.children}async doGetChildren(){if(!this.hasChildren)return[];if(!this.getChildrenInChunks)return this.fetchVariables(void 0,void 0,void 0);const n=this.namedVariables?await this.fetchVariables(void 0,void 0,"named"):[];let e=u.BASE_CHUNK_SIZE;for(;this.indexedVariables&&this.indexedVariables>e*u.BASE_CHUNK_SIZE;)e*=u.BASE_CHUNK_SIZE;if(this.indexedVariables&&this.indexedVariables>e){const i=Math.ceil(this.indexedVariables/e);for(let s=0;s<i;s++){const r=(this.startOfVariables||0)+s*e,a=Math.min(e,this.indexedVariables-s*e);n.push(new C(this.session,this.threadId,this,this.reference,`[${r}..${r+a-1}]`,"","",void 0,a,void 0,{kind:"virtual"},void 0,void 0,!0,r))}return n}const t=await this.fetchVariables(this.startOfVariables,this.indexedVariables,"indexed");return n.concat(t)}getId(){return this.id}getSession(){return this.session}get value(){return this._value}get hasChildren(){return!!this.reference&&this.reference>0&&!this.presentationHint?.lazy}async fetchVariables(n,e,t){try{const i=await this.session.variables(this.reference||0,this.threadId,t,n,e);if(!i||!i.body||!i.body.variables)return[];const s=new Map,r=i.body.variables.filter(a=>!!a).map(a=>{if(M(a.value)&&M(a.name)&&typeof a.variablesReference=="number"){const d=s.get(a.name)||0,l=d>0?d.toString():"";return s.set(a.name,d+1),new C(this.session,this.threadId,this,a.variablesReference,a.name,a.evaluateName,a.value,a.namedVariables,a.indexedVariables,a.memoryReference,a.presentationHint,a.type,a.__vscodeVariableMenuContext,!0,0,l,a.declarationLocationReference,a.valueLocationReference)}return new C(this.session,this.threadId,this,0,"",void 0,h.localize("invalidVariableAttributes","Invalid variable attributes"),0,0,void 0,{kind:"virtual"},void 0,void 0,!1)});return this.session.autoExpandLazyVariables&&await Promise.all(r.map(a=>a.presentationHint?.lazy&&a.evaluateLazy())),r}catch(i){return[new C(this.session,this.threadId,this,0,"",void 0,i.message,0,0,void 0,{kind:"virtual"},void 0,void 0,!1)]}}get getChildrenInChunks(){return!!this.indexedVariables}set value(n){this._value=n,this.valueChanged=!!u.allValues.get(this.getId())&&u.allValues.get(this.getId())!==g.DEFAULT_VALUE&&u.allValues.get(this.getId())!==n,u.allValues.set(this.getId(),n)}toString(){return this.value}async evaluateExpression(n,e,t,i,s=!1,r){if(!e||!t&&i!=="repl")return this.value=i==="repl"?h.localize("startDebugFirst","Please start a debug session to evaluate expressions"):g.DEFAULT_VALUE,this.reference=0,!1;this.session=e;try{const a=await e.evaluate(n,t?t.frameId:void 0,i,r);return a&&a.body?(this.value=a.body.result||"",this.reference=a.body.variablesReference,this.namedVariables=a.body.namedVariables,this.indexedVariables=a.body.indexedVariables,this.memoryReference=a.body.memoryReference,this.type=a.body.type||this.type,this.presentationHint=a.body.presentationHint,this.valueLocationReference=a.body.valueLocationReference,!s&&a.body.presentationHint?.lazy&&await this.evaluateLazy(),!0):!1}catch(a){return this.value=a.message||"",this.reference=0,!1}}}function P(o,n){n&&n.body&&(o.value=n.body.value||"",o.type=n.body.type||o.type,o.reference=n.body.variablesReference,o.namedVariables=n.body.namedVariables,o.indexedVariables=n.body.indexedVariables)}class Et{constructor(n,e,t,i){this.visualizer=n;this.treeId=e;this.treeItem=t;this.original=i}errorMessage;id=p();evaluateLazy(){return Promise.resolve()}getChildren(){return this.visualizer.getVisualizedChildren(this.treeId,this.treeItem.id)}getId(){return this.id}get name(){return this.treeItem.label}get value(){return this.treeItem.description||""}get hasChildren(){return this.treeItem.collapsibleState!==le.None}async edit(n){try{return await this.visualizer.editTreeItem(this.treeId,this.treeItem,n),!0}catch(e){return this.errorMessage=e.message,!1}}}class g extends u{constructor(e,t=p()){super(void 0,void 0,0,t);this.name=e;this.available=!1,e&&(this.value=g.DEFAULT_VALUE)}static DEFAULT_VALUE=h.localize("notAvailable","not available");available;_onDidChangeValue=new f;onDidChangeValue=this._onDidChangeValue.event;async evaluate(e,t,i,s,r){const a=this.value===g.DEFAULT_VALUE;this.available=await this.evaluateExpression(this.name,e,t,i,s,r),(a||this.valueChanged)&&this._onDidChangeValue.fire(this)}toString(){return`${this.name}
${this.value}`}async setExpression(e,t){if(!this.session)return;const i=await this.session.setExpression(t.frameId,this.name,e);P(this,i)}}class C extends u{constructor(e,t,i,s,r,a,d,l,c,b,D,m=void 0,k=void 0,ke=!0,W=0,G="",Ie=void 0,J=void 0){super(e,t,s,`variable:${i.getId()}:${r}:${G}`,l,c,b,W,D,J);this.parent=i;this.name=r;this.evaluateName=a;this.variableMenuContext=k;this.available=ke;this.declarationLocationReference=Ie;this.value=d||"",this.type=m}errorMessage;getThreadId(){return this.threadId}async setVariable(e,t){if(this.session)try{if(this.session.capabilities.supportsSetExpression&&!this.session.capabilities.supportsSetVariable&&this.evaluateName)return this.setExpression(e,t);const i=await this.session.setVariable(this.parent.reference,this.name,e);P(this,i)}catch(i){this.errorMessage=i.message}}async setExpression(e,t){if(!this.session||!this.evaluateName)return;const i=await this.session.setExpression(t.frameId,this.evaluateName,e);P(this,i)}toString(){return this.name?`${this.name}: ${this.value}`:this.value}adoptLazyResponse(e){this.evaluateName=e.evaluateName}toDebugProtocolObject(){return{name:this.name,variablesReference:this.reference||0,memoryReference:this.memoryReference,value:this.value,evaluateName:this.evaluateName}}}class z extends u{constructor(e,t,i,s,r,a,d,l){super(e.thread.session,e.thread.threadId,s,`scope:${i}:${t}`,a,d);this.stackFrame=e;this.name=i;this.expensive=r;this.range=l}toString(){return this.name}toDebugProtocolObject(){return{name:this.name,variablesReference:this.reference||0,expensive:this.expensive}}}class fe extends z{constructor(n,e,t){super(n,e,t,0,!1)}toString(){return this.name}}class ge{constructor(n,e,t,i,s,r,a,d,l){this.thread=n;this.frameId=e;this.source=t;this.name=i;this.presentationHint=s;this.range=r;this.index=a;this.canRestart=d;this.instructionPointerReference=l}scopes;getId(){return`stackframe:${this.thread.getId()}:${this.index}:${this.source.name}`}getScopes(){return this.scopes||(this.scopes=this.thread.session.scopes(this.frameId,this.thread.threadId).then(n=>{if(!n||!n.body||!n.body.scopes)return[];const e=new Set;return n.body.scopes.map(t=>{let i=0;do i=te(`${t.name}:${t.line}:${t.column}`,i);while(e.has(i));return e.add(i),new z(this,i,t.name,t.variablesReference,t.expensive,t.namedVariables,t.indexedVariables,t.line&&t.column&&t.endLine&&t.endColumn?new B(t.line,t.column,t.endLine,t.endColumn):void 0)})},n=>[new fe(this,0,n.message)])),this.scopes}async getMostSpecificScopes(n){const t=(await this.getScopes()).filter(r=>!r.expensive);if(!t.some(r=>!!r.range))return t;const s=t.filter(r=>r.range&&B.containsRange(r.range,n)).sort((r,a)=>r.range.endLineNumber-r.range.startLineNumber-(a.range.endLineNumber-a.range.startLineNumber));return s.length?s:t}restart(){return this.thread.session.restartFrame(this.frameId,this.thread.threadId)}forgetScopes(){this.scopes=void 0}toString(){const n=typeof this.range.startLineNumber=="number"?`:${this.range.startLineNumber}`:"",e=`${this.source.inMemory?this.source.name:this.source.uri.fsPath}${n}`;return e===ce?this.name:`${this.name} (${e})`}async openInEditor(n,e,t,i){const s=this.thread.stoppedDetails?.reason;if(this.instructionPointerReference&&(s==="instruction breakpoint"||s==="step"&&this.thread.lastSteppingGranularity==="instruction"||n.activeEditor instanceof $))return n.openEditor($.instance,{pinned:!0,revealIfOpened:!0});if(this.source.available)return this.source.openInEditor(n,this.range,e,t,i)}equals(n){return this.name===n.name&&n.thread===this.thread&&this.frameId===n.frameId&&n.source===this.source&&B.equalsRange(this.range,n.range)}}const be=["breakpoint","step","function breakpoint"];class Pt{constructor(n,e,t){this.session=n;this.name=e;this.threadId=t;this.callStack=[],this.staleCallStack=[],this.stopped=!1}callStack;staleCallStack;callStackCancellationTokens=[];stoppedDetails;stopped;reachedEndOfCallStack=!1;lastSteppingGranularity;getId(){return`thread:${this.session.getId()}:${this.threadId}`}clearCallStack(){this.callStack.length&&(this.staleCallStack=this.callStack),this.callStack=[],this.callStackCancellationTokens.forEach(n=>n.dispose(!0)),this.callStackCancellationTokens=[]}getCallStack(){return this.callStack}getStaleCallStack(){return this.staleCallStack}getTopStackFrame(){const n=this.getCallStack(),e=this.stoppedDetails?.reason;return n.find(i=>!!((e==="instruction breakpoint"||e==="step"&&this.lastSteppingGranularity==="instruction")&&i.instructionPointerReference||i.source&&i.source.available&&(be.includes(e)||!ue(i))))}get stateLabel(){return this.stoppedDetails?this.stoppedDetails.description||(this.stoppedDetails.reason?h.localize({key:"pausedOn",comment:["indicates reason for program being paused"]},"Paused on {0}",this.stoppedDetails.reason):h.localize("paused","Paused")):h.localize({key:"running",comment:["indicates state"]},"Running")}async fetchCallStack(n=20){if(this.stopped){const e=this.callStack.length,t=await this.getCallStackImpl(e,n);this.reachedEndOfCallStack=t.length<n,e<this.callStack.length&&this.callStack.splice(e,this.callStack.length-e),this.callStack=this.callStack.concat(t||[]),typeof this.stoppedDetails?.totalFrames=="number"&&this.stoppedDetails.totalFrames===this.callStack.length&&(this.reachedEndOfCallStack=!0)}}async getCallStackImpl(n,e){try{const t=new ee;this.callStackCancellationTokens.push(t);const i=await this.session.stackTrace(this.threadId,n,e,t.token);return!i||!i.body||t.token.isCancellationRequested?[]:(this.stoppedDetails&&(this.stoppedDetails.totalFrames=i.body.totalFrames),i.body.stackFrames.map((s,r)=>{const a=this.session.getSource(s.source);return new ge(this,s.id,a,s.name,s.presentationHint,new B(s.line,s.column,s.endLine||s.line,s.endColumn||s.column),n+r,typeof s.canRestart=="boolean"?s.canRestart:!0,s.instructionPointerReference)}))}catch(t){return this.stoppedDetails&&(this.stoppedDetails.framesErrorMessage=t.message),[]}}get exceptionInfo(){return this.stoppedDetails&&this.stoppedDetails.reason==="exception"?this.session.capabilities.supportsExceptionInfoRequest?this.session.exceptionInfo(this.threadId):Promise.resolve({description:this.stoppedDetails.text,breakMode:null}):Promise.resolve(void 0)}next(n){return this.session.next(this.threadId,n)}stepIn(n){return this.session.stepIn(this.threadId,void 0,n)}stepOut(n){return this.session.stepOut(this.threadId,n)}stepBack(n){return this.session.stepBack(this.threadId,n)}continue(){return this.session.continue(this.threadId)}pause(){return this.session.pause(this.threadId)}terminate(){return this.session.terminateThreads([this.threadId])}reverseContinue(){return this.session.reverseContinue(this.threadId)}}const _t=(o,n,e,t="memory")=>re.from({scheme:de,authority:o,path:"/"+encodeURIComponent(n)+`/${encodeURIComponent(t)}.bin`,query:e?`?range=${e.fromOffset}:${e.toOffset}`:void 0});class wt extends L{constructor(e,t){super();this.memoryReference=e;this.session=t;this._register(t.onDidInvalidateMemory(i=>{i.body.memoryReference===e&&this.invalidate(i.body.offset,i.body.count-i.body.offset)}))}invalidateEmitter=this._register(new f);onDidInvalidate=this.invalidateEmitter.event;writable=!!this.session.capabilities.supportsWriteMemoryRequest;async read(e,t){const i=t-e,s=e,r=await this.session.readMemory(this.memoryReference,s,i);if(r===void 0||!r.body?.data)return[{type:I.Unreadable,offset:s,length:i}];let a;try{a=Q(r.body.data)}catch{return[{type:I.Error,offset:s,length:i,error:"Invalid base64 data from debug adapter"}]}const d=r.body.unreadableBytes||0,l=i-d;if(a.byteLength<l){const c=T.alloc(l-a.byteLength);c.buffer.fill(0),a=T.concat([a,c],l)}else a.byteLength>l&&(a=a.slice(0,l));return d?[{type:I.Valid,offset:s,length:l,data:a},{type:I.Unreadable,offset:s+l,length:d}]:[{type:I.Valid,offset:s,length:i,data:a}]}async write(e,t){const s=(await this.session.writeMemory(this.memoryReference,e,X(t),!0))?.body?.bytesWritten??t.byteLength;return this.invalidate(e,e+s),s}dispose(){super.dispose()}invalidate(e,t){this.invalidateEmitter.fire({fromOffset:e,toOffset:t})}}class me{constructor(n,e){this.enabled=n;this.id=e}getId(){return this.id}}function y(o,n){return ne({supportsConditionalBreakpoints:!!n.supportsConditionalBreakpoints,supportsHitConditionalBreakpoints:!!n.supportsHitConditionalBreakpoints,supportsLogPoints:!!n.supportsLogPoints,supportsFunctionBreakpoints:!!n.supportsFunctionBreakpoints,supportsDataBreakpoints:!!n.supportsDataBreakpoints,supportsInstructionBreakpoints:!!n.supportsInstructionBreakpoints},o)}class v extends me{sessionData=new Map;data;hitCondition;condition;logMessage;mode;modeLabel;constructor(n,e){super(e.enabled??!0,n),this.condition=e.condition,this.hitCondition=e.hitCondition,this.logMessage=e.logMessage,this.mode=e.mode,this.modeLabel=e.modeLabel}setSessionData(n,e){e?(e.sessionId=n,this.sessionData.set(n,e)):this.sessionData.delete(n);const t=Array.from(this.sessionData.values()),i=F(t.filter(s=>s.verified),s=>`${s.line}:${s.column}`);i.length?this.data=i.length===1?i[0]:void 0:this.data=t.length?t[0]:void 0}get message(){if(this.data)return this.data.message}get verified(){return this.data?this.data.verified:!0}get sessionsThatVerified(){const n=[];for(const[e,t]of this.sessionData)t.verified&&n.push(e);return n}getIdFromAdapter(n){const e=this.sessionData.get(n);return e?e.id:void 0}getDebugProtocolBreakpoint(n){const e=this.sessionData.get(n);if(e)return{id:e.id,verified:e.verified,message:e.message,source:e.source,line:e.line,column:e.column,endLine:e.endLine,endColumn:e.endColumn,instructionReference:e.instructionReference,offset:e.offset}}toJSON(){return{id:this.getId(),enabled:this.enabled,condition:this.condition,hitCondition:this.hitCondition,logMessage:this.logMessage,mode:this.mode,modeLabel:this.modeLabel}}}class _ extends v{constructor(e,t,i,s,r=p()){super(r,e);this.textFileService=t;this.uriIdentityService=i;this.logService=s;this._uri=e.uri,this._lineNumber=e.lineNumber,this._column=e.column,this._adapterData=e.adapterData,this.triggeredBy=e.triggeredBy}sessionsDidTrigger;_uri;_adapterData;_lineNumber;_column;triggeredBy;toDAP(){return{line:this.sessionAgnosticData.lineNumber,column:this.sessionAgnosticData.column,condition:this.condition,hitCondition:this.hitCondition,logMessage:this.logMessage,mode:this.mode}}get originalUri(){return this._uri}get lineNumber(){return this.verified&&this.data&&typeof this.data.line=="number"?this.data.line:this._lineNumber}get verified(){return this.data?this.data.verified&&!this.textFileService.isDirty(this._uri):!0}get pending(){return this.data?!1:this.triggeredBy!==void 0}get uri(){return this.verified&&this.data&&this.data.source?pe(this.data.source,this.data.source.path,this.data.sessionId,this.uriIdentityService,this.logService):this._uri}get column(){return this.verified&&this.data&&typeof this.data.column=="number"?this.data.column:this._column}get message(){return this.textFileService.isDirty(this.uri)?h.localize("breakpointDirtydHover","Unverified breakpoint. File is modified, please restart debug session."):super.message}get adapterData(){return this.data&&this.data.source&&this.data.source.adapterData?this.data.source.adapterData:this._adapterData}get endLineNumber(){return this.verified&&this.data?this.data.endLine:void 0}get endColumn(){return this.verified&&this.data?this.data.endColumn:void 0}get sessionAgnosticData(){return{lineNumber:this._lineNumber,column:this._column}}get supported(){return this.data?!(this.logMessage&&!this.data.supportsLogPoints||this.condition&&!this.data.supportsConditionalBreakpoints||this.hitCondition&&!this.data.supportsHitConditionalBreakpoints):!0}setSessionData(e,t){super.setSessionData(e,t),this._adapterData||(this._adapterData=this.adapterData)}toJSON(){return{...super.toJSON(),uri:this._uri,lineNumber:this._lineNumber,column:this._column,adapterData:this.adapterData,triggeredBy:this.triggeredBy}}toString(){return`${E.basenameOrAuthority(this.uri)} ${this.lineNumber}`}setSessionDidTrigger(e){this.sessionsDidTrigger??=new Set,this.sessionsDidTrigger.add(e)}getSessionDidTrigger(e){return!!this.sessionsDidTrigger?.has(e)}update(e){e.hasOwnProperty("lineNumber")&&!se(e.lineNumber)&&(this._lineNumber=e.lineNumber),e.hasOwnProperty("column")&&(this._column=e.column),e.hasOwnProperty("condition")&&(this.condition=e.condition),e.hasOwnProperty("hitCondition")&&(this.hitCondition=e.hitCondition),e.hasOwnProperty("logMessage")&&(this.logMessage=e.logMessage),e.hasOwnProperty("mode")&&(this.mode=e.mode,this.modeLabel=e.modeLabel),e.hasOwnProperty("triggeredBy")&&(this.triggeredBy=e.triggeredBy,this.sessionsDidTrigger=void 0)}}class w extends v{name;constructor(n,e=p()){super(e,n),this.name=n.name}toDAP(){return{name:this.name,condition:this.condition,hitCondition:this.hitCondition}}toJSON(){return{...super.toJSON(),name:this.name}}get supported(){return this.data?this.data.supportsFunctionBreakpoints:!0}toString(){return this.name}}class O extends v{sessionDataIdForAddr=new WeakMap;description;src;canPersist;accessTypes;accessType;constructor(n,e=p()){super(e,n),this.description=n.description,"dataId"in n&&(n.src={type:A.Variable,dataId:n.dataId}),this.src=n.src,this.canPersist=n.canPersist,this.accessTypes=n.accessTypes,this.accessType=n.accessType,n.initialSessionData&&this.sessionDataIdForAddr.set(n.initialSessionData.session,n.initialSessionData.dataId)}async toDAP(n){let e;if(this.src.type===A.Variable)e=this.src.dataId;else{let t=this.sessionDataIdForAddr.get(n);if(!t){if(t=(await n.dataBytesBreakpointInfo(this.src.address,this.src.bytes))?.dataId,!t)return;this.sessionDataIdForAddr.set(n,t)}e=t}return{dataId:e,accessType:this.accessType,condition:this.condition,hitCondition:this.hitCondition}}toJSON(){return{...super.toJSON(),description:this.description,src:this.src,accessTypes:this.accessTypes,accessType:this.accessType,canPersist:this.canPersist}}get supported(){return this.data?this.data.supportsDataBreakpoints:!0}toString(){return this.description}}class H extends v{supportedSessions=new Set;filter;label;supportsCondition;description;conditionDescription;fallback=!1;constructor(n,e=p()){super(e,n),this.filter=n.filter,this.label=n.label,this.supportsCondition=n.supportsCondition,this.description=n.description,this.conditionDescription=n.conditionDescription,this.fallback=n.fallback||!1}toJSON(){return{...super.toJSON(),filter:this.filter,label:this.label,enabled:this.enabled,supportsCondition:this.supportsCondition,conditionDescription:this.conditionDescription,condition:this.condition,fallback:this.fallback,description:this.description}}setSupportedSession(n,e){e?this.supportedSessions.add(n):this.supportedSessions.delete(n)}setFallback(n){this.fallback=n}get supported(){return!0}isSupportedSession(n){return n?this.supportedSessions.has(n):this.fallback}matches(n){return this.filter===n.filter&&this.label===n.label&&this.supportsCondition===!!n.supportsCondition&&this.conditionDescription===n.conditionDescription&&this.description===n.description}toString(){return this.label}}class V extends v{instructionReference;offset;canPersist;address;constructor(n,e=p()){super(e,n),this.instructionReference=n.instructionReference,this.offset=n.offset,this.canPersist=n.canPersist,this.address=n.address}toDAP(){return{instructionReference:this.instructionReference,condition:this.condition,hitCondition:this.hitCondition,mode:this.mode,offset:this.offset}}toJSON(){return{...super.toJSON(),instructionReference:this.instructionReference,offset:this.offset,canPersist:this.canPersist,address:this.address}}get supported(){return this.data?this.data.supportsInstructionBreakpoints:!0}toString(){return this.instructionReference}}class Ot{constructor(n,e){this.sessionId=n;this.threadId=e}getId(){return`${this.sessionId}:${this.threadId}`}}let x=class extends L{constructor(e,t,i,s){super();this.textFileService=t;this.uriIdentityService=i;this.logService=s;this._register(N(r=>{this.breakpoints=e.breakpoints.read(r),this.functionBreakpoints=e.functionBreakpoints.read(r),this.exceptionBreakpoints=e.exceptionBreakpoints.read(r),this.dataBreakpoints=e.dataBreakpoints.read(r),this._onDidChangeBreakpoints.fire(void 0)})),this._register(N(r=>{this.watchExpressions=e.watchExpressions.read(r),this._onDidChangeWatchExpressions.fire(void 0)})),this.instructionBreakpoints=[],this.sessions=[];for(const r of this.watchExpressions)this.watchExpressionChangeListeners.set(r.getId(),r.onDidChangeValue(a=>this._onDidChangeWatchExpressionValue.fire(a)))}sessions;schedulers=new Map;breakpointsActivated=!0;_onDidChangeBreakpoints=this._register(new f);_onDidChangeCallStack=this._register(new f);_onDidChangeWatchExpressions=this._register(new f);_onDidChangeWatchExpressionValue=this._register(new f);_breakpointModes=new Map;breakpoints;functionBreakpoints;exceptionBreakpoints;dataBreakpoints;watchExpressions;watchExpressionChangeListeners=this._register(new ie);instructionBreakpoints;getId(){return"root"}getSession(e,t=!1){if(e)return this.getSessions(t).find(i=>i.getId()===e)}getSessions(e=!1){return this.sessions.filter(t=>e||t.state!==U.Inactive)}addSession(e){this.sessions=this.sessions.filter(s=>!(s.getId()===e.getId()||s.state===U.Inactive&&s.configuration.name===e.configuration.name));let t=1;for(;this.sessions.some(s=>s.getLabel()===e.getLabel());)e.setName(`${e.configuration.name} ${++t}`);let i=-1;e.parentSession&&(i=Z(this.sessions,s=>s.parentSession===e.parentSession||s===e.parentSession)),i>=0?this.sessions.splice(i+1,0,e):this.sessions.push(e),this._onDidChangeCallStack.fire(void 0)}get onDidChangeBreakpoints(){return this._onDidChangeBreakpoints.event}get onDidChangeCallStack(){return this._onDidChangeCallStack.event}get onDidChangeWatchExpressions(){return this._onDidChangeWatchExpressions.event}get onDidChangeWatchExpressionValue(){return this._onDidChangeWatchExpressionValue.event}rawUpdate(e){const t=this.sessions.find(i=>i.getId()===e.sessionId);t&&(t.rawUpdate(e),this._onDidChangeCallStack.fire(void 0))}clearThreads(e,t,i=void 0){const s=this.sessions.find(r=>r.getId()===e);this.schedulers.forEach(r=>{r.scheduler.dispose(),r.completeDeferred.complete()}),this.schedulers.clear(),s&&(s.clearThreads(t,i),this._onDidChangeCallStack.fire(void 0))}async fetchCallstack(e,t){if(e.reachedEndOfCallStack)return;const i=e.stoppedDetails?.totalFrames,s=typeof i=="number"?i-e.getCallStack().length:void 0;(!t||s&&t>s)&&(t=s),t&&t>0&&(await e.fetchCallStack(t),this._onDidChangeCallStack.fire())}refreshTopOfCallstack(e,t=!0){if(e.session.capabilities.supportsDelayedStackTraceLoading){let s=Promise.resolve();const r=new Promise((a,d)=>{s=e.fetchCallStack(1).then(()=>{if(!t){a(),this._onDidChangeCallStack.fire();return}if(!this.schedulers.has(e.getId())){const c=new j;this.schedulers.set(e.getId(),{completeDeferred:c,scheduler:new Y(()=>{e.fetchCallStack(19).then(()=>{const b=e.getStaleCallStack(),D=e.getCallStack();let m=b.length!==D.length;for(let k=1;k<b.length&&!m;k++)m=!b[k].equals(D[k]);m&&this._onDidChangeCallStack.fire()}).finally(()=>{c.complete(),this.schedulers.delete(e.getId())})},420)})}const l=this.schedulers.get(e.getId());l.scheduler.schedule(),l.completeDeferred.p.then(a,d),this._onDidChangeCallStack.fire()})});return{topCallStack:s,wholeCallStack:r}}const i=e.fetchCallStack();return{wholeCallStack:i,topCallStack:i}}getBreakpoints(e){if(e){const t=e.uri?.toString(),i=e.originalUri?.toString();return this.breakpoints.filter(s=>!(t&&s.uri.toString()!==t||i&&s.originalUri.toString()!==i||e.lineNumber&&s.lineNumber!==e.lineNumber||e.column&&s.column!==e.column||e.enabledOnly&&(!this.breakpointsActivated||!s.enabled)||e.triggeredOnly&&s.triggeredBy===void 0))}return this.breakpoints}getFunctionBreakpoints(){return this.functionBreakpoints}getDataBreakpoints(){return this.dataBreakpoints}getExceptionBreakpoints(){return this.exceptionBreakpoints}getExceptionBreakpointsForSession(e){return this.exceptionBreakpoints.filter(t=>t.isSupportedSession(e))}getInstructionBreakpoints(){return this.instructionBreakpoints}setExceptionBreakpointsForSession(e,t){if(!t)return;let i=!1;t.forEach(s=>{let r=this.exceptionBreakpoints.filter(a=>a.matches(s)).pop();r||(i=!0,r=new H({filter:s.filter,label:s.label,enabled:!!s.default,supportsCondition:!!s.supportsCondition,description:s.description,conditionDescription:s.conditionDescription}),this.exceptionBreakpoints.push(r)),r.setSupportedSession(e,!0)}),i&&this._onDidChangeBreakpoints.fire(void 0)}removeExceptionBreakpointsForSession(e){this.exceptionBreakpoints.forEach(t=>t.setSupportedSession(e,!1))}setExceptionBreakpointFallbackSession(e){this.exceptionBreakpoints.forEach(t=>t.setFallback(t.isSupportedSession(e)))}setExceptionBreakpointCondition(e,t){e.condition=t,this._onDidChangeBreakpoints.fire(void 0)}areBreakpointsActivated(){return this.breakpointsActivated}setBreakpointsActivated(e){this.breakpointsActivated=e,this._onDidChangeBreakpoints.fire(void 0)}addBreakpoints(e,t,i=!0){const s=t.map(r=>new _({uri:e,lineNumber:r.lineNumber,column:r.column,enabled:r.enabled??!0,condition:r.condition,hitCondition:r.hitCondition,logMessage:r.logMessage,triggeredBy:r.triggeredBy,adapterData:void 0,mode:r.mode,modeLabel:r.modeLabel},this.textFileService,this.uriIdentityService,this.logService,r.id));return this.breakpoints=this.breakpoints.concat(s),this.breakpointsActivated=!0,this.sortAndDeDup(),i&&this._onDidChangeBreakpoints.fire({added:s,sessionOnly:!1}),s}removeBreakpoints(e){this.breakpoints=this.breakpoints.filter(t=>!e.some(i=>i.getId()===t.getId())),this._onDidChangeBreakpoints.fire({removed:e,sessionOnly:!1})}updateBreakpoints(e){const t=[];this.breakpoints.forEach(i=>{const s=e.get(i.getId());s&&(i.update(s),t.push(i))}),this.sortAndDeDup(),this._onDidChangeBreakpoints.fire({changed:t,sessionOnly:!1})}setBreakpointSessionData(e,t,i){this.breakpoints.forEach(s=>{if(!i)s.setSessionData(e,void 0);else{const r=i.get(s.getId());r&&s.setSessionData(e,y(r,t))}}),this.functionBreakpoints.forEach(s=>{if(!i)s.setSessionData(e,void 0);else{const r=i.get(s.getId());r&&s.setSessionData(e,y(r,t))}}),this.dataBreakpoints.forEach(s=>{if(!i)s.setSessionData(e,void 0);else{const r=i.get(s.getId());r&&s.setSessionData(e,y(r,t))}}),this.exceptionBreakpoints.forEach(s=>{if(!i)s.setSessionData(e,void 0);else{const r=i.get(s.getId());r&&s.setSessionData(e,y(r,t))}}),this.instructionBreakpoints.forEach(s=>{if(!i)s.setSessionData(e,void 0);else{const r=i.get(s.getId());r&&s.setSessionData(e,y(r,t))}}),this._onDidChangeBreakpoints.fire({sessionOnly:!0})}getDebugProtocolBreakpoint(e,t){const i=this.breakpoints.find(s=>s.getId()===e);if(i)return i.getDebugProtocolBreakpoint(t)}getBreakpointModes(e){return[...this._breakpointModes.values()].filter(t=>t.appliesTo.includes(e))}registerBreakpointModes(e,t){for(const i of t){const s=`${i.mode}/${i.label}`,r=this._breakpointModes.get(s);if(r)for(const a of i.appliesTo)r.appliesTo.includes(a)||r.appliesTo.push(a);else{const a=[...this._breakpointModes.values()].find(d=>d!==r&&d.label===i.label);a&&(a.label=`${a.label} (${a.firstFromDebugType})`),this._breakpointModes.set(s,{mode:i.mode,label:a?`${i.label} (${e})`:i.label,firstFromDebugType:e,description:i.description,appliesTo:i.appliesTo.slice()})}}}sortAndDeDup(){this.breakpoints=this.breakpoints.sort((e,t)=>e.uri.toString()!==t.uri.toString()?E.basenameOrAuthority(e.uri).localeCompare(E.basenameOrAuthority(t.uri)):e.lineNumber===t.lineNumber?e.column&&t.column?e.column-t.column:1:e.lineNumber-t.lineNumber),this.breakpoints=F(this.breakpoints,e=>`${e.uri.toString()}:${e.lineNumber}:${e.column}`)}setEnablement(e,t){if(e instanceof _||e instanceof w||e instanceof H||e instanceof O||e instanceof V){const i=[];e.enabled!==t&&(e instanceof _||e instanceof w||e instanceof O||e instanceof V)&&i.push(e),e.enabled=t,t&&(this.breakpointsActivated=!0),this._onDidChangeBreakpoints.fire({changed:i,sessionOnly:!1})}}enableOrDisableAllBreakpoints(e){const t=[];this.breakpoints.forEach(i=>{i.enabled!==e&&t.push(i),i.enabled=e}),this.functionBreakpoints.forEach(i=>{i.enabled!==e&&t.push(i),i.enabled=e}),this.dataBreakpoints.forEach(i=>{i.enabled!==e&&t.push(i),i.enabled=e}),this.instructionBreakpoints.forEach(i=>{i.enabled!==e&&t.push(i),i.enabled=e}),e&&(this.breakpointsActivated=!0),this._onDidChangeBreakpoints.fire({changed:t,sessionOnly:!1})}addFunctionBreakpoint(e,t){const i=new w(e,t);return this.functionBreakpoints.push(i),this._onDidChangeBreakpoints.fire({added:[i],sessionOnly:!1}),i}updateFunctionBreakpoint(e,t){const i=this.functionBreakpoints.find(s=>s.getId()===e);i&&(typeof t.name=="string"&&(i.name=t.name),typeof t.condition=="string"&&(i.condition=t.condition),typeof t.hitCondition=="string"&&(i.hitCondition=t.hitCondition),this._onDidChangeBreakpoints.fire({changed:[i],sessionOnly:!1}))}removeFunctionBreakpoints(e){let t;e?(t=this.functionBreakpoints.filter(i=>i.getId()===e),this.functionBreakpoints=this.functionBreakpoints.filter(i=>i.getId()!==e)):(t=this.functionBreakpoints,this.functionBreakpoints=[]),this._onDidChangeBreakpoints.fire({removed:t,sessionOnly:!1})}addDataBreakpoint(e,t){const i=new O(e,t);this.dataBreakpoints.push(i),this._onDidChangeBreakpoints.fire({added:[i],sessionOnly:!1})}updateDataBreakpoint(e,t){const i=this.dataBreakpoints.find(s=>s.getId()===e);i&&(typeof t.condition=="string"&&(i.condition=t.condition),typeof t.hitCondition=="string"&&(i.hitCondition=t.hitCondition),this._onDidChangeBreakpoints.fire({changed:[i],sessionOnly:!1}))}removeDataBreakpoints(e){let t;e?(t=this.dataBreakpoints.filter(i=>i.getId()===e),this.dataBreakpoints=this.dataBreakpoints.filter(i=>i.getId()!==e)):(t=this.dataBreakpoints,this.dataBreakpoints=[]),this._onDidChangeBreakpoints.fire({removed:t,sessionOnly:!1})}addInstructionBreakpoint(e){const t=new V(e);this.instructionBreakpoints.push(t),this._onDidChangeBreakpoints.fire({added:[t],sessionOnly:!0})}removeInstructionBreakpoints(e,t){let i=[];if(e)for(let s=0;s<this.instructionBreakpoints.length;s++){const r=this.instructionBreakpoints[s];r.instructionReference===e&&(t===void 0||r.offset===t)&&(i.push(r),this.instructionBreakpoints.splice(s--,1))}else i=this.instructionBreakpoints,this.instructionBreakpoints=[];this._onDidChangeBreakpoints.fire({removed:i,sessionOnly:!1})}getWatchExpressions(){return this.watchExpressions}addWatchExpression(e){const t=new g(e||"");return this.watchExpressionChangeListeners.set(t.getId(),t.onDidChangeValue(i=>this._onDidChangeWatchExpressionValue.fire(i))),this.watchExpressions.push(t),this._onDidChangeWatchExpressions.fire(t),t}renameWatchExpression(e,t){const i=this.watchExpressions.filter(s=>s.getId()===e);i.length===1&&(i[0].name=t,this._onDidChangeWatchExpressions.fire(i[0]))}removeWatchExpressions(e=null){if(this.watchExpressions=e?this.watchExpressions.filter(t=>t.getId()!==e):[],this._onDidChangeWatchExpressions.fire(void 0),!e){this.watchExpressionChangeListeners.clearAndDisposeAll();return}this.watchExpressionChangeListeners.deleteAndDispose(e)}moveWatchExpression(e,t){const i=this.watchExpressions.find(s=>s.getId()===e);i&&(this.watchExpressions=this.watchExpressions.filter(s=>s.getId()!==e),this.watchExpressions=this.watchExpressions.slice(0,t).concat(i,this.watchExpressions.slice(t)),this._onDidChangeWatchExpressions.fire(void 0))}sourceIsNotAvailable(e){this.sessions.forEach(t=>{const i=t.getSourceForUri(e);i&&(i.available=!1)}),this._onDidChangeCallStack.fire(void 0)}};x=R([S(1,he),S(2,oe),S(3,ae)],x);export{v as BaseBreakpoint,_ as Breakpoint,O as DataBreakpoint,x as DebugModel,me as Enablement,fe as ErrorScope,H as ExceptionBreakpoint,g as Expression,u as ExpressionContainer,w as FunctionBreakpoint,V as InstructionBreakpoint,wt as MemoryRegion,z as Scope,ge as StackFrame,Pt as Thread,Ot as ThreadAndSessionIds,C as Variable,Et as VisualizedExpression,_t as getUriForDebugMemory};
