import e from"assert";import{SnippetCompletionProvider as E}from"../../browser/snippetCompletionProvider.js";import{Position as o}from"../../../../../editor/common/core/position.js";import{createModelServices as S,instantiateTextModel as m}from"../../../../../editor/test/common/testTextModel.js";import"../../browser/snippets.js";import{Snippet as c,SnippetSource as g}from"../../browser/snippetsFile.js";import{CompletionTriggerKind as v}from"../../../../../editor/common/languages.js";import{DisposableStore as I}from"../../../../../base/common/lifecycle.js";import{TestLanguageConfigurationService as q}from"../../../../../editor/test/common/modes/testLanguageConfigurationService.js";import{EditOperation as T}from"../../../../../editor/common/core/editOperation.js";import"../../../../../platform/instantiation/test/common/instantiationServiceMock.js";import{ILanguageService as x}from"../../../../../editor/common/languages/language.js";import{generateUuid as p}from"../../../../../base/common/uuid.js";import{ensureNoDisposablesAreLeakedInTestSuite as U}from"../../../../../base/test/common/utils.js";import"../../../../../editor/common/model.js";import{CompletionModel as k}from"../../../../../editor/contrib/suggest/browser/completionModel.js";import{CompletionItem as K}from"../../../../../editor/contrib/suggest/browser/suggest.js";import{WordDistance as R}from"../../../../../editor/contrib/suggest/browser/wordDistance.js";import{EditorOptions as y}from"../../../../../editor/common/config/editorOptions.js";class b{constructor(l){this.snippets=l}getSnippets(){return Promise.resolve(this.getSnippetsSync())}getSnippetsSync(){return this.snippets}getSnippetFiles(){throw new Error}isEnabled(){throw new Error}updateEnablement(){throw new Error}updateUsageTimestamp(l){throw new Error}}suite("SnippetsService",function(){const w={triggerKind:v.Invoke};let l,u,f,a;setup(function(){l=new I,u=S(l),f=u.get(x),l.add(f.registerLanguage({id:"fooLang",extensions:[".fooLang"]})),a=new b([new c(!1,["fooLang"],"barTest","bar","","barCodeSnippet","",g.User,p()),new c(!1,["fooLang"],"bazzTest","bazz","","bazzCodeSnippet","",g.User,p())])}),teardown(()=>{l.dispose()}),U();async function d(s,t,n,i=w){const r=await n.provideCompletionItems(s,o.lift(t),i);return new k(r.suggestions.map(C=>new K(t,C,r,n)),t.column,{characterCountDelta:0,leadingLineContent:s.getLineContent(t.lineNumber).substring(0,t.column-1)},R.None,y.suggest.defaultValue,y.snippetSuggestions.defaultValue,void 0)}test("snippet completions - simple",async function(){const s=new E(f,a,l.add(new q)),t=l.add(m(u,"","fooLang"));await s.provideCompletionItems(t,new o(1,1),w).then(i=>{e.strictEqual(i.incomplete,void 0),e.strictEqual(i.suggestions.length,2)});const n=await d(t,new o(1,1),s);e.strictEqual(n.items.length,2)}),test("snippet completions - simple 2",async function(){const s=new E(f,a,l.add(new q)),t=l.add(m(u,"hello ","fooLang"));await s.provideCompletionItems(t,new o(1,6),w).then(r=>{e.strictEqual(r.incomplete,void 0),e.strictEqual(r.suggestions.length,0)}),await s.provideCompletionItems(t,new o(1,7),w).then(r=>{e.strictEqual(r.incomplete,void 0),e.strictEqual(r.suggestions.length,2)});const n=await d(t,new o(1,6),s);e.strictEqual(n.items.length,0);const i=await d(t,new o(1,7),s);e.strictEqual(i.items.length,2)}),test("snippet completions - with prefix",async function(){const s=new E(f,a,l.add(new q)),t=l.add(m(u,"bar","fooLang"));await s.provideCompletionItems(t,new o(1,4),w).then(i=>{e.strictEqual(i.incomplete,void 0),e.strictEqual(i.suggestions.length,1),e.deepStrictEqual(i.suggestions[0].label,{label:"bar",description:"barTest"}),e.strictEqual(i.suggestions[0].range.insert.startColumn,1),e.strictEqual(i.suggestions[0].insertText,"barCodeSnippet")});const n=await d(t,new o(1,4),s);e.strictEqual(n.items.length,1),e.deepStrictEqual(n.items[0].completion.label,{label:"bar",description:"barTest"}),e.strictEqual(n.items[0].completion.range.insert.startColumn,1),e.strictEqual(n.items[0].completion.insertText,"barCodeSnippet")}),test("snippet completions - with different prefixes",async function(){a=new b([new c(!1,["fooLang"],"barTest","bar","","s1","",g.User,p()),new c(!1,["fooLang"],"name","bar-bar","","s2","",g.User,p())]);const s=new E(f,a,l.add(new q)),t=l.add(m(u,"bar-bar","fooLang"));{await s.provideCompletionItems(t,new o(1,3),w).then(i=>{e.strictEqual(i.incomplete,void 0),e.strictEqual(i.suggestions.length,2),e.deepStrictEqual(i.suggestions[0].label,{label:"bar",description:"barTest"}),e.strictEqual(i.suggestions[0].insertText,"s1"),e.strictEqual(i.suggestions[0].range.insert.startColumn,1),e.deepStrictEqual(i.suggestions[1].label,{label:"bar-bar",description:"name"}),e.strictEqual(i.suggestions[1].insertText,"s2"),e.strictEqual(i.suggestions[1].range.insert.startColumn,1)});const n=await d(t,new o(1,3),s);e.strictEqual(n.items.length,2),e.deepStrictEqual(n.items[0].completion.label,{label:"bar",description:"barTest"}),e.strictEqual(n.items[0].completion.insertText,"s1"),e.strictEqual(n.items[0].completion.range.insert.startColumn,1),e.deepStrictEqual(n.items[1].completion.label,{label:"bar-bar",description:"name"}),e.strictEqual(n.items[1].completion.insertText,"s2"),e.strictEqual(n.items[1].completion.range.insert.startColumn,1)}{await s.provideCompletionItems(t,new o(1,5),w).then(h=>{e.strictEqual(h.incomplete,void 0),e.strictEqual(h.suggestions.length,2);const[C,L]=h.suggestions;e.deepStrictEqual(C.label,{label:"bar",description:"barTest"}),e.strictEqual(C.insertText,"s1"),e.strictEqual(C.range.insert.startColumn,5),e.deepStrictEqual(L.label,{label:"bar-bar",description:"name"}),e.strictEqual(L.insertText,"s2"),e.strictEqual(L.range.insert.startColumn,1)});const n=await d(t,new o(1,5),s);e.strictEqual(n.items.length,2);const[i,r]=n.items.map(h=>h.completion);e.deepStrictEqual(i.label,{label:"bar-bar",description:"name"}),e.strictEqual(i.insertText,"s2"),e.strictEqual(i.range.insert.startColumn,1),e.deepStrictEqual(r.label,{label:"bar",description:"barTest"}),e.strictEqual(r.insertText,"s1"),e.strictEqual(r.range.insert.startColumn,5)}{await s.provideCompletionItems(t,new o(1,6),w).then(i=>{e.strictEqual(i.incomplete,void 0),e.strictEqual(i.suggestions.length,2),e.deepStrictEqual(i.suggestions[0].label,{label:"bar",description:"barTest"}),e.strictEqual(i.suggestions[0].insertText,"s1"),e.strictEqual(i.suggestions[0].range.insert.startColumn,5),e.deepStrictEqual(i.suggestions[1].label,{label:"bar-bar",description:"name"}),e.strictEqual(i.suggestions[1].insertText,"s2"),e.strictEqual(i.suggestions[1].range.insert.startColumn,1)});const n=await d(t,new o(1,6),s);e.strictEqual(n.items.length,2),e.deepStrictEqual(n.items[0].completion.label,{label:"bar-bar",description:"name"}),e.strictEqual(n.items[0].completion.insertText,"s2"),e.strictEqual(n.items[0].completion.range.insert.startColumn,1),e.deepStrictEqual(n.items[1].completion.label,{label:"bar",description:"barTest"}),e.strictEqual(n.items[1].completion.insertText,"s1"),e.strictEqual(n.items[1].completion.range.insert.startColumn,5)}}),test('Cannot use "<?php" as user snippet prefix anymore, #26275',async function(){a=new b([new c(!1,["fooLang"],"","<?php","","insert me","",g.User,p())]);const s=new E(f,a,l.add(new q));let t=m(u,"	<?php","fooLang");await s.provideCompletionItems(t,new o(1,7),w).then(h=>{e.strictEqual(h.suggestions.length,1)});const n=await d(t,new o(1,7),s);e.strictEqual(n.items.length,1),t.dispose(),t=m(u,"	<?","fooLang"),await s.provideCompletionItems(t,new o(1,4),w).then(h=>{e.strictEqual(h.suggestions.length,1),e.strictEqual(h.suggestions[0].range.insert.startColumn,2)});const i=await d(t,new o(1,4),s);e.strictEqual(i.items.length,1),e.strictEqual(i.items[0].completion.range.insert.startColumn,2),t.dispose(),t=m(u,"a<?","fooLang"),await s.provideCompletionItems(t,new o(1,4),w).then(h=>{e.strictEqual(h.suggestions.length,1),e.strictEqual(h.suggestions[0].range.insert.startColumn,2)});const r=await d(t,new o(1,4),s);e.strictEqual(r.items.length,1),e.strictEqual(r.items[0].completion.range.insert.startColumn,2),t.dispose()}),test("No user snippets in suggestions, when inside the code, #30508",async function(){a=new b([new c(!1,["fooLang"],"","foo","","<foo>$0</foo>","",g.User,p())]);const s=new E(f,a,l.add(new q)),t=l.add(m(u,`<head>
	
>/head>`,"fooLang"));await s.provideCompletionItems(t,new o(1,1),w).then(r=>{e.strictEqual(r.suggestions.length,1)});const n=await d(t,new o(1,1),s);e.strictEqual(n.items.length,1),await s.provideCompletionItems(t,new o(2,2),w).then(r=>{e.strictEqual(r.suggestions.length,1)});const i=await d(t,new o(2,2),s);e.strictEqual(i.items.length,1)}),test("SnippetSuggest - ensure extension snippets come last ",async function(){a=new b([new c(!1,["fooLang"],"second","second","","second","",g.Extension,p()),new c(!1,["fooLang"],"first","first","","first","",g.User,p())]);const s=new E(f,a,l.add(new q)),t=l.add(m(u,"","fooLang"));await s.provideCompletionItems(t,new o(1,1),w).then(h=>{e.strictEqual(h.suggestions.length,2);const[C,L]=h.suggestions;e.deepStrictEqual(C.label,{label:"first",description:"first"}),e.deepStrictEqual(L.label,{label:"second",description:"second"})});const n=await d(t,new o(1,1),s);e.strictEqual(n.items.length,2);const[i,r]=n.items;e.deepStrictEqual(i.completion.label,{label:"first",description:"first"}),e.deepStrictEqual(r.completion.label,{label:"second",description:"second"})}),test("Dash in snippets prefix broken #53945",async function(){a=new b([new c(!1,["fooLang"],"p-a","p-a","","second","",g.User,p())]);const s=new E(f,a,l.add(new q)),t=l.add(m(u,"p-","fooLang"));let n=await s.provideCompletionItems(t,new o(1,2),w),i=await d(t,new o(1,2),s);e.strictEqual(n.suggestions.length,1),e.strictEqual(i.items.length,1),n=await s.provideCompletionItems(t,new o(1,3),w),i=await d(t,new o(1,3),s),e.strictEqual(n.suggestions.length,1),e.strictEqual(i.items.length,1),n=await s.provideCompletionItems(t,new o(1,3),w),i=await d(t,new o(1,3),s),e.strictEqual(n.suggestions.length,1),e.strictEqual(i.items.length,1)}),test("No snippets suggestion on long lines beyond character 100 #58807",async function(){a=new b([new c(!1,["fooLang"],"bug","bug","","second","",g.User,p())]);const s=new E(f,a,l.add(new q)),t=l.add(m(u,"Thisisaverylonglinegoingwithmore100bcharactersandthismakesintellisensebecomea Thisisaverylonglinegoingwithmore100bcharactersandthismakesintellisensebecomea b","fooLang")),n=await s.provideCompletionItems(t,new o(1,158),w),i=await d(t,new o(1,158),s);e.strictEqual(n.suggestions.length,1),e.strictEqual(i.items.length,1)}),test("Type colon will trigger snippet #60746",async function(){a=new b([new c(!1,["fooLang"],"bug","bug","","second","",g.User,p())]);const s=new E(f,a,l.add(new q)),t=l.add(m(u,":","fooLang")),n=await s.provideCompletionItems(t,new o(1,2),w);e.strictEqual(n.suggestions.length,0);const i=await d(t,new o(1,2),s);e.strictEqual(i.items.length,0)}),test("substring of prefix can't trigger snippet #60737",async function(){a=new b([new c(!1,["fooLang"],"mytemplate","mytemplate","","second","",g.User,p())]);const s=new E(f,a,l.add(new q)),t=l.add(m(u,"template","fooLang")),n=await s.provideCompletionItems(t,new o(1,9),w);e.strictEqual(n.suggestions.length,1),e.deepStrictEqual(n.suggestions[0].label,{label:"mytemplate",description:"mytemplate"});const i=await d(t,new o(1,9),s);e.strictEqual(i.items.length,0)}),test("No snippets suggestion beyond character 100 if not at end of line #60247",async function(){a=new b([new c(!1,["fooLang"],"bug","bug","","second","",g.User,p())]);const s=new E(f,a,l.add(new q)),t=l.add(m(u,"Thisisaverylonglinegoingwithmore100bcharactersandthismakesintellisensebecomea Thisisaverylonglinegoingwithmore100bcharactersandthismakesintellisensebecomea b text_after_b","fooLang")),n=await s.provideCompletionItems(t,new o(1,158),w);e.strictEqual(n.suggestions.length,1);const i=await d(t,new o(1,158),s);e.strictEqual(i.items.length,1)}),test("issue #61296: VS code freezes when editing CSS fi`le with emoji",async function(){const s=l.add(new q);l.add(s.register("fooLang",{wordPattern:/(#?-?\d*\.\d\w*%?)|(::?[\w-]*(?=[^,{;]*[,{]))|(([@#.!])?[\w\-?]+%?|[@#!.])/g})),a=new b([new c(!1,["fooLang"],"bug","-a-bug","","second","",g.User,p())]);const t=new E(f,a,s),n=l.add(m(u,".\u{1F437}-a-b","fooLang")),i=await t.provideCompletionItems(n,new o(1,8),w);e.strictEqual(i.suggestions.length,1);const r=await d(n,new o(1,8),t);e.strictEqual(r.items.length,1)}),test("No snippets shown when triggering completions at whitespace on line that already has text #62335",async function(){a=new b([new c(!1,["fooLang"],"bug","bug","","second","",g.User,p())]);const s=new E(f,a,l.add(new q)),t=l.add(m(u,"a ","fooLang")),n=await s.provideCompletionItems(t,new o(1,3),w);e.strictEqual(n.suggestions.length,1);const i=await d(t,new o(1,3),s);e.strictEqual(i.items.length,1)}),test("Snippet prefix with special chars and numbers does not work #62906",async function(){a=new b([new c(!1,["fooLang"],"noblockwdelay","<<","",'<= #dly"',"",g.User,p()),new c(!1,["fooLang"],"noblockwdelay","11","","eleven","",g.User,p())]);const s=new E(f,a,l.add(new q));let t=m(u," <","fooLang"),n=await s.provideCompletionItems(t,new o(1,3),w);e.strictEqual(n.suggestions.length,1);let[i]=n.suggestions;e.strictEqual(i.range.insert.startColumn,2);let r=await d(t,new o(1,3),s);e.strictEqual(r.items.length,1),e.strictEqual(r.items[0].editStart.column,2),t.dispose(),t=m(u,"1","fooLang"),n=await s.provideCompletionItems(t,new o(1,2),w),r=await d(t,new o(1,2),s),e.strictEqual(n.suggestions.length,1),[i]=n.suggestions,e.strictEqual(i.range.insert.startColumn,1),e.strictEqual(r.items.length,1),e.strictEqual(r.items[0].editStart.column,1),t.dispose()}),test("Snippet replace range",async function(){a=new b([new c(!1,["fooLang"],"notWordTest","not word","","not word snippet","",g.User,p())]);const s=new E(f,a,l.add(new q));let t=m(u,"not wordFoo bar","fooLang"),n=await s.provideCompletionItems(t,new o(1,3),w);e.strictEqual(n.suggestions.length,1);let[i]=n.suggestions;e.strictEqual(i.range.insert.endColumn,3),e.strictEqual(i.range.replace.endColumn,9);let r=await d(t,new o(1,3),s);e.strictEqual(r.items.length,1),e.strictEqual(r.items[0].editInsertEnd.column,3),e.strictEqual(r.items[0].editReplaceEnd.column,9),t.dispose(),t=m(u,"not woFoo bar","fooLang"),n=await s.provideCompletionItems(t,new o(1,3),w),e.strictEqual(n.suggestions.length,1),[i]=n.suggestions,e.strictEqual(i.range.insert.endColumn,3),e.strictEqual(i.range.replace.endColumn,3),r=await d(t,new o(1,3),s),e.strictEqual(r.items.length,1),e.strictEqual(r.items[0].editInsertEnd.column,3),e.strictEqual(r.items[0].editReplaceEnd.column,3),t.dispose(),t=m(u,"not word","fooLang"),n=await s.provideCompletionItems(t,new o(1,1),w),e.strictEqual(n.suggestions.length,1),[i]=n.suggestions,e.strictEqual(i.range.insert.endColumn,1),e.strictEqual(i.range.replace.endColumn,9),r=await d(t,new o(1,1),s),e.strictEqual(r.items.length,1),e.strictEqual(r.items[0].editInsertEnd.column,1),e.strictEqual(r.items[0].editReplaceEnd.column,9),t.dispose()}),test("Snippet replace-range incorrect #108894",async function(){a=new b([new c(!1,["fooLang"],"eng","eng","","<span></span>","",g.User,p())]);const s=new E(f,a,l.add(new q)),t=m(u,"filler e KEEP ng filler","fooLang"),n=await s.provideCompletionItems(t,new o(1,9),w),i=await d(t,new o(1,9),s);e.strictEqual(n.suggestions.length,1);const[r]=n.suggestions;e.strictEqual(r.range.insert.endColumn,9),e.strictEqual(r.range.replace.endColumn,9),e.strictEqual(i.items.length,1),e.strictEqual(i.items[0].editInsertEnd.column,9),e.strictEqual(i.items[0].editReplaceEnd.column,9),t.dispose()}),test("Snippet will replace auto-closing pair if specified in prefix",async function(){const s=l.add(new q);l.add(s.register("fooLang",{brackets:[["{","}"],["[","]"],["(",")"]]})),a=new b([new c(!1,["fooLang"],"PSCustomObject","[PSCustomObject]","","[PSCustomObject] @{ Key = Value }","",g.User,p())]);const t=new E(f,a,s),n=m(u,"[psc]","fooLang"),i=await t.provideCompletionItems(n,new o(1,5),w),r=await d(n,new o(1,5),t);e.strictEqual(i.suggestions.length,1);const[h]=i.suggestions;e.strictEqual(h.range.insert.endColumn,5),e.strictEqual(h.range.replace.endColumn,6),e.strictEqual(r.items.length,1),e.strictEqual(r.items[0].editInsertEnd.column,5),e.strictEqual(r.items[0].editReplaceEnd.column,6),n.dispose()}),test("Leading whitespace in snippet prefix #123860",async function(){a=new b([new c(!1,["fooLang"],"cite-name"," cite","","~\\cite{$CLIPBOARD}","",g.User,p())]);const s=new E(f,a,l.add(new q)),t=m(u," ci","fooLang"),n=await s.provideCompletionItems(t,new o(1,4),w),i=await d(t,new o(1,4),s);e.strictEqual(n.suggestions.length,1);const[r]=n.suggestions;e.strictEqual(r.label.label," cite"),e.strictEqual(r.range.insert.startColumn,1),e.strictEqual(i.items.length,1),e.strictEqual(i.items[0].textLabel," cite"),e.strictEqual(i.items[0].editStart.column,1),t.dispose()}),test("still show suggestions in string when disable string suggestion #136611",async function(){a=new b([new c(!1,["fooLang"],"aaa","aaa","","value","",g.User,p()),new c(!1,["fooLang"],"bbb","bbb","","value","",g.User,p())]);const s=new E(f,a,l.add(new q)),t=m(u,"''","fooLang"),n=await s.provideCompletionItems(t,new o(1,2),{triggerKind:v.TriggerCharacter,triggerCharacter:"'"});e.strictEqual(n.suggestions.length,0),t.dispose()}),test("still show suggestions in string when disable string suggestion #136611 (part 2)",async function(){a=new b([new c(!1,["fooLang"],"aaa","aaa","","value","",g.User,p()),new c(!1,["fooLang"],"bbb","bbb","","value","",g.User,p()),new c(!1,["fooLang"],"'ccc","'ccc","","value","",g.User,p())]);const s=new E(f,a,l.add(new q)),t=m(u,"''","fooLang"),n=await s.provideCompletionItems(t,new o(1,2),{triggerKind:v.TriggerCharacter,triggerCharacter:"'"});e.strictEqual(n.suggestions.length,1);const i=await d(t,new o(1,2),s,{triggerKind:v.TriggerCharacter,triggerCharacter:"'"});e.strictEqual(i.items.length,1),t.dispose()}),test("Snippet suggestions are too eager #138707 (word)",async function(){a=new b([new c(!1,["fooLang"],"tys","tys","","value","",g.User,p()),new c(!1,["fooLang"],"hell_or_tell","hell_or_tell","","value","",g.User,p()),new c(!1,["fooLang"],"^y","^y","","value","",g.User,p())]);const s=new E(f,a,l.add(new q)),t=m(u,"'hellot'","fooLang"),n=await s.provideCompletionItems(t,new o(1,8),{triggerKind:v.Invoke});e.strictEqual(n.suggestions.length,1),e.strictEqual(n.suggestions[0].label.label,"hell_or_tell");const i=await d(t,new o(1,8),s,{triggerKind:v.Invoke});e.strictEqual(i.items.length,1),e.strictEqual(i.items[0].textLabel,"hell_or_tell"),t.dispose()}),test("Snippet suggestions are too eager #138707 (no word)",async function(){a=new b([new c(!1,["fooLang"],"tys","tys","","value","",g.User,p()),new c(!1,["fooLang"],"t","t","","value","",g.User,p()),new c(!1,["fooLang"],"^y","^y","","value","",g.User,p())]);const s=new E(f,a,l.add(new q)),t=m(u,")*&^","fooLang"),n=await s.provideCompletionItems(t,new o(1,5),{triggerKind:v.Invoke});e.strictEqual(n.suggestions.length,1),e.strictEqual(n.suggestions[0].label.label,"^y");const i=await d(t,new o(1,5),s,{triggerKind:v.Invoke});e.strictEqual(i.items.length,1),e.strictEqual(i.items[0].textLabel,"^y"),t.dispose()}),test("Snippet suggestions are too eager #138707 (word/word)",async function(){a=new b([new c(!1,["fooLang"],"async arrow function","async arrow function","","value","",g.User,p()),new c(!1,["fooLang"],"foobarrrrrr","foobarrrrrr","","value","",g.User,p())]);const s=new E(f,a,l.add(new q)),t=m(u,"foobar","fooLang"),n=await s.provideCompletionItems(t,new o(1,7),{triggerKind:v.Invoke});e.strictEqual(n.suggestions.length,1),e.strictEqual(n.suggestions[0].label.label,"foobarrrrrr");const i=await d(t,new o(1,7),s,{triggerKind:v.Invoke});e.strictEqual(i.items.length,1),e.strictEqual(i.items[0].textLabel,"foobarrrrrr"),t.dispose()}),test("Strange and useless autosuggestion #region/#endregion PHP #140039",async function(){a=new b([new c(!1,["fooLang"],"reg","#region","","value","",g.User,p())]);const s=new E(f,a,l.add(new q)),t=m(u,"function abc(w)","fooLang"),n=await s.provideCompletionItems(t,new o(1,15),{triggerKind:v.Invoke});e.strictEqual(n.suggestions.length,0),t.dispose()}),test.skip("Snippets disappear with . key #145960",async function(){a=new b([new c(!1,["fooLang"],"div","div","","div","",g.User,p()),new c(!1,["fooLang"],"div.","div.","","div.","",g.User,p()),new c(!1,["fooLang"],"div#","div#","","div#","",g.User,p())]);const s=new E(f,a,l.add(new q)),t=m(u,"di","fooLang"),n=await s.provideCompletionItems(t,new o(1,3),{triggerKind:v.Invoke});e.strictEqual(n.suggestions.length,3),t.applyEdits([T.insert(new o(1,3),".")]),e.strictEqual(t.getValue(),"di.");const i=await s.provideCompletionItems(t,new o(1,4),{triggerKind:v.TriggerCharacter,triggerCharacter:"."});e.strictEqual(i.suggestions.length,1),e.strictEqual(i.suggestions[0].insertText,"div."),t.dispose()}),test("Hyphen in snippet prefix de-indents snippet #139016",async function(){a=new b([new c(!1,["fooLang"],"foo","Foo- Bar","","Foo","",g.User,p())]);const s=l.add(m(u,"    bar","fooLang")),t=new E(f,a,l.add(new q)),n=await t.provideCompletionItems(s,new o(1,8),{triggerKind:v.Invoke});e.strictEqual(n.suggestions.length,1);const i=n.suggestions[0];e.strictEqual(i.range.insert.startColumn,5);const r=await d(s,new o(1,8),t);e.strictEqual(r.items.length,1),e.strictEqual(r.items[0].editStart.column,5)}),test("Autocomplete suggests based on the last letter of a word and it depends on the typing speed #191070",async function(){a=new b([new c(!1,["fooLang"],"/whiletrue","/whiletrue","","one","",g.User,p()),new c(!1,["fooLang"],"/sc not expanding","/sc not expanding","","two","",g.User,p())]);const s=new E(f,a,l.add(new q)),t=l.add(m(u,"","fooLang"));{t.setValue("w");const n=await s.provideCompletionItems(t,new o(1,2),{triggerKind:v.Invoke});e.strictEqual(n.suggestions[0].insertText,"one"),e.strictEqual(n.suggestions.length,1)}{t.setValue("where");const n=await s.provideCompletionItems(t,new o(1,6),{triggerKind:v.Invoke});e.strictEqual(n.suggestions[0].insertText,"one"),e.strictEqual(n.suggestions.length,1)}})});
