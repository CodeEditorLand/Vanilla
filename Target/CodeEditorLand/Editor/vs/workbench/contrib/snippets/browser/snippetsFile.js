import{WindowIdleValue as m,getActiveWindow as u}from"../../../../base/browser/dom.js";import{tail as S}from"../../../../base/common/arrays.js";import{Iterable as g}from"../../../../base/common/iterator.js";import{getNodeType as b,parse as y}from"../../../../base/common/json.js";import{basename as h,extname as x}from"../../../../base/common/path.js";import{relativePath as _}from"../../../../base/common/resources.js";import{isObject as v}from"../../../../base/common/types.js";import{Placeholder as f,SnippetParser as I,Text as w,Variable as T}from"../../../../editor/contrib/snippet/browser/snippetParser.js";import{KnownSnippetVariableNames as E}from"../../../../editor/contrib/snippet/browser/snippetVariables.js";import{localize as c}from"../../../../nls.js";class P{codeSnippet;isBogous;isTrivial;usesClipboardVariable;usesSelectionVariable;constructor(s){this.isBogous=!1,this.isTrivial=!1,this.usesClipboardVariable=!1,this.usesSelectionVariable=!1,this.codeSnippet=s;const i=new I().parse(s,!1),t=new Map;let o=0;for(const e of i.placeholders)o=Math.max(o,e.index);if(i.placeholders.length===0)this.isTrivial=!0;else if(o===0){const e=S(i.children);this.isTrivial=e instanceof f&&e.isFinalTabstop}const n=[...i.children];for(;n.length>0;){const e=n.shift();if(e instanceof T){if(e.children.length===0&&!E[e.name]){const r=t.has(e.name)?t.get(e.name):++o;t.set(e.name,r);const a=new f(r).appendChild(new w(e.name));i.replace(e,[a]),this.isBogous=!0}switch(e.name){case"CLIPBOARD":this.usesClipboardVariable=!0;break;case"SELECTION":case"TM_SELECTED_TEXT":this.usesSelectionVariable=!0;break}}else n.push(...e.children)}this.isBogous&&(this.codeSnippet=i.toTextmateString())}}class L{constructor(s,i,t,o,n,e,r,a,l,d){this.isFileTemplate=s;this.scopes=i;this.name=t;this.prefix=o;this.description=n;this.body=e;this.source=r;this.snippetSource=a;this.snippetIdentifier=l;this.extensionId=d;this.prefixLow=o.toLowerCase(),this._bodyInsights=new m(u(),()=>new P(this.body))}_bodyInsights;prefixLow;get codeSnippet(){return this._bodyInsights.value.codeSnippet}get isBogous(){return this._bodyInsights.value.isBogous}get isTrivial(){return this._bodyInsights.value.isTrivial}get needsClipboard(){return this._bodyInsights.value.usesClipboardVariable}get usesSelection(){return this._bodyInsights.value.usesSelectionVariable}}function j(p){return v(p)&&!!p.body}var B=(t=>(t[t.User=1]="User",t[t.Workspace=2]="Workspace",t[t.Extension=3]="Extension",t))(B||{});class A{constructor(s,i,t,o,n,e){this.source=s;this.location=i;this.defaultScopes=t;this._extension=o;this._fileService=n;this._extensionResourceLoaderService=e;this.isGlobalSnippets=x(i.path)===".code-snippets",this.isUserSnippets=!this._extension}data=[];isGlobalSnippets;isUserSnippets;_loadPromise;select(s,i){this.isGlobalSnippets||!this.isUserSnippets?this._scopeSelect(s,i):this._filepathSelect(s,i)}_filepathSelect(s,i){s+".json"===h(this.location.path)&&i.push(...this.data)}_scopeSelect(s,i){for(const o of this.data){const n=o.scopes.length;if(n===0)i.push(o);else for(let e=0;e<n;e++)if(o.scopes[e]===s){i.push(o);break}}const t=s.lastIndexOf(".");t>=0&&this._scopeSelect(s.substring(0,t),i)}async _load(){return this._extension?this._extensionResourceLoaderService.readExtensionResource(this.location):(await this._fileService.readFile(this.location)).value.toString()}load(){return this._loadPromise||(this._loadPromise=Promise.resolve(this._load()).then(s=>{const i=y(s);if(b(i)==="object")for(const[t,o]of Object.entries(i))if(j(o))this._parseSnippet(t,o,this.data);else for(const[n,e]of Object.entries(o))this._parseSnippet(n,e,this.data);return this})),this._loadPromise}reset(){this._loadPromise=void 0,this.data.length=0}_parseSnippet(s,i,t){let{isFileTemplate:o,prefix:n,body:e,description:r}=i;if(n||(n=""),Array.isArray(e)&&(e=e.join(`
`)),typeof e!="string")return;Array.isArray(r)&&(r=r.join(`
`));let a;this.defaultScopes?a=this.defaultScopes:typeof i.scope=="string"?a=i.scope.split(",").map(d=>d.trim()).filter(Boolean):a=[];let l;this._extension?l=this._extension.displayName||this._extension.name:this.source===2?l=c("source.workspaceSnippetGlobal","Workspace Snippet"):this.isGlobalSnippets?l=c("source.userSnippetGlobal","Global User Snippet"):l=c("source.userSnippet","User Snippet");for(const d of g.wrap(n))t.push(new L(!!o,a,s,d,r,e,l,this.source,this._extension?`${_(this._extension.extensionLocation,this.location)}/${s}`:`${h(this.location.path)}/${s}`,this._extension?.identifier))}}export{L as Snippet,A as SnippetFile,B as SnippetSource};
