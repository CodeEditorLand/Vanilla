import"./simpleFindWidget.css";import*as s from"../../../../../nls.js";import*as a from"../../../../../base/browser/dom.js";import{Widget as b}from"../../../../../base/browser/ui/widget.js";import{Delayer as C}from"../../../../../base/common/async.js";import{KeyCode as v}from"../../../../../base/common/keyCodes.js";import{FindReplaceState as N}from"../../../../../editor/contrib/find/browser/findState.js";import{SimpleButton as _,findPreviousMatchIcon as y,findNextMatchIcon as S,NLS_NO_RESULTS as f,NLS_MATCHES_LOCATION as F}from"../../../../../editor/contrib/find/browser/findWidget.js";import{ContextScopedFindInput as T}from"../../../../../platform/history/browser/contextScopedHistoryWidget.js";import{widgetClose as L}from"../../../../../platform/theme/common/iconRegistry.js";import{registerThemingParticipant as D}from"../../../../../platform/theme/common/themeService.js";import*as B from"../../../../../base/common/strings.js";import{showHistoryKeybindingHint as x}from"../../../../../platform/history/browser/historyWidgetKeybindingHint.js";import{status as w}from"../../../../../base/browser/ui/aria/aria.js";import{defaultInputBoxStyles as R,defaultToggleStyles as W}from"../../../../../platform/theme/browser/defaultStyles.js";import{Orientation as A,Sash as M}from"../../../../../base/browser/ui/sash/sash.js";import{registerColor as k}from"../../../../../platform/theme/common/colorRegistry.js";const E=s.localize("label.find","Find"),V=s.localize("placeholder.find","Find"),H=s.localize("label.previousMatchButton","Previous Match"),P=s.localize("label.nextMatchButton","Next Match"),K=s.localize("label.closeButton","Close"),u=310,z=73;class ft extends b{constructor(t,e,n,o,d){super();this._keybindingService=d;this._matchesLimit=t.matchesLimit??Number.MAX_SAFE_INTEGER,this._findInput=this._register(new T(null,e,{label:E,placeholder:V,validation:i=>{if(i.length===0||!this._findInput.getRegex())return null;try{return new RegExp(i),null}catch(h){return this._foundMatch=!1,this.updateButtons(this._foundMatch),{content:h.message}}},showCommonFindToggles:t.showCommonFindToggles,appendCaseSensitiveLabel:t.appendCaseSensitiveActionId?this._getKeybinding(t.appendCaseSensitiveActionId):void 0,appendRegexLabel:t.appendRegexActionId?this._getKeybinding(t.appendRegexActionId):void 0,appendWholeWordsLabel:t.appendWholeWordsActionId?this._getKeybinding(t.appendWholeWordsActionId):void 0,showHistoryHint:()=>x(d),inputBoxStyles:R,toggleStyles:W},n)),this._updateHistoryDelayer=this._register(new C(500)),this._register(this._findInput.onInput(async i=>{(!t.checkImeCompletionState||!this._findInput.isImeSessionInProgress)&&(this._foundMatch=this._onInputChanged(),t.showResultCount&&await this.updateResultCount(),this.updateButtons(this._foundMatch),this.focusFindBox(),this._delayedUpdateHistory())})),this._findInput.setRegex(!!this.state.isRegex),this._findInput.setCaseSensitive(!!this.state.matchCase),this._findInput.setWholeWords(!!this.state.wholeWord),this._register(this._findInput.onDidOptionChange(()=>{this.state.change({isRegex:this._findInput.getRegex(),wholeWord:this._findInput.getWholeWords(),matchCase:this._findInput.getCaseSensitive()},!0)})),this._register(this.state.onFindReplaceStateChange(()=>{this._findInput.setRegex(this.state.isRegex),this._findInput.setWholeWords(this.state.wholeWord),this._findInput.setCaseSensitive(this.state.matchCase),this.findFirst()})),this.prevBtn=this._register(new _({label:H+(t.previousMatchActionId?this._getKeybinding(t.previousMatchActionId):""),icon:y,onTrigger:()=>{this.find(!0)}},o)),this.nextBtn=this._register(new _({label:P+(t.nextMatchActionId?this._getKeybinding(t.nextMatchActionId):""),icon:S,onTrigger:()=>{this.find(!1)}},o));const I=this._register(new _({label:K+(t.closeWidgetActionId?this._getKeybinding(t.closeWidgetActionId):""),icon:L,onTrigger:()=>{this.hide()}},o));this._innerDomNode=document.createElement("div"),this._innerDomNode.classList.add("simple-find-part"),this._innerDomNode.appendChild(this._findInput.domNode),this._innerDomNode.appendChild(this.prevBtn.domNode),this._innerDomNode.appendChild(this.nextBtn.domNode),this._innerDomNode.appendChild(I.domNode),this._domNode=document.createElement("div"),this._domNode.classList.add("simple-find-part-wrapper"),this._domNode.appendChild(this._innerDomNode),this.onkeyup(this._innerDomNode,i=>{if(i.equals(v.Escape)){this.hide(),i.preventDefault();return}}),this._focusTracker=this._register(a.trackFocus(this._innerDomNode)),this._register(this._focusTracker.onDidFocus(this._onFocusTrackerFocus.bind(this))),this._register(this._focusTracker.onDidBlur(this._onFocusTrackerBlur.bind(this))),this._findInputFocusTracker=this._register(a.trackFocus(this._findInput.domNode)),this._register(this._findInputFocusTracker.onDidFocus(this._onFindInputFocusTrackerFocus.bind(this))),this._register(this._findInputFocusTracker.onDidBlur(this._onFindInputFocusTrackerBlur.bind(this))),this._register(a.addDisposableListener(this._innerDomNode,"click",i=>{i.stopPropagation()})),t?.showResultCount&&(this._domNode.classList.add("result-count"),this._matchesCount=document.createElement("div"),this._matchesCount.className="matchesCount",this._findInput.domNode.insertAdjacentElement("afterend",this._matchesCount),this._register(this._findInput.onDidChange(async()=>{await this.updateResultCount()})),this._register(this._findInput.onDidOptionChange(async()=>{this._foundMatch=this._onInputChanged(),await this.updateResultCount(),this.focusFindBox(),this._delayedUpdateHistory()})));let r=t?.initialWidth;if(r&&(r=r<u?u:r,this._domNode.style.width=`${r}px`),t?.enableSash){const i=r??u;let h=i;const l=this._register(new M(this._innerDomNode,this,{orientation:A.VERTICAL,size:1}));this._register(l.onDidStart(()=>{h=parseFloat(a.getComputedStyle(this._domNode).width)})),this._register(l.onDidChange(c=>{const p=h+c.startX-c.currentX;p<i||(this._domNode.style.width=`${p}px`)})),this._register(l.onDidReset(c=>{parseFloat(a.getComputedStyle(this._domNode).width)===i?this._domNode.style.width="100%":this._domNode.style.width=`${i}px`}))}}_findInput;_domNode;_innerDomNode;_focusTracker;_findInputFocusTracker;_updateHistoryDelayer;prevBtn;nextBtn;_matchesLimit;_matchesCount;_isVisible=!1;_foundMatch=!1;_width=0;state=new N;getVerticalSashLeft(t){return 0}get inputValue(){return this._findInput.getValue()}get focusTracker(){return this._focusTracker}_getKeybinding(t){const e=this._keybindingService?.lookupKeybinding(t);return e?` (${e.getLabel()})`:""}dispose(){super.dispose(),this._domNode?.remove()}isVisible(){return this._isVisible}getDomNode(){return this._domNode}getFindInputDomNode(){return this._findInput.domNode}reveal(t,e=!0){if(t&&this._findInput.setValue(t),this._isVisible){this._findInput.select();return}this._isVisible=!0,this.updateResultCount(),this.layout(),setTimeout(()=>{this._innerDomNode.classList.toggle("suppress-transition",!e),this._innerDomNode.classList.add("visible","visible-transition"),this._innerDomNode.setAttribute("aria-hidden","false"),this._findInput.select(),e||setTimeout(()=>{this._innerDomNode.classList.remove("suppress-transition")},0)},0)}show(t){t&&!this._isVisible&&this._findInput.setValue(t),this._isVisible=!0,this.layout(),setTimeout(()=>{this._innerDomNode.classList.add("visible","visible-transition"),this._innerDomNode.setAttribute("aria-hidden","false")},0)}hide(t=!0){this._isVisible&&(this._innerDomNode.classList.toggle("suppress-transition",!t),this._innerDomNode.classList.remove("visible-transition"),this._innerDomNode.setAttribute("aria-hidden","true"),setTimeout(()=>{this._isVisible=!1,this.updateButtons(this._foundMatch),this._innerDomNode.classList.remove("visible","suppress-transition")},t?200:0))}layout(t=this._width){if(this._width=t,!!this._isVisible&&this._matchesCount){let e=!1;u+z+28>=t&&(e=!0),this._innerDomNode.classList.toggle("reduced-find-widget",e)}}_delayedUpdateHistory(){this._updateHistoryDelayer.trigger(this._updateHistory.bind(this))}_updateHistory(){this._findInput.inputBox.addToHistory()}_getRegexValue(){return this._findInput.getRegex()}_getWholeWordValue(){return this._findInput.getWholeWords()}_getCaseSensitiveValue(){return this._findInput.getCaseSensitive()}updateButtons(t){const e=this.inputValue.length>0;this.prevBtn.setEnabled(this._isVisible&&e&&t),this.nextBtn.setEnabled(this._isVisible&&e&&t)}focusFindBox(){this.nextBtn.focus(),this._findInput.inputBox.focus()}async updateResultCount(){if(!this._matchesCount){this.updateButtons(this._foundMatch);return}const t=await this._getResultCount();this._matchesCount.innerText="";const e=this.inputValue.length>0&&t?.resultCount===0;this._matchesCount.classList.toggle("no-results",e);let n="";if(t?.resultCount){let o=String(t.resultCount);t.resultCount>=this._matchesLimit&&(o+="+");let d=String(t.resultIndex+1);d==="0"&&(d="?"),n=B.format(F,d,o)}else n=f;w(this._announceSearchResults(n,this.inputValue)),this._matchesCount.appendChild(document.createTextNode(n)),this._foundMatch=!!t&&t.resultCount>0,this.updateButtons(this._foundMatch)}changeState(t){this.state.change(t,!1)}_announceSearchResults(t,e){return e?t===f?e===""?s.localize("ariaSearchNoResultEmpty","{0} found",t):s.localize("ariaSearchNoResult","{0} found for '{1}'",t,e):s.localize("ariaSearchNoResultWithLineNumNoCurrentMatch","{0} found for '{1}'",t,e):s.localize("ariaSearchNoInput","Enter search input")}}const O=k("simpleFindWidget.sashBorder",{dark:"#454545",light:"#C8C8C8",hcDark:"#6FC3DF",hcLight:"#0F4A85"},s.localize("simpleFindWidget.sashBorder","Border color of the sash border."));D((m,g)=>{const t=m.getColor(O);g.addRule(`.monaco-workbench .simple-find-part .monaco-sash { background-color: ${t}; border-color: ${t} }`)});export{ft as SimpleFindWidget,O as simpleFindWidgetSashBorder};
