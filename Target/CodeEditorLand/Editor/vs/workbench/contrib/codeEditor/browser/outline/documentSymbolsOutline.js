var z=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var v=(d,e,t,o)=>{for(var r=o>1?void 0:o?F(e,t):e,n=d.length-1,i;n>=0;n--)(i=d[n])&&(r=(o?i(e,t,r):i(r))||r);return o&&r&&z(e,t,r),r},a=(d,e)=>(t,o)=>e(t,o,d);import{Barrier as N,TimeoutTimer as w,raceCancellation as q,timeout as U}from"../../../../../base/common/async.js";import{CancellationTokenSource as K}from"../../../../../base/common/cancellation.js";import{onUnexpectedError as H}from"../../../../../base/common/errors.js";import{Emitter as Q}from"../../../../../base/common/event.js";import{Disposable as $,DisposableStore as P,toDisposable as O}from"../../../../../base/common/lifecycle.js";import{isEqual as J}from"../../../../../base/common/resources.js";import{isCodeEditor as T,isDiffEditor as R}from"../../../../../editor/browser/editorBrowser.js";import{ICodeEditorService as X}from"../../../../../editor/browser/services/codeEditorService.js";import{Range as Y}from"../../../../../editor/common/core/range.js";import{ScrollType as Z}from"../../../../../editor/common/editorCommon.js";import{ILanguageFeaturesService as ee}from"../../../../../editor/common/services/languageFeatures.js";import{IMarkerDecorationsService as te}from"../../../../../editor/common/services/markerDecorations.js";import{ITextResourceConfigurationService as V}from"../../../../../editor/common/services/textResourceConfiguration.js";import{IOutlineModelService as ie,OutlineElement as y,OutlineGroup as L,OutlineModel as x,TreeElement as I}from"../../../../../editor/contrib/documentSymbols/browser/outlineModel.js";import{localize as oe}from"../../../../../nls.js";import{IConfigurationService as re}from"../../../../../platform/configuration/common/configuration.js";import{TextEditorSelectionRevealType as ne}from"../../../../../platform/editor/common/editor.js";import{IInstantiationService as B}from"../../../../../platform/instantiation/common/instantiation.js";import{MarkerSeverity as G}from"../../../../../platform/markers/common/markers.js";import{Registry as se}from"../../../../../platform/registry/common/platform.js";import{Extensions as ae}from"../../../../common/contributions.js";import{LifecyclePhase as le}from"../../../../services/lifecycle/common/lifecycle.js";import{IOutlineService as de,OutlineConfigCollapseItemsValues as ue,OutlineConfigKeys as p,OutlineTarget as C}from"../../../../services/outline/browser/outline.js";import{DocumentSymbolAccessibilityProvider as ce,DocumentSymbolComparator as me,DocumentSymbolFilter as M,DocumentSymbolGroupRenderer as pe,DocumentSymbolIdentityProvider as he,DocumentSymbolNavigationLabelProvider as fe,DocumentSymbolRenderer as ge,DocumentSymbolVirtualDelegate as be}from"./documentSymbolsTree.js";let h=class{constructor(e,t){this._editor=e;this._textResourceConfigurationService=t}_breadcrumbs=[];getBreadcrumbElements(){return this._breadcrumbs}clear(){this._breadcrumbs=[]}update(e,t){const o=this._computeBreadcrumbs(e,t);this._breadcrumbs=o}_computeBreadcrumbs(e,t){let o=e.getItemEnclosingPosition(t);if(!o)return[];const r=[];for(;o;){r.push(o);const i=o.parent;if(i instanceof x||i instanceof L&&i.parent&&i.parent.children.size===1)break;o=i}const n=[];for(let i=r.length-1;i>=0;i--){const s=r[i];if(this._isFiltered(s))break;n.push(s)}return n.length===0?[]:n}_isFiltered(e){if(!(e instanceof y))return!1;const t=`breadcrumbs.${M.kindToConfigName[e.symbol.kind]}`;let o;return this._editor&&this._editor.getModel()&&(o=this._editor.getModel().uri),!this._textResourceConfigurationService.getValue(o,t)}};h=v([a(1,V)],h);let f=class{constructor(e,t,o,r,n,i,s,u,c,m){this._editor=e;this._languageFeaturesService=r;this._codeEditorService=n;this._outlineModelService=i;this._configurationService=s;this._markerDecorationsService=u;this._breadcrumbsDataSource=new h(e,c);const S=new be,b=[new pe,m.createInstance(ge,!0,t)],_={getChildren:l=>l instanceof y||l instanceof L?l.children.values():l===this&&this._outlineModel?this._outlineModel.children.values():[]},D=new me,W=c.getValue(e.getModel()?.uri,p.collapseItems),A={collapseByDefault:t===C.Breadcrumbs||t===C.OutlinePane&&W===ue.Collapsed,expandOnlyOnTwistieClick:!0,multipleSelectionSupport:!1,identityProvider:new he,keyboardNavigationLabelProvider:new fe,accessibilityProvider:new ce(oe("document","Document Symbols")),filter:t===C.OutlinePane?m.createInstance(M,"outline"):t===C.Breadcrumbs?m.createInstance(M,"breadcrumbs"):void 0};this.config={breadcrumbsDataSource:this._breadcrumbsDataSource,delegate:S,renderers:b,treeDataSource:_,comparator:D,options:A,quickPickDataSource:{getQuickPickElements:()=>{throw new Error("not implemented")}}},this._disposables.add(r.documentSymbolProvider.onDidChange(l=>this._createOutline())),this._disposables.add(this._editor.onDidChangeModel(l=>this._createOutline())),this._disposables.add(this._editor.onDidChangeModelLanguage(l=>this._createOutline()));const E=new w;this._disposables.add(E),this._disposables.add(this._editor.onDidChangeModelContent(l=>{const k=this._editor.getModel();if(k){const j=i.getDebounceValue(k);E.cancelAndSet(()=>this._createOutline(l),j)}})),this._disposables.add(this._editor.onDidDispose(()=>this._outlineDisposables.clear())),this._createOutline().finally(()=>o.open())}_disposables=new P;_onDidChange=new Q;onDidChange=this._onDidChange.event;_outlineModel;_outlineDisposables=new P;_breadcrumbsDataSource;config;outlineKind="documentSymbols";get activeElement(){const e=this._editor.getPosition();if(!(!e||!this._outlineModel))return this._outlineModel.getItemEnclosingPosition(e)}dispose(){this._disposables.dispose(),this._outlineDisposables.dispose()}get isEmpty(){return!this._outlineModel||I.empty(this._outlineModel)}get uri(){return this._outlineModel?.uri}async reveal(e,t,o,r){const n=x.get(e);!n||!(e instanceof y)||await this._codeEditorService.openCodeEditor({resource:n.uri,options:{...t,selection:r?e.symbol.range:Y.collapseToStart(e.symbol.selectionRange),selectionRevealType:ne.NearTopIfOutsideViewport}},this._editor,o)}preview(e){if(!(e instanceof y))return $.None;const{symbol:t}=e;this._editor.revealRangeInCenterIfOutsideViewport(t.range,Z.Smooth);const o=this._editor.createDecorationsCollection([{range:t.range,options:{description:"document-symbols-outline-range-highlight",className:"rangeHighlight",isWholeLine:!0}}]);return O(()=>o.clear())}captureViewState(){const e=this._editor.saveViewState();return O(()=>{e&&this._editor.restoreViewState(e)})}async _createOutline(e){if(this._outlineDisposables.clear(),e||this._setOutlineModel(void 0),!this._editor.hasModel())return;const t=this._editor.getModel();if(!this._languageFeaturesService.documentSymbolProvider.has(t))return;const o=new K,r=t.getVersionId(),n=new w;this._outlineDisposables.add(n),this._outlineDisposables.add(O(()=>o.dispose(!0)));try{const i=await this._outlineModelService.getOrCreate(t,o.token);if(o.token.isCancellationRequested)return;if(I.empty(i)||!this._editor.hasModel()){this._setOutlineModel(i);return}if(e&&this._outlineModel&&t.getLineCount()>=25){const s=I.size(i),u=t.getValueLength(),c=s/u,m=I.size(this._outlineModel),S=u-e.changes.reduce((_,D)=>_+D.rangeLength,0),b=m/S;if((c<=b*.5||c>=b*1.5)&&!await q(U(2e3).then(()=>!0),o.token,!1))return}this._applyMarkersToOutline(i),this._outlineDisposables.add(this._markerDecorationsService.onDidChangeMarker(s=>{J(i.uri,s.uri)&&(this._applyMarkersToOutline(i),this._onDidChange.fire({}))})),this._outlineDisposables.add(this._configurationService.onDidChangeConfiguration(s=>{if(s.affectsConfiguration(p.problemsEnabled)||s.affectsConfiguration("problems.visibility")){const u=this._configurationService.getValue("problems.visibility"),c=this._configurationService.getValue(p.problemsEnabled);!u||!c?i.updateMarker([]):this._applyMarkersToOutline(i),this._onDidChange.fire({})}s.affectsConfiguration("outline")&&this._onDidChange.fire({}),s.affectsConfiguration("breadcrumbs")&&this._editor.hasModel()&&(this._breadcrumbsDataSource.update(i,this._editor.getPosition()),this._onDidChange.fire({}))})),this._outlineDisposables.add(this._configurationService.onDidChangeConfiguration(s=>{s.affectsConfiguration(p.icons)&&this._onDidChange.fire({}),s.affectsConfiguration("outline")&&this._onDidChange.fire({})})),this._outlineDisposables.add(this._editor.onDidChangeCursorPosition(s=>{n.cancelAndSet(()=>{!t.isDisposed()&&r===t.getVersionId()&&this._editor.hasModel()&&(this._breadcrumbsDataSource.update(i,this._editor.getPosition()),this._onDidChange.fire({affectOnlyActiveElement:!0}))},150)})),this._setOutlineModel(i)}catch(i){this._setOutlineModel(void 0),H(i)}}_applyMarkersToOutline(e){const t=this._configurationService.getValue("problems.visibility"),o=this._configurationService.getValue(p.problemsEnabled);if(!e||!t||!o)return;const r=[];for(const[n,i]of this._markerDecorationsService.getLiveMarkers(e.uri))(i.severity===G.Error||i.severity===G.Warning)&&r.push({...n,severity:i.severity});e.updateMarker(r)}_setOutlineModel(e){const t=this._editor.getPosition();!t||!e?(this._outlineModel=void 0,this._breadcrumbsDataSource.clear()):(this._outlineModel?.merge(e)||(this._outlineModel=e),this._breadcrumbsDataSource.update(e,t)),this._onDidChange.fire({})}};f=v([a(3,ee),a(4,X),a(5,ie),a(6,re),a(7,te),a(8,V),a(9,B)],f);let g=class{dispose;constructor(e){const t=e.registerOutlineCreator(this);this.dispose=()=>t.dispose()}matches(e){const t=e.getControl();return T(t)||R(t)}async createOutline(e,t,o){const r=e.getControl();let n;if(T(r)?n=r:R(r)&&(n=r.getModifiedEditor()),!n)return;const i=new N,s=n.invokeWithinContext(u=>u.get(B).createInstance(f,n,t,i));return await i.wait(),s}};g=v([a(0,de)],g),se.as(ae.Workbench).registerWorkbenchContribution(g,le.Eventually);
