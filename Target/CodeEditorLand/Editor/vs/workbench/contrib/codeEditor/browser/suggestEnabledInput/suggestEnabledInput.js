var U=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var w=(a,e,t,i)=>{for(var s=i>1?void 0:i?G(e,t):e,d=a.length-1,o;d>=0;d--)(o=a[d])&&(s=(i?o(e,t,s):o(s))||s);return i&&s&&U(e,t,s),s},n=(a,e)=>(t,i)=>e(t,i,a);import{$ as R,append as k}from"../../../../../base/browser/dom.js";import{DEFAULT_FONT_FAMILY as Y}from"../../../../../base/browser/fonts.js";import{Widget as J}from"../../../../../base/browser/ui/widget.js";import{Emitter as E,Event as A}from"../../../../../base/common/event.js";import{HistoryNavigator as Q}from"../../../../../base/common/history.js";import{KeyCode as j}from"../../../../../base/common/keyCodes.js";import{mixin as X}from"../../../../../base/common/objects.js";import{isMacintosh as Z}from"../../../../../base/common/platform.js";import{URI as ee}from"../../../../../base/common/uri.js";import"./suggestEnabledInput.css";import{EditorExtensionsRegistry as te}from"../../../../../editor/browser/editorExtensions.js";import{CodeEditorWidget as ie}from"../../../../../editor/browser/widget/codeEditor/codeEditorWidget.js";import{EditOperation as oe}from"../../../../../editor/common/core/editOperation.js";import{Position as re}from"../../../../../editor/common/core/position.js";import{Range as z}from"../../../../../editor/common/core/range.js";import{ensureValidWordDefinition as ne,getWordAtText as se}from"../../../../../editor/common/core/wordHelper.js";import*as le from"../../../../../editor/common/languages.js";import{ILanguageFeaturesService as M}from"../../../../../editor/common/services/languageFeatures.js";import{IModelService as K}from"../../../../../editor/common/services/model.js";import{ContextMenuController as ae}from"../../../../../editor/contrib/contextmenu/browser/contextmenu.js";import{SnippetController2 as de}from"../../../../../editor/contrib/snippet/browser/snippetController2.js";import{SuggestController as ue}from"../../../../../editor/contrib/suggest/browser/suggestController.js";import{IConfigurationService as F}from"../../../../../platform/configuration/common/configuration.js";import{IContextKeyService as V}from"../../../../../platform/contextkey/common/contextkey.js";import{registerAndCreateHistoryNavigationContext as ge}from"../../../../../platform/history/browser/contextScopedHistoryWidget.js";import{IInstantiationService as L}from"../../../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as pe}from"../../../../../platform/instantiation/common/serviceCollection.js";import{asCssVariable as W,asCssVariableWithDefault as ce,inputBackground as he,inputBorder as me,inputForeground as $,inputPlaceholderForeground as ye}from"../../../../../platform/theme/common/colorRegistry.js";import{MenuPreventer as fe}from"../menuPreventer.js";import{SelectionClipboardContributionID as Ce}from"../selectionClipboard.js";import{getSimpleEditorOptions as ve,setupSimpleEditorSelectionStyling as xe}from"../simpleEditorOptions.js";let x=class extends J{_onShouldFocusResults=new E;onShouldFocusResults=this._onShouldFocusResults.event;_onInputDidChange=new E;onInputDidChange=this._onInputDidChange.event;_onDidFocus=this._register(new E);onDidFocus=this._onDidFocus.event;_onDidBlur=this._register(new E);onDidBlur=this._onDidBlur.event;inputWidget;inputModel;stylingContainer;element;placeholderText;constructor(e,t,i,s,d,o,h,f,C,p,u){super(),this.stylingContainer=k(t,R(".suggest-input-container")),this.element=t,this.placeholderText=k(this.stylingContainer,R(".suggest-input-placeholder",void 0,o.placeholderText||""));const m=X(ve(u),Ie(s));m.overflowWidgetsDomNode=o.overflowWidgetsDomNode;const c=this.getScopedContextKeyService(C),q=c?this._register(h.createChild(new pe([V,c]))):h;this.inputWidget=this._register(q.createInstance(ie,this.stylingContainer,m,{contributions:te.getSomeEditorContributions([ue.ID,de.ID,ae.ID,fe.ID,Ce]),isSimpleWidget:!0})),this._register(u.onDidChangeConfiguration(r=>{if(r.affectsConfiguration("editor.accessibilitySupport")||r.affectsConfiguration("editor.cursorBlinking")){const l=u.getValue("editor.accessibilitySupport"),O=u.getValue("editor.cursorBlinking");this.inputWidget.updateOptions({accessibilitySupport:l,cursorBlinking:O})}})),this._register(this.inputWidget.onDidFocusEditorText(()=>this._onDidFocus.fire())),this._register(this.inputWidget.onDidBlurEditorText(()=>this._onDidBlur.fire()));const T=ee.parse(d);this.inputModel=f.createModel("",null,T,!0),this._register(this.inputModel),this.inputWidget.setModel(this.inputModel),this._register(this.inputWidget.onDidPaste(()=>this.setValue(this.getValue()))),this._register(this.inputWidget.onDidFocusEditorText(()=>{o.focusContextKey&&o.focusContextKey.set(!0),this.stylingContainer.classList.add("synthetic-focus")})),this._register(this.inputWidget.onDidBlurEditorText(()=>{o.focusContextKey&&o.focusContextKey.set(!1),this.stylingContainer.classList.remove("synthetic-focus")})),this._register(A.chain(this.inputWidget.onKeyDown,r=>r.filter(l=>l.keyCode===j.Enter))(r=>{r.preventDefault()},this)),this._register(A.chain(this.inputWidget.onKeyDown,r=>r.filter(l=>l.keyCode===j.DownArrow&&(Z?l.metaKey:l.ctrlKey)))(()=>this._onShouldFocusResults.fire(),this));let N=this.getValue();const H=this.inputWidget.getModel();H&&this._register(H.onDidChangeContent(()=>{const r=this.getValue();this.placeholderText.style.visibility=r?"hidden":"visible",N.trim()!==r.trim()&&(this._onInputDidChange.fire(void 0),N=r)}));const y={provideResults:i.provideResults,sortKey:i.sortKey||(r=>r),triggerCharacters:i.triggerCharacters||[],wordDefinition:i.wordDefinition?ne(i.wordDefinition):void 0,alwaysShowSuggestions:!!i.alwaysShowSuggestions};this.setValue(o.value||""),this._register(p.completionProvider.register({scheme:T.scheme,pattern:"**/"+T.path,hasAccessToAllModels:!0},{_debugDisplayName:`suggestEnabledInput/${e}`,triggerCharacters:y.triggerCharacters,provideCompletionItems:(r,l,O)=>{const S=r.getValue(),P=l.column-1;let b=0,D=0;if(y.wordDefinition){const g=se(l.column,y.wordDefinition,S,0);b=g?.word.length??0,D=g?g.startColumn-1:0}else D=S.lastIndexOf(" ",P-1)+1,b=P-D;return!y.alwaysShowSuggestions&&b>0&&y.triggerCharacters?.indexOf(S[D])===-1?{suggestions:[]}:{suggestions:i.provideResults(S).map(g=>{let v,B;return typeof g=="string"?v=g:(v=g.label,B=g),{label:v,insertText:v,range:z.fromPositions(l.delta(0,-b),l),sortText:y.sortKey(v),kind:le.CompletionItemKind.Keyword,...B}})}}})),this.style(o.styleOverrides||{})}getScopedContextKeyService(e){}updateAriaLabel(e){this.inputWidget.updateOptions({ariaLabel:e})}setValue(e){e=e.replace(/\s/g," ");const t=this.inputModel.getFullModelRange();this.inputWidget.executeEdits("suggestEnabledInput.setValue",[oe.replace(t,e)]),this.inputWidget.setScrollTop(0),this.inputWidget.setPosition(new re(1,e.length+1))}getValue(){return this.inputWidget.getValue()}style(e){this.stylingContainer.style.backgroundColor=W(e.inputBackground??he),this.stylingContainer.style.color=W(e.inputForeground??$),this.placeholderText.style.color=W(e.inputPlaceholderForeground??ye),this.stylingContainer.style.borderWidth="1px",this.stylingContainer.style.borderStyle="solid",this.stylingContainer.style.borderColor=ce(e.inputBorder??me,"transparent");const t=this.stylingContainer.getElementsByClassName("cursor")[0];t&&(t.style.backgroundColor=W(e.inputForeground??$))}focus(e){this.inputWidget.focus(),e&&this.inputWidget.getValue()&&this.selectAll()}onHide(){this.inputWidget.onHide()}layout(e){this.inputWidget.layout(e),this.placeholderText.style.width=`${e.width-2}px`}selectAll(){this.inputWidget.setSelection(new z(1,1,1,this.getValue().length+1))}};x=w([n(6,L),n(7,K),n(8,V),n(9,M),n(10,F)],x);let I=class extends x{history;constructor({id:e,parent:t,ariaLabel:i,suggestionProvider:s,resourceHandle:d,suggestOptions:o,history:h},f,C,p,u,m){super(e,t,s,i,d,o,f,C,p,u,m),this.history=new Q(h,100)}addToHistory(){const e=this.getValue();e&&e!==this.getCurrentValue()&&this.history.add(e)}getHistory(){return this.history.getHistory()}showNextValue(){this.history.has(this.getValue())||this.addToHistory();let e=this.getNextValue();e&&(e=e===this.getValue()?this.getNextValue():e),this.setValue(e??"")}showPreviousValue(){this.history.has(this.getValue())||this.addToHistory();let e=this.getPreviousValue();e&&(e=e===this.getValue()?this.getPreviousValue():e),e&&(this.setValue(e),this.inputWidget.setPosition({lineNumber:0,column:0}))}clearHistory(){this.history.clear()}getCurrentValue(){let e=this.history.current();return e||(e=this.history.last(),this.history.next()),e}getPreviousValue(){return this.history.previous()||this.history.first()}getNextValue(){return this.history.next()}};I=w([n(1,L),n(2,K),n(3,V),n(4,M),n(5,F)],I);let _=class extends I{historyContext;constructor(e,t,i,s,d,o){super(e,t,i,s,d,o);const{historyNavigationBackwardsEnablement:h,historyNavigationForwardsEnablement:f}=this.historyContext;this._register(this.inputWidget.onDidChangeCursorPosition(({position:C})=>{const p=this.inputWidget._getViewModel(),u=p.getLineCount(),m=p.getLineLength(u)+1,c=p.coordinatesConverter.convertModelPositionToViewPosition(C);h.set(c.lineNumber===1&&c.column===1),f.set(c.lineNumber===u&&c.column===m)}))}getScopedContextKeyService(e){const t=this._register(e.createScoped(this.element));return this.historyContext=this._register(ge(t,this)),t}};_=w([n(1,L),n(2,K),n(3,V),n(4,M),n(5,F)],_),xe(".suggest-input-container");function Ie(a){return{fontSize:13,lineHeight:20,wordWrap:"off",scrollbar:{vertical:"hidden"},roundedSelection:!1,guides:{indentation:!1},cursorWidth:1,fontFamily:Y,ariaLabel:a||"",snippetSuggestions:"none",suggest:{filterGraceful:!1,showIcons:!1},autoClosingBrackets:"never"}}export{_ as ContextScopedSuggestEnabledInputWithHistory,x as SuggestEnabledInput,I as SuggestEnabledInputWithHistory};
