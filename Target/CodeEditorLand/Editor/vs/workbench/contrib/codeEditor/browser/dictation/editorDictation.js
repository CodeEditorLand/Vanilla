var K=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var b=(a,n,e,i)=>{for(var t=i>1?void 0:i?A(n,e):n,o=a.length-1,d;o>=0;o--)(d=a[o])&&(t=(i?d(n,e,t):d(t))||t);return i&&t&&K(n,e,t),t},l=(a,n)=>(e,i)=>n(e,i,a);import"./editorDictation.css";import"../../../../../base/browser/dom.js";import{ActionBar as W}from"../../../../../base/browser/ui/actionbar/actionbar.js";import{toAction as O}from"../../../../../base/common/actions.js";import{CancellationTokenSource as R}from"../../../../../base/common/cancellation.js";import{Codicon as L}from"../../../../../base/common/codicons.js";import{KeyCode as h,KeyMod as u}from"../../../../../base/common/keyCodes.js";import{Disposable as I,DisposableStore as M,MutableDisposable as z,toDisposable as p}from"../../../../../base/common/lifecycle.js";import{isWindows as B}from"../../../../../base/common/platform.js";import{ThemeIcon as H}from"../../../../../base/common/themables.js";import{assertIsDefined as V}from"../../../../../base/common/types.js";import{ContentWidgetPositionPreference as f}from"../../../../../editor/browser/editorBrowser.js";import{EditorAction2 as S,EditorContributionInstantiation as _,registerEditorContribution as q}from"../../../../../editor/browser/editorExtensions.js";import{EditorOption as $}from"../../../../../editor/common/config/editorOptions.js";import{EditOperation as G}from"../../../../../editor/common/core/editOperation.js";import{Position as F}from"../../../../../editor/common/core/position.js";import{Range as D}from"../../../../../editor/common/core/range.js";import{Selection as X}from"../../../../../editor/common/core/selection.js";import"../../../../../editor/common/editorCommon.js";import{EditorContextKeys as Y}from"../../../../../editor/common/editorContextKeys.js";import{localize as w,localize2 as y}from"../../../../../nls.js";import{registerAction2 as E}from"../../../../../platform/actions/common/actions.js";import{ContextKeyExpr as j,IContextKeyService as J,RawContextKey as Q}from"../../../../../platform/contextkey/common/contextkey.js";import"../../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as x}from"../../../../../platform/keybinding/common/keybinding.js";import{KeybindingWeight as P}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import{HasSpeechProvider as U,ISpeechService as Z,SpeechToTextInProgress as ee,SpeechToTextStatus as m}from"../../../speech/common/speechService.js";const k=new Q("editorDictation.inProgress",!1),T=y("voiceCategory","Voice");class te extends S{constructor(){super({id:"workbench.action.editorDictation.start",title:y("startDictation","Start Dictation in Editor"),category:T,precondition:j.and(U,ee.toNegated(),Y.readOnly.toNegated()),f1:!0,keybinding:{primary:u.CtrlCmd|u.Alt|h.KeyV,weight:P.WorkbenchContrib,secondary:B?[u.Alt|h.Backquote]:void 0}})}runEditorCommand(n,e){const t=n.get(x).enableKeybindingHoldMode(this.desc.id);if(t){let o=!1;const d=setTimeout(()=>{o=!0},500);t.finally(()=>{clearTimeout(d),o&&r.get(e)?.stop()})}r.get(e)?.start()}}class c extends S{static ID="workbench.action.editorDictation.stop";constructor(){super({id:c.ID,title:y("stopDictation","Stop Dictation in Editor"),category:T,precondition:k,f1:!0,keybinding:{primary:h.Escape,weight:P.WorkbenchContrib+100}})}runEditorCommand(n,e){r.get(e)?.stop()}}class ie extends I{constructor(e,i){super();this.editor=e;const t=this._register(new W(this.domNode)),o=i.lookupKeybinding(c.ID)?.getLabel();t.push(O({id:c.ID,label:o?w("stopDictationShort1","Stop Dictation ({0})",o):w("stopDictationShort2","Stop Dictation"),class:H.asClassName(L.micFilled),run:()=>r.get(e)?.stop()}),{icon:!0,label:!1,keybinding:o}),this.domNode.classList.add("editor-dictation-widget"),this.domNode.appendChild(t.domNode)}suppressMouseDown=!0;allowEditorOverflow=!0;domNode=document.createElement("div");getId(){return"editorDictation"}getDomNode(){return this.domNode}getPosition(){if(!this.editor.hasModel())return null;const e=this.editor.getSelection();return{position:e.getPosition(),preference:[e.getPosition().equals(e.getStartPosition())?f.ABOVE:f.BELOW,f.EXACT]}}beforeRender(){const e=this.editor.getOption($.lineHeight),i=this.editor.getLayoutInfo().contentWidth*.7;return this.domNode.style.setProperty("--vscode-editor-dictation-widget-height",`${e}px`),this.domNode.style.setProperty("--vscode-editor-dictation-widget-width",`${i}px`),null}show(){this.editor.addContentWidget(this)}layout(){this.editor.layoutContentWidget(this)}active(){this.domNode.classList.add("recording")}hide(){this.domNode.classList.remove("recording"),this.editor.removeContentWidget(this)}}let r=class extends I{constructor(e,i,t,o){super();this.editor=e;this.speechService=i;this.contextKeyService=t;this.keybindingService=o}static ID="editorDictation";static get(e){return e.getContribution(r.ID)}widget=this._register(new ie(this.editor,this.keybindingService));editorDictationInProgress=k.bindTo(this.contextKeyService);sessionDisposables=this._register(new z);async start(){const e=new M;this.sessionDisposables.value=e,this.widget.show(),e.add(p(()=>this.widget.hide())),this.editorDictationInProgress.set(!0),e.add(p(()=>this.editorDictationInProgress.reset()));const i=this.editor.createDecorationsCollection();e.add(p(()=>i.clear())),e.add(this.editor.onDidChangeCursorPosition(()=>this.widget.layout()));let t,o=0;const d=(s,v)=>{t||(t=V(this.editor.getPosition()));const C=new F(t.lineNumber,t.column+s.length);this.editor.executeEdits(r.ID,[G.replace(D.fromPositions(t,t.with(void 0,t.column+o)),s)],[X.fromPositions(C)]),v?i.set([{range:D.fromPositions(t,t.with(void 0,t.column+s.length)),options:{description:"editor-dictation-preview",inlineClassName:"ghost-text-decoration-preview"}}]):i.clear(),o=s.length,v||(t=void 0,o=0),this.editor.revealPositionInCenterIfOutsideViewport(C)},g=new R;e.add(p(()=>g.dispose(!0)));const N=await this.speechService.createSpeechToTextSession(g.token,"editor");e.add(N.onDidChange(s=>{if(!g.token.isCancellationRequested)switch(s.status){case m.Started:this.widget.active();break;case m.Stopped:e.dispose();break;case m.Recognizing:{if(!s.text)return;d(s.text,!0);break}case m.Recognized:{if(!s.text)return;d(`${s.text} `,!1);break}}}))}stop(){this.sessionDisposables.clear()}};r=b([l(1,Z),l(2,J),l(3,x)],r),q(r.ID,r,_.Lazy),E(te),E(c);export{ie as DictationWidget,r as EditorDictation,te as EditorDictationStartAction,c as EditorDictationStopAction};
