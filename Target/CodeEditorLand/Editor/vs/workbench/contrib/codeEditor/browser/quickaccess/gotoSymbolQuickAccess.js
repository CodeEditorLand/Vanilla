var x=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var h=(p,c,e,i)=>{for(var o=i>1?void 0:i?w(c,e):c,r=p.length-1,t;r>=0;r--)(t=p[r])&&(o=(i?t(c,e,o):t(o))||o);return i&&o&&x(c,e,o),o},d=(p,c)=>(e,i)=>c(e,i,p);import{timeout as D}from"../../../../../base/common/async.js";import{CancellationTokenSource as O}from"../../../../../base/common/cancellation.js";import{onUnexpectedError as Q}from"../../../../../base/common/errors.js";import{fuzzyScore as T}from"../../../../../base/common/filters.js";import{prepareQuery as M}from"../../../../../base/common/fuzzyScorer.js";import{matchesFuzzyIconAware as A,parseLabelWithIcons as G}from"../../../../../base/common/iconLabels.js";import{KeyCode as F,KeyMod as E}from"../../../../../base/common/keyCodes.js";import{Disposable as L,DisposableStore as R,MutableDisposable as B,toDisposable as k}from"../../../../../base/common/lifecycle.js";import{isCompositeEditor as K}from"../../../../../editor/browser/editorBrowser.js";import"../../../../../editor/common/core/range.js";import{SymbolKind as C}from"../../../../../editor/common/languages.js";import"../../../../../editor/common/model.js";import{ILanguageFeaturesService as W}from"../../../../../editor/common/services/languageFeatures.js";import{IOutlineModelService as z}from"../../../../../editor/contrib/documentSymbols/browser/outlineModel.js";import"../../../../../editor/contrib/quickAccess/browser/editorNavigationQuickAccess.js";import{AbstractGotoSymbolQuickAccessProvider as m}from"../../../../../editor/contrib/quickAccess/browser/gotoSymbolQuickAccess.js";import{localize as u,localize2 as _}from"../../../../../nls.js";import{Action2 as V,MenuId as X,registerAction2 as q}from"../../../../../platform/actions/common/actions.js";import{IConfigurationService as N}from"../../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as Y}from"../../../../../platform/contextkey/common/contextkey.js";import"../../../../../platform/editor/common/editor.js";import"../../../../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as U}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import{Extensions as H}from"../../../../../platform/quickinput/common/quickAccess.js";import{IQuickInputService as j,ItemActivation as J}from"../../../../../platform/quickinput/common/quickInput.js";import{Registry as Z}from"../../../../../platform/registry/common/platform.js";import"../../../../common/editor.js";import{IEditorGroupsService as $}from"../../../../services/editor/common/editorGroupsService.js";import{IEditorService as ee}from"../../../../services/editor/common/editorService.js";import{IOutlineService as ie,OutlineTarget as te}from"../../../../services/outline/browser/outline.js";import{accessibilityHelpIsShown as oe,accessibleViewIsShown as re}from"../../../accessibility/browser/accessibilityConfiguration.js";let a=class extends m{constructor(e,i,o,r,t,S){super(r,S,{openSideBySideDirection:()=>this.configuration.openSideBySideDirection});this.editorService=e;this.editorGroupService=i;this.configurationService=o;this.outlineService=t}onDidActiveTextEditorControlChange=this.editorService.onDidActiveEditorChange;get configuration(){const e=this.configurationService.getValue().workbench?.editor;return{openEditorPinned:!e?.enablePreviewFromQuickOpen||!e?.enablePreview,openSideBySideDirection:e?.openSideBySideDirection}}get activeTextEditorControl(){if(!K(this.editorService.activeEditorPane?.getControl()))return this.editorService.activeTextEditorControl}gotoLocation(e,i){if((i.keyMods.alt||this.configuration.openEditorPinned&&i.keyMods.ctrlCmd||i.forceSideBySide)&&this.editorService.activeEditor){e.restoreViewState?.();const o={selection:i.range,pinned:i.keyMods.ctrlCmd||this.configuration.openEditorPinned,preserveFocus:i.preserveFocus};this.editorGroupService.sideGroup.openEditor(this.editorService.activeEditor,o)}else super.gotoLocation(e,i)}static SYMBOL_PICKS_TIMEOUT=8e3;async getSymbolPicks(e,i,o,r,t){return!await Promise.race([this.waitForLanguageSymbolRegistry(e,r),D(a.SYMBOL_PICKS_TIMEOUT)])||t.isCancellationRequested?[]:this.doGetSymbolPicks(this.getDocumentSymbols(e,t),M(i),o,t,e)}provideWithoutTextEditor(e){return this.canPickWithOutlineService()?this.doGetOutlinePicks(e):super.provideWithoutTextEditor(e)}canPickWithOutlineService(){return this.editorService.activeEditorPane?this.outlineService.canCreateOutline(this.editorService.activeEditorPane):!1}doGetOutlinePicks(e){const i=this.editorService.activeEditorPane;if(!i)return L.None;const o=new O,r=new R;return r.add(k(()=>o.dispose(!0))),e.busy=!0,this.outlineService.createOutline(i,te.QuickPick,o.token).then(t=>{if(!t)return;if(o.token.isCancellationRequested){t.dispose();return}r.add(t);const S=t.captureViewState();r.add(k(()=>{e.selectedItems.length===0&&S.dispose()}));const l=t.config.quickPickDataSource.getQuickPickElements(),P=l.map((n,s)=>({kind:C.File,index:s,score:0,label:n.label,description:n.description,ariaLabel:n.ariaLabel,iconClasses:n.iconClasses}));r.add(e.onDidAccept(()=>{e.hide();const[n]=e.selectedItems;n&&l[n.index]&&t.reveal(l[n.index].element,{},!1,!1)}));const y=()=>{const n=P.filter(s=>{if(e.value==="@")return s.score=0,s.highlights=void 0,!0;const I=e.value.substring(m.PREFIX.length).trim(),g=G(s.label),b=T(I,I.toLowerCase(),0,g.text,g.text.toLowerCase(),0,{firstMatchCanBeWeak:!0,boostFullMatch:!0});return b?(s.score=b[1],s.highlights={label:A(I,g)??void 0},!0):!1});if(n.length===0){const s=u("empty","No matching entries");e.items=[{label:s,index:-1,kind:C.String}],e.ariaLabel=s}else e.items=n};y(),r.add(e.onDidChangeValue(y));const v=new B;r.add(v),r.add(e.onDidChangeActive(()=>{const[n]=e.activeItems;n&&l[n.index]?v.value=t.preview(l[n.index].element):v.clear()}))}).catch(t=>{Q(t),e.hide()}).finally(()=>{e.busy=!1}),r}};a=h([d(0,ee),d(1,$),d(2,N),d(3,W),d(4,ie),d(5,z)],a);class f extends V{static ID="workbench.action.gotoSymbol";constructor(){super({id:f.ID,title:{..._("gotoSymbol","Go to Symbol in Editor..."),mnemonicTitle:u({key:"miGotoSymbolInEditor",comment:["&& denotes a mnemonic"]},"Go to &&Symbol in Editor...")},f1:!0,keybinding:{when:Y.and(re.negate(),oe.negate()),weight:U.WorkbenchContrib,primary:E.CtrlCmd|E.Shift|F.KeyO},menu:[{id:X.MenubarGoMenu,group:"4_symbol_nav",order:1}]})}run(c){c.get(j).quickAccess.show(a.PREFIX,{itemActivation:J.NONE})}}q(f),Z.as(H.Quickaccess).registerQuickAccessProvider({ctor:a,prefix:m.PREFIX,contextKey:"inFileSymbolsPicker",placeholder:u("gotoSymbolQuickAccessPlaceholder","Type the name of a symbol to go to."),helpEntries:[{description:u("gotoSymbolQuickAccess","Go to Symbol in Editor"),prefix:m.PREFIX,commandId:f.ID,commandCenterOrder:40},{description:u("gotoSymbolByCategoryQuickAccess","Go to Symbol in Editor by Category"),prefix:m.PREFIX_BY_CATEGORY}]});export{a as GotoSymbolQuickAccessProvider};
