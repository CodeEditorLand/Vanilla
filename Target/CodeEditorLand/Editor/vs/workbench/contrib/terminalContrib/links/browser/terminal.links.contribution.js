var y=Object.defineProperty;var u=Object.getOwnPropertyDescriptor;var L=(t,a,n,e)=>{for(var i=e>1?void 0:e?u(a,n):a,o=t.length-1,s;o>=0;o--)(s=t[o])&&(i=(e?s(a,n,i):s(i))||i);return e&&i&&y(a,n,i),i},d=(t,a)=>(n,e)=>a(n,e,t);import{Event as _}from"../../../../../base/common/event.js";import{KeyCode as g,KeyMod as l}from"../../../../../base/common/keyCodes.js";import{DisposableStore as w}from"../../../../../base/common/lifecycle.js";import{localize2 as c}from"../../../../../nls.js";import{AccessibleViewProviderId as T}from"../../../../../platform/accessibility/browser/accessibleView.js";import{ContextKeyExpr as v}from"../../../../../platform/contextkey/common/contextkey.js";import{InstantiationType as b,registerSingleton as M}from"../../../../../platform/instantiation/common/extensions.js";import{IInstantiationService as P}from"../../../../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as I}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import{accessibleViewCurrentProviderId as C,accessibleViewIsShown as S}from"../../../accessibility/browser/accessibilityConfiguration.js";import{isDetachedTerminalInstance as R}from"../../../terminal/browser/terminal.js";import{registerActiveInstanceAction as k}from"../../../terminal/browser/terminalActions.js";import{registerTerminalContribution as D}from"../../../terminal/browser/terminalExtensions.js";import{isTerminalProcessManager as x}from"../../../terminal/common/terminal.js";import{TerminalContextKeys as m}from"../../../terminal/common/terminalContextKey.js";import{terminalStrings as Q}from"../../../terminal/common/terminalStrings.js";import{TerminalLinksCommandId as p}from"../common/terminal.links.js";import{ITerminalLinkProviderService as f}from"./links.js";import{TerminalLinkManager as O}from"./terminalLinkManager.js";import{TerminalLinkProviderService as W}from"./terminalLinkProviderService.js";import{TerminalLinkQuickpick as K}from"./terminalLinkQuickpick.js";import{TerminalLinkResolver as F}from"./terminalLinkResolver.js";M(f,W,b.Delayed);let r=class extends w{constructor(n,e,i,o,s){super();this._instance=n;this._processManager=e;this._widgetManager=i;this._instantiationService=o;this._terminalLinkProviderService=s;this._linkResolver=this._instantiationService.createInstance(F)}static ID="terminal.link";static get(n){return n.getContribution(r.ID)}_linkManager;_terminalLinkQuickpick;_linkResolver;xtermReady(n){const e=this._linkManager=this.add(this._instantiationService.createInstance(O,n.raw,this._processManager,this._instance.capabilities,this._linkResolver));if(x(this._processManager)){const i=e.add(_.once(this._processManager.onProcessReady)(()=>{e.setWidgetManager(this._widgetManager),this.delete(i)}))}else e.setWidgetManager(this._widgetManager);if(!R(this._instance)){for(const i of this._terminalLinkProviderService.linkProviders)e.externalProvideLinksCb=i.provideLinks.bind(i,this._instance);e.add(this._terminalLinkProviderService.onDidAddLinkProvider(i=>{e.externalProvideLinksCb=i.provideLinks.bind(i,this._instance)}))}e.add(this._terminalLinkProviderService.onDidRemoveLinkProvider(()=>e.externalProvideLinksCb=void 0))}async showLinkQuickpick(n){this._terminalLinkQuickpick||(this._terminalLinkQuickpick=this.add(this._instantiationService.createInstance(K)),this._terminalLinkQuickpick.onDidRequestMoreLinks(()=>{this.showLinkQuickpick(!0)}));const e=await this._getLinks();return await this._terminalLinkQuickpick.show(this._instance,e)}async _getLinks(){if(!this._linkManager)throw new Error("terminal links are not ready, cannot generate link quick pick");return this._linkManager.getLinks()}async openRecentLink(n){if(!this._linkManager)throw new Error("terminal links are not ready, cannot open a link");this._linkManager.openRecentLink(n)}};r=L([d(3,P),d(4,f)],r),D(r.ID,r,!0);const h=Q.actionCategory;k({id:p.OpenDetectedLink,title:c("workbench.action.terminal.openDetectedLink","Open Detected Link..."),f1:!0,category:h,precondition:m.terminalHasBeenCreated,keybinding:[{primary:l.CtrlCmd|l.Shift|g.KeyO,weight:I.WorkbenchContrib+1,when:m.focus},{primary:l.CtrlCmd|l.Shift|g.KeyG,weight:I.WorkbenchContrib+1,when:v.and(S,v.equals(C.key,T.Terminal))}],run:t=>r.get(t)?.showLinkQuickpick()}),k({id:p.OpenWebLink,title:c("workbench.action.terminal.openLastUrlLink","Open Last URL Link"),metadata:{description:c("workbench.action.terminal.openLastUrlLink.description","Opens the last detected URL/URI link in the terminal")},f1:!0,category:h,precondition:m.terminalHasBeenCreated,run:t=>r.get(t)?.openRecentLink("url")}),k({id:p.OpenFileLink,title:c("workbench.action.terminal.openLastLocalFileLink","Open Last Local File Link"),f1:!0,category:h,precondition:m.terminalHasBeenCreated,run:t=>r.get(t)?.openRecentLink("localFile")});
