var S=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var g=(s,e,i,r)=>{for(var t=r>1?void 0:r?x(e,i):e,l=s.length-1,a;l>=0;l--)(a=s[l])&&(t=(r?a(e,i,t):a(t))||t);return r&&t&&S(e,i,t),t},m=(s,e)=>(i,r)=>e(i,r,s);import{Schemas as T}from"../../../../../../vs/base/common/network.js";import{URI as y}from"../../../../../../vs/base/common/uri.js";import{LinkComputer as _}from"../../../../../../vs/editor/common/languages/linkComputer.js";import{ITerminalLogService as C}from"../../../../../../vs/platform/terminal/common/terminal.js";import{IUriIdentityService as R}from"../../../../../../vs/platform/uriIdentity/common/uriIdentity.js";import{IWorkspaceContextService as b}from"../../../../../../vs/platform/workspace/common/workspace.js";import"../../../../../../vs/workbench/contrib/terminal/common/terminal.js";import{TerminalBuiltinLinkType as u}from"../../../../../../vs/workbench/contrib/terminalContrib/links/browser/links.js";import{convertLinkRangeToBuffer as W,getXtermLineContent as B}from"../../../../../../vs/workbench/contrib/terminalContrib/links/browser/terminalLinkHelpers.js";var P=(e=>(e[e.MaxResolvedLinksInLine=10]="MaxResolvedLinksInLine",e))(P||{});let p=class{constructor(e,i,r,t,l,a){this.xterm=e;this._processManager=i;this._linkResolver=r;this._logService=t;this._uriIdentityService=l;this._workspaceContextService=a}static id="uri";maxLinkLength=2048;async detect(e,i,r){const t=[],l=new U(this.xterm,i,r),a=_.computeLinks(l);let v=0;this._logService.trace("terminalUriLinkDetector#detect computedLinks",a);for(const n of a){const h=W(e,this.xterm.cols,n.range,i),o=n.url?typeof n.url=="string"?y.parse(this._excludeLineAndColSuffix(n.url)):n.url:void 0;if(!o)continue;const d=n.url?.toString()||"";if(d.length>this.maxLinkLength)continue;if(o.scheme!==T.file){t.push({text:d,uri:o,bufferRange:h,type:u.Url});continue}if(o.authority.length!==2&&o.authority.endsWith(":"))continue;const f=[o];o.authority.length>0&&f.push(y.from({...o,authority:void 0})),this._logService.trace("terminalUriLinkDetector#detect uriCandidates",f);for(const k of f){const L=await this._linkResolver.resolveLink(this._processManager,d,k);if(L){let c;L.isDirectory?this._isDirectoryInsideWorkspace(k)?c=u.LocalFolderInWorkspace:c=u.LocalFolderOutsideWorkspace:c=u.LocalFile;const I={text:typeof n.url=="string"?n.url:L.link,uri:k,bufferRange:h,type:c};this._logService.trace("terminalUriLinkDetector#detect verified link",I),t.push(I),v++;break}}if(++v>=10)break}return t}_isDirectoryInsideWorkspace(e){const i=this._workspaceContextService.getWorkspace().folders;for(let r=0;r<i.length;r++)if(this._uriIdentityService.extUri.isEqualOrParent(e,i[r].uri))return!0;return!1}_excludeLineAndColSuffix(e){return e.replace(/:\d+(:\d+)?$/,"")}};p=g([m(3,C),m(4,R),m(5,b)],p);class U{constructor(e,i,r){this._xterm=e;this._lineStart=i;this._lineEnd=r}getLineCount(){return 1}getLineContent(){return B(this._xterm.buffer.active,this._lineStart,this._lineEnd,this._xterm.cols)}}export{p as TerminalUriLinkDetector};
