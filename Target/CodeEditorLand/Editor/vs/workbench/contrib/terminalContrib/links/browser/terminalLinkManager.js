var E=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var F=(u,m,e,i)=>{for(var n=i>1?void 0:i?V(m,e):m,t=u.length-1,r;t>=0;t--)(r=u[t])&&(n=(i?r(m,e,n):r(n))||n);return i&&n&&E(m,e,n),n},L=(u,m)=>(e,i)=>m(e,i,u);import{EventType as z}from"../../../../../base/browser/dom.js";import{RunOnceScheduler as N}from"../../../../../base/common/async.js";import{MarkdownString as U}from"../../../../../base/common/htmlContent.js";import{DisposableStore as Y,dispose as M,toDisposable as j}from"../../../../../base/common/lifecycle.js";import{OS as B,isMacintosh as x}from"../../../../../base/common/platform.js";import{URI as O}from"../../../../../base/common/uri.js";import*as d from"../../../../../nls.js";import{IConfigurationService as K}from"../../../../../platform/configuration/common/configuration.js";import{IInstantiationService as X}from"../../../../../platform/instantiation/common/instantiation.js";import{INotificationService as $,Severity as q}from"../../../../../platform/notification/common/notification.js";import{ITerminalLogService as G}from"../../../../../platform/terminal/common/terminal.js";import{ITunnelService as Q}from"../../../../../platform/tunnel/common/tunnel.js";import{ITerminalConfigurationService as J,TerminalLinkQuickPickEvent as R}from"../../../terminal/browser/terminal.js";import{TerminalHover as Z}from"../../../terminal/browser/widgets/terminalHoverWidget.js";import{TERMINAL_CONFIG_SECTION as ee}from"../../../terminal/common/terminal.js";import{TerminalBuiltinLinkType as p}from"./links.js";import{TerminalExternalLinkDetector as ie}from"./terminalExternalLinkDetector.js";import{TerminalLinkDetectorAdapter as ne}from"./terminalLinkDetectorAdapter.js";import{convertBufferRangeToViewport as te}from"./terminalLinkHelpers.js";import{TerminalLocalFileLinkOpener as re,TerminalLocalFolderInWorkspaceLinkOpener as oe,TerminalLocalFolderOutsideWorkspaceLinkOpener as se,TerminalSearchLinkOpener as ae,TerminalUrlLinkOpener as le}from"./terminalLinkOpeners.js";import{TerminalLocalLinkDetector as S}from"./terminalLocalLinkDetector.js";import{TerminalMultiLineLinkDetector as H}from"./terminalMultiLineLinkDetector.js";import{TerminalUriLinkDetector as D}from"./terminalUriLinkDetector.js";import{TerminalWordLinkDetector as C}from"./terminalWordLinkDetector.js";let b=class extends Y{constructor(e,i,n,t,r,s,o,a,l,h){super();this._xterm=e;this._processInfo=i;this._linkResolver=t;this._configurationService=r;this._terminalConfigurationService=s;this._instantiationService=o;this._notificationService=a;this._logService=l;this._tunnelService=h;let c=!0;switch(this._configurationService.getValue(ee).enableFileLinks){case"off":case!1:c=!1;break;case"notRemote":c=!this._processInfo.remoteAuthority;break}c&&(this._setupLinkDetector(H.id,this._instantiationService.createInstance(H,this._xterm,this._processInfo,this._linkResolver)),this._setupLinkDetector(S.id,this._instantiationService.createInstance(S,this._xterm,n,this._processInfo,this._linkResolver))),this._setupLinkDetector(D.id,this._instantiationService.createInstance(D,this._xterm,this._processInfo,this._linkResolver)),this._setupLinkDetector(C.id,this.add(this._instantiationService.createInstance(C,this._xterm)));const w=this._instantiationService.createInstance(re),_=this._instantiationService.createInstance(oe);this._openers.set(p.LocalFile,w),this._openers.set(p.LocalFolderInWorkspace,_),this._openers.set(p.LocalFolderOutsideWorkspace,this._instantiationService.createInstance(se)),this._openers.set(p.Search,this._instantiationService.createInstance(ae,n,this._processInfo.initialCwd,w,_,()=>this._processInfo.os||B)),this._openers.set(p.Url,this._instantiationService.createInstance(le,!!this._processInfo.remoteAuthority)),this._registerStandardLinkProviders();let I,v;this.add(j(()=>{this._clearLinkProviders(),M(this._externalLinkProviders),I?.dispose(),v?.dispose()})),this._xterm.options.linkHandler={allowNonHttpProtocols:!0,activate:(y,k)=>{if(!this._isLinkActivationModifierDown(y))return;const g=k.indexOf(":");if(g===-1)throw new Error(`Could not find scheme in link "${k}"`);const f=k.substring(0,g);this._terminalConfigurationService.config.allowedLinkSchemes.indexOf(f)===-1&&this._notificationService.prompt(q.Warning,d.localize("scheme","Opening URIs can be insecure, do you want to allow opening links with the scheme {0}?",f),[{label:d.localize("allow","Allow {0}",f),run:()=>{const P=[...this._terminalConfigurationService.config.allowedLinkSchemes,f];this._configurationService.updateValue("terminal.integrated.allowedLinkSchemes",P)}}]),this._openers.get(p.Url)?.open({type:p.Url,text:k,bufferRange:null,uri:O.parse(k)})},hover:(y,k,g)=>{I?.dispose(),I=void 0,v?.dispose(),v=new N(()=>{const f=this._xterm._core,P={width:f._renderService.dimensions.css.cell.width,height:f._renderService.dimensions.css.cell.height},A={width:this._xterm.cols,height:this._xterm.rows};I=this._showHover({viewportRange:te(g,this._xterm.buffer.active.viewportY),cellDimensions:P,terminalDimensions:A},this._getLinkHoverString(k,k),void 0,W=>this._xterm.options.linkHandler?.activate(y,W,g)),v?.dispose(),v=void 0},this._configurationService.getValue("workbench.hover.delay")),v.schedule()}}}_widgetManager;_standardLinkProviders=new Map;_linkProvidersDisposables=[];_externalLinkProviders=[];_openers=new Map;externalProvideLinksCb;_setupLinkDetector(e,i,n=!1){const t=this.add(this._instantiationService.createInstance(ne,i));return this.add(t.onDidActivateLink(r=>{r.event?.preventDefault(),!(r.event&&!(r.event instanceof R)&&!this._isLinkActivationModifierDown(r.event))&&(r.link.activate?r.link.activate(r.link.text):this._openLink(r.link))})),this.add(t.onDidShowHover(r=>this._tooltipCallback(r.link,r.viewportRange,r.modifierDownCallback,r.modifierUpCallback))),n||this._standardLinkProviders.set(e,t),t}async _openLink(e){this._logService.debug("Opening link",e);const i=this._openers.get(e.type);if(!i)throw new Error(`No matching opener for link type "${e.type}"`);await i.open(e)}async openRecentLink(e){let i,n=this._xterm.buffer.active.length;for(;(!i||i.length===0)&&n>=this._xterm.buffer.active.viewportY;)i=await this._getLinksForType(n,e),n--;if(!i||i.length<1)return;const t=new R(z.CLICK);return i[0].activate(t,i[0].text),i[0]}async getLinks(){const e=[];for(let o=this._xterm.buffer.active.viewportY+this._xterm.rows-1;o>=this._xterm.buffer.active.viewportY;o--)e.push(this._getLinksForLine(o));const i=await Promise.all(e),n={wordLinks:[],webLinks:[],fileLinks:[],folderLinks:[]};for(const o of i)if(o){const{wordLinks:a,webLinks:l,fileLinks:h,folderLinks:c}=o;a?.length&&n.wordLinks.push(...a.reverse()),l?.length&&n.webLinks.push(...l.reverse()),h?.length&&n.fileLinks.push(...h.reverse()),c?.length&&n.folderLinks.push(...c.reverse())}const t=[];for(let o=this._xterm.buffer.active.viewportY-1;o>=0;o--)t.push(this._getLinksForLine(o));const r=[];for(let o=this._xterm.buffer.active.length-1;o>=this._xterm.buffer.active.viewportY+this._xterm.rows;o--)r.push(this._getLinksForLine(o));const s=Promise.all(t).then(async o=>{const a=await Promise.all(r),l={wordLinks:[...n.wordLinks],webLinks:[...n.webLinks],fileLinks:[...n.fileLinks],folderLinks:[...n.folderLinks]};for(const h of[...a,...o])if(h){const{wordLinks:c,webLinks:T,fileLinks:w,folderLinks:_}=h;c?.length&&l.wordLinks.push(...c.reverse()),T?.length&&l.webLinks.push(...T.reverse()),w?.length&&l.fileLinks.push(...w.reverse()),_?.length&&l.folderLinks.push(..._.reverse())}return l});return{viewport:n,all:s}}async _getLinksForLine(e){const i=await this._getLinksForType(e,"word"),n=await this._getLinksForType(e,"url"),t=await this._getLinksForType(e,"localFile"),r=await this._getLinksForType(e,"localFolder"),s=new Set;let o;if(i){o=[];for(const a of i)!s.has(a.text)&&a.text.length>1&&(o.push(a),s.add(a.text))}return{wordLinks:o,webLinks:n,fileLinks:t,folderLinks:r}}async _getLinksForType(e,i){switch(i){case"word":return await new Promise(n=>this._standardLinkProviders.get(C.id)?.provideLinks(e,n));case"url":return await new Promise(n=>this._standardLinkProviders.get(D.id)?.provideLinks(e,n));case"localFile":return(await new Promise(t=>this._standardLinkProviders.get(S.id)?.provideLinks(e,t)))?.filter(t=>t.type===p.LocalFile);case"localFolder":return(await new Promise(t=>this._standardLinkProviders.get(S.id)?.provideLinks(e,t)))?.filter(t=>t.type===p.LocalFolderInWorkspace)}}_tooltipCallback(e,i,n,t){if(!this._widgetManager)return;const r=this._xterm._core,s={width:r._renderService.dimensions.css.cell.width,height:r._renderService.dimensions.css.cell.height},o={width:this._xterm.cols,height:this._xterm.rows};this._showHover({viewportRange:i,cellDimensions:s,terminalDimensions:o,modifierDownCallback:n,modifierUpCallback:t},this._getLinkHoverString(e.text,e.label),e.actions,a=>e.activate(void 0,a),e)}_showHover(e,i,n,t,r){if(this._widgetManager){const s=this._instantiationService.createInstance(Z,e,i,n,t),o=this._widgetManager.attachWidget(s);return o&&r?.onInvalidated(()=>o.dispose()),o}}setWidgetManager(e){this._widgetManager=e}_clearLinkProviders(){M(this._linkProvidersDisposables),this._linkProvidersDisposables.length=0}_registerStandardLinkProviders(){const e=async t=>this.externalProvideLinksCb?.(t),i=`extension-${this._externalLinkProviders.length}`,n=this._setupLinkDetector(i,new ie(i,this._xterm,e),!0);this._linkProvidersDisposables.push(this._xterm.registerLinkProvider(n));for(const t of this._standardLinkProviders.values())this._linkProvidersDisposables.push(this._xterm.registerLinkProvider(t))}_isLinkActivationModifierDown(e){return this._configurationService.getValue("editor").multiCursorModifier==="ctrlCmd"?!!e.altKey:x?e.metaKey:e.ctrlKey}_getLinkHoverString(e,i){const n=this._configurationService.getValue("editor");let t="";n.multiCursorModifier==="ctrlCmd"?x?t=d.localize("terminalLinkHandler.followLinkAlt.mac","option + click"):t=d.localize("terminalLinkHandler.followLinkAlt","alt + click"):x?t=d.localize("terminalLinkHandler.followLinkCmd","cmd + click"):t=d.localize("terminalLinkHandler.followLinkCtrl","ctrl + click");let r=d.localize("followLink","Follow link");try{this._tunnelService.canTunnel(O.parse(e))&&(r=d.localize("followForwardedLink","Follow link using forwarded port"))}catch{}const s=new U("",!0);return i&&(i=s.appendText(i).value,s.value=""),e&&(e=s.appendText(e).value,s.value=""),i=i||r,e=e||i,/(\s|&nbsp;)/.test(e)&&(e=d.localize("followLinkUrl","Link")),s.appendLink(e,i).appendMarkdown(` (${t})`)}};b=F([L(4,K),L(5,J),L(6,X),L(7,$),L(8,G),L(9,Q)],b);export{b as TerminalLinkManager};
