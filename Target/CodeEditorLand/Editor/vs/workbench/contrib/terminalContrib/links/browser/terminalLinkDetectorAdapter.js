var x=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var h=(s,o,e,i)=>{for(var t=i>1?void 0:i?w(o,e):o,n=s.length-1,r;n>=0;n--)(r=s[n])&&(t=(i?r(o,e,t):r(t))||t);return i&&t&&x(o,e,t),t},L=(s,o)=>(e,i)=>o(e,i,s);import{Emitter as p}from"../../../../../base/common/event.js";import{Disposable as I}from"../../../../../base/common/lifecycle.js";import{localize as c}from"../../../../../nls.js";import{IInstantiationService as g}from"../../../../../platform/instantiation/common/instantiation.js";import{TerminalBuiltinLinkType as a}from"./links.js";import{TerminalLink as T}from"./terminalLink.js";import"./terminalLinkManager.js";let d=class extends I{constructor(e,i){super();this._detector=e;this._instantiationService=i}_activeLinks;_onDidActivateLink=this._register(new p);onDidActivateLink=this._onDidActivateLink.event;_onDidShowHover=this._register(new p);onDidShowHover=this._onDidShowHover.event;_activeProvideLinkRequests=new Map;async provideLinks(e,i){let t=this._activeProvideLinkRequests.get(e);if(t){await t,i(this._activeLinks);return}if(this._activeLinks)for(const n of this._activeLinks)n.dispose();t=this._provideLinks(e),this._activeProvideLinkRequests.set(e,t),this._activeLinks=await t,this._activeProvideLinkRequests.delete(e),i(this._activeLinks)}async _provideLinks(e){const i=[];let t=e-1,n=t;const r=[this._detector.xterm.buffer.active.getLine(t)],v=Math.max(this._detector.maxLinkLength,this._detector.xterm.cols),l=Math.ceil(v/this._detector.xterm.cols),k=Math.max(t-l,0),f=Math.min(n+l,this._detector.xterm.buffer.active.length);for(;t>=k&&this._detector.xterm.buffer.active.getLine(t)?.isWrapped;)r.unshift(this._detector.xterm.buffer.active.getLine(t-1)),t--;for(;n<f&&this._detector.xterm.buffer.active.getLine(n+1)?.isWrapped;)r.push(this._detector.xterm.buffer.active.getLine(n+1)),n++;const _=await this._detector.detect(r,t,n);for(const m of _)i.push(this._createTerminalLink(m,async u=>this._onDidActivateLink.fire({link:m,event:u})));return i}_createTerminalLink(e,i){return!e.disableTrimColon&&e.text.length>0&&e.text.charAt(e.text.length-1)===":"&&(e.text=e.text.slice(0,-1),e.bufferRange.end.x--),this._instantiationService.createInstance(T,this._detector.xterm,e.bufferRange,e.text,e.uri,e.parsedLink,e.actions,this._detector.xterm.buffer.active.viewportY,i,(t,n,r,v)=>this._onDidShowHover.fire({link:t,viewportRange:n,modifierDownCallback:r,modifierUpCallback:v}),e.type!==a.Search,e.label||this._getLabel(e.type),e.type)}_getLabel(e){switch(e){case a.Search:return c("searchWorkspace","Search workspace");case a.LocalFile:return c("openFile","Open file in editor");case a.LocalFolderInWorkspace:return c("focusFolder","Focus folder in explorer");case a.LocalFolderOutsideWorkspace:return c("openFolder","Open folder in new window");case a.Url:default:return c("followLink","Follow link")}}};d=h([L(1,g)],d);export{d as TerminalLinkDetectorAdapter};
