{
  "version": 3,
  "sources": ["../../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/contrib/terminalContrib/chat/browser/terminalChatWidget.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type { Terminal as RawXtermTerminal } from '@xterm/xterm';\nimport { Dimension, getActiveWindow, IFocusTracker, trackFocus } from '../../../../../base/browser/dom.js';\nimport { Emitter, Event } from '../../../../../base/common/event.js';\nimport { Disposable, toDisposable } from '../../../../../base/common/lifecycle.js';\nimport { MicrotaskDelay } from '../../../../../base/common/symbols.js';\nimport './media/terminalChatWidget.css';\nimport { localize } from '../../../../../nls.js';\nimport { IContextKey, IContextKeyService } from '../../../../../platform/contextkey/common/contextkey.js';\nimport { IInstantiationService } from '../../../../../platform/instantiation/common/instantiation.js';\nimport { ChatAgentLocation } from '../../../chat/common/chatAgents.js';\nimport { InlineChatWidget } from '../../../inlineChat/browser/inlineChatWidget.js';\nimport { ITerminalInstance, type IXtermTerminal } from '../../../terminal/browser/terminal.js';\nimport { MENU_TERMINAL_CHAT_INPUT, MENU_TERMINAL_CHAT_WIDGET, MENU_TERMINAL_CHAT_WIDGET_STATUS, TerminalChatCommandId, TerminalChatContextKeys } from './terminalChat.js';\nimport { TerminalStickyScrollContribution } from '../../stickyScroll/browser/terminalStickyScrollContribution.js';\n\nconst enum Constants {\n\tHorizontalMargin = 10,\n\tVerticalMargin = 30\n}\n\nexport class TerminalChatWidget extends Disposable {\n\n\tprivate readonly _container: HTMLElement;\n\n\tprivate readonly _onDidHide = this._register(new Emitter<void>());\n\treadonly onDidHide = this._onDidHide.event;\n\n\tprivate readonly _inlineChatWidget: InlineChatWidget;\n\tpublic get inlineChatWidget(): InlineChatWidget { return this._inlineChatWidget; }\n\n\tprivate readonly _focusTracker: IFocusTracker;\n\n\tprivate readonly _focusedContextKey: IContextKey<boolean>;\n\tprivate readonly _visibleContextKey: IContextKey<boolean>;\n\n\tconstructor(\n\t\tprivate readonly _terminalElement: HTMLElement,\n\t\tprivate readonly _instance: ITerminalInstance,\n\t\tprivate readonly _xterm: IXtermTerminal & { raw: RawXtermTerminal },\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t\t@IContextKeyService private readonly _contextKeyService: IContextKeyService\n\t) {\n\t\tsuper();\n\n\t\tthis._focusedContextKey = TerminalChatContextKeys.focused.bindTo(this._contextKeyService);\n\t\tthis._visibleContextKey = TerminalChatContextKeys.visible.bindTo(this._contextKeyService);\n\n\t\tthis._container = document.createElement('div');\n\t\tthis._container.classList.add('terminal-inline-chat');\n\t\t_terminalElement.appendChild(this._container);\n\n\t\tthis._inlineChatWidget = this._instantiationService.createInstance(\n\t\t\tInlineChatWidget,\n\t\t\t{\n\t\t\t\tlocation: ChatAgentLocation.Terminal,\n\t\t\t\tresolveData: () => {\n\t\t\t\t\t// TODO@meganrogge return something that identifies this terminal\n\t\t\t\t\treturn undefined;\n\t\t\t\t}\n\t\t\t},\n\t\t\t{\n\t\t\t\tstatusMenuId: {\n\t\t\t\t\tmenu: MENU_TERMINAL_CHAT_WIDGET_STATUS,\n\t\t\t\t\toptions: {\n\t\t\t\t\t\tbuttonConfigProvider: action => {\n\t\t\t\t\t\t\tif (action.id === TerminalChatCommandId.ViewInChat || action.id === TerminalChatCommandId.RunCommand || action.id === TerminalChatCommandId.RunFirstCommand) {\n\t\t\t\t\t\t\t\treturn { isSecondary: false };\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\treturn { isSecondary: true };\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tchatWidgetViewOptions: {\n\t\t\t\t\trendererOptions: { editableCodeBlock: true },\n\t\t\t\t\tmenus: {\n\t\t\t\t\t\ttelemetrySource: 'terminal-inline-chat',\n\t\t\t\t\t\texecuteToolbar: MENU_TERMINAL_CHAT_INPUT,\n\t\t\t\t\t\tinputSideToolbar: MENU_TERMINAL_CHAT_WIDGET,\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t);\n\t\tthis._register(Event.any(\n\t\t\tthis._inlineChatWidget.onDidChangeHeight,\n\t\t\tthis._instance.onDimensionsChanged,\n\t\t\tthis._inlineChatWidget.chatWidget.onDidChangeContentHeight,\n\t\t\tEvent.debounce(this._xterm.raw.onCursorMove, () => void 0, MicrotaskDelay),\n\t\t)(() => this._relayout()));\n\n\t\tconst observer = new ResizeObserver(() => this._relayout());\n\t\tobserver.observe(this._terminalElement);\n\t\tthis._register(toDisposable(() => observer.disconnect()));\n\n\t\tthis._reset();\n\t\tthis._container.appendChild(this._inlineChatWidget.domNode);\n\n\t\tthis._focusTracker = this._register(trackFocus(this._container));\n\t\tthis._register(this._focusTracker.onDidFocus(() => this._focusedContextKey.set(true)));\n\t\tthis._register(this._focusTracker.onDidBlur(() => {\n\t\t\tthis._focusedContextKey.set(false);\n\t\t\tif (!this.inlineChatWidget.responseContent) {\n\t\t\t\tthis.hide();\n\t\t\t}\n\t\t}));\n\n\t\tthis.hide();\n\t}\n\n\tprivate _dimension?: Dimension;\n\n\tprivate _relayout() {\n\t\tif (this._dimension) {\n\t\t\tthis._doLayout(this._inlineChatWidget.contentHeight);\n\t\t}\n\t}\n\n\tprivate _doLayout(heightInPixel: number) {\n\t\tconst xtermElement = this._xterm.raw!.element;\n\t\tif (!xtermElement) {\n\t\t\treturn;\n\t\t}\n\t\tconst style = getActiveWindow().getComputedStyle(xtermElement);\n\t\tconst xtermPadding = parseInt(style.paddingLeft) + parseInt(style.paddingRight);\n\t\tconst width = Math.min(640, xtermElement.clientWidth - 12/* padding */ - 2/* border */ - Constants.HorizontalMargin - xtermPadding);\n\t\tconst terminalWrapperHeight = this._getTerminalWrapperHeight() ?? Number.MAX_SAFE_INTEGER;\n\t\tlet height = Math.min(480, heightInPixel, terminalWrapperHeight);\n\t\tconst top = this._getTop() ?? 0;\n\t\tif (width === 0 || height === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tlet adjustedHeight = undefined;\n\t\tif (height < this._inlineChatWidget.contentHeight) {\n\t\t\tif (height - top > 0) {\n\t\t\t\theight = height - top - Constants.VerticalMargin;\n\t\t\t} else {\n\t\t\t\theight = height - Constants.VerticalMargin;\n\t\t\t\tadjustedHeight = height;\n\t\t\t}\n\t\t}\n\t\tthis._container.style.paddingLeft = style.paddingLeft;\n\t\tthis._dimension = new Dimension(width, height);\n\t\tthis._inlineChatWidget.layout(this._dimension);\n\t\tthis._updateVerticalPosition(adjustedHeight);\n\t}\n\n\tprivate _reset() {\n\t\tthis._inlineChatWidget.placeholder = localize('default.placeholder', \"Ask how to do something in the terminal\");\n\t\tthis._inlineChatWidget.updateInfo(localize('welcome.1', \"AI-generated commands may be incorrect\"));\n\t}\n\n\treveal(): void {\n\t\tthis._doLayout(this._inlineChatWidget.contentHeight);\n\t\tthis._container.classList.remove('hide');\n\t\tthis._visibleContextKey.set(true);\n\t\tthis._inlineChatWidget.focus();\n\t\tthis._instance.scrollToBottom();\n\t}\n\n\tprivate _getTop(): number | undefined {\n\t\tconst font = this._instance.xterm?.getFont();\n\t\tif (!font?.charHeight) {\n\t\t\treturn;\n\t\t}\n\t\tconst terminalWrapperHeight = this._getTerminalWrapperHeight() ?? 0;\n\t\tconst cellHeight = font.charHeight * font.lineHeight;\n\t\tconst topPadding = terminalWrapperHeight - (this._instance.rows * cellHeight);\n\t\tconst cursorY = (this._instance.xterm?.raw.buffer.active.cursorY ?? 0) + 1;\n\t\treturn topPadding + cursorY * cellHeight;\n\t}\n\n\tprivate _updateVerticalPosition(adjustedHeight?: number): void {\n\t\tconst top = this._getTop();\n\t\tif (!top) {\n\t\t\treturn;\n\t\t}\n\t\tthis._container.style.top = `${top}px`;\n\t\tconst widgetHeight = this._inlineChatWidget.contentHeight;\n\t\tconst terminalWrapperHeight = this._getTerminalWrapperHeight();\n\t\tif (!terminalWrapperHeight) {\n\t\t\treturn;\n\t\t}\n\t\tif (top > terminalWrapperHeight - widgetHeight && terminalWrapperHeight - widgetHeight > 0) {\n\t\t\tthis._setTerminalOffset(top - (terminalWrapperHeight - widgetHeight));\n\t\t} else if (adjustedHeight) {\n\t\t\tthis._setTerminalOffset(adjustedHeight);\n\t\t} else {\n\t\t\tthis._setTerminalOffset(undefined);\n\t\t}\n\t}\n\n\tprivate _getTerminalWrapperHeight(): number | undefined {\n\t\treturn this._terminalElement.clientHeight;\n\t}\n\n\thide(): void {\n\t\tthis._container.classList.add('hide');\n\t\tthis._inlineChatWidget.reset();\n\t\tthis._reset();\n\t\tthis._inlineChatWidget.updateToolbar(false);\n\t\tthis._visibleContextKey.set(false);\n\t\tthis._inlineChatWidget.value = '';\n\t\tthis._instance.focus();\n\t\tthis._setTerminalOffset(undefined);\n\t\tthis._onDidHide.fire();\n\t}\n\tprivate _setTerminalOffset(offset: number | undefined) {\n\t\tif (offset === undefined || this._container.classList.contains('hide')) {\n\t\t\tthis._terminalElement.style.position = '';\n\t\t\tthis._terminalElement.style.bottom = '';\n\t\t\tTerminalStickyScrollContribution.get(this._instance)?.hideUnlock();\n\t\t} else {\n\t\t\tthis._terminalElement.style.position = 'relative';\n\t\t\tthis._terminalElement.style.bottom = `${offset}px`;\n\t\t\tTerminalStickyScrollContribution.get(this._instance)?.hideLock();\n\t\t}\n\t}\n\tfocus(): void {\n\t\tthis._inlineChatWidget.focus();\n\t}\n\thasFocus(): boolean {\n\t\treturn this._inlineChatWidget.hasFocus();\n\t}\n\tinput(): string {\n\t\treturn this._inlineChatWidget.value;\n\t}\n\tsetValue(value?: string) {\n\t\tthis._inlineChatWidget.value = value ?? '';\n\t}\n\tacceptCommand(code: string, shouldExecute: boolean): void {\n\t\tthis._instance.runCommand(code, shouldExecute);\n\t\tthis.hide();\n\t}\n\tpublic get focusTracker(): IFocusTracker {\n\t\treturn this._focusTracker;\n\t}\n}\n"],
  "mappings": "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",
  "names": ["Constants"]
}
