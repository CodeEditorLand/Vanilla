var _=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var y=(o,d,i,s)=>{for(var t=s>1?void 0:s?T(d,i):d,r=o.length-1,h;r>=0;r--)(h=o[r])&&(t=(s?h(d,i,t):h(t))||t);return s&&t&&_(d,i,t),t},S=(o,d)=>(i,s)=>d(i,s,o);import*as W from"../../../../../base/browser/dom.js";import{AutoOpenBarrier as x}from"../../../../../base/common/async.js";import{Event as A}from"../../../../../base/common/event.js";import{KeyCode as p}from"../../../../../base/common/keyCodes.js";import{DisposableStore as K,MutableDisposable as O,toDisposable as k}from"../../../../../base/common/lifecycle.js";import{isWindows as V}from"../../../../../base/common/platform.js";import{localize2 as c}from"../../../../../nls.js";import{IConfigurationService as N}from"../../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as a,IContextKeyService as D}from"../../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as E}from"../../../../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as u}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import{IStorageService as R,StorageScope as C,StorageTarget as H}from"../../../../../platform/storage/common/storage.js";import{TerminalLocation as B,TerminalSettingId as M}from"../../../../../platform/terminal/common/terminal.js";import{ShellIntegrationOscPs as X}from"../../../../../platform/terminal/common/xterm/shellIntegrationAddon.js";import"../../../terminal/browser/terminal.js";import{registerActiveInstanceAction as l}from"../../../terminal/browser/terminalActions.js";import{registerTerminalContribution as q}from"../../../terminal/browser/terminalExtensions.js";import"../../../terminal/browser/widgets/widgetManager.js";import{TERMINAL_CONFIG_SECTION as L}from"../../../terminal/common/terminal.js";import{TerminalContextKeys as e}from"../../../terminal/common/terminalContextKey.js";import{parseCompletionsFromShell as J,SuggestAddon as z,VSCodeSuggestOscPt as F}from"./terminalSuggestAddon.js";import{TerminalSuggestCommandId as m}from"../common/terminal.suggest.js";import{terminalSuggestConfigSection as v,TerminalSuggestSettingId as I}from"../common/terminalSuggestConfiguration.js";import"../../../../services/suggest/browser/simpleCompletionItem.js";var U=(d=>(d.CachedPwshCommandsStorageKey="terminal.suggest.pwshCommands",d))(U||{});let n=class extends K{constructor(i,s,t,r,h,b,w){super();this._instance=i;this._contextKeyService=r;this._configurationService=h;this._instantiationService=b;this._storageService=w;if(this.add(k(()=>this._addon?.dispose())),this._terminalSuggestWidgetVisibleContextKey=e.suggestWidgetVisible.bindTo(this._contextKeyService),n._cachedPwshCommands.size===0){const g=this._storageService.get("terminal.suggest.pwshCommands",C.APPLICATION,void 0);if(g!==void 0){const f=JSON.parse(g);for(const P of f)n._cachedPwshCommands.add(P)}}this.add(this._configurationService.onDidChangeConfiguration(g=>{g.affectsConfiguration(I.Enabled)&&this.clearSuggestCache()}))}static ID="terminal.suggest";static get(i){return i.getContribution(n.ID)}_xterm;_addon=new O;_terminalSuggestWidgetContextKeys=new Set(e.suggestWidgetVisible.key);_terminalSuggestWidgetVisibleContextKey;get addon(){return this._addon.value}static _cachedPwshCommands=new Set;xtermReady(i){this._xterm=i.raw,this._configurationService.getValue(v).enabled&&this.add(i.raw.parser.registerOscHandler(X.VSCode,r=>this._handleVSCodeSequence(r)))}_handleVSCodeSequence(i){if(!this._xterm)return!1;const[s,...t]=i.split(";");switch(s){case F.CompletionsPwshCommands:return this._handleCompletionsPwshCommandsSequence(this._xterm,i,s,t)}return!1}async _handleCompletionsPwshCommandsSequence(i,s,t,r){const h=r[0],b=JSON.parse(s.slice(t.length+h.length+2)),w=J(b),g=n._cachedPwshCommands;g.clear();for(const f of w)g.add(f);return this._storageService.store("terminal.suggest.pwshCommands",JSON.stringify(Array.from(g.values())),C.APPLICATION,H.MACHINE),!0}clearSuggestCache(){n._cachedPwshCommands.clear(),this._storageService.remove("terminal.suggest.pwshCommands",C.APPLICATION)}xtermOpen(i){this._configurationService.getValue(v).enabled&&(this.add(A.runAndSubscribe(this._instance.onDidChangeShellType,async()=>{this._loadSuggestAddon(i.raw)})),this.add(this._contextKeyService.onDidChangeContext(r=>{r.affectsSome(this._terminalSuggestWidgetContextKeys)&&this._loadSuggestAddon(i.raw)})),this.add(this._configurationService.onDidChangeConfiguration(r=>{r.affectsConfiguration(M.SendKeybindingsToShell)&&this._loadSuggestAddon(i.raw)})))}_loadSuggestAddon(i){if(this._configurationService.getValue(L).sendKeybindingsToShell||this._instance.shellType!=="pwsh"){this._addon.clear();return}if(this._terminalSuggestWidgetVisibleContextKey){const t=this._addon.value=this._instantiationService.createInstance(z,n._cachedPwshCommands,this._instance.capabilities,this._terminalSuggestWidgetVisibleContextKey);if(i.loadAddon(t),this._instance.target===B.Editor?t.setContainerWithOverflow(i.element):t.setContainerWithOverflow(W.findParentWithClass(i.element,"panel")),t.setScreen(i.element.querySelector(".xterm-screen")),this.add(this._instance.onDidBlur(()=>t.hideSuggestWidget())),this.add(t.onAcceptedCompletion(async r=>{this._instance.focus(),this._instance.sendText(r,!1)})),this.add(this._instance.onWillPaste(()=>t.isPasting=!0)),this.add(this._instance.onDidPaste(()=>{setTimeout(()=>t.isPasting=!1,100)})),!V){let r;this.add(t.onDidRequestCompletions(()=>{r=new x(2e3),this._instance.pauseInputEvents(r)})),this.add(t.onDidReceiveCompletions(()=>{r?.open(),r=void 0}))}}}};n=y([S(3,D),S(4,N),S(5,E),S(6,R)],n),q(n.ID,n),l({id:m.SelectPrevSuggestion,title:c("workbench.action.terminal.selectPrevSuggestion","Select the Previous Suggestion"),f1:!1,precondition:a.and(a.or(e.processSupported,e.terminalHasBeenCreated),e.focus,e.isOpen,e.suggestWidgetVisible),keybinding:{primary:p.UpArrow,weight:u.WorkbenchContrib+1},run:o=>n.get(o)?.addon?.selectPreviousSuggestion()}),l({id:m.SelectPrevPageSuggestion,title:c("workbench.action.terminal.selectPrevPageSuggestion","Select the Previous Page Suggestion"),f1:!1,precondition:a.and(a.or(e.processSupported,e.terminalHasBeenCreated),e.focus,e.isOpen,e.suggestWidgetVisible),keybinding:{primary:p.PageUp,weight:u.WorkbenchContrib+1},run:o=>n.get(o)?.addon?.selectPreviousPageSuggestion()}),l({id:m.SelectNextSuggestion,title:c("workbench.action.terminal.selectNextSuggestion","Select the Next Suggestion"),f1:!1,precondition:a.and(a.or(e.processSupported,e.terminalHasBeenCreated),e.focus,e.isOpen,e.suggestWidgetVisible),keybinding:{primary:p.DownArrow,weight:u.WorkbenchContrib+1},run:o=>n.get(o)?.addon?.selectNextSuggestion()}),l({id:m.SelectNextPageSuggestion,title:c("workbench.action.terminal.selectNextPageSuggestion","Select the Next Page Suggestion"),f1:!1,precondition:a.and(a.or(e.processSupported,e.terminalHasBeenCreated),e.focus,e.isOpen,e.suggestWidgetVisible),keybinding:{primary:p.PageDown,weight:u.WorkbenchContrib+1},run:o=>n.get(o)?.addon?.selectNextPageSuggestion()}),l({id:m.AcceptSelectedSuggestion,title:c("workbench.action.terminal.acceptSelectedSuggestion","Accept Selected Suggestion"),f1:!1,precondition:a.and(a.or(e.processSupported,e.terminalHasBeenCreated),e.focus,e.isOpen,e.suggestWidgetVisible),keybinding:{primary:p.Tab,weight:u.WorkbenchContrib+1},run:o=>n.get(o)?.addon?.acceptSelectedSuggestion()}),l({id:m.AcceptSelectedSuggestionEnter,title:c("workbench.action.terminal.acceptSelectedSuggestionEnter","Accept Selected Suggestion (Enter)"),f1:!1,precondition:a.and(a.or(e.processSupported,e.terminalHasBeenCreated),e.focus,e.isOpen,e.suggestWidgetVisible),keybinding:{primary:p.Enter,weight:u.WorkbenchContrib+1,when:a.notEquals(`config.${I.RunOnEnter}`,"ignore")},run:o=>n.get(o)?.addon?.acceptSelectedSuggestion(void 0,!0)}),l({id:m.HideSuggestWidget,title:c("workbench.action.terminal.hideSuggestWidget","Hide Suggest Widget"),f1:!1,precondition:a.and(a.or(e.processSupported,e.terminalHasBeenCreated),e.focus,e.isOpen,e.suggestWidgetVisible),keybinding:{primary:p.Escape,weight:u.WorkbenchContrib+1},run:o=>n.get(o)?.addon?.hideSuggestWidget()}),l({id:m.ClearSuggestCache,title:c("workbench.action.terminal.clearSuggestCache","Clear Suggest Cache"),f1:!0,run:o=>n.get(o)?.clearSuggestCache()});
