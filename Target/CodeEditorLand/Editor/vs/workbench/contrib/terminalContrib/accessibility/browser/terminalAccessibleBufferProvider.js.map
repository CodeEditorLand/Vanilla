{
  "version": 3,
  "sources": ["../../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/contrib/terminalContrib/accessibility/browser/terminalAccessibleBufferProvider.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Emitter } from \"../../../../../base/common/event.js\";\nimport { Disposable } from \"../../../../../base/common/lifecycle.js\";\nimport { IModelService } from \"../../../../../editor/common/services/model.js\";\nimport {\n\tAccessibleViewProviderId,\n\tAccessibleViewType,\n\ttype IAccessibleViewContentProvider,\n\ttype IAccessibleViewOptions,\n\ttype IAccessibleViewSymbol,\n} from \"../../../../../platform/accessibility/browser/accessibleView.js\";\nimport { IConfigurationService } from \"../../../../../platform/configuration/common/configuration.js\";\nimport { IContextKeyService } from \"../../../../../platform/contextkey/common/contextkey.js\";\nimport {\n\ttype ITerminalCommand,\n\tTerminalCapability,\n} from \"../../../../../platform/terminal/common/capabilities/capabilities.js\";\nimport type { ICurrentPartialCommand } from \"../../../../../platform/terminal/common/capabilities/commandDetection/terminalCommand.js\";\nimport { AccessibilityVerbositySettingId } from \"../../../accessibility/browser/accessibilityConfiguration.js\";\nimport {\n\ttype ITerminalInstance,\n\tITerminalService,\n} from \"../../../terminal/browser/terminal.js\";\nimport { TerminalAccessibilitySettingId } from \"../common/terminalAccessibilityConfiguration.js\";\nimport type { BufferContentTracker } from \"./bufferContentTracker.js\";\n\nexport class TerminalAccessibleBufferProvider\n\textends Disposable\n\timplements IAccessibleViewContentProvider\n{\n\tid = AccessibleViewProviderId.Terminal;\n\toptions: IAccessibleViewOptions = {\n\t\ttype: AccessibleViewType.View,\n\t\tlanguage: \"terminal\",\n\t\tid: AccessibleViewProviderId.Terminal,\n\t};\n\tverbositySettingKey = AccessibilityVerbositySettingId.Terminal;\n\tprivate readonly _onDidRequestClearProvider =\n\t\tnew Emitter<AccessibleViewProviderId>();\n\treadonly onDidRequestClearLastProvider =\n\t\tthis._onDidRequestClearProvider.event;\n\tprivate _focusedInstance: ITerminalInstance | undefined;\n\tconstructor(\n\t\tprivate readonly _instance: Pick<\n\t\t\tITerminalInstance,\n\t\t\t| \"onDidExecuteText\"\n\t\t\t| \"focus\"\n\t\t\t| \"shellType\"\n\t\t\t| \"capabilities\"\n\t\t\t| \"onDidRequestFocus\"\n\t\t\t| \"resource\"\n\t\t\t| \"onDisposed\"\n\t\t>,\n\t\tprivate _bufferTracker: BufferContentTracker,\n\t\tcustomHelp: () => string,\n\t\t@IModelService _modelService: IModelService,\n\t\t@IConfigurationService configurationService: IConfigurationService,\n\t\t@IContextKeyService _contextKeyService: IContextKeyService,\n\t\t@ITerminalService _terminalService: ITerminalService,\n\t) {\n\t\tsuper();\n\t\tthis.options.customHelp = customHelp;\n\t\tthis.options.position = configurationService.getValue(\n\t\t\tTerminalAccessibilitySettingId.AccessibleViewPreserveCursorPosition,\n\t\t)\n\t\t\t? \"initial-bottom\"\n\t\t\t: \"bottom\";\n\t\tthis._register(\n\t\t\tthis._instance.onDisposed(() =>\n\t\t\t\tthis._onDidRequestClearProvider.fire(\n\t\t\t\t\tAccessibleViewProviderId.Terminal,\n\t\t\t\t),\n\t\t\t),\n\t\t);\n\t\tthis._register(\n\t\t\tconfigurationService.onDidChangeConfiguration((e) => {\n\t\t\t\tif (\n\t\t\t\t\te.affectsConfiguration(\n\t\t\t\t\t\tTerminalAccessibilitySettingId.AccessibleViewPreserveCursorPosition,\n\t\t\t\t\t)\n\t\t\t\t) {\n\t\t\t\t\tthis.options.position = configurationService.getValue(\n\t\t\t\t\t\tTerminalAccessibilitySettingId.AccessibleViewPreserveCursorPosition,\n\t\t\t\t\t)\n\t\t\t\t\t\t? \"initial-bottom\"\n\t\t\t\t\t\t: \"bottom\";\n\t\t\t\t}\n\t\t\t}),\n\t\t);\n\t\tthis._focusedInstance = _terminalService.activeInstance;\n\t\tthis._register(\n\t\t\t_terminalService.onDidChangeActiveInstance(() => {\n\t\t\t\tif (\n\t\t\t\t\t_terminalService.activeInstance &&\n\t\t\t\t\tthis._focusedInstance?.instanceId !==\n\t\t\t\t\t\t_terminalService.activeInstance?.instanceId\n\t\t\t\t) {\n\t\t\t\t\tthis._onDidRequestClearProvider.fire(\n\t\t\t\t\t\tAccessibleViewProviderId.Terminal,\n\t\t\t\t\t);\n\t\t\t\t\tthis._focusedInstance = _terminalService.activeInstance;\n\t\t\t\t}\n\t\t\t}),\n\t\t);\n\t}\n\n\tonClose() {\n\t\tthis._instance.focus();\n\t}\n\n\tprovideContent(): string {\n\t\tthis._bufferTracker.update();\n\t\treturn this._bufferTracker.lines.join(\"\\n\");\n\t}\n\n\tgetSymbols(): IAccessibleViewSymbol[] {\n\t\tconst commands = this._getCommandsWithEditorLine() ?? [];\n\t\tconst symbols: IAccessibleViewSymbol[] = [];\n\t\tfor (const command of commands) {\n\t\t\tconst label = command.command.command;\n\t\t\tif (label) {\n\t\t\t\tsymbols.push({\n\t\t\t\t\tlabel,\n\t\t\t\t\tlineNumber: command.lineNumber,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\treturn symbols;\n\t}\n\n\tprivate _getCommandsWithEditorLine(): ICommandWithEditorLine[] | undefined {\n\t\tconst capability = this._instance.capabilities.get(\n\t\t\tTerminalCapability.CommandDetection,\n\t\t);\n\t\tconst commands = capability?.commands;\n\t\tconst currentCommand = capability?.currentCommand;\n\t\tif (!commands?.length) {\n\t\t\treturn;\n\t\t}\n\t\tconst result: ICommandWithEditorLine[] = [];\n\t\tfor (const command of commands) {\n\t\t\tconst lineNumber = this._getEditorLineForCommand(command);\n\t\t\tif (lineNumber === undefined) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tresult.push({ command, lineNumber, exitCode: command.exitCode });\n\t\t}\n\t\tif (currentCommand) {\n\t\t\tconst lineNumber = this._getEditorLineForCommand(currentCommand);\n\t\t\tif (lineNumber !== undefined) {\n\t\t\t\tresult.push({ command: currentCommand, lineNumber });\n\t\t\t}\n\t\t}\n\t\treturn result;\n\t}\n\tprivate _getEditorLineForCommand(\n\t\tcommand: ITerminalCommand | ICurrentPartialCommand,\n\t): number | undefined {\n\t\tlet line: number | undefined;\n\t\tif (\"marker\" in command) {\n\t\t\tline = command.marker?.line;\n\t\t} else if (\"commandStartMarker\" in command) {\n\t\t\tline = command.commandStartMarker?.line;\n\t\t}\n\t\tif (line === undefined || line < 0) {\n\t\t\treturn;\n\t\t}\n\t\tline = this._bufferTracker.bufferToEditorLineMapping.get(line);\n\t\tif (line === undefined) {\n\t\t\treturn;\n\t\t}\n\t\treturn line + 1;\n\t}\n}\nexport interface ICommandWithEditorLine {\n\tcommand: ITerminalCommand | ICurrentPartialCommand;\n\tlineNumber: number;\n\texitCode?: number;\n}\n"],
  "mappings": "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",
  "names": []
}
