{
  "version": 3,
  "sources": ["../../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/contrib/terminalContrib/accessibility/browser/bufferContentTracker.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type { IMarker, Terminal } from \"@xterm/xterm\";\nimport { Disposable } from \"../../../../../base/common/lifecycle.js\";\nimport { IConfigurationService } from \"../../../../../platform/configuration/common/configuration.js\";\nimport {\n\tITerminalLogService,\n\tTerminalSettingId,\n} from \"../../../../../platform/terminal/common/terminal.js\";\nimport type { IXtermTerminal } from \"../../../terminal/browser/terminal.js\";\n\nexport class BufferContentTracker extends Disposable {\n\t/**\n\t * Marks the last part of the buffer that was cached\n\t */\n\tprivate _lastCachedMarker: IMarker | undefined;\n\t/**\n\t * The number of wrapped lines in the viewport when the last cached marker was set\n\t */\n\tprivate _priorEditorViewportLineCount = 0;\n\n\tprivate _lines: string[] = [];\n\tget lines(): string[] {\n\t\treturn this._lines;\n\t}\n\n\tbufferToEditorLineMapping: Map<number, number> = new Map();\n\n\tconstructor(\n\t\tprivate readonly _xterm: Pick<IXtermTerminal, 'getFont'> & { raw: Terminal },\n\t\t@ITerminalLogService private readonly _logService: ITerminalLogService,\n\t\t@IConfigurationService private readonly _configurationService: IConfigurationService) {\n\t\tsuper();\n\t}\n\n\treset(): void {\n\t\tthis._lines = [];\n\t\tthis._lastCachedMarker = undefined;\n\t\tthis.update();\n\t}\n\n\tupdate(): void {\n\t\tif (this._lastCachedMarker?.isDisposed) {\n\t\t\t// the terminal was cleared, reset the cache\n\t\t\tthis._lines = [];\n\t\t\tthis._lastCachedMarker = undefined;\n\t\t}\n\t\tthis._removeViewportContent();\n\t\tthis._updateCachedContent();\n\t\tthis._updateViewportContent();\n\t\tthis._lastCachedMarker = this._register(\n\t\t\tthis._xterm.raw.registerMarker(),\n\t\t);\n\t\tthis._logService.debug(\n\t\t\t\"Buffer content tracker: set \",\n\t\t\tthis._lines.length,\n\t\t\t\" lines\",\n\t\t);\n\t}\n\n\tprivate _updateCachedContent(): void {\n\t\tconst buffer = this._xterm.raw.buffer.active;\n\t\tconst start = this._lastCachedMarker?.line\n\t\t\t? this._lastCachedMarker.line - this._xterm.raw.rows + 1\n\t\t\t: 0;\n\t\tconst end = buffer.baseY;\n\t\tif (start < 0 || start > end) {\n\t\t\t// in the viewport, no need to cache\n\t\t\treturn;\n\t\t}\n\n\t\t// to keep the cache size down, remove any lines that are no longer in the scrollback\n\t\tconst scrollback: number = this._configurationService.getValue(\n\t\t\tTerminalSettingId.Scrollback,\n\t\t);\n\t\tconst maxBufferSize = scrollback + this._xterm.raw.rows - 1;\n\t\tconst linesToAdd = end - start;\n\t\tif (linesToAdd + this._lines.length > maxBufferSize) {\n\t\t\tconst numToRemove = linesToAdd + this._lines.length - maxBufferSize;\n\t\t\tfor (let i = 0; i < numToRemove; i++) {\n\t\t\t\tthis._lines.shift();\n\t\t\t}\n\t\t\tthis._logService.debug(\n\t\t\t\t\"Buffer content tracker: removed \",\n\t\t\t\tnumToRemove,\n\t\t\t\t\" lines from top of cached lines, now \",\n\t\t\t\tthis._lines.length,\n\t\t\t\t\" lines\",\n\t\t\t);\n\t\t}\n\n\t\t// iterate through the buffer lines and add them to the editor line cache\n\t\tconst cachedLines = [];\n\t\tlet currentLine = \"\";\n\t\tfor (let i = start; i < end; i++) {\n\t\t\tconst line = buffer.getLine(i);\n\t\t\tif (!line) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tthis.bufferToEditorLineMapping.set(\n\t\t\t\ti,\n\t\t\t\tthis._lines.length + cachedLines.length,\n\t\t\t);\n\t\t\tconst isWrapped = buffer.getLine(i + 1)?.isWrapped;\n\t\t\tcurrentLine += line.translateToString(!isWrapped);\n\t\t\tif (\n\t\t\t\t(currentLine && !isWrapped) ||\n\t\t\t\ti === buffer.baseY + this._xterm.raw.rows - 1\n\t\t\t) {\n\t\t\t\tif (line.length) {\n\t\t\t\t\tcachedLines.push(currentLine);\n\t\t\t\t\tcurrentLine = \"\";\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tthis._logService.debug(\n\t\t\t\"Buffer content tracker:\",\n\t\t\tcachedLines.length,\n\t\t\t\" lines cached\",\n\t\t);\n\t\tthis._lines.push(...cachedLines);\n\t}\n\n\tprivate _removeViewportContent(): void {\n\t\tif (!this._lines.length) {\n\t\t\treturn;\n\t\t}\n\t\t// remove previous viewport content in case it has changed\n\t\tlet linesToRemove = this._priorEditorViewportLineCount;\n\t\tlet index = 1;\n\t\twhile (linesToRemove) {\n\t\t\tthis.bufferToEditorLineMapping.forEach((value, key) => {\n\t\t\t\tif (value === this._lines.length - index) {\n\t\t\t\t\tthis.bufferToEditorLineMapping.delete(key);\n\t\t\t\t}\n\t\t\t});\n\t\t\tthis._lines.pop();\n\t\t\tindex++;\n\t\t\tlinesToRemove--;\n\t\t}\n\t\tthis._logService.debug(\n\t\t\t\"Buffer content tracker: removed lines from viewport, now \",\n\t\t\tthis._lines.length,\n\t\t\t\" lines cached\",\n\t\t);\n\t}\n\n\tprivate _updateViewportContent(): void {\n\t\tconst buffer = this._xterm.raw.buffer.active;\n\t\tthis._priorEditorViewportLineCount = 0;\n\t\tlet currentLine = \"\";\n\t\tfor (\n\t\t\tlet i = buffer.baseY;\n\t\t\ti < buffer.baseY + this._xterm.raw.rows;\n\t\t\ti++\n\t\t) {\n\t\t\tconst line = buffer.getLine(i);\n\t\t\tif (!line) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tthis.bufferToEditorLineMapping.set(i, this._lines.length);\n\t\t\tconst isWrapped = buffer.getLine(i + 1)?.isWrapped;\n\t\t\tcurrentLine += line.translateToString(!isWrapped);\n\t\t\tif (\n\t\t\t\t(currentLine && !isWrapped) ||\n\t\t\t\ti === buffer.baseY + this._xterm.raw.rows - 1\n\t\t\t) {\n\t\t\t\tif (currentLine.length) {\n\t\t\t\t\tthis._priorEditorViewportLineCount++;\n\t\t\t\t\tthis._lines.push(currentLine);\n\t\t\t\t\tcurrentLine = \"\";\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tthis._logService.debug(\n\t\t\t\"Viewport content update complete, \",\n\t\t\tthis._lines.length,\n\t\t\t\" lines in the viewport\",\n\t\t);\n\t}\n}\n"],
  "mappings": "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",
  "names": []
}
