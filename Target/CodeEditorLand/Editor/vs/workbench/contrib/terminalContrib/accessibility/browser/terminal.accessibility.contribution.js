var H=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var x=(c,r,e,i)=>{for(var n=i>1?void 0:i?q(r,e):r,o=c.length-1,a;o>=0;o--)(a=c[o])&&(n=(i?a(r,e,n):a(n))||n);return i&&n&&H(r,e,n),n},h=(c,r)=>(e,i)=>r(e,i,c);import{KeyCode as u,KeyMod as l}from"../../../../../base/common/keyCodes.js";import{Disposable as N,DisposableStore as K,MutableDisposable as O}from"../../../../../base/common/lifecycle.js";import{localize2 as _}from"../../../../../nls.js";import{CONTEXT_ACCESSIBILITY_MODE_ENABLED as R}from"../../../../../platform/accessibility/common/accessibility.js";import{Action2 as G,registerAction2 as X}from"../../../../../platform/actions/common/actions.js";import{ContextKeyExpr as t,IContextKeyService as U}from"../../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as k}from"../../../../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as T}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import{TerminalCapability as I}from"../../../../../platform/terminal/common/capabilities/capabilities.js";import{AccessibilityHelpAction as Y,AccessibleViewAction as z}from"../../../accessibility/browser/accessibleViewActions.js";import{ITerminalService as P}from"../../../terminal/browser/terminal.js";import{registerTerminalAction as y}from"../../../terminal/browser/terminalActions.js";import{registerTerminalContribution as V}from"../../../terminal/browser/terminalExtensions.js";import"../../../terminal/browser/widgets/widgetManager.js";import"../../../terminal/common/terminal.js";import{TerminalContextKeys as s}from"../../../terminal/common/terminalContextKey.js";import{BufferContentTracker as j}from"./bufferContentTracker.js";import{TerminalAccessibilityHelpProvider as L}from"./terminalAccessibilityHelp.js";import{TextAreaSyncAddon as M}from"./textAreaSyncAddon.js";import{Position as D}from"../../../../../editor/common/core/position.js";import{TerminalAccessibleBufferProvider as J}from"./terminalAccessibleBufferProvider.js";import{IConfigurationService as Q}from"../../../../../platform/configuration/common/configuration.js";import{TerminalSettingId as Z}from"../../../../../platform/terminal/common/terminal.js";import{Event as $}from"../../../../../base/common/event.js";import"../../../../../platform/terminal/common/capabilities/commandDetection/terminalCommand.js";import{AccessibilitySignal as W,IAccessibilitySignalService as ee}from"../../../../../platform/accessibilitySignal/browser/accessibilitySignalService.js";import{TerminalAccessibilitySettingId as E}from"../common/terminalAccessibilityConfiguration.js";import{TerminalAccessibilityCommandId as w}from"../common/terminal.accessibility.js";import{IAccessibleViewService as A,AccessibleViewProviderId as m,NavigationType as B}from"../../../../../platform/accessibility/browser/accessibleView.js";import{accessibleViewCurrentProviderId as f,accessibleViewIsShown as v}from"../../../accessibility/browser/accessibilityConfiguration.js";import{isWindows as ie}from"../../../../../base/common/platform.js";let b=class extends K{constructor(e,i,n,o){super();this._instance=e;this._instantiationService=o}static ID="terminal.textAreaSync";static get(e){return e.getContribution(b.ID)}_addon;layout(e){this._addon||(this._addon=this.add(this._instantiationService.createInstance(M,this._instance.capabilities)),e.raw.loadAddon(this._addon),this._addon.activate(e.raw))}};b=x([h(3,k)],b),V(b.ID,b);let d=class extends N{constructor(e,i,n,o,a,g,p,S,re){super();this._instance=e;this._accessibleViewService=o;this._instantiationService=a;this._terminalService=g;this._configurationService=p;this._contextKeyService=S;this._accessibilitySignalService=re;this._register(z.addImplementation(90,"terminal",()=>this._terminalService.activeInstance!==this._instance?!1:(this.show(),!0),s.focus)),this._register(e.onDidExecuteText(()=>{const C=p.getValue(Z.FocusAfterRun);C==="terminal"?e.focus(!0):C==="accessible-buffer"&&this.show()})),this._register(this._configurationService.onDidChangeConfiguration(C=>{C.affectsConfiguration(E.AccessibleViewFocusOnCommandExecution)&&this._updateCommandExecutedListener()})),this._register(this._instance.capabilities.onDidAddCapability(C=>{C.capability.type===I.CommandDetection&&this._updateCommandExecutedListener()}))}static ID="terminal.accessibleBufferProvider";static get(e){return e.getContribution(d.ID)}_bufferTracker;_bufferProvider;_xterm;_onDidRunCommand=new O;xtermReady(e){const i=this._instantiationService.createInstance(M,this._instance.capabilities);e.raw.loadAddon(i),i.activate(e.raw),this._xterm=e,this._register(this._xterm.raw.onWriteParsed(async()=>{this._terminalService.activeInstance===this._instance&&this._isTerminalAccessibleViewOpen()&&this._xterm.raw.buffer.active.baseY===0&&this.show()}));const n=$.latch(this._xterm.raw.onScroll);this._register(n(()=>{this._terminalService.activeInstance===this._instance&&this._isTerminalAccessibleViewOpen()&&this.show()}))}_updateCommandExecutedListener(){if(!this._instance.capabilities.has(I.CommandDetection))return;if(this._configurationService.getValue(E.AccessibleViewFocusOnCommandExecution)){if(this._onDidRunCommand.value)return}else{this._onDidRunCommand.clear();return}const e=this._instance.capabilities.get(I.CommandDetection);this._onDidRunCommand.value=this._register(e.onCommandExecuted(()=>{this._instance.hasFocus&&this.show()}))}_isTerminalAccessibleViewOpen(){return f.getValue(this._contextKeyService)===m.Terminal}show(){if(!this._xterm)return;this._bufferTracker||(this._bufferTracker=this._register(this._instantiationService.createInstance(j,this._xterm))),this._bufferProvider||(this._bufferProvider=this._register(this._instantiationService.createInstance(J,this._instance,this._bufferTracker,()=>this._register(this._instantiationService.createInstance(L,this._instance,this._xterm)).provideContent())));const e=this._configurationService.getValue(E.AccessibleViewPreserveCursorPosition)?this._accessibleViewService.getPosition(m.Terminal):void 0;this._accessibleViewService.show(this._bufferProvider,e)}navigateToCommand(e){const i=this._accessibleViewService.getPosition(m.Terminal)?.lineNumber,n=this._getCommandsWithEditorLine();if(!n?.length||!i)return;const o=e===B.Previous?n.filter(p=>p.lineNumber<i).sort((p,S)=>S.lineNumber-p.lineNumber):n.filter(p=>p.lineNumber>i).sort((p,S)=>p.lineNumber-S.lineNumber);if(!o.length)return;const a=o[0],g=a.command.command;!ie&&g?(this._accessibleViewService.setPosition(new D(a.lineNumber,1),!0),alert(g)):this._accessibleViewService.setPosition(new D(a.lineNumber,1),!0,!0),a.exitCode?this._accessibilitySignalService.playSignal(W.terminalCommandFailed):this._accessibilitySignalService.playSignal(W.terminalCommandSucceeded)}_getCommandsWithEditorLine(){const e=this._instance.capabilities.get(I.CommandDetection),i=e?.commands,n=e?.currentCommand;if(!i?.length)return;const o=[];for(const a of i){const g=this._getEditorLineForCommand(a);g&&o.push({command:a,lineNumber:g,exitCode:a.exitCode})}if(n){const a=this._getEditorLineForCommand(n);a&&o.push({command:n,lineNumber:a})}return o}_getEditorLineForCommand(e){if(!this._bufferTracker)return;let i;if("marker"in e?i=e.marker?.line:"commandStartMarker"in e&&(i=e.commandStartMarker?.line),!(i===void 0||i<0)&&(i=this._bufferTracker.bufferToEditorLineMapping.get(i),i!==void 0))return i+1}};d=x([h(3,A),h(4,k),h(5,P),h(6,Q),h(7,U),h(8,ee)],d),V(d.ID,d);class F extends N{static ID;constructor(){super(),this._register(Y.addImplementation(105,"terminal",async r=>{const e=r.get(k),i=r.get(P),n=r.get(A),o=await i.getActiveOrCreateInstance();await i.revealActiveTerminal();const a=o?.xterm;a&&n.show(e.createInstance(L,o,a))},t.or(s.focus,t.and(v,t.equals(f.key,m.Terminal)))))}}V(F.ID,F);class te extends G{constructor(){super({id:w.FocusAccessibleBuffer,title:_("workbench.action.terminal.focusAccessibleBuffer","Focus Accessible Terminal View"),precondition:t.or(s.processSupported,s.terminalHasBeenCreated),keybinding:[{primary:l.Alt|u.F2,secondary:[l.CtrlCmd|u.UpArrow],linux:{primary:l.Alt|u.F2|l.Shift,secondary:[l.CtrlCmd|u.UpArrow]},weight:T.WorkbenchContrib,when:t.and(R,s.focus)}]})}async run(r,...e){const n=await r.get(P).getActiveOrCreateInstance();n?.xterm&&d.get(n)?.show()}}X(te),y({id:w.AccessibleBufferGoToNextCommand,title:_("workbench.action.terminal.accessibleBufferGoToNextCommand","Accessible Buffer Go to Next Command"),precondition:t.or(s.processSupported,s.terminalHasBeenCreated,t.and(v,t.equals(f.key,m.Terminal))),keybinding:[{primary:l.Alt|u.DownArrow,when:t.and(t.and(v,t.equals(f.key,m.Terminal))),weight:T.WorkbenchContrib+2}],run:async c=>{const r=await c.service.activeInstance;r&&await d.get(r)?.navigateToCommand(B.Next)}}),y({id:w.AccessibleBufferGoToPreviousCommand,title:_("workbench.action.terminal.accessibleBufferGoToPreviousCommand","Accessible Buffer Go to Previous Command"),precondition:t.and(t.or(s.processSupported,s.terminalHasBeenCreated),t.and(v,t.equals(f.key,m.Terminal))),keybinding:[{primary:l.Alt|u.UpArrow,when:t.and(t.and(v,t.equals(f.key,m.Terminal))),weight:T.WorkbenchContrib+2}],run:async c=>{const r=await c.service.activeInstance;r&&await d.get(r)?.navigateToCommand(B.Previous)}}),y({id:w.ScrollToBottomAccessibleView,title:_("workbench.action.terminal.scrollToBottomAccessibleView","Scroll to Accessible View Bottom"),precondition:t.and(t.or(s.processSupported,s.terminalHasBeenCreated),t.and(v,t.equals(f.key,m.Terminal))),keybinding:{primary:l.CtrlCmd|u.End,linux:{primary:l.Shift|u.End},when:f.isEqualTo(m.Terminal),weight:T.WorkbenchContrib},run:(c,r)=>{const e=r.get(A),i=e.getLastPosition();i&&e.setPosition(i,!0)}}),y({id:w.ScrollToTopAccessibleView,title:_("workbench.action.terminal.scrollToTopAccessibleView","Scroll to Accessible View Top"),precondition:t.and(t.or(s.processSupported,s.terminalHasBeenCreated),t.and(v,t.equals(f.key,m.Terminal))),keybinding:{primary:l.CtrlCmd|u.Home,linux:{primary:l.Shift|u.Home},when:f.isEqualTo(m.Terminal),weight:T.WorkbenchContrib},run:(c,r)=>{r.get(A).setPosition(new D(1,1),!0)}});export{F as TerminalAccessibilityHelpContribution,d as TerminalAccessibleViewContribution};
