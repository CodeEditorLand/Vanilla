var I=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var v=(c,i,r,e)=>{for(var t=e>1?void 0:e?k(i,r):i,a=c.length-1,n;a>=0;a--)(n=c[a])&&(t=(e?n(i,r,t):n(t))||t);return e&&t&&I(i,r,t),t},o=(c,i)=>(r,e)=>i(r,e,c);import*as E from"../../../../../vs/base/common/arrays.js";import{onUnexpectedError as u}from"../../../../../vs/base/common/errors.js";import{joinPath as w}from"../../../../../vs/base/common/resources.js";import"../../../../../vs/base/common/uri.js";import{localize as S}from"../../../../../vs/nls.js";import{ICommandService as W}from"../../../../../vs/platform/commands/common/commands.js";import{IConfigurationService as b}from"../../../../../vs/platform/configuration/common/configuration.js";import{IFileService as R}from"../../../../../vs/platform/files/common/files.js";import{IInstantiationService as C}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{ILogService as O}from"../../../../../vs/platform/log/common/log.js";import{INotificationService as P}from"../../../../../vs/platform/notification/common/notification.js";import{IProductService as x}from"../../../../../vs/platform/product/common/productService.js";import{IStorageService as L,StorageScope as l,StorageTarget as U}from"../../../../../vs/platform/storage/common/storage.js";import{TelemetryLevel as F}from"../../../../../vs/platform/telemetry/common/telemetry.js";import{getTelemetryLevel as T}from"../../../../../vs/platform/telemetry/common/telemetryUtils.js";import{IWorkspaceContextService as V,UNKNOWN_EMPTY_WINDOW_WORKSPACE as D,WorkbenchState as G}from"../../../../../vs/platform/workspace/common/workspace.js";import"../../../../../vs/workbench/common/contributions.js";import{TerminalCommandId as N}from"../../../../../vs/workbench/contrib/terminal/common/terminal.js";import{GettingStartedInput as d,gettingStartedInputTypeId as f}from"../../../../../vs/workbench/contrib/welcomeGettingStarted/browser/gettingStartedInput.js";import{IEditorResolverService as K,RegisteredEditorPriority as B}from"../../../../../vs/workbench/services/editor/common/editorResolverService.js";import{IEditorService as M}from"../../../../../vs/workbench/services/editor/common/editorService.js";import{IWorkbenchEnvironmentService as _}from"../../../../../vs/workbench/services/environment/common/environmentService.js";import{IWorkbenchLayoutService as $}from"../../../../../vs/workbench/services/layout/browser/layoutService.js";import{ILifecycleService as Y,LifecyclePhase as j,StartupKind as z}from"../../../../../vs/workbench/services/lifecycle/common/lifecycle.js";import{IWorkingCopyBackupService as A}from"../../../../../vs/workbench/services/workingCopy/common/workingCopyBackup.js";const h="workbench.welcomePage.restorableWalkthroughs",g="workbench.startupEditor",J="workbench.welcome.enabled",y="workbench.telemetryOptOutShown";let m=class{constructor(i,r){this.instantiationService=i;r.registerEditor(`${d.RESOURCE.scheme}:/**`,{id:d.ID,label:S("welcome.displayName","Welcome Page"),priority:B.builtin},{singlePerResource:!1,canSupportResource:e=>e.scheme===d.RESOURCE.scheme},{createEditorInput:({resource:e,options:t})=>({editor:this.instantiationService.createInstance(d,t),options:{...t,pinned:!1}})})}static ID="workbench.contrib.startupPageEditorResolver"};m=v([o(0,C),o(1,K)],m);let p=class{constructor(i,r,e,t,a,n,s,H,Q,X,Z,ee,re){this.configurationService=i;this.editorService=r;this.workingCopyBackupService=e;this.fileService=t;this.contextService=a;this.lifecycleService=n;this.layoutService=s;this.productService=H;this.commandService=Q;this.environmentService=X;this.storageService=Z;this.logService=ee;this.notificationService=re;this.run().then(void 0,u)}static ID="workbench.contrib.startupPageRunner";async run(){if(await this.lifecycleService.when(j.Restored),this.productService.enableTelemetry&&this.productService.showTelemetryOptOut&&T(this.configurationService)!==F.NONE&&!this.environmentService.skipWelcome&&!this.storageService.get(y,l.PROFILE)){this.storageService.store(y,!0,l.PROFILE,U.USER),await this.openGettingStarted(!0);return}if(this.tryOpenWalkthroughForFolder())return;if(q(this.configurationService,this.contextService,this.environmentService)&&this.lifecycleService.startupKind!==z.ReloadedWindow){if(await this.workingCopyBackupService.hasBackups())return;if(!this.editorService.activeEditor||this.layoutService.openedDefaultEditors){const e=this.configurationService.inspect(g),t=e.value==="readme",a=e.userValue==="readme",n=e.defaultValue==="readme";t&&(!a||!n)&&this.logService.warn(`Warning: 'workbench.startupEditor: readme' setting ignored due to being set somewhere other than user or default settings (user=${e.userValue}, default=${e.defaultValue})`),t&&(a||n)?await this.openReadme():e.value==="welcomePage"||e.value==="welcomePageInEmptyWorkbench"?await this.openGettingStarted():e.value==="terminal"&&this.commandService.executeCommand(N.CreateTerminalEditor)}}}tryOpenWalkthroughForFolder(){const i=this.storageService.get(h,l.PROFILE);if(i){const r=JSON.parse(i),e=this.contextService.getWorkspace();if(r.folder===D.id||r.folder===e.folders[0].uri.toString()){const t={selectedCategory:r.category,selectedStep:r.step,pinned:!1};return this.editorService.openEditor({resource:d.RESOURCE,options:t}),this.storageService.remove(h,l.PROFILE),!0}}else return!1;return!1}async openReadme(){const i=E.coalesce(await Promise.all(this.contextService.getWorkspace().folders.map(async r=>{const e=r.uri,t=await this.fileService.resolve(e).catch(u),a=t?.children?t.children.map(s=>s.name).sort():[],n=a.find(s=>s.toLowerCase()==="readme.md")||a.find(s=>s.toLowerCase().startsWith("readme"));if(n)return w(e,n)})));if(!this.editorService.activeEditor)if(i.length){const r=e=>e.path.toLowerCase().endsWith(".md");await Promise.all([this.commandService.executeCommand("markdown.showPreview",null,i.filter(r),{locked:!0}).catch(e=>{this.notificationService.error(S("startupPage.markdownPreviewError",`Could not open markdown preview: {0}.

Please make sure the markdown extension is enabled.`,e.message))}),this.editorService.openEditors(i.filter(e=>!r(e)).map(e=>({resource:e})))])}else await this.openGettingStarted()}async openGettingStarted(i){const r=f,e=this.editorService.activeEditor;if(e?.typeId===r||this.editorService.editors.some(a=>a.typeId===r))return;const t=e?{pinned:!1,index:0,showTelemetryNotice:i}:{pinned:!1,showTelemetryNotice:i};r===f&&this.editorService.openEditor({resource:d.RESOURCE,options:t})}};p=v([o(0,b),o(1,M),o(2,A),o(3,R),o(4,V),o(5,Y),o(6,$),o(7,x),o(8,W),o(9,_),o(10,L),o(11,O),o(12,P)],p);function q(c,i,r){if(r.skipWelcome)return!1;const e=c.inspect(g);if(!e.userValue&&!e.workspaceValue){const t=c.inspect(J);if(t.value!==void 0&&t.value!==null)return t.value}return e.value==="welcomePage"||e.value==="readme"&&(e.userValue==="readme"||e.defaultValue==="readme")||i.getWorkbenchState()===G.EMPTY&&e.value==="welcomePageInEmptyWorkbench"||e.value==="terminal"}export{m as StartupPageEditorResolverContribution,p as StartupPageRunnerContribution,h as restoreWalkthroughsConfigurationKey};
