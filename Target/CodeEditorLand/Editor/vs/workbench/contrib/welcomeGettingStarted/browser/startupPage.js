var I=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var v=(c,i,r,e)=>{for(var t=e>1?void 0:e?k(i,r):i,a=c.length-1,n;a>=0;a--)(n=c[a])&&(t=(e?n(i,r,t):n(t))||t);return e&&t&&I(i,r,t),t},o=(c,i)=>(r,e)=>i(r,e,c);import{ICommandService as E}from"../../../../platform/commands/common/commands.js";import*as w from"../../../../base/common/arrays.js";import{IInstantiationService as W}from"../../../../platform/instantiation/common/instantiation.js";import{IEditorService as b}from"../../../services/editor/common/editorService.js";import{onUnexpectedError as u}from"../../../../base/common/errors.js";import{IWorkspaceContextService as R,UNKNOWN_EMPTY_WINDOW_WORKSPACE as C,WorkbenchState as O}from"../../../../platform/workspace/common/workspace.js";import{IConfigurationService as P}from"../../../../platform/configuration/common/configuration.js";import{IWorkingCopyBackupService as x}from"../../../services/workingCopy/common/workingCopyBackup.js";import{ILifecycleService as L,LifecyclePhase as U,StartupKind as F}from"../../../services/lifecycle/common/lifecycle.js";import{IFileService as T}from"../../../../platform/files/common/files.js";import{joinPath as V}from"../../../../base/common/resources.js";import{IWorkbenchLayoutService as D}from"../../../services/layout/browser/layoutService.js";import{GettingStartedInput as d,gettingStartedInputTypeId as S}from"./gettingStartedInput.js";import{IWorkbenchEnvironmentService as G}from"../../../services/environment/common/environmentService.js";import{IStorageService as N,StorageScope as l,StorageTarget as K}from"../../../../platform/storage/common/storage.js";import{getTelemetryLevel as B}from"../../../../platform/telemetry/common/telemetryUtils.js";import{TelemetryLevel as M}from"../../../../platform/telemetry/common/telemetry.js";import{IProductService as _}from"../../../../platform/product/common/productService.js";import{ILogService as $}from"../../../../platform/log/common/log.js";import{INotificationService as Y}from"../../../../platform/notification/common/notification.js";import{localize as f}from"../../../../nls.js";import{IEditorResolverService as j,RegisteredEditorPriority as z}from"../../../services/editor/common/editorResolverService.js";import{TerminalCommandId as A}from"../../terminal/common/terminal.js";const h="workbench.welcomePage.restorableWalkthroughs",g="workbench.startupEditor",J="workbench.welcome.enabled",y="workbench.telemetryOptOutShown";let m=class{constructor(i,r){this.instantiationService=i;r.registerEditor(`${d.RESOURCE.scheme}:/**`,{id:d.ID,label:f("welcome.displayName","Welcome Page"),priority:z.builtin},{singlePerResource:!1,canSupportResource:e=>e.scheme===d.RESOURCE.scheme},{createEditorInput:({resource:e,options:t})=>({editor:this.instantiationService.createInstance(d,t),options:{...t,pinned:!1}})})}static ID="workbench.contrib.startupPageEditorResolver"};m=v([o(0,W),o(1,j)],m);let p=class{constructor(i,r,e,t,a,n,s,H,Q,X,Z,ee,re){this.configurationService=i;this.editorService=r;this.workingCopyBackupService=e;this.fileService=t;this.contextService=a;this.lifecycleService=n;this.layoutService=s;this.productService=H;this.commandService=Q;this.environmentService=X;this.storageService=Z;this.logService=ee;this.notificationService=re;this.run().then(void 0,u)}static ID="workbench.contrib.startupPageRunner";async run(){if(await this.lifecycleService.when(U.Restored),this.productService.enableTelemetry&&this.productService.showTelemetryOptOut&&B(this.configurationService)!==M.NONE&&!this.environmentService.skipWelcome&&!this.storageService.get(y,l.PROFILE)){this.storageService.store(y,!0,l.PROFILE,K.USER),await this.openGettingStarted(!0);return}if(this.tryOpenWalkthroughForFolder())return;if(q(this.configurationService,this.contextService,this.environmentService)&&this.lifecycleService.startupKind!==F.ReloadedWindow){if(await this.workingCopyBackupService.hasBackups())return;if(!this.editorService.activeEditor||this.layoutService.openedDefaultEditors){const e=this.configurationService.inspect(g),t=e.value==="readme",a=e.userValue==="readme",n=e.defaultValue==="readme";t&&(!a||!n)&&this.logService.warn(`Warning: 'workbench.startupEditor: readme' setting ignored due to being set somewhere other than user or default settings (user=${e.userValue}, default=${e.defaultValue})`),t&&(a||n)?await this.openReadme():e.value==="welcomePage"||e.value==="welcomePageInEmptyWorkbench"?await this.openGettingStarted():e.value==="terminal"&&this.commandService.executeCommand(A.CreateTerminalEditor)}}}tryOpenWalkthroughForFolder(){const i=this.storageService.get(h,l.PROFILE);if(i){const r=JSON.parse(i),e=this.contextService.getWorkspace();if(r.folder===C.id||r.folder===e.folders[0].uri.toString()){const t={selectedCategory:r.category,selectedStep:r.step,pinned:!1};return this.editorService.openEditor({resource:d.RESOURCE,options:t}),this.storageService.remove(h,l.PROFILE),!0}}else return!1;return!1}async openReadme(){const i=w.coalesce(await Promise.all(this.contextService.getWorkspace().folders.map(async r=>{const e=r.uri,t=await this.fileService.resolve(e).catch(u),a=t?.children?t.children.map(s=>s.name).sort():[],n=a.find(s=>s.toLowerCase()==="readme.md")||a.find(s=>s.toLowerCase().startsWith("readme"));if(n)return V(e,n)})));if(!this.editorService.activeEditor)if(i.length){const r=e=>e.path.toLowerCase().endsWith(".md");await Promise.all([this.commandService.executeCommand("markdown.showPreview",null,i.filter(r),{locked:!0}).catch(e=>{this.notificationService.error(f("startupPage.markdownPreviewError",`Could not open markdown preview: {0}.

Please make sure the markdown extension is enabled.`,e.message))}),this.editorService.openEditors(i.filter(e=>!r(e)).map(e=>({resource:e})))])}else await this.openGettingStarted()}async openGettingStarted(i){const r=S,e=this.editorService.activeEditor;if(e?.typeId===r||this.editorService.editors.some(a=>a.typeId===r))return;const t=e?{pinned:!1,index:0,showTelemetryNotice:i}:{pinned:!1,showTelemetryNotice:i};r===S&&this.editorService.openEditor({resource:d.RESOURCE,options:t})}};p=v([o(0,P),o(1,b),o(2,x),o(3,T),o(4,R),o(5,L),o(6,D),o(7,_),o(8,E),o(9,G),o(10,N),o(11,$),o(12,Y)],p);function q(c,i,r){if(r.skipWelcome)return!1;const e=c.inspect(g);if(!e.userValue&&!e.workspaceValue){const t=c.inspect(J);if(t.value!==void 0&&t.value!==null)return t.value}return e.value==="welcomePage"||e.value==="readme"&&(e.userValue==="readme"||e.defaultValue==="readme")||i.getWorkbenchState()===O.EMPTY&&e.value==="welcomePageInEmptyWorkbench"||e.value==="terminal"}export{m as StartupPageEditorResolverContribution,p as StartupPageRunnerContribution,h as restoreWalkthroughsConfigurationKey};
