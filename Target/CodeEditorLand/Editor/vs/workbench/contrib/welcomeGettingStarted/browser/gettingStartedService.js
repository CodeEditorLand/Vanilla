var $=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var A=(n,a,e,t)=>{for(var i=t>1?void 0:t?z(a,e):a,r=n.length-1,l;r>=0;r--)(l=n[r])&&(i=(t?l(a,e,i):l(i))||i);return t&&i&&$(a,e,i),i},g=(n,a)=>(e,t)=>a(e,t,n);import{coalesce as V}from"../../../../base/common/arrays.js";import{CancellationTokenSource as H}from"../../../../base/common/cancellation.js";import{Emitter as C}from"../../../../base/common/event.js";import{Disposable as J}from"../../../../base/common/lifecycle.js";import{parseLinkedText as j}from"../../../../base/common/linkedText.js";import{FileAccess as u}from"../../../../base/common/network.js";import{dirname as X}from"../../../../base/common/path.js";import{joinPath as R}from"../../../../base/common/resources.js";import{URI as b}from"../../../../base/common/uri.js";import{localize as q,localize2 as L}from"../../../../nls.js";import{Action2 as Q,registerAction2 as Y}from"../../../../platform/actions/common/actions.js";import{ICommandService as Z}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as ee}from"../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as p,IContextKeyService as te,RawContextKey as ie}from"../../../../platform/contextkey/common/contextkey.js";import{EXTENSION_INSTALL_DEP_PACK_CONTEXT as re,EXTENSION_INSTALL_SKIP_WALKTHROUGH_CONTEXT as oe,IExtensionManagementService as ne}from"../../../../platform/extensionManagement/common/extensionManagement.js";import{InstantiationType as se,registerSingleton as ae}from"../../../../platform/instantiation/common/extensions.js";import{IInstantiationService as he,createDecorator as le}from"../../../../platform/instantiation/common/instantiation.js";import{IStorageService as P,StorageScope as v,StorageTarget as k}from"../../../../platform/storage/common/storage.js";import{ITelemetryService as ge}from"../../../../platform/telemetry/common/telemetry.js";import{IUserDataSyncEnablementService as de}from"../../../../platform/userDataSync/common/userDataSync.js";import{IWorkspaceContextService as ce}from"../../../../platform/workspace/common/workspace.js";import{Memento as N}from"../../../common/memento.js";import{IWorkbenchAssignmentService as pe}from"../../../services/assignment/common/assignmentService.js";import{DefaultIconPath as me}from"../../../services/extensionManagement/common/extensionManagement.js";import{checkGlobFileExists as ue}from"../../../services/extensions/common/workspaceContains.js";import{IHostService as ve}from"../../../services/host/browser/host.js";import{IViewsService as Se}from"../../../services/views/common/viewsService.js";import{walkthroughs as K}from"../common/gettingStartedContent.js";import{walkthroughsExtensionPoint as fe}from"./gettingStartedExtensionPoint.js";const ke=new ie("hasMultipleNewFileEntries",!1),B=le("walkthroughsService"),ye="workbench.welcomePage.hiddenCategories",D="workbench.welcomePage.walkthroughMetadata",Ie=q("builtin","Built-In"),we=24*60*60*1e3,T=7*we;let I=class extends J{constructor(e,t,i,r,l,c,o,d,h,S,m,f){super();this.storageService=e;this.commandService=t;this.instantiationService=i;this.workspaceContextService=r;this.contextService=l;this.userDataSyncEnablementService=c;this.configurationService=o;this.extensionManagementService=d;this.hostService=h;this.viewsService=S;this.telemetryService=m;this.tasExperimentService=f;this.metadata=new Map(JSON.parse(this.storageService.get(D,v.PROFILE,"[]"))),this.memento=new N("gettingStartedService",this.storageService),this.stepProgress=this.memento.getMemento(v.PROFILE,k.USER),this.initCompletionEventListeners(),ke.bindTo(this.contextService).set(!1),this.registerWalkthroughs()}_onDidAddWalkthrough=new C;onDidAddWalkthrough=this._onDidAddWalkthrough.event;_onDidRemoveWalkthrough=new C;onDidRemoveWalkthrough=this._onDidRemoveWalkthrough.event;_onDidChangeWalkthrough=new C;onDidChangeWalkthrough=this._onDidChangeWalkthrough.event;_onDidProgressStep=new C;onDidProgressStep=this._onDidProgressStep.event;memento;stepProgress;sessionEvents=new Set;completionListeners=new Map;gettingStartedContributions=new Map;steps=new Map;sessionInstalledExtensions=new Set;categoryVisibilityContextKeys=new Set;stepCompletionContextKeyExpressions=new Set;stepCompletionContextKeys=new Set;metadata;registerWalkthroughs(){K.forEach(async(e,t)=>{this._registerWalkthrough({...e,icon:{type:"icon",icon:e.icon},order:K.length-t,source:Ie,when:p.deserialize(e.when)??p.true(),steps:e.content.steps.map((i,r)=>({...i,completionEvents:i.completionEvents??[],description:U(i.description),category:e.id,order:r,when:p.deserialize(i.when)??p.true(),media:i.media.type==="image"?{type:"image",altText:i.media.altText,path:Ee(i.media.path)}:i.media.type==="svg"?{type:"svg",altText:i.media.altText,path:G(i.media.path).with({query:JSON.stringify({moduleId:"../common/media/"+i.media.path+".js"})})}:{type:"markdown",path:G(i.media.path).with({query:JSON.stringify({moduleId:"../common/media/"+i.media.path+".js"})}),base:u.asFileUri("vs/workbench/contrib/welcomeGettingStarted/common/media/"),root:u.asFileUri("vs/workbench/contrib/welcomeGettingStarted/common/media/")}}))})}),fe.setHandler((e,{added:t,removed:i})=>{t.map(r=>this.registerExtensionWalkthroughContributions(r.description)),i.map(r=>this.unregisterExtensionWalkthroughContributions(r.description))})}initCompletionEventListeners(){this._register(this.commandService.onDidExecuteCommand(e=>this.progressByEvent(`onCommand:${e.commandId}`))),this.extensionManagementService.getInstalled().then(e=>{e.forEach(t=>this.progressByEvent(`extensionInstalled:${t.identifier.id.toLowerCase()}`))}),this._register(this.extensionManagementService.onDidInstallExtensions(e=>{for(const t of e)t?.context?.[oe]||t?.context?.[re]||this.sessionInstalledExtensions.add(t.identifier.id.toLowerCase()),this.progressByEvent(`extensionInstalled:${t.identifier.id.toLowerCase()}`)})),this._register(this.contextService.onDidChangeContext(e=>{e.affectsSome(this.stepCompletionContextKeys)&&this.stepCompletionContextKeyExpressions.forEach(t=>{e.affectsSome(new Set(t.keys()))&&this.contextService.contextMatchesRules(t)&&this.progressByEvent("onContext:"+t.serialize())})})),this._register(this.viewsService.onDidChangeViewVisibility(e=>{e.visible&&this.progressByEvent("onView:"+e.id)})),this._register(this.configurationService.onDidChangeConfiguration(e=>{e.affectedKeys.forEach(t=>{this.progressByEvent("onSettingChanged:"+t)})})),this.userDataSyncEnablementService.isEnabled()&&this.progressByEvent("onEvent:sync-enabled"),this._register(this.userDataSyncEnablementService.onDidChangeEnablement(()=>{this.userDataSyncEnablementService.isEnabled()&&this.progressByEvent("onEvent:sync-enabled")}))}markWalkthroughOpened(e){const t=this.gettingStartedContributions.get(e),i=this.metadata.get(e);i&&t&&this.metadata.set(e,{...i,manaullyOpened:!0,stepIDs:t.steps.map(r=>r.id)}),this.storageService.store(D,JSON.stringify([...this.metadata.entries()]),v.PROFILE,k.USER)}async registerExtensionWalkthroughContributions(e){const t=o=>o.startsWith("https://")?b.parse(o,!0):u.uriToFileUri(R(e.extensionLocation,o)),i=o=>{const d=h=>h.startsWith("https://")?b.parse(h,!0):u.uriToBrowserUri(R(e.extensionLocation,h));if(typeof o=="string"){const h=d(o);return{hcDark:h,hcLight:h,dark:h,light:h}}else return{hcDark:d(o.hc),hcLight:d(o.hcLight??o.light),light:d(o.light),dark:d(o.dark)}};if(!e.contributes?.walkthroughs?.length)return;let r,l=Math.min();await Promise.all(e.contributes?.walkthroughs?.map(async(o,d)=>{const h=e.identifier.value+"#"+o.id,S=!this.metadata.get(h);S&&this.metadata.set(h,{firstSeen:+new Date,stepIDs:o.steps?.map(s=>s.id)??[],manaullyOpened:!1});const m=await Promise.race([this.tasExperimentService?.getTreatment(`gettingStarted.overrideCategory.${e.identifier.value+"."+o.id}.when`),new Promise(s=>setTimeout(()=>s(o.when),5e3))]);this.sessionInstalledExtensions.has(e.identifier.value.toLowerCase())&&this.contextService.contextMatchesRules(p.deserialize(m??o.when)??p.true())&&(this.sessionInstalledExtensions.delete(e.identifier.value.toLowerCase()),d<l&&S&&(r=h,l=d));const f=(o.steps??[]).map((s,E)=>{const y=U(s.description||""),F=e.identifier.value+"#"+o.id+"#"+s.id;let W;if(!s.media)throw Error("missing media in walkthrough step: "+o.id+"@"+s.id);if(s.media.image){const x=s.media.altText;W={type:"image",altText:x,path:i(s.media.image)}}else if(s.media.markdown)W={type:"markdown",path:t(s.media.markdown),base:t(X(s.media.markdown)),root:u.uriToFileUri(e.extensionLocation)};else if(s.media.svg)W={type:"svg",path:t(s.media.svg),altText:s.media.svg};else throw new Error("Unknown walkthrough format detected for "+F);return{description:y,media:W,completionEvents:s.completionEvents?.filter(x=>typeof x=="string")??[],id:F,title:s.title,when:p.deserialize(s.when)??p.true(),category:h,order:E}});let O=!1;if(o.featuredFor){const s=this.workspaceContextService.getWorkspace().folders.map(y=>y.uri),E=new H;setTimeout(()=>E.cancel(),2e3),O=await this.instantiationService.invokeFunction(y=>ue(y,s,o.featuredFor,E.token))}const _=o.icon??e.icon,M={description:o.description,title:o.title,id:h,isFeatured:O,source:e.displayName??e.name,order:0,steps:f,icon:{type:"image",path:_?u.uriToBrowserUri(R(e.extensionLocation,_)).toString(!0):me},when:p.deserialize(m??o.when)??p.true()};this._registerWalkthrough(M),this._onDidAddWalkthrough.fire(this.resolveWalkthrough(M))})),this.storageService.store(D,JSON.stringify([...this.metadata.entries()]),v.PROFILE,k.USER),await this.hostService.hadLastFocus()&&r&&this.configurationService.getValue("workbench.welcomePage.walkthroughs.openOnInstall")&&(this.telemetryService.publicLog2("gettingStarted.didAutoOpenWalkthrough",{id:r}),this.commandService.executeCommand("workbench.action.openWalkthrough",r,!0))}unregisterExtensionWalkthroughContributions(e){e.contributes?.walkthroughs?.length&&e.contributes?.walkthroughs?.forEach(t=>{const i=e.identifier.value+"#"+t.id;t.steps.forEach(r=>{const l=e.identifier.value+"#"+t.id+"#"+r.id;this.steps.delete(l)}),this.gettingStartedContributions.delete(i),this._onDidRemoveWalkthrough.fire(i)})}getWalkthrough(e){const t=this.gettingStartedContributions.get(e);if(!t)throw Error("Trying to get unknown walkthrough: "+e);return this.resolveWalkthrough(t)}getWalkthroughs(){return[...this.gettingStartedContributions.values()].map(i=>({...i,content:{type:"steps",steps:i.steps}})).filter(i=>i.content.type!=="steps"||i.content.steps.length).map(i=>this.resolveWalkthrough(i))}resolveWalkthrough(e){const t=e.steps.map(m=>this.getStepProgress(m)),i=this.metadata.get(e.id)?.manaullyOpened,r=this.metadata.get(e.id)?.firstSeen,l=r&&r>+new Date-T,c=this.metadata.get(e.id)?.stepIDs,o=this.gettingStartedContributions.get(e.id);if(!o)throw Error("Could not find walkthrough with id "+e.id);const d=o.steps.map(m=>m.id),h=c&&(d.length!==c.length||d.some((m,f)=>m!==c[f]));let S=0;if(r){const f=+new Date-r;S=Math.max(0,(T-f)/T)}return{...e,recencyBonus:S,steps:t,newItems:!!h,newEntry:!!(l&&!i)}}getStepProgress(e){return{...e,done:!1,...this.stepProgress[e.id]}}progressStep(e){const t=this.stepProgress[e];if(!t||t.done!==!0){this.stepProgress[e]={done:!0},this.memento.saveMemento();const i=this.getStep(e);if(!i)throw Error("Tried to progress unknown step");this._onDidProgressStep.fire(this.getStepProgress(i))}}deprogressStep(e){delete this.stepProgress[e],this.memento.saveMemento();const t=this.getStep(e);this._onDidProgressStep.fire(this.getStepProgress(t))}progressByEvent(e){this.sessionEvents.has(e)||(this.sessionEvents.add(e),this.completionListeners.get(e)?.forEach(t=>this.progressStep(t)))}registerWalkthrough(e){this._registerWalkthrough({...e,steps:e.steps.map(t=>({...t,description:U(t.description)}))})}_registerWalkthrough(e){this.gettingStartedContributions.get(e.id)||(this.gettingStartedContributions.set(e.id,e),e.steps.forEach(i=>{if(this.steps.has(i.id))throw Error("Attempting to register step with id "+i.id+" twice. Second is dropped.");this.steps.set(i.id,i),i.when.keys().forEach(r=>this.categoryVisibilityContextKeys.add(r)),this.registerDoneListeners(i)}),e.when.keys().forEach(i=>this.categoryVisibilityContextKeys.add(i)))}registerDoneListeners(e){if(!e.doneOn){e.completionEvents.length||(e.completionEvents=V(e.description.filter(t=>t.nodes.length===1).flatMap(t=>t.nodes.filter(i=>typeof i!="string").map(({href:i})=>{if(i.startsWith("command:"))return"onCommand:"+i.slice(8,i.includes("?")?i.indexOf("?"):void 0);if(i.startsWith("https://")||i.startsWith("http://"))return"onLink:"+i})))),e.completionEvents.length||e.completionEvents.push("stepSelected");for(let t of e.completionEvents){const[i,r,l]=/^([^:]*):?(.*)$/.exec(t)??[];if(r){switch(r){case"onLink":case"onEvent":case"onView":case"onSettingChanged":break;case"onContext":{const c=p.deserialize(l);c&&(this.stepCompletionContextKeyExpressions.add(c),c.keys().forEach(o=>this.stepCompletionContextKeys.add(o)),t=r+":"+c.serialize(),this.contextService.contextMatchesRules(c)&&this.sessionEvents.add(t));break}case"onStepSelected":case"stepSelected":t="stepSelected:"+e.id;break;case"onCommand":t=r+":"+l.replace(/^toSide:/,"");break;case"onExtensionInstalled":case"extensionInstalled":t="extensionInstalled:"+l.toLowerCase();break;default:continue}this.registerCompletionListener(t,e)}}}}registerCompletionListener(e,t){this.completionListeners.has(e)||this.completionListeners.set(e,new Set),this.completionListeners.get(e)?.add(t.id)}getStep(e){const t=this.steps.get(e);if(!t)throw Error("Attempting to access step which does not exist in registry "+e);return t}};I=A([g(0,P),g(1,Z),g(2,he),g(3,ce),g(4,te),g(5,de),g(6,ee),g(7,ne),g(8,ve),g(9,Se),g(10,ge),g(11,pe)],I);const U=n=>n.split(`
`).filter(a=>a).map(a=>j(a)),G=n=>n.startsWith("https://")?b.parse(n,!0):u.asFileUri(`vs/workbench/contrib/welcomeGettingStarted/common/media/${n}`),w=n=>n.startsWith("https://")?b.parse(n,!0):u.asBrowserUri(`vs/workbench/contrib/welcomeGettingStarted/common/media/${n}`),Ee=n=>{if(typeof n=="string"){const a=w(n);return{hcDark:a,hcLight:a,dark:a,light:a}}else return{hcDark:w(n.hc),hcLight:w(n.hcLight??n.light),light:w(n.light),dark:w(n.dark)}};Y(class extends Q{constructor(){super({id:"resetGettingStartedProgress",category:L("developer","Developer"),title:L("resetWelcomePageWalkthroughProgress","Reset Welcome Page Walkthrough Progress"),f1:!0,metadata:{description:L("resetGettingStartedProgressDescription","Reset the progress of all Walkthrough steps on the Welcome Page to make them appear as if they are being viewed for the first time, providing a fresh start to the getting started experience.")}})}run(n){const a=n.get(B),e=n.get(P);e.store(ye,JSON.stringify([]),v.PROFILE,k.USER),e.store(D,JSON.stringify([]),v.PROFILE,k.USER);const t=new N("gettingStartedService",n.get(P)),i=t.getMemento(v.PROFILE,k.USER);for(const r in i)if(Object.prototype.hasOwnProperty.call(i,r))try{a.deprogressStep(r)}catch{}t.saveMemento()}}),ae(B,I,se.Delayed);export{ke as HasMultipleNewFileEntries,B as IWalkthroughsService,I as WalkthroughsService,G as convertInternalMediaPathToFileURI,ye as hiddenEntriesConfigurationKey,U as parseDescription,D as walkthroughMetadataConfigurationKey};
