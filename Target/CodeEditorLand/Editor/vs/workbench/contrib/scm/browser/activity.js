var B=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var R=(p,d,e,t)=>{for(var i=t>1?void 0:t?A(d,e):d,s=p.length-1,o;s>=0;s--)(o=p[s])&&(i=(t?o(d,e,i):o(i))||i);return t&&i&&B(d,e,i),i},n=(p,d)=>(e,t)=>d(e,t,p);import{Emitter as N,Event as f}from"../../../../base/common/event.js";import{Iterable as w}from"../../../../base/common/iterator.js";import{Disposable as _}from"../../../../base/common/lifecycle.js";import{autorun as D,autorunWithStore as S,derived as C,observableFromEvent as I}from"../../../../base/common/observable.js";import{basename as G}from"../../../../base/common/resources.js";import"../../../../editor/common/languages.js";import{localize as y}from"../../../../nls.js";import{IConfigurationService as V}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as H,RawContextKey as m}from"../../../../platform/contextkey/common/contextkey.js";import{observableConfigValue as P}from"../../../../platform/observable/common/platformObservableUtils.js";import{IUriIdentityService as T}from"../../../../platform/uriIdentity/common/uriIdentity.js";import"../../../common/contributions.js";import{EditorResourceAccessor as x}from"../../../common/editor.js";import"../../../common/editor/editorInput.js";import{IActivityService as U,NumberBadge as $}from"../../../services/activity/common/activity.js";import{IEditorGroupsService as W}from"../../../services/editor/common/editorGroupsService.js";import{IStatusbarService as k,StatusbarAlignment as b}from"../../../services/statusbar/browser/statusbar.js";import{ITitleService as O}from"../../../services/title/browser/titleService.js";import{ISCMService as K,ISCMViewService as L,VIEW_PANE_ID as F}from"../common/scm.js";import{getRepositoryResourceCount as M}from"./util.js";const h={ActiveRepositoryName:new m("scmActiveRepositoryName",""),ActiveRepositoryBranchName:new m("scmActiveRepositoryBranchName","")};let g=class extends _{constructor(e,t,i,s,o,c,u){super();this.activityService=e;this.configurationService=t;this.contextKeyService=i;this.scmService=s;this.scmViewService=o;this.statusbarService=c;this.titleService=u;this._activeRepositoryNameContextKey=h.ActiveRepositoryName.bindTo(this.contextKeyService),this._activeRepositoryBranchNameContextKey=h.ActiveRepositoryBranchName.bindTo(this.contextKeyService),this.titleService.registerVariables([{name:"activeRepositoryName",contextKey:h.ActiveRepositoryName.key},{name:"activeRepositoryBranchName",contextKey:h.ActiveRepositoryBranchName.key}]),this._register(S((r,a)=>{this._updateActivityCountBadge(this._countBadge.read(r),a)})),this._register(S((r,a)=>{const v=this.scmViewService.activeRepository.read(r),E=v?.provider.statusBarCommands.read(r);this._updateStatusBar(v,E??[],a)})),this._register(D(r=>{const a=this.scmViewService.activeRepository.read(r),v=this._activeRepositoryCurrentHistoryItemGroupName.read(r);this._updateActiveRepositoryContextKeys(a?.provider.name,v)}))}_countBadgeConfig=P("scm.countBadge","all",this.configurationService);_repositories=I(this,f.any(this.scmService.onDidAddRepository,this.scmService.onDidRemoveRepository),()=>this.scmService.repositories);_activeRepositoryCurrentHistoryItemGroupName=C(e=>this.scmViewService.activeRepository.read(e)?.provider.historyProvider.read(e)?.currentHistoryItemGroup.read(e)?.name);_countBadgeRepositories=C(this,e=>{switch(this._countBadgeConfig.read(e)){case"all":{const t=this._repositories.read(e);return[...w.map(t,i=>({provider:i.provider,resourceCount:this._getRepositoryResourceCount(i)}))]}case"focused":{const t=this.scmViewService.activeRepository.read(e);return t?[{provider:t.provider,resourceCount:this._getRepositoryResourceCount(t)}]:[]}case"off":return[];default:throw new Error("Invalid countBadge setting")}});_countBadge=C(this,e=>{let t=0;for(const i of this._countBadgeRepositories.read(e)){const s=i.provider.count?.read(e),o=i.resourceCount.read(e);t=t+(s??o)}return t});_activeRepositoryNameContextKey;_activeRepositoryBranchNameContextKey;_getRepositoryResourceCount(e){return I(this,e.provider.onDidChangeResources,()=>M(e.provider))}_updateActivityCountBadge(e,t){if(e===0)return;const i=new $(e,s=>y("scmPendingChangesBadge","{0} pending changes",s));t.add(this.activityService.showViewActivity(F,{badge:i}))}_updateStatusBar(e,t,i){if(!e)return;const s=e.provider.rootUri?`${G(e.provider.rootUri)} (${e.provider.label})`:e.provider.label;for(let o=0;o<t.length;o++){const c=t[o],u=`${s}${c.tooltip?` - ${c.tooltip}`:""}`;let r=c.arguments?.[0];r&&typeof r=="string"?(r=r.substring(0,r.lastIndexOf("/")).replace(/^git\./,""),r.length>1&&(r=r[0].toLocaleUpperCase()+r.slice(1))):r="";const a={name:y("status.scm","Source Control")+(r?` ${r}`:""),text:c.title,ariaLabel:u,tooltip:u,command:c.id?c:void 0};i.add(o===0?this.statusbarService.addEntry(a,`status.scm.${o}`,b.LEFT,1e4):this.statusbarService.addEntry(a,`status.scm.${o}`,b.LEFT,{id:`status.scm.${o-1}`,alignment:b.RIGHT,compact:!0}))}}_updateActiveRepositoryContextKeys(e,t){this._activeRepositoryNameContextKey.set(e??""),this._activeRepositoryBranchNameContextKey.set(t??"")}};g=R([n(0,U),n(1,V),n(2,H),n(3,K),n(4,L),n(5,k),n(6,O)],g);let l=class extends _{constructor(e,t,i){super();this.scmService=t;this.uriIdentityService=i;const s=new m("scmActiveResourceHasChanges",!1,y("scmActiveResourceHasChanges","Whether the active resource has changes")),o=new m("scmActiveResourceRepository",void 0,y("scmActiveResourceRepository","The active resource's repository"));this._store.add(S((r,a)=>{for(const v of this._repositories.read(r))a.add(f.runAndSubscribe(v.provider.onDidChangeResources,()=>{this._onDidRepositoryChange.fire()}))}));const c={contextKey:s,getGroupContextKeyValue:r=>this._getEditorHasChanges(r.activeEditor),onDidChange:this._onDidRepositoryChange.event},u={contextKey:o,getGroupContextKeyValue:r=>this._getEditorRepositoryId(r.activeEditor),onDidChange:this._onDidRepositoryChange.event};this._store.add(e.registerContextKeyProvider(c)),this._store.add(e.registerContextKeyProvider(u))}_repositories=I(this,f.any(this.scmService.onDidAddRepository,this.scmService.onDidRemoveRepository),()=>this.scmService.repositories);_onDidRepositoryChange=new N;_getEditorHasChanges(e){const t=x.getOriginalUri(e);if(!t)return!1;const i=this.scmService.getRepository(t);for(const s of i?.provider.groups??[])if(s.resources.some(o=>this.uriIdentityService.extUri.isEqual(t,o.sourceUri)))return!0;return!1}_getEditorRepositoryId(e){const t=x.getOriginalUri(e);return t?this.scmService.getRepository(t)?.id:void 0}dispose(){this._onDidRepositoryChange.dispose(),super.dispose()}};l=R([n(0,W),n(1,K),n(2,T)],l);export{g as SCMActiveRepositoryController,l as SCMActiveResourceContextKeyController};
