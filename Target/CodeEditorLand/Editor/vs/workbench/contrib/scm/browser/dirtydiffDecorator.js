var Se=Object.defineProperty;var we=Object.getOwnPropertyDescriptor;var b=(d,n,e,i)=>{for(var t=i>1?void 0:i?we(n,e):n,o=d.length-1,r;o>=0;o--)(r=d[o])&&(t=(i?r(n,e,t):r(t))||t);return i&&t&&Se(n,e,t),t},h=(d,n)=>(e,i)=>n(e,i,d);import*as c from"../../../../nls.js";import"./media/dirtydiffDecorator.css";import{ThrottledDelayer as Ee}from"../../../../base/common/async.js";import{dispose as V,toDisposable as Y,Disposable as D,DisposableStore as M}from"../../../../base/common/lifecycle.js";import{Event as u,Emitter as xe}from"../../../../base/common/event.js";import"../../../common/contributions.js";import{IInstantiationService as _}from"../../../../platform/instantiation/common/instantiation.js";import{ITextModelService as _e}from"../../../../editor/common/services/resolverService.js";import{IEditorWorkerService as Le}from"../../../../editor/common/services/editorWorker.js";import{IConfigurationService as L}from"../../../../platform/configuration/common/configuration.js";import"../../../../base/common/uri.js";import{ISCMService as ke}from"../common/scm.js";import{ModelDecorationOptions as Ne}from"../../../../editor/common/model/textModel.js";import{themeColorFromId as Z,IThemeService as Te}from"../../../../platform/theme/common/themeService.js";import{editorErrorForeground as Ae,registerColor as p,transparent as W}from"../../../../platform/theme/common/colorRegistry.js";import{isCodeEditor as ee,MouseTargetType as ie}from"../../../../editor/browser/editorBrowser.js";import{registerEditorAction as k,registerEditorContribution as Re,EditorAction as N,EditorContributionInstantiation as Pe}from"../../../../editor/browser/editorExtensions.js";import{PeekViewWidget as Oe,getOuterEditor as Ge,peekViewBorder as Fe,peekViewTitleBackground as Ve,peekViewTitleForeground as We,peekViewTitleInfoForeground as Be}from"../../../../editor/contrib/peekView/browser/peekView.js";import{IContextKeyService as te,ContextKeyExpr as ze,RawContextKey as Qe}from"../../../../platform/contextkey/common/contextkey.js";import{EditorContextKeys as T}from"../../../../editor/common/editorContextKeys.js";import{KeyCode as I,KeyMod as C}from"../../../../base/common/keyCodes.js";import{Position as oe}from"../../../../editor/common/core/position.js";import"../../../../editor/common/core/range.js";import{rot as re}from"../../../../base/common/numbers.js";import{KeybindingsRegistry as Ke,KeybindingWeight as S}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{EmbeddedDiffEditorWidget as ne}from"../../../../editor/browser/widget/diffEditor/embeddedDiffEditorWidget.js";import{EditorOption as qe}from"../../../../editor/common/config/editorOptions.js";import{Action as se,ActionRunner as He}from"../../../../base/common/actions.js";import"../../../../base/browser/ui/actionbar/actionbar.js";import{IKeybindingService as Ue}from"../../../../platform/keybinding/common/keybinding.js";import{basename as $e}from"../../../../base/common/resources.js";import{MenuId as B,IMenuService as je,MenuItemAction as Xe,MenuRegistry as de}from"../../../../platform/actions/common/actions.js";import{createAndFillInActionBarActions as Je}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{ScrollType as ae}from"../../../../editor/common/editorCommon.js";import{OverviewRulerLane as Ye,MinimapPosition as Ze,shouldSynchronizeModel as ei}from"../../../../editor/common/model.js";import{equals as ii,sortedDiff as ti}from"../../../../base/common/arrays.js";import{ICodeEditorService as z}from"../../../../editor/browser/services/codeEditorService.js";import"../../../../base/common/sequence.js";import*as A from"../../../../base/browser/dom.js";import{EncodingMode as oi,ITextFileService as ri,isTextFileEditorModel as ni}from"../../../services/textfile/common/textfiles.js";import{gotoNextLocation as si,gotoPreviousLocation as di}from"../../../../platform/theme/common/iconRegistry.js";import{Codicon as ai}from"../../../../base/common/codicons.js";import{ThemeIcon as Q}from"../../../../base/common/themables.js";import{onUnexpectedError as li}from"../../../../base/common/errors.js";import{TextCompareEditorActiveContext as R}from"../../../common/contextkeys.js";import{IProgressService as ci,ProgressLocation as hi}from"../../../../platform/progress/common/progress.js";import"../../../../editor/common/diff/legacyLinesDiffComputer.js";import{Color as le}from"../../../../base/common/color.js";import{ResourceMap as fi}from"../../../../base/common/map.js";import{IEditorService as gi}from"../../../services/editor/common/editorService.js";import{AccessibilitySignal as K,IAccessibilitySignalService as ce}from"../../../../platform/accessibilitySignal/browser/accessibilitySignalService.js";import{IAccessibilityService as he}from"../../../../platform/accessibility/common/accessibility.js";import{IQuickDiffService as ui}from"../common/quickDiff.js";import{SwitchQuickDiffBaseAction as mi,SwitchQuickDiffViewItem as pi}from"./dirtyDiffSwitcher.js";class vi extends He{runAction(n,e){return n instanceof Xe?n.run(...e):super.runAction(n,e)}}const fe=new Qe("dirtyDiffVisible",!1);function bi(d){const n=d.modifiedEndLineNumber-d.modifiedStartLineNumber+1,e=d.originalEndLineNumber-d.originalStartLineNumber+1;return d.originalEndLineNumber===0?n:d.modifiedEndLineNumber===0?e:n+e}function q(d){return d.modifiedEndLineNumber===0?d.modifiedStartLineNumber===0?1:d.modifiedStartLineNumber:d.modifiedEndLineNumber}function Ci(d,n){return d===1&&n.modifiedStartLineNumber===0&&n.modifiedEndLineNumber===0?!0:d>=n.modifiedStartLineNumber&&d<=(n.modifiedEndLineNumber||n.modifiedStartLineNumber)}let y=class extends se{editor;action;instantiationService;constructor(n,e,i,t,o){const r=t.lookupKeybinding(e.id),s=e.label+(r?` (${r.getLabel()})`:"");super(e.id,s,i),this.instantiationService=o,this.action=e,this.editor=n}run(){return Promise.resolve(this.instantiationService.invokeFunction(n=>this.action.run(n,this.editor,null)))}};y=b([h(3,Ue),h(4,_)],y);var yi=(i=>(i[i.Modify=0]="Modify",i[i.Add=1]="Add",i[i.Delete=2]="Delete",i))(yi||{});function H(d){return d.originalEndLineNumber===0?1:d.modifiedEndLineNumber===0?2:0}function Di(d,n){switch(n){case 0:return d.getColor(U);case 1:return d.getColor($);case 2:return d.getColor(j)}}function w(d){const n=d.get(z).listDiffEditors();for(const e of n)if(e.hasTextFocus()&&e instanceof ne)return e.getParentEditor();return Ge(d)}let E=class extends Oe{constructor(e,i,t,o,r,s){super(e,{isResizeable:!0,frameWidth:1,keepEditorSelection:!0,className:"dirty-diff"},o);this.model=i;this.themeService=t;this.menuService=r;this.contextKeyService=s;this._disposables.add(t.onDidColorThemeChange(this._applyTheme,this)),this._applyTheme(t.getColorTheme()),this.model.original.length>0&&(s=s.createOverlay([["originalResourceScheme",this.model.original[0].uri.scheme],["originalResourceSchemes",this.model.original.map(a=>a.uri.scheme)]])),this.create(),e.hasModel()?this.title=$e(e.getModel().uri):this.title="",this.setTitle(this.title)}diffEditor;title;menu;_index=0;_provider="";change;height=void 0;dropdown;dropdownContainer;get provider(){return this._provider}get index(){return this._index}get visibleRange(){const e=this.diffEditor.getModifiedEditor().getVisibleRanges();return e.length>=0?e[0]:void 0}showChange(e,i=!0){const t=this.model.changes[e],o=t.change;if(this._index=e,this.contextKeyService.createKey("originalResourceScheme",this.model.changes[e].uri.scheme),this.updateActions(),this._provider=t.label,this.change=o,!this.model.original)return;u.once(this.diffEditor.onDidUpdateDiff)(()=>setTimeout(()=>this.revealChange(o),0));const a=this.model.getDiffEditorModel(t.uri.toString());if(!a)return;this.diffEditor.setModel(a),this.dropdown?.setSelection(t.label);const l=new oe(q(o),1),f=this.editor.getOption(qe.lineHeight),v=this.editor.getLayoutInfo().height,O=Math.floor(v/f),Ie=Math.min(bi(o)+8,Math.floor(O/3));this.renderTitle(t.label);const Me=H(o),X=Di(this.themeService.getColorTheme(),Me);this.style({frameColor:X,arrowColor:X});const G=[];let J=e;for(const F of this.model.changes)F.label===this.model.changes[this._index].label&&(G.push(F.change),t===F&&(J=G.length-1));this._actionbarWidget.context=[a.modified.uri,G,J],i&&(this.show(l,Ie),this.editor.setPosition(l),this.editor.focus())}renderTitle(e){const i=this.model.mapChanges.get(e),t=i.indexOf(this._index);let o;this.shouldUseDropdown()?(o=this.model.changes.length>1?c.localize("multiChanges","{0} of {1} changes",t+1,i.length):c.localize("multiChange","{0} of {1} change",t+1,i.length),this.dropdownContainer.style.display="inherit"):(o=this.model.changes.length>1?c.localize("changes","{0} - {1} of {2} changes",e,t+1,i.length):c.localize("change","{0} - {1} of {2} change",e,t+1,i.length),this.dropdownContainer.style.display="none"),this.setTitle(this.title,o)}switchQuickDiff(e){const i=e?.provider;if(i===this.model.changes[this._index].label)return;let t=this._index<this.model.changes.length-1?this._index+1:0;for(let s=t;s!==this._index;s<this.model.changes.length-1?s++:s=0)if(this.model.changes[s].label===i){t=s;break}let o=this._index>0?this._index-1:this.model.changes.length-1;for(let s=o;s!==this._index;s>=0?s--:s=this.model.changes.length-1)if(this.model.changes[s].label===i){o=s;break}const r=Math.abs(this.model.changes[t].change.modifiedEndLineNumber-this.model.changes[this._index].change.modifiedEndLineNumber)<Math.abs(this.model.changes[o].change.modifiedEndLineNumber-this.model.changes[this._index].change.modifiedEndLineNumber)?t:o;this.showChange(r,!1)}shouldUseDropdown(){let e=0;if(this.model.mapChanges.size>1){const i=Array.from(this.model.mapChanges.keys());for(let t=0;t<i.length&&e<=1;t++)this.model.mapChanges.get(i[t]).length>0&&e++}return e>=2}updateActions(){if(!this._actionbarWidget)return;const e=this.instantiationService.createInstance(y,this.editor,new ge(this.editor),Q.asClassName(di)),i=this.instantiationService.createInstance(y,this.editor,new ue(this.editor),Q.asClassName(si));this._disposables.add(e),this._disposables.add(i);const t=[];this.menu&&this.menu.dispose(),this.menu=this.menuService.createMenu(B.SCMChangeContext,this.contextKeyService),Je(this.menu,{shouldForwardArgs:!0},t),this._actionbarWidget.clear(),this._actionbarWidget.push(t.reverse(),{label:!1,icon:!0}),this._actionbarWidget.push([i,e],{label:!1,icon:!0}),this._actionbarWidget.push(new se("peekview.close",c.localize("label.close","Close"),Q.asClassName(ai.close),!0,()=>this.dispose()),{label:!1,icon:!0})}_fillHead(e){super._fillHead(e,!0),this.dropdownContainer=A.prepend(this._titleElement,A.$(".dropdown")),this.dropdown=this.instantiationService.createInstance(pi,new mi(i=>this.switchQuickDiff(i)),this.model.quickDiffs.map(i=>i.label),this.model.changes[this._index].label),this.dropdown.render(this.dropdownContainer),this.updateActions()}_getActionBarOptions(){const e=new vi;return e.onDidRun(i=>{!(i.action instanceof y)&&!i.error&&this.dispose()}),{...super._getActionBarOptions(),actionRunner:e}}_fillBody(e){const i={scrollBeyondLastLine:!0,scrollbar:{verticalScrollbarSize:14,horizontal:"auto",useShadows:!0,verticalHasArrows:!1,horizontalHasArrows:!1},overviewRulerLanes:2,fixedOverflowWidgets:!0,minimap:{enabled:!1},renderSideBySide:!1,readOnly:!1,renderIndicators:!1,diffAlgorithm:"advanced",ignoreTrimWhitespace:!1,stickyScroll:{enabled:!1}};this.diffEditor=this.instantiationService.createInstance(ne,e,i,{},this.editor),this._disposables.add(this.diffEditor)}_onWidth(e){typeof this.height>"u"||this.diffEditor.layout({height:this.height,width:e})}_doLayoutBody(e,i){super._doLayoutBody(e,i),this.diffEditor.layout({height:e,width:i}),typeof this.height>"u"&&this.change&&this.revealChange(this.change),this.height=e}revealChange(e){let i,t;e.modifiedEndLineNumber===0?(i=e.modifiedStartLineNumber,t=e.modifiedStartLineNumber+1):e.originalEndLineNumber>0?(i=e.modifiedStartLineNumber-1,t=e.modifiedEndLineNumber+1):(i=e.modifiedStartLineNumber,t=e.modifiedEndLineNumber),this.diffEditor.revealLinesInCenter(i,t,ae.Immediate)}_applyTheme(e){const i=e.getColor(Fe)||le.transparent;this.style({arrowColor:i,frameColor:i,headerBackgroundColor:e.getColor(Ve)||le.transparent,primaryHeadingColor:e.getColor(We),secondaryHeadingColor:e.getColor(Be)})}revealRange(e){this.editor.revealLineInCenterIfOutsideViewport(e.endLineNumber,ae.Smooth)}hasFocus(){return this.diffEditor.hasTextFocus()}dispose(){super.dispose(),this.menu?.dispose()}};E=b([h(2,Te),h(3,_),h(4,je),h(5,te)],E);class ge extends N{constructor(e){super({id:"editor.action.dirtydiff.previous",label:c.localize("show previous change","Show Previous Change"),alias:"Show Previous Change",precondition:R.toNegated(),kbOpts:{kbExpr:T.editorTextFocus,primary:C.Shift|C.Alt|I.F3,weight:S.EditorContrib}});this.outerEditor=e}run(e){const i=this.outerEditor??w(e);if(!i)return;const t=g.get(i);t&&t.canNavigate()&&t.previous()}}k(ge);class ue extends N{constructor(e){super({id:"editor.action.dirtydiff.next",label:c.localize("show next change","Show Next Change"),alias:"Show Next Change",precondition:R.toNegated(),kbOpts:{kbExpr:T.editorTextFocus,primary:C.Alt|I.F3,weight:S.EditorContrib}});this.outerEditor=e}run(e){const i=this.outerEditor??w(e);if(!i)return;const t=g.get(i);t&&t.canNavigate()&&t.next()}}k(ue),de.appendMenuItem(B.MenubarGoMenu,{group:"7_change_nav",command:{id:"editor.action.dirtydiff.next",title:c.localize({key:"miGotoNextChange",comment:["&& denotes a mnemonic"]},"Next &&Change")},order:1}),de.appendMenuItem(B.MenubarGoMenu,{group:"7_change_nav",command:{id:"editor.action.dirtydiff.previous",title:c.localize({key:"miGotoPreviousChange",comment:["&& denotes a mnemonic"]},"Previous &&Change")},order:2});class Ii extends N{constructor(){super({id:"workbench.action.editor.previousChange",label:c.localize("move to previous change","Go to Previous Change"),alias:"Go to Previous Change",precondition:R.toNegated(),kbOpts:{kbExpr:T.editorTextFocus,primary:C.Shift|C.Alt|I.F5,weight:S.EditorContrib}})}async run(n){const e=w(n),i=n.get(ce),t=n.get(he),o=n.get(z);if(!e||!e.hasModel())return;const r=g.get(e);if(!r||!r.modelRegistry)return;const s=e.getPosition().lineNumber,a=r.modelRegistry.getModel(e.getModel(),e);if(!a||a.changes.length===0)return;const l=a.findPreviousClosestChange(s,!1),f=a.changes[l];await pe(f.change,i),me(f.change,e,t,o)}}k(Ii);class Mi extends N{constructor(){super({id:"workbench.action.editor.nextChange",label:c.localize("move to next change","Go to Next Change"),alias:"Go to Next Change",precondition:R.toNegated(),kbOpts:{kbExpr:T.editorTextFocus,primary:C.Alt|I.F5,weight:S.EditorContrib}})}async run(n){const e=n.get(ce),i=w(n),t=n.get(he),o=n.get(z);if(!i||!i.hasModel())return;const r=g.get(i);if(!r||!r.modelRegistry)return;const s=i.getPosition().lineNumber,a=r.modelRegistry.getModel(i.getModel(),i);if(!a||a.changes.length===0)return;const l=a.findNextClosestChange(s,!1),f=a.changes[l].change;await pe(f,e),me(f,i,t,o)}}function me(d,n,e,i){const t=new oe(d.modifiedStartLineNumber,1);n.setPosition(t),n.revealPositionInCenter(t),e.isScreenReaderOptimized()&&(n.setSelection({startLineNumber:d.modifiedStartLineNumber,startColumn:0,endLineNumber:d.modifiedStartLineNumber,endColumn:Number.MAX_VALUE}),i.getActiveCodeEditor()?.writeScreenReaderContent("diff-navigation"))}async function pe(d,n){switch(H(d)){case 1:n.playSignal(K.diffLineInserted,{allowManyInParallel:!0,source:"dirtyDiffDecoration"});break;case 2:n.playSignal(K.diffLineDeleted,{allowManyInParallel:!0,source:"dirtyDiffDecoration"});break;case 0:n.playSignal(K.diffLineModified,{allowManyInParallel:!0,source:"dirtyDiffDecoration"});break}}k(Mi),Ke.registerCommandAndKeybindingRule({id:"closeDirtyDiff",weight:S.EditorContrib+50,primary:I.Escape,secondary:[C.Shift|I.Escape],when:ze.and(fe),handler:d=>{const n=w(d);if(!n)return;const e=g.get(n);e&&e.close()}});let g=class extends D{constructor(e,i,t,o){super();this.editor=e;this.configurationService=t;this.instantiationService=o;if(this.enabled=!i.getContextKeyValue("isInDiffEditor"),this.stylesheet=A.createStyleSheet(void 0,void 0,this._store),this.enabled){this.isDirtyDiffVisible=fe.bindTo(i),this._register(e.onDidChangeModel(()=>this.close()));const r=u.filter(t.onDidChangeConfiguration,s=>s.affectsConfiguration("scm.diffDecorationsGutterAction"));this._register(r(this.onDidChangeGutterAction,this)),this.onDidChangeGutterAction()}}static ID="editor.contrib.dirtydiff";static get(e){return e.getContribution(g.ID)}modelRegistry=null;model=null;widget=null;isDirtyDiffVisible;session=D.None;mouseDownInfo=null;enabled=!1;gutterActionDisposables=new M;stylesheet;onDidChangeGutterAction(){const e=this.configurationService.getValue("scm.diffDecorationsGutterAction");this.gutterActionDisposables.clear(),e==="diff"?(this.gutterActionDisposables.add(this.editor.onMouseDown(i=>this.onEditorMouseDown(i))),this.gutterActionDisposables.add(this.editor.onMouseUp(i=>this.onEditorMouseUp(i))),this.stylesheet.textContent=`
				.monaco-editor .dirty-diff-glyph {
					cursor: pointer;
				}

				.monaco-editor .margin-view-overlays .dirty-diff-glyph:hover::before {
					height: 100%;
					width: 6px;
					left: -6px;
				}

				.monaco-editor .margin-view-overlays .dirty-diff-deleted:hover::after {
					bottom: 0;
					border-top-width: 0;
					border-bottom-width: 0;
				}
			`):this.stylesheet.textContent=""}canNavigate(){return!this.widget||this.widget?.index===-1||!!this.model&&this.model.changes.length>1}refresh(){this.widget?.showChange(this.widget.index,!1)}next(e){if(!this.assertWidget()||!this.widget||!this.model)return;let i;if(this.editor.hasModel()&&(typeof e=="number"||!this.widget.provider))i=this.model.findNextClosestChange(typeof e=="number"?e:this.editor.getPosition().lineNumber,!0,this.widget.provider);else{const t=this.model.mapChanges.get(this.widget.provider)??this.model.mapChanges.values().next().value,o=t.findIndex(r=>r===this.widget.index);i=t[re(o+1,t.length)]}this.widget.showChange(i)}previous(e){if(!this.assertWidget()||!this.widget||!this.model)return;let i;if(this.editor.hasModel()&&typeof e=="number")i=this.model.findPreviousClosestChange(typeof e=="number"?e:this.editor.getPosition().lineNumber,!0,this.widget.provider);else{const t=this.model.mapChanges.get(this.widget.provider)??this.model.mapChanges.values().next().value,o=t.findIndex(r=>r===this.widget.index);i=t[re(o-1,t.length)]}this.widget.showChange(i)}close(){this.session.dispose(),this.session=D.None}assertWidget(){if(!this.enabled)return!1;if(this.widget)return!this.model||this.model.changes.length===0?(this.close(),!1):!0;if(!this.modelRegistry)return!1;const e=this.editor.getModel();if(!e)return!1;const i=this.modelRegistry.getModel(e,this.editor);if(!i||i.changes.length===0)return!1;this.model=i,this.widget=this.instantiationService.createInstance(E,this.editor,i),this.isDirtyDiffVisible.set(!0);const t=new M;return t.add(u.once(this.widget.onDidClose)(this.close,this)),u.chain(i.onDidChange,r=>r.filter(s=>s.diff.length>0).map(s=>s.diff))(this.onDidModelChange,this,t),t.add(this.widget),t.add(Y(()=>{this.model=null,this.widget=null,this.isDirtyDiffVisible.set(!1),this.editor.focus()})),this.session=t,!0}onDidModelChange(e){if(!(!this.model||!this.widget||this.widget.hasFocus())){for(const i of e)if(i.start<=this.widget.index){this.next();return}this.refresh()}}onEditorMouseDown(e){this.mouseDownInfo=null;const i=e.target.range;if(!i||!e.event.leftButton||e.target.type!==ie.GUTTER_LINE_DECORATIONS||!e.target.element||e.target.element.className.indexOf("dirty-diff-glyph")<0)return;const t=e.target.detail,o=e.target.element.offsetLeft,r=t.offsetX-o;r<-3||r>3||(this.mouseDownInfo={lineNumber:i.startLineNumber})}onEditorMouseUp(e){if(!this.mouseDownInfo)return;const{lineNumber:i}=this.mouseDownInfo;this.mouseDownInfo=null;const t=e.target.range;if(!t||t.startLineNumber!==i||e.target.type!==ie.GUTTER_LINE_DECORATIONS||!this.modelRegistry)return;const o=this.editor.getModel();if(!o)return;const r=this.modelRegistry.getModel(o,this.editor);if(!r)return;const s=r.changes.findIndex(a=>Ci(i,a.change));s<0||(s===this.widget?.index?this.close():this.next(i))}getChanges(){if(!this.modelRegistry)return[];if(!this.editor.hasModel())return[];const e=this.modelRegistry.getModel(this.editor.getModel(),this.editor);return e?e.changes.map(i=>i.change):[]}dispose(){this.gutterActionDisposables.dispose(),super.dispose()}};g=b([h(1,te),h(2,L),h(3,_)],g);const U=p("editorGutter.modifiedBackground",{dark:"#1B81A8",light:"#2090D3",hcDark:"#1B81A8",hcLight:"#2090D3"},c.localize("editorGutterModifiedBackground","Editor gutter background color for lines that are modified.")),$=p("editorGutter.addedBackground",{dark:"#487E02",light:"#48985D",hcDark:"#487E02",hcLight:"#48985D"},c.localize("editorGutterAddedBackground","Editor gutter background color for lines that are added.")),j=p("editorGutter.deletedBackground",Ae,c.localize("editorGutterDeletedBackground","Editor gutter background color for lines that are deleted.")),ve=p("minimapGutter.modifiedBackground",U,c.localize("minimapGutterModifiedBackground","Minimap gutter background color for lines that are modified.")),be=p("minimapGutter.addedBackground",$,c.localize("minimapGutterAddedBackground","Minimap gutter background color for lines that are added.")),Si=p("minimapGutter.deletedBackground",j,c.localize("minimapGutterDeletedBackground","Minimap gutter background color for lines that are deleted.")),Ce=p("editorOverviewRuler.modifiedForeground",W(U,.6),c.localize("overviewRulerModifiedForeground","Overview ruler marker color for modified content.")),ye=p("editorOverviewRuler.addedForeground",W($,.6),c.localize("overviewRulerAddedForeground","Overview ruler marker color for added content.")),wi=p("editorOverviewRuler.deletedForeground",W(j,.6),c.localize("overviewRulerDeletedForeground","Overview ruler marker color for deleted content."));let m=class extends D{constructor(e,i,t,o){super();this.codeEditor=i;this.model=t;this.configurationService=o;this.editorModel=e;const r=o.getValue("scm.diffDecorations"),s=r==="all"||r==="gutter",a=r==="all"||r==="overview",l=r==="all"||r==="minimap",f=c.localize("diffAdded","Added lines");this.addedOptions=m.createDecoration("dirty-diff-added",f,{gutter:s,overview:{active:a,color:ye},minimap:{active:l,color:be},isWholeLine:!0}),this.addedPatternOptions=m.createDecoration("dirty-diff-added-pattern",f,{gutter:s,overview:{active:a,color:ye},minimap:{active:l,color:be},isWholeLine:!0});const v=c.localize("diffModified","Changed lines");this.modifiedOptions=m.createDecoration("dirty-diff-modified",v,{gutter:s,overview:{active:a,color:Ce},minimap:{active:l,color:ve},isWholeLine:!0}),this.modifiedPatternOptions=m.createDecoration("dirty-diff-modified-pattern",v,{gutter:s,overview:{active:a,color:Ce},minimap:{active:l,color:ve},isWholeLine:!0}),this.deletedOptions=m.createDecoration("dirty-diff-deleted",c.localize("diffDeleted","Removed lines"),{gutter:s,overview:{active:a,color:wi},minimap:{active:l,color:Si},isWholeLine:!1}),this._register(o.onDidChangeConfiguration(O=>{O.affectsConfiguration("scm.diffDecorationsGutterPattern")&&this.onDidChange()})),this._register(t.onDidChange(this.onDidChange,this))}static createDecoration(e,i,t){const o={description:"dirty-diff-decoration",isWholeLine:t.isWholeLine};return t.gutter&&(o.linesDecorationsClassName=`dirty-diff-glyph ${e}`,o.linesDecorationsTooltip=i),t.overview.active&&(o.overviewRuler={color:Z(t.overview.color),position:Ye.Left}),t.minimap.active&&(o.minimap={color:Z(t.minimap.color),position:Ze.Gutter}),Ne.createDynamic(o)}addedOptions;addedPatternOptions;modifiedOptions;modifiedPatternOptions;deletedOptions;decorationsCollection;editorModel;onDidChange(){if(!this.editorModel)return;const e=this.configurationService.getValue("scm.diffDecorationsGutterPattern"),i=this.model.changes.map(t=>{const o=t.change,r=H(o),s=o.modifiedStartLineNumber,a=o.modifiedEndLineNumber||s;switch(r){case 1:return{range:{startLineNumber:s,startColumn:1,endLineNumber:a,endColumn:1},options:e.added?this.addedPatternOptions:this.addedOptions};case 2:return{range:{startLineNumber:s,startColumn:Number.MAX_VALUE,endLineNumber:s,endColumn:Number.MAX_VALUE},options:this.deletedOptions};case 0:return{range:{startLineNumber:s,startColumn:1,endLineNumber:a,endColumn:1},options:e.modified?this.modifiedPatternOptions:this.modifiedOptions}}});this.decorationsCollection?this.decorationsCollection.set(i):this.decorationsCollection=this.codeEditor.createDecorationsCollection(i)}dispose(){super.dispose(),this.decorationsCollection&&this.decorationsCollection?.clear(),this.editorModel=null,this.decorationsCollection=void 0}};m=b([h(3,L)],m);function De(d,n){let e=d.modifiedStartLineNumber-n.modifiedStartLineNumber;return e!==0||(e=d.modifiedEndLineNumber-n.modifiedEndLineNumber,e!==0)||(e=d.originalStartLineNumber-n.originalStartLineNumber,e!==0)?e:d.originalEndLineNumber-n.originalEndLineNumber}async function Yt(d,n,e,i){const t=await d.getQuickDiffs(n,e,i);return t.length>0?t[0].originalResource:null}let x=class extends D{constructor(e,i,t,o,r,s,a){super();this.scmService=i;this.quickDiffService=t;this.editorWorkerService=o;this.configurationService=r;this.textModelResolverService=s;this.progressService=a;this._model=e,this._register(e.textEditorModel.onDidChangeContent(()=>this.triggerDiff())),this._register(u.filter(r.onDidChangeConfiguration,l=>l.affectsConfiguration("scm.diffDecorationsIgnoreTrimWhitespace")||l.affectsConfiguration("diffEditor.ignoreTrimWhitespace"))(this.triggerDiff,this)),this._register(i.onDidAddRepository(this.onDidAddRepository,this));for(const l of i.repositories)this.onDidAddRepository(l);this._register(this._model.onDidChangeEncoding(()=>{this.diffDelayer.cancel(),this._quickDiffs=[],this._originalModels.clear(),this._originalTextModels=[],this._quickDiffsPromise=void 0,this.setChanges([],new Map),this.triggerDiff()})),this._register(this.quickDiffService.onDidChangeQuickDiffProviders(()=>this.triggerDiff())),this.triggerDiff()}_quickDiffs=[];_originalModels=new Map;_originalTextModels=[];_model;get original(){return this._originalTextModels}diffDelayer=new Ee(200);_quickDiffsPromise;repositoryDisposables=new Set;originalModelDisposables=this._register(new M);_disposed=!1;_onDidChange=new xe;onDidChange=this._onDidChange.event;_changes=[];get changes(){return this._changes}_mapChanges=new Map;get mapChanges(){return this._mapChanges}get quickDiffs(){return this._quickDiffs}getDiffEditorModel(e){if(!this._originalModels.has(e))return;const i=this._originalModels.get(e);return{modified:this._model.textEditorModel,original:i.textEditorModel}}onDidAddRepository(e){const i=new M;this.repositoryDisposables.add(i),i.add(Y(()=>this.repositoryDisposables.delete(i)));const t=u.any(e.provider.onDidChange,e.provider.onDidChangeResources);i.add(t(this.triggerDiff,this));const o=u.filter(this.scmService.onDidRemoveRepository,r=>r===e);i.add(o(()=>V(i),null)),this.triggerDiff()}triggerDiff(){return this.diffDelayer?this.diffDelayer.trigger(()=>this.diff()).then(e=>{const i=Array.from(this._originalModels.values());!e||this._disposed||this._model.isDisposed()||i.some(t=>t.isDisposed())||(i.every(t=>t.textEditorModel.getValueLength()===0)&&(e.changes=[]),e.changes||(e.changes=[]),this.setChanges(e.changes,e.mapChanges))},e=>li(e)):Promise.resolve()}setChanges(e,i){const t=ti(this._changes,e,(o,r)=>De(o.change,r.change));this._changes=e,this._mapChanges=i,this._onDidChange.fire({changes:e,diff:t})}diff(){return this.progressService.withProgress({location:hi.Scm,delay:250},async()=>{const e=await this.getQuickDiffsPromise();if(this._disposed||this._model.isDisposed()||e.length===0)return Promise.resolve({changes:[],mapChanges:new Map});const i=e.filter(l=>this.editorWorkerService.canComputeDirtyDiff(l.originalResource,this._model.resource));if(i.length===0)return Promise.resolve({changes:[],mapChanges:new Map});const t=this.configurationService.getValue("scm.diffDecorationsIgnoreTrimWhitespace"),o=t==="inherit"?this.configurationService.getValue("diffEditor.ignoreTrimWhitespace"):t!=="false",r=[];for(const l of i){const f=await this.editorWorkerService.computeDirtyDiff(l.originalResource,this._model.resource,o);if(f)for(const v of f)v&&r.push({change:v,label:l.label,uri:l.originalResource})}const s=r.sort((l,f)=>De(l.change,f.change)),a=new Map;for(let l=0;l<s.length;l++){const f=s[l].label;a.has(f)||a.set(f,[]),a.get(f).push(l)}return{changes:s,mapChanges:a}})}getQuickDiffsPromise(){return this._quickDiffsPromise?this._quickDiffsPromise:(this._quickDiffsPromise=this.getOriginalResource().then(async e=>this._disposed?[]:e.length===0?(this._quickDiffs=[],this._originalModels.clear(),this._originalTextModels=[],[]):ii(this._quickDiffs,e,(i,t)=>i.originalResource.toString()===t.originalResource.toString()&&i.label===t.label)?e:(this.originalModelDisposables.clear(),this._originalModels.clear(),this._originalTextModels=[],this._quickDiffs=e,(await Promise.all(e.map(async i=>{try{const t=await this.textModelResolverService.createModelReference(i.originalResource);if(this._disposed)return t.dispose(),[];if(this._originalModels.set(i.originalResource.toString(),t.object),this._originalTextModels.push(t.object.textEditorModel),ni(t.object)){const o=this._model.getEncoding();o&&t.object.setEncoding(o,oi.Decode)}return this.originalModelDisposables.add(t),this.originalModelDisposables.add(t.object.textEditorModel.onDidChangeContent(()=>this.triggerDiff())),i}catch{return[]}}))).flat())),this._quickDiffsPromise.finally(()=>{this._quickDiffsPromise=void 0}))}async getOriginalResource(){if(this._disposed)return Promise.resolve([]);const e=this._model.resource;return this.quickDiffService.getQuickDiffs(e,this._model.getLanguageId(),this._model.textEditorModel?ei(this._model.textEditorModel):void 0)}findNextClosestChange(e,i=!0,t){let o;!t&&i&&(o=this.quickDiffs.find(s=>s.isSCM)?.label);const r=[];for(let s=0;s<this.changes.length;s++){if(t&&this.changes[s].label!==t)continue;const a=this.changes[s],l=r.length;if(i){if(q(a.change)>=e)if(o&&a.label!==o)r.push(s);else return s}else if(a.change.modifiedStartLineNumber>e)return s;if(r.length>0&&r.length===l)return r[0]}return r.length>0?r[0]:0}findPreviousClosestChange(e,i=!0,t){for(let o=this.changes.length-1;o>=0;o--){if(t&&this.changes[o].label!==t)continue;const r=this.changes[o].change;if(i){if(r.modifiedStartLineNumber<=e)return o}else if(q(r)<e)return o}return this.changes.length-1}dispose(){super.dispose(),this._disposed=!0,this._quickDiffs=[],this._originalModels.clear(),this._originalTextModels=[],this.diffDelayer.cancel(),this.repositoryDisposables.forEach(e=>V(e)),this.repositoryDisposables.clear()}};x=b([h(1,ke),h(2,ui),h(3,Le),h(4,L),h(5,_e),h(6,ci)],x);class Ei{constructor(n,e){this.model=n;this.decorator=e}dispose(){this.decorator.dispose(),this.model.dispose()}}let P=class extends D{constructor(e,i,t,o){super();this.editorService=e;this.instantiationService=i;this.configurationService=t;this.textFileService=o;this.stylesheet=A.createStyleSheet(void 0,void 0,this._store);const r=u.filter(t.onDidChangeConfiguration,l=>l.affectsConfiguration("scm.diffDecorations"));this._register(r(this.onDidChangeConfiguration,this)),this.onDidChangeConfiguration();const s=u.filter(t.onDidChangeConfiguration,l=>l.affectsConfiguration("scm.diffDecorationsGutterWidth"));this._register(s(this.onDidChangeDiffWidthConfiguration,this)),this.onDidChangeDiffWidthConfiguration();const a=u.filter(t.onDidChangeConfiguration,l=>l.affectsConfiguration("scm.diffDecorationsGutterVisibility"));this._register(a(this.onDidChangeDiffVisibilityConfiguration,this)),this.onDidChangeDiffVisibilityConfiguration()}enabled=!1;viewState={width:3,visibility:"always"};items=new fi;transientDisposables=this._register(new M);stylesheet;onDidChangeConfiguration(){this.configurationService.getValue("scm.diffDecorations")!=="none"?this.enable():this.disable()}onDidChangeDiffWidthConfiguration(){let e=this.configurationService.getValue("scm.diffDecorationsGutterWidth");(isNaN(e)||e<=0||e>5)&&(e=3),this.setViewState({...this.viewState,width:e})}onDidChangeDiffVisibilityConfiguration(){const e=this.configurationService.getValue("scm.diffDecorationsGutterVisibility");this.setViewState({...this.viewState,visibility:e})}setViewState(e){this.viewState=e,this.stylesheet.textContent=`
			.monaco-editor .dirty-diff-added,
			.monaco-editor .dirty-diff-modified {
				border-left-width:${e.width}px;
			}
			.monaco-editor .dirty-diff-added-pattern,
			.monaco-editor .dirty-diff-added-pattern:before,
			.monaco-editor .dirty-diff-modified-pattern,
			.monaco-editor .dirty-diff-modified-pattern:before {
				background-size: ${e.width}px ${e.width}px;
			}
			.monaco-editor .dirty-diff-added,
			.monaco-editor .dirty-diff-added-pattern,
			.monaco-editor .dirty-diff-modified,
			.monaco-editor .dirty-diff-modified-pattern,
			.monaco-editor .dirty-diff-deleted {
				opacity: ${e.visibility==="always"?1:0};
			}
		`}enable(){this.enabled&&this.disable(),this.transientDisposables.add(u.any(this.editorService.onDidCloseEditor,this.editorService.onDidVisibleEditorsChange)(()=>this.onEditorsChanged())),this.onEditorsChanged(),this.enabled=!0}disable(){if(this.enabled){this.transientDisposables.clear();for(const[,e]of this.items)V(e.values());this.items.clear(),this.enabled=!1}}onEditorsChanged(){for(const e of this.editorService.visibleTextEditorControls)if(ee(e)){const i=e.getModel(),t=g.get(e);if(t&&(t.modelRegistry=this),i&&(!this.items.has(i.uri)||!this.items.get(i.uri).has(e.getId()))){const o=this.textFileService.files.get(i.uri);if(o?.isResolved()){const r=this.instantiationService.createInstance(x,o),s=new m(o.textEditorModel,e,r,this.configurationService);this.items.has(i.uri)||this.items.set(i.uri,new Map),this.items.get(i.uri)?.set(e.getId(),new Ei(r,s))}}}for(const[e,i]of this.items)for(const t of i.keys())this.editorService.visibleTextEditorControls.find(o=>ee(o)&&o.getModel()?.uri.toString()===e.toString()&&o.getId()===t)||i.has(t)&&(i.get(t)?.dispose(),i.delete(t),i.size===0&&this.items.delete(e))}getModel(e,i){return this.items.get(e.uri)?.get(i.getId())?.model}dispose(){this.disable(),super.dispose()}};P=b([h(0,gi),h(1,_),h(2,L),h(3,ri)],P),Re(g.ID,g,Pe.AfterFirstRender);export{g as DirtyDiffController,x as DirtyDiffModel,P as DirtyDiffWorkbenchController,Mi as GotoNextChangeAction,Ii as GotoPreviousChangeAction,ue as ShowNextChangeAction,ge as ShowPreviousChangeAction,Yt as getOriginalResource,fe as isDirtyDiffVisible};
