var ye=Object.defineProperty;var Ie=Object.getOwnPropertyDescriptor;var v=(c,i,e,t)=>{for(var r=t>1?void 0:t?Ie(i,e):i,o=c.length-1,s;o>=0;o--)(s=c[o])&&(r=(t?s(i,e,r):s(r))||r);return t&&r&&ye(i,e,r),r},a=(c,i)=>(e,t)=>i(e,t,c);import"./media/scm.css";import*as ve from"../../../../base/common/platform.js";import{$ as y,append as f,h as H,reset as q}from"../../../../base/browser/dom.js";import"../../../../base/browser/ui/hover/hover.js";import"../../../../base/browser/ui/hover/hoverDelegate.js";import{IconLabel as Y}from"../../../../base/browser/ui/iconLabel/iconLabel.js";import"../../../../base/browser/ui/list/list.js";import"../../../../base/browser/ui/tree/abstractTree.js";import"../../../../base/browser/ui/tree/tree.js";import{fromNow as fe}from"../../../../base/common/date.js";import{createMatches as J}from"../../../../base/common/filters.js";import{MarkdownString as ge}from"../../../../base/common/htmlContent.js";import{Disposable as F,DisposableStore as k}from"../../../../base/common/lifecycle.js";import{autorun as D,autorunWithStore as Se,autorunWithStoreHandleChanges as Me,derived as $,observableValue as O,waitForState as Ce}from"../../../../base/common/observable.js";import{ThemeIcon as g}from"../../../../base/common/themables.js";import{localize as l}from"../../../../nls.js";import{IConfigurationService as P}from"../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as Q,IContextKeyService as _e}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as be}from"../../../../platform/contextview/browser/contextView.js";import{IHoverService as W,WorkbenchHoverDelegate as we}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as X}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as Te}from"../../../../platform/keybinding/common/keybinding.js";import{WorkbenchAsyncDataTree as He}from"../../../../platform/list/browser/listService.js";import{IOpenerService as ke}from"../../../../platform/opener/common/opener.js";import{ITelemetryService as Pe}from"../../../../platform/telemetry/common/telemetry.js";import{asCssVariable as S,foreground as Re}from"../../../../platform/theme/common/colorRegistry.js";import{IThemeService as Z}from"../../../../platform/theme/common/themeService.js";import{ViewAction as K,ViewPane as Le,ViewPaneShowActions as Ee}from"../../../browser/parts/views/viewPane.js";import{IViewDescriptorService as Ve,ViewContainerLocation as ee}from"../../../common/views.js";import{renderSCMHistoryItemGraph as Ae,historyItemGroupLocal as xe,historyItemGroupRemote as Fe,historyItemGroupBase as De,toISCMHistoryItemViewModelArray as $e,SWIMLANE_WIDTH as Oe,renderSCMHistoryGraphPlaceholder as Qe,historyItemHoverDeletionsForeground as Ge,historyItemHoverLabelForeground as te,historyItemHoverAdditionsForeground as Be,historyItemHoverDefaultLabelForeground as ze,historyItemHoverDefaultLabelBackground as re}from"./scmHistory.js";import{isSCMHistoryItemLoadMoreTreeElement as G,isSCMHistoryItemViewModelTreeElement as w,isSCMRepository as U}from"./util.js";import"../common/history.js";import{HISTORY_VIEW_PANE_ID as B,ISCMService as Ne,ISCMViewService as ie}from"../common/scm.js";import"../../../../base/browser/ui/list/listWidget.js";import{stripIcons as qe}from"../../../../base/common/iconLabels.js";import{IWorkbenchLayoutService as We,Position as oe}from"../../../services/layout/browser/layoutService.js";import{HoverPosition as R}from"../../../../base/browser/ui/hover/hoverWidget.js";import{Action2 as Ke,MenuId as T,registerAction2 as z}from"../../../../platform/actions/common/actions.js";import{Sequencer as se,Throttler as Ue}from"../../../../base/common/async.js";import{URI as ne}from"../../../../base/common/uri.js";import{ICommandService as ae}from"../../../../platform/commands/common/commands.js";import{ActionRunner as je}from"../../../../base/common/actions.js";import{delta as Ye,groupBy as Je,tail as Xe}from"../../../../base/common/arrays.js";import{Codicon as L}from"../../../../base/common/codicons.js";import{IProgressService as le}from"../../../../platform/progress/common/progress.js";import{constObservable as Ze,latestChangedValue as et,observableFromEvent as ce,runOnChange as tt,signalFromObservable as j}from"../../../../base/common/observableInternal/utils.js";import{ContextKeys as rt}from"./scmViewPane.js";import"../../../../base/browser/ui/actionbar/actionbar.js";import"../../../../base/browser/ui/dropdown/dropdownActionViewItem.js";import{ActionViewItem as de}from"../../../../base/browser/ui/actionbar/actionViewItems.js";import{renderLabelWithIcons as it}from"../../../../base/browser/ui/iconLabel/iconLabels.js";import{IQuickInputService as me}from"../../../../platform/quickinput/common/quickInput.js";import{Event as ot}from"../../../../base/common/event.js";import{Iterable as pe}from"../../../../base/common/iterator.js";import{clamp as st}from"../../../../base/common/numbers.js";import{observableConfigValue as nt}from"../../../../platform/observable/common/platformObservableUtils.js";import{compare as he}from"../../../../base/common/strings.js";class at extends de{constructor(e,t,r){super(null,t,{...r,icon:!1,label:!0});this._repository=e}updateLabel(){if(this.options.label&&this.label){this.label.classList.add("scm-graph-repository-picker");const e=y(".icon");e.classList.add(...g.asClassNameArray(L.repo));const t=y(".name");t.textContent=this._repository.provider.name,q(this.label,e,t)}}getTooltip(){return this._repository.provider.name}}class lt extends de{constructor(e,t,r,o){super(null,r,{...o,icon:!1,label:!0});this._repository=e;this._historyItemsFilter=t}updateLabel(){if(this.options.label&&this.label){this.label.classList.add("scm-graph-history-item-picker");const e=y(".icon");e.classList.add(...g.asClassNameArray(L.gitBranch));const t=y(".name");this._historyItemsFilter==="all"?t.textContent=l("all","All"):this._historyItemsFilter==="auto"?t.textContent=l("auto","Auto"):this._historyItemsFilter.length===1?(t.textContent=this._historyItemsFilter[0].name,q(this.label,...it(`$(git-branch) ${this._historyItemsFilter[0].name}`))):t.textContent=l("items","{0} Items",this._historyItemsFilter.length),q(this.label,e,t)}}getTooltip(){if(this._historyItemsFilter==="all")return l("allHistoryItemRefs","All history item references");if(this._historyItemsFilter==="auto"){const e=this._repository.provider.historyProvider.get();return[e?.currentHistoryItemRef.get()?.name,e?.currentHistoryItemRemoteRef.get()?.name,e?.currentHistoryItemBaseRef.get()?.name].filter(t=>!!t).join(", ")}else return this._historyItemsFilter.length===1?this._historyItemsFilter[0].name:this._historyItemsFilter.map(e=>e.name).join(", ")}}z(class extends K{constructor(){super({id:"workbench.scm.graph.action.pickRepository",title:"",viewId:B,f1:!1,menu:{id:T.SCMHistoryTitle,when:Q.and(Q.has("scm.providerCount"),Q.greater("scm.providerCount",1)),group:"navigation",order:0}})}async runInView(c,i){i.pickRepository()}}),z(class extends K{constructor(){super({id:"workbench.scm.graph.action.pickHistoryItemRefs",title:"",icon:L.gitBranch,viewId:B,f1:!1,menu:{id:T.SCMHistoryTitle,group:"navigation",order:0}})}async runInView(c,i){i.pickHistoryItemRef()}}),z(class extends K{constructor(){super({id:"workbench.scm.action.refreshGraph",title:l("refreshGraph","Refresh"),viewId:B,f1:!1,icon:L.refresh,menu:{id:T.SCMHistoryTitle,group:"navigation",order:1e3}})}async runInView(c,i){i.refresh()}}),z(class extends Ke{constructor(){super({id:"workbench.scm.action.scm.viewChanges",title:l("viewChanges","View Changes"),f1:!1,menu:[{id:T.SCMChangesContext,group:"0_view",when:Q.equals("config.multiDiffEditor.experimental.enabled",!0)}]})}async run(c,i,...e){const t=c.get(ae);if(!i||e.length===0)return;const r=e[0],o=e[e.length-1],s=i.historyProvider.get();if(e.length>1){const m=await s?.resolveHistoryItemRefsCommonAncestor([r.id,o.id]);if(!m||m!==r.id&&m!==o.id)return}const n=o.parentIds.length>0?o.parentIds[0]:void 0,d=await s?.provideHistoryItemChanges(r.id,n);if(!d?.length)return;const p=e.length===1?`${e[0].displayId??e[0].id} - ${e[0].message}`:l("historyItemChangesEditorTitle","All Changes ({0} \u2194 {1})",o.displayId??o.id,r.displayId??r.id),u=i.rootUri,h=u?u.path:i.label,I=ne.from({scheme:"scm-history-item",path:`${h}/${n}..${r.id}`},!0);t.executeCommand("_workbench.openMultiDiffEditor",{title:p,multiDiffSourceUri:I,resources:d})}});class ct{getHeight(){return 22}getTemplateId(i){if(w(i))return M.TEMPLATE_ID;if(G(i))return C.TEMPLATE_ID;throw new Error("Unknown element")}}let M=class{constructor(i,e,t,r){this.hoverDelegate=i;this._configurationService=e;this._hoverService=t;this._themeService=r}static TEMPLATE_ID="history-item";get templateId(){return M.TEMPLATE_ID}_badgesConfig=nt("scm.graph.badges","filter",this._configurationService);renderTemplate(i){i.parentElement.parentElement.querySelector(".monaco-tl-twistie").classList.add("force-no-twistie");const e=f(i,y(".history-item")),t=f(e,y(".graph-container")),r=new Y(e,{supportIcons:!0,supportHighlights:!0,supportDescriptionHighlights:!0}),o=f(e,y(".label-container"));return e.appendChild(o),{element:e,graphContainer:t,label:r,labelContainer:o,elementDisposables:new k,disposables:new k}}renderElement(i,e,t,r){const o=i.element.historyItemViewModel,s=o.historyItem,n=this._hoverService.setupManagedHover(this.hoverDelegate,t.element,this.getTooltip(i.element));t.elementDisposables.add(n),t.graphContainer.textContent="",t.graphContainer.appendChild(Ae(o));const u=i.element.repository.provider.historyProvider.get()?.currentHistoryItemGroup?.get()?.revision===s.id?["history-item-current"]:[],[h,I]=this.processMatches(o,i.filterData);t.label.setLabel(s.subject,s.author,{matches:h,descriptionMatches:I,extraClasses:u}),this._renderBadges(s,t)}_renderBadges(i,e){e.elementDisposables.add(D(t=>{const r=this._badgesConfig.read(t);e.labelContainer.textContent="";const o=i.references?.find(s=>s.color);for(const s of i.references??[])if(!(!s.color&&r==="filter")&&s.icon&&g.isThemeIcon(s.icon)){const n=H("div.label",{style:{color:s.color?S(te):S(Re),backgroundColor:s.color?S(s.color):S(re)}},[H("div.icon@icon"),H("div.description@description")]);n.icon.classList.add(...g.asClassNameArray(s.icon)),n.description.textContent=s.name,n.description.style.display=s===o?"":"none",f(e.labelContainer,n.root)}}))}getTooltip(i){const e=this._themeService.getColorTheme(),t=i.historyItemViewModel.historyItem,r=new ge("",{isTrusted:!0,supportThemeIcons:!0});if(r.appendMarkdown(`$(git-commit) \`${t.displayId??t.id}\`

`),t.author){if(r.appendMarkdown(`$(account) **${t.author}**`),t.timestamp){const o=new Intl.DateTimeFormat(ve.language,{year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"});r.appendMarkdown(`, $(history) ${fe(t.timestamp,!0,!0)} (${o.format(t.timestamp)})`)}r.appendMarkdown(`

`)}if(r.appendMarkdown(`${t.message}

`),t.statistics){if(r.appendMarkdown(`---

`),r.appendMarkdown(`<span>${t.statistics.files===1?l("fileChanged","{0} file changed",t.statistics.files):l("filesChanged","{0} files changed",t.statistics.files)}</span>`),t.statistics.insertions){const o=e.getColor(Be);r.appendMarkdown(`,&nbsp;<span style="color:${o};">${t.statistics.insertions===1?l("insertion","{0} insertion{1}",t.statistics.insertions,"(+)"):l("insertions","{0} insertions{1}",t.statistics.insertions,"(+)")}</span>`)}if(t.statistics.deletions){const o=e.getColor(Ge);r.appendMarkdown(`,&nbsp;<span style="color:${o};">${t.statistics.deletions===1?l("deletion","{0} deletion{1}",t.statistics.deletions,"(-)"):l("deletions","{0} deletions{1}",t.statistics.deletions,"(-)")}</span>`)}}return(t.references??[]).length>0&&(r.appendMarkdown(`

---

`),r.appendMarkdown((t.references??[]).map(o=>{const s=g.isThemeIcon(o.icon)?o.icon.id:"",n=o.color?S(o.color):S(re);return`<span style="color:${o.color?S(te):S(ze)};background-color:${n};border-radius:2px;">&nbsp;$(${s})&nbsp;${o.name}&nbsp;</span>`}).join("&nbsp;&nbsp;"))),{markdown:r,markdownNotSupportedFallback:t.message}}processMatches(i,e){return e?[i.historyItem.message===e.label?J(e.score):void 0,i.historyItem.author===e.label?J(e.score):void 0]:[void 0,void 0]}disposeElement(i,e,t,r){t.elementDisposables.clear()}disposeTemplate(i){i.disposables.dispose()}};M=v([a(1,P),a(2,W),a(3,Z)],M);let C=class{constructor(i,e,t){this._loadingMore=i;this._loadMoreCallback=e;this._configurationService=t}static TEMPLATE_ID="historyItemLoadMore";get templateId(){return C.TEMPLATE_ID}renderTemplate(i){i.parentElement.parentElement.querySelector(".monaco-tl-twistie").classList.add("force-no-twistie");const e=f(i,y(".history-item-load-more")),t=f(e,y(".graph-placeholder")),r=f(e,y(".history-item-placeholder")),o=new Y(r,{supportIcons:!0});return{element:e,graphPlaceholder:t,historyItemPlaceholderContainer:r,historyItemPlaceholderLabel:o,elementDisposables:new k,disposables:new k}}renderElement(i,e,t,r){t.graphPlaceholder.textContent="",t.graphPlaceholder.style.width=`${Oe*(i.element.graphColumns.length+1)}px`,t.graphPlaceholder.appendChild(Qe(i.element.graphColumns));const o=this._configurationService.getValue("scm.graph.pageOnScroll")===!0;t.historyItemPlaceholderContainer.classList.toggle("shimmer",o),o?(t.historyItemPlaceholderLabel.setLabel(""),this._loadMoreCallback(i.element.repository)):t.elementDisposables.add(D(s=>{const d=`$(${this._loadingMore().read(s)?"loading~spin":"fold-down"})`;t.historyItemPlaceholderLabel.setLabel(l("loadMore","{0} Load More...",d))}))}disposeElement(i,e,t,r){t.elementDisposables.clear()}disposeTemplate(i){i.disposables.dispose()}};C=v([a(2,P)],C);let E=class extends we{constructor(e,t,r,o){super("element",!0,()=>this.getHoverOptions(),r,o);this._viewContainerLocation=e;this.layoutService=t}getHoverOptions(){const e=this.layoutService.getSideBarPosition();let t;return this._viewContainerLocation===ee.Sidebar?t=e===oe.LEFT?R.RIGHT:R.LEFT:this._viewContainerLocation===ee.AuxiliaryBar?t=e===oe.LEFT?R.LEFT:R.RIGHT:t=R.RIGHT,{additionalClasses:["history-item-hover"],position:{hoverPosition:t,forcePosition:!0}}}};E=v([a(1,We),a(2,P),a(3,W)],E);let V=class extends je{constructor(e){super();this._progressService=e}runAction(e,t){return this._progressService.withProgress({location:B},async()=>await super.runAction(e,t))}};V=v([a(0,le)],V);class dt{getWidgetAriaLabel(){return l("scm history","Source Control History")}getAriaLabel(i){if(U(i))return`${i.provider.name} ${i.provider.label}`;if(w(i)){const e=i.historyItemViewModel.historyItem;return`${qe(e.message).trim()}${e.author?`, ${e.author}`:""}`}else return""}}class mt{getId(i){if(U(i))return`repo:${i.provider.id}`;if(w(i)){const e=i.repository.provider,t=i.historyItemViewModel.historyItem;return`historyItem:${e.id}/${t.id}/${t.parentIds.join(",")}`}else{if(G(i))return`historyItemLoadMore:${i.repository.provider.id}}`;throw new Error("Invalid tree element")}}}class pt{getKeyboardNavigationLabel(i){if(!U(i)){if(w(i))return[i.historyItemViewModel.historyItem.message,i.historyItemViewModel.historyItem.author];if(G(i))return"";throw new Error("Invalid tree element")}}}class ht extends F{async getChildren(i){if(!(i instanceof _))return[];const e=[],t=await i.getHistoryItems();e.push(...t);const r=i.repository.get(),o=Xe(t);return r&&o&&o.historyItemViewModel.outputSwimlanes.length>0&&e.push({repository:r,graphColumns:o.historyItemViewModel.outputSwimlanes,type:"historyItemLoadMore"}),e}hasChildren(i){return i instanceof _}}let _=class extends F{constructor(e,t,r){super();this._configurationService=e;this._scmService=t;this._scmViewService=r;this._register(D(o=>{const s=this._closedRepository.read(o);s&&(this.repository.get()===s&&this._selectedRepository.set(pe.first(this._scmService.repositories)??"auto",void 0),this._state.delete(s))}))}_closedRepository=ce(this,this._scmService.onDidRemoveRepository,e=>e);_firstRepository=this._scmService.repositoryCount>0?Ze(pe.first(this._scmService.repositories)):ce(this,ot.once(this._scmService.onDidAddRepository),e=>e);_selectedRepository=O(this,"auto");_graphRepository=$(e=>{const t=this._selectedRepository.read(e);return t!=="auto"?t:this._scmViewService.activeRepository.read(e)});repository=et(this,[this._firstRepository,this._graphRepository]);historyItemsFilter=O(this,"auto");_state=new Map;clearRepositoryState(){const e=this.repository.get();e&&this._state.delete(e)}setLoadMore(e,t){const r=this._state.get(e);r&&this._state.set(e,{...r,loadMore:t})}async getHistoryItems(){const e=this.repository.get();if(!e)return[];let t=this._state.get(e);const r=e.provider.historyProvider.get();if(!r)return[];if(!t||t.loadMore){const s=t?.items??[];let n=t?.historyItemRefs;if(!n){const h=this.historyItemsFilter.get();switch(h){case"all":n=await r.provideHistoryItemRefs()??[];break;case"auto":n=[r.currentHistoryItemRef.get(),r.currentHistoryItemRemoteRef.get(),r.currentHistoryItemBaseRef.get()].filter(I=>!!I);break;default:n=h;break}}const d=st(this._configurationService.getValue("scm.graph.pageSize"),1,1e3),p=n.map(h=>h.revision??h.id),u=await r.provideHistoryItems({historyItemRefs:p,limit:d,skip:s.length})??[];t={historyItemRefs:n,items:[...s,...u],loadMore:!1},this._state.set(e,t)}const o=this._getGraphColorMap(t.historyItemRefs);return $e(t.items,o).map(s=>({repository:e,historyItemViewModel:s,type:"historyItemViewModel"}))}setRepository(e){this._selectedRepository.set(e,void 0)}setHistoryItemsFilter(e){this.historyItemsFilter.set(e,void 0)}_getGraphColorMap(e){const o=this.repository.get()?.provider.historyProvider.get()?.currentHistoryItemGroup.get(),s=new Map;o&&(s.set(o.id,xe),o.remote&&s.set(o.remote.id,Fe),o.base&&s.set(o.base.id,De));for(const n of e)s.has(n.id)||s.set(n.id,void 0);return s}dispose(){this._state.clear(),super.dispose()}};_=v([a(0,P),a(1,Ne),a(2,ie)],_);let A=class extends F{constructor(e,t){super();this._quickInputService=e;this._scmViewService=t}_autoQuickPickItem={label:l("auto","Auto"),description:l("activeRepository","Show the source control graph for the active repository"),repository:"auto"};async pickRepository(){const e=[this._autoQuickPickItem,{type:"separator"}];return e.push(...this._scmViewService.repositories.map(t=>({label:t.provider.name,description:t.provider.rootUri?.fsPath,iconClass:g.asClassName(L.repo),repository:t}))),this._quickInputService.pick(e,{placeHolder:l("scmGraphRepository","Select the repository to view, type to filter all repositories")})}};A=v([a(0,me),a(1,ie)],A);let x=class extends F{constructor(e,t,r){super();this._historyProvider=e;this._historyItemsFilter=t;this._quickInputService=r}_allQuickPickItem={id:"all",label:l("all","All"),description:l("allHistoryItemRefs","All history item references"),historyItemRef:"all"};_autoQuickPickItem={id:"auto",label:l("auto","Auto"),description:l("currentHistoryItemRef","Current history item reference(s)"),historyItemRef:"auto"};async pickHistoryItemRef(){const e=this._quickInputService.createQuickPick({useSeparators:!0});this._store.add(e),e.placeholder=l("scmGraphHistoryItemRef","Select one/more history item references to view, type to filter"),e.canSelectMany=!0,e.hideCheckAll=!0,e.busy=!0,e.show(),e.items=await this._createQuickPickItems(),e.busy=!1;let t=[];if(this._historyItemsFilter==="all")t.push(this._allQuickPickItem),e.selectedItems=[this._allQuickPickItem];else if(this._historyItemsFilter==="auto")t.push(this._autoQuickPickItem),e.selectedItems=[this._autoQuickPickItem];else{for(const r of e.items)r.type!=="separator"&&this._historyItemsFilter.some(o=>o.id===r.id)&&t.push(r);e.selectedItems=t}return new Promise(r=>{this._store.add(e.onDidChangeSelection(o=>{const{added:s}=Ye(t,o,(n,d)=>he(n.id??"",d.id??""));s.length>0&&(s[0].historyItemRef==="all"||s[0].historyItemRef==="auto"?e.selectedItems=[s[0]]:e.selectedItems=[...e.selectedItems.filter(n=>n.historyItemRef!=="all"&&n.historyItemRef!=="auto")]),t=[...e.selectedItems]})),this._store.add(e.onDidAccept(()=>{t.length===1&&t[0].historyItemRef==="all"?r("all"):t.length===1&&t[0].historyItemRef==="auto"?r("auto"):r(t.map(o=>o.historyItemRef)),e.hide()})),this._store.add(e.onDidHide(()=>{r(void 0),this.dispose()}))})}async _createQuickPickItems(){const e=[this._allQuickPickItem,this._autoQuickPickItem],t=await this._historyProvider.provideHistoryItemRefs()??[],r=Je(t,(o,s)=>he(o.category??"",s.category??""));for(const o of r)o.length!==0&&(e.push({type:"separator",label:o[0].category}),e.push(...o.map(s=>({id:s.id,label:s.name,description:s.description,iconClass:g.isThemeIcon(s.icon)?g.asClassName(s.icon):void 0,historyItemRef:s}))));return e}};x=v([a(2,me)],x);let N=class extends Le{constructor(e,t,r,o,s,n,d,p,u,h,I,m,b,ue){super({...e,titleMenuId:T.SCMHistoryTitle,showActions:Ee.WhenExpanded},d,n,s,h,u,p,I,m,b,ue);this._commandService=t;this._instantiationService=r;this._progressService=o;this._scmProviderCtx=rt.SCMProvider.bindTo(this.scopedContextKeyService),this._actionRunner=this.instantiationService.createInstance(V),this._register(this._actionRunner),this._register(this._updateChildrenThrottler)}_treeContainer;_tree;_treeViewModel;_treeDataSource;_treeIdentityProvider;_repositoryLoadMore=O(this,!1);_repositoryOutdated=O(this,!1);_actionRunner;_visibilityDisposables=new k;_treeOperationSequencer=new se;_treeLoadMoreSequencer=new se;_updateChildrenThrottler=new Ue;_scmProviderCtx;renderHeaderTitle(e){super.renderHeaderTitle(e,this.title);const t=H("div.scm-graph-view-badge-container",[H("div.scm-graph-view-badge.monaco-count-badge.long@badge")]);t.badge.textContent="Outdated",e.appendChild(t.root),this._register(D(r=>{const o=this._repositoryOutdated.read(r);t.root.style.display=o?"":"none"}))}renderBody(e){super.renderBody(e),this._treeContainer=f(e,y(".scm-view.scm-history-view")),this._treeContainer.classList.add("file-icon-themable-tree"),this._createTree(this._treeContainer),this.onDidChangeBodyVisibility(async t=>{if(t){this._treeViewModel=this.instantiationService.createInstance(_),this._visibilityDisposables.add(this._treeViewModel);const r=$(this,s=>{const n=this._treeViewModel.repository.read(s);return n?.provider.historyProvider.read(s)?.currentHistoryItemGroup.read(s)!==void 0?n:void 0});await Ce(r),this._treeOperationSequencer.queue(async()=>{await this._tree.setInput(this._treeViewModel),this._tree.scrollTop=0});let o=!0;this._visibilityDisposables.add(Se((s,n)=>{const d=this._treeViewModel.repository.read(s),p=d?.provider.historyProvider.read(s);if(!d||!p)return;this._scmProviderCtx.set(d.provider.contextValue);const u=j(this,p.currentHistoryItemRef),h=j(this,$(m=>p.currentHistoryItemRemoteRef.read(m)?.id)),I=j(this,$(m=>p.currentHistoryItemRemoteRef.read(m)?.revision));n.add(Me({owner:this,createEmptyChangeSummary:()=>({refresh:!1}),handleChange(m,b){return b.refresh=m.didChange(I)?"ifScrollTop":!0,!0}},(m,b)=>{if(u.read(m),h.read(m),I.read(m),b.refresh===!0){this.refresh();return}if(b.refresh==="ifScrollTop"){if(this._tree.scrollTop===0){this.refresh();return}this._repositoryOutdated.set(!0,void 0)}})),n.add(tt(this._treeViewModel.historyItemsFilter,()=>{this.refresh()})),o||this.refresh(),o=!1}))}else this._visibilityDisposables.clear()})}layoutBody(e,t){super.layoutBody(e,t),this._tree.layout(e,t)}getActionRunner(){return this._actionRunner}getActionsContext(){return this._treeViewModel?.repository.get()?.provider}getActionViewItem(e,t){if(e.id==="workbench.scm.graph.action.pickRepository"){const r=this._treeViewModel?.repository.get();if(r)return new at(r,e,t)}else if(e.id==="workbench.scm.graph.action.pickHistoryItemRefs"){const r=this._treeViewModel?.repository.get(),o=this._treeViewModel?.historyItemsFilter.get();if(r&&o)return new lt(r,o,e,t)}return super.getActionViewItem(e,t)}async refresh(){await this._updateChildren(!0),this.updateActions(),this._repositoryOutdated.set(!1,void 0),this._tree.scrollTop=0}async pickRepository(){const t=await this._instantiationService.createInstance(A).pickRepository();t&&this._treeViewModel.setRepository(t.repository)}async pickHistoryItemRef(){const t=this._treeViewModel.repository.get()?.provider.historyProvider.get(),r=this._treeViewModel.historyItemsFilter.get();if(!t)return;const s=await this._instantiationService.createInstance(x,t,r).pickHistoryItemRef();s&&this._treeViewModel.setHistoryItemsFilter(s)}_createTree(e){this._treeIdentityProvider=new mt;const t=this.instantiationService.createInstance(E,this.viewDescriptorService.getViewLocationById(this.id));this._register(t),this._treeDataSource=this.instantiationService.createInstance(ht),this._register(this._treeDataSource),this._tree=this.instantiationService.createInstance(He,"SCM History Tree",e,new ct,[this.instantiationService.createInstance(M,t),this.instantiationService.createInstance(C,()=>this._repositoryLoadMore,r=>this._loadMoreCallback(r))],this._treeDataSource,{accessibilityProvider:new dt,identityProvider:this._treeIdentityProvider,collapseByDefault:r=>!1,keyboardNavigationLabelProvider:new pt,horizontalScrolling:!1,multipleSelectionSupport:!1}),this._register(this._tree),this._tree.onDidOpen(this._onDidOpen,this,this._store),this._tree.onContextMenu(this._onContextMenu,this,this._store)}async _onDidOpen(e){if(e.element)if(w(e.element)){const t=e.element.historyItemViewModel.historyItem,r=t.parentIds.length>0?t.parentIds[0]:void 0,s=await e.element.repository.provider.historyProvider.get()?.provideHistoryItemChanges(t.id,r);if(s){const n=`${t.displayId??t.id} - ${t.message}`,d=e.element.repository.provider.rootUri,p=d?d.path:e.element.repository.provider.label,u=ne.from({scheme:"scm-history-item",path:`${p}/${r}..${t.id}`},!0);await this._commandService.executeCommand("_workbench.openMultiDiffEditor",{title:n,multiDiffSourceUri:u,resources:s})}}else G(e.element)&&(this.configurationService.getValue("scm.graph.pageOnScroll")===!0||(this._loadMoreCallback(e.element.repository),this._tree.setSelection([])));else return}_onContextMenu(e){const t=e.element;!t||!w(t)||this.contextMenuService.showContextMenu({menuId:T.SCMChangesContext,menuActionOptions:{arg:t.repository.provider,shouldForwardArgs:!0},getAnchor:()=>e.anchor,getActionsContext:()=>t.historyItemViewModel.historyItem})}async _loadMoreCallback(e){return this._treeLoadMoreSequencer.queue(async()=>{this._repositoryLoadMore.get()||(this._repositoryLoadMore.set(!0,void 0),this._treeViewModel.setLoadMore(e,!0),await this._updateChildren(),this._repositoryLoadMore.set(!1,void 0))})}_updateChildren(e=!1){return this._updateChildrenThrottler.queue(()=>this._treeOperationSequencer.queue(async()=>{e&&this._treeViewModel.clearRepositoryState(),await this._progressService.withProgress({location:this.id},async()=>{await this._tree.updateChildren(void 0,void 0,void 0,{})})}))}dispose(){this._visibilityDisposables.dispose(),super.dispose()}};N=v([a(1,ae),a(2,X),a(3,le),a(4,P),a(5,be),a(6,Te),a(7,X),a(8,Ve),a(9,_e),a(10,ke),a(11,Z),a(12,Pe),a(13,W)],N);export{N as SCMHistoryViewPane};
