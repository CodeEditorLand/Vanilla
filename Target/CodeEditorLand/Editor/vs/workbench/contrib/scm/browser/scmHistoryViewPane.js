var ae=Object.defineProperty;var le=Object.getOwnPropertyDescriptor;var I=(c,r,e,t)=>{for(var o=t>1?void 0:t?le(r,e):r,i=c.length-1,s;i>=0;i--)(s=c[i])&&(o=(t?s(r,e,o):s(o))||o);return t&&o&&ae(r,e,o),o},n=(c,r)=>(e,t)=>r(e,t,c);import"./media/scm.css";import{$ as f,append as h,h as x,reset as de}from"../../../../base/browser/dom.js";import"../../../../base/browser/ui/actionbar/actionbar.js";import{ActionViewItem as ce}from"../../../../base/browser/ui/actionbar/actionViewItems.js";import"../../../../base/browser/ui/dropdown/dropdownActionViewItem.js";import"../../../../base/browser/ui/hover/hover.js";import"../../../../base/browser/ui/hover/hoverDelegate.js";import{HoverPosition as w}from"../../../../base/browser/ui/hover/hoverWidget.js";import{IconLabel as z}from"../../../../base/browser/ui/iconLabel/iconLabel.js";import{renderLabelWithIcons as pe}from"../../../../base/browser/ui/iconLabel/iconLabels.js";import"../../../../base/browser/ui/list/list.js";import"../../../../base/browser/ui/list/listWidget.js";import"../../../../base/browser/ui/tree/abstractTree.js";import"../../../../base/browser/ui/tree/tree.js";import{ActionRunner as me}from"../../../../base/common/actions.js";import{tail as he}from"../../../../base/common/arrays.js";import{Sequencer as N,Throttler as ue}from"../../../../base/common/async.js";import{Codicon as q}from"../../../../base/common/codicons.js";import{fromNow as ye}from"../../../../base/common/date.js";import{Event as ve}from"../../../../base/common/event.js";import{createMatches as B}from"../../../../base/common/filters.js";import{MarkdownString as Ie}from"../../../../base/common/htmlContent.js";import{stripIcons as fe}from"../../../../base/common/iconLabels.js";import{Iterable as K}from"../../../../base/common/iterator.js";import{Disposable as W,DisposableStore as _}from"../../../../base/common/lifecycle.js";import{clamp as ge}from"../../../../base/common/numbers.js";import{autorun as P,autorunDelta as Se,autorunWithStore as Me,derived as Ce,observableValue as $}from"../../../../base/common/observable.js";import{constObservable as be,derivedConstOnceDefined as we,latestChangedValue as _e,observableFromEvent as U}from"../../../../base/common/observableInternal/utils.js";import*as Te from"../../../../base/common/platform.js";import{ThemeIcon as V}from"../../../../base/common/themables.js";import{URI as Q}from"../../../../base/common/uri.js";import{localize as p}from"../../../../nls.js";import{Action2 as Le,MenuId as T,registerAction2 as R}from"../../../../platform/actions/common/actions.js";import{ICommandService as j}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as L}from"../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as k,IContextKeyService as He}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as Ee}from"../../../../platform/contextview/browser/contextView.js";import{IHoverService as O,WorkbenchHoverDelegate as Pe}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as Ve}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as ke}from"../../../../platform/keybinding/common/keybinding.js";import{WorkbenchAsyncDataTree as De}from"../../../../platform/list/browser/listService.js";import{observableConfigValue as Ae}from"../../../../platform/observable/common/platformObservableUtils.js";import{IOpenerService as xe}from"../../../../platform/opener/common/opener.js";import{IProgressService as Y}from"../../../../platform/progress/common/progress.js";import{IQuickInputService as $e}from"../../../../platform/quickinput/common/quickInput.js";import{ITelemetryService as Re}from"../../../../platform/telemetry/common/telemetry.js";import{asCssVariable as u,foreground as Oe}from"../../../../platform/theme/common/colorRegistry.js";import{IThemeService as J}from"../../../../platform/theme/common/themeService.js";import{ViewAction as X,ViewPane as Fe,ViewPaneShowActions as Ge}from"../../../browser/parts/views/viewPane.js";import{IViewDescriptorService as ze,ViewContainerLocation as Z}from"../../../common/views.js";import{IWorkbenchLayoutService as Ne,Position as ee}from"../../../services/layout/browser/layoutService.js";import"../common/history.js";import{HISTORY_VIEW_PANE_ID as F,ISCMService as qe,ISCMViewService as te}from"../common/scm.js";import{historyItemGroupBase as Be,historyItemGroupLocal as Ke,historyItemGroupRemote as We,historyItemHoverAdditionsForeground as Ue,historyItemHoverDefaultLabelBackground as re,historyItemHoverDefaultLabelForeground as Qe,historyItemHoverDeletionsForeground as je,historyItemHoverLabelForeground as oe,renderSCMHistoryGraphPlaceholder as Ye,renderSCMHistoryItemGraph as Je,SWIMLANE_WIDTH as Xe,toISCMHistoryItemViewModelArray as Ze}from"./scmHistory.js";import{ContextKeys as et}from"./scmViewPane.js";import{isSCMHistoryItemLoadMoreTreeElement as D,isSCMHistoryItemViewModelTreeElement as S,isSCMRepository as G}from"./util.js";class tt extends ce{constructor(e,t,o){super(null,t,{...o,icon:!1,label:!0});this._repository=e}updateLabel(){this.options.label&&this.label&&(this.label.classList.add("scm-graph-repository-picker"),de(this.label,...pe(`$(repo) ${this._repository.provider.name}`)))}}R(class extends X{constructor(){super({id:"workbench.scm.action.repository",title:"",viewId:F,f1:!1,menu:{id:T.SCMHistoryTitle,when:k.and(k.has("scm.providerCount"),k.greater("scm.providerCount",1)),group:"navigation",order:0}})}async runInView(c,r){r.pickRepository()}}),R(class extends X{constructor(){super({id:"workbench.scm.action.refreshGraph",title:p("refreshGraph","Refresh"),viewId:F,f1:!1,icon:q.refresh,menu:{id:T.SCMHistoryTitle,group:"navigation",order:1e3}})}async runInView(c,r){r.refresh()}}),R(class extends Le{constructor(){super({id:"workbench.scm.action.scm.viewChanges",title:p("viewChanges","View Changes"),f1:!1,menu:[{id:T.SCMChangesContext,group:"0_view",when:k.equals("config.multiDiffEditor.experimental.enabled",!0)}]})}async run(c,r,...e){const t=c.get(j);if(!r||e.length===0)return;const o=e[0],i=e[e.length-1],s=r.historyProvider.get();if(e.length>1){const b=await s?.resolveHistoryItemGroupCommonAncestor([o.id,i.id]);if(!b||b!==o.id&&b!==i.id)return}const a=i.parentIds.length>0?i.parentIds[0]:void 0,l=await s?.provideHistoryItemChanges(o.id,a);if(!l?.length)return;const m=e.length===1?`${e[0].displayId??e[0].id} - ${e[0].message}`:p("historyItemChangesEditorTitle","All Changes ({0} \u2194 {1})",i.displayId??i.id,o.displayId??o.id),d=r.rootUri,M=d?d.path:r.label,C=Q.from({scheme:"scm-history-item",path:`${M}/${a}..${o.id}`},!0);t.executeCommand("_workbench.openMultiDiffEditor",{title:m,multiDiffSourceUri:C,resources:l})}});class rt{getHeight(){return 22}getTemplateId(r){if(S(r))return y.TEMPLATE_ID;if(D(r))return v.TEMPLATE_ID;throw new Error("Unknown element")}}let y=class{constructor(r,e,t,o){this.hoverDelegate=r;this._configurationService=e;this._hoverService=t;this._themeService=o}static TEMPLATE_ID="history-item";get templateId(){return y.TEMPLATE_ID}_labelConfig=Ae("scm.graph.labels","filter",this._configurationService);renderTemplate(r){r.parentElement.parentElement.querySelector(".monaco-tl-twistie").classList.add("force-no-twistie");const e=h(r,f(".history-item")),t=h(e,f(".graph-container")),o=new z(e,{supportIcons:!0,supportHighlights:!0,supportDescriptionHighlights:!0}),i=h(e,f(".label-container"));return e.appendChild(i),{element:e,graphContainer:t,label:o,labelContainer:i,elementDisposables:new _,disposables:new _}}renderElement(r,e,t,o){const i=r.element.historyItemViewModel,s=i.historyItem,a=this._hoverService.setupManagedHover(this.hoverDelegate,t.element,this.getTooltip(r.element));t.elementDisposables.add(a),t.graphContainer.textContent="",t.graphContainer.appendChild(Je(i));const d=r.element.repository.provider.historyProvider.get()?.currentHistoryItemGroup?.get()?.revision===s.id?["history-item-current"]:[],[M,C]=this.processMatches(i,r.filterData);t.label.setLabel(s.subject,s.author,{matches:M,descriptionMatches:C,extraClasses:d}),this._renderLabels(s,t)}_renderLabels(r,e){e.elementDisposables.add(P(t=>{const o=this._labelConfig.read(t);e.labelContainer.textContent="";const i=r.labels?.find(s=>s.color);for(const s of r.labels??[])if(!(!s.color&&o==="filter")&&s.icon&&V.isThemeIcon(s.icon)){const a=x("div.label",{style:{color:s.color?u(oe):u(Oe),backgroundColor:s.color?u(s.color):u(re)}},[x("div.icon@icon"),x("div.description@description")]);a.icon.classList.add(...V.asClassNameArray(s.icon)),a.description.textContent=s.title,a.description.style.display=s===i?"":"none",h(e.labelContainer,a.root)}}))}getTooltip(r){const e=this._themeService.getColorTheme(),t=r.historyItemViewModel.historyItem,o=new Ie("",{isTrusted:!0,supportThemeIcons:!0});if(o.appendMarkdown(`$(git-commit) \`${t.displayId??t.id}\`

`),t.author){if(o.appendMarkdown(`$(account) **${t.author}**`),t.timestamp){const i=new Intl.DateTimeFormat(Te.language,{year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"});o.appendMarkdown(`, $(history) ${ye(t.timestamp,!0,!0)} (${i.format(t.timestamp)})`)}o.appendMarkdown(`

`)}if(o.appendMarkdown(`${t.message}

`),t.statistics){if(o.appendMarkdown(`---

`),o.appendMarkdown(`<span>${t.statistics.files===1?p("fileChanged","{0} file changed",t.statistics.files):p("filesChanged","{0} files changed",t.statistics.files)}</span>`),t.statistics.insertions){const i=e.getColor(Ue);o.appendMarkdown(`,&nbsp;<span style="color:${i};">${t.statistics.insertions===1?p("insertion","{0} insertion{1}",t.statistics.insertions,"(+)"):p("insertions","{0} insertions{1}",t.statistics.insertions,"(+)")}</span>`)}if(t.statistics.deletions){const i=e.getColor(je);o.appendMarkdown(`,&nbsp;<span style="color:${i};">${t.statistics.deletions===1?p("deletion","{0} deletion{1}",t.statistics.deletions,"(-)"):p("deletions","{0} deletions{1}",t.statistics.deletions,"(-)")}</span>`)}}return(t.labels??[]).length>0&&(o.appendMarkdown(`

---

`),o.appendMarkdown((t.labels??[]).map(i=>{const s=V.isThemeIcon(i.icon)?i.icon.id:"",a=i.color?u(i.color):u(re);return`<span style="color:${i.color?u(oe):u(Qe)};background-color:${a};border-radius:2px;">&nbsp;$(${s})&nbsp;${i.title}&nbsp;</span>`}).join("&nbsp;&nbsp;"))),{markdown:o,markdownNotSupportedFallback:t.message}}processMatches(r,e){return e?[r.historyItem.message===e.label?B(e.score):void 0,r.historyItem.author===e.label?B(e.score):void 0]:[void 0,void 0]}disposeElement(r,e,t,o){t.elementDisposables.clear()}disposeTemplate(r){r.disposables.dispose()}};y=I([n(1,L),n(2,O),n(3,J)],y);let v=class{constructor(r,e,t){this._loadingMore=r;this._loadMoreCallback=e;this._configurationService=t}static TEMPLATE_ID="historyItemLoadMore";get templateId(){return v.TEMPLATE_ID}renderTemplate(r){r.parentElement.parentElement.querySelector(".monaco-tl-twistie").classList.add("force-no-twistie");const e=h(r,f(".history-item-load-more")),t=h(e,f(".graph-placeholder")),o=h(e,f(".history-item-placeholder")),i=new z(o,{supportIcons:!0});return{element:e,graphPlaceholder:t,historyItemPlaceholderContainer:o,historyItemPlaceholderLabel:i,elementDisposables:new _,disposables:new _}}renderElement(r,e,t,o){t.graphPlaceholder.textContent="",t.graphPlaceholder.style.width=`${Xe*(r.element.graphColumns.length+1)}px`,t.graphPlaceholder.appendChild(Ye(r.element.graphColumns));const i=this._configurationService.getValue("scm.graph.pageOnScroll")===!0;t.historyItemPlaceholderContainer.classList.toggle("shimmer",i),i?(t.historyItemPlaceholderLabel.setLabel(""),this._loadMoreCallback(r.element.repository)):t.elementDisposables.add(P(s=>{const l=`$(${this._loadingMore().read(s)?"loading~spin":"fold-down"})`;t.historyItemPlaceholderLabel.setLabel(p("loadMore","{0} Load More...",l))}))}disposeElement(r,e,t,o){t.elementDisposables.clear()}disposeTemplate(r){r.disposables.dispose()}};v=I([n(2,L)],v);let H=class extends Pe{constructor(e,t,o,i){super("element",!0,()=>this.getHoverOptions(),o,i);this._viewContainerLocation=e;this.layoutService=t}getHoverOptions(){const e=this.layoutService.getSideBarPosition();let t;return this._viewContainerLocation===Z.Sidebar?t=e===ee.LEFT?w.RIGHT:w.LEFT:this._viewContainerLocation===Z.AuxiliaryBar?t=e===ee.LEFT?w.LEFT:w.RIGHT:t=w.RIGHT,{additionalClasses:["history-item-hover"],position:{hoverPosition:t,forcePosition:!0}}}};H=I([n(1,Ne),n(2,L),n(3,O)],H);let E=class extends me{constructor(e){super();this._progressService=e}runAction(e,t){return this._progressService.withProgress({location:F},async()=>await super.runAction(e,t))}};E=I([n(0,Y)],E);class ot{getWidgetAriaLabel(){return p("scm history","Source Control History")}getAriaLabel(r){if(G(r))return`${r.provider.name} ${r.provider.label}`;if(S(r)){const e=r.historyItemViewModel.historyItem;return`${fe(e.message).trim()}${e.author?`, ${e.author}`:""}`}else return""}}class it{getId(r){if(G(r))return`repo:${r.provider.id}`;if(S(r)){const e=r.repository.provider,t=r.historyItemViewModel.historyItem;return`historyItem:${e.id}/${t.id}/${t.parentIds.join(",")}`}else{if(D(r))return`historyItemLoadMore:${r.repository.provider.id}}`;throw new Error("Invalid tree element")}}}class st{getKeyboardNavigationLabel(r){if(!G(r)){if(S(r))return[r.historyItemViewModel.historyItem.message,r.historyItemViewModel.historyItem.author];if(D(r))return"";throw new Error("Invalid tree element")}}}class nt extends W{async getChildren(r){if(!(r instanceof g))return[];const e=[],t=await r.getHistoryItems();e.push(...t);const o=r.repository.get(),i=he(t);return o&&i&&i.historyItemViewModel.outputSwimlanes.length>0&&e.push({repository:o,graphColumns:i.historyItemViewModel.outputSwimlanes,type:"historyItemLoadMore"}),e}hasChildren(r){return r instanceof g}}let g=class extends W{constructor(e,t,o){super();this._configurationService=e;this._scmService=t;this._scmViewService=o;this._register(P(i=>{const s=this._closedRepository.read(i);s&&(this.repository.get()===s&&this._selectedRepository.set(K.first(this._scmService.repositories)??"auto",void 0),this._state.delete(s))}))}_closedRepository=U(this,this._scmService.onDidRemoveRepository,e=>e);_firstRepository=this._scmService.repositoryCount>0?be(K.first(this._scmService.repositories)):U(this,ve.once(this._scmService.onDidAddRepository),e=>e);_selectedRepository=$(this,"auto");_graphRepository=Ce(e=>{const t=this._selectedRepository.read(e);return t!=="auto"?t:this._scmViewService.activeRepository.read(e)});repository=_e(this,[this._firstRepository,this._graphRepository]);_historyItemGroupIds=$(this,"auto");_state=new Map;clearRepositoryState(){const e=this.repository.get();e&&this._state.delete(e)}setLoadMore(e,t){const o=this._state.get(e);o&&this._state.set(e,{...o,loadMore:t})}async getHistoryItems(){const e=this.repository.get();if(!e)return[];let t=this._state.get(e);const o=e.provider.historyProvider.get(),i=t?.currentHistoryItemGroup??o?.currentHistoryItemGroup.get();if(!o||!i)return[];if(!t||t.loadMore){const a=[i.revision??i.id,...i.remote?[i.remote.revision??i.remote.id]:[],...i.base?[i.base.revision??i.base.id]:[]],l=t?.items??[],m=ge(this._configurationService.getValue("scm.graph.pageSize"),1,1e3),d=await o.provideHistoryItems({historyItemGroupIds:a,limit:m,skip:l.length})??[];t={currentHistoryItemGroup:i,items:[...l,...d],loadMore:!1},this._state.set(e,t)}const s=this._getHistoryItemsColorMap(i);return Ze(t.items,s).map(a=>({repository:e,historyItemViewModel:a,type:"historyItemViewModel"}))}setRepository(e){this._selectedRepository.set(e,void 0)}_getHistoryItemsColorMap(e){if(this._historyItemGroupIds.get()!=="auto")return new Map;const t=new Map([[e.name,Ke]]);return e.remote&&t.set(e.remote.name,We),e.base&&t.set(e.base.name,Be),t}dispose(){this._state.clear(),super.dispose()}};g=I([n(0,L),n(1,qe),n(2,te)],g);let A=class extends Fe{constructor(e,t,o,i,s,a,l,m,d,M,C,b,ie,se,ne){super({...e,titleMenuId:T.SCMHistoryTitle,showActions:Ge.WhenExpanded},m,l,a,C,M,d,b,ie,se,ne);this._commandService=t;this._scmViewService=o;this._progressService=i;this._quickInputService=s;this._scmProviderCtx=et.SCMProvider.bindTo(this.scopedContextKeyService),this._actionRunner=this.instantiationService.createInstance(E),this._register(this._actionRunner),this._register(this._updateChildrenThrottler)}_treeContainer;_tree;_treeViewModel;_treeDataSource;_treeIdentityProvider;_repositoryLoadMore=$(this,!1);_actionRunner;_visibilityDisposables=new _;_treeOperationSequencer=new N;_treeLoadMoreSequencer=new N;_updateChildrenThrottler=new ue;_scmProviderCtx;layoutBody(e,t){super.layoutBody(e,t),this._tree.layout(e,t)}renderBody(e){super.renderBody(e),this._treeContainer=h(e,f(".scm-view.scm-history-view")),this._treeContainer.classList.add("file-icon-themable-tree"),this._createTree(this._treeContainer),this.onDidChangeBodyVisibility(t=>{if(t){this._treeViewModel=this.instantiationService.createInstance(g),this._visibilityDisposables.add(this._treeViewModel);const o=we(this,i=>this._treeViewModel.repository.read(i)?.provider.historyProvider.read(i)?.currentHistoryItemGroup.read(i));this._visibilityDisposables.add(P(async i=>{o.read(i)&&(this._treeOperationSequencer.queue(async()=>{await this._tree.setInput(this._treeViewModel),this._tree.scrollTop=0}),this._visibilityDisposables.add(Me((s,a)=>{const l=this._treeViewModel.repository.read(s),m=l?.provider.historyProvider.read(s);!l||!m||(this._scmProviderCtx.set(l.provider.contextValue),a.add(Se(m?.currentHistoryItemGroup,d=>{if(d.lastValue?.id!==d.newValue?.id||d.lastValue?.revision!==d.newValue?.revision||d.lastValue?.remote?.id!==d.newValue?.remote?.id){this.refresh();return}if(d.lastValue?.remote?.revision!==d.newValue?.remote?.revision){if(this._tree.scrollTop===0){this.refresh();return}this.updateTitleDescription(p("outdated","OUTDATED"))}})))})))}))}else this._visibilityDisposables.clear()})}getActionRunner(){return this._actionRunner}getActionsContext(){return this._treeViewModel?.repository.get()?.provider}getActionViewItem(e,t){if(e.id==="workbench.scm.action.repository"){const o=this._treeViewModel?.repository.get();if(o)return new tt(o,e,t)}return super.getActionViewItem(e,t)}async refresh(){await this._updateChildren(!0),this.updateActions(),this.updateTitleDescription(void 0),this._tree.scrollTop=0}async pickRepository(){const e=[{label:p("auto","Auto"),description:p("activeRepository","Show the source control graph for the active repository"),repository:"auto"},{type:"separator"}];e.push(...this._scmViewService.repositories.map(o=>({label:o.provider.name,description:o.provider.rootUri?.fsPath,iconClass:V.asClassName(q.repo),repository:o})));const t=await this._quickInputService.pick(e,{placeHolder:p("scmGraphRepository","Select the repository to view, type to filter all repositories")});t&&this._treeViewModel.setRepository(t.repository)}_createTree(e){this._treeIdentityProvider=new it;const t=this.instantiationService.createInstance(H,this.viewDescriptorService.getViewLocationById(this.id));this._register(t),this._treeDataSource=this.instantiationService.createInstance(nt),this._register(this._treeDataSource),this._tree=this.instantiationService.createInstance(De,"SCM History Tree",e,new rt,[this.instantiationService.createInstance(y,t),this.instantiationService.createInstance(v,()=>this._repositoryLoadMore,o=>this._loadMoreCallback(o))],this._treeDataSource,{accessibilityProvider:new ot,identityProvider:this._treeIdentityProvider,collapseByDefault:o=>!1,keyboardNavigationLabelProvider:new st,horizontalScrolling:!1,multipleSelectionSupport:!1}),this._register(this._tree),this._tree.onDidOpen(this._onDidOpen,this,this._store),this._tree.onContextMenu(this._onContextMenu,this,this._store)}async _onDidOpen(e){if(e.element)if(S(e.element)){const t=e.element.historyItemViewModel.historyItem,o=t.parentIds.length>0?t.parentIds[0]:void 0,s=await e.element.repository.provider.historyProvider.get()?.provideHistoryItemChanges(t.id,o);if(s){const a=`${t.displayId??t.id} - ${t.message}`,l=e.element.repository.provider.rootUri,m=l?l.path:e.element.repository.provider.label,d=Q.from({scheme:"scm-history-item",path:`${m}/${o}..${t.id}`},!0);await this._commandService.executeCommand("_workbench.openMultiDiffEditor",{title:a,multiDiffSourceUri:d,resources:s})}}else D(e.element)&&(this.configurationService.getValue("scm.graph.pageOnScroll")===!0||(this._loadMoreCallback(e.element.repository),this._tree.setSelection([])));else return}_onContextMenu(e){const t=e.element;!t||!S(t)||this.contextMenuService.showContextMenu({menuId:T.SCMChangesContext,menuActionOptions:{arg:t.repository.provider,shouldForwardArgs:!0},getAnchor:()=>e.anchor,getActionsContext:()=>t.historyItemViewModel.historyItem})}async _loadMoreCallback(e){return this._treeLoadMoreSequencer.queue(async()=>{this._repositoryLoadMore.get()||(this._repositoryLoadMore.set(!0,void 0),this._treeViewModel.setLoadMore(e,!0),await this._updateChildren(),this._repositoryLoadMore.set(!1,void 0))})}_updateChildren(e=!1){return this._updateChildrenThrottler.queue(()=>this._treeOperationSequencer.queue(async()=>{e&&this._treeViewModel.clearRepositoryState(),await this._progressService.withProgress({location:this.id},async()=>{await this._tree.updateChildren(void 0,void 0,void 0,{})})}))}dispose(){this._visibilityDisposables.dispose(),super.dispose()}};A=I([n(1,j),n(2,te),n(3,Y),n(4,$e),n(5,L),n(6,Ee),n(7,ke),n(8,Ve),n(9,ze),n(10,He),n(11,xe),n(12,J),n(13,Re),n(14,O)],A);export{A as SCMHistoryViewPane};
