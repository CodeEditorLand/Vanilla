var Ie=Object.defineProperty;var fe=Object.getOwnPropertyDescriptor;var I=(d,i,e,t)=>{for(var r=t>1?void 0:t?fe(i,e):i,o=d.length-1,s;o>=0;o--)(s=d[o])&&(r=(t?s(i,e,r):s(r))||r);return t&&r&&Ie(i,e,r),r},l=(d,i)=>(e,t)=>i(e,t,d);import"./media/scm.css";import*as ve from"../../../../base/common/platform.js";import{$ as u,append as f,h as T,reset as U}from"../../../../base/browser/dom.js";import"../../../../base/browser/ui/hover/hover.js";import"../../../../base/browser/ui/hover/hoverDelegate.js";import{IconLabel as j}from"../../../../base/browser/ui/iconLabel/iconLabel.js";import"../../../../base/browser/ui/list/list.js";import"../../../../base/browser/ui/tree/abstractTree.js";import"../../../../base/browser/ui/tree/tree.js";import{fromNow as ge}from"../../../../base/common/date.js";import{createMatches as Y}from"../../../../base/common/filters.js";import{MarkdownString as Se}from"../../../../base/common/htmlContent.js";import{Disposable as x,DisposableStore as R}from"../../../../base/common/lifecycle.js";import{autorun as D,autorunWithStore as Ce,autorunWithStoreHandleChanges as Me,derived as F,observableValue as O,waitForState as _e,constObservable as be,latestChangedValue as we,observableFromEvent as J,runOnChange as Te,signalFromObservable as Re}from"../../../../base/common/observable.js";import{ThemeIcon as v}from"../../../../base/common/themables.js";import{localize as c}from"../../../../nls.js";import{IConfigurationService as H}from"../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as $,IContextKeyService as He}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as ke}from"../../../../platform/contextview/browser/contextView.js";import{IHoverService as K,WorkbenchHoverDelegate as Pe}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as X}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as Le}from"../../../../platform/keybinding/common/keybinding.js";import{WorkbenchAsyncDataTree as Ee}from"../../../../platform/list/browser/listService.js";import{IOpenerService as Ve}from"../../../../platform/opener/common/opener.js";import{ITelemetryService as Ae}from"../../../../platform/telemetry/common/telemetry.js";import{asCssVariable as g,foreground as xe}from"../../../../platform/theme/common/colorRegistry.js";import{IThemeService as Z}from"../../../../platform/theme/common/themeService.js";import{ViewAction as W,ViewPane as De,ViewPaneShowActions as Fe}from"../../../browser/parts/views/viewPane.js";import{IViewDescriptorService as Oe,ViewContainerLocation as ee}from"../../../common/views.js";import{renderSCMHistoryItemGraph as $e,toISCMHistoryItemViewModelArray as Qe,SWIMLANE_WIDTH as Be,renderSCMHistoryGraphPlaceholder as Ne,historyItemHoverDeletionsForeground as ze,historyItemHoverLabelForeground as te,historyItemHoverAdditionsForeground as qe,historyItemHoverDefaultLabelForeground as Ke,historyItemHoverDefaultLabelBackground as re}from"./scmHistory.js";import{isSCMHistoryItemLoadMoreTreeElement as Q,isSCMHistoryItemViewModelTreeElement as b,isSCMRepository as G}from"./util.js";import"../common/history.js";import{HISTORY_VIEW_PANE_ID as B,ISCMService as We,ISCMViewService as ie}from"../common/scm.js";import"../../../../base/browser/ui/list/listWidget.js";import{stripIcons as Ge}from"../../../../base/common/iconLabels.js";import{IWorkbenchLayoutService as Ue,Position as oe}from"../../../services/layout/browser/layoutService.js";import{HoverPosition as k}from"../../../../base/browser/ui/hover/hoverWidget.js";import{Action2 as je,MenuId as w,registerAction2 as N}from"../../../../platform/actions/common/actions.js";import{Sequencer as se,Throttler as Ye}from"../../../../base/common/async.js";import{URI as ne}from"../../../../base/common/uri.js";import{ICommandService as ae}from"../../../../platform/commands/common/commands.js";import{ActionRunner as Je}from"../../../../base/common/actions.js";import{delta as Xe,groupBy as Ze,tail as et}from"../../../../base/common/arrays.js";import{Codicon as P}from"../../../../base/common/codicons.js";import{IProgressService as le}from"../../../../platform/progress/common/progress.js";import{ContextKeys as tt}from"./scmViewPane.js";import"../../../../base/browser/ui/actionbar/actionbar.js";import"../../../../base/browser/ui/dropdown/dropdownActionViewItem.js";import{ActionViewItem as ce}from"../../../../base/browser/ui/actionbar/actionViewItems.js";import{IQuickInputService as de}from"../../../../platform/quickinput/common/quickInput.js";import{Event as rt}from"../../../../base/common/event.js";import{Iterable as me}from"../../../../base/common/iterator.js";import{clamp as it}from"../../../../base/common/numbers.js";import{observableConfigValue as ot}from"../../../../platform/observable/common/platformObservableUtils.js";import{compare as pe}from"../../../../base/common/strings.js";import{IClipboardService as st}from"../../../../platform/clipboard/common/clipboardService.js";import{getDefaultHoverDelegate as nt}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";const he="workbench.scm.action.graph.pickRepository",ye="workbench.scm.action.graph.pickHistoryItemRefs";class at extends ce{constructor(e,t,r){super(null,t,{...r,icon:!1,label:!0});this._repository=e}updateLabel(){if(this.options.label&&this.label){this.label.classList.add("scm-graph-repository-picker");const e=u(".icon");e.classList.add(...v.asClassNameArray(P.repo));const t=u(".name");t.textContent=this._repository.provider.name,U(this.label,e,t)}}getTooltip(){return this._repository.provider.name}}class lt extends ce{constructor(e,t,r,o){super(null,r,{...o,icon:!1,label:!0});this._repository=e;this._historyItemsFilter=t}updateLabel(){if(this.options.label&&this.label){this.label.classList.add("scm-graph-history-item-picker");const e=u(".icon");e.classList.add(...v.asClassNameArray(P.gitBranch));const t=u(".name");this._historyItemsFilter==="all"?t.textContent=c("all","All"):this._historyItemsFilter==="auto"?t.textContent=c("auto","Auto"):this._historyItemsFilter.length===1?t.textContent=this._historyItemsFilter[0].name:t.textContent=c("items","{0} Items",this._historyItemsFilter.length),U(this.label,e,t)}}getTooltip(){if(this._historyItemsFilter==="all")return c("allHistoryItemRefs","All history item references");if(this._historyItemsFilter==="auto"){const e=this._repository.provider.historyProvider.get();return[e?.historyItemRef.get()?.name,e?.historyItemRemoteRef.get()?.name,e?.historyItemBaseRef.get()?.name].filter(t=>!!t).join(", ")}else return this._historyItemsFilter.length===1?this._historyItemsFilter[0].name:this._historyItemsFilter.map(e=>e.name).join(", ")}}N(class extends W{constructor(){super({id:he,title:"",viewId:B,f1:!1,menu:{id:w.SCMHistoryTitle,when:$.and($.has("scm.providerCount"),$.greater("scm.providerCount",1)),group:"navigation",order:0}})}async runInView(d,i){i.pickRepository()}}),N(class extends W{constructor(){super({id:ye,title:"",icon:P.gitBranch,viewId:B,f1:!1,menu:{id:w.SCMHistoryTitle,group:"navigation",order:0}})}async runInView(d,i){i.pickHistoryItemRef()}}),N(class extends W{constructor(){super({id:"workbench.scm.action.graph.refresh",title:c("refreshGraph","Refresh"),viewId:B,f1:!1,icon:P.refresh,menu:{id:w.SCMHistoryTitle,group:"navigation",order:1e3}})}async runInView(d,i){i.refresh()}}),N(class extends je{constructor(){super({id:"workbench.scm.action.graph.viewChanges",title:c("viewChanges","View Changes"),f1:!1,menu:[{id:w.SCMChangesContext,group:"0_view",when:$.equals("config.multiDiffEditor.experimental.enabled",!0)}]})}async run(d,i,...e){const t=d.get(ae);if(!i||e.length===0)return;const r=e[0],o=e[e.length-1],s=i.historyProvider.get();if(e.length>1){const M=await s?.resolveHistoryItemRefsCommonAncestor([r.id,o.id]);if(!M||M!==r.id&&M!==o.id)return}const n=o.parentIds.length>0?o.parentIds[0]:void 0,a=await s?.provideHistoryItemChanges(r.id,n);if(!a?.length)return;const p=e.length===1?`${e[0].displayId??e[0].id} - ${e[0].message}`:c("historyItemChangesEditorTitle","All Changes ({0} \u2194 {1})",o.displayId??o.id,r.displayId??r.id),h=i.rootUri,m=h?h.path:i.label,y=ne.from({scheme:"scm-history-item",path:`${m}/${n}..${r.id}`},!0);t.executeCommand("_workbench.openMultiDiffEditor",{title:p,multiDiffSourceUri:y,resources:a})}});class ct{getHeight(){return 22}getTemplateId(i){if(b(i))return S.TEMPLATE_ID;if(Q(i))return C.TEMPLATE_ID;throw new Error("Unknown element")}}let S=class{constructor(i,e,t,r,o){this.hoverDelegate=i;this._clipboardService=e;this._configurationService=t;this._hoverService=r;this._themeService=o}static TEMPLATE_ID="history-item";get templateId(){return S.TEMPLATE_ID}_badgesConfig=ot("scm.graph.badges","filter",this._configurationService);renderTemplate(i){i.parentElement.parentElement.querySelector(".monaco-tl-twistie").classList.add("force-no-twistie");const e=f(i,u(".history-item")),t=f(e,u(".graph-container")),r=new j(e,{supportIcons:!0,supportHighlights:!0,supportDescriptionHighlights:!0}),o=f(e,u(".label-container"));return e.appendChild(o),{element:e,graphContainer:t,label:r,labelContainer:o,elementDisposables:new R,disposables:new R}}renderElement(i,e,t,r){const o=i.element.historyItemViewModel,s=o.historyItem,n=this._hoverService.setupManagedHover(this.hoverDelegate,t.element,this._getHoverContent(i.element),{actions:this._getHoverActions(s)});t.elementDisposables.add(n),t.graphContainer.textContent="",t.graphContainer.classList.toggle("current",o.isCurrent),t.graphContainer.appendChild($e(o));const h=i.element.repository.provider.historyProvider.get()?.historyItemRef?.get()?.revision===s.id?["history-item-current"]:[],[m,y]=this._processMatches(o,i.filterData);t.label.setLabel(s.subject,s.author,{matches:m,descriptionMatches:y,extraClasses:h}),this._renderBadges(s,t)}_renderBadges(i,e){e.elementDisposables.add(D(t=>{const r=this._badgesConfig.read(t);e.labelContainer.textContent="";const o=i.references?.find(s=>s.color);for(const s of i.references??[])if(!(!s.color&&r==="filter")&&s.icon&&v.isThemeIcon(s.icon)){const n=T("div.label",{style:{color:s.color?g(te):g(xe),backgroundColor:s.color?g(s.color):g(re)}},[T("div.icon@icon"),T("div.description@description")]);n.icon.classList.add(...v.asClassNameArray(s.icon)),n.description.textContent=s.name,n.description.style.display=s===o?"":"none",f(e.labelContainer,n.root)}}))}_getHoverActions(i){return[{commandId:"workbench.scm.action.graph.copyHistoryItemId",iconClass:"codicon.codicon-copy",label:i.displayId??i.id,run:()=>this._clipboardService.writeText(i.id)},{commandId:"workbench.scm.action.graph.copyHistoryItemMessage",iconClass:"codicon.codicon-copy",label:c("historyItemMessage","Message"),run:()=>this._clipboardService.writeText(i.message)}]}_getHoverContent(i){const e=this._themeService.getColorTheme(),t=i.historyItemViewModel.historyItem,r=new Se("",{isTrusted:!0,supportThemeIcons:!0});if(t.author){if(r.appendMarkdown(`$(account) **${t.author}**`),t.timestamp){const o=new Intl.DateTimeFormat(ve.language,{year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"});r.appendMarkdown(`, $(history) ${ge(t.timestamp,!0,!0)} (${o.format(t.timestamp)})`)}r.appendMarkdown(`

`)}if(r.appendMarkdown(`${t.message}

`),t.statistics){if(r.appendMarkdown(`---

`),r.appendMarkdown(`<span>${t.statistics.files===1?c("fileChanged","{0} file changed",t.statistics.files):c("filesChanged","{0} files changed",t.statistics.files)}</span>`),t.statistics.insertions){const o=e.getColor(qe);r.appendMarkdown(`,&nbsp;<span style="color:${o};">${t.statistics.insertions===1?c("insertion","{0} insertion{1}",t.statistics.insertions,"(+)"):c("insertions","{0} insertions{1}",t.statistics.insertions,"(+)")}</span>`)}if(t.statistics.deletions){const o=e.getColor(ze);r.appendMarkdown(`,&nbsp;<span style="color:${o};">${t.statistics.deletions===1?c("deletion","{0} deletion{1}",t.statistics.deletions,"(-)"):c("deletions","{0} deletions{1}",t.statistics.deletions,"(-)")}</span>`)}}return(t.references??[]).length>0&&(r.appendMarkdown(`

---

`),r.appendMarkdown((t.references??[]).map(o=>{const s=v.isThemeIcon(o.icon)?o.icon.id:"",n=o.color?g(o.color):g(re);return`<span style="color:${o.color?g(te):g(Ke)};background-color:${n};border-radius:2px;">&nbsp;$(${s})&nbsp;${o.name}&nbsp;</span>`}).join("&nbsp;&nbsp;"))),{markdown:r,markdownNotSupportedFallback:t.message}}_processMatches(i,e){return e?[i.historyItem.message===e.label?Y(e.score):void 0,i.historyItem.author===e.label?Y(e.score):void 0]:[void 0,void 0]}disposeElement(i,e,t,r){t.elementDisposables.clear()}disposeTemplate(i){i.disposables.dispose()}};S=I([l(1,st),l(2,H),l(3,K),l(4,Z)],S);let C=class{constructor(i,e,t){this._loadingMore=i;this._loadMoreCallback=e;this._configurationService=t}static TEMPLATE_ID="historyItemLoadMore";get templateId(){return C.TEMPLATE_ID}renderTemplate(i){i.parentElement.parentElement.querySelector(".monaco-tl-twistie").classList.add("force-no-twistie");const e=f(i,u(".history-item-load-more")),t=f(e,u(".graph-placeholder")),r=f(e,u(".history-item-placeholder")),o=new j(r,{supportIcons:!0});return{element:e,graphPlaceholder:t,historyItemPlaceholderContainer:r,historyItemPlaceholderLabel:o,elementDisposables:new R,disposables:new R}}renderElement(i,e,t,r){t.graphPlaceholder.textContent="",t.graphPlaceholder.style.width=`${Be*(i.element.graphColumns.length+1)}px`,t.graphPlaceholder.appendChild(Ne(i.element.graphColumns));const o=this._configurationService.getValue("scm.graph.pageOnScroll")===!0;t.historyItemPlaceholderContainer.classList.toggle("shimmer",o),o?(t.historyItemPlaceholderLabel.setLabel(""),this._loadMoreCallback(i.element.repository)):t.elementDisposables.add(D(s=>{const a=`$(${this._loadingMore().read(s)?"loading~spin":"fold-down"})`;t.historyItemPlaceholderLabel.setLabel(c("loadMore","{0} Load More...",a))}))}disposeElement(i,e,t,r){t.elementDisposables.clear()}disposeTemplate(i){i.disposables.dispose()}};C=I([l(2,H)],C);let L=class extends Pe{constructor(e,t,r,o){super("element",!0,()=>this.getHoverOptions(),r,o);this._viewContainerLocation=e;this.layoutService=t}getHoverOptions(){const e=this.layoutService.getSideBarPosition();let t;return this._viewContainerLocation===ee.Sidebar?t=e===oe.LEFT?k.RIGHT:k.LEFT:this._viewContainerLocation===ee.AuxiliaryBar?t=e===oe.LEFT?k.LEFT:k.RIGHT:t=k.RIGHT,{additionalClasses:["history-item-hover"],position:{hoverPosition:t,forcePosition:!0}}}};L=I([l(1,Ue),l(2,H),l(3,K)],L);let E=class extends Je{constructor(e){super();this._progressService=e}runAction(e,t){return this._progressService.withProgress({location:B},async()=>await super.runAction(e,t))}};E=I([l(0,le)],E);class dt{getWidgetAriaLabel(){return c("scm history","Source Control History")}getAriaLabel(i){if(G(i))return`${i.provider.name} ${i.provider.label}`;if(b(i)){const e=i.historyItemViewModel.historyItem;return`${Ge(e.message).trim()}${e.author?`, ${e.author}`:""}`}else return""}}class mt{getId(i){if(G(i))return`repo:${i.provider.id}`;if(b(i)){const e=i.repository.provider,t=i.historyItemViewModel.historyItem;return`historyItem:${e.id}/${t.id}/${t.parentIds.join(",")}`}else{if(Q(i))return`historyItemLoadMore:${i.repository.provider.id}}`;throw new Error("Invalid tree element")}}}class pt{getKeyboardNavigationLabel(i){if(!G(i)){if(b(i))return[i.historyItemViewModel.historyItem.message,i.historyItemViewModel.historyItem.author];if(Q(i))return"";throw new Error("Invalid tree element")}}}class ht extends x{async getChildren(i){if(!(i instanceof _))return[];const e=[],t=await i.getHistoryItems();e.push(...t);const r=i.repository.get(),o=et(t);return r&&o&&o.historyItemViewModel.outputSwimlanes.length>0&&e.push({repository:r,graphColumns:o.historyItemViewModel.outputSwimlanes,type:"historyItemLoadMore"}),e}hasChildren(i){return i instanceof _}}let _=class extends x{constructor(e,t,r){super();this._configurationService=e;this._scmService=t;this._scmViewService=r;this._register(D(o=>{const s=this._closedRepository.read(o);s&&(this.repository.get()===s&&this._selectedRepository.set(me.first(this._scmService.repositories)??"auto",void 0),this._state.delete(s))}))}_closedRepository=J(this,this._scmService.onDidRemoveRepository,e=>e);_firstRepository=this._scmService.repositoryCount>0?be(me.first(this._scmService.repositories)):J(this,rt.once(this._scmService.onDidAddRepository),e=>e);_selectedRepository=O(this,"auto");_graphRepository=F(e=>{const t=this._selectedRepository.read(e);return t!=="auto"?t:this._scmViewService.activeRepository.read(e)});repository=we(this,[this._firstRepository,this._graphRepository]);historyItemsFilter=O(this,"auto");_state=new Map;clearRepositoryState(){const e=this.repository.get();e&&this._state.delete(e)}setLoadMore(e,t){const r=this._state.get(e);r&&this._state.set(e,{...r,loadMore:t})}async getHistoryItems(){const e=this.repository.get();if(!e)return[];let t=this._state.get(e);const r=e.provider.historyProvider.get();if(!r)return[];if(!t||t.loadMore){const s=t?.items??[];let n=t?.historyItemRefs;if(!n){const m=this.historyItemsFilter.get();switch(m){case"all":n=await r.provideHistoryItemRefs()??[];break;case"auto":n=[r.historyItemRef.get(),r.historyItemRemoteRef.get(),r.historyItemBaseRef.get()].filter(y=>!!y);break;default:n=m;break}}const a=it(this._configurationService.getValue("scm.graph.pageSize"),1,1e3),p=n.map(m=>m.revision??m.id),h=await r.provideHistoryItems({historyItemRefs:p,limit:a,skip:s.length})??[];t={historyItemRefs:n,items:[...s,...h],loadMore:!1},this._state.set(e,t)}const o=this._getGraphColorMap(t.historyItemRefs);return Qe(t.items,o,r.historyItemRef.get()).map(s=>({repository:e,historyItemViewModel:s,type:"historyItemViewModel"}))}setRepository(e){this._selectedRepository.set(e,void 0)}setHistoryItemsFilter(e){this.historyItemsFilter.set(e,void 0)}_getGraphColorMap(e){const r=this.repository.get()?.provider.historyProvider.get(),o=r?.historyItemRef.get(),s=r?.historyItemRemoteRef.get(),n=r?.historyItemBaseRef.get(),a=new Map;o&&(a.set(o.id,o.color),s&&a.set(s.id,s.color),n&&a.set(n.id,n.color));for(const p of e)a.has(p.id)||a.set(p.id,void 0);return a}dispose(){this._state.clear(),super.dispose()}};_=I([l(0,H),l(1,We),l(2,ie)],_);let V=class extends x{constructor(e,t){super();this._quickInputService=e;this._scmViewService=t}_autoQuickPickItem={label:c("auto","Auto"),description:c("activeRepository","Show the source control graph for the active repository"),repository:"auto"};async pickRepository(){const e=[this._autoQuickPickItem,{type:"separator"}];return e.push(...this._scmViewService.repositories.map(t=>({label:t.provider.name,description:t.provider.rootUri?.fsPath,iconClass:v.asClassName(P.repo),repository:t}))),this._quickInputService.pick(e,{placeHolder:c("scmGraphRepository","Select the repository to view, type to filter all repositories")})}};V=I([l(0,de),l(1,ie)],V);let A=class extends x{constructor(e,t,r){super();this._historyProvider=e;this._historyItemsFilter=t;this._quickInputService=r}_allQuickPickItem={id:"all",label:c("all","All"),description:c("allHistoryItemRefs","All history item references"),historyItemRef:"all"};_autoQuickPickItem={id:"auto",label:c("auto","Auto"),description:c("currentHistoryItemRef","Current history item reference(s)"),historyItemRef:"auto"};async pickHistoryItemRef(){const e=this._quickInputService.createQuickPick({useSeparators:!0});this._store.add(e),e.placeholder=c("scmGraphHistoryItemRef","Select one/more history item references to view, type to filter"),e.canSelectMany=!0,e.hideCheckAll=!0,e.busy=!0,e.show();const t=await this._createQuickPickItems();let r=[];if(this._historyItemsFilter==="all")r.push(this._allQuickPickItem);else if(this._historyItemsFilter==="auto")r.push(this._autoQuickPickItem);else{let o=0;for(;o<t.length;){if(t[o].type==="separator"){o++;continue}if(this._historyItemsFilter.some(s=>s.id===t[o].id)){const s=t.splice(o,1);r.push(...s)}else o++}t.splice(2,0,{type:"separator"},...r)}return e.items=t,e.selectedItems=r,e.busy=!1,new Promise(o=>{this._store.add(e.onDidChangeSelection(s=>{const{added:n}=Xe(r,s,(a,p)=>pe(a.id??"",p.id??""));n.length>0&&(n[0].historyItemRef==="all"||n[0].historyItemRef==="auto"?e.selectedItems=[n[0]]:e.selectedItems=[...e.selectedItems.filter(a=>a.historyItemRef!=="all"&&a.historyItemRef!=="auto")]),r=[...e.selectedItems]})),this._store.add(e.onDidAccept(()=>{r.length===0?o(void 0):r.length===1&&r[0].historyItemRef==="all"?o("all"):r.length===1&&r[0].historyItemRef==="auto"?o("auto"):o(r.map(s=>s.historyItemRef)),e.hide()})),this._store.add(e.onDidHide(()=>{o(void 0),this.dispose()}))})}async _createQuickPickItems(){const e=[this._allQuickPickItem,this._autoQuickPickItem],t=await this._historyProvider.provideHistoryItemRefs()??[],r=Ze(t,(o,s)=>pe(o.category??"",s.category??""));for(const o of r)o.length!==0&&(e.push({type:"separator",label:o[0].category}),e.push(...o.map(s=>({id:s.id,label:s.name,description:s.description,iconClass:v.isThemeIcon(s.icon)?v.asClassName(s.icon):void 0,historyItemRef:s}))));return e}};A=I([l(2,de)],A);let z=class extends De{constructor(e,t,r,o,s,n,a,p,h,m,y,M,q,ue){super({...e,titleMenuId:w.SCMHistoryTitle,showActions:Fe.WhenExpanded},a,n,s,m,h,p,y,M,q,ue);this._commandService=t;this._instantiationService=r;this._progressService=o;this._scmProviderCtx=tt.SCMProvider.bindTo(this.scopedContextKeyService),this._actionRunner=this.instantiationService.createInstance(E),this._register(this._actionRunner),this._register(this._updateChildrenThrottler)}_treeContainer;_tree;_treeViewModel;_treeDataSource;_treeIdentityProvider;_repositoryLoadMore=O(this,!1);_repositoryOutdated=O(this,!1);_actionRunner;_visibilityDisposables=new R;_treeOperationSequencer=new se;_treeLoadMoreSequencer=new se;_updateChildrenThrottler=new Ye;_scmProviderCtx;renderHeaderTitle(e){super.renderHeaderTitle(e,this.title);const t=T("div.scm-graph-view-badge-container",[T("div.scm-graph-view-badge.monaco-count-badge.long@badge")]);t.badge.textContent="Outdated",e.appendChild(t.root),this._register(this.hoverService.setupManagedHover(nt("mouse"),t.root,{markdown:{value:c("scmGraphViewOutdated","Please refresh the graph using the refresh action ($(refresh))."),supportThemeIcons:!0},markdownNotSupportedFallback:void 0})),this._register(D(r=>{const o=this._repositoryOutdated.read(r);t.root.style.display=o?"":"none"}))}renderBody(e){super.renderBody(e),this._treeContainer=f(e,u(".scm-view.scm-history-view")),this._treeContainer.classList.add("file-icon-themable-tree"),this._createTree(this._treeContainer),this.onDidChangeBodyVisibility(async t=>{if(!t){this._visibilityDisposables.clear();return}this._treeViewModel=this.instantiationService.createInstance(_),this._visibilityDisposables.add(this._treeViewModel),await this._progressService.withProgress({location:this.id},async()=>{const o=F(this,s=>this._treeViewModel.repository.read(s)?.provider.historyProvider.read(s)?.historyItemRef.read(s)!==void 0?!0:void 0);await _e(o),await this._treeOperationSequencer.queue(async()=>{await this._tree.setInput(this._treeViewModel),this._tree.scrollTop=0})});let r=!0;this._visibilityDisposables.add(Ce((o,s)=>{const n=this._treeViewModel.repository.read(o),a=n?.provider.historyProvider.read(o);if(!n||!a)return;this._scmProviderCtx.set(n.provider.contextValue);const p=Re(this,F(m=>a.historyItemRemoteRef.read(m)?.id)),h=F(m=>a.historyItemRemoteRef.read(m)?.revision);s.add(Me({owner:this,createEmptyChangeSummary:()=>({refresh:!1}),handleChange(m,y){return y.refresh=m.didChange(h)?"ifScrollTop":!0,!0}},(m,y)=>{p.read(m);const M=a.historyItemRef.read(m),q=h.read(m);if(y.refresh===!0){this.refresh();return}if(y.refresh==="ifScrollTop"){if(M?.revision===q){this.refresh();return}if(this._tree.scrollTop===0){this.refresh();return}this._repositoryOutdated.set(!0,void 0)}})),s.add(Te(this._treeViewModel.historyItemsFilter,()=>{this.refresh()})),r||this.refresh(),r=!1}))})}layoutBody(e,t){super.layoutBody(e,t),this._tree.layout(e,t)}getActionRunner(){return this._actionRunner}getActionsContext(){return this._treeViewModel?.repository.get()?.provider}getActionViewItem(e,t){if(e.id===he){const r=this._treeViewModel?.repository.get();if(r)return new at(r,e,t)}else if(e.id===ye){const r=this._treeViewModel?.repository.get(),o=this._treeViewModel?.historyItemsFilter.get();if(r&&o)return new lt(r,o,e,t)}return super.getActionViewItem(e,t)}async refresh(){await this._updateChildren(!0),this.updateActions(),this._repositoryOutdated.set(!1,void 0),this._tree.scrollTop=0}async pickRepository(){const t=await this._instantiationService.createInstance(V).pickRepository();t&&this._treeViewModel.setRepository(t.repository)}async pickHistoryItemRef(){const t=this._treeViewModel.repository.get()?.provider.historyProvider.get(),r=this._treeViewModel.historyItemsFilter.get();if(!t)return;const s=await this._instantiationService.createInstance(A,t,r).pickHistoryItemRef();s&&this._treeViewModel.setHistoryItemsFilter(s)}_createTree(e){this._treeIdentityProvider=new mt;const t=this.instantiationService.createInstance(L,this.viewDescriptorService.getViewLocationById(this.id));this._register(t),this._treeDataSource=this.instantiationService.createInstance(ht),this._register(this._treeDataSource),this._tree=this.instantiationService.createInstance(Ee,"SCM History Tree",e,new ct,[this.instantiationService.createInstance(S,t),this.instantiationService.createInstance(C,()=>this._repositoryLoadMore,r=>this._loadMoreCallback(r))],this._treeDataSource,{accessibilityProvider:new dt,identityProvider:this._treeIdentityProvider,collapseByDefault:r=>!1,keyboardNavigationLabelProvider:new pt,horizontalScrolling:!1,multipleSelectionSupport:!1}),this._register(this._tree),this._tree.onDidOpen(this._onDidOpen,this,this._store),this._tree.onContextMenu(this._onContextMenu,this,this._store)}async _onDidOpen(e){if(e.element)if(b(e.element)){const t=e.element.historyItemViewModel.historyItem,r=t.parentIds.length>0?t.parentIds[0]:void 0,s=await e.element.repository.provider.historyProvider.get()?.provideHistoryItemChanges(t.id,r);if(s){const n=`${t.displayId??t.id} - ${t.message}`,a=e.element.repository.provider.rootUri,p=a?a.path:e.element.repository.provider.label,h=ne.from({scheme:"scm-history-item",path:`${p}/${r}..${t.id}`},!0);await this._commandService.executeCommand("_workbench.openMultiDiffEditor",{title:n,multiDiffSourceUri:h,resources:s})}}else Q(e.element)&&(this.configurationService.getValue("scm.graph.pageOnScroll")===!0||(this._loadMoreCallback(e.element.repository),this._tree.setSelection([])));else return}_onContextMenu(e){const t=e.element;!t||!b(t)||this.contextMenuService.showContextMenu({menuId:w.SCMChangesContext,menuActionOptions:{arg:t.repository.provider,shouldForwardArgs:!0},getAnchor:()=>e.anchor,getActionsContext:()=>t.historyItemViewModel.historyItem})}async _loadMoreCallback(e){return this._treeLoadMoreSequencer.queue(async()=>{this._repositoryLoadMore.get()||(this._repositoryLoadMore.set(!0,void 0),this._treeViewModel.setLoadMore(e,!0),await this._updateChildren(),this._repositoryLoadMore.set(!1,void 0))})}_updateChildren(e=!1){return this._updateChildrenThrottler.queue(()=>this._treeOperationSequencer.queue(async()=>{e&&this._treeViewModel.clearRepositoryState(),await this._progressService.withProgress({location:this.id},async()=>{await this._tree.updateChildren(void 0,void 0,void 0,{})})}))}dispose(){this._visibilityDisposables.dispose(),super.dispose()}};z=I([l(1,ae),l(2,X),l(3,le),l(4,H),l(5,ke),l(6,Le),l(7,X),l(8,Oe),l(9,He),l(10,Ve),l(11,Z),l(12,Ae),l(13,K)],z);export{z as SCMHistoryViewPane};
