var we=Object.defineProperty;var be=Object.getOwnPropertyDescriptor;var u=(d,o,e,t)=>{for(var r=t>1?void 0:t?be(o,e):o,i=d.length-1,s;i>=0;i--)(s=d[i])&&(r=(t?s(o,e,r):s(r))||r);return t&&r&&we(o,e,r),r},l=(d,o)=>(e,t)=>o(e,t,d);import"./media/scm.css";import*as He from"../../../../base/common/platform.js";import{$ as y,append as v,h as R,reset as Y}from"../../../../base/browser/dom.js";import"../../../../base/browser/ui/hover/hover.js";import"../../../../base/browser/ui/hover/hoverDelegate.js";import{IconLabel as J}from"../../../../base/browser/ui/iconLabel/iconLabel.js";import"../../../../base/browser/ui/list/list.js";import"../../../../base/browser/ui/tree/abstractTree.js";import"../../../../base/browser/ui/tree/tree.js";import{fromNow as Te}from"../../../../base/common/date.js";import{createMatches as X}from"../../../../base/common/filters.js";import{MarkdownString as Re}from"../../../../base/common/htmlContent.js";import{Disposable as $,DisposableStore as P}from"../../../../base/common/lifecycle.js";import{autorun as k,autorunWithStore as Pe,derived as W,observableValue as Q,waitForState as ke,constObservable as Ee,latestChangedValue as Ve,observableFromEvent as Z,runOnChange as G,observableSignal as Le}from"../../../../base/common/observable.js";import{ThemeIcon as I}from"../../../../base/common/themables.js";import{localize as c}from"../../../../nls.js";import{IConfigurationService as E}from"../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as B,IContextKeyService as ee}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as Fe}from"../../../../platform/contextview/browser/contextView.js";import{IHoverService as U,WorkbenchHoverDelegate as Ae}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as te}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as xe}from"../../../../platform/keybinding/common/keybinding.js";import{WorkbenchAsyncDataTree as De}from"../../../../platform/list/browser/listService.js";import{IOpenerService as Oe}from"../../../../platform/opener/common/opener.js";import{ITelemetryService as $e}from"../../../../platform/telemetry/common/telemetry.js";import{asCssVariable as f,foreground as Qe}from"../../../../platform/theme/common/colorRegistry.js";import{IThemeService as re}from"../../../../platform/theme/common/themeService.js";import{ViewAction as N,ViewPane as Be,ViewPaneShowActions as Ne}from"../../../browser/parts/views/viewPane.js";import{IViewDescriptorService as Ke,ViewContainerLocation as ie}from"../../../common/views.js";import{renderSCMHistoryItemGraph as qe,toISCMHistoryItemViewModelArray as ze,SWIMLANE_WIDTH as We,renderSCMHistoryGraphPlaceholder as Ge,historyItemHoverDeletionsForeground as Ue,historyItemHoverLabelForeground as oe,historyItemHoverAdditionsForeground as je,historyItemHoverDefaultLabelForeground as Ye,historyItemHoverDefaultLabelBackground as se}from"./scmHistory.js";import{getHistoryItemEditorTitle as ne,getProviderKey as C,isSCMHistoryItemLoadMoreTreeElement as K,isSCMHistoryItemViewModelTreeElement as w,isSCMRepository as j}from"./util.js";import"../common/history.js";import{HISTORY_VIEW_PANE_ID as V,ISCMService as Je,ISCMViewService as ae}from"../common/scm.js";import"../../../../base/browser/ui/list/listWidget.js";import{stripIcons as Xe}from"../../../../base/common/iconLabels.js";import{IWorkbenchLayoutService as Ze,Position as le}from"../../../services/layout/browser/layoutService.js";import{HoverPosition as L}from"../../../../base/browser/ui/hover/hoverWidget.js";import{Action2 as et,MenuId as _,registerAction2 as F}from"../../../../platform/actions/common/actions.js";import{Sequencer as ce,Throttler as tt}from"../../../../base/common/async.js";import{URI as de}from"../../../../base/common/uri.js";import{ICommandService as me}from"../../../../platform/commands/common/commands.js";import{ActionRunner as rt}from"../../../../base/common/actions.js";import{delta as it,groupBy as ot,tail as st}from"../../../../base/common/arrays.js";import{Codicon as b}from"../../../../base/common/codicons.js";import{IProgressService as pe}from"../../../../platform/progress/common/progress.js";import{ContextKeys as q}from"./scmViewPane.js";import"../../../../base/browser/ui/actionbar/actionbar.js";import"../../../../base/browser/ui/dropdown/dropdownActionViewItem.js";import{ActionViewItem as he}from"../../../../base/browser/ui/actionbar/actionViewItems.js";import{IQuickInputService as ye}from"../../../../platform/quickinput/common/quickInput.js";import{Event as nt}from"../../../../base/common/event.js";import{Iterable as ue}from"../../../../base/common/iterator.js";import{clamp as at}from"../../../../base/common/numbers.js";import{observableConfigValue as lt}from"../../../../platform/observable/common/platformObservableUtils.js";import{compare as Ie}from"../../../../base/common/strings.js";import{IClipboardService as ct}from"../../../../platform/clipboard/common/clipboardService.js";import{getDefaultHoverDelegate as dt}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import{IStorageService as mt,StorageScope as ve,StorageTarget as pt}from"../../../../platform/storage/common/storage.js";import{INotificationService as ht}from"../../../../platform/notification/common/notification.js";import{IExtensionService as yt}from"../../../services/extensions/common/extensions.js";import{groupBy as fe}from"../../../../base/common/collections.js";const ge="workbench.scm.action.graph.pickRepository",Se="workbench.scm.action.graph.pickHistoryItemRefs";class ut extends he{constructor(e,t,r){super(null,t,{...r,icon:!1,label:!0});this._repository=e}updateLabel(){if(this.options.label&&this.label){this.label.classList.add("scm-graph-repository-picker");const e=y(".icon");e.classList.add(...I.asClassNameArray(b.repo));const t=y(".name");t.textContent=this._repository.provider.name,Y(this.label,e,t)}}getTooltip(){return this._repository.provider.name}}class It extends he{constructor(e,t,r,i){super(null,r,{...i,icon:!1,label:!0});this._repository=e;this._historyItemsFilter=t}updateLabel(){if(this.options.label&&this.label){this.label.classList.add("scm-graph-history-item-picker");const e=y(".icon");e.classList.add(...I.asClassNameArray(b.gitBranch));const t=y(".name");this._historyItemsFilter==="all"?t.textContent=c("all","All"):this._historyItemsFilter==="auto"?t.textContent=c("auto","Auto"):this._historyItemsFilter.length===1?t.textContent=this._historyItemsFilter[0].name:t.textContent=c("items","{0} Items",this._historyItemsFilter.length),Y(this.label,e,t)}}getTooltip(){if(this._historyItemsFilter==="all")return c("allHistoryItemRefs","All history item references");if(this._historyItemsFilter==="auto"){const e=this._repository.provider.historyProvider.get();return[e?.historyItemRef.get()?.name,e?.historyItemRemoteRef.get()?.name,e?.historyItemBaseRef.get()?.name].filter(t=>!!t).join(", ")}else return this._historyItemsFilter.length===1?this._historyItemsFilter[0].name:this._historyItemsFilter.map(e=>e.name).join(", ")}}F(class extends N{constructor(){super({id:ge,title:c("repositoryPicker","Repository Picker"),viewId:V,f1:!1,menu:{id:_.SCMHistoryTitle,when:B.and(B.has("scm.providerCount"),B.greater("scm.providerCount",1)),group:"navigation",order:0}})}async runInView(d,o){o.pickRepository()}}),F(class extends N{constructor(){super({id:Se,title:c("referencePicker","History Item Reference Picker"),icon:b.gitBranch,viewId:V,precondition:q.SCMHistoryItemCount.notEqualsTo(0),f1:!1,menu:{id:_.SCMHistoryTitle,group:"navigation",order:1}})}async runInView(d,o){o.pickHistoryItemRef()}}),F(class extends N{constructor(){super({id:"workbench.scm.action.graph.revealCurrentHistoryItem",title:c("goToCurrentHistoryItem","Go to Current History Item"),icon:b.target,viewId:V,precondition:q.SCMHistoryItemCount.notEqualsTo(0),f1:!1,menu:{id:_.SCMHistoryTitle,group:"navigation",order:2}})}async runInView(d,o){o.revealCurrentHistoryItem()}}),F(class extends N{constructor(){super({id:"workbench.scm.action.graph.refresh",title:c("refreshGraph","Refresh"),viewId:V,f1:!1,icon:b.refresh,menu:{id:_.SCMHistoryTitle,group:"navigation",order:1e3}})}async runInView(d,o){o.refresh()}}),F(class extends et{constructor(){super({id:"workbench.scm.action.graph.viewChanges",title:c("viewChanges","View Changes"),f1:!1,menu:[{id:_.SCMChangesContext,group:"0_view",when:B.equals("config.multiDiffEditor.experimental.enabled",!0)}]})}async run(d,o,...e){const t=d.get(me);if(!o||e.length===0)return;const r=e[0],i=e[e.length-1],s=o.historyProvider.get();if(e.length>1){const T=await s?.resolveHistoryItemRefsCommonAncestor([r.id,i.id]);if(!T||T!==r.id&&T!==i.id)return}const n=i.parentIds.length>0?i.parentIds[0]:void 0,a=await s?.provideHistoryItemChanges(r.id,n);if(!a?.length)return;const m=e.length===1?ne(r):c("historyItemChangesEditorTitle","All Changes ({0} \u2194 {1})",i.displayId??i.id,r.displayId??r.id),p=o.rootUri,h=p?p.path:o.label,H=de.from({scheme:"scm-history-item",path:`${h}/${n}..${r.id}`},!0);t.executeCommand("_workbench.openMultiDiffEditor",{title:m,multiDiffSourceUri:H,resources:a})}});class vt{getHeight(){return 22}getTemplateId(o){if(w(o))return g.TEMPLATE_ID;if(K(o))return S.TEMPLATE_ID;throw new Error("Unknown element")}}let g=class{constructor(o,e,t,r,i){this.hoverDelegate=o;this._clipboardService=e;this._configurationService=t;this._hoverService=r;this._themeService=i}static TEMPLATE_ID="history-item";get templateId(){return g.TEMPLATE_ID}_badgesConfig=lt("scm.graph.badges","filter",this._configurationService);renderTemplate(o){o.parentElement.parentElement.querySelector(".monaco-tl-twistie").classList.add("force-no-twistie");const e=v(o,y(".history-item")),t=v(e,y(".graph-container")),r=new J(e,{supportIcons:!0,supportHighlights:!0,supportDescriptionHighlights:!0}),i=v(e,y(".label-container"));return e.appendChild(i),{element:e,graphContainer:t,label:r,labelContainer:i,elementDisposables:new P,disposables:new P}}renderElement(o,e,t,r){const i=o.element.historyItemViewModel,s=i.historyItem,n=this._hoverService.setupManagedHover(this.hoverDelegate,t.element,this._getHoverContent(o.element),{actions:this._getHoverActions(s)});t.elementDisposables.add(n),t.graphContainer.textContent="",t.graphContainer.classList.toggle("current",i.isCurrent),t.graphContainer.appendChild(qe(i));const p=o.element.repository.provider.historyProvider.get()?.historyItemRef?.get()?.revision===s.id?["history-item-current"]:[],[h,H]=this._processMatches(i,o.filterData);t.label.setLabel(s.subject,s.author,{matches:h,descriptionMatches:H,extraClasses:p}),this._renderBadges(s,t)}_renderBadges(o,e){e.elementDisposables.add(k(t=>{const r=this._badgesConfig.read(t),i=o.references?.find(n=>n.color);e.labelContainer.textContent="";const s=fe(o.references??[],n=>n.color?n.color:"");for(const[n,a]of Object.entries(s)){if(n===""&&r!=="all")continue;const m=fe(a,p=>I.isThemeIcon(p.icon)?p.icon.id:"");for(const[p,h]of Object.entries(m))p===""||h.length===0||this._renderBadge(h[0],h[0]===i,e)}}))}_renderBadge(o,e,t){if(!I.isThemeIcon(o.icon))return;const r=R("div.label",{style:{color:o.color?f(oe):f(Qe),backgroundColor:o.color?f(o.color):f(se)}},[R("div.icon@icon"),R("div.description@description")]);r.icon.classList.add(...I.asClassNameArray(o.icon)),r.description.textContent=o.name,r.description.style.display=e?"":"none",v(t.labelContainer,r.root)}_getHoverActions(o){return[{commandId:"workbench.scm.action.graph.copyHistoryItemId",iconClass:"codicon.codicon-copy",label:o.displayId??o.id,run:()=>this._clipboardService.writeText(o.id)},{commandId:"workbench.scm.action.graph.copyHistoryItemMessage",iconClass:"codicon.codicon-copy",label:c("historyItemMessage","Message"),run:()=>this._clipboardService.writeText(o.message)}]}_getHoverContent(o){const e=this._themeService.getColorTheme(),t=o.historyItemViewModel.historyItem,r=new Re("",{isTrusted:!0,supportThemeIcons:!0});if(t.author){if(r.appendMarkdown(`$(account) **${t.author}**`),t.timestamp){const i=new Intl.DateTimeFormat(He.language,{year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"});r.appendMarkdown(`, $(history) ${Te(t.timestamp,!0,!0)} (${i.format(t.timestamp)})`)}r.appendMarkdown(`

`)}if(r.appendMarkdown(`${t.message}

`),t.statistics){if(r.appendMarkdown(`---

`),r.appendMarkdown(`<span>${t.statistics.files===1?c("fileChanged","{0} file changed",t.statistics.files):c("filesChanged","{0} files changed",t.statistics.files)}</span>`),t.statistics.insertions){const i=e.getColor(je);r.appendMarkdown(`,&nbsp;<span style="color:${i};">${t.statistics.insertions===1?c("insertion","{0} insertion{1}",t.statistics.insertions,"(+)"):c("insertions","{0} insertions{1}",t.statistics.insertions,"(+)")}</span>`)}if(t.statistics.deletions){const i=e.getColor(Ue);r.appendMarkdown(`,&nbsp;<span style="color:${i};">${t.statistics.deletions===1?c("deletion","{0} deletion{1}",t.statistics.deletions,"(-)"):c("deletions","{0} deletions{1}",t.statistics.deletions,"(-)")}</span>`)}}return(t.references??[]).length>0&&(r.appendMarkdown(`

---

`),r.appendMarkdown((t.references??[]).map(i=>{const s=I.isThemeIcon(i.icon)?i.icon.id:"",n=i.color?f(i.color):f(se);return`<span style="color:${i.color?f(oe):f(Ye)};background-color:${n};border-radius:10px;">&nbsp;$(${s})&nbsp;${i.name}&nbsp;&nbsp;</span>`}).join("&nbsp;&nbsp;"))),{markdown:r,markdownNotSupportedFallback:t.message}}_processMatches(o,e){return e?[o.historyItem.message===e.label?X(e.score):void 0,o.historyItem.author===e.label?X(e.score):void 0]:[void 0,void 0]}disposeElement(o,e,t,r){t.elementDisposables.clear()}disposeTemplate(o){o.disposables.dispose()}};g=u([l(1,ct),l(2,E),l(3,U),l(4,re)],g);let S=class{constructor(o,e,t){this._isLoadingMore=o;this._loadMoreCallback=e;this._configurationService=t}static TEMPLATE_ID="historyItemLoadMore";get templateId(){return S.TEMPLATE_ID}renderTemplate(o){o.parentElement.parentElement.querySelector(".monaco-tl-twistie").classList.add("force-no-twistie");const e=v(o,y(".history-item-load-more")),t=v(e,y(".graph-placeholder")),r=v(e,y(".history-item-placeholder")),i=new J(r,{supportIcons:!0});return{element:e,graphPlaceholder:t,historyItemPlaceholderContainer:r,historyItemPlaceholderLabel:i,elementDisposables:new P,disposables:new P}}renderElement(o,e,t,r){t.graphPlaceholder.textContent="",t.graphPlaceholder.style.width=`${We*(o.element.graphColumns.length+1)}px`,t.graphPlaceholder.appendChild(Ge(o.element.graphColumns));const i=this._configurationService.getValue("scm.graph.pageOnScroll")===!0;t.historyItemPlaceholderContainer.classList.toggle("shimmer",i),i?(t.historyItemPlaceholderLabel.setLabel(""),this._loadMoreCallback()):t.elementDisposables.add(k(s=>{const a=`$(${this._isLoadingMore.read(s)?"loading~spin":"fold-down"})`;t.historyItemPlaceholderLabel.setLabel(c("loadMore","{0} Load More...",a))}))}disposeElement(o,e,t,r){t.elementDisposables.clear()}disposeTemplate(o){o.disposables.dispose()}};S=u([l(2,E)],S);let A=class extends Ae{constructor(e,t,r,i){super("element",!0,()=>this.getHoverOptions(),r,i);this._viewContainerLocation=e;this.layoutService=t}getHoverOptions(){const e=this.layoutService.getSideBarPosition();let t;return this._viewContainerLocation===ie.Sidebar?t=e===le.LEFT?L.RIGHT:L.LEFT:this._viewContainerLocation===ie.AuxiliaryBar?t=e===le.LEFT?L.LEFT:L.RIGHT:t=L.RIGHT,{additionalClasses:["history-item-hover"],position:{hoverPosition:t,forcePosition:!0}}}};A=u([l(1,Ze),l(2,E),l(3,U)],A);let x=class extends rt{constructor(e){super();this._progressService=e}runAction(e,t){return this._progressService.withProgress({location:V},async()=>await super.runAction(e,t))}};x=u([l(0,pe)],x);class ft{getWidgetAriaLabel(){return c("scm history","Source Control History")}getAriaLabel(o){if(j(o))return`${o.provider.name} ${o.provider.label}`;if(w(o)){const e=o.historyItemViewModel.historyItem;return`${Xe(e.message).trim()}${e.author?`, ${e.author}`:""}`}else return""}}class gt{getId(o){if(j(o))return`repo:${o.provider.id}`;if(w(o)){const e=o.repository.provider,t=o.historyItemViewModel.historyItem;return`historyItem:${e.id}/${t.id}/${t.parentIds.join(",")}`}else{if(K(o))return`historyItemLoadMore:${o.repository.provider.id}}`;throw new Error("Invalid tree element")}}}class St{getKeyboardNavigationLabel(o){if(!j(o)){if(w(o))return[o.historyItemViewModel.historyItem.message,o.historyItemViewModel.historyItem.author];if(K(o))return"";throw new Error("Invalid tree element")}}}class _t extends ${async getChildren(o){if(!(o instanceof M))return[];const e=[],t=await o.getHistoryItems();e.push(...t);const r=o.repository.get(),i=st(t);return r&&i&&i.historyItemViewModel.outputSwimlanes.length>0&&e.push({repository:r,graphColumns:i.historyItemViewModel.outputSwimlanes,type:"historyItemLoadMore"}),e}hasChildren(o){return o instanceof M}}let M=class extends ${constructor(e,t,r,i,s,n){super();this._configurationService=e;this._contextKeyService=t;this._extensionService=r;this._scmService=i;this._scmViewService=s;this._storageService=n;this._repositoryFilterState=this._loadHistoryItemsFilterState(),this._extensionService.onWillStop(this._saveHistoryItemsFilterState,this,this._store),this._storageService.onWillSaveState(this._saveHistoryItemsFilterState,this,this._store),this._scmHistoryItemCountCtx=q.SCMHistoryItemCount.bindTo(this._contextKeyService),this._register(k(a=>{const m=this._closedRepository.read(a);m&&(this.repository.get()===m&&this._selectedRepository.set(ue.first(this._scmService.repositories)??"auto",void 0),this._repositoryState.delete(m))}))}_closedRepository=Z(this,this._scmService.onDidRemoveRepository,e=>e);_firstRepository=this._scmService.repositoryCount>0?Ee(ue.first(this._scmService.repositories)):Z(this,nt.once(this._scmService.onDidAddRepository),e=>e);_selectedRepository=Q(this,"auto");_graphRepository=W(e=>{const t=this._selectedRepository.read(e);return t!=="auto"?t:this._scmViewService.activeRepository.read(e)});repository=Ve(this,[this._firstRepository,this._graphRepository]);onDidChangeHistoryItemsFilter=Le(this);isViewModelEmpty=Q(this,!1);_repositoryState=new Map;_repositoryFilterState=new Map;_scmHistoryItemCountCtx;clearRepositoryState(){const e=this.repository.get();e&&this._repositoryState.delete(e)}getHistoryItemsFilter(){const e=this.repository.get();if(!e)return;const t=this._repositoryFilterState.get(C(e.provider))??"auto";return t==="all"||t==="auto"?t:this._repositoryState.get(e)?.historyItemsFilter}getCurrentHistoryItemTreeElement(){const e=this.repository.get();if(!e)return;const t=this._repositoryState.get(e);if(!t)return;const i=e?.provider.historyProvider.get()?.historyItemRef.get();return t.viewModels.find(s=>s.historyItemViewModel.historyItem.id===i?.revision)}loadMore(e){const t=this.repository.get();if(!t)return;const r=this._repositoryState.get(t);r&&this._repositoryState.set(t,{...r,loadMore:e??!0})}async getHistoryItems(){const e=this.repository.get(),t=e?.provider.historyProvider.get();if(!e||!t)return this._scmHistoryItemCountCtx.set(0),this.isViewModelEmpty.set(!0,void 0),[];let r=this._repositoryState.get(e);if(!r||r.loadMore!==!1){const i=r?.viewModels.map(h=>h.historyItemViewModel.historyItem)??[],s=r?.historyItemsFilter??await this._resolveHistoryItemFilter(e,t),n=at(this._configurationService.getValue("scm.graph.pageSize"),1,1e3),a=s.map(h=>h.revision??h.id);do i.push(...await t.provideHistoryItems({historyItemRefs:a,limit:n,skip:i.length})??[]);while(typeof r?.loadMore=="string"&&!i.find(h=>h.id===r?.loadMore));const m=this._getGraphColorMap(s),p=ze(i,m,t.historyItemRef.get()).map(h=>({repository:e,historyItemViewModel:h,type:"historyItemViewModel"}));r={historyItemsFilter:s,viewModels:p,loadMore:!1},this._repositoryState.set(e,r),this._scmHistoryItemCountCtx.set(p.length),this.isViewModelEmpty.set(p.length===0,void 0)}return r.viewModels}setRepository(e){this._selectedRepository.set(e,void 0)}setHistoryItemsFilter(e){const t=this.repository.get();t&&(e!=="auto"?this._repositoryFilterState.set(C(t.provider),e):this._repositoryFilterState.delete(C(t.provider)),this._saveHistoryItemsFilterState(),this.onDidChangeHistoryItemsFilter.trigger(void 0))}_getGraphColorMap(e){const r=this.repository.get()?.provider.historyProvider.get(),i=r?.historyItemRef.get(),s=r?.historyItemRemoteRef.get(),n=r?.historyItemBaseRef.get(),a=new Map;i&&(a.set(i.id,i.color),s&&a.set(s.id,s.color),n&&a.set(n.id,n.color));for(const m of e)a.has(m.id)||a.set(m.id,void 0);return a}async _resolveHistoryItemFilter(e,t){const r=[],i=this._repositoryFilterState.get(C(e.provider))??"auto";switch(i){case"all":r.push(...await t.provideHistoryItemRefs()??[]);break;case"auto":r.push(...[t.historyItemRef.get(),t.historyItemRemoteRef.get(),t.historyItemBaseRef.get()].filter(s=>!!s));break;default:{const s=(await t.provideHistoryItemRefs(i)??[]).filter(n=>i.some(a=>a===n.id));s.length===0?(r.push(...[t.historyItemRef.get(),t.historyItemRemoteRef.get(),t.historyItemBaseRef.get()].filter(n=>!!n)),this._repositoryFilterState.delete(C(e.provider))):(r.push(...s),this._repositoryFilterState.set(C(e.provider),s.map(n=>n.id))),this._saveHistoryItemsFilterState();break}}return r}_loadHistoryItemsFilterState(){try{const e=this._storageService.get("scm.graphView.referencesFilter",ve.WORKSPACE);if(e)return new Map(JSON.parse(e))}catch{}return new Map}_saveHistoryItemsFilterState(){const e=Array.from(this._repositoryFilterState.entries());this._storageService.store("scm.graphView.referencesFilter",JSON.stringify(e),ve.WORKSPACE,pt.USER)}dispose(){this._repositoryState.clear(),super.dispose()}};M=u([l(0,E),l(1,ee),l(2,yt),l(3,Je),l(4,ae),l(5,mt)],M);let D=class extends ${constructor(e,t){super();this._quickInputService=e;this._scmViewService=t}_autoQuickPickItem={label:c("auto","Auto"),description:c("activeRepository","Show the source control graph for the active repository"),repository:"auto"};async pickRepository(){const e=[this._autoQuickPickItem,{type:"separator"}];return e.push(...this._scmViewService.repositories.map(t=>({label:t.provider.name,description:t.provider.rootUri?.fsPath,iconClass:I.asClassName(b.repo),repository:t}))),this._quickInputService.pick(e,{placeHolder:c("scmGraphRepository","Select the repository to view, type to filter all repositories")})}};D=u([l(0,ye),l(1,ae)],D);let O=class extends ${constructor(e,t,r){super();this._historyProvider=e;this._historyItemsFilter=t;this._quickInputService=r}_allQuickPickItem={id:"all",label:c("all","All"),description:c("allHistoryItemRefs","All history item references"),historyItemRef:"all"};_autoQuickPickItem={id:"auto",label:c("auto","Auto"),description:c("currentHistoryItemRef","Current history item reference(s)"),historyItemRef:"auto"};async pickHistoryItemRef(){const e=this._quickInputService.createQuickPick({useSeparators:!0});this._store.add(e),e.placeholder=c("scmGraphHistoryItemRef","Select one/more history item references to view, type to filter"),e.canSelectMany=!0,e.hideCheckAll=!0,e.busy=!0,e.show();const t=await this._createQuickPickItems();let r=[];if(this._historyItemsFilter==="all")r.push(this._allQuickPickItem);else if(this._historyItemsFilter==="auto")r.push(this._autoQuickPickItem);else{let i=0;for(;i<t.length;){if(t[i].type==="separator"){i++;continue}if(this._historyItemsFilter.some(s=>s.id===t[i].id)){const s=t.splice(i,1);r.push(...s)}else i++}t.splice(2,0,{type:"separator"},...r)}return e.items=t,e.selectedItems=r,e.busy=!1,new Promise(i=>{this._store.add(e.onDidChangeSelection(s=>{const{added:n}=it(r,s,(a,m)=>Ie(a.id??"",m.id??""));n.length>0&&(n[0].historyItemRef==="all"||n[0].historyItemRef==="auto"?e.selectedItems=[n[0]]:e.selectedItems=[...e.selectedItems.filter(a=>a.historyItemRef!=="all"&&a.historyItemRef!=="auto")]),r=[...e.selectedItems]})),this._store.add(e.onDidAccept(()=>{r.length===0?i(void 0):r.length===1&&r[0].historyItemRef==="all"?i("all"):r.length===1&&r[0].historyItemRef==="auto"?i("auto"):i(r.map(s=>s.historyItemRef.id)),e.hide()})),this._store.add(e.onDidHide(()=>{i(void 0),this.dispose()}))})}async _createQuickPickItems(){const e=[this._allQuickPickItem,this._autoQuickPickItem],t=await this._historyProvider.provideHistoryItemRefs()??[],r=ot(t,(i,s)=>Ie(i.category??"",s.category??""));for(const i of r)i.length!==0&&(e.push({type:"separator",label:i[0].category}),e.push(...i.map(s=>({id:s.id,label:s.name,description:s.description,iconClass:I.isThemeIcon(s.icon)?I.asClassName(s.icon):void 0,historyItemRef:s}))));return e}};O=u([l(2,ye)],O);let z=class extends Be{constructor(e,t,r,i,s,n,a,m,p,h,H,T,_e,Me,Ce){super({...e,titleMenuId:_.SCMHistoryTitle,showActions:Ne.WhenExpanded},m,a,n,H,h,p,T,_e,Me,Ce);this._commandService=t;this._instantiationService=r;this._notificationService=i;this._progressService=s;this._scmProviderCtx=q.SCMProvider.bindTo(this.scopedContextKeyService),this._actionRunner=this.instantiationService.createInstance(x),this._register(this._actionRunner),this._register(this._updateChildrenThrottler)}_treeContainer;_tree;_treeViewModel;_treeDataSource;_treeIdentityProvider;_repositoryIsLoadingMore=Q(this,!1);_repositoryOutdated=Q(this,!1);_actionRunner;_visibilityDisposables=new P;_treeOperationSequencer=new ce;_treeLoadMoreSequencer=new ce;_updateChildrenThrottler=new tt;_scmProviderCtx;renderHeaderTitle(e){super.renderHeaderTitle(e,this.title);const t=R("div.scm-graph-view-badge-container",[R("div.scm-graph-view-badge.monaco-count-badge.long@badge")]);t.badge.textContent="Outdated",e.appendChild(t.root),this._register(this.hoverService.setupManagedHover(dt("mouse"),t.root,{markdown:{value:c("scmGraphViewOutdated","Please refresh the graph using the refresh action ($(refresh))."),supportThemeIcons:!0},markdownNotSupportedFallback:void 0})),this._register(k(r=>{const i=this._repositoryOutdated.read(r);t.root.style.display=i?"":"none"}))}renderBody(e){super.renderBody(e),this._treeContainer=v(e,y(".scm-view.scm-history-view")),this._treeContainer.classList.add("file-icon-themable-tree"),this._createTree(this._treeContainer),this.onDidChangeBodyVisibility(async t=>{if(!t){this._visibilityDisposables.clear();return}this._treeViewModel=this.instantiationService.createInstance(M),this._visibilityDisposables.add(this._treeViewModel),await this._progressService.withProgress({location:this.id},async()=>{const i=W(this,s=>this._treeViewModel.repository.read(s)?.provider.historyProvider.read(s)?.historyItemRef.read(s)!==void 0?!0:void 0);await ke(i),await this._treeOperationSequencer.queue(async()=>{await this._tree.setInput(this._treeViewModel),this._tree.scrollTop=0})}),this._visibilityDisposables.add(k(i=>{this._treeViewModel.isViewModelEmpty.read(i),this._onDidChangeViewWelcomeState.fire()}));let r=!0;this._visibilityDisposables.add(Pe((i,s)=>{const n=this._treeViewModel.repository.read(i),a=n?.provider.historyProvider.read(i);if(!n||!a)return;this._scmProviderCtx.set(n.provider.contextValue);const m=W(p=>a.historyItemRef.read(p)?.id);s.add(G(m,()=>{this.refresh()})),s.add(G(a.historyItemRefChanges,p=>{if(p.silent){if(this._tree.scrollTop===0){this.refresh();return}this._repositoryOutdated.set(!0,void 0);return}this.refresh()})),s.add(G(this._treeViewModel.onDidChangeHistoryItemsFilter,()=>{this.refresh()})),r||this.refresh(),r=!1}))})}layoutBody(e,t){super.layoutBody(e,t),this._tree.layout(e,t)}getActionRunner(){return this._actionRunner}getActionsContext(){return this._treeViewModel?.repository.get()?.provider}getActionViewItem(e,t){if(e.id===ge){const r=this._treeViewModel?.repository.get();if(r)return new ut(r,e,t)}else if(e.id===Se){const r=this._treeViewModel?.repository.get(),i=this._treeViewModel?.getHistoryItemsFilter();if(r&&i)return new It(r,i,e,t)}return super.getActionViewItem(e,t)}focus(){super.focus();const e=new KeyboardEvent("keydown");this._tree.focusFirst(e),this._tree.domFocus()}shouldShowWelcome(){return this._treeViewModel?.isViewModelEmpty.get()===!0}async refresh(){this._treeViewModel.clearRepositoryState(),await this._updateChildren(),this.updateActions(),this._repositoryOutdated.set(!1,void 0),this._tree.scrollTop=0}async pickRepository(){const t=await this._instantiationService.createInstance(D).pickRepository();t&&this._treeViewModel.setRepository(t.repository)}async pickHistoryItemRef(){const t=this._treeViewModel.repository.get()?.provider.historyProvider.get(),r=this._treeViewModel.getHistoryItemsFilter();if(!t||!r)return;const s=await this._instantiationService.createInstance(O,t,r).pickHistoryItemRef();s&&this._treeViewModel.setHistoryItemsFilter(s)}async revealCurrentHistoryItem(){const e=this._treeViewModel.repository.get(),r=e?.provider.historyProvider.get()?.historyItemRef.get(),i=this._treeViewModel.getHistoryItemsFilter();if(!e||!r?.revision||!i)return;if(Array.isArray(i)&&!i.find(n=>n.id===r.id)){this._notificationService.info(c("scmGraphViewRevealCurrentHistoryItem","The current history item is not present in the source control graph. Please use the history item references picker to expand the set of history items in the graph."));return}const s=()=>{const n=this._treeViewModel.getCurrentHistoryItemTreeElement();return n&&this._tree.hasNode(n)?(this._tree.reveal(n,.5),this._tree.setSelection([n]),this._tree.setFocus([n]),!0):!1};s()||(await this._loadMore(r.revision),s())}_createTree(e){this._treeIdentityProvider=new gt;const t=this.instantiationService.createInstance(A,this.viewDescriptorService.getViewLocationById(this.id));this._register(t),this._treeDataSource=this.instantiationService.createInstance(_t),this._register(this._treeDataSource),this._tree=this.instantiationService.createInstance(De,"SCM History Tree",e,new vt,[this.instantiationService.createInstance(g,t),this.instantiationService.createInstance(S,this._repositoryIsLoadingMore,()=>this._loadMore())],this._treeDataSource,{accessibilityProvider:new ft,identityProvider:this._treeIdentityProvider,collapseByDefault:r=>!1,keyboardNavigationLabelProvider:new St,horizontalScrolling:!1,multipleSelectionSupport:!1}),this._register(this._tree),this._tree.onDidOpen(this._onDidOpen,this,this._store),this._tree.onContextMenu(this._onContextMenu,this,this._store)}async _onDidOpen(e){if(e.element)if(w(e.element)){const t=e.element.historyItemViewModel.historyItem,r=t.parentIds.length>0?t.parentIds[0]:void 0,s=await e.element.repository.provider.historyProvider.get()?.provideHistoryItemChanges(t.id,r);if(s){const n=ne(t),a=e.element.repository.provider.rootUri,m=a?a.path:e.element.repository.provider.label,p=de.from({scheme:"scm-history-item",path:`${m}/${r}..${t.id}`},!0);await this._commandService.executeCommand("_workbench.openMultiDiffEditor",{title:n,multiDiffSourceUri:p,resources:s})}}else K(e.element)&&(this.configurationService.getValue("scm.graph.pageOnScroll")===!0||(this._loadMore(),this._tree.setSelection([])));else return}_onContextMenu(e){const t=e.element;!t||!w(t)||this.contextMenuService.showContextMenu({menuId:_.SCMChangesContext,menuActionOptions:{arg:t.repository.provider,shouldForwardArgs:!0},getAnchor:()=>e.anchor,getActionsContext:()=>t.historyItemViewModel.historyItem})}async _loadMore(e){return this._treeLoadMoreSequencer.queue(async()=>{this._repositoryIsLoadingMore.get()||(this._repositoryIsLoadingMore.set(!0,void 0),this._treeViewModel.loadMore(e),await this._updateChildren(),this._repositoryIsLoadingMore.set(!1,void 0))})}_updateChildren(){return this._updateChildrenThrottler.queue(()=>this._treeOperationSequencer.queue(async()=>{await this._progressService.withProgress({location:this.id},async()=>{await this._tree.updateChildren(void 0,void 0,void 0,{})})}))}dispose(){this._visibilityDisposables.dispose(),super.dispose()}};z=u([l(1,me),l(2,te),l(3,ht),l(4,pe),l(5,E),l(6,Fe),l(7,xe),l(8,te),l(9,Ke),l(10,ee),l(11,Oe),l(12,re),l(13,$e),l(14,U)],z);export{z as SCMHistoryViewPane};
