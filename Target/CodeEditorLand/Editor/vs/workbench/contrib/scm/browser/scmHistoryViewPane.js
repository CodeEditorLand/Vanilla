var Ie=Object.defineProperty;var ve=Object.getOwnPropertyDescriptor;var I=(d,i,e,t)=>{for(var r=t>1?void 0:t?ve(i,e):i,o=d.length-1,s;o>=0;o--)(s=d[o])&&(r=(t?s(i,e,r):s(r))||r);return t&&r&&Ie(i,e,r),r},l=(d,i)=>(e,t)=>i(e,t,d);import"./media/scm.css";import{$ as u,append as v,h as T,reset as G}from"../../../../base/browser/dom.js";import{ActionViewItem as U}from"../../../../base/browser/ui/actionbar/actionViewItems.js";import{getDefaultHoverDelegate as fe}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import{HoverPosition as R}from"../../../../base/browser/ui/hover/hoverWidget.js";import{IconLabel as Y}from"../../../../base/browser/ui/iconLabel/iconLabel.js";import{ActionRunner as ge}from"../../../../base/common/actions.js";import{delta as Se,groupBy as Ce,tail as Me}from"../../../../base/common/arrays.js";import{Sequencer as J,Throttler as _e}from"../../../../base/common/async.js";import{Codicon as H}from"../../../../base/common/codicons.js";import{fromNow as be}from"../../../../base/common/date.js";import{Event as we}from"../../../../base/common/event.js";import{createMatches as X}from"../../../../base/common/filters.js";import{MarkdownString as Te}from"../../../../base/common/htmlContent.js";import{stripIcons as Re}from"../../../../base/common/iconLabels.js";import{Iterable as Z}from"../../../../base/common/iterator.js";import{Disposable as x,DisposableStore as k}from"../../../../base/common/lifecycle.js";import{clamp as He}from"../../../../base/common/numbers.js";import{autorun as D,autorunWithStore as ke,autorunWithStoreHandleChanges as Pe,constObservable as Le,derived as F,latestChangedValue as Ee,observableFromEvent as ee,observableValue as O,runOnChange as Ve,signalFromObservable as Ae,waitForState as xe}from"../../../../base/common/observable.js";import*as De from"../../../../base/common/platform.js";import{compare as te}from"../../../../base/common/strings.js";import{ThemeIcon as f}from"../../../../base/common/themables.js";import{URI as re}from"../../../../base/common/uri.js";import{localize as c}from"../../../../nls.js";import{Action2 as Fe,MenuId as b,registerAction2 as $}from"../../../../platform/actions/common/actions.js";import{IClipboardService as Oe}from"../../../../platform/clipboard/common/clipboardService.js";import{ICommandService as ie}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as P}from"../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as Q,IContextKeyService as $e}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as Qe}from"../../../../platform/contextview/browser/contextView.js";import{IHoverService as K,WorkbenchHoverDelegate as Be}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as oe}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as Ne}from"../../../../platform/keybinding/common/keybinding.js";import{WorkbenchAsyncDataTree as ze}from"../../../../platform/list/browser/listService.js";import{observableConfigValue as qe}from"../../../../platform/observable/common/platformObservableUtils.js";import{IOpenerService as Ke}from"../../../../platform/opener/common/opener.js";import{IProgressService as se}from"../../../../platform/progress/common/progress.js";import{IQuickInputService as ne}from"../../../../platform/quickinput/common/quickInput.js";import{ITelemetryService as je}from"../../../../platform/telemetry/common/telemetry.js";import{asCssVariable as g,foreground as We}from"../../../../platform/theme/common/colorRegistry.js";import{IThemeService as ae}from"../../../../platform/theme/common/themeService.js";import{ViewAction as j,ViewPane as Ge,ViewPaneShowActions as Ue}from"../../../browser/parts/views/viewPane.js";import{IViewDescriptorService as Ye,ViewContainerLocation as le}from"../../../common/views.js";import{IWorkbenchLayoutService as Je,Position as ce}from"../../../services/layout/browser/layoutService.js";import{HISTORY_VIEW_PANE_ID as B,ISCMService as Xe,ISCMViewService as de}from"../common/scm.js";import{SWIMLANE_WIDTH as Ze,historyItemHoverAdditionsForeground as et,historyItemHoverDefaultLabelBackground as pe,historyItemHoverDefaultLabelForeground as tt,historyItemHoverDeletionsForeground as rt,historyItemHoverLabelForeground as me,renderSCMHistoryGraphPlaceholder as it,renderSCMHistoryItemGraph as ot,toISCMHistoryItemViewModelArray as st}from"./scmHistory.js";import{ContextKeys as nt}from"./scmViewPane.js";import{isSCMHistoryItemLoadMoreTreeElement as N,isSCMHistoryItemViewModelTreeElement as w,isSCMRepository as W}from"./util.js";const he="workbench.scm.action.graph.pickRepository",ye="workbench.scm.action.graph.pickHistoryItemRefs";class at extends U{constructor(e,t,r){super(null,t,{...r,icon:!1,label:!0});this._repository=e}updateLabel(){if(this.options.label&&this.label){this.label.classList.add("scm-graph-repository-picker");const e=u(".icon");e.classList.add(...f.asClassNameArray(H.repo));const t=u(".name");t.textContent=this._repository.provider.name,G(this.label,e,t)}}getTooltip(){return this._repository.provider.name}}class lt extends U{constructor(e,t,r,o){super(null,r,{...o,icon:!1,label:!0});this._repository=e;this._historyItemsFilter=t}updateLabel(){if(this.options.label&&this.label){this.label.classList.add("scm-graph-history-item-picker");const e=u(".icon");e.classList.add(...f.asClassNameArray(H.gitBranch));const t=u(".name");this._historyItemsFilter==="all"?t.textContent=c("all","All"):this._historyItemsFilter==="auto"?t.textContent=c("auto","Auto"):this._historyItemsFilter.length===1?t.textContent=this._historyItemsFilter[0].name:t.textContent=c("items","{0} Items",this._historyItemsFilter.length),G(this.label,e,t)}}getTooltip(){if(this._historyItemsFilter==="all")return c("allHistoryItemRefs","All history item references");if(this._historyItemsFilter==="auto"){const e=this._repository.provider.historyProvider.get();return[e?.historyItemRef.get()?.name,e?.historyItemRemoteRef.get()?.name,e?.historyItemBaseRef.get()?.name].filter(t=>!!t).join(", ")}else return this._historyItemsFilter.length===1?this._historyItemsFilter[0].name:this._historyItemsFilter.map(e=>e.name).join(", ")}}$(class extends j{constructor(){super({id:he,title:"",viewId:B,f1:!1,menu:{id:b.SCMHistoryTitle,when:Q.and(Q.has("scm.providerCount"),Q.greater("scm.providerCount",1)),group:"navigation",order:0}})}async runInView(d,i){i.pickRepository()}}),$(class extends j{constructor(){super({id:ye,title:"",icon:H.gitBranch,viewId:B,f1:!1,menu:{id:b.SCMHistoryTitle,group:"navigation",order:0}})}async runInView(d,i){i.pickHistoryItemRef()}}),$(class extends j{constructor(){super({id:"workbench.scm.action.graph.refresh",title:c("refreshGraph","Refresh"),viewId:B,f1:!1,icon:H.refresh,menu:{id:b.SCMHistoryTitle,group:"navigation",order:1e3}})}async runInView(d,i){i.refresh()}}),$(class extends Fe{constructor(){super({id:"workbench.scm.action.graph.viewChanges",title:c("viewChanges","View Changes"),f1:!1,menu:[{id:b.SCMChangesContext,group:"0_view",when:Q.equals("config.multiDiffEditor.experimental.enabled",!0)}]})}async run(d,i,...e){const t=d.get(ie);if(!i||e.length===0)return;const r=e[0],o=e[e.length-1],s=i.historyProvider.get();if(e.length>1){const M=await s?.resolveHistoryItemRefsCommonAncestor([r.id,o.id]);if(!M||M!==r.id&&M!==o.id)return}const n=o.parentIds.length>0?o.parentIds[0]:void 0,a=await s?.provideHistoryItemChanges(r.id,n);if(!a?.length)return;const m=e.length===1?`${e[0].displayId??e[0].id} - ${e[0].message}`:c("historyItemChangesEditorTitle","All Changes ({0} \u2194 {1})",o.displayId??o.id,r.displayId??r.id),h=i.rootUri,p=h?h.path:i.label,y=re.from({scheme:"scm-history-item",path:`${p}/${n}..${r.id}`},!0);t.executeCommand("_workbench.openMultiDiffEditor",{title:m,multiDiffSourceUri:y,resources:a})}});class ct{getHeight(){return 22}getTemplateId(i){if(w(i))return S.TEMPLATE_ID;if(N(i))return C.TEMPLATE_ID;throw new Error("Unknown element")}}let S=class{constructor(i,e,t,r,o){this.hoverDelegate=i;this._clipboardService=e;this._configurationService=t;this._hoverService=r;this._themeService=o}static TEMPLATE_ID="history-item";get templateId(){return S.TEMPLATE_ID}_badgesConfig=qe("scm.graph.badges","filter",this._configurationService);renderTemplate(i){i.parentElement.parentElement.querySelector(".monaco-tl-twistie").classList.add("force-no-twistie");const e=v(i,u(".history-item")),t=v(e,u(".graph-container")),r=new Y(e,{supportIcons:!0,supportHighlights:!0,supportDescriptionHighlights:!0}),o=v(e,u(".label-container"));return e.appendChild(o),{element:e,graphContainer:t,label:r,labelContainer:o,elementDisposables:new k,disposables:new k}}renderElement(i,e,t,r){const o=i.element.historyItemViewModel,s=o.historyItem,n=this._hoverService.setupManagedHover(this.hoverDelegate,t.element,this._getHoverContent(i.element),{actions:this._getHoverActions(s)});t.elementDisposables.add(n),t.graphContainer.textContent="",t.graphContainer.classList.toggle("current",o.isCurrent),t.graphContainer.appendChild(ot(o));const h=i.element.repository.provider.historyProvider.get()?.historyItemRef?.get()?.revision===s.id?["history-item-current"]:[],[p,y]=this._processMatches(o,i.filterData);t.label.setLabel(s.subject,s.author,{matches:p,descriptionMatches:y,extraClasses:h}),this._renderBadges(s,t)}_renderBadges(i,e){e.elementDisposables.add(D(t=>{const r=this._badgesConfig.read(t);e.labelContainer.textContent="";const o=i.references?.find(s=>s.color);for(const s of i.references??[])if(!(!s.color&&r==="filter")&&s.icon&&f.isThemeIcon(s.icon)){const n=T("div.label",{style:{color:s.color?g(me):g(We),backgroundColor:s.color?g(s.color):g(pe)}},[T("div.icon@icon"),T("div.description@description")]);n.icon.classList.add(...f.asClassNameArray(s.icon)),n.description.textContent=s.name,n.description.style.display=s===o?"":"none",v(e.labelContainer,n.root)}}))}_getHoverActions(i){return[{commandId:"workbench.scm.action.graph.copyHistoryItemId",iconClass:"codicon.codicon-copy",label:i.displayId??i.id,run:()=>this._clipboardService.writeText(i.id)},{commandId:"workbench.scm.action.graph.copyHistoryItemMessage",iconClass:"codicon.codicon-copy",label:c("historyItemMessage","Message"),run:()=>this._clipboardService.writeText(i.message)}]}_getHoverContent(i){const e=this._themeService.getColorTheme(),t=i.historyItemViewModel.historyItem,r=new Te("",{isTrusted:!0,supportThemeIcons:!0});if(t.author){if(r.appendMarkdown(`$(account) **${t.author}**`),t.timestamp){const o=new Intl.DateTimeFormat(De.language,{year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"});r.appendMarkdown(`, $(history) ${be(t.timestamp,!0,!0)} (${o.format(t.timestamp)})`)}r.appendMarkdown(`

`)}if(r.appendMarkdown(`${t.message}

`),t.statistics){if(r.appendMarkdown(`---

`),r.appendMarkdown(`<span>${t.statistics.files===1?c("fileChanged","{0} file changed",t.statistics.files):c("filesChanged","{0} files changed",t.statistics.files)}</span>`),t.statistics.insertions){const o=e.getColor(et);r.appendMarkdown(`,&nbsp;<span style="color:${o};">${t.statistics.insertions===1?c("insertion","{0} insertion{1}",t.statistics.insertions,"(+)"):c("insertions","{0} insertions{1}",t.statistics.insertions,"(+)")}</span>`)}if(t.statistics.deletions){const o=e.getColor(rt);r.appendMarkdown(`,&nbsp;<span style="color:${o};">${t.statistics.deletions===1?c("deletion","{0} deletion{1}",t.statistics.deletions,"(-)"):c("deletions","{0} deletions{1}",t.statistics.deletions,"(-)")}</span>`)}}return(t.references??[]).length>0&&(r.appendMarkdown(`

---

`),r.appendMarkdown((t.references??[]).map(o=>{const s=f.isThemeIcon(o.icon)?o.icon.id:"",n=o.color?g(o.color):g(pe);return`<span style="color:${o.color?g(me):g(tt)};background-color:${n};border-radius:2px;">&nbsp;$(${s})&nbsp;${o.name}&nbsp;</span>`}).join("&nbsp;&nbsp;"))),{markdown:r,markdownNotSupportedFallback:t.message}}_processMatches(i,e){return e?[i.historyItem.message===e.label?X(e.score):void 0,i.historyItem.author===e.label?X(e.score):void 0]:[void 0,void 0]}disposeElement(i,e,t,r){t.elementDisposables.clear()}disposeTemplate(i){i.disposables.dispose()}};S=I([l(1,Oe),l(2,P),l(3,K),l(4,ae)],S);let C=class{constructor(i,e,t){this._loadingMore=i;this._loadMoreCallback=e;this._configurationService=t}static TEMPLATE_ID="historyItemLoadMore";get templateId(){return C.TEMPLATE_ID}renderTemplate(i){i.parentElement.parentElement.querySelector(".monaco-tl-twistie").classList.add("force-no-twistie");const e=v(i,u(".history-item-load-more")),t=v(e,u(".graph-placeholder")),r=v(e,u(".history-item-placeholder")),o=new Y(r,{supportIcons:!0});return{element:e,graphPlaceholder:t,historyItemPlaceholderContainer:r,historyItemPlaceholderLabel:o,elementDisposables:new k,disposables:new k}}renderElement(i,e,t,r){t.graphPlaceholder.textContent="",t.graphPlaceholder.style.width=`${Ze*(i.element.graphColumns.length+1)}px`,t.graphPlaceholder.appendChild(it(i.element.graphColumns));const o=this._configurationService.getValue("scm.graph.pageOnScroll")===!0;t.historyItemPlaceholderContainer.classList.toggle("shimmer",o),o?(t.historyItemPlaceholderLabel.setLabel(""),this._loadMoreCallback(i.element.repository)):t.elementDisposables.add(D(s=>{const a=`$(${this._loadingMore().read(s)?"loading~spin":"fold-down"})`;t.historyItemPlaceholderLabel.setLabel(c("loadMore","{0} Load More...",a))}))}disposeElement(i,e,t,r){t.elementDisposables.clear()}disposeTemplate(i){i.disposables.dispose()}};C=I([l(2,P)],C);let L=class extends Be{constructor(e,t,r,o){super("element",!0,()=>this.getHoverOptions(),r,o);this._viewContainerLocation=e;this.layoutService=t}getHoverOptions(){const e=this.layoutService.getSideBarPosition();let t;return this._viewContainerLocation===le.Sidebar?t=e===ce.LEFT?R.RIGHT:R.LEFT:this._viewContainerLocation===le.AuxiliaryBar?t=e===ce.LEFT?R.LEFT:R.RIGHT:t=R.RIGHT,{additionalClasses:["history-item-hover"],position:{hoverPosition:t,forcePosition:!0}}}};L=I([l(1,Je),l(2,P),l(3,K)],L);let E=class extends ge{constructor(e){super();this._progressService=e}runAction(e,t){return this._progressService.withProgress({location:B},async()=>await super.runAction(e,t))}};E=I([l(0,se)],E);class dt{getWidgetAriaLabel(){return c("scm history","Source Control History")}getAriaLabel(i){if(W(i))return`${i.provider.name} ${i.provider.label}`;if(w(i)){const e=i.historyItemViewModel.historyItem;return`${Re(e.message).trim()}${e.author?`, ${e.author}`:""}`}else return""}}class pt{getId(i){if(W(i))return`repo:${i.provider.id}`;if(w(i)){const e=i.repository.provider,t=i.historyItemViewModel.historyItem;return`historyItem:${e.id}/${t.id}/${t.parentIds.join(",")}`}else{if(N(i))return`historyItemLoadMore:${i.repository.provider.id}}`;throw new Error("Invalid tree element")}}}class mt{getKeyboardNavigationLabel(i){if(!W(i)){if(w(i))return[i.historyItemViewModel.historyItem.message,i.historyItemViewModel.historyItem.author];if(N(i))return"";throw new Error("Invalid tree element")}}}class ht extends x{async getChildren(i){if(!(i instanceof _))return[];const e=[],t=await i.getHistoryItems();e.push(...t);const r=i.repository.get(),o=Me(t);return r&&o&&o.historyItemViewModel.outputSwimlanes.length>0&&e.push({repository:r,graphColumns:o.historyItemViewModel.outputSwimlanes,type:"historyItemLoadMore"}),e}hasChildren(i){return i instanceof _}}let _=class extends x{constructor(e,t,r){super();this._configurationService=e;this._scmService=t;this._scmViewService=r;this._register(D(o=>{const s=this._closedRepository.read(o);s&&(this.repository.get()===s&&this._selectedRepository.set(Z.first(this._scmService.repositories)??"auto",void 0),this._state.delete(s))}))}_closedRepository=ee(this,this._scmService.onDidRemoveRepository,e=>e);_firstRepository=this._scmService.repositoryCount>0?Le(Z.first(this._scmService.repositories)):ee(this,we.once(this._scmService.onDidAddRepository),e=>e);_selectedRepository=O(this,"auto");_graphRepository=F(e=>{const t=this._selectedRepository.read(e);return t!=="auto"?t:this._scmViewService.activeRepository.read(e)});repository=Ee(this,[this._firstRepository,this._graphRepository]);historyItemsFilter=O(this,"auto");_state=new Map;clearRepositoryState(){const e=this.repository.get();e&&this._state.delete(e)}setLoadMore(e,t){const r=this._state.get(e);r&&this._state.set(e,{...r,loadMore:t})}async getHistoryItems(){const e=this.repository.get();if(!e)return[];let t=this._state.get(e);const r=e.provider.historyProvider.get();if(!r)return[];if(!t||t.loadMore){const s=t?.items??[];let n=t?.historyItemRefs;if(!n){const p=this.historyItemsFilter.get();switch(p){case"all":n=await r.provideHistoryItemRefs()??[];break;case"auto":n=[r.historyItemRef.get(),r.historyItemRemoteRef.get(),r.historyItemBaseRef.get()].filter(y=>!!y);break;default:n=p;break}}const a=He(this._configurationService.getValue("scm.graph.pageSize"),1,1e3),m=n.map(p=>p.revision??p.id),h=await r.provideHistoryItems({historyItemRefs:m,limit:a,skip:s.length})??[];t={historyItemRefs:n,items:[...s,...h],loadMore:!1},this._state.set(e,t)}const o=this._getGraphColorMap(t.historyItemRefs);return st(t.items,o,r.historyItemRef.get()).map(s=>({repository:e,historyItemViewModel:s,type:"historyItemViewModel"}))}setRepository(e){this._selectedRepository.set(e,void 0)}setHistoryItemsFilter(e){this.historyItemsFilter.set(e,void 0)}_getGraphColorMap(e){const r=this.repository.get()?.provider.historyProvider.get(),o=r?.historyItemRef.get(),s=r?.historyItemRemoteRef.get(),n=r?.historyItemBaseRef.get(),a=new Map;o&&(a.set(o.id,o.color),s&&a.set(s.id,s.color),n&&a.set(n.id,n.color));for(const m of e)a.has(m.id)||a.set(m.id,void 0);return a}dispose(){this._state.clear(),super.dispose()}};_=I([l(0,P),l(1,Xe),l(2,de)],_);let V=class extends x{constructor(e,t){super();this._quickInputService=e;this._scmViewService=t}_autoQuickPickItem={label:c("auto","Auto"),description:c("activeRepository","Show the source control graph for the active repository"),repository:"auto"};async pickRepository(){const e=[this._autoQuickPickItem,{type:"separator"}];return e.push(...this._scmViewService.repositories.map(t=>({label:t.provider.name,description:t.provider.rootUri?.fsPath,iconClass:f.asClassName(H.repo),repository:t}))),this._quickInputService.pick(e,{placeHolder:c("scmGraphRepository","Select the repository to view, type to filter all repositories")})}};V=I([l(0,ne),l(1,de)],V);let A=class extends x{constructor(e,t,r){super();this._historyProvider=e;this._historyItemsFilter=t;this._quickInputService=r}_allQuickPickItem={id:"all",label:c("all","All"),description:c("allHistoryItemRefs","All history item references"),historyItemRef:"all"};_autoQuickPickItem={id:"auto",label:c("auto","Auto"),description:c("currentHistoryItemRef","Current history item reference(s)"),historyItemRef:"auto"};async pickHistoryItemRef(){const e=this._quickInputService.createQuickPick({useSeparators:!0});this._store.add(e),e.placeholder=c("scmGraphHistoryItemRef","Select one/more history item references to view, type to filter"),e.canSelectMany=!0,e.hideCheckAll=!0,e.busy=!0,e.show();const t=await this._createQuickPickItems();let r=[];if(this._historyItemsFilter==="all")r.push(this._allQuickPickItem);else if(this._historyItemsFilter==="auto")r.push(this._autoQuickPickItem);else{let o=0;for(;o<t.length;){if(t[o].type==="separator"){o++;continue}if(this._historyItemsFilter.some(s=>s.id===t[o].id)){const s=t.splice(o,1);r.push(...s)}else o++}t.splice(2,0,{type:"separator"},...r)}return e.items=t,e.selectedItems=r,e.busy=!1,new Promise(o=>{this._store.add(e.onDidChangeSelection(s=>{const{added:n}=Se(r,s,(a,m)=>te(a.id??"",m.id??""));n.length>0&&(n[0].historyItemRef==="all"||n[0].historyItemRef==="auto"?e.selectedItems=[n[0]]:e.selectedItems=[...e.selectedItems.filter(a=>a.historyItemRef!=="all"&&a.historyItemRef!=="auto")]),r=[...e.selectedItems]})),this._store.add(e.onDidAccept(()=>{r.length===0?o(void 0):r.length===1&&r[0].historyItemRef==="all"?o("all"):r.length===1&&r[0].historyItemRef==="auto"?o("auto"):o(r.map(s=>s.historyItemRef)),e.hide()})),this._store.add(e.onDidHide(()=>{o(void 0),this.dispose()}))})}async _createQuickPickItems(){const e=[this._allQuickPickItem,this._autoQuickPickItem],t=await this._historyProvider.provideHistoryItemRefs()??[],r=Ce(t,(o,s)=>te(o.category??"",s.category??""));for(const o of r)o.length!==0&&(e.push({type:"separator",label:o[0].category}),e.push(...o.map(s=>({id:s.id,label:s.name,description:s.description,iconClass:f.isThemeIcon(s.icon)?f.asClassName(s.icon):void 0,historyItemRef:s}))));return e}};A=I([l(2,ne)],A);let z=class extends Ge{constructor(e,t,r,o,s,n,a,m,h,p,y,M,q,ue){super({...e,titleMenuId:b.SCMHistoryTitle,showActions:Ue.WhenExpanded},a,n,s,p,h,m,y,M,q,ue);this._commandService=t;this._instantiationService=r;this._progressService=o;this._scmProviderCtx=nt.SCMProvider.bindTo(this.scopedContextKeyService),this._actionRunner=this.instantiationService.createInstance(E),this._register(this._actionRunner),this._register(this._updateChildrenThrottler)}_treeContainer;_tree;_treeViewModel;_treeDataSource;_treeIdentityProvider;_repositoryLoadMore=O(this,!1);_repositoryOutdated=O(this,!1);_actionRunner;_visibilityDisposables=new k;_treeOperationSequencer=new J;_treeLoadMoreSequencer=new J;_updateChildrenThrottler=new _e;_scmProviderCtx;renderHeaderTitle(e){super.renderHeaderTitle(e,this.title);const t=T("div.scm-graph-view-badge-container",[T("div.scm-graph-view-badge.monaco-count-badge.long@badge")]);t.badge.textContent="Outdated",e.appendChild(t.root),this._register(this.hoverService.setupManagedHover(fe("mouse"),t.root,{markdown:{value:c("scmGraphViewOutdated","Please refresh the graph using the refresh action ($(refresh))."),supportThemeIcons:!0},markdownNotSupportedFallback:void 0})),this._register(D(r=>{const o=this._repositoryOutdated.read(r);t.root.style.display=o?"":"none"}))}renderBody(e){super.renderBody(e),this._treeContainer=v(e,u(".scm-view.scm-history-view")),this._treeContainer.classList.add("file-icon-themable-tree"),this._createTree(this._treeContainer),this.onDidChangeBodyVisibility(async t=>{if(!t){this._visibilityDisposables.clear();return}this._treeViewModel=this.instantiationService.createInstance(_),this._visibilityDisposables.add(this._treeViewModel),await this._progressService.withProgress({location:this.id},async()=>{const o=F(this,s=>this._treeViewModel.repository.read(s)?.provider.historyProvider.read(s)?.historyItemRef.read(s)!==void 0?!0:void 0);await xe(o),await this._treeOperationSequencer.queue(async()=>{await this._tree.setInput(this._treeViewModel),this._tree.scrollTop=0})});let r=!0;this._visibilityDisposables.add(ke((o,s)=>{const n=this._treeViewModel.repository.read(o),a=n?.provider.historyProvider.read(o);if(!n||!a)return;this._scmProviderCtx.set(n.provider.contextValue);const m=Ae(this,F(p=>a.historyItemRemoteRef.read(p)?.id)),h=F(p=>a.historyItemRemoteRef.read(p)?.revision);s.add(Pe({owner:this,createEmptyChangeSummary:()=>({refresh:!1}),handleChange(p,y){return y.refresh=p.didChange(h)?"ifScrollTop":!0,!0}},(p,y)=>{m.read(p);const M=a.historyItemRef.read(p),q=h.read(p);if(y.refresh===!0){this.refresh();return}if(y.refresh==="ifScrollTop"){if(M?.revision===q){this.refresh();return}if(this._tree.scrollTop===0){this.refresh();return}this._repositoryOutdated.set(!0,void 0)}})),s.add(Ve(this._treeViewModel.historyItemsFilter,()=>{this.refresh()})),r||this.refresh(),r=!1}))})}layoutBody(e,t){super.layoutBody(e,t),this._tree.layout(e,t)}getActionRunner(){return this._actionRunner}getActionsContext(){return this._treeViewModel?.repository.get()?.provider}getActionViewItem(e,t){if(e.id===he){const r=this._treeViewModel?.repository.get();if(r)return new at(r,e,t)}else if(e.id===ye){const r=this._treeViewModel?.repository.get(),o=this._treeViewModel?.historyItemsFilter.get();if(r&&o)return new lt(r,o,e,t)}return super.getActionViewItem(e,t)}async refresh(){await this._updateChildren(!0),this.updateActions(),this._repositoryOutdated.set(!1,void 0),this._tree.scrollTop=0}async pickRepository(){const t=await this._instantiationService.createInstance(V).pickRepository();t&&this._treeViewModel.setRepository(t.repository)}async pickHistoryItemRef(){const t=this._treeViewModel.repository.get()?.provider.historyProvider.get(),r=this._treeViewModel.historyItemsFilter.get();if(!t)return;const s=await this._instantiationService.createInstance(A,t,r).pickHistoryItemRef();s&&this._treeViewModel.setHistoryItemsFilter(s)}_createTree(e){this._treeIdentityProvider=new pt;const t=this.instantiationService.createInstance(L,this.viewDescriptorService.getViewLocationById(this.id));this._register(t),this._treeDataSource=this.instantiationService.createInstance(ht),this._register(this._treeDataSource),this._tree=this.instantiationService.createInstance(ze,"SCM History Tree",e,new ct,[this.instantiationService.createInstance(S,t),this.instantiationService.createInstance(C,()=>this._repositoryLoadMore,r=>this._loadMoreCallback(r))],this._treeDataSource,{accessibilityProvider:new dt,identityProvider:this._treeIdentityProvider,collapseByDefault:r=>!1,keyboardNavigationLabelProvider:new mt,horizontalScrolling:!1,multipleSelectionSupport:!1}),this._register(this._tree),this._tree.onDidOpen(this._onDidOpen,this,this._store),this._tree.onContextMenu(this._onContextMenu,this,this._store)}async _onDidOpen(e){if(e.element)if(w(e.element)){const t=e.element.historyItemViewModel.historyItem,r=t.parentIds.length>0?t.parentIds[0]:void 0,s=await e.element.repository.provider.historyProvider.get()?.provideHistoryItemChanges(t.id,r);if(s){const n=`${t.displayId??t.id} - ${t.message}`,a=e.element.repository.provider.rootUri,m=a?a.path:e.element.repository.provider.label,h=re.from({scheme:"scm-history-item",path:`${m}/${r}..${t.id}`},!0);await this._commandService.executeCommand("_workbench.openMultiDiffEditor",{title:n,multiDiffSourceUri:h,resources:s})}}else N(e.element)&&(this.configurationService.getValue("scm.graph.pageOnScroll")===!0||(this._loadMoreCallback(e.element.repository),this._tree.setSelection([])));else return}_onContextMenu(e){const t=e.element;!t||!w(t)||this.contextMenuService.showContextMenu({menuId:b.SCMChangesContext,menuActionOptions:{arg:t.repository.provider,shouldForwardArgs:!0},getAnchor:()=>e.anchor,getActionsContext:()=>t.historyItemViewModel.historyItem})}async _loadMoreCallback(e){return this._treeLoadMoreSequencer.queue(async()=>{this._repositoryLoadMore.get()||(this._repositoryLoadMore.set(!0,void 0),this._treeViewModel.setLoadMore(e,!0),await this._updateChildren(),this._repositoryLoadMore.set(!1,void 0))})}_updateChildren(e=!1){return this._updateChildrenThrottler.queue(()=>this._treeOperationSequencer.queue(async()=>{e&&this._treeViewModel.clearRepositoryState(),await this._progressService.withProgress({location:this.id},async()=>{await this._tree.updateChildren(void 0,void 0,void 0,{})})}))}dispose(){this._visibilityDisposables.dispose(),super.dispose()}};z=I([l(1,ie),l(2,oe),l(3,se),l(4,P),l(5,Qe),l(6,Ne),l(7,oe),l(8,Ye),l(9,$e),l(10,Ke),l(11,ae),l(12,je),l(13,K)],z);export{z as SCMHistoryViewPane};
