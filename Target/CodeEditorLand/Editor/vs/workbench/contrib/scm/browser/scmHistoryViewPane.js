var ne=Object.defineProperty;var ae=Object.getOwnPropertyDescriptor;var v=(m,o,t,e)=>{for(var r=e>1?void 0:e?ae(o,t):o,i=m.length-1,s;i>=0;i--)(s=m[i])&&(r=(e?s(o,t,r):s(r))||r);return e&&r&&ne(o,t,r),r},a=(m,o)=>(t,e)=>o(t,e,m);import"vs/css!./media/scm";import{$ as u,append as I}from"../../../../../vs/base/browser/dom.js";import"../../../../../vs/base/browser/ui/actionbar/actionbar.js";import"../../../../../vs/base/browser/ui/hover/hover.js";import"../../../../../vs/base/browser/ui/hover/hoverDelegate.js";import{createInstantHoverDelegate as le,getDefaultHoverDelegate as ce}from"../../../../../vs/base/browser/ui/hover/hoverDelegateFactory.js";import{HoverPosition as w}from"../../../../../vs/base/browser/ui/hover/hoverWidget.js";import{IconLabel as k}from"../../../../../vs/base/browser/ui/iconLabel/iconLabel.js";import"../../../../../vs/base/browser/ui/list/list.js";import"../../../../../vs/base/browser/ui/list/listWidget.js";import"../../../../../vs/base/browser/ui/tree/abstractTree.js";import"../../../../../vs/base/browser/ui/tree/tree.js";import{ActionRunner as B}from"../../../../../vs/base/common/actions.js";import{tail as de}from"../../../../../vs/base/common/arrays.js";import{Sequencer as me,Throttler as pe}from"../../../../../vs/base/common/async.js";import{Codicon as he}from"../../../../../vs/base/common/codicons.js";import{fromNow as ye}from"../../../../../vs/base/common/date.js";import{Event as ue}from"../../../../../vs/base/common/event.js";import{createMatches as K}from"../../../../../vs/base/common/filters.js";import{MarkdownString as Ie}from"../../../../../vs/base/common/htmlContent.js";import{stripIcons as ve}from"../../../../../vs/base/common/iconLabels.js";import{Iterable as Se}from"../../../../../vs/base/common/iterator.js";import{combinedDisposable as ge,Disposable as Me,DisposableMap as fe,DisposableStore as C}from"../../../../../vs/base/common/lifecycle.js";import{autorun as _,autorunWithStore as be,observableValue as N}from"../../../../../vs/base/common/observable.js";import*as Ce from"../../../../../vs/base/common/platform.js";import{ThemeIcon as $}from"../../../../../vs/base/common/themables.js";import{URI as we}from"../../../../../vs/base/common/uri.js";import{localize as h}from"../../../../../vs/nls.js";import{WorkbenchToolBar as _e}from"../../../../../vs/platform/actions/browser/toolbar.js";import{IMenuService as Te,MenuId as E,MenuItemAction as He,registerAction2 as Re}from"../../../../../vs/platform/actions/common/actions.js";import{ICommandService as O}from"../../../../../vs/platform/commands/common/commands.js";import{IConfigurationService as P}from"../../../../../vs/platform/configuration/common/configuration.js";import{ContextKeyExpr as D,IContextKeyService as W}from"../../../../../vs/platform/contextkey/common/contextkey.js";import{IContextMenuService as q}from"../../../../../vs/platform/contextview/browser/contextView.js";import{IHoverService as A,WorkbenchHoverDelegate as Le}from"../../../../../vs/platform/hover/browser/hover.js";import{IInstantiationService as Ve}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{IKeybindingService as U}from"../../../../../vs/platform/keybinding/common/keybinding.js";import{WorkbenchAsyncDataTree as Ee}from"../../../../../vs/platform/list/browser/listService.js";import{observableConfigValue as Pe}from"../../../../../vs/platform/observable/common/platformObservableUtils.js";import{IOpenerService as De}from"../../../../../vs/platform/opener/common/opener.js";import{IProgressService as j}from"../../../../../vs/platform/progress/common/progress.js";import{ITelemetryService as Y}from"../../../../../vs/platform/telemetry/common/telemetry.js";import{registerColor as J}from"../../../../../vs/platform/theme/common/colorRegistry.js";import{IThemeService as Q}from"../../../../../vs/platform/theme/common/themeService.js";import{ViewAction as Ae,ViewPane as xe}from"../../../../../vs/workbench/browser/parts/views/viewPane.js";import{IViewDescriptorService as Ge,ViewContainerLocation as X}from"../../../../../vs/workbench/common/views.js";import{historyItemGroupBase as Z,historyItemGroupHoverLabelForeground as ke,historyItemGroupLocal as ee,historyItemGroupRemote as te,renderSCMHistoryGraphPlaceholder as $e,renderSCMHistoryItemGraph as Fe,SWIMLANE_WIDTH as ze,toISCMHistoryItemViewModelArray as Be}from"../../../../../vs/workbench/contrib/scm/browser/scmHistory.js";import{RepositoryActionRunner as Ke}from"../../../../../vs/workbench/contrib/scm/browser/scmRepositoryRenderer.js";import{ContextKeys as Ne}from"../../../../../vs/workbench/contrib/scm/browser/scmViewPane.js";import{collectContextMenuActions as re,connectPrimaryMenu as Oe,getActionViewItemProvider as We,isSCMHistoryItemLoadMoreTreeElement as T,isSCMHistoryItemViewModelTreeElement as S,isSCMRepository as p,isSCMViewService as F}from"../../../../../vs/workbench/contrib/scm/browser/util.js";import"../../../../../vs/workbench/contrib/scm/common/history.js";import{HISTORY_VIEW_PANE_ID as oe,ISCMService as qe,ISCMViewService as z}from"../../../../../vs/workbench/contrib/scm/common/scm.js";import{IWorkbenchLayoutService as Ue,Position as ie}from"../../../../../vs/workbench/services/layout/browser/layoutService.js";const je=J("scm.historyItemAdditionsForeground","gitDecoration.addedResourceForeground",h("scm.historyItemAdditionsForeground","History item additions foreground color.")),Ye=J("scm.historyItemDeletionsForeground","gitDecoration.deletedResourceForeground",h("scm.historyItemDeletionsForeground","History item deletions foreground color."));Re(class extends Ae{constructor(){super({id:"workbench.scm.action.refreshGraph",title:h("refreshGraph","Refresh"),viewId:oe,f1:!1,icon:he.refresh,menu:{id:E.SCMHistoryTitle,when:D.or(D.has("scmRepository"),D.and(Ne.RepositoryVisibilityCount.isEqualTo(1),D.equals("config.scm.alwaysShowRepositories",!1))),group:"navigation",order:1e3}})}async runInView(m,o,t){const e=m.get(qe),r=t?e.getRepository(t.id):void 0;o.refresh(r)}});class Je{getHeight(){return 22}getTemplateId(o){if(p(o))return g.TEMPLATE_ID;if(S(o))return M.TEMPLATE_ID;if(T(o))return f.TEMPLATE_ID;throw new Error("Unknown element")}}let g=class{constructor(o,t,e,r,i,s,n,l,d,c){this.description=o;this.actionRunner=t;this.actionViewItemProvider=e;this.commandService=r;this.contextKeyService=i;this.contextMenuService=s;this.hoverService=n;this.keybindingService=l;this.menuService=d;this.telemetryService=c}static TEMPLATE_ID="repository";get templateId(){return g.TEMPLATE_ID}renderTemplate(o){o.classList.contains("monaco-tl-contents")&&o.parentElement.parentElement.querySelector(".monaco-tl-twistie").classList.add("force-twistie");const t=I(o,u(".scm-provider")),e=new k(t),r=this.hoverService.setupManagedHover(ce("mouse"),e.element,"",{}),i=I(t,u("div.state-label.monaco-count-badge.long")),s=new _e(I(t,u(".actions")),{actionRunner:this.actionRunner,actionViewItemProvider:this.actionViewItemProvider,resetMenu:E.SCMHistoryTitle},this.menuService,this.contextKeyService,this.contextMenuService,this.keybindingService,this.commandService,this.telemetryService);return{label:e,labelCustomHover:r,stateLabel:i,toolBar:s,elementDisposables:new C,templateDisposable:ge(r,s)}}renderElement(o,t,e,r){const i=p(o)?o:o.element;e.elementDisposables.add(_(s=>{const n=this.description(i).read(s);e.stateLabel.style.display=n!==""?"":"none",e.stateLabel.textContent=n})),e.label.setLabel(i.provider.name),e.labelCustomHover.update(i.provider.rootUri?`${i.provider.label}: ${i.provider.rootUri.fsPath}`:i.provider.label),e.elementDisposables.add(be((s,n)=>{const l=i.provider.historyProvider.read(s)?.currentHistoryItemGroup.read(s);if(!l){e.toolBar.setActions([],[]);return}const d=this.contextKeyService.createOverlay([["scmRepository",i.id],["scmProvider",i.provider.contextValue],["scmHistoryItemGroupHasRemote",!!l.remote]]),c=this.menuService.createMenu(E.SCMHistoryTitle,d);n.add(Oe(c,(b,y)=>{e.toolBar.setActions(b,y)}))})),e.toolBar.context=i.provider}disposeElement(o,t,e){e.elementDisposables.clear()}disposeTemplate(o){o.elementDisposables.dispose(),o.templateDisposable.dispose()}};g=v([a(3,O),a(4,W),a(5,q),a(6,A),a(7,U),a(8,Te),a(9,Y)],g);let M=class{constructor(o,t,e){this.hoverDelegate=o;this.hoverService=t;this.themeService=e}static TEMPLATE_ID="history-item";get templateId(){return M.TEMPLATE_ID}renderTemplate(o){o.parentElement.parentElement.querySelector(".monaco-tl-twistie").classList.add("force-no-twistie");const t=I(o,u(".history-item")),e=I(t,u(".graph-container")),r=new k(t,{supportIcons:!0,supportHighlights:!0,supportDescriptionHighlights:!0}),i=I(t,u(".label-container"));return t.appendChild(i),{element:t,graphContainer:e,label:r,labelContainer:i,elementDisposables:new C,disposables:new C}}renderElement(o,t,e,r){const i=o.element.historyItemViewModel,s=i.historyItem,n=this.hoverService.setupManagedHover(this.hoverDelegate,e.element,this.getTooltip(o.element));e.elementDisposables.add(n),e.graphContainer.textContent="",e.graphContainer.appendChild(Fe(i));const[l,d]=this.processMatches(i,o.filterData);if(e.label.setLabel(s.message,s.author,{matches:l,descriptionMatches:d}),e.labelContainer.textContent="",s.labels){const c=le();e.elementDisposables.add(c);const b=this.getLabels(o.element.repository);for(const y of s.labels)if(y.icon&&$.isThemeIcon(y.icon)&&b.includes(y.title)){const V=I(e.labelContainer,u("div.label"));V.classList.add(...$.asClassNameArray(y.icon));const G=this.hoverService.setupManagedHover(c,V,y.title);e.elementDisposables.add(G)}}}getLabels(o){const t=o.provider.historyProvider.get()?.currentHistoryItemGroup.get();return t?[t.name,t.remote?.name??"",t.base?.name??""]:[]}getTooltip(o){const t=this.themeService.getColorTheme(),e=o.historyItemViewModel.historyItem,r=o.repository.provider.historyProvider.get()?.currentHistoryItemGroup?.get(),i=new Ie("",{isTrusted:!0,supportThemeIcons:!0});if(e.author){if(i.appendMarkdown(`$(account) **${e.author}**`),e.timestamp){const s=new Intl.DateTimeFormat(Ce.language,{year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"});i.appendMarkdown(`, $(history) ${ye(e.timestamp,!0,!0)} (${s.format(e.timestamp)})`)}i.appendMarkdown(`

`)}if(i.appendMarkdown(`${e.message}

`),e.statistics){if(i.appendMarkdown(`---

`),i.appendMarkdown(`<span>${e.statistics.files===1?h("fileChanged","{0} file changed",e.statistics.files):h("filesChanged","{0} files changed",e.statistics.files)}</span>`),e.statistics.insertions){const s=t.getColor(je);i.appendMarkdown(`,&nbsp;<span style="color:${s};">${e.statistics.insertions===1?h("insertion","{0} insertion{1}",e.statistics.insertions,"(+)"):h("insertions","{0} insertions{1}",e.statistics.insertions,"(+)")}</span>`)}if(e.statistics.deletions){const s=t.getColor(Ye);i.appendMarkdown(`,&nbsp;<span style="color:${s};">${e.statistics.deletions===1?h("deletion","{0} deletion{1}",e.statistics.deletions,"(-)"):h("deletions","{0} deletions{1}",e.statistics.deletions,"(-)")}</span>`)}}if(e.labels){const s=t.getColor(ee),n=t.getColor(te),l=t.getColor(Z),d=t.getColor(ke);i.appendMarkdown(`

---

`),i.appendMarkdown(e.labels.map(c=>{const b=c.title===r?.name?s:c.title===r?.remote?.name?n:c.title===r?.base?.name?l:void 0,y=$.isThemeIcon(c.icon)?c.icon.id:"";return`<span style="color:${d};background-color:${b};border-radius:2px;">&nbsp;$(${y})&nbsp;${c.title}&nbsp;</span>`}).join("&nbsp;&nbsp;"))}return{markdown:i,markdownNotSupportedFallback:e.message}}processMatches(o,t){return t?[o.historyItem.message===t.label?K(t.score):void 0,o.historyItem.author===t.label?K(t.score):void 0]:[void 0,void 0]}disposeElement(o,t,e,r){e.elementDisposables.clear()}disposeTemplate(o){o.disposables.dispose()}};M=v([a(1,A),a(2,Q)],M);let f=class{constructor(o,t,e,r){this._loadingMore=o;this._loadMoreCallback=t;this._configurationService=e;this._scmViewService=r}static TEMPLATE_ID="historyItemLoadMore";get templateId(){return f.TEMPLATE_ID}renderTemplate(o){o.parentElement.parentElement.querySelector(".monaco-tl-twistie").classList.add("force-no-twistie");const t=I(o,u(".history-item-load-more")),e=I(t,u(".graph-placeholder")),r=I(t,u(".history-item-placeholder")),i=new k(r,{supportIcons:!0});return{element:t,graphPlaceholder:e,historyItemPlaceholderContainer:r,historyItemPlaceholderLabel:i,elementDisposables:new C,disposables:new C}}renderElement(o,t,e,r){const i=this._scmViewService.visibleRepositories.length,s=this._configurationService.getValue("scm.alwaysShowRepositories")===!0;e.graphPlaceholder.textContent="",e.graphPlaceholder.style.width=`${ze*(o.element.graphColumns.length+1)}px`,e.graphPlaceholder.appendChild($e(o.element.graphColumns)),e.historyItemPlaceholderContainer.classList.toggle("shimmer",i===1&&!s),i>1||s?e.elementDisposables.add(_(n=>{const d=`$(${this._loadingMore(o.element.repository).read(n)?"loading~spin":"fold-down"})`;e.historyItemPlaceholderLabel.setLabel(h("loadMore","{0} Load More...",d))})):(e.historyItemPlaceholderLabel.setLabel(""),this._loadMoreCallback(o.element.repository))}disposeTemplate(o){o.disposables.dispose()}};f=v([a(2,P),a(3,z)],f);class Qe extends B{constructor(t){super();this.getSelectedHistoryItems=t}async runAction(t,e){if(!(t instanceof He))return super.runAction(t,e);const r=[];r.push(e.repository.provider);const i=this.getSelectedHistoryItems();i.some(n=>n===e)&&i.length>1?r.push(...i.map(n=>({id:n.historyItemViewModel.historyItem.id,parentIds:n.historyItemViewModel.historyItem.parentIds,message:n.historyItemViewModel.historyItem.message,author:n.historyItemViewModel.historyItem.author,icon:n.historyItemViewModel.historyItem.icon,timestamp:n.historyItemViewModel.historyItem.timestamp,statistics:n.historyItemViewModel.historyItem.statistics}))):r.push({id:e.historyItemViewModel.historyItem.id,parentIds:e.historyItemViewModel.historyItem.parentIds,message:e.historyItemViewModel.historyItem.message,author:e.historyItemViewModel.historyItem.author,icon:e.historyItemViewModel.historyItem.icon,timestamp:e.historyItemViewModel.historyItem.timestamp,statistics:e.historyItemViewModel.historyItem.statistics}),await t.run(...r)}}let H=class extends Le{constructor(t,e,r,i){super("element",!0,()=>this.getHoverOptions(),r,i);this._viewContainerLocation=t;this.layoutService=e}getHoverOptions(){const t=this.layoutService.getSideBarPosition();let e;return this._viewContainerLocation===X.Sidebar?e=t===ie.LEFT?w.RIGHT:w.LEFT:this._viewContainerLocation===X.AuxiliaryBar?e=t===ie.LEFT?w.LEFT:w.RIGHT:e=w.RIGHT,{additionalClasses:["history-item-hover"],position:{hoverPosition:e,forcePosition:!0}}}};H=v([a(1,Ue),a(2,P),a(3,A)],H);let R=class extends B{constructor(t){super();this._progressService=t}runAction(t,e){return this._progressService.withProgress({location:oe},async()=>await super.runAction(t,e))}};R=v([a(0,j)],R);class Xe{getWidgetAriaLabel(){return h("scm history","Source Control History")}getAriaLabel(o){if(p(o))return`${o.provider.name} ${o.provider.label}`;if(S(o)){const t=o.historyItemViewModel.historyItem;return`${ve(t.message).trim()}${t.author?`, ${t.author}`:""}`}else return""}}class Ze{getId(o){if(p(o))return`repo:${o.provider.id}`;if(S(o)){const t=o.repository.provider,e=o.historyItemViewModel.historyItem;return`historyItem:${t.id}/${e.id}/${e.parentIds.join(",")}`}else{if(T(o))return`historyItemLoadMore:${o.repository.provider.id}}`;throw new Error("Invalid tree element")}}}class et{getKeyboardNavigationLabel(o){if(!p(o)){if(S(o))return[o.historyItemViewModel.historyItem.message,o.historyItemViewModel.historyItem.author];if(T(o))return"";throw new Error("Invalid tree element")}}}let L=class extends Me{constructor(t,e){super();this._configurationService=t;this._scmViewService=e}_state=new Map;async getChildren(t){const e=this._scmViewService.visibleRepositories.length,r=this._configurationService.getValue("scm.alwaysShowRepositories")===!0;if(F(t)&&(e>1||r))return this._scmViewService.visibleRepositories;if(F(t)&&e===1&&!r||p(t)){const i=[];t=p(t)?t:this._scmViewService.visibleRepositories[0];const s=await this._getHistoryItems(t);i.push(...s);const n=de(s);return n&&n.historyItemViewModel.outputSwimlanes.length>0&&i.push({repository:t,graphColumns:n.historyItemViewModel.outputSwimlanes,type:"historyItemLoadMore"}),i}return[]}hasChildren(t){if(F(t))return this._scmViewService.visibleRepositories.length!==0;if(p(t))return!0;if(S(t))return!1;if(T(t))return!1;throw new Error("hasChildren not implemented.")}clearState(t){if(!t){this._state.clear();return}this._state.delete(t)}loadMore(t){const e=this._state.get(t);e&&this._state.set(t,{...e,loadMore:!0})}async _getHistoryItems(t){let e=this._state.get(t);const r=t.provider.historyProvider.get(),i=e?.currentHistoryItemGroup??r?.currentHistoryItemGroup.get();if(!r||!i)return[];if(!e||e.loadMore){const n=[i.revision??i.id,...i.remote?[i.remote.revision??i.remote.id]:[],...i.base?[i.base.revision??i.base.id]:[]],l=e?.items??[],d=await r.provideHistoryItems2({historyItemGroupIds:n,limit:50,skip:l.length})??[];e={currentHistoryItemGroup:i,items:[...l,...d],loadMore:!1},this._state.set(t,e)}const s=new Map([[i.name,ee]]);return i.remote&&s.set(i.remote.name,te),i.base&&s.set(i.base.name,Z),Be(e.items,s).map(n=>({repository:t,historyItemViewModel:n,type:"historyItem2"}))}dispose(){this._state.clear(),super.dispose()}};L=v([a(0,P),a(1,z)],L);let x=class extends xe{constructor(t,e,r,i,s,n,l,d,c,b,y,V,G,se){super({...t,titleMenuId:E.SCMHistoryTitle},l,n,s,b,c,d,y,V,G,se);this._commandService=e;this._scmViewService=r;this._progressService=i;this._scmHistoryItemGroupHasRemoteContextKey=this.scopedContextKeyService.createKey("scmHistoryItemGroupHasRemote",void 0),this._actionRunner=this.instantiationService.createInstance(R),this._register(this._actionRunner),this._register(this._updateChildrenThrottler)}_treeContainer;_tree;_treeDataSource;_treeIdentityProvider;_repositoryDescription=new Map;_repositoryLoadMore=new Map;_actionRunner;_repositories=new fe;_visibilityDisposables=new C;_treeOperationSequencer=new me;_updateChildrenThrottler=new pe;_scmHistoryItemGroupHasRemoteContextKey;_providerCountBadgeConfig=Pe("scm.providerCountBadge","hidden",this.configurationService);layoutBody(t,e){super.layoutBody(t,e),this._tree.layout(t,e)}renderBody(t){super.renderBody(t),this._treeContainer=I(t,u(".scm-view.scm-history-view")),this._treeContainer.classList.add("file-icon-themable-tree"),this._register(_(e=>{const r=this._providerCountBadgeConfig.read(e);this._treeContainer.classList.toggle("hide-provider-counts",r==="hidden"),this._treeContainer.classList.toggle("auto-provider-counts",r==="auto")})),this._createTree(this._treeContainer),this.onDidChangeBodyVisibility(e=>{e?this._treeOperationSequencer.queue(async()=>{await this._tree.setInput(this._scmViewService),ue.filter(this.configurationService.onDidChangeConfiguration,r=>r.affectsConfiguration("scm.alwaysShowRepositories"),this._visibilityDisposables)(()=>{this.updateActions(),this._updateChildren()},this,this._visibilityDisposables),this._scmViewService.onDidChangeVisibleRepositories(this._onDidChangeVisibleRepositories,this,this._visibilityDisposables),this._onDidChangeVisibleRepositories({added:this._scmViewService.visibleRepositories,removed:Se.empty()}),this._tree.scrollTop=0}):(this._treeDataSource.clearState(),this._visibilityDisposables.clear(),this._repositories.clearAndDisposeAll())})}getActionRunner(){return this._actionRunner}async refresh(t){this._treeDataSource.clearState(t),await this._updateChildren(t),this._setRepositoryDescription(t,""),this._tree.scrollTop=0}_createTree(t){this._treeIdentityProvider=new Ze;const e=this.instantiationService.createInstance(H,this.viewDescriptorService.getViewLocationById(this.id));this._register(e),this._treeDataSource=this.instantiationService.createInstance(L),this._register(this._treeDataSource),this._tree=this.instantiationService.createInstance(Ee,"SCM History Tree",t,new Je,[this.instantiationService.createInstance(g,r=>this._getRepositoryDescription(r),this._actionRunner,We(this.instantiationService)),this.instantiationService.createInstance(M,e),this.instantiationService.createInstance(f,r=>this._getLoadMore(r),r=>this._loadMoreCallback(r))],this._treeDataSource,{accessibilityProvider:new Xe,identityProvider:this._treeIdentityProvider,collapseByDefault:r=>!p(r),keyboardNavigationLabelProvider:new et,horizontalScrolling:!1,multipleSelectionSupport:!1}),this._register(this._tree),this._tree.onDidOpen(this._onDidOpen,this,this._store),this._tree.onContextMenu(this._onContextMenu,this,this._store)}async _onDidOpen(t){if(t.element){if(p(t.element))this._scmViewService.focus(t.element);else if(S(t.element)){const e=t.element.historyItemViewModel.historyItem,r=e.parentIds.length>0?e.parentIds[0]:void 0,s=await t.element.repository.provider.historyProvider.get()?.provideHistoryItemChanges(e.id,r);if(s){const n=`${e.id.substring(0,8)} - ${e.message}`,l=t.element.repository.provider.rootUri,d=l?l.path:t.element.repository.provider.label,c=we.from({scheme:"scm-history-item",path:`${d}/${r}..${e.id}`},!0);await this._commandService.executeCommand("_workbench.openMultiDiffEditor",{title:n,multiDiffSourceUri:c,resources:s})}this._scmViewService.focus(t.element.repository)}else if(T(t.element)){const e=this._scmViewService.visibleRepositories.length,r=this.configurationService.getValue("scm.alwaysShowRepositories")===!0;(e>1||r)&&this._loadMoreCallback(t.element.repository)}}else return}_onContextMenu(t){const e=t.element;if(!e)return;let r=[],i=e,s=new Qe(()=>this._getSelectedHistoryItems());if(p(e)){const l=this._scmViewService.menus.getRepositoryMenus(e.provider).repositoryContextMenu;r=re(l),s=new Ke(()=>this._getSelectedRepositories()),i=e.provider}else if(S(e)){const l=this._scmViewService.menus.getRepositoryMenus(e.repository.provider).historyProviderMenu?.getHistoryItemMenu2(e);r=l?re(l):[]}s.onWillRun(()=>this._tree.domFocus()),this.contextMenuService.showContextMenu({getAnchor:()=>t.anchor,getActions:()=>r,getActionsContext:()=>i,actionRunner:s})}_onDidChangeVisibleRepositories({added:t,removed:e}){for(const r of t){const i=new C;i.add(_(s=>{const n=r.provider.historyProvider.read(s),l=n?.currentHistoryItemGroupId.read(s),d=n?.currentHistoryItemGroupRevision.read(s),c=n?.currentHistoryItemGroupRemoteId.read(s);this._scmViewService.visibleRepositories.length===1?this._scmHistoryItemGroupHasRemoteContextKey.set(!!c):this._scmHistoryItemGroupHasRemoteContextKey.reset(),!(!l&&!d&&!c)&&this.refresh(r)})),i.add(_(s=>{if(!r.provider.historyProvider.read(s)?.currentHistoryItemGroupRemoteRevision.read(s))return;if(this._tree.scrollTop===0){this.refresh(r);return}const d=h("outdated","OUTDATED");this._setRepositoryDescription(this._isRepositoryNodeVisible()?r:void 0,d)})),this._repositories.set(r,i)}for(const r of e)this._treeDataSource.clearState(r),this._repositoryDescription.delete(r),this._repositoryLoadMore.delete(r),this._repositories.deleteAndDispose(r);this._updateChildren()}_getSelectedRepositories(){const t=this._tree.getFocus().filter(r=>!!r&&p(r)),e=this._tree.getSelection().filter(r=>!!r&&p(r));return Array.from(new Set([...t,...e]))}_getSelectedHistoryItems(){return this._tree.getSelection().filter(t=>!!t&&S(t))}_getLoadMore(t){let e=this._repositoryLoadMore.get(t);return e||(e=N(this,!1),this._repositoryLoadMore.set(t,e)),e}_loadMoreCallback(t){const e=this._getLoadMore(t);e.get()||(e.set(!0,void 0),this._treeDataSource.loadMore(t),this._updateChildren(t).finally(()=>e.set(!1,void 0)))}_getRepositoryDescription(t){let e=this._repositoryDescription.get(t);return e||(e=N(this,""),this._repositoryDescription.set(t,e)),e}_setRepositoryDescription(t,e){t?this._getRepositoryDescription(t).set(e,void 0):this.updateTitleDescription(e)}_isRepositoryNodeVisible(){const t=this._scmViewService.visibleRepositories.length;return this.configurationService.getValue("scm.alwaysShowRepositories")===!0||t>1}_updateChildren(t){return this._updateChildrenThrottler.queue(()=>this._treeOperationSequencer.queue(async()=>{await this._progressService.withProgress({location:this.id},async()=>{t&&this._tree.hasNode(t)?await this._tree.updateChildren(t,void 0,void 0,{}):await this._tree.updateChildren(void 0,void 0,void 0,{})})}))}dispose(){this._visibilityDisposables.dispose(),this._repositories.dispose(),super.dispose()}};x=v([a(1,O),a(2,z),a(3,j),a(4,P),a(5,q),a(6,U),a(7,Ve),a(8,Ge),a(9,W),a(10,De),a(11,Q),a(12,Y),a(13,A)],x);export{x as SCMHistoryViewPane};
