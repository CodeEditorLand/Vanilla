var ge=Object.defineProperty;var Se=Object.getOwnPropertyDescriptor;var v=(d,o,e,t)=>{for(var r=t>1?void 0:t?Se(o,e):o,i=d.length-1,s;i>=0;i--)(s=d[i])&&(r=(t?s(o,e,r):s(r))||r);return t&&r&&ge(o,e,r),r},l=(d,o)=>(e,t)=>o(e,t,d);import"./media/scm.css";import*as Me from"../../../../base/common/platform.js";import{$ as y,append as f,h as H,reset as J}from"../../../../base/browser/dom.js";import"../../../../base/browser/ui/hover/hover.js";import"../../../../base/browser/ui/hover/hoverDelegate.js";import{IconLabel as X}from"../../../../base/browser/ui/iconLabel/iconLabel.js";import"../../../../base/browser/ui/list/list.js";import"../../../../base/browser/ui/tree/abstractTree.js";import"../../../../base/browser/ui/tree/tree.js";import{fromNow as _e}from"../../../../base/common/date.js";import{createMatches as Z}from"../../../../base/common/filters.js";import{MarkdownString as Ce}from"../../../../base/common/htmlContent.js";import{Disposable as $,DisposableStore as P}from"../../../../base/common/lifecycle.js";import{autorun as Q,autorunWithStore as we,derived as G,observableValue as R,waitForState as be,constObservable as Te,latestChangedValue as He,observableFromEvent as ee,runOnChange as U}from"../../../../base/common/observable.js";import{ThemeIcon as g}from"../../../../base/common/themables.js";import{localize as c}from"../../../../nls.js";import{IConfigurationService as k}from"../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as N,IContextKeyService as Pe}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as Re}from"../../../../platform/contextview/browser/contextView.js";import{IHoverService as j,WorkbenchHoverDelegate as ke}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as te}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as Ve}from"../../../../platform/keybinding/common/keybinding.js";import{WorkbenchAsyncDataTree as Le}from"../../../../platform/list/browser/listService.js";import{IOpenerService as Ee}from"../../../../platform/opener/common/opener.js";import{ITelemetryService as Ae}from"../../../../platform/telemetry/common/telemetry.js";import{asCssVariable as S,foreground as Fe}from"../../../../platform/theme/common/colorRegistry.js";import{IThemeService as re}from"../../../../platform/theme/common/themeService.js";import{ViewAction as B,ViewPane as xe,ViewPaneShowActions as De}from"../../../browser/parts/views/viewPane.js";import{IViewDescriptorService as Oe,ViewContainerLocation as ie}from"../../../common/views.js";import{renderSCMHistoryItemGraph as $e,toISCMHistoryItemViewModelArray as Qe,SWIMLANE_WIDTH as Ne,renderSCMHistoryGraphPlaceholder as Be,historyItemHoverDeletionsForeground as ze,historyItemHoverLabelForeground as oe,historyItemHoverAdditionsForeground as qe,historyItemHoverDefaultLabelForeground as Ke,historyItemHoverDefaultLabelBackground as se}from"./scmHistory.js";import{isSCMHistoryItemLoadMoreTreeElement as z,isSCMHistoryItemViewModelTreeElement as b,isSCMRepository as Y}from"./util.js";import"../common/history.js";import{HISTORY_VIEW_PANE_ID as V,ISCMService as We,ISCMViewService as ne}from"../common/scm.js";import"../../../../base/browser/ui/list/listWidget.js";import{stripIcons as Ge}from"../../../../base/common/iconLabels.js";import{IWorkbenchLayoutService as Ue,Position as ae}from"../../../services/layout/browser/layoutService.js";import{HoverPosition as L}from"../../../../base/browser/ui/hover/hoverWidget.js";import{Action2 as je,MenuId as C,registerAction2 as E}from"../../../../platform/actions/common/actions.js";import{Sequencer as le,Throttler as Ye}from"../../../../base/common/async.js";import{URI as ce}from"../../../../base/common/uri.js";import{ICommandService as de}from"../../../../platform/commands/common/commands.js";import{ActionRunner as Je}from"../../../../base/common/actions.js";import{delta as Xe,groupBy as Ze,tail as et}from"../../../../base/common/arrays.js";import{Codicon as T}from"../../../../base/common/codicons.js";import{IProgressService as me}from"../../../../platform/progress/common/progress.js";import{ContextKeys as tt}from"./scmViewPane.js";import"../../../../base/browser/ui/actionbar/actionbar.js";import"../../../../base/browser/ui/dropdown/dropdownActionViewItem.js";import{ActionViewItem as pe}from"../../../../base/browser/ui/actionbar/actionViewItems.js";import{IQuickInputService as he}from"../../../../platform/quickinput/common/quickInput.js";import{Event as rt}from"../../../../base/common/event.js";import{Iterable as ye}from"../../../../base/common/iterator.js";import{clamp as it}from"../../../../base/common/numbers.js";import{observableConfigValue as ot}from"../../../../platform/observable/common/platformObservableUtils.js";import{compare as ue}from"../../../../base/common/strings.js";import{IClipboardService as st}from"../../../../platform/clipboard/common/clipboardService.js";import{getDefaultHoverDelegate as nt}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import{IStorageService as at,StorageScope as Ie,StorageTarget as lt}from"../../../../platform/storage/common/storage.js";import{INotificationService as ct}from"../../../../platform/notification/common/notification.js";const ve="workbench.scm.action.graph.pickRepository",fe="workbench.scm.action.graph.pickHistoryItemRefs";class dt extends pe{constructor(e,t,r){super(null,t,{...r,icon:!1,label:!0});this._repository=e}updateLabel(){if(this.options.label&&this.label){this.label.classList.add("scm-graph-repository-picker");const e=y(".icon");e.classList.add(...g.asClassNameArray(T.repo));const t=y(".name");t.textContent=this._repository.provider.name,J(this.label,e,t)}}getTooltip(){return this._repository.provider.name}}class mt extends pe{constructor(e,t,r,i){super(null,r,{...i,icon:!1,label:!0});this._repository=e;this._historyItemsFilter=t}updateLabel(){if(this.options.label&&this.label){this.label.classList.add("scm-graph-history-item-picker");const e=y(".icon");e.classList.add(...g.asClassNameArray(T.gitBranch));const t=y(".name");this._historyItemsFilter==="all"?t.textContent=c("all","All"):this._historyItemsFilter==="auto"?t.textContent=c("auto","Auto"):this._historyItemsFilter.length===1?t.textContent=this._historyItemsFilter[0].name:t.textContent=c("items","{0} Items",this._historyItemsFilter.length),J(this.label,e,t)}}getTooltip(){if(this._historyItemsFilter==="all")return c("allHistoryItemRefs","All history item references");if(this._historyItemsFilter==="auto"){const e=this._repository.provider.historyProvider.get();return[e?.historyItemRef.get()?.name,e?.historyItemRemoteRef.get()?.name,e?.historyItemBaseRef.get()?.name].filter(t=>!!t).join(", ")}else return this._historyItemsFilter.length===1?this._historyItemsFilter[0].name:this._historyItemsFilter.map(e=>e.name).join(", ")}}E(class extends B{constructor(){super({id:ve,title:c("repositoryPicker","Repository Picker"),viewId:V,f1:!1,menu:{id:C.SCMHistoryTitle,when:N.and(N.has("scm.providerCount"),N.greater("scm.providerCount",1)),group:"navigation",order:0}})}async runInView(d,o){o.pickRepository()}}),E(class extends B{constructor(){super({id:fe,title:c("referencePicker","History Item Reference Picker"),icon:T.gitBranch,viewId:V,f1:!1,menu:{id:C.SCMHistoryTitle,group:"navigation",order:1}})}async runInView(d,o){o.pickHistoryItemRef()}}),E(class extends B{constructor(){super({id:"workbench.scm.action.graph.revealCurrentHistoryItem",title:c("goToCurrentHistoryItem","Go to Current History Item"),viewId:V,f1:!1,icon:T.target,menu:{id:C.SCMHistoryTitle,group:"navigation",order:2}})}async runInView(d,o){o.revealCurrentHistoryItem()}}),E(class extends B{constructor(){super({id:"workbench.scm.action.graph.refresh",title:c("refreshGraph","Refresh"),viewId:V,f1:!1,icon:T.refresh,menu:{id:C.SCMHistoryTitle,group:"navigation",order:1e3}})}async runInView(d,o){o.refresh()}}),E(class extends je{constructor(){super({id:"workbench.scm.action.graph.viewChanges",title:c("viewChanges","View Changes"),f1:!1,menu:[{id:C.SCMChangesContext,group:"0_view",when:N.equals("config.multiDiffEditor.experimental.enabled",!0)}]})}async run(d,o,...e){const t=d.get(de);if(!o||e.length===0)return;const r=e[0],i=e[e.length-1],s=o.historyProvider.get();if(e.length>1){const I=await s?.resolveHistoryItemRefsCommonAncestor([r.id,i.id]);if(!I||I!==r.id&&I!==i.id)return}const n=i.parentIds.length>0?i.parentIds[0]:void 0,a=await s?.provideHistoryItemChanges(r.id,n);if(!a?.length)return;const p=e.length===1?`${e[0].displayId??e[0].id} - ${e[0].message}`:c("historyItemChangesEditorTitle","All Changes ({0} \u2194 {1})",i.displayId??i.id,r.displayId??r.id),h=o.rootUri,m=h?h.path:o.label,u=ce.from({scheme:"scm-history-item",path:`${m}/${n}..${r.id}`},!0);t.executeCommand("_workbench.openMultiDiffEditor",{title:p,multiDiffSourceUri:u,resources:a})}});class pt{getHeight(){return 22}getTemplateId(o){if(b(o))return M.TEMPLATE_ID;if(z(o))return _.TEMPLATE_ID;throw new Error("Unknown element")}}let M=class{constructor(o,e,t,r,i){this.hoverDelegate=o;this._clipboardService=e;this._configurationService=t;this._hoverService=r;this._themeService=i}static TEMPLATE_ID="history-item";get templateId(){return M.TEMPLATE_ID}_badgesConfig=ot("scm.graph.badges","filter",this._configurationService);renderTemplate(o){o.parentElement.parentElement.querySelector(".monaco-tl-twistie").classList.add("force-no-twistie");const e=f(o,y(".history-item")),t=f(e,y(".graph-container")),r=new X(e,{supportIcons:!0,supportHighlights:!0,supportDescriptionHighlights:!0}),i=f(e,y(".label-container"));return e.appendChild(i),{element:e,graphContainer:t,label:r,labelContainer:i,elementDisposables:new P,disposables:new P}}renderElement(o,e,t,r){const i=o.element.historyItemViewModel,s=i.historyItem,n=this._hoverService.setupManagedHover(this.hoverDelegate,t.element,this._getHoverContent(o.element),{actions:this._getHoverActions(s)});t.elementDisposables.add(n),t.graphContainer.textContent="",t.graphContainer.classList.toggle("current",i.isCurrent),t.graphContainer.appendChild($e(i));const h=o.element.repository.provider.historyProvider.get()?.historyItemRef?.get()?.revision===s.id?["history-item-current"]:[],[m,u]=this._processMatches(i,o.filterData);t.label.setLabel(s.subject,s.author,{matches:m,descriptionMatches:u,extraClasses:h}),this._renderBadges(s,t)}_renderBadges(o,e){e.elementDisposables.add(Q(t=>{const r=this._badgesConfig.read(t);e.labelContainer.textContent="";const i=o.references?.find(s=>s.color);for(const s of o.references??[])if(!(!s.color&&r==="filter")&&s.icon&&g.isThemeIcon(s.icon)){const n=H("div.label",{style:{color:s.color?S(oe):S(Fe),backgroundColor:s.color?S(s.color):S(se)}},[H("div.icon@icon"),H("div.description@description")]);n.icon.classList.add(...g.asClassNameArray(s.icon)),n.description.textContent=s.name,n.description.style.display=s===i?"":"none",f(e.labelContainer,n.root)}}))}_getHoverActions(o){return[{commandId:"workbench.scm.action.graph.copyHistoryItemId",iconClass:"codicon.codicon-copy",label:o.displayId??o.id,run:()=>this._clipboardService.writeText(o.id)},{commandId:"workbench.scm.action.graph.copyHistoryItemMessage",iconClass:"codicon.codicon-copy",label:c("historyItemMessage","Message"),run:()=>this._clipboardService.writeText(o.message)}]}_getHoverContent(o){const e=this._themeService.getColorTheme(),t=o.historyItemViewModel.historyItem,r=new Ce("",{isTrusted:!0,supportThemeIcons:!0});if(t.author){if(r.appendMarkdown(`$(account) **${t.author}**`),t.timestamp){const i=new Intl.DateTimeFormat(Me.language,{year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"});r.appendMarkdown(`, $(history) ${_e(t.timestamp,!0,!0)} (${i.format(t.timestamp)})`)}r.appendMarkdown(`

`)}if(r.appendMarkdown(`${t.message}

`),t.statistics){if(r.appendMarkdown(`---

`),r.appendMarkdown(`<span>${t.statistics.files===1?c("fileChanged","{0} file changed",t.statistics.files):c("filesChanged","{0} files changed",t.statistics.files)}</span>`),t.statistics.insertions){const i=e.getColor(qe);r.appendMarkdown(`,&nbsp;<span style="color:${i};">${t.statistics.insertions===1?c("insertion","{0} insertion{1}",t.statistics.insertions,"(+)"):c("insertions","{0} insertions{1}",t.statistics.insertions,"(+)")}</span>`)}if(t.statistics.deletions){const i=e.getColor(ze);r.appendMarkdown(`,&nbsp;<span style="color:${i};">${t.statistics.deletions===1?c("deletion","{0} deletion{1}",t.statistics.deletions,"(-)"):c("deletions","{0} deletions{1}",t.statistics.deletions,"(-)")}</span>`)}}return(t.references??[]).length>0&&(r.appendMarkdown(`

---

`),r.appendMarkdown((t.references??[]).map(i=>{const s=g.isThemeIcon(i.icon)?i.icon.id:"",n=i.color?S(i.color):S(se);return`<span style="color:${i.color?S(oe):S(Ke)};background-color:${n};border-radius:2px;">&nbsp;$(${s})&nbsp;${i.name}&nbsp;</span>`}).join("&nbsp;&nbsp;"))),{markdown:r,markdownNotSupportedFallback:t.message}}_processMatches(o,e){return e?[o.historyItem.message===e.label?Z(e.score):void 0,o.historyItem.author===e.label?Z(e.score):void 0]:[void 0,void 0]}disposeElement(o,e,t,r){t.elementDisposables.clear()}disposeTemplate(o){o.disposables.dispose()}};M=v([l(1,st),l(2,k),l(3,j),l(4,re)],M);let _=class{constructor(o,e,t){this._loadingMore=o;this._loadMoreCallback=e;this._configurationService=t}static TEMPLATE_ID="historyItemLoadMore";get templateId(){return _.TEMPLATE_ID}renderTemplate(o){o.parentElement.parentElement.querySelector(".monaco-tl-twistie").classList.add("force-no-twistie");const e=f(o,y(".history-item-load-more")),t=f(e,y(".graph-placeholder")),r=f(e,y(".history-item-placeholder")),i=new X(r,{supportIcons:!0});return{element:e,graphPlaceholder:t,historyItemPlaceholderContainer:r,historyItemPlaceholderLabel:i,elementDisposables:new P,disposables:new P}}renderElement(o,e,t,r){t.graphPlaceholder.textContent="",t.graphPlaceholder.style.width=`${Ne*(o.element.graphColumns.length+1)}px`,t.graphPlaceholder.appendChild(Be(o.element.graphColumns));const i=this._configurationService.getValue("scm.graph.pageOnScroll")===!0;t.historyItemPlaceholderContainer.classList.toggle("shimmer",i),i?(t.historyItemPlaceholderLabel.setLabel(""),this._loadMoreCallback(o.element.repository)):t.elementDisposables.add(Q(s=>{const a=`$(${this._loadingMore().read(s)?"loading~spin":"fold-down"})`;t.historyItemPlaceholderLabel.setLabel(c("loadMore","{0} Load More...",a))}))}disposeElement(o,e,t,r){t.elementDisposables.clear()}disposeTemplate(o){o.disposables.dispose()}};_=v([l(2,k)],_);let A=class extends ke{constructor(e,t,r,i){super("element",!0,()=>this.getHoverOptions(),r,i);this._viewContainerLocation=e;this.layoutService=t}getHoverOptions(){const e=this.layoutService.getSideBarPosition();let t;return this._viewContainerLocation===ie.Sidebar?t=e===ae.LEFT?L.RIGHT:L.LEFT:this._viewContainerLocation===ie.AuxiliaryBar?t=e===ae.LEFT?L.LEFT:L.RIGHT:t=L.RIGHT,{additionalClasses:["history-item-hover"],position:{hoverPosition:t,forcePosition:!0}}}};A=v([l(1,Ue),l(2,k),l(3,j)],A);let F=class extends Je{constructor(e){super();this._progressService=e}runAction(e,t){return this._progressService.withProgress({location:V},async()=>await super.runAction(e,t))}};F=v([l(0,me)],F);class ht{getWidgetAriaLabel(){return c("scm history","Source Control History")}getAriaLabel(o){if(Y(o))return`${o.provider.name} ${o.provider.label}`;if(b(o)){const e=o.historyItemViewModel.historyItem;return`${Ge(e.message).trim()}${e.author?`, ${e.author}`:""}`}else return""}}class yt{getId(o){if(Y(o))return`repo:${o.provider.id}`;if(b(o)){const e=o.repository.provider,t=o.historyItemViewModel.historyItem;return`historyItem:${e.id}/${t.id}/${t.parentIds.join(",")}`}else{if(z(o))return`historyItemLoadMore:${o.repository.provider.id}}`;throw new Error("Invalid tree element")}}}class ut{getKeyboardNavigationLabel(o){if(!Y(o)){if(b(o))return[o.historyItemViewModel.historyItem.message,o.historyItemViewModel.historyItem.author];if(z(o))return"";throw new Error("Invalid tree element")}}}class It extends ${async getChildren(o){if(!(o instanceof w))return[];const e=[],t=await o.getHistoryItems();e.push(...t);const r=o.repository.get(),i=et(t);return r&&i&&i.historyItemViewModel.outputSwimlanes.length>0&&e.push({repository:r,graphColumns:i.historyItemViewModel.outputSwimlanes,type:"historyItemLoadMore"}),e}hasChildren(o){return o instanceof w}}let w=class extends ${constructor(e,t,r,i){super();this._configurationService=e;this._scmService=t;this._scmViewService=r;this._storageService=i;try{const s=this._storageService.get("scm.graphView.referencesFiler",Ie.WORKSPACE)??"auto",n=s==="auto"||s==="all"?s:JSON.parse(s);this.historyItemsFilter=R(this,n)}catch{this.historyItemsFilter=R(this,"auto")}this._register(Q(s=>{const n=this._closedRepository.read(s);n&&(this.repository.get()===n&&this._selectedRepository.set(ye.first(this._scmService.repositories)??"auto",void 0),this._state.delete(n))}))}_closedRepository=ee(this,this._scmService.onDidRemoveRepository,e=>e);_firstRepository=this._scmService.repositoryCount>0?Te(ye.first(this._scmService.repositories)):ee(this,rt.once(this._scmService.onDidAddRepository),e=>e);_selectedRepository=R(this,"auto");_graphRepository=G(e=>{const t=this._selectedRepository.read(e);return t!=="auto"?t:this._scmViewService.activeRepository.read(e)});repository=He(this,[this._firstRepository,this._graphRepository]);historyItemsFilter;_state=new Map;clearRepositoryState(){const e=this.repository.get();e&&this._state.delete(e)}getRepositoryState(){const e=this.repository.get();if(e)return this._state.get(e)}setLoadMore(e,t){const r=this._state.get(e);r&&this._state.set(e,{...r,loadMore:t})}async getHistoryItems(){const e=this.repository.get(),t=e?.provider.historyProvider.get();if(!e||!t)return[];let r=this._state.get(e);if(!r||r.loadMore!==!1){let i=r?.historyItemRefs;const s=r?.viewModels.map(m=>m.historyItemViewModel.historyItem)??[];if(!i){const m=this.historyItemsFilter.get();switch(m){case"all":i=await t.provideHistoryItemRefs()??[];break;case"auto":i=[t.historyItemRef.get(),t.historyItemRemoteRef.get(),t.historyItemBaseRef.get()].filter(u=>!!u);break;default:i=m;break}}const n=it(this._configurationService.getValue("scm.graph.pageSize"),1,1e3),a=i.map(m=>m.revision??m.id);do s.push(...await t.provideHistoryItems({historyItemRefs:a,limit:n,skip:s.length})??[]);while(typeof r?.loadMore=="string"&&!s.find(m=>m.id===r?.loadMore));const p=this._getGraphColorMap(i),h=Qe(s,p,t.historyItemRef.get()).map(m=>({repository:e,historyItemViewModel:m,type:"historyItemViewModel"}));r={historyItemRefs:i,viewModels:h,loadMore:!1},this._state.set(e,r)}return r.viewModels}setRepository(e){this._selectedRepository.set(e,void 0)}setHistoryItemsFilter(e){this._storageService.store("scm.graphView.referencesFiler",e,Ie.WORKSPACE,lt.USER),this.historyItemsFilter.set(e,void 0)}_getGraphColorMap(e){const r=this.repository.get()?.provider.historyProvider.get(),i=r?.historyItemRef.get(),s=r?.historyItemRemoteRef.get(),n=r?.historyItemBaseRef.get(),a=new Map;i&&(a.set(i.id,i.color),s&&a.set(s.id,s.color),n&&a.set(n.id,n.color));for(const p of e)a.has(p.id)||a.set(p.id,void 0);return a}dispose(){this._state.clear(),super.dispose()}};w=v([l(0,k),l(1,We),l(2,ne),l(3,at)],w);let x=class extends ${constructor(e,t){super();this._quickInputService=e;this._scmViewService=t}_autoQuickPickItem={label:c("auto","Auto"),description:c("activeRepository","Show the source control graph for the active repository"),repository:"auto"};async pickRepository(){const e=[this._autoQuickPickItem,{type:"separator"}];return e.push(...this._scmViewService.repositories.map(t=>({label:t.provider.name,description:t.provider.rootUri?.fsPath,iconClass:g.asClassName(T.repo),repository:t}))),this._quickInputService.pick(e,{placeHolder:c("scmGraphRepository","Select the repository to view, type to filter all repositories")})}};x=v([l(0,he),l(1,ne)],x);let D=class extends ${constructor(e,t,r){super();this._historyProvider=e;this._historyItemsFilter=t;this._quickInputService=r}_allQuickPickItem={id:"all",label:c("all","All"),description:c("allHistoryItemRefs","All history item references"),historyItemRef:"all"};_autoQuickPickItem={id:"auto",label:c("auto","Auto"),description:c("currentHistoryItemRef","Current history item reference(s)"),historyItemRef:"auto"};async pickHistoryItemRef(){const e=this._quickInputService.createQuickPick({useSeparators:!0});this._store.add(e),e.placeholder=c("scmGraphHistoryItemRef","Select one/more history item references to view, type to filter"),e.canSelectMany=!0,e.hideCheckAll=!0,e.busy=!0,e.show();const t=await this._createQuickPickItems();let r=[];if(this._historyItemsFilter==="all")r.push(this._allQuickPickItem);else if(this._historyItemsFilter==="auto")r.push(this._autoQuickPickItem);else{let i=0;for(;i<t.length;){if(t[i].type==="separator"){i++;continue}if(this._historyItemsFilter.some(s=>s.id===t[i].id)){const s=t.splice(i,1);r.push(...s)}else i++}t.splice(2,0,{type:"separator"},...r)}return e.items=t,e.selectedItems=r,e.busy=!1,new Promise(i=>{this._store.add(e.onDidChangeSelection(s=>{const{added:n}=Xe(r,s,(a,p)=>ue(a.id??"",p.id??""));n.length>0&&(n[0].historyItemRef==="all"||n[0].historyItemRef==="auto"?e.selectedItems=[n[0]]:e.selectedItems=[...e.selectedItems.filter(a=>a.historyItemRef!=="all"&&a.historyItemRef!=="auto")]),r=[...e.selectedItems]})),this._store.add(e.onDidAccept(()=>{r.length===0?i(void 0):r.length===1&&r[0].historyItemRef==="all"?i("all"):r.length===1&&r[0].historyItemRef==="auto"?i("auto"):i(r.map(s=>s.historyItemRef)),e.hide()})),this._store.add(e.onDidHide(()=>{i(void 0),this.dispose()}))})}async _createQuickPickItems(){const e=[this._allQuickPickItem,this._autoQuickPickItem],t=await this._historyProvider.provideHistoryItemRefs()??[],r=Ze(t,(i,s)=>ue(i.category??"",s.category??""));for(const i of r)i.length!==0&&(e.push({type:"separator",label:i[0].category}),e.push(...i.map(s=>({id:s.id,label:s.name,description:s.description,iconClass:g.isThemeIcon(s.icon)?g.asClassName(s.icon):void 0,historyItemRef:s}))));return e}};D=v([l(2,he)],D);let q=class extends xe{constructor(e,t,r,i,s,n,a,p,h,m,u,I,K,O,W){super({...e,titleMenuId:C.SCMHistoryTitle,showActions:De.WhenExpanded},p,a,n,u,m,h,I,K,O,W);this._commandService=t;this._instantiationService=r;this._notificationService=i;this._progressService=s;this._scmProviderCtx=tt.SCMProvider.bindTo(this.scopedContextKeyService),this._actionRunner=this.instantiationService.createInstance(F),this._register(this._actionRunner),this._register(this._updateChildrenThrottler)}_treeContainer;_tree;_treeViewModel;_treeDataSource;_treeIdentityProvider;_repositoryLoadMore=R(this,!1);_repositoryOutdated=R(this,!1);_actionRunner;_visibilityDisposables=new P;_treeOperationSequencer=new le;_treeLoadMoreSequencer=new le;_updateChildrenThrottler=new Ye;_scmProviderCtx;renderHeaderTitle(e){super.renderHeaderTitle(e,this.title);const t=H("div.scm-graph-view-badge-container",[H("div.scm-graph-view-badge.monaco-count-badge.long@badge")]);t.badge.textContent="Outdated",e.appendChild(t.root),this._register(this.hoverService.setupManagedHover(nt("mouse"),t.root,{markdown:{value:c("scmGraphViewOutdated","Please refresh the graph using the refresh action ($(refresh))."),supportThemeIcons:!0},markdownNotSupportedFallback:void 0})),this._register(Q(r=>{const i=this._repositoryOutdated.read(r);t.root.style.display=i?"":"none"}))}renderBody(e){super.renderBody(e),this._treeContainer=f(e,y(".scm-view.scm-history-view")),this._treeContainer.classList.add("file-icon-themable-tree"),this._createTree(this._treeContainer),this.onDidChangeBodyVisibility(async t=>{if(!t){this._visibilityDisposables.clear();return}this._treeViewModel=this.instantiationService.createInstance(w),this._visibilityDisposables.add(this._treeViewModel),await this._progressService.withProgress({location:this.id},async()=>{const i=G(this,s=>this._treeViewModel.repository.read(s)?.provider.historyProvider.read(s)?.historyItemRef.read(s)!==void 0?!0:void 0);await be(i),await this._treeOperationSequencer.queue(async()=>{await this._tree.setInput(this._treeViewModel),this._tree.scrollTop=0})});let r=!0;this._visibilityDisposables.add(we((i,s)=>{const n=this._treeViewModel.repository.read(i),a=n?.provider.historyProvider.read(i);if(!n||!a)return;this._scmProviderCtx.set(n.provider.contextValue);const p=G(h=>a.historyItemRef.read(h)?.id);s.add(U(p,()=>{this.refresh()})),s.add(U(a.historyItemRefChanges,h=>{if(h.silent){if(this._tree.scrollTop===0){this.refresh();return}this._repositoryOutdated.set(!0,void 0);return}if(h.removed.length!==0){const m=this._treeViewModel.historyItemsFilter.get();if(m!=="all"&&m!=="auto"){let u=!1;const I=[...m];for(const K of h.removed){const O=I.findIndex(W=>W.id===K.id);O!==-1&&(I.splice(O,1),u=!0)}if(u){this._treeViewModel.setHistoryItemsFilter(I);return}}}this.refresh()})),s.add(U(this._treeViewModel.historyItemsFilter,()=>{this.refresh()})),r||this.refresh(),r=!1}))})}layoutBody(e,t){super.layoutBody(e,t),this._tree.layout(e,t)}getActionRunner(){return this._actionRunner}getActionsContext(){return this._treeViewModel?.repository.get()?.provider}getActionViewItem(e,t){if(e.id===ve){const r=this._treeViewModel?.repository.get();if(r)return new dt(r,e,t)}else if(e.id===fe){const r=this._treeViewModel?.repository.get(),i=this._treeViewModel?.historyItemsFilter.get();if(r&&i)return new mt(r,i,e,t)}return super.getActionViewItem(e,t)}async refresh(){await this._updateChildren(!0),this.updateActions(),this._repositoryOutdated.set(!1,void 0),this._tree.scrollTop=0}async pickRepository(){const t=await this._instantiationService.createInstance(x).pickRepository();t&&this._treeViewModel.setRepository(t.repository)}async pickHistoryItemRef(){const t=this._treeViewModel.repository.get()?.provider.historyProvider.get();if(!t)return;const r=this._treeViewModel.historyItemsFilter.get(),s=await this._instantiationService.createInstance(D,t,r).pickHistoryItemRef();s&&this._treeViewModel.setHistoryItemsFilter(s)}async revealCurrentHistoryItem(){const e=this._treeViewModel.repository.get(),r=e?.provider.historyProvider.get()?.historyItemRef.get();if(!e||!r?.revision)return;const i=this._treeViewModel.historyItemsFilter.get();if(Array.isArray(i)&&!i.find(n=>n.id===r.id)){this._notificationService.info(c("scmGraphViewRevealCurrentHistoryItem","The current history item is not present in the source control graph. Please use the history item references picker to expand the set of history items in the graph."));return}const s=()=>{const n=this._treeViewModel.getRepositoryState();if(!n)return!1;const a=n.viewModels.find(p=>p.historyItemViewModel.historyItem.id===r.revision);return a&&this._tree.hasNode(a)?(this._tree.reveal(a,.5),this._tree.setSelection([a]),this._tree.setFocus([a]),!0):!1};s()||(this._treeViewModel.setLoadMore(e,r.revision),await this._updateChildren(),s())}_createTree(e){this._treeIdentityProvider=new yt;const t=this.instantiationService.createInstance(A,this.viewDescriptorService.getViewLocationById(this.id));this._register(t),this._treeDataSource=this.instantiationService.createInstance(It),this._register(this._treeDataSource),this._tree=this.instantiationService.createInstance(Le,"SCM History Tree",e,new pt,[this.instantiationService.createInstance(M,t),this.instantiationService.createInstance(_,()=>this._repositoryLoadMore,r=>this._loadMoreCallback(r))],this._treeDataSource,{accessibilityProvider:new ht,identityProvider:this._treeIdentityProvider,collapseByDefault:r=>!1,keyboardNavigationLabelProvider:new ut,horizontalScrolling:!1,multipleSelectionSupport:!1}),this._register(this._tree),this._tree.onDidOpen(this._onDidOpen,this,this._store),this._tree.onContextMenu(this._onContextMenu,this,this._store)}async _onDidOpen(e){if(e.element)if(b(e.element)){const t=e.element.historyItemViewModel.historyItem,r=t.parentIds.length>0?t.parentIds[0]:void 0,s=await e.element.repository.provider.historyProvider.get()?.provideHistoryItemChanges(t.id,r);if(s){const n=`${t.displayId??t.id} - ${t.message}`,a=e.element.repository.provider.rootUri,p=a?a.path:e.element.repository.provider.label,h=ce.from({scheme:"scm-history-item",path:`${p}/${r}..${t.id}`},!0);await this._commandService.executeCommand("_workbench.openMultiDiffEditor",{title:n,multiDiffSourceUri:h,resources:s})}}else z(e.element)&&(this.configurationService.getValue("scm.graph.pageOnScroll")===!0||(this._loadMoreCallback(e.element.repository),this._tree.setSelection([])));else return}_onContextMenu(e){const t=e.element;!t||!b(t)||this.contextMenuService.showContextMenu({menuId:C.SCMChangesContext,menuActionOptions:{arg:t.repository.provider,shouldForwardArgs:!0},getAnchor:()=>e.anchor,getActionsContext:()=>t.historyItemViewModel.historyItem})}async _loadMoreCallback(e){return this._treeLoadMoreSequencer.queue(async()=>{this._repositoryLoadMore.get()||(this._repositoryLoadMore.set(!0,void 0),this._treeViewModel.setLoadMore(e,!0),await this._updateChildren(),this._repositoryLoadMore.set(!1,void 0))})}_updateChildren(e=!1){return this._updateChildrenThrottler.queue(()=>this._treeOperationSequencer.queue(async()=>{e&&this._treeViewModel.clearRepositoryState(),await this._progressService.withProgress({location:this.id},async()=>{await this._tree.updateChildren(void 0,void 0,void 0,{})})}))}dispose(){this._visibilityDisposables.dispose(),super.dispose()}};q=v([l(1,de),l(2,te),l(3,ct),l(4,me),l(5,k),l(6,Re),l(7,Ve),l(8,te),l(9,Oe),l(10,Pe),l(11,Ee),l(12,re),l(13,Ae),l(14,j)],q);export{q as SCMHistoryViewPane};
