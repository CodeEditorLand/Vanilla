import{localize as h}from"../../../../nls.js";import{deepClone as F}from"../../../../base/common/objects.js";import{badgeBackground as k,buttonForeground as B,chartsBlue as V,chartsPurple as N,foreground as P}from"../../../../platform/theme/common/colorRegistry.js";import{asCssVariable as R,registerColor as m}from"../../../../platform/theme/common/colorUtils.js";import"../common/history.js";import{rot as _}from"../../../../base/common/numbers.js";import{svgElem as W}from"../../../../base/browser/dom.js";import{compareHistoryItemRefs as T}from"./util.js";const f=22,n=11,H=5,G=4,$=2,E=m("scmGraph.historyItemRefColor",V,h("scmGraphHistoryItemRefColor","History item reference color.")),oe=m("scmGraph.historyItemRemoteRefColor",N,h("scmGraphHistoryItemRemoteRefColor","History item remote reference color.")),ne=m("scmGraph.historyItemBaseRefColor","#EA5C00",h("scmGraphHistoryItemBaseRefColor","History item base reference color.")),se=m("scmGraph.historyItemHoverDefaultLabelForeground",P,h("scmGraphHistoryItemHoverDefaultLabelForeground","History item hover default label foreground color.")),ie=m("scmGraph.historyItemHoverDefaultLabelBackground",k,h("scmGraphHistoryItemHoverDefaultLabelBackground","History item hover default label background color.")),ce=m("scmGraph.historyItemHoverLabelForeground",B,h("scmGraphHistoryItemHoverLabelForeground","History item hover label foreground color.")),le=m("scmGraph.historyItemHoverAdditionsForeground",{light:"#587C0C",dark:"#81B88B",hcDark:"#A1E3AD",hcLight:"#374E06"},h("scmGraph.HistoryItemHoverAdditionsForeground","History item hover additions foreground color.")),de=m("scmGraph.historyItemHoverDeletionsForeground",{light:"#AD0707",dark:"#C74E39",hcDark:"#C74E39",hcLight:"#AD0707"},h("scmGraph.HistoryItemHoverDeletionsForeground","History item hover deletions foreground color.")),L=[m("scmGraph.foreground1","#FFB000",h("scmGraphForeground1","Source control graph foreground color (1).")),m("scmGraph.foreground2","#DC267F",h("scmGraphForeground2","Source control graph foreground color (2).")),m("scmGraph.foreground3","#994F00",h("scmGraphForeground3","Source control graph foreground color (3).")),m("scmGraph.foreground4","#40B0A6",h("scmGraphForeground4","Source control graph foreground color (4).")),m("scmGraph.foreground5","#B66DFF",h("scmGraphForeground5","Source control graph foreground color (5)."))];function A(s,e){for(const o of s.references??[]){const i=e.get(o.id);if(i!==void 0)return i}}function v(s){const e=document.createElementNS("http://www.w3.org/2000/svg","path");return e.setAttribute("fill","none"),e.setAttribute("stroke-width","1px"),e.setAttribute("stroke-linecap","round"),e.style.stroke=R(s),e}function b(s,e,o,i){const l=document.createElementNS("http://www.w3.org/2000/svg","circle");return l.setAttribute("cx",`${n*(s+1)}`),l.setAttribute("cy",`${n}`),l.setAttribute("r",`${e}`),l.style.strokeWidth=`${o}px`,i&&(l.style.fill=R(i)),l}function w(s,e,o,i){const l=v(i);return l.setAttribute("d",`M ${s} ${e} V ${o}`),l}function j(s,e){for(let o=s.length-1;o>=0;o--)if(s[o].id===e)return o;return-1}function pe(s){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.classList.add("graph");const o=s.historyItem,i=s.inputSwimlanes,l=s.outputSwimlanes,y=i.findIndex(t=>t.id===o.id),d=y!==-1?y:i.length,I=d<l.length?l[d].color:d<i.length?i[d].color:E;let c=0;for(let t=0;t<i.length;t++){const u=i[t].color;if(i[t].id===o.id)if(t!==d){const r=[],a=v(u);r.push(`M ${n*(t+1)} 0`),r.push(`A ${n} ${n} 0 0 1 ${n*t} ${n}`),r.push(`H ${n*(d+1)}`),a.setAttribute("d",r.join(" ")),e.append(a)}else c++;else if(c<l.length&&i[t].id===l[c].id){if(t===c){const r=w(n*(t+1),0,f,u);e.append(r)}else{const r=[],a=v(u);r.push(`M ${n*(t+1)} 0`),r.push("V 6"),r.push(`A ${H} ${H} 0 0 1 ${n*(t+1)-H} ${f/2}`),r.push(`H ${n*(c+1)+H}`),r.push(`A ${H} ${H} 0 0 0 ${n*(c+1)} ${f/2+H}`),r.push(`V ${f}`),a.setAttribute("d",r.join(" ")),e.append(a)}c++}}for(let t=1;t<o.parentIds.length;t++){const u=j(l,o.parentIds[t]);if(u===-1)continue;const r=[],a=v(l[u].color);r.push(`M ${n*u} ${f/2}`),r.push(`A ${n} ${n} 0 0 1 ${n*(u+1)} ${f}`),r.push(`M ${n*u} ${f/2}`),r.push(`H ${n*(d+1)} `),a.setAttribute("d",r.join(" ")),e.append(a)}if(y!==-1){const t=w(n*(d+1),0,f/2,i[y].color);e.append(t)}if(o.parentIds.length>0){const t=w(n*(d+1),f/2,f,I);e.append(t)}if(s.isCurrent){const t=b(d,G+3,$,I);e.append(t);const u=b(d,$,G);e.append(u)}else if(o.parentIds.length>1){const t=b(d,G+2,$,I);e.append(t);const u=b(d,G-1,$,I);e.append(u)}else{const t=b(d,G+1,$,I);e.append(t)}return e.style.height=`${f}px`,e.style.width=`${n*(Math.max(i.length,l.length,1)+1)}px`,e}function ae(s){const e=W("svg",{style:{height:`${f}px`,width:`${n*(s.length+1)}px`}});for(let o=0;o<s.length;o++){const i=w(n*(o+1),0,f,s[o].color);e.root.append(i)}return e.root}function ue(s,e=new Map,o,i,l){let y=-1;const d=[];for(let I=0;I<s.length;I++){const c=s[I],t=c.id===o?.revision,r=(d.at(-1)?.outputSwimlanes??[]).map(p=>F(p)),a=[];let x=!1;if(c.parentIds.length>0)for(const p of r){if(p.id===c.id){x||(a.push({id:c.parentIds[0],color:A(c,e)??p.color}),x=!0);continue}a.push(F(p))}for(let p=x?1:0;p<c.parentIds.length;p++){let g;if(!x)g=A(c,e);else{const S=s.find(C=>C.id===c.parentIds[p]);g=S?A(S,e):void 0}g||(y=_(y+1,L.length),g=L[y]),a.push({id:c.parentIds[p],color:g})}const M=(c.references??[]).map(p=>{let g=e.get(p.id);if(e.has(p.id)&&g===void 0){const S=r.findIndex(D=>D.id===c.id),C=S!==-1?S:r.length;g=C<a.length?a[C].color:C<r.length?r[C].color:E}return{...p,color:g}});M.sort((p,g)=>T(p,g,o,i,l)),d.push({historyItem:{...c,references:M},isCurrent:t,inputSwimlanes:r,outputSwimlanes:a})}return d}export{f as SWIMLANE_HEIGHT,n as SWIMLANE_WIDTH,L as colorRegistry,ne as historyItemBaseRefColor,le as historyItemHoverAdditionsForeground,ie as historyItemHoverDefaultLabelBackground,se as historyItemHoverDefaultLabelForeground,de as historyItemHoverDeletionsForeground,ce as historyItemHoverLabelForeground,E as historyItemRefColor,oe as historyItemRemoteRefColor,ae as renderSCMHistoryGraphPlaceholder,pe as renderSCMHistoryItemGraph,ue as toISCMHistoryItemViewModelArray};
