import{localize as f}from"../../../../nls.js";import{deepClone as b}from"../../../../base/common/objects.js";import{ThemeIcon as R}from"../../../../base/common/themables.js";import{buttonForeground as L,foreground as w}from"../../../../platform/theme/common/colorRegistry.js";import{chartsBlue as E,chartsGreen as D,chartsOrange as V,chartsPurple as N,chartsRed as P,chartsYellow as k}from"../../../../platform/theme/common/colors/chartsColors.js";import{asCssVariable as v,registerColor as I,transparent as B}from"../../../../platform/theme/common/colorUtils.js";import"../common/history.js";import{rot as T}from"../../../../base/common/numbers.js";import{svgElem as _}from"../../../../base/browser/dom.js";const m=22,s=11,C=4,g=5,M=I("scmGraph.historyItemRefColor",E,f("scmGraphHistoryItemRefColor","History item reference color.")),re=I("scmGraph.historyItemRemoteRefColor",N,f("scmGraphHistoryItemRemoteRefColor","History item remote reference color.")),oe=I("scmGraph.historyItemBaseRefColor",V,f("scmGraphHistoryItemBaseRefColor","History item base reference color.")),ne=I("scmGraph.historyItemHoverDefaultLabelForeground",w,f("scmGraphHistoryItemHoverDefaultLabelForeground","History item hover default label foreground color.")),se=I("scmGraph.historyItemHoverDefaultLabelBackground",B(w,.2),f("scmGraphHistoryItemHoverDefaultLabelBackground","History item hover default label background color.")),ie=I("scmGraph.historyItemHoverLabelForeground",L,f("scmGraphHistoryItemHoverLabelForeground","History item hover label foreground color.")),ce=I("scmGraph.historyItemHoverAdditionsForeground","gitDecoration.addedResourceForeground",f("scmGraph.HistoryItemHoverAdditionsForeground","History item hover additions foreground color.")),le=I("scmGraph.historyItemHoverDeletionsForeground","gitDecoration.deletedResourceForeground",f("scmGraph.HistoryItemHoverDeletionsForeground","History item hover deletions foreground color.")),A=[I("scmGraph.foreground1",D,f("scmGraphForeground1","Source control graph foreground color (1).")),I("scmGraph.foreground2",P,f("scmGraphForeground2","Source control graph foreground color (2).")),I("scmGraph.foreground3",k,f("scmGraphForeground3","Source control graph foreground color (3)."))];function G(i,e){for(const o of i.references??[]){const n=e.get(o.id);if(n!==void 0)return n}}function S(i){const e=document.createElementNS("http://www.w3.org/2000/svg","path");return e.setAttribute("fill","none"),e.setAttribute("stroke-width","1px"),e.setAttribute("stroke-linecap","round"),e.style.stroke=v(i),e}function $(i,e,o){const n=document.createElementNS("http://www.w3.org/2000/svg","circle");return n.setAttribute("cx",`${s*(i+1)}`),n.setAttribute("cy",`${s}`),n.setAttribute("r",`${e}`),n.style.fill=v(o),n}function x(i,e,o,n){const a=S(n);return a.setAttribute("d",`M ${i} ${e} V ${o}`),a}function W(i,e){for(let o=i.length-1;o>=0;o--)if(i[o].id===e)return o;return-1}function de(i){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.classList.add("graph");const o=i.historyItem,n=i.inputSwimlanes,a=i.outputSwimlanes,d=n.findIndex(r=>r.id===o.id),p=d!==-1?d:n.length,h=p<a.length?a[p].color:p<n.length?n[p].color:M;let u=0;for(let r=0;r<n.length;r++){const c=n[r].color;if(n[r].id===o.id)if(r!==p){const t=[],l=S(c);t.push(`M ${s*(r+1)} 0`),t.push(`A ${s} ${s} 0 0 1 ${s*r} ${s}`),t.push(`H ${s*(p+1)}`),l.setAttribute("d",t.join(" ")),e.append(l)}else u++;else if(u<a.length&&n[r].id===a[u].id){if(r===u){const t=x(s*(r+1),0,m,c);e.append(t)}else{const t=[],l=S(c);t.push(`M ${s*(r+1)} 0`),t.push("V 6"),t.push(`A ${g} ${g} 0 0 1 ${s*(r+1)-g} ${m/2}`),t.push(`H ${s*(u+1)+g}`),t.push(`A ${g} ${g} 0 0 0 ${s*(u+1)} ${m/2+g}`),t.push(`V ${m}`),l.setAttribute("d",t.join(" ")),e.append(l)}u++}}for(let r=1;r<o.parentIds.length;r++){const c=W(a,o.parentIds[r]);if(c===-1)continue;const t=[],l=S(a[c].color);t.push(`M ${s*c} ${m/2}`),t.push(`A ${s} ${s} 0 0 1 ${s*(c+1)} ${m}`),t.push(`M ${s*c} ${m/2}`),t.push(`H ${s*(p+1)} `),l.setAttribute("d",t.join(" ")),e.append(l)}if(d!==-1){const r=x(s*(p+1),0,m/2,n[d].color);e.append(r)}if(o.parentIds.length>0){const r=x(s*(p+1),m/2,m,h);e.append(r)}if(o.parentIds.length>1){const r=$(p,C+1,h);e.append(r);const c=$(p,C-1,h);e.append(c)}else{if(o.references?.some(c=>R.isThemeIcon(c.icon)&&c.icon.id==="target")){const c=$(p,C+2,h);e.append(c)}const r=$(p,C,h);e.append(r)}return e.style.height=`${m}px`,e.style.width=`${s*(Math.max(n.length,a.length,1)+1)}px`,e}function ae(i){const e=_("svg",{style:{height:`${m}px`,width:`${s*(i.length+1)}px`}});for(let o=0;o<i.length;o++){const n=x(s*(o+1),0,m,i[o].color);e.root.append(n)}return e.root}function pe(i,e=new Map){let o=-1;const n=[];for(let a=0;a<i.length;a++){const d=i[a],h=(n.at(-1)?.outputSwimlanes??[]).map(t=>b(t)),u=[];let r=!1;if(d.parentIds.length>0)for(const t of h){if(t.id===d.id){r||(u.push({id:d.parentIds[0],color:G(d,e)??t.color}),r=!0);continue}u.push(b(t))}for(let t=r?1:0;t<d.parentIds.length;t++){let l;if(!r)l=G(d,e);else{const H=i.find(y=>y.id===d.parentIds[t]);l=H?G(H,e):void 0}l||(o=T(o+1,A.length),l=A[o]),u.push({id:d.parentIds[t],color:l})}const c=(d.references??[]).map(t=>{let l=e.get(t.id);if(e.has(t.id)&&l===void 0){const H=h.findIndex(F=>F.id===d.id),y=H!==-1?H:h.length;l=y<u.length?u[y].color:y<h.length?h[y].color:M}return{...t,color:l}});n.push({historyItem:{...d,references:c},inputSwimlanes:h,outputSwimlanes:u})}return n}export{m as SWIMLANE_HEIGHT,s as SWIMLANE_WIDTH,A as colorRegistry,oe as historyItemBaseRefColor,ce as historyItemHoverAdditionsForeground,se as historyItemHoverDefaultLabelBackground,ne as historyItemHoverDefaultLabelForeground,le as historyItemHoverDeletionsForeground,ie as historyItemHoverLabelForeground,M as historyItemRefColor,re as historyItemRemoteRefColor,ae as renderSCMHistoryGraphPlaceholder,de as renderSCMHistoryItemGraph,pe as toISCMHistoryItemViewModelArray};
