var x=Object.defineProperty;var _=Object.getOwnPropertyDescriptor;var S=(h,n,e,r)=>{for(var t=r>1?void 0:r?_(n,e):n,o=h.length-1,a;o>=0;o--)(a=h[o])&&(t=(r?a(n,e,t):a(t))||t);return r&&t&&x(n,e,t),t},p=(h,n)=>(e,r)=>n(e,r,h);import{Color as u}from"../../../../base/common/color.js";import{Schemas as C}from"../../../../base/common/network.js";import{basename as R}from"../../../../base/common/resources.js";import{splitLines as b}from"../../../../base/common/strings.js";import{URI as y}from"../../../../base/common/uri.js";import{TokenMetadata as z}from"../../../../editor/common/encodedTokenAttributes.js";import{TokenizationRegistry as w}from"../../../../editor/common/languages.js";import{ILanguageService as E}from"../../../../editor/common/languages/language.js";import{CommandsRegistry as $}from"../../../../platform/commands/common/commands.js";import{IFileService as F}from"../../../../platform/files/common/files.js";import{IInstantiationService as M}from"../../../../platform/instantiation/common/instantiation.js";import{EditorResourceAccessor as N}from"../../../common/editor.js";import{IEditorService as L}from"../../../services/editor/common/editorService.js";import{ITextMateTokenizationService as A}from"../../../services/textMate/browser/textMateTokenizationFeature.js";import{findMatchingThemeRule as H}from"../../../services/textMate/common/TMHelper.js";import{IWorkbenchThemeService as U}from"../../../services/themes/common/workbenchThemeService.js";class O{_theme;_cache;_defaultColor;constructor(n){this._theme=n,this._cache=Object.create(null),this._defaultColor="#000000";for(let e=0,r=this._theme.tokenColors.length;e<r;e++){const t=this._theme.tokenColors[e];t.scope||(this._defaultColor=t.settings.foreground)}}_generateExplanation(n,e){return`${n}: ${u.Format.CSS.formatHexA(e,!0).toUpperCase()}`}explainTokenColor(n,e){const r=this._findMatchingThemeRule(n);if(!r){const o=u.fromHex(this._defaultColor);if(!e.equals(o))throw new Error(`[${this._theme.label}]: Unexpected color ${u.Format.CSS.formatHexA(e)} for ${n}. Expected default ${u.Format.CSS.formatHexA(o)}`);return this._generateExplanation("default",e)}const t=u.fromHex(r.settings.foreground);if(!e.equals(t))throw new Error(`[${this._theme.label}]: Unexpected color ${u.Format.CSS.formatHexA(e)} for ${n}. Expected ${u.Format.CSS.formatHexA(t)} coming in from ${r.rawSelector}`);return this._generateExplanation(r.rawSelector,e)}_findMatchingThemeRule(n){return this._cache[n]||(this._cache[n]=H(this._theme,n.split(" "))),this._cache[n]}}let g=class{constructor(n,e,r){this.languageService=n;this.themeService=e;this.textMateService=r}_themedTokenize(n,e){const r=w.getColorMap();let t=null;const o=[];let a=0;for(let l=0,i=e.length;l<i;l++){const s=e[l],c=n.tokenizeLine2(s,t);for(let m=0,k=c.tokens.length>>>1;m<k;m++){const f=c.tokens[m<<1],T=c.tokens[(m<<1)+1],d=m+1<k?c.tokens[m+1<<1]:s.length,v=s.substring(f,d),I=z.getForeground(T);o[a++]={text:v,color:r[I]}}t=c.ruleStack}return o}_tokenize(n,e){let r=null;const t=[];let o=0;for(let a=0,l=e.length;a<l;a++){const i=e[a],s=n.tokenizeLine(i,r);let c=null;for(let m=0,k=s.tokens.length;m<k;m++){const f=s.tokens[m],T=i.substring(f.startIndex,f.endIndex),d=f.scopes.join(" ");c===d?t[o-1].c+=T:(c=d,t[o++]={c:T,t:d,r:{dark_plus:void 0,light_plus:void 0,dark_vs:void 0,light_vs:void 0,hc_black:void 0}})}r=s.ruleStack}return t}async _getThemesResult(n,e){const r=this.themeService.getColorTheme(),t=i=>{const s="vscode-theme-defaults-themes-",c=i.indexOf(s);if(c!==-1)return i.substring(c+s.length,i.length-5)},o={},l=(await this.themeService.getColorThemes()).filter(i=>!!t(i.id));for(const i of l){const s=i.id;if(await this.themeService.setColorTheme(s,void 0)){const m=t(s);o[m]={document:new O(this.themeService.getColorTheme()),tokens:this._themedTokenize(n,e)}}}return await this.themeService.setColorTheme(r.id,void 0),o}_enrichResult(n,e){const r={},t=Object.keys(e);for(const o of t)r[o]=0;for(let o=0,a=n.length;o<a;o++){const l=n[o];for(const i of t){const s=e[i].tokens[r[i]];s.text=s.text.substr(l.c.length),l.r[i]=e[i].document.explainTokenColor(l.t,s.color),s.text.length===0&&r[i]++}}}captureSyntaxTokens(n,e){const r=this.languageService.guessLanguageIdByFilepathOrFirstLine(y.file(n));return this.textMateService.createTokenizer(r).then(t=>{if(!t)return[];const o=b(e),a=this._tokenize(t,o);return this._getThemesResult(t,o).then(l=>(this._enrichResult(a,l),a.filter(i=>i.c.length>0)))})}};g=S([p(0,E),p(1,U),p(2,A)],g),$.registerCommand("_workbench.captureSyntaxTokens",(h,n)=>{const e=r=>{const t=h.get(F),o=R(r),a=h.get(M).createInstance(g);return t.readFile(r).then(l=>a.captureSyntaxTokens(o,l.value.toString()))};if(n)return e(n);{const r=h.get(L),t=r.activeEditor?N.getCanonicalUri(r.activeEditor,{filterByScheme:C.file}):null;t&&e(t).then(o=>{})}});
