var ne=Object.defineProperty;var ce=Object.getOwnPropertyDescriptor;var h=(y,n,e,r)=>{for(var s=r>1?void 0:r?ce(n,e):n,t=y.length-1,i;t>=0;t--)(i=y[t])&&(s=(r?i(n,e,s):i(s))||s);return r&&s&&ne(n,e,s),s},a=(y,n)=>(e,r)=>n(e,r,y);import{Action as ae}from"../../../../base/common/actions.js";import{Codicon as v}from"../../../../base/common/codicons.js";import{fromNow as O}from"../../../../base/common/date.js";import{Event as X}from"../../../../base/common/event.js";import{Disposable as oe,DisposableStore as le}from"../../../../base/common/lifecycle.js";import{basename as p}from"../../../../base/common/resources.js";import{URI as L}from"../../../../base/common/uri.js";import{localize as o,localize2 as I}from"../../../../nls.js";import{Action2 as g,MenuId as w,registerAction2 as R}from"../../../../platform/actions/common/actions.js";import{ICommandService as ue}from"../../../../platform/commands/common/commands.js";import{ContextKeyExpr as u}from"../../../../platform/contextkey/common/contextkey.js";import{IDialogService as z,IFileDialogService as de}from"../../../../platform/dialogs/common/dialogs.js";import{IEnvironmentService as ye}from"../../../../platform/environment/common/environment.js";import{IFileService as j}from"../../../../platform/files/common/files.js";import{SyncDescriptor as P}from"../../../../platform/instantiation/common/descriptors.js";import{IInstantiationService as me}from"../../../../platform/instantiation/common/instantiation.js";import{INotificationService as N,Severity as Se}from"../../../../platform/notification/common/notification.js";import{IQuickInputService as he}from"../../../../platform/quickinput/common/quickInput.js";import{Registry as T}from"../../../../platform/registry/common/platform.js";import{FolderThemeIcon as ve}from"../../../../platform/theme/common/themeService.js";import{IUriIdentityService as G}from"../../../../platform/uriIdentity/common/uriIdentity.js";import{IUserDataProfilesService as F}from"../../../../platform/userDataProfile/common/userDataProfile.js";import{ALL_SYNC_RESOURCES as Q,IUserDataAutoSyncService as W,IUserDataSyncEnablementService as fe,IUserDataSyncResourceProviderService as q,IUserDataSyncService as b,SyncResource as pe,SyncStatus as K,UserDataSyncError as $,UserDataSyncErrorCode as Ie,getLastSyncResourceUri as ge}from"../../../../platform/userDataSync/common/userDataSync.js";import{IUserDataSyncMachinesService as B,isWebPlatform as we}from"../../../../platform/userDataSync/common/userDataSyncMachines.js";import{API_OPEN_DIFF_EDITOR_COMMAND_ID as Z,API_OPEN_EDITOR_COMMAND_ID as Y}from"../../../browser/parts/editor/editorCommands.js";import{TreeView as C,TreeViewPane as k}from"../../../browser/parts/views/treeView.js";import{Extensions as V,TreeItemCollapsibleState as m}from"../../../common/views.js";import{IEditorService as Re}from"../../../services/editor/common/editorService.js";import{AccountStatus as ee,CONTEXT_ACCOUNT_STATE as re,CONTEXT_ENABLE_ACTIVITY_VIEWS as _,CONTEXT_ENABLE_SYNC_CONFLICTS_VIEW as De,CONTEXT_HAS_CONFLICTS as Pe,CONTEXT_SYNC_STATE as te,IUserDataSyncWorkbenchService as A,SYNC_CONFLICTS_VIEW_ID as ie,SYNC_TITLE as Te,getSyncAreaLabel as J}from"../../../services/userDataSync/common/userDataSync.js";import{UserDataSyncConflictsViewPane as be}from"./userDataSyncConflictsView.js";let x=class extends oe{constructor(e,r,s,t,i){super();this.instantiationService=r;this.userDataSyncEnablementService=s;this.userDataSyncMachinesService=t;this.userDataSyncService=i;this.registerViews(e)}registerViews(e){this.registerConflictsView(e),this.registerActivityView(e,!0),this.registerMachinesView(e),this.registerActivityView(e,!1),this.registerTroubleShootView(e),this.registerExternalActivityView(e)}registerConflictsView(e){const r=T.as(V.ViewsRegistry),s=I("conflicts","Conflicts"),t={id:ie,name:s,ctorDescriptor:new P(be),when:u.and(De,Pe),canToggleVisibility:!1,canMoveView:!1,treeView:this.instantiationService.createInstance(C,ie,s.value),collapsed:!1,order:100};r.registerViews([t],e)}registerMachinesView(e){const r="workbench.views.sync.machines",s=I("synced machines","Synced Machines"),t=this.instantiationService.createInstance(C,r,s.value),i=this.instantiationService.createInstance(M,t);t.showRefreshAction=!0,t.canSelectMany=!0,t.dataProvider=i,this._register(X.any(this.userDataSyncMachinesService.onDidChange,this.userDataSyncService.onDidResetRemote)(()=>t.refresh()));const c=T.as(V.ViewsRegistry),l={id:r,name:s,ctorDescriptor:new P(k),when:u.and(te.notEqualsTo(K.Uninitialized),re.isEqualTo(ee.Available),_),canToggleVisibility:!0,canMoveView:!1,treeView:t,collapsed:!1,order:300};c.registerViews([l],e),this._register(R(class extends g{constructor(){super({id:"workbench.actions.sync.editMachineName",title:o("workbench.actions.sync.editMachineName","Edit Name"),icon:v.edit,menu:{id:w.ViewItemContext,when:u.and(u.equals("view",r)),group:"inline"}})}async run(d,S){await i.rename(S.$treeItemHandle)&&await t.refresh()}})),this._register(R(class extends g{constructor(){super({id:"workbench.actions.sync.turnOffSyncOnMachine",title:o("workbench.actions.sync.turnOffSyncOnMachine","Turn off Settings Sync"),menu:{id:w.ViewItemContext,when:u.and(u.equals("view",r),u.equals("viewItem","sync-machine"))}})}async run(d,S,D){await i.disable((D||[S]).map(se=>se.$treeItemHandle))&&await t.refresh()}}))}registerActivityView(e,r){const s=`workbench.views.sync.${r?"remote":"local"}Activity`,t=r?I("remote sync activity title","Sync Activity (Remote)"):I("local sync activity title","Sync Activity (Local)"),i=this.instantiationService.createInstance(C,s,t.value);i.showCollapseAllAction=!0,i.showRefreshAction=!0,i.dataProvider=r?this.instantiationService.createInstance(H):this.instantiationService.createInstance(Ce),this._register(X.any(this.userDataSyncEnablementService.onDidChangeResourceEnablement,this.userDataSyncEnablementService.onDidChangeEnablement,this.userDataSyncService.onDidResetLocal,this.userDataSyncService.onDidResetRemote)(()=>i.refresh()));const c=T.as(V.ViewsRegistry),l={id:s,name:t,ctorDescriptor:new P(k),when:u.and(te.notEqualsTo(K.Uninitialized),re.isEqualTo(ee.Available),_),canToggleVisibility:!0,canMoveView:!1,treeView:i,collapsed:!1,order:r?200:400,hideByDefault:!r};c.registerViews([l],e),this.registerDataViewActions(s)}registerExternalActivityView(e){const r="workbench.views.sync.externalActivity",s=I("downloaded sync activity title","Sync Activity (Developer)"),t=this.instantiationService.createInstance(U,void 0),i=this.instantiationService.createInstance(C,r,s.value);i.showCollapseAllAction=!1,i.showRefreshAction=!1,i.dataProvider=t;const c=T.as(V.ViewsRegistry),l={id:r,name:s,ctorDescriptor:new P(k),when:_,canToggleVisibility:!0,canMoveView:!1,treeView:i,collapsed:!1,hideByDefault:!1};c.registerViews([l],e),this._register(R(class extends g{constructor(){super({id:"workbench.actions.sync.loadActivity",title:o("workbench.actions.sync.loadActivity","Load Sync Activity"),icon:v.cloudUpload,menu:{id:w.ViewTitle,when:u.equals("view",r),group:"navigation"}})}async run(d){const D=await d.get(de).showOpenDialog({title:o("select sync activity file","Select Sync Activity File or Folder"),canSelectFiles:!0,canSelectFolders:!0,canSelectMany:!1});D?.[0]&&(t.activityDataResource=D[0],await i.refresh())}}))}registerDataViewActions(e){this._register(R(class extends g{constructor(){super({id:`workbench.actions.sync.${e}.resolveResource`,title:o("workbench.actions.sync.resolveResourceRef","Show raw JSON sync data"),menu:{id:w.ViewItemContext,when:u.and(u.equals("view",e),u.regex("viewItem",/sync-resource-.*/i))}})}async run(r,s){const{resource:t}=JSON.parse(s.$treeItemHandle);await r.get(Re).openEditor({resource:L.parse(t),options:{pinned:!0}})}})),this._register(R(class extends g{constructor(){super({id:`workbench.actions.sync.${e}.compareWithLocal`,title:o("workbench.actions.sync.compareWithLocal","Compare with Local"),menu:{id:w.ViewItemContext,when:u.and(u.equals("view",e),u.regex("viewItem",/sync-associatedResource-.*/i))}})}async run(r,s){const t=r.get(ue),{resource:i,comparableResource:c}=JSON.parse(s.$treeItemHandle),l=L.parse(i),d=L.parse(c);return t.executeCommand(Z,l,d,o("remoteToLocalDiff","{0} \u2194 {1}",o({key:"leftResourceName",comment:["remote as in file in cloud"]},"{0} (Remote)",p(l)),o({key:"rightResourceName",comment:["local as in file in disk"]},"{0} (Local)",p(d))),void 0)}})),this._register(R(class extends g{constructor(){super({id:`workbench.actions.sync.${e}.replaceCurrent`,title:o("workbench.actions.sync.replaceCurrent","Restore"),icon:v.discard,menu:{id:w.ViewItemContext,when:u.and(u.equals("view",e),u.regex("viewItem",/sync-resource-.*/i),u.notEquals("viewItem",`sync-resource-${pe.Profiles}`)),group:"inline"}})}async run(r,s){const t=r.get(z),i=r.get(b),{syncResourceHandle:c,syncResource:l}=JSON.parse(s.$treeItemHandle);if((await t.confirm({message:o({key:"confirm replace",comment:["A confirmation message to replace current user data (settings, extensions, keybindings, snippets) with selected version"]},"Would you like to replace your current {0} with selected?",J(l)),type:"info",title:Te.value})).confirmed)return i.replace({created:c.created,uri:L.revive(c.uri)})}}))}registerTroubleShootView(e){const r="workbench.views.sync.troubleshoot",s=I("troubleshoot","Troubleshoot"),t=this.instantiationService.createInstance(C,r,s.value),i=this.instantiationService.createInstance(E);t.showRefreshAction=!0,t.dataProvider=i;const c=T.as(V.ViewsRegistry),l={id:r,name:s,ctorDescriptor:new P(k),when:_,canToggleVisibility:!0,canMoveView:!1,treeView:t,collapsed:!1,order:500,hideByDefault:!0};c.registerViews([l],e)}};x=h([a(1,me),a(2,fe),a(3,B),a(4,b)],x);let f=class{constructor(n,e,r,s,t,i){this.userDataSyncService=n;this.userDataSyncResourceProviderService=e;this.userDataAutoSyncService=r;this.userDataSyncWorkbenchService=s;this.notificationService=t;this.userDataProfilesService=i}syncResourceHandlesByProfile=new Map;async getChildren(n){try{if(!n)return await this.getRoots();if(n.profile||n.handle===this.userDataProfilesService.defaultProfile.id){let e=this.syncResourceHandlesByProfile.get(n.handle);return e||this.syncResourceHandlesByProfile.set(n.handle,e=this.getSyncResourceHandles(n.profile)),await e}return n.syncResourceHandle?await this.getChildrenForSyncResourceTreeItem(n):[]}catch(e){throw e instanceof $||(e=$.toUserDataSyncError(e)),e instanceof $&&e.code===Ie.IncompatibleRemoteContent?this.notificationService.notify({severity:Se.Error,message:e.message,actions:{primary:[new ae("reset",o("reset","Reset Synced Data"),void 0,!0,()=>this.userDataSyncWorkbenchService.resetSyncedData())]}}):this.notificationService.error(e),e}}async getRoots(){this.syncResourceHandlesByProfile.clear();const n=[],e=await this.getProfiles();if(e.length){const r={handle:this.userDataProfilesService.defaultProfile.id,label:{label:this.userDataProfilesService.defaultProfile.name},collapsibleState:m.Expanded};n.push(r)}else{const r=await this.getSyncResourceHandles();n.push(...r)}for(const r of e){const s={handle:r.id,label:{label:r.name},collapsibleState:m.Collapsed,profile:r};n.push(s)}return n}async getChildrenForSyncResourceTreeItem(n){const e=n.syncResourceHandle,r=await this.userDataSyncResourceProviderService.getAssociatedResources(e),s=e.previous?await this.userDataSyncResourceProviderService.getAssociatedResources(e.previous):[];return r.map(({resource:t,comparableResource:i})=>{const c=JSON.stringify({resource:t.toString(),comparableResource:i.toString()}),l=s.find(d=>p(d.resource)===p(t))?.resource;return{handle:c,collapsibleState:m.None,resourceUri:t,command:l?{id:Z,title:"",arguments:[l,t,o("sideBySideLabels","{0} \u2194 {1}",`${p(t)} (${O(e.previous.created,!0)})`,`${p(t)} (${O(e.created,!0)})`),void 0]}:{id:Y,title:"",arguments:[t,void 0,void 0]},contextValue:`sync-associatedResource-${e.syncResource}`}})}async getSyncResourceHandles(n){const e=[],s=(await Promise.all(Q.map(async t=>{const i=await this.getResourceHandles(t,n);return i.map((c,l)=>({...c,syncResource:t,previous:i[l+1]}))}))).flat().sort((t,i)=>i.created-t.created);for(const t of s){const i=JSON.stringify({syncResourceHandle:t,syncResource:t.syncResource});e.push({handle:i,collapsibleState:m.Collapsed,label:{label:J(t.syncResource)},description:O(t.created,!0),tooltip:new Date(t.created).toLocaleString(),themeIcon:ve,syncResourceHandle:t,contextValue:`sync-resource-${t.syncResource}`})}return e}};f=h([a(0,b),a(1,q),a(2,W),a(3,A),a(4,N),a(5,F)],f);class Ce extends f{getResourceHandles(n,e){return this.userDataSyncResourceProviderService.getLocalSyncResourceHandles(n,e)}async getProfiles(){return this.userDataProfilesService.profiles.filter(n=>!n.isDefault).map(n=>({id:n.id,collection:n.id,name:n.name}))}}let H=class extends f{constructor(e,r,s,t,i,c,l){super(e,r,s,i,c,l);this.userDataSyncMachinesService=t}machinesPromise;async getChildren(e){return e||(this.machinesPromise=void 0),super.getChildren(e)}getMachines(){return this.machinesPromise===void 0&&(this.machinesPromise=this.userDataSyncMachinesService.getMachines()),this.machinesPromise}getResourceHandles(e,r){return this.userDataSyncResourceProviderService.getRemoteSyncResourceHandles(e,r)}getProfiles(){return this.userDataSyncResourceProviderService.getRemoteSyncedProfiles()}async getChildrenForSyncResourceTreeItem(e){const r=await super.getChildrenForSyncResourceTreeItem(e);if(r.length){const s=await this.userDataSyncResourceProviderService.getMachineId(e.syncResourceHandle);if(s){const i=(await this.getMachines()).find(({id:c})=>c===s);r[0].description=i?.isCurrent?o({key:"current",comment:["Represents current machine"]},"Current"):i?.name}}return r}};H=h([a(0,b),a(1,q),a(2,W),a(3,B),a(4,A),a(5,N),a(6,F)],H);let U=class extends f{constructor(e,r,s,t,i,c,l,d,S){super(r,s,t,i,c,l);this.activityDataResource=e;this.fileService=d;this.uriIdentityService=S}machinesPromise;activityDataLocation;async getChildren(e){if(!e){if(this.machinesPromise=void 0,!this.activityDataResource)return[];if((await this.fileService.resolve(this.activityDataResource)).isDirectory)this.activityDataLocation=this.activityDataResource;else{this.activityDataLocation=this.uriIdentityService.extUri.joinPath(this.uriIdentityService.extUri.dirname(this.activityDataResource),"remoteActivity");try{await this.fileService.del(this.activityDataLocation,{recursive:!0})}catch{}await this.userDataSyncService.extractActivityData(this.activityDataResource,this.activityDataLocation)}}return super.getChildren(e)}getResourceHandles(e,r){return this.userDataSyncResourceProviderService.getLocalSyncResourceHandles(e,r,this.activityDataLocation)}async getProfiles(){return this.userDataSyncResourceProviderService.getLocalSyncedProfiles(this.activityDataLocation)}async getChildrenForSyncResourceTreeItem(e){const r=await super.getChildrenForSyncResourceTreeItem(e);if(r.length){const s=await this.userDataSyncResourceProviderService.getMachineId(e.syncResourceHandle);if(s){const i=(await this.getMachines()).find(({id:c})=>c===s);r[0].description=i?.isCurrent?o({key:"current",comment:["Represents current machine"]},"Current"):i?.name}}return r}getMachines(){return this.machinesPromise===void 0&&(this.machinesPromise=this.userDataSyncResourceProviderService.getLocalSyncedMachines(this.activityDataLocation)),this.machinesPromise}};U=h([a(1,b),a(2,q),a(3,W),a(4,A),a(5,N),a(6,F),a(7,j),a(8,G)],U);let M=class{constructor(n,e,r,s,t,i){this.treeView=n;this.userDataSyncMachinesService=e;this.quickInputService=r;this.notificationService=s;this.dialogService=t;this.userDataSyncWorkbenchService=i}machinesPromise;async getChildren(n){n||(this.machinesPromise=void 0);try{let e=await this.getMachines();return e=e.filter(r=>!r.disabled).sort((r,s)=>r.isCurrent?-1:1),this.treeView.message=e.length?void 0:o("no machines","No Machines"),e.map(({id:r,name:s,isCurrent:t,platform:i})=>({handle:r,collapsibleState:m.None,label:{label:s},description:t?o({key:"current",comment:["Current machine"]},"Current"):void 0,themeIcon:i&&we(i)?v.globe:v.vm,contextValue:"sync-machine"}))}catch(e){return this.notificationService.error(e),[]}}getMachines(){return this.machinesPromise===void 0&&(this.machinesPromise=this.userDataSyncMachinesService.getMachines()),this.machinesPromise}async disable(n){const r=(await this.getMachines()).filter(({id:i})=>n.includes(i));if(!r.length)throw new Error(o("not found","machine not found with id: {0}",n.join(",")));if(!(await this.dialogService.confirm({type:"info",message:r.length>1?o("turn off sync on multiple machines","Are you sure you want to turn off sync on selected machines?"):o("turn off sync on machine","Are you sure you want to turn off sync on {0}?",r[0].name),primaryButton:o({key:"turn off",comment:["&& denotes a mnemonic"]},"&&Turn off")})).confirmed)return!1;r.some(i=>i.isCurrent)&&await this.userDataSyncWorkbenchService.turnoff(!1);const t=r.filter(i=>!i.isCurrent).map(i=>[i.id,!1]);return t.length&&await this.userDataSyncMachinesService.setEnablements(t),!0}async rename(n){const e=new le,r=e.add(this.quickInputService.createInputBox());r.placeholder=o("placeholder","Enter the name of the machine"),r.busy=!0,r.show();const s=await this.getMachines(),t=s.find(({id:c})=>c===n);if(!t)throw r.hide(),e.dispose(),new Error(o("not found","machine not found with id: {0}",n));r.busy=!1,r.value=t.name;const i=c=>(c=c.trim(),c&&!s.some(l=>l.id!==n&&l.name===c)?c:null);return e.add(r.onDidChangeValue(()=>r.validationMessage=i(r.value)?"":o("valid message","Machine name should be unique and not empty"))),new Promise((c,l)=>{e.add(r.onDidAccept(async()=>{const d=i(r.value);if(e.dispose(),d&&d!==t.name)try{await this.userDataSyncMachinesService.renameMachine(n,d),c(!0)}catch(S){l(S)}else c(!1)}))})}};M=h([a(1,B),a(2,he),a(3,N),a(4,z),a(5,A)],M);let E=class{constructor(n,e,r,s){this.fileService=n;this.userDataSyncWorkbenchService=e;this.environmentService=r;this.uriIdentityService=s}async getChildren(n){return n?n.handle==="LAST_SYNC_STATES"?this.getLastSyncStates():n.handle==="SYNC_LOGS"?this.getSyncLogs():[]:[{handle:"SYNC_LOGS",collapsibleState:m.Collapsed,label:{label:o("sync logs","Logs")},themeIcon:v.folder},{handle:"LAST_SYNC_STATES",collapsibleState:m.Collapsed,label:{label:o("last sync states","Last Synced Remotes")},themeIcon:v.folder}]}async getLastSyncStates(){const n=[];for(const e of Q){const r=ge(void 0,e,this.environmentService,this.uriIdentityService.extUri);await this.fileService.exists(r)&&n.push({handle:r.toString(),label:{label:J(e)},collapsibleState:m.None,resourceUri:r,command:{id:Y,title:"",arguments:[r,void 0,void 0]}})}return n}async getSyncLogs(){const n=await this.userDataSyncWorkbenchService.getAllLogResources(),e=[];for(const r of n){const s=this.uriIdentityService.extUri.dirname(r);e.push({handle:r.toString(),collapsibleState:m.None,resourceUri:r,label:{label:this.uriIdentityService.extUri.basename(s)},description:this.uriIdentityService.extUri.isEqual(s,this.environmentService.logsHome)?o({key:"current",comment:["Represents current log file"]},"Current"):void 0,command:{id:Y,title:"",arguments:[r,void 0,void 0]}})}return e}};E=h([a(0,j),a(1,A),a(2,ye),a(3,G)],E);export{x as UserDataSyncDataViews};
