var C=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var f=(a,e,t,i)=>{for(var s=i>1?void 0:i?v(e,t):e,o=a.length-1,r;o>=0;o--)(r=a[o])&&(s=(i?r(e,t,s):r(s))||s);return i&&s&&C(e,t,s),s},m=(a,e)=>(t,i)=>e(t,i,a);import*as h from"../../../../base/browser/dom.js";import{CancellationTokenSource as R}from"../../../../base/common/cancellation.js";import{KeyCode as S}from"../../../../base/common/keyCodes.js";import{DisposableStore as H}from"../../../../base/common/lifecycle.js";import"../../../../editor/browser/editorBrowser.js";import{EditorAction2 as g,EditorContributionInstantiation as x,registerEditorContribution as L}from"../../../../editor/browser/editorExtensions.js";import"../../../../editor/common/editorCommon.js";import{EditorContextKeys as D}from"../../../../editor/common/editorContextKeys.js";import{asCommandLink as N}from"../../../../editor/contrib/inlayHints/browser/inlayHints.js";import{InlayHintsController as A}from"../../../../editor/contrib/inlayHints/browser/inlayHintsController.js";import{localize as _,localize2 as y}from"../../../../nls.js";import{AccessibilitySignal as k,IAccessibilitySignalService as w}from"../../../../platform/accessibilitySignal/browser/accessibilitySignalService.js";import{registerAction2 as b}from"../../../../platform/actions/common/actions.js";import{IContextKeyService as K,RawContextKey as T}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as W}from"../../../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as M}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{Link as z}from"../../../../platform/opener/browser/link.js";let n=class{constructor(e,t,i,s){this._editor=e;this._accessibilitySignalService=i;this._instaService=s;this._ariaElement=document.createElement("span"),this._ariaElement.style.position="fixed",this._ariaElement.className="inlayhint-accessibility-element",this._ariaElement.tabIndex=0,this._ariaElement.setAttribute("aria-description",_("description","Code with Inlay Hint Information")),this._ctxIsReading=n.IsReading.bindTo(t)}static IsReading=new T("isReadingLineWithInlayHints",!1,{type:"boolean",description:_("isReadingLineWithInlayHints","Whether the current line and its inlay hints are currently focused")});static ID="editor.contrib.InlayHintsAccessibility";static get(e){return e.getContribution(n.ID)??void 0}_ariaElement;_ctxIsReading;_sessionDispoosables=new H;dispose(){this._sessionDispoosables.dispose(),this._ctxIsReading.reset(),this._ariaElement.remove()}_reset(){h.clearNode(this._ariaElement),this._sessionDispoosables.clear(),this._ctxIsReading.reset()}async _read(e,t){if(this._sessionDispoosables.clear(),this._ariaElement.isConnected||this._editor.getDomNode()?.appendChild(this._ariaElement),!this._editor.hasModel()||!this._ariaElement.isConnected){this._ctxIsReading.set(!1);return}const i=new R;this._sessionDispoosables.add(i);for(const l of t)await l.resolve(i.token);if(i.token.isCancellationRequested)return;const s=this._editor.getModel(),o=[];let r=0,u=!1;for(const l of t){const I=s.getValueInRange({startLineNumber:e,startColumn:r+1,endLineNumber:e,endColumn:l.hint.position.column});if(I.length>0&&(o.push(I),r=l.hint.position.column-1),r>750){o.push("\u2026"),u=!0;break}const c=document.createElement("em"),{label:p}=l.hint;if(typeof p=="string")c.innerText=p;else for(const d of p)if(d.command){const E=this._instaService.createInstance(z,c,{href:N(d.command),label:d.label,title:d.command.title},void 0);this._sessionDispoosables.add(E)}else c.innerText+=d.label;o.push(c)}u||o.push(s.getValueInRange({startLineNumber:e,startColumn:r+1,endLineNumber:e,endColumn:Number.MAX_SAFE_INTEGER})),h.reset(this._ariaElement,...o),this._ariaElement.focus(),this._ctxIsReading.set(!0),this._sessionDispoosables.add(h.addDisposableListener(this._ariaElement,"focusout",()=>{this._reset()}))}startInlayHintsReading(){if(!this._editor.hasModel())return;const e=this._editor.getPosition().lineNumber,t=A.get(this._editor)?.getInlayHintsForLine(e);!t||t.length===0?this._accessibilitySignalService.playSignal(k.noInlayHints):this._read(e,t)}stopInlayHintsReading(){this._reset(),this._editor.focus()}};n=f([m(1,K),m(2,w),m(3,W)],n),b(class extends g{constructor(){super({id:"inlayHints.startReadingLineWithHint",title:y("read.title","Read Line With Inline Hints"),precondition:D.hasInlayHintsProvider,f1:!0})}runEditorCommand(e,t){n.get(t)?.startInlayHintsReading()}}),b(class extends g{constructor(){super({id:"inlayHints.stopReadingLineWithHint",title:y("stop.title","Stop Inlay Hints Reading"),precondition:n.IsReading,f1:!0,keybinding:{weight:M.EditorContrib,primary:S.Escape}})}runEditorCommand(e,t){n.get(t)?.stopInlayHintsReading()}}),L(n.ID,n,x.Lazy);export{n as InlayHintsAccessibility};
