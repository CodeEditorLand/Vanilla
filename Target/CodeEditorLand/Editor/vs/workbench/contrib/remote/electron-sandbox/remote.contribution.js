var j=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var l=(c,n,i,r)=>{for(var e=r>1?void 0:r?G(n,i):n,s=c.length-1,o;s>=0;s--)(o=c[s])&&(e=(r?o(n,i,e):o(e))||e);return r&&e&&j(n,i,e),e},t=(c,n)=>(i,r)=>n(i,r,c);import{KeyChord as V,KeyCode as p,KeyMod as m}from"../../../../base/common/keyCodes.js";import{Disposable as w}from"../../../../base/common/lifecycle.js";import{Schemas as Y}from"../../../../base/common/network.js";import{isMacintosh as z,isWindows as J}from"../../../../base/common/platform.js";import{ipcRenderer as y}from"../../../../base/parts/sandbox/electron-sandbox/globals.js";import*as W from"../../../../nls.js";import{ICommandService as Q}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as N}from"../../../../platform/configuration/common/configuration.js";import{Extensions as X}from"../../../../platform/configuration/common/configurationRegistry.js";import{IContextKeyService as Z,RawContextKey as q}from"../../../../platform/contextkey/common/contextkey.js";import{KeybindingWeight as I,KeybindingsRegistry as b}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{ILabelService as U}from"../../../../platform/label/common/label.js";import{INativeHostService as ee}from"../../../../platform/native/common/native.js";import{Registry as P}from"../../../../platform/registry/common/platform.js";import{PersistentConnectionEventType as oe}from"../../../../platform/remote/common/remoteAgentConnection.js";import{IRemoteAuthorityResolverService as B}from"../../../../platform/remote/common/remoteAuthorityResolver.js";import{IStorageService as te,StorageScope as M,StorageTarget as ne}from"../../../../platform/storage/common/storage.js";import{TELEMETRY_SETTING_ID as re}from"../../../../platform/telemetry/common/telemetry.js";import{getTelemetryLevel as ie}from"../../../../platform/telemetry/common/telemetryUtils.js";import{IWorkspaceContextService as ae,WorkbenchState as se}from"../../../../platform/workspace/common/workspace.js";import{Extensions as ce,WorkbenchPhase as R,registerWorkbenchContribution2 as E}from"../../../common/contributions.js";import{OpenLocalFileCommand as L,OpenLocalFileFolderCommand as x,OpenLocalFolderCommand as A,RemoteFileDialogContext as v,SaveLocalFileCommand as D}from"../../../services/dialogs/browser/simpleFileDialog.js";import{INativeWorkbenchEnvironmentService as le}from"../../../services/environment/electron-sandbox/environmentService.js";import{IExtensionService as me}from"../../../services/extensions/common/extensions.js";import{ILifecycleService as de,LifecyclePhase as K}from"../../../services/lifecycle/common/lifecycle.js";import{IRemoteAgentService as T,remoteConnectionLatencyMeasurer as F}from"../../../services/remote/common/remoteAgentService.js";let f=class{constructor(n,i){y.on("vscode:getDiagnosticInfo",(r,e)=>{const s=n.getConnection();if(s){const o=i.getHostLabel(Y.vscodeRemote,s.remoteAuthority);n.getDiagnosticInfo(e.args).then(a=>{a&&(a.hostName=o,F.latency?.high&&(a.latency={average:F.latency.average,current:F.latency.current})),y.send(e.replyChannel,a)}).catch(a=>{const u=a&&a.message?`Connection to '${o}' could not be established  ${a.message}`:`Connection to '${o}' could not be established `;y.send(e.replyChannel,{hostName:o,errorMessage:u})})}else y.send(e.replyChannel)})}};f=l([t(0,T),t(1,U)],f);let C=class{constructor(n,i,r){const e=n.getConnection();e&&e.onDidStateChange(async s=>{if(s.type===oe.ConnectionGain){const o=await i.resolveAuthority(e.remoteAuthority);o.options&&o.options.extensionHostEnv&&await r.setRemoteEnvironment(o.options.extensionHostEnv)}})}};C=l([t(0,T),t(1,B),t(2,me)],C);let d=class extends w{constructor(i,r){super();this.remoteAgentService=i;this.configurationService=r;this.updateRemoteTelemetryEnablement(),this._register(r.onDidChangeConfiguration(e=>{e.affectsConfiguration(re)&&this.updateRemoteTelemetryEnablement()}))}static ID="workbench.contrib.remoteTelemetryEnablementUpdater";updateRemoteTelemetryEnablement(){return this.remoteAgentService.updateTelemetryLevel(ie(this.configurationService))}};d=l([t(0,T),t(1,N)],d);let h=class extends w{static ID="workbench.contrib.remoteEmptyWorkbenchPresentation";constructor(n,i,r,e,s){super();function o(){const O=r.getValue("workbench.startupEditor");return O!=="welcomePage"&&O!=="welcomePageInEmptyWorkbench"}function a(){return o()}const{remoteAuthority:u,filesToDiff:S,filesToMerge:k,filesToOpenOrCreate:_,filesToWait:$}=n;u&&s.getWorkbenchState()===se.EMPTY&&!S?.length&&!k?.length&&!_?.length&&!$&&i.resolveAuthority(u).then(()=>{o()&&e.executeCommand("workbench.view.explorer"),a()&&e.executeCommand("workbench.action.terminal.toggleTerminal")})}};h=l([t(0,le),t(1,B),t(2,N),t(3,Q),t(4,ae)],h);let g=class extends w{static ID="workbench.contrib.wslContextKeyInitializer";constructor(n,i,r,e){super();const s="wslFeatureInstalled",o="remote.wslFeatureInstalled",a=r.getBoolean(o,M.APPLICATION,void 0),S=new q(s,!!a,W.localize("wslFeatureInstalled","Whether the platform has the WSL feature installed")).bindTo(n);a===void 0&&e.when(K.Eventually).then(async()=>{i.hasWSLFeatureInstalled().then(k=>{k&&(S.set(!0),r.store(o,!0,M.APPLICATION,ne.MACHINE))})})}};g=l([t(0,Z),t(1,ee),t(2,te),t(3,de)],g);const H=P.as(ce.Workbench);H.registerWorkbenchContribution(f,K.Eventually),H.registerWorkbenchContribution(C,K.Eventually),E(d.ID,d,R.BlockRestore),E(h.ID,h,R.BlockRestore),J&&E(g.ID,g,R.BlockRestore),P.as(X.Configuration).registerConfiguration({id:"remote",title:W.localize("remote","Remote"),type:"object",properties:{"remote.downloadExtensionsLocally":{type:"boolean",markdownDescription:W.localize("remote.downloadExtensionsLocally","When enabled extensions are downloaded locally and installed on remote."),default:!1}}}),z?b.registerCommandAndKeybindingRule({id:x.ID,weight:I.WorkbenchContrib,primary:m.CtrlCmd|p.KeyO,when:v,metadata:{description:x.LABEL,args:[]},handler:x.handler()}):(b.registerCommandAndKeybindingRule({id:L.ID,weight:I.WorkbenchContrib,primary:m.CtrlCmd|p.KeyO,when:v,metadata:{description:L.LABEL,args:[]},handler:L.handler()}),b.registerCommandAndKeybindingRule({id:A.ID,weight:I.WorkbenchContrib,primary:V(m.CtrlCmd|p.KeyK,m.CtrlCmd|p.KeyO),when:v,metadata:{description:A.LABEL,args:[]},handler:A.handler()})),b.registerCommandAndKeybindingRule({id:D.ID,weight:I.WorkbenchContrib,primary:m.CtrlCmd|m.Shift|p.KeyS,when:v,metadata:{description:D.LABEL,args:[]},handler:D.handler()});
