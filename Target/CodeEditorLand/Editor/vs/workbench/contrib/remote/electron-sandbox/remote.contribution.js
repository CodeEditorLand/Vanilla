var G=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var l=(c,n,i,r)=>{for(var e=r>1?void 0:r?V(n,i):n,s=c.length-1,o;s>=0;s--)(o=c[s])&&(e=(r?o(n,i,e):o(e))||e);return r&&e&&G(n,i,e),e},t=(c,n)=>(i,r)=>n(i,r,c);import*as w from"../../../../nls.js";import{Registry as N}from"../../../../platform/registry/common/platform.js";import{IRemoteAgentService as W,remoteConnectionLatencyMeasurer as R}from"../../../services/remote/common/remoteAgentService.js";import{Disposable as E}from"../../../../base/common/lifecycle.js";import{isMacintosh as Y,isWindows as j}from"../../../../base/common/platform.js";import{KeyMod as m,KeyChord as z,KeyCode as f}from"../../../../base/common/keyCodes.js";import{KeybindingsRegistry as I,KeybindingWeight as b}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{WorkbenchPhase as L,Extensions as J,registerWorkbenchContribution2 as x}from"../../../common/contributions.js";import{ILifecycleService as Q,LifecyclePhase as A}from"../../../services/lifecycle/common/lifecycle.js";import{ILabelService as X}from"../../../../platform/label/common/label.js";import{ICommandService as Z}from"../../../../platform/commands/common/commands.js";import{Schemas as q}from"../../../../base/common/network.js";import{IExtensionService as U}from"../../../services/extensions/common/extensions.js";import{ipcRenderer as y}from"../../../../base/parts/sandbox/electron-sandbox/globals.js";import{INativeWorkbenchEnvironmentService as ee}from"../../../services/environment/electron-sandbox/environmentService.js";import{PersistentConnectionEventType as oe}from"../../../../platform/remote/common/remoteAgentConnection.js";import{IConfigurationService as P}from"../../../../platform/configuration/common/configuration.js";import{Extensions as te}from"../../../../platform/configuration/common/configurationRegistry.js";import{IRemoteAuthorityResolverService as B}from"../../../../platform/remote/common/remoteAuthorityResolver.js";import{OpenLocalFileFolderCommand as D,OpenLocalFileCommand as K,OpenLocalFolderCommand as T,SaveLocalFileCommand as F,RemoteFileDialogContext as v}from"../../../services/dialogs/browser/simpleFileDialog.js";import{IWorkspaceContextService as ne,WorkbenchState as re}from"../../../../platform/workspace/common/workspace.js";import{TELEMETRY_SETTING_ID as ie}from"../../../../platform/telemetry/common/telemetry.js";import{getTelemetryLevel as ae}from"../../../../platform/telemetry/common/telemetryUtils.js";import{IContextKeyService as se,RawContextKey as ce}from"../../../../platform/contextkey/common/contextkey.js";import{INativeHostService as le}from"../../../../platform/native/common/native.js";import{IStorageService as me,StorageScope as M,StorageTarget as de}from"../../../../platform/storage/common/storage.js";let p=class{constructor(n,i){y.on("vscode:getDiagnosticInfo",(r,e)=>{const s=n.getConnection();if(s){const o=i.getHostLabel(q.vscodeRemote,s.remoteAuthority);n.getDiagnosticInfo(e.args).then(a=>{a&&(a.hostName=o,R.latency?.high&&(a.latency={average:R.latency.average,current:R.latency.current})),y.send(e.replyChannel,a)}).catch(a=>{const u=a&&a.message?`Connection to '${o}' could not be established  ${a.message}`:`Connection to '${o}' could not be established `;y.send(e.replyChannel,{hostName:o,errorMessage:u})})}else y.send(e.replyChannel)})}};p=l([t(0,W),t(1,X)],p);let C=class{constructor(n,i,r){const e=n.getConnection();e&&e.onDidStateChange(async s=>{if(s.type===oe.ConnectionGain){const o=await i.resolveAuthority(e.remoteAuthority);o.options&&o.options.extensionHostEnv&&await r.setRemoteEnvironment(o.options.extensionHostEnv)}})}};C=l([t(0,W),t(1,B),t(2,U)],C);let d=class extends E{constructor(i,r){super();this.remoteAgentService=i;this.configurationService=r;this.updateRemoteTelemetryEnablement(),this._register(r.onDidChangeConfiguration(e=>{e.affectsConfiguration(ie)&&this.updateRemoteTelemetryEnablement()}))}static ID="workbench.contrib.remoteTelemetryEnablementUpdater";updateRemoteTelemetryEnablement(){return this.remoteAgentService.updateTelemetryLevel(ae(this.configurationService))}};d=l([t(0,W),t(1,P)],d);let h=class extends E{static ID="workbench.contrib.remoteEmptyWorkbenchPresentation";constructor(n,i,r,e,s){super();function o(){const O=r.getValue("workbench.startupEditor");return O!=="welcomePage"&&O!=="welcomePageInEmptyWorkbench"}function a(){return o()}const{remoteAuthority:u,filesToDiff:S,filesToMerge:k,filesToOpenOrCreate:_,filesToWait:$}=n;u&&s.getWorkbenchState()===re.EMPTY&&!S?.length&&!k?.length&&!_?.length&&!$&&i.resolveAuthority(u).then(()=>{o()&&e.executeCommand("workbench.view.explorer"),a()&&e.executeCommand("workbench.action.terminal.toggleTerminal")})}};h=l([t(0,ee),t(1,B),t(2,P),t(3,Z),t(4,ne)],h);let g=class extends E{static ID="workbench.contrib.wslContextKeyInitializer";constructor(n,i,r,e){super();const s="wslFeatureInstalled",o="remote.wslFeatureInstalled",a=r.getBoolean(o,M.APPLICATION,void 0),S=new ce(s,!!a,w.localize("wslFeatureInstalled","Whether the platform has the WSL feature installed")).bindTo(n);a===void 0&&e.when(A.Eventually).then(async()=>{i.hasWSLFeatureInstalled().then(k=>{k&&(S.set(!0),r.store(o,!0,M.APPLICATION,de.MACHINE))})})}};g=l([t(0,se),t(1,le),t(2,me),t(3,Q)],g);const H=N.as(J.Workbench);H.registerWorkbenchContribution(p,A.Eventually),H.registerWorkbenchContribution(C,A.Eventually),x(d.ID,d,L.BlockRestore),x(h.ID,h,L.BlockRestore),j&&x(g.ID,g,L.BlockRestore),N.as(te.Configuration).registerConfiguration({id:"remote",title:w.localize("remote","Remote"),type:"object",properties:{"remote.downloadExtensionsLocally":{type:"boolean",markdownDescription:w.localize("remote.downloadExtensionsLocally","When enabled extensions are downloaded locally and installed on remote."),default:!1}}}),Y?I.registerCommandAndKeybindingRule({id:D.ID,weight:b.WorkbenchContrib,primary:m.CtrlCmd|f.KeyO,when:v,metadata:{description:D.LABEL,args:[]},handler:D.handler()}):(I.registerCommandAndKeybindingRule({id:K.ID,weight:b.WorkbenchContrib,primary:m.CtrlCmd|f.KeyO,when:v,metadata:{description:K.LABEL,args:[]},handler:K.handler()}),I.registerCommandAndKeybindingRule({id:T.ID,weight:b.WorkbenchContrib,primary:z(m.CtrlCmd|f.KeyK,m.CtrlCmd|f.KeyO),when:v,metadata:{description:T.LABEL,args:[]},handler:T.handler()})),I.registerCommandAndKeybindingRule({id:F.ID,weight:b.WorkbenchContrib,primary:m.CtrlCmd|m.Shift|f.KeyS,when:v,metadata:{description:F.LABEL,args:[]},handler:F.handler()});
