var w=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var f=(s,n,r,e)=>{for(var o=e>1?void 0:e?x(n,r):n,a=s.length-1,l;a>=0;a--)(l=s[a])&&(o=(e?l(n,r,o):l(o))||o);return e&&o&&w(n,r,o),o},i=(s,n)=>(r,e)=>n(r,e,s);import*as v from"../../../../nls.js";import{ITunnelService as E,TunnelProtocol as g,TunnelPrivacyId as I}from"../../../../platform/tunnel/common/tunnel.js";import{Disposable as O}from"../../../../base/common/lifecycle.js";import"../../../common/contributions.js";import{IBrowserWorkbenchEnvironmentService as R}from"../../../services/environment/browser/environmentService.js";import{IOpenerService as k}from"../../../../platform/opener/common/opener.js";import{URI as A}from"../../../../base/common/uri.js";import{IRemoteExplorerService as S}from"../../../services/remote/common/remoteExplorerService.js";import{ILogService as W}from"../../../../platform/log/common/log.js";import{IContextKeyService as U}from"../../../../platform/contextkey/common/contextkey.js";import{forwardedPortsFeaturesEnabled as C}from"../../../services/remote/common/tunnelModel.js";let u=class extends O{constructor(r,e,o,a,l,P){super();this.openerService=o;const m=e.options?.tunnelProvider?.tunnelFactory;if(m){P.createKey(C.key,!0);let c=e.options?.tunnelProvider?.features?.privacyOptions??[];e.options?.tunnelProvider?.features?.public&&c.length===0&&(c=[{id:"private",label:v.localize("tunnelPrivacy.private","Private"),themeIcon:"lock"},{id:"public",label:v.localize("tunnelPrivacy.public","Public"),themeIcon:"eye"}]),this._register(r.setTunnelProvider({forwardPort:async(h,b)=>{let p;try{p=m(h,b)}catch{l.trace("tunnelFactory: tunnel provider error")}if(!p)return;let t;try{t=await p}catch(d){return l.trace("tunnelFactory: tunnel provider promise error"),d instanceof Error?d.message:void 0}const T=t.localAddress.startsWith("http")?t.localAddress:`http://${t.localAddress}`;return{tunnelRemotePort:t.remoteAddress.port,tunnelRemoteHost:t.remoteAddress.host,localAddress:await this.resolveExternalUri(T),privacy:t.privacy??(t.public?I.Public:I.Private),protocol:t.protocol??g.Http,dispose:async()=>{await t.dispose()}}}}));const y=e.options?.tunnelProvider?.features?{features:{elevation:!!e.options?.tunnelProvider?.features?.elevation,public:!!e.options?.tunnelProvider?.features?.public,privacyOptions:c,protocol:e.options?.tunnelProvider?.features?.protocol===void 0?!0:!!e.options?.tunnelProvider?.features?.protocol}}:void 0;a.setTunnelInformation(y)}}static ID="workbench.contrib.tunnelFactory";async resolveExternalUri(r){try{return(await this.openerService.resolveExternalUri(A.parse(r))).resolved.toString()}catch{return r}}};u=f([i(0,E),i(1,R),i(2,k),i(3,S),i(4,W),i(5,U)],u);export{u as TunnelFactoryContribution};
