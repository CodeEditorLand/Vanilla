var me=Object.defineProperty;var pe=Object.getOwnPropertyDescriptor;var x=(m,t,e,i)=>{for(var n=i>1?void 0:i?pe(t,e):t,r=m.length-1,s;r>=0;r--)(s=m[r])&&(n=(i?s(t,e,n):s(n))||n);return i&&n&&me(t,e,n),n},o=(m,t)=>(e,i)=>t(e,i,m);import"vs/css!./media/remoteViewlet";import*as b from"../../../../../vs/base/browser/dom.js";import"../../../../../vs/base/browser/ui/list/list.js";import"../../../../../vs/base/browser/ui/tree/tree.js";import{mainWindow as ue}from"../../../../../vs/base/browser/window.js";import{Emitter as he,Event as de}from"../../../../../vs/base/common/event.js";import{Disposable as Ie}from"../../../../../vs/base/common/lifecycle.js";import{Schemas as Q}from"../../../../../vs/base/common/network.js";import ve from"../../../../../vs/base/common/severity.js";import{ThemeIcon as fe}from"../../../../../vs/base/common/themables.js";import{isStringArray as U}from"../../../../../vs/base/common/types.js";import{URI as A}from"../../../../../vs/base/common/uri.js";import*as p from"../../../../../vs/nls.js";import{ICommandService as $}from"../../../../../vs/platform/commands/common/commands.js";import{IConfigurationService as K}from"../../../../../vs/platform/configuration/common/configuration.js";import{IContextKeyService as ge}from"../../../../../vs/platform/contextkey/common/contextkey.js";import{IContextMenuService as j}from"../../../../../vs/platform/contextview/browser/contextView.js";import{IDialogService as Se}from"../../../../../vs/platform/dialogs/common/dialogs.js";import"../../../../../vs/platform/extensions/common/extensions.js";import{IHoverService as we}from"../../../../../vs/platform/hover/browser/hover.js";import{SyncDescriptor as J}from"../../../../../vs/platform/instantiation/common/descriptors.js";import{IInstantiationService as X}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{IKeybindingService as De}from"../../../../../vs/platform/keybinding/common/keybinding.js";import{WorkbenchAsyncDataTree as ye}from"../../../../../vs/platform/list/browser/listService.js";import{ILogService as Te}from"../../../../../vs/platform/log/common/log.js";import{IOpenerService as ke}from"../../../../../vs/platform/opener/common/opener.js";import{IProgressService as be,ProgressLocation as R}from"../../../../../vs/platform/progress/common/progress.js";import{IQuickInputService as Y}from"../../../../../vs/platform/quickinput/common/quickInput.js";import{Registry as O}from"../../../../../vs/platform/registry/common/platform.js";import{PersistentConnectionEventType as P}from"../../../../../vs/platform/remote/common/remoteAgentConnection.js";import{getRemoteName as E}from"../../../../../vs/platform/remote/common/remoteHosts.js";import{IStorageService as Re}from"../../../../../vs/platform/storage/common/storage.js";import{ITelemetryService as z}from"../../../../../vs/platform/telemetry/common/telemetry.js";import{IThemeService as Z}from"../../../../../vs/platform/theme/common/themeService.js";import{getVirtualWorkspaceLocation as Ce}from"../../../../../vs/platform/workspace/common/virtualWorkspace.js";import{IWorkspaceContextService as ee}from"../../../../../vs/platform/workspace/common/workspace.js";import{ReloadWindowAction as te}from"../../../../../vs/workbench/browser/actions/windowActions.js";import{ViewPane as He}from"../../../../../vs/workbench/browser/parts/views/viewPane.js";import{FilterViewPaneContainer as xe}from"../../../../../vs/workbench/browser/parts/views/viewsViewlet.js";import"../../../../../vs/workbench/common/contributions.js";import{Extensions as F,IViewDescriptorService as ie,ViewContainerLocation as Pe}from"../../../../../vs/workbench/common/views.js";import{SwitchRemoteViewItem as Ee}from"../../../../../vs/workbench/contrib/remote/browser/explorerViewItems.js";import{VIEWLET_ID as W}from"../../../../../vs/workbench/contrib/remote/browser/remoteExplorer.js";import*as f from"../../../../../vs/workbench/contrib/remote/browser/remoteIcons.js";import{IWalkthroughsService as _e}from"../../../../../vs/workbench/contrib/welcomeGettingStarted/browser/gettingStartedService.js";import{IWorkbenchEnvironmentService as re}from"../../../../../vs/workbench/services/environment/common/environmentService.js";import{IExtensionService as Ve,isProposedApiEnabled as Ae}from"../../../../../vs/workbench/services/extensions/common/extensions.js";import"../../../../../vs/workbench/services/extensions/common/extensionsRegistry.js";import{IWorkbenchLayoutService as We}from"../../../../../vs/workbench/services/layout/browser/layoutService.js";import{IRemoteAgentService as ne}from"../../../../../vs/workbench/services/remote/common/remoteAgentService.js";import{IRemoteExplorerService as oe}from"../../../../../vs/workbench/services/remote/common/remoteExplorerService.js";import{ITimerService as Le}from"../../../../../vs/workbench/services/timer/browser/timerService.js";class Me{getHeight(t){return 22}getTemplateId(t){return"HelpItemTemplate"}}class Ne{templateId="HelpItemTemplate";renderTemplate(t){t.classList.add("remote-help-tree-node-item");const e=b.append(t,b.$(".remote-help-tree-node-item-icon"));return{parent:t,icon:e}}renderElement(t,e,i,n){const r=i.parent;b.append(r,i.icon),i.icon.classList.add(...t.element.iconClasses);const s=b.append(r,b.$(".help-item-label"));s.innerText=t.element.label}disposeTemplate(t){}}class Oe{hasChildren(t){return t instanceof B}getChildren(t){return t instanceof B&&t.items?t.items:[]}}class B{constructor(t,e,i,n,r,s,a,u){this.viewModel=t;this.openerService=e;this.quickInputService=i;this.commandService=n;this.remoteExplorerService=r;this.environmentService=s;this.workspaceContextService=a;this.walkthroughsService=u;this.updateItems(),t.onDidChangeHelpInformation(()=>this.updateItems())}items;createHelpItemValue(t,e){return new ze(this.commandService,this.walkthroughsService,t.extensionDescription,typeof t.remoteName=="string"?[t.remoteName]:t.remoteName,t.virtualWorkspace,t[e])}updateItems(){const t=[],e=this.viewModel.helpInformation.filter(r=>r.getStarted);if(e.length){const r=e.map(a=>this.createHelpItemValue(a,"getStarted")),s=this.items?.find(a=>a.icon===f.getStartedIcon)??new Fe(f.getStartedIcon,p.localize("remote.help.getStarted","Get Started"),r,this.quickInputService,this.environmentService,this.openerService,this.remoteExplorerService,this.workspaceContextService,this.commandService);s.values=r,t.push(s)}const i=this.viewModel.helpInformation.filter(r=>r.documentation);if(i.length){const r=i.map(a=>this.createHelpItemValue(a,"documentation")),s=this.items?.find(a=>a.icon===f.documentationIcon)??new se(f.documentationIcon,p.localize("remote.help.documentation","Read Documentation"),r,this.quickInputService,this.environmentService,this.openerService,this.remoteExplorerService,this.workspaceContextService);s.values=r,t.push(s)}const n=this.viewModel.helpInformation.filter(r=>r.issues);if(n.length){const r=n.map(a=>this.createHelpItemValue(a,"issues")),s=this.items?.find(a=>a.icon===f.reviewIssuesIcon)??new se(f.reviewIssuesIcon,p.localize("remote.help.issues","Review Issues"),r,this.quickInputService,this.environmentService,this.openerService,this.remoteExplorerService,this.workspaceContextService);s.values=r,t.push(s)}if(t.length){const r=this.viewModel.helpInformation.map(a=>this.createHelpItemValue(a,"reportIssue")),s=this.items?.find(a=>a.icon===f.reportIssuesIcon)??new Be(f.reportIssuesIcon,p.localize("remote.help.report","Report Issue"),r,this.quickInputService,this.environmentService,this.commandService,this.openerService,this.remoteExplorerService,this.workspaceContextService);s.values=r,t.push(s)}t.length&&(this.items=t)}}class ze{constructor(t,e,i,n,r,s){this.commandService=t;this.walkthroughService=e;this.extensionDescription=i;this.remoteAuthority=n;this.virtualWorkspace=r;this.urlOrCommandOrId=s}_url;_description;get description(){return this.getUrl().then(()=>this._description)}get url(){return this.getUrl()}async getUrl(){if(this._url===void 0){if(typeof this.urlOrCommandOrId=="string")if(A.parse(this.urlOrCommandOrId).authority)this._url=this.urlOrCommandOrId;else{const e=this.commandService.executeCommand(this.urlOrCommandOrId).then(n=>(this._url=n,this._url)),i=new Promise(n=>setTimeout(()=>n(""),500));this._url=await Promise.race([e,i])}else if(this.urlOrCommandOrId?.id)try{const t=`${this.extensionDescription.id}#${this.urlOrCommandOrId.id}`,e=await this.walkthroughService.getWalkthrough(t);this._description=e.title,this._url=t}catch{}}return this._url===void 0&&(this._url=""),this._url}}class G{constructor(t,e,i,n,r,s,a){this.icon=t;this.label=e;this.values=i;this.quickInputService=n;this.environmentService=r;this.remoteExplorerService=s;this.workspaceContextService=a;this.iconClasses.push(...fe.asClassNameArray(t)),this.iconClasses.push("remote-help-tree-node-item-icon")}iconClasses=[];async getActions(){return(await Promise.all(this.values.map(async t=>({label:t.extensionDescription.displayName||t.extensionDescription.identifier.value,description:await t.description??await t.url,url:await t.url,extensionDescription:t.extensionDescription})))).filter(t=>t.description)}async handleClick(){const t=this.environmentService.remoteAuthority;if(t){for(let e=0;e<this.remoteExplorerService.targetType.length;e++)if(t.startsWith(this.remoteExplorerService.targetType[e])){for(const i of this.values)if(i.remoteAuthority){for(const n of i.remoteAuthority)if(t.startsWith(n)){await this.takeAction(i.extensionDescription,await i.url);return}}}}else{const e=Ce(this.workspaceContextService.getWorkspace())?.scheme;if(e){for(let i=0;i<this.remoteExplorerService.targetType.length;i++)for(const n of this.values)if(n.virtualWorkspace&&n.remoteAuthority){for(const r of n.remoteAuthority)if(this.remoteExplorerService.targetType[i].startsWith(r)&&e.startsWith(n.virtualWorkspace)){await this.takeAction(n.extensionDescription,await n.url);return}}}}if(this.values.length>1){const e=await this.getActions();if(e.length){const i=await this.quickInputService.pick(e,{placeHolder:p.localize("pickRemoteExtension","Select url to open")});i&&await this.takeAction(i.extensionDescription,i.url)}}else await this.takeAction(this.values[0].extensionDescription,await this.values[0].url)}}class Fe extends G{constructor(e,i,n,r,s,a,u,h,g){super(e,i,n,r,s,u,h);this.openerService=a;this.commandService=g}async takeAction(e,i){if([Q.http,Q.https].includes(A.parse(i).scheme)){this.openerService.open(i,{allowCommands:!0});return}this.commandService.executeCommand("workbench.action.openWalkthrough",i)}}class se extends G{constructor(e,i,n,r,s,a,u,h){super(e,i,n,r,s,u,h);this.openerService=a}async takeAction(e,i){await this.openerService.open(A.parse(i),{allowCommands:!0})}}class Be extends G{constructor(e,i,n,r,s,a,u,h,g){super(e,i,n,r,s,h,g);this.commandService=a;this.openerService=u}async getActions(){return Promise.all(this.values.map(async e=>({label:e.extensionDescription.displayName||e.extensionDescription.identifier.value,description:"",url:await e.url,extensionDescription:e.extensionDescription})))}async takeAction(e,i){i?await this.openerService.open(A.parse(i)):await this.commandService.executeCommand("workbench.action.openIssueReporter",[e.identifier.value])}}let S=class extends He{constructor(e,i,n,r,s,a,u,h,g,N,w,l,I,v,d,D,y,T){super(i,n,r,a,s,h,u,g,v,d,D);this.viewModel=e;this.quickInputService=N;this.commandService=w;this.remoteExplorerService=l;this.environmentService=I;this.workspaceContextService=y;this.walkthroughsService=T}static ID="~remote.helpPanel";static TITLE=p.localize2("remote.help","Help and feedback");tree;renderBody(e){super.renderBody(e),e.classList.add("remote-help");const i=document.createElement("div");i.classList.add("remote-help-content"),e.appendChild(i),this.tree=this.instantiationService.createInstance(ye,"RemoteHelp",i,new Me,[new Ne],new Oe,{accessibilityProvider:{getAriaLabel:r=>r.label,getWidgetAriaLabel:()=>p.localize("remotehelp","Remote Help")}});const n=new B(this.viewModel,this.openerService,this.quickInputService,this.commandService,this.remoteExplorerService,this.environmentService,this.workspaceContextService,this.walkthroughsService);this.tree.setInput(n),this._register(de.debounce(this.tree.onDidOpen,(r,s)=>s,75,!0)(r=>{r.element?.handleClick()}))}layoutBody(e,i){super.layoutBody(e,i),this.tree.layout(e,i)}};S=x([o(2,De),o(3,j),o(4,ge),o(5,K),o(6,X),o(7,ie),o(8,ke),o(9,Y),o(10,$),o(11,oe),o(12,re),o(13,Z),o(14,z),o(15,we),o(16,ee),o(17,_e)],S);class Ge{id=S.ID;name=S.TITLE;ctorDescriptor;canToggleVisibility=!0;hideByDefault=!1;group="help@50";order=-10;constructor(t){this.ctorDescriptor=new J(S,[t])}}let _=class extends xe{constructor(e,i,n,r,s,a,u,h,g,N,w){super(W,N.onDidChangeTargetType,s,e,i,r,a,u,h,g,n,w);this.remoteExplorerService=N;this.addConstantViewDescriptors([this.helpPanelDescriptor]),this._register(this.remoteSwitcher=this.instantiationService.createInstance(Ee)),this.remoteExplorerService.onDidChangeHelpInformation(I=>{this._setHelpInformation(I)}),this._setHelpInformation(this.remoteExplorerService.helpInformation);const l=O.as(F.ViewsRegistry);this.remoteSwitcher.createOptionItems(l.getViews(this.viewContainer)),this._register(l.onViewsRegistered(I=>{const v=[];for(const d of I)d.viewContainer.id===W&&v.push(...d.views);v.length>0&&this.remoteSwitcher.createOptionItems(v)})),this._register(l.onViewsDeregistered(I=>{I.viewContainer.id===W&&this.remoteSwitcher.removeOptionItems(I.views)}))}helpPanelDescriptor=new Ge(this);helpInformation=[];_onDidChangeHelpInformation=new he;onDidChangeHelpInformation=this._onDidChangeHelpInformation.event;hasRegisteredHelpView=!1;remoteSwitcher;_setHelpInformation(e){const i=[];for(const r of e)this._handleRemoteInfoExtensionPoint(r,i);this.helpInformation=i,this._onDidChangeHelpInformation.fire();const n=O.as(F.ViewsRegistry);this.helpInformation.length&&!this.hasRegisteredHelpView?(n.getView(this.helpPanelDescriptor.id)||n.registerViews([this.helpPanelDescriptor],this.viewContainer),this.hasRegisteredHelpView=!0):this.hasRegisteredHelpView&&(n.deregisterViews([this.helpPanelDescriptor],this.viewContainer),this.hasRegisteredHelpView=!1)}_handleRemoteInfoExtensionPoint(e,i){Ae(e.description,"contribRemoteHelp")&&(!e.value.documentation&&!e.value.getStarted&&!e.value.issues||i.push({extensionDescription:e.description,getStarted:e.value.getStarted,documentation:e.value.documentation,reportIssue:e.value.reportIssue,issues:e.value.issues,remoteName:e.value.remoteName,virtualWorkspace:e.value.virtualWorkspace}))}getFilterOn(e){return U(e.remoteAuthority)?e.remoteAuthority[0]:e.remoteAuthority}setFilter(e){this.remoteExplorerService.targetType=U(e.remoteAuthority)?e.remoteAuthority:[e.remoteAuthority]}getTitle(){return p.localize("remote.explorer","Remote Explorer")}};_=x([o(0,We),o(1,z),o(2,ee),o(3,Re),o(4,K),o(5,X),o(6,Z),o(7,j),o(8,Ve),o(9,oe),o(10,ie)],_),O.as(F.ViewContainersRegistry).registerViewContainer({id:W,title:p.localize2("remote.explorer","Remote Explorer"),ctorDescriptor:new J(_),hideIfEmpty:!0,viewOrderDelegate:{getOrder:m=>{if(!m)return;let t=/^targets@(\d+)$/.exec(m);if(t)return-1e3;if(t=/^details(@(\d+))?$/.exec(m),t)return-500+Number(t[2]);if(t=/^help(@(\d+))?$/.exec(m),t)return-10}},icon:f.remoteExplorerViewIcon,order:4},Pe.Sidebar);let L=class{constructor(t,e){t.getEnvironment().then(i=>{i&&e.setPerformanceMarks("server",i.marks)})}};L=x([o(0,ne),o(1,Le)],L);class qe{location;_isDisposed;_lastReport;_currentProgressPromiseResolve;_currentProgress;_currentTimer;get lastReport(){return this._lastReport}constructor(t,e,i,n,r){this.location=e,this._isDisposed=!1,this._lastReport=i,this._currentProgressPromiseResolve=null,this._currentProgress=null,this._currentTimer=null;const s=new Promise(a=>this._currentProgressPromiseResolve=a);t.withProgress({location:e,buttons:n},a=>(this._isDisposed||(this._currentProgress=a),s),a=>r(a,this._lastReport)),this._lastReport&&this.report()}dispose(){this._isDisposed=!0,this._currentProgressPromiseResolve&&(this._currentProgressPromiseResolve(),this._currentProgressPromiseResolve=null),this._currentProgress=null,this._currentTimer&&(this._currentTimer.dispose(),this._currentTimer=null)}report(t){t&&(this._lastReport=t),this._lastReport&&this._currentProgress&&this._currentProgress.report({message:this._lastReport})}startTimer(t){this.stopTimer(),this._currentTimer=new Qe(this,t)}stopTimer(){this._currentTimer&&(this._currentTimer.dispose(),this._currentTimer=null)}}class Qe{_parent;_completionTime;_renderInterval;constructor(t,e){this._parent=t,this._completionTime=e,this._renderInterval=b.disposableWindowInterval(ue,()=>this._render(),1e3),this._render()}dispose(){this._renderInterval.dispose()}_render(){const t=this._completionTime-Date.now();if(t<0)return;const e=Math.ceil(t/1e3);e===1?this._parent.report(p.localize("reconnectionWaitOne","Attempting to reconnect in {0} second...",e)):this._parent.report(p.localize("reconnectionWaitMany","Attempting to reconnect in {0} seconds...",e))}}const ae=40*1e3;let M=class extends Ie{_reloadWindowShown=!1;constructor(t,e,i,n,r,s,a,u){super();const h=t.getConnection();if(h){let d=function(c,k,ce=null){return l&&(l.dispose(),l=null),c||(c=w?R.Notification:R.Dialog),new qe(e,c,ce,k.map(H=>H.label),(H,le)=>{typeof H<"u"&&k[H]?k[H].callback():c===R.Dialog?l=d(R.Notification,k,le):D()})},D=function(){l&&(l.dispose(),l=null)};var g=d,N=D;let w=!1;this._register(r.onShow(()=>w=!0)),this._register(r.onHide(()=>w=!1));let l=null,I=null,v=null,y="",T=0,C=0;const q={label:p.localize("reconnectNow","Reconnect Now"),callback:()=>{I?.skipWait()}},V={label:p.localize("reloadWindow","Reload Window"),callback:()=>{u.publicLog2("remoteReconnectionReload",{remoteName:E(a.remoteAuthority),reconnectionToken:y,millisSinceLastIncomingData:Date.now()-T,attempt:C}),n.executeCommand(te.ID)}};h.onDidStateChange(c=>{switch(l?.stopTimer(),v&&(v.dispose(),v=null),c.type){case P.ConnectionLost:y=c.reconnectionToken,T=Date.now()-c.millisSinceLastIncomingData,C=0,u.publicLog2("remoteConnectionLost",{remoteName:E(a.remoteAuthority),reconnectionToken:c.reconnectionToken}),(l||c.millisSinceLastIncomingData>ae)&&(l||(l=d(null,[q,V])),l.report(p.localize("connectionLost","Connection Lost")));break;case P.ReconnectionWait:l&&(I=c,l=d(null,[q,V]),l.startTimer(Date.now()+1e3*c.durationSeconds));break;case P.ReconnectionRunning:y=c.reconnectionToken,T=Date.now()-c.millisSinceLastIncomingData,C=c.attempt,u.publicLog2("remoteReconnectionRunning",{remoteName:E(a.remoteAuthority),reconnectionToken:c.reconnectionToken,millisSinceLastIncomingData:c.millisSinceLastIncomingData,attempt:c.attempt}),(l||c.millisSinceLastIncomingData>ae)&&(l=d(null,[V]),l.report(p.localize("reconnectionRunning","Disconnected. Attempting to reconnect...")),v=r.onShow(()=>{l&&l.location===R.Dialog&&(l=d(R.Notification,[V],l.lastReport))}));break;case P.ReconnectionPermanentFailure:y=c.reconnectionToken,T=Date.now()-c.millisSinceLastIncomingData,C=c.attempt,u.publicLog2("remoteReconnectionPermanentFailure",{remoteName:E(a.remoteAuthority),reconnectionToken:c.reconnectionToken,millisSinceLastIncomingData:c.millisSinceLastIncomingData,attempt:c.attempt,handled:c.handled}),D(),c.handled?(s.info("Error handled: Not showing a notification for the error."),console.log("Error handled: Not showing a notification for the error.")):this._reloadWindowShown||(this._reloadWindowShown=!0,i.confirm({type:ve.Error,message:p.localize("reconnectionPermanentFailure","Cannot reconnect. Please reload the window."),primaryButton:p.localize({key:"reloadWindow.dialog",comment:["&& denotes a mnemonic"]},"&&Reload Window")}).then(k=>{k.confirmed&&n.executeCommand(te.ID)}));break;case P.ConnectionGain:y=c.reconnectionToken,T=Date.now()-c.millisSinceLastIncomingData,C=c.attempt,u.publicLog2("remoteConnectionGain",{remoteName:E(a.remoteAuthority),reconnectionToken:c.reconnectionToken,millisSinceLastIncomingData:c.millisSinceLastIncomingData,attempt:c.attempt}),D();break}})}}};M=x([o(0,ne),o(1,be),o(2,Se),o(3,$),o(4,Y),o(5,Te),o(6,re),o(7,z)],M);export{M as RemoteAgentConnectionStatusListener,L as RemoteMarkers};
