import{deepStrictEqual as u,strictEqual as a}from"assert";import{importAMDNodeModule as B}from"../../../../../../amdX.js";import{isSafari as E}from"../../../../../../base/browser/browser.js";import{Color as R,RGBA as S}from"../../../../../../base/common/color.js";import{Emitter as o}from"../../../../../../base/common/event.js";import{ensureNoDisposablesAreLeakedInTestSuite as I}from"../../../../../../base/test/common/utils.js";import"../../../../../../editor/common/config/editorOptions.js";import{TestConfigurationService as A}from"../../../../../../platform/configuration/test/common/testConfigurationService.js";import"../../../../../../platform/instantiation/test/common/instantiationServiceMock.js";import{TerminalCapabilityStore as c}from"../../../../../../platform/terminal/common/capabilities/terminalCapabilityStore.js";import{IThemeService as y}from"../../../../../../platform/theme/common/themeService.js";import{TestColorTheme as f}from"../../../../../../platform/theme/test/common/testThemeService.js";import{PANEL_BACKGROUND as L,SIDE_BAR_BACKGROUND as O}from"../../../../../common/theme.js";import{ViewContainerLocation as k}from"../../../../../common/views.js";import{XtermTerminal as g}from"../../../browser/xterm/xtermTerminal.js";import{TERMINAL_VIEW_ID as _}from"../../../common/terminal.js";import{registerColors as D,TERMINAL_BACKGROUND_COLOR as h,TERMINAL_CURSOR_BACKGROUND_COLOR as w,TERMINAL_CURSOR_FOREGROUND_COLOR as C,TERMINAL_FOREGROUND_COLOR as p,TERMINAL_INACTIVE_SELECTION_BACKGROUND_COLOR as v,TERMINAL_SELECTION_BACKGROUND_COLOR as T,TERMINAL_SELECTION_FOREGROUND_COLOR as b}from"../../../common/terminalColorRegistry.js";import{workbenchInstantiationService as N}from"../../../../../test/browser/workbenchTestServices.js";D();class e{static shouldThrow=!1;static isEnabled=!1;onChangeTextureAtlas=new o().event;onAddTextureAtlasCanvas=new o().event;onRemoveTextureAtlasCanvas=new o().event;onContextLoss=new o().event;activate(){if(e.isEnabled=!e.shouldThrow,e.shouldThrow)throw new Error("Test webgl set to throw")}dispose(){e.isEnabled=!1}clearTextureAtlas(){}}class M extends g{webglAddonPromise=Promise.resolve(e);_getWebglAddonConstructor(){return this.webglAddonPromise}}class oe{_location=k.Panel;_onDidChangeLocation=new o;onDidChangeLocation=this._onDidChangeLocation.event;getViewLocationById(n){return this._location}moveTerminalToLocation(n){const i=this._location;this._location=n,this._onDidChangeLocation.fire({views:[{id:_}],from:i,to:n})}}const d={fontFamily:"monospace",fontWeight:"normal",fontWeightBold:"normal",gpuAcceleration:"off",scrollback:1e3,fastScrollSensitivity:2,mouseWheelScrollSensitivity:1,unicodeVersion:"6"};suite("XtermTerminal",()=>{const r=I();let n,i,l,t,s;setup(async()=>{i=new A({editor:{fastScrollSensitivity:2,mouseWheelScrollSensitivity:1},files:{},terminal:{integrated:d}}),n=N({configurationService:()=>i},r),l=n.get(y),s=(await B("@xterm/xterm","lib/xterm.js")).Terminal;const m=r.add(new c);t=r.add(n.createInstance(M,s,80,30,{getBackgroundColor:()=>{}},m,"",!0)),e.shouldThrow=!1,e.isEnabled=!1}),test("should use fallback dimensions of 80x30",()=>{a(t.raw.cols,80),a(t.raw.rows,30)}),suite("theme",()=>{test("should apply correct background color based on getBackgroundColor",()=>{l.setTheme(new f({[L]:"#ff0000",[O]:"#00ff00"})),t=r.add(n.createInstance(g,s,80,30,{getBackgroundColor:()=>new R(new S(255,0,0))},r.add(new c),"",!0)),a(t.raw.options.theme?.background,"#ff0000")}),test("should react to and apply theme changes",()=>{l.setTheme(new f({[h]:"#000100",[p]:"#000200",[C]:"#000300",[w]:"#000400",[T]:"#000500",[v]:"#000600",[b]:void 0,"terminal.ansiBlack":"#010000","terminal.ansiRed":"#020000","terminal.ansiGreen":"#030000","terminal.ansiYellow":"#040000","terminal.ansiBlue":"#050000","terminal.ansiMagenta":"#060000","terminal.ansiCyan":"#070000","terminal.ansiWhite":"#080000","terminal.ansiBrightBlack":"#090000","terminal.ansiBrightRed":"#100000","terminal.ansiBrightGreen":"#110000","terminal.ansiBrightYellow":"#120000","terminal.ansiBrightBlue":"#130000","terminal.ansiBrightMagenta":"#140000","terminal.ansiBrightCyan":"#150000","terminal.ansiBrightWhite":"#160000"})),t=r.add(n.createInstance(g,s,80,30,{getBackgroundColor:()=>{}},r.add(new c),"",!0)),u(t.raw.options.theme,{background:void 0,foreground:"#000200",cursor:"#000300",cursorAccent:"#000400",selectionBackground:"#000500",selectionInactiveBackground:"#000600",selectionForeground:void 0,overviewRulerBorder:void 0,scrollbarSliderActiveBackground:void 0,scrollbarSliderBackground:void 0,scrollbarSliderHoverBackground:void 0,black:"#010000",green:"#030000",red:"#020000",yellow:"#040000",blue:"#050000",magenta:"#060000",cyan:"#070000",white:"#080000",brightBlack:"#090000",brightRed:"#100000",brightGreen:"#110000",brightYellow:"#120000",brightBlue:"#130000",brightMagenta:"#140000",brightCyan:"#150000",brightWhite:"#160000"}),l.setTheme(new f({[h]:"#00010f",[p]:"#00020f",[C]:"#00030f",[w]:"#00040f",[T]:"#00050f",[v]:"#00060f",[b]:"#00070f","terminal.ansiBlack":"#01000f","terminal.ansiRed":"#02000f","terminal.ansiGreen":"#03000f","terminal.ansiYellow":"#04000f","terminal.ansiBlue":"#05000f","terminal.ansiMagenta":"#06000f","terminal.ansiCyan":"#07000f","terminal.ansiWhite":"#08000f","terminal.ansiBrightBlack":"#09000f","terminal.ansiBrightRed":"#10000f","terminal.ansiBrightGreen":"#11000f","terminal.ansiBrightYellow":"#12000f","terminal.ansiBrightBlue":"#13000f","terminal.ansiBrightMagenta":"#14000f","terminal.ansiBrightCyan":"#15000f","terminal.ansiBrightWhite":"#16000f"})),u(t.raw.options.theme,{background:void 0,foreground:"#00020f",cursor:"#00030f",cursorAccent:"#00040f",selectionBackground:"#00050f",selectionInactiveBackground:"#00060f",selectionForeground:"#00070f",overviewRulerBorder:void 0,scrollbarSliderActiveBackground:void 0,scrollbarSliderBackground:void 0,scrollbarSliderHoverBackground:void 0,black:"#01000f",green:"#03000f",red:"#02000f",yellow:"#04000f",blue:"#05000f",magenta:"#06000f",cyan:"#07000f",white:"#08000f",brightBlack:"#09000f",brightRed:"#10000f",brightGreen:"#11000f",brightYellow:"#12000f",brightBlue:"#13000f",brightMagenta:"#14000f",brightCyan:"#15000f",brightWhite:"#16000f"})})}),suite("renderers",()=>{test.skip("should re-evaluate gpu acceleration auto when the setting is changed",async()=>{a(e.isEnabled,!1);const m=document.createElement("div");t.attachToElement(m),await i.setUserConfiguration("terminal",{integrated:{...d,gpuAcceleration:"auto"}}),i.onDidChangeConfigurationEmitter.fire({affectsConfiguration:()=>!0}),await t.webglAddonPromise,E?a(e.isEnabled,!1,"The webgl renderer is always disabled on Safari"):a(e.isEnabled,!0),await i.setUserConfiguration("terminal",{integrated:{...d,gpuAcceleration:"off"}}),i.onDidChangeConfigurationEmitter.fire({affectsConfiguration:()=>!0}),await t.webglAddonPromise,a(e.isEnabled,!1),e.shouldThrow=!0,await i.setUserConfiguration("terminal",{integrated:{...d,gpuAcceleration:"auto"}}),i.onDidChangeConfigurationEmitter.fire({affectsConfiguration:()=>!0}),await t.webglAddonPromise,a(e.isEnabled,!1)})})});export{oe as TestViewDescriptorService};
