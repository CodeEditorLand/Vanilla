var v=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var m=(s,n,e,t)=>{for(var i=t>1?void 0:t?p(n,e):n,r=s.length-1,o;r>=0;r--)(o=s[r])&&(i=(t?o(n,e,i):o(i))||i);return t&&i&&v(n,e,i),i},a=(s,n)=>(e,t)=>n(e,t,s);import{disposableWindowInterval as f,getActiveWindow as d}from"../../../../base/browser/dom.js";import{Disposable as u}from"../../../../base/common/lifecycle.js";import{URI as I}from"../../../../base/common/uri.js";import{ipcRenderer as R}from"../../../../base/parts/sandbox/electron-sandbox/globals.js";import{IFileService as _}from"../../../../platform/files/common/files.js";import{INativeHostService as S}from"../../../../platform/native/common/native.js";import"../../../../platform/window/common/window.js";import"../../../common/contributions.js";import{IRemoteAgentService as h}from"../../../services/remote/common/remoteAgentService.js";import{ITerminalService as w}from"../browser/terminal.js";import{registerRemoteContributions as F}from"./terminalRemote.js";let c=class extends u{constructor(e,t,i,r){super();this._fileService=e;this._terminalService=t;R.on("vscode:openFiles",(g,l)=>{this._onOpenFileRequest(l)}),this._register(r.onDidResumeOS(()=>this._onOsResume())),this._terminalService.setNativeDelegate({getWindowCount:()=>r.getWindowCount()});const o=i.getConnection();o&&o.remoteAuthority&&F()}_onOsResume(){for(const e of this._terminalService.instances)e.xterm?.forceRedraw()}async _onOpenFileRequest(e){if(e.termProgram==="vscode"&&e.filesToWait){const t=I.revive(e.filesToWait.waitMarkerFileUri);await this._whenFileDeleted(t),this._terminalService.activeInstance?.focus()}}_whenFileDeleted(e){return new Promise(t=>{let i=!1;const r=f(d(),async()=>{if(!i){i=!0;const o=await this._fileService.exists(e);i=!1,o||(r.dispose(),t(void 0))}},1e3)})}};c=m([a(0,_),a(1,w),a(2,h),a(3,S)],c);export{c as TerminalNativeContribution};
