import*as u from"../../../../base/common/path.js";import{OperatingSystem as d,isMacintosh as T,isWindows as p,language as _}from"../../../../base/common/platform.js";import{sanitizeProcessEnvironment as w}from"../../../../base/common/processes.js";import{isString as h}from"../../../../base/common/types.js";import{URI as L}from"../../../../base/common/uri.js";import{WindowsShellType as E}from"../../../../platform/terminal/common/terminal.js";import{escapeNonWindowsPath as g,sanitizeCwd as I}from"../../../../platform/terminal/common/terminalEnvironment.js";function v(n,e){if(e)if(p)for(const r in e){let i=r;for(const a in n)if(r.toLowerCase()===a.toLowerCase()){i=a;break}const s=e[r];s!==void 0&&P(n,i,s)}else Object.keys(e).forEach(r=>{const i=e[r];i!==void 0&&P(n,r,i)})}function P(n,e,r){typeof r=="string"?n[e]=r:delete n[e]}function N(n,e,r,i){n.TERM_PROGRAM="vscode",e&&(n.TERM_PROGRAM_VERSION=e),k(n,i)&&(n.LANG=C(r)),n.COLORTERM="truecolor"}function O(n,e){if(e)for(const r of Object.keys(e)){const i=e[r];i!=null&&(n[r]=i)}}async function S(n,e){return await Promise.all(Object.entries(e).map(async([r,i])=>{if(typeof i=="string")try{e[r]=await n(i)}catch{e[r]=i}})),e}function k(n,e){if(e==="on")return!0;if(e==="auto"){const r=n.LANG;return!r||r.search(/\.UTF-8$/)===-1&&r.search(/\.utf8$/)===-1&&r.search(/\.euc.+/)===-1}return!1}function C(n){const e=n?n.split("-"):[],r=e.length;if(r===0)return"en_US.UTF-8";if(r===1){const i={af:"ZA",am:"ET",be:"BY",bg:"BG",ca:"ES",cs:"CZ",da:"DK",de:"DE",el:"GR",en:"US",es:"ES",et:"EE",eu:"ES",fi:"FI",fr:"FR",he:"IL",hr:"HR",hu:"HU",hy:"AM",is:"IS",it:"IT",ja:"JP",kk:"KZ",ko:"KR",lt:"LT",nl:"NL",no:"NO",pl:"PL",pt:"BR",ro:"RO",ru:"RU",sk:"SK",sl:"SI",sr:"YU",sv:"SE",tr:"TR",uk:"UA",zh:"CN"};e[0]in i&&e.push(i[e[0]])}else e[1]=e[1].toUpperCase();return e.join("_")+".UTF-8"}async function A(n,e,r,i,s,a){if(n.cwd){const t=typeof n.cwd=="object"?n.cwd.fsPath:n.cwd,f=await y(t,r);return I(f||t)}let o;return!n.ignoreConfigurationCwd&&s&&(r&&(s=await y(s,r,a)),s&&(u.isAbsolute(s)?o=s:i&&(o=u.join(i.fsPath,s)))),o||(o=i?i.fsPath:e||""),I(o)}async function y(n,e,r){if(e)try{return await e(n)}catch(i){r?.error("Could not resolve terminal cwd",i);return}return n}function F(n,e,r){if(r)return i=>r.resolveWithEnvironment(e,n,i)}async function j(n,e,r,i,s,a){const o={};if(n.strictEnv)O(o,n.env);else{O(o,a);const t={...e};r&&(t&&await S(r,t),n.env&&await S(r,n.env)),T&&(o.VSCODE_NODE_OPTIONS&&(o.NODE_OPTIONS=o.VSCODE_NODE_OPTIONS,delete o.VSCODE_NODE_OPTIONS),o.VSCODE_NODE_REPL_EXTERNAL_MODULE&&(o.NODE_REPL_EXTERNAL_MODULE=o.VSCODE_NODE_REPL_EXTERNAL_MODULE,delete o.VSCODE_NODE_REPL_EXTERNAL_MODULE)),w(o,"VSCODE_IPC_HOOK_CLI"),v(o,t),v(o,n.env),N(o,i,_,s)}return o}async function M(n,e,r,i,s,a,o=p){let t;if(h(n)?t=n:(t=n.fsPath,o&&a!==d.Windows?t=t.replace(/\\/g,"/"):!o&&a===d.Windows&&(t=t.replace(/\//g,"\\"))),!e)return t;const f=t.includes(" "),R=t.includes("(")||t.includes(")"),l=u.basename(e,".exe"),m=l==="pwsh"||r==="pwsh"||l==="powershell"||r==="powershell";if(m&&(f||t.includes("'")))return`& '${t.replace(/'/g,"''")}'`;if(R&&m)return`& '${t}'`;if(a===d.Windows){if(i!==void 0)return i===E.GitBash?g(t.replace(/\\/g,"/")):i===E.Wsl?s?.getWslPath(t,"win-to-unix")||t:f?`"${t}"`:t;const c=e.toLowerCase();return c.includes("wsl")||c.includes("bash.exe")&&!c.toLowerCase().includes("git")?s?.getWslPath(t,"win-to-unix")||t:f?`"${t}"`:t}return g(t)}function K(n,e,r){const i=typeof n=="string"?L.parse(n):n;let s=i?e.getWorkspaceFolder(i)??void 0:void 0;if(!s){const a=r.getLastActiveWorkspaceRoot();s=a?e.getWorkspaceFolder(a)??void 0:void 0}return s}export{N as addTerminalEnvironmentKeys,j as createTerminalEnvironment,F as createVariableResolver,A as getCwd,C as getLangEnvVariable,K as getWorkspaceForTerminal,v as mergeEnvironments,M as preparePathForShell,k as shouldSetLangEnvVariable};
