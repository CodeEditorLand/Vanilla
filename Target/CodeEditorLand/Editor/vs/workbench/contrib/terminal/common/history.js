var R=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var E=(i,r,e,t)=>{for(var n=t>1?void 0:t?k(r,e):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(t?a(r,e,n):a(n))||n);return t&&n&&R(r,e,n),n},w=(i,r)=>(e,t)=>r(e,t,i);import{env as m}from"../../../../base/common/process.js";import{Disposable as N}from"../../../../base/common/lifecycle.js";import{LRUCache as z}from"../../../../base/common/map.js";import{IConfigurationService as M}from"../../../../platform/configuration/common/configuration.js";import{FileOperationError as K,FileOperationResult as U,IFileService as y}from"../../../../platform/files/common/files.js";import{IInstantiationService as D}from"../../../../platform/instantiation/common/instantiation.js";import{IStorageService as W,StorageScope as g,StorageTarget as F}from"../../../../platform/storage/common/storage.js";import{GeneralShellType as L,PosixShellType as H,TerminalSettingId as O}from"../../../../platform/terminal/common/terminal.js";import{URI as b}from"../../../../base/common/uri.js";import{IRemoteAgentService as v}from"../../../services/remote/common/remoteAgentService.js";import{Schemas as x}from"../../../../base/common/network.js";import{isWindows as _,OperatingSystem as T}from"../../../../base/common/platform.js";import{join as $}from"../../../../base/common/path.js";var G=(r=>(r[r.DefaultHistoryLimit=100]="DefaultHistoryLimit",r))(G||{}),B=(e=>(e.Entries="terminal.history.entries",e.Timestamp="terminal.history.timestamp",e))(B||{});let P;function Se(i){return P||(P=i.get(D).createInstance(S,"commands")),P}let C;function pe(i){return C||(C=i.get(D).createInstance(S,"dirs")),C}const I=new Map;async function ye(i,r){const e=I.get(r);if(e===null)return[];if(e!==void 0)return e;let t;switch(r){case H.Bash:t=await J(i);break;case L.PowerShell:t=await Z(i);break;case H.Zsh:t=await V(i);break;case H.Fish:t=await j(i);break;case L.Python:t=await X(i);break;default:return[]}if(t===void 0)return I.set(r,null),[];const n=Array.from(t);return I.set(r,n),n}function ve(){I.clear()}let S=class extends N{constructor(e,t,n){super();this._storageDataKey=e;this._configurationService=t;this._storageService=n;this._entries=new z(this._getHistoryLimit()),this._register(this._configurationService.onDidChangeConfiguration(o=>{o.affectsConfiguration(O.ShellIntegrationCommandHistory)&&(this._entries.limit=this._getHistoryLimit())})),this._register(this._storageService.onDidChangeValue(g.APPLICATION,this._getTimestampStorageKey(),this._store)(()=>{this._isStale||(this._isStale=this._storageService.getNumber(this._getTimestampStorageKey(),g.APPLICATION,0)!==this._timestamp)}))}_entries;_timestamp=0;_isReady=!1;_isStale=!0;get entries(){return this._ensureUpToDate(),this._entries.entries()}add(e,t){this._ensureUpToDate(),this._entries.set(e,t),this._saveState()}remove(e){this._ensureUpToDate(),this._entries.delete(e),this._saveState()}clear(){this._ensureUpToDate(),this._entries.clear(),this._saveState()}_ensureUpToDate(){this._isReady||(this._loadState(),this._isReady=!0),this._isStale&&(this._entries.clear(),this._loadState(),this._isStale=!1)}_loadState(){this._timestamp=this._storageService.getNumber(this._getTimestampStorageKey(),g.APPLICATION,0);const e=this._loadPersistedState();if(e)for(const t of e.entries)this._entries.set(t.key,t.value)}_loadPersistedState(){const e=this._storageService.get(this._getEntriesStorageKey(),g.APPLICATION);if(e===void 0||e.length===0)return;let t;try{t=JSON.parse(e)}catch{return}return t}_saveState(){const e={entries:[]};this._entries.forEach((t,n)=>e.entries.push({key:n,value:t})),this._storageService.store(this._getEntriesStorageKey(),JSON.stringify(e),g.APPLICATION,F.MACHINE),this._timestamp=Date.now(),this._storageService.store(this._getTimestampStorageKey(),this._timestamp,g.APPLICATION,F.MACHINE)}_getHistoryLimit(){const e=this._configurationService.getValue(O.ShellIntegrationCommandHistory);return typeof e=="number"?e:100}_getTimestampStorageKey(){return`terminal.history.timestamp.${this._storageDataKey}`}_getEntriesStorageKey(){return`terminal.history.entries.${this._storageDataKey}`}};S=E([w(1,M),w(2,W)],S);async function J(i){const r=i.get(y),e=i.get(v),t=await e.getEnvironment();if(t?.os===T.Windows||!t&&_)return;const n=await p(m.HOME,".bash_history",!1,r,e);if(n===void 0)return;const o=n.split(`
`),a=new Set;let l,s,d;for(let f=0;f<o.length;f++){l=o[f],s===void 0?s=l:s+=`
${l}`;for(let c=0;c<l.length;c++)d?l[c]===d&&(d=void 0):l[c].match(/['"]/)&&(d=l[c]);d===void 0&&(s.length>0&&a.add(s.trim()),s=void 0)}return a.values()}async function V(i){const r=i.get(y),e=i.get(v),t=await e.getEnvironment();if(t?.os===T.Windows||!t&&_)return;const n=await p(m.HOME,".zsh_history",!1,r,e);if(n===void 0)return;const o=n.split(/\:\s\d+\:\d+;/),a=new Set;for(let l=0;l<o.length;l++){const s=o[l].replace(/\\\n/g,`
`).trim();s.length>0&&a.add(s)}return a.values()}async function X(i){const r=i.get(y),e=i.get(v),t=await p(m.HOME,".python_history",!1,r,e);if(t===void 0)return;const n=t.split(`
`),o=new Set;return n.forEach(a=>{a.trim().length>0&&o.add(a.trim())}),o.values()}async function Z(i){const r=i.get(y),e=i.get(v);let t,n;const o=await e.getEnvironment(),a=o?.os===T.Windows||!o&&_;a?(t=m.APPDATA,n="Microsoft\\Windows\\PowerShell\\PSReadLine\\ConsoleHost_history.txt"):(t=m.HOME,n=".local/share/powershell/PSReadline/ConsoleHost_history.txt");const l=await p(t,n,a,r,e);if(l===void 0)return;const s=l.split(`
`),d=new Set;let f,c,h;for(let A=0;A<s.length;A++){if(f=s[A],c===void 0?c=f:c+=`
${f}`,!f.endsWith("`")){const u=c.trim();u.length>0&&d.add(u),c=void 0;continue}for(let u=0;u<f.length;u++)h?f[u]===h&&(h=void 0):f[u].match(/`/)&&(h=f[u]);if(h)c=c.replace(/`$/,""),h=void 0;else{const u=c.trim();u.length>0&&d.add(u),c=void 0}}return d.values()}async function j(i){const r=i.get(y),e=i.get(v),t=await e.getEnvironment();if(t?.os===T.Windows||!t&&_)return;const o=await(m.XDG_DATA_HOME?p(m.XDG_DATA_HOME,"fish/fish_history",!1,r,e):p(m.HOME,".local/share/fish/fish_history",!1,r,e));if(o===void 0)return;const a=new Set,l=o.split(`
`).filter(s=>s.startsWith("- cmd:")).map(s=>s.substring(6).trimStart());for(let s=0;s<l.length;s++){const d=q(l[s]).trim();d.length>0&&a.add(d)}return a.values()}function q(i){return Q(/(^|[^\\])((?:\\\\)*)(\\n)/g,i,`$1$2
`)}function Q(i,r,e){let t,n=r;for(;;)if(t=n,n=n.replace(i,e),n===t)return n}async function p(i,r,e,t,n){if(!i)return;const o=n.getConnection(),a=!!o?.remoteAuthority,l=b.from({scheme:a?x.vscodeRemote:x.file,authority:a?o.remoteAuthority:void 0,path:b.file($(i,r)).path});let s;try{s=await t.readFile(l)}catch(d){if(d instanceof K&&d.fileOperationResult===U.FILE_NOT_FOUND)return;throw d}if(s!==void 0)return s.value.toString()}export{S as TerminalPersistedHistory,ve as clearShellFileHistory,J as fetchBashHistory,j as fetchFishHistory,Z as fetchPwshHistory,X as fetchPythonHistory,V as fetchZshHistory,Se as getCommandHistory,pe as getDirectoryHistory,ye as getShellFileHistory,q as sanitizeFishHistoryCmd};
