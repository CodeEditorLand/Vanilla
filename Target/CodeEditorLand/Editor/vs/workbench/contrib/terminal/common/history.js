var R=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var E=(i,n,e,t)=>{for(var r=t>1?void 0:t?k(n,e):n,o=i.length-1,a;o>=0;o--)(a=i[o])&&(r=(t?a(n,e,r):a(r))||r);return t&&r&&R(n,e,r),r},w=(i,n)=>(e,t)=>n(e,t,i);import{Disposable as N}from"../../../../base/common/lifecycle.js";import{LRUCache as z}from"../../../../base/common/map.js";import{Schemas as D}from"../../../../base/common/network.js";import{join as M}from"../../../../base/common/path.js";import{OperatingSystem as _,isWindows as T}from"../../../../base/common/platform.js";import{env as h}from"../../../../base/common/process.js";import{URI as F}from"../../../../base/common/uri.js";import{IConfigurationService as K}from"../../../../platform/configuration/common/configuration.js";import{FileOperationError as U,FileOperationResult as W,IFileService as y}from"../../../../platform/files/common/files.js";import{IInstantiationService as L}from"../../../../platform/instantiation/common/instantiation.js";import{IStorageService as $,StorageScope as g,StorageTarget as O}from"../../../../platform/storage/common/storage.js";import{GeneralShellType as b,PosixShellType as H,TerminalSettingId as x}from"../../../../platform/terminal/common/terminal.js";import{IRemoteAgentService as v}from"../../../services/remote/common/remoteAgentService.js";var G=(n=>(n[n.DefaultHistoryLimit=100]="DefaultHistoryLimit",n))(G||{}),B=(e=>(e.Entries="terminal.history.entries",e.Timestamp="terminal.history.timestamp",e))(B||{});let P;function he(i){return P||(P=i.get(L).createInstance(S,"commands")),P}let C;function me(i){return C||(C=i.get(L).createInstance(S,"dirs")),C}const I=new Map;async function ge(i,n){const e=I.get(n);if(e===null)return[];if(e!==void 0)return e;let t;switch(n){case H.Bash:t=await J(i);break;case b.PowerShell:t=await Z(i);break;case H.Zsh:t=await V(i);break;case H.Fish:t=await j(i);break;case b.Python:t=await X(i);break;default:return[]}if(t===void 0)return I.set(n,null),[];const r=Array.from(t);return I.set(n,r),r}function Se(){I.clear()}let S=class extends N{constructor(e,t,r){super();this._storageDataKey=e;this._configurationService=t;this._storageService=r;this._entries=new z(this._getHistoryLimit()),this._register(this._configurationService.onDidChangeConfiguration(o=>{o.affectsConfiguration(x.ShellIntegrationCommandHistory)&&(this._entries.limit=this._getHistoryLimit())})),this._register(this._storageService.onDidChangeValue(g.APPLICATION,this._getTimestampStorageKey(),this._store)(()=>{this._isStale||(this._isStale=this._storageService.getNumber(this._getTimestampStorageKey(),g.APPLICATION,0)!==this._timestamp)}))}_entries;_timestamp=0;_isReady=!1;_isStale=!0;get entries(){return this._ensureUpToDate(),this._entries.entries()}add(e,t){this._ensureUpToDate(),this._entries.set(e,t),this._saveState()}remove(e){this._ensureUpToDate(),this._entries.delete(e),this._saveState()}clear(){this._ensureUpToDate(),this._entries.clear(),this._saveState()}_ensureUpToDate(){this._isReady||(this._loadState(),this._isReady=!0),this._isStale&&(this._entries.clear(),this._loadState(),this._isStale=!1)}_loadState(){this._timestamp=this._storageService.getNumber(this._getTimestampStorageKey(),g.APPLICATION,0);const e=this._loadPersistedState();if(e)for(const t of e.entries)this._entries.set(t.key,t.value)}_loadPersistedState(){const e=this._storageService.get(this._getEntriesStorageKey(),g.APPLICATION);if(e===void 0||e.length===0)return;let t;try{t=JSON.parse(e)}catch{return}return t}_saveState(){const e={entries:[]};this._entries.forEach((t,r)=>e.entries.push({key:r,value:t})),this._storageService.store(this._getEntriesStorageKey(),JSON.stringify(e),g.APPLICATION,O.MACHINE),this._timestamp=Date.now(),this._storageService.store(this._getTimestampStorageKey(),this._timestamp,g.APPLICATION,O.MACHINE)}_getHistoryLimit(){const e=this._configurationService.getValue(x.ShellIntegrationCommandHistory);return typeof e=="number"?e:100}_getTimestampStorageKey(){return`terminal.history.timestamp.${this._storageDataKey}`}_getEntriesStorageKey(){return`terminal.history.entries.${this._storageDataKey}`}};S=E([w(1,K),w(2,$)],S);async function J(i){const n=i.get(y),e=i.get(v),t=await e.getEnvironment();if(t?.os===_.Windows||!t&&T)return;const r=await p(h.HOME,".bash_history",!1,n,e);if(r===void 0)return;const o=r.split(`
`),a=new Set;let l,s,c;for(let f=0;f<o.length;f++){l=o[f],s===void 0?s=l:s+=`
${l}`;for(let d=0;d<l.length;d++)c?l[d]===c&&(c=void 0):l[d].match(/['"]/)&&(c=l[d]);c===void 0&&(s.length>0&&a.add(s.trim()),s=void 0)}return a.values()}async function V(i){const n=i.get(y),e=i.get(v),t=await e.getEnvironment();if(t?.os===_.Windows||!t&&T)return;const r=await p(h.HOME,".zsh_history",!1,n,e);if(r===void 0)return;const o=r.split(/:\s\d+:\d+;/),a=new Set;for(let l=0;l<o.length;l++){const s=o[l].replace(/\\\n/g,`
`).trim();s.length>0&&a.add(s)}return a.values()}async function X(i){const n=i.get(y),e=i.get(v),t=await p(h.HOME,".python_history",!1,n,e);if(t===void 0)return;const r=t.split(`
`),o=new Set;return r.forEach(a=>{a.trim().length>0&&o.add(a.trim())}),o.values()}async function Z(i){const n=i.get(y),e=i.get(v);let t,r;const o=await e.getEnvironment(),a=o?.os===_.Windows||!o&&T;a?(t=h.APPDATA,r="Microsoft\\Windows\\PowerShell\\PSReadLine\\ConsoleHost_history.txt"):(t=h.HOME,r=".local/share/powershell/PSReadline/ConsoleHost_history.txt");const l=await p(t,r,a,n,e);if(l===void 0)return;const s=l.split(`
`),c=new Set;let f,d,m;for(let A=0;A<s.length;A++){if(f=s[A],d===void 0?d=f:d+=`
${f}`,!f.endsWith("`")){const u=d.trim();u.length>0&&c.add(u),d=void 0;continue}for(let u=0;u<f.length;u++)m?f[u]===m&&(m=void 0):f[u].match(/`/)&&(m=f[u]);if(m)d=d.replace(/`$/,""),m=void 0;else{const u=d.trim();u.length>0&&c.add(u),d=void 0}}return c.values()}async function j(i){const n=i.get(y),e=i.get(v),t=await e.getEnvironment();if(t?.os===_.Windows||!t&&T)return;const o=await(h.XDG_DATA_HOME?p(h.XDG_DATA_HOME,"fish/fish_history",!1,n,e):p(h.HOME,".local/share/fish/fish_history",!1,n,e));if(o===void 0)return;const a=new Set,l=o.split(`
`).filter(s=>s.startsWith("- cmd:")).map(s=>s.substring(6).trimStart());for(let s=0;s<l.length;s++){const c=q(l[s]).trim();c.length>0&&a.add(c)}return a.values()}function q(i){return Q(/(^|[^\\])((?:\\\\)*)(\\n)/g,i,`$1$2
`)}function Q(i,n,e){let t,r=n;for(;;)if(t=r,r=r.replace(i,e),r===t)return r}async function p(i,n,e,t,r){if(!i)return;const o=r.getConnection(),a=!!o?.remoteAuthority,l=F.from({scheme:a?D.vscodeRemote:D.file,authority:a?o.remoteAuthority:void 0,path:F.file(M(i,n)).path});let s;try{s=await t.readFile(l)}catch(c){if(c instanceof U&&c.fileOperationResult===W.FILE_NOT_FOUND)return;throw c}if(s!==void 0)return s.value.toString()}export{S as TerminalPersistedHistory,Se as clearShellFileHistory,J as fetchBashHistory,j as fetchFishHistory,Z as fetchPwshHistory,X as fetchPythonHistory,V as fetchZshHistory,he as getCommandHistory,me as getDirectoryHistory,ge as getShellFileHistory,q as sanitizeFishHistoryCmd};
