var C=Object.defineProperty;var y=Object.getOwnPropertyDescriptor;var f=(l,u,e,n)=>{for(var t=n>1?void 0:n?y(u,e):u,i=l.length-1,s;i>=0;i--)(s=l[i])&&(t=(n?s(u,e,t):s(t))||t);return n&&t&&C(u,e,t),t},I=(l,u)=>(e,n)=>u(e,n,l);import"../../../../base/browser/ui/sash/sash.js";import{asArray as m}from"../../../../base/common/arrays.js";import{timeout as T}from"../../../../base/common/async.js";import{Emitter as a,Event as d}from"../../../../base/common/event.js";import{Disposable as b}from"../../../../base/common/lifecycle.js";import"../../../../base/common/uri.js";import{IContextKeyService as A}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as S}from"../../../../platform/instantiation/common/instantiation.js";import{IQuickInputService as V}from"../../../../platform/quickinput/common/quickInput.js";import"../../../../platform/terminal/common/terminal.js";import{IViewDescriptorService as O}from"../../../common/views.js";import{IViewsService as F}from"../../../services/views/common/viewsService.js";import{TERMINAL_VIEW_ID as c}from"../common/terminal.js";import{TerminalContextKeys as G}from"../common/terminalContextKey.js";import"./terminal.js";import{TerminalGroup as P}from"./terminalGroup.js";import{getInstanceFromResource as B}from"./terminalUri.js";import"./terminalView.js";let g=class extends b{constructor(e,n,t,i,s){super();this._contextKeyService=e;this._instantiationService=n;this._viewsService=t;this._viewDescriptorService=i;this._quickInputService=s;this._terminalGroupCountContextKey=G.groupCount.bindTo(this._contextKeyService),this._register(this.onDidDisposeGroup(r=>this._removeGroup(r))),this._register(this.onDidChangeGroups(()=>this._terminalGroupCountContextKey.set(this.groups.length))),this._register(d.any(this.onDidChangeActiveGroup,this.onDidChangeInstances)(()=>this.updateVisibility())),this._register(this._quickInputService.onShow(()=>this._isQuickInputOpened=!0)),this._register(this._quickInputService.onHide(()=>this._isQuickInputOpened=!1))}groups=[];activeGroupIndex=-1;get instances(){return this.groups.reduce((e,n)=>e.concat(n.terminalInstances),[])}lastAccessedMenu="inline-tab";_terminalGroupCountContextKey;_container;_isQuickInputOpened=!1;_onDidChangeActiveGroup=this._register(new a);onDidChangeActiveGroup=this._onDidChangeActiveGroup.event;_onDidDisposeGroup=this._register(new a);onDidDisposeGroup=this._onDidDisposeGroup.event;_onDidChangeGroups=this._register(new a);onDidChangeGroups=this._onDidChangeGroups.event;_onDidShow=this._register(new a);onDidShow=this._onDidShow.event;_onDidDisposeInstance=this._register(new a);onDidDisposeInstance=this._onDidDisposeInstance.event;_onDidFocusInstance=this._register(new a);onDidFocusInstance=this._onDidFocusInstance.event;_onDidChangeActiveInstance=this._register(new a);onDidChangeActiveInstance=this._onDidChangeActiveInstance.event;_onDidChangeInstances=this._register(new a);onDidChangeInstances=this._onDidChangeInstances.event;_onDidChangeInstanceCapability=this._register(new a);onDidChangeInstanceCapability=this._onDidChangeInstanceCapability.event;_onDidChangePanelOrientation=this._register(new a);onDidChangePanelOrientation=this._onDidChangePanelOrientation.event;hidePanel(){const e=this._viewDescriptorService.getViewContainerByViewId(c);e&&this._viewDescriptorService.getViewContainerModel(e).activeViewDescriptors.length===1&&(this._viewsService.closeView(c),G.tabsMouse.bindTo(this._contextKeyService).set(!1))}get activeGroup(){if(!(this.activeGroupIndex<0||this.activeGroupIndex>=this.groups.length))return this.groups[this.activeGroupIndex]}set activeGroup(e){if(e===void 0)return;const n=this.groups.findIndex(t=>t===e);this.setActiveGroupByIndex(n)}get activeInstance(){return this.activeGroup?.activeInstance}setActiveInstance(e){this.setActiveInstanceByIndex(this._getIndexFromId(e.instanceId))}_getIndexFromId(e){const n=this.instances.findIndex(t=>t.instanceId===e);if(n===-1)throw new Error(`Terminal with ID ${e} does not exist (has it already been disposed?)`);return n}setContainer(e){this._container=e,this.groups.forEach(n=>n.attachToElement(e))}async focusTabs(){if(this.instances.length===0)return;await this.showPanel(!0),this._viewsService.getActiveViewWithId(c)?.terminalTabbedView?.focusTabs()}async focusHover(){if(this.instances.length===0)return;this._viewsService.getActiveViewWithId(c)?.terminalTabbedView?.focusHover()}async focusInstance(e){return this.showPanel(!0)}async focusActiveInstance(){return this.showPanel(!0)}createGroup(e){const n=this._instantiationService.createInstance(P,this._container,e);return this.groups.push(n),n.addDisposable(d.forward(n.onPanelOrientationChanged,this._onDidChangePanelOrientation)),n.addDisposable(d.forward(n.onDidDisposeInstance,this._onDidDisposeInstance)),n.addDisposable(d.forward(n.onDidFocusInstance,this._onDidFocusInstance)),n.addDisposable(d.forward(n.onDidChangeInstanceCapability,this._onDidChangeInstanceCapability)),n.addDisposable(d.forward(n.onInstancesChanged,this._onDidChangeInstances)),n.addDisposable(d.forward(n.onDisposed,this._onDidDisposeGroup)),n.addDisposable(n.onDidChangeActiveInstance(t=>{n===this.activeGroup&&this._onDidChangeActiveInstance.fire(t)})),n.terminalInstances.length>0&&this._onDidChangeInstances.fire(),this.instances.length===1&&this.setActiveInstanceByIndex(0),this._onDidChangeGroups.fire(),n}async showPanel(e){const n=this._viewsService.getActiveViewWithId(c)??await this._viewsService.openView(c,e);if(n?.setExpanded(!0),e){await T(0);const t=this.activeInstance;t&&(n&&!n.isVisible()&&await this._viewsService.openView(c,e),await t.focusWhenReady(!0))}this._onDidShow.fire()}getInstanceFromResource(e){return B(this.instances,e)}_removeGroup(e){const n=this.activeGroup,t=e===n,i=this.groups.indexOf(e);if(i!==-1&&(this.groups.splice(i,1),this._onDidChangeGroups.fire()),t){if(this.groups.length>0&&!this._isQuickInputOpened){const s=i<this.groups.length?i:this.groups.length-1;this.setActiveGroupByIndex(s,!0),this.activeInstance?.focus(!0)}}else this.activeGroupIndex>i&&this.setActiveGroupByIndex(this.activeGroupIndex-1);this.activeGroupIndex>=this.groups.length&&this.setActiveGroupByIndex(this.groups.length-1),this._onDidChangeInstances.fire(),this._onDidChangeGroups.fire(),t&&(this._onDidChangeActiveGroup.fire(this.activeGroup),this._onDidChangeActiveInstance.fire(this.activeInstance))}setActiveGroupByIndex(e,n){if(e===-1&&this.groups.length===0){this.activeGroupIndex!==-1&&(this.activeGroupIndex=-1,this._onDidChangeActiveGroup.fire(this.activeGroup),this._onDidChangeActiveInstance.fire(this.activeInstance));return}if(e<0||e>=this.groups.length)return;const t=this.activeGroup;this.activeGroupIndex=e,(n||t!==this.activeGroup)&&(this._onDidChangeActiveGroup.fire(this.activeGroup),this._onDidChangeActiveInstance.fire(this.activeInstance))}_getInstanceLocation(e){let n=0;for(;e>=0&&n<this.groups.length;){const t=this.groups[n],i=t.terminalInstances.length;if(e<i)return{group:t,groupIndex:n,instance:t.terminalInstances[e],instanceIndex:e};e-=i,n++}}setActiveInstanceByIndex(e){const n=this.activeInstance,t=this._getInstanceLocation(e),i=t?.group.terminalInstances[t.instanceIndex];if(!t||n===i)return;const s=t.instanceIndex;this.activeGroupIndex=t.groupIndex,this._onDidChangeActiveGroup.fire(this.activeGroup),t.group.setActiveInstanceByIndex(s,!0)}setActiveGroupToNext(){if(this.groups.length<=1)return;let e=this.activeGroupIndex+1;e>=this.groups.length&&(e=0),this.setActiveGroupByIndex(e)}setActiveGroupToPrevious(){if(this.groups.length<=1)return;let e=this.activeGroupIndex-1;e<0&&(e=this.groups.length-1),this.setActiveGroupByIndex(e)}_getValidTerminalGroups=e=>new Set(e.map(n=>this.getGroupForInstance(n)).filter(n=>n!==void 0));moveGroup(e,n){e=m(e);const t=this._getValidTerminalGroups(e),i=this.getGroupForInstance(n);if(!i||t.size===0)return;if(t.size===1&&t.has(i)){const h=i.terminalInstances.indexOf(n),p=e.sort((x,w)=>i.terminalInstances.indexOf(x)-i.terminalInstances.indexOf(w)),D=i.terminalInstances.indexOf(p[0])<h?"after":"before";i.moveInstance(p,h,D),this._onDidChangeInstances.fire();return}const s=this.groups.indexOf(i),r=Array.from(t).sort((h,p)=>this.groups.indexOf(h)-this.groups.indexOf(p)),v=this.groups.indexOf(r[0])<s?"after":"before",_=v==="after"?s+1:s;this.groups.splice(_,0,...r);for(const h of r){const p=v==="after"?this.groups.indexOf(h):this.groups.lastIndexOf(h);this.groups.splice(p,1)}this._onDidChangeInstances.fire()}moveGroupToEnd(e){e=m(e);const n=this._getValidTerminalGroups(e);if(n.size===0)return;const t=this.groups.length-1,i=Array.from(n).sort((s,r)=>this.groups.indexOf(s)-this.groups.indexOf(r));this.groups.splice(t+1,0,...i);for(const s of i){const r=this.groups.indexOf(s);this.groups.splice(r,1)}this._onDidChangeInstances.fire()}moveInstance(e,n,t){const i=this.getGroupForInstance(e),s=this.getGroupForInstance(n);if(!i||!s)return;i!==s&&(i.removeInstance(e),s.addInstance(e));const r=s.terminalInstances.indexOf(n)+(t==="after"?1:0);s.moveInstance(e,r,t)}unsplitInstance(e){const n=this.getGroupForInstance(e);!n||n.terminalInstances.length<2||(n.removeInstance(e),this.createGroup(e))}joinInstances(e){const n=this.getGroupForInstance(e[0]);if(n){let r=!0;for(let o=1;o<n.terminalInstances.length;o++)if(n.terminalInstances.includes(e[o])){r=!1;break}if(!r&&n.terminalInstances.length===e.length)return}let t,i;for(const r of e){const o=this.getGroupForInstance(r);if(o?.terminalInstances.length===1){t=r,i=o;break}}i||(i=this.createGroup());const s=this.activeGroup===i;for(const r of e){if(r===t)continue;const o=this.getGroupForInstance(r);o&&(o.removeInstance(r),i.addInstance(r))}this.setActiveInstance(e[0]),this._onDidChangeInstances.fire(),s||this._onDidChangeActiveGroup.fire(this.activeGroup)}instanceIsSplit(e){const n=this.getGroupForInstance(e);return n?n.terminalInstances.length>1:!1}getGroupForInstance(e){return this.groups.find(n=>n.terminalInstances.includes(e))}getGroupLabels(){return this.groups.filter(e=>e.terminalInstances.length>0).map((e,n)=>`${n+1}: ${e.title?e.title:""}`)}updateVisibility(){const e=this._viewsService.isViewVisible(c);this.groups.forEach((n,t)=>n.setVisible(e&&t===this.activeGroupIndex))}};g=f([I(0,A),I(1,S),I(2,F),I(3,O),I(4,V)],g);export{g as TerminalGroupService};
