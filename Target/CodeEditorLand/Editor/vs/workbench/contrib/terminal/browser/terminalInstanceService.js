var y=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var I=(a,r,e,t)=>{for(var n=t>1?void 0:t?v(r,e):r,i=a.length-1,o;i>=0;i--)(o=a[i])&&(n=(t?o(r,e,n):o(n))||n);return t&&n&&y(r,e,n),n},c=(a,r)=>(e,t)=>r(e,t,a);import{promiseWithResolvers as T}from"../../../../base/common/async.js";import{Emitter as g}from"../../../../base/common/event.js";import{Disposable as f}from"../../../../base/common/lifecycle.js";import{IContextKeyService as h}from"../../../../platform/contextkey/common/contextkey.js";import{InstantiationType as k,registerSingleton as u}from"../../../../platform/instantiation/common/extensions.js";import{IInstantiationService as S}from"../../../../platform/instantiation/common/instantiation.js";import{Registry as m}from"../../../../platform/registry/common/platform.js";import{TerminalExtensions as l}from"../../../../platform/terminal/common/terminal.js";import{IWorkbenchEnvironmentService as C}from"../../../services/environment/common/environmentService.js";import{TerminalContextKeys as d}from"../common/terminalContextKey.js";import{ITerminalInstanceService as _}from"./terminal.js";import{TerminalInstance as R}from"./terminalInstance.js";let s=class extends f{constructor(e,t,n){super();this._instantiationService=e;this._contextKeyService=t;this._terminalShellTypeContextKey=d.shellType.bindTo(this._contextKeyService),this._terminalInRunCommandPicker=d.inTerminalRunCommandPicker.bindTo(this._contextKeyService);for(const i of[void 0,n.remoteAuthority]){const{promise:o,resolve:p}=T();this._backendRegistration.set(i,{promise:o,resolve:p})}}_terminalShellTypeContextKey;_terminalInRunCommandPicker;_backendRegistration=new Map;_onDidCreateInstance=this._register(new g);get onDidCreateInstance(){return this._onDidCreateInstance.event}createInstance(e,t){const n=this.convertProfileToShellLaunchConfig(e),i=this._instantiationService.createInstance(R,this._terminalShellTypeContextKey,this._terminalInRunCommandPicker,n);return i.target=t,this._onDidCreateInstance.fire(i),i}convertProfileToShellLaunchConfig(e,t){if(e&&"profileName"in e){const n=e;return n.path?{executable:n.path,args:n.args,env:n.env,icon:n.icon,color:n.color,name:n.overrideName?n.profileName:void 0,cwd:t}:e}return e?(t&&(e.cwd=t),e):{}}async getBackend(e){let t=m.as(l.Backend).getTerminalBackend(e);return t||(await this._backendRegistration.get(e)?.promise,t=m.as(l.Backend).getTerminalBackend(e)),t}getRegisteredBackends(){return m.as(l.Backend).backends.values()}didRegisterBackend(e){this._backendRegistration.get(e)?.resolve()}};s=I([c(0,S),c(1,h),c(2,C)],s),u(_,s,k.Delayed);export{s as TerminalInstanceService};
