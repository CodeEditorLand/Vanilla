var k=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var I=(f,u,e,i)=>{for(var t=i>1?void 0:i?M(u,e):u,o=f.length-1,a;o>=0;o--)(a=f[o])&&(t=(i?a(u,e,t):a(t))||t);return i&&t&&k(u,e,t),t},l=(f,u)=>(e,i)=>u(e,i,f);import*as h from"../../../../../base/browser/dom.js";import{Separator as g}from"../../../../../base/common/actions.js";import{Emitter as O}from"../../../../../base/common/event.js";import{Disposable as A,DisposableStore as S,dispose as C,toDisposable as L}from"../../../../../base/common/lifecycle.js";import{ThemeIcon as b}from"../../../../../base/common/themables.js";import{localize as n}from"../../../../../nls.js";import{AccessibilitySignal as w,IAccessibilitySignalService as x}from"../../../../../platform/accessibilitySignal/browser/accessibilitySignalService.js";import{IClipboardService as E}from"../../../../../platform/clipboard/common/clipboardService.js";import{ICommandService as P}from"../../../../../platform/commands/common/commands.js";import{IConfigurationService as H}from"../../../../../platform/configuration/common/configuration.js";import{IContextMenuService as N}from"../../../../../platform/contextview/browser/contextView.js";import{IInstantiationService as V}from"../../../../../platform/instantiation/common/instantiation.js";import{INotificationService as G,Severity as Q}from"../../../../../platform/notification/common/notification.js";import{IOpenerService as q}from"../../../../../platform/opener/common/opener.js";import{IQuickInputService as U}from"../../../../../platform/quickinput/common/quickInput.js";import{CommandInvalidationReason as R,TerminalCapability as p}from"../../../../../platform/terminal/common/capabilities/capabilities.js";import{TerminalSettingId as v}from"../../../../../platform/terminal/common/terminal.js";import{IThemeService as z}from"../../../../../platform/theme/common/themeService.js";import{terminalDecorationError as B,terminalDecorationIncomplete as F,terminalDecorationMark as K,terminalDecorationSuccess as j}from"../terminalIcons.js";import{DecorationSelector as c,TerminalDecorationHoverManager as W,updateLayout as y}from"./decorationStyles.js";import{TERMINAL_COMMAND_DECORATION_DEFAULT_BACKGROUND_COLOR as $,TERMINAL_COMMAND_DECORATION_ERROR_BACKGROUND_COLOR as X,TERMINAL_COMMAND_DECORATION_SUCCESS_BACKGROUND_COLOR as J}from"../../common/terminalColorRegistry.js";import{ILifecycleService as Y}from"../../../../services/lifecycle/common/lifecycle.js";let D=class extends A{constructor(e,i,t,o,a,r,s,_,d,T,Z,ee){super();this._capabilities=e;this._clipboardService=i;this._contextMenuService=t;this._configurationService=o;this._themeService=a;this._openerService=r;this._quickInputService=s;this._commandService=d;this._accessibilitySignalService=Z;this._notificationService=ee;this._register(L(()=>this._dispose())),this._register(this._configurationService.onDidChangeConfiguration(m=>{m.affectsConfiguration(v.FontSize)||m.affectsConfiguration(v.LineHeight)?this.refreshLayouts():m.affectsConfiguration("workbench.colorCustomizations")?this._refreshStyles(!0):m.affectsConfiguration(v.ShellIntegrationDecorationsEnabled)&&(this._removeCapabilityDisposables(p.CommandDetection),this._updateDecorationVisibility())})),this._register(this._themeService.onDidColorThemeChange(()=>this._refreshStyles(!0))),this._updateDecorationVisibility(),this._register(this._capabilities.onDidAddCapabilityType(m=>this._createCapabilityDisposables(m))),this._register(this._capabilities.onDidRemoveCapabilityType(m=>this._removeCapabilityDisposables(m))),this._register(_.onWillShutdown(()=>this._disposeAllDecorations())),this._terminalDecorationHoverManager=this._register(T.createInstance(W))}_terminal;_capabilityDisposables=new Map;_decorations=new Map;_placeholderDecoration;_showGutterDecorations;_showOverviewRulerDecorations;_terminalDecorationHoverManager;_onDidRequestRunCommand=this._register(new O);onDidRequestRunCommand=this._onDidRequestRunCommand.event;_removeCapabilityDisposables(e){const i=this._capabilityDisposables.get(e);i&&C(i),this._capabilityDisposables.delete(e)}_createCapabilityDisposables(e){const i=new S,t=this._capabilities.get(e);if(!(!t||this._capabilityDisposables.has(e))){switch(t.type){case p.BufferMarkDetection:i.add(t.onMarkAdded(o=>this.registerMarkDecoration(o)));break;case p.CommandDetection:{const o=this._getCommandDetectionListeners(t);for(const a of o)i.add(a);break}}this._capabilityDisposables.set(e,i)}}registerMarkDecoration(e){if(!(!this._terminal||!this._showGutterDecorations&&!this._showOverviewRulerDecorations)&&!e.hidden)return this.registerCommandDecoration(void 0,void 0,e)}_updateDecorationVisibility(){const e=this._configurationService.getValue(v.ShellIntegrationDecorationsEnabled);this._showGutterDecorations=e==="both"||e==="gutter",this._showOverviewRulerDecorations=e==="both"||e==="overviewRuler",this._disposeAllDecorations(),(this._showGutterDecorations||this._showOverviewRulerDecorations)&&(this._attachToCommandCapability(),this._updateGutterDecorationVisibility());const i=this._capabilities.get(p.CommandDetection)?.executingCommandObject;i&&this.registerCommandDecoration(i,!0)}_disposeAllDecorations(){this._placeholderDecoration?.dispose();for(const e of this._decorations.values())e.decoration.dispose(),C(e.disposables)}_updateGutterDecorationVisibility(){const e=this._terminal?.element?.querySelectorAll(c.CommandDecoration);if(e)for(const i of e)this._updateCommandDecorationVisibility(i)}_updateCommandDecorationVisibility(e){this._showGutterDecorations?e.classList.remove(c.Hide):e.classList.add(c.Hide)}refreshLayouts(){y(this._configurationService,this._placeholderDecoration?.element);for(const e of this._decorations)y(this._configurationService,e[1].decoration.element)}_refreshStyles(e){if(e)for(const i of this._decorations.values()){const t=this._getDecorationCssColor(i)?.toString()??"";i.decoration.options?.overviewRulerOptions?i.decoration.options.overviewRulerOptions.color=t:i.decoration.options&&(i.decoration.options.overviewRulerOptions={color:t})}this._updateClasses(this._placeholderDecoration?.element);for(const i of this._decorations.values())this._updateClasses(i.decoration.element,i.exitCode,i.markProperties)}_dispose(){this._terminalDecorationHoverManager.dispose();for(const e of this._capabilityDisposables.values())C(e);this.clearDecorations()}_clearPlaceholder(){this._placeholderDecoration?.dispose(),this._placeholderDecoration=void 0}clearDecorations(){this._placeholderDecoration?.marker.dispose(),this._clearPlaceholder(),this._disposeAllDecorations(),this._decorations.clear()}_attachToCommandCapability(){if(this._capabilities.has(p.CommandDetection)){const e=this._capabilities.get(p.CommandDetection),i=this._getCommandDetectionListeners(e),t=new S;for(const o of i)t.add(o);this._capabilityDisposables.set(p.CommandDetection,t)}}_getCommandDetectionListeners(e){if(this._capabilityDisposables.has(p.CommandDetection)){const t=this._capabilityDisposables.get(p.CommandDetection);C(t),this._capabilityDisposables.delete(e.type)}const i=[];e.executingCommandObject?.marker&&this.registerCommandDecoration(e.executingCommandObject,!0),i.push(e.onCommandStarted(t=>this.registerCommandDecoration(t,!0)));for(const t of e.commands)this.registerCommandDecoration(t);return i.push(e.onCommandFinished(t=>{this.registerCommandDecoration(t),t.exitCode?this._accessibilitySignalService.playSignal(w.terminalCommandFailed):this._accessibilitySignalService.playSignal(w.terminalCommandSucceeded)})),i.push(e.onCommandInvalidated(t=>{for(const o of t){const a=o.marker?.id;if(a){const r=this._decorations.get(a);r&&(r.decoration.dispose(),C(r.disposables))}}})),i.push(e.onCurrentCommandInvalidated(t=>{t.reason===R.NoProblemsReported?Array.from(this._decorations.entries())[this._decorations.size-1]?.[1].decoration.dispose():t.reason===R.Windows&&this._clearPlaceholder()})),i}activate(e){this._terminal=e,this._attachToCommandCapability()}registerCommandDecoration(e,i,t){if(!this._terminal||i&&!e||!this._showGutterDecorations&&!this._showOverviewRulerDecorations)return;const o=e?.marker||t?.marker;if(!o)throw new Error(`cannot add a decoration for a command ${JSON.stringify(e)} with no marker`);this._clearPlaceholder();const a=this._getDecorationCssColor(e)?.toString()??"",r=this._terminal.registerDecoration({marker:o,overviewRulerOptions:this._showOverviewRulerDecorations?i?{color:a,position:"left"}:{color:a,position:e?.exitCode?"right":"left"}:void 0});if(r)return i&&(this._placeholderDecoration=r),r.onRender(s=>{s.classList.contains(c.OverviewRuler)||(this._decorations.get(r.marker.id)||(r.onDispose(()=>this._decorations.delete(r.marker.id)),this._decorations.set(r.marker.id,{decoration:r,disposables:this._createDisposables(s,e,t),exitCode:e?.exitCode,markProperties:e?.markProperties})),(!s.classList.contains(c.Codicon)||e?.marker?.line===0)&&(y(this._configurationService,s),this._updateClasses(s,e?.exitCode,e?.markProperties||t)))}),r}_createDisposables(e,i,t){return i?.exitCode===void 0&&!i?.markProperties?[]:i?.markProperties||t?[this._terminalDecorationHoverManager.createHover(e,i||t,t?.hoverMessage)]:[...this._createContextMenu(e,i),this._terminalDecorationHoverManager.createHover(e,i)]}_updateClasses(e,i,t){if(e){for(const o of e.classList)e.classList.remove(o);e.classList.add(c.CommandDecoration,c.Codicon,c.XtermDecoration),t?(e.classList.add(c.DefaultColor,...b.asClassNameArray(K)),t.hoverMessage||e.classList.add(c.Default)):(this._updateCommandDecorationVisibility(e),i===void 0?(e.classList.add(c.DefaultColor,c.Default),e.classList.add(...b.asClassNameArray(F))):i?(e.classList.add(c.ErrorColor),e.classList.add(...b.asClassNameArray(B))):e.classList.add(...b.asClassNameArray(j)))}}_createContextMenu(e,i){return[h.addDisposableListener(e,h.EventType.MOUSE_DOWN,async t=>{t.stopImmediatePropagation()}),h.addDisposableListener(e,h.EventType.CLICK,async t=>{t.stopImmediatePropagation(),this._terminalDecorationHoverManager.hideHover();const o=await this._getCommandActions(i);this._contextMenuService.showContextMenu({getAnchor:()=>e,getActions:()=>o})}),h.addDisposableListener(e,h.EventType.CONTEXT_MENU,async t=>{t.stopImmediatePropagation(),this._terminalDecorationHoverManager.hideHover();const o=this._getContextMenuActions();this._contextMenuService.showContextMenu({getAnchor:()=>e,getActions:()=>o})})]}_getContextMenuActions(){const e=n("workbench.action.terminal.toggleVisibility","Toggle Visibility");return[{class:void 0,tooltip:e,id:"terminal.toggleVisibility",label:e,enabled:!0,run:async()=>{this._showToggleVisibilityQuickPick()}}]}async _getCommandActions(e){const i=[];if(e.command!==""){const r=n("terminal.rerunCommand","Rerun Command");i.push({class:void 0,tooltip:r,id:"terminal.rerunCommand",label:r,enabled:!0,run:async()=>{e.command!==""&&(!e.isTrusted&&!await new Promise(d=>{this._notificationService.prompt(Q.Info,n("rerun","Do you want to run the command: {0}",e.command),[{label:n("yes","Yes"),run:()=>d(!0)},{label:n("no","No"),run:()=>d(!1)}])})||this._onDidRequestRunCommand.fire({command:e}))}}),i.push(new g);const s=n("terminal.copyCommand","Copy Command");i.push({class:void 0,tooltip:s,id:"terminal.copyCommand",label:s,enabled:!0,run:()=>this._clipboardService.writeText(e.command)})}if(e.hasOutput()){const r=n("terminal.copyCommandAndOutput","Copy Command and Output");i.push({class:void 0,tooltip:r,id:"terminal.copyCommandAndOutput",label:r,enabled:!0,run:()=>{const d=e.getOutput();typeof d=="string"&&this._clipboardService.writeText(`${e.command!==""?e.command+`
`:""}${d}`)}});const s=n("terminal.copyOutput","Copy Output");i.push({class:void 0,tooltip:s,id:"terminal.copyOutput",label:s,enabled:!0,run:()=>{const d=e.getOutput();typeof d=="string"&&this._clipboardService.writeText(d)}});const _=n("terminal.copyOutputAsHtml","Copy Output as HTML");i.push({class:void 0,tooltip:_,id:"terminal.copyOutputAsHtml",label:_,enabled:!0,run:()=>this._onDidRequestRunCommand.fire({command:e,copyAsHtml:!0})})}i.length>0&&i.push(new g);const t=n("workbench.action.terminal.runRecentCommand","Run Recent Command");i.push({class:void 0,tooltip:t,id:"workbench.action.terminal.runRecentCommand",label:t,enabled:!0,run:()=>this._commandService.executeCommand("workbench.action.terminal.runRecentCommand")});const o=n("workbench.action.terminal.goToRecentDirectory","Go To Recent Directory");i.push({class:void 0,tooltip:t,id:"workbench.action.terminal.goToRecentDirectory",label:o,enabled:!0,run:()=>this._commandService.executeCommand("workbench.action.terminal.goToRecentDirectory")}),i.push(new g);const a=n("terminal.learnShellIntegration","Learn About Shell Integration");return i.push({class:void 0,tooltip:a,id:"terminal.learnShellIntegration",label:a,enabled:!0,run:()=>this._openerService.open("https://code.visualstudio.com/docs/terminal/shell-integration")}),i}_showToggleVisibilityQuickPick(){const e=this._register(this._quickInputService.createQuickPick());e.hideInput=!0,e.hideCheckAll=!0,e.canSelectMany=!0,e.title=n("toggleVisibility","Toggle visibility");const i=this._configurationService.getValue(v.ShellIntegrationDecorationsEnabled),t={label:n("gutter","Gutter command decorations"),picked:i!=="never"&&i!=="overviewRuler"},o={label:n("overviewRuler","Overview ruler command decorations"),picked:i!=="never"&&i!=="gutter"};e.items=[t,o];const a=[];i!=="never"&&(i!=="gutter"&&a.push(t),i!=="overviewRuler"&&a.push(o)),e.selectedItems=a,this._register(e.onDidChangeSelection(async r=>{let s="never";r.includes(t)?r.includes(o)?s="both":s="gutter":r.includes(o)&&(s="overviewRuler"),await this._configurationService.updateValue(v.ShellIntegrationDecorationsEnabled,s)})),e.ok=!1,e.show()}_getDecorationCssColor(e){let i;return e?.exitCode===void 0?i=$:i=e.exitCode?X:J,this._themeService.getColorTheme().getColor(i)?.toString()}};D=I([l(1,E),l(2,N),l(3,H),l(4,z),l(5,q),l(6,U),l(7,Y),l(8,P),l(9,V),l(10,x),l(11,G)],D);export{D as DecorationAddon};
