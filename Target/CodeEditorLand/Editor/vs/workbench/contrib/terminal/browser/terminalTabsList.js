var te=Object.defineProperty;var ie=Object.getOwnPropertyDescriptor;var g=(v,r,t,e)=>{for(var i=e>1?void 0:e?ie(r,t):r,o=v.length-1,s;o>=0;o--)(s=v[o])&&(i=(e?s(r,t,i):s(i))||i);return e&&i&&te(r,t,i),i},l=(v,r)=>(t,e)=>r(t,e,v);import{DataTransfers as H}from"../../../../base/browser/dnd.js";import*as h from"../../../../base/browser/dom.js";import{ActionBar as re}from"../../../../base/browser/ui/actionbar/actionbar.js";import{HoverPosition as P}from"../../../../base/browser/ui/hover/hoverWidget.js";import{InputBox as ne,MessageType as E}from"../../../../base/browser/ui/inputbox/inputBox.js";import{ListDragOverEffectPosition as oe,ListDragOverEffectType as se}from"../../../../base/browser/ui/list/list.js";import{ElementsDragAndDropData as M,NativeDragAndDropData as ae}from"../../../../base/browser/ui/list/listView.js";import{Action as O}from"../../../../base/common/actions.js";import{disposableTimeout as le}from"../../../../base/common/async.js";import{Codicon as K}from"../../../../base/common/codicons.js";import{Emitter as ce}from"../../../../base/common/event.js";import{createSingleCallFunction as me}from"../../../../base/common/functional.js";import{KeyCode as W}from"../../../../base/common/keyCodes.js";import{Disposable as w,DisposableStore as de,dispose as k,toDisposable as V}from"../../../../base/common/lifecycle.js";import{Schemas as pe}from"../../../../base/common/network.js";import A from"../../../../base/common/severity.js";import{ThemeIcon as N}from"../../../../base/common/themables.js";import{URI as R}from"../../../../base/common/uri.js";import{localize as S}from"../../../../nls.js";import{MenuEntryActionViewItem as ue}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{MenuItemAction as he}from"../../../../platform/actions/common/actions.js";import{IConfigurationService as U}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as fe}from"../../../../platform/contextkey/common/contextkey.js";import{IContextViewService as ve}from"../../../../platform/contextview/browser/contextView.js";import{CodeDataTransfers as $,containsDragType as j}from"../../../../platform/dnd/browser/dnd.js";import{IHoverService as q}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as J}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as Ie}from"../../../../platform/keybinding/common/keybinding.js";import{IListService as Y,WorkbenchList as ge}from"../../../../platform/list/browser/listService.js";import{TerminalLocation as Se,TerminalSettingId as ye}from"../../../../platform/terminal/common/terminal.js";import{defaultInputBoxStyles as _e}from"../../../../platform/theme/browser/defaultStyles.js";import{IThemeService as G}from"../../../../platform/theme/common/themeService.js";import{DEFAULT_LABELS_CONTAINER as be,ResourceLabels as Te}from"../../../browser/labels.js";import{IDecorationsService as De}from"../../../services/decorations/common/decorations.js";import{IHostService as Ce}from"../../../services/host/browser/host.js";import{ILifecycleService as Ee}from"../../../services/lifecycle/common/lifecycle.js";import{TerminalCommandId as X}from"../common/terminal.js";import{TerminalContextKeys as Q}from"../common/terminalContextKey.js";import{terminalStrings as Z}from"../common/terminalStrings.js";import{ITerminalConfigurationService as we,ITerminalGroupService as x,ITerminalService as F,TerminalDataTransfers as B}from"./terminal.js";import{TerminalContextActionRunner as Ae}from"./terminalContextMenu.js";import{getColorClass as xe,getIconId as Fe,getUriClasses as Le}from"./terminalIcon.js";import{getColorForSeverity as He}from"./terminalStatusList.js";import{getInstanceHoverInfo as z}from"./terminalTooltip.js";import{getTerminalResourcesFromDragEvent as ke,parseTerminalUri as Re}from"./terminalUri.js";const ee=h.$;var Ge=(n=>(n[n.TabHeight=22]="TabHeight",n[n.NarrowViewWidth=46]="NarrowViewWidth",n[n.WideViewMinimumWidth=80]="WideViewMinimumWidth",n[n.DefaultWidth=120]="DefaultWidth",n[n.MidpointViewWidth=63]="MidpointViewWidth",n[n.ActionbarMinimumWidth=105]="ActionbarMinimumWidth",n[n.MaximumWidth=500]="MaximumWidth",n))(Ge||{});let L=class extends ge{constructor(t,e,i,o,s,n,p,c,m,d,u,D){super("TerminalTabsList",t,{getHeight:()=>22,getTemplateId:()=>"terminal.tabs"},[c.createInstance(y,t,c.createInstance(Te,be),()=>this.getSelectedElements())],{horizontalScrolling:!1,supportDynamicHeights:!1,selectionNavigation:!0,identityProvider:{getId:a=>a?.instanceId},accessibilityProvider:c.createInstance(_),smoothScrolling:s.getValue("workbench.list.smoothScrolling"),multipleSelectionSupport:!0,paddingBottom:22,dnd:c.createInstance(b),openOnSingleClick:!0},e,i,s,c);this._configurationService=s;this._terminalService=n;this._terminalGroupService=p;this._themeService=d;this._hoverService=D;const I=[this._terminalGroupService.onDidChangeInstances(()=>this.refresh()),this._terminalGroupService.onDidChangeGroups(()=>this.refresh()),this._terminalGroupService.onDidShow(()=>this.refresh()),this._terminalGroupService.onDidChangeInstanceCapability(()=>this.refresh()),this._terminalService.onAnyInstanceTitleChange(()=>this.refresh()),this._terminalService.onAnyInstanceIconChange(()=>this.refresh()),this._terminalService.onAnyInstancePrimaryStatusChange(()=>this.refresh()),this._terminalService.onDidChangeConnectionState(()=>this.refresh()),this._themeService.onDidColorThemeChange(()=>this.refresh()),this._terminalGroupService.onDidChangeActiveInstance(a=>{if(a){const f=this._terminalGroupService.instances.indexOf(a);this.setSelection([f]),this.reveal(f)}this.refresh()})];this.disposables.add(u.onWillShutdown(a=>{k(I),I.length=0})),this.disposables.add(V(()=>{k(I),I.length=0})),this.disposables.add(this.onMouseDblClick(async a=>{if(this.getFocus().length===0){const C=await this._terminalService.createTerminal({location:Se.Panel});this._terminalGroupService.setActiveInstance(C),await C.focusWhenReady()}this._terminalService.getEditingTerminal()?.instanceId!==a.element?.instanceId&&this._getFocusMode()==="doubleClick"&&this.getFocus().length===1&&a.element?.focus(!0)})),this.disposables.add(this.onMouseClick(async a=>{this._terminalService.getEditingTerminal()?.instanceId!==a.element?.instanceId&&(a.browserEvent.altKey&&a.element?await this._terminalService.createTerminal({location:{parentTerminal:a.element}}):this._getFocusMode()==="singleClick"&&this.getSelection().length<=1&&a.element?.focus(!0))})),this.disposables.add(this.onContextMenu(a=>{if(!a.element){this.setSelection([]);return}const f=this.getSelectedElements();(!f||!f.find(C=>a.element===C))&&this.setFocus(a.index!==void 0?[a.index]:[])})),this._terminalTabsSingleSelectedContextKey=Q.tabsSingularSelection.bindTo(e),this._isSplitContextKey=Q.splitTerminal.bindTo(e),this.disposables.add(this.onDidChangeSelection(a=>this._updateContextKey())),this.disposables.add(this.onDidChangeFocus(()=>this._updateContextKey())),this.disposables.add(this.onDidOpen(async a=>{const f=a.element;f&&(this._terminalGroupService.setActiveInstance(f),a.editorOptions.preserveFocus||await f.focusWhenReady())})),this._decorationsProvider||(this._decorationsProvider=this.disposables.add(c.createInstance(T)),this.disposables.add(m.registerDecorationsProvider(this._decorationsProvider))),this.refresh()}_decorationsProvider;_terminalTabsSingleSelectedContextKey;_isSplitContextKey;_getFocusMode(){return this._configurationService.getValue(ye.TabsFocusMode)}refresh(t=!0){t&&this._terminalService.isEditable(void 0)&&this.domFocus(),this.splice(0,this.length,this._terminalGroupService.instances.slice())}focusHover(){const t=this.getSelectedElements()[0];t&&this._hoverService.showHover({...z(t),target:this.getHTMLElement(),trapFocus:!0},!0)}_updateContextKey(){this._terminalTabsSingleSelectedContextKey.set(this.getSelectedElements().length===1);const t=this.getFocusedElements();this._isSplitContextKey.set(t.length>0&&this._terminalGroupService.instanceIsSplit(t[0]))}};L=g([l(1,fe),l(2,Y),l(3,G),l(4,U),l(5,F),l(6,x),l(7,J),l(8,De),l(9,G),l(10,Ee),l(11,q)],L);let y=class{constructor(r,t,e,i,o,s,n,p,c,m,d,u,D){this._container=r;this._labels=t;this._getSelection=e;this._instantiationService=i;this._terminalConfigurationService=o;this._terminalService=s;this._terminalGroupService=n;this._hoverService=p;this._configurationService=c;this._keybindingService=m;this._listService=d;this._themeService=u;this._contextViewService=D}templateId="terminal.tabs";renderTemplate(r){const t=h.append(r,ee(".terminal-tabs-entry")),e={},i=this._labels.create(t,{supportHighlights:!0,supportDescriptionHighlights:!0,supportIcons:!0,hoverDelegate:{delay:this._configurationService.getValue("workbench.hover.delay"),showHover:n=>this._hoverService.showHover({...n,actions:e.hoverActions,target:t,persistence:{hideOnHover:!0},appearance:{showPointer:!0},position:{hoverPosition:this._terminalConfigurationService.config.tabs.location==="left"?P.RIGHT:P.LEFT}})}}),o=h.append(i.element,ee(".actions")),s=new re(o,{actionRunner:new Ae,actionViewItemProvider:(n,p)=>n instanceof he?this._instantiationService.createInstance(ue,n,{hoverDelegate:p.hoverDelegate}):void 0});return{element:t,label:i,actionBar:s,context:e,elementDisposables:new de}}shouldHideText(){return this._container?this._container.clientWidth<63:!1}shouldHideActionBar(){return this._container?this._container.clientWidth<=105:!1}renderElement(r,t,e){const i=!this.shouldHideText(),o=this._terminalGroupService.getGroupForInstance(r);if(!o)throw new Error(`Could not find group for instance "${r.instanceId}"`);e.element.classList.toggle("has-text",i),e.element.classList.toggle("is-active",this._terminalGroupService.activeInstance===r);let s="";if(o.terminalInstances.length>1){const a=o.terminalInstances.indexOf(r);a===0?s="\u250C ":a===o.terminalInstances.length-1?s="\u2514 ":s="\u251C "}const n=z(r);e.context.hoverActions=n.actions;const p=this._instantiationService.invokeFunction(Fe,r),c=!this.shouldHideActionBar();let m="";if(i)this.fillActionBar(r,e),m=s,r.icon&&(m+=`$(${p}) ${r.title}`);else{const a=r.statusList.primary;a&&a.severity>A.Ignore?m=`${s}$(${a.icon?.id||p})`:m=`${s}$(${p})`}c||e.actionBar.clear(),e.elementDisposables.add(h.addDisposableListener(e.element,h.EventType.AUXCLICK,a=>{a.stopImmediatePropagation(),a.button===1&&this._terminalService.safeDisposeTerminal(r)}));const d=[],u=xe(r);u&&d.push(u);const D=Le(r,this._themeService.getColorTheme().type);D&&d.push(...D),e.label.setResource({resource:r.resource,name:m,description:i?r.description:void 0},{fileDecorations:{colors:!0,badges:i},title:{markdown:n.content,markdownNotSupportedFallback:void 0},extraClasses:d});const I=this._terminalService.getEditableData(r);e.label.element.classList.toggle("editable-tab",!!I),I&&(e.elementDisposables.add(this._renderInputBox(e.label.element.querySelector(".monaco-icon-label-container"),r,I)),e.actionBar.clear())}_renderInputBox(r,t,e){const i=t.title||"",o=new ne(r,this._contextViewService,{validationOptions:{validation:c=>{const m=e.validationMessage(c);return!m||m.severity!==A.Error?null:{content:m.content,formatContent:!0,type:E.ERROR}}},ariaLabel:S("terminalInputAriaLabel","Type terminal name. Press Enter to confirm or Escape to cancel."),inputBoxStyles:_e});o.element.style.height="22px",o.value=i,o.focus(),o.select({start:0,end:i.length});const s=me((c,m)=>{o.element.style.display="none";const d=o.value;k(p),o.element.remove(),m&&e.onFinish(d,c)}),n=()=>{if(o.isInputValid()){const c=e.validationMessage(o.value);c?o.showMessage({content:c.content,formatContent:!0,type:c.severity===A.Info?E.INFO:c.severity===A.Warning?E.WARNING:E.ERROR}):o.hideMessage()}};n();const p=[o,h.addStandardDisposableListener(o.inputElement,h.EventType.KEY_DOWN,c=>{c.stopPropagation(),c.equals(W.Enter)?s(o.isInputValid(),!0):c.equals(W.Escape)&&s(!1,!0)}),h.addStandardDisposableListener(o.inputElement,h.EventType.KEY_UP,c=>{n()}),h.addDisposableListener(o.inputElement,h.EventType.BLUR,()=>{s(o.isInputValid(),!0)})];return V(()=>{s(!1,!1)})}disposeElement(r,t,e){e.elementDisposables.clear(),e.actionBar.clear()}disposeTemplate(r){r.elementDisposables.dispose(),r.label.dispose(),r.actionBar.dispose()}fillActionBar(r,t){const e=[new O(X.SplitActiveTab,Z.split.short,N.asClassName(K.splitHorizontal),!0,async()=>{this._runForSelectionOrInstance(r,async i=>{this._terminalService.createTerminal({location:{parentTerminal:i}})})}),new O(X.KillActiveTab,Z.kill.short,N.asClassName(K.trashcan),!0,async()=>{this._runForSelectionOrInstance(r,i=>this._terminalService.safeDisposeTerminal(i))})];t.actionBar.clear();for(const i of e)t.actionBar.push(i,{icon:!0,label:!1,keybinding:this._keybindingService.lookupKeybinding(i.id)?.getLabel()})}_runForSelectionOrInstance(r,t){const e=this._getSelection();if(e.includes(r))for(const i of e)i&&t(i);else t(r);this._terminalGroupService.focusTabs(),this._listService.lastFocusedList?.focusNext()}};y=g([l(3,J),l(4,we),l(5,F),l(6,x),l(7,q),l(8,U),l(9,Ie),l(10,Y),l(11,G),l(12,ve)],y);let _=class{constructor(r){this._terminalGroupService=r}getWidgetAriaLabel(){return S("terminal.tabs","Terminal tabs")}getAriaLabel(r){let t="";const e=this._terminalGroupService.getGroupForInstance(r);if(e&&e.terminalInstances?.length>1){const i=e.terminalInstances.indexOf(r);t=S({key:"splitTerminalAriaLabel",comment:["The terminal's ID","The terminal's title","The terminal's split number","The terminal group's total split number"]},"Terminal {0} {1}, split {2} of {3}",r.instanceId,r.title,i+1,e.terminalInstances.length)}else t=S({key:"terminalAriaLabel",comment:["The terminal's ID","The terminal's title"]},"Terminal {0} {1}",r.instanceId,r.title);return t}};_=g([l(0,x)],_);let b=class extends w{constructor(t,e,i){super();this._terminalService=t;this._terminalGroupService=e;this._hostService=i;this._primaryBackend=this._terminalService.getPrimaryBackend()}_autoFocusInstance;_autoFocusDisposable=w.None;_primaryBackend;getDragURI(t){return this._terminalService.getEditingTerminal()?.instanceId===t.instanceId?null:t.resource.toString()}getDragLabel(t,e){return t.length===1?t[0].title:void 0}onDragLeave(){this._autoFocusInstance=void 0,this._autoFocusDisposable.dispose(),this._autoFocusDisposable=w.None}onDragStart(t,e){if(!e.dataTransfer)return;const i=t.getData();if(!Array.isArray(i))return;const o=i.filter(s=>"instanceId"in s);o.length>0&&e.dataTransfer.setData(B.Terminals,JSON.stringify(o.map(s=>s.resource.toString())))}onDragOver(t,e,i,o,s){if(t instanceof ae&&!j(s,H.FILES,H.RESOURCES,B.Terminals,$.FILES))return!1;const n=this._autoFocusInstance!==e;return n&&(this._autoFocusDisposable.dispose(),this._autoFocusInstance=e),!e&&!j(s,B.Terminals)?t instanceof M:(n&&e&&(this._autoFocusDisposable=le(()=>{this._terminalService.setActiveInstance(e),this._autoFocusInstance=void 0},500,this._store)),{feedback:i?[i]:void 0,accept:!0,effect:{type:se.Move,position:oe.Over}})}async drop(t,e,i,o,s){this._autoFocusDisposable.dispose(),this._autoFocusInstance=void 0;let n;const p=[],c=ke(s);if(c)for(const m of c){const d=this._terminalService.getInstanceFromResource(m);if(d)Array.isArray(n)?n.push(d):n=[d],this._terminalService.moveToTerminalView(d);else if(this._primaryBackend){const u=Re(m);u.instanceId&&p.push(this._primaryBackend.requestDetachInstance(u.workspaceId,u.instanceId))}}if(p.length){let m=await Promise.all(p);m=m.filter(u=>u!==void 0);let d;for(const u of m)d=await this._terminalService.createTerminal({config:{attachPersistentProcess:u}});d&&this._terminalService.setActiveInstance(d);return}if(n===void 0){if(!(t instanceof M)){this._handleExternalDrop(e,s);return}const m=t.getData();if(!m||!Array.isArray(m))return;n=[];for(const d of m)"instanceId"in d&&n.push(d)}if(!e){this._terminalGroupService.moveGroupToEnd(n),this._terminalService.setActiveInstance(n[0]);return}this._terminalGroupService.moveGroup(n,e),this._terminalService.setActiveInstance(n[0])}async _handleExternalDrop(t,e){if(!t||!e.dataTransfer)return;let i;const o=e.dataTransfer.getData(H.RESOURCES);o&&(i=R.parse(JSON.parse(o)[0]));const s=e.dataTransfer.getData($.FILES);!i&&s&&(i=R.file(JSON.parse(s)[0])),!i&&e.dataTransfer.files.length>0&&this._hostService.getPathForFile(e.dataTransfer.files[0])&&(i=R.file(this._hostService.getPathForFile(e.dataTransfer.files[0]))),i&&(this._terminalService.setActiveInstance(t),t.focus(),await t.sendPath(i,!1))}};b=g([l(0,F),l(1,x),l(2,Ce)],b);let T=class extends w{constructor(t){super();this._terminalService=t;this._register(this._terminalService.onAnyInstancePrimaryStatusChange(e=>this._onDidChange.fire([e.resource])))}label=S("label","Terminal");_onDidChange=this._register(new ce);onDidChange=this._onDidChange.event;provideDecorations(t){if(t.scheme!==pe.vscodeTerminal)return;const e=this._terminalService.getInstanceFromResource(t);if(!e)return;const i=e?.statusList?.primary;if(i?.icon)return{color:He(i.severity),letter:i.icon,tooltip:i.tooltip}}};T=g([l(0,F)],T);export{L as TerminalTabList,Ge as TerminalTabsListSizes};
