var te=Object.defineProperty;var ie=Object.getOwnPropertyDescriptor;var S=(I,r,t,e)=>{for(var i=e>1?void 0:e?ie(r,t):r,o=I.length-1,s;o>=0;o--)(s=I[o])&&(i=(e?s(r,t,i):s(i))||i);return e&&i&&te(r,t,i),i},l=(I,r)=>(t,e)=>r(t,e,I);import{IListService as G,WorkbenchList as re}from"../../../../platform/list/browser/listService.js";import"../../../../base/browser/ui/list/listWidget.js";import{IConfigurationService as M}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as ne}from"../../../../platform/contextkey/common/contextkey.js";import{IKeybindingService as oe}from"../../../../platform/keybinding/common/keybinding.js";import{IThemeService as H}from"../../../../platform/theme/common/themeService.js";import{ThemeIcon as P}from"../../../../base/common/themables.js";import{ITerminalConfigurationService as se,ITerminalGroupService as E,ITerminalService as x,TerminalDataTransfers as R}from"./terminal.js";import{localize as _}from"../../../../nls.js";import*as f from"../../../../base/browser/dom.js";import{IInstantiationService as K}from"../../../../platform/instantiation/common/instantiation.js";import{ActionBar as ae}from"../../../../base/browser/ui/actionbar/actionbar.js";import{MenuItemAction as le}from"../../../../platform/actions/common/actions.js";import{MenuEntryActionViewItem as ce}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{TerminalCommandId as V}from"../common/terminal.js";import{TerminalLocation as me,TerminalSettingId as de}from"../../../../platform/terminal/common/terminal.js";import{Codicon as W}from"../../../../base/common/codicons.js";import{Action as N}from"../../../../base/common/actions.js";import{DEFAULT_LABELS_CONTAINER as ue,ResourceLabels as pe}from"../../../browser/labels.js";import{IDecorationsService as he}from"../../../services/decorations/common/decorations.js";import{IHoverService as U}from"../../../../platform/hover/browser/hover.js";import A from"../../../../base/common/severity.js";import{Disposable as F,DisposableStore as fe,dispose as k,toDisposable as $}from"../../../../base/common/lifecycle.js";import{ListDragOverEffectPosition as ve,ListDragOverEffectType as Ie}from"../../../../base/browser/ui/list/list.js";import{DataTransfers as B}from"../../../../base/browser/dnd.js";import{disposableTimeout as ge}from"../../../../base/common/async.js";import{ElementsDragAndDropData as q,NativeDragAndDropData as Se}from"../../../../base/browser/ui/list/listView.js";import{URI as O}from"../../../../base/common/uri.js";import{getColorClass as _e,getIconId as ye,getUriClasses as be}from"./terminalIcon.js";import"../../../common/views.js";import{IContextViewService as Te}from"../../../../platform/contextview/browser/contextView.js";import{InputBox as De,MessageType as w}from"../../../../base/browser/ui/inputbox/inputBox.js";import{createSingleCallFunction as Ce}from"../../../../base/common/functional.js";import"../../../../base/browser/keyboardEvent.js";import{KeyCode as J}from"../../../../base/common/keyCodes.js";import{CodeDataTransfers as Y,containsDragType as j}from"../../../../platform/dnd/browser/dnd.js";import{terminalStrings as X}from"../common/terminalStrings.js";import{ILifecycleService as Ee}from"../../../services/lifecycle/common/lifecycle.js";import"../../../../platform/terminal/common/terminalProcess.js";import{TerminalContextKeys as Q}from"../common/terminalContextKey.js";import{getTerminalResourcesFromDragEvent as xe,parseTerminalUri as Ae}from"./terminalUri.js";import{getInstanceHoverInfo as Z}from"./terminalTooltip.js";import{defaultInputBoxStyles as Fe}from"../../../../platform/theme/browser/defaultStyles.js";import{Emitter as we}from"../../../../base/common/event.js";import{Schemas as Le}from"../../../../base/common/network.js";import{getColorForSeverity as Ge}from"./terminalStatusList.js";import{TerminalContextActionRunner as He}from"./terminalContextMenu.js";import{IHostService as Re}from"../../../services/host/browser/host.js";import{HoverPosition as z}from"../../../../base/browser/ui/hover/hoverWidget.js";const ee=f.$;var ke=(n=>(n[n.TabHeight=22]="TabHeight",n[n.NarrowViewWidth=46]="NarrowViewWidth",n[n.WideViewMinimumWidth=80]="WideViewMinimumWidth",n[n.DefaultWidth=120]="DefaultWidth",n[n.MidpointViewWidth=63]="MidpointViewWidth",n[n.ActionbarMinimumWidth=105]="ActionbarMinimumWidth",n[n.MaximumWidth=500]="MaximumWidth",n))(ke||{});let L=class extends re{constructor(t,e,i,o,s,n,p,c,u,m,d,h){super("TerminalTabsList",t,{getHeight:()=>22,getTemplateId:()=>"terminal.tabs"},[c.createInstance(y,t,c.createInstance(pe,ue),()=>this.getSelectedElements())],{horizontalScrolling:!1,supportDynamicHeights:!1,selectionNavigation:!0,identityProvider:{getId:a=>a?.instanceId},accessibilityProvider:c.createInstance(b),smoothScrolling:s.getValue("workbench.list.smoothScrolling"),multipleSelectionSupport:!0,paddingBottom:22,dnd:c.createInstance(T),openOnSingleClick:!0},e,i,s,c);this._configurationService=s;this._terminalService=n;this._terminalGroupService=p;this._themeService=m;this._hoverService=h;const g=[this._terminalGroupService.onDidChangeInstances(()=>this.refresh()),this._terminalGroupService.onDidChangeGroups(()=>this.refresh()),this._terminalGroupService.onDidShow(()=>this.refresh()),this._terminalGroupService.onDidChangeInstanceCapability(()=>this.refresh()),this._terminalService.onAnyInstanceTitleChange(()=>this.refresh()),this._terminalService.onAnyInstanceIconChange(()=>this.refresh()),this._terminalService.onAnyInstancePrimaryStatusChange(()=>this.refresh()),this._terminalService.onDidChangeConnectionState(()=>this.refresh()),this._themeService.onDidColorThemeChange(()=>this.refresh()),this._terminalGroupService.onDidChangeActiveInstance(a=>{if(a){const v=this._terminalGroupService.instances.indexOf(a);this.setSelection([v]),this.reveal(v)}this.refresh()})];this.disposables.add(d.onWillShutdown(a=>{k(g),g.length=0})),this.disposables.add($(()=>{k(g),g.length=0})),this.disposables.add(this.onMouseDblClick(async a=>{if(this.getFocus().length===0){const C=await this._terminalService.createTerminal({location:me.Panel});this._terminalGroupService.setActiveInstance(C),await C.focusWhenReady()}this._terminalService.getEditingTerminal()?.instanceId!==a.element?.instanceId&&this._getFocusMode()==="doubleClick"&&this.getFocus().length===1&&a.element?.focus(!0)})),this.disposables.add(this.onMouseClick(async a=>{this._terminalService.getEditingTerminal()?.instanceId!==a.element?.instanceId&&(a.browserEvent.altKey&&a.element?await this._terminalService.createTerminal({location:{parentTerminal:a.element}}):this._getFocusMode()==="singleClick"&&this.getSelection().length<=1&&a.element?.focus(!0))})),this.disposables.add(this.onContextMenu(a=>{if(!a.element){this.setSelection([]);return}const v=this.getSelectedElements();(!v||!v.find(C=>a.element===C))&&this.setFocus(a.index!==void 0?[a.index]:[])})),this._terminalTabsSingleSelectedContextKey=Q.tabsSingularSelection.bindTo(e),this._isSplitContextKey=Q.splitTerminal.bindTo(e),this.disposables.add(this.onDidChangeSelection(a=>this._updateContextKey())),this.disposables.add(this.onDidChangeFocus(()=>this._updateContextKey())),this.disposables.add(this.onDidOpen(async a=>{const v=a.element;v&&(this._terminalGroupService.setActiveInstance(v),a.editorOptions.preserveFocus||await v.focusWhenReady())})),this._decorationsProvider||(this._decorationsProvider=this.disposables.add(c.createInstance(D)),this.disposables.add(u.registerDecorationsProvider(this._decorationsProvider))),this.refresh()}_decorationsProvider;_terminalTabsSingleSelectedContextKey;_isSplitContextKey;_getFocusMode(){return this._configurationService.getValue(de.TabsFocusMode)}refresh(t=!0){t&&this._terminalService.isEditable(void 0)&&this.domFocus(),this.splice(0,this.length,this._terminalGroupService.instances.slice())}focusHover(){const t=this.getSelectedElements()[0];t&&this._hoverService.showHover({...Z(t),target:this.getHTMLElement(),trapFocus:!0},!0)}_updateContextKey(){this._terminalTabsSingleSelectedContextKey.set(this.getSelectedElements().length===1);const t=this.getFocusedElements();this._isSplitContextKey.set(t.length>0&&this._terminalGroupService.instanceIsSplit(t[0]))}};L=S([l(1,ne),l(2,G),l(3,H),l(4,M),l(5,x),l(6,E),l(7,K),l(8,he),l(9,H),l(10,Ee),l(11,U)],L);let y=class{constructor(r,t,e,i,o,s,n,p,c,u,m,d,h){this._container=r;this._labels=t;this._getSelection=e;this._instantiationService=i;this._terminalConfigurationService=o;this._terminalService=s;this._terminalGroupService=n;this._hoverService=p;this._configurationService=c;this._keybindingService=u;this._listService=m;this._themeService=d;this._contextViewService=h}templateId="terminal.tabs";renderTemplate(r){const t=f.append(r,ee(".terminal-tabs-entry")),e={},i=this._labels.create(t,{supportHighlights:!0,supportDescriptionHighlights:!0,supportIcons:!0,hoverDelegate:{delay:this._configurationService.getValue("workbench.hover.delay"),showHover:n=>this._hoverService.showHover({...n,actions:e.hoverActions,target:t,persistence:{hideOnHover:!0},appearance:{showPointer:!0},position:{hoverPosition:this._terminalConfigurationService.config.tabs.location==="left"?z.RIGHT:z.LEFT}})}}),o=f.append(i.element,ee(".actions")),s=new ae(o,{actionRunner:new He,actionViewItemProvider:(n,p)=>n instanceof le?this._instantiationService.createInstance(ce,n,{hoverDelegate:p.hoverDelegate}):void 0});return{element:t,label:i,actionBar:s,context:e,elementDisposables:new fe}}shouldHideText(){return this._container?this._container.clientWidth<63:!1}shouldHideActionBar(){return this._container?this._container.clientWidth<=105:!1}renderElement(r,t,e){const i=!this.shouldHideText(),o=this._terminalGroupService.getGroupForInstance(r);if(!o)throw new Error(`Could not find group for instance "${r.instanceId}"`);e.element.classList.toggle("has-text",i),e.element.classList.toggle("is-active",this._terminalGroupService.activeInstance===r);let s="";if(o.terminalInstances.length>1){const a=o.terminalInstances.indexOf(r);a===0?s="\u250C ":a===o.terminalInstances.length-1?s="\u2514 ":s="\u251C "}const n=Z(r);e.context.hoverActions=n.actions;const p=this._instantiationService.invokeFunction(ye,r),c=!this.shouldHideActionBar();let u="";if(i)this.fillActionBar(r,e),u=s,r.icon&&(u+=`$(${p}) ${r.title}`);else{const a=r.statusList.primary;a&&a.severity>A.Ignore?u=`${s}$(${a.icon?.id||p})`:u=`${s}$(${p})`}c||e.actionBar.clear(),e.elementDisposables.add(f.addDisposableListener(e.element,f.EventType.AUXCLICK,a=>{a.stopImmediatePropagation(),a.button===1&&this._terminalService.safeDisposeTerminal(r)}));const m=[],d=_e(r);d&&m.push(d);const h=be(r,this._themeService.getColorTheme().type);h&&m.push(...h),e.label.setResource({resource:r.resource,name:u,description:i?r.description:void 0},{fileDecorations:{colors:!0,badges:i},title:{markdown:n.content,markdownNotSupportedFallback:void 0},extraClasses:m});const g=this._terminalService.getEditableData(r);e.label.element.classList.toggle("editable-tab",!!g),g&&(e.elementDisposables.add(this._renderInputBox(e.label.element.querySelector(".monaco-icon-label-container"),r,g)),e.actionBar.clear())}_renderInputBox(r,t,e){const i=t.title||"",o=new De(r,this._contextViewService,{validationOptions:{validation:c=>{const u=e.validationMessage(c);return!u||u.severity!==A.Error?null:{content:u.content,formatContent:!0,type:w.ERROR}}},ariaLabel:_("terminalInputAriaLabel","Type terminal name. Press Enter to confirm or Escape to cancel."),inputBoxStyles:Fe});o.element.style.height="22px",o.value=i,o.focus(),o.select({start:0,end:i.length});const s=Ce((c,u)=>{o.element.style.display="none";const m=o.value;k(p),o.element.remove(),u&&e.onFinish(m,c)}),n=()=>{if(o.isInputValid()){const c=e.validationMessage(o.value);c?o.showMessage({content:c.content,formatContent:!0,type:c.severity===A.Info?w.INFO:c.severity===A.Warning?w.WARNING:w.ERROR}):o.hideMessage()}};n();const p=[o,f.addStandardDisposableListener(o.inputElement,f.EventType.KEY_DOWN,c=>{c.stopPropagation(),c.equals(J.Enter)?s(o.isInputValid(),!0):c.equals(J.Escape)&&s(!1,!0)}),f.addStandardDisposableListener(o.inputElement,f.EventType.KEY_UP,c=>{n()}),f.addDisposableListener(o.inputElement,f.EventType.BLUR,()=>{s(o.isInputValid(),!0)})];return $(()=>{s(!1,!1)})}disposeElement(r,t,e){e.elementDisposables.clear(),e.actionBar.clear()}disposeTemplate(r){r.elementDisposables.dispose(),r.label.dispose(),r.actionBar.dispose()}fillActionBar(r,t){const e=[new N(V.SplitActiveTab,X.split.short,P.asClassName(W.splitHorizontal),!0,async()=>{this._runForSelectionOrInstance(r,async i=>{this._terminalService.createTerminal({location:{parentTerminal:i}})})}),new N(V.KillActiveTab,X.kill.short,P.asClassName(W.trashcan),!0,async()=>{this._runForSelectionOrInstance(r,i=>this._terminalService.safeDisposeTerminal(i))})];t.actionBar.clear();for(const i of e)t.actionBar.push(i,{icon:!0,label:!1,keybinding:this._keybindingService.lookupKeybinding(i.id)?.getLabel()})}_runForSelectionOrInstance(r,t){const e=this._getSelection();if(e.includes(r))for(const i of e)i&&t(i);else t(r);this._terminalGroupService.focusTabs(),this._listService.lastFocusedList?.focusNext()}};y=S([l(3,K),l(4,se),l(5,x),l(6,E),l(7,U),l(8,M),l(9,oe),l(10,G),l(11,H),l(12,Te)],y);let b=class{constructor(r){this._terminalGroupService=r}getWidgetAriaLabel(){return _("terminal.tabs","Terminal tabs")}getAriaLabel(r){let t="";const e=this._terminalGroupService.getGroupForInstance(r);if(e&&e.terminalInstances?.length>1){const i=e.terminalInstances.indexOf(r);t=_({key:"splitTerminalAriaLabel",comment:["The terminal's ID","The terminal's title","The terminal's split number","The terminal group's total split number"]},"Terminal {0} {1}, split {2} of {3}",r.instanceId,r.title,i+1,e.terminalInstances.length)}else t=_({key:"terminalAriaLabel",comment:["The terminal's ID","The terminal's title"]},"Terminal {0} {1}",r.instanceId,r.title);return t}};b=S([l(0,E)],b);let T=class extends F{constructor(t,e,i,o){super();this._terminalService=t;this._terminalGroupService=e;this._hostService=i;this._listService=o;this._primaryBackend=this._terminalService.getPrimaryBackend()}_autoFocusInstance;_autoFocusDisposable=F.None;_primaryBackend;getDragURI(t){return this._terminalService.getEditingTerminal()?.instanceId===t.instanceId?null:t.resource.toString()}getDragLabel(t,e){return t.length===1?t[0].title:void 0}onDragLeave(){this._autoFocusInstance=void 0,this._autoFocusDisposable.dispose(),this._autoFocusDisposable=F.None}onDragStart(t,e){if(!e.dataTransfer)return;const i=t.getData();if(!Array.isArray(i))return;const o=i.filter(s=>"instanceId"in s);o.length>0&&e.dataTransfer.setData(R.Terminals,JSON.stringify(o.map(s=>s.resource.toString())))}onDragOver(t,e,i,o,s){if(t instanceof Se&&!j(s,B.FILES,B.RESOURCES,R.Terminals,Y.FILES))return!1;const n=this._autoFocusInstance!==e;return n&&(this._autoFocusDisposable.dispose(),this._autoFocusInstance=e),!e&&!j(s,R.Terminals)?t instanceof q:(n&&e&&(this._autoFocusDisposable=ge(()=>{this._terminalService.setActiveInstance(e),this._autoFocusInstance=void 0},500,this._store)),{feedback:i?[i]:void 0,accept:!0,effect:{type:Ie.Move,position:ve.Over}})}async drop(t,e,i,o,s){this._autoFocusDisposable.dispose(),this._autoFocusInstance=void 0;let n;const p=[],c=xe(s);if(c)for(const m of c){const d=this._terminalService.getInstanceFromResource(m);if(d)Array.isArray(n)?n.push(d):n=[d],this._terminalService.moveToTerminalView(d);else if(this._primaryBackend){const h=Ae(m);h.instanceId&&p.push(this._primaryBackend.requestDetachInstance(h.workspaceId,h.instanceId))}}if(p.length){let m=await Promise.all(p);m=m.filter(h=>h!==void 0);let d;for(const h of m)d=await this._terminalService.createTerminal({config:{attachPersistentProcess:h}});d&&this._terminalService.setActiveInstance(d);return}if(n===void 0){if(!(t instanceof q)){this._handleExternalDrop(e,s);return}const m=t.getData();if(!m||!Array.isArray(m))return;n=[];for(const d of m)"instanceId"in d&&n.push(d)}if(!e){this._terminalGroupService.moveGroupToEnd(n),this._terminalService.setActiveInstance(n[0]);const m=this._terminalGroupService.getGroupForInstance(n[0]);if(m){const d=this._terminalGroupService.groups.indexOf(m);this._listService.lastFocusedList?.setSelection([d])}return}this._terminalGroupService.moveGroup(n,e),this._terminalService.setActiveInstance(n[0]);const u=this._terminalGroupService.getGroupForInstance(n[0]);if(u){const m=this._terminalGroupService.groups.indexOf(u);this._listService.lastFocusedList?.setSelection([m])}}async _handleExternalDrop(t,e){if(!t||!e.dataTransfer)return;let i;const o=e.dataTransfer.getData(B.RESOURCES);o&&(i=O.parse(JSON.parse(o)[0]));const s=e.dataTransfer.getData(Y.FILES);!i&&s&&(i=O.file(JSON.parse(s)[0])),!i&&e.dataTransfer.files.length>0&&this._hostService.getPathForFile(e.dataTransfer.files[0])&&(i=O.file(this._hostService.getPathForFile(e.dataTransfer.files[0]))),i&&(this._terminalService.setActiveInstance(t),t.focus(),await t.sendPath(i,!1))}};T=S([l(0,x),l(1,E),l(2,Re),l(3,G)],T);let D=class extends F{constructor(t){super();this._terminalService=t;this._register(this._terminalService.onAnyInstancePrimaryStatusChange(e=>this._onDidChange.fire([e.resource])))}label=_("label","Terminal");_onDidChange=this._register(new we);onDidChange=this._onDidChange.event;provideDecorations(t){if(t.scheme!==Le.vscodeTerminal)return;const e=this._terminalService.getInstanceFromResource(t);if(!e)return;const i=e?.statusList?.primary;if(i?.icon)return{color:Ge(i.severity),letter:i.icon,tooltip:i.tooltip}}};D=S([l(0,x)],D);export{L as TerminalTabList,ke as TerminalTabsListSizes};
