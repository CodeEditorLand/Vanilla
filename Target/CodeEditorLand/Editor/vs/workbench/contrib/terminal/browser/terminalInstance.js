var xe=Object.defineProperty;var Ie=Object.getOwnPropertyDescriptor;var I=(u,d,e,t)=>{for(var i=t>1?void 0:t?Ie(d,e):d,s=u.length-1,n;s>=0;s--)(n=u[s])&&(i=(t?n(d,e,i):n(i))||i);return t&&i&&xe(d,e,i),i},o=(u,d)=>(e,t)=>d(e,t,u);import{importAMDNodeModule as Te}from"../../../../amdX.js";import{isFirefox as De}from"../../../../base/browser/browser.js";import{BrowserFeatures as re}from"../../../../base/browser/canIUse.js";import{DataTransfers as q}from"../../../../base/browser/dnd.js";import*as h from"../../../../base/browser/dom.js";import{StandardKeyboardEvent as ne}from"../../../../base/browser/keyboardEvent.js";import{Orientation as U}from"../../../../base/browser/ui/sash/sash.js";import{DomScrollableElement as Pe}from"../../../../base/browser/ui/scrollbar/scrollableElement.js";import{AutoOpenBarrier as oe,Promises as Le,disposableTimeout as Ee,timeout as ae}from"../../../../base/common/async.js";import{Codicon as B}from"../../../../base/common/codicons.js";import{debounce as X}from"../../../../base/common/decorators.js";import{ErrorNoTelemetry as ke,onUnexpectedError as le}from"../../../../base/common/errors.js";import{Emitter as l}from"../../../../base/common/event.js";import{KeyCode as Re}from"../../../../base/common/keyCodes.js";import{template as Ae}from"../../../../base/common/labels.js";import{Disposable as j,DisposableStore as ce,MutableDisposable as $,dispose as he,toDisposable as G}from"../../../../base/common/lifecycle.js";import{Schemas as Q}from"../../../../base/common/network.js";import*as k from"../../../../base/common/path.js";import{OS as Me,OperatingSystem as Y,isMacintosh as Z,isWindows as de}from"../../../../base/common/platform.js";import{ScrollbarVisibility as me}from"../../../../base/common/scrollable.js";import{URI as R}from"../../../../base/common/uri.js";import{TabFocus as Fe}from"../../../../editor/browser/config/tabFocus.js";import*as c from"../../../../nls.js";import{IAccessibilityService as Ke}from"../../../../platform/accessibility/common/accessibility.js";import{AccessibilitySignal as Oe,IAccessibilitySignalService as We}from"../../../../platform/accessibilitySignal/browser/accessibilitySignalService.js";import{IClipboardService as Be}from"../../../../platform/clipboard/common/clipboardService.js";import{ICommandService as ze}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as Ve}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as pe}from"../../../../platform/contextkey/common/contextkey.js";import{CodeDataTransfers as ue,containsDragType as J}from"../../../../platform/dnd/browser/dnd.js";import{FileSystemProviderCapabilities as Ne,IFileService as He}from"../../../../platform/files/common/files.js";import{IInstantiationService as qe}from"../../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as Ue}from"../../../../platform/instantiation/common/serviceCollection.js";import{IKeybindingService as Xe}from"../../../../platform/keybinding/common/keybinding.js";import{ResultKind as fe}from"../../../../platform/keybinding/common/keybindingResolver.js";import{INotificationService as je,Severity as P}from"../../../../platform/notification/common/notification.js";import{IOpenerService as $e}from"../../../../platform/opener/common/opener.js";import{IProductService as Ge}from"../../../../platform/product/common/productService.js";import{IQuickInputService as Qe}from"../../../../platform/quickinput/common/quickInput.js";import{IStorageService as Ye,StorageScope as ee,StorageTarget as Ze}from"../../../../platform/storage/common/storage.js";import{ITelemetryService as Je}from"../../../../platform/telemetry/common/telemetry.js";import{TerminalCapability as _}from"../../../../platform/terminal/common/capabilities/capabilities.js";import{TerminalCapabilityStoreMultiplexer as ei}from"../../../../platform/terminal/common/capabilities/terminalCapabilityStore.js";import{deserializeEnvironmentVariableCollections as ii}from"../../../../platform/terminal/common/environmentVariableShared.js";import{GeneralShellType as _e,ITerminalLogService as ti,PosixShellType as ge,ProcessPropertyType as C,ShellIntegrationStatus as si,TerminalExitReason as A,TerminalLocation as ri,TerminalSettingId as f,TitleEventSource as w}from"../../../../platform/terminal/common/terminal.js";import{formatMessageForTerminal as ie}from"../../../../platform/terminal/common/terminalStrings.js";import{editorBackground as ni}from"../../../../platform/theme/common/colorRegistry.js";import{getIconRegistry as oi}from"../../../../platform/theme/common/iconRegistry.js";import{IThemeService as ai}from"../../../../platform/theme/common/themeService.js";import{IWorkspaceContextService as ve}from"../../../../platform/workspace/common/workspace.js";import{IWorkspaceTrustRequestService as li}from"../../../../platform/workspace/common/workspaceTrust.js";import{PANEL_BACKGROUND as ci,SIDE_BAR_BACKGROUND as hi}from"../../../common/theme.js";import{IViewDescriptorService as te,ViewContainerLocation as ye}from"../../../common/views.js";import{IEditorService as di}from"../../../services/editor/common/editorService.js";import{IWorkbenchEnvironmentService as mi}from"../../../services/environment/common/environmentService.js";import{IHistoryService as pi}from"../../../services/history/common/history.js";import{IHostService as ui}from"../../../services/host/browser/host.js";import{IWorkbenchLayoutService as fi,isHorizontal as _i}from"../../../services/layout/browser/layoutService.js";import{IPathService as gi}from"../../../services/path/common/pathService.js";import{IPreferencesService as vi}from"../../../services/preferences/common/preferences.js";import{IViewsService as yi}from"../../../services/views/common/viewsService.js";import{AccessibilityVerbositySettingId as we}from"../../accessibility/browser/accessibilityConfiguration.js";import{AccessibilityCommandId as wi}from"../../accessibility/common/accessibilityCommands.js";import{getCommandHistory as Ci,getDirectoryHistory as Si}from"../common/history.js";import{DEFAULT_COMMANDS_TO_SKIP_SHELL as bi,ITerminalProfileResolverService as xi,ProcessState as T,TERMINAL_CREATION_COMMANDS as Ii,TERMINAL_VIEW_ID as z,TerminalCommandId as Ti}from"../common/terminal.js";import{shouldPasteTerminalText as Di}from"../common/terminalClipboard.js";import{TERMINAL_BACKGROUND_COLOR as Pi}from"../common/terminalColorRegistry.js";import{TerminalContextKeys as M}from"../common/terminalContextKey.js";import{getWorkspaceForTerminal as Li,preparePathForShell as Ei}from"../common/terminalEnvironment.js";import{terminalStrings as V}from"../common/terminalStrings.js";import{ITerminalConfigurationService as Ce,TerminalDataTransfers as se}from"./terminal.js";import{TerminalLaunchHelpAction as ki}from"./terminalActions.js";import{TerminalEditorInput as Ri}from"./terminalEditorInput.js";import{TerminalExtensionsRegistry as Ai}from"./terminalExtensions.js";import{createColorStyleElement as Mi,getColorClass as Fi,getStandardColors as Ki}from"./terminalIcon.js";import{TerminalIconPicker as Oi}from"./terminalIconPicker.js";import{TerminalProcessManager as Wi}from"./terminalProcessManager.js";import{TerminalResizeDebouncer as Bi}from"./terminalResizeDebouncer.js";import{showRunRecentQuickPick as zi}from"./terminalRunRecentQuickPick.js";import{TerminalStatus as L,TerminalStatusList as Vi}from"./terminalStatusList.js";import{getTerminalResourcesFromDragEvent as Ni,getTerminalUri as Hi}from"./terminalUri.js";import{TerminalWidgetManager as qi}from"./widgets/widgetManager.js";import{LineDataEventAddon as Ui}from"./xterm/lineDataEventAddon.js";import{XtermTerminal as Xi,getXtermScaledDimensions as ji}from"./xterm/xtermTerminal.js";import{IContextMenuService as $i}from"../../../../platform/contextview/browser/contextView.js";import{TerminalAccessibilityCommandId as Gi}from"../../terminalContrib/accessibility/common/terminal.accessibility.js";import{openContextMenu as Qi}from"./terminalContextMenu.js";var Yi=(i=>(i[i.WaitForContainerThreshold=100]="WaitForContainerThreshold",i[i.DefaultCols=80]="DefaultCols",i[i.DefaultRows=30]="DefaultRows",i[i.MaxCanvasWidth=4096]="MaxCanvasWidth",i))(Yi||{});let N;const Zi=[ge.Bash,ge.Zsh,_e.PowerShell,_e.Python];let g=class extends j{constructor(e,t,i,s,n,r,p,b,S,v,E,y,W,it,tt,st,rt,nt,ot,at,lt,Se,ct,ht,dt,mt,pt,ut,ft,_t,gt){super();this._terminalShellTypeContextKey=e;this._terminalInRunCommandPicker=t;this._shellLaunchConfig=i;this._contextKeyService=s;this._contextMenuService=n;this._terminalConfigurationService=p;this._terminalProfileResolverService=b;this._pathService=S;this._keybindingService=v;this._notificationService=E;this._preferencesService=y;this._viewsService=W;this._clipboardService=it;this._themeService=tt;this._configurationService=st;this._logService=rt;this._storageService=nt;this._accessibilityService=ot;this._productService=at;this._quickInputService=lt;this._workspaceContextService=ct;this._editorService=ht;this._workspaceTrustRequestService=dt;this._historyService=mt;this._telemetryService=pt;this._openerService=ut;this._commandService=ft;this._accessibilitySignalService=_t;this._viewDescriptorService=gt;if(this._wrapperElement=document.createElement("div"),this._wrapperElement.classList.add("terminal-wrapper"),this._widgetManager=this._register(r.createInstance(qi)),this._skipTerminalCommands=[],this._isExiting=!1,this._hadFocusOnExit=!1,this._isVisible=!1,this._instanceId=g._instanceIdCounter++,this._hasHadInput=!1,this._fixedRows=i.attachPersistentProcess?.fixedDimensions?.rows,this._fixedCols=i.attachPersistentProcess?.fixedDimensions?.cols,this._resource=Hi(this._workspaceContextService.getWorkspace().id,this.instanceId,this.title),this._shellLaunchConfig.attachPersistentProcess?.hideFromUser&&(this._shellLaunchConfig.hideFromUser=this._shellLaunchConfig.attachPersistentProcess.hideFromUser),this._shellLaunchConfig.attachPersistentProcess?.isFeatureTerminal&&(this._shellLaunchConfig.isFeatureTerminal=this._shellLaunchConfig.attachPersistentProcess.isFeatureTerminal),this._shellLaunchConfig.attachPersistentProcess?.type&&(this._shellLaunchConfig.type=this._shellLaunchConfig.attachPersistentProcess.type),this.shellLaunchConfig.cwd){const a=typeof this._shellLaunchConfig.cwd=="string"?R.from({scheme:Q.file,path:this._shellLaunchConfig.cwd}):this._shellLaunchConfig.cwd;a&&(this._workspaceFolder=this._workspaceContextService.getWorkspaceFolder(a)??void 0)}if(!this._workspaceFolder){const a=this._historyService.getLastActiveWorkspaceRoot();this._workspaceFolder=a?this._workspaceContextService.getWorkspaceFolder(a)??void 0:void 0}const D=this._register(s.createScoped(this._wrapperElement));this._scopedContextKeyService=D,this._scopedInstantiationService=this._register(r.createChild(new Ue([pe,D]))),this._terminalFocusContextKey=M.focus.bindTo(D),this._terminalHasFixedWidth=M.terminalHasFixedWidth.bindTo(D),this._terminalHasTextContextKey=M.textSelected.bindTo(D),this._terminalAltBufferActiveContextKey=M.altBufferActive.bindTo(D),this._terminalShellIntegrationEnabledContextKey=M.terminalShellIntegrationEnabled.bindTo(D),this._logService.trace(`terminalInstance#ctor (instanceId: ${this.instanceId})`,this._shellLaunchConfig),this._register(this.capabilities.onDidAddCapabilityType(a=>{this._logService.debug("terminalInstance added capability",a),a===_.CwdDetection?this.capabilities.get(_.CwdDetection)?.onDidChangeCwd(m=>{this._cwd=m,this._setTitle(this.title,w.Config),this._scopedInstantiationService.invokeFunction(Si)?.add(m,{remoteAuthority:this.remoteAuthority})}):a===_.CommandDetection&&this.capabilities.get(_.CommandDetection)?.onCommandFinished(x=>{x.command.trim().length>0&&this._scopedInstantiationService.invokeFunction(Ci)?.add(x.command,{shellType:this._shellType})})})),this._register(this.capabilities.onDidRemoveCapabilityType(a=>this._logService.debug("terminalInstance removed capability",a))),!this.shellLaunchConfig.executable&&!Se.remoteAuthority&&this._terminalProfileResolverService.resolveIcon(this._shellLaunchConfig,Me),this._icon=i.attachPersistentProcess?.icon||i.icon,this.shellLaunchConfig.customPtyImplementation&&this._setTitle(this._shellLaunchConfig.name,w.Api),this.statusList=this._register(this._scopedInstantiationService.createInstance(Vi)),this._initDimensions(),this._processManager=this._createProcessManager(),this._containerReadyBarrier=new oe(100),this._attachBarrier=new oe(1e3),this._xtermReadyPromise=this._createXterm(),this._xtermReadyPromise.then(async()=>{if(await this._containerReadyBarrier.wait(),!this.shellLaunchConfig.customPtyImplementation&&this._terminalConfigurationService.config.shellIntegration?.enabled&&!this.shellLaunchConfig.executable){const a=await this._processManager.getBackendOS(),m=await this._terminalProfileResolverService.getDefaultProfile({remoteAuthority:this.remoteAuthority,os:a});this.shellLaunchConfig.executable=m.path,this.shellLaunchConfig.args=m.args,this.shellLaunchConfig.isExtensionOwnedTerminal?(this.shellLaunchConfig.icon??=m.icon,this.shellLaunchConfig.color??=m.color,this.shellLaunchConfig.env??=m.env):(this.shellLaunchConfig.icon=m.icon,this.shellLaunchConfig.color=m.color,this.shellLaunchConfig.env=m.env)}await this._createProcess(),this.shellLaunchConfig.attachPersistentProcess&&(this._cwd=this.shellLaunchConfig.attachPersistentProcess.cwd,this._setTitle(this.shellLaunchConfig.attachPersistentProcess.title,this.shellLaunchConfig.attachPersistentProcess.titleSource),this.setShellType(this.shellType)),this._fixedCols&&await this._addScrollbar()}).catch(a=>{if(!this.isDisposed)throw a}),this._register(this._configurationService.onDidChangeConfiguration(async a=>{a.affectsConfiguration(we.Terminal)&&this._setAriaLabel(this.xterm?.raw,this._instanceId,this.title),a.affectsConfiguration("terminal.integrated")&&(this.updateConfig(),this.setVisible(this._isVisible)),[f.FontSize,f.FontFamily,f.FontWeight,f.FontWeightBold,f.LetterSpacing,f.LineHeight,"editor.fontFamily"].some(x=>a.affectsConfiguration(x))&&(this._layoutSettingsChanged=!0,await this._resize()),a.affectsConfiguration(f.UnicodeVersion)&&this._updateUnicodeVersion(),a.affectsConfiguration("editor.accessibilitySupport")&&this.updateAccessibilitySupport(),(a.affectsConfiguration(f.TerminalTitle)||a.affectsConfiguration(f.TerminalTitleSeparator)||a.affectsConfiguration(f.TerminalDescription))&&this._labelComputer?.refreshLabel(this)})),this._register(this._workspaceContextService.onDidChangeWorkspaceFolders(()=>this._labelComputer?.refreshLabel(this)));let H=h.getWindow(this._container).setTimeout(()=>{H=void 0,this._initialDataEvents=void 0,this._initialDataEventsListener.clear()},1e4);this._register(G(()=>{H&&h.getWindow(this._container).clearTimeout(H)}));const be=Ai.getTerminalContributions();for(const a of be){if(this._contributions.has(a.id)){le(new Error(`Cannot have two terminal contributions with the same id ${a.id}`));continue}let m;try{m=this._register(this._scopedInstantiationService.createInstance(a.ctor,this,this._processManager,this._widgetManager)),this._contributions.set(a.id,m)}catch(x){le(x)}this._xtermReadyPromise.then(x=>{m.xtermReady?.(x)}),this._register(this.onDisposed(()=>{m.dispose(),this._contributions.delete(a.id),"instance"in m&&delete m.instance,"_instance"in m&&delete m._instance}))}}static _lastKnownCanvasDimensions;static _lastKnownGridDimensions;static _instanceIdCounter=1;_scopedInstantiationService;_processManager;_contributions=new Map;_resource;_xtermReadyPromise;_pressAnyKeyToCloseListener;_instanceId;_latestXtermWriteData=0;_latestXtermParseData=0;_isExiting;_hadFocusOnExit;_isVisible;_exitCode;_exitReason;_skipTerminalCommands;_shellType;_title="";_titleSource=w.Process;_container;_wrapperElement;get domElement(){return this._wrapperElement}_horizontalScrollbar;_terminalFocusContextKey;_terminalHasFixedWidth;_terminalHasTextContextKey;_terminalAltBufferActiveContextKey;_terminalShellIntegrationEnabledContextKey;_cols=0;_rows=0;_fixedCols;_fixedRows;_cwd=void 0;_initialCwd=void 0;_injectedArgs=void 0;_layoutSettingsChanged=!0;_dimensionsOverride;_areLinksReady=!1;_initialDataEventsListener=this._register(new $);_initialDataEvents=[];_containerReadyBarrier;_attachBarrier;_icon;_messageTitleDisposable=this._register(new $);_widgetManager;_dndObserver=this._register(new $);_lastLayoutDimensions;_hasHadInput;_description;_processName="";_sequence;_staticTitle;_workspaceFolder;_labelComputer;_userHome;_hasScrollBar;_target;_usedShellIntegrationInjection=!1;get usedShellIntegrationInjection(){return this._usedShellIntegrationInjection}_lineDataEventAddon;_scopedContextKeyService;_resizeDebouncer;_pauseInputEventBarrier;pauseInputEvents(e){this._pauseInputEventBarrier=e}capabilities=this._register(new ei);statusList;get store(){return this._store}get extEnvironmentVariableCollection(){return this._processManager.extEnvironmentVariableCollection}xterm;disableLayout=!1;get waitOnExit(){return this._shellLaunchConfig.attachPersistentProcess?.waitOnExit||this._shellLaunchConfig.waitOnExit}set waitOnExit(e){this._shellLaunchConfig.waitOnExit=e}get target(){return this._target}set target(e){this._target=e,this._onDidChangeTarget.fire(e)}get instanceId(){return this._instanceId}get resource(){return this._resource}get cols(){return this._fixedCols!==void 0?this._fixedCols:this._dimensionsOverride&&this._dimensionsOverride.cols?this._dimensionsOverride.forceExactSize?this._dimensionsOverride.cols:Math.min(Math.max(this._dimensionsOverride.cols,2),this._cols):this._cols}get rows(){return this._fixedRows!==void 0?this._fixedRows:this._dimensionsOverride&&this._dimensionsOverride.rows?this._dimensionsOverride.forceExactSize?this._dimensionsOverride.rows:Math.min(Math.max(this._dimensionsOverride.rows,2),this._rows):this._rows}get isDisposed(){return this._store.isDisposed}get fixedCols(){return this._fixedCols}get fixedRows(){return this._fixedRows}get maxCols(){return this._cols}get maxRows(){return this._rows}get processId(){return this._processManager.shellProcessId}get processReady(){return this._processManager.ptyProcessReady}get hasChildProcesses(){return this.shellLaunchConfig.attachPersistentProcess?.hasChildProcesses||this._processManager.hasChildProcesses}get reconnectionProperties(){return this.shellLaunchConfig.attachPersistentProcess?.reconnectionProperties||this.shellLaunchConfig.reconnectionProperties}get areLinksReady(){return this._areLinksReady}get initialDataEvents(){return this._initialDataEvents}get exitCode(){return this._exitCode}get exitReason(){return this._exitReason}get hadFocusOnExit(){return this._hadFocusOnExit}get isTitleSetByProcess(){return!!this._messageTitleDisposable.value}get shellLaunchConfig(){return this._shellLaunchConfig}get shellType(){return this._shellType}get os(){return this._processManager.os}get isRemote(){return this._processManager.remoteAuthority!==void 0}get remoteAuthority(){return this._processManager.remoteAuthority}get hasFocus(){return h.isAncestorOfActiveElement(this._wrapperElement)}get title(){return this._title}get titleSource(){return this._titleSource}get icon(){return this._getIcon()}get color(){return this._getColor()}get processName(){return this._processName}get sequence(){return this._sequence}get staticTitle(){return this._staticTitle}get workspaceFolder(){return this._workspaceFolder}get cwd(){return this._cwd}get initialCwd(){return this._initialCwd}get description(){if(this._description)return this._description;switch(this.shellLaunchConfig.attachPersistentProcess?.type||this.shellLaunchConfig.type){case"Task":return V.typeTask;case"Local":return V.typeLocal;default:return}}get userHome(){return this._userHome}get shellIntegrationNonce(){return this._processManager.shellIntegrationNonce}get injectedArgs(){return this._injectedArgs}_onExit=new l;onExit=this._onExit.event;_onDisposed=this._register(new l);onDisposed=this._onDisposed.event;_onProcessIdReady=this._register(new l);onProcessIdReady=this._onProcessIdReady.event;_onProcessReplayComplete=this._register(new l);onProcessReplayComplete=this._onProcessReplayComplete.event;_onTitleChanged=this._register(new l);onTitleChanged=this._onTitleChanged.event;_onIconChanged=this._register(new l);onIconChanged=this._onIconChanged.event;_onWillData=this._register(new l);onWillData=this._onWillData.event;_onData=this._register(new l);onData=this._onData.event;_onBinary=this._register(new l);onBinary=this._onBinary.event;_onLineData=this._register(new l({onDidAddFirstListener:()=>this._onLineDataSetup()}));onLineData=this._onLineData.event;_onRequestExtHostProcess=this._register(new l);onRequestExtHostProcess=this._onRequestExtHostProcess.event;_onDimensionsChanged=this._register(new l);onDimensionsChanged=this._onDimensionsChanged.event;_onMaximumDimensionsChanged=this._register(new l);onMaximumDimensionsChanged=this._onMaximumDimensionsChanged.event;_onDidFocus=this._register(new l);onDidFocus=this._onDidFocus.event;_onDidRequestFocus=this._register(new l);onDidRequestFocus=this._onDidRequestFocus.event;_onDidBlur=this._register(new l);onDidBlur=this._onDidBlur.event;_onDidInputData=this._register(new l);onDidInputData=this._onDidInputData.event;_onDidChangeSelection=this._register(new l);onDidChangeSelection=this._onDidChangeSelection.event;_onRequestAddInstanceToGroup=this._register(new l);onRequestAddInstanceToGroup=this._onRequestAddInstanceToGroup.event;_onDidChangeHasChildProcesses=this._register(new l);onDidChangeHasChildProcesses=this._onDidChangeHasChildProcesses.event;_onDidExecuteText=this._register(new l);onDidExecuteText=this._onDidExecuteText.event;_onDidChangeTarget=this._register(new l);onDidChangeTarget=this._onDidChangeTarget.event;_onDidSendText=this._register(new l);onDidSendText=this._onDidSendText.event;_onDidChangeShellType=this._register(new l);onDidChangeShellType=this._onDidChangeShellType.event;_onDidChangeVisibility=this._register(new l);onDidChangeVisibility=this._onDidChangeVisibility.event;_onWillPaste=this._register(new l);onWillPaste=this._onWillPaste.event;_onDidPaste=this._register(new l);onDidPaste=this._onDidPaste.event;getContribution(e){return this._contributions.get(e)}_getIcon(){return this._icon||(this._icon=this._processManager.processState>=T.Launching?oi().getIcon(this._configurationService.getValue(f.TabsDefaultIcon)):void 0),this._icon}_getColor(){if(this.shellLaunchConfig.color)return this.shellLaunchConfig.color;if(this.shellLaunchConfig?.attachPersistentProcess?.color)return this.shellLaunchConfig.attachPersistentProcess.color;this._processManager.processState>=T.Launching}_initDimensions(){if(!this._container){this._cols=80,this._rows=30;return}const e=h.getWindow(this._container).getComputedStyle(this._container),t=Number.parseInt(e.width),i=Number.parseInt(e.height);this._evaluateColsAndRows(t,i)}_evaluateColsAndRows(e,t){if(!e||!t)return this._setLastKnownColsAndRows(),null;const i=this._getDimension(e,t);if(!i)return this._setLastKnownColsAndRows(),null;const s=this.xterm?this.xterm.getFont():this._terminalConfigurationService.getFont(h.getWindow(this.domElement)),n=ji(h.getWindow(this.domElement),s,i.width,i.height);return n?((this._cols!==n.cols||this._rows!==n.rows)&&(this._cols=n.cols,this._rows=n.rows,this._fireMaximumDimensionsChanged()),i.width):(this._setLastKnownColsAndRows(),null)}_setLastKnownColsAndRows(){g._lastKnownGridDimensions&&(this._cols=g._lastKnownGridDimensions.cols,this._rows=g._lastKnownGridDimensions.rows)}_fireMaximumDimensionsChanged(){this._onMaximumDimensionsChanged.fire()}_getDimension(e,t){const i=this.xterm?this.xterm.getFont():this._terminalConfigurationService.getFont(h.getWindow(this.domElement));if(!i||!i.charWidth||!i.charHeight||!this.xterm?.raw.element)return;const s=h.getWindow(this.xterm.raw.element).getComputedStyle(this.xterm.raw.element),n=Number.parseInt(s.paddingLeft)+Number.parseInt(s.paddingRight)+14,r=Number.parseInt(s.paddingTop)+Number.parseInt(s.paddingBottom);return g._lastKnownCanvasDimensions=new h.Dimension(Math.min(4096,e-n),t-r+(this._hasScrollBar&&this._horizontalScrollbar?-5:0)),g._lastKnownCanvasDimensions}get persistentProcessId(){return this._processManager.persistentProcessId}get shouldPersist(){return this._processManager.shouldPersist&&!this.shellLaunchConfig.isTransient&&(!this.reconnectionProperties||this._configurationService.getValue("task.reconnection")===!0)}static getXtermConstructor(e,t){const i=e.lookupKeybinding(Gi.FocusAccessibleBuffer,t);return N||(N=Le.withAsyncBody(async s=>{const n=(await Te("@xterm/xterm","lib/xterm.js")).Terminal;n.strings.promptLabel=c.localize("terminal.integrated.a11yPromptLabel","Terminal input"),n.strings.tooMuchOutput=i?c.localize("terminal.integrated.useAccessibleBuffer","Use the accessible buffer {0} to manually review output",i.getLabel()):c.localize("terminal.integrated.useAccessibleBufferNoKb","Use the Terminal: Focus Accessible Buffer command to manually review output"),s(n)}),N)}async _createXterm(){const e=await g.getXtermConstructor(this._keybindingService,this._contextKeyService);if(this.isDisposed)throw new ke("Terminal disposed of during xterm.js creation");const t=this.shellLaunchConfig.executable===void 0||this.shellType===void 0||!Zi.includes(this.shellType),i=this._scopedInstantiationService.createInstance(Xi,e,this._cols,this._rows,this._scopedInstantiationService.createInstance(O,this),this.capabilities,this._processManager.shellIntegrationNonce,t);this.xterm=i,this._resizeDebouncer=this._register(new Bi(()=>this._isVisible,()=>i,async(r,p)=>{i.raw.resize(r,p),await this._updatePtyDimensions(i.raw)},async r=>{i.raw.resize(r,i.raw.rows),await this._updatePtyDimensions(i.raw)},async r=>{i.raw.resize(i.raw.cols,r),await this._updatePtyDimensions(i.raw)})),this.updateAccessibilitySupport(),this._register(this.xterm.onDidRequestRunCommand(r=>{r.copyAsHtml?this.copySelection(!0,r.command):this.sendText(r.command.command,!r.noNewLine)})),this._register(this.xterm.onDidRequestFocus(()=>this.focus())),this._register(this.xterm.onDidRequestSendText(r=>this.sendText(r,!1)));const s=this._shellLaunchConfig.initialText?new Promise(r=>this._writeInitialText(i,r)):void 0,n=this._register(new Ui(s));if(this._register(n.onLineData(r=>this._onLineData.fire(r))),this._lineDataEventAddon=n,Ee(()=>{this._register(i.raw.onBell(()=>{(this._configurationService.getValue(f.EnableBell)||this._configurationService.getValue(f.EnableVisualBell))&&this.statusList.add({id:L.Bell,severity:P.Warning,icon:B.bell,tooltip:c.localize("bellStatus","Bell")},this._terminalConfigurationService.config.bellDuration),this._accessibilitySignalService.playSignal(Oe.terminalBell)}))},1e3,this._store),this._register(i.raw.onSelectionChange(async()=>this._onSelectionChange())),this._register(i.raw.buffer.onBufferChange(()=>this._refreshAltBufferContextKey())),this._register(this._processManager.onProcessData(r=>this._onProcessData(r))),this._register(i.raw.onData(async r=>{await this._pauseInputEventBarrier?.wait(),await this._processManager.write(r),this._onDidInputData.fire(r)})),this._register(i.raw.onBinary(r=>this._processManager.processBinary(r))),this._register(this._processManager.onProcessReady(async r=>{this._processManager.os&&n.setOperatingSystem(this._processManager.os),i.raw.options.windowsPty=r.windowsPty})),this._register(this._processManager.onRestoreCommands(r=>this.xterm?.shellIntegration.deserialize(r))),this._register(this._viewDescriptorService.onDidChangeLocation(({views:r})=>{r.some(p=>p.id===z)&&i.refresh()})),!this.capabilities.has(_.CwdDetection)){let r=i.raw.onKey(p=>{new ne(p.domEvent).equals(Re.Enter)&&this._updateProcessCwd()});this._register(this.capabilities.onDidAddCapabilityType(p=>{p===_.CwdDetection&&(r?.dispose(),r=void 0)}))}return this._pathService.userHome().then(r=>{this._userHome=r.fsPath}),this._isVisible&&this._open(),i}async _onLineDataSetup(){(this.xterm||await this._xtermReadyPromise).raw.loadAddon(this._lineDataEventAddon)}async runCommand(e,t){let i=this.capabilities.get(_.CommandDetection);if(!i&&(this._processManager.processState===T.Uninitialized||this._processManager.processState===T.Launching)){const s=new ce;await Promise.race([new Promise(n=>{s.add(this.capabilities.onDidAddCapabilityType(r=>{r===_.CommandDetection&&(i=this.capabilities.get(_.CommandDetection),n())}))}),ae(2e3)]),s.dispose()}(!i||i.promptInputModel.value.length>0)&&(await this.sendText("",!1),await ae(100)),await this.sendText(e,t,!t)}async runRecent(e,t,i){return this._scopedInstantiationService.invokeFunction(zi,this,this._terminalInRunCommandPicker,e,t,i)}detachFromElement(){this._wrapperElement.remove(),this._container=void 0}attachToElement(e){this._container!==e&&(this._attachBarrier.isOpen()||this._attachBarrier.open(),this._container=e,this._container.appendChild(this._wrapperElement),this.xterm?.raw.element&&this.xterm.raw.open(this.xterm.raw.element),this.xterm?.refresh(),setTimeout(()=>this._initDragAndDrop(e)))}_open(){if(!this.xterm||this.xterm.raw.element)return;if(!this._container||!this._container.isConnected)throw new Error("A container element needs to be set with `attachToElement` and be part of the DOM before calling `_open`");const e=document.createElement("div");this._wrapperElement.appendChild(e),this._container.appendChild(this._wrapperElement);const t=this.xterm;this._wrapperElement.xterm=t.raw;const i=t.attachToElement(e);for(const s of this._contributions.values())this.xterm?s.xtermOpen?.(this.xterm):this._xtermReadyPromise.then(n=>s.xtermOpen?.(n));if(this._register(t.shellIntegration.onDidChangeStatus(()=>{this.hasFocus?this._setShellIntegrationContextKey():this._terminalShellIntegrationEnabledContextKey.reset()})),!t.raw.element||!t.raw.textarea)throw new Error("xterm elements not set after open");this._setAriaLabel(t.raw,this._instanceId,this._title),t.raw.attachCustomKeyEventHandler(s=>{if(this._isExiting)return!1;const n=new ne(s),r=this._keybindingService.softDispatch(n,n.target),p=r.kind===fe.MoreChordsNeeded&&this._terminalConfigurationService.config.allowChords&&s.key!=="Escape";if(this._keybindingService.inChordMode||p)return s.preventDefault(),!1;const b="terminal.integrated.showTerminalConfigPrompt",S=["RightArrow","LeftArrow","UpArrow","DownArrow","Space","Meta","Control","Shift","Alt","","Delete","Backspace","Tab"];return this._storageService.getBoolean(b,ee.APPLICATION,!0)&&!S.includes(s.key)&&!s.ctrlKey&&!s.shiftKey&&!s.altKey&&(this._hasHadInput=!0),r.kind===fe.KbFound&&r.commandId&&this._skipTerminalCommands.some(v=>v===r.commandId)&&!this._terminalConfigurationService.config.sendKeybindingsToShell?(this._storageService.getBoolean(b,ee.APPLICATION,!0)&&this._hasHadInput&&!Ii.includes(r.commandId)&&(this._notificationService.prompt(P.Info,c.localize("keybindingHandling","Some keybindings don't go to the terminal by default and are handled by {0} instead.",this._productService.nameLong),[{label:c.localize("configureTerminalSettings","Configure Terminal Settings"),run:()=>{this._preferencesService.openSettings({jsonEditor:!1,query:`@id:${f.CommandsToSkipShell},${f.SendKeybindingsToShell},${f.AllowChords}`})}}]),this._storageService.store(b,!1,ee.APPLICATION,Ze.USER)),s.preventDefault(),!1):this._terminalConfigurationService.config.allowMnemonics&&!Z&&s.altKey||Fe.getTabFocusMode()&&s.key==="Tab"?!1:s.key==="Tab"&&s.shiftKey?(s.preventDefault(),!0):!(de&&s.altKey&&s.key==="F4"&&!s.ctrlKey||!re.clipboard.readText&&s.key==="v"&&s.ctrlKey)}),this._register(h.addDisposableListener(t.raw.element,"mousedown",()=>{const s=h.addDisposableListener(t.raw.element.ownerDocument,"mouseup",()=>{setTimeout(()=>this._refreshSelectionContextKey(),0),s.dispose()})})),this._register(h.addDisposableListener(t.raw.element,"touchstart",()=>{t.raw.focus()})),this._register(h.addDisposableListener(t.raw.element,"keyup",()=>{setTimeout(()=>this._refreshSelectionContextKey(),0)})),this._register(h.addDisposableListener(t.raw.textarea,"focus",()=>this._setFocus(!0))),this._register(h.addDisposableListener(t.raw.textarea,"blur",()=>this._setFocus(!1))),this._register(h.addDisposableListener(t.raw.textarea,"focusout",()=>this._setFocus(!1))),this._initDragAndDrop(this._container),this._widgetManager.attachToElement(i),this._lastLayoutDimensions&&this.layout(this._lastLayoutDimensions),this.updateConfig(),t.raw.options.disableStdin&&this._attachPressAnyKeyToCloseListener(t.raw)}_setFocus(e){e?(this._terminalFocusContextKey.set(!0),this._setShellIntegrationContextKey(),this._onDidFocus.fire(this)):(this.resetFocusContextKey(),this._onDidBlur.fire(this),this._refreshSelectionContextKey())}_setShellIntegrationContextKey(){this.xterm&&this._terminalShellIntegrationEnabledContextKey.set(this.xterm.shellIntegration.status===si.VSCode)}resetFocusContextKey(){this._terminalFocusContextKey.reset(),this._terminalShellIntegrationEnabledContextKey.reset()}_initDragAndDrop(e){const t=new ce,i=t.add(this._scopedInstantiationService.createInstance(F,e));t.add(i.onDropTerminal(s=>this._onRequestAddInstanceToGroup.fire(s))),t.add(i.onDropFile(async s=>{this.focus(),await this.sendPath(s,!1)})),t.add(new h.DragAndDropObserver(e,i)),this._dndObserver.value=t}hasSelection(){return this.xterm?this.xterm.raw.hasSelection():!1}async copySelection(e,t){await(await this._xtermReadyPromise).copySelection(e,t)}get selection(){return this.xterm&&this.hasSelection()?this.xterm.raw.getSelection():void 0}clearSelection(){this.xterm?.raw.clearSelection()}_refreshAltBufferContextKey(){this._terminalAltBufferActiveContextKey.set(!!(this.xterm&&this.xterm.raw.buffer.active===this.xterm.raw.buffer.alternate))}dispose(e){if(!(this.shellLaunchConfig.type==="Task"&&e===A.Process&&this._exitCode!==0&&!this.shellLaunchConfig.waitOnExit)&&!this.isDisposed){this._logService.trace(`terminalInstance#dispose (instanceId: ${this.instanceId})`),he(this._widgetManager),this.xterm?.raw.element&&(this._hadFocusOnExit=this.hasFocus),this._wrapperElement.xterm&&(this._wrapperElement.xterm=void 0),this._horizontalScrollbar&&(this._horizontalScrollbar.dispose(),this._horizontalScrollbar=void 0);try{this.xterm?.dispose()}catch(t){this._logService.error("Exception occurred during xterm disposal",t)}De&&(this.resetFocusContextKey(),this._terminalHasTextContextKey.reset(),this._onDidBlur.fire(this)),this._pressAnyKeyToCloseListener&&(this._pressAnyKeyToCloseListener.dispose(),this._pressAnyKeyToCloseListener=void 0),this._exitReason===void 0&&(this._exitReason=e??A.Unknown),this._processManager.dispose(),this._onProcessExit(void 0),this._onDisposed.fire(this),super.dispose()}}async detachProcessAndDispose(e){await this._processManager.detachFromProcess(e===A.User),this.dispose(e)}focus(e){this._refreshAltBufferContextKey(),this.xterm&&(e||!h.getActiveWindow().getSelection()?.toString())&&(this.xterm.raw.focus(),this._onDidRequestFocus.fire())}async focusWhenReady(e){await this._xtermReadyPromise,await this._attachBarrier.wait(),this.focus(e)}async paste(){await this._paste(await this._clipboardService.readText())}async pasteSelection(){await this._paste(await this._clipboardService.readText("selection"))}async _paste(e){if(!this.xterm)return;let t=e;const i=await this._scopedInstantiationService.invokeFunction(Di,t,this.xterm?.raw.modes.bracketedPasteMode);i&&(typeof i=="object"&&(t=i.modifiedText),this.focus(),this._onWillPaste.fire(t),this.xterm.raw.paste(t),this._onDidPaste.fire(t))}async sendText(e,t,i){i&&this.xterm?.raw.modes.bracketedPasteMode&&(e=`\x1B[200~${e}\x1B[201~`),e=e.replace(/\r?\n/g,"\r"),t&&!e.endsWith("\r")&&(e+="\r"),this._logService.debug("sending data (vscode)",e),await this._processManager.write(e),this._onDidInputData.fire(e),this._onDidSendText.fire(e),this.xterm?.scrollToBottom(),t&&this._onDidExecuteText.fire()}async sendPath(e,t){return this.sendText(await this.preparePathForShell(e),t)}async preparePathForShell(e){return await this.processReady,Ei(e,this.shellLaunchConfig.executable,this.title,this.shellType,this._processManager.backend,this._processManager.os)}setVisible(e){const t=this._isVisible!==e;this._isVisible=e,this._wrapperElement.classList.toggle("active",e),e&&this.xterm&&(this._open(),this._resizeDebouncer?.flush(),this._resize()),t&&this._onDidChangeVisibility.fire(e)}scrollDownLine(){this.xterm?.scrollDownLine()}scrollDownPage(){this.xterm?.scrollDownPage()}scrollToBottom(){this.xterm?.scrollToBottom()}scrollUpLine(){this.xterm?.scrollUpLine()}scrollUpPage(){this.xterm?.scrollUpPage()}scrollToTop(){this.xterm?.scrollToTop()}clearBuffer(){this._processManager.clearBuffer(),this.xterm?.clearBuffer()}_refreshSelectionContextKey(){const e=!!this._viewsService.getActiveViewWithId(z);let t=!1;const i=this._editorService.activeEditor;i&&(t=i instanceof Ri),this._terminalHasTextContextKey.set((e||t)&&this.hasSelection())}_createProcessManager(){let e;this.shellLaunchConfig.attachPersistentProcess?.environmentVariableCollections&&(e=ii(this.shellLaunchConfig.attachPersistentProcess.environmentVariableCollections));const t=this._scopedInstantiationService.createInstance(Wi,this._instanceId,this.shellLaunchConfig?.cwd,e,this.shellLaunchConfig.attachPersistentProcess?.shellIntegrationNonce);return this.capabilities.add(t.capabilities),this._register(t.onProcessReady(async i=>{this._onProcessIdReady.fire(this),this._initialCwd=await this.getInitialCwd(),this._labelComputer||(this._labelComputer=this._register(this._scopedInstantiationService.createInstance(K)),this._register(this._labelComputer.onDidChangeLabel(s=>{(this._title!==s.title||this._description!==s.description)&&(this._title=s.title,this._description=s.description,this._onTitleChanged.fire(this))}))),this._shellLaunchConfig.name?this._setTitle(this._shellLaunchConfig.name,w.Api):(setTimeout(()=>{this._xtermReadyPromise.then(s=>{this._messageTitleDisposable.value=s.raw.onTitleChange(n=>this._onTitleChange(n))})}),this._setTitle(this._shellLaunchConfig.executable,w.Process))})),this._register(t.onProcessExit(i=>this._onProcessExit(i))),this._register(t.onDidChangeProperty(({type:i,value:s})=>{switch(i){case C.Cwd:this._cwd=s,this._labelComputer?.refreshLabel(this);break;case C.InitialCwd:this._initialCwd=s,this._cwd=this._initialCwd,this._setTitle(this.title,w.Config),this._icon=this._shellLaunchConfig.attachPersistentProcess?.icon||this._shellLaunchConfig.icon,this._onIconChanged.fire({instance:this,userInitiated:!1});break;case C.Title:this._setTitle(s??"",w.Process);break;case C.OverrideDimensions:this.setOverrideDimensions(s,!0);break;case C.ResolvedShellLaunchConfig:this._setResolvedShellLaunchConfig(s);break;case C.ShellType:this.setShellType(s);break;case C.HasChildProcesses:this._onDidChangeHasChildProcesses.fire(s);break;case C.UsedShellIntegrationInjection:this._usedShellIntegrationInjection=!0;break}})),this._initialDataEventsListener.value=t.onProcessData(i=>this._initialDataEvents?.push(i.data)),this._register(t.onProcessReplayComplete(()=>this._onProcessReplayComplete.fire())),this._register(t.onEnvironmentVariableInfoChanged(i=>this._onEnvironmentVariableInfoChanged(i))),this._register(t.onPtyDisconnect(()=>{this.xterm&&(this.xterm.raw.options.disableStdin=!0),this.statusList.add({id:L.Disconnected,severity:P.Error,icon:B.debugDisconnect,tooltip:c.localize("disconnectStatus","Lost connection to process")})})),this._register(t.onPtyReconnect(()=>{this.xterm&&(this.xterm.raw.options.disableStdin=!1),this.statusList.remove(L.Disconnected)})),t}async _createProcess(){if(this.isDisposed)return;this._historyService.getLastActiveWorkspaceRoot(Q.file)?await this._trust()||this._onProcessExit({message:c.localize("workspaceNotTrustedCreateTerminal","Cannot launch a terminal process in an untrusted workspace")}):this._cwd&&this._userHome&&this._cwd!==this._userHome&&this._onProcessExit({message:c.localize("workspaceNotTrustedCreateTerminalCwd","Cannot launch a terminal process in an untrusted workspace with cwd {0} and userHome {1}",this._cwd,this._userHome)}),this._container&&this._cols===0&&this._rows===0&&(this._initDimensions(),this.xterm?.raw.resize(this._cols||80,this._rows||30));const t=this.shellLaunchConfig.icon;await this._processManager.createProcess(this._shellLaunchConfig,this._cols||80,this._rows||30).then(i=>{i&&("message"in i?this._onProcessExit(i):"injectedArgs"in i&&(this._injectedArgs=i.injectedArgs))}),!this.isDisposed&&(this.xterm?.shellIntegration&&this.capabilities.add(this.xterm.shellIntegration.capabilities),(t!==this.shellLaunchConfig.icon||this.shellLaunchConfig.color)&&(this._icon=this._shellLaunchConfig.attachPersistentProcess?.icon||this._shellLaunchConfig.icon,this._onIconChanged.fire({instance:this,userInitiated:!1})))}registerMarker(e){return this.xterm?.raw.registerMarker(e)}addBufferMarker(e){this.capabilities.get(_.BufferMarkDetection)?.addMark(e)}scrollToMark(e,t,i){this.xterm?.markTracker.scrollToClosestMarker(e,t,i)}async freePortKillProcess(e,t){await this._processManager?.freePortKillProcess(e),this.runCommand(t,!1)}_onProcessData(e){const t=e.data.indexOf("\x1B]633;C\x07");t!==-1?e.trackCommit?(this._writeProcessData(e.data.substring(0,t+8)),e.writePromise=new Promise(i=>this._writeProcessData(e.data.substring(t+8),i))):(this._writeProcessData(e.data.substring(0,t+8)),this._writeProcessData(e.data.substring(t+8))):e.trackCommit?e.writePromise=new Promise(i=>this._writeProcessData(e.data,i)):this._writeProcessData(e.data)}_writeProcessData(e,t){this._onWillData.fire(e);const i=++this._latestXtermWriteData;this.xterm?.raw.write(e,()=>{this._latestXtermParseData=i,this._processManager.acknowledgeDataEvent(e.length),t?.(),this._onData.fire(e)})}async _onProcessExit(e){if(this._isExiting)return;const t=et(e,this.shellLaunchConfig,this._processManager.processState,this._initialCwd);if(this._usedShellIntegrationInjection&&this._processManager.processState===T.KilledDuringLaunch&&t?.code!==0){this._relaunchWithShellIntegrationDisabled(t?.message),this._onExit.fire(e);return}this._isExiting=!0,await this._flushXtermData(),this._exitCode=t?.code;const i=t?.message;this._logService.debug("Terminal process exit","instanceId",this.instanceId,"code",this._exitCode,"processState",this._processManager.processState);const s=this.waitOnExit;s&&this._processManager.processState!==T.KilledByUser?this._xtermReadyPromise.then(n=>{switch(i&&n.raw.write(ie(i)),typeof s){case"string":n.raw.write(ie(s,{excludeLeadingNewLine:!0}));break;case"function":this.exitCode!==void 0&&n.raw.write(ie(s(this.exitCode),{excludeLeadingNewLine:!0}));break}n.raw.options.disableStdin=!0,n.raw.textarea&&this._attachPressAnyKeyToCloseListener(n.raw)}):(i&&(this._processManager.processState===T.KilledDuringLaunch||this._terminalConfigurationService.config.showExitAlert?this._notificationService.notify({message:i,severity:P.Error,actions:{primary:[this._scopedInstantiationService.createInstance(ki)]}}):this._logService.warn(i)),this.dispose(A.Process)),this._onExit.fire(e),this.isDisposed&&this._onExit.dispose()}_relaunchWithShellIntegrationDisabled(e){this._shellLaunchConfig.ignoreShellIntegration=!0,this.relaunch(),this.statusList.add({id:L.ShellIntegrationAttentionNeeded,severity:P.Warning,icon:B.warning,tooltip:`${e} `+c.localize("launchFailed.exitCodeOnlyShellIntegration","Disabling shell integration in user settings might help."),hoverActions:[{commandId:Ti.ShellIntegrationLearnMore,label:c.localize("shellIntegration.learnMore","Learn more about shell integration"),run:()=>{this._openerService.open("https://code.visualstudio.com/docs/editor/integrated-terminal#_shell-integration")}},{commandId:"workbench.action.openSettings",label:c.localize("shellIntegration.openSettings","Open user settings"),run:()=>{this._commandService.executeCommand("workbench.action.openSettings","terminal.integrated.shellIntegration.enabled")}}]}),this._telemetryService.publicLog2("terminal/shellIntegrationFailureProcessExit")}_flushXtermData(){if(this._latestXtermWriteData===this._latestXtermParseData)return Promise.resolve();let e=0;return new Promise(t=>{const i=h.disposableWindowInterval(h.getActiveWindow().window,()=>{(this._latestXtermWriteData===this._latestXtermParseData||++e===5)&&(i.dispose(),t())},20)})}_attachPressAnyKeyToCloseListener(e){e.textarea&&!this._pressAnyKeyToCloseListener&&(this._pressAnyKeyToCloseListener=h.addDisposableListener(e.textarea,"keypress",t=>{this._pressAnyKeyToCloseListener&&(this._pressAnyKeyToCloseListener.dispose(),this._pressAnyKeyToCloseListener=void 0,this.dispose(A.Process),t.preventDefault())}))}_writeInitialText(e,t){if(!this._shellLaunchConfig.initialText){t?.();return}const i=typeof this._shellLaunchConfig.initialText=="string"?this._shellLaunchConfig.initialText:this._shellLaunchConfig.initialText?.text;typeof this._shellLaunchConfig.initialText=="string"||this._shellLaunchConfig.initialText.trailingNewLine?e.raw.writeln(i,t):e.raw.write(i,t)}async reuseTerminal(e,t=!1){this._pressAnyKeyToCloseListener?.dispose(),this._pressAnyKeyToCloseListener=void 0;const i=this.xterm;i&&(t||await new Promise(s=>i.raw.write(`
\x1B[G`,s)),e.initialText&&(this._shellLaunchConfig.initialText=e.initialText,await new Promise(s=>this._writeInitialText(i,s))),this._isExiting&&this._shellLaunchConfig.waitOnExit&&(i.raw.options.disableStdin=!1,this._isExiting=!1),t&&i.clearDecorations()),this.statusList.remove(L.RelaunchNeeded),t||(e.initialText=" "),this._shellLaunchConfig=e,await this._processManager.relaunch(this._shellLaunchConfig,this._cols||80,this._rows||30,t).then(s=>{s&&("message"in s?this._onProcessExit(s):"injectedArgs"in s&&(this._injectedArgs=s.injectedArgs))})}relaunch(){this.reuseTerminal(this._shellLaunchConfig,!0)}_onTitleChange(e){this.isTitleSetByProcess&&this._setTitle(e,w.Sequence)}async _trust(){return await this._workspaceTrustRequestService.requestWorkspaceTrust({message:c.localize("terminal.requestTrust","Creating a terminal process requires executing code")})===!0}async _onSelectionChange(){if(this._onDidChangeSelection.fire(this),this._configurationService.getValue(f.CopyOnSelection)){if(this._overrideCopySelection===!1)return;this.hasSelection()&&await this.copySelection()}}_overrideCopySelection=void 0;overrideCopyOnSelection(e){if(this._overrideCopySelection!==void 0)throw new Error("Cannot set a copy on selection override multiple times");return this._overrideCopySelection=e,G(()=>this._overrideCopySelection=void 0)}async _updateProcessCwd(){if(!(this.isDisposed||this.shellLaunchConfig.customPtyImplementation))try{const e=await this._refreshProperty(C.Cwd);if(typeof e!="string")throw new Error(`cwd is not a string ${e}`)}catch(e){if(e instanceof Error&&e.message==="Cannot refresh property when process is not set")return;throw e}}updateConfig(){this._setCommandsToSkipShell(this._terminalConfigurationService.config.commandsToSkipShell),this._refreshEnvironmentVariableInfoWidgetState(this._processManager.environmentVariableInfo)}async _updateUnicodeVersion(){this._processManager.setUnicodeVersion(this._terminalConfigurationService.config.unicodeVersion)}updateAccessibilitySupport(){this.xterm.raw.options.screenReaderMode=this._accessibilityService.isScreenReaderOptimized()}_setCommandsToSkipShell(e){const t=e.filter(i=>i[0]==="-").map(i=>i.slice(1));this._skipTerminalCommands=bi.filter(i=>!t.includes(i)).concat(e)}layout(e){if(this._lastLayoutDimensions=e,!(this.disableLayout||e.width<=0||e.height<=0||!this._evaluateColsAndRows(e.width,e.height))){this._resize(),this._containerReadyBarrier.isOpen()||this._containerReadyBarrier.open();for(const i of this._contributions.values())this.xterm?i.layout?.(this.xterm,e):this._xtermReadyPromise.then(s=>i.layout?.(s,e))}}async _resize(e){if(!this.xterm)return;let t=this.cols,i=this.rows;if(this._isVisible&&this._layoutSettingsChanged){const s=this.xterm.getFont(),n=this._terminalConfigurationService.config;this.xterm.raw.options.letterSpacing=s.letterSpacing,this.xterm.raw.options.lineHeight=s.lineHeight,this.xterm.raw.options.fontSize=s.fontSize,this.xterm.raw.options.fontFamily=s.fontFamily,this.xterm.raw.options.fontWeight=n.fontWeight,this.xterm.raw.options.fontWeightBold=n.fontWeightBold,this._initDimensions(),t=this.cols,i=this.rows,this._layoutSettingsChanged=!1}isNaN(t)||isNaN(i)||((t!==this.xterm.raw.cols||i!==this.xterm.raw.rows)&&((this._fixedRows||this._fixedCols)&&await this._updateProperty(C.FixedDimensions,{cols:this._fixedCols,rows:this._fixedRows}),this._onDimensionsChanged.fire()),g._lastKnownGridDimensions={cols:t,rows:i},this._resizeDebouncer.resize(t,i,e??!1))}async _updatePtyDimensions(e){await this._processManager.setDimensions(e.cols,e.rows)}setShellType(e){this._shellType!==e&&e&&(this._shellType=e,this._terminalShellTypeContextKey.set(e?.toString()),this._onDidChangeShellType.fire(e))}_setAriaLabel(e,t,i){const s=[];if(e&&e.textarea){i&&i.length>0?s.push(c.localize("terminalTextBoxAriaLabelNumberAndTitle","Terminal {0}, {1}",t,i)):s.push(c.localize("terminalTextBoxAriaLabel","Terminal {0}",t)),this._accessibilityService.isScreenReaderOptimized()||s.push(c.localize("terminalScreenReaderMode","Run the command: Toggle Screen Reader Accessibility Mode for an optimized screen reader experience"));const r=this._keybindingService.lookupKeybinding(wi.OpenAccessibilityHelp)?.getLabel();this._configurationService.getValue(we.Terminal)&&r&&s.push(c.localize("terminalHelpAriaLabel","Use {0} for terminal accessibility help",r)),e.textarea.setAttribute("aria-label",s.join(`
`))}}_updateTitleProperties(e,t){if(!e)return this._processName;switch(t){case w.Process:if(this._processManager.os===Y.Windows)e=k.win32.parse(e).name;else{const i=e.indexOf(" ");e.startsWith("/")?e=k.basename(e):i>-1&&(e=e.substring(0,i))}this._processName=e;break;case w.Api:this._staticTitle=e,this._messageTitleDisposable.value=void 0;break;case w.Sequence:this._sequence=e,this._processManager.os===Y.Windows&&e.match(/^[a-zA-Z]:\\.+\.[a-zA-Z]{1,3}/)&&(this._sequence=k.win32.parse(e).name);break}return this._titleSource=t,e}setOverrideDimensions(e,t=!1){this._dimensionsOverride&&this._dimensionsOverride.forceExactSize&&!e&&this._rows===0&&this._cols===0&&(this._cols=this._dimensionsOverride.cols,this._rows=this._dimensionsOverride.rows),this._dimensionsOverride=e,t?this._resize(!0):this._resize()}async setFixedDimensions(){const e=await this._quickInputService.input({title:c.localize("setTerminalDimensionsColumn","Set Fixed Dimensions: Column"),placeHolder:"Enter a number of columns or leave empty for automatic width",validateInput:async i=>i.length>0&&!i.match(/^\d+$/)?{content:"Enter a number or leave empty size automatically",severity:P.Error}:void 0});if(e===void 0)return;this._fixedCols=this._parseFixedDimension(e),this._labelComputer?.refreshLabel(this),this._terminalHasFixedWidth.set(!!this._fixedCols);const t=await this._quickInputService.input({title:c.localize("setTerminalDimensionsRow","Set Fixed Dimensions: Row"),placeHolder:"Enter a number of rows or leave empty for automatic height",validateInput:async i=>i.length>0&&!i.match(/^\d+$/)?{content:"Enter a number or leave empty size automatically",severity:P.Error}:void 0});t!==void 0&&(this._fixedRows=this._parseFixedDimension(t),this._labelComputer?.refreshLabel(this),await this._refreshScrollbar(),this._resize(),this.focus())}_parseFixedDimension(e){if(e==="")return;const t=Number.parseInt(e);if(t<=0)throw new Error(`Could not parse dimension "${e}"`);return t}async toggleSizeToContentWidth(){if(this.xterm?.raw.buffer.active){if(this._hasScrollBar)this._terminalHasFixedWidth.set(!1),this._fixedCols=void 0,this._fixedRows=void 0,this._hasScrollBar=!1,this._initDimensions(),await this._resize();else{const e=this.xterm?this.xterm.getFont():this._terminalConfigurationService.getFont(h.getWindow(this.domElement)),t=Math.floor(4096/(e.charWidth??20)),i=Math.max(this.maxCols,Math.min(this.xterm.getLongestViewportWrappedLineLength(),t));i>this.xterm.raw.cols&&(this._fixedCols=i)}await this._refreshScrollbar(),this._labelComputer?.refreshLabel(this),this.focus()}}_refreshScrollbar(){return this._fixedCols||this._fixedRows?this._addScrollbar():this._removeScrollbar()}async _addScrollbar(){const e=(this.xterm?this.xterm.getFont():this._terminalConfigurationService.getFont(h.getWindow(this.domElement))).charWidth;if(!(!this.xterm?.raw.element||!this._container||!e||!this._fixedCols)&&(this._wrapperElement.classList.add("fixed-dims"),this._hasScrollBar=!0,this._initDimensions(),await this._resize(),this._terminalHasFixedWidth.set(!0),this._horizontalScrollbar||(this._horizontalScrollbar=this._register(new Pe(this._wrapperElement,{vertical:me.Hidden,horizontal:me.Auto,useShadows:!1,scrollYToX:!1,consumeMouseWheelIfScrollbarIsNeeded:!1})),this._container.appendChild(this._horizontalScrollbar.getDomNode())),this._horizontalScrollbar.setScrollDimensions({width:this.xterm.raw.element.clientWidth,scrollWidth:this._fixedCols*e+40}),this._horizontalScrollbar.getDomNode().style.paddingBottom="16px",de))for(let t=this.xterm.raw.buffer.active.viewportY;t<this.xterm.raw.buffer.active.length;t++){const i=this.xterm.raw.buffer.active.getLine(t);i._line.isWrapped=!1}}async _removeScrollbar(){!this._container||!this._horizontalScrollbar||(this._horizontalScrollbar.getDomNode().remove(),this._horizontalScrollbar.dispose(),this._horizontalScrollbar=void 0,this._wrapperElement.remove(),this._wrapperElement.classList.remove("fixed-dims"),this._container.appendChild(this._wrapperElement))}_setResolvedShellLaunchConfig(e){this._shellLaunchConfig.args=e.args,this._shellLaunchConfig.cwd=e.cwd,this._shellLaunchConfig.executable=e.executable,this._shellLaunchConfig.env=e.env}_onEnvironmentVariableInfoChanged(e){e.requiresAction&&this.xterm?.raw.textarea?.setAttribute("aria-label",c.localize("terminalStaleTextBoxAriaLabel","Terminal {0} environment is stale, run the 'Show Environment Information' command for more information",this._instanceId)),this._refreshEnvironmentVariableInfoWidgetState(e)}async _refreshEnvironmentVariableInfoWidgetState(e){if(!e){this.statusList.remove(L.RelaunchNeeded),this.statusList.remove(L.EnvironmentVariableInfoChangesActive);return}if(e.requiresAction&&this._terminalConfigurationService.config.environmentChangesRelaunch&&!this._processManager.hasWrittenData&&(!this._shellLaunchConfig.isFeatureTerminal||this.reconnectionProperties&&this._configurationService.getValue("task.reconnection")===!0)&&!this._shellLaunchConfig.customPtyImplementation&&!this._shellLaunchConfig.isExtensionOwnedTerminal&&!this._shellLaunchConfig.attachPersistentProcess&&!(this._processManager.remoteAuthority&&this._terminalConfigurationService.config.windowsEnableConpty&&await this._processManager.getBackendOS()===Y.Windows)){this.relaunch();return}const t=Li(this.shellLaunchConfig.cwd,this._workspaceContextService,this._historyService);this.statusList.add(e.getStatus({workspaceFolder:t}))}async getInitialCwd(){return this._initialCwd||(this._initialCwd=this._processManager.initialCwd),this._initialCwd}async getCwd(){return this.capabilities.has(_.CwdDetection)?this.capabilities.get(_.CwdDetection).getCwd():this.capabilities.has(_.NaiveCwdDetection)?this.capabilities.get(_.NaiveCwdDetection).getCwd():this._processManager.initialCwd}async _refreshProperty(e){return await this.processReady,this._processManager.refreshProperty(e)}async _updateProperty(e,t){return this._processManager.updateProperty(e,t)}async rename(e){this._setTitle(e,w.Api)}_setTitle(e,t){const i=!e;e=this._updateTitleProperties(e,t);const s=e!==this._title;this._title=e,this._labelComputer?.refreshLabel(this,i),this._setAriaLabel(this.xterm?.raw,this._instanceId,this._title),s&&this._onTitleChanged.fire(this)}async changeIcon(e){if(e)return this._icon=e,this._onIconChanged.fire({instance:this,userInitiated:!0}),e;const t=this._scopedInstantiationService.createInstance(Oi),i=await t.pickIcons();if(t.dispose(),!!i)return this._icon=i,this._onIconChanged.fire({instance:this,userInitiated:!0}),i}async changeColor(e,t){if(e)return this.shellLaunchConfig.color=e,this._onIconChanged.fire({instance:this,userInitiated:!0}),e;if(t){this.shellLaunchConfig.color="",this._onIconChanged.fire({instance:this,userInitiated:!0});return}if(!this._getIcon())return;const s=this._themeService.getColorTheme(),n=Ki(s),r=Mi(s),p=[];for(const y of n){const W=Fi(y);p.push({label:`$(${B.circleFilled.id}) ${y.replace("terminal.ansi","")}`,id:y,description:y,iconClasses:[W]})}p.push({type:"separator"});const b={label:"Reset to default"};p.push(b);const S=[],v=this._quickInputService.createQuickPick({useSeparators:!0});S.push(v),v.items=p,v.matchOnDescription=!0,v.placeholder=c.localize("changeColor","Select a color for the terminal"),v.show();const E=await new Promise(y=>{S.push(v.onDidHide(()=>y(void 0))),S.push(v.onDidAccept(()=>y(v.selectedItems[0])))});return he(S),E&&(this.shellLaunchConfig.color=E.id,this._onIconChanged.fire({instance:this,userInitiated:!0})),v.hide(),r.dispose(),E?.id}forceScrollbarVisibility(){this._wrapperElement.classList.add("force-scrollbar")}resetScrollbarVisibility(){this._wrapperElement.classList.remove("force-scrollbar")}setParentContextKeyService(e){this._scopedContextKeyService.updateParent(e)}async handleMouseEvent(e,t){if(h.isHTMLElement(e.target)&&(e.target.classList.contains("scrollbar")||e.target.classList.contains("slider")))return{cancelContextMenu:!0};if(e.which===2){switch(this._terminalConfigurationService.config.middleClickBehavior){case"paste":this.paste();break;case"default":default:this.focus();break}return}if(e.which===3){const i=this._terminalConfigurationService.config.rightClickBehavior;if(i==="nothing")return e.shiftKey?void 0:{cancelContextMenu:!0};if(i==="copyPaste"||i==="paste"){if(i==="copyPaste"&&e.shiftKey){Qi(h.getActiveWindow(),e,this,t,this._contextMenuService);return}return i==="copyPaste"&&this.hasSelection()?(await this.copySelection(),this.clearSelection()):re.clipboard.readText?this.paste():this._notificationService.info(`This browser doesn't support the clipboard.readText API needed to trigger a paste, try ${Z?"\u2318":"Ctrl"}+V instead.`),Z&&setTimeout(()=>this.clearSelection(),0),{cancelContextMenu:!0}}}}};I([X(50)],g.prototype,"_fireMaximumDimensionsChanged",1),I([X(1e3)],g.prototype,"relaunch",1),I([X(2e3)],g.prototype,"_updateProcessCwd",1),g=I([o(3,pe),o(4,$i),o(5,qe),o(6,Ce),o(7,xi),o(8,gi),o(9,Xe),o(10,je),o(11,vi),o(12,yi),o(13,Be),o(14,ai),o(15,Ve),o(16,ti),o(17,Ye),o(18,Ke),o(19,Ge),o(20,Qe),o(21,mi),o(22,ve),o(23,di),o(24,li),o(25,pi),o(26,Je),o(27,$e),o(28,ze),o(29,We),o(30,te)],g);let F=class extends j{constructor(e,t,i,s){super();this._container=e;this._layoutService=t;this._viewDescriptorService=i;this._hostService=s;this._register(G(()=>this._clearDropOverlay()))}_dropOverlay;_onDropFile=this._register(new l);get onDropFile(){return this._onDropFile.event}_onDropTerminal=this._register(new l);get onDropTerminal(){return this._onDropTerminal.event}_clearDropOverlay(){this._dropOverlay?.remove(),this._dropOverlay=void 0}onDragEnter(e){if(J(e,q.FILES,q.RESOURCES,se.Terminals,ue.FILES)){if(this._dropOverlay||(this._dropOverlay=document.createElement("div"),this._dropOverlay.classList.add("terminal-drop-overlay")),J(e,se.Terminals)){const t=this._getDropSide(e);this._dropOverlay.classList.toggle("drop-before",t==="before"),this._dropOverlay.classList.toggle("drop-after",t==="after")}this._dropOverlay.parentElement||this._container.appendChild(this._dropOverlay)}}onDragLeave(e){this._clearDropOverlay()}onDragEnd(e){this._clearDropOverlay()}onDragOver(e){if(!(!e.dataTransfer||!this._dropOverlay)){if(J(e,se.Terminals)){const t=this._getDropSide(e);this._dropOverlay.classList.toggle("drop-before",t==="before"),this._dropOverlay.classList.toggle("drop-after",t==="after")}this._dropOverlay.style.opacity="1"}}async onDrop(e){if(this._clearDropOverlay(),!e.dataTransfer)return;const t=Ni(e);if(t){for(const r of t){const p=this._getDropSide(e);this._onDropTerminal.fire({uri:r,side:p})}return}let i;const s=e.dataTransfer.getData(q.RESOURCES);s&&(i=R.parse(JSON.parse(s)[0]));const n=e.dataTransfer.getData(ue.FILES);!i&&n&&(i=R.file(JSON.parse(n)[0])),!i&&e.dataTransfer.files.length>0&&this._hostService.getPathForFile(e.dataTransfer.files[0])&&(i=R.file(this._hostService.getPathForFile(e.dataTransfer.files[0]))),i&&this._onDropFile.fire(i)}_getDropSide(e){const t=this._container;if(!t)return"after";const i=t.getBoundingClientRect();return this._getViewOrientation()===U.HORIZONTAL?e.clientX-i.left<i.width/2?"before":"after":e.clientY-i.top<i.height/2?"before":"after"}_getViewOrientation(){const e=this._layoutService.getPanelPosition();return this._viewDescriptorService.getViewLocationById(z)===ye.Panel&&_i(e)?U.HORIZONTAL:U.VERTICAL}};F=I([o(1,fi),o(2,te),o(3,ui)],F);var Ji=(e=>(e.Title="title",e.Description="description",e))(Ji||{});let K=class extends j{constructor(e,t,i){super();this._fileService=e;this._terminalConfigurationService=t;this._workspaceContextService=i}_title="";_description="";get title(){return this._title}get description(){return this._description}_onDidChangeLabel=this._register(new l);onDidChangeLabel=this._onDidChangeLabel.event;refreshLabel(e,t){this._title=this.computeLabel(e,this._terminalConfigurationService.config.tabs.title,"title",t),this._description=this.computeLabel(e,this._terminalConfigurationService.config.tabs.description,"description"),(this._title!==e.title||this._description!==e.description||t)&&this._onDidChangeLabel.fire({title:this._title,description:this._description})}computeLabel(e,t,i,s){const n=e.shellLaunchConfig.attachPersistentProcess?.type||e.shellLaunchConfig.type,r={cwd:e.cwd||e.initialCwd||"",cwdFolder:"",workspaceFolderName:e.workspaceFolder?.name,workspaceFolder:e.workspaceFolder?k.basename(e.workspaceFolder.uri.fsPath):void 0,local:n==="Local"?V.typeLocal:void 0,process:e.processName,sequence:e.sequence,task:n==="Task"?V.typeTask:void 0,fixedDimensions:e.fixedCols?e.fixedRows?`\u2194${e.fixedCols} \u2195${e.fixedRows}`:`\u2194${e.fixedCols}`:e.fixedRows?`\u2195${e.fixedRows}`:"",separator:{label:this._terminalConfigurationService.config.tabs.separator}};if(r.workspaceFolderName=e.workspaceFolder?.name??r.workspaceFolder,t=t.trim(),!t)return i==="title"&&e.processName||"";if(!s&&e.staticTitle&&i==="title")return e.staticTitle.replace(/[\n\r\t]/g,"")||r.process?.replace(/[\n\r\t]/g,"")||"";const p=e.capabilities.has(_.CwdDetection)||e.capabilities.has(_.NaiveCwdDetection),S=this._workspaceContextService.getWorkspace().folders.length>1;if(r.cwd&&p&&(!e.shellLaunchConfig.isFeatureTerminal||i==="title")){const E=R.from({scheme:e.workspaceFolder?.uri.scheme||Q.file,path:e.cwd?k.resolve(e.cwd):void 0});let y=!1;if(S)y=!0;else if(e.workspaceFolder?.uri){const W=this._fileService.hasCapability(e.workspaceFolder.uri,Ne.PathCaseSensitive);y=E.fsPath.localeCompare(e.workspaceFolder.uri.fsPath,void 0,{sensitivity:W?"case":"base"})!==0}y&&(r.cwdFolder=k.basename(r.cwd))}const v=Ae(t,r).replace(/[\n\r\t]/g,"").trim();return v===""&&i==="title"?e.processName||"":v}};K=I([o(0,He),o(1,Ce),o(2,ve)],K);function et(u,d,e,t){if(u===void 0||u===0)return{code:u,message:void 0};const i=typeof u=="number"?u:u.code;let s;switch(typeof u){case"number":{let n;d.executable&&(n=d.executable,typeof d.args=="string"?n+=` ${d.args}`:d.args&&d.args.length&&(n+=d.args.map(r=>` '${r}'`).join())),e===T.KilledDuringLaunch?n?s=c.localize("launchFailed.exitCodeAndCommandLine",'The terminal process "{0}" failed to launch (exit code: {1}).',n,i):s=c.localize("launchFailed.exitCodeOnly","The terminal process failed to launch (exit code: {0}).",i):n?s=c.localize("terminated.exitCodeAndCommandLine",'The terminal process "{0}" terminated with exit code: {1}.',n,i):s=c.localize("terminated.exitCodeOnly","The terminal process terminated with exit code: {0}.",i);break}case"object":{if(u.message.toString().includes("Could not find pty with id"))break;let n=u.message;const r=u.message.match(/.*error code:\s*(\d+).*$/);if(r)switch(r.length>1?Number.parseInt(r[1]):void 0){case 5:n=`Access was denied to the path containing your executable "${d.executable}". Manage and change your permissions to get this to work`;break;case 267:n=`Invalid starting directory "${t}", review your terminal.integrated.cwd setting`;break;case 1260:n="Windows cannot open this program because it has been prevented by a software restriction policy. For more information, open Event Viewer or contact your system Administrator";break}s=c.localize("launchFailed.errorMessage","The terminal process failed to launch: {0}.",n);break}}return{code:i,message:s}}let O=class{constructor(d,e){this._instance=d;this._viewDescriptorService=e}getBackgroundColor(d){const e=d.getColor(Pi);return e||(this._instance.target===ri.Editor?d.getColor(ni):this._viewDescriptorService.getViewLocationById(z)===ye.Panel?d.getColor(ci):d.getColor(hi))}};O=I([o(1,te)],O);export{g as TerminalInstance,O as TerminalInstanceColorProvider,K as TerminalLabelComputer,et as parseExitResult};
