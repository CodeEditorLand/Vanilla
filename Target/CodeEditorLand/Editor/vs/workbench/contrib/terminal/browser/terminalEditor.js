var v=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var u=(a,o,e,t)=>{for(var i=t>1?void 0:t?f(o,e):o,n=a.length-1,s;n>=0;n--)(s=a[n])&&(i=(t?s(o,e,i):s(i))||i);return t&&i&&v(o,e,i),i},r=(a,o)=>(e,t)=>o(e,t,a);import*as c from"../../../../base/browser/dom.js";import"../../../../base/browser/ui/actionbar/actionbar.js";import{Action as p}from"../../../../base/common/actions.js";import"../../../../base/common/cancellation.js";import{DropdownWithPrimaryActionViewItem as _}from"../../../../platform/actions/browser/dropdownWithPrimaryActionViewItem.js";import{IMenuService as S,MenuId as I,MenuItemAction as E}from"../../../../platform/actions/common/actions.js";import{IContextKeyService as w}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as g}from"../../../../platform/contextview/browser/contextView.js";import"../../../../platform/editor/common/editor.js";import{IInstantiationService as M}from"../../../../platform/instantiation/common/instantiation.js";import{IStorageService as C}from"../../../../platform/storage/common/storage.js";import{ITelemetryService as T}from"../../../../platform/telemetry/common/telemetry.js";import{IThemeService as y}from"../../../../platform/theme/common/themeService.js";import{EditorPane as b}from"../../../browser/parts/editor/editorPane.js";import"../../../common/editor.js";import{ITerminalConfigurationService as A,ITerminalEditorService as P,ITerminalService as D,terminalEditorId as x}from"./terminal.js";import"./terminalEditorInput.js";import{getTerminalActionBarArgs as V}from"./terminalMenus.js";import{ITerminalProfileResolverService as L,ITerminalProfileService as G,TerminalCommandId as k}from"../common/terminal.js";import"../../../services/editor/common/editorGroupsService.js";import{openContextMenu as O}from"./terminalContextMenu.js";import{ACTIVE_GROUP as R}from"../../../services/editor/common/editorService.js";import{IWorkbenchLayoutService as N,Parts as h}from"../../../services/layout/browser/layoutService.js";import"../../../../base/browser/ui/actionbar/actionViewItems.js";import{DisposableStore as B}from"../../../../base/common/lifecycle.js";let l=class extends b{constructor(e,t,i,n,s,F,H,W,m,d,K,j,U,$){super(x,e,t,i,n);this._terminalEditorService=s;this._terminalProfileResolverService=F;this._terminalService=H;this._terminalConfigurationService=W;this._instantiationService=K;this._contextMenuService=j;this._terminalProfileService=U;this._workbenchLayoutService=$;this._dropdownMenu=this._register(d.createMenu(I.TerminalNewDropdownContext,m)),this._instanceMenu=this._register(d.createMenu(I.TerminalInstanceContext,m))}_editorInstanceElement;_overflowGuardElement;_editorInput=void 0;_lastDimension;_dropdownMenu;_instanceMenu;_cancelContextMenu=!1;_disposableStore=this._register(new B);async setInput(e,t,i,n){this._editorInput?.terminalInstance?.detachFromElement(),this._editorInput=e,await super.setInput(e,t,i,n),this._editorInput.terminalInstance?.attachToElement(this._overflowGuardElement),this._lastDimension&&this.layout(this._lastDimension),this._editorInput.terminalInstance?.setVisible(this.isVisible()&&this._workbenchLayoutService.isVisible(h.EDITOR_PART,this.window)),this._editorInput.terminalInstance&&(this._register(this._editorInput.terminalInstance.onDidFocus(()=>this._setActiveInstance())),this._editorInput.setCopyLaunchConfig(this._editorInput.terminalInstance.shellLaunchConfig))}clearInput(){super.clearInput(),this._overflowGuardElement&&this._editorInput?.terminalInstance?.domElement.parentElement===this._overflowGuardElement&&this._editorInput.terminalInstance?.detachFromElement(),this._editorInput=void 0}_setActiveInstance(){this._editorInput?.terminalInstance&&this._terminalEditorService.setActiveInstance(this._editorInput.terminalInstance)}focus(){super.focus(),this._editorInput?.terminalInstance?.focus(!0)}createEditor(e){this._editorInstanceElement=e,this._overflowGuardElement=c.$(".terminal-overflow-guard.terminal-editor"),this._editorInstanceElement.appendChild(this._overflowGuardElement),this._registerListeners()}_registerListeners(){this._editorInstanceElement&&(this._register(c.addDisposableListener(this._editorInstanceElement,"mousedown",async e=>{const t=this._terminalEditorService.activeInstance;if(this._terminalEditorService.instances.length>0&&t){const i=await t.handleMouseEvent(e,this._instanceMenu);typeof i=="object"&&i.cancelContextMenu&&(this._cancelContextMenu=!0)}})),this._register(c.addDisposableListener(this._editorInstanceElement,"contextmenu",e=>{const t=this._terminalConfigurationService.config.rightClickBehavior;if(t==="nothing"&&!e.shiftKey){e.preventDefault(),e.stopImmediatePropagation(),this._cancelContextMenu=!1;return}else!this._cancelContextMenu&&t!=="copyPaste"&&t!=="paste"&&(this._cancelContextMenu||O(this.window,e,this._editorInput?.terminalInstance,this._instanceMenu,this._contextMenuService),e.preventDefault(),e.stopImmediatePropagation(),this._cancelContextMenu=!1)})))}layout(e){const t=this._editorInput?.terminalInstance;t&&(t.attachToElement(this._overflowGuardElement),t.layout(e)),this._lastDimension=e}setVisible(e){super.setVisible(e),this._editorInput?.terminalInstance?.setVisible(e&&this._workbenchLayoutService.isVisible(h.EDITOR_PART,this.window))}getActionViewItem(e,t){switch(e.id){case k.CreateTerminalEditor:if(e instanceof E){const n=V({viewColumn:R},this._terminalProfileService.availableProfiles,this._getDefaultProfileName(),this._terminalProfileService.contributedProfiles,this._terminalService,this._dropdownMenu);return this._registerDisposableActions(n.dropdownAction,n.dropdownMenuActions),this._instantiationService.createInstance(_,e,n.dropdownAction,n.dropdownMenuActions,n.className,{hoverDelegate:t.hoverDelegate})}}return super.getActionViewItem(e,t)}_registerDisposableActions(e,t){this._disposableStore.clear(),e instanceof p&&this._disposableStore.add(e),t.filter(i=>i instanceof p).forEach(i=>this._disposableStore.add(i))}_getDefaultProfileName(){let e;try{e=this._terminalProfileService.getDefaultProfileName()}catch{e=this._terminalProfileResolverService.defaultProfileName}return e}};l=u([r(1,T),r(2,y),r(3,C),r(4,P),r(5,L),r(6,D),r(7,A),r(8,w),r(9,S),r(10,M),r(11,g),r(12,G),r(13,N)],l);export{l as TerminalEditor};
