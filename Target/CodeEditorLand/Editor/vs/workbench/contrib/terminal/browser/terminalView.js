var ne=Object.defineProperty;var oe=Object.getOwnPropertyDescriptor;var v=(a,s,e,t)=>{for(var i=t>1?void 0:t?oe(s,e):s,n=a.length-1,o;n>=0;n--)(o=a[n])&&(i=(t?o(s,e,i):o(i))||i);return t&&i&&ne(s,e,i),i},r=(a,s)=>(e,t)=>s(e,t,a);import*as l from"../../../../base/browser/dom.js";import{ActionViewItem as se,SelectActionViewItem as ae}from"../../../../base/browser/ui/actionbar/actionViewItems.js";import{renderLabelWithIcons as ce}from"../../../../base/browser/ui/iconLabel/iconLabels.js";import{Action as P}from"../../../../base/common/actions.js";import{Event as G}from"../../../../base/common/event.js";import{DisposableStore as le,MutableDisposable as me,dispose as he,toDisposable as K}from"../../../../base/common/lifecycle.js";import{MicrotaskDelay as de}from"../../../../base/common/symbols.js";import{ThemeIcon as B}from"../../../../base/common/themables.js";import{URI as k}from"../../../../base/common/uri.js";import*as C from"../../../../nls.js";import{IAccessibilityService as W}from"../../../../platform/accessibility/common/accessibility.js";import{DropdownWithPrimaryActionViewItem as pe}from"../../../../platform/actions/browser/dropdownWithPrimaryActionViewItem.js";import{MenuEntryActionViewItem as ve,createAndFillInContextMenuActions as ue}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{IMenuService as _e,MenuId as F,MenuItemAction as N}from"../../../../platform/actions/common/actions.js";import{ICommandService as fe}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as R}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as $}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as z,IContextViewService as Se}from"../../../../platform/contextview/browser/contextView.js";import{IHoverService as U}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as j}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as L}from"../../../../platform/keybinding/common/keybinding.js";import{INotificationService as X,Severity as ge}from"../../../../platform/notification/common/notification.js";import{IOpenerService as Ie}from"../../../../platform/opener/common/opener.js";import{ITelemetryService as ye}from"../../../../platform/telemetry/common/telemetry.js";import{TerminalCapability as be}from"../../../../platform/terminal/common/capabilities/capabilities.js";import{TerminalLocation as _,TerminalSettingId as d}from"../../../../platform/terminal/common/terminal.js";import{defaultSelectBoxStyles as Ce}from"../../../../platform/theme/browser/defaultStyles.js";import{asCssVariable as Te,selectBorder as we}from"../../../../platform/theme/common/colorRegistry.js";import{ColorScheme as De}from"../../../../platform/theme/common/theme.js";import{IThemeService as T,Themable as Ae}from"../../../../platform/theme/common/themeService.js";import{ViewPane as Ee}from"../../../browser/parts/views/viewPane.js";import{IViewDescriptorService as Me}from"../../../common/views.js";import{ITerminalProfileResolverService as J,ITerminalProfileService as q,TerminalCommandId as w}from"../common/terminal.js";import{TerminalContextKeys as xe}from"../common/terminalContextKey.js";import{ITerminalConfigurationService as Q,ITerminalGroupService as f,ITerminalService as D,TerminalConnectionState as V,TerminalDataTransfers as Pe}from"./terminal.js";import{switchTerminalActionViewItemSeparator as Ge,switchTerminalShowTabsTitle as Le}from"./terminalActions.js";import{InstanceContext as Ve,TerminalContextActionRunner as He}from"./terminalContextMenu.js";import{getColorClass as Y,getUriClasses as Z}from"./terminalIcon.js";import{getTerminalActionBarArgs as ee}from"./terminalMenus.js";import{getColorForSeverity as Oe}from"./terminalStatusList.js";import{TerminalTabbedView as Ke}from"./terminalTabbedView.js";import{getInstanceHoverInfo as Be}from"./terminalTooltip.js";let A=class extends Ee{constructor(e,t,i,n,o,c,p,E,b,H,O,M,x,m,u,ie,Fe,Ne,Re,$e,ze){super(e,t,c,o,i,n,p,ie,O,M,x);this._contextKeyService=i;this._configurationService=o;this._contextMenuService=c;this._instantiationService=p;this._terminalService=E;this._terminalConfigurationService=b;this._terminalGroupService=H;this._notificationService=m;this._keybindingService=u;this._menuService=Fe;this._terminalProfileService=Ne;this._terminalProfileResolverService=Re;this._themeService=$e;this._accessibilityService=ze;this._register(this._terminalService.onDidRegisterProcessSupport(()=>{this._onDidChangeViewWelcomeState.fire()})),this._register(this._terminalService.onDidChangeInstances(()=>{this._hasWelcomeScreen()&&this._terminalGroupService.instances.length<=1&&this._onDidChangeViewWelcomeState.fire(),this._parentDomElement&&(this._terminalTabbedView||this._createTabsView(),this._terminalGroupService.instances.length===1&&this.layoutBody(this._parentDomElement.offsetHeight,this._parentDomElement.offsetWidth))})),this._dropdownMenu=this._register(this._menuService.createMenu(F.TerminalNewDropdownContext,this._contextKeyService)),this._singleTabMenu=this._register(this._menuService.createMenu(F.TerminalTabContext,this._contextKeyService)),this._register(this._terminalProfileService.onDidChangeAvailableProfiles(h=>this._updateTabActionBar(h))),this._viewShowing=xe.viewShowing.bindTo(this._contextKeyService),this._register(this.onDidChangeBodyVisibility(h=>{h&&this._terminalTabbedView?.rerenderTabs()})),this._register(this._configurationService.onDidChangeConfiguration(h=>{this._parentDomElement&&(h.affectsConfiguration(d.ShellIntegrationDecorationsEnabled)||h.affectsConfiguration(d.ShellIntegrationEnabled))&&this._updateForShellIntegration(this._parentDomElement)})),this._register(this._terminalService.onDidCreateInstance(h=>{h.capabilities.onDidAddCapabilityType(re=>{re===be.CommandDetection&&this._gutterDecorationsEnabled()&&this._parentDomElement?.classList.add("shell-integration")})}))}_parentDomElement;_terminalTabbedView;get terminalTabbedView(){return this._terminalTabbedView}_isInitialized=!1;_newDropdown=this._register(new me);_dropdownMenu;_singleTabMenu;_viewShowing;_disposableStore=this._register(new le);_updateForShellIntegration(e){e.classList.toggle("shell-integration",this._gutterDecorationsEnabled())}_gutterDecorationsEnabled(){const e=this._configurationService.getValue(d.ShellIntegrationDecorationsEnabled);return(e==="both"||e==="gutter")&&this._configurationService.getValue(d.ShellIntegrationEnabled)}_initializeTerminal(e){if(this.isBodyVisible()&&this._terminalService.isProcessSupportRegistered&&this._terminalService.connectionState===V.Connected){const t=this._isInitialized;this._isInitialized=!0;let i="never";t||(i=this._configurationService.getValue(d.HideOnStartup),i==="always"&&this._terminalGroupService.hidePanel());let n=this._terminalGroupService.groups.length===0;if(e&&(n&&=this._terminalService.restoredGroupCount===0),!n)return;if(!t){switch(i){case"never":this._terminalService.createTerminal({location:_.Panel});break;case"whenEmpty":this._terminalService.restoredGroupCount===0&&this._terminalGroupService.hidePanel();break}return}this._terminalService.createTerminal({location:_.Panel})}}renderBody(e){super.renderBody(e),this._parentDomElement||this._updateForShellIntegration(e),this._parentDomElement=e,this._parentDomElement.classList.add("integrated-terminal"),l.createStyleSheet(this._parentDomElement),this._instantiationService.createInstance(I,this._parentDomElement),this.shouldShowWelcome()||this._createTabsView(),this._register(this.configurationService.onDidChangeConfiguration(t=>{if((t.affectsConfiguration(d.FontFamily)||t.affectsConfiguration("editor.fontFamily"))&&!this._terminalConfigurationService.configFontIsMonospace()){const i=[{label:C.localize("terminal.useMonospace","Use 'monospace'"),run:()=>this.configurationService.updateValue(d.FontFamily,"monospace")}];this._notificationService.prompt(ge.Warning,C.localize("terminal.monospaceOnly","The terminal only supports monospace fonts. Be sure to restart VS Code if this is a newly installed font."),i)}})),this._register(this.onDidChangeBodyVisibility(async t=>{if(this._viewShowing.set(t),t)this._hasWelcomeScreen()&&this._onDidChangeViewWelcomeState.fire(),this._initializeTerminal(!1),this._terminalGroupService.showPanel(!1);else for(const i of this._terminalGroupService.instances)i.resetFocusContextKey();this._terminalGroupService.updateVisibility()})),this._register(this._terminalService.onDidChangeConnectionState(()=>this._initializeTerminal(!0))),this.layoutBody(this._parentDomElement.offsetHeight,this._parentDomElement.offsetWidth)}_createTabsView(){this._parentDomElement&&(this._terminalTabbedView=this._register(this.instantiationService.createInstance(Ke,this._parentDomElement)))}layoutBody(e,t){super.layoutBody(e,t),this._terminalTabbedView?.layout(t,e)}getActionViewItem(e,t){switch(e.id){case w.Split:{const i=this,n=new class extends P{constructor(){super(e.id,e.label,e.class,e.enabled),this.checked=e.checked,this.tooltip=e.tooltip,this._register(e)}async run(){const o=i._terminalGroupService.activeInstance;if(o)return(await i._terminalService.createTerminal({location:{parentTerminal:o}}))?.focusWhenReady()}};return new se(e,n,{...t,icon:!0,label:!1,keybinding:this._getKeybindingLabel(e)})}case w.SwitchTerminal:return this._instantiationService.createInstance(S,e);case w.Focus:if(e instanceof N){const i=[];return ue(this._singleTabMenu,{shouldForwardArgs:!0},i),this._instantiationService.createInstance(g,e,i)}case w.New:if(e instanceof N){const i=ee(_.Panel,this._terminalProfileService.availableProfiles,this._getDefaultProfileName(),this._terminalProfileService.contributedProfiles,this._terminalService,this._dropdownMenu);return this._registerDisposableActions(i.dropdownAction,i.dropdownMenuActions),this._newDropdown.value=new pe(e,i.dropdownAction,i.dropdownMenuActions,i.className,this._contextMenuService,{hoverDelegate:t.hoverDelegate},this._keybindingService,this._notificationService,this._contextKeyService,this._themeService,this._accessibilityService),this._newDropdown.value?.update(i.dropdownAction,i.dropdownMenuActions),this._newDropdown.value}}return super.getActionViewItem(e,t)}_registerDisposableActions(e,t){this._disposableStore.clear(),e instanceof P&&this._disposableStore.add(e),t.filter(i=>i instanceof P).forEach(i=>this._disposableStore.add(i))}_getDefaultProfileName(){let e;try{e=this._terminalProfileService.getDefaultProfileName()}catch{e=this._terminalProfileResolverService.defaultProfileName}return e}_getKeybindingLabel(e){return this._keybindingService.lookupKeybinding(e.id)?.getLabel()??void 0}_updateTabActionBar(e){const t=ee(_.Panel,e,this._getDefaultProfileName(),this._terminalProfileService.contributedProfiles,this._terminalService,this._dropdownMenu);this._registerDisposableActions(t.dropdownAction,t.dropdownMenuActions),this._newDropdown.value?.update(t.dropdownAction,t.dropdownMenuActions)}focus(){if(super.focus(),this._terminalService.connectionState===V.Connected){this._terminalGroupService.showPanel(!0);return}const e=this.element.ownerDocument.activeElement;e&&this._register(this._terminalService.onDidChangeConnectionState(()=>{e&&l.isActiveElement(e)&&this._terminalGroupService.showPanel(!0)}))}_hasWelcomeScreen(){return!this._terminalService.isProcessSupportRegistered}shouldShowWelcome(){return this._hasWelcomeScreen()&&this._terminalService.instances.length===0}};A=v([r(1,L),r(2,$),r(3,Me),r(4,R),r(5,z),r(6,j),r(7,D),r(8,Q),r(9,f),r(10,T),r(11,ye),r(12,U),r(13,X),r(14,L),r(15,Ie),r(16,_e),r(17,q),r(18,J),r(19,T),r(20,W)],A);let S=class extends ae{constructor(e,t,i,n,o){super(null,e,te(t,i),i.activeGroupIndex,n,Ce,{ariaLabel:C.localize("terminals","Open Terminals."),optionsAsChildren:!0});this._terminalService=t;this._terminalGroupService=i;this._register(t.onDidChangeInstances(()=>this._updateItems(),this)),this._register(t.onDidChangeActiveGroup(()=>this._updateItems(),this)),this._register(t.onDidChangeActiveInstance(()=>this._updateItems(),this)),this._register(t.onAnyInstanceTitleChange(()=>this._updateItems(),this)),this._register(i.onDidChangeGroups(()=>this._updateItems(),this)),this._register(t.onDidChangeConnectionState(()=>this._updateItems(),this)),this._register(o.onDidChangeAvailableProfiles(()=>this._updateItems(),this)),this._register(t.onAnyInstancePrimaryStatusChange(()=>this._updateItems(),this))}render(e){super.render(e),e.classList.add("switch-terminal"),e.style.borderColor=Te(we)}_updateItems(){const e=te(this._terminalService,this._terminalGroupService);this.setOptions(e,this._terminalGroupService.activeGroupIndex)}};S=v([r(1,D),r(2,f),r(3,Se),r(4,q)],S);function te(a,s){let e;return a.connectionState===V.Connected?e=s.getGroupLabels().map(t=>({text:t})):e=[{text:C.localize("terminalConnectingLabel","Starting...")}],e.push({text:Ge,isDisabled:!0}),e.push({text:Le}),e}let g=class extends ve{constructor(e,t,i,n,o,c,p,E,b,H,O,M,x){super(e,{draggable:!0,hoverDelegate:M.createInstance(y)},i,n,o,c,H,x);this._actions=t;this._terminalService=p;this._terminaConfigurationService=E;this._terminalGroupService=b;this._commandService=O;this._instantiationService=M;this._register(G.debounce(G.any(this._terminalService.onAnyInstancePrimaryStatusChange,this._terminalGroupService.onDidChangeActiveInstance,G.map(this._terminalService.onAnyInstanceIconChange,m=>m.instance),this._terminalService.onAnyInstanceTitleChange,this._terminalService.onDidChangeInstanceCapability),(m,u)=>(m||(m=new Set),u&&m.add(u),m),de)(m=>{for(const u of m)this.updateLabel(u)})),this._register(K(()=>he(this._elementDisposables)))}_color;_altCommand;_class;_elementDisposables=[];async onClick(e){this._terminalGroupService.lastAccessedMenu="inline-tab",e.altKey&&this._menuItemAction.alt?this._commandService.executeCommand(this._menuItemAction.alt.id,{location:_.Panel}):this._openContextMenu()}updateLabel(e){if(!(e&&e!==this._terminalGroupService.activeInstance)&&(this._elementDisposables.length===0&&this.element&&this.label&&(this._elementDisposables.push(l.addDisposableListener(this.element,l.EventType.CONTEXT_MENU,t=>{t.button===2&&(this._openContextMenu(),t.preventDefault())})),this._elementDisposables.push(l.addDisposableListener(this.element,l.EventType.AUXCLICK,t=>{if(t.button===1){const i=this._terminalGroupService.activeInstance;i&&this._terminalService.safeDisposeTerminal(i),t.preventDefault()}})),this._elementDisposables.push(l.addDisposableListener(this.element,l.EventType.DRAG_START,t=>{const i=this._terminalGroupService.activeInstance;t.dataTransfer&&i&&t.dataTransfer.setData(Pe.Terminals,JSON.stringify([i.resource.toString()]))}))),this.label)){const t=this.label,i=this._terminalGroupService.activeInstance;if(!i){l.reset(t,"");return}t.classList.add("single-terminal-tab");let n="";const o=i.statusList.primary;if(o){const E=Oe(o.severity);this._themeService.getColorTheme();const b=this._themeService.getColorTheme().getColor(E);b&&(n=b.toString())}t.style.color=n,l.reset(t,...ce(this._instantiationService.invokeFunction(ke,i,this._terminaConfigurationService.config.tabs.separator,B.isThemeIcon(this._commandAction.item.icon)?this._commandAction.item.icon:void 0))),this._altCommand&&(t.classList.remove(this._altCommand),this._altCommand=void 0),this._color&&(t.classList.remove(this._color),this._color=void 0),this._class&&(t.classList.remove(this._class),t.classList.remove("terminal-uri-icon"),this._class=void 0);const c=Y(i);c&&(this._color=c,t.classList.add(c));const p=Z(i,this._themeService.getColorTheme().type);p&&(this._class=p?.[0],t.classList.add(...p)),this._commandAction.item.icon&&(this._altCommand="alt-command",t.classList.add(this._altCommand)),this.updateTooltip()}}_openContextMenu(){this._contextMenuService.showContextMenu({actionRunner:new He,getAnchor:()=>this.element,getActions:()=>this._actions,getActionsContext:()=>{const e=this._terminalGroupService.activeInstance;return e?[new Ve(e)]:[]}})}};g=v([r(2,L),r(3,X),r(4,$),r(5,T),r(6,D),r(7,Q),r(8,f),r(9,z),r(10,fe),r(11,j),r(12,W)],g);function ke(a,s,e,t){if(!s||!s.title)return"";const i=B.isThemeIcon(s.icon)?s.icon.id:a.get(J).getDefaultIcon().id,n=`$(${t?.id||i}) ${We(s,e)}`,o=s.statusList.primary;return o?.icon?`${n} $(${o.icon.id})`:n}function We(a,s){return a?a.description?`${a.title} ${s} ${a.description}`:a.title:""}let I=class extends Ae{constructor(e,t,i,n){super(t);this._themeService=t;this._terminalService=i;this._terminalGroupService=n;this._registerListeners(),this._styleElement=l.createStyleSheet(e),this._register(K(()=>this._styleElement.remove())),this.updateStyles()}_styleElement;_registerListeners(){this._register(this._terminalService.onAnyInstanceIconChange(()=>this.updateStyles())),this._register(this._terminalService.onDidChangeInstances(()=>this.updateStyles())),this._register(this._terminalGroupService.onDidChangeGroups(()=>this.updateStyles()))}updateStyles(){super.updateStyles();const e=this._themeService.getColorTheme();let t="";for(const i of this._terminalService.instances){const n=i.icon;if(!n)continue;let o;n instanceof k?o=n:n instanceof Object&&"light"in n&&"dark"in n&&(o=e.type===De.LIGHT?n.light:n.dark);const c=Z(i,e.type);o instanceof k&&c&&c.length>1&&(t+=`.monaco-workbench .${c[0]} .monaco-highlighted-label .codicon, .monaco-action-bar .terminal-uri-icon.single-terminal-tab.action-label:not(.alt-command) .codicon{background-image: ${l.asCSSUrl(o)};}`)}for(const i of this._terminalService.instances){const n=Y(i);if(!n||!i.color)continue;const o=e.getColor(i.color);o&&(t+=`.monaco-workbench .${n} .codicon:first-child:not(.codicon-split-horizontal):not(.codicon-trashcan):not(.file-icon){ color: ${o} !important; }`)}this._styleElement.textContent=t}};I=v([r(1,T),r(2,D),r(3,f)],I);let y=class{constructor(s,e,t){this._configurationService=s;this._hoverService=e;this._terminalGroupService=t}_lastHoverHideTime=0;placement="element";get delay(){return Date.now()-this._lastHoverHideTime<200?0:this._configurationService.getValue("workbench.hover.delay")}showHover(s,e){const t=this._terminalGroupService.activeInstance;if(!t)return;const i=Be(t);return this._hoverService.showHover({...s,content:i.content,actions:i.actions},e)}onDidHideHover(){this._lastHoverHideTime=Date.now()}};y=v([r(0,R),r(1,U),r(2,f)],y);export{A as TerminalViewPane};
