var ne=Object.defineProperty;var oe=Object.getOwnPropertyDescriptor;var v=(a,s,e,i)=>{for(var t=i>1?void 0:i?oe(s,e):s,n=a.length-1,o;n>=0;n--)(o=a[n])&&(t=(i?o(s,e,t):o(t))||t);return i&&t&&ne(s,e,t),t},r=(a,s)=>(e,i)=>s(e,i,a);import*as l from"../../../../../vs/base/browser/dom.js";import"../../../../../vs/base/browser/ui/actionbar/actionbar.js";import{ActionViewItem as se,SelectActionViewItem as ae}from"../../../../../vs/base/browser/ui/actionbar/actionViewItems.js";import"../../../../../vs/base/browser/ui/hover/hoverDelegate.js";import{renderLabelWithIcons as ce}from"../../../../../vs/base/browser/ui/iconLabel/iconLabels.js";import"../../../../../vs/base/browser/ui/selectBox/selectBox.js";import{Action as x}from"../../../../../vs/base/common/actions.js";import{Event as G}from"../../../../../vs/base/common/event.js";import{DisposableStore as le,dispose as me,MutableDisposable as he,toDisposable as K}from"../../../../../vs/base/common/lifecycle.js";import{MicrotaskDelay as de}from"../../../../../vs/base/common/symbols.js";import{ThemeIcon as k}from"../../../../../vs/base/common/themables.js";import{URI as B}from"../../../../../vs/base/common/uri.js";import"../../../../../vs/editor/browser/editorExtensions.js";import*as C from"../../../../../vs/nls.js";import{IAccessibilityService as W}from"../../../../../vs/platform/accessibility/common/accessibility.js";import{DropdownWithPrimaryActionViewItem as pe}from"../../../../../vs/platform/actions/browser/dropdownWithPrimaryActionViewItem.js";import{createAndFillInContextMenuActions as ve,MenuEntryActionViewItem as ue}from"../../../../../vs/platform/actions/browser/menuEntryActionViewItem.js";import{IMenuService as _e,MenuId as F,MenuItemAction as N}from"../../../../../vs/platform/actions/common/actions.js";import{ICommandService as fe}from"../../../../../vs/platform/commands/common/commands.js";import{IConfigurationService as R}from"../../../../../vs/platform/configuration/common/configuration.js";import{IContextKeyService as $}from"../../../../../vs/platform/contextkey/common/contextkey.js";import{IContextMenuService as z,IContextViewService as Se}from"../../../../../vs/platform/contextview/browser/contextView.js";import{IHoverService as U}from"../../../../../vs/platform/hover/browser/hover.js";import{IInstantiationService as X}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{IKeybindingService as L}from"../../../../../vs/platform/keybinding/common/keybinding.js";import{INotificationService as j,Severity as ge}from"../../../../../vs/platform/notification/common/notification.js";import{IOpenerService as Ie}from"../../../../../vs/platform/opener/common/opener.js";import{ITelemetryService as ye}from"../../../../../vs/platform/telemetry/common/telemetry.js";import{TerminalCapability as be}from"../../../../../vs/platform/terminal/common/capabilities/capabilities.js";import{TerminalLocation as _,TerminalSettingId as d}from"../../../../../vs/platform/terminal/common/terminal.js";import{defaultSelectBoxStyles as Ce}from"../../../../../vs/platform/theme/browser/defaultStyles.js";import{asCssVariable as Te,selectBorder as we}from"../../../../../vs/platform/theme/common/colorRegistry.js";import{ColorScheme as De}from"../../../../../vs/platform/theme/common/theme.js";import{IThemeService as T,Themable as Ae}from"../../../../../vs/platform/theme/common/themeService.js";import{ViewPane as Ee}from"../../../../../vs/workbench/browser/parts/views/viewPane.js";import{IViewDescriptorService as Me}from"../../../../../vs/workbench/common/views.js";import{ITerminalConfigurationService as J,ITerminalGroupService as f,ITerminalService as w,TerminalConnectionState as V,TerminalDataTransfers as Pe}from"../../../../../vs/workbench/contrib/terminal/browser/terminal.js";import{switchTerminalActionViewItemSeparator as xe,switchTerminalShowTabsTitle as Ge}from"../../../../../vs/workbench/contrib/terminal/browser/terminalActions.js";import{InstanceContext as Le,TerminalContextActionRunner as Ve}from"../../../../../vs/workbench/contrib/terminal/browser/terminalContextMenu.js";import{getColorClass as q,getUriClasses as Q}from"../../../../../vs/workbench/contrib/terminal/browser/terminalIcon.js";import{getTerminalActionBarArgs as Y}from"../../../../../vs/workbench/contrib/terminal/browser/terminalMenus.js";import{getColorForSeverity as He}from"../../../../../vs/workbench/contrib/terminal/browser/terminalStatusList.js";import{TerminalTabbedView as Oe}from"../../../../../vs/workbench/contrib/terminal/browser/terminalTabbedView.js";import{getInstanceHoverInfo as Ke}from"../../../../../vs/workbench/contrib/terminal/browser/terminalTooltip.js";import{ITerminalProfileResolverService as Z,ITerminalProfileService as ee,TerminalCommandId as D}from"../../../../../vs/workbench/contrib/terminal/common/terminal.js";import{TerminalContextKeys as ke}from"../../../../../vs/workbench/contrib/terminal/common/terminalContextKey.js";let A=class extends Ee{constructor(e,i,t,n,o,c,p,E,b,H,O,M,P,m,u,te,Fe,Ne,Re,$e,ze){super(e,i,c,o,t,n,p,te,O,M,P);this._contextKeyService=t;this._configurationService=o;this._contextMenuService=c;this._instantiationService=p;this._terminalService=E;this._terminalConfigurationService=b;this._terminalGroupService=H;this._notificationService=m;this._keybindingService=u;this._menuService=Fe;this._terminalProfileService=Ne;this._terminalProfileResolverService=Re;this._themeService=$e;this._accessibilityService=ze;this._register(this._terminalService.onDidRegisterProcessSupport(()=>{this._onDidChangeViewWelcomeState.fire()})),this._register(this._terminalService.onDidChangeInstances(()=>{this._hasWelcomeScreen()&&this._terminalGroupService.instances.length<=1&&this._onDidChangeViewWelcomeState.fire(),this._parentDomElement&&(this._terminalTabbedView||this._createTabsView(),this._terminalGroupService.instances.length===1&&this.layoutBody(this._parentDomElement.offsetHeight,this._parentDomElement.offsetWidth))})),this._dropdownMenu=this._register(this._menuService.createMenu(F.TerminalNewDropdownContext,this._contextKeyService)),this._singleTabMenu=this._register(this._menuService.createMenu(F.TerminalTabContext,this._contextKeyService)),this._register(this._terminalProfileService.onDidChangeAvailableProfiles(h=>this._updateTabActionBar(h))),this._viewShowing=ke.viewShowing.bindTo(this._contextKeyService),this._register(this.onDidChangeBodyVisibility(h=>{h&&this._terminalTabbedView?.rerenderTabs()})),this._register(this._configurationService.onDidChangeConfiguration(h=>{this._parentDomElement&&(h.affectsConfiguration(d.ShellIntegrationDecorationsEnabled)||h.affectsConfiguration(d.ShellIntegrationEnabled))&&this._updateForShellIntegration(this._parentDomElement)})),this._register(this._terminalService.onDidCreateInstance(h=>{h.capabilities.onDidAddCapabilityType(re=>{re===be.CommandDetection&&this._gutterDecorationsEnabled()&&this._parentDomElement?.classList.add("shell-integration")})}))}_parentDomElement;_terminalTabbedView;get terminalTabbedView(){return this._terminalTabbedView}_isInitialized=!1;_newDropdown=this._register(new he);_dropdownMenu;_singleTabMenu;_viewShowing;_disposableStore=this._register(new le);_updateForShellIntegration(e){e.classList.toggle("shell-integration",this._gutterDecorationsEnabled())}_gutterDecorationsEnabled(){const e=this._configurationService.getValue(d.ShellIntegrationDecorationsEnabled);return(e==="both"||e==="gutter")&&this._configurationService.getValue(d.ShellIntegrationEnabled)}_initializeTerminal(e){if(this.isBodyVisible()&&this._terminalService.isProcessSupportRegistered&&this._terminalService.connectionState===V.Connected){const i=this._isInitialized;this._isInitialized=!0;let t="never";i||(t=this._configurationService.getValue(d.HideOnStartup),t==="always"&&this._terminalGroupService.hidePanel());let n=this._terminalGroupService.groups.length===0;if(e&&(n&&=this._terminalService.restoredGroupCount===0),!n)return;if(!i){switch(t){case"never":this._terminalService.createTerminal({location:_.Panel});break;case"whenEmpty":this._terminalService.restoredGroupCount===0&&this._terminalGroupService.hidePanel();break}return}this._terminalService.createTerminal({location:_.Panel})}}renderBody(e){super.renderBody(e),this._parentDomElement||this._updateForShellIntegration(e),this._parentDomElement=e,this._parentDomElement.classList.add("integrated-terminal"),l.createStyleSheet(this._parentDomElement),this._instantiationService.createInstance(I,this._parentDomElement),this.shouldShowWelcome()||this._createTabsView(),this._register(this.configurationService.onDidChangeConfiguration(i=>{if((i.affectsConfiguration(d.FontFamily)||i.affectsConfiguration("editor.fontFamily"))&&!this._terminalConfigurationService.configFontIsMonospace()){const t=[{label:C.localize("terminal.useMonospace","Use 'monospace'"),run:()=>this.configurationService.updateValue(d.FontFamily,"monospace")}];this._notificationService.prompt(ge.Warning,C.localize("terminal.monospaceOnly","The terminal only supports monospace fonts. Be sure to restart VS Code if this is a newly installed font."),t)}})),this._register(this.onDidChangeBodyVisibility(async i=>{if(this._viewShowing.set(i),i)this._hasWelcomeScreen()&&this._onDidChangeViewWelcomeState.fire(),this._initializeTerminal(!1),this._terminalGroupService.showPanel(!1);else for(const t of this._terminalGroupService.instances)t.resetFocusContextKey();this._terminalGroupService.updateVisibility()})),this._register(this._terminalService.onDidChangeConnectionState(()=>this._initializeTerminal(!0))),this.layoutBody(this._parentDomElement.offsetHeight,this._parentDomElement.offsetWidth)}_createTabsView(){this._parentDomElement&&(this._terminalTabbedView=this._register(this.instantiationService.createInstance(Oe,this._parentDomElement)))}layoutBody(e,i){super.layoutBody(e,i),this._terminalTabbedView?.layout(i,e)}getActionViewItem(e,i){switch(e.id){case D.Split:{const t=this,n=new class extends x{constructor(){super(e.id,e.label,e.class,e.enabled),this.checked=e.checked,this.tooltip=e.tooltip,this._register(e)}async run(){const o=t._terminalGroupService.activeInstance;if(o)return(await t._terminalService.createTerminal({location:{parentTerminal:o}}))?.focusWhenReady()}};return new se(e,n,{...i,icon:!0,label:!1,keybinding:this._getKeybindingLabel(e)})}case D.SwitchTerminal:return this._instantiationService.createInstance(S,e);case D.Focus:if(e instanceof N){const t=[];return ve(this._singleTabMenu,{shouldForwardArgs:!0},t),this._instantiationService.createInstance(g,e,t)}case D.New:if(e instanceof N){const t=Y(_.Panel,this._terminalProfileService.availableProfiles,this._getDefaultProfileName(),this._terminalProfileService.contributedProfiles,this._terminalService,this._dropdownMenu);return this._registerDisposableActions(t.dropdownAction,t.dropdownMenuActions),this._newDropdown.value=new pe(e,t.dropdownAction,t.dropdownMenuActions,t.className,this._contextMenuService,{hoverDelegate:i.hoverDelegate},this._keybindingService,this._notificationService,this._contextKeyService,this._themeService,this._accessibilityService),this._newDropdown.value?.update(t.dropdownAction,t.dropdownMenuActions),this._newDropdown.value}}return super.getActionViewItem(e,i)}_registerDisposableActions(e,i){this._disposableStore.clear(),e instanceof x&&this._disposableStore.add(e),i.filter(t=>t instanceof x).forEach(t=>this._disposableStore.add(t))}_getDefaultProfileName(){let e;try{e=this._terminalProfileService.getDefaultProfileName()}catch{e=this._terminalProfileResolverService.defaultProfileName}return e}_getKeybindingLabel(e){return this._keybindingService.lookupKeybinding(e.id)?.getLabel()??void 0}_updateTabActionBar(e){const i=Y(_.Panel,e,this._getDefaultProfileName(),this._terminalProfileService.contributedProfiles,this._terminalService,this._dropdownMenu);this._registerDisposableActions(i.dropdownAction,i.dropdownMenuActions),this._newDropdown.value?.update(i.dropdownAction,i.dropdownMenuActions)}focus(){if(super.focus(),this._terminalService.connectionState===V.Connected){this._terminalGroupService.showPanel(!0);return}const e=this.element.ownerDocument.activeElement;e&&this._register(this._terminalService.onDidChangeConnectionState(()=>{e&&l.isActiveElement(e)&&this._terminalGroupService.showPanel(!0)}))}_hasWelcomeScreen(){return!this._terminalService.isProcessSupportRegistered}shouldShowWelcome(){return this._hasWelcomeScreen()&&this._terminalService.instances.length===0}};A=v([r(1,L),r(2,$),r(3,Me),r(4,R),r(5,z),r(6,X),r(7,w),r(8,J),r(9,f),r(10,T),r(11,ye),r(12,U),r(13,j),r(14,L),r(15,Ie),r(16,_e),r(17,ee),r(18,Z),r(19,T),r(20,W)],A);let S=class extends ae{constructor(e,i,t,n,o){super(null,e,ie(i,t),t.activeGroupIndex,n,Ce,{ariaLabel:C.localize("terminals","Open Terminals."),optionsAsChildren:!0});this._terminalService=i;this._terminalGroupService=t;this._register(i.onDidChangeInstances(()=>this._updateItems(),this)),this._register(i.onDidChangeActiveGroup(()=>this._updateItems(),this)),this._register(i.onDidChangeActiveInstance(()=>this._updateItems(),this)),this._register(i.onAnyInstanceTitleChange(()=>this._updateItems(),this)),this._register(t.onDidChangeGroups(()=>this._updateItems(),this)),this._register(i.onDidChangeConnectionState(()=>this._updateItems(),this)),this._register(o.onDidChangeAvailableProfiles(()=>this._updateItems(),this)),this._register(i.onAnyInstancePrimaryStatusChange(()=>this._updateItems(),this))}render(e){super.render(e),e.classList.add("switch-terminal"),e.style.borderColor=Te(we)}_updateItems(){const e=ie(this._terminalService,this._terminalGroupService);this.setOptions(e,this._terminalGroupService.activeGroupIndex)}};S=v([r(1,w),r(2,f),r(3,Se),r(4,ee)],S);function ie(a,s){let e;return a.connectionState===V.Connected?e=s.getGroupLabels().map(i=>({text:i})):e=[{text:C.localize("terminalConnectingLabel","Starting...")}],e.push({text:xe,isDisabled:!0}),e.push({text:Ge}),e}let g=class extends ue{constructor(e,i,t,n,o,c,p,E,b,H,O,M,P){super(e,{draggable:!0,hoverDelegate:M.createInstance(y)},t,n,o,c,H,P);this._actions=i;this._terminalService=p;this._terminaConfigurationService=E;this._terminalGroupService=b;this._commandService=O;this._instantiationService=M;this._register(G.debounce(G.any(this._terminalService.onAnyInstancePrimaryStatusChange,this._terminalGroupService.onDidChangeActiveInstance,G.map(this._terminalService.onAnyInstanceIconChange,m=>m.instance),this._terminalService.onAnyInstanceTitleChange,this._terminalService.onDidChangeInstanceCapability),(m,u)=>(m||(m=new Set),u&&m.add(u),m),de)(m=>{for(const u of m)this.updateLabel(u)})),this._register(K(()=>me(this._elementDisposables)))}_color;_altCommand;_class;_elementDisposables=[];async onClick(e){this._terminalGroupService.lastAccessedMenu="inline-tab",e.altKey&&this._menuItemAction.alt?this._commandService.executeCommand(this._menuItemAction.alt.id,{location:_.Panel}):this._openContextMenu()}updateLabel(e){if(!(e&&e!==this._terminalGroupService.activeInstance)&&(this._elementDisposables.length===0&&this.element&&this.label&&(this._elementDisposables.push(l.addDisposableListener(this.element,l.EventType.CONTEXT_MENU,i=>{i.button===2&&(this._openContextMenu(),i.preventDefault())})),this._elementDisposables.push(l.addDisposableListener(this.element,l.EventType.AUXCLICK,i=>{if(i.button===1){const t=this._terminalGroupService.activeInstance;t&&this._terminalService.safeDisposeTerminal(t),i.preventDefault()}})),this._elementDisposables.push(l.addDisposableListener(this.element,l.EventType.DRAG_START,i=>{const t=this._terminalGroupService.activeInstance;i.dataTransfer&&t&&i.dataTransfer.setData(Pe.Terminals,JSON.stringify([t.resource.toString()]))}))),this.label)){const i=this.label,t=this._terminalGroupService.activeInstance;if(!t){l.reset(i,"");return}i.classList.add("single-terminal-tab");let n="";const o=t.statusList.primary;if(o){const E=He(o.severity);this._themeService.getColorTheme();const b=this._themeService.getColorTheme().getColor(E);b&&(n=b.toString())}i.style.color=n,l.reset(i,...ce(this._instantiationService.invokeFunction(Be,t,this._terminaConfigurationService.config.tabs.separator,k.isThemeIcon(this._commandAction.item.icon)?this._commandAction.item.icon:void 0))),this._altCommand&&(i.classList.remove(this._altCommand),this._altCommand=void 0),this._color&&(i.classList.remove(this._color),this._color=void 0),this._class&&(i.classList.remove(this._class),i.classList.remove("terminal-uri-icon"),this._class=void 0);const c=q(t);c&&(this._color=c,i.classList.add(c));const p=Q(t,this._themeService.getColorTheme().type);p&&(this._class=p?.[0],i.classList.add(...p)),this._commandAction.item.icon&&(this._altCommand="alt-command",i.classList.add(this._altCommand)),this.updateTooltip()}}_openContextMenu(){this._contextMenuService.showContextMenu({actionRunner:new Ve,getAnchor:()=>this.element,getActions:()=>this._actions,getActionsContext:()=>{const e=this._terminalGroupService.activeInstance;return e?[new Le(e)]:[]}})}};g=v([r(2,L),r(3,j),r(4,$),r(5,T),r(6,w),r(7,J),r(8,f),r(9,z),r(10,fe),r(11,X),r(12,W)],g);function Be(a,s,e,i){if(!s||!s.title)return"";const t=k.isThemeIcon(s.icon)?s.icon.id:a.get(Z).getDefaultIcon().id,n=`$(${i?.id||t}) ${We(s,e)}`,o=s.statusList.primary;return o?.icon?`${n} $(${o.icon.id})`:n}function We(a,s){return a?a.description?`${a.title} ${s} ${a.description}`:a.title:""}let I=class extends Ae{constructor(e,i,t,n){super(i);this._themeService=i;this._terminalService=t;this._terminalGroupService=n;this._registerListeners(),this._styleElement=l.createStyleSheet(e),this._register(K(()=>this._styleElement.remove())),this.updateStyles()}_styleElement;_registerListeners(){this._register(this._terminalService.onAnyInstanceIconChange(()=>this.updateStyles())),this._register(this._terminalService.onDidChangeInstances(()=>this.updateStyles())),this._register(this._terminalGroupService.onDidChangeGroups(()=>this.updateStyles()))}updateStyles(){super.updateStyles();const e=this._themeService.getColorTheme();let i="";for(const t of this._terminalService.instances){const n=t.icon;if(!n)continue;let o;n instanceof B?o=n:n instanceof Object&&"light"in n&&"dark"in n&&(o=e.type===De.LIGHT?n.light:n.dark);const c=Q(t,e.type);o instanceof B&&c&&c.length>1&&(i+=`.monaco-workbench .${c[0]} .monaco-highlighted-label .codicon, .monaco-action-bar .terminal-uri-icon.single-terminal-tab.action-label:not(.alt-command) .codicon{background-image: ${l.asCSSUrl(o)};}`)}for(const t of this._terminalService.instances){const n=q(t);if(!n||!t.color)continue;const o=e.getColor(t.color);o&&(i+=`.monaco-workbench .${n} .codicon:first-child:not(.codicon-split-horizontal):not(.codicon-trashcan):not(.file-icon){ color: ${o} !important; }`)}this._styleElement.textContent=i}};I=v([r(1,T),r(2,w),r(3,f)],I);let y=class{constructor(s,e,i){this._configurationService=s;this._hoverService=e;this._terminalGroupService=i}_lastHoverHideTime=0;placement="element";get delay(){return Date.now()-this._lastHoverHideTime<200?0:this._configurationService.getValue("workbench.hover.delay")}showHover(s,e){const i=this._terminalGroupService.activeInstance;if(!i)return;const t=Ke(i);return this._hoverService.showHover({...s,content:t.content,actions:t.actions},e)}onDidHideHover(){this._lastHoverHideTime=Date.now()}};y=v([r(0,R),r(1,U),r(2,f)],y);export{A as TerminalViewPane};
