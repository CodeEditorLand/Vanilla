var x=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var I=(d,n,t,e)=>{for(var i=e>1?void 0:e?O(n,t):n,s=d.length-1,a;s>=0;s--)(a=d[s])&&(i=(e?a(n,t,i):a(i))||i);return e&&i&&x(n,t,i),i},g=(d,n)=>(t,e)=>n(t,e,d);import{disposableTimeout as T}from"../../../../base/common/async.js";import{Disposable as D,DisposableStore as F}from"../../../../base/common/lifecycle.js";import{autorun as N,autorunWithStore as w,derived as R,observableFromEvent as W,observableFromPromise as V,observableFromValueWithChangeEvent as j,observableSignalFromEvent as L,wasEventTriggeredRecently as B}from"../../../../base/common/observable.js";import{isDefined as q}from"../../../../base/common/types.js";import{isCodeEditor as z,isDiffEditor as G}from"../../../../editor/browser/editorBrowser.js";import{CursorChangeReason as M}from"../../../../editor/common/cursorEvents.js";import{FoldingController as H}from"../../../../editor/contrib/folding/browser/folding.js";import{AccessibilitySignal as m,IAccessibilitySignalService as J}from"../../../../platform/accessibilitySignal/browser/accessibilitySignalService.js";import{IInstantiationService as K}from"../../../../platform/instantiation/common/instantiation.js";import{IMarkerService as Q,MarkerSeverity as k}from"../../../../platform/markers/common/markers.js";import{IEditorService as U}from"../../../services/editor/common/editorService.js";import{IDebugService as X}from"../../debug/common/debug.js";let A=class extends D{constructor(t,e,i){super();this._editorService=t;this._instantiationService=e;this._accessibilitySignalService=i;this._register(w((s,a)=>{if(!this._someAccessibilitySignalIsEnabled.read(s))return;const r=this._activeEditorObservable.read(s);r&&this._registerAccessibilitySignalsForEditor(r.editor,r.model,a)}))}_textProperties=[this._instantiationService.createInstance(v,m.errorAtPosition,m.errorOnLine,k.Error),this._instantiationService.createInstance(v,m.warningAtPosition,m.warningOnLine,k.Warning),this._instantiationService.createInstance(Y),this._instantiationService.createInstance(f)];_someAccessibilitySignalIsEnabled=R(this,t=>this._textProperties.flatMap(e=>[e.lineSignal,e.positionSignal]).filter(q).some(e=>j(this,this._accessibilitySignalService.getEnabledState(e,!1)).read(t)));_activeEditorObservable=W(this,this._editorService.onDidActiveEditorChange,t=>{const e=this._editorService.activeTextEditorControl,i=G(e)?e.getOriginalEditor():z(e)?e:void 0;return i&&i.hasModel()?{editor:i,model:i.getModel()}:void 0});_registerAccessibilitySignalsForEditor(t,e,i){let s=-1;const a=new Set,r=i.add(new F),u=this._textProperties.map(c=>({source:c.createSource(t,e),property:c})),C=B(t.onDidChangeModelContent,100,i);i.add(t.onDidChangeCursorPosition(c=>{if(r.clear(),c&&c.reason!==M.Explicit&&c.reason!==M.NotSet){a.clear();return}const h=(o,b,p)=>{const l=p==="line"?o.lineSignal:o.positionSignal;if(!(!l||!this._accessibilitySignalService.getEnabledState(l,!1).value||!b.isPresent(E,p,void 0))){for(const S of["sound","announcement"])if(this._accessibilitySignalService.getEnabledState(l,!1,S).value){const P=this._accessibilitySignalService.getDelayMs(l,S,p)+(C.get()?1e3:0);r.add(T(()=>{b.isPresent(E,p,void 0)&&((p!=="line"||!a.has(o))&&this._accessibilitySignalService.playSignal(l,{modality:S}),a.add(o))},P))}}},E=c.position,_=E.lineNumber;if(_!==s){a.clear(),s=_;for(const o of u)h(o.property,o.source,"line")}for(const o of u)h(o.property,o.source,"positional");for(const o of u){if(![o.property.lineSignal,o.property.positionSignal].some(l=>l&&this._accessibilitySignalService.getEnabledState(l,!1).value))return;let b,p;r.add(N(l=>{const S=o.source.isPresentAtPosition(c.position,l),P=o.source.isPresentOnLine(c.position.lineNumber,l);b!==void 0&&b!==void 0&&(!b&&S&&h(o.property,o.source,"positional"),!p&&P&&h(o.property,o.source,"line")),b=S,p=P}))}}))}};A=I([g(0,U),g(1,K),g(2,J)],A);class y{static notPresent=new y({isPresentAtPosition:()=>!1,isPresentOnLine:()=>!1});isPresentOnLine;isPresentAtPosition;constructor(n){this.isPresentOnLine=n.isPresentOnLine,this.isPresentAtPosition=n.isPresentAtPosition??(()=>!1)}isPresent(n,t,e){return t==="line"?this.isPresentOnLine(n.lineNumber,e):this.isPresentAtPosition(n,e)}}let v=class{constructor(n,t,e,i){this.positionSignal=n;this.lineSignal=t;this.severity=e;this.markerService=i}debounceWhileTyping=!0;createSource(n,t){const e=L("onMarkerChanged",this.markerService.onMarkerChanged);return new y({isPresentAtPosition:(i,s)=>(e.read(s),this.markerService.read({resource:t.uri}).some(r=>r.severity===this.severity&&r.startLineNumber<=i.lineNumber&&i.lineNumber<=r.endLineNumber&&r.startColumn<=i.column&&i.column<=r.endColumn)),isPresentOnLine:(i,s)=>(e.read(s),this.markerService.read({resource:t.uri}).some(r=>r.severity===this.severity&&r.startLineNumber<=i&&i<=r.endLineNumber))})}};v=I([g(3,Q)],v);class Y{lineSignal=m.foldedArea;createSource(n,t){const e=H.get(n);if(!e)return y.notPresent;const i=V(e.getFoldingModel()??Promise.resolve(void 0));return new y({isPresentOnLine(s,a){const u=i.read(a).value?.getRegionAtLine(s);return u?u.isCollapsed&&u.startLineNumber===s:!1}})}}let f=class{constructor(n){this.debugService=n}lineSignal=m.break;createSource(n,t){const e=L("onDidChangeBreakpoints",this.debugService.getModel().onDidChangeBreakpoints),i=this.debugService;return new y({isPresentOnLine(s,a){return e.read(a),i.getModel().getBreakpoints({uri:t.uri,lineNumber:s}).length>0}})}};f=I([g(0,X)],f);export{A as EditorTextPropertySignalsContribution};
