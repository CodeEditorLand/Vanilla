var K=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var S=(s,e,i,r)=>{for(var t=r>1?void 0:r?F(e,i):e,n=s.length-1,w;n>=0;n--)(w=s[n])&&(t=(r?w(e,i,t):w(t))||t);return r&&t&&K(e,i,t),t},d=(s,e)=>(i,r)=>e(i,r,s);import{CancellationTokenSource as E}from"../../../../../vs/base/common/cancellation.js";import{Codicon as b}from"../../../../../vs/base/common/codicons.js";import{isCancellationError as W}from"../../../../../vs/base/common/errors.js";import{Event as x}from"../../../../../vs/base/common/event.js";import{KeyCode as h,KeyMod as l}from"../../../../../vs/base/common/keyCodes.js";import{DisposableStore as D}from"../../../../../vs/base/common/lifecycle.js";import"../../../../../vs/editor/browser/editorBrowser.js";import{EditorAction2 as g,EditorContributionInstantiation as A,registerEditorContribution as R}from"../../../../../vs/editor/browser/editorExtensions.js";import{ICodeEditorService as O}from"../../../../../vs/editor/browser/services/codeEditorService.js";import"../../../../../vs/editor/common/core/position.js";import{Range as V}from"../../../../../vs/editor/common/core/range.js";import"../../../../../vs/editor/common/editorCommon.js";import{EditorContextKeys as P}from"../../../../../vs/editor/common/editorContextKeys.js";import{PeekContext as k}from"../../../../../vs/editor/contrib/peekView/browser/peekView.js";import{localize as c,localize2 as _}from"../../../../../vs/nls.js";import{MenuId as q,registerAction2 as m}from"../../../../../vs/platform/actions/common/actions.js";import{ContextKeyExpr as C,IContextKeyService as L,RawContextKey as I}from"../../../../../vs/platform/contextkey/common/contextkey.js";import{IInstantiationService as z}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{KeybindingWeight as y}from"../../../../../vs/platform/keybinding/common/keybindingsRegistry.js";import{IStorageService as N,StorageScope as T,StorageTarget as U}from"../../../../../vs/platform/storage/common/storage.js";import{registerIcon as M}from"../../../../../vs/platform/theme/common/iconRegistry.js";import{CallHierarchyTreePeekWidget as v}from"../../../../../vs/workbench/contrib/callHierarchy/browser/callHierarchyPeek.js";import{CallHierarchyDirection as a,CallHierarchyModel as j,CallHierarchyProviderRegistry as f}from"../../../../../vs/workbench/contrib/callHierarchy/common/callHierarchy.js";const H=new I("editorHasCallHierarchyProvider",!1,c("editorHasCallHierarchyProvider","Whether a call hierarchy provider is available")),u=new I("callHierarchyVisible",!1,c("callHierarchyVisible","Whether call hierarchy peek is currently showing")),p=new I("callHierarchyDirection",void 0,{type:"string",description:c("callHierarchyDirection","Whether call hierarchy shows incoming or outgoing calls")});function B(s){return s===a.CallsFrom||s===a.CallsTo?s:a.CallsTo}let o=class{constructor(e,i,r,t,n){this._editor=e;this._contextKeyService=i;this._storageService=r;this._editorService=t;this._instantiationService=n;this._ctxIsVisible=u.bindTo(this._contextKeyService),this._ctxHasProvider=H.bindTo(this._contextKeyService),this._ctxDirection=p.bindTo(this._contextKeyService),this._dispoables.add(x.any(e.onDidChangeModel,e.onDidChangeModelLanguage,f.onDidChange)(()=>{this._ctxHasProvider.set(e.hasModel()&&f.has(e.getModel()))})),this._dispoables.add(this._sessionDisposables)}static Id="callHierarchy";static get(e){return e.getContribution(o.Id)}static _StorageDirection="callHierarchy/defaultDirection";_ctxHasProvider;_ctxIsVisible;_ctxDirection;_dispoables=new D;_sessionDisposables=new D;_widget;dispose(){this._ctxHasProvider.reset(),this._ctxIsVisible.reset(),this._dispoables.dispose()}async startCallHierarchyFromEditor(){if(this._sessionDisposables.clear(),!this._editor.hasModel())return;const e=this._editor.getModel(),i=this._editor.getPosition();if(!f.has(e))return;const r=new E,t=j.create(e,i,r.token),n=B(this._storageService.get(o._StorageDirection,T.PROFILE,a.CallsTo));this._showCallHierarchyWidget(i,n,t,r)}async startCallHierarchyFromCallHierarchy(){if(!this._widget)return;const e=this._widget.getModel(),i=this._widget.getFocused();if(!i||!e)return;const r=await this._editorService.openCodeEditor({resource:i.item.uri},this._editor);if(!r)return;const t=e.fork(i.item);this._sessionDisposables.clear(),o.get(r)?._showCallHierarchyWidget(V.lift(t.root.selectionRange).getStartPosition(),this._widget.direction,Promise.resolve(t),new E)}_showCallHierarchyWidget(e,i,r,t){this._ctxIsVisible.set(!0),this._ctxDirection.set(i),x.any(this._editor.onDidChangeModel,this._editor.onDidChangeModelLanguage)(this.endCallHierarchy,this,this._sessionDisposables),this._widget=this._instantiationService.createInstance(v,this._editor,e,i),this._widget.showLoading(),this._sessionDisposables.add(this._widget.onDidClose(()=>{this.endCallHierarchy(),this._storageService.store(o._StorageDirection,this._widget.direction,T.PROFILE,U.USER)})),this._sessionDisposables.add({dispose(){t.dispose(!0)}}),this._sessionDisposables.add(this._widget),r.then(n=>{t.token.isCancellationRequested||(n?(this._sessionDisposables.add(n),this._widget.showModel(n)):this._widget.showMessage(c("no.item","No results")))}).catch(n=>{if(W(n)){this.endCallHierarchy();return}this._widget.showMessage(c("error","Failed to show call hierarchy"))})}showOutgoingCalls(){this._widget?.updateDirection(a.CallsFrom),this._ctxDirection.set(a.CallsFrom)}showIncomingCalls(){this._widget?.updateDirection(a.CallsTo),this._ctxDirection.set(a.CallsTo)}endCallHierarchy(){this._sessionDisposables.clear(),this._ctxIsVisible.set(!1),this._editor.focus()}};o=S([d(1,L),d(2,N),d(3,O),d(4,z)],o),R(o.Id,o,A.Eager),m(class extends g{constructor(){super({id:"editor.showCallHierarchy",title:_("title","Peek Call Hierarchy"),menu:{id:q.EditorContextPeek,group:"navigation",order:1e3,when:C.and(H,k.notInPeekEditor,P.isInEmbeddedEditor.toNegated())},keybinding:{when:P.editorTextFocus,weight:y.WorkbenchContrib,primary:l.Shift+l.Alt+h.KeyH},precondition:C.and(H,k.notInPeekEditor),f1:!0})}async runEditorCommand(e,i){return o.get(i)?.startCallHierarchyFromEditor()}}),m(class extends g{constructor(){super({id:"editor.showIncomingCalls",title:_("title.incoming","Show Incoming Calls"),icon:M("callhierarchy-incoming",b.callIncoming,c("showIncomingCallsIcons","Icon for incoming calls in the call hierarchy view.")),precondition:C.and(u,p.isEqualTo(a.CallsFrom)),keybinding:{weight:y.WorkbenchContrib,primary:l.Shift+l.Alt+h.KeyH},menu:{id:v.TitleMenu,when:p.isEqualTo(a.CallsFrom),order:1}})}runEditorCommand(s,e){return o.get(e)?.showIncomingCalls()}}),m(class extends g{constructor(){super({id:"editor.showOutgoingCalls",title:_("title.outgoing","Show Outgoing Calls"),icon:M("callhierarchy-outgoing",b.callOutgoing,c("showOutgoingCallsIcon","Icon for outgoing calls in the call hierarchy view.")),precondition:C.and(u,p.isEqualTo(a.CallsTo)),keybinding:{weight:y.WorkbenchContrib,primary:l.Shift+l.Alt+h.KeyH},menu:{id:v.TitleMenu,when:p.isEqualTo(a.CallsTo),order:1}})}runEditorCommand(s,e){return o.get(e)?.showOutgoingCalls()}}),m(class extends g{constructor(){super({id:"editor.refocusCallHierarchy",title:_("title.refocus","Refocus Call Hierarchy"),precondition:u,keybinding:{weight:y.WorkbenchContrib,primary:l.Shift+h.Enter}})}async runEditorCommand(s,e){return o.get(e)?.startCallHierarchyFromCallHierarchy()}}),m(class extends g{constructor(){super({id:"editor.closeCallHierarchy",title:c("close","Close"),icon:b.close,precondition:u,keybinding:{weight:y.WorkbenchContrib+10,primary:h.Escape,when:C.not("config.editor.stablePeek")},menu:{id:v.TitleMenu,order:1e3}})}runEditorCommand(s,e){return o.get(e)?.endCallHierarchy()}});
