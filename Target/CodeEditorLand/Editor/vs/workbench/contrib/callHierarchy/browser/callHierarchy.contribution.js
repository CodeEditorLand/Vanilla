var K=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var S=(s,e,i,r)=>{for(var t=r>1?void 0:r?F(e,i):e,n=s.length-1,w;n>=0;n--)(w=s[n])&&(t=(r?w(e,i,t):w(t))||t);return r&&t&&K(e,i,t),t},d=(s,e)=>(i,r)=>e(i,r,s);import{localize as c,localize2 as _}from"../../../../nls.js";import{CallHierarchyProviderRegistry as b,CallHierarchyDirection as a,CallHierarchyModel as W}from"../common/callHierarchy.js";import{CancellationTokenSource as E}from"../../../../base/common/cancellation.js";import{IInstantiationService as A}from"../../../../platform/instantiation/common/instantiation.js";import{CallHierarchyTreePeekWidget as v}from"./callHierarchyPeek.js";import{Event as x}from"../../../../base/common/event.js";import{registerEditorContribution as R,EditorAction2 as h,EditorContributionInstantiation as O}from"../../../../editor/browser/editorExtensions.js";import"../../../../editor/common/editorCommon.js";import"../../../../editor/browser/editorBrowser.js";import{IContextKeyService as V,RawContextKey as I,ContextKeyExpr as g}from"../../../../platform/contextkey/common/contextkey.js";import{DisposableStore as D}from"../../../../base/common/lifecycle.js";import{KeybindingWeight as m}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{KeyCode as C,KeyMod as l}from"../../../../base/common/keyCodes.js";import{EditorContextKeys as P}from"../../../../editor/common/editorContextKeys.js";import{PeekContext as k}from"../../../../editor/contrib/peekView/browser/peekView.js";import{IStorageService as q,StorageScope as T,StorageTarget as L}from"../../../../platform/storage/common/storage.js";import{ICodeEditorService as z}from"../../../../editor/browser/services/codeEditorService.js";import{Range as N}from"../../../../editor/common/core/range.js";import"../../../../editor/common/core/position.js";import{MenuId as U,registerAction2 as y}from"../../../../platform/actions/common/actions.js";import{Codicon as f}from"../../../../base/common/codicons.js";import{registerIcon as M}from"../../../../platform/theme/common/iconRegistry.js";import{isCancellationError as j}from"../../../../base/common/errors.js";const H=new I("editorHasCallHierarchyProvider",!1,c("editorHasCallHierarchyProvider","Whether a call hierarchy provider is available")),u=new I("callHierarchyVisible",!1,c("callHierarchyVisible","Whether call hierarchy peek is currently showing")),p=new I("callHierarchyDirection",void 0,{type:"string",description:c("callHierarchyDirection","Whether call hierarchy shows incoming or outgoing calls")});function B(s){return s===a.CallsFrom||s===a.CallsTo?s:a.CallsTo}let o=class{constructor(e,i,r,t,n){this._editor=e;this._contextKeyService=i;this._storageService=r;this._editorService=t;this._instantiationService=n;this._ctxIsVisible=u.bindTo(this._contextKeyService),this._ctxHasProvider=H.bindTo(this._contextKeyService),this._ctxDirection=p.bindTo(this._contextKeyService),this._dispoables.add(x.any(e.onDidChangeModel,e.onDidChangeModelLanguage,b.onDidChange)(()=>{this._ctxHasProvider.set(e.hasModel()&&b.has(e.getModel()))})),this._dispoables.add(this._sessionDisposables)}static Id="callHierarchy";static get(e){return e.getContribution(o.Id)}static _StorageDirection="callHierarchy/defaultDirection";_ctxHasProvider;_ctxIsVisible;_ctxDirection;_dispoables=new D;_sessionDisposables=new D;_widget;dispose(){this._ctxHasProvider.reset(),this._ctxIsVisible.reset(),this._dispoables.dispose()}async startCallHierarchyFromEditor(){if(this._sessionDisposables.clear(),!this._editor.hasModel())return;const e=this._editor.getModel(),i=this._editor.getPosition();if(!b.has(e))return;const r=new E,t=W.create(e,i,r.token),n=B(this._storageService.get(o._StorageDirection,T.PROFILE,a.CallsTo));this._showCallHierarchyWidget(i,n,t,r)}async startCallHierarchyFromCallHierarchy(){if(!this._widget)return;const e=this._widget.getModel(),i=this._widget.getFocused();if(!i||!e)return;const r=await this._editorService.openCodeEditor({resource:i.item.uri},this._editor);if(!r)return;const t=e.fork(i.item);this._sessionDisposables.clear(),o.get(r)?._showCallHierarchyWidget(N.lift(t.root.selectionRange).getStartPosition(),this._widget.direction,Promise.resolve(t),new E)}_showCallHierarchyWidget(e,i,r,t){this._ctxIsVisible.set(!0),this._ctxDirection.set(i),x.any(this._editor.onDidChangeModel,this._editor.onDidChangeModelLanguage)(this.endCallHierarchy,this,this._sessionDisposables),this._widget=this._instantiationService.createInstance(v,this._editor,e,i),this._widget.showLoading(),this._sessionDisposables.add(this._widget.onDidClose(()=>{this.endCallHierarchy(),this._storageService.store(o._StorageDirection,this._widget.direction,T.PROFILE,L.USER)})),this._sessionDisposables.add({dispose(){t.dispose(!0)}}),this._sessionDisposables.add(this._widget),r.then(n=>{t.token.isCancellationRequested||(n?(this._sessionDisposables.add(n),this._widget.showModel(n)):this._widget.showMessage(c("no.item","No results")))}).catch(n=>{if(j(n)){this.endCallHierarchy();return}this._widget.showMessage(c("error","Failed to show call hierarchy"))})}showOutgoingCalls(){this._widget?.updateDirection(a.CallsFrom),this._ctxDirection.set(a.CallsFrom)}showIncomingCalls(){this._widget?.updateDirection(a.CallsTo),this._ctxDirection.set(a.CallsTo)}endCallHierarchy(){this._sessionDisposables.clear(),this._ctxIsVisible.set(!1),this._editor.focus()}};o=S([d(1,V),d(2,q),d(3,z),d(4,A)],o),R(o.Id,o,O.Eager),y(class extends h{constructor(){super({id:"editor.showCallHierarchy",title:_("title","Peek Call Hierarchy"),menu:{id:U.EditorContextPeek,group:"navigation",order:1e3,when:g.and(H,k.notInPeekEditor,P.isInEmbeddedEditor.toNegated())},keybinding:{when:P.editorTextFocus,weight:m.WorkbenchContrib,primary:l.Shift+l.Alt+C.KeyH},precondition:g.and(H,k.notInPeekEditor),f1:!0})}async runEditorCommand(e,i){return o.get(i)?.startCallHierarchyFromEditor()}}),y(class extends h{constructor(){super({id:"editor.showIncomingCalls",title:_("title.incoming","Show Incoming Calls"),icon:M("callhierarchy-incoming",f.callIncoming,c("showIncomingCallsIcons","Icon for incoming calls in the call hierarchy view.")),precondition:g.and(u,p.isEqualTo(a.CallsFrom)),keybinding:{weight:m.WorkbenchContrib,primary:l.Shift+l.Alt+C.KeyH},menu:{id:v.TitleMenu,when:p.isEqualTo(a.CallsFrom),order:1}})}runEditorCommand(s,e){return o.get(e)?.showIncomingCalls()}}),y(class extends h{constructor(){super({id:"editor.showOutgoingCalls",title:_("title.outgoing","Show Outgoing Calls"),icon:M("callhierarchy-outgoing",f.callOutgoing,c("showOutgoingCallsIcon","Icon for outgoing calls in the call hierarchy view.")),precondition:g.and(u,p.isEqualTo(a.CallsTo)),keybinding:{weight:m.WorkbenchContrib,primary:l.Shift+l.Alt+C.KeyH},menu:{id:v.TitleMenu,when:p.isEqualTo(a.CallsTo),order:1}})}runEditorCommand(s,e){return o.get(e)?.showOutgoingCalls()}}),y(class extends h{constructor(){super({id:"editor.refocusCallHierarchy",title:_("title.refocus","Refocus Call Hierarchy"),precondition:u,keybinding:{weight:m.WorkbenchContrib,primary:l.Shift+C.Enter}})}async runEditorCommand(s,e){return o.get(e)?.startCallHierarchyFromCallHierarchy()}}),y(class extends h{constructor(){super({id:"editor.closeCallHierarchy",title:c("close","Close"),icon:f.close,precondition:u,keybinding:{weight:m.WorkbenchContrib+10,primary:C.Escape,when:g.not("config.editor.stablePeek")},menu:{id:v.TitleMenu,order:1e3}})}runEditorCommand(s,e){return o.get(e)?.endCallHierarchy()}});
