{
  "version": 3,
  "sources": ["../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/contrib/callHierarchy/common/callHierarchy.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { isNonEmptyArray } from \"../../../../base/common/arrays.js\";\nimport { CancellationToken } from \"../../../../base/common/cancellation.js\";\nimport { onUnexpectedExternalError } from \"../../../../base/common/errors.js\";\nimport {\n\ttype IDisposable,\n\tRefCountedDisposable,\n} from \"../../../../base/common/lifecycle.js\";\nimport { assertType } from \"../../../../base/common/types.js\";\nimport { URI } from \"../../../../base/common/uri.js\";\nimport {\n\ttype IPosition,\n\tPosition,\n} from \"../../../../editor/common/core/position.js\";\nimport type { IRange } from \"../../../../editor/common/core/range.js\";\nimport { LanguageFeatureRegistry } from \"../../../../editor/common/languageFeatureRegistry.js\";\nimport type {\n\tProviderResult,\n\tSymbolKind,\n\tSymbolTag,\n} from \"../../../../editor/common/languages.js\";\nimport type { ITextModel } from \"../../../../editor/common/model.js\";\nimport { IModelService } from \"../../../../editor/common/services/model.js\";\nimport { ITextModelService } from \"../../../../editor/common/services/resolverService.js\";\nimport { CommandsRegistry } from \"../../../../platform/commands/common/commands.js\";\n\nexport enum CallHierarchyDirection {\n\tCallsTo = \"incomingCalls\",\n\tCallsFrom = \"outgoingCalls\",\n}\n\nexport interface CallHierarchyItem {\n\t_sessionId: string;\n\t_itemId: string;\n\tkind: SymbolKind;\n\tname: string;\n\tdetail?: string;\n\turi: URI;\n\trange: IRange;\n\tselectionRange: IRange;\n\ttags?: SymbolTag[];\n}\n\nexport interface IncomingCall {\n\tfrom: CallHierarchyItem;\n\tfromRanges: IRange[];\n}\n\nexport interface OutgoingCall {\n\tfromRanges: IRange[];\n\tto: CallHierarchyItem;\n}\n\nexport interface CallHierarchySession {\n\troots: CallHierarchyItem[];\n\tdispose(): void;\n}\n\nexport interface CallHierarchyProvider {\n\tprepareCallHierarchy(\n\t\tdocument: ITextModel,\n\t\tposition: IPosition,\n\t\ttoken: CancellationToken,\n\t): ProviderResult<CallHierarchySession>;\n\n\tprovideIncomingCalls(\n\t\titem: CallHierarchyItem,\n\t\ttoken: CancellationToken,\n\t): ProviderResult<IncomingCall[]>;\n\n\tprovideOutgoingCalls(\n\t\titem: CallHierarchyItem,\n\t\ttoken: CancellationToken,\n\t): ProviderResult<OutgoingCall[]>;\n}\n\nexport const CallHierarchyProviderRegistry =\n\tnew LanguageFeatureRegistry<CallHierarchyProvider>();\n\nexport class CallHierarchyModel {\n\tstatic async create(\n\t\tmodel: ITextModel,\n\t\tposition: IPosition,\n\t\ttoken: CancellationToken,\n\t): Promise<CallHierarchyModel | undefined> {\n\t\tconst [provider] = CallHierarchyProviderRegistry.ordered(model);\n\t\tif (!provider) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst session = await provider.prepareCallHierarchy(\n\t\t\tmodel,\n\t\t\tposition,\n\t\t\ttoken,\n\t\t);\n\t\tif (!session) {\n\t\t\treturn undefined;\n\t\t}\n\t\treturn new CallHierarchyModel(\n\t\t\tsession.roots.reduce((p, c) => p + c._sessionId, \"\"),\n\t\t\tprovider,\n\t\t\tsession.roots,\n\t\t\tnew RefCountedDisposable(session),\n\t\t);\n\t}\n\n\treadonly root: CallHierarchyItem;\n\n\tprivate constructor(\n\t\treadonly id: string,\n\t\treadonly provider: CallHierarchyProvider,\n\t\treadonly roots: CallHierarchyItem[],\n\t\treadonly ref: RefCountedDisposable,\n\t) {\n\t\tthis.root = roots[0];\n\t}\n\n\tdispose(): void {\n\t\tthis.ref.release();\n\t}\n\n\tfork(item: CallHierarchyItem): CallHierarchyModel {\n\t\tconst that = this;\n\t\treturn new (class extends CallHierarchyModel {\n\t\t\tconstructor() {\n\t\t\t\tsuper(that.id, that.provider, [item], that.ref.acquire());\n\t\t\t}\n\t\t})();\n\t}\n\n\tasync resolveIncomingCalls(\n\t\titem: CallHierarchyItem,\n\t\ttoken: CancellationToken,\n\t): Promise<IncomingCall[]> {\n\t\ttry {\n\t\t\tconst result = await this.provider.provideIncomingCalls(\n\t\t\t\titem,\n\t\t\t\ttoken,\n\t\t\t);\n\t\t\tif (isNonEmptyArray(result)) {\n\t\t\t\treturn result;\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tonUnexpectedExternalError(e);\n\t\t}\n\t\treturn [];\n\t}\n\n\tasync resolveOutgoingCalls(\n\t\titem: CallHierarchyItem,\n\t\ttoken: CancellationToken,\n\t): Promise<OutgoingCall[]> {\n\t\ttry {\n\t\t\tconst result = await this.provider.provideOutgoingCalls(\n\t\t\t\titem,\n\t\t\t\ttoken,\n\t\t\t);\n\t\t\tif (isNonEmptyArray(result)) {\n\t\t\t\treturn result;\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tonUnexpectedExternalError(e);\n\t\t}\n\t\treturn [];\n\t}\n}\n\n// --- API command support\n\nconst _models = new Map<string, CallHierarchyModel>();\n\nCommandsRegistry.registerCommand(\n\t\"_executePrepareCallHierarchy\",\n\tasync (accessor, ...args) => {\n\t\tconst [resource, position] = args;\n\t\tassertType(URI.isUri(resource));\n\t\tassertType(Position.isIPosition(position));\n\n\t\tconst modelService = accessor.get(IModelService);\n\t\tlet textModel = modelService.getModel(resource);\n\t\tlet textModelReference: IDisposable | undefined;\n\t\tif (!textModel) {\n\t\t\tconst textModelService = accessor.get(ITextModelService);\n\t\t\tconst result =\n\t\t\t\tawait textModelService.createModelReference(resource);\n\t\t\ttextModel = result.object.textEditorModel;\n\t\t\ttextModelReference = result;\n\t\t}\n\n\t\ttry {\n\t\t\tconst model = await CallHierarchyModel.create(\n\t\t\t\ttextModel,\n\t\t\t\tposition,\n\t\t\t\tCancellationToken.None,\n\t\t\t);\n\t\t\tif (!model) {\n\t\t\t\treturn [];\n\t\t\t}\n\t\t\t//\n\t\t\t_models.set(model.id, model);\n\t\t\t_models.forEach((value, key, map) => {\n\t\t\t\tif (map.size > 10) {\n\t\t\t\t\tvalue.dispose();\n\t\t\t\t\t_models.delete(key);\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn [model.root];\n\t\t} finally {\n\t\t\ttextModelReference?.dispose();\n\t\t}\n\t},\n);\n\nfunction isCallHierarchyItemDto(obj: any): obj is CallHierarchyItem {\n\treturn true;\n}\n\nCommandsRegistry.registerCommand(\n\t\"_executeProvideIncomingCalls\",\n\tasync (_accessor, ...args) => {\n\t\tconst [item] = args;\n\t\tassertType(isCallHierarchyItemDto(item));\n\n\t\t// find model\n\t\tconst model = _models.get(item._sessionId);\n\t\tif (!model) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\treturn model.resolveIncomingCalls(item, CancellationToken.None);\n\t},\n);\n\nCommandsRegistry.registerCommand(\n\t\"_executeProvideOutgoingCalls\",\n\tasync (_accessor, ...args) => {\n\t\tconst [item] = args;\n\t\tassertType(isCallHierarchyItemDto(item));\n\n\t\t// find model\n\t\tconst model = _models.get(item._sessionId);\n\t\tif (!model) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\treturn model.resolveOutgoingCalls(item, CancellationToken.None);\n\t},\n);\n"],
  "mappings": "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",
  "names": ["CallHierarchyDirection"]
}
