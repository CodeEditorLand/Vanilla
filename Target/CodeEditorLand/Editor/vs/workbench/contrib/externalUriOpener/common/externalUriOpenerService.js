var y=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var m=(c,l,r,n)=>{for(var e=n>1?void 0:n?x(l,r):l,i=c.length-1,t;i>=0;i--)(t=c[i])&&(e=(n?t(l,r,e):t(e))||e);return n&&e&&y(l,r,e),e},s=(c,l)=>(r,n)=>l(r,n,c);import{firstOrDefault as E}from"../../../../../vs/base/common/arrays.js";import"../../../../../vs/base/common/cancellation.js";import{Iterable as P}from"../../../../../vs/base/common/iterator.js";import{Disposable as k}from"../../../../../vs/base/common/lifecycle.js";import{LinkedList as b}from"../../../../../vs/base/common/linkedList.js";import{isWeb as S}from"../../../../../vs/base/common/platform.js";import{URI as h}from"../../../../../vs/base/common/uri.js";import*as u from"../../../../../vs/editor/common/languages.js";import*as f from"../../../../../vs/nls.js";import{IConfigurationService as w}from"../../../../../vs/platform/configuration/common/configuration.js";import{createDecorator as R}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{ILogService as C}from"../../../../../vs/platform/log/common/log.js";import{IOpenerService as D}from"../../../../../vs/platform/opener/common/opener.js";import{IQuickInputService as T}from"../../../../../vs/platform/quickinput/common/quickInput.js";import{defaultExternalUriOpenerId as I,externalUriOpenersSettingId as U}from"../../../../../vs/workbench/contrib/externalUriOpener/common/configuration.js";import{testUrlMatchesGlob as A}from"../../../../../vs/workbench/contrib/url/common/urlGlob.js";import{IPreferencesService as L}from"../../../../../vs/workbench/services/preferences/common/preferences.js";const ie=R("externalUriOpenerService");let d=class extends k{constructor(r,n,e,i,t){super();this.configurationService=n;this.logService=e;this.preferencesService=i;this.quickInputService=t;this._register(r.registerExternalOpener(this))}_serviceBrand;_providers=new b;registerExternalOpenerProvider(r){return{dispose:this._providers.push(r)}}async getOpeners(r,n,e,i){const t=await this.getAllOpenersForUri(r);if(t.size===0)return[];if(e.preferredOpenerId){if(e.preferredOpenerId===I)return[];const a=t.get(e.preferredOpenerId);if(a)return[a]}const o=this.getConfiguredOpenerForUri(t,r);if(o)return o===I?[]:[o];const p=[];if(await Promise.all(Array.from(t.values()).map(async a=>{let O;try{O=await a.canOpen(e.sourceUri,i)}catch(v){this.logService.error(v);return}switch(O){case u.ExternalUriOpenerPriority.Option:case u.ExternalUriOpenerPriority.Default:case u.ExternalUriOpenerPriority.Preferred:p.push({opener:a,priority:O});break}})),p.length===0)return[];const g=E(p.filter(a=>a.priority===u.ExternalUriOpenerPriority.Preferred));return g?[g.opener]:!n&&p.every(a=>a.priority===u.ExternalUriOpenerPriority.Option)?[]:p.map(a=>a.opener)}async openExternal(r,n,e){const i=typeof r=="string"?h.parse(r):r,t=await this.getOpeners(i,!1,n,e);return t.length===0?!1:t.length===1?t[0].openExternalUri(i,n,e):this.showOpenerPrompt(t,i,n,e)}async getOpener(r,n,e){const i=await this.getOpeners(r,!0,n,e);if(i.length>=1)return i[0]}async getAllOpenersForUri(r){const n=new Map;return await Promise.all(P.map(this._providers,async e=>{for await(const i of e.getOpeners(r))n.set(i.id,i)})),n}getConfiguredOpenerForUri(r,n){const e=this.configurationService.getValue(U)||{};for(const[i,t]of Object.entries(e))if(A(n,i)){if(t===I)return"default";const o=r.get(t);if(o)return o}}async showOpenerPrompt(r,n,e,i){const t=r.map(p=>({label:p.label,opener:p}));t.push({label:S?f.localize("selectOpenerDefaultLabel.web","Open in new browser window"):f.localize("selectOpenerDefaultLabel","Open in default browser"),opener:void 0},{type:"separator"},{label:f.localize("selectOpenerConfigureTitle","Configure default opener..."),opener:"configureDefault"});const o=await this.quickInputService.pick(t,{placeHolder:f.localize("selectOpenerPlaceHolder","How would you like to open: {0}",n.toString())});return o?typeof o.opener>"u"?!1:o.opener==="configureDefault"?(await this.preferencesService.openUserSettings({jsonEditor:!0,revealSetting:{key:U,edit:!0}}),!0):o.opener.openExternalUri(n,e,i):!0}};d=m([s(0,D),s(1,w),s(2,C),s(3,L),s(4,T)],d);export{d as ExternalUriOpenerService,ie as IExternalUriOpenerService};
