{
  "version": 3,
  "sources": ["../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/contrib/webview/browser/resourceLoading.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { VSBufferReadableStream } from '../../../../base/common/buffer.js';\nimport { CancellationToken } from '../../../../base/common/cancellation.js';\nimport { isUNC } from '../../../../base/common/extpath.js';\nimport { Schemas } from '../../../../base/common/network.js';\nimport { normalize, sep } from '../../../../base/common/path.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { FileOperationError, FileOperationResult, IFileService, IWriteFileOptions } from '../../../../platform/files/common/files.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { getWebviewContentMimeType } from '../../../../platform/webview/common/mimeTypes.js';\n\nexport namespace WebviewResourceResponse {\n\texport enum Type { Success, Failed, AccessDenied, NotModified }\n\n\texport class StreamSuccess {\n\t\treadonly type = Type.Success;\n\n\t\tconstructor(\n\t\t\tpublic readonly stream: VSBufferReadableStream,\n\t\t\tpublic readonly etag: string | undefined,\n\t\t\tpublic readonly mtime: number | undefined,\n\t\t\tpublic readonly mimeType: string,\n\t\t) { }\n\t}\n\n\texport const Failed = { type: Type.Failed } as const;\n\texport const AccessDenied = { type: Type.AccessDenied } as const;\n\n\texport class NotModified {\n\t\treadonly type = Type.NotModified;\n\n\t\tconstructor(\n\t\t\tpublic readonly mimeType: string,\n\t\t\tpublic readonly mtime: number | undefined,\n\t\t) { }\n\t}\n\n\texport type StreamResponse = StreamSuccess | typeof Failed | typeof AccessDenied | NotModified;\n}\n\nexport async function loadLocalResource(\n\trequestUri: URI,\n\toptions: {\n\t\tifNoneMatch: string | undefined;\n\t\troots: ReadonlyArray<URI>;\n\t},\n\tfileService: IFileService,\n\tlogService: ILogService,\n\ttoken: CancellationToken,\n): Promise<WebviewResourceResponse.StreamResponse> {\n\tlogService.debug(`loadLocalResource - begin. requestUri=${requestUri}`);\n\n\tconst resourceToLoad = getResourceToLoad(requestUri, options.roots);\n\n\tlogService.debug(`loadLocalResource - found resource to load. requestUri=${requestUri}, resourceToLoad=${resourceToLoad}`);\n\n\tif (!resourceToLoad) {\n\t\treturn WebviewResourceResponse.AccessDenied;\n\t}\n\n\tconst mime = getWebviewContentMimeType(requestUri); // Use the original path for the mime\n\n\ttry {\n\t\tconst result = await fileService.readFileStream(resourceToLoad, { etag: options.ifNoneMatch }, token);\n\t\treturn new WebviewResourceResponse.StreamSuccess(result.value, result.etag, result.mtime, mime);\n\t} catch (err) {\n\t\tif (err instanceof FileOperationError) {\n\t\t\tconst result = err.fileOperationResult;\n\n\t\t\t// NotModified status is expected and can be handled gracefully\n\t\t\tif (result === FileOperationResult.FILE_NOT_MODIFIED_SINCE) {\n\t\t\t\treturn new WebviewResourceResponse.NotModified(mime, (err.options as IWriteFileOptions | undefined)?.mtime);\n\t\t\t}\n\t\t}\n\n\t\t// Otherwise the error is unexpected.\n\t\tlogService.debug(`loadLocalResource - Error using fileReader. requestUri=${requestUri}`);\n\t\tconsole.log(err);\n\n\t\treturn WebviewResourceResponse.Failed;\n\t}\n}\n\nfunction getResourceToLoad(\n\trequestUri: URI,\n\troots: ReadonlyArray<URI>,\n): URI | undefined {\n\tfor (const root of roots) {\n\t\tif (containsResource(root, requestUri)) {\n\t\t\treturn normalizeResourcePath(requestUri);\n\t\t}\n\t}\n\n\treturn undefined;\n}\n\nfunction containsResource(root: URI, resource: URI): boolean {\n\tif (root.scheme !== resource.scheme) {\n\t\treturn false;\n\t}\n\n\tlet resourceFsPath = normalize(resource.fsPath);\n\tlet rootPath = normalize(root.fsPath + (root.fsPath.endsWith(sep) ? '' : sep));\n\n\tif (isUNC(root.fsPath) && isUNC(resource.fsPath)) {\n\t\trootPath = rootPath.toLowerCase();\n\t\tresourceFsPath = resourceFsPath.toLowerCase();\n\t}\n\n\treturn resourceFsPath.startsWith(rootPath);\n}\n\nfunction normalizeResourcePath(resource: URI): URI {\n\t// Rewrite remote uris to a path that the remote file system can understand\n\tif (resource.scheme === Schemas.vscodeRemote) {\n\t\treturn URI.from({\n\t\t\tscheme: Schemas.vscodeRemote,\n\t\t\tauthority: resource.authority,\n\t\t\tpath: '/vscode-resource',\n\t\t\tquery: JSON.stringify({\n\t\t\t\trequestResourcePath: resource.path\n\t\t\t})\n\t\t});\n\t}\n\treturn resource;\n}\n"],
  "mappings": "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",
  "names": ["WebviewResourceResponse", "Type"]
}
