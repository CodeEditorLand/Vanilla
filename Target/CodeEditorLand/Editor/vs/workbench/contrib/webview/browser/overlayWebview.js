var g=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var p=(o,d,e,i)=>{for(var t=i>1?void 0:i?f(d,e):d,n=o.length-1,s;n>=0;n--)(s=o[n])&&(t=(i?s(d,e,t):s(t))||t);return i&&t&&g(d,e,t),t},a=(o,d)=>(e,i)=>d(e,i,o);import{getWindowById as y}from"../../../../base/browser/dom.js";import{FastDomNode as m}from"../../../../base/browser/fastDomNode.js";import"../../../../base/browser/mouseEvent.js";import"../../../../base/browser/window.js";import{Emitter as r}from"../../../../base/common/event.js";import{Disposable as W,DisposableStore as D,MutableDisposable as b}from"../../../../base/common/lifecycle.js";import"../../../../base/common/uri.js";import{generateUuid as E}from"../../../../base/common/uuid.js";import{IContextKeyService as S}from"../../../../platform/contextkey/common/contextkey.js";import"../../../../platform/extensions/common/extensions.js";import{IWorkbenchLayoutService as x}from"../../../services/layout/browser/layoutService.js";import{IWebviewService as C,KEYBINDING_CONTEXT_WEBVIEW_FIND_WIDGET_ENABLED as I,KEYBINDING_CONTEXT_WEBVIEW_FIND_WIDGET_VISIBLE as M}from"./webview.js";let l=class extends W{constructor(e,i,t,n){super();this._layoutService=i;this._webviewService=t;this._baseContextKeyService=n;this.providedViewType=e.providedViewType,this.origin=e.origin??E(),this._title=e.title,this._extension=e.extension,this._options=e.options,this._contentOptions=e.contentOptions}_isFirstLoad=!0;_firstLoadPendingMessages=new Set;_webview=this._register(new b);_webviewEvents=this._register(new D);_html="";_title;_initialScrollProgress=0;_state=void 0;_extension;_contentOptions;_options;_owner=void 0;_windowId=void 0;get window(){return y(this._windowId,!0).window}_scopedContextKeyService=this._register(new b);_findWidgetVisible;_findWidgetEnabled;_shouldShowFindWidgetOnRestore=!1;providedViewType;origin;_container;get isFocused(){return!!this._webview.value?.isFocused}_isDisposed=!1;_onDidDispose=this._register(new r);onDidDispose=this._onDidDispose.event;dispose(){this._isDisposed=!0,this._container?.domNode.remove(),this._container=void 0;for(const e of this._firstLoadPendingMessages)e.resolve(!1);this._firstLoadPendingMessages.clear(),this._onDidDispose.fire(),super.dispose()}get container(){if(this._isDisposed)throw new Error("OverlayWebview has been disposed");if(!this._container){const e=document.createElement("div");e.style.position="absolute",e.style.overflow="hidden",this._container=new m(e),this._container.setVisibility("hidden"),this._layoutService.getContainer(this.window).appendChild(e)}return this._container.domNode}claim(e,i,t){if(this._isDisposed)return;const n=this._owner;if(this._windowId!==i.vscodeWindowId&&(this.release(n),this._webview.clear(),this._webviewEvents.clear(),this._container?.domNode.remove(),this._container=void 0),this._owner=e,this._windowId=i.vscodeWindowId,this._show(i),n!==e){const s=t||this._baseContextKeyService;this._scopedContextKeyService.clear(),this._scopedContextKeyService.value=s.createScoped(this.container);const h=this._findWidgetVisible?.get();this._findWidgetVisible?.reset(),this._findWidgetVisible=M.bindTo(s),this._findWidgetVisible.set(!!h),this._findWidgetEnabled?.reset(),this._findWidgetEnabled=I.bindTo(s),this._findWidgetEnabled.set(!!this.options.enableFindWidget),this._webview.value?.setContextKeyService(this._scopedContextKeyService.value)}}release(e){this._owner===e&&(this._scopedContextKeyService.clear(),this._owner=void 0,this._container&&this._container.setVisibility("hidden"),this._options.retainContextWhenHidden?(this._shouldShowFindWidgetOnRestore=!!this._findWidgetVisible?.get(),this.hideFind(!1)):(this._webview.clear(),this._webviewEvents.clear()))}layoutWebviewOverElement(e,i,t){if(!this._container||!this._container.domNode.parentElement)return;const n=this._layoutService.whenContainerStylesLoaded(this.window);n?n.then(()=>this.doLayoutWebviewOverElement(e,i,t)):this.doLayoutWebviewOverElement(e,i,t)}doLayoutWebviewOverElement(e,i,t){if(!this._container||!this._container.domNode.parentElement)return;const n=e.getBoundingClientRect(),s=this._container.domNode.parentElement.getBoundingClientRect(),h=(s.height-this._container.domNode.parentElement.clientHeight)/2,u=(s.width-this._container.domNode.parentElement.clientWidth)/2;if(this._container.setTop(n.top-s.top-h),this._container.setLeft(n.left-s.left-u),this._container.setWidth(i?i.width:n.width),this._container.setHeight(i?i.height:n.height),t){const{top:v,left:_,right:c,bottom:w}=F(n,t);this._container.domNode.style.clipPath=`polygon(${_}px ${v}px, ${c}px ${v}px, ${c}px ${w}px, ${_}px ${w}px)`}}_show(e){if(this._isDisposed)throw new Error("OverlayWebview is disposed");if(!this._webview.value){const i=this._webviewService.createWebviewElement({providedViewType:this.providedViewType,origin:this.origin,title:this._title,options:this._options,contentOptions:this._contentOptions,extension:this.extension});this._webview.value=i,i.state=this._state,this._scopedContextKeyService.value&&this._webview.value.setContextKeyService(this._scopedContextKeyService.value),this._html&&i.setHtml(this._html),this._options.tryRestoreScrollPosition&&(i.initialScrollProgress=this._initialScrollProgress),this._findWidgetEnabled?.set(!!this.options.enableFindWidget),i.mountTo(this.container,e),this._webviewEvents.clear(),this._webviewEvents.add(i.onDidFocus(()=>{this._onDidFocus.fire()})),this._webviewEvents.add(i.onDidBlur(()=>{this._onDidBlur.fire()})),this._webviewEvents.add(i.onDidClickLink(t=>{this._onDidClickLink.fire(t)})),this._webviewEvents.add(i.onMessage(t=>{this._onMessage.fire(t)})),this._webviewEvents.add(i.onMissingCsp(t=>{this._onMissingCsp.fire(t)})),this._webviewEvents.add(i.onDidWheel(t=>{this._onDidWheel.fire(t)})),this._webviewEvents.add(i.onDidReload(()=>{this._onDidReload.fire()})),this._webviewEvents.add(i.onFatalError(t=>{this._onFatalError.fire(t)})),this._webviewEvents.add(i.onDidScroll(t=>{this._initialScrollProgress=t.scrollYPercentage,this._onDidScroll.fire(t)})),this._webviewEvents.add(i.onDidUpdateState(t=>{this._state=t,this._onDidUpdateState.fire(t)})),this._isFirstLoad&&this._firstLoadPendingMessages.forEach(async t=>{t.resolve(await i.postMessage(t.message,t.transfer))}),this._isFirstLoad=!1,this._firstLoadPendingMessages.clear()}this.options.retainContextWhenHidden&&this._shouldShowFindWidgetOnRestore&&(this.showFind(!1),this._shouldShowFindWidgetOnRestore=!1),this._container?.setVisibility("visible")}setHtml(e){this._html=e,this._withWebview(i=>i.setHtml(e))}setTitle(e){this._title=e,this._withWebview(i=>i.setTitle(e))}get initialScrollProgress(){return this._initialScrollProgress}set initialScrollProgress(e){this._initialScrollProgress=e,this._withWebview(i=>i.initialScrollProgress=e)}get state(){return this._state}set state(e){this._state=e,this._withWebview(i=>i.state=e)}get extension(){return this._extension}set extension(e){this._extension=e,this._withWebview(i=>i.extension=e)}get options(){return this._options}set options(e){this._options={customClasses:this._options.customClasses,...e}}get contentOptions(){return this._contentOptions}set contentOptions(e){this._contentOptions=e,this._withWebview(i=>i.contentOptions=e)}set localResourcesRoot(e){this._withWebview(i=>i.localResourcesRoot=e)}_onDidFocus=this._register(new r);onDidFocus=this._onDidFocus.event;_onDidBlur=this._register(new r);onDidBlur=this._onDidBlur.event;_onDidClickLink=this._register(new r);onDidClickLink=this._onDidClickLink.event;_onDidReload=this._register(new r);onDidReload=this._onDidReload.event;_onDidScroll=this._register(new r);onDidScroll=this._onDidScroll.event;_onDidUpdateState=this._register(new r);onDidUpdateState=this._onDidUpdateState.event;_onMessage=this._register(new r);onMessage=this._onMessage.event;_onMissingCsp=this._register(new r);onMissingCsp=this._onMissingCsp.event;_onDidWheel=this._register(new r);onDidWheel=this._onDidWheel.event;_onFatalError=this._register(new r);onFatalError=this._onFatalError.event;async postMessage(e,i){if(this._webview.value)return this._webview.value.postMessage(e,i);if(this._isFirstLoad){let t;const n=new Promise(s=>t=s);return this._firstLoadPendingMessages.add({message:e,transfer:i,resolve:t}),n}return!1}focus(){this._webview.value?.focus()}reload(){this._webview.value?.reload()}selectAll(){this._webview.value?.selectAll()}copy(){this._webview.value?.copy()}paste(){this._webview.value?.paste()}cut(){this._webview.value?.cut()}undo(){this._webview.value?.undo()}redo(){this._webview.value?.redo()}showFind(e=!0){this._webview.value&&(this._webview.value.showFind(e),this._findWidgetVisible?.set(!0))}hideFind(e=!0){this._findWidgetVisible?.reset(),this._webview.value?.hideFind(e)}runFindAction(e){this._webview.value?.runFindAction(e)}_withWebview(e){this._webview.value&&e(this._webview.value)}windowDidDragStart(){this._webview.value?.windowDidDragStart()}windowDidDragEnd(){this._webview.value?.windowDidDragEnd()}setContextKeyService(e){this._webview.value?.setContextKeyService(e)}};l=p([a(1,x),a(2,C),a(3,S)],l);function F(o,d){const e=d.getBoundingClientRect(),i=Math.max(e.top-o.top,0),t=Math.max(o.width-(o.right-e.right),0),n=Math.max(o.height-(o.bottom-e.bottom),0),s=Math.max(e.left-o.left,0);return{top:i,right:t,bottom:n,left:s}}export{l as OverlayWebview};
