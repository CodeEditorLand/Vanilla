var _=Object.defineProperty;var g=Object.getOwnPropertyDescriptor;var p=(s,n,e,i)=>{for(var t=i>1?void 0:i?g(n,e):n,o=s.length-1,a;o>=0;o--)(a=s[o])&&(t=(i?a(n,e,t):a(t))||t);return i&&t&&_(n,e,t),t},r=(s,n)=>(e,i)=>n(e,i,s);import{Delayer as y}from"../../../../../vs/base/common/async.js";import"../../../../../vs/base/common/buffer.js";import{Schemas as F}from"../../../../../vs/base/common/network.js";import{consumeStream as M}from"../../../../../vs/base/common/stream.js";import{ProxyChannel as C}from"../../../../../vs/base/parts/ipc/common/ipc.js";import{IAccessibilityService as H}from"../../../../../vs/platform/accessibility/common/accessibility.js";import{IConfigurationService as B}from"../../../../../vs/platform/configuration/common/configuration.js";import{IContextMenuService as W}from"../../../../../vs/platform/contextview/browser/contextView.js";import{IFileService as A}from"../../../../../vs/platform/files/common/files.js";import{IInstantiationService as D}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{IMainProcessService as x}from"../../../../../vs/platform/ipc/common/mainProcessService.js";import{ILogService as L}from"../../../../../vs/platform/log/common/log.js";import{INativeHostService as R}from"../../../../../vs/platform/native/common/native.js";import{INotificationService as T}from"../../../../../vs/platform/notification/common/notification.js";import{IRemoteAuthorityResolverService as N}from"../../../../../vs/platform/remote/common/remoteAuthorityResolver.js";import{ITelemetryService as K}from"../../../../../vs/platform/telemetry/common/telemetry.js";import{ITunnelService as P}from"../../../../../vs/platform/tunnel/common/tunnel.js";import"../../../../../vs/platform/webview/common/webviewManagerService.js";import"../../../../../vs/workbench/contrib/webview/browser/themeing.js";import"../../../../../vs/workbench/contrib/webview/browser/webview.js";import{WebviewElement as V}from"../../../../../vs/workbench/contrib/webview/browser/webviewElement.js";import{WindowIgnoreMenuShortcutsManager as k}from"../../../../../vs/workbench/contrib/webview/electron-sandbox/windowIgnoreMenuShortcutsManager.js";import{IWorkbenchEnvironmentService as O}from"../../../../../vs/workbench/services/environment/common/environmentService.js";let m=class extends V{constructor(e,i,t,o,a,v,d,c,S,h,l,w,I,u,b){super(e,i,h,t,w,d,a,S,c,v,o,u,b);this._nativeHostService=I;this._webviewKeyboardHandler=new k(h,l,I),this._webviewMainService=C.toService(l.getChannel("webview")),e.options.enableFindWidget&&(this._register(this.onDidHtmlChange(f=>{this._findStarted&&this._cachedHtmlContent!==f&&(this.stopFind(!1),this._cachedHtmlContent=f)})),this._register(this._webviewMainService.onFoundInFrame(f=>{this._hasFindResult.fire(f.matches>0)})))}_webviewKeyboardHandler;_findStarted=!1;_cachedHtmlContent;_webviewMainService;_iframeDelayer=this._register(new y(200));get platform(){return"electron"}dispose(){this._webviewKeyboardHandler.didBlur(),super.dispose()}webviewContentEndpoint(e){return`${F.vscodeWebview}://${e}`}streamToBuffer(e){return M(e,i=>{const t=i.reduce((d,c)=>d+c.byteLength,0),o=new ArrayBuffer(t),a=new Uint8Array(o);let v=0;for(const d of i)a.set(d.buffer,v),v+=d.byteLength;return o})}find(e,i){if(this.element)if(!this._findStarted)this.updateFind(e);else{const t={forward:!i,findNext:!1,matchCase:!1};this._webviewMainService.findInFrame({windowId:this._nativeHostService.windowId},this.id,e,t)}}updateFind(e){if(!e||!this.element)return;const i={forward:!0,findNext:!0,matchCase:!1};this._iframeDelayer.trigger(()=>{this._findStarted=!0,this._webviewMainService.findInFrame({windowId:this._nativeHostService.windowId},this.id,e,i)})}stopFind(e){this.element&&(this._iframeDelayer.cancel(),this._findStarted=!1,this._webviewMainService.stopFindInFrame({windowId:this._nativeHostService.windowId},this.id,{keepSelection:e}),this._onDidStopFind.fire())}handleFocusChange(e){super.handleFocusChange(e),e?this._webviewKeyboardHandler.didFocus():this._webviewKeyboardHandler.didBlur()}};m=p([r(2,W),r(3,P),r(4,A),r(5,K),r(6,O),r(7,N),r(8,L),r(9,B),r(10,x),r(11,T),r(12,R),r(13,D),r(14,H)],m);export{m as ElectronWebviewElement};
