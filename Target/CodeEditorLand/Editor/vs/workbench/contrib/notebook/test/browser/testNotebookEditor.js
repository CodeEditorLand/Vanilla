import*as O from"../../../../../base/browser/dom.js";import"../../../../../base/browser/ui/list/list.js";import{VSBuffer as _}from"../../../../../base/common/buffer.js";import{NotImplementedError as w}from"../../../../../base/common/errors.js";import{Emitter as c,Event as v}from"../../../../../base/common/event.js";import{DisposableStore as M}from"../../../../../base/common/lifecycle.js";import{ResourceMap as U}from"../../../../../base/common/map.js";import{Mimes as A}from"../../../../../base/common/mime.js";import{URI as N}from"../../../../../base/common/uri.js";import{mock as p}from"../../../../../base/test/common/mock.js";import{runWithFakedTimers as P}from"../../../../../base/test/common/timeTravelScheduler.js";import{ILanguageService as B}from"../../../../../editor/common/languages/language.js";import{ILanguageConfigurationService as W}from"../../../../../editor/common/languages/languageConfigurationRegistry.js";import{LanguageService as H}from"../../../../../editor/common/services/languageService.js";import{IModelService as K}from"../../../../../editor/common/services/model.js";import{ModelService as q}from"../../../../../editor/common/services/modelService.js";import{ITextModelService as z}from"../../../../../editor/common/services/resolverService.js";import{TestLanguageConfigurationService as $}from"../../../../../editor/test/common/modes/testLanguageConfigurationService.js";import{IClipboardService as j}from"../../../../../platform/clipboard/common/clipboardService.js";import{TestClipboardService as G}from"../../../../../platform/clipboard/test/common/testClipboardService.js";import{IConfigurationService as b}from"../../../../../platform/configuration/common/configuration.js";import{TestConfigurationService as J}from"../../../../../platform/configuration/test/common/testConfigurationService.js";import{ContextKeyService as Q}from"../../../../../platform/contextkey/browser/contextKeyService.js";import{IContextKeyService as E}from"../../../../../platform/contextkey/common/contextkey.js";import{TestInstantiationService as X}from"../../../../../platform/instantiation/test/common/instantiationServiceMock.js";import{IKeybindingService as Y}from"../../../../../platform/keybinding/common/keybinding.js";import{MockKeybindingService as Z}from"../../../../../platform/keybinding/test/common/mockKeybindingService.js";import{ILayoutService as ee}from"../../../../../platform/layout/browser/layoutService.js";import{IListService as oe,ListService as te}from"../../../../../platform/list/browser/listService.js";import{ILogService as re,NullLogService as ne}from"../../../../../platform/log/common/log.js";import{IStorageService as ie}from"../../../../../platform/storage/common/storage.js";import{IThemeService as de}from"../../../../../platform/theme/common/themeService.js";import{TestThemeService as le}from"../../../../../platform/theme/test/common/testThemeService.js";import{IUndoRedoService as se}from"../../../../../platform/undoRedo/common/undoRedo.js";import{UndoRedoService as ae}from"../../../../../platform/undoRedo/common/undoRedoService.js";import{IWorkspaceTrustRequestService as ue}from"../../../../../platform/workspace/common/workspaceTrust.js";import"../../../../common/editor/editorInput.js";import{EditorModel as ce}from"../../../../common/editor/editorModel.js";import{CellFocusMode as f}from"../../browser/notebookBrowser.js";import"../../browser/notebookViewEvents.js";import{NotebookCellStatusBarService as me}from"../../browser/services/notebookCellStatusBarServiceImpl.js";import{ListViewInfoAccessor as ge,NotebookCellList as pe}from"../../browser/view/notebookCellList.js";import"../../browser/view/notebookRenderingCommon.js";import{NotebookEventDispatcher as ve}from"../../browser/viewModel/eventDispatcher.js";import{NotebookViewModel as be}from"../../browser/viewModel/notebookViewModelImpl.js";import{ViewContext as fe}from"../../browser/viewModel/viewContext.js";import{NotebookCellTextModel as Ce}from"../../common/model/notebookCellTextModel.js";import{NotebookTextModel as Ie}from"../../common/model/notebookTextModel.js";import{INotebookCellStatusBarService as ke}from"../../common/notebookCellStatusBarService.js";import{CellUri as C,NotebookCellExecutionState as he,SelectionStateType as x}from"../../common/notebookCommon.js";import{INotebookExecutionStateService as I}from"../../common/notebookExecutionStateService.js";import{NotebookOptions as D}from"../../browser/notebookOptions.js";import"../../common/notebookRange.js";import{TextModelResolverService as Se}from"../../../../services/textmodelResolver/common/textModelResolverService.js";import"../../../../services/workingCopy/common/workingCopy.js";import{TestLayoutService as we}from"../../../../test/browser/workbenchTestServices.js";import{TestStorageService as Me,TestWorkspaceTrustRequestService as Ne}from"../../../../test/common/workbenchTestServices.js";import{FontInfo as Ee}from"../../../../../editor/common/config/fontInfo.js";import{EditorFontLigatures as xe,EditorFontVariations as De}from"../../../../../editor/common/config/editorOptions.js";import{ICodeEditorService as k}from"../../../../../editor/browser/services/codeEditorService.js";import{mainWindow as y}from"../../../../../base/browser/window.js";import{TestCodeEditorService as ye}from"../../../../../editor/test/browser/editorTestServices.js";import{INotebookCellOutlineDataSourceFactory as Re,NotebookCellOutlineDataSourceFactory as Te}from"../../browser/viewModel/notebookOutlineDataSourceFactory.js";import{ILanguageDetectionService as Fe}from"../../../../services/languageDetection/common/languageDetectionWorkerService.js";class Mt extends Ce{constructor(d,n,s,i,l,m,u){super(C.generate(N.parse("test:///fake/notebook"),n),n,s,i,A.text,l,m,void 0,void 0,void 0,{transientCellMetadata:{},transientDocumentMetadata:{},transientOutputs:!1,cellContentMetadata:{}},u);this.viewType=d;this.source=s}}class Le extends ce{constructor(d){super();this._notebook=d;d&&d.onDidChangeContent&&this._register(d.onDidChangeContent(()=>{this._dirty=!0,this._onDidChangeDirty.fire(),this._onDidChangeContent.fire()}))}_dirty=!1;_onDidSave=this._register(new c);onDidSave=this._onDidSave.event;_onDidChangeDirty=this._register(new c);onDidChangeDirty=this._onDidChangeDirty.event;onDidChangeOrphaned=v.None;onDidChangeReadonly=v.None;onDidRevertUntitled=v.None;_onDidChangeContent=this._register(new c);onDidChangeContent=this._onDidChangeContent.event;get viewType(){return this._notebook.viewType}get resource(){return this._notebook.uri}get notebook(){return this._notebook}isReadonly(){return!1}isOrphaned(){return!1}hasAssociatedFilePath(){return!1}isDirty(){return this._dirty}get hasErrorState(){return!1}isModified(){return this._dirty}getNotebook(){return this._notebook}async load(){return this}async save(){return this._notebook?(this._dirty=!1,this._onDidChangeDirty.fire(),this._onDidSave.fire({}),!0):!1}saveAs(){throw new w}revert(){throw new w}}function R(t){const e=t.add(new X),d=new le;return e.stub(B,t.add(new H)),e.stub(se,e.createInstance(ae)),e.stub(b,new J),e.stub(de,d),e.stub(W,t.add(new $)),e.stub(K,t.add(e.createInstance(q))),e.stub(z,t.add(e.createInstance(Se))),e.stub(E,t.add(e.createInstance(Q))),e.stub(oe,t.add(e.createInstance(te))),e.stub(ee,new we),e.stub(re,new ne),e.stub(j,G),e.stub(ie,t.add(new Me)),e.stub(ue,t.add(new Ne(!0))),e.stub(I,new _e),e.stub(Y,new Z),e.stub(ke,t.add(new me)),e.stub(k,t.add(new ye(d))),e.stub(Re,e.createInstance(Te)),e.stub(Fe,new class{_serviceBrand;isEnabledForLanguage(s){return!1}async detectLanguage(s,i){}}),e}function T(t,e,d){const n="notebook",s=e.add(t.createInstance(Ie,n,N.parse("test://test"),d.map(o=>({source:o[0],mime:void 0,language:o[1],cellKind:o[2],outputs:o[3]??[],metadata:o[4]})),{},{transientCellMetadata:{},transientDocumentMetadata:{},cellContentMetadata:{},transientOutputs:!1})),i=e.add(new Le(s)),l=e.add(new D(y,!1,void 0,t.get(b),t.get(I),t.get(k))),m=new class extends p(){},u=new fe(l,e.add(new ve),()=>m),r=e.add(t.createInstance(be,n,i.notebook,u,null,{isReadOnly:!1})),a=e.add(Ve(t,e,u));a.attachViewModel(r);const h=e.add(new ge(a));let S=[{start:0,end:100}];const L=Date.now().toString();return{editor:new class extends p(){dispose(){r.dispose()}notebookOptions=l;onDidChangeModel=new c().event;onDidChangeCellState=new c().event;getViewModel(){return r}textModel=r.notebookDocument;hasModel(){return!!r}getLength(){return r.length}getFocus(){return r.getFocus()}getSelections(){return r.getSelections()}setFocus(o){r.updateSelectionsState({kind:x.Index,focus:o,selections:r.getSelections()})}setSelections(o){r.updateSelectionsState({kind:x.Index,focus:r.getFocus(),selections:o})}getViewIndexByModelIndex(o){return h.getViewIndex(r.viewCells[o])}getCellRangeFromViewRange(o,g){return h.getCellRangeFromViewRange(o,g)}revealCellRangeInView(){}setHiddenAreas(o){return a.setHiddenAreas(o,!0)}getActiveCell(){const o=a.getFocusedElements();if(o&&o.length)return o[0]}hasOutputTextSelection(){return!1}changeModelDecorations(){return null}focusElement(){}setCellEditorSelection(){}async revealRangeInCenterIfOutsideViewportAsync(){}async layoutNotebookCell(){}async createOutput(){}async removeInset(){}async focusNotebookCell(o,g){o.focusMode=g==="editor"?f.Editor:g==="output"?f.Output:f.Container}cellAt(o){return r.cellAt(o)}getCellIndex(o){return r.getCellIndex(o)}getCellsInRange(o){return r.getCellsInRange(o)}getCellByHandle(o){return r.getCellByHandle(o)}getNextVisibleCellIndex(o){return r.getNextVisibleCellIndex(o)}getControl(){return this}get onDidChangeSelection(){return r.onDidChangeSelection}get onDidChangeOptions(){return r.onDidChangeOptions}get onDidChangeViewCells(){return r.onDidChangeViewCells}async find(o,g){return r.find(o,g).filter(V=>V.length>0)}deltaCellDecorations(){return[]}onDidChangeVisibleRanges=v.None;get visibleRanges(){return S}set visibleRanges(o){S=o}getId(){return L}setScrollTop(o){a.scrollTop=o}get scrollTop(){return a.scrollTop}getLayoutInfo(){return{width:0,height:0,scrollHeight:a.getScrollHeight(),fontInfo:new Ee({pixelRatio:1,fontFamily:"mockFont",fontWeight:"normal",fontSize:14,fontFeatureSettings:xe.OFF,fontVariationSettings:De.OFF,lineHeight:19,letterSpacing:1.5,isMonospace:!0,typicalHalfwidthCharacterWidth:10,typicalFullwidthCharacterWidth:20,canUseHalfwidthRightwardsArrow:!0,spaceWidth:10,middotWidth:10,wsmiddotWidth:10,maxDigitWidth:10},!0),stickyHeight:0}}},viewModel:r}}function F(t,e,d){return T(t,e,d)}async function Et(t,e,d){const n=new M,s=R(n),i=F(s,n,t),l=F(s,n,e),m=new class extends p(){get notebook(){return i.viewModel.notebookDocument}get resource(){return i.viewModel.notebookDocument.uri}},u=new class extends p(){get notebook(){return l.viewModel.notebookDocument}get resource(){return l.viewModel.notebookDocument.uri}},r=new class extends p(){get original(){return m}get modified(){return u}},a=await d(r,n,s);return a instanceof Promise?a.finally(()=>{i.editor.dispose(),i.viewModel.notebookDocument.dispose(),i.viewModel.dispose(),l.editor.dispose(),l.viewModel.notebookDocument.dispose(),l.viewModel.dispose(),n.dispose()}):(i.editor.dispose(),i.viewModel.notebookDocument.dispose(),i.viewModel.dispose(),l.editor.dispose(),l.viewModel.notebookDocument.dispose(),l.viewModel.dispose(),n.dispose()),a}async function xt(t,e,d){const n=new M,s=d??R(n),i=T(s,n,t);return P({useFakeTimers:!0},async()=>{const l=await e(i.editor,i.viewModel,n,s);return l instanceof Promise?l.finally(()=>{i.editor.dispose(),i.viewModel.dispose(),i.editor.textModel.dispose(),n.dispose()}):(i.editor.dispose(),i.viewModel.dispose(),i.editor.textModel.dispose(),n.dispose()),l})}function Ve(t,e,d){const n={getHeight(u){return u.getHeight(17)},getTemplateId(){return"template"}},s=new class extends p(){},i={templateId:"template",renderTemplate(){return s},renderElement(){},disposeTemplate(){}},l=d?d.notebookOptions:e.add(new D(y,!1,void 0,t.get(b),t.get(I),t.get(k)));return e.add(t.createInstance(pe,"NotebookCellList",O.$("container"),l,n,[i],t.get(E),{supportDynamicHeights:!0,multipleSelectionSupport:!0}))}function Dt(t){return _.fromString(t)}class Oe{constructor(e,d,n){this.notebook=e;this.cellHandle=d;this.onComplete=n}state=he.Unconfirmed;didPause=!1;isPaused=!1;confirm(){}update(e){}complete(e){this.onComplete()}}class _e{_serviceBrand;_executions=new U;onDidChangeExecution=new c().event;onDidChangeLastRunFailState=new c().event;forceCancelNotebookExecutions(e){}getCellExecutionsForNotebook(e){return[]}getCellExecution(e){return this._executions.get(e)}createCellExecution(e,d){const n=()=>this._executions.delete(C.generate(e,d)),s=new Oe(e,d,n);return this._executions.set(C.generate(e,d),s),s}getCellExecutionsByHandleForNotebook(e){}getLastFailedCellForNotebook(e){}getExecution(e){}createExecution(e){throw new Error("Method not implemented.")}}export{Le as NotebookEditorTestModel,Mt as TestCell,_e as TestNotebookExecutionStateService,Ve as createNotebookCellList,F as createTestNotebookEditor,R as setupInstantiationService,Dt as valueBytesFromString,xt as withTestNotebook,Et as withTestNotebookDiffModel};
