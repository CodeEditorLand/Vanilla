import a from"assert";import{VSBuffer as s}from"../../../../../base/common/buffer.js";import{CancellationTokenSource as j}from"../../../../../base/common/cancellation.js";import{LcsDiff as h}from"../../../../../base/common/diff/diff.js";import{DisposableStore as x}from"../../../../../base/common/lifecycle.js";import{Mimes as l}from"../../../../../base/common/mime.js";import{mock as D}from"../../../../../base/test/common/mock.js";import{ensureNoDisposablesAreLeakedInTestSuite as b}from"../../../../../base/test/common/utils.js";import{TestConfigurationService as L}from"../../../../../platform/configuration/test/common/testConfigurationService.js";import"../../browser/diff/diffElementViewModel.js";import{NotebookDiffEditorEventDispatcher as I}from"../../browser/diff/eventDispatcher.js";import"../../browser/diff/notebookDiffEditorBrowser.js";import{NotebookDiffViewModel as C,prettyChanges as q}from"../../browser/diff/notebookDiffViewModel.js";import{CellKind as t}from"../../common/notebookCommon.js";import{INotebookService as y}from"../../common/notebookService.js";import"../../common/services/notebookWorkerService.js";import{withTestNotebookDiffModel as p}from"./testNotebookEditor.js";class f{constructor(m){this.textModel=m}getElements(){const m=new Int32Array(this.textModel.cells.length);for(let u=0;u<this.textModel.cells.length;u++)m[u]=this.textModel.cells[u].getHashValue();return m}}suite("NotebookDiff",()=>{let S,m,u,e,c,w;teardown(()=>S.dispose());const v=new L;b(),setup(()=>{S=new x;const i=S.add(new j);u=S.add(new I),m=i.token,w=new class extends D(){computeDiff(){return Promise.resolve({cellsDiff:c})}}});async function E(i){let d;S.add(i.onDidChangeItems(r=>d=r)),await i.computeDiff(m),a.strictEqual(d,void 0)}test("diff different source",async()=>{await p([["x","javascript",t.Code,[{outputId:"someOtherId",outputs:[{mime:l.text,data:s.wrap(new Uint8Array([3]))}]}],{metadata:{collapsed:!1},executionOrder:3}]],[["y","javascript",t.Code,[{outputId:"someOtherId",outputs:[{mime:l.text,data:s.wrap(new Uint8Array([3]))}]}],{metadata:{collapsed:!1},executionOrder:3}]],async(i,d,r)=>{c=new h(new f(i.original.notebook),new f(i.modified.notebook)).ComputeDiff(!1),a.strictEqual(c.changes.length,1),a.deepStrictEqual(c.changes.map(o=>({originalStart:o.originalStart,originalLength:o.originalLength,modifiedStart:o.modifiedStart,modifiedLength:o.modifiedLength})),[{originalStart:0,originalLength:1,modifiedStart:0,modifiedLength:1}]),e=d.add(new C(i,w,v,u,r.get(y),void 0)),await e.computeDiff(m),a.strictEqual(e.items.length,1),a.strictEqual(e.items[0].type,"modified")})}),test("No changes when re-computing diff with the same source",async()=>{await p([["x","javascript",t.Code,[{outputId:"someOtherId",outputs:[{mime:l.text,data:s.wrap(new Uint8Array([3]))}]}],{metadata:{collapsed:!1},executionOrder:3}]],[["y","javascript",t.Code,[{outputId:"someOtherId",outputs:[{mime:l.text,data:s.wrap(new Uint8Array([3]))}]}],{metadata:{collapsed:!1},executionOrder:3}]],async(i,d,r)=>{c=new h(new f(i.original.notebook),new f(i.modified.notebook)).ComputeDiff(!1),a.strictEqual(c.changes.length,1),a.deepStrictEqual(c.changes.map(o=>({originalStart:o.originalStart,originalLength:o.originalLength,modifiedStart:o.modifiedStart,modifiedLength:o.modifiedLength})),[{originalStart:0,originalLength:1,modifiedStart:0,modifiedLength:1}]),e=d.add(new C(i,w,v,u,r.get(y),void 0)),await e.computeDiff(m),await E(e)})}),test("diff different output",async()=>{await p([["x","javascript",t.Code,[{outputId:"someId",outputs:[{mime:l.text,data:s.wrap(new Uint8Array([5]))}]}],{metadata:{collapsed:!1},executionOrder:5}],["","javascript",t.Code,[],{}]],[["x","javascript",t.Code,[{outputId:"someOtherId",outputs:[{mime:l.text,data:s.wrap(new Uint8Array([3]))}]}],{metadata:{collapsed:!1},executionOrder:3}],["","javascript",t.Code,[],{}]],async(i,d,r)=>{c=new h(new f(i.original.notebook),new f(i.modified.notebook)).ComputeDiff(!1),a.strictEqual(c.changes.length,1),a.deepStrictEqual(c.changes.map(g=>({originalStart:g.originalStart,originalLength:g.originalLength,modifiedStart:g.modifiedStart,modifiedLength:g.modifiedLength})),[{originalStart:0,originalLength:1,modifiedStart:0,modifiedLength:1}]),e=d.add(new C(i,w,v,u,r.get(y),void 0));let o;d.add(e.onDidChangeItems(g=>o=g)),await e.computeDiff(m),a.strictEqual(e.items.length,2),a.strictEqual(e.items[0].type,"modified"),a.strictEqual(e.items[1].type,"placeholder"),e.items[1].showHiddenCells(),a.strictEqual(e.items.length,2),a.strictEqual(e.items[0].type,"modified"),a.strictEqual(e.items[1].type,"unchanged"),a.deepStrictEqual(o,{start:1,deleteCount:1,elements:[e.items[1]]}),e.items[1].hideUnchangedCells(),a.strictEqual(e.items.length,2),a.strictEqual(e.items[0].type,"modified"),a.strictEqual(e.items[1].type,"placeholder"),a.deepStrictEqual(o,{start:1,deleteCount:1,elements:[e.items[1]]}),await E(e)})}),test("diff test small source",async()=>{await p([["123456789","javascript",t.Code,[],{}]],[["987654321","javascript",t.Code,[],{}]],async(i,d,r)=>{c=new h(new f(i.original.notebook),new f(i.modified.notebook)).ComputeDiff(!1),a.strictEqual(c.changes.length,1),a.deepStrictEqual(c.changes.map(o=>({originalStart:o.originalStart,originalLength:o.originalLength,modifiedStart:o.modifiedStart,modifiedLength:o.modifiedLength})),[{originalStart:0,originalLength:1,modifiedStart:0,modifiedLength:1}]),e=d.add(new C(i,w,v,u,r.get(y),void 0)),await e.computeDiff(m),a.strictEqual(e.items.length,1),a.strictEqual(e.items[0].type,"modified"),await E(e)})}),test("diff test data single cell",async()=>{await p([[[`# This version has a bug
`,`def mult(a, b):
`,"    return a / b"].join(""),"javascript",t.Code,[],{}]],[[[`def mult(a, b):
`,`    'This version is debugged.'
`,"    return a * b"].join(""),"javascript",t.Code,[],{}]],async(i,d,r)=>{c=new h(new f(i.original.notebook),new f(i.modified.notebook)).ComputeDiff(!1),a.strictEqual(c.changes.length,1),a.deepStrictEqual(c.changes.map(o=>({originalStart:o.originalStart,originalLength:o.originalLength,modifiedStart:o.modifiedStart,modifiedLength:o.modifiedLength})),[{originalStart:0,originalLength:1,modifiedStart:0,modifiedLength:1}]),e=d.add(new C(i,w,v,u,r.get(y),void 0)),await e.computeDiff(m),a.strictEqual(e.items.length,1),a.strictEqual(e.items[0].type,"modified"),await E(e)})}),test("diff foo/foe",async()=>{await p([[[`def foe(x, y):
`,`    return x + y
`,"foe(3, 2)"].join(""),"javascript",t.Code,[{outputId:"someId",outputs:[{mime:l.text,data:s.wrap(new Uint8Array([6]))}]}],{metadata:{collapsed:!1},executionOrder:5}],[[`def foo(x, y):
`,`    return x * y
`,"foo(1, 2)"].join(""),"javascript",t.Code,[{outputId:"someId",outputs:[{mime:l.text,data:s.wrap(new Uint8Array([2]))}]}],{metadata:{collapsed:!1},executionOrder:6}],["","javascript",t.Code,[],{}]],[[[`def foo(x, y):
`,`    return x * y
`,"foo(1, 2)"].join(""),"javascript",t.Code,[{outputId:"someId",outputs:[{mime:l.text,data:s.wrap(new Uint8Array([6]))}]}],{metadata:{collapsed:!1},executionOrder:5}],[[`def foe(x, y):
`,`    return x + y
`,"foe(3, 2)"].join(""),"javascript",t.Code,[{outputId:"someId",outputs:[{mime:l.text,data:s.wrap(new Uint8Array([2]))}]}],{metadata:{collapsed:!1},executionOrder:6}],["","javascript",t.Code,[],{}]],async(i,d,r)=>{c=new h(new f(i.original.notebook),new f(i.modified.notebook)).ComputeDiff(!1),e=d.add(new C(i,w,v,u,r.get(y),void 0));let o;d.add(e.onDidChangeItems(g=>o=g)),await e.computeDiff(m),a.strictEqual(e.items.length,3),a.strictEqual(e.items[0].type,"modified"),a.strictEqual(e.items[1].type,"modified"),a.strictEqual(e.items[2].type,"placeholder"),e.items[2].showHiddenCells(),a.strictEqual(e.items[2].type,"unchanged"),a.deepStrictEqual(o,{start:2,deleteCount:1,elements:[e.items[2]]}),await E(e)})}),test("diff markdown",async()=>{await p([["This is a test notebook with only markdown cells","markdown",t.Markup,[],{}],["Lorem ipsum dolor sit amet","markdown",t.Markup,[],{}],["In other news","markdown",t.Markup,[],{}]],[["This is a test notebook with markdown cells only","markdown",t.Markup,[],{}],["Lorem ipsum dolor sit amet","markdown",t.Markup,[],{}],["In the news","markdown",t.Markup,[],{}]],async(i,d,r)=>{c=new h(new f(i.original.notebook),new f(i.modified.notebook)).ComputeDiff(!1),e=d.add(new C(i,w,v,u,r.get(y),void 0));let o;d.add(e.onDidChangeItems(g=>o=g)),await e.computeDiff(m),a.strictEqual(e.items.length,3),a.strictEqual(e.items[0].type,"modified"),a.strictEqual(e.items[1].type,"placeholder"),a.strictEqual(e.items[2].type,"modified"),e.items[1].showHiddenCells(),a.strictEqual(e.items[1].type,"unchanged"),a.deepStrictEqual(o,{start:1,deleteCount:1,elements:[e.items[1]]}),await E(e)})}),test("diff insert",async()=>{await p([["var a = 1;","javascript",t.Code,[],{}],["var b = 2;","javascript",t.Code,[],{}]],[["var h = 8;","javascript",t.Code,[],{}],["var a = 1;","javascript",t.Code,[],{}],["var b = 2;","javascript",t.Code,[],{}]],async(i,d,r)=>{c={changes:[{originalStart:0,originalLength:0,modifiedStart:0,modifiedLength:1}],quitEarly:!1},e=d.add(new C(i,w,v,u,r.get(y),void 0));let n;d.add(e.onDidChangeItems(g=>n=g));const o=await e.computeDiff(m);a.strictEqual(o?.firstChangeIndex,0),a.strictEqual(e.items[0].type,"insert"),a.strictEqual(e.items[1].type,"placeholder"),e.items[1].showHiddenCells(),a.strictEqual(e.items[1].type,"unchanged"),a.strictEqual(e.items[2].type,"unchanged"),a.deepStrictEqual(n,{start:1,deleteCount:1,elements:[e.items[1],e.items[2]]}),await E(e)})}),test("diff insert 2",async()=>{await p([["var a = 1;","javascript",t.Code,[],{}],["var b = 2;","javascript",t.Code,[],{}],["var c = 3;","javascript",t.Code,[],{}],["var d = 4;","javascript",t.Code,[],{}],["var e = 5;","javascript",t.Code,[],{}],["var f = 6;","javascript",t.Code,[],{}],["var g = 7;","javascript",t.Code,[],{}]],[["var h = 8;","javascript",t.Code,[],{}],["var a = 1;","javascript",t.Code,[],{}],["var b = 2;","javascript",t.Code,[],{}],["var c = 3;","javascript",t.Code,[],{}],["var d = 4;","javascript",t.Code,[],{}],["var e = 5;","javascript",t.Code,[],{}],["var f = 6;","javascript",t.Code,[],{}],["var g = 7;","javascript",t.Code,[],{}]],async(i,d,r)=>{const n=d.add(new I);c={changes:[{originalStart:0,originalLength:0,modifiedStart:0,modifiedLength:1},{originalStart:0,originalLength:6,modifiedStart:1,modifiedLength:6}],quitEarly:!1},e=d.add(new C(i,w,v,n,r.get(y),void 0));let o;d.add(e.onDidChangeItems(k=>o=k));const g=await e.computeDiff(m);a.strictEqual(g?.firstChangeIndex,0),a.strictEqual(e.items.length,2),a.strictEqual(e.items[0].type,"insert"),a.strictEqual(e.items[1].type,"placeholder"),e.items[1].showHiddenCells(),a.strictEqual(e.items[1].type,"unchanged"),a.strictEqual(e.items[2].type,"unchanged"),a.strictEqual(e.items[3].type,"unchanged"),a.strictEqual(e.items[4].type,"unchanged"),a.strictEqual(e.items[5].type,"unchanged"),a.strictEqual(e.items[6].type,"unchanged"),a.strictEqual(e.items[7].type,"unchanged"),a.deepStrictEqual(o,{start:1,deleteCount:1,elements:e.items.slice(1)}),e.items[1].hideUnchangedCells(),a.strictEqual(e.items.length,2),a.strictEqual(e.items[0].type,"insert"),a.strictEqual(e.items[1].type,"placeholder"),a.deepStrictEqual(o,{start:1,deleteCount:7,elements:[e.items[1]]}),await E(e)})}),test("diff insert 3",async()=>{await p([["var a = 1;","javascript",t.Code,[],{}],["var b = 2;","javascript",t.Code,[],{}],["var c = 3;","javascript",t.Code,[],{}],["var d = 4;","javascript",t.Code,[],{}],["var e = 5;","javascript",t.Code,[],{}],["var f = 6;","javascript",t.Code,[],{}],["var g = 7;","javascript",t.Code,[],{}]],[["var a = 1;","javascript",t.Code,[],{}],["var b = 2;","javascript",t.Code,[],{}],["var c = 3;","javascript",t.Code,[],{}],["var d = 4;","javascript",t.Code,[],{}],["var h = 8;","javascript",t.Code,[],{}],["var e = 5;","javascript",t.Code,[],{}],["var f = 6;","javascript",t.Code,[],{}],["var g = 7;","javascript",t.Code,[],{}]],async(i,d,r)=>{c={changes:[{originalStart:4,originalLength:0,modifiedStart:4,modifiedLength:1}],quitEarly:!1},e=d.add(new C(i,w,v,u,r.get(y),void 0));let n;d.add(e.onDidChangeItems(o=>n=o)),await e.computeDiff(m),a.strictEqual(e.items[0].type,"placeholder"),a.strictEqual(e.items[1].type,"insert"),a.strictEqual(e.items[2].type,"placeholder"),e.items[0].showHiddenCells(),a.strictEqual(e.items[0].type,"unchanged"),a.strictEqual(e.items[1].type,"unchanged"),a.strictEqual(e.items[2].type,"unchanged"),a.strictEqual(e.items[3].type,"unchanged"),a.strictEqual(e.items[4].type,"insert"),a.strictEqual(e.items[5].type,"placeholder"),a.deepStrictEqual(n,{start:0,deleteCount:1,elements:e.items.slice(0,4)}),e.items[5].showHiddenCells(),a.strictEqual(e.items[0].type,"unchanged"),a.strictEqual(e.items[1].type,"unchanged"),a.strictEqual(e.items[2].type,"unchanged"),a.strictEqual(e.items[3].type,"unchanged"),a.strictEqual(e.items[4].type,"insert"),a.strictEqual(e.items[5].type,"unchanged"),a.deepStrictEqual(n,{start:5,deleteCount:1,elements:e.items.slice(5)}),e.items[0].hideUnchangedCells(),a.strictEqual(e.items[0].type,"placeholder"),a.strictEqual(e.items[1].type,"insert"),a.strictEqual(e.items[2].type,"unchanged"),a.deepStrictEqual(n,{start:0,deleteCount:4,elements:e.items.slice(0,1)}),await E(e)})}),test("LCS",async()=>{await p([["# Description","markdown",t.Markup,[],{metadata:{}}],["x = 3","javascript",t.Code,[],{metadata:{collapsed:!0},executionOrder:1}],["x","javascript",t.Code,[{outputId:"someId",outputs:[{mime:l.text,data:s.wrap(new Uint8Array([3]))}]}],{metadata:{collapsed:!1},executionOrder:1}],["x","javascript",t.Code,[],{metadata:{collapsed:!1}}]],[["# Description","markdown",t.Markup,[],{metadata:{}}],["x = 3","javascript",t.Code,[],{metadata:{collapsed:!0},executionOrder:1}],["x","javascript",t.Code,[],{metadata:{collapsed:!1}}],["x","javascript",t.Code,[{outputId:"someId",outputs:[{mime:l.text,data:s.wrap(new Uint8Array([3]))}]}],{metadata:{collapsed:!1},executionOrder:1}]],async i=>{const r=new h(new f(i.original.notebook),new f(i.modified.notebook)).ComputeDiff(!1);a.deepStrictEqual(r.changes.map(n=>({originalStart:n.originalStart,originalLength:n.originalLength,modifiedStart:n.modifiedStart,modifiedLength:n.modifiedLength})),[{originalStart:2,originalLength:0,modifiedStart:2,modifiedLength:1},{originalStart:3,originalLength:1,modifiedStart:4,modifiedLength:0}])})}),test("LCS 2",async()=>{await p([["# Description","markdown",t.Markup,[],{metadata:{}}],["x = 3","javascript",t.Code,[],{metadata:{collapsed:!0},executionOrder:1}],["x","javascript",t.Code,[{outputId:"someId",outputs:[{mime:l.text,data:s.wrap(new Uint8Array([3]))}]}],{metadata:{collapsed:!1},executionOrder:1}],["x","javascript",t.Code,[],{metadata:{collapsed:!1}}],["x = 5","javascript",t.Code,[],{}],["x","javascript",t.Code,[],{}],["x","javascript",t.Code,[{outputId:"someId",outputs:[{mime:l.text,data:s.wrap(new Uint8Array([5]))}]}],{}]],[["# Description","markdown",t.Markup,[],{metadata:{}}],["x = 3","javascript",t.Code,[],{metadata:{collapsed:!0},executionOrder:1}],["x","javascript",t.Code,[],{metadata:{collapsed:!1}}],["x","javascript",t.Code,[{outputId:"someId",outputs:[{mime:l.text,data:s.wrap(new Uint8Array([3]))}]}],{metadata:{collapsed:!1},executionOrder:1}],["x = 5","javascript",t.Code,[],{}],["x","javascript",t.Code,[{outputId:"someId",outputs:[{mime:l.text,data:s.wrap(new Uint8Array([5]))}]}],{}],["x","javascript",t.Code,[],{}]],async i=>{const r=new h(new f(i.original.notebook),new f(i.modified.notebook)).ComputeDiff(!1);q(i,r),a.deepStrictEqual(r.changes.map(n=>({originalStart:n.originalStart,originalLength:n.originalLength,modifiedStart:n.modifiedStart,modifiedLength:n.modifiedLength})),[{originalStart:2,originalLength:0,modifiedStart:2,modifiedLength:1},{originalStart:3,originalLength:1,modifiedStart:4,modifiedLength:0},{originalStart:5,originalLength:0,modifiedStart:5,modifiedLength:1},{originalStart:6,originalLength:1,modifiedStart:7,modifiedLength:0}])})}),test("LCS 3",async()=>{await p([["var a = 1;","javascript",t.Code,[],{}],["var b = 2;","javascript",t.Code,[],{}],["var c = 3;","javascript",t.Code,[],{}],["var d = 4;","javascript",t.Code,[],{}],["var e = 5;","javascript",t.Code,[],{}],["var f = 6;","javascript",t.Code,[],{}],["var g = 7;","javascript",t.Code,[],{}]],[["var a = 1;","javascript",t.Code,[],{}],["var b = 2;","javascript",t.Code,[],{}],["var c = 3;","javascript",t.Code,[],{}],["var d = 4;","javascript",t.Code,[],{}],["var h = 8;","javascript",t.Code,[],{}],["var e = 5;","javascript",t.Code,[],{}],["var f = 6;","javascript",t.Code,[],{}],["var g = 7;","javascript",t.Code,[],{}]],async i=>{const r=new h(new f(i.original.notebook),new f(i.modified.notebook)).ComputeDiff(!1);q(i,r),a.deepStrictEqual(r.changes.map(n=>({originalStart:n.originalStart,originalLength:n.originalLength,modifiedStart:n.modifiedStart,modifiedLength:n.modifiedLength})),[{originalStart:4,originalLength:0,modifiedStart:4,modifiedLength:1}])})}),test("diff output",async()=>{await p([["x","javascript",t.Code,[{outputId:"someOtherId",outputs:[{mime:l.text,data:s.wrap(new Uint8Array([3]))}]}],{metadata:{collapsed:!1},executionOrder:3}],["y","javascript",t.Code,[{outputId:"someOtherId",outputs:[{mime:l.text,data:s.wrap(new Uint8Array([4]))}]}],{metadata:{collapsed:!1},executionOrder:3}]],[["x","javascript",t.Code,[{outputId:"someOtherId",outputs:[{mime:l.text,data:s.wrap(new Uint8Array([3]))}]}],{metadata:{collapsed:!1},executionOrder:3}],["y","javascript",t.Code,[{outputId:"someOtherId",outputs:[{mime:l.text,data:s.wrap(new Uint8Array([5]))}]}],{metadata:{collapsed:!1},executionOrder:3}]],async(i,d,r)=>{c=new h(new f(i.original.notebook),new f(i.modified.notebook)).ComputeDiff(!1),e=d.add(new C(i,w,v,u,r.get(y),void 0)),await e.computeDiff(m),a.strictEqual(e.items.length,2),a.strictEqual(e.items[0].type,"placeholder"),e.items[0].showHiddenCells(),a.strictEqual(e.items[0].checkIfOutputsModified(),!1),a.strictEqual(e.items[1].type,"modified"),await E(e)})}),test("diff output fast check",async()=>{await p([["x","javascript",t.Code,[{outputId:"someOtherId",outputs:[{mime:l.text,data:s.wrap(new Uint8Array([3]))}]}],{metadata:{collapsed:!1},executionOrder:3}],["y","javascript",t.Code,[{outputId:"someOtherId",outputs:[{mime:l.text,data:s.wrap(new Uint8Array([4]))}]}],{metadata:{collapsed:!1},executionOrder:3}]],[["x","javascript",t.Code,[{outputId:"someOtherId",outputs:[{mime:l.text,data:s.wrap(new Uint8Array([3]))}]}],{metadata:{collapsed:!1},executionOrder:3}],["y","javascript",t.Code,[{outputId:"someOtherId",outputs:[{mime:l.text,data:s.wrap(new Uint8Array([5]))}]}],{metadata:{collapsed:!1},executionOrder:3}]],async(i,d,r)=>{c=new h(new f(i.original.notebook),new f(i.modified.notebook)).ComputeDiff(!1),e=d.add(new C(i,w,v,u,r.get(y),void 0)),await e.computeDiff(m),a.strictEqual(e.items.length,2),a.strictEqual(e.items[0].type,"placeholder"),e.items[0].showHiddenCells(),a.strictEqual(e.items[0].original.textModel.equal(e.items[0].modified.textModel),!0),a.strictEqual(e.items[1].original.textModel.equal(e.items[1].modified.textModel),!1),await E(e)})})});
