import c from"assert";import{AsyncIterableObject as R,DeferredPromise as y}from"../../../../../base/common/async.js";import"../../../../../base/common/cancellation.js";import{Event as C}from"../../../../../base/common/event.js";import{DisposableStore as U}from"../../../../../base/common/lifecycle.js";import{URI as _}from"../../../../../base/common/uri.js";import{mock as I}from"../../../../../base/test/common/mock.js";import{ensureNoDisposablesAreLeakedInTestSuite as j}from"../../../../../base/test/common/utils.js";import{PLAINTEXT_LANGUAGE_ID as F}from"../../../../../editor/common/languages/modesRegistry.js";import{IMenuService as P}from"../../../../../platform/actions/common/actions.js";import{ExtensionIdentifier as A}from"../../../../../platform/extensions/common/extensions.js";import"../../../../../platform/instantiation/test/common/instantiationServiceMock.js";import{insertCellAtIndex as E}from"../../browser/controller/cellOperations.js";import{NotebookExecutionService as O}from"../../browser/services/notebookExecutionServiceImpl.js";import{NotebookExecutionStateService as L}from"../../browser/services/notebookExecutionStateServiceImpl.js";import{NotebookKernelService as H}from"../../browser/services/notebookKernelServiceImpl.js";import"../../browser/viewModel/notebookViewModelImpl.js";import"../../common/model/notebookTextModel.js";import{CellEditType as K,CellKind as p,CellUri as V,NotebookExecutionState as D}from"../../common/notebookCommon.js";import{CellExecutionUpdateType as v,INotebookExecutionService as W}from"../../common/notebookExecutionService.js";import{INotebookExecutionStateService as m,NotebookExecutionType as S}from"../../common/notebookExecutionStateService.js";import{INotebookKernelService as G}from"../../common/notebookKernelService.js";import{INotebookLoggingService as X}from"../../common/notebookLoggingService.js";import{INotebookService as Y}from"../../common/notebookService.js";import{setupInstantiationService as z,withTestNotebook as B}from"./testNotebookEditor.js";suite("NotebookExecutionStateService",()=>{let l,u,f,k;teardown(()=>{f.dispose()}),j(),setup(function(){f=new U,l=z(f),l.stub(Y,new class extends I(){onDidAddNotebookDocument=C.None;onWillRemoveNotebookDocument=C.None;getNotebookTextModels(){return[]}getNotebookTextModel(e){return k}}),l.stub(P,new class extends I(){createMenu(){return new class extends I(){onDidChange=C.None;getActions(){return[]}dispose(){}}}}),l.stub(X,new class extends I(){debug(e,d){}}),u=f.add(l.createInstance(H)),l.set(G,u),l.set(W,f.add(l.createInstance(O))),l.set(m,f.add(l.createInstance(L)))});async function x(e,d){return B(e,(o,i)=>d(i,i.notebookDocument,f))}function h(e,d){return x([],async(o,i,t)=>{k=o.notebookDocument;let r=0;const a=new class extends g{implementsInterrupt=d;constructor(){super({languages:["javascript"]})}async executeNotebookCellsRequest(){}async cancelNotebookCellExecution(Q,q){r+=q.length}};t.add(u.registerKernel(a)),u.selectKernelForNotebook(a,o.notebookDocument);const n=l.get(m),s=t.add(E(o,0,"var c = 3","javascript",p.Code,{},[],!0,!0)),b=t.add(E(o,1,"var c = 3","javascript",p.Code,{},[],!0,!0)),N=t.add(E(o,2,"var c = 3","javascript",p.Code,{},[],!0,!0));E(o,3,"var c = 3","javascript",p.Code,{},[],!0,!0);const T=n.createCellExecution(o.uri,s.handle);T.confirm(),T.update([{editType:v.ExecutionState,executionOrder:1}]),n.createCellExecution(o.uri,b.handle).confirm(),n.createCellExecution(o.uri,N.handle),c.strictEqual(r,0),o.notebookDocument.applyEdits([{editType:K.Replace,index:0,count:3,cells:[]}],!0,void 0,()=>{},void 0,!1),c.strictEqual(r,e)})}test("cancel execution when cell is deleted",async function(){return h(3,!1)}),test("cancel execution when cell is deleted in interrupt-type kernel",async function(){return h(1,!0)}),test("fires onDidChangeCellExecution when cell is completed while deleted",async function(){return x([],async(e,d,o)=>{k=e.notebookDocument;const i=new g;o.add(u.registerKernel(i)),u.selectKernelForNotebook(i,e.notebookDocument);const t=l.get(m),r=E(e,0,"var c = 3","javascript",p.Code,{},[],!0,!0),a=t.createCellExecution(e.uri,r.handle);let n=!1;o.add(t.onDidChangeExecution(s=>{s.type===S.cell&&(n=!s.changed)})),e.notebookDocument.applyEdits([{editType:K.Replace,index:0,count:1,cells:[]}],!0,void 0,()=>{},void 0,!1),a.complete({}),c.strictEqual(n,!0)})}),test("does not fire onDidChangeCellExecution for output updates",async function(){return x([],async(e,d,o)=>{k=e.notebookDocument;const i=new g;o.add(u.registerKernel(i)),u.selectKernelForNotebook(i,e.notebookDocument);const t=l.get(m),r=o.add(E(e,0,"var c = 3","javascript",p.Code,{},[],!0,!0)),a=t.createCellExecution(e.uri,r.handle);let n=!1;o.add(t.onDidChangeExecution(s=>{s.type===S.cell&&(n=!0)})),a.update([{editType:v.OutputItems,items:[],outputId:"1"}]),c.strictEqual(n,!1),a.update([{editType:v.ExecutionState,executionOrder:123}]),c.strictEqual(n,!0),a.complete({})})}),test("getCellExecution and onDidChangeCellExecution",async function(){return x([],async(e,d,o)=>{k=e.notebookDocument;const i=new g;o.add(u.registerKernel(i)),u.selectKernelForNotebook(i,e.notebookDocument);const t=l.get(m),r=o.add(E(e,0,"var c = 3","javascript",p.Code,{},[],!0,!0)),a=new y;return o.add(t.onDidChangeExecution(n=>{if(n.type===S.cell){const s=V.generate(n.notebook,n.cellHandle),b=t.getCellExecution(s);c.ok(b),c.strictEqual(n.notebook.toString(),b.notebook.toString()),c.strictEqual(n.cellHandle,b.cellHandle),c.strictEqual(b.notebook.toString(),n.changed?.notebook.toString()),c.strictEqual(b.cellHandle,n.changed?.cellHandle),a.complete()}})),t.createCellExecution(e.uri,r.handle),a.p})}),test("getExecution and onDidChangeExecution",async function(){return x([],async(e,d,o)=>{k=e.notebookDocument;const i=new g;o.add(u.registerKernel(i)),u.selectKernelForNotebook(i,e.notebookDocument);const t=[],r=l.get(m);r.onDidChangeExecution(n=>t.push(n.type===S.notebook&&!!n.changed),this,o);const a=new y;return o.add(r.onDidChangeExecution(n=>{if(n.type===S.notebook){const s=r.getExecution(e.uri);c.ok(s),c.strictEqual(n.notebook.toString(),s.notebook.toString()),c.ok(n.affectsNotebook(e.uri)),c.deepStrictEqual(t,[!0]),a.complete()}})),r.createExecution(e.uri),a.p})}),test("getExecution and onDidChangeExecution 2",async function(){return x([],async(e,d,o)=>{k=e.notebookDocument;const i=new g;o.add(u.registerKernel(i)),u.selectKernelForNotebook(i,e.notebookDocument);const t=l.get(m),r=new y,a=[D.Unconfirmed,D.Pending,D.Executing,void 0];t.onDidChangeExecution(s=>{if(s.type===S.notebook){const b=a.shift();if(typeof b=="number"){const N=t.getExecution(e.uri);c.ok(N),c.strictEqual(s.notebook.toString(),N.notebook.toString()),c.strictEqual(s.changed?.state,b)}else c.ok(s.changed===void 0);c.ok(s.affectsNotebook(e.uri)),a.length===0&&r.complete()}},this,o);const n=t.createExecution(e.uri);return n.confirm(),n.begin(),n.complete(),r.p})}),test("force-cancel works for Cell Execution",async function(){return x([],async(e,d,o)=>{k=e.notebookDocument;const i=new g;o.add(u.registerKernel(i)),u.selectKernelForNotebook(i,e.notebookDocument);const t=l.get(m),r=o.add(E(e,0,"var c = 3","javascript",p.Code,{},[],!0,!0));t.createCellExecution(e.uri,r.handle);const a=t.getCellExecution(r.uri);c.ok(a),t.forceCancelNotebookExecutions(e.uri);const n=t.getCellExecution(r.uri);c.strictEqual(n,void 0)})}),test("force-cancel works for Notebook Execution",async function(){return x([],async(e,d,o)=>{k=e.notebookDocument;const i=new g;o.add(u.registerKernel(i)),u.selectKernelForNotebook(i,e.notebookDocument);const t=[],r=l.get(m);r.onDidChangeExecution(s=>t.push(s.type===S.notebook&&!!s.changed),this,o),r.createExecution(e.uri);const a=r.getExecution(e.uri);c.ok(a),c.deepStrictEqual(t,[!0]),r.forceCancelNotebookExecutions(e.uri);const n=r.getExecution(e.uri);c.deepStrictEqual(t,[!0,!1]),c.strictEqual(n,void 0)})}),test("force-cancel works for Cell and Notebook Execution",async function(){return x([],async(e,d,o)=>{k=e.notebookDocument;const i=new g;o.add(u.registerKernel(i)),u.selectKernelForNotebook(i,e.notebookDocument);const t=l.get(m);t.createExecution(e.uri),t.createExecution(e.uri);const r=t.getExecution(e.uri),a=t.getExecution(e.uri);c.ok(r),c.ok(a),t.forceCancelNotebookExecutions(e.uri);const n=t.getExecution(e.uri),s=t.getExecution(e.uri);c.strictEqual(n,void 0),c.strictEqual(s,void 0)})})});class g{id="test";label="";viewType="*";onDidChange=C.None;extension=new A("test");localResourceRoot=_.file("/test");description;detail;preloadUris=[];preloadProvides=[];supportedLanguages=[];async executeNotebookCellsRequest(){}async cancelNotebookCellExecution(u,f){}provideVariables(u,f,k,x,h){return R.EMPTY}constructor(u){this.supportedLanguages=u?.languages??[F],u?.id&&(this.id=u?.id)}}
