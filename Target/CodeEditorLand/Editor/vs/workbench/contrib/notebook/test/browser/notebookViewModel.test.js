import a from"assert";import{DisposableStore as R}from"../../../../../base/common/lifecycle.js";import{URI as y}from"../../../../../base/common/uri.js";import{IBulkEditService as D}from"../../../../../editor/browser/services/bulkEditService.js";import{TrackedRangeStickiness as T}from"../../../../../editor/common/model.js";import{IModelService as A}from"../../../../../editor/common/services/model.js";import{ILanguageService as N}from"../../../../../editor/common/languages/language.js";import{ITextModelService as O}from"../../../../../editor/common/services/resolverService.js";import{IConfigurationService as h}from"../../../../../platform/configuration/common/configuration.js";import{TestConfigurationService as V}from"../../../../../platform/configuration/test/common/testConfigurationService.js";import"../../../../../platform/instantiation/test/common/instantiationServiceMock.js";import{IThemeService as L}from"../../../../../platform/theme/common/themeService.js";import{TestThemeService as B}from"../../../../../platform/theme/test/common/testThemeService.js";import{IUndoRedoService as U}from"../../../../../platform/undoRedo/common/undoRedo.js";import{insertCellAtIndex as d,runDeleteAction as g}from"../../browser/controller/cellOperations.js";import{NotebookEventDispatcher as W}from"../../browser/viewModel/eventDispatcher.js";import{NotebookViewModel as G}from"../../browser/viewModel/notebookViewModelImpl.js";import{ViewContext as K}from"../../browser/viewModel/viewContext.js";import{NotebookTextModel as P}from"../../common/model/notebookTextModel.js";import{CellKind as r,diff as z}from"../../common/notebookCommon.js";import{NotebookOptions as F}from"../../browser/notebookOptions.js";import"../../common/notebookRange.js";import{NotebookEditorTestModel as H,setupInstantiationService as J,withTestNotebook as l}from"./testNotebookEditor.js";import{INotebookExecutionStateService as q}from"../../common/notebookExecutionStateService.js";import"../../browser/notebookBrowser.js";import{ensureNoDisposablesAreLeakedInTestSuite as f}from"../../../../../base/test/common/utils.js";import{mainWindow as Q}from"../../../../../base/browser/window.js";import{ICodeEditorService as X}from"../../../../../editor/browser/services/codeEditorService.js";import{ILanguageDetectionService as Y}from"../../../../services/languageDetection/common/languageDetectionWorkerService.js";suite("NotebookViewModel",()=>{f();let o,e,t,s,i,k,b,E,v;suiteSetup(()=>{o=new R,e=J(o),t=e.get(O),s=e.get(D),i=e.get(U),k=e.get(A),b=e.get(N),E=e.get(Y),v=e.get(q),e.stub(h,new V),e.stub(L,new B)}),suiteTeardown(()=>o.dispose()),test("ctor",function(){const p=new P("notebook",y.parse("test"),[],{},{transientCellMetadata:{},transientDocumentMetadata:{},transientOutputs:!1,cellContentMetadata:{}},i,k,b,E),n=new H(p),c=new F(Q,!1,void 0,e.get(h),e.get(q),e.get(X)),C=new W,S=new K(c,C,()=>({})),u=new G("notebook",n.notebook,S,null,{isReadOnly:!1},e,s,i,t,v);a.strictEqual(u.viewType,"notebook"),p.dispose(),n.dispose(),c.dispose(),C.dispose(),u.dispose()}),test("insert/delete",async function(){await l([["var a = 1;","javascript",r.Code,[],{}],["var b = 2;","javascript",r.Code,[],{}]],(p,n)=>{const c=d(n,1,"var c = 3","javascript",r.Code,{},[],!0,!0);a.strictEqual(n.length,3),a.strictEqual(n.notebookDocument.cells.length,3),a.strictEqual(n.getCellIndex(c),1),g(p,n.cellAt(1)),a.strictEqual(n.length,2),a.strictEqual(n.notebookDocument.cells.length,2),a.strictEqual(n.getCellIndex(c),-1),c.dispose(),c.model.dispose()})}),test("index",async function(){await l([["var a = 1;","javascript",r.Code,[],{}],["var b = 2;","javascript",r.Code,[],{}]],(p,n)=>{const c=n.cellAt(0),C=n.cellAt(n.length-1),S=n.getCellIndex(c)+1,u=d(n,S,"var c = 3;","javascript",r.Code,{},[],!0,!0),x=n.getCellIndex(u);g(p,n.cellAt(x));const j=n.getCellIndex(C)+1,I=d(n,j,"var d = 4;","javascript",r.Code,{},[],!0,!0);a.strictEqual(n.length,3),a.strictEqual(n.notebookDocument.cells.length,3),a.strictEqual(n.getCellIndex(I),2),u.dispose(),u.model.dispose(),I.dispose(),I.model.dispose()})})});function m(o,e){if(!e.length)return o;let t=0,s=0;const i=[];for(;t<o.length&&s<e.length;)t<e[s].start&&i.push(...o.slice(t,e[s].start)),t=e[s].end+1,s++;return t<o.length&&i.push(...o.slice(t)),i}suite("NotebookViewModel Decorations",()=>{f(),test("tracking range",async function(){await l([["var a = 1;","javascript",r.Code,[],{}],["var b = 2;","javascript",r.Code,[],{}],["var c = 3;","javascript",r.Code,[],{}],["var d = 4;","javascript",r.Code,[],{}],["var e = 5;","javascript",r.Code,[],{}]],(o,e)=>{const t=e.setTrackedRange("test",{start:1,end:2},T.GrowsOnlyWhenTypingAfter);a.deepStrictEqual(e.getTrackedRange(t),{start:1,end:2});const s=d(e,0,"var d = 6;","javascript",r.Code,{},[],!0,!0);a.deepStrictEqual(e.getTrackedRange(t),{start:2,end:3}),g(o,e.cellAt(0)),a.deepStrictEqual(e.getTrackedRange(t),{start:1,end:2});const i=d(e,3,"var d = 7;","javascript",r.Code,{},[],!0,!0);a.deepStrictEqual(e.getTrackedRange(t),{start:1,end:3}),g(o,e.cellAt(3)),a.deepStrictEqual(e.getTrackedRange(t),{start:1,end:2}),g(o,e.cellAt(1)),a.deepStrictEqual(e.getTrackedRange(t),{start:0,end:1}),s.dispose(),s.model.dispose(),i.dispose(),i.model.dispose()})}),test("tracking range 2",async function(){await l([["var a = 1;","javascript",r.Code,[],{}],["var b = 2;","javascript",r.Code,[],{}],["var c = 3;","javascript",r.Code,[],{}],["var d = 4;","javascript",r.Code,[],{}],["var e = 5;","javascript",r.Code,[],{}],["var e = 6;","javascript",r.Code,[],{}],["var e = 7;","javascript",r.Code,[],{}]],(o,e)=>{const t=e.setTrackedRange("test",{start:1,end:3},T.GrowsOnlyWhenTypingAfter);a.deepStrictEqual(e.getTrackedRange(t),{start:1,end:3}),d(e,5,"var d = 9;","javascript",r.Code,{},[],!0,!0),a.deepStrictEqual(e.getTrackedRange(t),{start:1,end:3}),d(e,4,"var d = 10;","javascript",r.Code,{},[],!0,!0),a.deepStrictEqual(e.getTrackedRange(t),{start:1,end:4})})}),test("diff hidden ranges",async function(){a.deepStrictEqual(m([1,2,3,4,5],[]),[1,2,3,4,5]),a.deepStrictEqual(m([1,2,3,4,5],[{start:1,end:2}]),[1,4,5]),a.deepStrictEqual(m([1,2,3,4,5,6,7,8,9],[{start:1,end:2},{start:4,end:5}]),[1,4,7,8,9]);const o=m([1,2,3,4,5,6,7,8,9],[{start:1,end:2},{start:4,end:5}]),e=m([1,2,3,4,5,6,7,8,9],[{start:2,end:4}]);a.deepStrictEqual(z(o,e,t=>o.indexOf(t)>=0),[{start:1,deleteCount:1,toInsert:[2,6]}])})}),suite("NotebookViewModel API",()=>{f(),test("#115432, get nearest code cell",async function(){await l([["# header a","markdown",r.Markup,[],{}],["var b = 1;","javascript",r.Code,[],{}],["# header b","markdown",r.Markup,[],{}],["b = 2;","python",r.Code,[],{}],["var c = 3","javascript",r.Code,[],{}],["# header d","markdown",r.Markup,[],{}],["var e = 4;","TypeScript",r.Code,[],{}],["# header f","markdown",r.Markup,[],{}]],(o,e)=>{a.strictEqual(e.nearestCodeCellIndex(0),1),a.strictEqual(e.nearestCodeCellIndex(2),1),a.strictEqual(e.nearestCodeCellIndex(4),3),a.strictEqual(e.nearestCodeCellIndex(5),4),a.strictEqual(e.nearestCodeCellIndex(6),4)})}),test("#108464, get nearest code cell",async function(){await l([["# header a","markdown",r.Markup,[],{}],["var b = 1;","javascript",r.Code,[],{}],["# header b","markdown",r.Markup,[],{}]],(o,e)=>{a.strictEqual(e.nearestCodeCellIndex(2),1)})}),test("getCells",async()=>{await l([["# header a","markdown",r.Markup,[],{}],["var b = 1;","javascript",r.Code,[],{}],["# header b","markdown",r.Markup,[],{}]],(o,e)=>{a.strictEqual(e.getCellsInRange().length,3),a.deepStrictEqual(e.getCellsInRange({start:0,end:1}).map(t=>t.getText()),["# header a"]),a.deepStrictEqual(e.getCellsInRange({start:0,end:2}).map(t=>t.getText()),["# header a","var b = 1;"]),a.deepStrictEqual(e.getCellsInRange({start:0,end:3}).map(t=>t.getText()),["# header a","var b = 1;","# header b"]),a.deepStrictEqual(e.getCellsInRange({start:0,end:4}).map(t=>t.getText()),["# header a","var b = 1;","# header b"]),a.deepStrictEqual(e.getCellsInRange({start:1,end:4}).map(t=>t.getText()),["var b = 1;","# header b"]),a.deepStrictEqual(e.getCellsInRange({start:2,end:4}).map(t=>t.getText()),["# header b"]),a.deepStrictEqual(e.getCellsInRange({start:3,end:4}).map(t=>t.getText()),[]),a.deepStrictEqual(e.getCellsInRange({start:-1,end:1}).map(t=>t.getText()),["# header a"]),a.deepStrictEqual(e.getCellsInRange({start:3,end:0}).map(t=>t.getText()),["# header a","var b = 1;","# header b"])})})});
