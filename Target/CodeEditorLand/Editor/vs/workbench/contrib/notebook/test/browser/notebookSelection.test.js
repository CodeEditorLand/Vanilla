import t from"assert";import{ILanguageService as q}from"../../../../../editor/common/languages/language.js";import"../../../../../platform/instantiation/test/common/instantiationServiceMock.js";import{FoldingModel as g,updateFoldingStateAtIndex as l}from"../../browser/viewModel/foldingModel.js";import{runDeleteAction as b}from"../../browser/controller/cellOperations.js";import{NotebookCellSelectionCollection as m}from"../../browser/viewModel/cellSelectionCollection.js";import{CellEditType as S,CellKind as n,SelectionStateType as E}from"../../common/notebookCommon.js";import{createNotebookCellList as u,setupInstantiationService as h,TestCell as f,withTestNotebook as o}from"./testNotebookEditor.js";import{ensureNoDisposablesAreLeakedInTestSuite as k}from"../../../../../base/test/common/utils.js";import{DisposableStore as y}from"../../../../../base/common/lifecycle.js";suite("NotebookSelection",()=>{k(),test("focus is never empty",function(){const i=new m;t.deepStrictEqual(i.focus,{start:0,end:0}),i.setState(null,[],!0,"model"),t.deepStrictEqual(i.focus,{start:0,end:0}),i.dispose()})}),suite("NotebookCellList focus/selection",()=>{let i,c,p;teardown(()=>{i.dispose()}),k(),setup(()=>{i=new y,c=h(i),p=c.get(q)}),test("notebook cell list setFocus",async function(){await o([["var a = 1;","javascript",n.Code,[],{}],["var b = 2;","javascript",n.Code,[],{}]],(d,e,r)=>{const a=u(c,r);a.attachViewModel(e),t.strictEqual(a.length,2),a.setFocus([0]),t.deepStrictEqual(e.getFocus(),{start:0,end:1}),a.setFocus([1]),t.deepStrictEqual(e.getFocus(),{start:1,end:2}),a.detachViewModel()})}),test("notebook cell list setSelections",async function(){await o([["var a = 1;","javascript",n.Code,[],{}],["var b = 2;","javascript",n.Code,[],{}]],(d,e,r)=>{const a=u(c,r);a.attachViewModel(e),t.strictEqual(a.length,2),a.setSelection([0]),t.deepStrictEqual(e.getSelections(),[{start:0,end:1}]),a.setSelection([1]),t.deepStrictEqual(e.getSelections(),[{start:1,end:2}])})}),test("notebook cell list setFocus2",async function(){await o([["var a = 1;","javascript",n.Code,[],{}],["var b = 2;","javascript",n.Code,[],{}]],(d,e,r)=>{const a=u(c,r);a.attachViewModel(e),t.strictEqual(a.length,2),a.setFocus([0]),t.deepStrictEqual(e.getFocus(),{start:0,end:1}),a.setFocus([1]),t.deepStrictEqual(e.getFocus(),{start:1,end:2}),a.setSelection([1]),t.deepStrictEqual(e.getSelections(),[{start:1,end:2}]),a.detachViewModel()})}),test("notebook cell list focus/selection from UI",async function(){await o([["# header a","markdown",n.Markup,[],{}],["var b = 1;","javascript",n.Code,[],{}],["# header b","markdown",n.Markup,[],{}],["var b = 2;","javascript",n.Code,[],{}],["# header c","markdown",n.Markup,[],{}]],(d,e,r)=>{const a=u(c,r);a.attachViewModel(e),t.deepStrictEqual(e.getFocus(),{start:0,end:1}),t.deepStrictEqual(e.getSelections(),[{start:0,end:1}]),a.setFocus([1],new KeyboardEvent("keydown"),void 0),a.setSelection([1],new KeyboardEvent("keydown"),void 0),t.deepStrictEqual(e.getFocus(),{start:1,end:2}),t.deepStrictEqual(e.getSelections(),[{start:1,end:2}]),a.setFocus([2],new KeyboardEvent("keydown"),void 0),a.setSelection([1,2]),t.deepStrictEqual(e.getFocus(),{start:2,end:3}),t.deepStrictEqual(e.getSelections(),[{start:1,end:3}]),a.setFocus([3],new KeyboardEvent("keydown"),void 0),t.deepStrictEqual(e.getFocus(),{start:3,end:4}),t.deepStrictEqual(e.getSelections(),[{start:1,end:3}])})}),test("notebook cell list focus/selection with folding regions",async function(){await o([["# header a","markdown",n.Markup,[],{}],["var b = 1;","javascript",n.Code,[],{}],["# header b","markdown",n.Markup,[],{}],["var b = 2;","javascript",n.Code,[],{}],["# header c","markdown",n.Markup,[],{}]],(d,e,r)=>{const a=r.add(new g);a.attachViewModel(e);const s=u(c,r);s.attachViewModel(e),t.strictEqual(s.length,5),t.deepStrictEqual(e.getFocus(),{start:0,end:1}),t.deepStrictEqual(e.getSelections(),[{start:0,end:1}]),s.setFocus([0]),l(a,0,!0),l(a,2,!0),e.updateFoldingRanges(a.regions),s.setHiddenAreas(e.getHiddenRanges(),!0),t.strictEqual(s.length,3),t.deepStrictEqual(e.getFocus(),{start:0,end:1}),t.deepStrictEqual(e.getSelections(),[{start:0,end:1}]),s.focusNext(1,!1),t.deepStrictEqual(e.getFocus(),{start:2,end:3}),t.deepStrictEqual(e.getSelections(),[{start:0,end:1}]),l(a,2,!1),e.updateFoldingRanges(a.regions),s.setHiddenAreas(e.getHiddenRanges(),!0),t.strictEqual(s.length,4),t.deepStrictEqual(e.getFocus(),{start:2,end:3})})}),test("notebook cell list focus/selection with folding regions and applyEdits",async function(){await o([["# header a","markdown",n.Markup,[],{}],["var b = 1;","javascript",n.Code,[],{}],["# header b","markdown",n.Markup,[],{}],["var b = 2;","javascript",n.Code,[],{}],["var c = 3","javascript",n.Markup,[],{}],["# header d","markdown",n.Markup,[],{}],["var e = 4;","javascript",n.Code,[],{}]],(d,e,r)=>{const a=r.add(new g);a.attachViewModel(e);const s=u(c,r);s.attachViewModel(e),s.setFocus([0]),s.setSelection([0]),l(a,0,!0),l(a,2,!0),e.updateFoldingRanges(a.regions),s.setHiddenAreas(e.getHiddenRanges(),!0),t.strictEqual(s.getModelIndex2(0),0),t.strictEqual(s.getModelIndex2(1),2),d.textModel.applyEdits([{editType:S.Replace,index:0,count:2,cells:[]}],!0,void 0,()=>{},void 0,!1),e.updateFoldingRanges(a.regions),s.setHiddenAreas(e.getHiddenRanges(),!0),t.strictEqual(s.getModelIndex2(0),0),t.strictEqual(s.getModelIndex2(1),3),d.textModel.applyEdits([{editType:S.Replace,index:0,count:0,cells:[r.add(new f(e.viewType,7,"# header f","markdown",n.Code,[],p)),r.add(new f(e.viewType,8,"var g = 5;","javascript",n.Code,[],p))]}],!0,void 0,()=>{},void 0,!1),e.updateFoldingRanges(a.regions),s.setHiddenAreas(e.getHiddenRanges(),!0),t.strictEqual(s.getModelIndex2(0),0),t.strictEqual(s.getModelIndex2(1),1),t.strictEqual(s.getModelIndex2(2),2)})}),test("notebook cell list getModelIndex",async function(){await o([["# header a","markdown",n.Markup,[],{}],["var b = 1;","javascript",n.Code,[],{}],["# header b","markdown",n.Markup,[],{}],["var b = 2;","javascript",n.Code,[],{}],["# header c","markdown",n.Markup,[],{}]],(d,e,r)=>{const a=r.add(new g);a.attachViewModel(e);const s=u(c,r);s.attachViewModel(e),l(a,0,!0),l(a,2,!0),e.updateFoldingRanges(a.regions),s.setHiddenAreas(e.getHiddenRanges(),!0),t.deepStrictEqual(s.getModelIndex2(-1),0),t.deepStrictEqual(s.getModelIndex2(0),0),t.deepStrictEqual(s.getModelIndex2(1),2),t.deepStrictEqual(s.getModelIndex2(2),4)})}),test("notebook validate range",async()=>{await o([["# header a","markdown",n.Markup,[],{}],["var b = 1;","javascript",n.Code,[],{}]],(d,e)=>{t.deepStrictEqual(e.validateRange(null),null),t.deepStrictEqual(e.validateRange(void 0),null),t.deepStrictEqual(e.validateRange({start:0,end:0}),{start:0,end:0}),t.deepStrictEqual(e.validateRange({start:0,end:2}),{start:0,end:2}),t.deepStrictEqual(e.validateRange({start:0,end:3}),{start:0,end:2}),t.deepStrictEqual(e.validateRange({start:-1,end:3}),{start:0,end:2}),t.deepStrictEqual(e.validateRange({start:-1,end:1}),{start:0,end:1}),t.deepStrictEqual(e.validateRange({start:2,end:1}),{start:1,end:2}),t.deepStrictEqual(e.validateRange({start:2,end:-1}),{start:0,end:2})})}),test("notebook updateSelectionState",async function(){await o([["# header a","markdown",n.Markup,[],{}],["var b = 1;","javascript",n.Code,[],{}]],(d,e)=>{e.updateSelectionsState({kind:E.Index,focus:{start:1,end:2},selections:[{start:1,end:2},{start:-1,end:0}]}),t.deepStrictEqual(e.getSelections(),[{start:1,end:2}])})}),test("notebook cell selection w/ cell deletion",async function(){await o([["# header a","markdown",n.Markup,[],{}],["var b = 1;","javascript",n.Code,[],{}]],(d,e)=>{e.updateSelectionsState({kind:E.Index,focus:{start:1,end:2},selections:[{start:1,end:2}]}),b(d,e.cellAt(1)),t.deepStrictEqual(e.getFocus(),{start:0,end:1}),t.deepStrictEqual(e.getSelections(),[{start:0,end:1}])})}),test("notebook cell selection w/ cell deletion from applyEdits",async function(){await o([["# header a","markdown",n.Markup,[],{}],["var b = 1;","javascript",n.Code,[],{}],["var c = 2;","javascript",n.Code,[],{}]],async(d,e)=>{e.updateSelectionsState({kind:E.Index,focus:{start:1,end:2},selections:[{start:1,end:2}]}),d.textModel.applyEdits([{editType:S.Replace,index:1,count:1,cells:[]}],!0,void 0,()=>{},void 0,!0),t.deepStrictEqual(e.getFocus(),{start:1,end:2}),t.deepStrictEqual(e.getSelections(),[{start:1,end:2}])})})});
