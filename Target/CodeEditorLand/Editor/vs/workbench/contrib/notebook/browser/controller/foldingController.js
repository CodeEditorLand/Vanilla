import{Disposable as A,DisposableStore as O}from"../../../../../base/common/lifecycle.js";import{NOTEBOOK_EDITOR_FOCUSED as m,NOTEBOOK_IS_ACTIVE_EDITOR as C}from"../../common/notebookContextKeys.js";import{getNotebookEditorFromEditorPane as h,CellFoldingState as l}from"../notebookBrowser.js";import{FoldingModel as y}from"../viewModel/foldingModel.js";import{CellKind as b}from"../../common/notebookCommon.js";import{registerNotebookContribution as R}from"../notebookEditorExtensions.js";import{registerAction2 as _,Action2 as E}from"../../../../../platform/actions/common/actions.js";import{ContextKeyExpr as p}from"../../../../../platform/contextkey/common/contextkey.js";import{InputFocusedContextKey as M}from"../../../../../platform/contextkey/common/contextkeys.js";import{KeyCode as a,KeyMod as c}from"../../../../../base/common/keyCodes.js";import{KeybindingWeight as k}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import{IEditorService as w}from"../../../../services/editor/common/editorService.js";import{NOTEBOOK_ACTIONS_CATEGORY as F}from"./coreActions.js";import{localize as N,localize2 as S}from"../../../../../nls.js";class f extends A{constructor(t){super();this._notebookEditor=t;this._register(this._notebookEditor.onMouseUp(e=>{this.onMouseUp(e)})),this._register(this._notebookEditor.onDidChangeModel(()=>{this._localStore.clear(),this._notebookEditor.hasModel()&&(this._localStore.add(this._notebookEditor.onDidChangeCellState(e=>{e.source.editStateChanged&&e.cell.cellKind===b.Markup&&this._foldingModel?.recompute()})),this._foldingModel=new y,this._localStore.add(this._foldingModel),this._foldingModel.attachViewModel(this._notebookEditor.getViewModel()),this._localStore.add(this._foldingModel.onDidFoldingRegionChanged(()=>{this._updateEditorFoldingRanges()})))}))}static id="workbench.notebook.foldingController";_foldingModel=null;_localStore=this._register(new O);saveViewState(){return this._foldingModel?.getMemento()||[]}restoreViewState(t){this._foldingModel?.applyMemento(t||[]),this._updateEditorFoldingRanges()}setFoldingStateDown(t,e,n){const s=e===l.Collapsed,o=this._foldingModel.getRegionAtLine(t+1),d=[];if(o&&(o.isCollapsed!==s&&d.push(o),n>1)){const r=this._foldingModel.getRegionsInside(o,(u,I)=>u.isCollapsed!==s&&I<n);d.push(...r)}d.forEach(r=>this._foldingModel.setCollapsed(r.regionIndex,e===l.Collapsed)),this._updateEditorFoldingRanges()}setFoldingStateUp(t,e,n){if(!this._foldingModel)return;this._foldingModel.getAllRegionsAtLine(t+1,(o,d)=>o.isCollapsed!==(e===l.Collapsed)&&d<=n).forEach(o=>this._foldingModel.setCollapsed(o.regionIndex,e===l.Collapsed)),this._updateEditorFoldingRanges()}_updateEditorFoldingRanges(){if(!this._foldingModel||!this._notebookEditor.hasModel())return;const t=this._notebookEditor.getViewModel();t.updateFoldingRanges(this._foldingModel.regions);const e=t.getHiddenRanges();this._notebookEditor.setHiddenAreas(e)}onMouseUp(t){if(!t.event.target||!this._notebookEditor.hasModel())return;const e=this._notebookEditor.getViewModel(),n=t.event.target;if(n.classList.contains("codicon-notebook-collapsed")||n.classList.contains("codicon-notebook-expanded")){if(!n.parentElement.classList.contains("notebook-folding-indicator"))return;const o=t.target,d=e.getCellIndex(o),r=e.getFoldingState(d);if(r===l.None)return;this.setFoldingStateUp(d,r===l.Collapsed?l.Expanded:l.Collapsed,1),this._notebookEditor.focusElement(o)}}}R(f.id,f);const L=N("fold.cell","Fold Cell"),v=S("unfold.cell","Unfold Cell"),x={args:[{isOptional:!0,name:"index",description:"The cell index",schema:{type:"object",required:["index","direction"],properties:{index:{type:"number"},direction:{type:"string",enum:["up","down"],default:"down"},levels:{type:"number",default:1}}}}]};_(class extends E{constructor(){super({id:"notebook.fold",title:S("fold.cell","Fold Cell"),category:F,keybinding:{when:p.and(m,p.not(M)),primary:c.CtrlCmd|c.Shift|a.BracketLeft,mac:{primary:c.CtrlCmd|c.Alt|a.BracketLeft,secondary:[a.LeftArrow]},secondary:[a.LeftArrow],weight:k.WorkbenchContrib},metadata:{description:L,args:x.args},precondition:C,f1:!0})}async run(g,i){const t=g.get(w),e=h(t.activeEditorPane);if(!e||!e.hasModel())return;const n=i&&i.levels||1,s=i&&i.direction==="up"?"up":"down";let o;if(i)o=i.index;else{const r=e.getActiveCell();if(!r)return;o=e.getCellIndex(r)}const d=e.getContribution(f.id);if(o!==void 0){if((o<0||o>=e.getLength()?void 0:e.cellAt(o))?.cellKind===b.Code&&s==="down")return;s==="up"?d.setFoldingStateUp(o,l.Collapsed,n):d.setFoldingStateDown(o,l.Collapsed,n);const u=e.getViewModel().getNearestVisibleCellIndexUpwards(o);e.focusElement(e.cellAt(u))}}}),_(class extends E{constructor(){super({id:"notebook.unfold",title:v,category:F,keybinding:{when:p.and(m,p.not(M)),primary:c.CtrlCmd|c.Shift|a.BracketRight,mac:{primary:c.CtrlCmd|c.Alt|a.BracketRight,secondary:[a.RightArrow]},secondary:[a.RightArrow],weight:k.WorkbenchContrib},metadata:{description:v,args:x.args},precondition:C,f1:!0})}async run(g,i){const t=g.get(w),e=h(t.activeEditorPane);if(!e)return;const n=i&&i.levels||1,s=i&&i.direction==="up"?"up":"down";let o;if(i)o=i.index;else{const r=e.getActiveCell();if(!r)return;o=e.getCellIndex(r)}const d=e.getContribution(f.id);o!==void 0&&(s==="up"?d.setFoldingStateUp(o,l.Expanded,n):d.setFoldingStateDown(o,l.Expanded,n))}});export{f as FoldingController};
