var w=Object.defineProperty;var g=Object.getOwnPropertyDescriptor;var v=(a,l,e,o)=>{for(var t=o>1?void 0:o?g(l,e):l,i=a.length-1,r;i>=0;i--)(r=a[i])&&(t=(o?r(l,e,t):r(t))||t);return o&&t&&w(l,e,t),t},u=(a,l)=>(e,o)=>l(e,o,a);import*as d from"../../../../../base/browser/dom.js";import{createFastDomNode as c}from"../../../../../base/browser/fastDomNode.js";import{PixelRatio as f}from"../../../../../base/browser/pixelRatio.js";import{Color as C}from"../../../../../base/common/color.js";import{DisposableStore as E}from"../../../../../base/common/lifecycle.js";import{defaultInsertColor as b,defaultRemoveColor as y,diffInserted as D,diffOverviewRulerInserted as N,diffOverviewRulerRemoved as S,diffRemoved as H}from"../../../../../platform/theme/common/colorRegistry.js";import{IThemeService as I,Themable as V}from"../../../../../platform/theme/common/themeService.js";const M=20;let _=class extends V{constructor(e,o,t,i){super(i);this.notebookEditor=e;this.width=o;this._insertColor=null,this._removeColor=null,this._insertColorHex=null,this._removeColorHex=null,this._disposables=this._register(new E),this._renderAnimationFrame=null,this._domNode=c(document.createElement("canvas")),this._domNode.setPosition("relative"),this._domNode.setLayerHinting(!0),this._domNode.setContain("strict"),t.appendChild(this._domNode.domNode),this._overviewViewportDomElement=c(document.createElement("div")),this._overviewViewportDomElement.setClassName("diffViewport"),this._overviewViewportDomElement.setPosition("absolute"),this._overviewViewportDomElement.setWidth(o),t.appendChild(this._overviewViewportDomElement.domNode),this._register(f.getInstance(d.getWindow(this._domNode.domNode)).onDidChange(()=>{this._scheduleRender()})),this._register(this.themeService.onDidColorThemeChange(r=>{this.applyColors(r)&&this._scheduleRender()})),this.applyColors(this.themeService.getColorTheme()),this._register(this.notebookEditor.onDidScroll(()=>{this._renderOverviewViewport()})),this._register(d.addStandardDisposableListener(t,d.EventType.POINTER_DOWN,r=>{this.notebookEditor.delegateVerticalScrollbarPointerDown(r)}))}_domNode;_overviewViewportDomElement;_diffElementViewModels=[];_lanes=2;_insertColor;_insertColorHex;_removeColor;_removeColorHex;_disposables;_renderAnimationFrame;applyColors(e){const o=e.getColor(N)||(e.getColor(D)||b).transparent(2),t=e.getColor(S)||(e.getColor(H)||y).transparent(2),i=!o.equals(this._insertColor)||!t.equals(this._removeColor);return this._insertColor=o,this._removeColor=t,this._insertColor&&(this._insertColorHex=C.Format.CSS.formatHexA(this._insertColor)),this._removeColor&&(this._removeColorHex=C.Format.CSS.formatHexA(this._removeColor)),i}layout(){this._layoutNow()}updateViewModels(e,o){this._disposables.clear(),this._diffElementViewModels=e,o&&(this._disposables.add(o.onDidChangeLayout(()=>{this._scheduleRender()})),this._disposables.add(o.onDidChangeCellLayout(()=>{this._scheduleRender()}))),this._scheduleRender()}_scheduleRender(){this._renderAnimationFrame===null&&(this._renderAnimationFrame=d.runAtThisOrScheduleAtNextAnimationFrame(d.getWindow(this._domNode.domNode),this._onRenderScheduled.bind(this),16))}_onRenderScheduled(){this._renderAnimationFrame=null,this._layoutNow()}_layoutNow(){const o=this.notebookEditor.getLayoutInfo().height,t=this._diffElementViewModels.map(s=>s.totalHeight).reduce((s,n)=>s+n,0),i=f.getInstance(d.getWindow(this._domNode.domNode)).value;this._domNode.setWidth(this.width),this._domNode.setHeight(o),this._domNode.domNode.width=this.width*i,this._domNode.domNode.height=o*i;const r=this._domNode.domNode.getContext("2d");r.clearRect(0,0,this.width*i,o*i),this._renderCanvas(r,this.width*i,o*i,t*i,i),this._renderOverviewViewport()}_renderOverviewViewport(){const e=this._computeOverviewViewport();e?(this._overviewViewportDomElement.setTop(e.top),this._overviewViewportDomElement.setHeight(e.height)):(this._overviewViewportDomElement.setTop(0),this._overviewViewportDomElement.setHeight(0))}_computeOverviewViewport(){const e=this.notebookEditor.getLayoutInfo();if(!e)return null;const o=this.notebookEditor.getScrollTop(),t=this.notebookEditor.getScrollHeight(),i=Math.max(0,e.height),r=Math.max(0,i-2*0),s=e.height,n=Math.round(Math.max(M,Math.floor(s*r/t))),h=(r-n)/(t-s),p=Math.round(o*h);return{height:n,top:p}}_renderCanvas(e,o,t,i,r){if(!this._insertColorHex||!this._removeColorHex)return;const s=o/this._lanes;let n=0;for(let h=0;h<this._diffElementViewModels.length;h++){const p=this._diffElementViewModels[h],m=Math.round(p.totalHeight/i*r*t);switch(p.type){case"insert":e.fillStyle=this._insertColorHex,e.fillRect(s,n,s,m);break;case"delete":e.fillStyle=this._removeColorHex,e.fillRect(0,n,s,m);break;case"unchanged":break;case"modified":e.fillStyle=this._removeColorHex,e.fillRect(0,n,s,m),e.fillStyle=this._insertColorHex,e.fillRect(s,n,s,m);break}n+=m}}dispose(){this._renderAnimationFrame!==null&&(this._renderAnimationFrame.dispose(),this._renderAnimationFrame=null),super.dispose()}};_=v([u(3,I)],_);export{_ as NotebookDiffOverviewRuler};
