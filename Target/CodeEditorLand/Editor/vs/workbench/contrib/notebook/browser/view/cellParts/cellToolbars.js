var A=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var m=(s,l,e,t)=>{for(var o=t>1?void 0:t?M(l,e):l,i=s.length-1,r;i>=0;i--)(r=s[i])&&(o=(t?r(l,e,o):r(o))||o);return t&&o&&A(l,e,o),o},c=(s,l)=>(e,t)=>l(e,t,s);import*as T from"../../../../../../base/browser/dom.js";import{createInstantHoverDelegate as w}from"../../../../../../base/browser/ui/hover/hoverDelegateFactory.js";import{ToolBar as b}from"../../../../../../base/browser/ui/toolbar/toolbar.js";import{disposableTimeout as S}from"../../../../../../base/common/async.js";import{Emitter as D}from"../../../../../../base/common/event.js";import{MarshalledId as g}from"../../../../../../base/common/marshallingIds.js";import{MenuEntryActionViewItem as x,createActionViewItem as I,createAndFillInActionBarActions as E}from"../../../../../../platform/actions/browser/menuEntryActionViewItem.js";import{WorkbenchToolBar as k}from"../../../../../../platform/actions/browser/toolbar.js";import{IMenuService as y,MenuItemAction as V}from"../../../../../../platform/actions/common/actions.js";import{IContextKeyService as C}from"../../../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as f}from"../../../../../../platform/contextview/browser/contextView.js";import{IInstantiationService as u}from"../../../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as N}from"../../../../../../platform/keybinding/common/keybinding.js";import{CellOverlayPart as _}from"../cellPart.js";import{CodiconActionViewItem as K}from"./cellActionView.js";import{registerCellToolbarStickyScroll as O}from"./cellToolbarStickyScroll.js";let h=class extends _{constructor(e,t,o,i,r,n,a){super();this._notebookEditor=e;this._bottomCellToolbarContainer=o;this.instantiationService=i;this.contextMenuService=r;this.contextKeyService=n;this.menuService=a}_betweenCellToolbar;_initialize(){if(this._betweenCellToolbar)return this._betweenCellToolbar;const e=this._register(new b(this._bottomCellToolbarContainer,this.contextMenuService,{actionViewItemProvider:(i,r)=>{if(i instanceof V)return this._notebookEditor.notebookOptions.getDisplayOptions().insertToolbarAlignment==="center"?this.instantiationService.createInstance(K,i,{hoverDelegate:r.hoverDelegate}):this.instantiationService.createInstance(x,i,{hoverDelegate:r.hoverDelegate})}}));this._betweenCellToolbar=e;const t=this._register(this.menuService.createMenu(this._notebookEditor.creationOptions.menuIds.cellInsertToolbar,this.contextKeyService)),o=()=>{const i=d(t);e.setActions(i.primary,i.secondary)};return this._register(t.onDidChange(()=>o())),this._register(this._notebookEditor.notebookOptions.onDidChangeOptions(i=>{i.insertToolbarAlignment&&o()})),o(),e}didRenderCell(e){const t=this._initialize();this._notebookEditor.hasModel()&&(t.context={ui:!0,cell:e,notebookEditor:this._notebookEditor,source:"insertToolbar",$mid:g.NotebookCellActionContext}),this.updateInternalLayoutNow(e)}updateInternalLayoutNow(e){const t=e.layoutInfo.bottomToolbarOffset;this._bottomCellToolbarContainer.style.transform=`translateY(${t}px)`}};h=m([c(3,u),c(4,f),c(5,C),c(6,y)],h);let p=class extends _{constructor(e,t,o,i,r,n,a,v){super();this.toolbarContainer=e;this._rootClassDelegate=t;this.toolbarId=o;this.deleteToolbarId=i;this._notebookEditor=r;this.contextKeyService=n;this.menuService=a;this.instantiationService=v}_model;_view;_onDidUpdateActions=this._register(new D);onDidUpdateActions=this._onDidUpdateActions.event;get hasActions(){return this._model?this._model.actions.primary.length+this._model.actions.secondary.length+this._model.deleteActions.primary.length+this._model.deleteActions.secondary.length>0:!1}_initializeModel(){if(this._model)return this._model;const e=this._register(this.menuService.createMenu(this.toolbarId,this.contextKeyService)),t=this._register(this.menuService.createMenu(this.deleteToolbarId,this.contextKeyService)),o=d(e),i=d(t);return this._model={titleMenu:e,actions:o,deleteMenu:t,deleteActions:i},this._model}_initialize(e,t){if(this._view)return this._view;const o=this._register(w()),i=this._register(this.instantiationService.createInstance(k,this.toolbarContainer,{actionViewItemProvider:(n,a)=>I(this.instantiationService,n,a),renderDropdownAsChildElement:!0,hoverDelegate:o})),r=this._register(this.instantiationService.invokeFunction(n=>L(n,this.toolbarContainer,o,"cell-delete-toolbar")));return(e.deleteActions.primary.length!==0||e.deleteActions.secondary.length!==0)&&r.setActions(e.deleteActions.primary,e.deleteActions.secondary),this.setupChangeListeners(i,e.titleMenu,e.actions),this.setupChangeListeners(r,e.deleteMenu,e.deleteActions),this._view={toolbar:i,deleteToolbar:r},this._view}prepareRenderCell(e){this._initializeModel()}didRenderCell(e){const t=this._initializeModel(),o=this._initialize(t,e);if(this.cellDisposables.add(O(this._notebookEditor,e,this.toolbarContainer,{extraOffset:4,min:-14})),this._notebookEditor.hasModel()){const i={ui:!0,cell:e,notebookEditor:this._notebookEditor,source:"cellToolbar",$mid:g.NotebookCellActionContext};this.updateContext(o,i)}}updateContext(e,t){e.toolbar.context=t,e.deleteToolbar.context=t}setupChangeListeners(e,t,o){let i=!1,r;this.updateActions(e,o),this._register(t.onDidChange(()=>{if(i){const a=d(t);r=()=>this.updateActions(e,a);return}const n=d(t);this.updateActions(e,n)})),this._rootClassDelegate.toggle("cell-toolbar-dropdown-active",!1),this._register(e.onDidChangeDropdownVisibility(n=>{i=n,this._rootClassDelegate.toggle("cell-toolbar-dropdown-active",n),r&&!n&&(S(()=>{r?.()},0,this._store),r=void 0)}))}updateActions(e,t){const o=T.isAncestorOfActiveElement(e.getElement());e.setActions(t.primary,t.secondary),o&&this._notebookEditor.focus(),t.primary.length||t.secondary.length?(this._rootClassDelegate.toggle("cell-has-toolbar-actions",!0),this._onDidUpdateActions.fire()):(this._rootClassDelegate.toggle("cell-has-toolbar-actions",!1),this._onDidUpdateActions.fire())}};p=m([c(5,C),c(6,y),c(7,u)],p);function d(s){const t={primary:[],secondary:[]};return E(s,{shouldForwardArgs:!0},t,o=>/^inline/.test(o)),t}function L(s,l,e,t){const o=s.get(f),i=s.get(N),r=s.get(u),n=new b(l,o,{getKeyBinding:a=>i.lookupKeybinding(a.id),actionViewItemProvider:(a,v)=>I(r,a,v),renderDropdownAsChildElement:!0,hoverDelegate:e});return t&&n.getElement().classList.add(t),n}export{h as BetweenCellToolbar,p as CellTitleToolbarPart};
