var c=Object.defineProperty;var g=Object.getOwnPropertyDescriptor;var m=(s,r,e,t)=>{for(var o=t>1?void 0:t?g(r,e):r,i=s.length-1,n;i>=0;i--)(n=s[i])&&(o=(t?n(r,e,o):n(o))||o);return t&&o&&c(r,e,o),o},a=(s,r)=>(e,t)=>r(e,t,s);import{coalesce as p}from"../../../../../../base/common/arrays.js";import{DisposableMap as f,DisposableStore as u}from"../../../../../../base/common/lifecycle.js";import{EDITOR_FONT_DEFAULTS as v}from"../../../../../../editor/common/config/editorOptions.js";import"../../../../../../editor/common/languages.js";import{IConfigurationService as I}from"../../../../../../platform/configuration/common/configuration.js";import{IContextKeyService as y}from"../../../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as T}from"../../../../../../platform/instantiation/common/instantiation.js";import{IThemeService as C}from"../../../../../../platform/theme/common/themeService.js";import{ICommentService as _}from"../../../../comments/browser/commentService.js";import{CommentThreadWidget as w}from"../../../../comments/browser/commentThreadWidget.js";import"../../notebookBrowser.js";import{CellContentPart as S}from"../cellPart.js";import"../../../common/notebookRange.js";let h=class extends S{constructor(e,t,o,i,n,d,l){super();this.notebookEditor=e;this.container=t;this.contextKeyService=o;this.themeService=i;this.commentService=n;this.configurationService=d;this.instantiationService=l;this.container.classList.add("review-widget"),this._register(this._commentThreadWidgets=new f),this._register(this.themeService.onDidColorThemeChange(this._applyTheme,this)),this._applyTheme()}_commentThreadWidgets;currentElement;async initialize(e){this.currentElement!==e&&(this.currentElement=e,await this._updateThread())}async _createCommentTheadWidget(e,t){const o=new u,i=this.instantiationService.createInstance(w,this.container,this.notebookEditor,e,this.notebookEditor.textModel.uri,this.contextKeyService,this.instantiationService,t,void 0,void 0,{codeBlockFontFamily:this.configurationService.getValue("editor").fontFamily||v.fontFamily},void 0,{actionRunner:()=>{},collapse:()=>{}});o.add(i),this._commentThreadWidgets.set(t.threadId,{widget:i,dispose:()=>o.dispose()});const n=this.notebookEditor.getLayoutInfo();await i.display(n.fontInfo.lineHeight,!0),this._applyTheme(),o.add(i.onDidResize(()=>{this.currentElement&&(this.currentElement.commentHeight=this._calculateCommentThreadHeight(i.getDimensions().height))}))}_bindListeners(){this.cellDisposables.add(this.commentService.onDidUpdateCommentThreads(async()=>this._updateThread()))}async _updateThread(){if(!this.currentElement)return;const e=await this._getCommentThreadsForCell(this.currentElement),t=new Set(this._commentThreadWidgets.keys()),o=this.currentElement.layoutInfo;this.container.style.top=`${o.commentOffset}px`;for(const i of e)if(i)for(const n of i.threads){t.delete(n.threadId);const d=this._commentThreadWidgets.get(n.threadId)?.widget;d?await d.updateCommentThread(n):await this._createCommentTheadWidget(i.uniqueOwner,n)}for(const i of t)this._commentThreadWidgets.deleteAndDispose(i);this._updateHeight()}_calculateCommentThreadHeight(e){const t=this.notebookEditor.getLayoutInfo(),o=Math.ceil(t.fontInfo.lineHeight*1.2),i=t.fontInfo.lineHeight,n=Math.round(i/3),d=Math.round(i/9)*2;return o+e+n+d+8}_updateHeight(){if(!this.currentElement)return;let e=0;for(const{widget:t}of this._commentThreadWidgets.values())e+=this._calculateCommentThreadHeight(t.getDimensions().height);this.currentElement.commentHeight=e}async _getCommentThreadsForCell(e){return this.notebookEditor.hasModel()?p(await this.commentService.getNotebookComments(e.uri)):[]}_applyTheme(){const e=this.themeService.getColorTheme(),t=this.notebookEditor.getLayoutInfo().fontInfo;for(const{widget:o}of this._commentThreadWidgets.values())o.applyTheme(e,t)}didRenderCell(e){this.initialize(e),this._bindListeners()}prepareLayout(){this._updateHeight()}updateInternalLayoutNow(e){this.currentElement&&(this.container.style.top=`${e.layoutInfo.commentOffset}px`)}};h=m([a(2,y),a(3,C),a(4,_),a(5,I),a(6,T)],h);export{h as CellComments};
