var C=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var I=(c,p,e,t)=>{for(var i=t>1?void 0:t?k(p,e):p,r=c.length-1,o;r>=0;r--)(o=c[r])&&(i=(t?o(p,e,i):o(i))||i);return t&&i&&C(p,e,i),i},_=(c,p)=>(e,t)=>p(e,t,c);import*as u from"../../../../../base/browser/dom.js";import*as f from"../../../../../nls.js";import{Disposable as w,DisposableStore as E}from"../../../../../base/common/lifecycle.js";import{SideBySideDiffElementViewModel as g}from"./diffElementViewModel.js";import{DiffSide as b}from"./notebookDiffEditorBrowser.js";import{RenderOutputType as M}from"../notebookBrowser.js";import{INotebookService as T}from"../../common/notebookService.js";import{ThemeIcon as V}from"../../../../../base/common/themables.js";import{mimetypeIcon as O}from"../notebookIcons.js";import{StandardKeyboardEvent as x}from"../../../../../base/browser/keyboardEvent.js";import{KeyCode as y}from"../../../../../base/common/keyCodes.js";import{IQuickInputService as S}from"../../../../../platform/quickinput/common/quickInput.js";class N extends w{constructor(e,t,i,r,o,l,d,a,n){super();this._notebookEditor=e;this._notebookTextModel=t;this._notebookService=i;this._quickInputService=r;this._diffElementViewModel=o;this._diffSide=l;this._nestedCell=d;this._outputContainer=a;this.output=n}resizeListener=this._register(new E);domNode;renderResult;render(e,t){const i=document.createElement("div");let r;const[o,l]=this.output.resolveMimeTypes(this._notebookTextModel,void 0),d=this.output.pickedMimeType||o[l];if(o.length>1){i.style.position="relative";const n=u.$(".multi-mimetype-output");n.classList.add(...V.asClassNameArray(O)),n.tabIndex=0,n.title=f.localize("mimeTypePicker","Choose a different output mimetype, available mimetypes: {0}",o.map(s=>s.mimeType).join(", ")),i.appendChild(n),this.resizeListener.add(u.addStandardDisposableListener(n,"mousedown",async s=>{s.leftButton&&(s.preventDefault(),s.stopPropagation(),await this.pickActiveMimeTypeRenderer(this._notebookTextModel,this.output))})),this.resizeListener.add(u.addDisposableListener(n,u.EventType.KEY_DOWN,async s=>{const m=new x(s);(m.equals(y.Enter)||m.equals(y.Space))&&(s.preventDefault(),s.stopPropagation(),await this.pickActiveMimeTypeRenderer(this._notebookTextModel,this.output))}))}const a=u.$(".output-inner-container");if(u.append(i,a),o.length!==0){const n=this._notebookService.getRendererInfo(d.rendererId);r=n?{type:M.Extension,renderer:n,source:this.output,mimeType:d.mimeType}:this._renderMissingRenderer(this.output,d.mimeType),this.output.pickedMimeType=d}this.domNode=i,this.renderResult=r,r&&(t?this._outputContainer.insertBefore(i,t):this._outputContainer.appendChild(i),this._notebookEditor.createOutput(this._diffElementViewModel,this._nestedCell,r,()=>this.getOutputOffsetInCell(e),this._diffElementViewModel instanceof g?this._diffSide:this._diffElementViewModel.type==="insert"?b.Modified:b.Original))}_renderMissingRenderer(e,t){if(!e.model.outputs.length)return this._renderMessage(e,f.localize("empty","Cell has no output"));if(!t){const r=e.model.outputs.map(o=>o.mime).join(", ");return this._renderMessage(e,f.localize("noRenderer.2","No renderer could be found for output. It has the following mimetypes: {0}",r))}return this._renderSearchForMimetype(e,t)}_renderSearchForMimetype(e,t){const i=`@tag:notebookRenderer ${t}`,r=u.$("p",void 0,`No renderer could be found for mimetype "${t}", but one might be available on the Marketplace.`),o=u.$("a",{href:`command:workbench.extensions.search?%22${i}%22`,class:"monaco-button monaco-text-button",tabindex:0,role:"button",style:"padding: 8px; text-decoration: none; color: rgb(255, 255, 255); background-color: rgb(14, 99, 156); max-width: 200px;"},"Search Marketplace");return{type:M.Html,source:e,htmlContent:r.outerHTML+o.outerHTML}}_renderMessage(e,t){const i=u.$("p",void 0,t);return{type:M.Html,source:e,htmlContent:i.outerHTML}}async pickActiveMimeTypeRenderer(e,t){const[i,r]=t.resolveMimeTypes(e,void 0),o=i.filter(n=>n.isTrusted).map((n,s)=>({label:n.mimeType,id:n.mimeType,index:s,picked:s===r,detail:this.generateRendererInfo(n.rendererId),description:s===r?f.localize("curruentActiveMimeType","Currently Active"):void 0})),l=new E,d=l.add(this._quickInputService.createQuickPick());d.items=o,d.activeItems=o.filter(n=>!!n.picked),d.placeholder=o.length!==i.length?f.localize("promptChooseMimeTypeInSecure.placeHolder","Select mimetype to render for current output. Rich mimetypes are available only when the notebook is trusted"):f.localize("promptChooseMimeType.placeHolder","Select mimetype to render for current output");const a=await new Promise(n=>{l.add(d.onDidAccept(()=>{n(d.selectedItems.length===1?d.selectedItems[0].index:void 0),l.dispose()})),d.show()});if(a!==void 0&&a!==r){const n=this._nestedCell.outputsViewModels.indexOf(t),s=this.domNode.nextElementSibling;this.resizeListener.clear();const m=this.domNode;m&&(m.remove(),this._notebookEditor.removeInset(this._diffElementViewModel,this._nestedCell,t,this._diffSide)),t.pickedMimeType=i[a],this.render(n,s)}}generateRendererInfo(e){const t=this._notebookService.getRendererInfo(e);return t?`${t.displayName!==""?t.displayName:t.id} (${t.extensionId.value})`:f.localize("builtinRenderInfo","built-in")}getCellOutputCurrentIndex(){return this._diffElementViewModel.getNestedCellViewModel(this._diffSide).outputs.indexOf(this.output.model)}updateHeight(e,t){this._diffElementViewModel.updateOutputHeight(this._diffSide,e,t)}getOutputOffsetInContainer(e){return this._diffElementViewModel.getOutputOffsetInContainer(this._diffSide,e)}getOutputOffsetInCell(e){return this._diffElementViewModel.getOutputOffsetInCell(this._diffSide,e)}}let h=class extends w{constructor(e,t,i,r,o,l,d,a){super();this._editor=e;this._notebookTextModel=t;this._diffElementViewModel=i;this._nestedCellViewModel=r;this._diffSide=o;this._outputContainer=l;this._notebookService=d;this._quickInputService=a;this._register(this._diffElementViewModel.onDidLayoutChange(()=>{this._outputEntries.forEach((n,s)=>{const m=r.outputs.indexOf(s.model);if(m>=0){const v=this._diffElementViewModel.getOutputOffsetInContainer(this._diffSide,m);n.domNode.style.top=`${v}px`}})})),this._register(this._nestedCellViewModel.textModel.onDidChangeOutputs(n=>{this._updateOutputs(n)}))}_outputEntries=new Map;_updateOutputs(e){const t=[];this._outputEntries.forEach((o,l)=>{this._nestedCellViewModel.outputsViewModels.indexOf(l)<0&&(t.push(l),o.domNode.remove(),this._editor.removeInset(this._diffElementViewModel,this._nestedCellViewModel,l,this._diffSide))}),t.forEach(o=>{this._outputEntries.get(o)?.dispose(),this._outputEntries.delete(o)});let i;this._nestedCellViewModel.outputsViewModels.reverse().forEach(o=>{if(this._outputEntries.has(o)){i=this._outputEntries.get(o).domNode;return}const l=this._nestedCellViewModel.outputsViewModels.indexOf(o);this._renderOutput(o,l,i),i=this._outputEntries.get(o)?.domNode})}render(){for(let e=0;e<this._nestedCellViewModel.outputsViewModels.length;e++){const t=this._nestedCellViewModel.outputsViewModels[e];this._renderOutput(t,e,void 0)}}showOutputs(){for(let e=0;e<this._nestedCellViewModel.outputsViewModels.length;e++){const t=this._nestedCellViewModel.outputsViewModels[e];this._editor.showInset(this._diffElementViewModel,t.cellViewModel,t,this._diffSide)}}hideOutputs(){this._outputEntries.forEach((e,t)=>{this._editor.hideInset(this._diffElementViewModel,this._nestedCellViewModel,t)})}_renderOutput(e,t,i){this._outputEntries.has(e)||this._outputEntries.set(e,new N(this._editor,this._notebookTextModel,this._notebookService,this._quickInputService,this._diffElementViewModel,this._diffSide,this._nestedCellViewModel,this._outputContainer,e)),this._outputEntries.get(e).render(t,i)}};h=I([_(6,T),_(7,S)],h);export{h as OutputContainer,N as OutputElement};
