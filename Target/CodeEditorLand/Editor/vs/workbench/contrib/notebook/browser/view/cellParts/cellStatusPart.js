var w=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var b=(u,d,t,i)=>{for(var e=i>1?void 0:i?M(d,t):d,r=u.length-1,n;r>=0;r--)(n=u[r])&&(e=(i?n(d,t,e):n(e))||e);return i&&e&&w(d,t,e),e},c=(u,d)=>(t,i)=>d(t,i,u);import*as l from"../../../../../../../vs/base/browser/dom.js";import{StandardKeyboardEvent as T}from"../../../../../../../vs/base/browser/keyboardEvent.js";import"../../../../../../../vs/base/browser/ui/hover/hoverDelegate.js";import{HoverPosition as H}from"../../../../../../../vs/base/browser/ui/hover/hoverWidget.js";import{SimpleIconLabel as A}from"../../../../../../../vs/base/browser/ui/iconLabel/simpleIconLabel.js";import"../../../../../../../vs/base/common/actions.js";import{toErrorMessage as L}from"../../../../../../../vs/base/common/errorMessage.js";import{Emitter as B}from"../../../../../../../vs/base/common/event.js";import{stripIcons as N}from"../../../../../../../vs/base/common/iconLabels.js";import{KeyCode as _}from"../../../../../../../vs/base/common/keyCodes.js";import{Disposable as W,DisposableStore as x,dispose as D}from"../../../../../../../vs/base/common/lifecycle.js";import{MarshalledId as O}from"../../../../../../../vs/base/common/marshallingIds.js";import"../../../../../../../vs/base/common/themables.js";import"../../../../../../../vs/editor/browser/editorBrowser.js";import{isThemeColor as F}from"../../../../../../../vs/editor/common/editorCommon.js";import{ICommandService as P}from"../../../../../../../vs/platform/commands/common/commands.js";import{IConfigurationService as R}from"../../../../../../../vs/platform/configuration/common/configuration.js";import{IHoverService as E}from"../../../../../../../vs/platform/hover/browser/hover.js";import{IInstantiationService as V}from"../../../../../../../vs/platform/instantiation/common/instantiation.js";import{INotificationService as K}from"../../../../../../../vs/platform/notification/common/notification.js";import{ITelemetryService as $}from"../../../../../../../vs/platform/telemetry/common/telemetry.js";import{IThemeService as k}from"../../../../../../../vs/platform/theme/common/themeService.js";import"../../../../../../../vs/workbench/contrib/notebook/browser/controller/coreActions.js";import{CellFocusMode as p}from"../../../../../../../vs/workbench/contrib/notebook/browser/notebookBrowser.js";import{CellContentPart as q}from"../../../../../../../vs/workbench/contrib/notebook/browser/view/cellPart.js";import{ClickTargetType as f}from"../../../../../../../vs/workbench/contrib/notebook/browser/view/cellParts/cellWidgets.js";import{CodeCellViewModel as Y}from"../../../../../../../vs/workbench/contrib/notebook/browser/viewModel/codeCellViewModel.js";import{CellStatusbarAlignment as S}from"../../../../../../../vs/workbench/contrib/notebook/common/notebookCommon.js";const C=l.$;let I=class extends q{constructor(t,i,e,r,n,o,a,g){super();this._notebookEditor=t;this._cellContainer=i;this._editor=r;this._instantiationService=n;this._themeService=g;this.statusBarContainer=l.append(e,C(".cell-statusbar-container")),this.statusBarContainer.tabIndex=-1;const h=l.append(this.statusBarContainer,C(".cell-status-left")),m=l.append(this.statusBarContainer,C(".cell-status-right"));this.leftItemsContainer=l.append(h,C(".cell-contributed-items.cell-contributed-items-left")),this.rightItemsContainer=l.append(m,C(".cell-contributed-items.cell-contributed-items-right")),this.itemsDisposable=this._register(new x),this.hoverDelegate=new class{_lastHoverHideTime=0;showHover=s=>(s.position=s.position??{},s.position.hoverPosition=H.ABOVE,o.showHover(s));placement="element";get delay(){return Date.now()-this._lastHoverHideTime<200?0:a.getValue("workbench.hover.delay")}onDidHideHover(){this._lastHoverHideTime=Date.now()}},this._register(this._themeService.onDidColorThemeChange(()=>this.currentContext&&this.updateContext(this.currentContext))),this._register(l.addDisposableListener(this.statusBarContainer,l.EventType.CLICK,s=>{s.target===h||s.target===m||s.target===this.statusBarContainer?this._onDidClick.fire({type:f.Container,event:s}):s.target.classList.contains("cell-status-item-has-command")?this._onDidClick.fire({type:f.ContributedCommandItem,event:s}):this._onDidClick.fire({type:f.ContributedTextItem,event:s})}))}statusBarContainer;leftItemsContainer;rightItemsContainer;itemsDisposable;leftItems=[];rightItems=[];width=0;currentContext;_onDidClick=this._register(new B);onDidClick=this._onDidClick.event;hoverDelegate;didRenderCell(t){if(this._notebookEditor.hasModel()){const i={ui:!0,cell:t,notebookEditor:this._notebookEditor,$mid:O.NotebookCellActionContext};this.updateContext(i)}if(this._editor){const i=()=>{if(this._editor&&(this._editor.hasWidgetFocus()||this.statusBarContainer.ownerDocument.activeElement&&this.statusBarContainer.contains(this.statusBarContainer.ownerDocument.activeElement)))t.focusMode=p.Editor;else{const e=t.focusMode;e===p.ChatInput?t.focusMode=p.ChatInput:e===p.Output&&this._notebookEditor.hasWebviewFocus()?t.focusMode=p.Output:t.focusMode=p.Container}};this.cellDisposables.add(this._editor.onDidFocusEditorWidget(()=>{i()})),this.cellDisposables.add(this._editor.onDidBlurEditorWidget(()=>{this._notebookEditor.hasEditorFocus()&&!(this.statusBarContainer.ownerDocument.activeElement&&this.statusBarContainer.contains(this.statusBarContainer.ownerDocument.activeElement))&&i()})),this.cellDisposables.add(this.onDidClick(e=>{if(this.currentCell instanceof Y&&e.type!==f.ContributedCommandItem&&this._editor){const r=this._editor.getTargetAtClientPoint(e.event.clientX,e.event.clientY-this._notebookEditor.notebookOptions.computeEditorStatusbarHeight(this.currentCell.internalMetadata,this.currentCell.uri));r?.position&&(this._editor.setPosition(r.position),this._editor.focus())}}))}}updateInternalLayoutNow(t){this._cellContainer.classList.toggle("cell-statusbar-hidden",this._notebookEditor.notebookOptions.computeEditorStatusbarHeight(t.internalMetadata,t.uri)===0);const e=t.layoutInfo.editorWidth;if(!e)return;this.width=e,this.statusBarContainer.style.width=`${e}px`;const r=this.getMaxItemWidth();this.leftItems.forEach(n=>n.maxWidth=r),this.rightItems.forEach(n=>n.maxWidth=r)}getMaxItemWidth(){return this.width/2}updateContext(t){this.currentContext=t,this.itemsDisposable.clear(),this.currentContext&&(this.itemsDisposable.add(this.currentContext.cell.onDidChangeLayout(()=>{this.currentContext&&this.updateInternalLayoutNow(this.currentContext.cell)})),this.itemsDisposable.add(this.currentContext.cell.onDidChangeCellStatusBarItems(()=>this.updateRenderedItems())),this.itemsDisposable.add(this.currentContext.notebookEditor.onDidChangeActiveCell(()=>this.updateActiveCell())),this.updateInternalLayoutNow(this.currentContext.cell),this.updateActiveCell(),this.updateRenderedItems())}updateActiveCell(){const t=this.currentContext.notebookEditor.getActiveCell()===this.currentContext?.cell;this.statusBarContainer.classList.toggle("is-active-cell",t)}updateRenderedItems(){const t=this.currentContext.cell.getCellStatusBarItems();t.sort((o,a)=>(a.priority??0)-(o.priority??0));const i=this.getMaxItemWidth(),e=t.filter(o=>o.alignment===S.Left),r=t.filter(o=>o.alignment===S.Right).reverse(),n=(o,a,g)=>{if(o.length>a.length){const h=o.splice(a.length,o.length-a.length);for(const m of h)m.container.remove(),m.dispose()}a.forEach((h,m)=>{const s=o[m];if(s)s.updateItem(h,i);else{const y=this._instantiationService.createInstance(v,this.currentContext,this.hoverDelegate,this._editor,h,i);o.push(y),g.appendChild(y.container)}})};n(this.leftItems,e,this.leftItemsContainer),n(this.rightItems,r,this.rightItemsContainer)}dispose(){super.dispose(),D(this.leftItems),D(this.rightItems)}};I=b([c(4,V),c(5,E),c(6,R),c(7,k)],I);let v=class extends W{constructor(t,i,e,r,n,o,a,g,h,m){super();this._context=t;this._hoverDelegate=i;this._editor=e;this._telemetryService=o;this._commandService=a;this._notificationService=g;this._themeService=h;this._hoverService=m;this.updateItem(r,n)}container=C(".cell-status-item");set maxWidth(t){this.container.style.maxWidth=t+"px"}_currentItem;_itemDisposables=this._register(new x);updateItem(t,i){this._itemDisposables.clear(),(!this._currentItem||this._currentItem.text!==t.text)&&(this._itemDisposables.add(new A(this.container)).text=t.text.replace(/\n/g," "));const e=o=>F(o)?this._themeService.getColorTheme().getColor(o.id)?.toString()||"":o;this.container.style.color=t.color?e(t.color):"",this.container.style.backgroundColor=t.backgroundColor?e(t.backgroundColor):"",this.container.style.opacity=t.opacity?t.opacity:"",this.container.classList.toggle("cell-status-item-show-when-active",!!t.onlyShowWhenActive),typeof i=="number"&&(this.maxWidth=i);let r,n;if(t.accessibilityInformation?(r=t.accessibilityInformation.label,n=t.accessibilityInformation.role):r=t.text?N(t.text).trim():"",this.container.setAttribute("aria-label",r),this.container.setAttribute("role",n||""),t.tooltip){const o=typeof t.tooltip=="string"?t.tooltip:{markdown:t.tooltip,markdownNotSupportedFallback:void 0};this._itemDisposables.add(this._hoverService.setupManagedHover(this._hoverDelegate,this.container,o))}this.container.classList.toggle("cell-status-item-has-command",!!t.command),t.command?(this.container.tabIndex=0,this._itemDisposables.add(l.addDisposableListener(this.container,l.EventType.CLICK,o=>{this.executeCommand()})),this._itemDisposables.add(l.addDisposableListener(this.container,l.EventType.KEY_DOWN,o=>{const a=new T(o);(a.equals(_.Space)||a.equals(_.Enter))&&this.executeCommand()}))):this.container.removeAttribute("tabIndex"),this._currentItem=t}async executeCommand(){const t=this._currentItem.command;if(!t)return;const i=typeof t=="string"?t:t.id,e=typeof t=="string"?[]:t.arguments??[];(typeof t=="string"||!t.arguments||!Array.isArray(t.arguments)||t.arguments.length===0)&&e.unshift(this._context),this._telemetryService.publicLog2("workbenchActionExecuted",{id:i,from:"cell status bar"});try{this._editor?.focus(),await this._commandService.executeCommand(i,...e)}catch(r){this._notificationService.error(L(r))}}};v=b([c(5,$),c(6,P),c(7,K),c(8,k),c(9,E)],v);export{I as CellEditorStatusBar};
