var D=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var T=(g,v,e,t)=>{for(var i=t>1?void 0:t?V(v,e):v,n=g.length-1,r;n>=0;n--)(r=g[n])&&(i=(t?r(v,e,i):r(i))||i);return t&&i&&D(v,e,i),i},m=(g,v)=>(e,t)=>v(e,t,g);import*as h from"../../../../../../../vs/base/browser/dom.js";import"../../../../../../../vs/base/browser/fastDomNode.js";import{renderMarkdown as L}from"../../../../../../../vs/base/browser/markdownRenderer.js";import{Action as P}from"../../../../../../../vs/base/common/actions.js";import"../../../../../../../vs/base/common/htmlContent.js";import{Disposable as A,DisposableStore as _}from"../../../../../../../vs/base/common/lifecycle.js";import{MarshalledId as F}from"../../../../../../../vs/base/common/marshallingIds.js";import{autorun as S,observableValue as U}from"../../../../../../../vs/base/common/observable.js";import{ThemeIcon as j}from"../../../../../../../vs/base/common/themables.js";import*as C from"../../../../../../../vs/nls.js";import{createAndFillInActionBarActions as K}from"../../../../../../../vs/platform/actions/browser/menuEntryActionViewItem.js";import{WorkbenchToolBar as $}from"../../../../../../../vs/platform/actions/browser/toolbar.js";import{IMenuService as B,MenuId as z}from"../../../../../../../vs/platform/actions/common/actions.js";import{IContextKeyService as J}from"../../../../../../../vs/platform/contextkey/common/contextkey.js";import{IInstantiationService as k}from"../../../../../../../vs/platform/instantiation/common/instantiation.js";import{IOpenerService as Q}from"../../../../../../../vs/platform/opener/common/opener.js";import{IQuickInputService as Y}from"../../../../../../../vs/platform/quickinput/common/quickInput.js";import{ViewContainerLocation as W}from"../../../../../../../vs/workbench/common/views.js";import{VIEWLET_ID as q}from"../../../../../../../vs/workbench/contrib/extensions/common/extensions.js";import{TEXT_BASED_MIMETYPES as X}from"../../../../../../../vs/workbench/contrib/notebook/browser/contrib/clipboard/cellOutputClipboard.js";import{COPY_OUTPUT_COMMAND_ID as G}from"../../../../../../../vs/workbench/contrib/notebook/browser/controller/cellOutputActions.js";import{JUPYTER_EXTENSION_ID as Z,RenderOutputType as I}from"../../../../../../../vs/workbench/contrib/notebook/browser/notebookBrowser.js";import{mimetypeIcon as ee}from"../../../../../../../vs/workbench/contrib/notebook/browser/notebookIcons.js";import{CellContentPart as te}from"../../../../../../../vs/workbench/contrib/notebook/browser/view/cellPart.js";import"../../../../../../../vs/workbench/contrib/notebook/browser/view/notebookRenderingCommon.js";import"../../../../../../../vs/workbench/contrib/notebook/browser/viewModel/codeCellViewModel.js";import"../../../../../../../vs/workbench/contrib/notebook/common/model/notebookTextModel.js";import{CellUri as x,isTextStreamMime as H,NotebookCellExecutionState as ie,RENDERER_NOT_AVAILABLE as oe}from"../../../../../../../vs/workbench/contrib/notebook/common/notebookCommon.js";import{NOTEBOOK_CELL_HAS_HIDDEN_OUTPUTS as ne,NOTEBOOK_CELL_IS_FIRST_OUTPUT as re}from"../../../../../../../vs/workbench/contrib/notebook/common/notebookContextKeys.js";import{INotebookExecutionStateService as se}from"../../../../../../../vs/workbench/contrib/notebook/common/notebookExecutionStateService.js";import"../../../../../../../vs/workbench/contrib/notebook/common/notebookKernelService.js";import{INotebookService as le}from"../../../../../../../vs/workbench/contrib/notebook/common/notebookService.js";import{IPaneCompositePartService as ae}from"../../../../../../../vs/workbench/services/panecomposite/browser/panecomposite.js";let f=class extends A{constructor(e,t,i,n,r,l,a,s,p,o,u){super();this.notebookEditor=e;this.viewCell=t;this.cellOutputContainer=i;this.outputContainer=n;this.output=r;this.notebookService=l;this.quickInputService=a;this.menuService=p;this.paneCompositeService=o;this.instantiationService=u;this.contextKeyService=s,this._register(this.output.model.onDidChangeData(()=>{this.rerender()})),this._register(this.output.onDidResetRenderer(()=>{this.rerender()}))}toolbarDisposables=this._register(new _);innerContainer;renderedOutputContainer;renderResult;contextKeyService;toolbarAttached=!1;detach(){this.renderedOutputContainer?.remove();let e=0;if(this.innerContainer){for(let t=0;t<this.innerContainer.childNodes.length&&(this.innerContainer.childNodes[t].className==="rendered-output"&&e++,!(e>1));t++);e===0&&this.innerContainer.remove()}this.notebookEditor.removeInset(this.output)}updateDOMTop(e){this.innerContainer&&(this.innerContainer.style.top=`${e}px`)}rerender(){if(this.notebookEditor.hasModel()&&this.innerContainer&&this.renderResult&&this.renderResult.type===I.Extension){const[e,t]=this.output.resolveMimeTypes(this.notebookEditor.textModel,this.notebookEditor.activeKernel?.preloadProvides),i=e[t];if(i.mimeType===this.renderResult.mimeType&&i.rendererId===this.renderResult.renderer.id){const n=this.viewCell.outputsViewModels.indexOf(this.output);this.notebookEditor.updateOutput(this.viewCell,this.renderResult,this.viewCell.getOutputOffset(n));return}}if(this.innerContainer){const e=this.innerContainer.nextElementSibling;this.toolbarDisposables.clear();const t=this.innerContainer;t&&(t.remove(),this.notebookEditor.removeInset(this.output)),this.render(e)}else{const e=this.cellOutputContainer.renderedOutputEntries.findIndex(i=>i.element===this),t=e>0&&this.cellOutputContainer.renderedOutputEntries[e-1].element.innerContainer?.parentElement?this.cellOutputContainer.renderedOutputEntries[e-1].element.innerContainer:void 0;this.render(t)}this._relayoutCell()}_generateInnerOutputContainer(e,t){return this.innerContainer=h.$(".output-inner-container"),e&&e.nextElementSibling?this.outputContainer.domNode.insertBefore(this.innerContainer,e.nextElementSibling):this.outputContainer.domNode.appendChild(this.innerContainer),this.innerContainer.setAttribute("output-mime-type",t.mimeType),this.innerContainer}render(e){const t=this.viewCell.outputsViewModels.indexOf(this.output);if(this.viewCell.isOutputCollapsed||!this.notebookEditor.hasModel()){this.cellOutputContainer.flagAsStale();return}if(!x.parse(this.viewCell.uri)?.notebook)return;const n=this.notebookEditor.textModel,[r,l]=this.output.resolveMimeTypes(n,this.notebookEditor.activeKernel?.preloadProvides);if(!r.find(o=>o.isTrusted)||r.length===0){this.viewCell.updateOutputHeight(t,0,"CellOutputElement#noMimeType");return}const a=r[l];let s=this.notebookService.getRendererInfo(a.rendererId);!s&&a.mimeType.indexOf("text/")>-1&&(s=this.notebookService.getRendererInfo("vscode.builtin-renderer"));const p=this._generateInnerOutputContainer(e,a);if(t===0||this.output.visible.get()?this._attachToolbar(p,n,this.notebookEditor.activeKernel,t,r):(this._register(S(o=>{const u=o.readObservable(this.output.visible);u&&!this.toolbarAttached?this._attachToolbar(p,n,this.notebookEditor.activeKernel,t,r):u||this.toolbarDisposables.clear(),this.cellOutputContainer.checkForHiddenOutputs()})),this.cellOutputContainer.hasHiddenOutputs.set(!0,void 0)),this.renderedOutputContainer=h.append(p,h.$(".rendered-output")),this.renderResult=s?{type:I.Extension,renderer:s,source:this.output,mimeType:a.mimeType}:this._renderMissingRenderer(this.output,a.mimeType),this.output.pickedMimeType=a,!this.renderResult){this.viewCell.updateOutputHeight(t,0,"CellOutputElement#renderResultUndefined");return}return this.notebookEditor.createOutput(this.viewCell,this.renderResult,this.viewCell.getOutputOffset(t),!1),p.classList.add("background"),{initRenderIsSynchronous:!1}}_renderMissingRenderer(e,t){if(!e.model.outputs.length)return this._renderMessage(e,C.localize("empty","Cell has no output"));if(!t){const n=e.model.outputs.map(r=>r.mime).join(", ");return this._renderMessage(e,C.localize("noRenderer.2","No renderer could be found for output. It has the following mimetypes: {0}",n))}return this._renderSearchForMimetype(e,t)}_renderSearchForMimetype(e,t){const i=`@tag:notebookRenderer ${t}`,n=h.$("p",void 0,`No renderer could be found for mimetype "${t}", but one might be available on the Marketplace.`),r=h.$("a",{href:`command:workbench.extensions.search?%22${i}%22`,class:"monaco-button monaco-text-button",tabindex:0,role:"button",style:"padding: 8px; text-decoration: none; color: rgb(255, 255, 255); background-color: rgb(14, 99, 156); max-width: 200px;"},"Search Marketplace");return{type:I.Html,source:e,htmlContent:n.outerHTML+r.outerHTML}}_renderMessage(e,t){const i=h.$("p",void 0,t);return{type:I.Html,source:e,htmlContent:i.outerHTML}}shouldEnableCopy(e){if(!e.find(t=>X.indexOf(t.mimeType)||t.mimeType.startsWith("image/")))return!1;if(H(e[0].mimeType)){const t=this.output.cellViewModel,i=t.outputsViewModels.indexOf(this.output);if(i>0){const n=t.model.outputs[i-1];return!H(n.outputs[0].mime)}}return!0}async _attachToolbar(e,t,i,n,r){const l=r.filter(d=>d.isTrusted).length>1,a=this.shouldEnableCopy(r);if(n>0&&!l&&!a||!this.notebookEditor.hasModel())return;e.style.position="relative";const s=h.$(".cell-output-toolbar");e.appendChild(s);const p=this.toolbarDisposables.add(this.instantiationService.createInstance($,s,{renderDropdownAsChildElement:!1}));p.context={ui:!0,cell:this.output.cellViewModel,outputViewModel:this.output,notebookEditor:this.notebookEditor,$mid:F.NotebookCellActionContext};const o=this.toolbarDisposables.add(new P("notebook.output.pickMimetype",C.localize("pickMimeType","Change Presentation"),j.asClassName(ee),void 0,async d=>this._pickActiveMimeTypeRenderer(e,t,i,this.output))),u=this.toolbarDisposables.add(this.contextKeyService.createScoped(e)),y=ne.bindTo(u);re.bindTo(u).set(n===0),this.toolbarDisposables.add(S(d=>{y.set(d.readObservable(this.cellOutputContainer.hasHiddenOutputs))}));const E=this.toolbarDisposables.add(this.menuService.createMenu(z.NotebookOutputToolbar,u)),w=()=>{const d=[];let c=[];K(E,{shouldForwardArgs:!0},{primary:d,secondary:c},()=>!1),a||(c=c.filter(N=>N.id!==G)),l&&(c=[o,...c]),p.setActions([],c)};w(),this.toolbarDisposables.add(E.onDidChange(w))}async _pickActiveMimeTypeRenderer(e,t,i,n){const[r,l]=n.resolveMimeTypes(t,i?.preloadProvides),a=[],s=[];r.forEach((d,c)=>{d.isTrusted&&(d.rendererId===oe?s:a).push({label:d.mimeType,id:d.mimeType,index:c,picked:c===l,detail:this._generateRendererInfo(d.rendererId),description:c===l?C.localize("curruentActiveMimeType","Currently Active"):void 0})}),s.some(d=>de.includes(d.id))&&s.push({label:C.localize("installJupyterPrompt","Install additional renderers from the marketplace"),id:"installRenderers",index:r.length});const p=new _,o=p.add(this.quickInputService.createQuickPick({useSeparators:!0}));o.items=[...a,{type:"separator"},...s],o.activeItems=a.filter(d=>!!d.picked),o.placeholder=a.length!==r.length?C.localize("promptChooseMimeTypeInSecure.placeHolder","Select mimetype to render for current output"):C.localize("promptChooseMimeType.placeHolder","Select mimetype to render for current output");const u=await new Promise(d=>{p.add(o.onDidAccept(()=>{d(o.selectedItems.length===1?o.selectedItems[0]:void 0),p.dispose()})),o.show()});if(u===void 0||u.index===l)return;if(u.id==="installRenderers"){this._showJupyterExtension();return}const y=e.nextElementSibling;this.toolbarDisposables.clear();const M=this.innerContainer;M&&(M.remove(),this.notebookEditor.removeInset(n)),n.pickedMimeType=r[u.index],this.viewCell.updateOutputMinHeight(this.viewCell.layoutInfo.outputTotalHeight);const{mimeType:E,rendererId:w}=r[u.index];this.notebookService.updateMimePreferredRenderer(t.viewType,E,w,r.map(d=>d.mimeType)),this.render(y),this._validateFinalOutputHeight(!1),this._relayoutCell()}async _showJupyterExtension(){(await this.paneCompositeService.openPaneComposite(q,W.Sidebar,!0))?.getViewPaneContainer()?.search(`@id:${Z}`)}_generateRendererInfo(e){const t=this.notebookService.getRendererInfo(e);return t?`${t.displayName!==""?t.displayName:t.id} (${t.extensionId.value})`:C.localize("unavailableRenderInfo","renderer not available")}_outputHeightTimer=null;_validateFinalOutputHeight(e){this._outputHeightTimer!==null&&clearTimeout(this._outputHeightTimer),e?this.viewCell.unlockOutputHeight():this._outputHeightTimer=setTimeout(()=>{this.viewCell.unlockOutputHeight()},1e3)}_relayoutCell(){this.notebookEditor.layoutNotebookCell(this.viewCell,this.viewCell.layoutInfo.totalHeight)}dispose(){this._outputHeightTimer&&(this.viewCell.unlockOutputHeight(),clearTimeout(this._outputHeightTimer)),super.dispose()}};f=T([m(5,le),m(6,Y),m(7,J),m(8,B),m(9,ae),m(10,k)],f);class b{constructor(v,e){this.model=v;this.element=e}}var ue=(e=>(e[e.Execution=1]="Execution",e[e.Other=2]="Other",e))(ue||{});let O=class extends te{constructor(e,t,i,n,r,l,a){super();this.notebookEditor=e;this.viewCell=t;this.templateData=i;this.options=n;this.openerService=r;this._notebookExecutionStateService=l;this.instantiationService=a;this._register(t.onDidStartExecution(()=>{t.updateOutputMinHeight(t.layoutInfo.outputTotalHeight)})),this._register(t.onDidStopExecution(()=>{this._validateFinalOutputHeight(!1)})),this._register(t.onDidChangeOutputs(s=>{const o=this._notebookExecutionStateService.getCellExecution(t.uri)?1:2;this._updateOutputs(s,o)})),this._register(t.onDidChangeLayout(()=>{this.updateInternalLayoutNow(t)}))}_outputEntries=[];_hasStaleOutputs=!1;hasHiddenOutputs=U("hasHiddenOutputs",!1);checkForHiddenOutputs(){this._outputEntries.find(e=>e.model.visible)?this.hasHiddenOutputs.set(!0,void 0):this.hasHiddenOutputs.set(!1,void 0)}get renderedOutputEntries(){return this._outputEntries}updateInternalLayoutNow(e){this.templateData.outputContainer.setTop(e.layoutInfo.outputContainerOffset),this.templateData.outputShowMoreContainer.setTop(e.layoutInfo.outputShowMoreContainerOffset),this._outputEntries.forEach(t=>{const i=this.viewCell.outputsViewModels.indexOf(t.model);if(i>=0){const n=this.viewCell.getOutputOffsetInContainer(i);t.element.updateDOMTop(n)}})}render(){try{this._doRender()}finally{this._relayoutCell()}}flagAsStale(){this._hasStaleOutputs=!0}_doRender(){if(this.viewCell.outputsViewModels.length>0){this.viewCell.layoutInfo.outputTotalHeight!==0&&this.viewCell.updateOutputMinHeight(this.viewCell.layoutInfo.outputTotalHeight),h.show(this.templateData.outputContainer.domNode);for(let e=0;e<Math.min(this.options.limit,this.viewCell.outputsViewModels.length);e++){const t=this.viewCell.outputsViewModels[e],i=this.instantiationService.createInstance(f,this.notebookEditor,this.viewCell,this,this.templateData.outputContainer,t);this._outputEntries.push(new b(t,i)),i.render(void 0)}this.viewCell.outputsViewModels.length>this.options.limit&&(h.show(this.templateData.outputShowMoreContainer.domNode),this.viewCell.updateOutputShowMoreContainerHeight(46)),this._validateFinalOutputHeight(!1)}else h.hide(this.templateData.outputContainer.domNode);this.templateData.outputShowMoreContainer.domNode.innerText="",this.viewCell.outputsViewModels.length>this.options.limit?this.templateData.outputShowMoreContainer.domNode.appendChild(this._generateShowMoreElement(this.templateData.templateDisposables)):(h.hide(this.templateData.outputShowMoreContainer.domNode),this.viewCell.updateOutputShowMoreContainerHeight(0))}viewUpdateShowOutputs(e){this._hasStaleOutputs&&(this._hasStaleOutputs=!1,this._outputEntries.forEach(t=>{t.element.rerender()}));for(let t=0;t<this._outputEntries.length;t++){const n=this._outputEntries[t].element;n.renderResult?this.notebookEditor.createOutput(this.viewCell,n.renderResult,this.viewCell.getOutputOffset(t),!1):n.render(void 0)}this._relayoutCell()}viewUpdateHideOuputs(){for(let e=0;e<this._outputEntries.length;e++)this.notebookEditor.hideInset(this._outputEntries[e].model)}_outputHeightTimer=null;_validateFinalOutputHeight(e){this._outputHeightTimer!==null&&clearTimeout(this._outputHeightTimer);const t=this._notebookExecutionStateService.getCellExecution(this.viewCell.uri);e?this.viewCell.unlockOutputHeight():t?.state!==ie.Executing&&(this._outputHeightTimer=setTimeout(()=>{this.viewCell.unlockOutputHeight()},200))}_updateOutputs(e,t=2){const i=this.viewCell.layoutInfo.outputTotalHeight;this.viewCell.updateOutputMinHeight(i),this.viewCell.outputsViewModels.length?h.show(this.templateData.outputContainer.domNode):h.hide(this.templateData.outputContainer.domNode),this.viewCell.spliceOutputHeights(e.start,e.deleteCount,e.newOutputs.map(n=>0)),this._renderNow(e,t)}_renderNow(e,t){if(e.start>=this.options.limit)return;const i=this._outputEntries.slice(0,e.start),n=this._outputEntries.slice(e.start,e.start+e.deleteCount),r=this._outputEntries.slice(e.start+e.deleteCount);let l=this.viewCell.outputsViewModels.slice(e.start,e.start+e.newOutputs.length);if(i.length+l.length+r.length>this.options.limit)if(i.length+l.length>this.options.limit){[...n,...r].forEach(s=>{s.element.detach(),s.element.dispose()}),l=l.slice(0,this.options.limit-i.length);const a=l.map(s=>new b(s,this.instantiationService.createInstance(f,this.notebookEditor,this.viewCell,this,this.templateData.outputContainer,s)));this._outputEntries=[...i,...a];for(let s=i.length;s<this._outputEntries.length;s++)this._outputEntries[s].element.render(void 0)}else{const a=r.slice(this.options.limit-i.length-l.length);[...n,...a].forEach(o=>{o.element.detach(),o.element.dispose()});const s=i.length+l.length,p=l.map(o=>new b(o,this.instantiationService.createInstance(f,this.notebookEditor,this.viewCell,this,this.templateData.outputContainer,o)));this._outputEntries=[...i,...p,...r.slice(0,this.options.limit-i.length-l.length)];for(let o=i.length;o<s;o++){const u=o-1>=0&&this._outputEntries[o-1]&&this._outputEntries[o-1].element.innerContainer?.parentElement?this._outputEntries[o-1].element.innerContainer:void 0;this._outputEntries[o].element.render(u)}}else{n.forEach(o=>{o.element.detach(),o.element.dispose()});const a=i.length+l.length,s=l.map(o=>new b(o,this.instantiationService.createInstance(f,this.notebookEditor,this.viewCell,this,this.templateData.outputContainer,o)));let p=[];if(i.length+s.length+r.length<this.viewCell.outputsViewModels.length){const o=Math.min(this.options.limit,this.viewCell.outputsViewModels.length);p=this.viewCell.outputsViewModels.slice(i.length+s.length+r.length,o).map(u=>new b(u,this.instantiationService.createInstance(f,this.notebookEditor,this.viewCell,this,this.templateData.outputContainer,u)))}this._outputEntries=[...i,...s,...r,...p];for(let o=i.length;o<a;o++){const u=o-1>=0&&this._outputEntries[o-1]&&this._outputEntries[o-1].element.innerContainer?.parentElement?this._outputEntries[o-1].element.innerContainer:void 0;this._outputEntries[o].element.render(u)}for(let o=0;o<p.length;o++)this._outputEntries[i.length+l.length+r.length+o].element.render(void 0)}this.viewCell.outputsViewModels.length>this.options.limit?(h.show(this.templateData.outputShowMoreContainer.domNode),this.templateData.outputShowMoreContainer.domNode.hasChildNodes()||this.templateData.outputShowMoreContainer.domNode.appendChild(this._generateShowMoreElement(this.templateData.templateDisposables)),this.viewCell.updateOutputShowMoreContainerHeight(46)):h.hide(this.templateData.outputShowMoreContainer.domNode),this._relayoutCell(),this._validateFinalOutputHeight(t===2&&this.viewCell.outputsViewModels.length===0)}_generateShowMoreElement(e){const t={value:`There are more than ${this.options.limit} outputs, [show more (open the raw output data in a text editor) ...](command:workbench.action.openLargeOutput)`,isTrusted:!0,supportThemeIcons:!0},i=L(t,{actionHandler:{callback:n=>{n==="command:workbench.action.openLargeOutput"&&this.openerService.open(x.generateCellOutputUri(this.notebookEditor.textModel.uri))},disposables:e}});return e.add(i),i.element.classList.add("output-show-more"),i.element}_relayoutCell(){this.notebookEditor.layoutNotebookCell(this.viewCell,this.viewCell.layoutInfo.totalHeight)}dispose(){this.viewCell.updateOutputMinHeight(0),this._outputHeightTimer&&clearTimeout(this._outputHeightTimer),this._outputEntries.forEach(e=>{e.element.dispose()}),super.dispose()}};O=T([m(4,Q),m(5,se),m(6,k)],O);const de=["application/geo+json","application/vdom.v1+json","application/vnd.dataresource+json","application/vnd.plotly.v1+json","application/vnd.vega.v2+json","application/vnd.vega.v3+json","application/vnd.vega.v4+json","application/vnd.vega.v5+json","application/vnd.vegalite.v1+json","application/vnd.vegalite.v2+json","application/vnd.vegalite.v3+json","application/vnd.vegalite.v4+json","application/x-nteract-model-debug+json","image/svg+xml","text/latex","text/vnd.plotly.v1+html","application/vnd.jupyter.widget-view+json","application/vnd.code.notebook.error"];export{O as CellOutputContainer};
