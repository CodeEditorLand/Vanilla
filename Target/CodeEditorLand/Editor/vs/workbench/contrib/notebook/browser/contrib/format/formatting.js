var V=Object.defineProperty;var j=Object.getOwnPropertyDescriptor;var h=(e,o,r,t)=>{for(var i=t>1?void 0:t?j(o,r):o,n=e.length-1,a;n>=0;n--)(a=e[n])&&(i=(t?a(o,r,i):a(i))||i);return t&&i&&V(o,r,i),i},c=(e,o)=>(r,t)=>o(r,t,e);import{CancellationToken as g}from"../../../../../../../vs/base/common/cancellation.js";import{KeyCode as E,KeyMod as s}from"../../../../../../../vs/base/common/keyCodes.js";import{Disposable as z,DisposableStore as A}from"../../../../../../../vs/base/common/lifecycle.js";import"../../../../../../../vs/editor/browser/editorBrowser.js";import{EditorAction as G,registerEditorAction as H}from"../../../../../../../vs/editor/browser/editorExtensions.js";import{IBulkEditService as M,ResourceTextEdit as T}from"../../../../../../../vs/editor/browser/services/bulkEditService.js";import{EditorContextKeys as d}from"../../../../../../../vs/editor/common/editorContextKeys.js";import{IEditorWorkerService as W}from"../../../../../../../vs/editor/common/services/editorWorker.js";import{ILanguageFeaturesService as K}from"../../../../../../../vs/editor/common/services/languageFeatures.js";import{ITextModelService as R}from"../../../../../../../vs/editor/common/services/resolverService.js";import{formatDocumentWithSelectedProvider as U,FormattingMode as y,getDocumentFormattingEditsWithSelectedProvider as O}from"../../../../../../../vs/editor/contrib/format/browser/format.js";import{localize as x,localize2 as Y}from"../../../../../../../vs/nls.js";import{Action2 as q,MenuId as J,registerAction2 as Q}from"../../../../../../../vs/platform/actions/common/actions.js";import{IConfigurationService as X}from"../../../../../../../vs/platform/configuration/common/configuration.js";import{ContextKeyExpr as k}from"../../../../../../../vs/platform/contextkey/common/contextkey.js";import{IInstantiationService as C}from"../../../../../../../vs/platform/instantiation/common/instantiation.js";import{KeybindingWeight as P}from"../../../../../../../vs/platform/keybinding/common/keybindingsRegistry.js";import{Progress as _}from"../../../../../../../vs/platform/progress/common/progress.js";import{Registry as Z}from"../../../../../../../vs/platform/registry/common/platform.js";import{Extensions as $}from"../../../../../../../vs/workbench/common/contributions.js";import{CodeActionParticipantUtils as ee}from"../../../../../../../vs/workbench/contrib/notebook/browser/contrib/saveParticipants/saveParticipants.js";import{NOTEBOOK_ACTIONS_CATEGORY as oe}from"../../../../../../../vs/workbench/contrib/notebook/browser/controller/coreActions.js";import{getNotebookEditorFromEditorPane as te}from"../../../../../../../vs/workbench/contrib/notebook/browser/notebookBrowser.js";import{NotebookSetting as re}from"../../../../../../../vs/workbench/contrib/notebook/common/notebookCommon.js";import{NOTEBOOK_EDITOR_EDITABLE as D,NOTEBOOK_IS_ACTIVE_EDITOR as B}from"../../../../../../../vs/workbench/contrib/notebook/common/notebookContextKeys.js";import{INotebookExecutionService as ie}from"../../../../../../../vs/workbench/contrib/notebook/common/notebookExecutionService.js";import"../../../../../../../vs/workbench/contrib/notebook/common/notebookExecutionStateService.js";import{INotebookService as ne}from"../../../../../../../vs/workbench/contrib/notebook/common/notebookService.js";import{IEditorService as ae}from"../../../../../../../vs/workbench/services/editor/common/editorService.js";import{LifecyclePhase as ce}from"../../../../../../../vs/workbench/services/lifecycle/common/lifecycle.js";Q(class extends q{constructor(){super({id:"notebook.format",title:Y("format.title","Format Notebook"),category:oe,precondition:k.and(B,D),keybinding:{when:d.editorTextFocus.toNegated(),primary:s.Shift|s.Alt|E.KeyF,linux:{primary:s.CtrlCmd|s.Shift|E.KeyI},weight:P.WorkbenchContrib},f1:!0,menu:{id:J.EditorContext,when:k.and(d.inCompositeEditor,d.hasDocumentFormattingProvider),group:"1_modification",order:1.3}})}async run(e){const o=e.get(ae),r=e.get(R),t=e.get(W),i=e.get(K),n=e.get(M),a=e.get(C),l=te(o.activeEditorPane);if(!l||!l.hasModel())return;const p=l.textModel,u=await a.invokeFunction(ee.checkAndRunFormatCodeAction,p,_.None,g.None),f=new A;try{if(!u){const S=await Promise.all(p.cells.map(async m=>{const N=await r.createModelReference(m.uri);f.add(N);const I=N.object.textEditorModel,F=await O(t,i,I,y.Explicit,g.None),w=[];if(F){for(const L of F)w.push(new T(I.uri,L,I.getVersionId()));return w}return[]}));await n.apply(S.flat(),{label:x("label","Format Notebook"),code:"undoredo.formatNotebook"})}}finally{f.dispose()}}}),H(class extends G{constructor(){super({id:"notebook.formatCell",label:x("formatCell.label","Format Cell"),alias:"Format Cell",precondition:k.and(B,D,d.inCompositeEditor,d.writable,d.hasDocumentFormattingProvider),kbOpts:{kbExpr:k.and(d.editorTextFocus),primary:s.Shift|s.Alt|E.KeyF,linux:{primary:s.CtrlCmd|s.Shift|E.KeyI},weight:P.EditorContrib},contextMenuOpts:{group:"1_modification",order:1.301}})}async run(o,r){r.hasModel()&&await o.get(C).invokeFunction(U,r,y.Explicit,_.None,g.None,!0)}});let v=class{constructor(o,r,t,i,n,a){this.bulkEditService=o;this.languageFeaturesService=r;this.textModelService=t;this.editorWorkerService=i;this.configurationService=n;this._notebookService=a}async onWillExecuteCell(o){if(!this.configurationService.getValue(re.formatOnCellExecution))return;const t=new A;try{const i=await Promise.all(o.map(async n=>{const a=this._notebookService.getNotebookTextModel(n.notebook);if(!a)return[];let l;for(const m of a.cells)if(m.handle===n.cellHandle){l=m;break}if(!l)return[];const p=await this.textModelService.createModelReference(l.uri);t.add(p);const u=p.object.textEditorModel,f=await O(this.editorWorkerService,this.languageFeaturesService,u,y.Silent,g.None),S=[];return f?(S.push(...f.map(m=>new T(u.uri,m,u.getVersionId()))),S):[]}));await this.bulkEditService.apply(i.flat(),{label:x("formatCells.label","Format Cells"),code:"undoredo.notebooks.onWillExecuteFormat"})}finally{t.dispose()}}};v=h([c(0,M),c(1,K),c(2,R),c(3,W),c(4,X),c(5,ne)],v);let b=class extends z{constructor(r,t){super();this.instantiationService=r;this.notebookExecutionService=t;this.registerKernelExecutionParticipants()}registerKernelExecutionParticipants(){this._register(this.notebookExecutionService.registerExecutionParticipant(this.instantiationService.createInstance(v)))}};b=h([c(0,C),c(1,ie)],b);const se=Z.as($.Workbench);se.registerWorkbenchContribution(b,ce.Restored);export{b as CellExecutionParticipantsContribution};
