import{Emitter as u}from"../../../../../base/common/event.js";import{Disposable as C,MutableDisposable as S,dispose as c}from"../../../../../base/common/lifecycle.js";import{Mimes as g}from"../../../../../base/common/mime.js";import{Range as m}from"../../../../../editor/common/core/range.js";import{Selection as p}from"../../../../../editor/common/core/selection.js";import*as v from"../../../../../editor/common/editorCommon.js";import{SearchParams as x}from"../../../../../editor/common/model/textModelSearch.js";import{readTransientState as D,writeTransientState as E}from"../../../codeEditor/browser/toggleWordWrap.js";import{InlineChatController as M}from"../../../inlineChat/browser/inlineChatController.js";import{CellEditState as f,CellFocusMode as _,CursorAtBoundary as a,CursorAtLineBoundary as d}from"../notebookBrowser.js";class k extends C{constructor(e,t,i,o,r,n,s,l){super();this.viewType=e;this.model=t;this.id=i;this._viewContext=o;this._configurationService=r;this._modelService=n;this._undoRedoService=s;this._codeEditorService=l;this._register(t.onDidChangeMetadata(()=>{this._onDidChangeState.fire({metadataChanged:!0})})),this._register(t.onDidChangeInternalMetadata(h=>{this._onDidChangeState.fire({internalMetadataChanged:!0}),h.lastRunSuccessChanged&&this.layoutChange({})})),this._register(this._configurationService.onDidChangeConfiguration(h=>{h.affectsConfiguration("notebook.lineNumbers")&&(this.lineNumbers="inherit")})),this.model.collapseState?.inputCollapsed&&(this._inputCollapsed=!0),this.model.collapseState?.outputCollapsed&&(this._outputCollapsed=!0),this._commentOptions=this._configurationService.getValue("editor.comments",{overrideIdentifier:this.language}),this._register(this._configurationService.onDidChangeConfiguration(h=>{h.affectsConfiguration("editor.comments")&&(this._commentOptions=this._configurationService.getValue("editor.comments",{overrideIdentifier:this.language}))}))}_onDidChangeEditorAttachState=this._register(new u);onDidChangeEditorAttachState=this._onDidChangeEditorAttachState.event;_onDidChangeState=this._register(new u);onDidChangeState=this._onDidChangeState.event;get handle(){return this.model.handle}get uri(){return this.model.uri}get lineCount(){return this.model.textBuffer.getLineCount()}get metadata(){return this.model.metadata}get internalMetadata(){return this.model.internalMetadata}get language(){return this.model.language}get mime(){if(typeof this.model.mime=="string")return this.model.mime;switch(this.language){case"markdown":return g.markdown;default:return g.text}}_editState=f.Preview;_lineNumbers="inherit";get lineNumbers(){return this._lineNumbers}set lineNumbers(e){e!==this._lineNumbers&&(this._lineNumbers=e,this._onDidChangeState.fire({cellLineNumberChanged:!0}))}_commentOptions;get commentOptions(){return this._commentOptions}set commentOptions(e){this._commentOptions=e}_focusMode=_.Container;get focusMode(){return this._focusMode}set focusMode(e){this._focusMode!==e&&(this._focusMode=e,this._onDidChangeState.fire({focusModeChanged:!0}))}_textEditor;get editorAttached(){return!!this._textEditor}_editorListeners=[];_editorViewStates=null;_editorTransientState=null;_resolvedCellDecorations=new Map;_textModelRefChangeDisposable=this._register(new S);_cellDecorationsChanged=this._register(new u);onCellDecorationsChanged=this._cellDecorationsChanged.event;_resolvedDecorations=new Map;_lastDecorationId=0;_cellStatusBarItems=new Map;_onDidChangeCellStatusBarItems=this._register(new u);onDidChangeCellStatusBarItems=this._onDidChangeCellStatusBarItems.event;_lastStatusBarId=0;get textModel(){return this.model.textModel}hasModel(){return!!this.textModel}_dragging=!1;get dragging(){return this._dragging}set dragging(e){this._dragging=e,this._onDidChangeState.fire({dragStateChanged:!0})}_textModelRef;_inputCollapsed=!1;get isInputCollapsed(){return this._inputCollapsed}set isInputCollapsed(e){this._inputCollapsed=e,this._onDidChangeState.fire({inputCollapsedChanged:!0})}_outputCollapsed=!1;get isOutputCollapsed(){return this._outputCollapsed}set isOutputCollapsed(e){this._outputCollapsed=e,this._onDidChangeState.fire({outputCollapsedChanged:!0})}_commentHeight=0;set commentHeight(e){this._commentHeight!==e&&(this._commentHeight=e,this.layoutChange({commentHeight:!0},"BaseCellViewModel#commentHeight"))}_isDisposed=!1;assertTextModelAttached(){return!!(this.textModel&&this._textEditor&&this._textEditor.getModel()===this.textModel)}attachTextEditor(e,t){if(!e.hasModel())throw new Error("Invalid editor: model is missing");if(this._textEditor===e){this._editorListeners.length===0&&(this._editorListeners.push(this._textEditor.onDidChangeCursorSelection(()=>{this._onDidChangeState.fire({selectionChanged:!0})})),this._onDidChangeState.fire({selectionChanged:!0}));return}if(this._textEditor=e,this._editorViewStates?this._restoreViewState(this._editorViewStates):t&&this._restoreViewState({contributionsState:{},cursorState:[],viewState:{scrollLeft:0,firstPosition:{lineNumber:1,column:1},firstPositionDeltaTop:this._viewContext.notebookOptions.getLayoutConfiguration().editorTopPadding}}),this._editorTransientState&&E(e.getModel(),this._editorTransientState,this._codeEditorService),this._isDisposed)return;e.changeDecorations(o=>{this._resolvedDecorations.forEach((r,n)=>{if(n.startsWith("_lazy_")){const s=o.addDecoration(r.options.range,r.options.options);this._resolvedDecorations.get(n).id=s}else{const s=o.addDecoration(r.options.range,r.options.options);this._resolvedDecorations.get(n).id=s}})}),this._editorListeners.push(e.onDidChangeCursorSelection(()=>{this._onDidChangeState.fire({selectionChanged:!0})}));const i=M.get(this._textEditor);i&&this._editorListeners.push(i.onWillStartSession(()=>{this.textBuffer.getLength()===0&&this.enableAutoLanguageDetection()})),this._onDidChangeState.fire({selectionChanged:!0}),this._onDidChangeEditorAttachState.fire()}detachTextEditor(){this.saveViewState(),this.saveTransientState(),this._textEditor?.changeDecorations(e=>{this._resolvedDecorations.forEach(t=>{const i=t.id;i&&e.removeDecoration(i)})}),this._textEditor=void 0,c(this._editorListeners),this._editorListeners=[],this._onDidChangeEditorAttachState.fire(),this._textModelRef&&(this._textModelRef.dispose(),this._textModelRef=void 0),this._textModelRefChangeDisposable.clear()}getText(){return this.model.getValue()}getAlternativeId(){return this.model.alternativeId}getTextLength(){return this.model.getTextLength()}enableAutoLanguageDetection(){this.model.enableAutoLanguageDetection()}saveViewState(){this._textEditor&&(this._editorViewStates=this._textEditor.saveViewState())}saveTransientState(){!this._textEditor||!this._textEditor.hasModel()||(this._editorTransientState=D(this._textEditor.getModel(),this._codeEditorService))}saveEditorViewState(){return this._textEditor&&(this._editorViewStates=this._textEditor.saveViewState()),this._editorViewStates}restoreEditorViewState(e,t){this._editorViewStates=e}_restoreViewState(e){e&&this._textEditor?.restoreViewState(e)}addModelDecoration(e){if(!this._textEditor){const i=++this._lastDecorationId,o=`_lazy_${this.id};${i}`;return this._resolvedDecorations.set(o,{options:e}),o}let t;return this._textEditor.changeDecorations(i=>{t=i.addDecoration(e.range,e.options),this._resolvedDecorations.set(t,{id:t,options:e})}),t}removeModelDecoration(e){const t=this._resolvedDecorations.get(e);this._textEditor&&t&&t.id!==void 0&&this._textEditor.changeDecorations(i=>{i.removeDecoration(t.id)}),this._resolvedDecorations.delete(e)}deltaModelDecorations(e,t){return e.forEach(o=>{this.removeModelDecoration(o)}),t.map(o=>this.addModelDecoration(o))}_removeCellDecoration(e){const t=this._resolvedCellDecorations.get(e);if(this._resolvedCellDecorations.delete(e),t){for(const i of this._resolvedCellDecorations.values())t.className===i.className&&(t.className=void 0),t.outputClassName===i.outputClassName&&(t.outputClassName=void 0),t.gutterClassName===i.gutterClassName&&(t.gutterClassName=void 0),t.topClassName===i.topClassName&&(t.topClassName=void 0);this._cellDecorationsChanged.fire({added:[],removed:[t]})}}_addCellDecoration(e){const t=++this._lastDecorationId,i=`_cell_${this.id};${t}`;return this._resolvedCellDecorations.set(i,e),this._cellDecorationsChanged.fire({added:[e],removed:[]}),i}getCellDecorations(){return[...this._resolvedCellDecorations.values()]}getCellDecorationRange(e){return this._textEditor?this._textEditor.getModel()?.getDecorationRange(e)??null:null}deltaCellDecorations(e,t){return e.forEach(o=>{this._removeCellDecoration(o)}),t.map(o=>this._addCellDecoration(o))}deltaCellStatusBarItems(e,t){e.forEach(o=>{this._cellStatusBarItems.get(o)&&this._cellStatusBarItems.delete(o)});const i=t.map(o=>{const r=++this._lastStatusBarId,n=`_cell_${this.id};${r}`;return this._cellStatusBarItems.set(n,o),n});return this._onDidChangeCellStatusBarItems.fire(),i}getCellStatusBarItems(){return Array.from(this._cellStatusBarItems.values())}revealRangeInCenter(e){this._textEditor?.revealRangeInCenter(e,v.ScrollType.Immediate)}setSelection(e){this._textEditor?.setSelection(e)}setSelections(e){e.length&&(this._textEditor?this._textEditor?.setSelections(e):this._editorViewStates&&(this._editorViewStates.cursorState=e.map(t=>({inSelectionMode:!t.isEmpty(),selectionStart:t.getStartPosition(),position:t.getEndPosition()}))))}getSelections(){return this._textEditor?.getSelections()??this._editorViewStates?.cursorState.map(e=>new p(e.selectionStart.lineNumber,e.selectionStart.column,e.position.lineNumber,e.position.column))??[]}getSelectionsStartPosition(){return this._textEditor?this._textEditor.getSelections()?.map(t=>t.getStartPosition()):this._editorViewStates?.cursorState?.map(t=>t.selectionStart)}getLineScrollTopOffset(e){if(!this._textEditor)return 0;const t=this._viewContext.notebookOptions.computeEditorPadding(this.internalMetadata,this.uri);return this._textEditor.getTopForLineNumber(e)+t.top}getPositionScrollTopOffset(e){if(!this._textEditor)return 0;const t=e instanceof p?e.getPosition():e.getStartPosition(),i=this._viewContext.notebookOptions.computeEditorPadding(this.internalMetadata,this.uri);return this._textEditor.getTopForPosition(t.lineNumber,t.column)+i.top}cursorAtLineBoundary(){if(!this._textEditor||!this.textModel||!this._textEditor.hasTextFocus())return d.None;const e=this._textEditor.getSelection();if(!e||!e.isEmpty())return d.None;const t=this.textModel.getLineLength(e.startLineNumber);if(t===0)return d.Both;switch(e.startColumn){case 1:return d.Start;case t+1:return d.End;default:return d.None}}cursorAtBoundary(){if(!this._textEditor)return a.None;if(!this.textModel)return a.None;const e=this._textEditor.getSelection();if(!e||!e.isEmpty())return a.None;const t=this._textEditor.getTopForPosition(1,1),i=this._textEditor.getTopForPosition(this.textModel.getLineCount(),this.textModel.getLineLength(this.textModel.getLineCount())),o=this._textEditor.getTopForPosition(e.startLineNumber,e.startColumn);return o===i?o===t?a.Both:a.Bottom:o===t?a.Top:a.None}_editStateSource="";get editStateSource(){return this._editStateSource}updateEditState(e,t){this._editStateSource=t,e!==this._editState&&(this._editState=e,this._onDidChangeState.fire({editStateChanged:!0}),this._editState===f.Preview&&(this.focusMode=_.Container))}getEditState(){return this._editState}get textBuffer(){return this.model.textBuffer}async resolveTextModel(){if(!this._textModelRef||!this.textModel){if(this._textModelRef=await this._modelService.createModelReference(this.uri),this._isDisposed)return this.textModel;if(!this._textModelRef)throw new Error(`Cannot resolve text model for ${this.uri}`);this._textModelRefChangeDisposable.value=this.textModel.onDidChangeContent(()=>this.onDidChangeTextModelContent())}return this.textModel}cellStartFind(e,t){let i=[];const o=this.textBuffer.getLineCount(),r=t.findScope?.selectedTextRanges??[new m(1,1,o,this.textBuffer.getLineLength(o)+1)];if(this.assertTextModelAttached())i=this.textModel.findMatches(e,r,t.regex||!1,t.caseSensitive||!1,t.wholeWord&&t.wordSeparators||null,t.regex||!1);else{const s=new x(e,t.regex||!1,t.caseSensitive||!1,t.wholeWord&&t.wordSeparators||null).parseSearchRequest();if(!s)return null;r.forEach(l=>{i.push(...this.textBuffer.findMatchesLineByLine(new m(l.startLineNumber,l.startColumn,l.endLineNumber,l.endColumn),s,t.regex||!1,1e3))})}return i}dispose(){this._isDisposed=!0,super.dispose(),c(this._editorListeners),this._undoRedoService.getUriComparisonKey(this.uri)===this.uri.toString()&&this._undoRedoService.removeElements(this.uri),this._textModelRef?.dispose()}toJSON(){return{handle:this.handle}}}export{k as BaseCellViewModel};
