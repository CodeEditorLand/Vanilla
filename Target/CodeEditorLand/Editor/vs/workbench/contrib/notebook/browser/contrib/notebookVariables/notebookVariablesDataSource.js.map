{
  "version": 3,
  "sources": ["../../../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/contrib/notebook/browser/contrib/notebookVariables/notebookVariablesDataSource.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { IAsyncDataSource } from '../../../../../../base/browser/ui/tree/tree.js';\nimport { CancellationTokenSource } from '../../../../../../base/common/cancellation.js';\nimport { localize } from '../../../../../../nls.js';\nimport { NotebookTextModel } from '../../../common/model/notebookTextModel.js';\nimport { INotebookKernel, INotebookKernelService, VariablesResult, variablePageSize } from '../../../common/notebookKernelService.js';\n\nexport interface INotebookScope {\n\tkind: 'root';\n\treadonly notebook: NotebookTextModel;\n}\n\nexport interface INotebookVariableElement {\n\tkind: 'variable';\n\treadonly id: string;\n\treadonly extHostId: number;\n\treadonly name: string;\n\treadonly value: string;\n\treadonly type?: string;\n\treadonly interfaces?: string[];\n\treadonly expression?: string;\n\treadonly language?: string;\n\treadonly indexedChildrenCount: number;\n\treadonly indexStart?: number;\n\treadonly hasNamedChildren: boolean;\n\treadonly notebook: NotebookTextModel;\n\treadonly extensionId?: string;\n}\n\nexport class NotebookVariableDataSource implements IAsyncDataSource<INotebookScope, INotebookVariableElement> {\n\n\tprivate cancellationTokenSource: CancellationTokenSource;\n\n\tconstructor(private readonly notebookKernelService: INotebookKernelService) {\n\t\tthis.cancellationTokenSource = new CancellationTokenSource();\n\t}\n\n\thasChildren(element: INotebookScope | INotebookVariableElement): boolean {\n\t\treturn element.kind === 'root' || element.hasNamedChildren || element.indexedChildrenCount > 0;\n\t}\n\n\tpublic cancel(): void {\n\t\tthis.cancellationTokenSource.cancel();\n\t\tthis.cancellationTokenSource.dispose();\n\t\tthis.cancellationTokenSource = new CancellationTokenSource();\n\t}\n\n\tasync getChildren(element: INotebookScope | INotebookVariableElement): Promise<Array<INotebookVariableElement>> {\n\t\tif (element.kind === 'root') {\n\t\t\treturn this.getRootVariables(element.notebook);\n\t\t} else {\n\t\t\treturn this.getVariables(element);\n\t\t}\n\t}\n\n\tprivate async getVariables(parent: INotebookVariableElement): Promise<INotebookVariableElement[]> {\n\t\tconst selectedKernel = this.notebookKernelService.getMatchingKernel(parent.notebook).selected;\n\t\tif (selectedKernel && selectedKernel.hasVariableProvider) {\n\n\t\t\tlet children: INotebookVariableElement[] = [];\n\t\t\tif (parent.hasNamedChildren) {\n\t\t\t\tconst variables = selectedKernel.provideVariables(parent.notebook.uri, parent.extHostId, 'named', 0, this.cancellationTokenSource.token);\n\t\t\t\tconst childNodes = await variables\n\t\t\t\t\t.map(variable => { return this.createVariableElement(variable, parent.notebook); })\n\t\t\t\t\t.toPromise();\n\t\t\t\tchildren = children.concat(childNodes);\n\t\t\t}\n\t\t\tif (parent.indexedChildrenCount > 0) {\n\t\t\t\tconst childNodes = await this.getIndexedChildren(parent, selectedKernel);\n\t\t\t\tchildren = children.concat(childNodes);\n\t\t\t}\n\n\t\t\treturn children;\n\t\t}\n\t\treturn [];\n\t}\n\n\tprivate async getIndexedChildren(parent: INotebookVariableElement, kernel: INotebookKernel) {\n\t\tconst childNodes: INotebookVariableElement[] = [];\n\n\t\tif (parent.indexedChildrenCount > variablePageSize) {\n\n\t\t\tconst nestedPageSize = Math.floor(Math.max(parent.indexedChildrenCount / variablePageSize, 100));\n\n\t\t\tconst indexedChildCountLimit = 1_000_000;\n\t\t\tlet start = parent.indexStart ?? 0;\n\t\t\tconst last = start + Math.min(parent.indexedChildrenCount, indexedChildCountLimit);\n\t\t\tfor (; start < last; start += nestedPageSize) {\n\t\t\t\tlet end = start + nestedPageSize;\n\t\t\t\tif (end > last) {\n\t\t\t\t\tend = last;\n\t\t\t\t}\n\n\t\t\t\tchildNodes.push({\n\t\t\t\t\tkind: 'variable',\n\t\t\t\t\tnotebook: parent.notebook,\n\t\t\t\t\tid: parent.id + `${start}`,\n\t\t\t\t\textHostId: parent.extHostId,\n\t\t\t\t\tname: `[${start}..${end - 1}]`,\n\t\t\t\t\tvalue: '',\n\t\t\t\t\tindexedChildrenCount: end - start,\n\t\t\t\t\tindexStart: start,\n\t\t\t\t\thasNamedChildren: false\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (parent.indexedChildrenCount > indexedChildCountLimit) {\n\t\t\t\tchildNodes.push({\n\t\t\t\t\tkind: 'variable',\n\t\t\t\t\tnotebook: parent.notebook,\n\t\t\t\t\tid: parent.id + `${last + 1}`,\n\t\t\t\t\textHostId: parent.extHostId,\n\t\t\t\t\tname: localize('notebook.indexedChildrenLimitReached', \"Display limit reached\"),\n\t\t\t\t\tvalue: '',\n\t\t\t\t\tindexedChildrenCount: 0,\n\t\t\t\t\thasNamedChildren: false\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\telse if (parent.indexedChildrenCount > 0) {\n\t\t\tconst variables = kernel.provideVariables(parent.notebook.uri, parent.extHostId, 'indexed', parent.indexStart ?? 0, this.cancellationTokenSource.token);\n\n\t\t\tfor await (const variable of variables) {\n\t\t\t\tchildNodes.push(this.createVariableElement(variable, parent.notebook));\n\t\t\t\tif (childNodes.length >= variablePageSize) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t}\n\t\treturn childNodes;\n\t}\n\n\tprivate async getRootVariables(notebook: NotebookTextModel): Promise<INotebookVariableElement[]> {\n\t\tconst selectedKernel = this.notebookKernelService.getMatchingKernel(notebook).selected;\n\t\tif (selectedKernel && selectedKernel.hasVariableProvider) {\n\t\t\tconst variables = selectedKernel.provideVariables(notebook.uri, undefined, 'named', 0, this.cancellationTokenSource.token);\n\t\t\treturn await variables\n\t\t\t\t.map(variable => { return this.createVariableElement(variable, notebook); })\n\t\t\t\t.toPromise();\n\t\t}\n\n\t\treturn [];\n\t}\n\n\tprivate createVariableElement(variable: VariablesResult, notebook: NotebookTextModel): INotebookVariableElement {\n\t\treturn {\n\t\t\t...variable,\n\t\t\tkind: 'variable',\n\t\t\tnotebook,\n\t\t\textHostId: variable.id,\n\t\t\tid: `${variable.id}`\n\t\t};\n\t}\n}\n"],
  "mappings": "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",
  "names": []
}
