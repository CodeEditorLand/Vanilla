import{ResourceTextEdit as N}from"../../../../../editor/browser/services/bulkEditService.js";import{Position as S}from"../../../../../editor/common/core/position.js";import{Range as y}from"../../../../../editor/common/core/range.js";import{PLAINTEXT_LANGUAGE_ID as k}from"../../../../../editor/common/languages/modesRegistry.js";import{EndOfLinePreference as K}from"../../../../../editor/common/model.js";import{localize as A}from"../../../../../nls.js";import{ResourceNotebookCellEdit as b}from"../../../bulkEdit/browser/bulkCellEdits.js";import{cloneNotebookCellTextModel as E}from"../../common/model/notebookCellTextModel.js";import{CellEditType as p,CellKind as w,SelectionStateType as f}from"../../common/notebookCommon.js";import{cellRangeContains as h,cellRangesToIndexes as M}from"../../common/notebookRange.js";import{CellEditState as v,CellFocusMode as R,expandCellRangesWithHiddenCells as F}from"../notebookBrowser.js";async function X(o,l,t,i){const{notebookEditor:e}=l;if(e.hasModel()&&!e.isReadOnly){if(l.ui&&l.cell){const{cell:s}=l;if(s.cellKind===o)return;const c=s.getText(),n=e.getCellIndex(s);t===void 0&&(t=(e.activeKernel?.supportedLanguages??[])[0]??k),e.textModel.applyEdits([{editType:p.Replace,index:n,count:1,cells:[{cellKind:o,source:c,language:t,mime:i??s.mime,outputs:s.model.outputs,metadata:s.metadata}]}],!0,{kind:f.Index,focus:e.getFocus(),selections:e.getSelections()},()=>({kind:f.Index,focus:e.getFocus(),selections:e.getSelections()}),void 0,!0);const u=e.cellAt(n);await e.focusNotebookCell(u,s.getEditState()===v.Editing?"editor":"container")}else if(l.selectedCells){const s=l.selectedCells,c=[];s.forEach(n=>{if(n.cellKind===o)return;const u=n.getText(),d=e.getCellIndex(n);t===void 0&&(t=(e.activeKernel?.supportedLanguages??[])[0]??k),c.push({editType:p.Replace,index:d,count:1,cells:[{cellKind:o,source:u,language:t,mime:i??n.mime,outputs:n.model.outputs,metadata:n.metadata}]})}),e.textModel.applyEdits(c,!0,{kind:f.Index,focus:e.getFocus(),selections:e.getSelections()},()=>({kind:f.Index,focus:e.getFocus(),selections:e.getSelections()}),void 0,!0)}}}function Q(o,l){const t=o.textModel,i=o.getSelections(),e=o.getCellIndex(l),s=i.find(n=>n.start<=e&&e<n.end),c=!o.isReadOnly||t.viewType==="interactive";if(s){const n=i.reverse().map(d=>({editType:p.Replace,index:d.start,count:d.end-d.start,cells:[]})),u=s.end>=o.getLength()?void 0:o.cellAt(s.end);t.applyEdits(n,!0,{kind:f.Index,focus:o.getFocus(),selections:o.getSelections()},()=>{if(u){const d=t.cells.findIndex(r=>r.handle===u.handle);return{kind:f.Index,focus:{start:d,end:d+1},selections:[{start:d,end:d+1}]}}else if(t.length){const d=t.length-1;return{kind:f.Index,focus:{start:d,end:d+1},selections:[{start:d,end:d+1}]}}else return{kind:f.Index,focus:{start:0,end:0},selections:[{start:0,end:0}]}},void 0,c)}else{const n=o.getFocus(),u=[{editType:p.Replace,index:e,count:1,cells:[]}],d=[];for(let r=0;r<i.length;r++){const a=i[r];a.end<=e?d.push(a):a.start>e?d.push({start:a.start-1,end:a.end-1}):d.push({start:e,end:e+1})}if(o.cellAt(n.start)===l){const r=n.end===t.length?{start:n.start-1,end:n.end-1}:n;t.applyEdits(u,!0,{kind:f.Index,focus:o.getFocus(),selections:o.getSelections()},()=>({kind:f.Index,focus:r,selections:d}),void 0,c)}else{const r=n.start>e?{start:n.start-1,end:n.end-1}:n;t.applyEdits(u,!0,{kind:f.Index,focus:o.getFocus(),selections:o.getSelections()},()=>({kind:f.Index,focus:r,selections:d}),void 0,c)}}}async function Y(o,l){if(!o.notebookEditor.hasModel())return;const t=o.notebookEditor,i=t.textModel;if(t.isReadOnly)return;let e;if(o.cell){const s=t.getCellIndex(o.cell);e={start:s,end:s+1}}else{const s=t.getSelections();e=F(t,s)[0]}if(!(!e||e.start===e.end))if(l==="up"){if(e.start===0)return;const s=e.start-1,c={start:e.start-1,end:e.end-1},n=o.notebookEditor.getFocus(),u=h(e,n)?{start:n.start-1,end:n.end-1}:{start:e.start-1,end:e.start};i.applyEdits([{editType:p.Move,index:s,length:1,newIdx:e.end-1}],!0,{kind:f.Index,focus:t.getFocus(),selections:t.getSelections()},()=>({kind:f.Index,focus:u,selections:[c]}),void 0,!0);const d=t.getSelections()[0]??t.getFocus();t.revealCellRangeInView(d)}else{if(e.end>=i.length)return;const s=e.end,c={start:e.start+1,end:e.end+1},n=t.getFocus(),u=h(e,n)?{start:n.start+1,end:n.end+1}:{start:e.start+1,end:e.start+2};i.applyEdits([{editType:p.Move,index:s,length:1,newIdx:e.start}],!0,{kind:f.Index,focus:t.getFocus(),selections:t.getSelections()},()=>({kind:f.Index,focus:u,selections:[c]}),void 0,!0);const d=t.getSelections()[0]??t.getFocus();t.revealCellRangeInView(d)}}async function Z(o,l){const t=o.notebookEditor;if(!t.hasModel())return;const i=t.textModel;if(t.isReadOnly)return;let e;if(o.ui){const s=o.cell,c=t.getCellIndex(s);e={start:c,end:c+1}}else{const s=t.getSelections();e=F(t,s)[0]}if(!(!e||e.start===e.end))if(l==="up"){const s=t.getFocus(),c=t.getSelections();i.applyEdits([{editType:p.Replace,index:e.end,count:0,cells:M([e]).map(n=>E(t.cellAt(n).model))}],!0,{kind:f.Index,focus:s,selections:c},()=>({kind:f.Index,focus:s,selections:c}),void 0,!0)}else{const s=t.getFocus(),c=t.getSelections(),u=M([e]).map(g=>E(t.cellAt(g).model)).length,d=o.ui?s:{start:s.start+u,end:s.end+u},r=o.ui?c:[{start:e.start+u,end:e.end+u}];i.applyEdits([{editType:p.Replace,index:e.end,count:0,cells:M([e]).map(g=>E(t.cellAt(g).model))}],!0,{kind:f.Index,focus:s,selections:c},()=>({kind:f.Index,focus:d,selections:r}),void 0,!0);const a=t.getSelections()[0]??t.getFocus();t.revealCellRangeInView(a)}}async function $(o,l,t){const i=t.notebookEditor;if(i.isReadOnly)return;const e=[],s=[];for(const a of i.getSelections())s.push(...i.getCellsInRange(a));if(s.length<=1)return;const c=s[0].cellKind;if(!s.every(a=>a.cellKind===c)){const a=A("notebookActions.joinSelectedCells","Cannot join cells of different kinds");return l.warn(a)}const u=s[0],d=s.map(a=>a.getText()).join(u.textBuffer.getEOL()),r=i.getSelections()[0];e.push(new b(i.textModel.uri,{editType:p.Replace,index:r.start,count:r.end-r.start,cells:[{cellKind:u.cellKind,source:d,language:u.language,mime:u.mime,outputs:u.model.outputs,metadata:u.metadata}]}));for(const a of i.getSelections().slice(1))e.push(new b(i.textModel.uri,{editType:p.Replace,index:a.start,count:a.end-a.start,cells:[]}));e.length&&await o.apply(e,{quotableLabel:A("notebookActions.joinSelectedCells.label","Join Notebook Cells")})}async function T(o,l,t,i){if(o.isReadOnly)return null;const e=o.textModel,s=o.getCellsInRange(l);if(!s.length||l.start===0&&t==="above"||l.end===e.length&&t==="below")return null;for(let c=0;c<s.length;c++){const n=s[c];if(i&&n.cellKind!==i)return null}if(t==="above"){const c=o.cellAt(l.start-1);if(i&&c.cellKind!==i)return null;const n=s.map(r=>(r.textBuffer.getEOL()??"")+r.getText()).join(""),u=c.textBuffer.getLineCount(),d=c.textBuffer.getLineLength(u);return{edits:[new N(c.uri,{range:new y(u,d+1,u,d+1),text:n}),new b(e.uri,{editType:p.Replace,index:l.start,count:l.end-l.start,cells:[]})],cell:c,endFocus:{start:l.start-1,end:l.start},endSelections:[{start:l.start-1,end:l.start}]}}else{const c=o.cellAt(l.end);if(i&&c.cellKind!==i)return null;const n=s[0],d=[...s.slice(1),c].map(g=>(g.textBuffer.getEOL()??"")+g.getText()).join(""),r=n.textBuffer.getLineCount(),a=n.textBuffer.getLineLength(r);return{edits:[new N(n.uri,{range:new y(r,a+1,r,a+1),text:d}),new b(e.uri,{editType:p.Replace,index:l.start+1,count:l.end-l.start,cells:[]})],cell:n,endFocus:{start:l.start,end:l.start+1},endSelections:[{start:l.start,end:l.start+1}]}}}async function ee(o,l,t){const i=l.notebookEditor,e=i.textModel,s=i.getViewModel();let c=null;if(l.ui){const n=l.cell.focusMode,u=i.getCellIndex(l.cell);if(c=await T(i,{start:u,end:u+1},t),!c)return;await o.apply(c?.edits,{quotableLabel:"Join Notebook Cells"}),s.updateSelectionsState({kind:f.Index,focus:c.endFocus,selections:c.endSelections}),c.cell.updateEditState(v.Editing,"joinCellsWithSurrounds"),i.revealCellRangeInView(i.getFocus()),n===R.Editor&&(c.cell.focusMode=R.Editor)}else{const n=i.getSelections();if(!n.length)return;const u=i.getFocus(),d=i.cellAt(u.start)?.focusMode,r=[];let a=null;const g=[];for(let C=n.length-1;C>=0;C--){const m=n[C],L=h(m,u);if(m.end>=e.length&&t==="below"||m.start===0&&t==="above"){L&&(a=i.cellAt(u.start)),g.push(...i.getCellsInRange(m));continue}const x=await T(i,m,t);if(!x)return;r.push(...x.edits),g.push(x.cell),L&&(a=x.cell)}if(!r.length||!a||!g.length)return;await o.apply(r,{quotableLabel:"Join Notebook Cells"}),g.forEach(C=>{C.updateEditState(v.Editing,"joinCellsWithSurrounds")}),s.updateSelectionsState({kind:f.Handle,primary:a.handle,selections:g.map(C=>C.handle)}),i.revealCellRangeInView(i.getFocus());const I=i.cellAt(i.getFocus().start);d===R.Editor&&I&&(I.focusMode=R.Editor)}}function V(o,l){const t=[],i=l.getLineCount(),e=n=>l.getLineLength(n);o=o.sort((n,u)=>{const d=n.lineNumber-u.lineNumber,r=n.column-u.column;return d!==0?d:r});for(let n of o)e(n.lineNumber)+1===n.column&&n.column!==1&&n.lineNumber<i&&(n=new S(n.lineNumber+1,1)),B(t,n);if(t.length===0)return null;const s=new S(1,1),c=new S(i,e(i)+1);return[s,...t,c]}function B(o,l){const t=o.length>0?o[o.length-1]:void 0;(!t||t.lineNumber!==l.lineNumber||t.column!==l.column)&&o.push(l)}function te(o,l){const t=V(l,o.textBuffer);if(!t)return null;const i=[];for(let e=1;e<t.length;e++){const s=t[e-1],c=t[e];i.push(o.textBuffer.getValueInRange(new y(s.lineNumber,s.column,c.lineNumber,c.column),K.TextDefined))}return i}function ne(o,l,t,i,e="above",s="",c=!1){const n=l.getViewModel(),u=l.activeKernel;if(n.options.isReadOnly)return null;const d=l.cellAt(t),r=c?n.getNextVisibleCellIndex(t):t+1;let a;if(i===w.Code){const I=u?.supportedLanguages??o.getRegisteredLanguageIds(),C=I[0]||k;if(d?.cellKind===w.Code)a=d.language;else if(d?.cellKind===w.Markup){const m=n.nearestCodeCellIndex(t);m>-1?a=n.cellAt(m).language:a=C}else d===void 0&&e==="above"?a=n.viewCells.find(m=>m.cellKind===w.Code)?.language||C:a=C;I.includes(a)||(a=C)}else a="markdown";return O(n,d?e==="above"?t:r:t,s,a,i,void 0,[],!0,!0)}function O(o,l,t,i,e,s,c,n,u){const d={kind:f.Index,focus:{start:l,end:l+1},selections:[{start:l,end:l+1}]};return o.notebookDocument.applyEdits([{editType:p.Replace,index:l,count:0,cells:[{cellKind:e,language:i,mime:void 0,outputs:c,metadata:s,source:t}]}],n,{kind:f.Index,focus:o.getFocus(),selections:o.getSelections()},()=>d,void 0,u&&!o.options.isReadOnly),o.cellAt(l)}export{X as changeCellToKind,te as computeCellLinesContents,Z as copyCellRange,ne as insertCell,O as insertCellAtIndex,ee as joinCellsWithSurrounds,T as joinNotebookCells,$ as joinSelectedCells,Y as moveCellRange,Q as runDeleteAction};
