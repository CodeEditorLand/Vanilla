var lt=Object.defineProperty;var ht=Object.getOwnPropertyDescriptor;var E=(m,e,t,o)=>{for(var i=o>1?void 0:o?ht(e,t):e,a=m.length-1,n;a>=0;a--)(n=m[a])&&(i=(o?n(e,t,i):n(i))||i);return o&&i&&lt(e,t,i),i},l=(m,e)=>(t,o)=>e(t,o,m);import*as d from"../../../../../base/browser/dom.js";import{Disposable as v,DisposableStore as H}from"../../../../../base/common/lifecycle.js";import{Schemas as $}from"../../../../../base/common/network.js";import{IInstantiationService as w}from"../../../../../platform/instantiation/common/instantiation.js";import{getFormattedOutputJSON as D,OutputComparison as Z,outputEqual as ut,OUTPUT_EDITOR_HEIGHT_MAGIC as K,PropertyFoldingState as g,SideBySideDiffElementViewModel as ct,NotebookDocumentMetadataViewModel as pt}from"./diffElementViewModel.js";import{DiffSide as _,DIFF_CELL_MARGIN as P,NOTEBOOK_DIFF_CELL_INPUT as ft,NOTEBOOK_DIFF_CELL_PROPERTY as gt,NOTEBOOK_DIFF_CELL_PROPERTY_EXPANDED as mt,NOTEBOOK_DIFF_CELL_IGNORE_WHITESPACE as _t,NOTEBOOK_DIFF_METADATA as Ct}from"./notebookDiffEditorBrowser.js";import{CodeEditorWidget as tt}from"../../../../../editor/browser/widget/codeEditor/codeEditorWidget.js";import{IModelService as U}from"../../../../../editor/common/services/model.js";import{ILanguageService as z}from"../../../../../editor/common/languages/language.js";import{CellEditType as yt,CellUri as j}from"../../common/notebookCommon.js";import"../../../../../base/browser/ui/toolbar/toolbar.js";import{IContextMenuService as O}from"../../../../../platform/contextview/browser/contextView.js";import{IMenuService as M,MenuId as S,MenuItemAction as St}from"../../../../../platform/actions/common/actions.js";import{IKeybindingService as x}from"../../../../../platform/keybinding/common/keybinding.js";import{INotificationService as k}from"../../../../../platform/notification/common/notification.js";import"../../../../../base/common/actions.js";import{createAndFillInActionBarActions as J}from"../../../../../platform/actions/browser/menuEntryActionViewItem.js";import{IContextKeyService as I}from"../../../../../platform/contextkey/common/contextkey.js";import{CodiconActionViewItem as Et}from"../view/cellParts/cellActionView.js";import{collapsedIcon as vt,expandedIcon as bt}from"../notebookIcons.js";import{OutputContainer as L}from"./diffElementOutputs.js";import{EditorExtensionsRegistry as Mt}from"../../../../../editor/browser/editorExtensions.js";import{ContextMenuController as It}from"../../../../../editor/contrib/contextmenu/browser/contextmenu.js";import{SnippetController2 as Ht}from"../../../../../editor/contrib/snippet/browser/snippetController2.js";import{SuggestController as wt}from"../../../../../editor/contrib/suggest/browser/suggestController.js";import{MenuPreventer as Dt}from"../../../codeEditor/browser/menuPreventer.js";import{SelectionClipboardContributionID as Ot}from"../../../codeEditor/browser/selectionClipboard.js";import{TabCompletionController as xt}from"../../../snippets/browser/tabCompletion.js";import{renderIcon as et,renderLabelWithIcons as it}from"../../../../../base/browser/ui/iconLabel/iconLabels.js";import"../../../../../editor/common/editorCommon.js";import{ITextModelService as T}from"../../../../../editor/common/services/resolverService.js";import{IConfigurationService as V}from"../../../../../platform/configuration/common/configuration.js";import{IThemeService as kt}from"../../../../../platform/theme/common/themeService.js";import{WorkbenchToolBar as Lt}from"../../../../../platform/actions/browser/toolbar.js";import{ITelemetryService as Tt}from"../../../../../platform/telemetry/common/telemetry.js";import{fixedDiffEditorOptions as G,fixedEditorOptions as ot,getEditorPadding as at}from"./diffCellEditorOptions.js";import{AccessibilityVerbositySettingId as Vt}from"../../../accessibility/browser/accessibilityConfiguration.js";import{IAccessibilityService as Rt}from"../../../../../platform/accessibility/common/accessibility.js";import{DiffEditorWidget as Y}from"../../../../../editor/browser/widget/diffEditor/diffEditorWidget.js";import{ICommandService as Ft}from"../../../../../platform/commands/common/commands.js";import"./diffNestedCellViewModel.js";import{localize as R}from"../../../../../nls.js";import{Emitter as nt}from"../../../../../base/common/event.js";import{ITextResourceConfigurationService as F}from"../../../../../editor/common/services/textResourceConfiguration.js";import{getFormattedMetadataJSON as dt}from"../../common/model/notebookCellTextModel.js";import"../../../../../editor/common/config/editorOptions.js";import{getUnchangedRegionSettings as q}from"./unchangedEditorRegions.js";function b(){return{isSimpleWidget:!1,contributions:Mt.getSomeEditorContributions([Dt.ID,Ot,It.ID,wt.ID,Ht.ID,xt.ID])}}class Ye extends v{constructor(e,t){super(),t.body.classList.remove("left","right","full");const o=e.hiddenCells.length===1?R("hiddenCell","{0} hidden cell",e.hiddenCells.length):R("hiddenCells","{0} hidden cells",e.hiddenCells.length);t.placeholder.innerText=o,this._register(d.addDisposableListener(t.placeholder,"dblclick",i=>{i.button===0&&(i.preventDefault(),e.showHiddenCells())})),this._register(t.marginOverlay.onAction(()=>e.showHiddenCells())),t.marginOverlay.show()}}let C=class extends v{constructor(t,o,i,a,n,r,s,h,c,u,p,f,y){super();this.cell=t;this.propertyHeaderContainer=o;this.notebookEditor=i;this.accessor=a;this.contextMenuService=n;this.keybindingService=r;this.commandService=s;this.notificationService=h;this.menuService=c;this.contextKeyService=u;this.themeService=p;this.telemetryService=f;this.accessibilityService=y}_foldingIndicator;_statusSpan;_description;_toolbar;_menu;_propertyExpanded;_propertyChanged;buildHeader(){this._foldingIndicator=d.append(this.propertyHeaderContainer,d.$(".property-folding-indicator")),this._foldingIndicator.classList.add(this.accessor.prefix);const t=d.append(this.propertyHeaderContainer,d.$("div.property-status"));this._statusSpan=d.append(t,d.$("span")),this._description=d.append(t,d.$("span.property-description"));const o=d.append(this.propertyHeaderContainer,d.$("div.property-toolbar"));this._toolbar=this._register(new Lt(o,{actionViewItemProvider:(a,n)=>{if(a instanceof St)return new Et(a,{hoverDelegate:n.hoverDelegate},this.keybindingService,this.notificationService,this.contextKeyService,this.themeService,this.contextMenuService,this.accessibilityService)}},this.menuService,this.contextKeyService,this.contextMenuService,this.keybindingService,this.commandService,this.telemetryService)),this._toolbar.context=this.cell;const i=this.contextKeyService.createScoped(o);this._register(i),this._propertyChanged=gt.bindTo(i),this._propertyExpanded=mt.bindTo(i),this._menu=this._register(this.menuService.createMenu(this.accessor.menuId,i)),this._register(this._menu.onDidChange(()=>this.updateMenu())),this._register(this.notebookEditor.onMouseUp(a=>{if(!a.event.target||a.target!==this.cell)return;const n=a.event.target;if(n===this.propertyHeaderContainer||n===this._foldingIndicator||this._foldingIndicator.contains(n)||n===t||t.contains(n)){const r=this.accessor.getFoldingState();this.accessor.updateFoldingState(r===g.Expanded?g.Collapsed:g.Expanded),this._updateFoldingIcon(),this.accessor.updateInfoRendering(this.cell.renderOutput)}})),this.refresh(),this.accessor.updateInfoRendering(this.cell.renderOutput)}refresh(){this.updateMenu(),this._updateFoldingIcon();const t=this.accessor.checkIfModified();this._propertyChanged&&this._propertyChanged.set(!!t),t?(this._statusSpan.textContent=this.accessor.changedLabel,this._statusSpan.style.fontWeight="bold",t.reason&&(this._description.textContent=t.reason),this.propertyHeaderContainer.classList.add("modified")):(this._statusSpan.textContent=this.accessor.unChangedLabel,this._statusSpan.style.fontWeight="normal",this._description.textContent="",this.propertyHeaderContainer.classList.remove("modified"))}updateMenu(){if(this.accessor.checkIfModified()){const o=[];J(this._menu,{shouldForwardArgs:!0},o),this._toolbar.setActions(o)}else this._toolbar.setActions([])}_updateFoldingIcon(){this.accessor.getFoldingState()===g.Collapsed?(d.reset(this._foldingIndicator,et(vt)),this._propertyExpanded?.set(!1)):(d.reset(this._foldingIndicator,et(bt)),this._propertyExpanded?.set(!0))}};C=E([l(4,O),l(5,x),l(6,Ft),l(7,k),l(8,M),l(9,I),l(10,kt),l(11,Tt),l(12,Rt)],C);let N=class extends v{constructor(t,o,i,a,n,r,s,h,c){super();this.notebookEditor=t;this.viewModel=o;this.templateData=i;this.instantiationService=a;this.textModelService=n;this.menuService=r;this.contextKeyService=s;this.textConfigurationService=h;this.configurationService=c;this._editor=i.sourceEditor,this._cellHeaderContainer=this.templateData.cellHeaderContainer,this._editorContainer=this.templateData.editorContainer,this._diffEditorContainer=this.templateData.diffEditorContainer,this._editorViewStateChanged=!1,this._register(o.onDidLayoutChange(u=>{this.layout(u),this.updateBorders()})),this.buildBody(),this.updateBorders()}_editor;_editorViewStateChanged;_toolbar;_cellHeaderContainer;_editorContainer;_cellHeader;_diffEditorContainer;buildBody(){const t=this.templateData.body;t.classList.remove("full"),t.classList.add("full"),this.updateSourceEditor(),this.viewModel instanceof pt&&this._register(this.viewModel.modifiedMetadata.onDidChange(o=>{this._cellHeader.refresh()}))}layoutNotebookCell(){this.notebookEditor.layoutNotebookCell(this.viewModel,this.viewModel.layoutInfo.totalHeight)}updateBorders(){this.templateData.leftBorder.style.height=`${this.viewModel.layoutInfo.totalHeight-32}px`,this.templateData.rightBorder.style.height=`${this.viewModel.layoutInfo.totalHeight-32}px`,this.templateData.bottomBorder.style.top=`${this.viewModel.layoutInfo.totalHeight-32}px`}updateSourceEditor(){this._cellHeaderContainer.style.display="flex",this._cellHeaderContainer.innerText="",this._editorContainer.classList.add("diff");const t=()=>{if(this.viewModel.cellFoldingState===g.Collapsed){this._editorContainer.style.display="none",this.viewModel.editorHeight=0;return}const r=this.notebookEditor.getLayoutInfo().fontInfo.lineHeight||17,s=this.viewModel.layoutInfo.editorHeight!==0?this.viewModel.layoutInfo.editorHeight:this.viewModel.computeInputEditorHeight(r);this._editorContainer.style.height=`${s}px`,this._editorContainer.style.display="block";const h=this._editor.getContentHeight();return h>=0&&(this.viewModel.editorHeight=h),s},o=()=>{const r=t();if(!r)return;const s=this.viewModel.modifiedMetadata.textBuffer.getLineCount(),h={padding:at(s)},c=this._register(q(this.configurationService));c.options.enabled&&(h.hideUnchangedRegions=c.options),this._editor.updateOptions(h),this._register(c.onDidChangeEnablement(()=>{h.hideUnchangedRegions=c.options,this._editor.updateOptions(h)})),this._editor.layout({width:this.notebookEditor.getLayoutInfo().width-2*P,height:r}),this._register(this._editor.onDidContentSizeChange(u=>{this.viewModel.cellFoldingState===g.Expanded&&u.contentHeightChanged&&this.viewModel.layoutInfo.editorHeight!==u.contentHeight&&(this.viewModel.editorHeight=u.contentHeight)})),this._initializeSourceDiffEditor()};this._cellHeader=this._register(this.instantiationService.createInstance(C,this.viewModel,this._cellHeaderContainer,this.notebookEditor,{updateInfoRendering:()=>o(),checkIfModified:()=>this.viewModel.originalMetadata.getHash()!==this.viewModel.modifiedMetadata.getHash()?{reason:void 0}:!1,getFoldingState:()=>this.viewModel.cellFoldingState,updateFoldingState:r=>this.viewModel.cellFoldingState=r,unChangedLabel:"Notebook Metadata",changedLabel:"Notebook Metadata changed",prefix:"metadata",menuId:S.NotebookDiffDocumentMetadata})),this._cellHeader.buildHeader(),o();const i=this.contextKeyService.createScoped(this.templateData.inputToolbarContainer);this._register(i);const a=Ct.bindTo(i);a.set(this.viewModel.originalMetadata.getHash()!==this.viewModel.modifiedMetadata.getHash()),this._toolbar=this.templateData.toolbar,this._toolbar.context=this.viewModel;const n=()=>{const r=this.viewModel.originalMetadata.getHash()!==this.viewModel.modifiedMetadata.getHash();if(a.set(r),r){const s=[],h=this.menuService.getMenuActions(S.NotebookDiffDocumentMetadata,i,{shouldForwardArgs:!0});J(h,s),this._toolbar.setActions(s)}else this._toolbar.setActions([])};this._register(this.viewModel.modifiedMetadata.onDidChange(()=>{n()})),n()}async _initializeSourceDiffEditor(){const[t,o]=await Promise.all([this.textModelService.createModelReference(this.viewModel.originalMetadata.uri),this.textModelService.createModelReference(this.viewModel.modifiedMetadata.uri)]);if(this._store.isDisposed){t.dispose(),o.dispose();return}this._register(t),this._register(o);const i=this._register(this._editor.createViewModel({original:t.object.textEditorModel,modified:o.object.textEditorModel}));await i.waitForDiff(),this._editor.setModel(i);const a=()=>{this._editorViewStateChanged=!0},n=h=>{(h.scrollTopChanged||h.scrollLeftChanged)&&(this._editorViewStateChanged=!0)};this.updateEditorOptionsForWhitespace(),this._register(this._editor.getOriginalEditor().onDidChangeCursorSelection(a)),this._register(this._editor.getOriginalEditor().onDidScrollChange(n)),this._register(this._editor.getModifiedEditor().onDidChangeCursorSelection(a)),this._register(this._editor.getModifiedEditor().onDidScrollChange(n));const r=this.viewModel.getSourceEditorViewState();r&&this._editor.restoreViewState(r);const s=this._editor.getContentHeight();this.viewModel.editorHeight=s}updateEditorOptionsForWhitespace(){const t=this._editor,o=t.getModel()?.modified.uri||t.getModel()?.original.uri;if(!o)return;const i=this.textConfigurationService.getValue(o,"diffEditor.ignoreTrimWhitespace");t.updateOptions({ignoreTrimWhitespace:i}),this._register(this.textConfigurationService.onDidChangeConfiguration(a=>{if(a.affectsConfiguration(o,"diffEditor")&&a.affectedKeys.has("diffEditor.ignoreTrimWhitespace")){const n=this.textConfigurationService.getValue(o,"diffEditor.ignoreTrimWhitespace");t.updateOptions({ignoreTrimWhitespace:n})}}))}layout(t){d.scheduleAtNextAnimationFrame(d.getWindow(this._diffEditorContainer),()=>{t.editorHeight&&(this._editorContainer.style.height=`${this.viewModel.layoutInfo.editorHeight}px`,this._editor.layout({width:this._editor.getViewWidth(),height:this.viewModel.layoutInfo.editorHeight})),t.outerWidth&&(this._editorContainer.style.height=`${this.viewModel.layoutInfo.editorHeight}px`,this._editor.layout()),this.layoutNotebookCell()})}dispose(){this._editor.setModel(null),this._editorViewStateChanged&&this.viewModel.saveSpirceEditorViewState(this._editor.saveViewState()),super.dispose()}};N=E([l(3,w),l(4,T),l(5,M),l(6,I),l(7,F),l(8,V)],N);class rt extends v{constructor(t,o,i,a,n,r,s,h,c,u,p,f,y,X,Nt){super();this.notebookEditor=t;this.cell=o;this.templateData=i;this.style=a;this.instantiationService=n;this.languageService=r;this.modelService=s;this.textModelService=h;this.contextMenuService=c;this.keybindingService=u;this.notificationService=p;this.menuService=f;this.contextKeyService=y;this.configurationService=X;this.textConfigurationService=Nt;this._isDisposed=!1,this._metadataEditorDisposeStore=this._register(new H),this._outputEditorDisposeStore=this._register(new H),this._register(o.onDidLayoutChange(Q=>{this.layout(Q)})),this._register(o.onDidLayoutChange(Q=>this.updateBorders())),this.init(),this.buildBody(),this._register(o.onDidStateChange(()=>{this.updateOutputRendering(this.cell.renderOutput)}))}_metadataLocalDisposable=this._register(new H);_outputLocalDisposable=this._register(new H);_ignoreMetadata=!1;_ignoreOutputs=!1;_cellHeaderContainer;_editorContainer;_cellHeader;_metadataHeaderContainer;_metadataHeader;_metadataInfoContainer;_metadataEditorContainer;_metadataEditorDisposeStore;_metadataEditor;_outputHeaderContainer;_outputHeader;_outputInfoContainer;_outputEditorContainer;_outputViewContainer;_outputLeftContainer;_outputRightContainer;_outputMetadataContainer;_outputEmptyElement;_outputLeftView;_outputRightView;_outputEditorDisposeStore;_outputEditor;_outputMetadataEditor;_diffEditorContainer;_diagonalFill;_isDisposed;buildBody(){const t=this.templateData.body;switch(this._diffEditorContainer=this.templateData.diffEditorContainer,t.classList.remove("left","right","full"),this.style){case"left":t.classList.add("left");break;case"right":t.classList.add("right");break;default:t.classList.add("full");break}this.styleContainer(this._diffEditorContainer),this.updateSourceEditor(),this.cell.modified&&this._register(this.cell.modified.textModel.onDidChangeContent(()=>this._cellHeader.refresh())),this._ignoreMetadata=this.configurationService.getValue("notebook.diff.ignoreMetadata"),this._ignoreMetadata?this._disposeMetadata():this._buildMetadata(),this._ignoreOutputs=this.configurationService.getValue("notebook.diff.ignoreOutputs")||!!this.notebookEditor.textModel?.transientOptions.transientOutputs,this._ignoreOutputs?this._disposeOutput():this._buildOutput(),this._register(this.configurationService.onDidChangeConfiguration(o=>{let i=!1,a=!1;if(o.affectsConfiguration("notebook.diff.ignoreMetadata")){const n=this.configurationService.getValue("notebook.diff.ignoreMetadata");n!==void 0&&this._ignoreMetadata!==n&&(this._ignoreMetadata=n,this._metadataLocalDisposable.clear(),this.configurationService.getValue("notebook.diff.ignoreMetadata")?this._disposeMetadata():(this.cell.metadataStatusHeight=25,this._buildMetadata(),this.updateMetadataRendering(),i=!0))}if(o.affectsConfiguration("notebook.diff.ignoreOutputs")){const n=this.configurationService.getValue("notebook.diff.ignoreOutputs");n!==void 0&&this._ignoreOutputs!==(n||this.notebookEditor.textModel?.transientOptions.transientOutputs)&&(this._ignoreOutputs=n||!!this.notebookEditor.textModel?.transientOptions.transientOutputs,this._outputLocalDisposable.clear(),this._ignoreOutputs?(this._disposeOutput(),this.cell.layoutChange()):(this.cell.outputStatusHeight=25,this._buildOutput(),a=!0))}(i||a)&&this.layout({metadataHeight:i,outputTotalHeight:a})}))}updateMetadataRendering(){this.cell.metadataFoldingState===g.Expanded?(this._metadataInfoContainer.style.display="block",!this._metadataEditorContainer||!this._metadataEditor?(this._metadataEditorContainer=d.append(this._metadataInfoContainer,d.$(".metadata-editor-container")),this._buildMetadataEditor()):this.cell.metadataHeight=this._metadataEditor.getContentHeight()):(this._metadataInfoContainer.style.display="none",this.cell.metadataHeight=0)}updateOutputRendering(t){this.cell.outputFoldingState===g.Expanded?(this._outputInfoContainer.style.display="block",t?(this._hideOutputsRaw(),this._buildOutputRendererContainer(),this._showOutputsRenderer(),this._showOutputsEmptyView()):(this._hideOutputsRenderer(),this._buildOutputRawContainer(),this._showOutputsRaw())):(this._outputInfoContainer.style.display="none",this._hideOutputsRaw(),this._hideOutputsRenderer(),this._hideOutputsEmptyView())}_buildOutputRawContainer(){this._outputEditorContainer||(this._outputEditorContainer=d.append(this._outputInfoContainer,d.$(".output-editor-container")),this._buildOutputEditor())}_showOutputsRaw(){this._outputEditorContainer&&(this._outputEditorContainer.style.display="block",this.cell.rawOutputHeight=this._outputEditor.getContentHeight())}_showOutputsEmptyView(){this.cell.layoutChange()}_hideOutputsRaw(){this._outputEditorContainer&&(this._outputEditorContainer.style.display="none",this.cell.rawOutputHeight=0)}_hideOutputsEmptyView(){this.cell.layoutChange()}_applySanitizedMetadataChanges(t,o){const i={};try{const a=JSON.parse(o),n=new Set([...Object.keys(a)]);for(const s of n)switch(s){case"inputCollapsed":case"outputCollapsed":typeof a[s]=="boolean"?i[s]=a[s]:i[s]=t[s];break;default:i[s]=a[s];break}const r=this.notebookEditor.textModel.cells.indexOf(this.cell.modified.textModel);if(r<0)return;this.notebookEditor.textModel.applyEdits([{editType:yt.Metadata,index:r,metadata:i}],!0,void 0,()=>{},void 0,!0)}catch{}}async _buildMetadataEditor(){if(this._metadataEditorDisposeStore.clear(),this.cell instanceof ct){this._metadataEditor=this.instantiationService.createInstance(Y,this._metadataEditorContainer,{...G,overflowWidgetsDomNode:this.notebookEditor.getOverflowContainerDomNode(),readOnly:!1,originalEditable:!1,ignoreTrimWhitespace:!1,automaticLayout:!1,dimension:{height:this.cell.layoutInfo.metadataHeight,width:this.cell.getComputedCellContainerWidth(this.notebookEditor.getLayoutInfo(),!0,!0)}},{originalEditor:b(),modifiedEditor:b()});const t=this._register(q(this.configurationService));t.options.enabled&&this._metadataEditor.updateOptions({hideUnchangedRegions:t.options}),this._metadataEditorDisposeStore.add(t.onDidChangeEnablement(()=>{this._metadataEditor&&this._metadataEditor.updateOptions({hideUnchangedRegions:t.options})})),this.layout({metadataHeight:!0}),this._metadataEditorDisposeStore.add(this._metadataEditor),this._metadataEditorContainer?.classList.add("diff");const[o,i]=await Promise.all([this.textModelService.createModelReference(j.generateCellPropertyUri(this.cell.originalDocument.uri,this.cell.original.handle,$.vscodeNotebookCellMetadata)),this.textModelService.createModelReference(j.generateCellPropertyUri(this.cell.modifiedDocument.uri,this.cell.modified.handle,$.vscodeNotebookCellMetadata))]);this._metadataEditorDisposeStore.add(o),this._metadataEditorDisposeStore.add(i);const a=this._metadataEditor.createViewModel({original:o.object.textEditorModel,modified:i.object.textEditorModel});await a.waitForDiff(),this._metadataEditor.setModel(a),this.cell.metadataHeight=this._metadataEditor.getContentHeight(),this._metadataEditorDisposeStore.add(this._metadataEditor.onDidContentSizeChange(r=>{r.contentHeightChanged&&this.cell.metadataFoldingState===g.Expanded&&(this.cell.metadataHeight=r.contentHeight)}));let n=!1;this._metadataEditorDisposeStore.add(i.object.textEditorModel.onDidChangeContent(()=>{n=!0;const r=i.object.textEditorModel.getValue();this._applySanitizedMetadataChanges(this.cell.modified.metadata,r),this._metadataHeader.refresh(),n=!1})),this._metadataEditorDisposeStore.add(this.cell.modified.textModel.onDidChangeMetadata(()=>{if(n)return;const r=dt(this.notebookEditor.textModel?.transientOptions.transientCellMetadata,this.cell.modified?.metadata||{},this.cell.modified?.language);i.object.textEditorModel.setValue(r)}));return}else{this._metadataEditor=this.instantiationService.createInstance(tt,this._metadataEditorContainer,{...ot,dimension:{width:this.cell.getComputedCellContainerWidth(this.notebookEditor.getLayoutInfo(),!1,!0),height:this.cell.layoutInfo.metadataHeight},overflowWidgetsDomNode:this.notebookEditor.getOverflowContainerDomNode(),readOnly:!1},{}),this.layout({metadataHeight:!0}),this._metadataEditorDisposeStore.add(this._metadataEditor);const t=this.languageService.createById("jsonc"),o=dt(this.notebookEditor.textModel?.transientOptions.transientCellMetadata,this.cell.type==="insert"?this.cell.modified.metadata||{}:this.cell.original.metadata||{}),i=this.cell.type==="insert"?this.cell.modified.uri:this.cell.original.uri,a=this.cell.type==="insert"?this.cell.modified.handle:this.cell.original.handle,n=j.generateCellPropertyUri(i,a,$.vscodeNotebookCellMetadata),r=this.modelService.createModel(o,t,n,!1);this._metadataEditor.setModel(r),this._metadataEditorDisposeStore.add(r),this.cell.metadataHeight=this._metadataEditor.getContentHeight(),this._metadataEditorDisposeStore.add(this._metadataEditor.onDidContentSizeChange(s=>{s.contentHeightChanged&&this.cell.metadataFoldingState===g.Expanded&&(this.cell.metadataHeight=s.contentHeight)}))}}_buildOutputEditor(){if(this._outputEditorDisposeStore.clear(),(this.cell.type==="modified"||this.cell.type==="unchanged")&&!this.notebookEditor.textModel.transientOptions.transientOutputs){const a=D(this.cell.original?.outputs||[]),n=D(this.cell.modified?.outputs||[]);if(a!==n){const r=this.languageService.createById("json"),s=this.modelService.createModel(a,r,void 0,!0),h=this.modelService.createModel(n,r,void 0,!0);this._outputEditorDisposeStore.add(s),this._outputEditorDisposeStore.add(h);const c=this.notebookEditor.getLayoutInfo().fontInfo.lineHeight||17,u=Math.max(s.getLineCount(),h.getLineCount());this._outputEditor=this.instantiationService.createInstance(Y,this._outputEditorContainer,{...G,overflowWidgetsDomNode:this.notebookEditor.getOverflowContainerDomNode(),readOnly:!0,ignoreTrimWhitespace:!1,automaticLayout:!1,dimension:{height:Math.min(K,this.cell.layoutInfo.rawOutputHeight||c*u),width:this.cell.getComputedCellContainerWidth(this.notebookEditor.getLayoutInfo(),!1,!0)},accessibilityVerbose:this.configurationService.getValue(Vt.DiffEditor)??!1},{originalEditor:b(),modifiedEditor:b()}),this._outputEditorDisposeStore.add(this._outputEditor),this._outputEditorContainer?.classList.add("diff"),this._outputEditor.setModel({original:s,modified:h}),this._outputEditor.restoreViewState(this.cell.getOutputEditorViewState()),this.cell.rawOutputHeight=this._outputEditor.getContentHeight(),this._outputEditorDisposeStore.add(this._outputEditor.onDidContentSizeChange(p=>{p.contentHeightChanged&&this.cell.outputFoldingState===g.Expanded&&(this.cell.rawOutputHeight=p.contentHeight)})),this._outputEditorDisposeStore.add(this.cell.modified.textModel.onDidChangeOutputs(()=>{const p=D(this.cell.modified?.outputs||[]);h.setValue(p),this._outputHeader.refresh()}));return}}this._outputEditor=this.instantiationService.createInstance(tt,this._outputEditorContainer,{...ot,dimension:{width:Math.min(K,this.cell.getComputedCellContainerWidth(this.notebookEditor.getLayoutInfo(),!1,this.cell.type==="unchanged"||this.cell.type==="modified")-32),height:this.cell.layoutInfo.rawOutputHeight},overflowWidgetsDomNode:this.notebookEditor.getOverflowContainerDomNode()},{}),this._outputEditorDisposeStore.add(this._outputEditor);const t=this.languageService.createById("json"),o=D(this.notebookEditor.textModel.transientOptions.transientOutputs?[]:this.cell.type==="insert"?this.cell.modified?.outputs||[]:this.cell.original?.outputs||[]),i=this.modelService.createModel(o,t,void 0,!0);this._outputEditorDisposeStore.add(i),this._outputEditor.setModel(i),this._outputEditor.restoreViewState(this.cell.getOutputEditorViewState()),this.cell.rawOutputHeight=this._outputEditor.getContentHeight(),this._outputEditorDisposeStore.add(this._outputEditor.onDidContentSizeChange(a=>{a.contentHeightChanged&&this.cell.outputFoldingState===g.Expanded&&(this.cell.rawOutputHeight=a.contentHeight)}))}layoutNotebookCell(){this.notebookEditor.layoutNotebookCell(this.cell,this.cell.layoutInfo.totalHeight)}updateBorders(){this.templateData.leftBorder.style.height=`${this.cell.layoutInfo.totalHeight-32}px`,this.templateData.rightBorder.style.height=`${this.cell.layoutInfo.totalHeight-32}px`,this.templateData.bottomBorder.style.top=`${this.cell.layoutInfo.totalHeight-32}px`}dispose(){this._outputEditor&&this.cell.saveOutputEditorViewState(this._outputEditor.saveViewState()),this._metadataEditor&&this.cell.saveMetadataEditorViewState(this._metadataEditor.saveViewState()),this._metadataEditorDisposeStore.dispose(),this._outputEditorDisposeStore.dispose(),this._isDisposed=!0,super.dispose()}}class st extends rt{_editor;cell;templateData;constructor(e,t,o,i,a,n,r,s,h,c,u,p,f,y,X){super(e,t,o,i,a,n,r,s,h,c,u,p,f,y,X),this.cell=t,this.templateData=o,this.updateBorders()}init(){this._diagonalFill=this.templateData.diagonalFill}buildBody(){const e=this.templateData.body;switch(this._diffEditorContainer=this.templateData.diffEditorContainer,e.classList.remove("left","right","full"),this.style){case"left":e.classList.add("left");break;case"right":e.classList.add("right");break;default:e.classList.add("full");break}this.styleContainer(this._diffEditorContainer),this.updateSourceEditor(),this.configurationService.getValue("notebook.diff.ignoreMetadata")?this._disposeMetadata():this._buildMetadata(),this.configurationService.getValue("notebook.diff.ignoreOutputs")||this.notebookEditor.textModel?.transientOptions.transientOutputs?this._disposeOutput():this._buildOutput(),this._register(this.configurationService.onDidChangeConfiguration(t=>{let o=!1,i=!1;t.affectsConfiguration("notebook.diff.ignoreMetadata")&&(this._metadataLocalDisposable.clear(),this.configurationService.getValue("notebook.diff.ignoreMetadata")?this._disposeMetadata():(this.cell.metadataStatusHeight=25,this._buildMetadata(),this.updateMetadataRendering(),o=!0)),t.affectsConfiguration("notebook.diff.ignoreOutputs")&&(this._outputLocalDisposable.clear(),this.configurationService.getValue("notebook.diff.ignoreOutputs")||this.notebookEditor.textModel?.transientOptions.transientOutputs?this._disposeOutput():(this.cell.outputStatusHeight=25,this._buildOutput(),i=!0)),(o||i)&&this.layout({metadataHeight:o,outputTotalHeight:i})}))}updateSourceEditor(){this._cellHeaderContainer=this.templateData.cellHeaderContainer,this._cellHeaderContainer.style.display="flex",this._cellHeaderContainer.innerText="",this._editorContainer=this.templateData.editorContainer,this._editorContainer.classList.add("diff");const e=()=>{if(this.cell.cellFoldingState===g.Collapsed){this._editorContainer.style.display="none",this.cell.editorHeight=0;return}const t=this.notebookEditor.getLayoutInfo().fontInfo.lineHeight||17,o=this.cell.computeInputEditorHeight(t);if(this._editorContainer.style.height=`${o}px`,this._editorContainer.style.display="block",this._editor){const i=this._editor.getContentHeight();i>=0&&(this.cell.editorHeight=i);return}this._editor=this.templateData.sourceEditor,this._editor.layout({width:(this.notebookEditor.getLayoutInfo().width-2*P)/2-18,height:o}),this._editor.updateOptions({readOnly:this.readonly}),this.cell.editorHeight=o,this._register(this._editor.onDidContentSizeChange(i=>{this.cell.cellFoldingState===g.Expanded&&i.contentHeightChanged&&this.cell.layoutInfo.editorHeight!==i.contentHeight&&(this.cell.editorHeight=i.contentHeight)})),this._initializeSourceDiffEditor(this.nestedCellViewModel)};this._cellHeader=this._register(this.instantiationService.createInstance(C,this.cell,this._cellHeaderContainer,this.notebookEditor,{updateInfoRendering:()=>e(),checkIfModified:()=>({reason:void 0}),getFoldingState:()=>this.cell.cellFoldingState,updateFoldingState:t=>this.cell.cellFoldingState=t,unChangedLabel:"Input",changedLabel:"Input",prefix:"input",menuId:S.NotebookDiffCellInputTitle})),this._cellHeader.buildHeader(),e(),this._initializeSourceDiffEditor(this.nestedCellViewModel)}calculateDiagonalFillHeight(){return this.cell.layoutInfo.cellStatusHeight+this.cell.layoutInfo.editorHeight+this.cell.layoutInfo.editorMargin+this.cell.layoutInfo.metadataStatusHeight+this.cell.layoutInfo.metadataHeight+this.cell.layoutInfo.outputTotalHeight+this.cell.layoutInfo.outputStatusHeight}async _initializeSourceDiffEditor(e){const t=await this.textModelService.createModelReference(e.uri);if(this._isDisposed)return;const o=t.object.textEditorModel;this._register(t),this._editor.setModel(o);const i=this.cell.getSourceEditorViewState();i&&this._editor.restoreViewState(i);const a=this._editor.getContentHeight();this.cell.editorHeight=a;const n=`${this.calculateDiagonalFillHeight()}px`;this._diagonalFill.style.height!==n&&(this._diagonalFill.style.height=n)}_disposeMetadata(){this.cell.metadataStatusHeight=0,this.cell.metadataHeight=0,this.templateData.cellHeaderContainer.style.display="none",this.templateData.metadataHeaderContainer.style.display="none",this.templateData.metadataInfoContainer.style.display="none",this._metadataEditor=void 0}_buildMetadata(){this._metadataHeaderContainer=this.templateData.metadataHeaderContainer,this._metadataInfoContainer=this.templateData.metadataInfoContainer,this._metadataHeaderContainer.style.display="flex",this._metadataInfoContainer.style.display="block",this._metadataHeaderContainer.innerText="",this._metadataInfoContainer.innerText="",this._metadataHeader=this.instantiationService.createInstance(C,this.cell,this._metadataHeaderContainer,this.notebookEditor,{updateInfoRendering:this.updateMetadataRendering.bind(this),checkIfModified:()=>this.cell.checkMetadataIfModified(),getFoldingState:()=>this.cell.metadataFoldingState,updateFoldingState:e=>{this.cell.metadataFoldingState=e},unChangedLabel:"Metadata",changedLabel:"Metadata changed",prefix:"metadata",menuId:S.NotebookDiffCellMetadataTitle}),this._metadataLocalDisposable.add(this._metadataHeader),this._metadataHeader.buildHeader()}_buildOutput(){this.templateData.outputHeaderContainer.style.display="flex",this.templateData.outputInfoContainer.style.display="block",this._outputHeaderContainer=this.templateData.outputHeaderContainer,this._outputInfoContainer=this.templateData.outputInfoContainer,this._outputHeaderContainer.innerText="",this._outputInfoContainer.innerText="",this._outputHeader=this.instantiationService.createInstance(C,this.cell,this._outputHeaderContainer,this.notebookEditor,{updateInfoRendering:this.updateOutputRendering.bind(this),checkIfModified:()=>this.cell.checkIfOutputsModified(),getFoldingState:()=>this.cell.outputFoldingState,updateFoldingState:e=>{this.cell.outputFoldingState=e},unChangedLabel:"Outputs",changedLabel:"Outputs changed",prefix:"output",menuId:S.NotebookDiffCellOutputsTitle}),this._outputLocalDisposable.add(this._outputHeader),this._outputHeader.buildHeader()}_disposeOutput(){this._hideOutputsRaw(),this._hideOutputsRenderer(),this._hideOutputsEmptyView(),this.cell.rawOutputHeight=0,this.cell.outputMetadataHeight=0,this.cell.outputStatusHeight=0,this.templateData.outputHeaderContainer.style.display="none",this.templateData.outputInfoContainer.style.display="none",this._outputViewContainer=void 0}}let W=class extends st{constructor(e,t,o,i,a,n,r,s,h,c,u,p,f,y){super(e,t,o,"left",r,i,a,n,s,h,c,u,p,f,y)}get nestedCellViewModel(){return this.cell.original}get readonly(){return!0}styleContainer(e){e.classList.remove("inserted"),e.classList.add("removed")}layout(e){d.scheduleAtNextAnimationFrame(d.getWindow(this._diffEditorContainer),()=>{(e.editorHeight||e.outerWidth)&&this._editor&&(this._editorContainer.style.height=`${this.cell.layoutInfo.editorHeight}px`,this._editor.layout({width:this.cell.getComputedCellContainerWidth(this.notebookEditor.getLayoutInfo(),!1,!1),height:this.cell.layoutInfo.editorHeight})),e.outerWidth&&this._editor&&(this._editorContainer.style.height=`${this.cell.layoutInfo.editorHeight}px`,this._editor.layout()),(e.metadataHeight||e.outerWidth)&&this._metadataEditor?.layout({width:this.cell.getComputedCellContainerWidth(this.notebookEditor.getLayoutInfo(),!1,!1),height:this.cell.layoutInfo.metadataHeight}),(e.outputTotalHeight||e.outerWidth)&&this._outputEditor?.layout({width:this.cell.getComputedCellContainerWidth(this.notebookEditor.getLayoutInfo(),!1,!1),height:this.cell.layoutInfo.outputTotalHeight}),this._diagonalFill&&(this._diagonalFill.style.height=`${this.calculateDiagonalFillHeight()}px`),this.layoutNotebookCell()})}_buildOutputRendererContainer(){if(!this._outputViewContainer){this._outputViewContainer=d.append(this._outputInfoContainer,d.$(".output-view-container")),this._outputEmptyElement=d.append(this._outputViewContainer,d.$(".output-empty-view"));const e=d.append(this._outputEmptyElement,d.$("span"));e.innerText="No outputs to render",this.cell.original?.outputs.length?this._outputEmptyElement.style.display="none":this._outputEmptyElement.style.display="block",this.cell.layoutChange(),this._outputLeftView=this.instantiationService.createInstance(L,this.notebookEditor,this.notebookEditor.textModel,this.cell,this.cell.original,_.Original,this._outputViewContainer),this._register(this._outputLeftView),this._outputLeftView.render();const t=this.notebookEditor.onDidDynamicOutputRendered(o=>{o.cell.uri.toString()===this.cell.original.uri.toString()&&(this.notebookEditor.deltaCellOutputContainerClassNames(_.Original,this.cell.original.id,["nb-cellDeleted"],[]),t.dispose())});this._register(t)}this._outputViewContainer.style.display="block"}_decorate(){this.notebookEditor.deltaCellOutputContainerClassNames(_.Original,this.cell.original.id,["nb-cellDeleted"],[])}_showOutputsRenderer(){this._outputViewContainer&&(this._outputViewContainer.style.display="block",this._outputLeftView?.showOutputs(),this._decorate())}_hideOutputsRenderer(){this._outputViewContainer&&(this._outputViewContainer.style.display="none",this._outputLeftView?.hideOutputs())}dispose(){this._editor&&this.cell.saveSpirceEditorViewState(this._editor.saveViewState()),super.dispose()}};W=E([l(3,z),l(4,U),l(5,T),l(6,w),l(7,O),l(8,x),l(9,k),l(10,M),l(11,I),l(12,V),l(13,F)],W);let B=class extends st{constructor(e,t,o,i,a,n,r,s,h,c,u,p,f,y){super(e,t,o,"right",i,a,n,r,s,h,c,u,p,f,y)}get nestedCellViewModel(){return this.cell.modified}get readonly(){return!1}styleContainer(e){e.classList.remove("removed"),e.classList.add("inserted")}_buildOutputRendererContainer(){if(!this._outputViewContainer){this._outputViewContainer=d.append(this._outputInfoContainer,d.$(".output-view-container")),this._outputEmptyElement=d.append(this._outputViewContainer,d.$(".output-empty-view")),this._outputEmptyElement.innerText="No outputs to render",this.cell.modified?.outputs.length?this._outputEmptyElement.style.display="none":this._outputEmptyElement.style.display="block",this.cell.layoutChange(),this._outputRightView=this.instantiationService.createInstance(L,this.notebookEditor,this.notebookEditor.textModel,this.cell,this.cell.modified,_.Modified,this._outputViewContainer),this._register(this._outputRightView),this._outputRightView.render();const e=this.notebookEditor.onDidDynamicOutputRendered(t=>{t.cell.uri.toString()===this.cell.modified.uri.toString()&&(this.notebookEditor.deltaCellOutputContainerClassNames(_.Modified,this.cell.modified.id,["nb-cellAdded"],[]),e.dispose())});this._register(e)}this._outputViewContainer.style.display="block"}_decorate(){this.notebookEditor.deltaCellOutputContainerClassNames(_.Modified,this.cell.modified.id,["nb-cellAdded"],[])}_showOutputsRenderer(){this._outputViewContainer&&(this._outputViewContainer.style.display="block",this._outputRightView?.showOutputs(),this._decorate())}_hideOutputsRenderer(){this._outputViewContainer&&(this._outputViewContainer.style.display="none",this._outputRightView?.hideOutputs())}layout(e){d.scheduleAtNextAnimationFrame(d.getWindow(this._diffEditorContainer),()=>{(e.editorHeight||e.outerWidth)&&this._editor&&(this._editorContainer.style.height=`${this.cell.layoutInfo.editorHeight}px`,this._editor.layout({width:this.cell.getComputedCellContainerWidth(this.notebookEditor.getLayoutInfo(),!1,!1),height:this.cell.layoutInfo.editorHeight})),e.outerWidth&&this._editor&&(this._editorContainer.style.height=`${this.cell.layoutInfo.editorHeight}px`,this._editor.layout()),(e.metadataHeight||e.outerWidth)&&this._metadataEditor?.layout({width:this.cell.getComputedCellContainerWidth(this.notebookEditor.getLayoutInfo(),!1,!0),height:this.cell.layoutInfo.metadataHeight}),(e.outputTotalHeight||e.outerWidth)&&this._outputEditor?.layout({width:this.cell.getComputedCellContainerWidth(this.notebookEditor.getLayoutInfo(),!1,!1),height:this.cell.layoutInfo.outputTotalHeight}),this.layoutNotebookCell(),this._diagonalFill&&(this._diagonalFill.style.height=`${this.calculateDiagonalFillHeight()}px`)})}dispose(){this._editor&&this.cell.saveSpirceEditorViewState(this._editor.saveViewState()),super.dispose()}};B=E([l(3,w),l(4,z),l(5,U),l(6,T),l(7,O),l(8,x),l(9,k),l(10,M),l(11,I),l(12,V),l(13,F)],B);let A=class extends rt{_editor;_editorViewStateChanged;_toolbar;_menu;cell;templateData;constructor(e,t,o,i,a,n,r,s,h,c,u,p,f,y){super(e,t,o,"full",i,a,n,r,s,h,c,u,p,f,y),this.cell=t,this.templateData=o,this._editorViewStateChanged=!1,this.updateBorders()}init(){}styleContainer(e){e.classList.remove("inserted","removed")}buildBody(){super.buildBody(),this.cell.displayIconToHideUnmodifiedCells?(this._register(this.templateData.marginOverlay.onAction(()=>this.cell.hideUnchangedCells())),this.templateData.marginOverlay.show()):this.templateData.marginOverlay.hide()}_disposeMetadata(){this.cell.metadataStatusHeight=0,this.cell.metadataHeight=0,this.templateData.metadataHeaderContainer.style.display="none",this.templateData.metadataInfoContainer.style.display="none",this._metadataEditor=void 0}_buildMetadata(){this._metadataHeaderContainer=this.templateData.metadataHeaderContainer,this._metadataInfoContainer=this.templateData.metadataInfoContainer,this._metadataHeaderContainer.style.display="flex",this._metadataInfoContainer.style.display="block",this._metadataHeaderContainer.innerText="",this._metadataInfoContainer.innerText="",this._metadataHeader=this.instantiationService.createInstance(C,this.cell,this._metadataHeaderContainer,this.notebookEditor,{updateInfoRendering:this.updateMetadataRendering.bind(this),checkIfModified:()=>this.cell.checkMetadataIfModified(),getFoldingState:()=>this.cell.metadataFoldingState,updateFoldingState:e=>{this.cell.metadataFoldingState=e},unChangedLabel:"Metadata",changedLabel:"Metadata changed",prefix:"metadata",menuId:S.NotebookDiffCellMetadataTitle}),this._metadataLocalDisposable.add(this._metadataHeader),this._metadataHeader.buildHeader()}_disposeOutput(){this._hideOutputsRaw(),this._hideOutputsRenderer(),this._hideOutputsEmptyView(),this.cell.rawOutputHeight=0,this.cell.outputMetadataHeight=0,this.cell.outputStatusHeight=0,this.templateData.outputHeaderContainer.style.display="none",this.templateData.outputInfoContainer.style.display="none",this._outputViewContainer=void 0}_buildOutput(){this.templateData.outputHeaderContainer.style.display="flex",this.templateData.outputInfoContainer.style.display="block",this._outputHeaderContainer=this.templateData.outputHeaderContainer,this._outputInfoContainer=this.templateData.outputInfoContainer,this._outputHeaderContainer.innerText="",this._outputInfoContainer.innerText="",this.cell.checkIfOutputsModified()?this._outputInfoContainer.classList.add("modified"):this._outputInfoContainer.classList.remove("modified"),this._outputHeader=this.instantiationService.createInstance(C,this.cell,this._outputHeaderContainer,this.notebookEditor,{updateInfoRendering:this.updateOutputRendering.bind(this),checkIfModified:()=>this.cell.checkIfOutputsModified(),getFoldingState:()=>this.cell.outputFoldingState,updateFoldingState:e=>{this.cell.outputFoldingState=e},unChangedLabel:"Outputs",changedLabel:"Outputs changed",prefix:"output",menuId:S.NotebookDiffCellOutputsTitle}),this._outputLocalDisposable.add(this._outputHeader),this._outputHeader.buildHeader()}_buildOutputRendererContainer(){if(!this._outputViewContainer){this._outputViewContainer=d.append(this._outputInfoContainer,d.$(".output-view-container")),this._outputEmptyElement=d.append(this._outputViewContainer,d.$(".output-empty-view")),this._outputEmptyElement.innerText="No outputs to render",!this.cell.checkIfOutputsModified()&&this.cell.modified.outputs.length===0?this._outputEmptyElement.style.display="block":this._outputEmptyElement.style.display="none",this.cell.layoutChange(),this._register(this.cell.modified.textModel.onDidChangeOutputs(()=>{!this.cell.checkIfOutputsModified()&&this.cell.modified.outputs.length===0?this._outputEmptyElement.style.display="block":this._outputEmptyElement.style.display="none",this._decorate()})),this._outputLeftContainer=d.append(this._outputViewContainer,d.$(".output-view-container-left")),this._outputRightContainer=d.append(this._outputViewContainer,d.$(".output-view-container-right")),this._outputMetadataContainer=d.append(this._outputViewContainer,d.$(".output-view-container-metadata"));const e=this.cell.checkIfOutputsModified(),t=e&&e.kind===Z.Metadata&&this.cell.original.outputs.length===1&&this.cell.modified.outputs.length===1&&ut(this.cell.original.outputs[0],this.cell.modified.outputs[0])===Z.Metadata;if(e&&!t){const o=this.notebookEditor.onDidDynamicOutputRendered(a=>{a.cell.uri.toString()===this.cell.original.uri.toString()&&this.cell.checkIfOutputsModified()&&(this.notebookEditor.deltaCellOutputContainerClassNames(_.Original,this.cell.original.id,["nb-cellDeleted"],[]),o.dispose())}),i=this.notebookEditor.onDidDynamicOutputRendered(a=>{a.cell.uri.toString()===this.cell.modified.uri.toString()&&this.cell.checkIfOutputsModified()&&(this.notebookEditor.deltaCellOutputContainerClassNames(_.Modified,this.cell.modified.id,["nb-cellAdded"],[]),i.dispose())});this._register(o),this._register(i)}if(this._outputLeftView=this.instantiationService.createInstance(L,this.notebookEditor,this.notebookEditor.textModel,this.cell,this.cell.original,_.Original,this._outputLeftContainer),this._outputLeftView.render(),this._register(this._outputLeftView),this._outputRightView=this.instantiationService.createInstance(L,this.notebookEditor,this.notebookEditor.textModel,this.cell,this.cell.modified,_.Modified,this._outputRightContainer),this._outputRightView.render(),this._register(this._outputRightView),e&&!t&&this._decorate(),t){this._outputMetadataContainer.style.top=`${this.cell.layoutInfo.rawOutputHeight}px`,this._outputMetadataEditor=this.instantiationService.createInstance(Y,this._outputMetadataContainer,{...G,overflowWidgetsDomNode:this.notebookEditor.getOverflowContainerDomNode(),readOnly:!0,ignoreTrimWhitespace:!1,automaticLayout:!1,dimension:{height:K,width:this.cell.getComputedCellContainerWidth(this.notebookEditor.getLayoutInfo(),!1,!0)}},{originalEditor:b(),modifiedEditor:b()}),this._register(this._outputMetadataEditor);const o=JSON.stringify(this.cell.original.outputs[0].metadata??{},void 0,"	"),i=JSON.stringify(this.cell.modified.outputs[0].metadata??{},void 0,"	"),a=this.languageService.createById("json"),n=this.modelService.createModel(o,a,void 0,!0),r=this.modelService.createModel(i,a,void 0,!0);this._outputMetadataEditor.setModel({original:n,modified:r}),this.cell.outputMetadataHeight=this._outputMetadataEditor.getContentHeight(),this._register(this._outputMetadataEditor.onDidContentSizeChange(s=>{this.cell.outputMetadataHeight=s.contentHeight}))}}this._outputViewContainer.style.display="block"}_decorate(){this.cell.checkIfOutputsModified()?(this.notebookEditor.deltaCellOutputContainerClassNames(_.Original,this.cell.original.id,["nb-cellDeleted"],[]),this.notebookEditor.deltaCellOutputContainerClassNames(_.Modified,this.cell.modified.id,["nb-cellAdded"],[])):(this.notebookEditor.deltaCellOutputContainerClassNames(_.Original,this.cell.original.id,[],["nb-cellDeleted"]),this.notebookEditor.deltaCellOutputContainerClassNames(_.Modified,this.cell.modified.id,[],["nb-cellAdded"]))}_showOutputsRenderer(){this._outputViewContainer&&(this._outputViewContainer.style.display="block",this._outputLeftView?.showOutputs(),this._outputRightView?.showOutputs(),this._outputMetadataEditor?.layout({width:this._editor?.getViewWidth()||this.cell.getComputedCellContainerWidth(this.notebookEditor.getLayoutInfo(),!1,!0),height:this.cell.layoutInfo.outputMetadataHeight}),this._decorate())}_hideOutputsRenderer(){this._outputViewContainer&&(this._outputViewContainer.style.display="none",this._outputLeftView?.hideOutputs(),this._outputRightView?.hideOutputs())}updateSourceEditor(){this._cellHeaderContainer=this.templateData.cellHeaderContainer,this._cellHeaderContainer.style.display="flex",this._cellHeaderContainer.innerText="";const e=this.cell.modified;this._editorContainer=this.templateData.editorContainer,this._editorContainer.classList.add("diff");const t=()=>{if(this.cell.cellFoldingState===g.Collapsed){this._editorContainer.style.display="none",this.cell.editorHeight=0;return}const s=e.textModel.textBuffer.getLineCount(),h=this.notebookEditor.getLayoutInfo().fontInfo.lineHeight||17,c=this.cell.layoutInfo.editorHeight!==0?this.cell.layoutInfo.editorHeight:this.cell.computeInputEditorHeight(h);if(this._editorContainer.style.height=`${c}px`,this._editorContainer.style.display="block",this._editor){const f=this._editor.getContentHeight();f>=0&&(this.cell.editorHeight=f);return}this._editor=this.templateData.sourceEditor;const u={padding:at(s)},p=this._register(q(this.configurationService));p.options.enabled&&(u.hideUnchangedRegions=p.options),this._editor.updateOptions(u),this._register(p.onDidChangeEnablement(()=>{u.hideUnchangedRegions=p.options,this._editor?.updateOptions(u)})),this._editor.layout({width:this.notebookEditor.getLayoutInfo().width-2*P,height:c}),this._register(this._editor.onDidContentSizeChange(f=>{this.cell.cellFoldingState===g.Expanded&&f.contentHeightChanged&&this.cell.layoutInfo.editorHeight!==f.contentHeight&&(this.cell.editorHeight=f.contentHeight)})),this._initializeSourceDiffEditor()};this._cellHeader=this._register(this.instantiationService.createInstance(C,this.cell,this._cellHeaderContainer,this.notebookEditor,{updateInfoRendering:()=>t(),checkIfModified:()=>this.cell.modified?.textModel.getTextBufferHash()!==this.cell.original?.textModel.getTextBufferHash()?{reason:void 0}:!1,getFoldingState:()=>this.cell.cellFoldingState,updateFoldingState:s=>this.cell.cellFoldingState=s,unChangedLabel:"Input",changedLabel:"Input changed",prefix:"input",menuId:S.NotebookDiffCellInputTitle})),this._cellHeader.buildHeader(),t();const o=this.contextKeyService.createScoped(this.templateData.inputToolbarContainer);this._register(o);const i=ft.bindTo(o);i.set(this.cell.modified.textModel.getTextBufferHash()!==this.cell.original.textModel.getTextBufferHash());const a=_t.bindTo(o),n=this.textConfigurationService.getValue(this.cell.modified.uri,"diffEditor.ignoreTrimWhitespace");a.set(n),this._toolbar=this.templateData.toolbar,this._toolbar.context=this.cell;const r=()=>{const s=this.textConfigurationService.getValue(this.cell.modified.uri,"diffEditor.ignoreTrimWhitespace");a.set(s);const h=this.cell.modified.textModel.getTextBufferHash()!==this.cell.original.textModel.getTextBufferHash();if(i.set(h),h){const c=[],u=this.menuService.getMenuActions(S.NotebookDiffCellInputTitle,o,{shouldForwardArgs:!0});J(u,c),this._toolbar.setActions(c)}else this._toolbar.setActions([])};this._register(this.cell.modified.textModel.onDidChangeContent(()=>r())),this._register(this.textConfigurationService.onDidChangeConfiguration(s=>{s.affectsConfiguration(this.cell.modified.uri,"diffEditor")&&s.affectedKeys.has("diffEditor.ignoreTrimWhitespace")&&r()})),r()}async _initializeSourceDiffEditor(){const[e,t]=await Promise.all([this.textModelService.createModelReference(this.cell.original.uri),this.textModelService.createModelReference(this.cell.modified.uri)]);if(this._register(e),this._register(t),this._isDisposed){e.dispose(),t.dispose();return}const o=this._register(this._editor.createViewModel({original:e.object.textEditorModel,modified:t.object.textEditorModel}));await o.waitForDiff(),this._editor.setModel(o);const i=()=>{this._editorViewStateChanged=!0},a=s=>{(s.scrollTopChanged||s.scrollLeftChanged)&&(this._editorViewStateChanged=!0)};this.updateEditorOptionsForWhitespace(),this._register(this._editor.getOriginalEditor().onDidChangeCursorSelection(i)),this._register(this._editor.getOriginalEditor().onDidScrollChange(a)),this._register(this._editor.getModifiedEditor().onDidChangeCursorSelection(i)),this._register(this._editor.getModifiedEditor().onDidScrollChange(a));const n=this.cell.getSourceEditorViewState();n&&this._editor.restoreViewState(n);const r=this._editor.getContentHeight();this.cell.editorHeight=r}updateEditorOptionsForWhitespace(){const e=this._editor;if(!e)return;const t=e.getModel()?.modified.uri||e.getModel()?.original.uri;if(!t)return;const o=this.textConfigurationService.getValue(t,"diffEditor.ignoreTrimWhitespace");e.updateOptions({ignoreTrimWhitespace:o}),this._register(this.textConfigurationService.onDidChangeConfiguration(i=>{if(i.affectsConfiguration(t,"diffEditor")&&i.affectedKeys.has("diffEditor.ignoreTrimWhitespace")){const a=this.textConfigurationService.getValue(t,"diffEditor.ignoreTrimWhitespace");e.updateOptions({ignoreTrimWhitespace:a})}}))}layout(e){d.scheduleAtNextAnimationFrame(d.getWindow(this._diffEditorContainer),()=>{e.editorHeight&&this._editor&&(this._editorContainer.style.height=`${this.cell.layoutInfo.editorHeight}px`,this._editor.layout({width:this._editor.getViewWidth(),height:this.cell.layoutInfo.editorHeight})),e.outerWidth&&this._editor&&(this._editorContainer.style.height=`${this.cell.layoutInfo.editorHeight}px`,this._editor.layout()),(e.metadataHeight||e.outerWidth)&&this._metadataEditorContainer&&(this._metadataEditorContainer.style.height=`${this.cell.layoutInfo.metadataHeight}px`,this._metadataEditor?.layout({width:this._editor?.getViewWidth()||this.cell.getComputedCellContainerWidth(this.notebookEditor.getLayoutInfo(),!1,!0),height:this.cell.layoutInfo.metadataHeight})),(e.outputTotalHeight||e.outerWidth)&&(this._outputEditorContainer&&(this._outputEditorContainer.style.height=`${this.cell.layoutInfo.outputTotalHeight}px`,this._outputEditor?.layout({width:this._editor?.getViewWidth()||this.cell.getComputedCellContainerWidth(this.notebookEditor.getLayoutInfo(),!1,!0),height:this.cell.layoutInfo.outputTotalHeight})),this._outputMetadataContainer&&(this._outputMetadataContainer.style.height=`${this.cell.layoutInfo.outputMetadataHeight}px`,this._outputMetadataContainer.style.top=`${this.cell.layoutInfo.outputTotalHeight-this.cell.layoutInfo.outputMetadataHeight}px`,this._outputMetadataEditor?.layout({width:this._editor?.getViewWidth()||this.cell.getComputedCellContainerWidth(this.notebookEditor.getLayoutInfo(),!1,!0),height:this.cell.layoutInfo.outputMetadataHeight}))),this.layoutNotebookCell()})}dispose(){this._editor&&this._editor.setModel(null),this._editor&&this._editorViewStateChanged&&this.cell.saveSpirceEditorViewState(this._editor.saveViewState()),super.dispose()}};A=E([l(3,w),l(4,z),l(5,U),l(6,T),l(7,O),l(8,x),l(9,k),l(10,M),l(11,I),l(12,V),l(13,F)],A);class qe extends v{constructor(t){super();this.container=t;this._nodes.root.style.display="none",t.appendChild(this._nodes.root)}_nodes=d.h("div.diff-hidden-cells",[d.h("div.center@content",{style:{display:"flex"}},[d.$("a",{title:R("showUnchangedCells","Show Unchanged Cells"),role:"button",onclick:()=>{this._action.fire()}},...it("$(unfold)"))])]);_action=this._register(new nt);onAction=this._action.event;show(){this._nodes.root.style.display="block"}hide(){this._nodes.root.style.display="none"}dispose(){this.hide(),this.container.removeChild(this._nodes.root),d.reset(this._nodes.root),super.dispose()}}class Xe extends v{constructor(t){super();this.container=t;this._nodes.root.style.display="none",t.appendChild(this._nodes.root)}_nodes=d.h("div.diff-hidden-cells",[d.h("div.center@content",{style:{display:"flex"}},[d.$("a",{title:R("hideUnchangedCells","Hide Unchanged Cells"),role:"button",onclick:()=>{this._action.fire()}},...it("$(fold)"))])]);_action=this._register(new nt);onAction=this._action.event;show(){this._nodes.root.style.display="block"}hide(){this._nodes.root.style.display="none"}dispose(){this.hide(),this.container.removeChild(this._nodes.root),d.reset(this._nodes.root),super.dispose()}}export{Ye as CellDiffPlaceholderElement,qe as CollapsedCellOverlayWidget,W as DeletedElement,B as InsertElement,A as ModifiedElement,N as NotebookDocumentMetadataElement,Xe as UnchangedCellOverlayWidget,b as getOptimizedNestedCodeEditorWidgetOptions};
