import{timeout as L}from"../../../../../../base/common/async.js";import{KeyCode as t,KeyMod as r}from"../../../../../../base/common/keyCodes.js";import{EditorExtensionsRegistry as T}from"../../../../../../editor/browser/editorExtensions.js";import{EditorContextKeys as u}from"../../../../../../editor/common/editorContextKeys.js";import{localize as a}from"../../../../../../nls.js";import{CONTEXT_ACCESSIBILITY_MODE_ENABLED as h}from"../../../../../../platform/accessibility/common/accessibility.js";import{Action2 as M,registerAction2 as d}from"../../../../../../platform/actions/common/actions.js";import{Extensions as B}from"../../../../../../platform/configuration/common/configurationRegistry.js";import{ContextKeyExpr as e}from"../../../../../../platform/contextkey/common/contextkey.js";import{InputFocusedContextKey as C}from"../../../../../../platform/contextkey/common/contextkeys.js";import{KeybindingWeight as l}from"../../../../../../platform/keybinding/common/keybindingsRegistry.js";import{Registry as R}from"../../../../../../platform/registry/common/platform.js";import{InlineChatController as k}from"../../../../inlineChat/browser/inlineChatController.js";import{CellKind as N,NOTEBOOK_EDITOR_CURSOR_BOUNDARY as A}from"../../../common/notebookCommon.js";import{NOTEBOOK_CELL_EDITOR_FOCUSED as S,NOTEBOOK_CELL_HAS_OUTPUTS as q,NOTEBOOK_CELL_MARKDOWN_EDIT_MODE as P,NOTEBOOK_CELL_TYPE as I,NOTEBOOK_CURSOR_NAVIGATION_MODE as v,NOTEBOOK_EDITOR_FOCUSED as c,NOTEBOOK_OUTPUT_FOCUSED as _,NOTEBOOK_OUTPUT_INPUT_FOCUSED as x}from"../../../common/notebookContextKeys.js";import{CTX_NOTEBOOK_CHAT_OUTER_FOCUS_POSITION as D}from"../../controller/chat/notebookChatContext.js";import{NOTEBOOK_EDITOR_WIDGET_ACTION_WEIGHT as f,NotebookAction as U,NotebookCellAction as m,findTargetCellEditor as W}from"../../controller/coreActions.js";import{CellEditState as K}from"../../notebookBrowser.js";const G="notebook.focusTop",H="notebook.focusBottom",z="notebook.focusPreviousEditor",V="notebook.focusNextEditor",j="notebook.cell.focusInOutput",X="notebook.cell.focusOutOutput",Y="notebook.centerActiveCell",J="notebook.cell.cursorPageUp",Q="notebook.cell.cursorPageUpSelect",Z="notebook.cell.cursorPageDown",$="notebook.cell.cursorPageDownSelect";d(class extends M{constructor(){super({id:"notebook.cell.nullAction",title:a("notebook.cell.webviewHandledEvents","Keypresses that should be handled by the focused element in the cell output."),keybinding:[{when:x,primary:t.DownArrow,weight:l.WorkbenchContrib+1},{when:x,primary:t.UpArrow,weight:l.WorkbenchContrib+1}],f1:!1})}run(){}}),d(class extends m{constructor(){super({id:V,title:a("cursorMoveDown","Focus Next Cell Editor"),keybinding:[{when:e.and(c,h.negate(),e.equals("config.notebook.navigation.allowNavigateToSurroundingCells",!0),e.and(e.has(C),u.editorTextFocus,A.notEqualsTo("top"),A.notEqualsTo("none")),u.isEmbeddedDiffEditor.negate()),primary:t.DownArrow,weight:f},{when:e.and(c,h.negate(),e.equals("config.notebook.navigation.allowNavigateToSurroundingCells",!0),e.and(I.isEqualTo("markup"),P.isEqualTo(!1),v),u.isEmbeddedDiffEditor.negate()),primary:t.DownArrow,weight:l.WorkbenchContrib},{when:e.and(c,_),primary:r.CtrlCmd|t.DownArrow,mac:{primary:r.WinCtrl|r.CtrlCmd|t.DownArrow},weight:l.WorkbenchContrib},{when:e.and(S,h),primary:r.CtrlCmd|t.PageDown,mac:{primary:r.WinCtrl|t.PageUp},weight:l.WorkbenchContrib+1}]})}async runWithContext(n,o){const i=o.notebookEditor,O=o.cell,g=i.getCellIndex(O);if(typeof g!="number"||g>=i.getLength()-1)return;const p=O.textBuffer.getLineCount(),w=o.cell??o.selectedCells?.[0],E=w?W(o,w):void 0;if(E&&E.hasTextFocus()&&k.get(E)?.getWidgetPosition()?.lineNumber===p)k.get(E)?.focus();else{const b=i.cellAt(g+1),F=b.cellKind===N.Markup&&b.getEditState()===K.Preview?"container":"editor";await i.focusNotebookCell(b,F,{focusEditorLine:1})}}}),d(class extends m{constructor(){super({id:z,title:a("cursorMoveUp","Focus Previous Cell Editor"),keybinding:[{when:e.and(c,h.negate(),e.equals("config.notebook.navigation.allowNavigateToSurroundingCells",!0),e.and(e.has(C),u.editorTextFocus,A.notEqualsTo("bottom"),A.notEqualsTo("none")),u.isEmbeddedDiffEditor.negate()),primary:t.UpArrow,weight:f},{when:e.and(c,h.negate(),e.equals("config.notebook.navigation.allowNavigateToSurroundingCells",!0),e.and(I.isEqualTo("markup"),P.isEqualTo(!1),v),u.isEmbeddedDiffEditor.negate()),primary:t.UpArrow,weight:l.WorkbenchContrib},{when:e.and(S,h),primary:r.CtrlCmd|t.PageUp,mac:{primary:r.WinCtrl|t.PageUp},weight:l.WorkbenchContrib+1}]})}async runWithContext(n,o){const i=o.notebookEditor,O=o.cell,g=i.getCellIndex(O);if(typeof g!="number"||g<1||i.getLength()===0)return;const p=i.cellAt(g-1),w=p.cellKind===N.Markup&&p.getEditState()===K.Preview?"container":"editor",E=p.textBuffer.getLineCount();await i.focusNotebookCell(p,w,{focusEditorLine:E});const b=W(o,p);b&&k.get(b)?.getWidgetPosition()?.lineNumber===E&&k.get(b)?.focus()}}),d(class extends U{constructor(){super({id:G,title:a("focusFirstCell","Focus First Cell"),keybinding:[{when:e.and(c,e.not(C)),primary:r.CtrlCmd|t.Home,weight:l.WorkbenchContrib},{when:e.and(c,e.not(C),D.isEqualTo("")),mac:{primary:r.CtrlCmd|t.UpArrow},weight:l.WorkbenchContrib}]})}async runWithContext(s,n){const o=n.notebookEditor;if(o.getLength()===0)return;const i=o.cellAt(0);await o.focusNotebookCell(i,"container")}}),d(class extends U{constructor(){super({id:H,title:a("focusLastCell","Focus Last Cell"),keybinding:[{when:e.and(c,e.not(C)),primary:r.CtrlCmd|t.End,mac:void 0,weight:l.WorkbenchContrib},{when:e.and(c,e.not(C),D.isEqualTo("")),mac:{primary:r.CtrlCmd|t.DownArrow},weight:l.WorkbenchContrib}]})}async runWithContext(s,n){const o=n.notebookEditor;if(!o.hasModel()||o.getLength()===0)return;const i=o.getLength()-1,O=o.getPreviousVisibleCellIndex(i);if(O){const g=o.cellAt(O);await o.focusNotebookCell(g,"container")}}}),d(class extends m{constructor(){super({id:j,title:a("focusOutput","Focus In Active Cell Output"),keybinding:{when:e.and(c,q),primary:r.CtrlCmd|t.DownArrow,mac:{primary:r.WinCtrl|r.CtrlCmd|t.DownArrow},weight:l.WorkbenchContrib}})}async runWithContext(s,n){const o=n.notebookEditor,i=n.cell;return L(0).then(()=>o.focusNotebookCell(i,"output"))}}),d(class extends m{constructor(){super({id:X,title:a("focusOutputOut","Focus Out Active Cell Output"),keybinding:{when:e.and(c,_),primary:r.CtrlCmd|t.UpArrow,mac:{primary:r.WinCtrl|r.CtrlCmd|t.UpArrow},weight:l.WorkbenchContrib}})}async runWithContext(s,n){const o=n.notebookEditor,i=n.cell;await o.focusNotebookCell(i,"editor")}}),d(class extends m{constructor(){super({id:Y,title:a("notebookActions.centerActiveCell","Center Active Cell"),keybinding:{when:c,primary:r.CtrlCmd|t.KeyL,mac:{primary:r.WinCtrl|t.KeyL},weight:l.WorkbenchContrib}})}async runWithContext(n,o){return o.notebookEditor.revealInCenter(o.cell)}}),d(class extends m{constructor(){super({id:J,title:a("cursorPageUp","Cell Cursor Page Up"),keybinding:[{when:e.and(c,e.has(C),u.editorTextFocus),primary:t.PageUp,weight:f}]})}async runWithContext(s,n){T.getEditorCommand("cursorPageUp").runCommand(s,{pageSize:y(n)})}}),d(class extends m{constructor(){super({id:Q,title:a("cursorPageUpSelect","Cell Cursor Page Up Select"),keybinding:[{when:e.and(c,e.has(C),u.editorTextFocus,_.negate()),primary:r.Shift|t.PageUp,weight:f}]})}async runWithContext(s,n){T.getEditorCommand("cursorPageUpSelect").runCommand(s,{pageSize:y(n)})}}),d(class extends m{constructor(){super({id:Z,title:a("cursorPageDown","Cell Cursor Page Down"),keybinding:[{when:e.and(c,e.has(C),u.editorTextFocus),primary:t.PageDown,weight:f}]})}async runWithContext(s,n){T.getEditorCommand("cursorPageDown").runCommand(s,{pageSize:y(n)})}}),d(class extends m{constructor(){super({id:$,title:a("cursorPageDownSelect","Cell Cursor Page Down Select"),keybinding:[{when:e.and(c,e.has(C),u.editorTextFocus,_.negate()),primary:r.Shift|t.PageDown,weight:f}]})}async runWithContext(s,n){T.getEditorCommand("cursorPageDownSelect").runCommand(s,{pageSize:y(n)})}});function y(s){const o=s.notebookEditor.getViewModel().layoutInfo,i=o?.fontInfo.lineHeight||17;return Math.max(1,Math.floor((o?.height||0)/i)-2)}R.as(B.Configuration).registerConfiguration({id:"notebook",order:100,type:"object",properties:{"notebook.navigation.allowNavigateToSurroundingCells":{type:"boolean",default:!0,markdownDescription:a("notebook.navigation.allowNavigateToSurroundingCells","When enabled cursor can navigate to the next/previous cell when the current cursor in the cell editor is at the first/last line.")}}});export{Y as CENTER_ACTIVE_CELL};
