var C=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var h=(d,c,n,t)=>{for(var i=t>1?void 0:t?S(c,n):c,e=d.length-1,o;e>=0;e--)(o=d[e])&&(i=(t?o(c,n,i):o(i))||i);return t&&i&&C(c,n,i),i},g=(d,c)=>(n,t)=>c(n,t,d);import{Disposable as I}from"../../../../../../../vs/base/common/lifecycle.js";import{ResourceMap as p}from"../../../../../../../vs/base/common/map.js";import{Schemas as E}from"../../../../../../../vs/base/common/network.js";import{isEqual as M}from"../../../../../../../vs/base/common/resources.js";import{Registry as B}from"../../../../../../../vs/platform/registry/common/platform.js";import{Extensions as _}from"../../../../../../../vs/workbench/common/contributions.js";import{IDebugService as W}from"../../../../../../../vs/workbench/contrib/debug/common/debug.js";import{getNotebookEditorFromEditorPane as y}from"../../../../../../../vs/workbench/contrib/notebook/browser/notebookBrowser.js";import"../../../../../../../vs/workbench/contrib/notebook/common/model/notebookTextModel.js";import{CellUri as m,NotebookCellsChangeType as x}from"../../../../../../../vs/workbench/contrib/notebook/common/notebookCommon.js";import{INotebookService as D}from"../../../../../../../vs/workbench/contrib/notebook/common/notebookService.js";import{IEditorService as N}from"../../../../../../../vs/workbench/services/editor/common/editorService.js";import{LifecyclePhase as R}from"../../../../../../../vs/workbench/services/lifecycle/common/lifecycle.js";let u=class extends I{constructor(n,t,i){super();this._debugService=n;this._editorService=i;const e=new p;this._register(t.onWillAddNotebookDocument(o=>{e.set(o.uri,o.onWillAddRemoveCells(s=>{const r=this._debugService.getModel();if(r.getBreakpoints().length&&s.rawEvent.kind===x.ModelChange)for(const l of s.rawEvent.changes){const[a,f]=l;if(f>0){const b=o.cells.slice(a,a+f);for(const v of b)r.getBreakpoints({uri:v.uri}).forEach(k=>this._debugService.removeBreakpoints(k.getId()))}}}))})),this._register(t.onWillRemoveNotebookDocument(o=>{this.updateBreakpoints(o),e.get(o.uri)?.dispose(),e.delete(o.uri)})),this._register(this._debugService.getModel().onDidChangeBreakpoints(o=>{const s=o?.added?.find(r=>"uri"in r&&r.uri.scheme===E.vscodeNotebookCell);if(s){const r=m.parse(s.uri);if(!r)return;const l=y(this._editorService.activeEditorPane);if(!l||!l.hasModel()||l.textModel.uri.toString()!==r.notebook.toString())return;const a=l.getCellByHandle(r.handle);if(!a)return;l.focusElement(a)}}))}updateBreakpoints(n){const t=this._debugService.getModel().getBreakpoints();if(!t.length||!n.cells.length)return;const i=new p;n.cells.forEach((e,o)=>{i.set(e.uri,o)}),t.forEach(e=>{const o=i.get(e.uri);if(typeof o!="number")return;const s=m.parse(e.uri)?.notebook;if(!s)return;const r=m.generate(s,o);M(r,e.uri)||(this._debugService.removeBreakpoints(e.getId()),this._debugService.addBreakpoints(r,[{column:e.column,condition:e.condition,enabled:e.enabled,hitCondition:e.hitCondition,logMessage:e.logMessage,lineNumber:e.lineNumber}]))})}};u=h([g(0,W),g(1,D),g(2,N)],u),B.as(_.Workbench).registerWorkbenchContribution(u,R.Restored);
