var _=Object.defineProperty;var m=Object.getOwnPropertyDescriptor;var S=(l,n,e,t)=>{for(var r=t>1?void 0:t?m(n,e):n,s=l.length-1,i;s>=0;s--)(i=l[s])&&(r=(t?i(n,e,r):i(r))||r);return t&&r&&_(n,e,r),r},c=(l,n)=>(e,t)=>n(e,t,l);import{Disposable as f,DisposableStore as b}from"../../../../../base/common/lifecycle.js";import{LinkedMap as v,Touch as k}from"../../../../../base/common/map.js";import{localize2 as R}from"../../../../../nls.js";import{Categories as u}from"../../../../../platform/action/common/actionCommonCategories.js";import{Action2 as y,registerAction2 as I}from"../../../../../platform/actions/common/actions.js";import"../../../../../platform/instantiation/common/instantiation.js";import{IStorageService as M,StorageScope as g,StorageTarget as O}from"../../../../../platform/storage/common/storage.js";import{INotebookKernelHistoryService as T,INotebookKernelService as E}from"../../common/notebookKernelService.js";import{INotebookLoggingService as A}from"../../common/notebookLoggingService.js";const h=5;let o=class extends f{constructor(e,t,r){super();this._storageService=e;this._notebookKernelService=t;this._notebookLoggingService=r;this._loadState(),this._register(this._storageService.onWillSaveState(()=>this._saveState())),this._register(this._storageService.onDidChangeValue(g.WORKSPACE,o.STORAGE_KEY,this._register(new b))(()=>{this._loadState()}))}static STORAGE_KEY="notebook.kernelHistory";_mostRecentKernelsMap={};getKernels(e){const t=this._notebookKernelService.getMatchingKernel(e),r=t.all,s=t.selected,i=t.all.length===1?t.all[0]:void 0;this._notebookLoggingService.debug("History",`getMatchingKernels: ${t.all.length} kernels available for ${e.uri.path}. Selected: ${t.selected?.label}. Suggested: ${i?.label}`);const a=this._mostRecentKernelsMap[e.notebookType]?[...this._mostRecentKernelsMap[e.notebookType].values()]:[],p=a.map(d=>r.find(K=>K.id===d)).filter(d=>!!d);return this._notebookLoggingService.debug("History",`mru: ${a.length} kernels in history, ${p.length} registered already.`),{selected:s??i,all:p}}addMostRecentKernel(e){const t=e.id,r=e.viewType,s=this._mostRecentKernelsMap[r]??new v;if(s.set(t,t,k.AsOld),s.size>h){const i=[...s.entries()].slice(0,h);s.fromJSON(i)}this._mostRecentKernelsMap[r]=s}_saveState(){let e=!1;for(const[t,r]of Object.entries(this._mostRecentKernelsMap))e=e||r.size>0;if(e){const t=this._serialize();this._storageService.store(o.STORAGE_KEY,JSON.stringify(t),g.WORKSPACE,O.USER)}else this._storageService.remove(o.STORAGE_KEY,g.WORKSPACE)}_loadState(){const e=this._storageService.get(o.STORAGE_KEY,g.WORKSPACE);if(e)try{this._deserialize(JSON.parse(e))}catch{this._mostRecentKernelsMap={}}else this._mostRecentKernelsMap={}}_serialize(){const e=Object.create(null);for(const[t,r]of Object.entries(this._mostRecentKernelsMap))e[t]={entries:[...r.values()]};return e}_deserialize(e){this._mostRecentKernelsMap={};for(const[t,r]of Object.entries(e)){const s=new v,i=[];for(const a of r.entries)i.push([a,a]);s.fromJSON(i),this._mostRecentKernelsMap[t]=s}}_clear(){this._mostRecentKernelsMap={},this._saveState()}};o=S([c(0,M),c(1,E),c(2,A)],o),I(class extends y{constructor(){super({id:"notebook.clearNotebookKernelsMRUCache",title:R("workbench.notebook.clearNotebookKernelsMRUCache","Clear Notebook Kernels MRU Cache"),category:u.Developer,f1:!0})}async run(l){l.get(T)._clear()}});export{o as NotebookKernelHistoryService};
