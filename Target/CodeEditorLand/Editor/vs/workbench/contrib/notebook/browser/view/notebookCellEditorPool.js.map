{
  "version": 3,
  "sources": ["../../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/contrib/notebook/browser/view/notebookCellEditorPool.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as DOM from \"../../../../../base/browser/dom.js\";\nimport {\n\ttype CancelablePromise,\n\tcreateCancelablePromise,\n} from \"../../../../../base/common/async.js\";\nimport {\n\tDisposable,\n\tDisposableStore,\n\tMutableDisposable,\n} from \"../../../../../base/common/lifecycle.js\";\nimport { CodeEditorWidget } from \"../../../../../editor/browser/widget/codeEditor/codeEditorWidget.js\";\nimport { EditorContextKeys } from \"../../../../../editor/common/editorContextKeys.js\";\nimport { ITextModelService } from \"../../../../../editor/common/services/resolverService.js\";\nimport { IConfigurationService } from \"../../../../../platform/configuration/common/configuration.js\";\nimport {\n\tIContextKeyService,\n\ttype IScopedContextKeyService,\n} from \"../../../../../platform/contextkey/common/contextkey.js\";\nimport { IInstantiationService } from \"../../../../../platform/instantiation/common/instantiation.js\";\nimport { ServiceCollection } from \"../../../../../platform/instantiation/common/serviceCollection.js\";\nimport {\n\tCellFocusMode,\n\ttype ICellViewModel,\n\ttype INotebookEditorDelegate,\n} from \"../notebookBrowser.js\";\nimport { CellEditorOptions } from \"./cellParts/cellEditorOptions.js\";\n\nexport class NotebookCellEditorPool extends Disposable {\n\tprivate readonly _focusedEditorDOM: HTMLElement;\n\tprivate readonly _editorDisposable = this._register(\n\t\tnew MutableDisposable(),\n\t);\n\tprivate _editorContextKeyService!: IScopedContextKeyService;\n\tprivate _editor!: CodeEditorWidget;\n\tprivate _focusEditorCancellablePromise: CancelablePromise<void> | undefined;\n\tprivate _isInitialized = false;\n\tprivate _isDisposed = false;\n\n\tconstructor(\n\t\treadonly notebookEditor: INotebookEditorDelegate,\n\t\tprivate readonly contextKeyServiceProvider: (\n\t\t\tcontainer: HTMLElement,\n\t\t) => IScopedContextKeyService,\n\t\t@ITextModelService private readonly textModelService: ITextModelService,\n\t\t@IConfigurationService\n\t\tprivate readonly _configurationService: IConfigurationService,\n\t\t@IInstantiationService\n\t\tprivate readonly _instantiationService: IInstantiationService,\n\t) {\n\t\tsuper();\n\n\t\tthis._focusedEditorDOM = this.notebookEditor\n\t\t\t.getDomNode()\n\t\t\t.appendChild(DOM.$(\".cell-editor-part-cache\"));\n\t\tthis._focusedEditorDOM.style.position = \"absolute\";\n\t\tthis._focusedEditorDOM.style.top = \"-50000px\";\n\t\tthis._focusedEditorDOM.style.width = \"1px\";\n\t\tthis._focusedEditorDOM.style.height = \"1px\";\n\t}\n\n\tprivate _initializeEditor(cell: ICellViewModel) {\n\t\tthis._editorContextKeyService = this._register(\n\t\t\tthis.contextKeyServiceProvider(this._focusedEditorDOM),\n\t\t);\n\n\t\tconst editorContainer = DOM.prepend(\n\t\t\tthis._focusedEditorDOM,\n\t\t\tDOM.$(\".cell-editor-container\"),\n\t\t);\n\t\tconst editorInstaService = this._register(\n\t\t\tthis._instantiationService.createChild(\n\t\t\t\tnew ServiceCollection([\n\t\t\t\t\tIContextKeyService,\n\t\t\t\t\tthis._editorContextKeyService,\n\t\t\t\t]),\n\t\t\t),\n\t\t);\n\t\tEditorContextKeys.inCompositeEditor\n\t\t\t.bindTo(this._editorContextKeyService)\n\t\t\t.set(true);\n\t\tconst editorOptions = new CellEditorOptions(\n\t\t\tthis.notebookEditor.getBaseCellEditorOptions(cell.language),\n\t\t\tthis.notebookEditor.notebookOptions,\n\t\t\tthis._configurationService,\n\t\t);\n\n\t\tthis._editor = this._register(\n\t\t\teditorInstaService.createInstance(\n\t\t\t\tCodeEditorWidget,\n\t\t\t\teditorContainer,\n\t\t\t\t{\n\t\t\t\t\t...editorOptions.getDefaultValue(),\n\t\t\t\t\tdimension: {\n\t\t\t\t\t\twidth: 0,\n\t\t\t\t\t\theight: 0,\n\t\t\t\t\t},\n\t\t\t\t\tscrollbar: {\n\t\t\t\t\t\tvertical: \"hidden\",\n\t\t\t\t\t\thorizontal: \"auto\",\n\t\t\t\t\t\thandleMouseWheel: false,\n\t\t\t\t\t\tuseShadows: false,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tcontributions:\n\t\t\t\t\t\tthis.notebookEditor.creationOptions\n\t\t\t\t\t\t\t.cellEditorContributions,\n\t\t\t\t},\n\t\t\t),\n\t\t);\n\n\t\tthis._isInitialized = true;\n\t}\n\n\tpreserveFocusedEditor(cell: ICellViewModel): void {\n\t\tif (!this._isInitialized) {\n\t\t\tthis._initializeEditor(cell);\n\t\t}\n\n\t\tthis._editorDisposable.clear();\n\t\tthis._focusEditorCancellablePromise?.cancel();\n\n\t\tthis._focusEditorCancellablePromise = createCancelablePromise(\n\t\t\tasync (token) => {\n\t\t\t\tconst ref = await this.textModelService.createModelReference(\n\t\t\t\t\tcell.uri,\n\t\t\t\t);\n\n\t\t\t\tif (this._isDisposed || token.isCancellationRequested) {\n\t\t\t\t\tref.dispose();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst editorDisposable = new DisposableStore();\n\t\t\t\teditorDisposable.add(ref);\n\t\t\t\tthis._editor.setModel(ref.object.textEditorModel);\n\t\t\t\tthis._editor.setSelections(cell.getSelections());\n\t\t\t\tthis._editor.focus();\n\n\t\t\t\tconst _update = () => {\n\t\t\t\t\tconst editorSelections = this._editor.getSelections();\n\t\t\t\t\tif (editorSelections) {\n\t\t\t\t\t\tcell.setSelections(editorSelections);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.notebookEditor.revealInView(cell);\n\t\t\t\t\tthis._editor.setModel(null);\n\t\t\t\t\tref.dispose();\n\t\t\t\t};\n\n\t\t\t\teditorDisposable.add(\n\t\t\t\t\tthis._editor.onDidChangeModelContent((e) => {\n\t\t\t\t\t\t_update();\n\t\t\t\t\t}),\n\t\t\t\t);\n\n\t\t\t\teditorDisposable.add(\n\t\t\t\t\tthis._editor.onDidChangeCursorSelection((e) => {\n\t\t\t\t\t\tif (e.source === \"keyboard\" || e.source === \"mouse\") {\n\t\t\t\t\t\t\t_update();\n\t\t\t\t\t\t}\n\t\t\t\t\t}),\n\t\t\t\t);\n\n\t\t\t\teditorDisposable.add(\n\t\t\t\t\tthis.notebookEditor.onDidChangeActiveEditor(() => {\n\t\t\t\t\t\tconst latestActiveCell =\n\t\t\t\t\t\t\tthis.notebookEditor.getActiveCell();\n\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tlatestActiveCell !== cell ||\n\t\t\t\t\t\t\tlatestActiveCell.focusMode !== CellFocusMode.Editor\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t// focus moves to another cell or cell container\n\t\t\t\t\t\t\t// we should stop preserving the editor\n\t\t\t\t\t\t\tthis._editorDisposable.clear();\n\t\t\t\t\t\t\tthis._editor.setModel(null);\n\t\t\t\t\t\t\tref.dispose();\n\t\t\t\t\t\t}\n\t\t\t\t\t}),\n\t\t\t\t);\n\n\t\t\t\tthis._editorDisposable.value = editorDisposable;\n\t\t\t},\n\t\t);\n\t}\n\n\toverride dispose() {\n\t\tthis._isDisposed = true;\n\t\tthis._focusEditorCancellablePromise?.cancel();\n\n\t\tsuper.dispose();\n\t}\n}\n"],
  "mappings": "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",
  "names": []
}
