{
  "version": 3,
  "sources": ["../../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/contrib/notebook/browser/view/notebookCellEditorPool.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as DOM from '../../../../../base/browser/dom.js';\nimport { CancelablePromise, createCancelablePromise } from '../../../../../base/common/async.js';\nimport { Disposable, DisposableStore, MutableDisposable } from '../../../../../base/common/lifecycle.js';\nimport { CodeEditorWidget } from '../../../../../editor/browser/widget/codeEditor/codeEditorWidget.js';\nimport { EditorContextKeys } from '../../../../../editor/common/editorContextKeys.js';\nimport { ITextModelService } from '../../../../../editor/common/services/resolverService.js';\nimport { IConfigurationService } from '../../../../../platform/configuration/common/configuration.js';\nimport { IContextKeyService, IScopedContextKeyService } from '../../../../../platform/contextkey/common/contextkey.js';\nimport { IInstantiationService } from '../../../../../platform/instantiation/common/instantiation.js';\nimport { ServiceCollection } from '../../../../../platform/instantiation/common/serviceCollection.js';\nimport { CellFocusMode, ICellViewModel, INotebookEditorDelegate } from '../notebookBrowser.js';\nimport { CellEditorOptions } from './cellParts/cellEditorOptions.js';\n\nexport class NotebookCellEditorPool extends Disposable {\n\tprivate readonly _focusedEditorDOM: HTMLElement;\n\tprivate readonly _editorDisposable = this._register(new MutableDisposable());\n\tprivate _editorContextKeyService!: IScopedContextKeyService;\n\tprivate _editor!: CodeEditorWidget;\n\tprivate _focusEditorCancellablePromise: CancelablePromise<void> | undefined;\n\tprivate _isInitialized = false;\n\tprivate _isDisposed = false;\n\n\tconstructor(\n\t\treadonly notebookEditor: INotebookEditorDelegate,\n\t\tprivate readonly contextKeyServiceProvider: (container: HTMLElement) => IScopedContextKeyService,\n\t\t@ITextModelService private readonly textModelService: ITextModelService,\n\t\t@IConfigurationService private readonly _configurationService: IConfigurationService,\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t) {\n\t\tsuper();\n\n\t\tthis._focusedEditorDOM = this.notebookEditor.getDomNode().appendChild(DOM.$('.cell-editor-part-cache'));\n\t\tthis._focusedEditorDOM.style.position = 'absolute';\n\t\tthis._focusedEditorDOM.style.top = '-50000px';\n\t\tthis._focusedEditorDOM.style.width = '1px';\n\t\tthis._focusedEditorDOM.style.height = '1px';\n\t}\n\n\tprivate _initializeEditor(cell: ICellViewModel) {\n\t\tthis._editorContextKeyService = this._register(this.contextKeyServiceProvider(this._focusedEditorDOM));\n\n\t\tconst editorContainer = DOM.prepend(this._focusedEditorDOM, DOM.$('.cell-editor-container'));\n\t\tconst editorInstaService = this._register(this._instantiationService.createChild(new ServiceCollection([IContextKeyService, this._editorContextKeyService])));\n\t\tEditorContextKeys.inCompositeEditor.bindTo(this._editorContextKeyService).set(true);\n\t\tconst editorOptions = new CellEditorOptions(this.notebookEditor.getBaseCellEditorOptions(cell.language), this.notebookEditor.notebookOptions, this._configurationService);\n\n\t\tthis._editor = this._register(editorInstaService.createInstance(CodeEditorWidget, editorContainer, {\n\t\t\t...editorOptions.getDefaultValue(),\n\t\t\tdimension: {\n\t\t\t\twidth: 0,\n\t\t\t\theight: 0\n\t\t\t},\n\t\t\tscrollbar: {\n\t\t\t\tvertical: 'hidden',\n\t\t\t\thorizontal: 'auto',\n\t\t\t\thandleMouseWheel: false,\n\t\t\t\tuseShadows: false,\n\t\t\t},\n\t\t}, {\n\t\t\tcontributions: this.notebookEditor.creationOptions.cellEditorContributions\n\t\t}));\n\n\t\tthis._isInitialized = true;\n\t}\n\n\tpreserveFocusedEditor(cell: ICellViewModel): void {\n\t\tif (!this._isInitialized) {\n\t\t\tthis._initializeEditor(cell);\n\t\t}\n\n\t\tthis._editorDisposable.clear();\n\t\tthis._focusEditorCancellablePromise?.cancel();\n\n\t\tthis._focusEditorCancellablePromise = createCancelablePromise(async token => {\n\t\t\tconst ref = await this.textModelService.createModelReference(cell.uri);\n\n\t\t\tif (this._isDisposed || token.isCancellationRequested) {\n\t\t\t\tref.dispose();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst editorDisposable = new DisposableStore();\n\t\t\teditorDisposable.add(ref);\n\t\t\tthis._editor.setModel(ref.object.textEditorModel);\n\t\t\tthis._editor.setSelections(cell.getSelections());\n\t\t\tthis._editor.focus();\n\n\t\t\tconst _update = () => {\n\t\t\t\tconst editorSelections = this._editor.getSelections();\n\t\t\t\tif (editorSelections) {\n\t\t\t\t\tcell.setSelections(editorSelections);\n\t\t\t\t}\n\n\t\t\t\tthis.notebookEditor.revealInView(cell);\n\t\t\t\tthis._editor.setModel(null);\n\t\t\t\tref.dispose();\n\t\t\t};\n\n\t\t\teditorDisposable.add(this._editor.onDidChangeModelContent((e) => {\n\t\t\t\t_update();\n\t\t\t}));\n\n\t\t\teditorDisposable.add(this._editor.onDidChangeCursorSelection(e => {\n\t\t\t\tif (e.source === 'keyboard' || e.source === 'mouse') {\n\t\t\t\t\t_update();\n\t\t\t\t}\n\t\t\t}));\n\n\t\t\teditorDisposable.add(this.notebookEditor.onDidChangeActiveEditor(() => {\n\t\t\t\tconst latestActiveCell = this.notebookEditor.getActiveCell();\n\n\t\t\t\tif (latestActiveCell !== cell || latestActiveCell.focusMode !== CellFocusMode.Editor) {\n\t\t\t\t\t// focus moves to another cell or cell container\n\t\t\t\t\t// we should stop preserving the editor\n\t\t\t\t\tthis._editorDisposable.clear();\n\t\t\t\t\tthis._editor.setModel(null);\n\t\t\t\t\tref.dispose();\n\t\t\t\t}\n\t\t\t}));\n\n\t\t\tthis._editorDisposable.value = editorDisposable;\n\t\t});\n\t}\n\n\toverride dispose() {\n\t\tthis._isDisposed = true;\n\t\tthis._focusEditorCancellablePromise?.cancel();\n\n\t\tsuper.dispose();\n\t}\n}\n"],
  "mappings": "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",
  "names": []
}
