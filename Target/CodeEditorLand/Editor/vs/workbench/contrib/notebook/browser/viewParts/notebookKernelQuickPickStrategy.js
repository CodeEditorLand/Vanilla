var $=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var D=(d,a,e,t)=>{for(var i=t>1?void 0:t?F(a,e):a,o=d.length-1,n;o>=0;o--)(n=d[o])&&(i=(t?n(a,e,i):n(i))||i);return t&&i&&$(a,e,i),i},p=(d,a)=>(e,t)=>a(e,t,d);import"../../../../../../vs/base/common/actions.js";import{groupBy as V}from"../../../../../../vs/base/common/arrays.js";import{createCancelablePromise as j}from"../../../../../../vs/base/common/async.js";import{CancellationToken as U}from"../../../../../../vs/base/common/cancellation.js";import{Codicon as R}from"../../../../../../vs/base/common/codicons.js";import{Event as x}from"../../../../../../vs/base/common/event.js";import{DisposableStore as w}from"../../../../../../vs/base/common/lifecycle.js";import{MarshalledId as X}from"../../../../../../vs/base/common/marshallingIds.js";import{uppercaseFirstLetter as z}from"../../../../../../vs/base/common/strings.js";import{ThemeIcon as S}from"../../../../../../vs/base/common/themables.js";import{URI as L}from"../../../../../../vs/base/common/uri.js";import"../../../../../../vs/editor/common/languages.js";import{localize as I}from"../../../../../../vs/nls.js";import{ICommandService as J}from"../../../../../../vs/platform/commands/common/commands.js";import"../../../../../../vs/platform/contextkey/common/contextkey.js";import{ILabelService as Y}from"../../../../../../vs/platform/label/common/label.js";import{ILogService as Z}from"../../../../../../vs/platform/log/common/log.js";import{IOpenerService as ee}from"../../../../../../vs/platform/opener/common/opener.js";import{IProductService as te}from"../../../../../../vs/platform/product/common/productService.js";import{ProgressLocation as ie}from"../../../../../../vs/platform/progress/common/progress.js";import{IQuickInputService as ne}from"../../../../../../vs/platform/quickinput/common/quickInput.js";import{ViewContainerLocation as oe}from"../../../../../../vs/workbench/common/views.js";import{VIEWLET_ID as re,IExtensionsWorkbenchService as se}from"../../../../../../vs/workbench/contrib/extensions/common/extensions.js";import{SELECT_KERNEL_ID as ce}from"../../../../../../vs/workbench/contrib/notebook/browser/controller/coreActions.js";import{JUPYTER_EXTENSION_ID as le,KERNEL_RECOMMENDATIONS as ae}from"../../../../../../vs/workbench/contrib/notebook/browser/notebookBrowser.js";import"../../../../../../vs/workbench/contrib/notebook/browser/notebookEditorWidget.js";import{executingStateIcon as q,selectKernelIcon as C}from"../../../../../../vs/workbench/contrib/notebook/browser/notebookIcons.js";import"../../../../../../vs/workbench/contrib/notebook/common/model/notebookTextModel.js";import"../../../../../../vs/workbench/contrib/notebook/common/notebookCommon.js";import{INotebookKernelHistoryService as ue,INotebookKernelService as de}from"../../../../../../vs/workbench/contrib/notebook/common/notebookKernelService.js";import{EnablementState as h}from"../../../../../../vs/workbench/services/extensionManagement/common/extensionManagement.js";import{IExtensionService as ke}from"../../../../../../vs/workbench/services/extensions/common/extensions.js";import{IPaneCompositePartService as me}from"../../../../../../vs/workbench/services/panecomposite/browser/panecomposite.js";function K(d){return"kernel"in d}function Ie(d){return"kernels"in d}function _(d){return"action"in d}function B(d){return d.id==="installSuggested"&&"extensionIds"in d}function W(d){return d.id==="install"}function O(d){return"command"in d}function pe(d){return"autoRun"in d&&!!d.autoRun}const H=200;function A(d,a){const e={kernel:d,picked:d.id===a?.id,label:d.label,description:d.description,detail:d.detail};return d.id===a?.id&&(e.description?e.description=I("current2","{0} - Currently Selected",e.description):e.description=I("current1","Currently Selected")),e}class he{constructor(a,e,t,i,o,n,l,s,u){this._notebookKernelService=a;this._productService=e;this._quickInputService=t;this._labelService=i;this._logService=o;this._paneCompositePartService=n;this._extensionWorkbenchService=l;this._extensionService=s;this._commandService=u}async showQuickPick(a,e,t){const i=a.textModel,o=a.scopedContextKeyService,n=this._getMatchingResult(i),{selected:l,all:s}=n;let u;if(e){for(const m of s)if(m.id===e){u=m;break}if(!u)return this._logService.warn(`wanted kernel DOES NOT EXIST, wanted: ${e}, all: ${s.map(m=>m.id)}`),!1}if(u)return this._selecteKernel(i,u),!0;const r=new w,c=r.add(this._quickInputService.createQuickPick({useSeparators:!0})),k=this._getKernelPickerQuickPickItems(i,n,this._notebookKernelService,o);if(k.length===1&&pe(k[0])&&!t){const m=await this._handleQuickPick(a,k[0],k);return r.dispose(),m}c.items=k,c.canSelectMany=!1,c.placeholder=l?I("prompt.placeholder.change","Change kernel for '{0}'",this._labelService.getUriLabel(i.uri,{relative:!0})):I("prompt.placeholder.select","Select kernel for '{0}'",this._labelService.getUriLabel(i.uri,{relative:!0})),c.busy=this._notebookKernelService.getKernelDetectionTasks(i).length>0;const b=this._notebookKernelService.onDidChangeKernelDetectionTasks(()=>{c.busy=this._notebookKernelService.getKernelDetectionTasks(i).length>0}),M=k.length===0?j(m=>this._showInstallKernelExtensionRecommendation(i,c,this._extensionWorkbenchService,m)):void 0,G=x.debounce(x.any(this._notebookKernelService.onDidChangeSourceActions,this._notebookKernelService.onDidAddKernel,this._notebookKernelService.onDidRemoveKernel,this._notebookKernelService.onDidChangeNotebookAffinity),(m,Q)=>m,H)(async()=>{c.busy=!1,M?.cancel();const m=c.activeItems,Q=this._getMatchingResult(i),f=this._getKernelPickerQuickPickItems(i,Q,this._notebookKernelService,o);c.keepScrollPosition=!0;const N=[];for(const P of m)if(K(P)){const v=P.kernel.id,g=f.find(T=>K(T)&&T.kernel.id===v);g&&N.push(g)}else if(_(P)){const v=f.find(g=>_(g)&&g.action.action.id===P.action.action.id);v&&N.push(v)}c.items=f,c.activeItems=N},this),E=await new Promise((m,Q)=>{r.add(c.onDidAccept(()=>{const f=c.selectedItems[0];m(f?{selected:f,items:c.items}:{selected:void 0,items:c.items}),c.hide()})),r.add(c.onDidHide(()=>{b.dispose(),G.dispose(),c.dispose(),m({selected:void 0,items:c.items})})),c.show()});return r.dispose(),E.selected?await this._handleQuickPick(a,E.selected,E.items):!1}_getMatchingResult(a){return this._notebookKernelService.getMatchingKernel(a)}async _handleQuickPick(a,e,t){if(K(e)){const i=e.kernel;return this._selecteKernel(a.textModel,i),!0}return W(e)?await this._showKernelExtension(this._paneCompositePartService,this._extensionWorkbenchService,this._extensionService,a.textModel.viewType,[]):B(e)?await this._showKernelExtension(this._paneCompositePartService,this._extensionWorkbenchService,this._extensionService,a.textModel.viewType,e.extensionIds,this._productService.quality!=="stable"):_(e)&&e.action.runAction(),!0}_selecteKernel(a,e){this._notebookKernelService.selectKernelForNotebook(e,a)}async _showKernelExtension(a,e,t,i,o,n){const l=[],s=[];for(const k of o){const b=(await e.getExtensions([{id:k}],U.None))[0];b.enablementState===h.DisabledGlobally||b.enablementState===h.DisabledWorkspace||b.enablementState===h.DisabledByEnvironment?s.push(b):await e.canInstall(b)&&l.push(b)}if(l.length||s.length){await Promise.all([...l.map(async k=>{await e.install(k,{installPreReleaseVersion:n??!1,context:{skipWalkthrough:!0}},ie.Notification)}),...s.map(async k=>{switch(k.enablementState){case h.DisabledWorkspace:await e.setEnablement([k],h.EnabledWorkspace);return;case h.DisabledGlobally:await e.setEnablement([k],h.EnabledGlobally);return;case h.DisabledByEnvironment:await e.setEnablement([k],h.EnabledByEnvironment);return;default:break}})]),await t.activateByEvent(`onNotebook:${i}`);return}const r=(await a.openPaneComposite(re,oe.Sidebar,!0))?.getViewPaneContainer(),c=i.split(/[^a-z0-9]/gi).map(z).join("");r?.search(`@tag:notebookKernel${c}`)}async _showInstallKernelExtensionRecommendation(a,e,t,i){e.busy=!0;const o=await this._getKernelRecommendationsQuickPickItems(a,t);e.busy=!1,!i.isCancellationRequested&&o&&e.items.length===0&&(e.items=o)}async _getKernelRecommendationsQuickPickItems(a,e){const t=[],i=this.getSuggestedLanguage(a),o=i?this.getSuggestedKernelFromLanguage(a.viewType,i):void 0;if(o){if(await e.queryLocal(),e.installed.filter(l=>(l.enablementState===h.EnabledByEnvironment||l.enablementState===h.EnabledGlobally||l.enablementState===h.EnabledWorkspace)&&o.extensionIds.includes(l.identifier.id)).length===o.extensionIds.length)return;t.push({id:"installSuggested",description:o.displayName??o.extensionIds.join(", "),label:`$(${R.lightbulb.id}) `+I("installSuggestedKernel","Install/Enable suggested extensions"),extensionIds:o.extensionIds})}return t.push({id:"install",label:I("searchForKernels","Browse marketplace for kernel extensions")}),t}getSuggestedLanguage(a){let t=a.metadata?.metadata?.language_info?.name;if(!t){const i=a.cells.map(o=>o.language).filter(o=>o!=="markdown");if(i.length>1){const o=i[0];i.every(n=>n===o)&&(t=o)}}return t}getSuggestedKernelFromLanguage(a,e){return ae.get(a)?.get(e)}}let y=class extends he{constructor(e,t,i,o,n,l,s,u,r,c,k){super(e,t,i,o,n,l,s,u,r);this._notebookKernelHistoryService=c;this._openerService=k}_getKernelPickerQuickPickItems(e,t,i,o){const n=[];if(t.selected){const s=A(t.selected,t.selected);n.push(s)}t.suggestions.filter(s=>s.id!==t.selected?.id).map(s=>A(s,t.selected)).forEach(s=>{n.push(s)});const l=n.length===0;return n.length>0&&n.push({type:"separator"}),n.push({id:"selectAnother",label:I("selectAnotherKernel.more","Select Another Kernel..."),autoRun:l}),n}_selecteKernel(e,t){const i=this._notebookKernelService.getMatchingKernel(e);i.selected&&this._notebookKernelHistoryService.addMostRecentKernel(i.selected),super._selecteKernel(e,t),this._notebookKernelHistoryService.addMostRecentKernel(t)}_getMatchingResult(e){const{selected:t,all:i}=this._notebookKernelHistoryService.getKernels(e),o=this._notebookKernelService.getMatchingKernel(e);return{selected:t,all:o.all,suggestions:i,hidden:[]}}async _handleQuickPick(e,t,i){return t.id==="selectAnother"?this.displaySelectAnotherQuickPick(e,i.length===1&&i[0]===t):super._handleQuickPick(e,t,i)}async displaySelectAnotherQuickPick(e,t){const i=e.textModel,o=new w,n=o.add(this._quickInputService.createQuickPick({useSeparators:!0})),l=await new Promise(s=>{n.title=t?I("select","Select Kernel"):I("selectAnotherKernel","Select Another Kernel"),n.placeholder=I("selectKernel.placeholder","Type to choose a kernel source"),n.busy=!0,n.buttons=[this._quickInputService.backButton],n.show(),o.add(n.onDidTriggerButton(u=>{u===this._quickInputService.backButton&&s(u)})),o.add(n.onDidTriggerItemButton(async u=>{if(O(u.item)&&u.item.documentation!==void 0){const r=L.isUri(u.item.documentation)?L.parse(u.item.documentation):await this._commandService.executeCommand(u.item.documentation);this._openerService.open(r,{openExternal:!0})}})),o.add(n.onDidAccept(async()=>{s(n.selectedItems[0])})),o.add(n.onDidHide(()=>{s(void 0)})),this._calculdateKernelSources(e).then(u=>{n.items=u,n.items.length>0&&(n.busy=!1)}),o.add(x.debounce(x.any(this._notebookKernelService.onDidChangeSourceActions,this._notebookKernelService.onDidAddKernel,this._notebookKernelService.onDidRemoveKernel),(u,r)=>u,H)(async()=>{n.busy=!0;const u=await this._calculdateKernelSources(e);n.items=u,n.busy=!1}))});if(n.hide(),o.dispose(),l===this._quickInputService.backButton)return this.showQuickPick(e,void 0,!0);if(l){const s=l;if(O(s))try{const u=await this._executeCommand(i,s.command);if(u){const{all:r}=await this._getMatchingResult(i),c=r.find(k=>k.id===`ms-toolsai.jupyter/${u}`);return c&&await this._selecteKernel(i,c),!0}else return this.displaySelectAnotherQuickPick(e,!1)}catch{return!1}else{if(K(s))return await this._selecteKernel(i,s.kernel),!0;if(Ie(s))return await this._selectOneKernel(i,s.label,s.kernels),!0;if(_(s))try{return await s.action.runAction(),!0}catch{return!1}else{if(W(s))return await this._showKernelExtension(this._paneCompositePartService,this._extensionWorkbenchService,this._extensionService,e.textModel.viewType,[]),!0;if(B(s))return await this._showKernelExtension(this._paneCompositePartService,this._extensionWorkbenchService,this._extensionService,e.textModel.viewType,s.extensionIds,this._productService.quality!=="stable"),this.displaySelectAnotherQuickPick(e,!1)}}}return!1}async _calculdateKernelSources(e){const t=e.textModel,i=this._notebookKernelService.getSourceActions(t,e.scopedContextKeyService),o=await this._notebookKernelService.getKernelSourceActions2(t),n=this._getMatchingResult(t);if(i.length===0&&n.all.length===0&&o.length===0)return await this._getKernelRecommendationsQuickPickItems(t,this._extensionWorkbenchService)??[];const l=n.all.filter(r=>r.extension.value!==le),s=[];for(const r of V(l,(c,k)=>c.extension.value===k.extension.value?0:1)){const c=this._extensionService.extensions.find(b=>b.identifier.value===r[0].extension.value),k=c?.displayName??c?.description??r[0].extension.value;r.length>1?s.push({label:k,kernels:r}):s.push({label:r[0].label,kernel:r[0]})}const u=o.filter(r=>r.command);s.push(...u.map(r=>{const c=r.documentation?[{iconClass:S.asClassName(R.info),tooltip:I("learnMoreTooltip","Learn More")}]:[];return{id:typeof r.command=="string"?r.command:r.command.id,label:r.label,description:r.description,command:r.command,documentation:r.documentation,buttons:c}}));for(const r of i){const c={action:r,picked:!1,label:r.action.label,tooltip:r.action.tooltip};s.push(c)}return s}async _selectOneKernel(e,t,i){const o=i.map(s=>A(s,void 0)),n=new w,l=n.add(this._quickInputService.createQuickPick({useSeparators:!0}));l.items=o,l.canSelectMany=!1,l.title=I("selectKernelFromExtension","Select Kernel from {0}",t),n.add(l.onDidAccept(async()=>{l.selectedItems&&l.selectedItems.length>0&&K(l.selectedItems[0])&&await this._selecteKernel(e,l.selectedItems[0].kernel),l.hide(),l.dispose()})),n.add(l.onDidHide(()=>{n.dispose()})),l.show()}async _executeCommand(e,t){const i=typeof t=="string"?t:t.id,o=typeof t=="string"?[]:t.arguments??[];return(typeof t=="string"||!t.arguments||!Array.isArray(t.arguments)||t.arguments.length===0)&&o.unshift({uri:e.uri,$mid:X.NotebookActionContext}),typeof t=="string"?this._commandService.executeCommand(i):this._commandService.executeCommand(i,...o)}static updateKernelStatusAction(e,t,i,o){if(i.getKernelDetectionTasks(e).length){const r=i.getMatchingKernel(e);if(t.enabled=!0,t.class=S.asClassName(S.modify(q,"spin")),r.selected){t.label=r.selected.label;const c=r.selected.description??r.selected.detail;t.tooltip=c?I("kernels.selectedKernelAndKernelDetectionRunning","Selected Kernel: {0} (Kernel Detection Tasks Running)",c):I("kernels.detecting","Detecting Kernels")}else t.label=I("kernels.detecting","Detecting Kernels");return}const l=i.getRunningSourceActions(e),s=(r,c)=>{const k=r.action;t.class=c?S.asClassName(S.modify(q,"spin")):S.asClassName(C),t.label=k.label,t.enabled=!0};if(l.length)return s(l[0],!0);const{selected:u}=o.getKernels(e);u?(t.label=u.label,t.class=S.asClassName(C),t.tooltip=u.description??u.detail??""):(t.label=I("select","Select Kernel"),t.class=S.asClassName(C),t.tooltip="")}static async resolveKernel(e,t,i,o){const n=i.getKernels(e);if(n.selected)return n.selected;await o.executeCommand(ce);const{selected:l}=i.getKernels(e);return l}};y=D([p(0,de),p(1,te),p(2,ne),p(3,Y),p(4,Z),p(5,me),p(6,se),p(7,ke),p(8,J),p(9,ue),p(10,ee)],y);export{y as KernelPickerMRUStrategy};
