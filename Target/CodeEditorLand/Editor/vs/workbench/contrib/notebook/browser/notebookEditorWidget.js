var me=Object.defineProperty;var fe=Object.getOwnPropertyDescriptor;var ee=(T,M,e,t)=>{for(var i=t>1?void 0:t?fe(M,e):M,o=T.length-1,n;o>=0;o--)(n=T[o])&&(i=(t?n(M,e,i):n(i))||i);return t&&i&&me(M,e,i),i},v=(T,M)=>(e,t)=>M(e,t,T);import"./media/notebook.css";import"./media/notebookCellChat.css";import"./media/notebookCellEditorHint.css";import"./media/notebookCellInsertToolbar.css";import"./media/notebookCellStatusBar.css";import"./media/notebookCellTitleToolbar.css";import"./media/notebookFocusIndicator.css";import"./media/notebookToolbar.css";import"./media/notebookDnd.css";import"./media/notebookFolding.css";import"./media/notebookCellOutput.css";import"./media/notebookEditorStickyScroll.css";import"./media/notebookKernelActionViewItem.css";import"./media/notebookOutline.css";import*as u from"../../../../base/browser/dom.js";import"../../../../base/browser/mouseEvent.js";import"../../../../base/browser/ui/list/list.js";import{mainWindow as te}from"../../../../base/browser/window.js";import{DeferredPromise as ge,SequencerByKey as _e}from"../../../../base/common/async.js";import"../../../../base/common/cancellation.js";import{Color as E,RGBA as G}from"../../../../base/common/color.js";import{onUnexpectedError as Ce}from"../../../../base/common/errors.js";import{Emitter as w,Event as ke}from"../../../../base/common/event.js";import{combinedDisposable as ye,Disposable as Ie,DisposableStore as oe,dispose as q,toDisposable as Me}from"../../../../base/common/lifecycle.js";import{setTimeout0 as Se}from"../../../../base/common/platform.js";import{extname as Oe,isEqual as Ee}from"../../../../base/common/resources.js";import"../../../../base/common/uri.js";import{generateUuid as ie}from"../../../../base/common/uuid.js";import{FontMeasurements as xe}from"../../../../editor/browser/config/fontMeasurements.js";import"../../../../editor/browser/editorBrowser.js";import"../../../../editor/common/config/editorOptions.js";import{BareFontInfo as De}from"../../../../editor/common/config/fontInfo.js";import{Range as F}from"../../../../editor/common/core/range.js";import"../../../../editor/common/core/selection.js";import{SuggestController as Ve}from"../../../../editor/contrib/suggest/browser/suggestController.js";import*as p from"../../../../nls.js";import{MenuId as x}from"../../../../platform/actions/common/actions.js";import{IConfigurationService as Te}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as ne,RawContextKey as Ne}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as Re}from"../../../../platform/contextview/browser/contextView.js";import{IInstantiationService as Le}from"../../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as Fe}from"../../../../platform/instantiation/common/serviceCollection.js";import{ILayoutService as Be}from"../../../../platform/layout/browser/layoutService.js";import{registerZIndex as f,ZIndex as g}from"../../../../platform/layout/browser/zIndexRegistry.js";import{IEditorProgressService as He}from"../../../../platform/progress/common/progress.js";import{ITelemetryService as Ae}from"../../../../platform/telemetry/common/telemetry.js";import{contrastBorder as Y,errorForeground as Pe,focusBorder as R,foreground as B,listInactiveSelectionBackground as Z,registerColor as b,scrollbarSliderActiveBackground as We,scrollbarSliderBackground as Ke,scrollbarSliderHoverBackground as $e,transparent as j}from"../../../../platform/theme/common/colorRegistry.js";import{EDITOR_PANE_BACKGROUND as le,PANEL_BORDER as re,SIDE_BAR_BACKGROUND as se}from"../../../common/theme.js";import{debugIconStartForeground as ae}from"../../debug/browser/debugColors.js";import{CellEditState as D,CellFocusMode as k,CellRevealRangeType as H,CellRevealType as A,RenderOutputType as $,ScrollToRevealBehavior as de}from"./notebookBrowser.js";import{NotebookEditorExtensionsRegistry as ze}from"./notebookEditorExtensions.js";import{INotebookEditorService as Ue}from"./services/notebookEditorService.js";import{notebookDebug as Ge}from"./notebookLogger.js";import{NotebookLayoutChangedEvent as ce}from"./notebookViewEvents.js";import{CellContextKeyManager as qe}from"./view/cellParts/cellContextKeys.js";import{CellDragAndDropController as Ye}from"./view/cellParts/cellDnd.js";import{ListViewInfoAccessor as Ze,NotebookCellList as je,NOTEBOOK_WEBVIEW_BOUNDARY as Qe}from"./view/notebookCellList.js";import"./view/notebookRenderingCommon.js";import{BackLayerWebView as Je}from"./view/renderers/backLayerWebView.js";import{CodeCellRenderer as Xe,MarkupCellRenderer as et,NotebookCellListDelegate as tt}from"./view/renderers/cellRenderer.js";import"./view/renderers/webviewMessages.js";import{CodeCellViewModel as he,outputDisplayLimit as ot}from"./viewModel/codeCellViewModel.js";import{NotebookEventDispatcher as it}from"./viewModel/eventDispatcher.js";import{MarkupCellViewModel as P}from"./viewModel/markupCellViewModel.js";import{NotebookViewModel as nt}from"./viewModel/notebookViewModelImpl.js";import{ViewContext as lt}from"./viewModel/viewContext.js";import{NotebookEditorWorkbenchToolbar as rt}from"./viewParts/notebookEditorToolbar.js";import{NotebookEditorContextKeys as st}from"./viewParts/notebookEditorWidgetContextKeys.js";import{NotebookOverviewRuler as at}from"./viewParts/notebookOverviewRuler.js";import{ListTopCellToolbar as dt}from"./viewParts/notebookTopCellToolbar.js";import"../common/model/notebookTextModel.js";import{CellEditType as ct,CellKind as y,NotebookFindScopeType as ue,RENDERER_NOT_AVAILABLE as ht,SelectionStateType as W}from"../common/notebookCommon.js";import{NOTEBOOK_CURSOR_NAVIGATION_MODE as ut,NOTEBOOK_EDITOR_EDITABLE as pt,NOTEBOOK_EDITOR_FOCUSED as bt,NOTEBOOK_OUTPUT_FOCUSED as wt,NOTEBOOK_OUTPUT_INPUT_FOCUSED as vt}from"../common/notebookContextKeys.js";import{INotebookExecutionService as mt}from"../common/notebookExecutionService.js";import{INotebookExecutionStateService as ft}from"../common/notebookExecutionStateService.js";import{INotebookKernelService as gt}from"../common/notebookKernelService.js";import{NotebookOptions as _t,OutputInnerContainerTopPadding as pe}from"./notebookOptions.js";import{cellRangesToIndexes as Ct}from"../common/notebookRange.js";import{INotebookRendererMessagingService as kt}from"../common/notebookRendererMessagingService.js";import{INotebookService as yt}from"../common/notebookService.js";import"../../webview/browser/webview.js";import{EditorExtensionsRegistry as It}from"../../../../editor/browser/editorExtensions.js";import{IEditorGroupsService as Mt}from"../../../services/editor/common/editorGroupsService.js";import"../common/notebookPerformance.js";import{BaseCellEditorOptions as St}from"./viewModel/cellEditorOptions.js";import{FloatingEditorClickMenu as Ot}from"../../../browser/codeeditor.js";import"../../../../editor/common/core/dimension.js";import{CellFindMatchModel as be}from"./contrib/find/findModel.js";import{INotebookLoggingService as Et}from"../common/notebookLoggingService.js";import{Schemas as xt}from"../../../../base/common/network.js";import{DropIntoEditorController as Dt}from"../../../../editor/contrib/dropOrPasteInto/browser/dropIntoEditorController.js";import{CopyPasteController as Vt}from"../../../../editor/contrib/dropOrPasteInto/browser/copyPasteController.js";import{NotebookStickyScroll as Tt}from"./viewParts/notebookEditorStickyScroll.js";import{AccessibilityVerbositySettingId as Nt}from"../../accessibility/browser/accessibilityConfiguration.js";import{IKeybindingService as Rt}from"../../../../platform/keybinding/common/keybinding.js";import{PixelRatio as Lt}from"../../../../base/browser/pixelRatio.js";import{PreventDefaultContextMenuItemsContextKeyName as Ft}from"../../webview/browser/webview.contribution.js";import{NotebookAccessibilityProvider as Bt}from"./notebookAccessibilityProvider.js";import{NotebookHorizontalTracker as Ht}from"./viewParts/notebookHorizontalTracker.js";import{NotebookCellEditorPool as At}from"./view/notebookCellEditorPool.js";const Pt=u.$;function On(){const T=["editor.contrib.review",Ot.ID,"editor.contrib.dirtydiff","editor.contrib.testingOutputPeek","editor.contrib.testingDecorations","store.contrib.stickyScrollController","editor.contrib.findController","editor.contrib.emptyTextEditorHint"],M=It.getEditorContributions().filter(e=>T.indexOf(e.id)===-1);return{menuIds:{notebookToolbar:x.NotebookToolbar,cellTitleToolbar:x.NotebookCellTitle,cellDeleteToolbar:x.NotebookCellDelete,cellInsertToolbar:x.NotebookCellBetween,cellTopInsertToolbar:x.NotebookCellListTop,cellExecuteToolbar:x.NotebookCellExecute,cellExecutePrimary:x.NotebookCellExecutePrimary},cellEditorContributions:M}}let Q=class extends Ie{constructor(e,t,i,o,n,l,r,a,d,h,_,I,L,m,S,K,O,X){super();this.creationOptions=e;this.notebookRendererMessaging=n;this.notebookEditorService=l;this.notebookKernelService=r;this._notebookService=a;this.configurationService=d;this.layoutService=_;this.contextMenuService=I;this.telemetryService=L;this.notebookExecutionService=m;this.notebookExecutionStateService=S;this.editorProgressService=K;this.logService=O;this.keybindingService=X;this._dimension=t,this.isEmbedded=e.isEmbedded??!1,this._readOnly=e.isReadOnly??!1,this._inRepl=e.forRepl??!1,this._overlayContainer=document.createElement("div"),this.scopedContextKeyService=this._register(h.createScoped(this._overlayContainer)),this.instantiationService=this._register(i.createChild(new Fe([ne,this.scopedContextKeyService]))),this._notebookOptions=e.options??this.instantiationService.createInstance(_t,this.creationOptions?.codeWindow??te,this._readOnly,void 0),this._register(this._notebookOptions);const C=this._register(new it);this._viewContext=new lt(this._notebookOptions,C,c=>this.getBaseCellEditorOptions(c)),this._register(this._viewContext.eventDispatcher.onDidChangeLayout(()=>{this._onDidChangeLayout.fire()})),this._register(this._viewContext.eventDispatcher.onDidChangeCellState(c=>{this._onDidChangeCellState.fire(c)})),this._register(a.onDidChangeOutputRenderers(()=>{this._updateOutputRenderers()})),this._register(this.instantiationService.createInstance(st,this)),this._register(r.onDidChangeSelectedNotebooks(c=>{Ee(c.notebook,this.viewModel?.uri)&&(this._loadKernelPreloads(),this._onDidChangeActiveKernel.fire())})),this._scrollBeyondLastLine=this.configurationService.getValue("editor.scrollBeyondLastLine"),this._register(this.configurationService.onDidChangeConfiguration(c=>{c.affectsConfiguration("editor.scrollBeyondLastLine")&&(this._scrollBeyondLastLine=this.configurationService.getValue("editor.scrollBeyondLastLine"),this._dimension&&this._isVisible&&this.layout(this._dimension))})),this._register(this._notebookOptions.onDidChangeOptions(c=>{(c.cellStatusBarVisibility||c.cellToolbarLocation||c.cellToolbarInteraction)&&this._updateForNotebookConfiguration(),c.fontFamily&&this._generateFontInfo(),(c.compactView||c.focusIndicator||c.insertToolbarPosition||c.cellToolbarLocation||c.dragAndDropEnabled||c.fontSize||c.markupFontSize||c.markdownLineHeight||c.fontFamily||c.insertToolbarAlignment||c.outputFontSize||c.outputLineHeight||c.outputFontFamily||c.outputWordWrap||c.outputScrolling||c.outputLinkifyFilePaths||c.minimalError)&&(this._styleElement?.remove(),this._createLayoutStyles(),this._webview?.updateOptions({...this.notebookOptions.computeWebviewOptions(),fontFamily:this._generateFontFamily()})),this._dimension&&this._isVisible&&this.layout(this._dimension)}));const N=e.codeWindow?this.layoutService.getContainer(e.codeWindow):this.layoutService.mainContainer;this._register(o.getPart(N).onDidScroll(c=>{!this._shadowElement||!this._isVisible||(this.updateShadowElement(this._shadowElement,this._dimension),this.layoutContainerOverShadowElement(this._dimension,this._position))})),this.notebookEditorService.addNotebookEditor(this);const z=ie();this._overlayContainer.id=`notebook-${z}`,this._overlayContainer.className="notebookOverlay",this._overlayContainer.classList.add("notebook-editor"),this._overlayContainer.inert=!0,this._overlayContainer.style.visibility="hidden",N.appendChild(this._overlayContainer),this._createBody(this._overlayContainer),this._generateFontInfo(),this._isVisible=!0,this._editorFocus=bt.bindTo(this.scopedContextKeyService),this._outputFocus=wt.bindTo(this.scopedContextKeyService),this._outputInputFocus=vt.bindTo(this.scopedContextKeyService),this._editorEditable=pt.bindTo(this.scopedContextKeyService),this._cursorNavMode=ut.bindTo(this.scopedContextKeyService),new Ne(Ft,!1).bindTo(this.scopedContextKeyService).set(!0),this._editorEditable.set(!e.isReadOnly);let s;Array.isArray(this.creationOptions.contributions)?s=this.creationOptions.contributions:s=ze.getEditorContributions();for(const c of s){let U;try{U=this.instantiationService.createInstance(c.ctor,this)}catch(ve){Ce(ve)}if(U)if(!this._contributions.has(c.id))this._contributions.set(c.id,U);else throw U.dispose(),new Error(`DUPLICATE notebook editor contribution: '${c.id}'`)}this._updateForNotebookConfiguration()}_onDidChangeCellState=this._register(new w);onDidChangeCellState=this._onDidChangeCellState.event;_onDidChangeViewCells=this._register(new w);onDidChangeViewCells=this._onDidChangeViewCells.event;_onWillChangeModel=this._register(new w);onWillChangeModel=this._onWillChangeModel.event;_onDidChangeModel=this._register(new w);onDidChangeModel=this._onDidChangeModel.event;_onDidAttachViewModel=this._register(new w);onDidAttachViewModel=this._onDidAttachViewModel.event;_onDidChangeOptions=this._register(new w);onDidChangeOptions=this._onDidChangeOptions.event;_onDidChangeDecorations=this._register(new w);onDidChangeDecorations=this._onDidChangeDecorations.event;_onDidScroll=this._register(new w);onDidScroll=this._onDidScroll.event;_onDidChangeLayout=this._register(new w);onDidChangeLayout=this._onDidChangeLayout.event;_onDidChangeActiveCell=this._register(new w);onDidChangeActiveCell=this._onDidChangeActiveCell.event;_onDidChangeFocus=this._register(new w);onDidChangeFocus=this._onDidChangeFocus.event;_onDidChangeSelection=this._register(new w);onDidChangeSelection=this._onDidChangeSelection.event;_onDidChangeVisibleRanges=this._register(new w);onDidChangeVisibleRanges=this._onDidChangeVisibleRanges.event;_onDidFocusEmitter=this._register(new w);onDidFocusWidget=this._onDidFocusEmitter.event;_onDidBlurEmitter=this._register(new w);onDidBlurWidget=this._onDidBlurEmitter.event;_onDidChangeActiveEditor=this._register(new w);onDidChangeActiveEditor=this._onDidChangeActiveEditor.event;_onDidChangeActiveKernel=this._register(new w);onDidChangeActiveKernel=this._onDidChangeActiveKernel.event;_onMouseUp=this._register(new w);onMouseUp=this._onMouseUp.event;_onMouseDown=this._register(new w);onMouseDown=this._onMouseDown.event;_onDidReceiveMessage=this._register(new w);onDidReceiveMessage=this._onDidReceiveMessage.event;_onDidRenderOutput=this._register(new w);onDidRenderOutput=this._onDidRenderOutput.event;_onDidRemoveOutput=this._register(new w);onDidRemoveOutput=this._onDidRemoveOutput.event;_onDidResizeOutputEmitter=this._register(new w);onDidResizeOutput=this._onDidResizeOutputEmitter.event;_overlayContainer;_notebookTopToolbarContainer;_notebookTopToolbar;_notebookStickyScrollContainer;_notebookStickyScroll;_notebookOverviewRulerContainer;_notebookOverviewRuler;_body;_styleElement;_overflowContainer;_webview=null;_webviewResolvePromise=null;_webviewTransparentCover=null;_listDelegate=null;_list;_listViewInfoAccessor;_dndController=null;_listTopCellToolbar=null;_renderedEditors=new Map;_editorPool;_viewContext;_notebookViewModel;_localStore=this._register(new oe);_localCellStateListeners=[];_fontInfo;_dimension;_position;_shadowElement;_shadowElementViewInfo=null;_editorFocus;_outputFocus;_editorEditable;_cursorNavMode;_outputInputFocus;_contributions=new Map;_scrollBeyondLastLine;_insetModifyQueueByOutputId=new _e;_cellContextKeyManager=null;_uuid=ie();_focusTracker;_webviewFocused=!1;_isVisible=!1;get isVisible(){return this._isVisible}_isDisposed=!1;get isDisposed(){return this._isDisposed}set viewModel(e){this._onWillChangeModel.fire(this._notebookViewModel?.notebookDocument),this._notebookViewModel=e,this._onDidChangeModel.fire(e?.notebookDocument)}get viewModel(){return this._notebookViewModel}get textModel(){return this._notebookViewModel?.notebookDocument}get isReadOnly(){return this._notebookViewModel?.options.isReadOnly??!1}get activeCodeEditor(){if(this._isDisposed)return;const[e]=this._list.getFocusedElements();return this._renderedEditors.get(e)}get activeCellAndCodeEditor(){if(this._isDisposed)return;const[e]=this._list.getFocusedElements(),t=this._renderedEditors.get(e);if(t)return[e,t]}get codeEditors(){return[...this._renderedEditors]}get visibleRanges(){return this._list.visibleRanges||[]}_baseCellEditorOptions=new Map;isEmbedded;_readOnly;_inRepl;scopedContextKeyService;instantiationService;_notebookOptions;_currentProgress;get notebookOptions(){return this._notebookOptions}_debugFlag=!1;_debug(...e){this._debugFlag&&Ge(...e)}getId(){return this._uuid}getViewModel(){return this.viewModel}getLength(){return this.viewModel?.length??0}getSelections(){return this.viewModel?.getSelections()??[]}setSelections(e){if(!this.viewModel)return;const t=this.viewModel.getFocus();this.viewModel.updateSelectionsState({kind:W.Index,focus:t,selections:e})}getFocus(){return this.viewModel?.getFocus()??{start:0,end:0}}setFocus(e){if(!this.viewModel)return;const t=this.viewModel.getSelections();this.viewModel.updateSelectionsState({kind:W.Index,focus:e,selections:t})}getSelectionViewModels(){if(!this.viewModel)return[];const e=new Set;return this.viewModel.getSelections().map(t=>this.viewModel.viewCells.slice(t.start,t.end)).reduce((t,i)=>(i.forEach(o=>{e.has(o.handle)||(e.add(o.handle),t.push(o))}),t),[])}hasModel(){return!!this._notebookViewModel}showProgress(){this._currentProgress=this.editorProgressService.show(!0)}hideProgress(){this._currentProgress&&(this._currentProgress.done(),this._currentProgress=void 0)}getBaseCellEditorOptions(e){const t=this._baseCellEditorOptions.get(e);if(t)return t;{const i=new St(this,this.notebookOptions,this.configurationService,e);return this._baseCellEditorOptions.set(e,i),i}}_updateForNotebookConfiguration(){if(!this._overlayContainer)return;this._overlayContainer.classList.remove("cell-title-toolbar-left"),this._overlayContainer.classList.remove("cell-title-toolbar-right"),this._overlayContainer.classList.remove("cell-title-toolbar-hidden");const e=this._notebookOptions.computeCellToolbarLocation(this.viewModel?.viewType);this._overlayContainer.classList.add(`cell-title-toolbar-${e}`);const t=this._notebookOptions.getDisplayOptions().cellToolbarInteraction;let i="hover";this._overlayContainer.classList.remove("cell-toolbar-hover"),this._overlayContainer.classList.remove("cell-toolbar-click"),(t==="hover"||t==="click")&&(i=t),this._overlayContainer.classList.add(`cell-toolbar-${i}`)}_generateFontInfo(){const e=this.configurationService.getValue("editor"),t=u.getWindow(this.getDomNode());this._fontInfo=xe.readFontInfo(t,De.createFromRawSettings(e,Lt.getInstance(t).value))}_createBody(e){this._notebookTopToolbarContainer=document.createElement("div"),this._notebookTopToolbarContainer.classList.add("notebook-toolbar-container"),this._notebookTopToolbarContainer.style.display="none",u.append(e,this._notebookTopToolbarContainer),this._notebookStickyScrollContainer=document.createElement("div"),this._notebookStickyScrollContainer.classList.add("notebook-sticky-scroll-container"),u.append(e,this._notebookStickyScrollContainer),this._body=document.createElement("div"),u.append(e,this._body),this._body.classList.add("cell-list-container"),this._createLayoutStyles(),this._createCellList(),this._notebookOverviewRulerContainer=document.createElement("div"),this._notebookOverviewRulerContainer.classList.add("notebook-overview-ruler-container"),this._list.scrollableElement.appendChild(this._notebookOverviewRulerContainer),this._registerNotebookOverviewRuler(),this._register(this.instantiationService.createInstance(Ht,this,this._list.scrollableElement)),this._overflowContainer=document.createElement("div"),this._overflowContainer.classList.add("notebook-overflow-widget-container","monaco-editor"),u.append(e,this._overflowContainer)}_generateFontFamily(){return this._fontInfo?.fontFamily??'"SF Mono", Monaco, Menlo, Consolas, "Ubuntu Mono", "Liberation Mono", "DejaVu Sans Mono", "Courier New", monospace'}_createLayoutStyles(){this._styleElement=u.createStyleSheet(this._body);const{cellRightMargin:e,cellTopMargin:t,cellRunGutter:i,cellBottomMargin:o,codeCellLeftMargin:n,markdownCellGutter:l,markdownCellLeftMargin:r,markdownCellBottomMargin:a,markdownCellTopMargin:d,collapsedIndicatorHeight:h,focusIndicator:_,insertToolbarPosition:I,outputFontSize:L,focusIndicatorLeftMargin:m,focusIndicatorGap:S}=this._notebookOptions.getLayoutConfiguration(),{insertToolbarAlignment:K,compactView:O,fontSize:X}=this._notebookOptions.getDisplayOptions(),C=this._notebookOptions.getCellEditorContainerLeftMargin(),{bottomToolbarGap:N,bottomToolbarHeight:z}=this._notebookOptions.computeBottomToolbarDimensions(this.viewModel?.viewType),s=[];this._fontInfo||this._generateFontInfo();const c=this._generateFontFamily();s.push(`
		.notebook-editor {
			--notebook-cell-output-font-size: ${L}px;
			--notebook-cell-input-preview-font-size: ${X}px;
			--notebook-cell-input-preview-font-family: ${c};
		}
		`),O?s.push(`.notebookOverlay .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .markdown-cell-row div.cell.code { margin-left: ${C}px; }`):s.push(`.notebookOverlay .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .markdown-cell-row div.cell.code { margin-left: ${n}px; }`),_==="border"?(s.push(`
			.monaco-workbench .notebookOverlay .monaco-list .monaco-list-row .cell-focus-indicator-top:before,
			.monaco-workbench .notebookOverlay .monaco-list .monaco-list-row .cell-focus-indicator-bottom:before,
			.monaco-workbench .notebookOverlay .monaco-list .markdown-cell-row .cell-inner-container:before,
			.monaco-workbench .notebookOverlay .monaco-list .markdown-cell-row .cell-inner-container:after {
				content: "";
				position: absolute;
				width: 100%;
				height: 1px;
			}

			.monaco-workbench .notebookOverlay .monaco-list .monaco-list-row .cell-focus-indicator-left:before,
			.monaco-workbench .notebookOverlay .monaco-list .monaco-list-row .cell-focus-indicator-right:before {
				content: "";
				position: absolute;
				width: 1px;
				height: 100%;
				z-index: 10;
			}

			/* top border */
			.monaco-workbench .notebookOverlay .monaco-list .monaco-list-row .cell-focus-indicator-top:before {
				border-top: 1px solid transparent;
			}

			/* left border */
			.monaco-workbench .notebookOverlay .monaco-list .monaco-list-row .cell-focus-indicator-left:before {
				border-left: 1px solid transparent;
			}

			/* bottom border */
			.monaco-workbench .notebookOverlay .monaco-list .monaco-list-row .cell-focus-indicator-bottom:before {
				border-bottom: 1px solid transparent;
			}

			/* right border */
			.monaco-workbench .notebookOverlay .monaco-list .monaco-list-row .cell-focus-indicator-right:before {
				border-right: 1px solid transparent;
			}
			`),s.push(`
			.monaco-workbench .notebookOverlay .monaco-list .monaco-list-row.code-cell-row.focused .cell-focus-indicator-left:before,
			.monaco-workbench .notebookOverlay .monaco-list .monaco-list-row.code-cell-row.focused .cell-focus-indicator-right:before,
			.monaco-workbench .notebookOverlay .monaco-list.selection-multiple .monaco-list-row.code-cell-row.selected .cell-focus-indicator-left:before,
			.monaco-workbench .notebookOverlay .monaco-list.selection-multiple .monaco-list-row.code-cell-row.selected .cell-focus-indicator-right:before {
				top: -${t}px; height: calc(100% + ${t+o}px)
			}`)):(s.push(`
			.monaco-workbench .notebookOverlay .monaco-list .monaco-list-row .cell-focus-indicator-left .codeOutput-focus-indicator {
				border-left: 3px solid transparent;
				border-radius: 4px;
				width: 0px;
				margin-left: ${m}px;
				border-color: var(--vscode-notebook-inactiveFocusedCellBorder) !important;
			}

			.monaco-workbench .notebookOverlay .monaco-list .monaco-list-row.focused .cell-focus-indicator-left .codeOutput-focus-indicator-container,
			.monaco-workbench .notebookOverlay .monaco-list .monaco-list-row .cell-output-hover .cell-focus-indicator-left .codeOutput-focus-indicator-container,
			.monaco-workbench .notebookOverlay .monaco-list .monaco-list-row .markdown-cell-hover .cell-focus-indicator-left .codeOutput-focus-indicator-container,
			.monaco-workbench .notebookOverlay .monaco-list .monaco-list-row:hover .cell-focus-indicator-left .codeOutput-focus-indicator-container {
				display: block;
			}

			.monaco-workbench .notebookOverlay .monaco-list .monaco-list-row .cell-focus-indicator-left .codeOutput-focus-indicator-container:hover .codeOutput-focus-indicator {
				border-left: 5px solid transparent;
				margin-left: ${m-1}px;
			}
			`),s.push(`
			.monaco-workbench .notebookOverlay .monaco-list .monaco-list-row.focused .cell-inner-container.cell-output-focus .cell-focus-indicator-left .codeOutput-focus-indicator,
			.monaco-workbench .notebookOverlay .monaco-list:focus-within .monaco-list-row.focused .cell-inner-container .cell-focus-indicator-left .codeOutput-focus-indicator {
				border-color: var(--vscode-notebook-focusedCellBorder) !important;
			}

			.monaco-workbench .notebookOverlay .monaco-list .monaco-list-row .cell-inner-container .cell-focus-indicator-left .output-focus-indicator {
				margin-top: ${S}px;
			}
			`)),I==="betweenCells"||I==="both"?(s.push(".monaco-workbench .notebookOverlay > .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .monaco-list-row .cell-bottom-toolbar-container { display: flex; }"),s.push(".monaco-workbench .notebookOverlay > .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .view-zones .cell-list-top-cell-toolbar-container { display: flex; }")):(s.push(".monaco-workbench .notebookOverlay > .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .monaco-list-row .cell-bottom-toolbar-container { display: none; }"),s.push(".monaco-workbench .notebookOverlay > .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .view-zones .cell-list-top-cell-toolbar-container { display: none; }")),K==="left"&&(s.push(`
			.monaco-workbench .notebookOverlay .cell-list-top-cell-toolbar-container .action-item:first-child,
			.monaco-workbench .notebookOverlay .cell-list-top-cell-toolbar-container .action-item:first-child, .monaco-workbench .notebookOverlay > .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .monaco-list-row .cell-bottom-toolbar-container .action-item:first-child {
				margin-right: 0px !important;
			}`),s.push(`
			.monaco-workbench .notebookOverlay .cell-list-top-cell-toolbar-container .monaco-toolbar .action-label,
			.monaco-workbench .notebookOverlay .cell-list-top-cell-toolbar-container .monaco-toolbar .action-label, .monaco-workbench .notebookOverlay > .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .monaco-list-row .cell-bottom-toolbar-container .monaco-toolbar .action-label {
				padding: 0px !important;
				justify-content: center;
				border-radius: 4px;
			}`),s.push(`
			.monaco-workbench .notebookOverlay .cell-list-top-cell-toolbar-container,
			.monaco-workbench .notebookOverlay .cell-list-top-cell-toolbar-container, .monaco-workbench .notebookOverlay > .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .monaco-list-row .cell-bottom-toolbar-container {
				align-items: flex-start;
				justify-content: left;
				margin: 0 16px 0 ${8+n}px;
			}`),s.push(`
			.monaco-workbench .notebookOverlay .cell-list-top-cell-toolbar-container,
			.notebookOverlay .cell-bottom-toolbar-container .action-item {
				border: 0px;
			}`)),s.push(`.notebookOverlay .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .code-cell-row div.cell.code { margin-left: ${C}px; }`),s.push(`.notebookOverlay .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .monaco-list-row div.cell { margin-right: ${e}px; }`),s.push(`.notebookOverlay .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .monaco-list-row > .cell-inner-container { padding-top: ${t}px; }`),s.push(`.notebookOverlay .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .markdown-cell-row > .cell-inner-container { padding-bottom: ${a}px; padding-top: ${d}px; }`),s.push(".notebookOverlay .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .markdown-cell-row > .cell-inner-container.webview-backed-markdown-cell { padding: 0; }"),s.push(`.notebookOverlay .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .markdown-cell-row > .webview-backed-markdown-cell.markdown-cell-edit-mode .cell.code { padding-bottom: ${a}px; padding-top: ${d}px; }`),s.push(`.notebookOverlay .output { margin: 0px ${e}px 0px ${C}px; }`),s.push(`.notebookOverlay .output { width: calc(100% - ${C+e}px); }`),s.push(`.notebookOverlay .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .monaco-list-row .cell-comment-container { left: ${C}px; }`),s.push(`.notebookOverlay .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .monaco-list-row .cell-comment-container { width: calc(100% - ${C+e}px); }`),s.push(`.monaco-workbench .notebookOverlay .output .output-collapse-container .expandButton { left: -${i}px; }`),s.push(`.monaco-workbench .notebookOverlay .output .output-collapse-container .expandButton {
			position: absolute;
			width: ${i}px;
			padding: 6px 0px;
		}`),s.push(`.notebookOverlay .output-show-more-container { margin: 0px ${e}px 0px ${C}px; }`),s.push(`.notebookOverlay .output-show-more-container { width: calc(100% - ${C+e}px); }`),s.push(`.notebookOverlay .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .monaco-list-row div.cell.markdown { padding-left: ${i}px; }`),s.push(`.monaco-workbench .notebookOverlay > .cell-list-container .notebook-folding-indicator { left: ${(l-20)/2+r}px; }`),s.push(`.notebookOverlay > .cell-list-container .notebook-folded-hint { left: ${l+r+8}px; }`),s.push(`.notebookOverlay .monaco-list .monaco-list-row :not(.webview-backed-markdown-cell) .cell-focus-indicator-top { height: ${t}px; }`),s.push(`.notebookOverlay .monaco-list .monaco-list-row .cell-focus-indicator-side { bottom: ${N}px; }`),s.push(`.notebookOverlay .monaco-list .monaco-list-row.code-cell-row .cell-focus-indicator-left { width: ${C}px; }`),s.push(`.notebookOverlay .monaco-list .monaco-list-row.markdown-cell-row .cell-focus-indicator-left { width: ${n}px; }`),s.push(`.notebookOverlay .monaco-list .monaco-list-row .cell-focus-indicator.cell-focus-indicator-right { width: ${e}px; }`),s.push(`.notebookOverlay .monaco-list .monaco-list-row .cell-focus-indicator-bottom { height: ${o}px; }`),s.push(`.notebookOverlay .monaco-list .monaco-list-row .cell-shadow-container-bottom { top: ${o}px; }`),s.push(`
			.notebookOverlay .monaco-list .monaco-list-row:has(+ .monaco-list-row.selected) .cell-focus-indicator-bottom {
				height: ${N+o}px;
			}
		`),s.push(`
			.notebookOverlay .monaco-list .monaco-list-row.code-cell-row.nb-multiCellHighlight:has(+ .monaco-list-row.nb-multiCellHighlight) .cell-focus-indicator-bottom {
				height: ${N+o}px;
				background-color: var(--vscode-notebook-symbolHighlightBackground) !important;
			}

			.notebookOverlay .monaco-list .monaco-list-row.markdown-cell-row.nb-multiCellHighlight:has(+ .monaco-list-row.nb-multiCellHighlight) .cell-focus-indicator-bottom {
				height: ${N+o-6}px;
				background-color: var(--vscode-notebook-symbolHighlightBackground) !important;
			}
		`),s.push(`
			.monaco-workbench .notebookOverlay > .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .monaco-list-row .input-collapse-container .cell-collapse-preview {
				line-height: ${h}px;
			}

			.monaco-workbench .notebookOverlay > .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .monaco-list-row .input-collapse-container .cell-collapse-preview .monaco-tokenized-source {
				max-height: ${h}px;
			}
		`),s.push(`.monaco-workbench .notebookOverlay > .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .monaco-list-row .cell-bottom-toolbar-container .monaco-toolbar { height: ${z}px }`),s.push(`.monaco-workbench .notebookOverlay > .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .view-zones .cell-list-top-cell-toolbar-container .monaco-toolbar { height: ${z}px }`),s.push(`.monaco-workbench .notebookOverlay.cell-title-toolbar-right > .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .monaco-list-row .cell-title-toolbar {
			right: ${e+26}px;
		}
		.monaco-workbench .notebookOverlay.cell-title-toolbar-left > .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .monaco-list-row .cell-title-toolbar {
			left: ${C+16}px;
		}
		.monaco-workbench .notebookOverlay.cell-title-toolbar-hidden > .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .monaco-list-row .cell-title-toolbar {
			display: none;
		}`),s.push(`
		.monaco-workbench .notebookOverlay .output > div.foreground.output-inner-container {
			padding: ${pe}px 8px;
		}
		.monaco-workbench .notebookOverlay > .cell-list-container > .monaco-list > .monaco-scrollable-element > .monaco-list-rows > .monaco-list-row .output-collapse-container {
			padding: ${pe}px 8px;
		}
		`),s.push(`
		.monaco-workbench .notebookOverlay .cell-chat-part {
			margin: 0 ${e}px 6px 4px;
		}
		`),this._styleElement.textContent=s.join(`
`)}_createCellList(){this._body.classList.add("cell-list-container"),this._dndController=this._register(new Ye(this,this._body));const e=o=>this._list.contextKeyService.createScoped(o);this._editorPool=this._register(this.instantiationService.createInstance(At,this,e));const t=[this.instantiationService.createInstance(Xe,this,this._renderedEditors,this._editorPool,this._dndController,e),this.instantiationService.createInstance(et,this,this._dndController,this._renderedEditors,e)];t.forEach(o=>{this._register(o)}),this._listDelegate=this.instantiationService.createInstance(tt,u.getWindow(this.getDomNode())),this._register(this._listDelegate);const i=new Bt(this.notebookExecutionStateService,()=>this.viewModel,this.keybindingService,this.configurationService);this._register(i),this._list=this.instantiationService.createInstance(je,"NotebookCellList",this._body,this._viewContext.notebookOptions,this._listDelegate,t,this.scopedContextKeyService,{setRowLineHeight:!1,setRowHeight:!1,supportDynamicHeights:!0,horizontalScrolling:!1,keyboardSupport:!1,mouseSupport:!0,multipleSelectionSupport:!0,selectionNavigation:!0,typeNavigationEnabled:!0,paddingTop:0,paddingBottom:0,transformOptimization:!1,initialSize:this._dimension,styleController:o=>this._list,overrideStyles:{listBackground:V,listActiveSelectionBackground:V,listActiveSelectionForeground:B,listFocusAndSelectionBackground:V,listFocusAndSelectionForeground:B,listFocusBackground:V,listFocusForeground:B,listHoverForeground:B,listHoverBackground:V,listHoverOutline:R,listFocusOutline:R,listInactiveSelectionBackground:V,listInactiveSelectionForeground:B,listInactiveFocusBackground:V,listInactiveFocusOutline:V},accessibilityProvider:i}),this._dndController.setList(this._list),this._register(this._list),this._listViewInfoAccessor=new Ze(this._list),this._register(this._listViewInfoAccessor),this._register(ye(...t)),this._listTopCellToolbar=this._register(this.instantiationService.createInstance(dt,this,this.notebookOptions)),this._webviewTransparentCover=u.append(this._list.rowsContainer,Pt(".webview-cover")),this._webviewTransparentCover.style.display="none",this._register(u.addStandardDisposableGenericMouseDownListener(this._overlayContainer,o=>{o.target.classList.contains("slider")&&this._webviewTransparentCover&&(this._webviewTransparentCover.style.display="block")})),this._register(u.addStandardDisposableGenericMouseUpListener(this._overlayContainer,()=>{this._webviewTransparentCover&&(this._webviewTransparentCover.style.display="none")})),this._register(this._list.onMouseDown(o=>{o.element&&this._onMouseDown.fire({event:o.browserEvent,target:o.element})})),this._register(this._list.onMouseUp(o=>{o.element&&this._onMouseUp.fire({event:o.browserEvent,target:o.element})})),this._register(this._list.onDidChangeFocus(o=>{this._onDidChangeActiveEditor.fire(this),this._onDidChangeActiveCell.fire(),this._onDidChangeFocus.fire(),this._cursorNavMode.set(!1)})),this._register(this._list.onContextMenu(o=>{this.showListContextMenu(o)})),this._register(this._list.onDidChangeVisibleRanges(()=>{this._onDidChangeVisibleRanges.fire()})),this._register(this._list.onDidScroll(o=>{o.scrollTop!==o.oldScrollTop&&(this._onDidScroll.fire(),this.clearActiveCellWidgets())})),this._focusTracker=this._register(u.trackFocus(this.getDomNode())),this._register(this._focusTracker.onDidBlur(()=>{this._editorFocus.set(!1),this.viewModel?.setEditorFocus(!1),this._onDidBlurEmitter.fire()})),this._register(this._focusTracker.onDidFocus(()=>{this._editorFocus.set(!0),this.viewModel?.setEditorFocus(!0),this._onDidFocusEmitter.fire()})),this._registerNotebookActionsToolbar(),this._registerNotebookStickyScroll(),this._register(this.configurationService.onDidChangeConfiguration(o=>{o.affectsConfiguration(Nt.Notebook)&&(this._list.ariaLabel=i?.getWidgetAriaLabel())}))}showListContextMenu(e){this.contextMenuService.showContextMenu({menuId:x.NotebookCellTitle,contextKeyService:this.scopedContextKeyService,getAnchor:()=>e.anchor})}_registerNotebookOverviewRuler(){this._notebookOverviewRuler=this._register(this.instantiationService.createInstance(at,this,this._notebookOverviewRulerContainer))}_registerNotebookActionsToolbar(){this._notebookTopToolbar=this._register(this.instantiationService.createInstance(rt,this,this.scopedContextKeyService,this._notebookOptions,this._notebookTopToolbarContainer)),this._register(this._notebookTopToolbar.onDidChangeVisibility(()=>{this._dimension&&this._isVisible&&this.layout(this._dimension)}))}_registerNotebookStickyScroll(){this._notebookStickyScroll=this._register(this.instantiationService.createInstance(Tt,this._notebookStickyScrollContainer,this,this._list,e=>{this.isDisposed||(this._dimension&&this._isVisible&&(e>0?(this.layout(this._dimension),this.setScrollTop(this.scrollTop+e)):e<0&&(this.setScrollTop(this.scrollTop+e),this.layout(this._dimension))),this._onDidScroll.fire())}))}_updateOutputRenderers(){!this.viewModel||!this._webview||(this._webview.updateOutputRenderers(),this.viewModel.viewCells.forEach(e=>{e.outputsViewModels.forEach(t=>{t.pickedMimeType?.rendererId===ht&&t.resetRenderer()})}))}getDomNode(){return this._overlayContainer}getOverflowContainerDomNode(){return this._overflowContainer}getInnerWebview(){return this._webview?.webview}setEditorProgressService(e){this.editorProgressService=e}setParentContextKeyService(e){this.scopedContextKeyService.updateParent(e)}async setModel(e,t,i){if(this.viewModel===void 0||!this.viewModel.equal(e)){const o=this._notebookOptions.computeBottomToolbarDimensions(this.viewModel?.viewType);this._detachModel(),await this._attachModel(e,t,i);const n=this._notebookOptions.computeBottomToolbarDimensions(this.viewModel?.viewType);(o.bottomToolbarGap!==n.bottomToolbarGap||o.bottomToolbarHeight!==n.bottomToolbarHeight)&&(this._styleElement?.remove(),this._createLayoutStyles(),this._webview?.updateOptions({...this.notebookOptions.computeWebviewOptions(),fontFamily:this._generateFontFamily()})),this.telemetryService.publicLog2("notebook/editorOpened",{scheme:e.uri.scheme,ext:Oe(e.uri),viewType:e.viewType})}else this.restoreListViewState(t);this._restoreSelectedKernel(t),this._loadKernelPreloads(),this._dndController?.clearGlobalDragState(),this._localStore.add(this._list.onDidChangeFocus(()=>{this.updateContextKeysOnFocusChange()})),this.updateContextKeysOnFocusChange(),this._backgroundMarkdownRendering()}_backgroundMarkdownRenderRunning=!1;_backgroundMarkdownRendering(){this._backgroundMarkdownRenderRunning||(this._backgroundMarkdownRenderRunning=!0,u.runWhenWindowIdle(u.getWindow(this.getDomNode()),e=>{this._backgroundMarkdownRenderingWithDeadline(e)}))}_backgroundMarkdownRenderingWithDeadline(e){const t=Date.now()+e.timeRemaining(),i=()=>{try{if(this._backgroundMarkdownRenderRunning=!0,this._isDisposed||!this.viewModel)return;const o=this.viewModel.viewCells.find(n=>n.cellKind===y.Markup&&!this._webview?.markupPreviewMapping.has(n.id)&&!this.cellIsHidden(n));if(!o)return;this.createMarkupPreview(o)}finally{this._backgroundMarkdownRenderRunning=!1}Date.now()<t?Se(i):this._backgroundMarkdownRendering()};i()}updateContextKeysOnFocusChange(){if(!this.viewModel)return;const e=this._list.getFocusedElements()[0];e&&(this._cellContextKeyManager||(this._cellContextKeyManager=this._localStore.add(this.instantiationService.createInstance(qe,this,e))),this._cellContextKeyManager.updateForElement(e))}async setOptions(e){if(e?.isReadOnly!==void 0&&(this._readOnly=e?.isReadOnly),!this.viewModel)return;this.viewModel.updateOptions({isReadOnly:this._readOnly}),this.notebookOptions.updateOptions(this._readOnly);const t=e?.cellOptions??this._parseIndexedCellOptions(e);if(t){const i=this.viewModel.viewCells.find(o=>o.uri.toString()===t.resource.toString());if(i){this.focusElement(i);const o=t.options?.selection;o?(i.updateEditState(D.Editing,"setOptions"),i.focusMode=k.Editor,await this.revealRangeInCenterIfOutsideViewportAsync(i,new F(o.startLineNumber,o.startColumn,o.endLineNumber||o.startLineNumber,o.endColumn||o.startColumn))):this._list.revealCell(i,e?.cellRevealType??A.CenterIfOutsideViewport);const n=this._renderedEditors.get(i);if(n){if(t.options?.selection){const{selection:l}=t.options,r=new F(l.startLineNumber,l.startColumn,l.endLineNumber||l.startLineNumber,l.endColumn||l.startColumn);n.setSelection(r),n.revealPositionInCenterIfOutsideViewport({lineNumber:l.startLineNumber,column:l.startColumn}),await this.revealRangeInCenterIfOutsideViewportAsync(i,r)}t.options?.preserveFocus||n.focus()}}}if(e?.cellSelections){const i=e.cellSelections[0].start,o=this.viewModel.cellAt(i);o&&(this.viewModel.updateSelectionsState({kind:W.Index,focus:{start:i,end:i+1},selections:e.cellSelections}),this.revealInCenterIfOutsideViewport(o))}this._updateForOptions(),this._onDidChangeOptions.fire()}_parseIndexedCellOptions(e){if(e?.indexedCellOptions){const t=this.cellAt(e.indexedCellOptions.index);if(t)return{resource:t.uri,options:{selection:e.indexedCellOptions.selection,preserveFocus:!1}}}}_detachModel(){this._localStore.clear(),q(this._localCellStateListeners),this._list.detachViewModel(),this.viewModel?.dispose(),this.viewModel=void 0,this._webview?.dispose(),this._webview?.element.remove(),this._webview=null,this._list.clear()}_updateForOptions(){this.viewModel&&(this._editorEditable.set(!this.viewModel.options.isReadOnly),this._overflowContainer.classList.toggle("notebook-editor-editable",!this.viewModel.options.isReadOnly),this.getDomNode().classList.toggle("notebook-editor-editable",!this.viewModel.options.isReadOnly))}async _resolveWebview(){return this.textModel?this._webviewResolvePromise?this._webviewResolvePromise:(this._webview||this._ensureWebview(this.getId(),this.textModel.viewType,this.textModel.uri),this._webviewResolvePromise=(async()=>{if(!this._webview)throw new Error("Notebook output webview object is not created successfully.");if(await this._webview.createWebview(this.creationOptions.codeWindow??te),!this._webview.webview)throw new Error("Notebook output webview element was not created successfully.");return this._localStore.add(this._webview.webview.onDidBlur(()=>{this._outputFocus.set(!1),this._webviewFocused=!1,this.updateEditorFocus(),this.updateCellFocusMode()})),this._localStore.add(this._webview.webview.onDidFocus(()=>{this._outputFocus.set(!0),this.updateEditorFocus(),this._webviewFocused=!0})),this._localStore.add(this._webview.onMessage(e=>{this._onDidReceiveMessage.fire(e)})),this._webview})(),this._webviewResolvePromise):null}_ensureWebview(e,t,i){if(this._webview)return;const o=this;this._webview=this.instantiationService.createInstance(Je,{get creationOptions(){return o.creationOptions},setScrollTop(n){o._list.scrollTop=n},triggerScroll(n){o._list.triggerScrollFromMouseWheelEvent(n)},getCellByInfo:o.getCellByInfo.bind(o),getCellById:o._getCellById.bind(o),toggleNotebookCellSelection:o._toggleNotebookCellSelection.bind(o),focusNotebookCell:o.focusNotebookCell.bind(o),focusNextNotebookCell:o.focusNextNotebookCell.bind(o),updateOutputHeight:o._updateOutputHeight.bind(o),scheduleOutputHeightAck:o._scheduleOutputHeightAck.bind(o),updateMarkupCellHeight:o._updateMarkupCellHeight.bind(o),setMarkupCellEditState:o._setMarkupCellEditState.bind(o),didStartDragMarkupCell:o._didStartDragMarkupCell.bind(o),didDragMarkupCell:o._didDragMarkupCell.bind(o),didDropMarkupCell:o._didDropMarkupCell.bind(o),didEndDragMarkupCell:o._didEndDragMarkupCell.bind(o),didResizeOutput:o._didResizeOutput.bind(o),updatePerformanceMetadata:o._updatePerformanceMetadata.bind(o),didFocusOutputInputChange:o._didFocusOutputInputChange.bind(o)},e,t,i,{...this._notebookOptions.computeWebviewOptions(),fontFamily:this._generateFontFamily()},this.notebookRendererMessaging.getScoped(this._uuid)),this._webview.element.style.width="100%",this._list.attachWebview(this._webview.element)}async _attachModel(e,t,i){this._ensureWebview(this.getId(),e.viewType,e.uri),this.viewModel=this.instantiationService.createInstance(nt,e.viewType,e,this._viewContext,this.getLayoutInfo(),{isReadOnly:this._readOnly,inRepl:this._inRepl}),this._viewContext.eventDispatcher.emit([new ce({width:!0,fontInfo:!0},this.getLayoutInfo())]),this.notebookOptions.updateOptions(this._readOnly),this._updateForOptions(),this._updateForNotebookConfiguration();{this.viewModel.restoreEditorViewState(t);const n=t?.contributionsState||{};for(const[l,r]of this._contributions)typeof r.restoreViewState=="function"&&r.restoreViewState(n[l])}this._localStore.add(this.viewModel.onDidChangeViewCells(n=>{this._onDidChangeViewCells.fire(n)})),this._localStore.add(this.viewModel.onDidChangeSelection(()=>{this._onDidChangeSelection.fire(),this.updateSelectedMarkdownPreviews()})),this._localStore.add(this._list.onWillScroll(n=>{this._webview?.isResolved()&&(this._webviewTransparentCover.style.transform=`translateY(${n.scrollTop})`)}));let o=!1;this._localStore.add(this._list.onDidChangeContentHeight(()=>{o||(o=!0,this._localStore.add(u.scheduleAtNextAnimationFrame(u.getWindow(this.getDomNode()),()=>{o=!1,this._updateScrollHeight()},100)))})),this._localStore.add(this._list.onDidRemoveOutputs(n=>{n.forEach(l=>this.removeInset(l))})),this._localStore.add(this._list.onDidHideOutputs(n=>{n.forEach(l=>this.hideInset(l))})),this._localStore.add(this._list.onDidRemoveCellsFromView(n=>{const l=[],r=[];for(const a of n)if(a.cellKind===y.Markup){const d=a;this.viewModel?.viewCells.find(h=>h.handle===d.handle)?l.push(d):r.push(d)}this.hideMarkupPreviews(l),this.deleteMarkupPreviews(r)})),await this._warmupWithMarkdownRenderer(this.viewModel,t,i),i?.mark("customMarkdownLoaded"),this._localCellStateListeners=this.viewModel.viewCells.map(n=>this._bindCellListener(n)),this._lastCellWithEditorFocus=this.viewModel.viewCells.find(n=>this.getActiveCell()===n&&n.focusMode===k.Editor)??null,this._localStore.add(this.viewModel.onDidChangeViewCells(n=>{this._isDisposed||([...n.splices].reverse().forEach(l=>{const[r,a,d]=l,h=this._localCellStateListeners.splice(r,a,...d.map(_=>this._bindCellListener(_)));q(h)}),n.splices.some(l=>l[2].some(r=>r.cellKind===y.Markup))&&this._backgroundMarkdownRendering())})),this._dimension?this._list.layout(this.getBodyHeight(this._dimension.height),this._dimension.width):this._list.layout(),this._dndController?.clearGlobalDragState(),this.restoreListViewState(t)}_bindCellListener(e){const t=new oe;return t.add(e.onDidChangeLayout(i=>{(i.totalHeight||i.outerWidth)&&this.layoutNotebookCell(e,e.layoutInfo.totalHeight,i.context)})),e.cellKind===y.Code&&t.add(e.onDidRemoveOutputs(i=>{i.forEach(o=>this.removeInset(o))})),t.add(e.onDidChangeState(i=>{i.inputCollapsedChanged&&e.isInputCollapsed&&e.cellKind===y.Markup&&this.hideMarkupPreviews([e]),i.outputCollapsedChanged&&e.isOutputCollapsed&&e.cellKind===y.Code&&e.outputsViewModels.forEach(o=>this.hideInset(o)),i.focusModeChanged&&this._validateCellFocusMode(e)})),t}_lastCellWithEditorFocus=null;_validateCellFocusMode(e){e.focusMode===k.Editor&&(this._lastCellWithEditorFocus&&this._lastCellWithEditorFocus!==e&&(this._lastCellWithEditorFocus.focusMode=k.Container),this._lastCellWithEditorFocus=e)}async _warmupWithMarkdownRenderer(e,t,i){this.logService.debug("NotebookEditorWidget","warmup "+this.viewModel?.uri.toString()),await this._resolveWebview(),i?.mark("webviewCommLoaded"),this.logService.debug("NotebookEditorWidget","warmup - webview resolved"),this._webview.element.style.visibility="hidden",await this._warmupViewportMarkdownCells(e,t),this.logService.debug("NotebookEditorWidget","warmup - viewport warmed up"),this._list.layout(0,0),this._list.attachViewModel(e),this._list.scrollTop=t?.scrollPosition?.top??0,this._debug("finish initial viewport warmup and view state restore."),this._webview.element.style.visibility="visible",this.logService.debug("NotebookEditorWidget","warmup - list view model attached, set to visible"),this._onDidAttachViewModel.fire()}async _warmupViewportMarkdownCells(e,t){if(t&&t.cellTotalHeights){const i=t.cellTotalHeights,o=t.scrollPosition?.top??0,n=o+Math.max(this._dimension?.height??0,1080);let l=0;const r=[];for(let a=0;a<e.length;a++){const d=e.cellAt(a),h=i[a]??0;if(l+h<o){l+=h;continue}if(d.cellKind===y.Markup&&r.push([d,l]),l+=h,l>n)break}await this._webview.initializeMarkup(r.map(([a,d])=>this.createMarkupCellInitialization(a,d)))}else{const i=e.viewCells.filter(r=>r.cellKind===y.Markup).slice(0,5).map(r=>this.createMarkupCellInitialization(r,-1e4));await this._webview.initializeMarkup(i);let o=0;const n=[],l=Math.max(this._dimension?.height??0,1080);for(const r of e.viewCells)if(r.cellKind===y.Markup&&n.push({id:r.id,top:o}),o+=r.getHeight(this.getLayoutInfo().fontInfo.lineHeight),o>l)break;this._webview?.updateScrollTops([],n)}}createMarkupCellInitialization(e,t){return{mime:e.mime,cellId:e.id,cellHandle:e.handle,content:e.getText(),offset:t,visible:!1,metadata:e.metadata}}restoreListViewState(e){if(!this.viewModel)return;e?.scrollPosition!==void 0?(this._list.scrollTop=e.scrollPosition.top,this._list.scrollLeft=e.scrollPosition.left):(this._list.scrollTop=0,this._list.scrollLeft=0);const t=typeof e?.focus=="number"?e.focus:0;if(t<this.viewModel.length){const i=this.viewModel.cellAt(t);i&&this.viewModel?.updateSelectionsState({kind:W.Handle,primary:i.handle,selections:[i.handle]})}else this._list.length>0&&this.viewModel.updateSelectionsState({kind:W.Index,focus:{start:0,end:1},selections:[{start:0,end:1}]});if(e?.editorFocused){const i=this.viewModel.cellAt(t);i&&(i.focusMode=k.Editor)}}_restoreSelectedKernel(e){if(e?.selectedKernelId&&this.textModel){const t=this.notebookKernelService.getMatchingKernel(this.textModel),i=t.all.find(o=>o.id===e.selectedKernelId);i&&!t.selected&&this.notebookKernelService.selectKernelForNotebook(i,this.textModel)}}getEditorViewState(){const e=this.viewModel?.getEditorViewState();if(!e)return{editingCells:{},cellLineNumberStates:{},editorViewStates:{},collapsedInputCells:{},collapsedOutputCells:{}};if(this._list){e.scrollPosition={left:this._list.scrollLeft,top:this._list.scrollTop};const i={};for(let o=0;o<this.viewModel.length;o++){const n=this.viewModel.cellAt(o);i[o]=n.layoutInfo.totalHeight}if(e.cellTotalHeights=i,this.viewModel){const o=this.viewModel.getFocus(),n=this.viewModel.cellAt(o.start);if(n){const l=this._list.domElementOfElement(n),r=n.getEditState()===D.Editing&&!!(l&&l.ownerDocument.activeElement&&l.contains(l.ownerDocument.activeElement));e.editorFocused=r,e.focus=o.start}}}const t={};for(const[i,o]of this._contributions)typeof o.saveViewState=="function"&&(t[i]=o.saveViewState());return e.contributionsState=t,this.textModel?.uri.scheme===xt.untitled&&(e.selectedKernelId=this.activeKernel?.id),e}_allowScrollBeyondLastLine(){return this._scrollBeyondLastLine&&!this.isEmbedded}getBodyHeight(e){return Math.max(e-(this._notebookTopToolbar?.useGlobalToolbar?26:0),0)}layout(e,t,i){if(!t&&this._shadowElementViewInfo===null){this._dimension=e,this._position=i;return}if(e.width<=0||e.height<=0){this.onWillHide();return}const o=this.layoutService.whenContainerStylesLoaded(u.getWindow(this.getDomNode()));o?o.then(()=>this.layoutNotebook(e,t,i)):this.layoutNotebook(e,t,i)}layoutNotebook(e,t,i){if(t&&this.updateShadowElement(t,e,i),this._shadowElementViewInfo&&this._shadowElementViewInfo.width<=0&&this._shadowElementViewInfo.height<=0){this.onWillHide();return}this._dimension=e,this._position=i;const o=this.getBodyHeight(e.height)-this.getLayoutInfo().stickyHeight;u.size(this._body,e.width,o);const n=o;this._list.getRenderHeight()<n?(this._list.updateOptions({paddingBottom:this._allowScrollBeyondLastLine()?Math.max(0,n-50):0,paddingTop:0}),this._list.layout(n,e.width)):(this._list.layout(n,e.width),this._list.updateOptions({paddingBottom:this._allowScrollBeyondLastLine()?Math.max(0,n-50):0,paddingTop:0})),this._overlayContainer.inert=!1,this._overlayContainer.style.visibility="visible",this._overlayContainer.style.display="block",this._overlayContainer.style.position="absolute",this._overlayContainer.style.overflow="hidden",this.layoutContainerOverShadowElement(e,i),this._webviewTransparentCover&&(this._webviewTransparentCover.style.height=`${e.height}px`,this._webviewTransparentCover.style.width=`${e.width}px`),this._notebookTopToolbar.layout(this._dimension),this._notebookOverviewRuler.layout(),this._viewContext?.eventDispatcher.emit([new ce({width:!0,fontInfo:!0},this.getLayoutInfo())])}updateShadowElement(e,t,i){if(this._shadowElement=e,t&&i)this._shadowElementViewInfo={height:t.height,width:t.width,top:i.top,left:i.left};else{const o=e.getBoundingClientRect();this._shadowElementViewInfo={height:o.height,width:o.width,top:o.top,left:o.left}}}layoutContainerOverShadowElement(e,t){if(e&&t){this._overlayContainer.style.top=`${t.top}px`,this._overlayContainer.style.left=`${t.left}px`,this._overlayContainer.style.width=`${e.width}px`,this._overlayContainer.style.height=`${e.height}px`;return}if(!this._shadowElementViewInfo)return;const i=this._overlayContainer.parentElement?.getBoundingClientRect();this._overlayContainer.style.top=`${this._shadowElementViewInfo.top-(i?.top||0)}px`,this._overlayContainer.style.left=`${this._shadowElementViewInfo.left-(i?.left||0)}px`,this._overlayContainer.style.width=`${e?e.width:this._shadowElementViewInfo.width}px`,this._overlayContainer.style.height=`${e?e.height:this._shadowElementViewInfo.height}px`}focus(){if(this._isVisible=!0,this._editorFocus.set(!0),this._webviewFocused)this._webview?.focusWebview();else{if(this.viewModel){const e=this.viewModel.getFocus(),t=this.viewModel.cellAt(e.start);if(this.hasEditorFocus()||(this.focusContainer(),this.updateEditorFocus()),t&&t.focusMode===k.Editor){t.updateEditState(D.Editing,"editorWidget.focus"),t.focusMode=k.Editor,this.focusEditor(t);return}}this._list.domFocus()}this._currentProgress&&this.showProgress()}onShow(){this._isVisible=!0}focusEditor(e){for(const[t,i]of this._renderedEditors.entries())if(t===e){i.focus();return}}focusContainer(e=!1){this._webviewFocused?this._webview?.focusWebview():this._list.focusContainer(e)}selectOutputContent(e){this._webview?.selectOutputContents(e)}selectInputContents(e){this._webview?.selectInputContents(e)}onWillHide(){this._isVisible=!1,this._editorFocus.set(!1),this._overlayContainer.inert=!0,this._overlayContainer.style.visibility="hidden",this._overlayContainer.style.left="-50000px",this._notebookTopToolbarContainer.style.display="none",this.clearActiveCellWidgets()}clearActiveCellWidgets(){this._renderedEditors.forEach((e,t)=>{this.getActiveCell()===t&&e&&(Ve.get(e)?.cancelSuggestWidget(),Dt.get(e)?.clearWidgets(),Vt.get(e)?.clearWidgets())})}editorHasDomFocus(){return u.isAncestorOfActiveElement(this.getDomNode())}updateEditorFocus(){this._focusTracker.refreshState();const e=this.editorHasDomFocus();this._editorFocus.set(e),this.viewModel?.setEditorFocus(e)}updateCellFocusMode(){const e=this.getActiveCell();e?.focusMode===k.Output&&!this._webviewFocused&&(e.focusMode=k.Container)}hasEditorFocus(){return this.updateEditorFocus(),this.editorHasDomFocus()}hasWebviewFocus(){return this._webviewFocused}hasOutputTextSelection(){if(!this.hasEditorFocus())return!1;const e=u.getWindow(this.getDomNode()).getSelection();if(e?.rangeCount!==1)return!1;const t=e.getRangeAt(0);if(t.startContainer===t.endContainer&&t.endOffset-t.startOffset===0)return!1;let i=t.commonAncestorContainer;if(!this._body.contains(i))return!1;for(;i&&i!==this._body;){if(i.classList&&i.classList.contains("output"))return!0;i=i.parentNode}return!1}_didFocusOutputInputChange(e){this._outputInputFocus.set(e)}focusElement(e){this.viewModel?.updateSelectionsState({kind:W.Handle,primary:e.handle,selections:[e.handle]})}get scrollTop(){return this._list.scrollTop}get scrollBottom(){return this._list.scrollTop+this._list.getRenderHeight()}getAbsoluteTopOfElement(e){return this._list.getCellViewScrollTop(e)}getHeightOfElement(e){return this._list.elementHeight(e)}scrollToBottom(){this._list.scrollToBottom()}setScrollTop(e){this._list.scrollTop=e}revealCellRangeInView(e){return this._list.revealCells(e)}revealInView(e){return this._list.revealCell(e,A.Default)}revealInViewAtTop(e){this._list.revealCell(e,A.Top)}revealInCenter(e){this._list.revealCell(e,A.Center)}async revealInCenterIfOutsideViewport(e){await this._list.revealCell(e,A.CenterIfOutsideViewport)}async revealFirstLineIfOutsideViewport(e){await this._list.revealCell(e,A.FirstLineIfOutsideViewport)}async revealLineInViewAsync(e,t){return this._list.revealRangeInCell(e,new F(t,1,t,1),H.Default)}async revealLineInCenterAsync(e,t){return this._list.revealRangeInCell(e,new F(t,1,t,1),H.Center)}async revealLineInCenterIfOutsideViewportAsync(e,t){return this._list.revealRangeInCell(e,new F(t,1,t,1),H.CenterIfOutsideViewport)}async revealRangeInViewAsync(e,t){return this._list.revealRangeInCell(e,t,H.Default)}async revealRangeInCenterAsync(e,t){return this._list.revealRangeInCell(e,t,H.Center)}async revealRangeInCenterIfOutsideViewportAsync(e,t){return this._list.revealRangeInCell(e,t,H.CenterIfOutsideViewport)}revealCellOffsetInCenter(e,t){return this._list.revealCellOffsetInCenter(e,t)}revealOffsetInCenterIfOutsideViewport(e){return this._list.revealOffsetInCenterIfOutsideViewport(e)}getViewIndexByModelIndex(e){if(!this._listViewInfoAccessor)return-1;const t=this.viewModel?.viewCells[e];return t?this._listViewInfoAccessor.getViewIndex(t):-1}getViewHeight(e){return this._listViewInfoAccessor?this._listViewInfoAccessor.getViewHeight(e):-1}getCellRangeFromViewRange(e,t){return this._listViewInfoAccessor.getCellRangeFromViewRange(e,t)}getCellsInRange(e){return this._listViewInfoAccessor.getCellsInRange(e)}setCellEditorSelection(e,t){this._list.setCellEditorSelection(e,t)}setHiddenAreas(e){return this._list.setHiddenAreas(e,!0)}getVisibleRangesPlusViewportAboveAndBelow(){return this._listViewInfoAccessor.getVisibleRangesPlusViewportAboveAndBelow()}deltaCellDecorations(e,t){const i=this.viewModel?.deltaCellDecorations(e,t)||[];return this._onDidChangeDecorations.fire(),i}deltaCellContainerClassNames(e,t,i){this._webview?.deltaCellContainerClassNames(e,t,i)}changeModelDecorations(e){return this.viewModel?.changeModelDecorations(e)||null}changeViewZones(e){this._list.changeViewZones(e)}async _loadKernelPreloads(){if(!this.hasModel())return;const{selected:e}=this.notebookKernelService.getMatchingKernel(this.textModel);this._webview?.isResolved()||await this._resolveWebview(),this._webview?.updateKernelPreloads(e)}get activeKernel(){return this.textModel&&this.notebookKernelService.getSelectedOrSuggestedKernel(this.textModel)}async cancelNotebookCells(e){if(!(!this.viewModel||!this.hasModel()))return e||(e=this.viewModel.viewCells),this.notebookExecutionService.cancelNotebookCellHandles(this.textModel,Array.from(e).map(t=>t.handle))}async executeNotebookCells(e){if(!this.viewModel||!this.hasModel()){this.logService.info("notebookEditorWidget","No NotebookViewModel, cannot execute cells");return}return e||(e=this.viewModel.viewCells),this.notebookExecutionService.executeNotebookCells(this.textModel,Array.from(e).map(t=>t.model),this.scopedContextKeyService)}_pendingLayouts=new WeakMap;async layoutNotebookCell(e,t,i){if(this._debug("layout cell",e.handle,t),this._list.getViewIndex(e)===void 0)return;this._pendingLayouts?.has(e)&&this._pendingLayouts?.get(e).dispose();const n=new ge,l=()=>{if(!this._isDisposed&&this.viewModel?.hasCell(e)&&this._list.getViewIndex(e)!==void 0&&this._list.elementHeight(e)!==t){if(this._pendingLayouts?.delete(e),!this.hasEditorFocus()){const r=this.viewModel?.getCellIndex(e),a=this.visibleRanges;if(r!==void 0&&a&&a.length&&a[0].start===r&&this._list.scrollTop>this.getAbsoluteTopOfElement(e))return this._list.updateElementHeight2(e,t,Math.min(r+1,this.getLength()-1))}this._list.updateElementHeight2(e,t),n.complete(void 0)}};if(this._list.inRenderingTransaction){const r=u.scheduleAtNextAnimationFrame(u.getWindow(this.getDomNode()),l);this._pendingLayouts?.set(e,Me(()=>{r.dispose(),n.complete(void 0)}))}else l();return n.p}getActiveCell(){const e=this._list.getFocusedElements();if(e&&e.length)return e[0]}_toggleNotebookCellSelection(e,t){const i=this._list.getSelectedElements(),o=i.includes(e),n=t?i[i.length-1]??e:e,l=this._list.getViewIndex(e),r=this._list.getViewIndex(n),a=this.getCellsInViewRange(l,r);o?this._list.selectElements(i.filter(d=>!a.includes(d))):(this.focusElement(e),this._list.selectElements([...i.filter(d=>!a.includes(d)),...a]))}getCellsInViewRange(e,t){const i=[];for(let o=0;o<this._list.length;++o){const n=this._list.element(o);n&&(o>=e&&o<=t||o>=t&&o<=e)&&i.push(n)}return i}async focusNotebookCell(e,t,i){if(!this._isDisposed)if(e.focusedOutputId=void 0,t==="editor"){if(this.focusElement(e),this._list.focusView(),e.updateEditState(D.Editing,"focusNotebookCell"),e.focusMode=k.Editor,!i?.skipReveal)if(typeof i?.focusEditorLine=="number"){this._cursorNavMode.set(!0),await this.revealLineInViewAsync(e,i.focusEditorLine);const o=this._renderedEditors.get(e),n=i.focusEditorLine;o?.setSelection({startLineNumber:n,startColumn:1,endLineNumber:n,endColumn:1})}else{const o=e.getSelectionsStartPosition();if(o?.length){const n=o[0];await this.revealRangeInViewAsync(e,F.fromPositions(n,n))}else await this.revealInView(e)}}else if(t==="output"){if(this.focusElement(e),this.hasEditorFocus()||this._list.focusView(),!this._webview)return;const o=e.outputsViewModels.find(l=>l.model.alternativeOutputId)?.model.alternativeOutputId,n=i?.outputId??o??e.id;this._webview.focusOutput(n,i?.altOutputId,i?.outputWebviewFocused||this._webviewFocused),e.updateEditState(D.Preview,"focusNotebookCell"),e.focusMode=k.Output,e.focusedOutputId=i?.outputId,this._outputFocus.set(!0),i?.skipReveal||this.revealInCenterIfOutsideViewport(e)}else{const o=this._list.domElementOfElement(e);o&&o.ownerDocument.activeElement&&o.contains(o.ownerDocument.activeElement)&&o.ownerDocument.activeElement.blur(),this._webview?.blurOutput(),e.updateEditState(D.Preview,"focusNotebookCell"),e.focusMode=k.Container,this.focusElement(e),i?.skipReveal||(typeof i?.focusEditorLine=="number"?(this._cursorNavMode.set(!0),await this.revealInView(e)):i?.revealBehavior===de.firstLine?await this.revealFirstLineIfOutsideViewport(e):i?.revealBehavior===de.fullCell?await this.revealInView(e):await this.revealInCenterIfOutsideViewport(e)),this._list.focusView(),this.updateEditorFocus()}}async focusNextNotebookCell(e,t){const i=this.viewModel?.getCellIndex(e);if(typeof i!="number")return;const o=this.viewModel?.cellAt(i+1);o&&await this.focusNotebookCell(o,t)}async _warmupCell(e){if(e.isOutputCollapsed)return;const t=e.outputsViewModels;for(const i of t.slice(0,ot)){const[o,n]=i.resolveMimeTypes(this.textModel,void 0);if(!o.find(h=>h.isTrusted)||o.length===0)continue;const l=o[n];if(!l)return;const r=this._notebookService.getRendererInfo(l.rendererId);if(!r)return;const a={type:$.Extension,renderer:r,source:i,mimeType:l.mimeType},d=this._webview?.insetMapping.get(a.source);if(!d||!d.initialized){const h=new Promise(_=>{this._register(ke.any(this.onDidRenderOutput,this.onDidRemoveOutput)(I=>{I.model===a.source.model&&_()}))});this.createOutput(e,a,0,!1),await h}else this.createOutput(e,a,0,!1);return}}async _warmupAll(e){if(!this.hasModel()||!this.viewModel)return;const t=this.viewModel.viewCells,i=[];for(let o=0;o<t.length;o++)t[o].cellKind===y.Markup&&!this._webview.markupPreviewMapping.has(t[o].id)&&i.push(this.createMarkupPreview(t[o]));if(e&&this._list)for(let o=0;o<this._list.length;o++){const n=this._list.element(o);n?.cellKind===y.Code&&i.push(this._warmupCell(n))}return Promise.all(i)}async find(e,t,i,o=!1,n=!1,l){if(!this._notebookViewModel)return[];l||(l=this.getId());const r=this._notebookViewModel.find(e,t).filter(h=>h.length>0);if(!t.includeMarkupPreview&&!t.includeOutput||t.findScope?.findScopeType===ue.Text)return this._webview?.findStop(l),r;const a={};if(r.forEach(h=>{a[h.cell.id]=h}),this._webview){const h=Date.now();await this._warmupAll(!!t.includeOutput);const _=Date.now();if(this.logService.debug("Find",`Warmup time: ${_-h}ms`),i.isCancellationRequested)return[];let I=[];t.findScope&&t.findScope.findScopeType===ue.Cells&&t.findScope.selectedCellRanges&&(I=Ct(t.findScope.selectedCellRanges).map(S=>this._notebookViewModel?.viewCells[S].id??""));const L=await this._webview.find(e,{caseSensitive:t.caseSensitive,wholeWord:t.wholeWord,includeMarkup:!!t.includeMarkupPreview,includeOutput:!!t.includeOutput,shouldGetSearchPreviewInfo:n,ownerID:l,findIds:I});if(i.isCancellationRequested)return[];L.forEach(m=>{const S=this._notebookViewModel.viewCells.find(O=>O.id===m.cellId);if(!S)return;if(m.type==="preview"){if(S.getEditState()===D.Preview&&!t.includeMarkupPreview||S.getEditState()===D.Editing&&t.includeMarkupInput)return}else if(!t.includeOutput)return;const K=a[m.cellId];K?K.webviewMatches.push(m):a[m.cellId]=new be(this._notebookViewModel.viewCells.find(O=>O.id===m.cellId),this._notebookViewModel.viewCells.findIndex(O=>O.id===m.cellId),[],[m])})}const d=[];return this._notebookViewModel.viewCells.forEach((h,_)=>{a[h.id]&&d.push(new be(h,_,a[h.id].contentMatches,a[h.id].webviewMatches))}),d}async findHighlightCurrent(e,t){return this._webview?this._webview?.findHighlightCurrent(e,t??this.getId()):0}async findUnHighlightCurrent(e,t){if(this._webview)return this._webview?.findUnHighlightCurrent(e,t??this.getId())}findStop(e){this._webview?.findStop(e??this.getId())}getLayoutInfo(){if(!this._list)throw new Error("Editor is not initalized successfully");return this._fontInfo||this._generateFontInfo(),{width:this._dimension?.width??0,height:this._dimension?.height??0,scrollHeight:this._list?.getScrollHeight()??0,fontInfo:this._fontInfo,stickyHeight:this._notebookStickyScroll?.getCurrentStickyHeight()??0}}async createMarkupPreview(e){if(!this._webview||(this._webview.isResolved()||await this._resolveWebview(),!this._webview||!this._list.webviewElement)||!this.viewModel||!this._list.viewModel||this.viewModel.getCellIndex(e)===-1||this.cellIsHidden(e))return;const t=parseInt(this._list.webviewElement.domNode.style.top,10),i=t?0-t:0,o=this._list.getCellViewScrollTop(e);await this._webview.showMarkupPreview({mime:e.mime,cellHandle:e.handle,cellId:e.id,content:e.getText(),offset:o+i,visible:!0,metadata:e.metadata})}cellIsHidden(e){const t=this.viewModel.getCellIndex(e);return this.viewModel.getHiddenRanges().some(o=>t>=o.start&&t<=o.end)}async unhideMarkupPreviews(e){this._webview&&(this._webview.isResolved()||await this._resolveWebview(),await this._webview?.unhideMarkupPreviews(e.map(t=>t.id)))}async hideMarkupPreviews(e){!this._webview||!e.length||(this._webview.isResolved()||await this._resolveWebview(),await this._webview?.hideMarkupPreviews(e.map(t=>t.id)))}async deleteMarkupPreviews(e){this._webview&&(this._webview.isResolved()||await this._resolveWebview(),await this._webview?.deleteMarkupPreviews(e.map(t=>t.id)))}async updateSelectedMarkdownPreviews(){if(!this._webview)return;this._webview.isResolved()||await this._resolveWebview();const e=this.getSelectionViewModels().map(t=>t.id);await this._webview?.updateMarkupPreviewSelections(e.length>1?e:[])}async createOutput(e,t,i,o){this._insetModifyQueueByOutputId.queue(t.source.model.outputId,async()=>{if(this._isDisposed||!this._webview||(this._webview.isResolved()||await this._resolveWebview(),!this._webview)||!this._list.webviewElement)return;t.type===$.Extension&&this.notebookRendererMessaging.prepare(t.renderer.id);const n=parseInt(this._list.webviewElement.domNode.style.top,10),l=n?0-n:0,r=this._list.getCellViewScrollTop(e)+l,a=this._webview.insetMapping.get(t.source);if(!a||!a.renderer&&t.type===$.Extension)o?this._webview.requestCreateOutputWhenWebviewIdle({cellId:e.id,cellHandle:e.handle,cellUri:e.uri,executionId:e.internalMetadata.executionId},t,r,i):this._webview.createOutput({cellId:e.id,cellHandle:e.handle,cellUri:e.uri,executionId:e.internalMetadata.executionId},t,r,i);else if(a.renderer&&t.type===$.Extension&&a.renderer.id!==t.renderer.id)this._webview.removeInsets([t.source]),this._webview.createOutput({cellId:e.id,cellHandle:e.handle,cellUri:e.uri},t,r,i);else if(a.versionId!==t.source.model.versionId)this._webview.updateOutput({cellId:e.id,cellHandle:e.handle,cellUri:e.uri,executionId:e.internalMetadata.executionId},t,r,i);else{const d=e.outputsViewModels.indexOf(t.source),h=e.getOutputOffset(d);this._webview.updateScrollTops([{cell:e,output:t.source,cellTop:r,outputOffset:h,forceDisplay:!e.isOutputCollapsed}],[])}})}async updateOutput(e,t,i){this._insetModifyQueueByOutputId.queue(t.source.model.outputId,async()=>{if(this._isDisposed||!this._webview||e.isOutputCollapsed||(this._webview.isResolved()||await this._resolveWebview(),!this._webview||!this._list.webviewElement))return;if(!this._webview.insetMapping.has(t.source))return this.createOutput(e,t,i,!1);t.type===$.Extension&&this.notebookRendererMessaging.prepare(t.renderer.id);const o=parseInt(this._list.webviewElement.domNode.style.top,10),n=o?0-o:0,l=this._list.getCellViewScrollTop(e)+n;this._webview.updateOutput({cellId:e.id,cellHandle:e.handle,cellUri:e.uri},t,l,i)})}async copyOutputImage(e){this._webview?.copyImage(e)}removeInset(e){this._insetModifyQueueByOutputId.queue(e.model.outputId,async()=>{this._isDisposed||!this._webview||(this._webview?.isResolved()&&this._webview.removeInsets([e]),this._onDidRemoveOutput.fire(e))})}hideInset(e){this._insetModifyQueueByOutputId.queue(e.model.outputId,async()=>{this._isDisposed||!this._webview||this._webview?.isResolved()&&this._webview.hideInset(e)})}postMessage(e){this._webview?.isResolved()&&this._webview.postKernelMessage(e)}addClassName(e){this._overlayContainer.classList.add(e)}removeClassName(e){this._overlayContainer.classList.remove(e)}cellAt(e){return this.viewModel?.cellAt(e)}getCellByInfo(e){const{cellHandle:t}=e;return this.viewModel?.viewCells.find(i=>i.handle===t)}getCellByHandle(e){return this.viewModel?.getCellByHandle(e)}getCellIndex(e){return this.viewModel?.getCellIndexByHandle(e.handle)}getNextVisibleCellIndex(e){return this.viewModel?.getNextVisibleCellIndex(e)}getPreviousVisibleCellIndex(e){return this.viewModel?.getPreviousVisibleCellIndex(e)}_updateScrollHeight(){if(this._isDisposed||!this._webview?.isResolved()||!this._list.webviewElement)return;const e=this._list.scrollHeight;this._webview.element.style.height=`${e+Qe*2}px`;const t=parseInt(this._list.webviewElement.domNode.style.top,10),i=t?0-t:0,o=[],n=[];this._webview?.insetMapping.forEach((r,a)=>{const d=this.viewModel?.getCellByHandle(r.cellInfo.cellHandle);if(!d||!(d instanceof he)||(this.viewModel?.viewCells.find(m=>m.handle===r.cellInfo.cellHandle),this._list.getViewIndex(d)===void 0))return;d.outputsViewModels.indexOf(a)<0&&n.push(a);const _=this._list.getCellViewScrollTop(d),I=d.outputsViewModels.indexOf(a),L=d.getOutputOffset(I);o.push({cell:d,output:a,cellTop:_+i,outputOffset:L,forceDisplay:!1})}),this._webview.removeInsets(n);const l=[];for(const r of this._webview.markupPreviewMapping.keys()){const a=this.viewModel?.viewCells.find(d=>d.id===r);if(a){const d=this._list.getCellViewScrollTop(a);l.push({id:r,top:d+i})}}(l.length||o.length)&&(this._debug("_list.onDidChangeContentHeight/markdown",l),this._webview?.updateScrollTops(o,l))}_updateOutputHeight(e,t,i,o,n){const l=this.viewModel?.viewCells.find(r=>r.handle===e.cellHandle);if(l&&l instanceof he){const r=l.outputsViewModels.indexOf(t);this._debug("update cell output",l.handle,i),l.updateOutputHeight(r,i,n),this.layoutNotebookCell(l,l.layoutInfo.totalHeight),o&&this._onDidRenderOutput.fire(t)}}_pendingOutputHeightAcks=new Map;_scheduleOutputHeightAck(e,t,i){const o=this._pendingOutputHeightAcks.size===0;this._pendingOutputHeightAcks.set(t,{cellId:e.cellId,outputId:t,height:i}),o&&u.scheduleAtNextAnimationFrame(u.getWindow(this.getDomNode()),()=>{this._debug("ack height"),this._updateScrollHeight(),this._webview?.ackHeight([...this._pendingOutputHeightAcks.values()]),this._pendingOutputHeightAcks.clear()},-1)}_getCellById(e){return this.viewModel?.viewCells.find(t=>t.id===e)}_updateMarkupCellHeight(e,t,i){const o=this._getCellById(e);if(o&&o instanceof P){const{bottomToolbarGap:n}=this._notebookOptions.computeBottomToolbarDimensions(this.viewModel?.viewType);this._debug("updateMarkdownCellHeight",o.handle,t+n,i),o.renderedMarkdownHeight=t}}_setMarkupCellEditState(e,t){const i=this._getCellById(e);i instanceof P&&(this.revealInView(i),i.updateEditState(t,"setMarkdownCellEditState"))}_didStartDragMarkupCell(e,t){const i=this._getCellById(e);if(i instanceof P){const o=this._list.webviewElement?-parseInt(this._list.webviewElement.domNode.style.top,10):0;this._dndController?.startExplicitDrag(i,t.dragOffsetY-o)}}_didDragMarkupCell(e,t){const i=this._getCellById(e);if(i instanceof P){const o=this._list.webviewElement?-parseInt(this._list.webviewElement.domNode.style.top,10):0;this._dndController?.explicitDrag(i,t.dragOffsetY-o)}}_didDropMarkupCell(e,t){const i=this._getCellById(e);if(i instanceof P){const o=this._list.webviewElement?-parseInt(this._list.webviewElement.domNode.style.top,10):0;t.dragOffsetY-=o,this._dndController?.explicitDrop(i,t)}}_didEndDragMarkupCell(e){const t=this._getCellById(e);t instanceof P&&this._dndController?.endExplicitDrag(t)}_didResizeOutput(e){const t=this._getCellById(e);t&&this._onDidResizeOutputEmitter.fire(t)}_updatePerformanceMetadata(e,t,i,o){if(!this.hasModel())return;const n=this._getCellById(e),l=n?this.getCellIndex(n):void 0;if(n?.internalMetadata.executionId===t&&l!==void 0){const r=n.internalMetadata.renderDuration||{};r[o]=(r[o]??0)+i,this.textModel.applyEdits([{editType:ct.PartialInternalMetadata,index:l,internalMetadata:{executionId:t,renderDuration:r}}],!0,void 0,()=>{},void 0,!1)}}getContribution(e){return this._contributions.get(e)||null}dispose(){this._isDisposed=!0,this._webview?.dispose(),this._webview=null,this.notebookEditorService.removeNotebookEditor(this),q(this._contributions.values()),this._contributions.clear(),this._localStore.clear(),q(this._localCellStateListeners),this._list.dispose(),this._listTopCellToolbar?.dispose(),this._overlayContainer.remove(),this.viewModel?.dispose(),this._renderedEditors.clear(),this._baseCellEditorOptions.forEach(e=>e.dispose()),this._baseCellEditorOptions.clear(),this._notebookOverviewRulerContainer.remove(),super.dispose(),this._webview=null,this._webviewResolvePromise=null,this._webviewTransparentCover=null,this._dndController=null,this._listTopCellToolbar=null,this._notebookViewModel=void 0,this._cellContextKeyManager=null,this._notebookTopToolbar=null,this._list=null,this._listViewInfoAccessor=null,this._pendingLayouts=null,this._listDelegate=null}toJSON(){return{notebookUri:this.viewModel?.uri}}};Q=ee([v(2,Le),v(3,Mt),v(4,kt),v(5,Ue),v(6,gt),v(7,yt),v(8,Te),v(9,ne),v(10,Be),v(11,Re),v(12,Ae),v(13,mt),v(14,ft),v(15,He),v(16,Et),v(17,Rt)],Q),f(g.Base,5,"notebook-progress-bar"),f(g.Base,10,"notebook-list-insertion-indicator"),f(g.Base,20,"notebook-cell-editor-outline"),f(g.Base,25,"notebook-scrollbar"),f(g.Base,26,"notebook-cell-status"),f(g.Base,26,"notebook-folding-indicator"),f(g.Base,27,"notebook-output"),f(g.Base,28,"notebook-cell-bottom-toolbar-container"),f(g.Base,29,"notebook-run-button-container"),f(g.Base,29,"notebook-input-collapse-condicon"),f(g.Base,30,"notebook-cell-output-toolbar"),f(g.Sash,1,"notebook-cell-expand-part-button"),f(g.Sash,2,"notebook-cell-toolbar"),f(g.Sash,3,"notebook-cell-toolbar-dropdown-active");const J=b("notebook.cellBorderColor",{dark:j(Z,1),light:j(Z,1),hcDark:re,hcLight:re},p.localize("notebook.cellBorderColor","The border color for notebook cells.")),En=b("notebook.focusedEditorBorder",R,p.localize("notebook.focusedEditorBorder","The color of the notebook cell editor border.")),xn=b("notebookStatusSuccessIcon.foreground",ae,p.localize("notebookStatusSuccessIcon.foreground","The error icon color of notebook cells in the cell status bar.")),Dn=b("notebookEditorOverviewRuler.runningCellForeground",ae,p.localize("notebookEditorOverviewRuler.runningCellForeground","The color of the running cell decoration in the notebook editor overview ruler.")),Vn=b("notebookStatusErrorIcon.foreground",Pe,p.localize("notebookStatusErrorIcon.foreground","The error icon color of notebook cells in the cell status bar.")),Tn=b("notebookStatusRunningIcon.foreground",B,p.localize("notebookStatusRunningIcon.foreground","The running icon color of notebook cells in the cell status bar.")),Nn=b("notebook.outputContainerBorderColor",null,p.localize("notebook.outputContainerBorderColor","The border color of the notebook output container.")),Rn=b("notebook.outputContainerBackgroundColor",null,p.localize("notebook.outputContainerBackgroundColor","The color of the notebook output container background.")),Ln=b("notebook.cellToolbarSeparator",{dark:E.fromHex("#808080").transparent(.35),light:E.fromHex("#808080").transparent(.35),hcDark:Y,hcLight:Y},p.localize("notebook.cellToolbarSeparator","The color of the separator in the cell bottom toolbar")),we=b("notebook.focusedCellBackground",null,p.localize("focusedCellBackground","The background color of a cell when the cell is focused.")),Fn=b("notebook.selectedCellBackground",{dark:Z,light:Z,hcDark:null,hcLight:null},p.localize("selectedCellBackground","The background color of a cell when the cell is selected.")),Bn=b("notebook.cellHoverBackground",{dark:j(we,.5),light:j(we,.7),hcDark:null,hcLight:null},p.localize("notebook.cellHoverBackground","The background color of a cell when the cell is hovered.")),Hn=b("notebook.selectedCellBorder",{dark:J,light:J,hcDark:Y,hcLight:Y},p.localize("notebook.selectedCellBorder","The color of the cell's top and bottom border when the cell is selected but not focused.")),An=b("notebook.inactiveSelectedCellBorder",{dark:null,light:null,hcDark:R,hcLight:R},p.localize("notebook.inactiveSelectedCellBorder","The color of the cell's borders when multiple cells are selected.")),Pn=b("notebook.focusedCellBorder",R,p.localize("notebook.focusedCellBorder","The color of the cell's focus indicator borders when the cell is focused.")),Wn=b("notebook.inactiveFocusedCellBorder",J,p.localize("notebook.inactiveFocusedCellBorder","The color of the cell's top and bottom border when a cell is focused while the primary focus is outside of the editor.")),Kn=b("notebook.cellStatusBarItemHoverBackground",{light:new E(new G(0,0,0,.08)),dark:new E(new G(255,255,255,.15)),hcDark:new E(new G(255,255,255,.15)),hcLight:new E(new G(0,0,0,.08))},p.localize("notebook.cellStatusBarItemHoverBackground","The background color of notebook cell status bar items.")),$n=b("notebook.cellInsertionIndicator",R,p.localize("notebook.cellInsertionIndicator","The color of the notebook cell insertion indicator.")),zn=b("notebookScrollbarSlider.background",Ke,p.localize("notebookScrollbarSliderBackground","Notebook scrollbar slider background color.")),Un=b("notebookScrollbarSlider.hoverBackground",$e,p.localize("notebookScrollbarSliderHoverBackground","Notebook scrollbar slider background color when hovering.")),Gn=b("notebookScrollbarSlider.activeBackground",We,p.localize("notebookScrollbarSliderActiveBackground","Notebook scrollbar slider background color when clicked on.")),qn=b("notebook.symbolHighlightBackground",{dark:E.fromHex("#ffffff0b"),light:E.fromHex("#fdff0033"),hcDark:null,hcLight:null},p.localize("notebook.symbolHighlightBackground","Background color of highlighted cell")),Yn=b("notebook.cellEditorBackground",{light:se,dark:se,hcDark:null,hcLight:null},p.localize("notebook.cellEditorBackground","Cell editor background color.")),V=b("notebook.editorBackground",{light:le,dark:le,hcDark:null,hcLight:null},p.localize("notebook.editorBackground","Notebook background color."));export{Ln as CELL_TOOLBAR_SEPERATOR,Q as NotebookEditorWidget,Yn as cellEditorBackground,Bn as cellHoverBackground,$n as cellInsertionIndicator,Kn as cellStatusBarItemHover,Vn as cellStatusIconError,Tn as cellStatusIconRunning,xn as cellStatusIconSuccess,qn as cellSymbolHighlight,we as focusedCellBackground,Pn as focusedCellBorder,En as focusedEditorBorderColor,On as getDefaultNotebookCreationOptions,Wn as inactiveFocusedCellBorder,An as inactiveSelectedCellBorder,Gn as listScrollbarSliderActiveBackground,zn as listScrollbarSliderBackground,Un as listScrollbarSliderHoverBackground,J as notebookCellBorder,Nn as notebookOutputContainerBorderColor,Rn as notebookOutputContainerColor,Dn as runningCellRulerDecorationColor,Fn as selectedCellBackground,Hn as selectedCellBorder};
