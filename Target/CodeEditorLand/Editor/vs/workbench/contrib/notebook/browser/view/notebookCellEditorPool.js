var h=Object.defineProperty;var u=Object.getOwnPropertyDescriptor;var p=(n,s,i,o)=>{for(var e=o>1?void 0:o?u(s,i):s,t=n.length-1,d;t>=0;t--)(d=n[t])&&(e=(o?d(s,i,e):d(e))||e);return o&&e&&h(s,i,e),e},a=(n,s)=>(i,o)=>s(i,o,n);import*as c from"../../../../../base/browser/dom.js";import{createCancelablePromise as v}from"../../../../../base/common/async.js";import{Disposable as _,DisposableStore as f,MutableDisposable as m}from"../../../../../base/common/lifecycle.js";import{CodeEditorWidget as C}from"../../../../../editor/browser/widget/codeEditor/codeEditorWidget.js";import{EditorContextKeys as S}from"../../../../../editor/common/editorContextKeys.js";import{ITextModelService as E}from"../../../../../editor/common/services/resolverService.js";import{IConfigurationService as b}from"../../../../../platform/configuration/common/configuration.js";import{IContextKeyService as M}from"../../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as D}from"../../../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as g}from"../../../../../platform/instantiation/common/serviceCollection.js";import{CellFocusMode as y}from"../notebookBrowser.js";import{CellEditorOptions as I}from"./cellParts/cellEditorOptions.js";let l=class extends _{constructor(i,o,e,t,d){super();this.notebookEditor=i;this.contextKeyServiceProvider=o;this.textModelService=e;this._configurationService=t;this._instantiationService=d;this._focusedEditorDOM=this.notebookEditor.getDomNode().appendChild(c.$(".cell-editor-part-cache")),this._focusedEditorDOM.style.position="absolute",this._focusedEditorDOM.style.top="-50000px",this._focusedEditorDOM.style.width="1px",this._focusedEditorDOM.style.height="1px"}_focusedEditorDOM;_editorDisposable=this._register(new m);_editorContextKeyService;_editor;_focusEditorCancellablePromise;_isInitialized=!1;_isDisposed=!1;_initializeEditor(i){this._editorContextKeyService=this._register(this.contextKeyServiceProvider(this._focusedEditorDOM));const o=c.prepend(this._focusedEditorDOM,c.$(".cell-editor-container")),e=this._register(this._instantiationService.createChild(new g([M,this._editorContextKeyService])));S.inCompositeEditor.bindTo(this._editorContextKeyService).set(!0);const t=new I(this.notebookEditor.getBaseCellEditorOptions(i.language),this.notebookEditor.notebookOptions,this._configurationService);this._editor=this._register(e.createInstance(C,o,{...t.getDefaultValue(),dimension:{width:0,height:0},scrollbar:{vertical:"hidden",horizontal:"auto",handleMouseWheel:!1,useShadows:!1}},{contributions:this.notebookEditor.creationOptions.cellEditorContributions})),this._isInitialized=!0}preserveFocusedEditor(i){this._isInitialized||this._initializeEditor(i),this._editorDisposable.clear(),this._focusEditorCancellablePromise?.cancel(),this._focusEditorCancellablePromise=v(async o=>{const e=await this.textModelService.createModelReference(i.uri);if(this._isDisposed||o.isCancellationRequested){e.dispose();return}const t=new f;t.add(e),this._editor.setModel(e.object.textEditorModel),this._editor.setSelections(i.getSelections()),this._editor.focus();const d=()=>{const r=this._editor.getSelections();r&&i.setSelections(r),this.notebookEditor.revealInView(i),this._editor.setModel(null),e.dispose()};t.add(this._editor.onDidChangeModelContent(r=>{d()})),t.add(this._editor.onDidChangeCursorSelection(r=>{(r.source==="keyboard"||r.source==="mouse")&&d()})),t.add(this.notebookEditor.onDidChangeActiveEditor(()=>{const r=this.notebookEditor.getActiveCell();(r!==i||r.focusMode!==y.Editor)&&(this._editorDisposable.clear(),this._editor.setModel(null),e.dispose())})),this._editorDisposable.value=t})}dispose(){this._isDisposed=!0,this._focusEditorCancellablePromise?.cancel(),super.dispose()}};l=p([a(2,E),a(3,b),a(4,D)],l);export{l as NotebookCellEditorPool};
