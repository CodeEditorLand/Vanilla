import"./media/notebookFind.css";import{KeyCode as u,KeyMod as v}from"../../../../../../base/common/keyCodes.js";import{Schemas as y}from"../../../../../../base/common/network.js";import{isEqual as A}from"../../../../../../base/common/resources.js";import"../../../../../../base/common/uri.js";import"../../../../../../editor/browser/editorBrowser.js";import{ICodeEditorService as T}from"../../../../../../editor/browser/services/codeEditorService.js";import{EditorOption as r}from"../../../../../../editor/common/config/editorOptions.js";import{EditorContextKeys as _}from"../../../../../../editor/common/editorContextKeys.js";import"../../../../../../editor/common/model.js";import{FindStartFocusAction as h,getSelectionSearchString as F,StartFindAction as x,StartFindReplaceAction as M}from"../../../../../../editor/contrib/find/browser/findController.js";import{localize2 as b}from"../../../../../../nls.js";import{Action2 as R,registerAction2 as C}from"../../../../../../platform/actions/common/actions.js";import{ContextKeyExpr as p}from"../../../../../../platform/contextkey/common/contextkey.js";import"../../../../../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as I}from"../../../../../../platform/keybinding/common/keybindingsRegistry.js";import{IEditorService as a}from"../../../../../services/editor/common/editorService.js";import{CellUri as O,NotebookFindScopeType as K}from"../../../common/notebookCommon.js";import{INTERACTIVE_WINDOW_IS_ACTIVE_EDITOR as W,KEYBINDING_CONTEXT_NOTEBOOK_FIND_WIDGET_FOCUSED as w,NOTEBOOK_EDITOR_FOCUSED as N,NOTEBOOK_IS_ACTIVE_EDITOR as D}from"../../../common/notebookContextKeys.js";import{NotebookMultiCellAction as P}from"../../controller/coreActions.js";import{getNotebookEditorFromEditorPane as S}from"../../notebookBrowser.js";import{registerNotebookContribution as U}from"../../notebookEditorExtensions.js";import{NotebookFindContrib as c}from"./notebookFindWidget.js";U(c.id,c),C(class extends R{constructor(){super({id:"notebook.hideFind",title:b("notebookActions.hideFind","Hide Find in Notebook"),keybinding:{when:p.and(N,w),primary:u.Escape,weight:I.WorkbenchContrib}})}async run(t){const e=t.get(a),o=S(e.activeEditorPane);if(!o)return;o.getContribution(c.id).hide(),o.focus()}}),C(class extends P{constructor(){super({id:"notebook.find",title:b("notebookActions.findInNotebook","Find in Notebook"),keybinding:{when:p.and(N,p.or(D,W),_.focus.toNegated()),primary:u.KeyF|v.CtrlCmd,weight:I.WorkbenchContrib}})}async runWithContext(t,e){const o=t.get(a),n=S(o.activeEditorPane);if(!n)return;n.getContribution(c.id).show(void 0,{findScope:{findScopeType:K.None}})}});function B(t,e){if(e.uri.scheme===y.vscodeNotebookCell){const o=O.parse(e.uri);if(o&&A(o.notebook,t))return!0}return!1}function E(t,e){if(e.seedSearchStringFromSelection==="single"){const o=F(t,e.seedSearchStringFromSelection,e.seedSearchStringFromNonEmptySelection);if(o)return{searchString:o,selection:t.getSelection()}}else if(e.seedSearchStringFromSelection==="multiple"&&!e.updateSearchScope){const o=F(t,e.seedSearchStringFromSelection);if(o)return{searchString:o,selection:t.getSelection()}}}x.addImplementation(100,(t,e,o)=>{const n=t.get(a),i=S(n.activeEditorPane);if(!i||!e.hasModel())return!1;if(!i.hasEditorFocus()&&!i.hasWebviewFocus()){const d=t.get(T),m=d.getFocusedCodeEditor()||d.getActiveCodeEditor();if(!(i.hasModel()&&m&&m.hasModel()&&B(i.textModel.uri,m.getModel())))return!1}const l=i.getContribution(c.id),s=E(e,{forceRevealReplace:!1,seedSearchStringFromSelection:e.getOption(r.find).seedSearchStringFromSelection!=="never"?"single":"none",seedSearchStringFromNonEmptySelection:e.getOption(r.find).seedSearchStringFromSelection==="selection",seedSearchStringFromGlobalClipboard:e.getOption(r.find).globalFindClipboard,shouldFocus:h.FocusFindInput,shouldAnimate:!0,updateSearchScope:!1,loop:e.getOption(r.find).loop});let f;const k=e.getModel().uri,g=O.parse(k);if(s?.selection&&g){const d=i.getCellByHandle(g.handle);d&&(f={searchStringSeededFrom:{cell:d,range:s.selection}})}return l.show(s?.searchString,f),!0}),M.addImplementation(100,(t,e,o)=>{const n=t.get(a),i=S(n.activeEditorPane);if(!i||!e.hasModel())return!1;const l=i.getContribution(c.id),s=E(e,{forceRevealReplace:!1,seedSearchStringFromSelection:e.getOption(r.find).seedSearchStringFromSelection!=="never"?"single":"none",seedSearchStringFromNonEmptySelection:e.getOption(r.find).seedSearchStringFromSelection==="selection",seedSearchStringFromGlobalClipboard:e.getOption(r.find).globalFindClipboard,shouldFocus:h.FocusFindInput,shouldAnimate:!0,updateSearchScope:!1,loop:e.getOption(r.find).loop});return l?(l.replace(s?.searchString),!0):!1});
