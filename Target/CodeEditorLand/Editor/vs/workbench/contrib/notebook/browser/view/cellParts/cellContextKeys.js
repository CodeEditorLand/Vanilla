var C=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var d=(s,o,e,t)=>{for(var i=t>1?void 0:t?S(o,e):o,a=s.length-1,l;a>=0;a--)(l=s[a])&&(i=(t?l(o,e,i):l(i))||i);return t&&i&&C(o,e,i),i},r=(s,o)=>(e,t)=>o(e,t,s);import{Disposable as m,DisposableStore as b}from"../../../../../../base/common/lifecycle.js";import{autorun as f}from"../../../../../../base/common/observable.js";import{IContextKeyService as v}from"../../../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as O}from"../../../../../../platform/instantiation/common/instantiation.js";import{NotebookCellExecutionState as h}from"../../../common/notebookCommon.js";import{NOTEBOOK_CELL_EDITABLE as x,NOTEBOOK_CELL_EDITOR_FOCUSED as _,NOTEBOOK_CELL_EXECUTING as y,NOTEBOOK_CELL_EXECUTION_STATE as g,NOTEBOOK_CELL_FOCUSED as T,NOTEBOOK_CELL_GENERATED_BY_CHAT as K,NOTEBOOK_CELL_HAS_ERROR_DIAGNOSTICS as I,NOTEBOOK_CELL_HAS_OUTPUTS as L,NOTEBOOK_CELL_INPUT_COLLAPSED as N,NOTEBOOK_CELL_LINE_NUMBERS as F,NOTEBOOK_CELL_MARKDOWN_EDIT_MODE as D,NOTEBOOK_CELL_OUTPUT_COLLAPSED as k,NOTEBOOK_CELL_RESOURCE as M,NOTEBOOK_CELL_TYPE as R}from"../../../common/notebookContextKeys.js";import{INotebookExecutionStateService as B,NotebookExecutionType as w}from"../../../common/notebookExecutionStateService.js";import{NotebookChatController as E}from"../../controller/chat/notebookChatController.js";import{CellEditState as A,CellFocusMode as U}from"../../notebookBrowser.js";import{CodeCellViewModel as u}from"../../viewModel/codeCellViewModel.js";import{MarkupCellViewModel as p}from"../../viewModel/markupCellViewModel.js";import{CellContentPart as H}from"../cellPart.js";let c=class extends H{constructor(e,t){super();this.instantiationService=t;this.cellContextKeyManager=this._register(this.instantiationService.createInstance(n,e,void 0))}cellContextKeyManager;didRenderCell(e){this.cellContextKeyManager.updateForElement(e)}};c=d([r(1,O)],c);let n=class extends m{constructor(e,t,i,a){super();this.notebookEditor=e;this.element=t;this._contextKeyService=i;this._notebookExecutionStateService=a;this._contextKeyService.bufferChangeEvents(()=>{this.cellType=R.bindTo(this._contextKeyService),this.cellEditable=x.bindTo(this._contextKeyService),this.cellFocused=T.bindTo(this._contextKeyService),this.cellEditorFocused=_.bindTo(this._contextKeyService),this.markdownEditMode=D.bindTo(this._contextKeyService),this.cellRunState=g.bindTo(this._contextKeyService),this.cellExecuting=y.bindTo(this._contextKeyService),this.cellHasOutputs=L.bindTo(this._contextKeyService),this.cellContentCollapsed=N.bindTo(this._contextKeyService),this.cellOutputCollapsed=k.bindTo(this._contextKeyService),this.cellLineNumbers=F.bindTo(this._contextKeyService),this.cellGeneratedByChat=K.bindTo(this._contextKeyService),this.cellResource=M.bindTo(this._contextKeyService),this.cellHasErrorDiagnostics=I.bindTo(this._contextKeyService),t&&this.updateForElement(t)}),this._register(this._notebookExecutionStateService.onDidChangeExecution(l=>{l.type===w.cell&&this.element&&l.affectsCell(this.element.uri)&&this.updateForExecutionState()}))}cellType;cellEditable;cellFocused;cellEditorFocused;cellRunState;cellExecuting;cellHasOutputs;cellContentCollapsed;cellOutputCollapsed;cellLineNumbers;cellResource;cellGeneratedByChat;cellHasErrorDiagnostics;markdownEditMode;elementDisposables=this._register(new b);updateForElement(e){if(this.elementDisposables.clear(),this.element=e,!e)return;this.elementDisposables.add(e.onDidChangeState(i=>this.onDidChangeState(i))),e instanceof u&&(this.elementDisposables.add(e.onDidChangeOutputs(()=>this.updateForOutputs())),this.elementDisposables.add(f(i=>{this.cellHasErrorDiagnostics.set(!!i.readObservable(e.excecutionError))}))),this.elementDisposables.add(this.notebookEditor.onDidChangeActiveCell(()=>this.updateForFocusState())),this.element instanceof p?this.cellType.set("markup"):this.element instanceof u&&this.cellType.set("code"),this._contextKeyService.bufferChangeEvents(()=>{this.updateForFocusState(),this.updateForExecutionState(),this.updateForEditState(),this.updateForCollapseState(),this.updateForOutputs(),this.updateForChat(),this.cellLineNumbers.set(this.element.lineNumbers),this.cellResource.set(this.element.uri.toString())});const t=E.get(this.notebookEditor);t&&this.elementDisposables.add(t.onDidChangePromptCache(i=>{i.cell.toString()===this.element.uri.toString()&&this.updateForChat()}))}onDidChangeState(e){this._contextKeyService.bufferChangeEvents(()=>{e.internalMetadataChanged&&this.updateForExecutionState(),e.editStateChanged&&this.updateForEditState(),e.focusModeChanged&&this.updateForFocusState(),e.cellLineNumberChanged&&this.cellLineNumbers.set(this.element.lineNumbers),(e.inputCollapsedChanged||e.outputCollapsedChanged)&&this.updateForCollapseState()})}updateForFocusState(){if(!this.element)return;const e=this.notebookEditor.getActiveCell();this.cellFocused.set(this.notebookEditor.getActiveCell()===this.element),e===this.element?this.cellEditorFocused.set(this.element.focusMode===U.Editor):this.cellEditorFocused.set(!1)}updateForExecutionState(){if(!this.element)return;const e=this.element.internalMetadata;this.cellEditable.set(!this.notebookEditor.isReadOnly);const t=this._notebookExecutionStateService.getCellExecution(this.element.uri);this.element instanceof p?(this.cellRunState.reset(),this.cellExecuting.reset()):t?.state===h.Executing?(this.cellRunState.set("executing"),this.cellExecuting.set(!0)):t?.state===h.Pending||t?.state===h.Unconfirmed?(this.cellRunState.set("pending"),this.cellExecuting.set(!0)):e.lastRunSuccess===!0?(this.cellRunState.set("succeeded"),this.cellExecuting.set(!1)):e.lastRunSuccess===!1?(this.cellRunState.set("failed"),this.cellExecuting.set(!1)):(this.cellRunState.set("idle"),this.cellExecuting.set(!1))}updateForEditState(){this.element&&(this.element instanceof p?this.markdownEditMode.set(this.element.getEditState()===A.Editing):this.markdownEditMode.set(!1))}updateForCollapseState(){this.element&&(this.cellContentCollapsed.set(!!this.element.isInputCollapsed),this.cellOutputCollapsed.set(!!this.element.isOutputCollapsed))}updateForOutputs(){this.element instanceof u?this.cellHasOutputs.set(this.element.outputsViewModels.length>0):this.cellHasOutputs.set(!1)}updateForChat(){const e=E.get(this.notebookEditor);if(!e||!this.element){this.cellGeneratedByChat.set(!1);return}this.cellGeneratedByChat.set(e.isCellGeneratedByChat(this.element))}};n=d([r(2,v),r(3,B)],n);export{n as CellContextKeyManager,c as CellContextKeyPart};
