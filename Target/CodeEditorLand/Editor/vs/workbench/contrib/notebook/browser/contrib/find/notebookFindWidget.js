var C=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var _=(h,e,t,i)=>{for(var o=i>1?void 0:i?T(e,t):e,r=h.length-1,d;r>=0;r--)(d=h[r])&&(o=(i?d(e,t,o):d(o))||o);return i&&o&&C(e,t,o),o},a=(h,e)=>(t,i)=>e(t,i,h);import*as s from"../../../../../../base/browser/dom.js";import"../../../../../../base/browser/keyboardEvent.js";import{alert as N}from"../../../../../../base/browser/ui/aria/aria.js";import{KeyCode as g,KeyMod as F}from"../../../../../../base/common/keyCodes.js";import{Lazy as k}from"../../../../../../base/common/lazy.js";import{Disposable as D}from"../../../../../../base/common/lifecycle.js";import*as R from"../../../../../../base/common/strings.js";import"../../../../../../editor/common/core/range.js";import"../../../../../../editor/common/model.js";import{MATCHES_LIMIT as y}from"../../../../../../editor/contrib/find/browser/findModel.js";import{FindReplaceState as O}from"../../../../../../editor/contrib/find/browser/findState.js";import{NLS_MATCHES_LOCATION as x,NLS_NO_RESULTS as I}from"../../../../../../editor/contrib/find/browser/findWidget.js";import{localize as v}from"../../../../../../nls.js";import{IConfigurationService as W}from"../../../../../../platform/configuration/common/configuration.js";import{IContextKeyService as K}from"../../../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as A,IContextViewService as B}from"../../../../../../platform/contextview/browser/contextView.js";import{IHoverService as L}from"../../../../../../platform/hover/browser/hover.js";import{IInstantiationService as w}from"../../../../../../platform/instantiation/common/instantiation.js";import"./findFilters.js";import{FindModel as P}from"./findModel.js";import{SimpleFindReplaceWidget as H}from"./notebookFindReplaceWidget.js";import{CellEditState as b}from"../../notebookBrowser.js";import"../../../common/notebookCommon.js";import{KEYBINDING_CONTEXT_NOTEBOOK_FIND_WIDGET_FOCUSED as V}from"../../../common/notebookContextKeys.js";const c="find-hide-transition",l="find-show-transition";let M=69;const S=200;let f=class extends D{constructor(t,i){super();this.notebookEditor=t;this.instantiationService=i;this.widget=new k(()=>this._register(this.instantiationService.createInstance(u,this.notebookEditor)))}static id="workbench.notebook.find";widget;show(t,i){return this.widget.value.show(t,i)}hide(){this.widget.rawValue?.hide()}replace(t){return this.widget.value.replace(t)}};f=_([a(1,w)],f);let u=class extends H{_findWidgetFocused;_showTimeout=null;_hideTimeout=null;_previousFocusElement;_findModel;constructor(e,t,i,o,r,d,m){super(t,i,o,r,m,d,new O,e),this._findModel=new P(this._notebookEditor,this._state,this._configurationService),s.append(this._notebookEditor.getDomNode(),this.getDomNode()),this._findWidgetFocused=V.bindTo(i),this._register(this._findInput.onKeyDown(n=>this._onFindInputKeyDown(n))),this._register(this._replaceInput.onKeyDown(n=>this._onReplaceInputKeyDown(n))),this._register(this._state.onFindReplaceStateChange(n=>{if(this.onInputChanged(),n.isSearching&&(this._state.isSearching?this._progressBar.infinite().show(S):this._progressBar.stop().hide()),this._findModel.currentMatch>=0){const p=this._findModel.getCurrentMatch();this._replaceBtn.setEnabled(p.isModelMatch)}const E=this._findModel.findMatches;this._replaceAllBtn.setEnabled(E.length>0&&E.find(p=>p.webviewMatches.length>0)===void 0),n.filters&&this._findInput.updateFilterState(this._state.filters?.isModified()??!1)})),this._register(s.addDisposableListener(this.getDomNode(),s.EventType.FOCUS,n=>{this._previousFocusElement=s.isHTMLElement(n.relatedTarget)?n.relatedTarget:void 0},!0))}_onFindInputKeyDown(e){if(e.equals(g.Enter)){this.find(!1),e.preventDefault();return}else if(e.equals(F.Shift|g.Enter)){this.find(!0),e.preventDefault();return}}_onReplaceInputKeyDown(e){if(e.equals(g.Enter)){this.replaceOne(),e.preventDefault();return}}onInputChanged(){this._state.change({searchString:this.inputValue},!1);const e=this._findModel.findMatches;return!!(e&&e.length)}findIndex(e){this._findModel.find({index:e})}find(e){this._findModel.find({previous:e})}replaceOne(){if(!this._notebookEditor.hasModel()||!this._findModel.findMatches.length)return;this._findModel.ensureFindMatches(),this._findModel.currentMatch<0&&this._findModel.find({previous:!1});const e=this._findModel.getCurrentMatch(),t=e.cell;if(e.isModelMatch){const i=e.match;this._progressBar.infinite().show(S);const r=this.replacePattern.buildReplaceString(i.matches,this._state.preserveCase);this._notebookEditor.getViewModel().replaceOne(t,i.range,r).then(()=>{this._progressBar.stop()})}}replaceAll(){if(!this._notebookEditor.hasModel())return;this._progressBar.infinite().show(S);const e=this.replacePattern,t=this._findModel.findMatches,i=[];t.forEach(r=>{r.contentMatches.forEach(d=>{const m=d.matches;i.push(e.buildReplaceString(m,this._state.preserveCase))})}),this._notebookEditor.getViewModel().replaceAll(this._findModel.findMatches,i).then(()=>{this._progressBar.stop()})}findFirst(){}onFocusTrackerFocus(){this._findWidgetFocused.set(!0)}onFocusTrackerBlur(){this._previousFocusElement=void 0,this._findWidgetFocused.reset()}onReplaceInputFocusTrackerFocus(){}onReplaceInputFocusTrackerBlur(){}onFindInputFocusTrackerFocus(){}onFindInputFocusTrackerBlur(){}async show(e,t){const i=this._state.searchString!==e;super.show(e,t),this._state.change({searchString:e??this._state.searchString,isRevealed:!0},!1),typeof t?.matchIndex=="number"?(this._findModel.findMatches.length||await this._findModel.research(),this.findIndex(t.matchIndex)):this._findInput.select(),!i&&t?.searchStringSeededFrom&&this._findModel.refreshCurrentMatch(t.searchStringSeededFrom),this._showTimeout===null&&(this._hideTimeout!==null&&(s.getWindow(this.getDomNode()).clearTimeout(this._hideTimeout),this._hideTimeout=null,this._notebookEditor.removeClassName(c)),this._notebookEditor.addClassName(l),this._showTimeout=s.getWindow(this.getDomNode()).setTimeout(()=>{this._notebookEditor.removeClassName(l),this._showTimeout=null},200))}replace(e,t){super.showWithReplace(e,t),this._state.change({searchString:e??"",replaceString:t??"",isRevealed:!0},!1),this._replaceInput.select(),this._showTimeout===null&&(this._hideTimeout!==null&&(s.getWindow(this.getDomNode()).clearTimeout(this._hideTimeout),this._hideTimeout=null,this._notebookEditor.removeClassName(c)),this._notebookEditor.addClassName(l),this._showTimeout=s.getWindow(this.getDomNode()).setTimeout(()=>{this._notebookEditor.removeClassName(l),this._showTimeout=null},200))}hide(){if(super.hide(),this._state.change({isRevealed:!1},!1),this._findModel.clear(),this._notebookEditor.findStop(),this._progressBar.stop(),this._hideTimeout===null&&(this._showTimeout!==null&&(s.getWindow(this.getDomNode()).clearTimeout(this._showTimeout),this._showTimeout=null,this._notebookEditor.removeClassName(l)),this._notebookEditor.addClassName(c),this._hideTimeout=s.getWindow(this.getDomNode()).setTimeout(()=>{this._notebookEditor.removeClassName(c)},200)),this._previousFocusElement&&this._previousFocusElement.offsetParent&&(this._previousFocusElement.focus(),this._previousFocusElement=void 0),this._notebookEditor.hasModel())for(let e=0;e<this._notebookEditor.getLength();e++){const t=this._notebookEditor.cellAt(e);t.getEditState()===b.Editing&&t.editStateSource==="find"&&t.updateEditState(b.Preview,"closeFind")}}_updateMatchesCount(){if(!this._findModel||!this._findModel.findMatches)return;this._matchesCount.style.width=M+"px",this._matchesCount.title="",this._matchesCount.firstChild?.remove();let e;if(this._state.matchesCount>0){let t=String(this._state.matchesCount);this._state.matchesCount>=y&&(t+="+");const i=this._findModel.currentMatch<0?"?":String(this._findModel.currentMatch+1);e=R.format(x,i,t)}else e=I;this._matchesCount.appendChild(document.createTextNode(e)),N(this._getAriaLabel(e,this._state.currentMatch,this._state.searchString)),M=Math.max(M,this._matchesCount.clientWidth)}_getAriaLabel(e,t,i){return e===I?i===""?v("ariaSearchNoResultEmpty","{0} found",e):v("ariaSearchNoResult","{0} found for '{1}'",e,i):v("ariaSearchNoResultWithLineNumNoCurrentMatch","{0} found for '{1}'",e,i)}dispose(){this._notebookEditor?.removeClassName(l),this._notebookEditor?.removeClassName(c),this._findModel.dispose(),super.dispose()}};u=_([a(1,B),a(2,K),a(3,W),a(4,A),a(5,L),a(6,w)],u);export{f as NotebookFindContrib};
