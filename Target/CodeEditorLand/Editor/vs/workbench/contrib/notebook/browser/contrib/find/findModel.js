var S=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var m=(d,o,t,i)=>{for(var n=i>1?void 0:i?b(o,t):o,e=d.length-1,r;e>=0;e--)(r=d[e])&&(n=(i?r(o,t,n):r(n))||n);return i&&n&&S(o,t,n),n},C=(d,o)=>(t,i)=>o(t,i,d);import{findFirstIdxMonotonousOrArrLen as _}from"../../../../../../base/common/arraysFind.js";import{createCancelablePromise as x,Delayer as w}from"../../../../../../base/common/async.js";import"../../../../../../base/common/cancellation.js";import{Disposable as I,DisposableStore as k}from"../../../../../../base/common/lifecycle.js";import{Range as F}from"../../../../../../editor/common/core/range.js";import"../../../../../../editor/common/model.js";import{PrefixSumComputer as E}from"../../../../../../editor/common/model/prefixSumComputer.js";import"../../../../../../editor/contrib/find/browser/findState.js";import{IConfigurationService as D}from"../../../../../../platform/configuration/common/configuration.js";import"./findFilters.js";import{FindMatchDecorationModel as R}from"./findMatchDecorationModel.js";import{CellEditState as l}from"../../notebookBrowser.js";import"../../viewModel/notebookViewModelImpl.js";import"../../../common/model/notebookTextModel.js";import{CellKind as g,NotebookCellsChangeType as v}from"../../../common/notebookCommon.js";class at{cell;index;_contentMatches;_webviewMatches;get length(){return this._contentMatches.length+this._webviewMatches.length}get contentMatches(){return this._contentMatches}get webviewMatches(){return this._webviewMatches}constructor(o,t,i,n){this.cell=o,this.index=t,this._contentMatches=i,this._webviewMatches=n}getMatch(o){if(o>=this.length)throw new Error("NotebookCellFindMatch: index out of range");return o<this._contentMatches.length?this._contentMatches[o]:this._webviewMatches[o-this._contentMatches.length]}}let p=class extends I{constructor(t,i,n){super();this._notebookEditor=t;this._state=i;this._configurationService=n;this._throttledDelayer=new w(20),this._computePromise=null,this._register(i.onFindReplaceStateChange(e=>{this._updateCellStates(e),(e.searchString||e.isRegex||e.matchCase||e.searchScope||e.wholeWord||e.isRevealed&&this._state.isRevealed||e.filters||e.isReplaceRevealed)&&this.research(),e.isRevealed&&!this._state.isRevealed&&this.clear()})),this._register(this._notebookEditor.onDidChangeModel(e=>{this._registerModelListener(e)})),this._register(this._notebookEditor.onDidChangeCellState(e=>{e.cell.cellKind===g.Markup&&e.source.editStateChanged&&this.research()})),this._notebookEditor.hasModel()&&this._registerModelListener(this._notebookEditor.textModel),this._findMatchDecorationModel=new R(this._notebookEditor,this._notebookEditor.getId())}_findMatches=[];_findMatchesStarts=null;_currentMatch=-1;_throttledDelayer;_computePromise=null;_modelDisposable=this._register(new k);_findMatchDecorationModel;get findMatches(){return this._findMatches}get currentMatch(){return this._currentMatch}_updateCellStates(t){if(!this._state.filters?.markupInput||!this._state.filters?.markupPreview||!this._state.filters?.findScope)return;const i=()=>{const n=this._notebookEditor.getViewModel();if(!n)return;const e=this._configurationService.inspect("editor.wordSeparators").value,r={regex:this._state.isRegex,wholeWord:this._state.wholeWord,caseSensitive:this._state.matchCase,wordSeparators:e,includeMarkupInput:!0,includeCodeInput:!1,includeMarkupPreview:!1,includeOutput:!1,findScope:this._state.filters?.findScope},h=n.find(this._state.searchString,r);for(let a=0;a<n.length;a++){const s=n.cellAt(a);if(s&&s.cellKind===g.Markup){const u=h.find(M=>M.cell.handle===s.handle&&M.contentMatches.length>0)?l.Editing:l.Preview,f=s.getEditState();if(f===l.Editing&&s.editStateSource!=="find")continue;f!==u&&s.updateEditState(u,"find")}}};if(t.isReplaceRevealed&&!this._state.isReplaceRevealed){const n=this._notebookEditor.getViewModel();if(!n)return;for(let e=0;e<n.length;e++){const r=n.cellAt(e);r&&r.cellKind===g.Markup&&r.getEditState()===l.Editing&&r.editStateSource==="find"&&r.updateEditState(l.Preview,"find")}return}(t.isReplaceRevealed||(t.filters||t.isRevealed||t.searchString||t.replaceString)&&this._state.isRevealed&&this._state.isReplaceRevealed)&&i()}ensureFindMatches(){this._findMatchesStarts||this.set(this._findMatches,!0)}getCurrentMatch(){const t=this._findMatchesStarts.getIndexOf(this._currentMatch),i=this._findMatches[t.index].cell,n=this._findMatches[t.index].getMatch(t.remainder);return{cell:i,match:n,isModelMatch:t.remainder<this._findMatches[t.index].contentMatches.length}}refreshCurrentMatch(t){const i=this.findMatches.findIndex(h=>h.cell===t.cell);if(i===-1)return;const e=this.findMatches[i].contentMatches.findIndex(h=>h.range.intersectRanges(t.range)!==null);if(e===void 0)return;const r=i===0?0:this._findMatchesStarts?.getPrefixSum(i-1)??0;this._currentMatch=r+e,this.highlightCurrentFindMatchDecoration(i,e).then(h=>{this.revealCellRange(i,e,h),this._state.changeMatchInfo(this._currentMatch,this._findMatches.reduce((a,s)=>a+s.length,0),void 0)})}find(t){if(!this.findMatches.length)return;if(!this._findMatchesStarts)this.set(this._findMatches,!0),"index"in t&&(this._currentMatch=t.index);else{const n=this._findMatchesStarts.getTotalSum();if("index"in t)this._currentMatch=t.index;else if(this._currentMatch===-1)this._currentMatch=t.previous?n-1:0;else{const e=(this._currentMatch+(t.previous?-1:1)+n)%n;this._currentMatch=e}}const i=this._findMatchesStarts.getIndexOf(this._currentMatch);this.highlightCurrentFindMatchDecoration(i.index,i.remainder).then(n=>{this.revealCellRange(i.index,i.remainder,n),this._state.changeMatchInfo(this._currentMatch,this._findMatches.reduce((e,r)=>e+r.length,0),void 0)})}revealCellRange(t,i,n){const e=this._findMatches[t];if(i>=e.contentMatches.length)this._notebookEditor.focusElement(e.cell),this._notebookEditor.getCellIndex(e.cell)!==void 0&&this._notebookEditor.revealCellOffsetInCenter(e.cell,n??0);else{const r=e.getMatch(i);e.cell.getEditState()!==l.Editing&&e.cell.updateEditState(l.Editing,"find"),e.cell.isInputCollapsed=!1,this._notebookEditor.focusElement(e.cell),this._notebookEditor.setCellEditorSelection(e.cell,r.range),this._notebookEditor.revealRangeInCenterIfOutsideViewportAsync(e.cell,r.range)}}_registerModelListener(t){this._modelDisposable.clear(),t&&this._modelDisposable.add(t.onDidChangeContent(i=>{i.rawEvents.some(n=>n.kind===v.ChangeCellContent||n.kind===v.ModelChange)&&this.research()})),this.research()}async research(){return this._throttledDelayer.trigger(async()=>{this._state.change({isSearching:!0},!1),await this._research(),this._state.change({isSearching:!1},!1)})}async _research(){if(this._computePromise?.cancel(),!this._state.isRevealed||!this._notebookEditor.hasModel()){this.set([],!1);return}this._computePromise=x(a=>this._compute(a));const t=await this._computePromise;if(!t){this.set([],!1);return}if(t.length===0){this.set([],!1);return}const i=a=>{const s=_(t.map(c=>c.index),c=>c>=a);this._updateCurrentMatch(t,this._matchesCountBeforeIndex(t,s))};if(this._currentMatch===-1)if(this._notebookEditor.getLength()===0){this.set(t,!1);return}else{const a=this._notebookEditor.getFocus().start;i(a),this.set(t,!1);return}const n=this._findMatchesStarts.getIndexOf(this._currentMatch),e=this._findMatches[n.index].cell,r=this._notebookEditor.getCellIndex(e);if(r<0){if(this._notebookEditor.getLength()===0){this.set(t,!1);return}i(r);return}const h=this._notebookEditor.cellAt(r);if(h.cellKind===g.Markup&&h.getEditState()===l.Preview){i(r);return}if(!this._findMatchDecorationModel.currentMatchDecorations){i(r);return}if(this._findMatchDecorationModel.currentMatchDecorations.kind==="input"){const a=this._findMatchDecorationModel.currentMatchDecorations.decorations.find(c=>c.ownerId===h.handle);if(!a){i(r);return}const s=_(t,c=>c.index>=r)%t.length;if(t[s].index>r){this._updateCurrentMatch(t,this._matchesCountBeforeIndex(t,s));return}else{let c=h.editorAttached&&a.decorations[0]?h.getCellDecorationRange(a.decorations[0]):null;if(c===null&&n.remainder<this._findMatches[n.index].contentMatches.length&&(c=this._findMatches[n.index].getMatch(n.remainder).range),c!==null){const u=t[s],f=_(u.contentMatches,M=>F.compareRangesUsingStarts(M.range,c)>=0);this._updateCurrentMatch(t,this._matchesCountBeforeIndex(t,s)+f)}else{this._updateCurrentMatch(t,this._matchesCountBeforeIndex(t,s));return}}}else{const a=_(t.map(s=>s.index),s=>s>=r)%t.length;this._updateCurrentMatch(t,this._matchesCountBeforeIndex(t,a))}}set(t,i){if(!t||!t.length){this._findMatches=[],this._findMatchDecorationModel.setAllFindMatchesDecorations([]),this.constructFindMatchesStarts(),this._currentMatch=-1,this._findMatchDecorationModel.clearCurrentFindMatchDecoration(),this._state.changeMatchInfo(this._currentMatch,this._findMatches.reduce((n,e)=>n+e.length,0),void 0);return}this._findMatches=t,this._findMatchDecorationModel.setAllFindMatchesDecorations(t||[]),this.constructFindMatchesStarts(),i&&(this._currentMatch=0,this.highlightCurrentFindMatchDecoration(0,0)),this._state.changeMatchInfo(this._currentMatch,this._findMatches.reduce((n,e)=>n+e.length,0),void 0)}async _compute(t){if(!this._notebookEditor.hasModel())return null;let i=null;const n=this._state.searchString,e=this._configurationService.inspect("editor.wordSeparators").value,r={regex:this._state.isRegex,wholeWord:this._state.wholeWord,caseSensitive:this._state.matchCase,wordSeparators:e,includeMarkupInput:this._state.filters?.markupInput??!0,includeCodeInput:this._state.filters?.codeInput??!0,includeMarkupPreview:!!this._state.filters?.markupPreview,includeOutput:!!this._state.filters?.codeOutput,findScope:this._state.filters?.findScope};return i=await this._notebookEditor.find(n,r,t),t.isCancellationRequested?null:i}_updateCurrentMatch(t,i){this._currentMatch=i%t.length,this.set(t,!1);const n=this._findMatchesStarts.getIndexOf(this._currentMatch);this.highlightCurrentFindMatchDecoration(n.index,n.remainder),this._state.changeMatchInfo(this._currentMatch,this._findMatches.reduce((e,r)=>e+r.length,0),void 0)}_matchesCountBeforeIndex(t,i){let n=0;for(let e=0;e<i;e++)n+=t[e].length;return n}constructFindMatchesStarts(){if(this._findMatches&&this._findMatches.length){const t=new Uint32Array(this._findMatches.length);for(let i=0;i<this._findMatches.length;i++)t[i]=this._findMatches[i].length;this._findMatchesStarts=new E(t)}else this._findMatchesStarts=null}async highlightCurrentFindMatchDecoration(t,i){const n=this._findMatches[t].cell,e=this._findMatches[t].getMatch(i);return i<this._findMatches[t].contentMatches.length?this._findMatchDecorationModel.highlightCurrentFindMatchDecorationInCell(n,e.range):this._findMatchDecorationModel.highlightCurrentFindMatchDecorationInWebview(n,e.index)}clear(){this._computePromise?.cancel(),this._throttledDelayer.cancel(),this.set([],!1)}dispose(){this._findMatchDecorationModel.dispose(),super.dispose()}};p=m([C(2,D)],p);export{at as CellFindMatchModel,p as FindModel};
