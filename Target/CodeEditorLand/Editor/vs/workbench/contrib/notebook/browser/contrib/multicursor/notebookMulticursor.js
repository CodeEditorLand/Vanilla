var X=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var D=(m,a,e,o)=>{for(var t=o>1?void 0:o?Y(a,e):a,i=m.length-1,r;i>=0;i--)(r=m[i])&&(t=(o?r(a,e,t):r(t))||t);return o&&t&&X(a,e,t),t},g=(m,a)=>(e,o)=>a(e,o,m);import{localize as x}from"../../../../../../nls.js";import{Emitter as Z}from"../../../../../../base/common/event.js";import{KeyCode as N,KeyMod as G}from"../../../../../../base/common/keyCodes.js";import{Disposable as L,DisposableStore as A}from"../../../../../../base/common/lifecycle.js";import{ResourceMap as V}from"../../../../../../base/common/map.js";import"../../../../../../base/common/uri.js";import{EditorConfiguration as J}from"../../../../../../editor/browser/config/editorConfiguration.js";import{CoreEditingCommands as Q}from"../../../../../../editor/browser/coreCommands.js";import"../../../../../../editor/browser/editorBrowser.js";import{RedoCommand as $,UndoCommand as ee}from"../../../../../../editor/browser/editorExtensions.js";import{CodeEditorWidget as O}from"../../../../../../editor/browser/widget/codeEditor/codeEditorWidget.js";import"../../../../../../editor/common/config/editorConfiguration.js";import{cursorBlinkingStyleFromString as _,cursorStyleFromString as W,TextEditorCursorBlinkingStyle as v,TextEditorCursorStyle as b}from"../../../../../../editor/common/config/editorOptions.js";import"../../../../../../editor/common/core/position.js";import"../../../../../../editor/common/core/range.js";import{Selection as S,SelectionDirection as B}from"../../../../../../editor/common/core/selection.js";import{USUAL_WORD_SEPARATORS as oe}from"../../../../../../editor/common/core/wordHelper.js";import{CommandExecutor as q,CursorsController as te}from"../../../../../../editor/common/cursor/cursor.js";import{DeleteOperations as U}from"../../../../../../editor/common/cursor/cursorDeleteOperations.js";import{CursorConfiguration as ie}from"../../../../../../editor/common/cursorCommon.js";import{CursorChangeReason as h}from"../../../../../../editor/common/cursorEvents.js";import{Handler as M}from"../../../../../../editor/common/editorCommon.js";import{ILanguageConfigurationService as re}from"../../../../../../editor/common/languages/languageConfigurationRegistry.js";import"../../../../../../editor/common/model.js";import{indentOfLine as ne}from"../../../../../../editor/common/model/textModel.js";import{ITextModelService as se}from"../../../../../../editor/common/services/resolverService.js";import"../../../../../../editor/common/viewModel.js";import{ViewModelEventsCollector as C}from"../../../../../../editor/common/viewModelEventDispatcher.js";import{WordHighlighterContribution as le}from"../../../../../../editor/contrib/wordHighlighter/browser/wordHighlighter.js";import{IAccessibilityService as ce}from"../../../../../../platform/accessibility/common/accessibility.js";import{MenuId as ae,registerAction2 as T}from"../../../../../../platform/actions/common/actions.js";import{IConfigurationService as F}from"../../../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as n,IContextKeyService as de,RawContextKey as K}from"../../../../../../platform/contextkey/common/contextkey.js";import"../../../../../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as R}from"../../../../../../platform/keybinding/common/keybindingsRegistry.js";import{IUndoRedoService as ue,UndoRedoElementType as he}from"../../../../../../platform/undoRedo/common/undoRedo.js";import{registerWorkbenchContribution2 as Ce,WorkbenchPhase as me}from"../../../../../common/contributions.js";import{IEditorService as y}from"../../../../../services/editor/common/editorService.js";import{NOTEBOOK_CELL_EDITOR_FOCUSED as z,NOTEBOOK_IS_ACTIVE_EDITOR as f}from"../../../common/notebookContextKeys.js";import{NotebookAction as P}from"../../controller/coreActions.js";import{getNotebookEditorFromEditorPane as E}from"../../notebookBrowser.js";import{registerNotebookContribution as fe}from"../../notebookEditorExtensions.js";import{CellEditorOptions as ge}from"../../view/cellParts/cellEditorOptions.js";const pe="notebook.addFindMatchToSelection";var be=(o=>(o[o.Idle=0]="Idle",o[o.Selecting=1]="Selecting",o[o.Editing=2]="Editing",o))(be||{});const c={IsNotebookMultiCursor:new K("isNotebookMultiSelect",!1),NotebookMultiSelectCursorState:new K("notebookMultiSelectCursorState",0)};let d=class extends L{constructor(e,o,t,i,r,s,l){super();this.notebookEditor=e;this.contextKeyService=o;this.textModelService=t;this.languageConfigurationService=i;this.accessibilityService=r;this.configurationService=s;this.undoRedoService=l;this.anchorCell=this.notebookEditor.activeCellAndCodeEditor,this._register(this.onDidChangeAnchorCell(()=>{this.updateCursorsControllers(),this.updateAnchorListeners()}))}static id="notebook.multiCursorController";word="";trackedMatches=[];_onDidChangeAnchorCell=this._register(new Z);onDidChangeAnchorCell=this._onDidChangeAnchorCell.event;anchorCell;anchorDisposables=this._register(new A);cursorsDisposables=this._register(new A);cursorsControllers=new V;state=0;getState(){return this.state}_nbIsMultiSelectSession=c.IsNotebookMultiCursor.bindTo(this.contextKeyService);_nbMultiSelectState=c.NotebookMultiSelectCursorState.bindTo(this.contextKeyService);updateCursorsControllers(){this.cursorsDisposables.clear(),this.trackedMatches.forEach(async e=>{const t=(await this.textModelService.createModelReference(e.cellViewModel.uri)).object.textEditorModel;if(!t)return;const i=this.constructCursorSimpleModel(e.cellViewModel),r=this.constructCoordinatesConverter(),s=e.editorConfig,l=this.cursorsDisposables.add(new te(t,i,r,new ie(t.getLanguageId(),t.getOptions(),s,this.languageConfigurationService)));l.setSelections(new C,void 0,e.wordSelections,h.Explicit),this.cursorsControllers.set(e.cellViewModel.uri,l)})}constructCoordinatesConverter(){return{convertViewPositionToModelPosition(e){return e},convertViewRangeToModelRange(e){return e},validateViewPosition(e,o){return e},validateViewRange(e,o){return e},convertModelPositionToViewPosition(e,o,t,i){return e},convertModelRangeToViewRange(e,o){return e},modelPositionIsVisible(e){return!0},getModelLineViewLineCount(e){return 1},getViewLineNumberOfModelPosition(e,o){return e}}}constructCursorSimpleModel(e){return{getLineCount(){return e.textBuffer.getLineCount()},getLineContent(o){return e.textBuffer.getLineContent(o)},getLineMinColumn(o){return e.textBuffer.getLineMinColumn(o)},getLineMaxColumn(o){return e.textBuffer.getLineMaxColumn(o)},getLineFirstNonWhitespaceColumn(o){return e.textBuffer.getLineFirstNonWhitespaceColumn(o)},getLineLastNonWhitespaceColumn(o){return e.textBuffer.getLineLastNonWhitespaceColumn(o)},normalizePosition(o,t){return o},getLineIndentColumn(o){return ne(e.textBuffer.getLineContent(o))+1}}}updateAnchorListeners(){if(this.anchorDisposables.clear(),!this.anchorCell)throw new Error("Anchor cell is undefined");this.anchorDisposables.add(this.anchorCell[1].onWillType(e=>{const o=new C;this.trackedMatches.forEach(t=>{const i=this.cursorsControllers.get(t.cellViewModel.uri);i&&t.cellViewModel.handle!==this.anchorCell?.[0].handle&&i.type(o,e,"keyboard")})})),this.anchorDisposables.add(this.anchorCell[1].onDidType(()=>{this.state=2,this._nbMultiSelectState.set(2);const e=this.cursorsControllers.get(this.anchorCell[0].uri);if(!e)return;const o=this.notebookEditor.activeCodeEditor?.getSelections();o&&(e.setSelections(new C,"keyboard",o,h.Explicit),this.trackedMatches.forEach(t=>{const i=this.cursorsControllers.get(t.cellViewModel.uri);i&&(t.initialSelection=i.getSelection(),t.wordSelections=[])}),this.updateLazyDecorations())})),this.anchorDisposables.add(this.anchorCell[1].onDidChangeCursorSelection(e=>{if(e.source==="mouse"){this.resetToIdleState();return}if(!e.oldSelections||e.reason===h.NotSet||e.reason===h.RecoverFromMarkers)return;const o={deltaStartCol:e.selection.startColumn-e.oldSelections[0].startColumn,deltaStartLine:e.selection.startLineNumber-e.oldSelections[0].startLineNumber,deltaEndCol:e.selection.endColumn-e.oldSelections[0].endColumn,deltaEndLine:e.selection.endLineNumber-e.oldSelections[0].endLineNumber},t=e.selection.getDirection();this.trackedMatches.forEach(i=>{const r=this.cursorsControllers.get(i.cellViewModel.uri);if(!r)return;const s=r.getSelections().map(l=>{const u=l.startColumn+o.deltaStartCol,p=l.startLineNumber+o.deltaStartLine,I=l.endColumn+o.deltaEndCol,w=l.endLineNumber+o.deltaEndLine;return S.createWithDirection(p,u,w,I,t)});r.setSelections(new C,e.source,s,h.Explicit)}),this.updateLazyDecorations()})),this.anchorDisposables.add(this.anchorCell[1].onWillTriggerEditorOperationEvent(e=>{this.trackedMatches.forEach(o=>{if(o.cellViewModel.handle===this.anchorCell?.[0].handle)return;const t=new C,i=this.cursorsControllers.get(o.cellViewModel.uri);if(i)switch(e.handlerId){case M.CompositionStart:i.startComposition(t);return;case M.CompositionEnd:i.endComposition(t,e.source);return;case M.ReplacePreviousChar:{const r=e.payload;i.compositionType(t,r.text||"",r.replaceCharCnt||0,0,0,e.source);return}case M.CompositionType:{const r=e.payload;i.compositionType(t,r.text||"",r.replacePrevCharCnt||0,r.replaceNextCharCnt||0,r.positionDelta||0,e.source);return}case M.Paste:{const r=e.payload;i.paste(t,r.text||"",r.pasteOnNewLine||!1,r.multicursorText||null,e.source);return}case M.Cut:i.cut(t,e.source);return}})})),this.anchorDisposables.add(this.anchorCell[1].onDidBlurEditorWidget(()=>{(this.state===1||this.state===2)&&this.resetToIdleState()}))}updateFinalUndoRedo(){if(!this.anchorCell?.[1].getModel())return;const o=new V,t=[];this.trackedMatches.forEach(i=>{if(!i.undoRedoHistory)return;t.push(i.cellViewModel.uri);const s=this.undoRedoService.getElements(i.cellViewModel.uri).past.slice(),l=i.undoRedoHistory.past.slice(),u=s.slice(l.length);u.length!==0&&(o.set(i.cellViewModel.uri,u),this.undoRedoService.removeElements(i.cellViewModel.uri),l.forEach(p=>{this.undoRedoService.pushElement(p)}))}),this.undoRedoService.pushElement({type:he.Workspace,resources:t,label:"Multi Cursor Edit",code:"multiCursorEdit",confirmBeforeUndo:!1,undo:async()=>{o.forEach(async i=>{i.reverse().forEach(async r=>{await r.undo()})})},redo:async()=>{o.forEach(async i=>{i.forEach(async r=>{await r.redo()})})}})}resetToIdleState(){this.state=0,this._nbMultiSelectState.set(0),this._nbIsMultiSelectSession.set(!1),this.updateFinalUndoRedo(),this.trackedMatches.forEach(e=>{this.clearDecorations(e),e.cellViewModel.setSelections([e.initialSelection])}),this.anchorDisposables.clear(),this.anchorCell=void 0,this.cursorsDisposables.clear(),this.cursorsControllers.clear(),this.trackedMatches=[]}async findAndTrackNextSelection(e){if(this.state===0){const o=e.textModel;if(!o)return;const t=e.getSelections()[0],i=this.getWord(t,o);if(!i)return;this.word=i.word;const r=new S(t.startLineNumber,i.startColumn,t.startLineNumber,i.endColumn);if(e.setSelections([r]),this.anchorCell=this.notebookEditor.activeCellAndCodeEditor,!this.anchorCell||this.anchorCell[0].handle!==e.handle)throw new Error("Active cell is not the same as the cell passed as context");if(!(this.anchorCell[1]instanceof O))throw new Error("Active cell is not an instance of CodeEditorWidget");o.pushStackElement(),this.trackedMatches=[];const s=this.constructCellEditorOptions(this.anchorCell[0]),l=s.getRawOptions(),u={cursorStyle:W(l.cursorStyle),cursorBlinking:_(l.cursorBlinking),cursorSmoothCaretAnimation:l.cursorSmoothCaretAnimation},p={cellViewModel:e,initialSelection:t,wordSelections:[r],editorConfig:s,cursorConfig:u,decorationIds:[],undoRedoHistory:this.undoRedoService.getElements(e.uri)};this.trackedMatches.push(p),this._nbIsMultiSelectSession.set(!0),this.state=1,this._nbMultiSelectState.set(1),this._onDidChangeAnchorCell.fire()}else if(this.state===1){const o=this.notebookEditor.textModel;if(!o)return;const t=this.notebookEditor.getCellIndex(e);if(t===void 0)return;const i=o.findNextMatch(this.word,{cellIndex:t,position:e.getSelections()[e.getSelections().length-1].getEndPosition()},!1,!0,oe);if(!i)return;const r=this.notebookEditor.getCellByHandle(i.cell.handle);if(!r)return;let s;if(i.cell.handle===e.handle){s=this.trackedMatches.find(u=>u.cellViewModel.handle===i.cell.handle),s.wordSelections.push(S.fromRange(i.match.range,B.LTR)),r.setSelections(s.wordSelections);const l=this.cursorsControllers.get(s.cellViewModel.uri);if(!l)return;l.setSelections(new C,void 0,s.wordSelections,h.Explicit)}else if(i.cell.handle!==e.handle){await this.notebookEditor.revealRangeInViewAsync(r,i.match.range),this.notebookEditor.focusNotebookCell(r,"editor");const l=r.getSelections()[0],u=S.fromRange(i.match.range,B.LTR);if(r.setSelections([u]),this.notebookEditor.activeCellAndCodeEditor?.[0].handle!==r.handle)throw new Error("Focused cell does not match the find match data");if(this.anchorCell=this.notebookEditor.activeCellAndCodeEditor,!this.anchorCell||!(this.anchorCell[1]instanceof O))throw new Error("Active cell is not an instance of CodeEditorWidget");(await r.resolveTextModel()).pushStackElement();const I=this.constructCellEditorOptions(this.anchorCell[0]),w=I.getRawOptions(),H={cursorStyle:W(w.cursorStyle),cursorBlinking:_(w.cursorBlinking),cursorSmoothCaretAnimation:w.cursorSmoothCaretAnimation};s={cellViewModel:r,initialSelection:l,wordSelections:[u],editorConfig:I,cursorConfig:H,decorationIds:[],undoRedoHistory:this.undoRedoService.getElements(r.uri)},this.trackedMatches.push(s),this._onDidChangeAnchorCell.fire(),this.initializeMultiSelectDecorations(this.trackedMatches.find(j=>j.cellViewModel.handle===e.handle))}else return}}async deleteLeft(){this.trackedMatches.forEach(e=>{const o=this.cursorsControllers.get(e.cellViewModel.uri);if(!o)return;const[,t]=U.deleteLeft(o.getPrevEditOperationType(),o.context.cursorConfig,o.context.model,o.getSelections(),o.getAutoClosedCharacters()),i=q.executeCommands(o.context.model,o.getSelections(),t);i&&o.setSelections(new C,void 0,i,h.Explicit)}),this.updateLazyDecorations()}async deleteRight(){this.trackedMatches.forEach(e=>{const o=this.cursorsControllers.get(e.cellViewModel.uri);if(!o)return;const[,t]=U.deleteRight(o.getPrevEditOperationType(),o.context.cursorConfig,o.context.model,o.getSelections());if(e.cellViewModel.handle!==this.anchorCell?.[0].handle){const i=q.executeCommands(o.context.model,o.getSelections(),t);if(!i)return;o.setSelections(new C,void 0,i,h.Explicit)}else o.setSelections(new C,void 0,e.cellViewModel.getSelections(),h.Explicit)}),this.updateLazyDecorations()}async undo(){const e=[];for(const o of this.trackedMatches){const t=await o.cellViewModel.resolveTextModel();t&&e.push(t);const i=this.cursorsControllers.get(o.cellViewModel.uri);if(!i)return;i.setSelections(new C,void 0,o.cellViewModel.getSelections(),h.Explicit)}await Promise.all(e.map(o=>o.undo())),this.updateLazyDecorations()}async redo(){const e=[];for(const o of this.trackedMatches){const t=await o.cellViewModel.resolveTextModel();t&&e.push(t);const i=this.cursorsControllers.get(o.cellViewModel.uri);if(!i)return;i.setSelections(new C,void 0,o.cellViewModel.getSelections(),h.Explicit)}await Promise.all(e.map(o=>o.redo())),this.updateLazyDecorations()}constructCellEditorOptions(e){const t=new ge(this.notebookEditor.getBaseCellEditorOptions(e.language),this.notebookEditor.notebookOptions,this.configurationService).getUpdatedValue(e.internalMetadata,e.uri);return new J(!1,ae.EditorContent,t,null,this.accessibilityService)}initializeMultiSelectDecorations(e,o){if(!e)return;const t=[];e.wordSelections.forEach(i=>{t.push({range:S.fromPositions(i.getEndPosition()),options:{description:"",className:this.getClassName(e.cursorConfig,!0)}})}),e.decorationIds=e.cellViewModel.deltaModelDecorations(e.decorationIds,t)}updateLazyDecorations(){this.trackedMatches.forEach(e=>{if(e.cellViewModel.handle===this.anchorCell?.[0].handle)return;const o=this.cursorsControllers.get(e.cellViewModel.uri);if(!o)return;const t=o.getSelections(),i=[];t?.map(s=>{s.isEmpty()||i.push({range:s,options:{description:"",className:this.getClassName(e.cursorConfig,!1)}}),i.push({range:S.fromPositions(s.getPosition()),options:{description:"",zIndex:1e4,className:this.getClassName(e.cursorConfig,!0)}})}),e.decorationIds=e.cellViewModel.deltaModelDecorations(e.decorationIds,i);const r=this.notebookEditor.codeEditors.find(s=>s[0]===e.cellViewModel);r&&le.get(r[1])?.wordHighlighter?.trigger()})}clearDecorations(e){e.decorationIds=e.cellViewModel.deltaModelDecorations(e.decorationIds,[])}getWord(e,o){const t=e.startLineNumber,i=e.startColumn;return o.isDisposed()?null:o.getWordAtPosition({lineNumber:t,column:i})}getClassName(e,o){let t=o?".nb-multicursor-cursor":".nb-multicursor-selection";if(o){switch(e.cursorStyle){case b.Line:break;case b.Block:t+=".nb-cursor-block-style";break;case b.Underline:t+=".nb-cursor-underline-style";break;case b.LineThin:t+=".nb-cursor-line-thin-style";break;case b.BlockOutline:t+=".nb-cursor-block-outline-style";break;case b.UnderlineThin:t+=".nb-cursor-underline-thin-style";break;default:break}switch(e.cursorBlinking){case v.Blink:t+=".nb-blink";break;case v.Smooth:t+=".nb-smooth";break;case v.Phase:t+=".nb-phase";break;case v.Expand:t+=".nb-expand";break;case v.Solid:t+=".nb-solid";break;default:t+=".nb-solid";break}(e.cursorSmoothCaretAnimation==="on"||e.cursorSmoothCaretAnimation==="explicit")&&(t+=".nb-smooth-caret-animation")}return t}dispose(){super.dispose(),this.anchorDisposables.dispose(),this.cursorsDisposables.dispose(),this.trackedMatches.forEach(e=>{this.clearDecorations(e)}),this.trackedMatches=[]}};d=D([g(1,de),g(2,se),g(3,re),g(4,ce),g(5,F),g(6,ue)],d);class Se extends P{constructor(){super({id:pe,title:x("addFindMatchToSelection","Add Find Match to Selection"),precondition:n.and(n.equals("config.notebook.multiCursor.enabled",!0),f,z),keybinding:{when:n.and(n.equals("config.notebook.multiCursor.enabled",!0),f,z),primary:G.CtrlCmd|N.KeyD,weight:R.WorkbenchContrib}})}async runWithContext(a,e){const o=a.get(y),t=E(o.activeEditorPane);if(!t||!e.cell)return;t.getContribution(d.id).findAndTrackNextSelection(e.cell)}}class Me extends P{constructor(){super({id:"noteMultiCursor.exit",title:x("exitMultiSelection","Exit Multi Cursor Mode"),precondition:n.and(n.equals("config.notebook.multiCursor.enabled",!0),f,c.IsNotebookMultiCursor),keybinding:{when:n.and(n.equals("config.notebook.multiCursor.enabled",!0),f,c.IsNotebookMultiCursor),primary:N.Escape,weight:R.WorkbenchContrib}})}async runWithContext(a,e){const o=a.get(y),t=E(o.activeEditorPane);if(!t)return;t.getContribution(d.id).resetToIdleState()}}class Ee extends P{constructor(){super({id:"noteMultiCursor.deleteLeft",title:x("deleteLeftMultiSelection","Delete Left"),precondition:n.and(n.equals("config.notebook.multiCursor.enabled",!0),f,c.IsNotebookMultiCursor,n.or(c.NotebookMultiSelectCursorState.isEqualTo(1),c.NotebookMultiSelectCursorState.isEqualTo(2))),keybinding:{when:n.and(n.equals("config.notebook.multiCursor.enabled",!0),f,c.IsNotebookMultiCursor,n.or(c.NotebookMultiSelectCursorState.isEqualTo(1),c.NotebookMultiSelectCursorState.isEqualTo(2))),primary:N.Backspace,weight:R.WorkbenchContrib}})}async runWithContext(a,e){const o=a.get(y),t=E(o.activeEditorPane);if(!t)return;t.getContribution(d.id).deleteLeft()}}class ke extends P{constructor(){super({id:"noteMultiCursor.deleteRight",title:x("deleteRightMultiSelection","Delete Right"),precondition:n.and(n.equals("config.notebook.multiCursor.enabled",!0),f,c.IsNotebookMultiCursor,n.or(c.NotebookMultiSelectCursorState.isEqualTo(1),c.NotebookMultiSelectCursorState.isEqualTo(2))),keybinding:{when:n.and(n.equals("config.notebook.multiCursor.enabled",!0),f,c.IsNotebookMultiCursor,n.or(c.NotebookMultiSelectCursorState.isEqualTo(1),c.NotebookMultiSelectCursorState.isEqualTo(2))),primary:N.Delete,weight:R.WorkbenchContrib}})}async runWithContext(a,e){const o=a.get(y),t=E(o.activeEditorPane);if(!t)return;const i=t.activeCodeEditor;if(!i)return;Q.DeleteRight.runEditorCommand(a,i,null),t.getContribution(d.id).deleteRight()}}let k=class extends L{constructor(e,o){super();this._editorService=e;this.configurationService=o;if(!this.configurationService.getValue("notebook.multiCursor.enabled"))return;const t=10005;this._register(ee.addImplementation(t,"notebook-multicursor-undo-redo",()=>{const i=E(this._editorService.activeEditorPane);return!i||!i.hasModel()?!1:i.getContribution(d.id).undo()},n.and(n.equals("config.notebook.multiCursor.enabled",!0),f,c.IsNotebookMultiCursor))),this._register($.addImplementation(t,"notebook-multicursor-undo-redo",()=>{const i=E(this._editorService.activeEditorPane);return!i||!i.hasModel()?!1:i.getContribution(d.id).redo()},n.and(n.equals("config.notebook.multiCursor.enabled",!0),f,c.IsNotebookMultiCursor)))}static ID="workbench.contrib.notebook.multiCursorUndoRedo"};k=D([g(0,y),g(1,F)],k),fe(d.id,d),Ce(k.ID,k,me.BlockRestore),T(Se),T(Me),T(Ee),T(ke);export{c as NOTEBOOK_MULTI_CURSOR_CONTEXT,d as NotebookMultiCursorController,be as NotebookMultiCursorState};
