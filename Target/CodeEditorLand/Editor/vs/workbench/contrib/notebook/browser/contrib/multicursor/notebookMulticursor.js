var O=Object.defineProperty;var _=Object.getOwnPropertyDescriptor;var E=(d,s,e,t)=>{for(var o=t>1?void 0:t?_(s,e):s,i=d.length-1,r;i>=0;i--)(r=d[i])&&(o=(t?r(s,e,o):r(o))||o);return t&&o&&O(s,e,o),o},u=(d,s)=>(e,t)=>s(e,t,d);import{localize as v}from"../../../../../../nls.js";import{Emitter as W}from"../../../../../../base/common/event.js";import{KeyCode as w,KeyMod as B}from"../../../../../../base/common/keyCodes.js";import{Disposable as R,DisposableStore as T}from"../../../../../../base/common/lifecycle.js";import{ResourceMap as N}from"../../../../../../base/common/map.js";import"../../../../../../base/common/uri.js";import{EditorConfiguration as K}from"../../../../../../editor/browser/config/editorConfiguration.js";import"../../../../../../editor/browser/editorBrowser.js";import{RedoCommand as U,UndoCommand as F}from"../../../../../../editor/browser/editorExtensions.js";import{CodeEditorWidget as D}from"../../../../../../editor/browser/widget/codeEditor/codeEditorWidget.js";import"../../../../../../editor/common/config/editorConfiguration.js";import"../../../../../../editor/common/core/position.js";import"../../../../../../editor/common/core/range.js";import{Selection as I,SelectionDirection as A}from"../../../../../../editor/common/core/selection.js";import{USUAL_WORD_SEPARATORS as H}from"../../../../../../editor/common/core/wordHelper.js";import{CommandExecutor as z,CursorsController as q}from"../../../../../../editor/common/cursor/cursor.js";import{DeleteOperations as j}from"../../../../../../editor/common/cursor/cursorDeleteOperations.js";import{CursorConfiguration as X}from"../../../../../../editor/common/cursorCommon.js";import{CursorChangeReason as b}from"../../../../../../editor/common/cursorEvents.js";import{Handler as C}from"../../../../../../editor/common/editorCommon.js";import{ILanguageConfigurationService as Y}from"../../../../../../editor/common/languages/languageConfigurationRegistry.js";import"../../../../../../editor/common/model.js";import{indentOfLine as Z}from"../../../../../../editor/common/model/textModel.js";import{ITextModelService as G}from"../../../../../../editor/common/services/resolverService.js";import"../../../../../../editor/common/viewModel.js";import{ViewModelEventsCollector as p}from"../../../../../../editor/common/viewModelEventDispatcher.js";import{IAccessibilityService as J}from"../../../../../../platform/accessibility/common/accessibility.js";import{MenuId as Q,registerAction2 as k}from"../../../../../../platform/actions/common/actions.js";import{IConfigurationService as L}from"../../../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as c,IContextKeyService as $,RawContextKey as V}from"../../../../../../platform/contextkey/common/contextkey.js";import"../../../../../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as y}from"../../../../../../platform/keybinding/common/keybindingsRegistry.js";import{IUndoRedoService as ee,UndoRedoElementType as te}from"../../../../../../platform/undoRedo/common/undoRedo.js";import{registerWorkbenchContribution2 as oe,WorkbenchPhase as ie}from"../../../../../common/contributions.js";import{IEditorService as M}from"../../../../../services/editor/common/editorService.js";import{NOTEBOOK_CELL_EDITOR_FOCUSED as re,NOTEBOOK_IS_ACTIVE_EDITOR as g}from"../../../common/notebookContextKeys.js";import{NotebookAction as x}from"../../controller/coreActions.js";import{getNotebookEditorFromEditorPane as S}from"../../notebookBrowser.js";import{registerNotebookContribution as ne}from"../../notebookEditorExtensions.js";import{CellEditorOptions as se}from"../../view/cellParts/cellEditorOptions.js";const le="notebook.addFindMatchToSelection";var ce=(t=>(t[t.Idle=0]="Idle",t[t.Selecting=1]="Selecting",t[t.Editing=2]="Editing",t))(ce||{});const h={IsNotebookMultiSelect:new V("isNotebookMultiSelect",!1),NotebookMultiSelectState:new V("notebookMultiSelectState",0)};let a=class extends R{constructor(e,t,o,i,r,n,l){super();this.notebookEditor=e;this.contextKeyService=t;this.textModelService=o;this.languageConfigurationService=i;this.accessibilityService=r;this.configurationService=n;this.undoRedoService=l;this.configurationService.getValue("notebook.multiSelect.enabled")&&(this.anchorCell=this.notebookEditor.activeCellAndCodeEditor,this._register(this.onDidChangeAnchorCell(()=>{this.updateCursorsControllers(),this.updateAnchorListeners()})))}static id="notebook.multiCursorController";state=0;word="";trackedMatches=[];_onDidChangeAnchorCell=this._register(new W);onDidChangeAnchorCell=this._onDidChangeAnchorCell.event;anchorCell;anchorDisposables=this._register(new T);cursorsDisposables=this._register(new T);cursorsControllers=new N;_nbIsMultiSelectSession=h.IsNotebookMultiSelect.bindTo(this.contextKeyService);_nbMultiSelectState=h.NotebookMultiSelectState.bindTo(this.contextKeyService);updateCursorsControllers(){this.cursorsDisposables.clear(),this.trackedMatches.forEach(async e=>{const o=(await this.textModelService.createModelReference(e.cellViewModel.uri)).object.textEditorModel;if(!o)return;const i=this.constructCursorSimpleModel(e.cellViewModel),r=this.constructCoordinatesConverter(),n=e.config,l=this.cursorsDisposables.add(new q(o,i,r,new X(o.getLanguageId(),o.getOptions(),n,this.languageConfigurationService)));l.setSelections(new p,void 0,e.wordSelections,b.Explicit),this.cursorsControllers.set(e.cellViewModel.uri,l)})}constructCoordinatesConverter(){return{convertViewPositionToModelPosition(e){return e},convertViewRangeToModelRange(e){return e},validateViewPosition(e,t){return e},validateViewRange(e,t){return e},convertModelPositionToViewPosition(e,t,o,i){return e},convertModelRangeToViewRange(e,t){return e},modelPositionIsVisible(e){return!0},getModelLineViewLineCount(e){return 1},getViewLineNumberOfModelPosition(e,t){return e}}}constructCursorSimpleModel(e){return{getLineCount(){return e.textBuffer.getLineCount()},getLineContent(t){return e.textBuffer.getLineContent(t)},getLineMinColumn(t){return e.textBuffer.getLineMinColumn(t)},getLineMaxColumn(t){return e.textBuffer.getLineMaxColumn(t)},getLineFirstNonWhitespaceColumn(t){return e.textBuffer.getLineFirstNonWhitespaceColumn(t)},getLineLastNonWhitespaceColumn(t){return e.textBuffer.getLineLastNonWhitespaceColumn(t)},normalizePosition(t,o){return t},getLineIndentColumn(t){return Z(e.textBuffer.getLineContent(t))+1}}}updateAnchorListeners(){if(this.anchorDisposables.clear(),!this.anchorCell)throw new Error("Anchor cell is undefined");this.anchorDisposables.add(this.anchorCell[1].onWillType(e=>{const t=new p;this.trackedMatches.forEach(o=>{const i=this.cursorsControllers.get(o.cellViewModel.uri);i&&o.cellViewModel.handle!==this.anchorCell?.[0].handle&&i.type(t,e,"keyboard")})})),this.anchorDisposables.add(this.anchorCell[1].onDidType(()=>{this.state=2,this._nbMultiSelectState.set(2);const e=this.cursorsControllers.get(this.anchorCell[0].uri);if(!e)return;const t=this.notebookEditor.activeCodeEditor?.getSelections();t&&(e.setSelections(new p,"keyboard",t,b.Explicit),this.trackedMatches.forEach(o=>{const i=this.cursorsControllers.get(o.cellViewModel.uri);i&&(o.initialSelection=i.getSelection(),o.wordSelections=[])}),this.updateLazyDecorations())})),this.anchorDisposables.add(this.anchorCell[1].onDidChangeCursorSelection(e=>{e.source==="keyboard"&&this.trackedMatches.forEach(t=>{const o=this.cursorsControllers.get(t.cellViewModel.uri);o&&(o.setSelections(new p,e.source,[e.selection],b.Explicit),this.updateLazyDecorations())})})),this.anchorDisposables.add(this.anchorCell[1].onWillTriggerEditorOperationEvent(e=>{this.trackedMatches.forEach(t=>{if(t.cellViewModel.handle===this.anchorCell?.[0].handle)return;const o=new p,i=this.cursorsControllers.get(t.cellViewModel.uri);if(i)switch(e.handlerId){case C.CompositionStart:i.startComposition(o);return;case C.CompositionEnd:i.endComposition(o,e.source);return;case C.ReplacePreviousChar:{const r=e.payload;i.compositionType(o,r.text||"",r.replaceCharCnt||0,0,0,e.source);return}case C.CompositionType:{const r=e.payload;i.compositionType(o,r.text||"",r.replacePrevCharCnt||0,r.replaceNextCharCnt||0,r.positionDelta||0,e.source);return}case C.Paste:{const r=e.payload;i.paste(o,r.text||"",r.pasteOnNewLine||!1,r.multicursorText||null,e.source);return}case C.Cut:i.cut(o,e.source);return}})})),this.anchorDisposables.add(this.anchorCell[1].onDidChangeCursorSelection(e=>{(e.source==="mouse"||e.source==="deleteRight")&&this.resetToIdleState()})),this.anchorDisposables.add(this.anchorCell[1].onDidBlurEditorWidget(()=>{(this.state===1||this.state===2)&&this.resetToIdleState()}))}updateFinalUndoRedo(){if(!this.anchorCell?.[1].getModel())return;const t=new N,o=[];this.trackedMatches.forEach(i=>{if(!i.undoRedoHistory)return;o.push(i.cellViewModel.uri);const n=this.undoRedoService.getElements(i.cellViewModel.uri).past.slice(),l=i.undoRedoHistory.past.slice(),m=n.slice(l.length);m.length!==0&&(t.set(i.cellViewModel.uri,m),this.undoRedoService.removeElements(i.cellViewModel.uri),l.forEach(P=>{this.undoRedoService.pushElement(P)}))}),this.undoRedoService.pushElement({type:te.Workspace,resources:o,label:"Multi Cursor Edit",code:"multiCursorEdit",confirmBeforeUndo:!1,undo:async()=>{t.forEach(async i=>{i.reverse().forEach(async r=>{await r.undo()})})},redo:async()=>{t.forEach(async i=>{i.forEach(async r=>{await r.redo()})})}})}resetToIdleState(){this.state=0,this._nbMultiSelectState.set(0),this._nbIsMultiSelectSession.set(!1),this.updateFinalUndoRedo(),this.trackedMatches.forEach(e=>{this.clearDecorations(e),e.cellViewModel.setSelections([e.initialSelection])}),this.anchorDisposables.clear(),this.cursorsDisposables.clear(),this.cursorsControllers.clear(),this.trackedMatches=[]}async findAndTrackNextSelection(e){if(this.state===0){const t=e.textModel;if(!t)return;const o=e.getSelections()[0],i=this.getWord(o,t);if(!i)return;this.word=i.word;const r=new I(o.startLineNumber,i.startColumn,o.startLineNumber,i.endColumn);if(e.setSelections([r]),this.anchorCell=this.notebookEditor.activeCellAndCodeEditor,!this.anchorCell||this.anchorCell[0].handle!==e.handle)throw new Error("Active cell is not the same as the cell passed as context");if(!(this.anchorCell[1]instanceof D))throw new Error("Active cell is not an instance of CodeEditorWidget");t.pushStackElement(),this.trackedMatches=[];const n=this.constructCellEditorOptions(this.anchorCell[0]),l={cellViewModel:e,initialSelection:o,wordSelections:[r],config:n,decorationIds:[],undoRedoHistory:this.undoRedoService.getElements(e.uri)};this.trackedMatches.push(l),this.initializeMultiSelectDecorations(l),this._nbIsMultiSelectSession.set(!0),this.state=1,this._nbMultiSelectState.set(1),this._onDidChangeAnchorCell.fire()}else if(this.state===1){const t=this.notebookEditor.textModel;if(!t)return;const o=this.notebookEditor.getCellIndex(e);if(o===void 0)return;const i=t.findNextMatch(this.word,{cellIndex:o,position:e.getSelections()[e.getSelections().length-1].getEndPosition()},!1,!0,H);if(!i)return;const r=this.notebookEditor.getCellByHandle(i.cell.handle);if(!r)return;let n;if(i.cell.handle!==e.handle){await this.notebookEditor.revealRangeInViewAsync(r,i.match.range),this.notebookEditor.focusNotebookCell(r,"editor");const l=r.getSelections()[0],m=I.fromRange(i.match.range,A.LTR);if(r.setSelections([m]),this.anchorCell=this.notebookEditor.activeCellAndCodeEditor,!this.anchorCell||!(this.anchorCell[1]instanceof D))throw new Error("Active cell is not an instance of CodeEditorWidget");(await r.resolveTextModel()).pushStackElement(),n={cellViewModel:r,initialSelection:l,wordSelections:[m],config:this.constructCellEditorOptions(this.anchorCell[0]),decorationIds:[],undoRedoHistory:this.undoRedoService.getElements(r.uri)},this.trackedMatches.push(n),this._onDidChangeAnchorCell.fire()}else n=this.trackedMatches.find(l=>l.cellViewModel.handle===i.cell.handle),n.wordSelections.push(I.fromRange(i.match.range,A.LTR)),r.setSelections(n.wordSelections);this.initializeMultiSelectDecorations(n)}}async deleteLeft(){this.trackedMatches.forEach(e=>{const t=this.cursorsControllers.get(e.cellViewModel.uri);if(!t)return;const[,o]=j.deleteLeft(t.getPrevEditOperationType(),t.context.cursorConfig,t.context.model,t.getSelections(),t.getAutoClosedCharacters()),i=z.executeCommands(t.context.model,t.getSelections(),o);i&&t.setSelections(new p,void 0,i,b.Explicit)})}async undo(){const e=[];for(const t of this.trackedMatches){const o=await t.cellViewModel.resolveTextModel();o&&e.push(o)}await Promise.all(e.map(t=>t.undo()))}async redo(){const e=[];for(const t of this.trackedMatches){const o=await t.cellViewModel.resolveTextModel();o&&e.push(o)}await Promise.all(e.map(t=>t.redo()))}constructCellEditorOptions(e){const o=new se(this.notebookEditor.getBaseCellEditorOptions(e.language),this.notebookEditor.notebookOptions,this.configurationService).getUpdatedValue(e.internalMetadata,e.uri);return new K(!1,Q.EditorContent,o,null,this.accessibilityService)}initializeMultiSelectDecorations(e){const t=[];e.wordSelections.forEach(o=>{t.push({range:o,options:{description:"",className:"nb-multicursor-selection"}})}),e.decorationIds=e.cellViewModel.deltaModelDecorations(e.decorationIds,t)}updateLazyDecorations(){this.trackedMatches.forEach(e=>{if(this.notebookEditor.getCellIndex(e.cellViewModel)===void 0)return;const o=this.cursorsControllers.get(e.cellViewModel.uri);if(!o)return;const r=o.getSelections()?.map(n=>({range:n,options:{description:"",className:"nb-multicursor-selection"}}));e.decorationIds=e.cellViewModel.deltaModelDecorations(e.decorationIds,r??[])})}clearDecorations(e){e.decorationIds=e.cellViewModel.deltaModelDecorations(e.decorationIds,[])}getWord(e,t){const o=e.startLineNumber,i=e.startColumn;return t.isDisposed()?null:t.getWordAtPosition({lineNumber:o,column:i})}dispose(){super.dispose(),this.anchorDisposables.dispose(),this.cursorsDisposables.dispose(),this.trackedMatches.forEach(e=>{this.clearDecorations(e)}),this.trackedMatches=[]}};a=E([u(1,$),u(2,G),u(3,Y),u(4,J),u(5,L),u(6,ee)],a);class ae extends x{constructor(){super({id:le,title:v("addFindMatchToSelection","Add Find Match to Selection"),keybinding:{when:c.and(c.equals("config.notebook.multiSelect.enabled",!0),g,re),primary:B.CtrlCmd|w.KeyD,weight:y.WorkbenchContrib}})}async runWithContext(s,e){const t=s.get(M),o=S(t.activeEditorPane);if(!o||!e.cell)return;o.getContribution(a.id).findAndTrackNextSelection(e.cell)}}class de extends x{constructor(){super({id:"noteMultiCursor.exit",title:v("exitMultiSelection","Exit Multi Cursor Mode"),keybinding:{when:c.and(c.equals("config.notebook.multiSelect.enabled",!0),g,h.IsNotebookMultiSelect),primary:w.Escape,weight:y.WorkbenchContrib}})}async runWithContext(s,e){const t=s.get(M),o=S(t.activeEditorPane);if(!o)return;o.getContribution(a.id).resetToIdleState()}}class ue extends x{constructor(){super({id:"noteMultiCursor.deleteLeft",title:v("deleteLeftMultiSelection","Delete Left"),keybinding:{when:c.and(c.equals("config.notebook.multiSelect.enabled",!0),g,h.IsNotebookMultiSelect,c.or(h.NotebookMultiSelectState.isEqualTo(1),h.NotebookMultiSelectState.isEqualTo(2))),primary:w.Backspace,weight:y.WorkbenchContrib}})}async runWithContext(s,e){const t=s.get(M),o=S(t.activeEditorPane);if(!o)return;o.getContribution(a.id).deleteLeft()}}let f=class extends R{constructor(e,t){super();this._editorService=e;this.configurationService=t;if(!this.configurationService.getValue("notebook.multiSelect.enabled"))return;const o=10005;this._register(F.addImplementation(o,"notebook-multicursor-undo-redo",()=>{const i=S(this._editorService.activeEditorPane);return!i||!i.hasModel()?!1:i.getContribution(a.id).undo()},c.and(c.equals("config.notebook.multiSelect.enabled",!0),g,h.IsNotebookMultiSelect))),this._register(U.addImplementation(o,"notebook-multicursor-undo-redo",()=>{const i=S(this._editorService.activeEditorPane);return!i||!i.hasModel()?!1:i.getContribution(a.id).redo()},c.and(c.equals("config.notebook.multiSelect.enabled",!0),g,h.IsNotebookMultiSelect)))}static ID="workbench.contrib.notebook.multiCursorUndoRedo"};f=E([u(0,M),u(1,L)],f),ne(a.id,a),k(ae),k(de),k(ue),oe(f.ID,f,ie.BlockRestore);export{h as NOTEBOOK_MULTI_SELECTION_CONTEXT,a as NotebookMultiCursorController};
