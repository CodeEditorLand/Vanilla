var D=Object.defineProperty;var y=Object.getOwnPropertyDescriptor;var C=(a,s,e,t)=>{for(var o=t>1?void 0:t?y(s,e):s,i=a.length-1,r;i>=0;i--)(r=a[i])&&(o=(t?r(s,e,o):r(o))||o);return t&&o&&D(s,e,o),o},d=(a,s)=>(e,t)=>s(e,t,a);import{Emitter as A}from"../../../../../../../vs/base/common/event.js";import{KeyCode as f,KeyMod as N}from"../../../../../../../vs/base/common/keyCodes.js";import{Disposable as T,DisposableStore as p}from"../../../../../../../vs/base/common/lifecycle.js";import{ResourceMap as L}from"../../../../../../../vs/base/common/map.js";import{EditorConfiguration as P}from"../../../../../../../vs/editor/browser/config/editorConfiguration.js";import"../../../../../../../vs/editor/browser/editorBrowser.js";import{CodeEditorWidget as g}from"../../../../../../../vs/editor/browser/widget/codeEditor/codeEditorWidget.js";import"../../../../../../../vs/editor/common/config/editorConfiguration.js";import"../../../../../../../vs/editor/common/core/position.js";import"../../../../../../../vs/editor/common/core/range.js";import{Selection as h,SelectionDirection as m}from"../../../../../../../vs/editor/common/core/selection.js";import{USUAL_WORD_SEPARATORS as V}from"../../../../../../../vs/editor/common/core/wordHelper.js";import{CursorsController as R}from"../../../../../../../vs/editor/common/cursor/cursor.js";import{CursorConfiguration as O}from"../../../../../../../vs/editor/common/cursorCommon.js";import{CursorChangeReason as _}from"../../../../../../../vs/editor/common/cursorEvents.js";import{ILanguageConfigurationService as W}from"../../../../../../../vs/editor/common/languages/languageConfigurationRegistry.js";import"../../../../../../../vs/editor/common/model.js";import{indentOfLine as B}from"../../../../../../../vs/editor/common/model/textModel.js";import{ITextModelService as K}from"../../../../../../../vs/editor/common/services/resolverService.js";import"../../../../../../../vs/editor/common/viewModel.js";import{ViewModelEventsCollector as b}from"../../../../../../../vs/editor/common/viewModelEventDispatcher.js";import{localize as M}from"../../../../../../../vs/nls.js";import{IAccessibilityService as F}from"../../../../../../../vs/platform/accessibility/common/accessibility.js";import{MenuId as z,registerAction2 as S}from"../../../../../../../vs/platform/actions/common/actions.js";import{IConfigurationService as U}from"../../../../../../../vs/platform/configuration/common/configuration.js";import{ContextKeyExpr as u,IContextKeyService as H,RawContextKey as q}from"../../../../../../../vs/platform/contextkey/common/contextkey.js";import"../../../../../../../vs/platform/instantiation/common/instantiation.js";import{KeybindingWeight as v}from"../../../../../../../vs/platform/keybinding/common/keybindingsRegistry.js";import{NotebookAction as E}from"../../../../../../../vs/workbench/contrib/notebook/browser/controller/coreActions.js";import{getNotebookEditorFromEditorPane as I}from"../../../../../../../vs/workbench/contrib/notebook/browser/notebookBrowser.js";import{registerNotebookContribution as j}from"../../../../../../../vs/workbench/contrib/notebook/browser/notebookEditorExtensions.js";import{CellEditorOptions as X}from"../../../../../../../vs/workbench/contrib/notebook/browser/view/cellParts/cellEditorOptions.js";import{NOTEBOOK_CELL_EDITOR_FOCUSED as Z,NOTEBOOK_IS_ACTIVE_EDITOR as w}from"../../../../../../../vs/workbench/contrib/notebook/common/notebookContextKeys.js";import{IEditorService as k}from"../../../../../../../vs/workbench/services/editor/common/editorService.js";const G="notebook.addFindMatchToSelection",x={IsNotebookMultiSelect:new q("isNotebookMultiSelect",!1)};var J=(t=>(t[t.Idle=0]="Idle",t[t.Selecting=1]="Selecting",t[t.Editing=2]="Editing",t))(J||{});let c=class extends T{constructor(e,t,o,i,r,n){super();this.notebookEditor=e;this.contextKeyService=t;this.textModelService=o;this.languageConfigurationService=i;this.accessibilityService=r;this.configurationService=n;this.configurationService.getValue("notebook.multiSelect.enabled")&&(this.anchorCell=this.notebookEditor.activeCellAndCodeEditor,this._register(this.onDidChangeAnchorCell(()=>{this.updateCursorsControllers(),this.updateAnchorListeners()})))}static id="notebook.multiCursorController";state=0;word="";trackedMatches=[];_onDidChangeAnchorCell=this._register(new A);onDidChangeAnchorCell=this._onDidChangeAnchorCell.event;anchorCell;anchorDisposables=this._register(new p);cursorsDisposables=this._register(new p);cursorsControllers=new L;_nbIsMultiSelectSession=x.IsNotebookMultiSelect.bindTo(this.contextKeyService);updateCursorsControllers(){this.cursorsDisposables.clear(),this.trackedMatches.forEach(async e=>{if(e.cellViewModel.handle===this.anchorCell?.[0].handle)return;const o=(await this.textModelService.createModelReference(e.cellViewModel.uri)).object.textEditorModel;if(!o)return;const i=e.config,r=this.constructCoordinatesConverter(),n=this.constructCursorSimpleModel(e.cellViewModel),l=this.cursorsDisposables.add(new R(o,n,r,new O(o.getLanguageId(),o.getOptions(),i,this.languageConfigurationService)));l.setSelections(new b,void 0,e.selections,_.Explicit),this.cursorsControllers.set(e.cellViewModel.uri,l)})}constructCoordinatesConverter(){return{convertViewPositionToModelPosition(e){return e},convertViewRangeToModelRange(e){return e},validateViewPosition(e,t){return e},validateViewRange(e,t){return e},convertModelPositionToViewPosition(e,t,o,i){return e},convertModelRangeToViewRange(e,t){return e},modelPositionIsVisible(e){return!0},getModelLineViewLineCount(e){return 1},getViewLineNumberOfModelPosition(e,t){return e}}}constructCursorSimpleModel(e){return{getLineCount(){return e.textBuffer.getLineCount()},getLineContent(t){return e.textBuffer.getLineContent(t)},getLineMinColumn(t){return e.textBuffer.getLineMinColumn(t)},getLineMaxColumn(t){return e.textBuffer.getLineMaxColumn(t)},getLineFirstNonWhitespaceColumn(t){return e.textBuffer.getLineFirstNonWhitespaceColumn(t)},getLineLastNonWhitespaceColumn(t){return e.textBuffer.getLineLastNonWhitespaceColumn(t)},normalizePosition(t,o){return t},getLineIndentColumn(t){return B(e.textBuffer.getLineContent(t))+1}}}updateAnchorListeners(){if(this.anchorDisposables.clear(),!this.anchorCell)throw new Error("Anchor cell is undefined");this.anchorDisposables.add(this.anchorCell[1].onWillType(e=>{this.state=2,this.cursorsControllers.forEach(t=>{t.type(new b,e,"keyboard")})})),this.anchorDisposables.add(this.anchorCell[1].onDidType(()=>{this.state=0,this.updateLazyDecorations()})),this.anchorDisposables.add(this.anchorCell[1].onDidChangeCursorSelection(e=>{(e.source==="mouse"||e.source==="deleteLeft"||e.source==="deleteRight")&&this.resetToIdleState()})),this.anchorDisposables.add(this.anchorCell[1].onDidBlurEditorWidget(()=>{(this.state===2||this.state===1)&&this.resetToIdleState()}))}resetToIdleState(){this.state=0,this._nbIsMultiSelectSession.set(!1),this.trackedMatches.forEach(e=>{this.clearDecorations(e)}),this.trackedMatches[0].cellViewModel.setSelections([this.trackedMatches[0].selections[0]]),this.anchorDisposables.clear(),this.cursorsDisposables.clear(),this.cursorsControllers.clear(),this.trackedMatches=[]}async findAndTrackNextSelection(e){if(this.state===0){const t=e.textModel;if(!t)return;const o=e.getSelections()[0],i=this.getWord(o,t);if(!i)return;this.word=i.word;const r=new h(o.startLineNumber,i.startColumn,o.startLineNumber,i.endColumn);if(e.setSelections([r]),this.anchorCell=this.notebookEditor.activeCellAndCodeEditor,!this.anchorCell||this.anchorCell[0].handle!==e.handle)throw new Error("Active cell is not the same as the cell passed as context");if(!(this.anchorCell[1]instanceof g))throw new Error("Active cell is not an instance of CodeEditorWidget");this.trackedMatches=[];const n=this.constructCellEditorOptions(this.anchorCell[0]),l={cellViewModel:e,selections:[r],config:n,decorationIds:[]};this.trackedMatches.push(l),this.initializeMultiSelectDecorations(l),this._nbIsMultiSelectSession.set(!0),this.state=1,this._onDidChangeAnchorCell.fire()}else if(this.state===1){const t=this.notebookEditor.textModel;if(!t)return;const o=this.notebookEditor.getCellIndex(e);if(o===void 0)return;const i=t.findNextMatch(this.word,{cellIndex:o,position:e.getSelections()[e.getSelections().length-1].getEndPosition()},!1,!0,V);if(!i)return;const r=this.notebookEditor.getCellByHandle(i.cell.handle);if(!r)return;let n;if(i.cell.handle!==e.handle){await this.notebookEditor.revealRangeInViewAsync(r,i.match.range),this.notebookEditor.focusNotebookCell(r,"editor");const l=h.fromRange(i.match.range,m.LTR);if(r.setSelections([l]),this.anchorCell=this.notebookEditor.activeCellAndCodeEditor,!this.anchorCell||!(this.anchorCell[1]instanceof g))throw new Error("Active cell is not an instance of CodeEditorWidget");n={cellViewModel:r,selections:[l],config:this.constructCellEditorOptions(this.anchorCell[0]),decorationIds:[]},this.trackedMatches.push(n),this._onDidChangeAnchorCell.fire()}else n=this.trackedMatches.find(l=>l.cellViewModel.handle===i.cell.handle),n.selections.push(h.fromRange(i.match.range,m.LTR)),r.setSelections(n.selections);this.initializeMultiSelectDecorations(n)}}constructCellEditorOptions(e){const o=new X(this.notebookEditor.getBaseCellEditorOptions(e.language),this.notebookEditor.notebookOptions,this.configurationService).getUpdatedValue(e.internalMetadata,e.uri);return new P(!1,z.EditorContent,o,null,this.accessibilityService)}initializeMultiSelectDecorations(e){const t=[];e.selections.forEach(o=>{t.push({range:o,options:{description:"",className:"nb-multicursor-selection"}})}),e.decorationIds=e.cellViewModel.deltaModelDecorations(e.decorationIds,t)}updateLazyDecorations(){this.trackedMatches.forEach(e=>{if(this.notebookEditor.getCellIndex(e.cellViewModel)===void 0)return;let o;const i=this.cursorsControllers.get(e.cellViewModel.uri);i?o=i.getSelections():o=this.notebookEditor.activeCodeEditor?.getSelections();const r=o?.map(n=>({range:n,options:{description:"",className:"nb-multicursor-selection"}}));e.decorationIds=e.cellViewModel.deltaModelDecorations(e.decorationIds,r??[])})}clearDecorations(e){e.decorationIds=e.cellViewModel.deltaModelDecorations(e.decorationIds,[])}getWord(e,t){const o=e.startLineNumber,i=e.startColumn;return t.isDisposed()?null:t.getWordAtPosition({lineNumber:o,column:i})}dispose(){super.dispose(),this.anchorDisposables.dispose(),this.cursorsDisposables.dispose(),this.trackedMatches.forEach(e=>{this.clearDecorations(e)}),this.trackedMatches=[]}};c=C([d(1,H),d(2,K),d(3,W),d(4,F),d(5,U)],c);class Q extends E{constructor(){super({id:G,title:M("addFindMatchToSelection","Add Find Match to Selection"),keybinding:{when:u.and(u.equals("config.notebook.multiSelect.enabled",!0),w,Z),primary:N.CtrlCmd|f.KeyD,weight:v.WorkbenchContrib}})}async runWithContext(s,e){const t=s.get(k),o=I(t.activeEditorPane);if(!o||!e.cell)return;o.getContribution(c.id).findAndTrackNextSelection(e.cell)}}class Y extends E{constructor(){super({id:"noteMultiCursor.exit",title:M("exitMultiSelection","Exit Multi Cursor Mode"),keybinding:{when:u.and(u.equals("config.notebook.multiSelect.enabled",!0),w,x.IsNotebookMultiSelect),primary:f.Escape,weight:v.WorkbenchContrib}})}async runWithContext(s,e){const t=s.get(k),o=I(t.activeEditorPane);if(!o)return;o.getContribution(c.id).resetToIdleState()}}j(c.id,c),S(Q),S(Y);export{x as NOTEBOOK_MULTI_SELECTION_CONTEXT,c as NotebookMultiCursorController};
