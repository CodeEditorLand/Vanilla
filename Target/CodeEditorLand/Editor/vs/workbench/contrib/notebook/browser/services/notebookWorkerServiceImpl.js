var _=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var k=(s,i,e,o)=>{for(var r=o>1?void 0:o?b(i,e):i,a=s.length-1,l;a>=0;a--)(l=s[a])&&(r=(o?l(i,e,r):l(r))||r);return o&&r&&_(i,e,r),r},h=(s,i)=>(e,o)=>i(e,o,s);import{createWebWorker as M}from"../../../../../../vs/base/browser/defaultWorkerFactory.js";import{Disposable as c,DisposableStore as I,dispose as v,toDisposable as S}from"../../../../../../vs/base/common/lifecycle.js";import"../../../../../../vs/base/common/uri.js";import"../../../../../../vs/base/common/worker/simpleWorker.js";import"../../../../../../vs/workbench/contrib/notebook/common/model/notebookCellTextModel.js";import{NotebookCellsChangeType as m}from"../../../../../../vs/workbench/contrib/notebook/common/notebookCommon.js";import{INotebookService as y}from"../../../../../../vs/workbench/contrib/notebook/common/notebookService.js";import"../../../../../../vs/workbench/contrib/notebook/common/services/notebookSimpleWorker.js";import"../../../../../../vs/workbench/contrib/notebook/common/services/notebookWorkerService.js";let p=class extends c{_workerManager;constructor(i){super(),this._workerManager=this._register(new f(i))}canComputeDiff(i,e){throw new Error("Method not implemented.")}computeDiff(i,e){return this._workerManager.withWorker().then(o=>o.computeDiff(i,e))}canPromptRecommendation(i){return this._workerManager.withWorker().then(e=>e.canPromptRecommendation(i))}};p=k([h(0,y)],p);class f extends c{constructor(e){super();this._notebookService=e;this._editorWorkerClient=null}_editorWorkerClient;withWorker(){return this._editorWorkerClient||(this._editorWorkerClient=new C(this._notebookService)),Promise.resolve(this._editorWorkerClient)}}class x extends c{constructor(e,o){super();this._proxy=e;this._notebookService=o}_syncedModels=Object.create(null);_syncedModelsLastUsedTime=Object.create(null);ensureSyncedResources(e){for(const o of e){const r=o.toString();this._syncedModels[r]||this._beginModelSync(o),this._syncedModels[r]&&(this._syncedModelsLastUsedTime[r]=new Date().getTime())}}_beginModelSync(e){const o=this._notebookService.listNotebookDocuments().find(t=>t.uri.toString()===e.toString());if(!o)return;const r=e.toString();this._proxy.$acceptNewModel(o.uri.toString(),{cells:o.cells.map(t=>({handle:t.handle,uri:t.uri,source:t.getValue(),eol:t.textBuffer.getEOL(),language:t.language,mime:t.mime,cellKind:t.cellKind,outputs:t.outputs.map(d=>({outputId:d.outputId,outputs:d.outputs})),metadata:t.metadata,internalMetadata:t.internalMetadata})),metadata:o.metadata});const a=new I,l=t=>({handle:t.handle,uri:t.uri,source:t.textBuffer.getLinesContent(),eol:t.textBuffer.getEOL(),language:t.language,cellKind:t.cellKind,outputs:t.outputs.map(d=>({outputId:d.outputId,outputs:d.outputs})),metadata:t.metadata,internalMetadata:t.internalMetadata});a.add(o.onDidChangeContent(t=>{const d=t.rawEvents.map(n=>n.kind===m.ModelChange||n.kind===m.Initialize?{kind:n.kind,versionId:t.versionId,changes:n.changes.map(u=>[u[0],u[1],u[2].map(g=>l(g))])}:n.kind===m.Move?{kind:n.kind,index:n.index,length:n.length,newIdx:n.newIdx,versionId:t.versionId,cells:n.cells.map(u=>l(u))}:n);this._proxy.$acceptModelChanged(r.toString(),{rawEvents:d,versionId:t.versionId})})),a.add(o.onWillDispose(()=>{this._stopModelSync(r)})),a.add(S(()=>{this._proxy.$acceptRemovedModel(r)})),this._syncedModels[r]=a}_stopModelSync(e){const o=this._syncedModels[e];delete this._syncedModels[e],delete this._syncedModelsLastUsedTime[e],v(o)}}class C extends c{constructor(e){super();this._notebookService=e;this._worker=null,this._modelManager=null}_worker;_modelManager;computeDiff(e,o){return this._ensureSyncedResources([e,o]).$computeDiff(e.toString(),o.toString())}canPromptRecommendation(e){return this._ensureSyncedResources([e]).$canPromptRecommendation(e.toString())}_getOrCreateModelManager(e){return this._modelManager||(this._modelManager=this._register(new x(e,this._notebookService))),this._modelManager}_ensureSyncedResources(e){const o=this._getOrCreateWorker().proxy;return this._getOrCreateModelManager(o).ensureSyncedResources(e),o}_getOrCreateWorker(){if(!this._worker)try{this._worker=this._register(M("vs/workbench/contrib/notebook/common/services/notebookSimpleWorker","NotebookEditorWorker"))}catch(e){throw e}return this._worker}}export{p as NotebookEditorWorkerServiceImpl};
