{
  "version": 3,
  "sources": ["../../../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/contrib/notebook/browser/view/cellParts/cellComments.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { coalesce } from '../../../../../../base/common/arrays.js';\nimport { DisposableStore, MutableDisposable } from '../../../../../../base/common/lifecycle.js';\nimport { EDITOR_FONT_DEFAULTS, IEditorOptions } from '../../../../../../editor/common/config/editorOptions.js';\nimport * as languages from '../../../../../../editor/common/languages.js';\nimport { IConfigurationService } from '../../../../../../platform/configuration/common/configuration.js';\nimport { IContextKeyService } from '../../../../../../platform/contextkey/common/contextkey.js';\nimport { IInstantiationService } from '../../../../../../platform/instantiation/common/instantiation.js';\nimport { IThemeService } from '../../../../../../platform/theme/common/themeService.js';\nimport { ICommentService } from '../../../../comments/browser/commentService.js';\nimport { CommentThreadWidget } from '../../../../comments/browser/commentThreadWidget.js';\nimport { ICellViewModel, INotebookEditorDelegate } from '../../notebookBrowser.js';\nimport { CellContentPart } from '../cellPart.js';\nimport { ICellRange } from '../../../common/notebookRange.js';\n\nexport class CellComments extends CellContentPart {\n\tprivate readonly _commentThreadWidget: MutableDisposable<CommentThreadWidget<ICellRange>>;\n\tprivate currentElement: ICellViewModel | undefined;\n\tprivate readonly _commentThreadDisposables = this._register(new DisposableStore());\n\n\tconstructor(\n\t\tprivate readonly notebookEditor: INotebookEditorDelegate,\n\t\tprivate readonly container: HTMLElement,\n\t\t@IContextKeyService private readonly contextKeyService: IContextKeyService,\n\t\t@IThemeService private readonly themeService: IThemeService,\n\t\t@ICommentService private readonly commentService: ICommentService,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService,\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService\n\t) {\n\t\tsuper();\n\t\tthis.container.classList.add('review-widget');\n\n\t\tthis._register(this._commentThreadWidget = new MutableDisposable<CommentThreadWidget<ICellRange>>());\n\n\t\tthis._register(this.themeService.onDidColorThemeChange(this._applyTheme, this));\n\t\t// TODO @rebornix onDidChangeLayout (font change)\n\t\t// this._register(this.notebookEditor.onDidchangeLa)\n\t\tthis._applyTheme();\n\t}\n\n\tprivate async initialize(element: ICellViewModel) {\n\t\tif (this.currentElement === element) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.currentElement = element;\n\t\tawait this._updateThread();\n\t}\n\n\tprivate async _createCommentTheadWidget(owner: string, commentThread: languages.CommentThread<ICellRange>) {\n\t\tthis._commentThreadDisposables.clear();\n\t\tthis._commentThreadWidget.value = this.instantiationService.createInstance(\n\t\t\tCommentThreadWidget,\n\t\t\tthis.container,\n\t\t\tthis.notebookEditor,\n\t\t\towner,\n\t\t\tthis.notebookEditor.textModel!.uri,\n\t\t\tthis.contextKeyService,\n\t\t\tthis.instantiationService,\n\t\t\tcommentThread,\n\t\t\tundefined,\n\t\t\tundefined,\n\t\t\t{\n\t\t\t\tcodeBlockFontFamily: this.configurationService.getValue<IEditorOptions>('editor').fontFamily || EDITOR_FONT_DEFAULTS.fontFamily\n\t\t\t},\n\t\t\tundefined,\n\t\t\t{\n\t\t\t\tactionRunner: () => {\n\t\t\t\t},\n\t\t\t\tcollapse: () => { }\n\t\t\t}\n\t\t) as unknown as CommentThreadWidget<ICellRange>;\n\n\t\tconst layoutInfo = this.notebookEditor.getLayoutInfo();\n\n\t\tawait this._commentThreadWidget.value.display(layoutInfo.fontInfo.lineHeight, true);\n\t\tthis._applyTheme();\n\n\t\tthis._commentThreadDisposables.add(this._commentThreadWidget.value.onDidResize(() => {\n\t\t\tif (this.currentElement && this._commentThreadWidget.value) {\n\t\t\t\tthis.currentElement.commentHeight = this._calculateCommentThreadHeight(this._commentThreadWidget.value.getDimensions().height);\n\t\t\t}\n\t\t}));\n\t}\n\n\tprivate _bindListeners() {\n\t\tthis.cellDisposables.add(this.commentService.onDidUpdateCommentThreads(async () => this._updateThread()));\n\t}\n\n\tprivate async _updateThread() {\n\t\tif (!this.currentElement) {\n\t\t\treturn;\n\t\t}\n\t\tconst info = await this._getCommentThreadForCell(this.currentElement);\n\t\tif (!this._commentThreadWidget.value && info) {\n\t\t\tawait this._createCommentTheadWidget(info.owner, info.thread);\n\t\t\tthis.container.style.top = `${this.currentElement.layoutInfo.commentOffset}px`;\n\t\t\tthis.currentElement.commentHeight = this._calculateCommentThreadHeight(this._commentThreadWidget.value!.getDimensions().height);\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._commentThreadWidget.value) {\n\t\t\tif (!info) {\n\t\t\t\tthis._commentThreadDisposables.clear();\n\t\t\t\tthis._commentThreadWidget.value = undefined;\n\t\t\t\tthis.currentElement.commentHeight = 0;\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tawait this._commentThreadWidget.value.updateCommentThread(info.thread);\n\t\t\tthis.currentElement.commentHeight = this._calculateCommentThreadHeight(this._commentThreadWidget.value.getDimensions().height);\n\t\t}\n\t}\n\n\tprivate _calculateCommentThreadHeight(bodyHeight: number) {\n\t\tconst layoutInfo = this.notebookEditor.getLayoutInfo();\n\n\t\tconst headHeight = Math.ceil(layoutInfo.fontInfo.lineHeight * 1.2);\n\t\tconst lineHeight = layoutInfo.fontInfo.lineHeight;\n\t\tconst arrowHeight = Math.round(lineHeight / 3);\n\t\tconst frameThickness = Math.round(lineHeight / 9) * 2;\n\n\t\tconst computedHeight = headHeight + bodyHeight + arrowHeight + frameThickness + 8 /** margin bottom to avoid margin collapse */;\n\t\treturn computedHeight;\n\n\t}\n\n\tprivate async _getCommentThreadForCell(element: ICellViewModel): Promise<{ thread: languages.CommentThread<ICellRange>; owner: string } | null> {\n\t\tif (this.notebookEditor.hasModel()) {\n\t\t\tconst commentInfos = coalesce(await this.commentService.getNotebookComments(element.uri));\n\t\t\tfor (const commentInfo of commentInfos) {\n\t\t\t\tfor (const thread of commentInfo.threads) {\n\t\t\t\t\t// For now, only one thread per cell is supported.\n\t\t\t\t\treturn { owner: commentInfo.uniqueOwner, thread };\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tprivate _applyTheme() {\n\t\tconst theme = this.themeService.getColorTheme();\n\t\tconst fontInfo = this.notebookEditor.getLayoutInfo().fontInfo;\n\t\tthis._commentThreadWidget.value?.applyTheme(theme, fontInfo);\n\t}\n\n\toverride didRenderCell(element: ICellViewModel): void {\n\t\tthis.initialize(element);\n\t\tthis._bindListeners();\n\t}\n\n\toverride prepareLayout(): void {\n\t\tif (this.currentElement && this._commentThreadWidget.value) {\n\t\t\tthis.currentElement.commentHeight = this._calculateCommentThreadHeight(this._commentThreadWidget.value.getDimensions().height);\n\t\t}\n\t}\n\n\toverride updateInternalLayoutNow(element: ICellViewModel): void {\n\t\tif (this.currentElement && this._commentThreadWidget.value) {\n\t\t\tthis.container.style.top = `${element.layoutInfo.commentOffset}px`;\n\t\t}\n\t}\n}\n\n"],
  "mappings": "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",
  "names": []
}
