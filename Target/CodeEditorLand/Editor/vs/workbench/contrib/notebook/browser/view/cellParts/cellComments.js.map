{
  "version": 3,
  "sources": ["../../../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/contrib/notebook/browser/view/cellParts/cellComments.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { coalesce } from \"../../../../../../base/common/arrays.js\";\nimport {\n\tDisposableStore,\n\tMutableDisposable,\n} from \"../../../../../../base/common/lifecycle.js\";\nimport {\n\tEDITOR_FONT_DEFAULTS,\n\ttype IEditorOptions,\n} from \"../../../../../../editor/common/config/editorOptions.js\";\nimport type * as languages from \"../../../../../../editor/common/languages.js\";\nimport { IConfigurationService } from \"../../../../../../platform/configuration/common/configuration.js\";\nimport { IContextKeyService } from \"../../../../../../platform/contextkey/common/contextkey.js\";\nimport { IInstantiationService } from \"../../../../../../platform/instantiation/common/instantiation.js\";\nimport { IThemeService } from \"../../../../../../platform/theme/common/themeService.js\";\nimport { ICommentService } from \"../../../../comments/browser/commentService.js\";\nimport { CommentThreadWidget } from \"../../../../comments/browser/commentThreadWidget.js\";\nimport type { ICellRange } from \"../../../common/notebookRange.js\";\nimport type {\n\tICellViewModel,\n\tINotebookEditorDelegate,\n} from \"../../notebookBrowser.js\";\nimport { CellContentPart } from \"../cellPart.js\";\n\nexport class CellComments extends CellContentPart {\n\tprivate readonly _commentThreadWidget: MutableDisposable<\n\t\tCommentThreadWidget<ICellRange>\n\t>;\n\tprivate currentElement: ICellViewModel | undefined;\n\tprivate readonly _commentThreadDisposables = this._register(\n\t\tnew DisposableStore(),\n\t);\n\n\tconstructor(\n\t\tprivate readonly notebookEditor: INotebookEditorDelegate,\n\t\tprivate readonly container: HTMLElement,\n\t\t@IContextKeyService private readonly contextKeyService: IContextKeyService,\n\t\t@IThemeService private readonly themeService: IThemeService,\n\t\t@ICommentService private readonly commentService: ICommentService,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService,\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService\n\t) {\n\t\tsuper();\n\t\tthis.container.classList.add('review-widget');\n\n\t\tthis._register(this._commentThreadWidget = new MutableDisposable<CommentThreadWidget<ICellRange>>());\n\n\t\tthis._register(this.themeService.onDidColorThemeChange(this._applyTheme, this));\n\t\t// TODO @rebornix onDidChangeLayout (font change)\n\t\t// this._register(this.notebookEditor.onDidchangeLa)\n\t\tthis._applyTheme();\n\t}\n\n\tprivate async initialize(element: ICellViewModel) {\n\t\tif (this.currentElement === element) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.currentElement = element;\n\t\tawait this._updateThread();\n\t}\n\n\tprivate async _createCommentTheadWidget(\n\t\towner: string,\n\t\tcommentThread: languages.CommentThread<ICellRange>,\n\t) {\n\t\tthis._commentThreadDisposables.clear();\n\t\tthis._commentThreadWidget.value =\n\t\t\tthis.instantiationService.createInstance(\n\t\t\t\tCommentThreadWidget,\n\t\t\t\tthis.container,\n\t\t\t\tthis.notebookEditor,\n\t\t\t\towner,\n\t\t\t\tthis.notebookEditor.textModel!.uri,\n\t\t\t\tthis.contextKeyService,\n\t\t\t\tthis.instantiationService,\n\t\t\t\tcommentThread,\n\t\t\t\tundefined,\n\t\t\t\tundefined,\n\t\t\t\t{\n\t\t\t\t\tcodeBlockFontFamily:\n\t\t\t\t\t\tthis.configurationService.getValue<IEditorOptions>(\n\t\t\t\t\t\t\t\"editor\",\n\t\t\t\t\t\t).fontFamily || EDITOR_FONT_DEFAULTS.fontFamily,\n\t\t\t\t},\n\t\t\t\tundefined,\n\t\t\t\t{\n\t\t\t\t\tactionRunner: () => {},\n\t\t\t\t\tcollapse: () => {},\n\t\t\t\t},\n\t\t\t) as unknown as CommentThreadWidget<ICellRange>;\n\n\t\tconst layoutInfo = this.notebookEditor.getLayoutInfo();\n\n\t\tawait this._commentThreadWidget.value.display(\n\t\t\tlayoutInfo.fontInfo.lineHeight,\n\t\t\ttrue,\n\t\t);\n\t\tthis._applyTheme();\n\n\t\tthis._commentThreadDisposables.add(\n\t\t\tthis._commentThreadWidget.value.onDidResize(() => {\n\t\t\t\tif (this.currentElement && this._commentThreadWidget.value) {\n\t\t\t\t\tthis.currentElement.commentHeight =\n\t\t\t\t\t\tthis._calculateCommentThreadHeight(\n\t\t\t\t\t\t\tthis._commentThreadWidget.value.getDimensions()\n\t\t\t\t\t\t\t\t.height,\n\t\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}),\n\t\t);\n\t}\n\n\tprivate _bindListeners() {\n\t\tthis.cellDisposables.add(\n\t\t\tthis.commentService.onDidUpdateCommentThreads(async () =>\n\t\t\t\tthis._updateThread(),\n\t\t\t),\n\t\t);\n\t}\n\n\tprivate async _updateThread() {\n\t\tif (!this.currentElement) {\n\t\t\treturn;\n\t\t}\n\t\tconst info = await this._getCommentThreadForCell(this.currentElement);\n\t\tif (!this._commentThreadWidget.value && info) {\n\t\t\tawait this._createCommentTheadWidget(info.owner, info.thread);\n\t\t\tthis.container.style.top = `${this.currentElement.layoutInfo.commentOffset}px`;\n\t\t\tthis.currentElement.commentHeight =\n\t\t\t\tthis._calculateCommentThreadHeight(\n\t\t\t\t\tthis._commentThreadWidget.value!.getDimensions().height,\n\t\t\t\t);\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._commentThreadWidget.value) {\n\t\t\tif (!info) {\n\t\t\t\tthis._commentThreadDisposables.clear();\n\t\t\t\tthis._commentThreadWidget.value = undefined;\n\t\t\t\tthis.currentElement.commentHeight = 0;\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tawait this._commentThreadWidget.value.updateCommentThread(\n\t\t\t\tinfo.thread,\n\t\t\t);\n\t\t\tthis.currentElement.commentHeight =\n\t\t\t\tthis._calculateCommentThreadHeight(\n\t\t\t\t\tthis._commentThreadWidget.value.getDimensions().height,\n\t\t\t\t);\n\t\t}\n\t}\n\n\tprivate _calculateCommentThreadHeight(bodyHeight: number) {\n\t\tconst layoutInfo = this.notebookEditor.getLayoutInfo();\n\n\t\tconst headHeight = Math.ceil(layoutInfo.fontInfo.lineHeight * 1.2);\n\t\tconst lineHeight = layoutInfo.fontInfo.lineHeight;\n\t\tconst arrowHeight = Math.round(lineHeight / 3);\n\t\tconst frameThickness = Math.round(lineHeight / 9) * 2;\n\n\t\tconst computedHeight =\n\t\t\theadHeight +\n\t\t\tbodyHeight +\n\t\t\tarrowHeight +\n\t\t\tframeThickness +\n\t\t\t8 /** margin bottom to avoid margin collapse */;\n\t\treturn computedHeight;\n\t}\n\n\tprivate async _getCommentThreadForCell(\n\t\telement: ICellViewModel,\n\t): Promise<{\n\t\tthread: languages.CommentThread<ICellRange>;\n\t\towner: string;\n\t} | null> {\n\t\tif (this.notebookEditor.hasModel()) {\n\t\t\tconst commentInfos = coalesce(\n\t\t\t\tawait this.commentService.getNotebookComments(element.uri),\n\t\t\t);\n\t\t\tfor (const commentInfo of commentInfos) {\n\t\t\t\tfor (const thread of commentInfo.threads) {\n\t\t\t\t\t// For now, only one thread per cell is supported.\n\t\t\t\t\treturn { owner: commentInfo.uniqueOwner, thread };\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tprivate _applyTheme() {\n\t\tconst theme = this.themeService.getColorTheme();\n\t\tconst fontInfo = this.notebookEditor.getLayoutInfo().fontInfo;\n\t\tthis._commentThreadWidget.value?.applyTheme(theme, fontInfo);\n\t}\n\n\toverride didRenderCell(element: ICellViewModel): void {\n\t\tthis.initialize(element);\n\t\tthis._bindListeners();\n\t}\n\n\toverride prepareLayout(): void {\n\t\tif (this.currentElement && this._commentThreadWidget.value) {\n\t\t\tthis.currentElement.commentHeight =\n\t\t\t\tthis._calculateCommentThreadHeight(\n\t\t\t\t\tthis._commentThreadWidget.value.getDimensions().height,\n\t\t\t\t);\n\t\t}\n\t}\n\n\toverride updateInternalLayoutNow(element: ICellViewModel): void {\n\t\tif (this.currentElement && this._commentThreadWidget.value) {\n\t\t\tthis.container.style.top = `${element.layoutInfo.commentOffset}px`;\n\t\t}\n\t}\n}\n"],
  "mappings": "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",
  "names": []
}
