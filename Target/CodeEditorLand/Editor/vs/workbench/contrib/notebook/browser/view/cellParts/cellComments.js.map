{
  "version": 3,
  "sources": ["../../../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/contrib/notebook/browser/view/cellParts/cellComments.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { coalesce } from \"../../../../../../base/common/arrays.js\";\nimport {\n\tDisposableMap,\n\tDisposableStore,\n} from \"../../../../../../base/common/lifecycle.js\";\nimport {\n\tEDITOR_FONT_DEFAULTS,\n\ttype IEditorOptions,\n} from \"../../../../../../editor/common/config/editorOptions.js\";\nimport type * as languages from \"../../../../../../editor/common/languages.js\";\nimport { IConfigurationService } from \"../../../../../../platform/configuration/common/configuration.js\";\nimport { IContextKeyService } from \"../../../../../../platform/contextkey/common/contextkey.js\";\nimport { IInstantiationService } from \"../../../../../../platform/instantiation/common/instantiation.js\";\nimport { IThemeService } from \"../../../../../../platform/theme/common/themeService.js\";\nimport {\n\tICommentService,\n\ttype INotebookCommentInfo,\n} from \"../../../../comments/browser/commentService.js\";\nimport { CommentThreadWidget } from \"../../../../comments/browser/commentThreadWidget.js\";\nimport type { ICellRange } from \"../../../common/notebookRange.js\";\nimport type {\n\tICellViewModel,\n\tINotebookEditorDelegate,\n} from \"../../notebookBrowser.js\";\nimport { CellContentPart } from \"../cellPart.js\";\n\nexport class CellComments extends CellContentPart {\n\t// keyed by threadId\n\tprivate readonly _commentThreadWidgets: DisposableMap<\n\t\tstring,\n\t\t{ widget: CommentThreadWidget<ICellRange>; dispose: () => void }\n\t>;\n\tprivate currentElement: ICellViewModel | undefined;\n\n\tconstructor(\n\t\tprivate readonly notebookEditor: INotebookEditorDelegate,\n\t\tprivate readonly container: HTMLElement,\n\t\t@IContextKeyService\n\t\tprivate readonly contextKeyService: IContextKeyService,\n\t\t@IThemeService private readonly themeService: IThemeService,\n\t\t@ICommentService private readonly commentService: ICommentService,\n\t\t@IConfigurationService\n\t\tprivate readonly configurationService: IConfigurationService,\n\t\t@IInstantiationService\n\t\tprivate readonly instantiationService: IInstantiationService,\n\t) {\n\t\tsuper();\n\t\tthis.container.classList.add(\"review-widget\");\n\n\t\tthis._register(this._commentThreadWidgets = new DisposableMap<string, { widget: CommentThreadWidget<ICellRange>; dispose: () => void }>());\n\n\t\tthis._register(\n\t\t\tthis.themeService.onDidColorThemeChange(this._applyTheme, this),\n\t\t);\n\t\t// TODO @rebornix onDidChangeLayout (font change)\n\t\t// this._register(this.notebookEditor.onDidchangeLa)\n\t\tthis._applyTheme();\n\t}\n\n\tprivate async initialize(element: ICellViewModel) {\n\t\tif (this.currentElement === element) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.currentElement = element;\n\t\tawait this._updateThread();\n\t}\n\n\tprivate async _createCommentTheadWidget(\n\t\towner: string,\n\t\tcommentThread: languages.CommentThread<ICellRange>,\n\t) {\n\t\tconst widgetDisposables = new DisposableStore();\n\t\tconst widget = this.instantiationService.createInstance(\n\t\t\tCommentThreadWidget,\n\t\t\tthis.container,\n\t\t\tthis.notebookEditor,\n\t\t\towner,\n\t\t\tthis.notebookEditor.textModel!.uri,\n\t\t\tthis.contextKeyService,\n\t\t\tthis.instantiationService,\n\t\t\tcommentThread,\n\t\t\tundefined,\n\t\t\tundefined,\n\t\t\t{\n\t\t\t\tcodeBlockFontFamily:\n\t\t\t\t\tthis.configurationService.getValue<IEditorOptions>(\"editor\")\n\t\t\t\t\t\t.fontFamily || EDITOR_FONT_DEFAULTS.fontFamily,\n\t\t\t},\n\t\t\tundefined,\n\t\t\t{\n\t\t\t\tactionRunner: () => {},\n\t\t\t\tcollapse: () => {},\n\t\t\t},\n\t\t) as unknown as CommentThreadWidget<ICellRange>;\n\t\twidgetDisposables.add(widget);\n\t\tthis._commentThreadWidgets.set(commentThread.threadId, {\n\t\t\twidget,\n\t\t\tdispose: () => widgetDisposables.dispose(),\n\t\t});\n\n\t\tconst layoutInfo = this.notebookEditor.getLayoutInfo();\n\n\t\tawait widget.display(layoutInfo.fontInfo.lineHeight, true);\n\t\tthis._applyTheme();\n\n\t\twidgetDisposables.add(\n\t\t\twidget.onDidResize(() => {\n\t\t\t\tif (this.currentElement) {\n\t\t\t\t\tthis.currentElement.commentHeight =\n\t\t\t\t\t\tthis._calculateCommentThreadHeight(\n\t\t\t\t\t\t\twidget.getDimensions().height,\n\t\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}),\n\t\t);\n\t}\n\n\tprivate _bindListeners() {\n\t\tthis.cellDisposables.add(\n\t\t\tthis.commentService.onDidUpdateCommentThreads(async () =>\n\t\t\t\tthis._updateThread(),\n\t\t\t),\n\t\t);\n\t}\n\n\tprivate async _updateThread() {\n\t\tif (!this.currentElement) {\n\t\t\treturn;\n\t\t}\n\t\tconst infos = await this._getCommentThreadsForCell(this.currentElement);\n\t\tconst widgetsToDelete = new Set(this._commentThreadWidgets.keys());\n\t\tconst layoutInfo = this.currentElement.layoutInfo;\n\t\tthis.container.style.top = `${layoutInfo.commentOffset}px`;\n\t\tfor (const info of infos) {\n\t\t\tif (!info) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tfor (const thread of info.threads) {\n\t\t\t\twidgetsToDelete.delete(thread.threadId);\n\t\t\t\tconst widget = this._commentThreadWidgets.get(\n\t\t\t\t\tthread.threadId,\n\t\t\t\t)?.widget;\n\t\t\t\tif (widget) {\n\t\t\t\t\tawait widget.updateCommentThread(thread);\n\t\t\t\t} else {\n\t\t\t\t\tawait this._createCommentTheadWidget(\n\t\t\t\t\t\tinfo.uniqueOwner,\n\t\t\t\t\t\tthread,\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tfor (const threadId of widgetsToDelete) {\n\t\t\tthis._commentThreadWidgets.deleteAndDispose(threadId);\n\t\t}\n\t\tthis._updateHeight();\n\t}\n\n\tprivate _calculateCommentThreadHeight(bodyHeight: number) {\n\t\tconst layoutInfo = this.notebookEditor.getLayoutInfo();\n\n\t\tconst headHeight = Math.ceil(layoutInfo.fontInfo.lineHeight * 1.2);\n\t\tconst lineHeight = layoutInfo.fontInfo.lineHeight;\n\t\tconst arrowHeight = Math.round(lineHeight / 3);\n\t\tconst frameThickness = Math.round(lineHeight / 9) * 2;\n\n\t\tconst computedHeight =\n\t\t\theadHeight +\n\t\t\tbodyHeight +\n\t\t\tarrowHeight +\n\t\t\tframeThickness +\n\t\t\t8 /** margin bottom to avoid margin collapse */;\n\t\treturn computedHeight;\n\t}\n\n\tprivate _updateHeight() {\n\t\tif (!this.currentElement) {\n\t\t\treturn;\n\t\t}\n\t\tlet height = 0;\n\t\tfor (const { widget } of this._commentThreadWidgets.values()) {\n\t\t\theight += this._calculateCommentThreadHeight(\n\t\t\t\twidget.getDimensions().height,\n\t\t\t);\n\t\t}\n\t\tthis.currentElement.commentHeight = height;\n\t}\n\n\tprivate async _getCommentThreadsForCell(\n\t\telement: ICellViewModel,\n\t): Promise<(INotebookCommentInfo | null)[]> {\n\t\tif (this.notebookEditor.hasModel()) {\n\t\t\treturn coalesce(\n\t\t\t\tawait this.commentService.getNotebookComments(element.uri),\n\t\t\t);\n\t\t}\n\n\t\treturn [];\n\t}\n\n\tprivate _applyTheme() {\n\t\tconst theme = this.themeService.getColorTheme();\n\t\tconst fontInfo = this.notebookEditor.getLayoutInfo().fontInfo;\n\t\tfor (const { widget } of this._commentThreadWidgets.values()) {\n\t\t\twidget.applyTheme(theme, fontInfo);\n\t\t}\n\t}\n\n\toverride didRenderCell(element: ICellViewModel): void {\n\t\tthis.initialize(element);\n\t\tthis._bindListeners();\n\t}\n\n\toverride prepareLayout(): void {\n\t\tthis._updateHeight();\n\t}\n\n\toverride updateInternalLayoutNow(element: ICellViewModel): void {\n\t\tif (this.currentElement) {\n\t\t\tthis.container.style.top = `${element.layoutInfo.commentOffset}px`;\n\t\t}\n\t}\n}\n"],
  "mappings": ";;;;;;;;;;;;AAKA,SAAS,gBAAgB;AACzB;AAAA,EACC;AAAA,EACA;AAAA,OACM;AACP;AAAA,EACC;AAAA,OAEM;AAEP,SAAS,6BAA6B;AACtC,SAAS,0BAA0B;AACnC,SAAS,6BAA6B;AACtC,SAAS,qBAAqB;AAC9B;AAAA,EACC;AAAA,OAEM;AACP,SAAS,2BAA2B;AAMpC,SAAS,uBAAuB;AAEzB,IAAM,eAAN,cAA2B,gBAAgB;AAAA,EAQjD,YACkB,gBACA,WAEA,mBACe,cACE,gBAEjB,sBAEA,sBAChB;AACD,UAAM;AAXW;AACA;AAEA;AACe;AACE;AAEjB;AAEA;AAGjB,SAAK,UAAU,UAAU,IAAI,eAAe;AAE5C,SAAK,UAAU,KAAK,wBAAwB,IAAI,cAAwF,CAAC;AAEzI,SAAK;AAAA,MACJ,KAAK,aAAa,sBAAsB,KAAK,aAAa,IAAI;AAAA,IAC/D;AAGA,SAAK,YAAY;AAAA,EAClB;AAAA,EA9DD,OA+BkD;AAAA;AAAA;AAAA;AAAA,EAEhC;AAAA,EAIT;AAAA,EA2BR,MAAc,WAAW,SAAyB;AACjD,QAAI,KAAK,mBAAmB,SAAS;AACpC;AAAA,IACD;AAEA,SAAK,iBAAiB;AACtB,UAAM,KAAK,cAAc;AAAA,EAC1B;AAAA,EAEA,MAAc,0BACb,OACA,eACC;AACD,UAAM,oBAAoB,IAAI,gBAAgB;AAC9C,UAAM,SAAS,KAAK,qBAAqB;AAAA,MACxC;AAAA,MACA,KAAK;AAAA,MACL,KAAK;AAAA,MACL;AAAA,MACA,KAAK,eAAe,UAAW;AAAA,MAC/B,KAAK;AAAA,MACL,KAAK;AAAA,MACL;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,QACC,qBACC,KAAK,qBAAqB,SAAyB,QAAQ,EACzD,cAAc,qBAAqB;AAAA,MACvC;AAAA,MACA;AAAA,MACA;AAAA,QACC,cAAc,6BAAM;AAAA,QAAC,GAAP;AAAA,QACd,UAAU,6BAAM;AAAA,QAAC,GAAP;AAAA,MACX;AAAA,IACD;AACA,sBAAkB,IAAI,MAAM;AAC5B,SAAK,sBAAsB,IAAI,cAAc,UAAU;AAAA,MACtD;AAAA,MACA,SAAS,6BAAM,kBAAkB,QAAQ,GAAhC;AAAA,IACV,CAAC;AAED,UAAM,aAAa,KAAK,eAAe,cAAc;AAErD,UAAM,OAAO,QAAQ,WAAW,SAAS,YAAY,IAAI;AACzD,SAAK,YAAY;AAEjB,sBAAkB;AAAA,MACjB,OAAO,YAAY,MAAM;AACxB,YAAI,KAAK,gBAAgB;AACxB,eAAK,eAAe,gBACnB,KAAK;AAAA,YACJ,OAAO,cAAc,EAAE;AAAA,UACxB;AAAA,QACF;AAAA,MACD,CAAC;AAAA,IACF;AAAA,EACD;AAAA,EAEQ,iBAAiB;AACxB,SAAK,gBAAgB;AAAA,MACpB,KAAK,eAAe;AAAA,QAA0B,YAC7C,KAAK,cAAc;AAAA,MACpB;AAAA,IACD;AAAA,EACD;AAAA,EAEA,MAAc,gBAAgB;AAC7B,QAAI,CAAC,KAAK,gBAAgB;AACzB;AAAA,IACD;AACA,UAAM,QAAQ,MAAM,KAAK,0BAA0B,KAAK,cAAc;AACtE,UAAM,kBAAkB,IAAI,IAAI,KAAK,sBAAsB,KAAK,CAAC;AACjE,UAAM,aAAa,KAAK,eAAe;AACvC,SAAK,UAAU,MAAM,MAAM,GAAG,WAAW,aAAa;AACtD,eAAW,QAAQ,OAAO;AACzB,UAAI,CAAC,MAAM;AACV;AAAA,MACD;AACA,iBAAW,UAAU,KAAK,SAAS;AAClC,wBAAgB,OAAO,OAAO,QAAQ;AACtC,cAAM,SAAS,KAAK,sBAAsB;AAAA,UACzC,OAAO;AAAA,QACR,GAAG;AACH,YAAI,QAAQ;AACX,gBAAM,OAAO,oBAAoB,MAAM;AAAA,QACxC,OAAO;AACN,gBAAM,KAAK;AAAA,YACV,KAAK;AAAA,YACL;AAAA,UACD;AAAA,QACD;AAAA,MACD;AAAA,IACD;AACA,eAAW,YAAY,iBAAiB;AACvC,WAAK,sBAAsB,iBAAiB,QAAQ;AAAA,IACrD;AACA,SAAK,cAAc;AAAA,EACpB;AAAA,EAEQ,8BAA8B,YAAoB;AACzD,UAAM,aAAa,KAAK,eAAe,cAAc;AAErD,UAAM,aAAa,KAAK,KAAK,WAAW,SAAS,aAAa,GAAG;AACjE,UAAM,aAAa,WAAW,SAAS;AACvC,UAAM,cAAc,KAAK,MAAM,aAAa,CAAC;AAC7C,UAAM,iBAAiB,KAAK,MAAM,aAAa,CAAC,IAAI;AAEpD,UAAM,iBACL,aACA,aACA,cACA,iBACA;AACD,WAAO;AAAA,EACR;AAAA,EAEQ,gBAAgB;AACvB,QAAI,CAAC,KAAK,gBAAgB;AACzB;AAAA,IACD;AACA,QAAI,SAAS;AACb,eAAW,EAAE,OAAO,KAAK,KAAK,sBAAsB,OAAO,GAAG;AAC7D,gBAAU,KAAK;AAAA,QACd,OAAO,cAAc,EAAE;AAAA,MACxB;AAAA,IACD;AACA,SAAK,eAAe,gBAAgB;AAAA,EACrC;AAAA,EAEA,MAAc,0BACb,SAC2C;AAC3C,QAAI,KAAK,eAAe,SAAS,GAAG;AACnC,aAAO;AAAA,QACN,MAAM,KAAK,eAAe,oBAAoB,QAAQ,GAAG;AAAA,MAC1D;AAAA,IACD;AAEA,WAAO,CAAC;AAAA,EACT;AAAA,EAEQ,cAAc;AACrB,UAAM,QAAQ,KAAK,aAAa,cAAc;AAC9C,UAAM,WAAW,KAAK,eAAe,cAAc,EAAE;AACrD,eAAW,EAAE,OAAO,KAAK,KAAK,sBAAsB,OAAO,GAAG;AAC7D,aAAO,WAAW,OAAO,QAAQ;AAAA,IAClC;AAAA,EACD;AAAA,EAES,cAAc,SAA+B;AACrD,SAAK,WAAW,OAAO;AACvB,SAAK,eAAe;AAAA,EACrB;AAAA,EAES,gBAAsB;AAC9B,SAAK,cAAc;AAAA,EACpB;AAAA,EAES,wBAAwB,SAA+B;AAC/D,QAAI,KAAK,gBAAgB;AACxB,WAAK,UAAU,MAAM,MAAM,GAAG,QAAQ,WAAW,aAAa;AAAA,IAC/D;AAAA,EACD;AACD;AArMa,eAAN;AAAA,EAWJ;AAAA,EAEA;AAAA,EACA;AAAA,EACA;AAAA,EAEA;AAAA,GAjBU;",
  "names": []
}
