var v=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var d=(a,i,r,o)=>{for(var e=o>1?void 0:o?I(i,r):i,n=a.length-1,t;n>=0;n--)(t=a[n])&&(e=(o?t(i,r,e):t(e))||e);return o&&e&&v(i,r,e),e},m=(a,i)=>(r,o)=>i(r,o,a);import{distinct as h}from"../../../../../base/common/arrays.js";import{onUnexpectedError as E}from"../../../../../base/common/errors.js";import{Event as c}from"../../../../../base/common/event.js";import{Disposable as S}from"../../../../../base/common/lifecycle.js";import{localize as l}from"../../../../../nls.js";import{IExtensionManagementService as x,InstallOperation as u}from"../../../../../platform/extensionManagement/common/extensionManagement.js";import{areSameExtensions as f}from"../../../../../platform/extensionManagement/common/extensionManagementUtil.js";import{IInstantiationService as k}from"../../../../../platform/instantiation/common/instantiation.js";import{INotificationService as g,Severity as K}from"../../../../../platform/notification/common/notification.js";import{IStorageService as M,StorageScope as O,StorageTarget as D}from"../../../../../platform/storage/common/storage.js";import{Memento as F}from"../../../../common/memento.js";import{EnablementState as w,IWorkbenchExtensionEnablementService as y}from"../../../../services/extensionManagement/common/extensionManagement.js";import{ILifecycleService as P}from"../../../../services/lifecycle/common/lifecycle.js";import{getInstalledExtensions as j}from"../../../extensions/common/extensionsUtils.js";function N(a){const i=a.get(x),r=a.get(y),o=c.chain(i.onDidInstallExtensions,e=>e.filter(n=>n.some(({operation:t})=>t===u.Install)).map(n=>n.map(({identifier:t})=>t)));return c.debounce(c.any(c.any(o,c.map(i.onDidUninstallExtension,e=>[e.identifier])),c.map(r.onEnablementChanged,e=>e.map(n=>n.identifier))),(e,n)=>{e=e||(n.length?[n[0]]:[]);for(const t of n)e.some(s=>!f(s,t))&&e.push(t);return e})}const R="hasRecommendedKeymap";let p=class extends S{constructor(r,o,e,n,t){super();this.instantiationService=r;this.extensionEnablementService=o;this.notificationService=e;this.notebookKeymapMemento=new F("notebookKeymap",n),this.notebookKeymap=this.notebookKeymapMemento.getMemento(O.PROFILE,D.USER),this._register(t.onDidShutdown(()=>this.dispose())),this._register(this.instantiationService.invokeFunction(N)(s=>{Promise.all(s.map(b=>this.checkForOtherKeymaps(b))).then(void 0,E)}))}_serviceBrand;notebookKeymapMemento;notebookKeymap;checkForOtherKeymaps(r){return this.instantiationService.invokeFunction(j).then(o=>{const e=o.filter(t=>C(t)),n=e.find(t=>f(t.identifier,r));if(n&&n.globallyEnabled){this.notebookKeymap[R]=!0,this.notebookKeymapMemento.saveMemento();const t=e.filter(s=>!f(s.identifier,r)&&s.globallyEnabled);if(t.length)return this.promptForDisablingOtherKeymaps(n,t)}})}promptForDisablingOtherKeymaps(r,o){const e=n=>{n&&this.extensionEnablementService.setEnablement(o.map(t=>t.local),w.DisabledGlobally)};this.notificationService.prompt(K.Info,l("disableOtherKeymapsConfirmation","Disable other keymaps ({0}) to avoid conflicts between keybindings?",h(o.map(n=>n.local.manifest.displayName)).map(n=>`'${n}'`).join(", ")),[{label:l("yes","Yes"),run:()=>e(!0)},{label:l("no","No"),run:()=>e(!1)}])}};p=d([m(0,k),m(1,y),m(2,g),m(3,M),m(4,P)],p);function C(a){if(a.local.manifest.extensionPack)return!1;const i=a.local.manifest.keywords;return i?i.indexOf("notebook-keymap")!==-1:!1}export{p as NotebookKeymapService,C as isNotebookKeymapExtension};
