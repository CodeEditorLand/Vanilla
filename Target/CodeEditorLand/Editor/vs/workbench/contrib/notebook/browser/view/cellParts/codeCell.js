var L=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var w=(p,r,t,e)=>{for(var i=e>1?void 0:e?k(r,t):r,o=p.length-1,a;o>=0;o--)(a=p[o])&&(i=(e?a(r,t,i):a(i))||i);return e&&i&&L(r,t,i),i},h=(p,r)=>(t,e)=>r(t,e,p);import{localize as I}from"../../../../../../nls.js";import*as s from"../../../../../../base/browser/dom.js";import{raceCancellation as D}from"../../../../../../base/common/async.js";import{CancellationTokenSource as _}from"../../../../../../base/common/cancellation.js";import{Codicon as x}from"../../../../../../base/common/codicons.js";import{Event as m}from"../../../../../../base/common/event.js";import{Disposable as H,toDisposable as b}from"../../../../../../base/common/lifecycle.js";import{clamp as N}from"../../../../../../base/common/numbers.js";import*as M from"../../../../../../base/common/strings.js";import{ThemeIcon as T}from"../../../../../../base/common/themables.js";import{EditorOption as y}from"../../../../../../editor/common/config/editorOptions.js";import"../../../../../../editor/common/core/dimension.js";import{ILanguageService as P}from"../../../../../../editor/common/languages/language.js";import{tokenizeToStringSync as F}from"../../../../../../editor/common/languages/textToHtmlTokenizer.js";import"../../../../../../editor/common/model.js";import{CodeActionController as O}from"../../../../../../editor/contrib/codeAction/browser/codeActionController.js";import{IConfigurationService as R}from"../../../../../../platform/configuration/common/configuration.js";import{IInstantiationService as z}from"../../../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as A}from"../../../../../../platform/keybinding/common/keybinding.js";import{IOpenerService as V}from"../../../../../../platform/opener/common/opener.js";import{INotebookExecutionStateService as W}from"../../../common/notebookExecutionStateService.js";import{CellFocusMode as C,EXPAND_CELL_INPUT_COMMAND_ID as B}from"../../notebookBrowser.js";import{outputDisplayLimit as U}from"../../viewModel/codeCellViewModel.js";import"../cellPart.js";import"../notebookCellEditorPool.js";import"../notebookRenderingCommon.js";import{CellEditorOptions as j}from"./cellEditorOptions.js";import{CellOutputContainer as $}from"./cellOutput.js";import{CollapsedCodeCellExecutionIcon as K}from"./codeCellExecutionIcon.js";let g=class extends H{constructor(t,e,i,o,a,l,d,u,c,v){super();this.notebookEditor=t;this.viewCell=e;this.templateData=i;this.editorPool=o;this.instantiationService=a;this.keybindingService=l;this.languageService=u;this.configurationService=c;this._cellEditorOptions=this._register(new j(this.notebookEditor.getBaseCellEditorOptions(e.language),this.notebookEditor.notebookOptions,this.configurationService)),this._outputContainerRenderer=this.instantiationService.createInstance($,t,e,i,{limit:U}),this.cellParts=this._register(i.cellParts.concatContentPart([this._cellEditorOptions,this._outputContainerRenderer],s.getWindow(t.getDomNode())));const f=this.calculateInitEditorHeight();this.initializeEditor(f),this._renderedInputCollapseState=!1,this.registerNotebookEditorListeners(),this.registerViewCellLayoutChange(),this.registerCellEditorEventListeners(),this.registerDecorations(),this.registerMouseListener(),this._register(m.any(this.viewCell.onDidStartExecution,this.viewCell.onDidStopExecution)(n=>{this.cellParts.updateForExecutionState(this.viewCell,n)})),this._register(this.viewCell.onDidChangeState(n=>{if(this.cellParts.updateState(this.viewCell,n),n.outputIsHoveredChanged&&this.updateForOutputHover(),n.outputIsFocusedChanged&&this.updateForOutputFocus(),(n.metadataChanged||n.internalMetadataChanged)&&this.updateEditorOptions(),n.inputCollapsedChanged||n.outputCollapsedChanged){this.viewCell.pauseLayout();const S=this.updateForCollapseState();this.viewCell.resumeLayout(),S&&this.relayoutCell()}n.focusModeChanged&&this.updateEditorForFocusModeChange(!0)})),this.cellParts.scheduleRenderCell(this.viewCell),this._register(b(()=>{this.cellParts.unrenderCell(this.viewCell)})),this.updateEditorOptions(),this.updateEditorForFocusModeChange(!1),this.updateForOutputHover(),this.updateForOutputFocus(),this.viewCell.editorHeight=f,this._outputContainerRenderer.render(),this._renderedOutputCollapseState=!1,this.initialViewUpdateExpanded(),this._register(this.viewCell.onLayoutInfoRead(()=>{this.cellParts.prepareLayout()}));const E=s.append(this.templateData.cellInputCollapsedContainer,s.$(".collapsed-execution-icon"));this._register(b(()=>{E.remove()})),this._collapsedExecutionIcon=this._register(this.instantiationService.createInstance(K,this.notebookEditor,this.viewCell,E)),this.updateForCollapseState(),this._register(m.runAndSubscribe(e.onDidChangeOutputs,this.updateForOutputs.bind(this))),this._register(m.runAndSubscribe(e.onDidChangeLayout,this.updateForLayout.bind(this))),this._cellEditorOptions.setLineNumbers(this.viewCell.lineNumbers),i.editor.updateOptions(this._cellEditorOptions.getUpdatedValue(this.viewCell.internalMetadata,this.viewCell.uri))}_outputContainerRenderer;_inputCollapseElement;_renderedInputCollapseState;_renderedOutputCollapseState;_isDisposed=!1;cellParts;_collapsedExecutionIcon;_cellEditorOptions;updateCodeCellOptions(t){t.editor.updateOptions(this._cellEditorOptions.getUpdatedValue(this.viewCell.internalMetadata,this.viewCell.uri));const e=new _;this._register({dispose(){e.dispose(!0)}}),D(this.viewCell.resolveTextModel(),e.token).then(i=>{this._isDisposed||i&&i.updateOptions({indentSize:this._cellEditorOptions.indentSize,tabSize:this._cellEditorOptions.tabSize,insertSpaces:this._cellEditorOptions.insertSpaces})})}_pendingLayout;updateForLayout(){this._pendingLayout?.dispose(),this._pendingLayout=s.modify(s.getWindow(this.notebookEditor.getDomNode()),()=>{this.cellParts.updateInternalLayoutNow(this.viewCell)})}updateForOutputHover(){this.templateData.container.classList.toggle("cell-output-hover",this.viewCell.outputIsHovered)}updateForOutputFocus(){this.templateData.container.classList.toggle("cell-output-focus",this.viewCell.outputIsFocused)}calculateInitEditorHeight(){const t=this.viewCell.lineCount,e=this.viewCell.layoutInfo.fontInfo?.lineHeight||17,i=this.notebookEditor.notebookOptions.computeEditorPadding(this.viewCell.internalMetadata,this.viewCell.uri);return this.viewCell.layoutInfo.editorHeight===0?t*e+i.top+i.bottom:this.viewCell.layoutInfo.editorHeight}initializeEditor(t){const e=this.viewCell.layoutInfo.editorWidth;this.layoutEditor({width:e,height:t});const i=new _;this._register({dispose(){i.dispose(!0)}}),D(this.viewCell.resolveTextModel(),i.token).then(o=>{if(!this._isDisposed){if(o&&this.templateData.editor){if(this._reigsterModelListeners(o),this.templateData.editor.setModel(o),this._isDisposed)return;o.updateOptions({indentSize:this._cellEditorOptions.indentSize,tabSize:this._cellEditorOptions.tabSize,insertSpaces:this._cellEditorOptions.insertSpaces}),this.viewCell.attachTextEditor(this.templateData.editor,this.viewCell.layoutInfo.estimatedHasHorizontalScrolling);const a=()=>{this.notebookEditor.getActiveCell()===this.viewCell&&this.viewCell.focusMode===C.Editor&&(this.notebookEditor.hasEditorFocus()||this.notebookEditor.getDomNode().ownerDocument.activeElement===this.notebookEditor.getDomNode().ownerDocument.body)&&this.templateData.editor?.focus()};a();const l=this.templateData.editor?.getContentHeight();if(l!==void 0&&l!==t&&this.onCellEditorHeightChange(l),this._isDisposed)return;a()}this._register(this._cellEditorOptions.onDidChange(()=>this.updateCodeCellOptions(this.templateData)))}})}updateForOutputs(){s.setVisibility(this.viewCell.outputsViewModels.length>0,this.templateData.focusSinkElement)}updateEditorOptions(){const t=this.templateData.editor;if(!t)return;const e=this.notebookEditor.isReadOnly,i=this.notebookEditor.notebookOptions.computeEditorPadding(this.viewCell.internalMetadata,this.viewCell.uri),o=t.getOptions();(o.get(y.readOnly)!==e||o.get(y.padding)!==i)&&t.updateOptions({readOnly:this.notebookEditor.isReadOnly,padding:this.notebookEditor.notebookOptions.computeEditorPadding(this.viewCell.internalMetadata,this.viewCell.uri)})}registerNotebookEditorListeners(){this._register(this.notebookEditor.onDidScroll(()=>{this.adjustEditorPosition()})),this._register(this.notebookEditor.onDidChangeLayout(()=>{this.adjustEditorPosition(),this.onCellWidthChange()}))}adjustEditorPosition(){const i=this.notebookEditor.scrollTop,o=this.notebookEditor.getAbsoluteTopOfElement(this.viewCell),a=i-o+-7,l=this.notebookEditor.getLayoutInfo(),d=l.height-l.stickyHeight-26,u=this.viewCell.layoutInfo.editorHeight-d,c=u>20?N(0,a,u):0;this.templateData.editorPart.style.top=`${c}px`,this.templateData.editor?.setScrollTop(c)}registerViewCellLayoutChange(){this._register(this.viewCell.onDidChangeLayout(t=>{t.outerWidth!==void 0&&this.templateData.editor.getLayoutInfo().width!==this.viewCell.layoutInfo.editorWidth&&(this.onCellWidthChange(),this.adjustEditorPosition())}))}registerCellEditorEventListeners(){this._register(this.templateData.editor.onDidContentSizeChange(t=>{t.contentHeightChanged&&this.viewCell.layoutInfo.editorHeight!==t.contentHeight&&(this.onCellEditorHeightChange(t.contentHeight),this.adjustEditorPosition())})),this._register(this.templateData.editor.onDidChangeCursorSelection(t=>{if(t.source==="restoreState"||t.oldModelVersionId===0)return;const e=this.templateData.editor.getSelections();if(e?.length){const i=this.templateData.editor.getContentHeight(),o=this.viewCell.layoutInfo.editorHeight;if(i!==o&&(this.onCellEditorHeightChange(i),this._isDisposed))return;const a=e[e.length-1];this.notebookEditor.revealRangeInViewAsync(this.viewCell,a)}})),this._register(this.templateData.editor.onDidBlurEditorWidget(()=>{O.get(this.templateData.editor)?.hideCodeActions(),O.get(this.templateData.editor)?.hideLightBulbWidget()}))}_reigsterModelListeners(t){this._register(t.onDidChangeTokens(()=>{if(this.viewCell.isInputCollapsed&&this._inputCollapseElement){const e=this._getRichTextFromLineTokens(t);s.safeInnerHtml(this._inputCollapseElement,e),this._attachInputExpandButton(this._inputCollapseElement)}}))}registerDecorations(){this._register(this.viewCell.onCellDecorationsChanged(t=>{t.added.forEach(e=>{e.className&&this.templateData.rootContainer.classList.add(e.className),e.outputClassName&&this.notebookEditor.deltaCellContainerClassNames(this.viewCell.id,[e.outputClassName],[])}),t.removed.forEach(e=>{e.className&&this.templateData.rootContainer.classList.remove(e.className),e.outputClassName&&this.notebookEditor.deltaCellContainerClassNames(this.viewCell.id,[],[e.outputClassName])})})),this.viewCell.getCellDecorations().forEach(t=>{t.className&&this.templateData.rootContainer.classList.add(t.className),t.outputClassName&&this.notebookEditor.deltaCellContainerClassNames(this.viewCell.id,[t.outputClassName],[])})}registerMouseListener(){this._register(this.templateData.editor.onMouseDown(t=>{t.event.rightButton&&t.event.preventDefault()}))}shouldPreserveEditor(){return this.notebookEditor.getActiveCell()===this.viewCell&&this.viewCell.focusMode===C.Editor&&(this.notebookEditor.hasEditorFocus()||this.notebookEditor.getDomNode().ownerDocument.activeElement===this.notebookEditor.getDomNode().ownerDocument.body)}updateEditorForFocusModeChange(t){this.shouldPreserveEditor()&&(t?this.templateData.editor?.focus():this._register(s.runAtThisOrScheduleAtNextAnimationFrame(s.getWindow(this.templateData.container),()=>{this.templateData.editor?.focus()}))),this.templateData.container.classList.toggle("cell-editor-focus",this.viewCell.focusMode===C.Editor),this.templateData.container.classList.toggle("cell-output-focus",this.viewCell.focusMode===C.Output)}updateForCollapseState(){return this.viewCell.isOutputCollapsed===this._renderedOutputCollapseState&&this.viewCell.isInputCollapsed===this._renderedInputCollapseState?!1:(this.viewCell.layoutChange({editorHeight:!0}),this.viewCell.isInputCollapsed?this._collapseInput():this._showInput(),this.viewCell.isOutputCollapsed?this._collapseOutput():this._showOutput(!1),this.relayoutCell(),this._renderedOutputCollapseState=this.viewCell.isOutputCollapsed,this._renderedInputCollapseState=this.viewCell.isInputCollapsed,!0)}_collapseInput(){s.hide(this.templateData.editorPart),this.templateData.container.classList.toggle("input-collapsed",!0),this._removeInputCollapsePreview(),this._collapsedExecutionIcon.setVisibility(!0);const t=this.templateData.editor.hasModel()?this._getRichTextFromLineTokens(this.templateData.editor.getModel()):this._getRichText(this.viewCell.textBuffer,this.viewCell.language),e=s.$("div.cell-collapse-preview");s.safeInnerHtml(e,t),this._inputCollapseElement=e,this.templateData.cellInputCollapsedContainer.appendChild(e),this._attachInputExpandButton(e),s.show(this.templateData.cellInputCollapsedContainer)}_attachInputExpandButton(t){const e=s.$("span.expandInputIcon"),i=this.keybindingService.lookupKeybinding(B);i&&(t.title=I("cellExpandInputButtonLabelWithDoubleClick","Double-click to expand cell input ({0})",i.getLabel()),e.title=I("cellExpandInputButtonLabel","Expand Cell Input ({0})",i.getLabel())),e.classList.add(...T.asClassNameArray(x.more)),t.appendChild(e)}_showInput(){this._collapsedExecutionIcon.setVisibility(!1),s.show(this.templateData.editorPart),s.hide(this.templateData.cellInputCollapsedContainer)}_getRichText(t,e){return F(this.languageService,t.getLineContent(1),e)}_getRichTextFromLineTokens(t){let e='<div class="monaco-tokenized-source">';const o=t.tokenization.getLineTokens(1).inflate(),a=t.getLineContent(1);let l=0;for(let d=0,u=o.getCount();d<u;d++){const c=o.getClassName(d),v=o.getEndOffset(d);e+=`<span class="${c}">${M.escape(a.substring(l,v))}</span>`,l=v}return e+="</div>",e}_removeInputCollapsePreview(){const t=this.templateData.cellInputCollapsedContainer.children,e=[];for(let i=0;i<t.length;i++)t[i].classList.contains("cell-collapse-preview")&&e.push(t[i]);e.forEach(i=>{i.remove()})}_updateOutputInnerContainer(t){const e=this.templateData.outputContainer.domNode.children;for(let i=0;i<e.length;i++)e[i].classList.contains("output-inner-container")&&s.setVisibility(!t,e[i])}_collapseOutput(){this.templateData.container.classList.toggle("output-collapsed",!0),s.show(this.templateData.cellOutputCollapsedContainer),this._updateOutputInnerContainer(!0),this._outputContainerRenderer.viewUpdateHideOuputs()}_showOutput(t){this.templateData.container.classList.toggle("output-collapsed",!1),s.hide(this.templateData.cellOutputCollapsedContainer),this._updateOutputInnerContainer(!1),this._outputContainerRenderer.viewUpdateShowOutputs(t)}initialViewUpdateExpanded(){this.templateData.container.classList.toggle("input-collapsed",!1),s.show(this.templateData.editorPart),s.hide(this.templateData.cellInputCollapsedContainer),this.templateData.container.classList.toggle("output-collapsed",!1),this._showOutput(!0)}layoutEditor(t){const e=this.notebookEditor.getLayoutInfo(),i=Math.min(e.height-e.stickyHeight-26,t.height);this.templateData.editor?.layout({width:t.width,height:i},!0)}onCellWidthChange(){if(!this.templateData.editor.hasModel())return;const t=this.templateData.editor.getContentHeight();this.viewCell.editorHeight=t,this.relayoutCell(),this.layoutEditor({width:this.viewCell.layoutInfo.editorWidth,height:t})}onCellEditorHeightChange(t){const e=this.templateData.editor.getLayoutInfo();this.viewCell.editorHeight=t,this.relayoutCell(),this.layoutEditor({width:e.width,height:t})}relayoutCell(){this.notebookEditor.layoutNotebookCell(this.viewCell,this.viewCell.layoutInfo.totalHeight)}dispose(){this._isDisposed=!0,this.shouldPreserveEditor()&&this.editorPool.preserveFocusedEditor(this.viewCell),this.viewCell.detachTextEditor(),this._removeInputCollapsePreview(),this._outputContainerRenderer.dispose(),this._pendingLayout?.dispose(),super.dispose()}};g=w([h(4,z),h(5,A),h(6,V),h(7,P),h(8,R),h(9,W)],g);export{g as CodeCell};
