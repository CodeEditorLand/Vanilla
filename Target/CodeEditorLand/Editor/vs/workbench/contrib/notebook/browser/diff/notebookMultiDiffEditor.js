var E=Object.defineProperty;var _=Object.getOwnPropertyDescriptor;var I=(p,s,e,t)=>{for(var o=t>1?void 0:t?_(s,e):s,d=p.length-1,r;d>=0;d--)(r=p[d])&&(o=(t?r(s,e,o):r(o))||o);return t&&o&&E(s,e,o),o},i=(p,s)=>(e,t)=>s(e,t,p);import"../../../../../../vs/base/browser/dom.js";import{PixelRatio as y}from"../../../../../../vs/base/browser/pixelRatio.js";import{CancellationTokenSource as O}from"../../../../../../vs/base/common/cancellation.js";import{DisposableStore as N}from"../../../../../../vs/base/common/lifecycle.js";import{Schemas as n}from"../../../../../../vs/base/common/network.js";import{autorun as x,transaction as V}from"../../../../../../vs/base/common/observable.js";import{FontMeasurements as U}from"../../../../../../vs/editor/browser/config/fontMeasurements.js";import{MultiDiffEditorWidget as F}from"../../../../../../vs/editor/browser/widget/multiDiffEditor/multiDiffEditorWidget.js";import"../../../../../../vs/editor/browser/widget/multiDiffEditor/workbenchUIElementFactory.js";import"../../../../../../vs/editor/common/config/editorOptions.js";import{BareFontInfo as L}from"../../../../../../vs/editor/common/config/fontInfo.js";import{getIconClassesForLanguageId as R}from"../../../../../../vs/editor/common/services/getIconClasses.js";import{localize as S}from"../../../../../../vs/nls.js";import{IConfigurationService as W}from"../../../../../../vs/platform/configuration/common/configuration.js";import{IContextKeyService as A}from"../../../../../../vs/platform/contextkey/common/contextkey.js";import{IInstantiationService as M}from"../../../../../../vs/platform/instantiation/common/instantiation.js";import{IStorageService as K}from"../../../../../../vs/platform/storage/common/storage.js";import{ITelemetryService as H}from"../../../../../../vs/platform/telemetry/common/telemetry.js";import{IThemeService as T}from"../../../../../../vs/platform/theme/common/themeService.js";import{ResourceLabel as B}from"../../../../../../vs/workbench/browser/labels.js";import{EditorPane as P}from"../../../../../../vs/workbench/browser/parts/editor/editorPane.js";import"../../../../../../vs/workbench/common/editor.js";import"../../../../../../vs/workbench/contrib/notebook/browser/diff/diffElementViewModel.js";import{NotebookDiffEditorEventDispatcher as G}from"../../../../../../vs/workbench/contrib/notebook/browser/diff/eventDispatcher.js";import{NOTEBOOK_DIFF_CELLS_COLLAPSED as j,NOTEBOOK_DIFF_HAS_UNCHANGED_CELLS as z,NOTEBOOK_DIFF_UNCHANGED_CELLS_HIDDEN as $}from"../../../../../../vs/workbench/contrib/notebook/browser/diff/notebookDiffEditorBrowser.js";import{NotebookDiffViewModel as q}from"../../../../../../vs/workbench/contrib/notebook/browser/diff/notebookDiffViewModel.js";import{NotebookMultiDiffEditorWidgetInput as J}from"../../../../../../vs/workbench/contrib/notebook/browser/diff/notebookMultiDiffEditorInput.js";import{NotebookOptions as Q}from"../../../../../../vs/workbench/contrib/notebook/browser/notebookOptions.js";import{CellUri as D,NOTEBOOK_MULTI_DIFF_EDITOR_ID as X}from"../../../../../../vs/workbench/contrib/notebook/common/notebookCommon.js";import{INotebookService as C}from"../../../../../../vs/workbench/contrib/notebook/common/notebookService.js";import{INotebookEditorWorkerService as Y}from"../../../../../../vs/workbench/contrib/notebook/common/services/notebookWorkerService.js";import"../../../../../../vs/workbench/services/editor/common/editorGroupsService.js";import{INotebookDocumentService as Z}from"../../../../../../vs/workbench/services/notebook/common/notebookDocumentService.js";let m=class extends P{constructor(e,t,o,d,r,f,a,l,c){super(m.ID,e,a,o,l);this.instantiationService=t;this._parentContextKeyService=d;this.notebookEditorWorkerService=r;this.configurationService=f;this.notebookService=c;this._notebookOptions=t.createInstance(Q,this.window,!1,void 0),this._register(this._notebookOptions)}_multiDiffEditorWidget;static ID=X;_fontInfo;_scopeContextKeyService;modelSpecificResources=this._register(new N);_model;viewModel;widgetViewModel;get textModel(){return this._model?.modified.notebook}_notebookOptions;get notebookOptions(){return this._notebookOptions}ctxAllCollapsed=this._parentContextKeyService.createKey(j.key,!1);ctxHasUnchangedCells=this._parentContextKeyService.createKey(z.key,!1);ctxHiddenUnchangedCells=this._parentContextKeyService.createKey($.key,!0);get fontInfo(){return this._fontInfo||(this._fontInfo=this.createFontInfo()),this._fontInfo}layout(e,t){this._multiDiffEditorWidget.layout(e)}createFontInfo(){const e=this.configurationService.getValue("editor");return U.readFontInfo(this.window,L.createFromRawSettings(e,y.getInstance(this.window).value))}createEditor(e){this._multiDiffEditorWidget=this._register(this.instantiationService.createInstance(F,e,this.instantiationService.createInstance(g))),this._register(this._multiDiffEditorWidget.onDidChangeActiveControl(()=>{this._onDidChangeControl.fire()}))}async setInput(e,t,o,d){super.setInput(e,t,o,d);const r=await e.resolve();this._model!==r&&(this._detachModel(),this._model=r);const f=this.modelSpecificResources.add(new G);this.viewModel=this.modelSpecificResources.add(new q(r,this.notebookEditorWorkerService,this.instantiationService,this.configurationService,f,this.notebookService,void 0,!0)),await this.viewModel.computeDiff(this.modelSpecificResources.add(new O).token),this.ctxHasUnchangedCells.set(this.viewModel.hasUnchangedCells),this.ctxHasUnchangedCells.set(this.viewModel.hasUnchangedCells);const a=this.modelSpecificResources.add(J.createInput(this.viewModel,this.instantiationService));this.widgetViewModel=this.modelSpecificResources.add(await a.getViewModel());const l=new WeakSet;this.modelSpecificResources.add(x(c=>{if(!this.widgetViewModel||!this.viewModel)return;const u=this.widgetViewModel.items.read(c),h=this.viewModel.value;u.length===h.length&&V(k=>{u.forEach(v=>{if(l.has(v))return;l.add(v);const b=h.find(w=>w.modifiedUri?.toString()===v.modifiedUri?.toString()&&w.originalUri?.toString()===v.originalUri?.toString());b&&b.type==="unchanged"&&v.collapsed.set(!0,k)})})})),this._multiDiffEditorWidget.setViewModel(this.widgetViewModel)}_detachModel(){this.viewModel=void 0,this.modelSpecificResources.clear()}_generateFontFamily(){return this.fontInfo.fontFamily??'"SF Mono", Monaco, Menlo, Consolas, "Ubuntu Mono", "Liberation Mono", "DejaVu Sans Mono", "Courier New", monospace'}setOptions(e){super.setOptions(e)}getControl(){return this._multiDiffEditorWidget.getActiveControl()}focus(){super.focus(),this._multiDiffEditorWidget?.getActiveControl()?.focus()}hasFocus(){return this._multiDiffEditorWidget?.getActiveControl()?.hasTextFocus()||super.hasFocus()}clearInput(){super.clearInput(),this._multiDiffEditorWidget.setViewModel(void 0),this.modelSpecificResources.clear(),this.viewModel=void 0,this.widgetViewModel=void 0}expandAll(){this.widgetViewModel&&(this.widgetViewModel.expandAll(),this.ctxAllCollapsed.set(!1))}collapseAll(){this.widgetViewModel&&(this.widgetViewModel.collapseAll(),this.ctxAllCollapsed.set(!0))}hideUnchanged(){this.viewModel&&(this.viewModel.includeUnchanged=!1,this.ctxHiddenUnchangedCells.set(!0))}showUnchanged(){this.viewModel&&(this.viewModel.includeUnchanged=!0,this.ctxHiddenUnchangedCells.set(!1))}getDiffElementViewModel(e){if(e.scheme===n.vscodeNotebookCellOutput||e.scheme===n.vscodeNotebookCellOutputDiff||e.scheme===n.vscodeNotebookCellMetadata||e.scheme===n.vscodeNotebookCellMetadataDiff){const t=D.parseCellPropertyUri(e,e.scheme);t&&(e=D.generate(t.notebook,t.handle))}return this.viewModel?.items.find(t=>{switch(t.type){case"delete":return t.original?.uri.toString()===e.toString();case"insert":return t.modified?.uri.toString()===e.toString();case"modified":case"unchanged":return t.modified?.uri.toString()===e.toString()||t.original?.uri.toString()===e.toString();default:return}})}};m=I([i(1,M),i(2,T),i(3,A),i(4,Y),i(5,W),i(6,H),i(7,K),i(8,C)],m);let g=class{constructor(s,e,t){this._instantiationService=s;this.notebookDocumentService=e;this.notebookService=t}createResourceLabel(s){const e=this._instantiationService.createInstance(B,s,{}),t=this;return{setUri(o,d={}){if(!o)e.element.clear();else{let r="",f="",a;if(o.scheme===n.vscodeNotebookCell){const l=o.scheme===n.vscodeNotebookCell?t.notebookDocumentService.getNotebook(o):void 0,c=n.vscodeNotebookCell?t.notebookDocumentService.getNotebook(o)?.getCellIndex(o):void 0;if(l&&c!==void 0){r=S("notebookCellLabel","Cell {0}",`${c+1}`);const u=l?t.notebookService.getNotebookTextModel(l?.uri):void 0,h=u&&c!==void 0?u.cells[c].language:void 0;a=h?R(h):void 0}}else o.scheme===n.vscodeNotebookCellMetadata||o.scheme===n.vscodeNotebookCellMetadataDiff?f=S("notebookCellMetadataLabel","Metadata"):(o.scheme===n.vscodeNotebookCellOutput||o.scheme===n.vscodeNotebookCellOutputDiff)&&(f=S("notebookCellOutputLabel","Output"));e.element.setResource({name:r,description:f},{strikethrough:d.strikethrough,forceLabel:!0,hideIcon:!a,extraClasses:a})}},dispose(){e.dispose()}}}};g=I([i(0,M),i(1,Z),i(2,C)],g);export{m as NotebookMultiTextDiffEditor};
