var E=Object.defineProperty;var _=Object.getOwnPropertyDescriptor;var I=(p,s,e,t)=>{for(var o=t>1?void 0:t?_(s,e):s,d=p.length-1,r;d>=0;d--)(r=p[d])&&(o=(t?r(s,e,o):r(o))||o);return t&&o&&E(s,e,o),o},i=(p,s)=>(e,t)=>s(e,t,p);import"../../../../../base/browser/dom.js";import"../../../../../editor/browser/widget/multiDiffEditor/workbenchUIElementFactory.js";import{IStorageService as y}from"../../../../../platform/storage/common/storage.js";import{ITelemetryService as O}from"../../../../../platform/telemetry/common/telemetry.js";import{IThemeService as N}from"../../../../../platform/theme/common/themeService.js";import"../../../../common/editor.js";import"../../../../services/editor/common/editorGroupsService.js";import{CancellationTokenSource as x}from"../../../../../base/common/cancellation.js";import{IInstantiationService as M}from"../../../../../platform/instantiation/common/instantiation.js";import{IContextKeyService as V}from"../../../../../platform/contextkey/common/contextkey.js";import{INotebookEditorWorkerService as U}from"../../common/services/notebookWorkerService.js";import{IConfigurationService as F}from"../../../../../platform/configuration/common/configuration.js";import"../../../../../editor/common/config/editorOptions.js";import{BareFontInfo as L}from"../../../../../editor/common/config/fontInfo.js";import{PixelRatio as R}from"../../../../../base/browser/pixelRatio.js";import{DisposableStore as W}from"../../../../../base/common/lifecycle.js";import{EditorPane as A}from"../../../../browser/parts/editor/editorPane.js";import{CellUri as D,NOTEBOOK_MULTI_DIFF_EDITOR_ID as K}from"../../common/notebookCommon.js";import{FontMeasurements as H}from"../../../../../editor/browser/config/fontMeasurements.js";import{NotebookOptions as T}from"../notebookOptions.js";import{INotebookService as C}from"../../common/notebookService.js";import{NotebookMultiDiffEditorWidgetInput as B}from"./notebookMultiDiffEditorInput.js";import{MultiDiffEditorWidget as P}from"../../../../../editor/browser/widget/multiDiffEditor/multiDiffEditorWidget.js";import{ResourceLabel as j}from"../../../../browser/labels.js";import{INotebookDocumentService as G}from"../../../../services/notebook/common/notebookDocumentService.js";import{localize as S}from"../../../../../nls.js";import{Schemas as n}from"../../../../../base/common/network.js";import{getIconClassesForLanguageId as z}from"../../../../../editor/common/services/getIconClasses.js";import{NotebookDiffViewModel as $}from"./notebookDiffViewModel.js";import{NotebookDiffEditorEventDispatcher as q}from"./eventDispatcher.js";import{NOTEBOOK_DIFF_CELLS_COLLAPSED as J,NOTEBOOK_DIFF_HAS_UNCHANGED_CELLS as Q,NOTEBOOK_DIFF_UNCHANGED_CELLS_HIDDEN as X}from"./notebookDiffEditorBrowser.js";import"./diffElementViewModel.js";import{autorun as Y,transaction as Z}from"../../../../../base/common/observable.js";let m=class extends A{constructor(e,t,o,d,r,f,a,l,c){super(m.ID,e,a,o,l);this.instantiationService=t;this._parentContextKeyService=d;this.notebookEditorWorkerService=r;this.configurationService=f;this.notebookService=c;this._notebookOptions=t.createInstance(T,this.window,!1,void 0),this._register(this._notebookOptions)}_multiDiffEditorWidget;static ID=K;_fontInfo;_scopeContextKeyService;modelSpecificResources=this._register(new W);_model;viewModel;widgetViewModel;get textModel(){return this._model?.modified.notebook}_notebookOptions;get notebookOptions(){return this._notebookOptions}ctxAllCollapsed=this._parentContextKeyService.createKey(J.key,!1);ctxHasUnchangedCells=this._parentContextKeyService.createKey(Q.key,!1);ctxHiddenUnchangedCells=this._parentContextKeyService.createKey(X.key,!0);get fontInfo(){return this._fontInfo||(this._fontInfo=this.createFontInfo()),this._fontInfo}layout(e,t){this._multiDiffEditorWidget.layout(e)}createFontInfo(){const e=this.configurationService.getValue("editor");return H.readFontInfo(this.window,L.createFromRawSettings(e,R.getInstance(this.window).value))}createEditor(e){this._multiDiffEditorWidget=this._register(this.instantiationService.createInstance(P,e,this.instantiationService.createInstance(g))),this._register(this._multiDiffEditorWidget.onDidChangeActiveControl(()=>{this._onDidChangeControl.fire()}))}async setInput(e,t,o,d){super.setInput(e,t,o,d);const r=await e.resolve();this._model!==r&&(this._detachModel(),this._model=r);const f=this.modelSpecificResources.add(new q);this.viewModel=this.modelSpecificResources.add(new $(r,this.notebookEditorWorkerService,this.configurationService,f,this.notebookService,void 0,!0)),await this.viewModel.computeDiff(this.modelSpecificResources.add(new x).token),this.ctxHasUnchangedCells.set(this.viewModel.hasUnchangedCells),this.ctxHasUnchangedCells.set(this.viewModel.hasUnchangedCells);const a=this.modelSpecificResources.add(B.createInput(this.viewModel,this.instantiationService));this.widgetViewModel=this.modelSpecificResources.add(await a.getViewModel());const l=new WeakSet;this.modelSpecificResources.add(Y(c=>{if(!this.widgetViewModel||!this.viewModel)return;const u=this.widgetViewModel.items.read(c),h=this.viewModel.value;u.length===h.length&&Z(k=>{u.forEach(v=>{if(l.has(v))return;l.add(v);const b=h.find(w=>w.modifiedUri?.toString()===v.modifiedUri?.toString()&&w.originalUri?.toString()===v.originalUri?.toString());b&&b.type==="unchanged"&&v.collapsed.set(!0,k)})})})),this._multiDiffEditorWidget.setViewModel(this.widgetViewModel)}_detachModel(){this.viewModel=void 0,this.modelSpecificResources.clear()}_generateFontFamily(){return this.fontInfo.fontFamily??'"SF Mono", Monaco, Menlo, Consolas, "Ubuntu Mono", "Liberation Mono", "DejaVu Sans Mono", "Courier New", monospace'}setOptions(e){super.setOptions(e)}getControl(){return this._multiDiffEditorWidget.getActiveControl()}focus(){super.focus(),this._multiDiffEditorWidget?.getActiveControl()?.focus()}hasFocus(){return this._multiDiffEditorWidget?.getActiveControl()?.hasTextFocus()||super.hasFocus()}clearInput(){super.clearInput(),this._multiDiffEditorWidget.setViewModel(void 0),this.modelSpecificResources.clear(),this.viewModel=void 0,this.widgetViewModel=void 0}expandAll(){this.widgetViewModel&&(this.widgetViewModel.expandAll(),this.ctxAllCollapsed.set(!1))}collapseAll(){this.widgetViewModel&&(this.widgetViewModel.collapseAll(),this.ctxAllCollapsed.set(!0))}hideUnchanged(){this.viewModel&&(this.viewModel.includeUnchanged=!1,this.ctxHiddenUnchangedCells.set(!0))}showUnchanged(){this.viewModel&&(this.viewModel.includeUnchanged=!0,this.ctxHiddenUnchangedCells.set(!1))}getDiffElementViewModel(e){if(e.scheme===n.vscodeNotebookCellOutput||e.scheme===n.vscodeNotebookCellOutputDiff||e.scheme===n.vscodeNotebookCellMetadata||e.scheme===n.vscodeNotebookCellMetadataDiff){const t=D.parseCellPropertyUri(e,e.scheme);t&&(e=D.generate(t.notebook,t.handle))}return this.viewModel?.items.find(t=>{switch(t.type){case"delete":return t.original?.uri.toString()===e.toString();case"insert":return t.modified?.uri.toString()===e.toString();case"modified":case"unchanged":return t.modified?.uri.toString()===e.toString()||t.original?.uri.toString()===e.toString();default:return}})}};m=I([i(1,M),i(2,N),i(3,V),i(4,U),i(5,F),i(6,O),i(7,y),i(8,C)],m);let g=class{constructor(s,e,t){this._instantiationService=s;this.notebookDocumentService=e;this.notebookService=t}createResourceLabel(s){const e=this._instantiationService.createInstance(j,s,{}),t=this;return{setUri(o,d={}){if(!o)e.element.clear();else{let r="",f="",a;if(o.scheme===n.vscodeNotebookCell){const l=o.scheme===n.vscodeNotebookCell?t.notebookDocumentService.getNotebook(o):void 0,c=n.vscodeNotebookCell?t.notebookDocumentService.getNotebook(o)?.getCellIndex(o):void 0;if(l&&c!==void 0){r=S("notebookCellLabel","Cell {0}",`${c+1}`);const u=l?t.notebookService.getNotebookTextModel(l?.uri):void 0,h=u&&c!==void 0?u.cells[c].language:void 0;a=h?z(h):void 0}}else o.scheme===n.vscodeNotebookCellMetadata||o.scheme===n.vscodeNotebookCellMetadataDiff?f=S("notebookCellMetadataLabel","Metadata"):(o.scheme===n.vscodeNotebookCellOutput||o.scheme===n.vscodeNotebookCellOutputDiff)&&(f=S("notebookCellOutputLabel","Output"));e.element.setResource({name:r,description:f},{strikethrough:d.strikethrough,forceLabel:!0,hideIcon:!a,extraClasses:a})}},dispose(){e.dispose()}}}};g=I([i(0,M),i(1,G),i(2,C)],g);export{m as NotebookMultiTextDiffEditor};
