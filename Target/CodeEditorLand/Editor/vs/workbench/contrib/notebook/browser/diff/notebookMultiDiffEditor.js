var _=Object.defineProperty;var y=Object.getOwnPropertyDescriptor;var I=(p,s,e,t)=>{for(var o=t>1?void 0:t?y(s,e):s,d=p.length-1,n;d>=0;d--)(n=p[d])&&(o=(t?n(s,e,o):n(o))||o);return t&&o&&_(s,e,o),o},i=(p,s)=>(e,t)=>s(e,t,p);import"../../../../../base/browser/dom.js";import"../../../../../editor/browser/widget/multiDiffEditor/workbenchUIElementFactory.js";import{IStorageService as O}from"../../../../../platform/storage/common/storage.js";import{ITelemetryService as N}from"../../../../../platform/telemetry/common/telemetry.js";import{IThemeService as x}from"../../../../../platform/theme/common/themeService.js";import"../../../../common/editor.js";import"../../../../services/editor/common/editorGroupsService.js";import{CancellationTokenSource as V}from"../../../../../base/common/cancellation.js";import{IInstantiationService as D}from"../../../../../platform/instantiation/common/instantiation.js";import{IContextKeyService as U}from"../../../../../platform/contextkey/common/contextkey.js";import{INotebookEditorWorkerService as F}from"../../common/services/notebookWorkerService.js";import{IConfigurationService as L}from"../../../../../platform/configuration/common/configuration.js";import"../../../../../editor/common/config/editorOptions.js";import{BareFontInfo as R}from"../../../../../editor/common/config/fontInfo.js";import{PixelRatio as W}from"../../../../../base/browser/pixelRatio.js";import{DisposableStore as H}from"../../../../../base/common/lifecycle.js";import{EditorPane as A}from"../../../../browser/parts/editor/editorPane.js";import{CellUri as C,NOTEBOOK_MULTI_DIFF_EDITOR_ID as K}from"../../common/notebookCommon.js";import{FontMeasurements as T}from"../../../../../editor/browser/config/fontMeasurements.js";import{NotebookOptions as B}from"../notebookOptions.js";import{INotebookService as k}from"../../common/notebookService.js";import{NotebookMultiDiffEditorWidgetInput as P}from"./notebookMultiDiffEditorInput.js";import{MultiDiffEditorWidget as j}from"../../../../../editor/browser/widget/multiDiffEditor/multiDiffEditorWidget.js";import{ResourceLabel as G}from"../../../../browser/labels.js";import{INotebookDocumentService as z}from"../../../../services/notebook/common/notebookDocumentService.js";import{localize as S}from"../../../../../nls.js";import{Schemas as r}from"../../../../../base/common/network.js";import{getIconClassesForLanguageId as $}from"../../../../../editor/common/services/getIconClasses.js";import{NotebookDiffViewModel as q}from"./notebookDiffViewModel.js";import{NotebookDiffEditorEventDispatcher as J}from"./eventDispatcher.js";import{NOTEBOOK_DIFF_CELLS_COLLAPSED as Q,NOTEBOOK_DIFF_HAS_UNCHANGED_CELLS as X,NOTEBOOK_DIFF_UNCHANGED_CELLS_HIDDEN as Y}from"./notebookDiffEditorBrowser.js";import"./diffElementViewModel.js";import{autorun as Z,transaction as ee}from"../../../../../base/common/observable.js";import{DiffEditorHeightCalculatorService as te}from"./editorHeightCalculator.js";let m=class extends A{constructor(e,t,o,d,n,f,a,c,l){super(m.ID,e,a,o,c);this.instantiationService=t;this._parentContextKeyService=d;this.notebookEditorWorkerService=n;this.configurationService=f;this.notebookService=l;this._notebookOptions=t.createInstance(B,this.window,!1,void 0),this._register(this._notebookOptions)}_multiDiffEditorWidget;static ID=K;_fontInfo;_scopeContextKeyService;modelSpecificResources=this._register(new H);_model;viewModel;widgetViewModel;get textModel(){return this._model?.modified.notebook}_notebookOptions;get notebookOptions(){return this._notebookOptions}ctxAllCollapsed=this._parentContextKeyService.createKey(Q.key,!1);ctxHasUnchangedCells=this._parentContextKeyService.createKey(X.key,!1);ctxHiddenUnchangedCells=this._parentContextKeyService.createKey(Y.key,!0);get fontInfo(){return this._fontInfo||(this._fontInfo=this.createFontInfo()),this._fontInfo}layout(e,t){this._multiDiffEditorWidget.layout(e)}createFontInfo(){const e=this.configurationService.getValue("editor");return T.readFontInfo(this.window,R.createFromRawSettings(e,W.getInstance(this.window).value))}createEditor(e){this._multiDiffEditorWidget=this._register(this.instantiationService.createInstance(j,e,this.instantiationService.createInstance(v))),this._register(this._multiDiffEditorWidget.onDidChangeActiveControl(()=>{this._onDidChangeControl.fire()}))}async setInput(e,t,o,d){super.setInput(e,t,o,d);const n=await e.resolve();this._model!==n&&(this._detachModel(),this._model=n);const f=this.modelSpecificResources.add(new J),a=this.instantiationService.createInstance(te,this.fontInfo.lineHeight);this.viewModel=this.modelSpecificResources.add(new q(n,this.notebookEditorWorkerService,this.configurationService,f,this.notebookService,a,void 0,!0)),await this.viewModel.computeDiff(this.modelSpecificResources.add(new V).token),this.ctxHasUnchangedCells.set(this.viewModel.hasUnchangedCells),this.ctxHasUnchangedCells.set(this.viewModel.hasUnchangedCells);const c=this.modelSpecificResources.add(P.createInput(this.viewModel,this.instantiationService));this.widgetViewModel=this.modelSpecificResources.add(await c.getViewModel());const l=new WeakSet;this.modelSpecificResources.add(Z(g=>{if(!this.widgetViewModel||!this.viewModel)return;const u=this.widgetViewModel.items.read(g),M=this.viewModel.value;u.length===M.length&&ee(E=>{u.forEach(h=>{if(l.has(h))return;l.add(h);const b=M.find(w=>w.modifiedUri?.toString()===h.modifiedUri?.toString()&&w.originalUri?.toString()===h.originalUri?.toString());b&&b.type==="unchanged"&&h.collapsed.set(!0,E)})})})),this._multiDiffEditorWidget.setViewModel(this.widgetViewModel)}_detachModel(){this.viewModel=void 0,this.modelSpecificResources.clear()}_generateFontFamily(){return this.fontInfo.fontFamily??'"SF Mono", Monaco, Menlo, Consolas, "Ubuntu Mono", "Liberation Mono", "DejaVu Sans Mono", "Courier New", monospace'}setOptions(e){super.setOptions(e)}getControl(){return this._multiDiffEditorWidget.getActiveControl()}focus(){super.focus(),this._multiDiffEditorWidget?.getActiveControl()?.focus()}hasFocus(){return this._multiDiffEditorWidget?.getActiveControl()?.hasTextFocus()||super.hasFocus()}clearInput(){super.clearInput(),this._multiDiffEditorWidget.setViewModel(void 0),this.modelSpecificResources.clear(),this.viewModel=void 0,this.widgetViewModel=void 0}expandAll(){this.widgetViewModel&&(this.widgetViewModel.expandAll(),this.ctxAllCollapsed.set(!1))}collapseAll(){this.widgetViewModel&&(this.widgetViewModel.collapseAll(),this.ctxAllCollapsed.set(!0))}hideUnchanged(){this.viewModel&&(this.viewModel.includeUnchanged=!1,this.ctxHiddenUnchangedCells.set(!0))}showUnchanged(){this.viewModel&&(this.viewModel.includeUnchanged=!0,this.ctxHiddenUnchangedCells.set(!1))}getDiffElementViewModel(e){if(e.scheme===r.vscodeNotebookCellOutput||e.scheme===r.vscodeNotebookCellOutputDiff||e.scheme===r.vscodeNotebookCellMetadata||e.scheme===r.vscodeNotebookCellMetadataDiff){const t=C.parseCellPropertyUri(e,e.scheme);t&&(e=C.generate(t.notebook,t.handle))}return e.scheme===r.vscodeNotebookMetadata?this.viewModel?.items.find(t=>t.type==="modifiedMetadata"||t.type==="unchangedMetadata"):this.viewModel?.items.find(t=>{switch(t.type){case"delete":return t.original?.uri.toString()===e.toString();case"insert":return t.modified?.uri.toString()===e.toString();case"modified":case"unchanged":return t.modified?.uri.toString()===e.toString()||t.original?.uri.toString()===e.toString();default:return}})}};m=I([i(1,D),i(2,x),i(3,U),i(4,F),i(5,L),i(6,N),i(7,O),i(8,k)],m);let v=class{constructor(s,e,t){this._instantiationService=s;this.notebookDocumentService=e;this.notebookService=t}createResourceLabel(s){const e=this._instantiationService.createInstance(G,s,{}),t=this;return{setUri(o,d={}){if(!o)e.element.clear();else{let n="",f="",a;if(o.scheme===r.vscodeNotebookCell){const c=o.scheme===r.vscodeNotebookCell?t.notebookDocumentService.getNotebook(o):void 0,l=r.vscodeNotebookCell?t.notebookDocumentService.getNotebook(o)?.getCellIndex(o):void 0;if(c&&l!==void 0){n=S("notebookCellLabel","Cell {0}",`${l+1}`);const g=c?t.notebookService.getNotebookTextModel(c?.uri):void 0,u=g&&l!==void 0?g.cells[l].language:void 0;a=u?$(u):void 0}}else o.scheme===r.vscodeNotebookCellMetadata||o.scheme===r.vscodeNotebookCellMetadataDiff?f=S("notebookCellMetadataLabel","Metadata"):(o.scheme===r.vscodeNotebookCellOutput||o.scheme===r.vscodeNotebookCellOutputDiff)&&(f=S("notebookCellOutputLabel","Output"));e.element.setResource({name:n,description:f},{strikethrough:d.strikethrough,forceLabel:!0,hideIcon:!a,extraClasses:a})}},dispose(){e.dispose()}}}};v=I([i(0,D),i(1,z),i(2,k)],v);export{m as NotebookMultiTextDiffEditor};
