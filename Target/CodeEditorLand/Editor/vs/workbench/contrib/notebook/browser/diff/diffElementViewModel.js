import{Emitter as y}from"../../../../../base/common/event.js";import{hash as c}from"../../../../../base/common/hash.js";import{Disposable as V}from"../../../../../base/common/lifecycle.js";import"../../../../../base/common/uri.js";import{DiffEditorWidget as b}from"../../../../../editor/browser/widget/diffEditor/diffEditorWidget.js";import"../../../../../editor/common/config/fontInfo.js";import"../../../../../editor/common/editorCommon.js";import{fixedEditorPadding as S}from"./diffCellEditorOptions.js";import{DiffNestedCellViewModel as _}from"./diffNestedCellViewModel.js";import{NotebookDiffViewEventType as x}from"./eventDispatcher.js";import{DIFF_CELL_MARGIN as C,DiffSide as M}from"./notebookDiffEditorBrowser.js";import{CellLayoutState as O}from"../notebookBrowser.js";import"../notebookViewEvents.js";import{getFormattedMetadataJSON as w}from"../../common/model/notebookCellTextModel.js";import"../../common/model/notebookTextModel.js";import"../../common/notebookCommon.js";import"../../common/notebookService.js";import"../../../../../platform/configuration/common/configuration.js";var T=(t=>(t[t.Expanded=0]="Expanded",t[t.Collapsed=1]="Collapsed",t))(T||{});const v=1440;class E extends V{constructor(t,e,i){super();this.mainDocumentTextModel=t;this.editorEventDispatcher=e;this.initData=i;this._register(this.editorEventDispatcher.onDidChangeLayout(a=>this._layoutInfoEmitter.fire({outerWidth:!0})))}_layoutInfoEmitter=this._register(new y);onDidLayoutChange=this._layoutInfoEmitter.event}class mt extends E{type="placeholder";hiddenCells=[];_unfoldHiddenCells=this._register(new y);onUnfoldHiddenCells=this._unfoldHiddenCells.event;constructor(n,t,e){super(n,t,e)}get totalHeight(){return 24+2*C}getHeight(n){return this.totalHeight}layoutChange(){}showHiddenCells(){this._unfoldHiddenCells.fire()}}class D extends E{constructor(t,e,i,a,u,r,d,l){super(t,u,r);this.type=a;this.configurationService=l;this.original=e?this._register(new _(e,d)):void 0,this.modified=i?this._register(new _(i,d)):void 0;const g=this._estimateEditorHeight(r.fontInfo),p=25;this._layoutInfo={width:0,editorHeight:g,editorMargin:0,metadataHeight:0,cellStatusHeight:p,metadataStatusHeight:25,rawOutputHeight:0,outputTotalHeight:0,outputStatusHeight:25,outputMetadataHeight:0,bodyMargin:32,totalHeight:82+p+g,layoutState:O.Uninitialized},this.cellFoldingState=i?.getTextBufferHash()!==e?.getTextBufferHash()?0:1,this.metadataFoldingState=1,this.outputFoldingState=1,this._register(this.editorEventDispatcher.onDidChangeLayout(m=>this._layoutInfoEmitter.fire({outerWidth:!0})))}cellFoldingState;metadataFoldingState;outputFoldingState;_stateChangeEmitter=this._register(new y);onDidStateChange=this._stateChangeEmitter.event;_layoutInfo;displayIconToHideUnmodifiedCells;_hideUnchangedCells=this._register(new y);onHideUnchangedCells=this._hideUnchangedCells.event;hideUnchangedCells(){this._hideUnchangedCells.fire()}set rawOutputHeight(t){this._layout({rawOutputHeight:Math.min(v,t)})}get rawOutputHeight(){throw new Error("Use Cell.layoutInfo.rawOutputHeight")}set outputStatusHeight(t){this._layout({outputStatusHeight:t})}get outputStatusHeight(){throw new Error("Use Cell.layoutInfo.outputStatusHeight")}set outputMetadataHeight(t){this._layout({outputMetadataHeight:t})}get outputMetadataHeight(){throw new Error("Use Cell.layoutInfo.outputStatusHeight")}set editorHeight(t){this._layout({editorHeight:t})}get editorHeight(){throw new Error("Use Cell.layoutInfo.editorHeight")}set editorMargin(t){this._layout({editorMargin:t})}get editorMargin(){throw new Error("Use Cell.layoutInfo.editorMargin")}set metadataStatusHeight(t){this._layout({metadataStatusHeight:t})}get metadataStatusHeight(){throw new Error("Use Cell.layoutInfo.outputStatusHeight")}set metadataHeight(t){this._layout({metadataHeight:t})}get metadataHeight(){throw new Error("Use Cell.layoutInfo.metadataHeight")}_renderOutput=!0;set renderOutput(t){this._renderOutput=t,this._layout({recomputeOutput:!0}),this._stateChangeEmitter.fire({renderOutput:this._renderOutput})}get renderOutput(){return this._renderOutput}get layoutInfo(){return this._layoutInfo}get totalHeight(){return this.layoutInfo.totalHeight}get ignoreOutputs(){return this.configurationService.getValue("notebook.diff.ignoreOutputs")||!!this.mainDocumentTextModel?.transientOptions.transientOutputs}_sourceEditorViewState=null;_outputEditorViewState=null;_metadataEditorViewState=null;original;modified;layoutChange(){this._layout({recomputeOutput:!0})}_estimateEditorHeight(t){const e=t?.lineHeight??17;switch(this.type){case"unchanged":case"insert":return this.modified.textModel.textBuffer.getLineCount()*e+S.top+S.bottom;case"delete":case"modified":return this.original.textModel.textBuffer.getLineCount()*e+S.top+S.bottom}}_layout(t){const e=t.width!==void 0?t.width:this._layoutInfo.width,i=t.editorHeight!==void 0?t.editorHeight:this._layoutInfo.editorHeight,a=t.editorMargin!==void 0?t.editorMargin:this._layoutInfo.editorMargin,u=t.metadataHeight!==void 0?t.metadataHeight:this._layoutInfo.metadataHeight,r=t.cellStatusHeight!==void 0?t.cellStatusHeight:this._layoutInfo.cellStatusHeight,d=t.metadataStatusHeight!==void 0?t.metadataStatusHeight:this._layoutInfo.metadataStatusHeight,l=t.rawOutputHeight!==void 0?t.rawOutputHeight:this._layoutInfo.rawOutputHeight,g=t.outputStatusHeight!==void 0?t.outputStatusHeight:this._layoutInfo.outputStatusHeight,p=t.bodyMargin!==void 0?t.bodyMargin:this._layoutInfo.bodyMargin,m=t.outputMetadataHeight!==void 0?t.outputMetadataHeight:this._layoutInfo.outputMetadataHeight,I=this.ignoreOutputs?0:t.recomputeOutput||t.rawOutputHeight!==void 0||t.outputMetadataHeight!==void 0?this._getOutputTotalHeight(l,m):this._layoutInfo.outputTotalHeight,H=i+a+r+u+d+I+g+p,s={width:e,editorHeight:i,editorMargin:a,metadataHeight:u,cellStatusHeight:r,metadataStatusHeight:d,outputTotalHeight:I,outputStatusHeight:g,bodyMargin:p,rawOutputHeight:l,outputMetadataHeight:m,totalHeight:H,layoutState:O.Measured};let h=!1;const f={};s.width!==this._layoutInfo.width&&(f.width=!0,h=!0),s.editorHeight!==this._layoutInfo.editorHeight&&(f.editorHeight=!0,h=!0),s.editorMargin!==this._layoutInfo.editorMargin&&(f.editorMargin=!0,h=!0),s.metadataHeight!==this._layoutInfo.metadataHeight&&(f.metadataHeight=!0,h=!0),s.cellStatusHeight!==this._layoutInfo.cellStatusHeight&&(f.cellStatusHeight=!0,h=!0),s.metadataStatusHeight!==this._layoutInfo.metadataStatusHeight&&(f.metadataStatusHeight=!0,h=!0),s.outputTotalHeight!==this._layoutInfo.outputTotalHeight&&(f.outputTotalHeight=!0,h=!0),s.outputStatusHeight!==this._layoutInfo.outputStatusHeight&&(f.outputStatusHeight=!0,h=!0),s.bodyMargin!==this._layoutInfo.bodyMargin&&(f.bodyMargin=!0,h=!0),s.outputMetadataHeight!==this._layoutInfo.outputMetadataHeight&&(f.outputMetadataHeight=!0,h=!0),s.totalHeight!==this._layoutInfo.totalHeight&&(f.totalHeight=!0,h=!0),h&&(this._layoutInfo=s,this._fireLayoutChangeEvent(f))}getHeight(t){if(this._layoutInfo.layoutState===O.Uninitialized){const e=this.cellFoldingState===1?0:this.estimateEditorHeight(t);return this._computeTotalHeight(e)}else return this._layoutInfo.totalHeight}_computeTotalHeight(t){return t+this._layoutInfo.editorMargin+this._layoutInfo.metadataHeight+this._layoutInfo.cellStatusHeight+this._layoutInfo.metadataStatusHeight+this._layoutInfo.outputTotalHeight+this._layoutInfo.outputStatusHeight+this._layoutInfo.outputMetadataHeight+this._layoutInfo.bodyMargin}estimateEditorHeight(t=20){return Math.max(this.original?.textModel.textBuffer.getLineCount()??1,this.modified?.textModel.textBuffer.getLineCount()??1)*t+24+12+0}_getOutputTotalHeight(t,e){return this.outputFoldingState===1?0:this.renderOutput?this.isOutputEmpty()?24:this.getRichOutputTotalHeight()+e:t}_fireLayoutChangeEvent(t){this._layoutInfoEmitter.fire(t),this.editorEventDispatcher.emit([{type:x.CellLayoutChanged,source:this._layoutInfo}])}getComputedCellContainerWidth(t,e,i){return i?t.width-2*C+(e?b.ENTIRE_DIFF_OVERVIEW_WIDTH:0)-2:(t.width-2*C+(e?b.ENTIRE_DIFF_OVERVIEW_WIDTH:0))/2-18-2}getOutputEditorViewState(){return this._outputEditorViewState}saveOutputEditorViewState(t){this._outputEditorViewState=t}getMetadataEditorViewState(){return this._metadataEditorViewState}saveMetadataEditorViewState(t){this._metadataEditorViewState=t}getSourceEditorViewState(){return this._sourceEditorViewState}saveSpirceEditorViewState(t){this._sourceEditorViewState=t}}class ct extends D{constructor(t,e,i,a,u,r,d,l,g){super(t,i,a,u,r,d,l,g);this.otherDocumentTextModel=e;this.type=u,this.cellFoldingState=this.modified.textModel.getValue()!==this.original.textModel.getValue()?0:1,this.metadataFoldingState=1,this.outputFoldingState=1,this.checkMetadataIfModified()&&(this.metadataFoldingState=0),this.checkIfOutputsModified()&&(this.outputFoldingState=0),this._register(this.original.onDidChangeOutputLayout(()=>{this._layout({recomputeOutput:!0})})),this._register(this.modified.onDidChangeOutputLayout(()=>{this._layout({recomputeOutput:!0})})),this._register(this.modified.textModel.onDidChangeContent(()=>{if(t.transientOptions.cellContentMetadata){const p=[...Object.keys(t.transientOptions.cellContentMetadata)],m=Object.assign({},this.modified.metadata),I=this.original.metadata;for(const H of p)H in I&&(m[H]=I[H]);this.modified.textModel.metadata=m}}))}get originalDocument(){return this.otherDocumentTextModel}get modifiedDocument(){return this.mainDocumentTextModel}original;modified;type;checkIfInputModified(){return this.original.textModel.getTextBufferHash()===this.modified.textModel.getTextBufferHash()?!1:{reason:"Cell content has changed"}}checkIfOutputsModified(){if(this.mainDocumentTextModel.transientOptions.transientOutputs)return!1;const t=N(this.original?.outputs??[],this.modified?.outputs??[]);return t===0?!1:{reason:t===1?"Output metadata has changed":void 0,kind:t}}checkMetadataIfModified(){return c(w(this.mainDocumentTextModel.transientOptions.transientCellMetadata,this.original?.metadata||{},this.original?.language))!==c(w(this.mainDocumentTextModel.transientOptions.transientCellMetadata,this.modified?.metadata??{},this.modified?.language))?{reason:void 0}:!1}updateOutputHeight(t,e,i){t===M.Original?this.original.updateOutputHeight(e,i):this.modified.updateOutputHeight(e,i)}getOutputOffsetInContainer(t,e){return t===M.Original?this.original.getOutputOffset(e):this.modified.getOutputOffset(e)}getOutputOffsetInCell(t,e){const i=this.getOutputOffsetInContainer(t,e);return this._layoutInfo.editorHeight+this._layoutInfo.editorMargin+this._layoutInfo.metadataHeight+this._layoutInfo.cellStatusHeight+this._layoutInfo.metadataStatusHeight+this._layoutInfo.outputStatusHeight+this._layoutInfo.bodyMargin/2+i}isOutputEmpty(){return this.mainDocumentTextModel.transientOptions.transientOutputs?!0:this.checkIfOutputsModified()?!1:(this.original?.outputs||[]).length===0}getRichOutputTotalHeight(){return Math.max(this.original.getOutputTotalHeight(),this.modified.getOutputTotalHeight())}getNestedCellViewModel(t){return t===M.Original?this.original:this.modified}getCellByUri(t){return t.toString()===this.original.uri.toString()?this.original:this.modified}}class It extends D{constructor(t,e,i,a,u,r,d,l,g){super(t,i,a,u,r,d,l,g);this.otherDocumentTextModel=e;this.type=u,this._register(this.cellViewModel.onDidChangeOutputLayout(()=>{this._layout({recomputeOutput:!0})}))}get cellViewModel(){return this.type==="insert"?this.modified:this.original}get originalDocument(){return this.type==="insert"?this.otherDocumentTextModel:this.mainDocumentTextModel}get modifiedDocument(){return this.type==="insert"?this.mainDocumentTextModel:this.otherDocumentTextModel}type;checkIfInputModified(){return{reason:"Cell content has changed"}}getNestedCellViewModel(t){return this.type==="insert"?this.modified:this.original}checkIfOutputsModified(){return!1}checkMetadataIfModified(){return!1}updateOutputHeight(t,e,i){this.cellViewModel?.updateOutputHeight(e,i)}getOutputOffsetInContainer(t,e){return this.cellViewModel.getOutputOffset(e)}getOutputOffsetInCell(t,e){const i=this.cellViewModel.getOutputOffset(e);return this._layoutInfo.editorHeight+this._layoutInfo.editorMargin+this._layoutInfo.metadataHeight+this._layoutInfo.cellStatusHeight+this._layoutInfo.metadataStatusHeight+this._layoutInfo.outputStatusHeight+this._layoutInfo.bodyMargin/2+i}isOutputEmpty(){return this.mainDocumentTextModel.transientOptions.transientOutputs?!0:(this.original?.outputs||this.modified?.outputs||[]).length===0}getRichOutputTotalHeight(){return this.cellViewModel?.getOutputTotalHeight()??0}getCellByUri(t){return this.cellViewModel}}var k=(e=>(e[e.Unchanged=0]="Unchanged",e[e.Metadata=1]="Metadata",e[e.Other=2]="Other",e))(k||{});function Ht(o,n){if(c(o.metadata)===c(n.metadata))return 2;for(let t=0;t<o.outputs.length;t++){const e=o.outputs[t],i=n.outputs[t];if(e.mime!==i.mime||e.data.buffer.length!==i.data.buffer.length)return 2;for(let a=0;a<e.data.buffer.length;a++)if(e.data.buffer[a]!==i.data.buffer[a])return 2}return 1}function N(o,n){if(o.length!==n.length)return 2;const t=o.length;for(let e=0;e<t;e++){const i=o[e],a=n[e];if(c(i.metadata)!==c(a.metadata))return 1;if(i.outputs.length!==a.outputs.length)return 2;for(let u=0;u<i.outputs.length;u++){const r=i.outputs[u],d=a.outputs[u];if(r.mime!==d.mime||r.data.buffer.length!==d.data.buffer.length)return 2;for(let l=0;l<r.data.buffer.length;l++)if(r.data.buffer[l]!==d.data.buffer[l])return 2}}return 0}function F(o){if(!o.length)return null;const t=o[0].mime;return o.find(i=>i.mime!==t)?null:o.map(i=>i.data.toString()).join("")}function yt(o){if(o.length===1){const n=F(o[0].outputs);if(n)return n}return JSON.stringify(o.map(n=>({metadata:n.metadata,outputItems:n.outputs.map(t=>({mimeType:t.mime,data:t.data.toString()}))})),void 0,"	")}export{D as DiffElementCellViewModelBase,mt as DiffElementPlaceholderViewModel,E as DiffElementViewModelBase,v as OUTPUT_EDITOR_HEIGHT_MAGIC,k as OutputComparison,T as PropertyFoldingState,ct as SideBySideDiffElementViewModel,It as SingleSideDiffElementViewModel,yt as getFormattedOutputJSON,F as getStreamOutputData,Ht as outputEqual};
