import{Emitter as C}from"../../../../../base/common/event.js";import{hash as H}from"../../../../../base/common/hash.js";import{Disposable as N}from"../../../../../base/common/lifecycle.js";import"../../../../../base/common/uri.js";import{DiffEditorWidget as S}from"../../../../../editor/browser/widget/diffEditor/diffEditorWidget.js";import"../../../../../editor/common/config/fontInfo.js";import"../../../../../editor/common/editorCommon.js";import{getEditorPadding as b}from"./diffCellEditorOptions.js";import{DiffNestedCellViewModel as O}from"./diffNestedCellViewModel.js";import{NotebookDiffViewEventType as D}from"./eventDispatcher.js";import{DIFF_CELL_MARGIN as y,DiffSide as E}from"./notebookDiffEditorBrowser.js";import{CellLayoutState as I}from"../notebookBrowser.js";import"../notebookViewEvents.js";import{getFormattedMetadataJSON as V}from"../../common/model/notebookCellTextModel.js";import"../../common/model/notebookTextModel.js";import{CellUri as x}from"../../common/notebookCommon.js";import"../../common/notebookService.js";import"../../../../../platform/configuration/common/configuration.js";import{Schemas as v}from"../../../../../base/common/network.js";import"./editorHeightCalculator.js";import{NotebookDocumentMetadataTextModel as T}from"../../common/model/notebookMetadataTextModel.js";const _=25,bt=24,_t=17;var F=(t=>(t[t.Expanded=0]="Expanded",t[t.Collapsed=1]="Collapsed",t))(F||{});const L=1440;class w extends N{constructor(t,e,i){super();this.mainDocumentTextModel=t;this.editorEventDispatcher=e;this.initData=i;this._register(this.editorEventDispatcher.onDidChangeLayout(o=>this._layoutInfoEmitter.fire({outerWidth:!0})))}_layoutInfoEmitter=this._register(new C);onDidLayoutChange=this._layoutInfoEmitter.event}class Et extends w{type="placeholder";hiddenCells=[];_unfoldHiddenCells=this._register(new C);onUnfoldHiddenCells=this._unfoldHiddenCells.event;renderOutput=!1;constructor(r,t,e){super(r,t,e)}get totalHeight(){return 24+2*y}getHeight(r){return this.totalHeight}layoutChange(){}showHiddenCells(){this._unfoldHiddenCells.fire()}}class wt extends w{constructor(t,e,i,o,u,d,l){super(t,o,u);this.originalDocumentTextModel=t;this.modifiedDocumentTextModel=e;this.type=i;this.editorHeightCalculator=l;const a=_;this._layoutInfo={width:0,editorHeight:0,editorMargin:0,metadataHeight:0,cellStatusHeight:a,metadataStatusHeight:0,rawOutputHeight:0,outputTotalHeight:0,outputStatusHeight:0,outputMetadataHeight:0,bodyMargin:32,totalHeight:82+a+0,layoutState:I.Uninitialized},this.cellFoldingState=i==="modifiedMetadata"?0:1,this.originalMetadata=this._register(new T(t)),this.modifiedMetadata=this._register(new T(e))}originalMetadata;modifiedMetadata;cellFoldingState;_layoutInfo;renderOutput=!1;set editorHeight(t){this._layout({editorHeight:t})}get editorHeight(){throw new Error("Use Cell.layoutInfo.editorHeight")}set editorMargin(t){this._layout({editorMargin:t})}get editorMargin(){throw new Error("Use Cell.layoutInfo.editorMargin")}get layoutInfo(){return this._layoutInfo}get totalHeight(){return this.layoutInfo.totalHeight}_sourceEditorViewState=null;async computeHeights(){if(this.type==="unchangedMetadata")this.editorHeight=this.editorHeightCalculator.computeHeightFromLines(this.originalMetadata.textBuffer.getLineCount());else{const t=this.originalMetadata.uri,e=this.modifiedMetadata.uri;this.editorHeight=await this.editorHeightCalculator.diffAndComputeHeight(t,e)}}layoutChange(){this._layout({recomputeOutput:!0})}_layout(t){const e=t.width!==void 0?t.width:this._layoutInfo.width,i=t.editorHeight!==void 0?t.editorHeight:this._layoutInfo.editorHeight,o=t.editorMargin!==void 0?t.editorMargin:this._layoutInfo.editorMargin,u=t.cellStatusHeight!==void 0?t.cellStatusHeight:this._layoutInfo.cellStatusHeight,d=t.bodyMargin!==void 0?t.bodyMargin:this._layoutInfo.bodyMargin,l=i+o+u+d,a={width:e,editorHeight:i,editorMargin:o,metadataHeight:0,cellStatusHeight:u,metadataStatusHeight:0,outputTotalHeight:0,outputStatusHeight:0,bodyMargin:d,rawOutputHeight:0,outputMetadataHeight:0,totalHeight:l,layoutState:I.Measured};let h=!1;const f={};a.width!==this._layoutInfo.width&&(f.width=!0,h=!0),a.editorHeight!==this._layoutInfo.editorHeight&&(f.editorHeight=!0,h=!0),a.editorMargin!==this._layoutInfo.editorMargin&&(f.editorMargin=!0,h=!0),a.cellStatusHeight!==this._layoutInfo.cellStatusHeight&&(f.cellStatusHeight=!0,h=!0),a.bodyMargin!==this._layoutInfo.bodyMargin&&(f.bodyMargin=!0,h=!0),a.totalHeight!==this._layoutInfo.totalHeight&&(f.totalHeight=!0,h=!0),h&&(this._layoutInfo=a,this._fireLayoutChangeEvent(f))}getHeight(t){if(this._layoutInfo.layoutState===I.Uninitialized){const e=this.cellFoldingState===1?0:this.computeInputEditorHeight(t);return this._computeTotalHeight(e)}else return this._layoutInfo.totalHeight}_computeTotalHeight(t){return t+this._layoutInfo.editorMargin+this._layoutInfo.metadataHeight+this._layoutInfo.cellStatusHeight+this._layoutInfo.metadataStatusHeight+this._layoutInfo.outputTotalHeight+this._layoutInfo.outputStatusHeight+this._layoutInfo.outputMetadataHeight+this._layoutInfo.bodyMargin}computeInputEditorHeight(t){return this.editorHeightCalculator.computeHeightFromLines(Math.max(this.originalMetadata.textBuffer.getLineCount(),this.modifiedMetadata.textBuffer.getLineCount()))}_fireLayoutChangeEvent(t){this._layoutInfoEmitter.fire(t),this.editorEventDispatcher.emit([{type:D.CellLayoutChanged,source:this._layoutInfo}])}getComputedCellContainerWidth(t,e,i){return i?t.width-2*y+(e?S.ENTIRE_DIFF_OVERVIEW_WIDTH:0)-2:(t.width-2*y+(e?S.ENTIRE_DIFF_OVERVIEW_WIDTH:0))/2-18-2}getSourceEditorViewState(){return this._sourceEditorViewState}saveSpirceEditorViewState(t){this._sourceEditorViewState=t}}class k extends w{constructor(t,e,i,o,u,d,l,a,h,f){super(t,u,d);this.type=o;this.index=a;this.configurationService=h;this.diffEditorHeightCalculator=f;this.original=e?this._register(new O(e,l)):void 0,this.modified=i?this._register(new O(i,l)):void 0;const m=this._estimateEditorHeight(d.fontInfo),c=_;this._layoutInfo={width:0,editorHeight:m,editorMargin:0,metadataHeight:0,cellStatusHeight:c,metadataStatusHeight:this.ignoreMetadata?0:_,rawOutputHeight:0,outputTotalHeight:0,outputStatusHeight:this.ignoreOutputs?0:_,outputMetadataHeight:0,bodyMargin:32,totalHeight:82+c+m,layoutState:I.Uninitialized},this.cellFoldingState=i?.getTextBufferHash()!==e?.getTextBufferHash()?0:1,this.metadataFoldingState=1,this.outputFoldingState=1}cellFoldingState;metadataFoldingState;outputFoldingState;_stateChangeEmitter=this._register(new C);onDidStateChange=this._stateChangeEmitter.event;_layoutInfo;displayIconToHideUnmodifiedCells;_hideUnchangedCells=this._register(new C);onHideUnchangedCells=this._hideUnchangedCells.event;hideUnchangedCells(){this._hideUnchangedCells.fire()}set rawOutputHeight(t){this._layout({rawOutputHeight:Math.min(L,t)})}get rawOutputHeight(){throw new Error("Use Cell.layoutInfo.rawOutputHeight")}set outputStatusHeight(t){this._layout({outputStatusHeight:t})}get outputStatusHeight(){throw new Error("Use Cell.layoutInfo.outputStatusHeight")}set outputMetadataHeight(t){this._layout({outputMetadataHeight:t})}get outputMetadataHeight(){throw new Error("Use Cell.layoutInfo.outputStatusHeight")}set editorHeight(t){this._layout({editorHeight:t})}get editorHeight(){throw new Error("Use Cell.layoutInfo.editorHeight")}set editorMargin(t){this._layout({editorMargin:t})}get editorMargin(){throw new Error("Use Cell.layoutInfo.editorMargin")}set metadataStatusHeight(t){this._layout({metadataStatusHeight:t})}get metadataStatusHeight(){throw new Error("Use Cell.layoutInfo.outputStatusHeight")}set metadataHeight(t){this._layout({metadataHeight:t})}get metadataHeight(){throw new Error("Use Cell.layoutInfo.metadataHeight")}_renderOutput=!0;set renderOutput(t){this._renderOutput=t,this._layout({recomputeOutput:!0}),this._stateChangeEmitter.fire({renderOutput:this._renderOutput})}get renderOutput(){return this._renderOutput}get layoutInfo(){return this._layoutInfo}get totalHeight(){return this.layoutInfo.totalHeight}get ignoreOutputs(){return this.configurationService.getValue("notebook.diff.ignoreOutputs")||!!this.mainDocumentTextModel?.transientOptions.transientOutputs}get ignoreMetadata(){return this.configurationService.getValue("notebook.diff.ignoreMetadata")}_sourceEditorViewState=null;_outputEditorViewState=null;_metadataEditorViewState=null;original;modified;layoutChange(){this._layout({recomputeOutput:!0})}_estimateEditorHeight(t){const e=t?.lineHeight??17;switch(this.type){case"unchanged":case"insert":{const i=this.modified.textModel.textBuffer.getLineCount();return i*e+b(i).top+b(i).bottom}case"delete":case"modified":{const i=this.original.textModel.textBuffer.getLineCount();return i*e+b(i).top+b(i).bottom}}}_layout(t){const e=t.width!==void 0?t.width:this._layoutInfo.width,i=t.editorHeight!==void 0?t.editorHeight:this._layoutInfo.editorHeight,o=t.editorMargin!==void 0?t.editorMargin:this._layoutInfo.editorMargin,u=t.metadataHeight!==void 0?t.metadataHeight:this._layoutInfo.metadataHeight,d=t.cellStatusHeight!==void 0?t.cellStatusHeight:this._layoutInfo.cellStatusHeight,l=t.metadataStatusHeight!==void 0?t.metadataStatusHeight:this._layoutInfo.metadataStatusHeight,a=t.rawOutputHeight!==void 0?t.rawOutputHeight:this._layoutInfo.rawOutputHeight,h=t.outputStatusHeight!==void 0?t.outputStatusHeight:this._layoutInfo.outputStatusHeight,f=t.bodyMargin!==void 0?t.bodyMargin:this._layoutInfo.bodyMargin,m=t.outputMetadataHeight!==void 0?t.outputMetadataHeight:this._layoutInfo.outputMetadataHeight,c=this.ignoreOutputs?0:t.recomputeOutput||t.rawOutputHeight!==void 0||t.outputMetadataHeight!==void 0?this._getOutputTotalHeight(a,m):this._layoutInfo.outputTotalHeight,M=i+o+d+u+l+c+h+f,g={width:e,editorHeight:i,editorMargin:o,metadataHeight:u,cellStatusHeight:d,metadataStatusHeight:l,outputTotalHeight:c,outputStatusHeight:h,bodyMargin:f,rawOutputHeight:a,outputMetadataHeight:m,totalHeight:M,layoutState:I.Measured};let s=!1;const p={};g.width!==this._layoutInfo.width&&(p.width=!0,s=!0),g.editorHeight!==this._layoutInfo.editorHeight&&(p.editorHeight=!0,s=!0),g.editorMargin!==this._layoutInfo.editorMargin&&(p.editorMargin=!0,s=!0),g.metadataHeight!==this._layoutInfo.metadataHeight&&(p.metadataHeight=!0,s=!0),g.cellStatusHeight!==this._layoutInfo.cellStatusHeight&&(p.cellStatusHeight=!0,s=!0),g.metadataStatusHeight!==this._layoutInfo.metadataStatusHeight&&(p.metadataStatusHeight=!0,s=!0),g.outputTotalHeight!==this._layoutInfo.outputTotalHeight&&(p.outputTotalHeight=!0,s=!0),g.outputStatusHeight!==this._layoutInfo.outputStatusHeight&&(p.outputStatusHeight=!0,s=!0),g.bodyMargin!==this._layoutInfo.bodyMargin&&(p.bodyMargin=!0,s=!0),g.outputMetadataHeight!==this._layoutInfo.outputMetadataHeight&&(p.outputMetadataHeight=!0,s=!0),g.totalHeight!==this._layoutInfo.totalHeight&&(p.totalHeight=!0,s=!0),s&&(this._layoutInfo=g,this._fireLayoutChangeEvent(p))}getHeight(t){if(this._layoutInfo.layoutState===I.Uninitialized){const e=this.cellFoldingState===1?0:this.computeInputEditorHeight(t);return this._computeTotalHeight(e)}else return this._layoutInfo.totalHeight}_computeTotalHeight(t){return t+this._layoutInfo.editorMargin+this._layoutInfo.metadataHeight+this._layoutInfo.cellStatusHeight+this._layoutInfo.metadataStatusHeight+this._layoutInfo.outputTotalHeight+this._layoutInfo.outputStatusHeight+this._layoutInfo.outputMetadataHeight+this._layoutInfo.bodyMargin}computeInputEditorHeight(t){const e=Math.max(this.original?.textModel.textBuffer.getLineCount()??1,this.modified?.textModel.textBuffer.getLineCount()??1);return this.diffEditorHeightCalculator.computeHeightFromLines(e)}_getOutputTotalHeight(t,e){return this.outputFoldingState===1?0:this.renderOutput?this.isOutputEmpty()?24:this.getRichOutputTotalHeight()+e:t}_fireLayoutChangeEvent(t){this._layoutInfoEmitter.fire(t),this.editorEventDispatcher.emit([{type:D.CellLayoutChanged,source:this._layoutInfo}])}getComputedCellContainerWidth(t,e,i){return i?t.width-2*y+(e?S.ENTIRE_DIFF_OVERVIEW_WIDTH:0)-2:(t.width-2*y+(e?S.ENTIRE_DIFF_OVERVIEW_WIDTH:0))/2-18-2}getOutputEditorViewState(){return this._outputEditorViewState}saveOutputEditorViewState(t){this._outputEditorViewState=t}getMetadataEditorViewState(){return this._metadataEditorViewState}saveMetadataEditorViewState(t){this._metadataEditorViewState=t}getSourceEditorViewState(){return this._sourceEditorViewState}saveSpirceEditorViewState(t){this._sourceEditorViewState=t}}class Ot extends k{constructor(t,e,i,o,u,d,l,a,h,f,m){super(t,i,o,u,d,l,a,f,h,m);this.otherDocumentTextModel=e;this.type=u,this.cellFoldingState=this.modified.textModel.getValue()!==this.original.textModel.getValue()?0:1,this.metadataFoldingState=1,this.outputFoldingState=1,this.checkMetadataIfModified()&&(this.metadataFoldingState=0),this.checkIfOutputsModified()&&(this.outputFoldingState=0),this._register(this.original.onDidChangeOutputLayout(()=>{this._layout({recomputeOutput:!0})})),this._register(this.modified.onDidChangeOutputLayout(()=>{this._layout({recomputeOutput:!0})})),this._register(this.modified.textModel.onDidChangeContent(()=>{if(t.transientOptions.cellContentMetadata){const c=[...Object.keys(t.transientOptions.cellContentMetadata)],M=Object.assign({},this.modified.metadata),g=this.original.metadata;for(const s of c)s in g&&(M[s]=g[s]);this.modified.textModel.metadata=M}}))}get originalDocument(){return this.otherDocumentTextModel}get modifiedDocument(){return this.mainDocumentTextModel}original;modified;type;editorHeightWithUnchangedLinesCollapsed;checkIfInputModified(){return this.original.textModel.getTextBufferHash()===this.modified.textModel.getTextBufferHash()?!1:{reason:"Cell content has changed"}}checkIfOutputsModified(){if(this.mainDocumentTextModel.transientOptions.transientOutputs)return!1;const t=P(this.original?.outputs??[],this.modified?.outputs??[]);return t===0?!1:{reason:t===1?"Output metadata has changed":void 0,kind:t}}checkMetadataIfModified(){return H(V(this.mainDocumentTextModel.transientOptions.transientCellMetadata,this.original?.metadata||{},this.original?.language))!==H(V(this.mainDocumentTextModel.transientOptions.transientCellMetadata,this.modified?.metadata??{},this.modified?.language))?{reason:void 0}:!1}updateOutputHeight(t,e,i){t===E.Original?this.original.updateOutputHeight(e,i):this.modified.updateOutputHeight(e,i)}getOutputOffsetInContainer(t,e){return t===E.Original?this.original.getOutputOffset(e):this.modified.getOutputOffset(e)}getOutputOffsetInCell(t,e){const i=this.getOutputOffsetInContainer(t,e);return this._layoutInfo.editorHeight+this._layoutInfo.editorMargin+this._layoutInfo.metadataHeight+this._layoutInfo.cellStatusHeight+this._layoutInfo.metadataStatusHeight+this._layoutInfo.outputStatusHeight+this._layoutInfo.bodyMargin/2+i}isOutputEmpty(){return this.mainDocumentTextModel.transientOptions.transientOutputs?!0:this.checkIfOutputsModified()?!1:(this.original?.outputs||[]).length===0}getRichOutputTotalHeight(){return Math.max(this.original.getOutputTotalHeight(),this.modified.getOutputTotalHeight())}getNestedCellViewModel(t){return t===E.Original?this.original:this.modified}getCellByUri(t){return t.toString()===this.original.uri.toString()?this.original:this.modified}computeInputEditorHeight(t){return this.type==="modified"&&typeof this.editorHeightWithUnchangedLinesCollapsed=="number"&&this.checkIfInputModified()?this.editorHeightWithUnchangedLinesCollapsed:super.computeInputEditorHeight(t)}async computeModifiedInputEditorHeight(){this.checkIfInputModified()&&(this.editorHeightWithUnchangedLinesCollapsed=this._layoutInfo.editorHeight=await this.diffEditorHeightCalculator.diffAndComputeHeight(this.original.uri,this.modified.uri))}async computeModifiedMetadataEditorHeight(){if(this.checkMetadataIfModified()){const t=x.generateCellPropertyUri(this.originalDocument.uri,this.original.handle,v.vscodeNotebookCellMetadata),e=x.generateCellPropertyUri(this.modifiedDocument.uri,this.modified.handle,v.vscodeNotebookCellMetadata);this._layoutInfo.metadataHeight=await this.diffEditorHeightCalculator.diffAndComputeHeight(t,e)}}async computeEditorHeights(){this.type!=="unchanged"&&await Promise.all([this.computeModifiedInputEditorHeight(),this.computeModifiedMetadataEditorHeight()])}}class Dt extends k{constructor(t,e,i,o,u,d,l,a,h,f,m){super(t,i,o,u,d,l,a,m,h,f);this.otherDocumentTextModel=e;this.type=u,this._register(this.cellViewModel.onDidChangeOutputLayout(()=>{this._layout({recomputeOutput:!0})}))}get cellViewModel(){return this.type==="insert"?this.modified:this.original}get originalDocument(){return this.type==="insert"?this.otherDocumentTextModel:this.mainDocumentTextModel}get modifiedDocument(){return this.type==="insert"?this.mainDocumentTextModel:this.otherDocumentTextModel}type;checkIfInputModified(){return{reason:"Cell content has changed"}}getNestedCellViewModel(t){return this.type==="insert"?this.modified:this.original}checkIfOutputsModified(){return!1}checkMetadataIfModified(){return!1}updateOutputHeight(t,e,i){this.cellViewModel?.updateOutputHeight(e,i)}getOutputOffsetInContainer(t,e){return this.cellViewModel.getOutputOffset(e)}getOutputOffsetInCell(t,e){const i=this.cellViewModel.getOutputOffset(e);return this._layoutInfo.editorHeight+this._layoutInfo.editorMargin+this._layoutInfo.metadataHeight+this._layoutInfo.cellStatusHeight+this._layoutInfo.metadataStatusHeight+this._layoutInfo.outputStatusHeight+this._layoutInfo.bodyMargin/2+i}isOutputEmpty(){return this.mainDocumentTextModel.transientOptions.transientOutputs?!0:(this.original?.outputs||this.modified?.outputs||[]).length===0}getRichOutputTotalHeight(){return this.cellViewModel?.getOutputTotalHeight()??0}getCellByUri(t){return this.cellViewModel}}var U=(e=>(e[e.Unchanged=0]="Unchanged",e[e.Metadata=1]="Metadata",e[e.Other=2]="Other",e))(U||{});function Vt(n,r){if(H(n.metadata)===H(r.metadata))return 2;for(let t=0;t<n.outputs.length;t++){const e=n.outputs[t],i=r.outputs[t];if(e.mime!==i.mime||e.data.buffer.length!==i.data.buffer.length)return 2;for(let o=0;o<e.data.buffer.length;o++)if(e.data.buffer[o]!==i.data.buffer[o])return 2}return 1}function P(n,r){if(n.length!==r.length)return 2;const t=n.length;for(let e=0;e<t;e++){const i=n[e],o=r[e];if(H(i.metadata)!==H(o.metadata))return 1;if(i.outputs.length!==o.outputs.length)return 2;for(let u=0;u<i.outputs.length;u++){const d=i.outputs[u],l=o.outputs[u];if(d.mime!==l.mime||d.data.buffer.length!==l.data.buffer.length)return 2;for(let a=0;a<d.data.buffer.length;a++)if(d.data.buffer[a]!==l.data.buffer[a])return 2}}return 0}function B(n){if(!n.length)return null;const t=n[0].mime;return n.find(i=>i.mime!==t)?null:n.map(i=>i.data.toString()).join("")}function xt(n){if(n.length===1){const r=B(n[0].outputs);if(r)return r}return JSON.stringify(n.map(r=>({metadata:r.metadata,outputItems:r.outputs.map(t=>({mimeType:t.mime,data:t.data.toString()}))})),void 0,"	")}export{_t as DefaultLineHeight,k as DiffElementCellViewModelBase,Et as DiffElementPlaceholderViewModel,w as DiffElementViewModelBase,bt as HeightOfHiddenLinesRegionInDiffEditor,wt as NotebookDocumentMetadataViewModel,L as OUTPUT_EDITOR_HEIGHT_MAGIC,U as OutputComparison,F as PropertyFoldingState,Ot as SideBySideDiffElementViewModel,Dt as SingleSideDiffElementViewModel,xt as getFormattedOutputJSON,B as getStreamOutputData,Vt as outputEqual};
