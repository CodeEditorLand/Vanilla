import{Emitter as H}from"../../../../../../vs/base/common/event.js";import{hash as c}from"../../../../../../vs/base/common/hash.js";import{toFormattedString as V}from"../../../../../../vs/base/common/jsonFormatter.js";import{Disposable as x}from"../../../../../../vs/base/common/lifecycle.js";import"../../../../../../vs/base/common/uri.js";import{DiffEditorWidget as b}from"../../../../../../vs/editor/browser/widget/diffEditor/diffEditorWidget.js";import"../../../../../../vs/editor/common/config/fontInfo.js";import"../../../../../../vs/editor/common/editorCommon.js";import{fixedEditorPadding as y}from"../../../../../../vs/workbench/contrib/notebook/browser/diff/diffCellEditorOptions.js";import{DiffNestedCellViewModel as O}from"../../../../../../vs/workbench/contrib/notebook/browser/diff/diffNestedCellViewModel.js";import{NotebookDiffViewEventType as T}from"../../../../../../vs/workbench/contrib/notebook/browser/diff/eventDispatcher.js";import{DIFF_CELL_MARGIN as S,DiffSide as C}from"../../../../../../vs/workbench/contrib/notebook/browser/diff/notebookDiffEditorBrowser.js";import{CellLayoutState as M}from"../../../../../../vs/workbench/contrib/notebook/browser/notebookBrowser.js";import"../../../../../../vs/workbench/contrib/notebook/browser/notebookViewEvents.js";import"../../../../../../vs/workbench/contrib/notebook/common/model/notebookCellTextModel.js";import"../../../../../../vs/workbench/contrib/notebook/common/model/notebookTextModel.js";import"../../../../../../vs/workbench/contrib/notebook/common/notebookCommon.js";import"../../../../../../vs/workbench/contrib/notebook/common/notebookService.js";var k=(t=>(t[t.Expanded=0]="Expanded",t[t.Collapsed=1]="Collapsed",t))(k||{});const v=1440;class _ extends x{constructor(t,e,i){super();this.mainDocumentTextModel=t;this.editorEventDispatcher=e;this.initData=i;this._register(this.editorEventDispatcher.onDidChangeLayout(n=>this._layoutInfoEmitter.fire({outerWidth:!0})))}_layoutInfoEmitter=this._register(new H);onDidLayoutChange=this._layoutInfoEmitter.event}class ct extends _{type="placeholder";hiddenCells=[];_unfoldHiddenCells=this._register(new H);onUnfoldHiddenCells=this._unfoldHiddenCells.event;constructor(a,t,e){super(a,t,e)}get totalHeight(){return 24+2*S}getHeight(a){return this.totalHeight}layoutChange(){}showHiddenCells(){this._unfoldHiddenCells.fire()}}class w extends _{constructor(t,e,i,n,u,d,r){super(t,u,d);this.type=n;this.original=e?this._register(new O(e,r)):void 0,this.modified=i?this._register(new O(i,r)):void 0;const l=this._estimateEditorHeight(d.fontInfo),g=25;this._layoutInfo={width:0,editorHeight:l,editorMargin:0,metadataHeight:0,cellStatusHeight:g,metadataStatusHeight:25,rawOutputHeight:0,outputTotalHeight:0,outputStatusHeight:25,outputMetadataHeight:0,bodyMargin:32,totalHeight:82+g+l,layoutState:M.Uninitialized},this.cellFoldingState=i?.textModel?.getValue()!==e?.textModel?.getValue()?0:1,this.metadataFoldingState=1,this.outputFoldingState=1,this._register(this.editorEventDispatcher.onDidChangeLayout(m=>this._layoutInfoEmitter.fire({outerWidth:!0})))}cellFoldingState;metadataFoldingState;outputFoldingState;_stateChangeEmitter=this._register(new H);onDidStateChange=this._stateChangeEmitter.event;_layoutInfo;displayIconToHideUnmodifiedCells;_hideUnchangedCells=this._register(new H);onHideUnchangedCells=this._hideUnchangedCells.event;hideUnchangedCells(){this._hideUnchangedCells.fire()}set rawOutputHeight(t){this._layout({rawOutputHeight:Math.min(v,t)})}get rawOutputHeight(){throw new Error("Use Cell.layoutInfo.rawOutputHeight")}set outputStatusHeight(t){this._layout({outputStatusHeight:t})}get outputStatusHeight(){throw new Error("Use Cell.layoutInfo.outputStatusHeight")}set outputMetadataHeight(t){this._layout({outputMetadataHeight:t})}get outputMetadataHeight(){throw new Error("Use Cell.layoutInfo.outputStatusHeight")}set editorHeight(t){this._layout({editorHeight:t})}get editorHeight(){throw new Error("Use Cell.layoutInfo.editorHeight")}set editorMargin(t){this._layout({editorMargin:t})}get editorMargin(){throw new Error("Use Cell.layoutInfo.editorMargin")}set metadataStatusHeight(t){this._layout({metadataStatusHeight:t})}get metadataStatusHeight(){throw new Error("Use Cell.layoutInfo.outputStatusHeight")}set metadataHeight(t){this._layout({metadataHeight:t})}get metadataHeight(){throw new Error("Use Cell.layoutInfo.metadataHeight")}_renderOutput=!0;set renderOutput(t){this._renderOutput=t,this._layout({recomputeOutput:!0}),this._stateChangeEmitter.fire({renderOutput:this._renderOutput})}get renderOutput(){return this._renderOutput}get layoutInfo(){return this._layoutInfo}get totalHeight(){return this.layoutInfo.totalHeight}_sourceEditorViewState=null;_outputEditorViewState=null;_metadataEditorViewState=null;original;modified;layoutChange(){this._layout({recomputeOutput:!0})}_estimateEditorHeight(t){const e=t?.lineHeight??17;switch(this.type){case"unchanged":case"insert":return this.modified.textModel.textBuffer.getLineCount()*e+y.top+y.bottom;case"delete":case"modified":return this.original.textModel.textBuffer.getLineCount()*e+y.top+y.bottom}}_layout(t){const e=t.width!==void 0?t.width:this._layoutInfo.width,i=t.editorHeight!==void 0?t.editorHeight:this._layoutInfo.editorHeight,n=t.editorMargin!==void 0?t.editorMargin:this._layoutInfo.editorMargin,u=t.metadataHeight!==void 0?t.metadataHeight:this._layoutInfo.metadataHeight,d=t.cellStatusHeight!==void 0?t.cellStatusHeight:this._layoutInfo.cellStatusHeight,r=t.metadataStatusHeight!==void 0?t.metadataStatusHeight:this._layoutInfo.metadataStatusHeight,l=t.rawOutputHeight!==void 0?t.rawOutputHeight:this._layoutInfo.rawOutputHeight,g=t.outputStatusHeight!==void 0?t.outputStatusHeight:this._layoutInfo.outputStatusHeight,m=t.bodyMargin!==void 0?t.bodyMargin:this._layoutInfo.bodyMargin,I=t.outputMetadataHeight!==void 0?t.outputMetadataHeight:this._layoutInfo.outputMetadataHeight,p=t.recomputeOutput||t.rawOutputHeight!==void 0||t.outputMetadataHeight!==void 0?this._getOutputTotalHeight(l,I):this._layoutInfo.outputTotalHeight,D=i+n+d+u+r+p+g+m,s={width:e,editorHeight:i,editorMargin:n,metadataHeight:u,cellStatusHeight:d,metadataStatusHeight:r,outputTotalHeight:p,outputStatusHeight:g,bodyMargin:m,rawOutputHeight:l,outputMetadataHeight:I,totalHeight:D,layoutState:M.Measured};let h=!1;const f={};s.width!==this._layoutInfo.width&&(f.width=!0,h=!0),s.editorHeight!==this._layoutInfo.editorHeight&&(f.editorHeight=!0,h=!0),s.editorMargin!==this._layoutInfo.editorMargin&&(f.editorMargin=!0,h=!0),s.metadataHeight!==this._layoutInfo.metadataHeight&&(f.metadataHeight=!0,h=!0),s.cellStatusHeight!==this._layoutInfo.cellStatusHeight&&(f.cellStatusHeight=!0,h=!0),s.metadataStatusHeight!==this._layoutInfo.metadataStatusHeight&&(f.metadataStatusHeight=!0,h=!0),s.outputTotalHeight!==this._layoutInfo.outputTotalHeight&&(f.outputTotalHeight=!0,h=!0),s.outputStatusHeight!==this._layoutInfo.outputStatusHeight&&(f.outputStatusHeight=!0,h=!0),s.bodyMargin!==this._layoutInfo.bodyMargin&&(f.bodyMargin=!0,h=!0),s.outputMetadataHeight!==this._layoutInfo.outputMetadataHeight&&(f.outputMetadataHeight=!0,h=!0),s.totalHeight!==this._layoutInfo.totalHeight&&(f.totalHeight=!0,h=!0),h&&(this._layoutInfo=s,this._fireLayoutChangeEvent(f))}getHeight(t){if(this._layoutInfo.layoutState===M.Uninitialized){const e=this.estimateEditorHeight(t);return this._computeTotalHeight(e)}else return this._layoutInfo.totalHeight}_computeTotalHeight(t){return t+this._layoutInfo.editorMargin+this._layoutInfo.metadataHeight+this._layoutInfo.cellStatusHeight+this._layoutInfo.metadataStatusHeight+this._layoutInfo.outputTotalHeight+this._layoutInfo.outputStatusHeight+this._layoutInfo.outputMetadataHeight+this._layoutInfo.bodyMargin}estimateEditorHeight(t=20){return Math.max(this.original?.textModel.textBuffer.getLineCount()??1,this.modified?.textModel.textBuffer.getLineCount()??1)*t+24+12+0}_getOutputTotalHeight(t,e){return this.outputFoldingState===1?0:this.renderOutput?this.isOutputEmpty()?24:this.getRichOutputTotalHeight()+e:t}_fireLayoutChangeEvent(t){this._layoutInfoEmitter.fire(t),this.editorEventDispatcher.emit([{type:T.CellLayoutChanged,source:this._layoutInfo}])}getComputedCellContainerWidth(t,e,i){return i?t.width-2*S+(e?b.ENTIRE_DIFF_OVERVIEW_WIDTH:0)-2:(t.width-2*S+(e?b.ENTIRE_DIFF_OVERVIEW_WIDTH:0))/2-18-2}getOutputEditorViewState(){return this._outputEditorViewState}saveOutputEditorViewState(t){this._outputEditorViewState=t}getMetadataEditorViewState(){return this._metadataEditorViewState}saveMetadataEditorViewState(t){this._metadataEditorViewState=t}getSourceEditorViewState(){return this._sourceEditorViewState}saveSpirceEditorViewState(t){this._sourceEditorViewState=t}}class It extends w{constructor(t,e,i,n,u,d,r,l){super(t,i,n,u,d,r,l);this.otherDocumentTextModel=e;this.type=u,this.cellFoldingState=this.modified.textModel.getValue()!==this.original.textModel.getValue()?0:1,this.metadataFoldingState=1,this.outputFoldingState=1,this.checkMetadataIfModified()&&(this.metadataFoldingState=0),this.checkIfOutputsModified()&&(this.outputFoldingState=0),this._register(this.original.onDidChangeOutputLayout(()=>{this._layout({recomputeOutput:!0})})),this._register(this.modified.onDidChangeOutputLayout(()=>{this._layout({recomputeOutput:!0})})),this._register(this.modified.textModel.onDidChangeContent(()=>{if(t.transientOptions.cellContentMetadata){const g=[...Object.keys(t.transientOptions.cellContentMetadata)],m=Object.assign({},this.modified.metadata),I=this.original.metadata;for(const p of g)p in I&&(m[p]=I[p]);this.modified.textModel.metadata=m}}))}get originalDocument(){return this.otherDocumentTextModel}get modifiedDocument(){return this.mainDocumentTextModel}original;modified;type;checkIfInputModified(){return this.original.textModel.getTextBufferHash()===this.modified.textModel.getTextBufferHash()?!1:{reason:"Cell content has changed"}}checkIfOutputsModified(){if(this.mainDocumentTextModel.transientOptions.transientOutputs)return!1;const t=F(this.original?.outputs??[],this.modified?.outputs??[]);return t===0?!1:{reason:t===1?"Output metadata is changed":void 0,kind:t}}checkMetadataIfModified(){return c(E(this.mainDocumentTextModel,this.original?.metadata||{},this.original?.language))!==c(E(this.mainDocumentTextModel,this.modified?.metadata??{},this.modified?.language))?{reason:void 0}:!1}updateOutputHeight(t,e,i){t===C.Original?this.original.updateOutputHeight(e,i):this.modified.updateOutputHeight(e,i)}getOutputOffsetInContainer(t,e){return t===C.Original?this.original.getOutputOffset(e):this.modified.getOutputOffset(e)}getOutputOffsetInCell(t,e){const i=this.getOutputOffsetInContainer(t,e);return this._layoutInfo.editorHeight+this._layoutInfo.editorMargin+this._layoutInfo.metadataHeight+this._layoutInfo.cellStatusHeight+this._layoutInfo.metadataStatusHeight+this._layoutInfo.outputStatusHeight+this._layoutInfo.bodyMargin/2+i}isOutputEmpty(){return this.mainDocumentTextModel.transientOptions.transientOutputs?!0:this.checkIfOutputsModified()?!1:(this.original?.outputs||[]).length===0}getRichOutputTotalHeight(){return Math.max(this.original.getOutputTotalHeight(),this.modified.getOutputTotalHeight())}getNestedCellViewModel(t){return t===C.Original?this.original:this.modified}getCellByUri(t){return t.toString()===this.original.uri.toString()?this.original:this.modified}}class Ht extends w{constructor(t,e,i,n,u,d,r,l){super(t,i,n,u,d,r,l);this.otherDocumentTextModel=e;this.type=u,this._register(this.cellViewModel.onDidChangeOutputLayout(()=>{this._layout({recomputeOutput:!0})}))}get cellViewModel(){return this.type==="insert"?this.modified:this.original}get originalDocument(){return this.type==="insert"?this.otherDocumentTextModel:this.mainDocumentTextModel}get modifiedDocument(){return this.type==="insert"?this.mainDocumentTextModel:this.otherDocumentTextModel}type;checkIfInputModified(){return{reason:"Cell content has changed"}}getNestedCellViewModel(t){return this.type==="insert"?this.modified:this.original}checkIfOutputsModified(){return!1}checkMetadataIfModified(){return!1}updateOutputHeight(t,e,i){this.cellViewModel?.updateOutputHeight(e,i)}getOutputOffsetInContainer(t,e){return this.cellViewModel.getOutputOffset(e)}getOutputOffsetInCell(t,e){const i=this.cellViewModel.getOutputOffset(e);return this._layoutInfo.editorHeight+this._layoutInfo.editorMargin+this._layoutInfo.metadataHeight+this._layoutInfo.cellStatusHeight+this._layoutInfo.metadataStatusHeight+this._layoutInfo.outputStatusHeight+this._layoutInfo.bodyMargin/2+i}isOutputEmpty(){return this.mainDocumentTextModel.transientOptions.transientOutputs?!0:(this.original?.outputs||this.modified?.outputs||[]).length===0}getRichOutputTotalHeight(){return this.cellViewModel?.getOutputTotalHeight()??0}getCellByUri(t){return this.cellViewModel}}var N=(e=>(e[e.Unchanged=0]="Unchanged",e[e.Metadata=1]="Metadata",e[e.Other=2]="Other",e))(N||{});function yt(o,a){if(c(o.metadata)===c(a.metadata))return 2;for(let t=0;t<o.outputs.length;t++){const e=o.outputs[t],i=a.outputs[t];if(e.mime!==i.mime||e.data.buffer.length!==i.data.buffer.length)return 2;for(let n=0;n<e.data.buffer.length;n++)if(e.data.buffer[n]!==i.data.buffer[n])return 2}return 1}function F(o,a){if(o.length!==a.length)return 2;const t=o.length;for(let e=0;e<t;e++){const i=o[e],n=a[e];if(c(i.metadata)!==c(n.metadata))return 1;if(i.outputs.length!==n.outputs.length)return 2;for(let u=0;u<i.outputs.length;u++){const d=i.outputs[u],r=n.outputs[u];if(d.mime!==r.mime||d.data.buffer.length!==r.data.buffer.length)return 2;for(let l=0;l<d.data.buffer.length;l++)if(d.data.buffer[l]!==r.data.buffer[l])return 2}}return 0}function E(o,a,t){let e={};if(o){const u=o.transientOptions.transientCellMetadata,d=new Set([...Object.keys(a)]);for(const r of d)u[r]||(e[r]=a[r])}else e=a;const i={language:t,...e};return V(i,{})}function L(o){if(!o.length)return null;const t=o[0].mime;return o.find(i=>i.mime!==t)?null:o.map(i=>i.data.toString()).join("")}function St(o){if(o.length===1){const a=L(o[0].outputs);if(a)return a}return JSON.stringify(o.map(a=>({metadata:a.metadata,outputItems:a.outputs.map(t=>({mimeType:t.mime,data:t.data.toString()}))})),void 0,"	")}export{w as DiffElementCellViewModelBase,ct as DiffElementPlaceholderViewModel,_ as DiffElementViewModelBase,v as OUTPUT_EDITOR_HEIGHT_MAGIC,N as OutputComparison,k as PropertyFoldingState,It as SideBySideDiffElementViewModel,Ht as SingleSideDiffElementViewModel,E as getFormattedMetadataJSON,St as getFormattedOutputJSON,L as getStreamOutputData,yt as outputEqual};
