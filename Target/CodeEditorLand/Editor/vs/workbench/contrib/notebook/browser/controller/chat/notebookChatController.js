var F=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var I=(C,r,e,t)=>{for(var i=t>1?void 0:t?A(r,e):r,o=C.length-1,s;o>=0;o--)(s=C[o])&&(i=(t?s(r,e,i):s(i))||i);return t&&i&&F(r,e,i),i},p=(C,r)=>(e,t)=>r(e,t,C);import{Dimension as H,WindowIntervalTimer as U,getWindow as S,scheduleAtNextAnimationFrame as x,trackFocus as L}from"../../../../../../base/browser/dom.js";import{DeferredPromise as V,Queue as R,createCancelablePromise as K,disposableTimeout as q}from"../../../../../../base/common/async.js";import{CancellationTokenSource as M}from"../../../../../../base/common/cancellation.js";import{Emitter as Z}from"../../../../../../base/common/event.js";import{Disposable as T,DisposableStore as v,MutableDisposable as B,toDisposable as P}from"../../../../../../base/common/lifecycle.js";import{LRUCache as G}from"../../../../../../base/common/map.js";import{Schemas as $}from"../../../../../../base/common/network.js";import{MovingAverage as X}from"../../../../../../base/common/numbers.js";import{isEqual as O}from"../../../../../../base/common/resources.js";import{StopWatch as Q}from"../../../../../../base/common/stopwatch.js";import{assertType as m}from"../../../../../../base/common/types.js";import{URI as J}from"../../../../../../base/common/uri.js";import"../../../../../../editor/browser/editorBrowser.js";import{CodeEditorWidget as j}from"../../../../../../editor/browser/widget/codeEditor/codeEditorWidget.js";import"../../../../../../editor/common/core/editOperation.js";import"../../../../../../editor/common/core/position.js";import{Selection as z}from"../../../../../../editor/common/core/selection.js";import{TextEdit as Y}from"../../../../../../editor/common/languages.js";import{ILanguageService as ee}from"../../../../../../editor/common/languages/language.js";import"../../../../../../editor/common/model.js";import{IEditorWorkerService as te}from"../../../../../../editor/common/services/editorWorker.js";import{IModelService as ie}from"../../../../../../editor/common/services/model.js";import{localize as D}from"../../../../../../nls.js";import{IContextKeyService as oe}from"../../../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as se}from"../../../../../../platform/instantiation/common/instantiation.js";import{IStorageService as ne,StorageScope as W,StorageTarget as re}from"../../../../../../platform/storage/common/storage.js";import{ChatAgentLocation as k}from"../../../../chat/common/chatAgents.js";import"../../../../chat/common/chatModel.js";import{IChatService as de}from"../../../../chat/common/chatService.js";import{countWords as ae}from"../../../../chat/common/chatWordCounter.js";import"../../../../inlineChat/browser/inlineChatStrategies.js";import{InlineChatWidget as le}from"../../../../inlineChat/browser/inlineChatWidget.js";import{asProgressiveEdit as he,performAsyncTextEdit as ce}from"../../../../inlineChat/browser/utils.js";import{insertCell as ge,runDeleteAction as ue}from"../cellOperations.js";import{CTX_NOTEBOOK_CELL_CHAT_FOCUSED as _e,CTX_NOTEBOOK_CHAT_HAS_ACTIVE_REQUEST as pe,CTX_NOTEBOOK_CHAT_OUTER_FOCUS_POSITION as fe,CTX_NOTEBOOK_CHAT_USER_DID_EDIT as me,MENU_CELL_CHAT_WIDGET_STATUS as Ce}from"./notebookChatContext.js";import"../../notebookBrowser.js";import{registerNotebookContribution as Ee}from"../../notebookEditorExtensions.js";import{CellKind as be}from"../../../common/notebookCommon.js";import{INotebookExecutionStateService as we,NotebookExecutionType as ve}from"../../../common/notebookExecutionStateService.js";class ke extends T{constructor(e,t,i,o,s,n,a,h){super();this._notebookEditor=e;this.id=t;this.notebookViewZone=i;this.domNode=o;this.widgetContainer=s;this.inlineChatWidget=n;this.parentEditor=a;this._languageService=h;const c=()=>{this.heightInPx!==n.contentHeight&&(this.heightInPx=n.contentHeight,this._notebookEditor.changeViewZones(u=>{u.layoutZone(t)}),this._layoutWidget(n,s))};this._register(n.onDidChangeHeight(()=>{c()})),this._register(n.chatWidget.onDidChangeHeight(()=>{c()})),this.heightInPx=n.contentHeight,this._layoutWidget(n,s)}set afterModelPosition(e){this.notebookViewZone.afterModelPosition=e}get afterModelPosition(){return this.notebookViewZone.afterModelPosition}set heightInPx(e){this.notebookViewZone.heightInPx=e}get heightInPx(){return this.notebookViewZone.heightInPx}_editingCell=null;get editingCell(){return this._editingCell}layout(){this._layoutWidget(this.inlineChatWidget,this.widgetContainer)}restoreEditingCell(e){this._editingCell=e;const t=this._notebookEditor.deltaCellDecorations([],[{handle:this._editingCell.handle,options:{className:"nb-chatGenerationHighlight",outputClassName:"nb-chatGenerationHighlight"}}]);this._register(P(()=>{this._notebookEditor.deltaCellDecorations(t,[])}))}hasFocus(){return this.inlineChatWidget.hasFocus()}focus(){this.updateNotebookEditorFocusNSelections(),this.inlineChatWidget.focus()}updateNotebookEditorFocusNSelections(){this._notebookEditor.focusContainer(!0),this._notebookEditor.setFocus({start:this.afterModelPosition,end:this.afterModelPosition}),this._notebookEditor.setSelections([{start:this.afterModelPosition,end:this.afterModelPosition}])}getEditingCell(){return this._editingCell}async getOrCreateEditingCell(){if(this._editingCell){const o=this._notebookEditor.codeEditors.find(s=>s[0]===this._editingCell)?.[1];return o?.hasModel()?{cell:this._editingCell,editor:o}:void 0}if(!this._notebookEditor.hasModel())return;const e=this.inlineChatWidget.hasFocus();if(this._editingCell=ge(this._languageService,this._notebookEditor,this.afterModelPosition,be.Code,"above"),!this._editingCell)return;await this._notebookEditor.revealFirstLineIfOutsideViewport(this._editingCell);const t=this._notebookEditor.deltaCellDecorations([],[{handle:this._editingCell.handle,options:{className:"nb-chatGenerationHighlight",outputClassName:"nb-chatGenerationHighlight"}}]);this._register(P(()=>{this._notebookEditor.deltaCellDecorations(t,[])})),e&&this.focus();const i=this._notebookEditor.codeEditors.find(o=>o[0]===this._editingCell)?.[1];if(i?.hasModel())return{cell:this._editingCell,editor:i}}async discardChange(){this._notebookEditor.hasModel()&&this._editingCell&&ue(this._notebookEditor,this._editingCell)}_layoutWidget(e,t){const o=this._notebookEditor.notebookOptions.getLayoutConfiguration().cellRightMargin,s=this._notebookEditor.notebookOptions.getCellEditorContainerLeftMargin(),a=Math.min(640,this._notebookEditor.getLayoutInfo().width-s-o);e.layout(new H(a,this.heightInPx)),e.domNode.style.width=`${a}px`,t.style.left=`${s}px`}dispose(){this._notebookEditor.changeViewZones(e=>{e.removeZone(this.id)}),this.domNode.remove(),super.dispose()}}class y{static str(r){return`${r.viewType}/${r.uri.toString()}`}static obj(r){const e=r.indexOf("/");return{viewType:r.substring(0,e),uri:J.parse(r.substring(e+1))}}}let d=class extends T{constructor(e,t,i,o,s,n,a,h,c){super();this._notebookEditor=e;this._instantiationService=t;this._contextKeyService=i;this._editorWorkerService=o;this._modelService=s;this._languageService=n;this._executionStateService=a;this._storageService=h;this._chatService=c;this._ctxHasActiveRequest=pe.bindTo(this._contextKeyService),this._ctxCellWidgetFocused=_e.bindTo(this._contextKeyService),this._ctxUserDidEdit=me.bindTo(this._contextKeyService),this._ctxOuterFocusPosition=fe.bindTo(this._contextKeyService),this._registerFocusTracker(),d._promptHistory=JSON.parse(this._storageService.get(d._storageKey,W.PROFILE,"[]")),this._historyUpdate=u=>{const g=d._promptHistory.indexOf(u);g>=0&&d._promptHistory.splice(g,1),d._promptHistory.unshift(u),this._historyOffset=-1,this._historyCandidate="",this._storageService.store(d._storageKey,JSON.stringify(d._promptHistory),W.PROFILE,re.USER)}}static id="workbench.notebook.chatController";static counter=0;static get(e){return e.getContribution(d.id)}static _storageKey="inline-chat-history";static _promptHistory=[];_historyOffset=-1;_historyCandidate="";_historyUpdate;_promptCache=new G(1e3,.7);_onDidChangePromptCache=this._register(new Z);onDidChangePromptCache=this._onDidChangePromptCache.event;_strategy;_sessionCtor;_warmupRequestCts;_activeRequestCts;_ctxHasActiveRequest;_ctxCellWidgetFocused;_ctxUserDidEdit;_ctxOuterFocusPosition;_userEditingDisposables=this._register(new v);_widgetDisposableStore=this._register(new v);_focusTracker;_widget;_model=this._register(new B);_registerFocusTracker(){this._register(this._notebookEditor.onDidChangeFocus(()=>{if(!this._widget){this._ctxOuterFocusPosition.set("");return}const e=this._widget.afterModelPosition,t=this._notebookEditor.getFocus().start;t+1===e?this._ctxOuterFocusPosition.set("above"):t===e?this._ctxOuterFocusPosition.set("below"):this._ctxOuterFocusPosition.set("")}))}run(e,t,i){if(this._widget){if(this._widget.afterModelPosition!==e){const o=S(this._widget.domNode);this._disposeWidget(),x(o,()=>{this._createWidget(e,t,i,void 0)})}return}this._createWidget(e,t,i,void 0)}restore(e,t){if(!this._notebookEditor.hasModel())return;const i=this._notebookEditor.textModel.cells.indexOf(e.model);if(!(i<0)){if(this._widget){if(this._widget.afterModelPosition!==i){this._disposeWidget();const o=S(this._widget.domNode);x(o,()=>{this._createWidget(i,t,!1,e)})}return}this._createWidget(i,t,!1,e)}}_disposeWidget(){this._widget?.dispose(),this._widget=void 0,this._widgetDisposableStore.clear(),this._historyOffset=-1,this._historyCandidate=""}_createWidget(e,t,i,o){if(!this._notebookEditor.hasModel())return;this._widgetDisposableStore.clear();const s=document.createElement("div");s.classList.add("monaco-editor");const n=document.createElement("div");n.style.position="absolute",s.appendChild(n),this._focusTracker=this._widgetDisposableStore.add(L(s)),this._widgetDisposableStore.add(this._focusTracker.onDidFocus(()=>{this._updateNotebookEditorFocusNSelections()}));const a=document.createElement("div"),h=this._widgetDisposableStore.add(this._instantiationService.createInstance(j,a,{},{isSimpleWidget:!0})),c=`notebook-chat-input-${d.counter++}`,g=this._notebookEditor.textModel.uri.with({scheme:$.untitled,fragment:c}),_=this._modelService.createModel("",null,g,!1);h.setModel(_);const l=this._widgetDisposableStore.add(this._instantiationService.createInstance(le,{location:k.Notebook,resolveData:()=>{const f=this.getSessionInputUri();if(f)return{type:k.Notebook,sessionInputUri:f}}},{statusMenuId:Ce,chatWidgetViewOptions:{rendererOptions:{renderTextEditsAsSummary:f=>O(f,this._widget?.parentEditor.getModel()?.uri)||O(f,this._notebookEditor.textModel?.uri)},menus:{telemetrySource:"notebook-generate-cell"}}}));l.placeholder=D("default.placeholder","Ask a question"),l.updateInfo(D("welcome.1","AI-generated code may be incorrect")),n.appendChild(l.domNode),this._widgetDisposableStore.add(l.onDidChangeInput(()=>{this._warmupRequestCts?.dispose(!0),this._warmupRequestCts=void 0})),this._notebookEditor.changeViewZones(f=>{const b={afterModelPosition:e,heightInPx:80,domNode:s},w=f.addZone(b);this._scrollWidgetIntoView(e),this._widget=new ke(this._notebookEditor,w,b,s,n,l,h,this._languageService),o&&(this._widget.restoreEditingCell(o),this._updateUserEditingState()),this._ctxCellWidgetFocused.set(!0),q(()=>{this._focusWidget()},0,this._store),this._sessionCtor=K(async E=>{await this._startSession(E),m(this._model.value);const N=this._model.value;this._widget?.inlineChatWidget.setChatModel(N),h.hasModel()&&(this._widget&&this._focusWidget(),this._widget&&t&&(this._widget.inlineChatWidget.value=t,i&&this.acceptInput()))})})}async _startSession(e){if(!this._model.value&&(this._model.value=this._chatService.startSession(k.Editor,e),!this._model.value))throw new Error("Failed to start chat session");this._strategy=new ye}_scrollWidgetIntoView(e){if(e===0||this._notebookEditor.getLength()===0)this._notebookEditor.revealOffsetInCenterIfOutsideViewport(0);else{const t=this._notebookEditor.cellAt(Math.min(e-1,this._notebookEditor.getLength()-1));if(t){const i=this._notebookEditor.getAbsoluteTopOfElement(t),o=this._notebookEditor.getHeightOfElement(t);this._notebookEditor.revealOffsetInCenterIfOutsideViewport(i+o+48)}}}_focusWidget(){this._widget&&(this._updateNotebookEditorFocusNSelections(),this._widget.focus())}_updateNotebookEditorFocusNSelections(){this._widget&&this._widget.updateNotebookEditorFocusNSelections()}hasSession(e){return this._model.value===e}getSessionInputUri(){return this._widget?.parentEditor.getModel()?.uri}async acceptInput(){m(this._widget),await this._sessionCtor,m(this._model.value),m(this._strategy);const e=this._widget.inlineChatWidget.value;this._historyUpdate(e);const t=this._widget.parentEditor,i=t.getModel();if(!t.hasModel()||!i)return;this._widget.editingCell&&this._widget.editingCell.textBuffer.getLength()>0&&(await this._widget.editingCell.resolveTextModel()).setValue("");const o=this._widget.editingCell?this._notebookEditor.getCellIndex(this._widget.editingCell):void 0;o!==void 0?this._notebookEditor.setSelections([{start:o,end:o+1}]):this._notebookEditor.setSelections([{start:this._widget.afterModelPosition,end:this._widget.afterModelPosition}]),this._ctxHasActiveRequest.set(!0),this._activeRequestCts?.cancel(),this._activeRequestCts=new M;const s=new v;try{this._ctxHasActiveRequest.set(!0);const n=new R,a=Q.create(),h=new X,c=new M(this._activeRequestCts.token),u=new V,g=await this._widget.inlineChatWidget.chatWidget.acceptInput();if(g){let l=0;s.add(g.onDidChange(f=>{if(g.isCanceled){c.cancel(),u.complete();return}if(g.isComplete){u.complete();return}const b=g.response.value.map(E=>E.kind==="textEditGroup"?E.edits:[]).flat(),w=b.slice(l);w.length!==0&&(l=b.length,h.update(a.elapsed()),a.reset(),n.queue(async()=>{for(const E of w)await this._makeChanges(E,{duration:h.value,token:c.token})}))}))}await u.p,await n.whenIdle(),this._userEditingDisposables.clear();const _=this._widget.getEditingCell();_&&(this._userEditingDisposables.add(_.model.onDidChangeContent(()=>this._updateUserEditingState())),this._userEditingDisposables.add(_.model.onDidChangeLanguage(()=>this._updateUserEditingState())),this._userEditingDisposables.add(_.model.onDidChangeMetadata(()=>this._updateUserEditingState())),this._userEditingDisposables.add(_.model.onDidChangeInternalMetadata(()=>this._updateUserEditingState())),this._userEditingDisposables.add(_.model.onDidChangeOutputs(()=>this._updateUserEditingState())),this._userEditingDisposables.add(this._executionStateService.onDidChangeExecution(l=>{l.type===ve.cell&&l.affectsCell(_.uri)&&this._updateUserEditingState()})))}catch{}finally{s.dispose(),this._ctxHasActiveRequest.set(!1),this._widget.inlineChatWidget.updateInfo(""),this._widget.inlineChatWidget.updateToolbar(!0)}}async _makeChanges(e,t){m(this._strategy),m(this._widget);const i=await this._widget.getOrCreateEditingCell();if(!i)return;const o=i.editor,s=await this._editorWorkerService.computeMoreMinimalEdits(o.getModel().uri,e);if(s?.length===0)return;const a=(!t&&s?s:e).map(Y.asEditOperation);try{t?await this._strategy.makeProgressiveChanges(o,a,t):await this._strategy.makeChanges(o,a)}finally{}}_updateUserEditingState(){this._ctxUserDidEdit.set(!0)}async acceptSession(){if(m(this._model),m(this._strategy),!this._widget?.parentEditor?.hasModel())return;const t=this._widget?.getEditingCell();if(t&&this._notebookEditor.hasModel()){const i=y.str({uri:t.uri,viewType:this._notebookEditor.textModel.viewType});this._widget?.inlineChatWidget.value&&this._promptCache.set(i,this._widget.inlineChatWidget.value),this._onDidChangePromptCache.fire({cell:t.uri})}try{this._model.clear()}catch{}this.dismiss(!1)}async focusAbove(){if(!this._widget)return;const t=this._widget.afterModelPosition-1;if(t<0)return;const i=this._notebookEditor.cellAt(t);i&&await this._notebookEditor.focusNotebookCell(i,"editor")}async focusNext(){if(!this._widget)return;const e=this._widget.afterModelPosition,t=this._notebookEditor.cellAt(e);t&&await this._notebookEditor.focusNotebookCell(t,"editor")}hasFocus(){return this._widget?.hasFocus()??!1}focus(){this._focusWidget()}focusNearestWidget(e,t){switch(t){case"above":this._widget?.afterModelPosition===e&&this._focusWidget();break;case"below":this._widget?.afterModelPosition===e+1&&this._focusWidget();break;default:break}}populateHistory(e){if(!this._widget)return;const t=d._promptHistory.length;if(t===0)return;this._historyOffset===-1&&(this._historyCandidate=this._widget.inlineChatWidget.value);const i=this._historyOffset+(e?1:-1);if(i>=t)return;let o;i<0?(o=this._historyCandidate,this._historyOffset=-1):(o=d._promptHistory[i],this._historyOffset=i),this._widget.inlineChatWidget.value=o,this._widget.inlineChatWidget.selectAll()}async cancelCurrentRequest(e){this._activeRequestCts?.cancel()}getEditingCell(){return this._widget?.getEditingCell()}discard(){this._activeRequestCts?.cancel(),this._widget?.discardChange(),this.dismiss(!0)}dismiss(e){const t=this._widget,i=t?.afterModelPosition,o=this._notebookEditor.getFocus(),s=o.start===i&&o.end===i;if(t&&s){const n=t.getEditingCell(),a=n&&!e,h=i===0&&this._notebookEditor.getLength()>0,c=i!==0&&this._notebookEditor.cellAt(i-1);a?this._notebookEditor.focusNotebookCell(n,"container"):h?this._notebookEditor.focusNotebookCell(this._notebookEditor.cellAt(0),"container"):c&&this._notebookEditor.focusNotebookCell(this._notebookEditor.cellAt(i-1),"container")}this._ctxCellWidgetFocused.set(!1),this._ctxUserDidEdit.set(!1),this._sessionCtor?.cancel(),this._sessionCtor=void 0,this._model.clear(),this._widget?.dispose(),this._widget=void 0,this._widgetDisposableStore.clear()}isCellGeneratedByChat(e){if(!this._notebookEditor.hasModel())return!1;const t=y.str({uri:e.uri,viewType:this._notebookEditor.textModel.viewType});return this._promptCache.has(t)}getPromptFromCache(e){if(!this._notebookEditor.hasModel())return;const t=y.str({uri:e.uri,viewType:this._notebookEditor.textModel.viewType});return this._promptCache.get(t)}dispose(){this.dismiss(!1),super.dispose()}};d=I([p(1,se),p(2,oe),p(3,te),p(4,ie),p(5,ee),p(6,we),p(7,ne),p(8,de)],d);class ye{_editCount=0;constructor(){}async makeProgressiveChanges(r,e,t){++this._editCount===1&&r.pushUndoStop();const i=t.duration/1e3;for(const o of e){const n=ae(o.text??"")/i;await ce(r.getModel(),he(new U,o,n,t.token))}}async makeChanges(r,e){const t=i=>{let o=null;for(const s of i)o=!o||o.isBefore(s.range.getEndPosition())?s.range.getEndPosition():o;return o&&[z.fromPositions(o)]};++this._editCount===1&&r.pushUndoStop(),r.executeEdits("inline-chat-live",e,t)}}Ee(d.id,d);export{ye as EditStrategy,d as NotebookChatController};
