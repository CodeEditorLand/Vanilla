var $=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var H=(v,b,t,e)=>{for(var i=e>1?void 0:e?K(b,t):b,r=v.length-1,a;r>=0;r--)(a=v[r])&&(i=(e?a(b,t,i):a(i))||i);return e&&i&&$(b,t,i),i},B=(v,b)=>(t,e)=>b(t,e,v);import{PixelRatio as A}from"../../../../base/browser/pixelRatio.js";import{Emitter as tt}from"../../../../base/common/event.js";import{Disposable as ot}from"../../../../base/common/lifecycle.js";import{isObject as et}from"../../../../base/common/types.js";import{FontMeasurements as it}from"../../../../editor/browser/config/fontMeasurements.js";import{ICodeEditorService as nt}from"../../../../editor/browser/services/codeEditorService.js";import{BareFontInfo as N}from"../../../../editor/common/config/fontInfo.js";import{ConfigurationTarget as l,IConfigurationService as rt}from"../../../../platform/configuration/common/configuration.js";import{NotebookSetting as o}from"../common/notebookCommon.js";import{INotebookExecutionStateService as at}from"../common/notebookExecutionStateService.js";const G=18,Ct=4,x=Object.freeze({codeCellLeftMargin:28,cellRunGutter:32,markdownCellTopMargin:8,markdownCellBottomMargin:8,markdownCellLeftMargin:0,markdownCellGutter:32,focusIndicatorLeftMargin:4}),j=Object.freeze({codeCellLeftMargin:8,cellRunGutter:36,markdownCellTopMargin:6,markdownCellBottomMargin:6,markdownCellLeftMargin:8,markdownCellGutter:36,focusIndicatorLeftMargin:4});let z=class extends ot{constructor(t,e,i,r,a,u){super();this.targetWindow=t;this.isReadonly=e;this.overrides=i;this.configurationService=r;this.notebookExecutionStateService=a;this.codeEditorService=u;const s=this.configurationService.getValue(o.showCellStatusBar),c=i?.globalToolbar??this.configurationService.getValue(o.globalToolbar)??!0,m=i?.stickyScrollEnabled??this.configurationService.getValue(o.stickyScrollEnabled)??!1,T=this._computeStickyScrollModeOption(),L=this.configurationService.getValue(o.consolidatedOutputButton)??!0,w=this.configurationService.getValue(o.consolidatedRunButton)??!1,k=i?.dragAndDropEnabled??this.configurationService.getValue(o.dragAndDropEnabled)??!0,_=this.configurationService.getValue(o.cellToolbarLocation)??{default:"right"},F=i?.cellToolbarInteraction??this.configurationService.getValue(o.cellToolbarVisibility),d=this.configurationService.getValue(o.compactView)??!0,C=this._computeFocusIndicatorOption(),E=this._computeInsertToolbarPositionOption(this.isReadonly),O=this._computeInsertToolbarAlignmentOption(),M=this._computeShowFoldingControlsOption(),S=this.configurationService.getValue("editor.fontSize"),V=this.configurationService.getValue(o.markupFontSize),P=this.configurationService.getValue(o.markdownLineHeight);let g=this.configurationService.getValue(o.cellEditorOptionsCustomizations)??{};g=et(g)?g:{};const I=this.configurationService.getValue(o.interactiveWindowCollapseCodeCells);let h;const y=this.configurationService.getValue(o.outputLineHeightDeprecated);y!==void 0?(this._migrateDeprecatedSetting(o.outputLineHeightDeprecated,o.outputLineHeight),h=y):h=this.configurationService.getValue(o.outputLineHeight);let f;const n=this.configurationService.getValue(o.outputFontSizeDeprecated);n!==void 0?(this._migrateDeprecatedSetting(o.outputFontSizeDeprecated,o.outputFontSize),f=n):f=this.configurationService.getValue(o.outputFontSize)||S;let p;const R=this.configurationService.getValue(o.outputFontFamilyDeprecated);R!==void 0?(this._migrateDeprecatedSetting(o.outputFontFamilyDeprecated,o.outputFontFamily),p=R):p=this.configurationService.getValue(o.outputFontFamily);let D;const W=this.configurationService.getValue(o.outputScrollingDeprecated);W!==void 0?(this._migrateDeprecatedSetting(o.outputScrollingDeprecated,o.outputScrolling),D=W):D=this.configurationService.getValue(o.outputScrolling);const U=this._computeOutputLineHeight(h,f),q=this.configurationService.getValue(o.outputWordWrap),J=this.configurationService.getValue(o.textOutputLineLimit)??30,Q=this.configurationService.getValue(o.LinkifyOutputFilePaths)??!0,X=this.configurationService.getValue(o.minimalErrorRendering),Y=this._computeEditorTopPadding();this._layoutConfiguration={...d?j:x,cellTopMargin:6,cellBottomMargin:6,cellRightMargin:16,cellStatusBarHeight:22,cellOutputPadding:8,markdownPreviewPadding:8,editorToolbarHeight:0,editorTopPadding:Y,editorBottomPadding:4,editorBottomPaddingWithoutStatusBar:12,collapsedIndicatorHeight:28,showCellStatusBar:s,globalToolbar:c,stickyScrollEnabled:m,stickyScrollMode:T,consolidatedOutputButton:L,consolidatedRunButton:w,dragAndDropEnabled:k,cellToolbarLocation:_,cellToolbarInteraction:F,compactView:d,focusIndicator:C,insertToolbarPosition:E,insertToolbarAlignment:O,showFoldingControls:M,fontSize:S,outputFontSize:f,outputFontFamily:p,outputLineHeight:U,markupFontSize:V,markdownLineHeight:P,editorOptionsCustomizations:g,focusIndicatorGap:3,interactiveWindowCollapseCodeCells:I,markdownFoldHintHeight:22,outputScrolling:D,outputWordWrap:q,outputLineLimit:J,outputLinkifyFilePaths:Q,outputMinimalError:X},this._register(this.configurationService.onDidChangeConfiguration(Z=>{this._updateConfiguration(Z)}))}_layoutConfiguration;_onDidChangeOptions=this._register(new tt);onDidChangeOptions=this._onDidChangeOptions.event;_editorTopPadding=12;updateOptions(t){this.isReadonly!==t&&(this.isReadonly=t,this._updateConfiguration({affectsConfiguration(e){return e===o.insertToolbarLocation},source:l.DEFAULT,affectedKeys:new Set([o.insertToolbarLocation]),change:{keys:[o.insertToolbarLocation],overrides:[]}}))}_computeEditorTopPadding(){let t=!1;const e=a=>{this._editorTopPadding=a;const u=Object.assign({},this._layoutConfiguration);u.editorTopPadding=this._editorTopPadding,this._layoutConfiguration=u,this._onDidChangeOptions.fire({editorTopPadding:!0})},i=new Set,r=a=>{if(!t&&!i.has(a))try{const u=this.codeEditorService.resolveDecorationOptions(a,!0);if(u.afterContentClassName||u.beforeContentClassName){const s=this.codeEditorService.resolveDecorationCSSRules(a);if(s!==null){for(let c=0;c<s.length;c++)if((s[c].selectorText.endsWith("::after")||s[c].selectorText.endsWith("::after"))&&s[c].cssText.indexOf("top:")>-1){const m=this.configurationService.getValue("editor");e(N.createFromRawSettings(m,A.getInstance(this.targetWindow).value).lineHeight+2),t=!0;break}}}i.add(a)}catch{}};return this._register(this.codeEditorService.onDecorationTypeRegistered(r)),this.codeEditorService.listDecorationTypes().forEach(r),this._editorTopPadding}_migrateDeprecatedSetting(t,e){const i=this.configurationService.inspect(t);i.application!==void 0&&(this.configurationService.updateValue(t,void 0,l.APPLICATION),this.configurationService.updateValue(e,i.application.value,l.APPLICATION)),i.user!==void 0&&(this.configurationService.updateValue(t,void 0,l.USER),this.configurationService.updateValue(e,i.user.value,l.USER)),i.userLocal!==void 0&&(this.configurationService.updateValue(t,void 0,l.USER_LOCAL),this.configurationService.updateValue(e,i.userLocal.value,l.USER_LOCAL)),i.userRemote!==void 0&&(this.configurationService.updateValue(t,void 0,l.USER_REMOTE),this.configurationService.updateValue(e,i.userRemote.value,l.USER_REMOTE)),i.workspace!==void 0&&(this.configurationService.updateValue(t,void 0,l.WORKSPACE),this.configurationService.updateValue(e,i.workspace.value,l.WORKSPACE)),i.workspaceFolder!==void 0&&(this.configurationService.updateValue(t,void 0,l.WORKSPACE_FOLDER),this.configurationService.updateValue(e,i.workspaceFolder.value,l.WORKSPACE_FOLDER))}_computeOutputLineHeight(t,e){if(t===0){const r=this.configurationService.getValue("editor");t=it.readFontInfo(this.targetWindow,N.createFromRawSettings(r,A.getInstance(this.targetWindow).value)).lineHeight}else if(t<9){let r=e;r===0&&(r=this.configurationService.getValue("editor.fontSize")),t=t*r}return t=Math.round(t),t<9&&(t=9),t}_updateConfiguration(t){const e=t.affectsConfiguration(o.showCellStatusBar),i=t.affectsConfiguration(o.cellToolbarLocation),r=t.affectsConfiguration(o.cellToolbarVisibility),a=t.affectsConfiguration(o.compactView),u=t.affectsConfiguration(o.focusIndicator),s=t.affectsConfiguration(o.insertToolbarLocation),c=t.affectsConfiguration(o.experimentalInsertToolbarAlignment),m=t.affectsConfiguration(o.globalToolbar),T=t.affectsConfiguration(o.stickyScrollEnabled),L=t.affectsConfiguration(o.stickyScrollMode),w=t.affectsConfiguration(o.consolidatedOutputButton),k=t.affectsConfiguration(o.consolidatedRunButton),_=t.affectsConfiguration(o.showFoldingControls),F=t.affectsConfiguration(o.dragAndDropEnabled),d=t.affectsConfiguration("editor.fontSize"),C=t.affectsConfiguration(o.outputFontSize),E=t.affectsConfiguration(o.markupFontSize),O=t.affectsConfiguration(o.markdownLineHeight),M=t.affectsConfiguration("editor.fontFamily"),S=t.affectsConfiguration(o.outputFontFamily),V=t.affectsConfiguration(o.cellEditorOptionsCustomizations),P=t.affectsConfiguration(o.interactiveWindowCollapseCodeCells),g=t.affectsConfiguration(o.outputLineHeight),I=t.affectsConfiguration(o.outputScrolling),h=t.affectsConfiguration(o.outputWordWrap),y=t.affectsConfiguration(o.LinkifyOutputFilePaths),f=t.affectsConfiguration(o.minimalErrorRendering);if(!e&&!i&&!r&&!a&&!u&&!s&&!c&&!m&&!T&&!L&&!w&&!k&&!_&&!F&&!d&&!C&&!E&&!O&&!M&&!S&&!V&&!P&&!g&&!I&&!h&&!y&&!f)return;let n=Object.assign({},this._layoutConfiguration);if(e&&(n.showCellStatusBar=this.configurationService.getValue(o.showCellStatusBar)),i&&(n.cellToolbarLocation=this.configurationService.getValue(o.cellToolbarLocation)??{default:"right"}),r&&!this.overrides?.cellToolbarInteraction&&(n.cellToolbarInteraction=this.configurationService.getValue(o.cellToolbarVisibility)),u&&(n.focusIndicator=this._computeFocusIndicatorOption()),a){const p=this.configurationService.getValue(o.compactView)??!0;n=Object.assign(n,{...p?j:x}),n.compactView=p}if(c&&(n.insertToolbarAlignment=this._computeInsertToolbarAlignmentOption()),s&&(n.insertToolbarPosition=this._computeInsertToolbarPositionOption(this.isReadonly)),m&&this.overrides?.globalToolbar===void 0&&(n.globalToolbar=this.configurationService.getValue(o.globalToolbar)??!0),T&&this.overrides?.stickyScrollEnabled===void 0&&(n.stickyScrollEnabled=this.configurationService.getValue(o.stickyScrollEnabled)??!1),L&&(n.stickyScrollMode=this.configurationService.getValue(o.stickyScrollMode)??"flat"),w&&(n.consolidatedOutputButton=this.configurationService.getValue(o.consolidatedOutputButton)??!0),k&&(n.consolidatedRunButton=this.configurationService.getValue(o.consolidatedRunButton)??!0),_&&(n.showFoldingControls=this._computeShowFoldingControlsOption()),F&&(n.dragAndDropEnabled=this.configurationService.getValue(o.dragAndDropEnabled)??!0),d&&(n.fontSize=this.configurationService.getValue("editor.fontSize")),(C||d)&&(n.outputFontSize=this.configurationService.getValue(o.outputFontSize)||n.fontSize),E&&(n.markupFontSize=this.configurationService.getValue(o.markupFontSize)),O&&(n.markdownLineHeight=this.configurationService.getValue(o.markdownLineHeight)),S&&(n.outputFontFamily=this.configurationService.getValue(o.outputFontFamily)),V&&(n.editorOptionsCustomizations=this.configurationService.getValue(o.cellEditorOptionsCustomizations)),P&&(n.interactiveWindowCollapseCodeCells=this.configurationService.getValue(o.interactiveWindowCollapseCodeCells)),g||d||C){const p=this.configurationService.getValue(o.outputLineHeight);n.outputLineHeight=this._computeOutputLineHeight(p,n.outputFontSize)}h&&(n.outputWordWrap=this.configurationService.getValue(o.outputWordWrap)),I&&(n.outputScrolling=this.configurationService.getValue(o.outputScrolling)),y&&(n.outputLinkifyFilePaths=this.configurationService.getValue(o.LinkifyOutputFilePaths)),f&&(n.outputMinimalError=this.configurationService.getValue(o.minimalErrorRendering)),this._layoutConfiguration=Object.freeze(n),this._onDidChangeOptions.fire({cellStatusBarVisibility:e,cellToolbarLocation:i,cellToolbarInteraction:r,compactView:a,focusIndicator:u,insertToolbarPosition:s,insertToolbarAlignment:c,globalToolbar:m,stickyScrollEnabled:T,stickyScrollMode:L,showFoldingControls:_,consolidatedOutputButton:w,consolidatedRunButton:k,dragAndDropEnabled:F,fontSize:d,outputFontSize:C,markupFontSize:E,markdownLineHeight:O,fontFamily:M,outputFontFamily:S,editorOptionsCustomizations:V,interactiveWindowCollapseCodeCells:P,outputLineHeight:g,outputScrolling:I,outputWordWrap:h,outputLinkifyFilePaths:y,minimalError:f})}_computeInsertToolbarPositionOption(t){return t?"hidden":this.configurationService.getValue(o.insertToolbarLocation)??"both"}_computeInsertToolbarAlignmentOption(){return this.configurationService.getValue(o.experimentalInsertToolbarAlignment)??"center"}_computeShowFoldingControlsOption(){return this.configurationService.getValue(o.showFoldingControls)??"mouseover"}_computeFocusIndicatorOption(){return this.configurationService.getValue(o.focusIndicator)??"gutter"}_computeStickyScrollModeOption(){return this.configurationService.getValue(o.stickyScrollMode)??"flat"}getCellCollapseDefault(){return this._layoutConfiguration.interactiveWindowCollapseCodeCells==="never"?{codeCell:{inputCollapsed:!1}}:{codeCell:{inputCollapsed:!0}}}getLayoutConfiguration(){return this._layoutConfiguration}getDisplayOptions(){return this._layoutConfiguration}getCellEditorContainerLeftMargin(){const{codeCellLeftMargin:t,cellRunGutter:e}=this._layoutConfiguration;return t+e}computeCollapsedMarkdownCellHeight(t){const{bottomToolbarGap:e}=this.computeBottomToolbarDimensions(t);return this._layoutConfiguration.markdownCellTopMargin+this._layoutConfiguration.collapsedIndicatorHeight+e+this._layoutConfiguration.markdownCellBottomMargin}computeBottomToolbarOffset(t,e){const{bottomToolbarGap:i,bottomToolbarHeight:r}=this.computeBottomToolbarDimensions(e);return t-i-r/2}computeCodeCellEditorWidth(t){return t-(this._layoutConfiguration.codeCellLeftMargin+this._layoutConfiguration.cellRunGutter+this._layoutConfiguration.cellRightMargin)}computeMarkdownCellEditorWidth(t){return t-this._layoutConfiguration.markdownCellGutter-this._layoutConfiguration.markdownCellLeftMargin-this._layoutConfiguration.cellRightMargin}computeStatusBarHeight(){return this._layoutConfiguration.cellStatusBarHeight}_computeBottomToolbarDimensions(t,e,i,r){return i==="left"||r!=="hidden"?{bottomToolbarGap:18,bottomToolbarHeight:18}:e==="betweenCells"||e==="both"?t?{bottomToolbarGap:12,bottomToolbarHeight:20}:{bottomToolbarGap:20,bottomToolbarHeight:20}:{bottomToolbarGap:0,bottomToolbarHeight:0}}computeBottomToolbarDimensions(t){const e=this._layoutConfiguration,i=this.computeCellToolbarLocation(t),{bottomToolbarGap:r,bottomToolbarHeight:a}=this._computeBottomToolbarDimensions(e.compactView,e.insertToolbarPosition,e.insertToolbarAlignment,i);return{bottomToolbarGap:r,bottomToolbarHeight:a}}computeCellToolbarLocation(t){const e=this._layoutConfiguration.cellToolbarLocation;if(typeof e=="string"){if(e==="left"||e==="right"||e==="hidden")return e}else if(t){const i=e[t]??e.default;let r="right";switch(i){case"left":r="left";break;case"right":r="right";break;case"hidden":r="hidden";break;default:r="right";break}return r}return"right"}computeTopInsertToolbarHeight(t){if(this._layoutConfiguration.insertToolbarPosition==="betweenCells"||this._layoutConfiguration.insertToolbarPosition==="both")return G;const e=this.computeCellToolbarLocation(t);return e==="left"||e==="right"?G:0}computeEditorPadding(t,e){return{top:this._editorTopPadding,bottom:this.statusBarIsVisible(t,e)?this._layoutConfiguration.editorBottomPadding:this._layoutConfiguration.editorBottomPaddingWithoutStatusBar}}computeEditorStatusbarHeight(t,e){return this.statusBarIsVisible(t,e)?this.computeStatusBarHeight():0}statusBarIsVisible(t,e){const i=this.notebookExecutionStateService.getCellExecution(e);return this._layoutConfiguration.showCellStatusBar==="visible"?!0:this._layoutConfiguration.showCellStatusBar==="visibleAfterExecute"?typeof t.lastRunSuccess=="boolean"||i!==void 0:!1}computeWebviewOptions(){return{outputNodePadding:this._layoutConfiguration.cellOutputPadding,outputNodeLeftPadding:this._layoutConfiguration.cellOutputPadding,previewNodePadding:this._layoutConfiguration.markdownPreviewPadding,markdownLeftMargin:this._layoutConfiguration.markdownCellGutter+this._layoutConfiguration.markdownCellLeftMargin,leftMargin:this._layoutConfiguration.codeCellLeftMargin,rightMargin:this._layoutConfiguration.cellRightMargin,runGutter:this._layoutConfiguration.cellRunGutter,dragAndDropEnabled:this._layoutConfiguration.dragAndDropEnabled,fontSize:this._layoutConfiguration.fontSize,outputFontSize:this._layoutConfiguration.outputFontSize,outputFontFamily:this._layoutConfiguration.outputFontFamily,markupFontSize:this._layoutConfiguration.markupFontSize,markdownLineHeight:this._layoutConfiguration.markdownLineHeight,outputLineHeight:this._layoutConfiguration.outputLineHeight,outputScrolling:this._layoutConfiguration.outputScrolling,outputWordWrap:this._layoutConfiguration.outputWordWrap,outputLineLimit:this._layoutConfiguration.outputLineLimit,outputLinkifyFilePaths:this._layoutConfiguration.outputLinkifyFilePaths,minimalError:this._layoutConfiguration.outputMinimalError}}computeDiffWebviewOptions(){return{outputNodePadding:this._layoutConfiguration.cellOutputPadding,outputNodeLeftPadding:0,previewNodePadding:this._layoutConfiguration.markdownPreviewPadding,markdownLeftMargin:0,leftMargin:32,rightMargin:0,runGutter:0,dragAndDropEnabled:!1,fontSize:this._layoutConfiguration.fontSize,outputFontSize:this._layoutConfiguration.outputFontSize,outputFontFamily:this._layoutConfiguration.outputFontFamily,markupFontSize:this._layoutConfiguration.markupFontSize,markdownLineHeight:this._layoutConfiguration.markdownLineHeight,outputLineHeight:this._layoutConfiguration.outputLineHeight,outputScrolling:this._layoutConfiguration.outputScrolling,outputWordWrap:this._layoutConfiguration.outputWordWrap,outputLineLimit:this._layoutConfiguration.outputLineLimit,outputLinkifyFilePaths:!1,minimalError:!1}}computeIndicatorPosition(t,e,i){const{bottomToolbarGap:r}=this.computeBottomToolbarDimensions(i);return{bottomIndicatorTop:t-r-this._layoutConfiguration.cellBottomMargin-e,verticalIndicatorHeight:t-r-e}}};z=H([B(3,rt),B(4,at),B(5,nt)],z);export{z as NotebookOptions,Ct as OutputInnerContainerTopPadding};
