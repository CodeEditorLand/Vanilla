import"../../../../../base/common/cancellation.js";import"../../../../../base/common/diff/diff.js";import{Emitter as D}from"../../../../../base/common/event.js";import{Disposable as V,DisposableStore as S,dispose as M}from"../../../../../base/common/lifecycle.js";import{Schemas as u}from"../../../../../base/common/network.js";import"../../../../../editor/common/config/fontInfo.js";import"../../../../../platform/configuration/common/configuration.js";import{MultiDiffEditorItem as x}from"../../../multiDiffEditor/browser/multiDiffSourceResolverService.js";import{DiffElementPlaceholderViewModel as _,NotebookDocumentMetadataViewModel as N,SideBySideDiffElementViewModel as w,SingleSideDiffElementViewModel as E}from"./diffElementViewModel.js";import"./eventDispatcher.js";import{NOTEBOOK_DIFF_ITEM_DIFF_STATE as b,NOTEBOOK_DIFF_ITEM_KIND as k}from"./notebookDiffEditorBrowser.js";import"../../common/model/notebookTextModel.js";import{CellUri as p}from"../../common/notebookCommon.js";import"../../common/notebookService.js";import"../../common/services/notebookWorkerService.js";import"./editorHeightCalculator.js";class pe extends V{constructor(t,o,e,i,n,l,h,d){super();this.model=t;this.notebookEditorWorkerService=o;this.configurationService=e;this.eventDispatcher=i;this.notebookService=n;this.diffEditorHeightCalculator=l;this.fontInfo=h;this.excludeUnchangedPlaceholder=d;this.hideOutput=this.model.modified.notebook.transientOptions.transientOutputs||this.configurationService.getValue("notebook.diff.ignoreOutputs"),this.ignoreMetadata=this.configurationService.getValue("notebook.diff.ignoreMetadata"),this._register(this.configurationService.onDidChangeConfiguration(s=>{let c=!1,f=!1;if(s.affectsConfiguration("notebook.diff.ignoreMetadata")){const g=this.configurationService.getValue("notebook.diff.ignoreMetadata");g!==void 0&&this.ignoreMetadata!==g&&(this.ignoreMetadata=g,c=!0,f=!0)}if(s.affectsConfiguration("notebook.diff.ignoreOutputs")){const g=this.configurationService.getValue("notebook.diff.ignoreOutputs");g!==void 0&&this.hideOutput!==(g||this.model.modified.notebook.transientOptions.transientOutputs)&&(this.hideOutput=g||!!this.model.modified.notebook.transientOptions.transientOutputs,c=!0)}f&&this.toggleNotebookMetadata(),c&&this._onDidChange.fire()}))}placeholderAndRelatedCells=new Map;_items=[];get items(){return this._items}_onDidChangeItems=this._register(new D);onDidChangeItems=this._onDidChangeItems.event;disposables=this._register(new S);_onDidChange=this._register(new D);diffEditorItems=[];onDidChange=this._onDidChange.event;notebookMetadataViewModel;get value(){return this.diffEditorItems.filter(t=>t.type!=="placeholder").filter(t=>this._includeUnchanged?!0:t instanceof I||t instanceof m||t instanceof C?!(t.type==="unchanged"&&t.containerType==="unchanged"):!0).filter(t=>t instanceof C?!this.hideOutput:!0).filter(t=>t instanceof m?!this.ignoreMetadata:!0)}_hasUnchangedCells;get hasUnchangedCells(){return this._hasUnchangedCells===!0}_includeUnchanged;get includeUnchanged(){return this._includeUnchanged===!0}set includeUnchanged(t){this._includeUnchanged=t,this._onDidChange.fire()}hideOutput;ignoreMetadata;originalCellViewModels=[];dispose(){this.clear(),super.dispose()}clear(){this.disposables.clear(),M(Array.from(this.placeholderAndRelatedCells.keys())),this.placeholderAndRelatedCells.clear(),M(this.originalCellViewModels),this.originalCellViewModels=[],M(this._items),this._items.splice(0,this._items.length)}async computeDiff(t){const o=await this.notebookEditorWorkerService.computeDiff(this.model.original.resource,this.model.modified.resource);if(t.isCancellationRequested)return;O(this.model,o.cellsDiff);const{cellDiffInfo:e,firstChangeIndex:i}=U(this.model,o);if(!R(e,this.originalCellViewModels,this.model))return await this.updateViewModels(e,o.metadataChanged),this.updateDiffEditorItems(),{firstChangeIndex:i}}toggleNotebookMetadata(){this.notebookMetadataViewModel&&(this.ignoreMetadata?this._items.length&&this._items[0]===this.notebookMetadataViewModel&&(this._items.splice(0,1),this._onDidChangeItems.fire({start:0,deleteCount:1,elements:[]})):(!this._items.length||this._items[0]!==this.notebookMetadataViewModel)&&(this._items.splice(0,0,this.notebookMetadataViewModel),this._onDidChangeItems.fire({start:0,deleteCount:0,elements:[this.notebookMetadataViewModel]})))}updateDiffEditorItems(){this.diffEditorItems=[];const t=this.model.original.resource,o=this.model.modified.resource;this._hasUnchangedCells=!1,this.items.forEach(e=>{switch(e.type){case"delete":{this.diffEditorItems.push(new I(e.original.uri,void 0,e.type,e.type));const i=p.generateCellPropertyUri(t,e.original.handle,u.vscodeNotebookCellMetadata);this.diffEditorItems.push(new m(i,void 0,e.type,e.type));const n=p.generateCellPropertyUri(t,e.original.handle,u.vscodeNotebookCellOutput);this.diffEditorItems.push(new C(n,void 0,e.type,e.type));break}case"insert":{this.diffEditorItems.push(new I(void 0,e.modified.uri,e.type,e.type));const i=p.generateCellPropertyUri(o,e.modified.handle,u.vscodeNotebookCellMetadata);this.diffEditorItems.push(new m(void 0,i,e.type,e.type));const n=p.generateCellPropertyUri(o,e.modified.handle,u.vscodeNotebookCellOutput);this.diffEditorItems.push(new C(void 0,n,e.type,e.type));break}case"modified":{const i=e.checkIfInputModified()?e.type:"unchanged",n=e.checkIfInputModified()||e.checkMetadataIfModified()||e.checkIfOutputsModified()?e.type:"unchanged";this.diffEditorItems.push(new I(e.original.uri,e.modified.uri,i,n));const l=p.generateCellPropertyUri(t,e.original.handle,u.vscodeNotebookCellMetadata),h=p.generateCellPropertyUri(o,e.modified.handle,u.vscodeNotebookCellMetadata);this.diffEditorItems.push(new m(l,h,e.checkMetadataIfModified()?e.type:"unchanged",n));const d=p.generateCellPropertyUri(t,e.original.handle,u.vscodeNotebookCellOutput),s=p.generateCellPropertyUri(o,e.modified.handle,u.vscodeNotebookCellOutput);this.diffEditorItems.push(new C(d,s,e.checkIfOutputsModified()?e.type:"unchanged",n));break}case"unchanged":{this._hasUnchangedCells=!0,this.diffEditorItems.push(new I(e.original.uri,e.modified.uri,e.type,e.type));const i=p.generateCellPropertyUri(t,e.original.handle,u.vscodeNotebookCellMetadata),n=p.generateCellPropertyUri(o,e.modified.handle,u.vscodeNotebookCellMetadata);this.diffEditorItems.push(new m(i,n,e.type,e.type));const l=p.generateCellPropertyUri(t,e.original.handle,u.vscodeNotebookCellOutput),h=p.generateCellPropertyUri(o,e.modified.handle,u.vscodeNotebookCellOutput);this.diffEditorItems.push(new C(l,h,e.type,e.type));break}}}),this._onDidChange.fire()}async updateViewModels(t,o){const e=await this.createDiffViewModels(t,o),i=this._items.length;this.clear(),this._items.splice(0,i);let n;this.originalCellViewModels=e,e.forEach((l,h)=>{if(l.type==="unchanged"&&!this.excludeUnchangedPlaceholder){if(!n){l.displayIconToHideUnmodifiedCells=!0,n=new _(l.mainDocumentTextModel,l.editorEventDispatcher,l.initData),this._items.push(n);const s=n;this.disposables.add(s.onUnfoldHiddenCells(()=>{const c=this.placeholderAndRelatedCells.get(s);if(!Array.isArray(c))return;const f=this._items.indexOf(s);this._items.splice(f,1,...c),this._onDidChangeItems.fire({start:f,deleteCount:1,elements:c})})),this.disposables.add(l.onHideUnchangedCells(()=>{const c=this.placeholderAndRelatedCells.get(s);if(!Array.isArray(c))return;const f=this._items.indexOf(l);this._items.splice(f,c.length,s),this._onDidChangeItems.fire({start:f,deleteCount:c.length,elements:[s]})}))}const d=this.placeholderAndRelatedCells.get(n)||[];d.push(l),this.placeholderAndRelatedCells.set(n,d),n.hiddenCells.push(l)}else n=void 0,this._items.push(l)}),this._onDidChangeItems.fire({start:0,deleteCount:i,elements:this._items})}async createDiffViewModels(t,o){const e=this.model.original.notebook,i=this.model.modified.notebook,n={metadataStatusHeight:this.configurationService.getValue("notebook.diff.ignoreMetadata")?0:25,outputStatusHeight:this.configurationService.getValue("notebook.diff.ignoreOutputs")||i.transientOptions.transientOutputs?0:25,fontInfo:this.fontInfo},l=[];return this.notebookMetadataViewModel=this._register(new N(this.model.original.notebook,this.model.modified.notebook,o?"modifiedMetadata":"unchangedMetadata",this.eventDispatcher,n,this.notebookService,this.diffEditorHeightCalculator)),this.ignoreMetadata||(o&&await this.notebookMetadataViewModel.computeHeights(),l.push(this.notebookMetadataViewModel)),(await Promise.all(t.map(async d=>{switch(d.type){case"delete":return new E(e,i,e.cells[d.originalCellIndex],void 0,"delete",this.eventDispatcher,n,this.notebookService,this.configurationService,this.diffEditorHeightCalculator,d.originalCellIndex);case"insert":return new E(i,e,void 0,i.cells[d.modifiedCellIndex],"insert",this.eventDispatcher,n,this.notebookService,this.configurationService,this.diffEditorHeightCalculator,d.modifiedCellIndex);case"modified":{const s=new w(this.model.modified.notebook,this.model.original.notebook,e.cells[d.originalCellIndex],i.cells[d.modifiedCellIndex],"modified",this.eventDispatcher,n,this.notebookService,this.configurationService,d.originalCellIndex,this.diffEditorHeightCalculator);return await s.computeEditorHeights(),s}case"unchanged":return new w(this.model.modified.notebook,this.model.original.notebook,e.cells[d.originalCellIndex],i.cells[d.modifiedCellIndex],"unchanged",this.eventDispatcher,n,this.notebookService,this.configurationService,d.originalCellIndex,this.diffEditorHeightCalculator)}}))).forEach(d=>l.push(d)),l}}function O(a,r){const t=r.changes;for(let o=0;o<r.changes.length-1;o++){const e=t[o],i=t[o+1],n=e.originalStart,l=e.modifiedStart;e.originalLength===1&&e.modifiedLength===0&&i.originalStart===n+2&&i.originalLength===0&&i.modifiedStart===l+1&&i.modifiedLength===1&&a.original.notebook.cells[n].getHashValue()===a.modified.notebook.cells[l+1].getHashValue()&&a.original.notebook.cells[n+1].getHashValue()===a.modified.notebook.cells[l].getHashValue()&&(e.originalStart=n,e.originalLength=0,e.modifiedStart=l,e.modifiedLength=1,i.originalStart=n+1,i.originalLength=1,i.modifiedStart=l+2,i.modifiedLength=0,o++)}}function U(a,r){const t=r.cellsDiff.changes,o=[],e=a.original.notebook,i=a.modified.notebook;let n=0,l=0,h=-1;for(let d=0;d<t.length;d++){const s=t[d];for(let f=0;f<s.originalStart-n;f++){const g=e.cells[n+f],v=i.cells[l+f];g.getHashValue()===v.getHashValue()?o.push({originalCellIndex:n+f,modifiedCellIndex:l+f,type:"unchanged"}):(h===-1&&(h=o.length),o.push({originalCellIndex:n+f,modifiedCellIndex:l+f,type:"modified"}))}const c=H(s,e,i);c.length&&h===-1&&(h=o.length),o.push(...c),n=s.originalStart+s.originalLength,l=s.modifiedStart+s.modifiedLength}for(let d=n;d<e.cells.length;d++)o.push({originalCellIndex:d,modifiedCellIndex:d-n+l,type:"unchanged"});return{cellDiffInfo:o,firstChangeIndex:h}}function R(a,r,t){if(a.length!==r.length)return!1;const o=t.original.notebook,e=t.modified.notebook;for(let i=0;i<r.length;i++){const n=a[i],l=r[i];if(n.type!==l.type)return!1;switch(n.type){case"delete":{if(o.cells[n.originalCellIndex].handle!==l.original?.handle)return!1;continue}case"insert":{if(e.cells[n.modifiedCellIndex].handle!==l.modified?.handle)return!1;continue}default:{if(o.cells[n.originalCellIndex].handle!==l.original?.handle||e.cells[n.modifiedCellIndex].handle!==l.modified?.handle)return!1;continue}}}return!0}function H(a,r,t){const o=[],e=Math.min(a.originalLength,a.modifiedLength);for(let i=0;i<e;i++){const n=r.cells[a.originalStart+i].equal(t.cells[a.modifiedStart+i]);o.push({originalCellIndex:a.originalStart+i,modifiedCellIndex:a.modifiedStart+i,type:n?"unchanged":"modified"})}for(let i=e;i<a.originalLength;i++)o.push({originalCellIndex:a.originalStart+i,type:"delete"});for(let i=e;i<a.modifiedLength;i++)o.push({modifiedCellIndex:a.modifiedStart+i,type:"insert"});return o}class y extends x{constructor(t,o,e,i,n,l,h){super(t,o,e,h);this.type=i;this.containerType=n;this.kind=l}}class I extends y{constructor(r,t,o,e){super(r,t,t||r,o,e,"Cell",{[k.key]:"Cell",[b.key]:o})}}class m extends y{constructor(r,t,o,e){super(r,t,t||r,o,e,"Metadata",{[k.key]:"Metadata",[b.key]:o})}}class C extends y{constructor(r,t,o,e){super(r,t,t||r,o,e,"Output",{[k.key]:"Output",[b.key]:o})}}export{pe as NotebookDiffViewModel,y as NotebookMultiDiffEditorItem,O as prettyChanges};
