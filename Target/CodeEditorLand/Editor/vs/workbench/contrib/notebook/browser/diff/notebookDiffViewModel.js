import"../../../../../base/common/cancellation.js";import"../../../../../base/common/diff/diff.js";import{Emitter as k}from"../../../../../base/common/event.js";import{Disposable as x,DisposableStore as v,dispose as I}from"../../../../../base/common/lifecycle.js";import{Schemas as h}from"../../../../../base/common/network.js";import"../../../../../editor/common/config/fontInfo.js";import"../../../../../platform/configuration/common/configuration.js";import{MultiDiffEditorItem as N}from"../../../multiDiffEditor/browser/multiDiffSourceResolverService.js";import{DiffElementPlaceholderViewModel as O,SideBySideDiffElementViewModel as D,SingleSideDiffElementViewModel as E}from"./diffElementViewModel.js";import"./eventDispatcher.js";import{NOTEBOOK_DIFF_ITEM_DIFF_STATE as y,NOTEBOOK_DIFF_ITEM_KIND as b}from"./notebookDiffEditorBrowser.js";import"../../common/model/notebookTextModel.js";import{CellUri as c}from"../../common/notebookCommon.js";import"../../common/notebookService.js";import"../../common/services/notebookWorkerService.js";class he extends x{constructor(i,n,e,t,o,d,s){super();this.model=i;this.notebookEditorWorkerService=n;this.configurationService=e;this.eventDispatcher=t;this.notebookService=o;this.fontInfo=d;this.excludeUnchangedPlaceholder=s;this.hideOutput=this.model.modified.notebook.transientOptions.transientOutputs||this.configurationService.getValue("notebook.diff.ignoreOutputs"),this.hideCellMetadata=this.configurationService.getValue("notebook.diff.ignoreMetadata"),this._register(this.configurationService.onDidChangeConfiguration(a=>{let f=!1;if(a.affectsConfiguration("notebook.diff.ignoreMetadata")){const u=this.configurationService.getValue("notebook.diff.ignoreMetadata");u!==void 0&&this.hideCellMetadata!==u&&(this.hideCellMetadata=u,f=!0)}if(a.affectsConfiguration("notebook.diff.ignoreOutputs")){const u=this.configurationService.getValue("notebook.diff.ignoreOutputs");u!==void 0&&this.hideOutput!==(u||this.model.modified.notebook.transientOptions.transientOutputs)&&(this.hideOutput=u||!!this.model.modified.notebook.transientOptions.transientOutputs,f=!0)}f&&this._onDidChange.fire()}))}placeholderAndRelatedCells=new Map;_items=[];get items(){return this._items}_onDidChangeItems=this._register(new k);onDidChangeItems=this._onDidChangeItems.event;disposables=this._register(new v);_onDidChange=this._register(new k);diffEditorItems=[];onDidChange=this._onDidChange.event;get value(){return this.diffEditorItems.filter(i=>i.type!=="placeholder").filter(i=>this._includeUnchanged?!0:i instanceof C||i instanceof g||i instanceof m?!(i.type==="unchanged"&&i.containerType==="unchanged"):!0).filter(i=>i instanceof m?!this.hideOutput:!0).filter(i=>i instanceof g?!this.hideCellMetadata:!0)}_hasUnchangedCells;get hasUnchangedCells(){return this._hasUnchangedCells===!0}_includeUnchanged;get includeUnchanged(){return this._includeUnchanged===!0}set includeUnchanged(i){this._includeUnchanged=i,this._onDidChange.fire()}hideOutput;hideCellMetadata;originalCellViewModels=[];dispose(){this.clear(),super.dispose()}clear(){this.disposables.clear(),I(Array.from(this.placeholderAndRelatedCells.keys())),this.placeholderAndRelatedCells.clear(),I(this.originalCellViewModels),this.originalCellViewModels=[],I(this._items),this._items.splice(0,this._items.length)}async computeDiff(i){const n=await this.notebookEditorWorkerService.computeDiff(this.model.original.resource,this.model.modified.resource);if(i.isCancellationRequested)return;_(this.model,n.cellsDiff);const{cellDiffInfo:e,firstChangeIndex:t}=S(this.model,n);if(!U(e,this.originalCellViewModels,this.model))return this.updateViewModels(e),this.updateDiffEditorItems(),{firstChangeIndex:t}}updateDiffEditorItems(){this.diffEditorItems=[];const i=this.model.original.resource,n=this.model.modified.resource;this._hasUnchangedCells=!1,this.items.forEach(e=>{switch(e.type){case"delete":{this.diffEditorItems.push(new C(e.original.uri,void 0,e.type,e.type));const t=c.generateCellPropertyUri(i,e.original.handle,h.vscodeNotebookCellMetadata);this.diffEditorItems.push(new g(t,void 0,e.type,e.type));const o=c.generateCellPropertyUri(i,e.original.handle,h.vscodeNotebookCellOutput);this.diffEditorItems.push(new m(o,void 0,e.type,e.type));break}case"insert":{this.diffEditorItems.push(new C(void 0,e.modified.uri,e.type,e.type));const t=c.generateCellPropertyUri(n,e.modified.handle,h.vscodeNotebookCellMetadata);this.diffEditorItems.push(new g(void 0,t,e.type,e.type));const o=c.generateCellPropertyUri(n,e.modified.handle,h.vscodeNotebookCellOutput);this.diffEditorItems.push(new m(void 0,o,e.type,e.type));break}case"modified":{const t=e.checkIfInputModified()?e.type:"unchanged",o=e.checkIfInputModified()||e.checkMetadataIfModified()||e.checkIfOutputsModified()?e.type:"unchanged";this.diffEditorItems.push(new C(e.original.uri,e.modified.uri,t,o));const d=c.generateCellPropertyUri(i,e.original.handle,h.vscodeNotebookCellMetadata),s=c.generateCellPropertyUri(n,e.modified.handle,h.vscodeNotebookCellMetadata);this.diffEditorItems.push(new g(d,s,e.checkMetadataIfModified()?e.type:"unchanged",o));const a=c.generateCellPropertyUri(i,e.original.handle,h.vscodeNotebookCellOutput),f=c.generateCellPropertyUri(n,e.modified.handle,h.vscodeNotebookCellOutput);this.diffEditorItems.push(new m(a,f,e.checkIfOutputsModified()?e.type:"unchanged",o));break}case"unchanged":{this._hasUnchangedCells=!0,this.diffEditorItems.push(new C(e.original.uri,e.modified.uri,e.type,e.type));const t=c.generateCellPropertyUri(i,e.original.handle,h.vscodeNotebookCellMetadata),o=c.generateCellPropertyUri(n,e.modified.handle,h.vscodeNotebookCellMetadata);this.diffEditorItems.push(new g(t,o,e.type,e.type));const d=c.generateCellPropertyUri(i,e.original.handle,h.vscodeNotebookCellOutput),s=c.generateCellPropertyUri(n,e.modified.handle,h.vscodeNotebookCellOutput);this.diffEditorItems.push(new m(d,s,e.type,e.type));break}}}),this._onDidChange.fire()}updateViewModels(i){const n=R(this.configurationService,this.model,this.eventDispatcher,i,this.fontInfo,this.notebookService),e=this._items.length;this.clear(),this._items.splice(0,e);let t;this.originalCellViewModels=n,n.forEach((o,d)=>{if(o.type==="unchanged"&&!this.excludeUnchangedPlaceholder){if(!t){o.displayIconToHideUnmodifiedCells=!0,t=new O(o.mainDocumentTextModel,o.editorEventDispatcher,o.initData),this._items.push(t);const a=t;this.disposables.add(a.onUnfoldHiddenCells(()=>{const f=this.placeholderAndRelatedCells.get(a);if(!Array.isArray(f))return;const u=this._items.indexOf(a);this._items.splice(u,1,...f),this._onDidChangeItems.fire({start:u,deleteCount:1,elements:f})})),this.disposables.add(o.onHideUnchangedCells(()=>{const f=this.placeholderAndRelatedCells.get(a);if(!Array.isArray(f))return;const u=this._items.indexOf(o);this._items.splice(u,f.length,a),this._onDidChangeItems.fire({start:u,deleteCount:f.length,elements:[a]})}))}const s=this.placeholderAndRelatedCells.get(t)||[];s.push(o),this.placeholderAndRelatedCells.set(t,s),t.hiddenCells.push(o)}else t=void 0,this._items.push(o)}),this._onDidChangeItems.fire({start:0,deleteCount:e,elements:this._items})}}function _(l,r){const i=r.changes;for(let n=0;n<r.changes.length-1;n++){const e=i[n],t=i[n+1],o=e.originalStart,d=e.modifiedStart;e.originalLength===1&&e.modifiedLength===0&&t.originalStart===o+2&&t.originalLength===0&&t.modifiedStart===d+1&&t.modifiedLength===1&&l.original.notebook.cells[o].getHashValue()===l.modified.notebook.cells[d+1].getHashValue()&&l.original.notebook.cells[o+1].getHashValue()===l.modified.notebook.cells[d].getHashValue()&&(e.originalStart=o,e.originalLength=0,e.modifiedStart=d,e.modifiedLength=1,t.originalStart=o+1,t.originalLength=1,t.modifiedStart=d+2,t.modifiedLength=0,n++)}}function S(l,r){const i=r.cellsDiff.changes,n=[],e=l.original.notebook,t=l.modified.notebook;let o=0,d=0,s=-1;for(let a=0;a<i.length;a++){const f=i[a];for(let p=0;p<f.originalStart-o;p++){const w=e.cells[o+p],V=t.cells[d+p];w.getHashValue()===V.getHashValue()?n.push({originalCellIndex:o+p,modifiedCellIndex:d+p,type:"unchanged"}):(s===-1&&(s=n.length),n.push({originalCellIndex:o+p,modifiedCellIndex:d+p,type:"modified"}))}const u=T(f,e,t);u.length&&s===-1&&(s=n.length),n.push(...u),o=f.originalStart+f.originalLength,d=f.modifiedStart+f.modifiedLength}for(let a=o;a<e.cells.length;a++)n.push({originalCellIndex:a,modifiedCellIndex:a-o+d,type:"unchanged"});return{cellDiffInfo:n,firstChangeIndex:s}}function U(l,r,i){if(l.length!==r.length)return!1;const n=i.original.notebook,e=i.modified.notebook;for(let t=0;t<r.length;t++){const o=l[t],d=r[t];if(o.type!==d.type)return!1;switch(o.type){case"delete":{if(n.cells[o.originalCellIndex].handle!==d.original?.handle)return!1;continue}case"insert":{if(e.cells[o.modifiedCellIndex].handle!==d.modified?.handle)return!1;continue}default:{if(n.cells[o.originalCellIndex].handle!==d.original?.handle||e.cells[o.modifiedCellIndex].handle!==d.modified?.handle)return!1;continue}}}return!0}function R(l,r,i,n,e,t){const o=r.original.notebook,d=r.modified.notebook,s={metadataStatusHeight:l.getValue("notebook.diff.ignoreMetadata")?0:25,outputStatusHeight:l.getValue("notebook.diff.ignoreOutputs")||d.transientOptions.transientOutputs?0:25,fontInfo:e};return n.map(a=>{switch(a.type){case"delete":return new E(o,d,o.cells[a.originalCellIndex],void 0,"delete",i,s,t,l);case"insert":return new E(d,o,void 0,d.cells[a.modifiedCellIndex],"insert",i,s,t,l);case"modified":return new D(r.modified.notebook,r.original.notebook,o.cells[a.originalCellIndex],d.cells[a.modifiedCellIndex],"modified",i,s,t,l);case"unchanged":return new D(r.modified.notebook,r.original.notebook,o.cells[a.originalCellIndex],d.cells[a.modifiedCellIndex],"unchanged",i,s,t,l)}})}function T(l,r,i){const n=[],e=Math.min(l.originalLength,l.modifiedLength);for(let t=0;t<e;t++){const o=r.cells[l.originalStart+t].equal(i.cells[l.modifiedStart+t]);n.push({originalCellIndex:l.originalStart+t,modifiedCellIndex:l.modifiedStart+t,type:o?"unchanged":"modified"})}for(let t=e;t<l.originalLength;t++)n.push({originalCellIndex:l.originalStart+t,type:"delete"});for(let t=e;t<l.modifiedLength;t++)n.push({modifiedCellIndex:l.modifiedStart+t,type:"insert"});return n}class M extends N{constructor(i,n,e,t,o,d,s){super(i,n,e,s);this.type=t;this.containerType=o;this.kind=d}}class C extends M{constructor(r,i,n,e){super(r,i,i||r,n,e,"Cell",{[b.key]:"Cell",[y.key]:n})}}class g extends M{constructor(r,i,n,e){super(r,i,i||r,n,e,"Metadata",{[b.key]:"Metadata",[y.key]:n})}}class m extends M{constructor(r,i,n,e){super(r,i,i||r,n,e,"Output",{[b.key]:"Output",[y.key]:n})}}export{he as NotebookDiffViewModel,M as NotebookMultiDiffEditorItem,_ as prettyChanges};
