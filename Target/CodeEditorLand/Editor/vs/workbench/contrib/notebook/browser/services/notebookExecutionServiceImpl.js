var v=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var x=(s,e,i,r)=>{for(var o=r>1?void 0:r?k(e,i):e,c=s.length-1,u;c>=0;c--)(u=s[c])&&(o=(r?u(e,i,o):u(o))||o);return r&&o&&v(e,i,o),o},n=(s,e)=>(i,r)=>e(i,r,s);import"../../../../../../vs/base/common/cancellation.js";import{toDisposable as S}from"../../../../../../vs/base/common/lifecycle.js";import*as b from"../../../../../../vs/nls.js";import{ICommandService as f}from"../../../../../../vs/platform/commands/common/commands.js";import"../../../../../../vs/platform/contextkey/common/contextkey.js";import{IWorkspaceTrustRequestService as E}from"../../../../../../vs/platform/workspace/common/workspaceTrust.js";import{KernelPickerMRUStrategy as g}from"../../../../../../vs/workbench/contrib/notebook/browser/viewParts/notebookKernelQuickPickStrategy.js";import"../../../../../../vs/workbench/contrib/notebook/common/model/notebookCellTextModel.js";import{CellKind as C,NotebookCellExecutionState as I}from"../../../../../../vs/workbench/contrib/notebook/common/notebookCommon.js";import"../../../../../../vs/workbench/contrib/notebook/common/notebookExecutionService.js";import{INotebookExecutionStateService as N}from"../../../../../../vs/workbench/contrib/notebook/common/notebookExecutionStateService.js";import{INotebookKernelHistoryService as h,INotebookKernelService as y}from"../../../../../../vs/workbench/contrib/notebook/common/notebookKernelService.js";import{INotebookLoggingService as K}from"../../../../../../vs/workbench/contrib/notebook/common/notebookLoggingService.js";let m=class{constructor(e,i,r,o,c,u){this._commandService=e;this._notebookKernelService=i;this._notebookKernelHistoryService=r;this._workspaceTrustRequestService=o;this._logService=c;this._notebookExecutionStateService=u}_activeProxyKernelExecutionToken;async executeNotebookCells(e,i,r){const o=Array.from(i).filter(t=>t.cellKind===C.Code);if(!o.length)return;this._logService.debug("Execution",`${JSON.stringify(o.map(t=>t.handle))}`);const c=b.localize("notebookRunTrust","Executing a notebook cell will run code from this workspace.");if(!await this._workspaceTrustRequestService.requestWorkspaceTrust({message:c}))return;const p=[];for(const t of o)this._notebookExecutionStateService.getCellExecution(t.uri)||p.push([t,this._notebookExecutionStateService.createCellExecution(e.uri,t.handle)]);const d=await g.resolveKernel(e,this._notebookKernelService,this._notebookKernelHistoryService,this._commandService);if(!d){p.forEach(t=>t[1].complete({}));return}this._notebookKernelHistoryService.addMostRecentKernel(d);const a=[];for(const[t,l]of p)d.supportedLanguages.includes(t.language)?a.push(l):l.complete({});if(a.length>0){await this.runExecutionParticipants(a),this._notebookKernelService.selectKernelForNotebook(d,e),await d.executeNotebookCellsRequest(e.uri,a.map(l=>l.cellHandle));const t=a.filter(l=>l.state===I.Unconfirmed);t.length&&(this._logService.debug("Execution",`Completing unconfirmed executions ${JSON.stringify(t.map(l=>l.cellHandle))}`),t.forEach(l=>l.complete({}))),this._logService.debug("Execution",`Completed executions ${JSON.stringify(a.map(l=>l.cellHandle))}`)}}async cancelNotebookCellHandles(e,i){const r=Array.from(i);this._logService.debug("Execution",`CancelNotebookCellHandles ${JSON.stringify(r)}`);const o=this._notebookKernelService.getSelectedOrSuggestedKernel(e);o&&await o.cancelNotebookCellExecution(e.uri,r)}async cancelNotebookCells(e,i){this.cancelNotebookCellHandles(e,Array.from(i,r=>r.handle))}cellExecutionParticipants=new Set;registerExecutionParticipant(e){return this.cellExecutionParticipants.add(e),S(()=>this.cellExecutionParticipants.delete(e))}async runExecutionParticipants(e){for(const i of this.cellExecutionParticipants)await i.onWillExecuteCell(e)}dispose(){this._activeProxyKernelExecutionToken?.dispose(!0)}};m=x([n(0,f),n(1,y),n(2,h),n(3,E),n(4,K),n(5,N)],m);export{m as NotebookExecutionService};
