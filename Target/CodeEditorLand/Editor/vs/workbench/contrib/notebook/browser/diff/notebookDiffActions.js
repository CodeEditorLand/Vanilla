import{IBulkEditService as x,ResourceTextEdit as M}from"../../../../../editor/browser/services/bulkEditService.js";import{localize as p,localize2 as v}from"../../../../../nls.js";import{Action2 as u,MenuId as c,registerAction2 as l}from"../../../../../platform/actions/common/actions.js";import{IConfigurationService as q}from"../../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as i}from"../../../../../platform/contextkey/common/contextkey.js";import"../../../../../platform/instantiation/common/instantiation.js";import{ActiveEditorContext as s}from"../../../../common/contextkeys.js";import{SideBySideDiffElementViewModel as D}from"./diffElementViewModel.js";import{NOTEBOOK_DIFF_CELL_IGNORE_WHITESPACE_KEY as U,NOTEBOOK_DIFF_CELL_INPUT as k,NOTEBOOK_DIFF_CELL_PROPERTY as C,NOTEBOOK_DIFF_CELL_PROPERTY_EXPANDED as K,NOTEBOOK_DIFF_HAS_UNCHANGED_CELLS as O,NOTEBOOK_DIFF_ITEM_DIFF_STATE as y,NOTEBOOK_DIFF_ITEM_KIND as w,NOTEBOOK_DIFF_UNCHANGED_CELLS_HIDDEN as A}from"./notebookDiffEditorBrowser.js";import{NotebookTextDiffEditor as f}from"./notebookDiffEditor.js";import"../../common/notebookDiffEditorInput.js";import{nextChangeIcon as B,openAsTextIcon as L,previousChangeIcon as W,renderOutputIcon as H,revertIcon as T,toggleWhitespace as G}from"../notebookIcons.js";import{IEditorService as E}from"../../../../services/editor/common/editorService.js";import{Registry as Y}from"../../../../../platform/registry/common/platform.js";import{Extensions as j}from"../../../../../platform/configuration/common/configurationRegistry.js";import"../../../../../platform/action/common/action.js";import{DEFAULT_EDITOR_ASSOCIATION as z}from"../../../../common/editor.js";import{KeybindingWeight as R}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import{KeyCode as F,KeyMod as S}from"../../../../../base/common/keyCodes.js";import{CellEditType as b,NOTEBOOK_DIFF_EDITOR_ID as N}from"../../common/notebookCommon.js";import{ITextResourceConfigurationService as X}from"../../../../../editor/common/services/textResourceConfiguration.js";import{NotebookMultiTextDiffEditor as a}from"./notebookMultiDiffEditor.js";import{Codicon as h}from"../../../../../base/common/codicons.js";import{TextEditorSelectionRevealType as J}from"../../../../../platform/editor/common/editor.js";l(class extends u{constructor(){super({id:"notebook.diff.openFile",icon:h.goToFile,title:v("notebook.diff.openFile","Open File"),precondition:i.or(s.isEqualTo(f.ID),s.isEqualTo(a.ID)),menu:[{id:c.EditorTitle,group:"navigation",when:i.or(s.isEqualTo(f.ID),s.isEqualTo(a.ID))}]})}async run(n){const e=n.get(E),o=e.activeEditorPane;if(o&&(o instanceof f||o instanceof a)){const t=o.input.modified.resource;await e.openEditor({resource:t})}}}),l(class extends u{constructor(){super({id:"notebook.diff.cell.toggleCollapseUnchangedRegions",title:v("notebook.diff.cell.toggleCollapseUnchangedRegions","Toggle Collapse Unchanged Regions"),icon:h.map,toggled:i.has("config.diffEditor.hideUnchangedRegions.enabled"),precondition:s.isEqualTo(f.ID),menu:{id:c.EditorTitle,group:"navigation",when:s.isEqualTo(f.ID)}})}run(n,...e){const o=n.get(q),r=!o.getValue("diffEditor.hideUnchangedRegions.enabled");o.updateValue("diffEditor.hideUnchangedRegions.enabled",r)}}),l(class extends u{constructor(){super({id:"notebook.diff.switchToText",icon:L,title:v("notebook.diff.switchToText","Open Text Diff Editor"),precondition:i.or(s.isEqualTo(f.ID),s.isEqualTo(a.ID)),menu:[{id:c.EditorTitle,group:"navigation",when:i.or(s.isEqualTo(f.ID),s.isEqualTo(a.ID))}]})}async run(n){const e=n.get(E),o=e.activeEditorPane;if(o&&(o instanceof f||o instanceof a)){const r=o.input;await e.openEditor({original:{resource:r.original.resource},modified:{resource:r.resource},label:r.getName(),options:{preserveFocus:!1,override:z.id}})}}}),l(class extends u{constructor(){super({id:"notebook.diffEditor.showUnchangedCells",title:v("showUnchangedCells","Show Unchanged Cells"),icon:h.unfold,precondition:i.and(s.isEqualTo(a.ID),i.has(O.key)),menu:{when:i.and(s.isEqualTo(a.ID),i.has(O.key),i.equals(A.key,!0)),id:c.EditorTitle,order:22,group:"navigation"}})}run(n,...e){const o=n.get(E).activeEditorPane;o&&o instanceof a&&o.showUnchanged()}}),l(class extends u{constructor(){super({id:"notebook.diffEditor.hideUnchangedCells",title:v("hideUnchangedCells","Hide Unchanged Cells"),icon:h.fold,precondition:i.and(s.isEqualTo(a.ID),i.has(O.key)),menu:{when:i.and(s.isEqualTo(a.ID),i.has(O.key),i.equals(A.key,!1)),id:c.EditorTitle,order:22,group:"navigation"}})}run(n,...e){const o=n.get(E).activeEditorPane;o&&o instanceof a&&o.hideUnchanged()}}),l(class extends u{constructor(){super({id:"notebook.diffEditor.2.goToCell",title:v("goToCell","Go To Cell"),icon:h.goToFile,menu:{when:i.and(s.isEqualTo(a.ID),i.equals(w.key,"Cell"),i.notEquals(y.key,"delete")),id:c.MultiDiffEditorFileToolbar,order:0,group:"navigation"}})}async run(e,...o){const r=o[0],t=e.get(E);t.activeEditorPane instanceof a&&await t.openEditor({resource:r,options:{selectionRevealType:J.CenterIfOutsideViewport}})}});const _=p("notebook.diff.cell.revertInput","Revert Input");l(class extends u{constructor(){super({id:"notebook.diffEditor.2.cell.revertInput",title:_,icon:T,menu:{when:i.and(s.isEqualTo(a.ID),i.equals(w.key,"Cell"),i.equals(y.key,"modified")),id:c.MultiDiffEditorFileToolbar,order:2,group:"navigation"}})}async run(n,...e){const o=e[0],t=n.get(E).activeEditorPane;if(!(t instanceof a))return;const d=t.getDiffElementViewModel(o);if(d&&d instanceof D){const g=d.modified,m=d.original;if(!m||!g)return;await n.get(x).apply([new M(g.uri,{range:g.textModel.getFullModelRange(),text:m.textModel.getValue()})],{quotableLabel:"Revert Notebook Cell Content Change"})}}});const Q=p("notebook.diff.cell.revertOutputs","Revert Outputs");l(class extends u{constructor(){super({id:"notebook.diffEditor.2.cell.revertOutputs",title:Q,icon:T,f1:!1,menu:{when:i.and(s.isEqualTo(a.ID),i.equals(w.key,"Output"),i.equals(y.key,"modified")),id:c.MultiDiffEditorFileToolbar,order:2,group:"navigation"}})}async run(n,...e){const o=e[0],t=n.get(E).activeEditorPane;if(!(t instanceof a))return;const d=t.getDiffElementViewModel(o);if(d&&d instanceof D){const g=d.original,m=d.modifiedDocument.cells.findIndex(I=>I.handle===d.modified.handle);if(m===-1)return;d.mainDocumentTextModel.applyEdits([{editType:b.Output,index:m,outputs:g.outputs}],!0,void 0,()=>{},void 0,!0)}}});const P=p("notebook.diff.cell.revertMetadata","Revert Metadata");l(class extends u{constructor(){super({id:"notebook.diffEditor.2.cell.revertMetadata",title:P,icon:T,f1:!1,menu:{when:i.and(s.isEqualTo(a.ID),i.equals(w.key,"Metadata"),i.equals(y.key,"modified")),id:c.MultiDiffEditorFileToolbar,order:2,group:"navigation"}})}async run(n,...e){const o=e[0],t=n.get(E).activeEditorPane;if(!(t instanceof a))return;const d=t.getDiffElementViewModel(o);if(d&&d instanceof D){const g=d.original,m=d.modifiedDocument.cells.findIndex(I=>I.handle===d.modified.handle);if(m===-1)return;d.mainDocumentTextModel.applyEdits([{editType:b.Metadata,index:m,metadata:g.metadata}],!0,void 0,()=>{},void 0,!0)}}}),l(class extends u{constructor(){super({id:"notebook.diff.cell.revertMetadata",title:P,icon:T,f1:!1,menu:{id:c.NotebookDiffCellMetadataTitle,when:C},precondition:C})}run(n,e){if(!e||!(e instanceof D))return;const o=e.original,r=e.modified,t=e.mainDocumentTextModel.cells.indexOf(r.textModel);if(t===-1)return;const d=[{editType:b.Metadata,index:t,metadata:o.metadata}];e.original.language&&e.modified.language!==e.original.language&&d.push({editType:b.CellLanguage,index:t,language:e.original.language}),e.modifiedDocument.applyEdits(d,!0,void 0,()=>{},void 0,!0)}}),l(class extends u{constructor(){super({id:"notebook.diff.cell.switchOutputRenderingStyleToText",title:p("notebook.diff.cell.switchOutputRenderingStyleToText","Switch Output Rendering"),icon:H,f1:!1,menu:{id:c.NotebookDiffCellOutputsTitle,when:K}})}run(n,e){e&&(e.renderOutput=!e.renderOutput)}}),l(class extends u{constructor(){super({id:"notebook.diff.cell.revertOutputs",title:p("notebook.diff.cell.revertOutputs","Revert Outputs"),icon:T,f1:!1,menu:{id:c.NotebookDiffCellOutputsTitle,when:C},precondition:C})}run(n,e){if(!e||!(e instanceof D))return;const o=e.original,r=e.modified,t=e.mainDocumentTextModel.cells.indexOf(r.textModel);t!==-1&&e.mainDocumentTextModel.applyEdits([{editType:b.Output,index:t,outputs:o.outputs}],!0,void 0,()=>{},void 0,!0)}}),l(class extends u{constructor(){super({id:"notebook.toggle.diff.cell.ignoreTrimWhitespace",title:p("ignoreTrimWhitespace.label","Show Leading/Trailing Whitespace Differences"),icon:G,f1:!1,menu:{id:c.NotebookDiffCellInputTitle,when:k,order:1},precondition:k,toggled:i.equals(U,!1)})}run(n,e){const o=e;if(!o?.modified)return;const r=o.modified.uri,t=n.get(X),d="diffEditor.ignoreTrimWhitespace",g=t.getValue(r,d);t.updateValue(r,d,!g)}}),l(class extends u{constructor(){super({id:"notebook.diff.cell.revertInput",title:_,icon:T,f1:!1,menu:{id:c.NotebookDiffCellInputTitle,when:k,order:2},precondition:k})}run(n,e){if(!e)return;const o=e.original,r=e.modified;return!o||!r?void 0:n.get(x).apply([new M(r.uri,{range:r.textModel.getFullModelRange(),text:o.textModel.getValue()})],{quotableLabel:"Revert Notebook Cell Content Change"})}});class V extends u{constructor(o,r,t,d,g,m,I){super({id:o,title:r,precondition:t,menu:[{id:c.EditorTitle,group:"notebook",when:t,order:g}],toggled:d});this.toggleOutputs=m;this.toggleMetadata=I}async run(o){const r=o.get(q);if(this.toggleOutputs!==void 0){const t=r.getValue("notebook.diff.ignoreOutputs");r.updateValue("notebook.diff.ignoreOutputs",!t)}if(this.toggleMetadata!==void 0){const t=r.getValue("notebook.diff.ignoreMetadata");r.updateValue("notebook.diff.ignoreMetadata",!t)}}}l(class extends V{constructor(){super("notebook.diff.showOutputs",v("notebook.diff.showOutputs","Show Outputs Differences"),i.or(s.isEqualTo(f.ID),s.isEqualTo(a.ID)),i.notEquals("config.notebook.diff.ignoreOutputs",!0),2,!0,void 0)}}),l(class extends V{constructor(){super("notebook.diff.showMetadata",v("notebook.diff.showMetadata","Show Metadata Differences"),i.or(s.isEqualTo(f.ID),s.isEqualTo(a.ID)),i.notEquals("config.notebook.diff.ignoreMetadata",!0),1,void 0,!0)}}),l(class extends u{constructor(){super({id:"notebook.diff.action.previous",title:p("notebook.diff.action.previous.title","Show Previous Change"),icon:W,f1:!1,keybinding:{primary:S.Shift|S.Alt|F.F3,weight:R.WorkbenchContrib,when:s.isEqualTo(f.ID)},menu:{id:c.EditorTitle,group:"navigation",when:s.isEqualTo(f.ID)}})}run(n){const e=n.get(E);if(e.activeEditorPane?.getId()!==N)return;e.activeEditorPane.getControl()?.previousChange()}}),l(class extends u{constructor(){super({id:"notebook.diff.action.next",title:p("notebook.diff.action.next.title","Show Next Change"),icon:B,f1:!1,keybinding:{primary:S.Alt|F.F3,weight:R.WorkbenchContrib,when:s.isEqualTo(f.ID)},menu:{id:c.EditorTitle,group:"navigation",when:s.isEqualTo(f.ID)}})}run(n){const e=n.get(E);if(e.activeEditorPane?.getId()!==N)return;e.activeEditorPane.getControl()?.nextChange()}}),Y.as(j.Configuration).registerConfiguration({id:"notebook",order:100,type:"object",properties:{"notebook.diff.ignoreMetadata":{type:"boolean",default:!1,markdownDescription:p("notebook.diff.ignoreMetadata","Hide Metadata Differences")},"notebook.diff.ignoreOutputs":{type:"boolean",default:!1,markdownDescription:p("notebook.diff.ignoreOutputs","Hide Outputs Differences")}}});
