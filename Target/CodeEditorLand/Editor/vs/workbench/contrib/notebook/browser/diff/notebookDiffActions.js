import{Codicon as k}from"../../../../../base/common/codicons.js";import{KeyCode as x,KeyMod as S}from"../../../../../base/common/keyCodes.js";import{IBulkEditService as M,ResourceTextEdit as q}from"../../../../../editor/browser/services/bulkEditService.js";import{ITextResourceConfigurationService as V}from"../../../../../editor/common/services/textResourceConfiguration.js";import{localize as g,localize2 as v}from"../../../../../nls.js";import"../../../../../platform/action/common/action.js";import{Action2 as c,MenuId as u,registerAction2 as l}from"../../../../../platform/actions/common/actions.js";import{IConfigurationService as K}from"../../../../../platform/configuration/common/configuration.js";import{Extensions as B}from"../../../../../platform/configuration/common/configurationRegistry.js";import{ContextKeyExpr as t}from"../../../../../platform/contextkey/common/contextkey.js";import{TextEditorSelectionRevealType as L}from"../../../../../platform/editor/common/editor.js";import"../../../../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as A}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import{Registry as U}from"../../../../../platform/registry/common/platform.js";import{ActiveEditorContext as s}from"../../../../common/contextkeys.js";import{DEFAULT_EDITOR_ASSOCIATION as W}from"../../../../common/editor.js";import{IEditorService as E}from"../../../../services/editor/common/editorService.js";import{CellEditType as D,NOTEBOOK_DIFF_EDITOR_ID as F}from"../../common/notebookCommon.js";import"../../common/notebookDiffEditorInput.js";import{nextChangeIcon as H,openAsTextIcon as G,previousChangeIcon as Y,renderOutputIcon as j,revertIcon as T,toggleWhitespace as z}from"../notebookIcons.js";import{SideBySideDiffElementViewModel as b}from"./diffElementViewModel.js";import{NotebookTextDiffEditor as f}from"./notebookDiffEditor.js";import{NOTEBOOK_DIFF_CELL_IGNORE_WHITESPACE_KEY as X,NOTEBOOK_DIFF_CELL_INPUT as h,NOTEBOOK_DIFF_CELL_PROPERTY as C,NOTEBOOK_DIFF_CELL_PROPERTY_EXPANDED as J,NOTEBOOK_DIFF_HAS_UNCHANGED_CELLS as O,NOTEBOOK_DIFF_ITEM_DIFF_STATE as y,NOTEBOOK_DIFF_ITEM_KIND as w,NOTEBOOK_DIFF_UNCHANGED_CELLS_HIDDEN as N}from"./notebookDiffEditorBrowser.js";import{NotebookMultiTextDiffEditor as a}from"./notebookMultiDiffEditor.js";l(class extends c{constructor(){super({id:"notebook.diff.openFile",icon:k.goToFile,title:v("notebook.diff.openFile","Open File"),precondition:t.or(s.isEqualTo(f.ID),s.isEqualTo(a.ID)),menu:[{id:u.EditorTitle,group:"navigation",when:t.or(s.isEqualTo(f.ID),s.isEqualTo(a.ID))}]})}async run(n){const e=n.get(E),o=e.activeEditorPane;if(o&&(o instanceof f||o instanceof a)){const i=o.input.modified.resource;await e.openEditor({resource:i})}}}),l(class extends c{constructor(){super({id:"notebook.diff.switchToText",icon:G,title:v("notebook.diff.switchToText","Open Text Diff Editor"),precondition:t.or(s.isEqualTo(f.ID),s.isEqualTo(a.ID)),menu:[{id:u.EditorTitle,group:"navigation",when:t.or(s.isEqualTo(f.ID),s.isEqualTo(a.ID))}]})}async run(n){const e=n.get(E),o=e.activeEditorPane;if(o&&(o instanceof f||o instanceof a)){const r=o.input;await e.openEditor({original:{resource:r.original.resource},modified:{resource:r.resource},label:r.getName(),options:{preserveFocus:!1,override:W.id}})}}}),l(class extends c{constructor(){super({id:"notebook.diffEditor.showUnchangedCells",title:v("showUnchangedCells","Show Unchanged Cells"),icon:k.unfold,precondition:t.and(s.isEqualTo(a.ID),t.has(O.key)),menu:{when:t.and(s.isEqualTo(a.ID),t.has(O.key),t.equals(N.key,!0)),id:u.EditorTitle,order:22,group:"navigation"}})}run(n,...e){const o=n.get(E).activeEditorPane;o&&o instanceof a&&o.showUnchanged()}}),l(class extends c{constructor(){super({id:"notebook.diffEditor.hideUnchangedCells",title:v("hideUnchangedCells","Hide Unchanged Cells"),icon:k.fold,precondition:t.and(s.isEqualTo(a.ID),t.has(O.key)),menu:{when:t.and(s.isEqualTo(a.ID),t.has(O.key),t.equals(N.key,!1)),id:u.EditorTitle,order:22,group:"navigation"}})}run(n,...e){const o=n.get(E).activeEditorPane;o&&o instanceof a&&o.hideUnchanged()}}),l(class extends c{constructor(){super({id:"notebook.diffEditor.2.goToCell",title:v("goToCell","Go To Cell"),icon:k.goToFile,menu:{when:t.and(s.isEqualTo(a.ID),t.equals(w.key,"Cell"),t.notEquals(y.key,"delete")),id:u.MultiDiffEditorFileToolbar,order:0,group:"navigation"}})}async run(e,...o){const r=o[0],i=e.get(E);i.activeEditorPane instanceof a&&await i.openEditor({resource:r,options:{selectionRevealType:L.CenterIfOutsideViewport}})}});const _=g("notebook.diff.cell.revertInput","Revert Input");l(class extends c{constructor(){super({id:"notebook.diffEditor.2.cell.revertInput",title:_,icon:T,menu:{when:t.and(s.isEqualTo(a.ID),t.equals(w.key,"Cell"),t.equals(y.key,"modified")),id:u.MultiDiffEditorFileToolbar,order:2,group:"navigation"}})}async run(n,...e){const o=e[0],i=n.get(E).activeEditorPane;if(!(i instanceof a))return;const d=i.getDiffElementViewModel(o);if(d&&d instanceof b){const p=d.modified,m=d.original;if(!m||!p)return;await n.get(M).apply([new q(p.uri,{range:p.textModel.getFullModelRange(),text:m.textModel.getValue()})],{quotableLabel:"Revert Notebook Cell Content Change"})}}});const Q=g("notebook.diff.cell.revertOutputs","Revert Outputs");l(class extends c{constructor(){super({id:"notebook.diffEditor.2.cell.revertOutputs",title:Q,icon:T,f1:!1,menu:{when:t.and(s.isEqualTo(a.ID),t.equals(w.key,"Output"),t.equals(y.key,"modified")),id:u.MultiDiffEditorFileToolbar,order:2,group:"navigation"}})}async run(n,...e){const o=e[0],i=n.get(E).activeEditorPane;if(!(i instanceof a))return;const d=i.getDiffElementViewModel(o);if(d&&d instanceof b){const p=d.original,m=d.modifiedDocument.cells.findIndex(I=>I.handle===d.modified.handle);if(m===-1)return;d.mainDocumentTextModel.applyEdits([{editType:D.Output,index:m,outputs:p.outputs}],!0,void 0,()=>{},void 0,!0)}}});const P=g("notebook.diff.cell.revertMetadata","Revert Metadata");l(class extends c{constructor(){super({id:"notebook.diffEditor.2.cell.revertMetadata",title:P,icon:T,f1:!1,menu:{when:t.and(s.isEqualTo(a.ID),t.equals(w.key,"Metadata"),t.equals(y.key,"modified")),id:u.MultiDiffEditorFileToolbar,order:2,group:"navigation"}})}async run(n,...e){const o=e[0],i=n.get(E).activeEditorPane;if(!(i instanceof a))return;const d=i.getDiffElementViewModel(o);if(d&&d instanceof b){const p=d.original,m=d.modifiedDocument.cells.findIndex(I=>I.handle===d.modified.handle);if(m===-1)return;d.mainDocumentTextModel.applyEdits([{editType:D.Metadata,index:m,metadata:p.metadata}],!0,void 0,()=>{},void 0,!0)}}}),l(class extends c{constructor(){super({id:"notebook.diff.cell.revertMetadata",title:P,icon:T,f1:!1,menu:{id:u.NotebookDiffCellMetadataTitle,when:C},precondition:C})}run(n,e){if(!e||!(e.cell instanceof b))return;const o=e.cell.original,r=e.cell.modified,i=e.cell.mainDocumentTextModel.cells.indexOf(r.textModel);if(i===-1)return;const d=[{editType:D.Metadata,index:i,metadata:o.metadata}];e.cell.original.language&&e.cell.modified.language!==e.cell.original.language&&d.push({editType:D.CellLanguage,index:i,language:e.cell.original.language}),e.cell.modifiedDocument.applyEdits(d,!0,void 0,()=>{},void 0,!0)}}),l(class extends c{constructor(){super({id:"notebook.diff.cell.switchOutputRenderingStyleToText",title:g("notebook.diff.cell.switchOutputRenderingStyleToText","Switch Output Rendering"),icon:j,f1:!1,menu:{id:u.NotebookDiffCellOutputsTitle,when:J}})}run(n,e){e&&(e.cell.renderOutput=!e.cell.renderOutput)}}),l(class extends c{constructor(){super({id:"notebook.diff.cell.revertOutputs",title:g("notebook.diff.cell.revertOutputs","Revert Outputs"),icon:T,f1:!1,menu:{id:u.NotebookDiffCellOutputsTitle,when:C},precondition:C})}run(n,e){if(!e||!(e.cell instanceof b))return;const o=e.cell.original,r=e.cell.modified,i=e.cell.mainDocumentTextModel.cells.indexOf(r.textModel);i!==-1&&e.cell.mainDocumentTextModel.applyEdits([{editType:D.Output,index:i,outputs:o.outputs}],!0,void 0,()=>{},void 0,!0)}}),l(class extends c{constructor(){super({id:"notebook.toggle.diff.cell.ignoreTrimWhitespace",title:g("ignoreTrimWhitespace.label","Show Leading/Trailing Whitespace Differences"),icon:z,f1:!1,menu:{id:u.NotebookDiffCellInputTitle,when:h,order:1},precondition:h,toggled:t.equals(X,!1)})}run(n,e){const o=e?.cell;if(!o?.modified)return;const r=o.modified.uri,i=n.get(V),d="diffEditor.ignoreTrimWhitespace",p=i.getValue(r,d);i.updateValue(r,d,!p)}}),l(class extends c{constructor(){super({id:"notebook.diff.cell.revertInput",title:_,icon:T,f1:!1,menu:{id:u.NotebookDiffCellInputTitle,when:h,order:2},precondition:h})}run(n,e){if(!e)return;const o=e.cell.original,r=e.cell.modified;return!o||!r?void 0:n.get(M).apply([new q(r.uri,{range:r.textModel.getFullModelRange(),text:o.textModel.getValue()})],{quotableLabel:"Revert Notebook Cell Content Change"})}});class R extends c{constructor(o,r,i,d,p,m,I){super({id:o,title:r,precondition:i,menu:[{id:u.EditorTitle,group:"notebook",when:i,order:p}],toggled:d});this.toggleOutputs=m;this.toggleMetadata=I}async run(o){const r=o.get(K);if(this.toggleOutputs!==void 0){const i=r.getValue("notebook.diff.ignoreOutputs");r.updateValue("notebook.diff.ignoreOutputs",!i)}if(this.toggleMetadata!==void 0){const i=r.getValue("notebook.diff.ignoreMetadata");r.updateValue("notebook.diff.ignoreMetadata",!i)}}}l(class extends R{constructor(){super("notebook.diff.showOutputs",v("notebook.diff.showOutputs","Show Outputs Differences"),t.or(s.isEqualTo(f.ID),s.isEqualTo(a.ID)),t.notEquals("config.notebook.diff.ignoreOutputs",!0),2,!0,void 0)}}),l(class extends R{constructor(){super("notebook.diff.showMetadata",v("notebook.diff.showMetadata","Show Metadata Differences"),t.or(s.isEqualTo(f.ID),s.isEqualTo(a.ID)),t.notEquals("config.notebook.diff.ignoreMetadata",!0),1,void 0,!0)}}),l(class extends c{constructor(){super({id:"notebook.diff.action.previous",title:g("notebook.diff.action.previous.title","Show Previous Change"),icon:Y,f1:!1,keybinding:{primary:S.Shift|S.Alt|x.F3,weight:A.WorkbenchContrib,when:s.isEqualTo(f.ID)},menu:{id:u.EditorTitle,group:"navigation",when:s.isEqualTo(f.ID)}})}run(n){const e=n.get(E);if(e.activeEditorPane?.getId()!==F)return;e.activeEditorPane.getControl()?.previousChange()}}),l(class extends c{constructor(){super({id:"notebook.diff.action.next",title:g("notebook.diff.action.next.title","Show Next Change"),icon:H,f1:!1,keybinding:{primary:S.Alt|x.F3,weight:A.WorkbenchContrib,when:s.isEqualTo(f.ID)},menu:{id:u.EditorTitle,group:"navigation",when:s.isEqualTo(f.ID)}})}run(n){const e=n.get(E);if(e.activeEditorPane?.getId()!==F)return;e.activeEditorPane.getControl()?.nextChange()}}),U.as(B.Configuration).registerConfiguration({id:"notebook",order:100,type:"object",properties:{"notebook.diff.ignoreMetadata":{type:"boolean",default:!1,markdownDescription:g("notebook.diff.ignoreMetadata","Hide Metadata Differences")},"notebook.diff.ignoreOutputs":{type:"boolean",default:!1,markdownDescription:g("notebook.diff.ignoreOutputs","Hide Outputs Differences")}}});
