import{IBulkEditService as M,ResourceTextEdit as x}from"../../../../../editor/browser/services/bulkEditService.js";import{localize as p,localize2 as v}from"../../../../../nls.js";import{Action2 as c,MenuId as u,registerAction2 as l}from"../../../../../platform/actions/common/actions.js";import{IConfigurationService as q}from"../../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as t}from"../../../../../platform/contextkey/common/contextkey.js";import"../../../../../platform/instantiation/common/instantiation.js";import{ActiveEditorContext as a}from"../../../../common/contextkeys.js";import{SideBySideDiffElementViewModel as b}from"./diffElementViewModel.js";import{NOTEBOOK_DIFF_CELL_IGNORE_WHITESPACE_KEY as K,NOTEBOOK_DIFF_CELL_INPUT as h,NOTEBOOK_DIFF_CELL_PROPERTY as C,NOTEBOOK_DIFF_CELL_PROPERTY_EXPANDED as B,NOTEBOOK_DIFF_HAS_UNCHANGED_CELLS as O,NOTEBOOK_DIFF_ITEM_DIFF_STATE as w,NOTEBOOK_DIFF_ITEM_KIND as y,NOTEBOOK_DIFF_METADATA as A,NOTEBOOK_DIFF_UNCHANGED_CELLS_HIDDEN as N}from"./notebookDiffEditorBrowser.js";import{NotebookTextDiffEditor as f}from"./notebookDiffEditor.js";import"../../common/notebookDiffEditorInput.js";import{nextChangeIcon as L,openAsTextIcon as W,previousChangeIcon as H,renderOutputIcon as G,revertIcon as T,toggleWhitespace as Y}from"../notebookIcons.js";import{IEditorService as E}from"../../../../services/editor/common/editorService.js";import{Registry as j}from"../../../../../platform/registry/common/platform.js";import{Extensions as z}from"../../../../../platform/configuration/common/configurationRegistry.js";import"../../../../../platform/action/common/action.js";import{DEFAULT_EDITOR_ASSOCIATION as X}from"../../../../common/editor.js";import{KeybindingWeight as F}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import{KeyCode as R,KeyMod as S}from"../../../../../base/common/keyCodes.js";import{CellEditType as I,NOTEBOOK_DIFF_EDITOR_ID as _}from"../../common/notebookCommon.js";import{ITextResourceConfigurationService as J}from"../../../../../editor/common/services/textResourceConfiguration.js";import{NotebookMultiTextDiffEditor as s}from"./notebookMultiDiffEditor.js";import{Codicon as k}from"../../../../../base/common/codicons.js";import{TextEditorSelectionRevealType as Q}from"../../../../../platform/editor/common/editor.js";l(class extends c{constructor(){super({id:"notebook.diff.openFile",icon:k.goToFile,title:v("notebook.diff.openFile","Open File"),precondition:t.or(a.isEqualTo(f.ID),a.isEqualTo(s.ID)),menu:[{id:u.EditorTitle,group:"navigation",when:t.or(a.isEqualTo(f.ID),a.isEqualTo(s.ID))}]})}async run(i){const e=i.get(E),o=e.activeEditorPane;if(o&&(o instanceof f||o instanceof s)){const n=o.input.modified.resource;await e.openEditor({resource:n})}}}),l(class extends c{constructor(){super({id:"notebook.diff.cell.toggleCollapseUnchangedRegions",title:v("notebook.diff.cell.toggleCollapseUnchangedRegions","Toggle Collapse Unchanged Regions"),icon:k.map,toggled:t.has("config.diffEditor.hideUnchangedRegions.enabled"),precondition:a.isEqualTo(f.ID),menu:{id:u.EditorTitle,group:"navigation",when:a.isEqualTo(f.ID)}})}run(i,...e){const o=i.get(q),r=!o.getValue("diffEditor.hideUnchangedRegions.enabled");o.updateValue("diffEditor.hideUnchangedRegions.enabled",r)}}),l(class extends c{constructor(){super({id:"notebook.diff.switchToText",icon:W,title:v("notebook.diff.switchToText","Open Text Diff Editor"),precondition:t.or(a.isEqualTo(f.ID),a.isEqualTo(s.ID)),menu:[{id:u.EditorTitle,group:"navigation",when:t.or(a.isEqualTo(f.ID),a.isEqualTo(s.ID))}]})}async run(i){const e=i.get(E),o=e.activeEditorPane;if(o&&(o instanceof f||o instanceof s)){const r=o.input;await e.openEditor({original:{resource:r.original.resource},modified:{resource:r.resource},label:r.getName(),options:{preserveFocus:!1,override:X.id}})}}}),l(class extends c{constructor(){super({id:"notebook.diffEditor.showUnchangedCells",title:v("showUnchangedCells","Show Unchanged Cells"),icon:k.unfold,precondition:t.and(a.isEqualTo(s.ID),t.has(O.key)),menu:{when:t.and(a.isEqualTo(s.ID),t.has(O.key),t.equals(N.key,!0)),id:u.EditorTitle,order:22,group:"navigation"}})}run(i,...e){const o=i.get(E).activeEditorPane;o&&o instanceof s&&o.showUnchanged()}}),l(class extends c{constructor(){super({id:"notebook.diffEditor.hideUnchangedCells",title:v("hideUnchangedCells","Hide Unchanged Cells"),icon:k.fold,precondition:t.and(a.isEqualTo(s.ID),t.has(O.key)),menu:{when:t.and(a.isEqualTo(s.ID),t.has(O.key),t.equals(N.key,!1)),id:u.EditorTitle,order:22,group:"navigation"}})}run(i,...e){const o=i.get(E).activeEditorPane;o&&o instanceof s&&o.hideUnchanged()}}),l(class extends c{constructor(){super({id:"notebook.diffEditor.2.goToCell",title:v("goToCell","Go To Cell"),icon:k.goToFile,menu:{when:t.and(a.isEqualTo(s.ID),t.equals(y.key,"Cell"),t.notEquals(w.key,"delete")),id:u.MultiDiffEditorFileToolbar,order:0,group:"navigation"}})}async run(e,...o){const r=o[0],n=e.get(E);n.activeEditorPane instanceof s&&await n.openEditor({resource:r,options:{selectionRevealType:Q.CenterIfOutsideViewport}})}}),l(class extends c{constructor(){super({id:"notebook.diff.revertMetadata",title:p("notebook.diff.revertMetadata","Revert Notebook Metadata"),icon:T,f1:!1,menu:{id:u.NotebookDiffDocumentMetadata,when:A},precondition:A})}run(i,e){!e||!(i.get(E).activeEditorPane instanceof f)||e.modifiedDocumentTextModel.applyEdits([{editType:I.DocumentMetadata,metadata:e.originalMetadata.metadata}],!0,void 0,()=>{},void 0,!0)}});const P=p("notebook.diff.cell.revertInput","Revert Input");l(class extends c{constructor(){super({id:"notebook.diffEditor.2.cell.revertInput",title:P,icon:T,menu:{when:t.and(a.isEqualTo(s.ID),t.equals(y.key,"Cell"),t.equals(w.key,"modified")),id:u.MultiDiffEditorFileToolbar,order:2,group:"navigation"}})}async run(i,...e){const o=e[0],n=i.get(E).activeEditorPane;if(!(n instanceof s))return;const d=n.getDiffElementViewModel(o);if(d&&d instanceof b){const g=d.modified,m=d.original;if(!m||!g)return;await i.get(M).apply([new x(g.uri,{range:g.textModel.getFullModelRange(),text:m.textModel.getValue()})],{quotableLabel:"Revert Notebook Cell Content Change"})}}});const Z=p("notebook.diff.cell.revertOutputs","Revert Outputs");l(class extends c{constructor(){super({id:"notebook.diffEditor.2.cell.revertOutputs",title:Z,icon:T,f1:!1,menu:{when:t.and(a.isEqualTo(s.ID),t.equals(y.key,"Output"),t.equals(w.key,"modified")),id:u.MultiDiffEditorFileToolbar,order:2,group:"navigation"}})}async run(i,...e){const o=e[0],n=i.get(E).activeEditorPane;if(!(n instanceof s))return;const d=n.getDiffElementViewModel(o);if(d&&d instanceof b){const g=d.original,m=d.modifiedDocument.cells.findIndex(D=>D.handle===d.modified.handle);if(m===-1)return;d.mainDocumentTextModel.applyEdits([{editType:I.Output,index:m,outputs:g.outputs}],!0,void 0,()=>{},void 0,!0)}}});const V=p("notebook.diff.cell.revertMetadata","Revert Metadata");l(class extends c{constructor(){super({id:"notebook.diffEditor.2.cell.revertMetadata",title:V,icon:T,f1:!1,menu:{when:t.and(a.isEqualTo(s.ID),t.equals(y.key,"Metadata"),t.equals(w.key,"modified")),id:u.MultiDiffEditorFileToolbar,order:2,group:"navigation"}})}async run(i,...e){const o=e[0],n=i.get(E).activeEditorPane;if(!(n instanceof s))return;const d=n.getDiffElementViewModel(o);if(d&&d instanceof b){const g=d.original,m=d.modifiedDocument.cells.findIndex(D=>D.handle===d.modified.handle);if(m===-1)return;d.mainDocumentTextModel.applyEdits([{editType:I.Metadata,index:m,metadata:g.metadata}],!0,void 0,()=>{},void 0,!0)}}}),l(class extends c{constructor(){super({id:"notebook.diff.cell.revertMetadata",title:V,icon:T,f1:!1,menu:{id:u.NotebookDiffCellMetadataTitle,when:C},precondition:C})}run(i,e){if(!e||!(e instanceof b))return;const o=e.original,r=e.modified,n=e.mainDocumentTextModel.cells.indexOf(r.textModel);if(n===-1)return;const d=[{editType:I.Metadata,index:n,metadata:o.metadata}];e.original.language&&e.modified.language!==e.original.language&&d.push({editType:I.CellLanguage,index:n,language:e.original.language}),e.modifiedDocument.applyEdits(d,!0,void 0,()=>{},void 0,!0)}}),l(class extends c{constructor(){super({id:"notebook.diff.cell.switchOutputRenderingStyleToText",title:p("notebook.diff.cell.switchOutputRenderingStyleToText","Switch Output Rendering"),icon:G,f1:!1,menu:{id:u.NotebookDiffCellOutputsTitle,when:B}})}run(i,e){e&&(e.renderOutput=!e.renderOutput)}}),l(class extends c{constructor(){super({id:"notebook.diff.cell.revertOutputs",title:p("notebook.diff.cell.revertOutputs","Revert Outputs"),icon:T,f1:!1,menu:{id:u.NotebookDiffCellOutputsTitle,when:C},precondition:C})}run(i,e){if(!e||!(e instanceof b))return;const o=e.original,r=e.modified,n=e.mainDocumentTextModel.cells.indexOf(r.textModel);n!==-1&&e.mainDocumentTextModel.applyEdits([{editType:I.Output,index:n,outputs:o.outputs}],!0,void 0,()=>{},void 0,!0)}}),l(class extends c{constructor(){super({id:"notebook.toggle.diff.cell.ignoreTrimWhitespace",title:p("ignoreTrimWhitespace.label","Show Leading/Trailing Whitespace Differences"),icon:Y,f1:!1,menu:{id:u.NotebookDiffCellInputTitle,when:h,order:1},precondition:h,toggled:t.equals(K,!1)})}run(i,e){const o=e;if(!o?.modified)return;const r=o.modified.uri,n=i.get(J),d="diffEditor.ignoreTrimWhitespace",g=n.getValue(r,d);n.updateValue(r,d,!g)}}),l(class extends c{constructor(){super({id:"notebook.diff.cell.revertInput",title:P,icon:T,f1:!1,menu:{id:u.NotebookDiffCellInputTitle,when:h,order:2},precondition:h})}run(i,e){if(!e)return;const o=e.original,r=e.modified;return!o||!r?void 0:i.get(M).apply([new x(r.uri,{range:r.textModel.getFullModelRange(),text:o.textModel.getValue()})],{quotableLabel:"Revert Notebook Cell Content Change"})}});class U extends c{constructor(o,r,n,d,g,m,D){super({id:o,title:r,precondition:n,menu:[{id:u.EditorTitle,group:"notebook",when:n,order:g}],toggled:d});this.toggleOutputs=m;this.toggleMetadata=D}async run(o){const r=o.get(q);if(this.toggleOutputs!==void 0){const n=r.getValue("notebook.diff.ignoreOutputs");r.updateValue("notebook.diff.ignoreOutputs",!n)}if(this.toggleMetadata!==void 0){const n=r.getValue("notebook.diff.ignoreMetadata");r.updateValue("notebook.diff.ignoreMetadata",!n)}}}l(class extends U{constructor(){super("notebook.diff.showOutputs",v("notebook.diff.showOutputs","Show Outputs Differences"),t.or(a.isEqualTo(f.ID),a.isEqualTo(s.ID)),t.notEquals("config.notebook.diff.ignoreOutputs",!0),2,!0,void 0)}}),l(class extends U{constructor(){super("notebook.diff.showMetadata",v("notebook.diff.showMetadata","Show Metadata Differences"),t.or(a.isEqualTo(f.ID),a.isEqualTo(s.ID)),t.notEquals("config.notebook.diff.ignoreMetadata",!0),1,void 0,!0)}}),l(class extends c{constructor(){super({id:"notebook.diff.action.previous",title:p("notebook.diff.action.previous.title","Show Previous Change"),icon:H,f1:!1,keybinding:{primary:S.Shift|S.Alt|R.F3,weight:F.WorkbenchContrib,when:a.isEqualTo(f.ID)},menu:{id:u.EditorTitle,group:"navigation",when:a.isEqualTo(f.ID)}})}run(i){const e=i.get(E);if(e.activeEditorPane?.getId()!==_)return;e.activeEditorPane.getControl()?.previousChange()}}),l(class extends c{constructor(){super({id:"notebook.diff.action.next",title:p("notebook.diff.action.next.title","Show Next Change"),icon:L,f1:!1,keybinding:{primary:S.Alt|R.F3,weight:F.WorkbenchContrib,when:a.isEqualTo(f.ID)},menu:{id:u.EditorTitle,group:"navigation",when:a.isEqualTo(f.ID)}})}run(i){const e=i.get(E);if(e.activeEditorPane?.getId()!==_)return;e.activeEditorPane.getControl()?.nextChange()}}),j.as(z.Configuration).registerConfiguration({id:"notebook",order:100,type:"object",properties:{"notebook.diff.ignoreMetadata":{type:"boolean",default:!1,markdownDescription:p("notebook.diff.ignoreMetadata","Hide Metadata Differences")},"notebook.diff.ignoreOutputs":{type:"boolean",default:!1,markdownDescription:p("notebook.diff.ignoreOutputs","Hide Outputs Differences")}}});
