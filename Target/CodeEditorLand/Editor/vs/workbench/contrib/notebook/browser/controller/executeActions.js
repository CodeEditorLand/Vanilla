import{Iterable as G}from"../../../../../base/common/iterator.js";import{KeyCode as w,KeyMod as A}from"../../../../../base/common/keyCodes.js";import{isEqual as ie}from"../../../../../base/common/resources.js";import{ThemeIcon as U}from"../../../../../base/common/themables.js";import{ILanguageService as D}from"../../../../../editor/common/languages/language.js";import{localize as s,localize2 as q}from"../../../../../nls.js";import{MenuId as c,MenuRegistry as re,registerAction2 as d}from"../../../../../platform/actions/common/actions.js";import{IConfigurationService as le}from"../../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as t}from"../../../../../platform/contextkey/common/contextkey.js";import{EditorsOrder as se}from"../../../../common/editor.js";import{IEditorGroupsService as v}from"../../../../services/editor/common/editorGroupsService.js";import{IEditorService as h}from"../../../../services/editor/common/editorService.js";import{IDebugService as ce}from"../../../debug/common/debug.js";import{CTX_INLINE_CHAT_FOCUSED as P}from"../../../inlineChat/common/inlineChat.js";import{CellKind as I,CellUri as ae,NotebookSetting as T}from"../../common/notebookCommon.js";import{NOTEBOOK_CELL_EXECUTING as de,NOTEBOOK_CELL_EXECUTION_STATE as W,NOTEBOOK_CELL_LIST_FOCUSED as R,NOTEBOOK_CELL_TYPE as y,NOTEBOOK_HAS_RUNNING_CELL as N,NOTEBOOK_HAS_SOMETHING_RUNNING as E,NOTEBOOK_INTERRUPTIBLE_KERNEL as k,NOTEBOOK_IS_ACTIVE_EDITOR as g,NOTEBOOK_KERNEL_COUNT as ue,NOTEBOOK_KERNEL_SOURCE_COUNT as Ce,NOTEBOOK_LAST_CELL_FAILED as B,NOTEBOOK_MISSING_KERNEL_EXTENSION as be}from"../../common/notebookContextKeys.js";import{NotebookEditorInput as Ee}from"../../common/notebookEditorInput.js";import{INotebookExecutionStateService as X}from"../../common/notebookExecutionStateService.js";import{CellEditState as M,CellFocusMode as ke,EXECUTE_CELL_COMMAND_ID as ge,ScrollToRevealBehavior as H}from"../notebookBrowser.js";import*as C from"../notebookIcons.js";import{insertCell as F}from"./cellOperations.js";import{CTX_NOTEBOOK_CELL_CHAT_FOCUSED as pe}from"./chat/notebookChatContext.js";import{NotebookChatController as Ne}from"./chat/notebookChatController.js";import{CELL_TITLE_CELL_GROUP_ID as V,CellToolbarOrder as j,NOTEBOOK_EDITOR_WIDGET_ACTION_WEIGHT as K,NotebookAction as S,NotebookCellAction as $,NotebookMultiCellAction as _,cellExecutionArgs as z,executeNotebookCondition as Y,getContextFromActiveEditor as J,getContextFromUri as Q,parseMultiCellExecutionArgs as O}from"./coreActions.js";const me="notebook.execute",fe="notebook.cancelExecution",Ae="notebook.interruptExecution",ve="notebook.cell.cancelExecution",Ie="notebook.cell.executeAndFocusContainer",Z="notebook.cell.executeAndSelectBelow",ee="notebook.cell.executeAndInsertBelow",Te="notebook.cell.executeCellAndBelow",Se="notebook.cell.executeCellsAbove",_e="notebook.renderAllMarkdownCells",Oe="notebook.revealRunningCell",xe="notebook.revealLastFailedCell",p=t.and(y.isEqualTo("code"),t.or(t.greater(ue.key,0),t.greater(Ce.key,0),be)),x=t.and(p,de.toNegated());function oe(a){for(let o=0;o<a.notebookEditor.getLength();o++){const e=a.notebookEditor.cellAt(o);e.cellKind===I.Markup&&e.updateEditState(M.Preview,"renderAllMarkdownCells")}}async function L(a,o){const e=a.activeGroup;if(e&&e.activeEditor&&e.pinEditor(e.activeEditor),o.ui&&o.cell){if(await o.notebookEditor.executeNotebookCells(G.single(o.cell)),o.autoReveal){const n=o.notebookEditor.getCellIndex(o.cell);o.notebookEditor.revealCellRangeInView({start:n,end:n+1})}}else if(o.selectedCells?.length||o.cell){const n=o.selectedCells?.length?o.selectedCells:[o.cell];await o.notebookEditor.executeNotebookCells(n);const r=n[0];if(r&&o.autoReveal){const l=o.notebookEditor.getCellIndex(r);o.notebookEditor.revealCellRangeInView({start:l,end:l+1})}}let i;for(const[,n]of o.notebookEditor.codeEditors)if(ie(n.getModel()?.uri,(o.cell??o.selectedCells?.[0])?.uri)){i=n;break}}d(class extends S{constructor(){super({id:_e,title:s("notebookActions.renderMarkdown","Render All Markdown Cells")})}async runWithContext(o,e){oe(e)}}),d(class extends S{constructor(){super({id:me,title:s("notebookActions.executeNotebook","Run All"),icon:C.executeAllIcon,metadata:{description:s("notebookActions.executeNotebook","Run All"),args:[{name:"uri",description:"The document uri"}]},menu:[{id:c.EditorTitle,order:-1,group:"navigation",when:t.and(g,Y,t.or(k.toNegated(),E.toNegated()),t.notEquals("config.notebook.globalToolbar",!0))},{id:c.NotebookToolbar,order:-1,group:"navigation/execute",when:t.and(Y,t.or(k.toNegated(),E.toNegated()),t.and(E,k.toNegated())?.negate(),t.equals("config.notebook.globalToolbar",!0))}]})}getEditorContextFromArgsOrActive(o,e){return Q(o,e)??J(o.get(h))}async runWithContext(o,e){oe(e);const n=o.get(h).getEditors(se.MOST_RECENTLY_ACTIVE).find(l=>l.editor instanceof Ee&&l.editor.viewType===e.notebookEditor.textModel.viewType&&l.editor.resource.toString()===e.notebookEditor.textModel.uri.toString()),r=o.get(v);return n&&r.getGroup(n.groupId)?.pinEditor(n.editor),e.notebookEditor.executeNotebookCells()}}),d(class extends _{constructor(){super({id:ge,precondition:x,title:s("notebookActions.execute","Execute Cell"),keybinding:{when:t.or(R,t.and(pe,P)),primary:A.WinCtrl|w.Enter,win:{primary:A.CtrlCmd|A.Alt|w.Enter},weight:K},menu:{id:c.NotebookCellExecutePrimary,when:x,group:"inline"},metadata:{description:s("notebookActions.execute","Execute Cell"),args:z},icon:C.executeIcon})}parseArgs(o,...e){return O(o,...e)}async runWithContext(o,e){const i=o.get(v);e.ui&&await e.notebookEditor.focusNotebookCell(e.cell,"container",{skipReveal:!0});const n=Ne.get(e.notebookEditor),r=n?.getEditingCell();if(n?.hasFocus()&&r){const l=i.activeGroup;l&&l.activeEditor&&l.pinEditor(l.activeEditor),await e.notebookEditor.executeNotebookCells([r]);return}await L(i,e)}}),d(class extends _{constructor(){super({id:Se,precondition:p,title:s("notebookActions.executeAbove","Execute Above Cells"),menu:[{id:c.NotebookCellExecute,when:t.and(p,t.equals(`config.${T.consolidatedRunButton}`,!0))},{id:c.NotebookCellTitle,order:j.ExecuteAboveCells,group:V,when:t.and(p,t.equals(`config.${T.consolidatedRunButton}`,!1))}],icon:C.executeAboveIcon})}parseArgs(o,...e){return O(o,...e)}async runWithContext(o,e){let i;if(e.ui?(i=e.notebookEditor.getCellIndex(e.cell),await e.notebookEditor.focusNotebookCell(e.cell,"container",{skipReveal:!0})):i=Math.min(...e.selectedCells.map(n=>e.notebookEditor.getCellIndex(n))),typeof i=="number"){const n={start:0,end:i},r=e.notebookEditor.getCellsInRange(n);e.notebookEditor.executeNotebookCells(r)}}}),d(class extends _{constructor(){super({id:Te,precondition:p,title:s("notebookActions.executeBelow","Execute Cell and Below"),menu:[{id:c.NotebookCellExecute,when:t.and(p,t.equals(`config.${T.consolidatedRunButton}`,!0))},{id:c.NotebookCellTitle,order:j.ExecuteCellAndBelow,group:V,when:t.and(p,t.equals(`config.${T.consolidatedRunButton}`,!1))}],icon:C.executeBelowIcon})}parseArgs(o,...e){return O(o,...e)}async runWithContext(o,e){let i;if(e.ui?(i=e.notebookEditor.getCellIndex(e.cell),await e.notebookEditor.focusNotebookCell(e.cell,"container",{skipReveal:!0})):i=Math.min(...e.selectedCells.map(n=>e.notebookEditor.getCellIndex(n))),typeof i=="number"){const n={start:i,end:e.notebookEditor.getLength()},r=e.notebookEditor.getCellsInRange(n);e.notebookEditor.executeNotebookCells(r)}}}),d(class extends _{constructor(){super({id:Ie,precondition:x,title:s("notebookActions.executeAndFocusContainer","Execute Cell and Focus Container"),metadata:{description:s("notebookActions.executeAndFocusContainer","Execute Cell and Focus Container"),args:z},icon:C.executeIcon})}parseArgs(o,...e){return O(o,...e)}async runWithContext(o,e){const i=o.get(v);if(e.ui)await e.notebookEditor.focusNotebookCell(e.cell,"container",{skipReveal:!0});else{const n=e.selectedCells[0];n&&await e.notebookEditor.focusNotebookCell(n,"container",{skipReveal:!0})}await L(i,e)}});const te=t.or(t.equals(W.key,"executing"),t.equals(W.key,"pending"));d(class extends _{constructor(){super({id:ve,precondition:te,title:s("notebookActions.cancel","Stop Cell Execution"),icon:C.stopIcon,menu:{id:c.NotebookCellExecutePrimary,when:te,group:"inline"},metadata:{description:s("notebookActions.cancel","Stop Cell Execution"),args:[{name:"options",description:"The cell range options",schema:{type:"object",required:["ranges"],properties:{ranges:{type:"array",items:[{type:"object",required:["start","end"],properties:{start:{type:"number"},end:{type:"number"}}}]},document:{type:"object",description:"The document uri"}}}}]}})}parseArgs(o,...e){return O(o,...e)}async runWithContext(o,e){return e.ui?(await e.notebookEditor.focusNotebookCell(e.cell,"container",{skipReveal:!0}),e.notebookEditor.cancelNotebookCells(G.single(e.cell))):e.notebookEditor.cancelNotebookCells(e.selectedCells)}}),d(class extends ${constructor(){super({id:Z,precondition:t.or(x,y.isEqualTo("markup")),title:s("notebookActions.executeAndSelectBelow","Execute Notebook Cell and Select Below"),keybinding:{when:t.and(R,P.negate()),primary:A.Shift|w.Enter,weight:K}})}async runWithContext(o,e){const i=o.get(v),n=e.notebookEditor.getCellIndex(e.cell);if(typeof n!="number")return;const r=o.get(D),u=o.get(le).getValue(T.scrollToRevealCell);let b;if(u==="none"?b={skipReveal:!0}:b={revealBehavior:u==="fullCell"?H.fullCell:H.firstLine},e.cell.cellKind===I.Markup){const m=e.notebookEditor.cellAt(n+1);if(e.cell.updateEditState(M.Preview,Z),m)await e.notebookEditor.focusNotebookCell(m,"container",b);else{const f=F(r,e.notebookEditor,n,I.Markup,"below");f&&await e.notebookEditor.focusNotebookCell(f,"editor",b)}return}else{const m=e.notebookEditor.cellAt(n+1);if(m)await e.notebookEditor.focusNotebookCell(m,"container",b);else{const f=F(r,e.notebookEditor,n,I.Code,"below");f&&await e.notebookEditor.focusNotebookCell(f,"editor",b)}return L(i,e)}}}),d(class extends ${constructor(){super({id:ee,precondition:t.or(x,y.isEqualTo("markup")),title:s("notebookActions.executeAndInsertBelow","Execute Notebook Cell and Insert Below"),keybinding:{when:R,primary:A.Alt|w.Enter,weight:K}})}async runWithContext(o,e){const i=o.get(v),n=e.notebookEditor.getCellIndex(e.cell),r=o.get(D),l=e.cell.focusMode===ke.Editor?"editor":"container",u=F(r,e.notebookEditor,n,e.cell.cellKind,"below");u&&await e.notebookEditor.focusNotebookCell(u,l),e.cell.cellKind===I.Markup?e.cell.updateEditState(M.Preview,ee):L(i,e)}});class ne extends S{getEditorContextFromArgsOrActive(o,e){return Q(o,e)??J(o.get(h))}async runWithContext(o,e){return e.notebookEditor.cancelNotebookCells()}}d(class extends ne{constructor(){super({id:fe,title:q("notebookActions.cancelNotebook","Stop Execution"),icon:C.stopIcon,menu:[{id:c.EditorTitle,order:-1,group:"navigation",when:t.and(g,E,k.toNegated(),t.notEquals("config.notebook.globalToolbar",!0))},{id:c.NotebookToolbar,order:-1,group:"navigation/execute",when:t.and(E,k.toNegated(),t.equals("config.notebook.globalToolbar",!0))}]})}}),d(class extends ne{constructor(){super({id:Ae,title:q("notebookActions.interruptNotebook","Interrupt"),precondition:t.and(E,k),icon:C.stopIcon,menu:[{id:c.EditorTitle,order:-1,group:"navigation",when:t.and(g,E,k,t.notEquals("config.notebook.globalToolbar",!0))},{id:c.NotebookToolbar,order:-1,group:"navigation/execute",when:t.and(E,k,t.equals("config.notebook.globalToolbar",!0))},{id:c.InteractiveToolbar,group:"navigation/execute"}]})}}),re.appendMenuItem(c.NotebookToolbar,{title:s("revealRunningCellShort","Go To"),submenu:c.NotebookCellExecuteGoTo,group:"navigation/execute",order:20,icon:U.modify(C.executingStateIcon,"spin")}),d(class extends S{constructor(){super({id:Oe,title:s("revealRunningCell","Go to Running Cell"),tooltip:s("revealRunningCell","Go to Running Cell"),shortTitle:s("revealRunningCell","Go to Running Cell"),precondition:N,menu:[{id:c.EditorTitle,when:t.and(g,N,t.notEquals("config.notebook.globalToolbar",!0)),group:"navigation",order:0},{id:c.NotebookCellExecuteGoTo,when:t.and(g,N,t.equals("config.notebook.globalToolbar",!0)),group:"navigation/execute",order:20},{id:c.InteractiveToolbar,when:t.and(N,t.equals("activeEditor","workbench.editor.interactive")),group:"navigation",order:10}],icon:U.modify(C.executingStateIcon,"spin")})}async runWithContext(o,e){const i=o.get(X),n=e.notebookEditor.textModel.uri,r=i.getCellExecutionsForNotebook(n);if(r[0]){const u=this.findCellAtTopFrame(o,n)??r[0].cellHandle,b=e.notebookEditor.getCellByHandle(u);b&&e.notebookEditor.focusNotebookCell(b,"container")}}findCellAtTopFrame(o,e){const i=o.get(ce);for(const n of i.getModel().getSessions())for(const r of n.getAllThreads()){const l=r.getTopStackFrame();if(l){const u=ae.parse(l.source.uri);if(u&&u.notebook.toString()===e.toString())return u.handle}}}}),d(class extends S{constructor(){super({id:xe,title:s("revealLastFailedCell","Go to Most Recently Failed Cell"),tooltip:s("revealLastFailedCell","Go to Most Recently Failed Cell"),shortTitle:s("revealLastFailedCellShort","Go to Most Recently Failed Cell"),precondition:B,menu:[{id:c.EditorTitle,when:t.and(g,B,N.toNegated(),t.notEquals("config.notebook.globalToolbar",!0)),group:"navigation",order:0},{id:c.NotebookCellExecuteGoTo,when:t.and(g,B,N.toNegated(),t.equals("config.notebook.globalToolbar",!0)),group:"navigation/execute",order:20}],icon:C.errorStateIcon})}async runWithContext(o,e){const i=o.get(X),n=e.notebookEditor.textModel.uri,r=i.getLastFailedCellForNotebook(n);if(r!==void 0){const l=e.notebookEditor.getCellByHandle(r);l&&e.notebookEditor.focusNotebookCell(l,"container")}}});export{p as executeCondition,x as executeThisCellCondition};
