import{URI as a}from"../../../../../base/common/uri.js";import{localize as d,localize2 as y}from"../../../../../nls.js";import{Action2 as E,MenuId as s,MenuRegistry as C}from"../../../../../platform/actions/common/actions.js";import{ContextKeyExpr as c}from"../../../../../platform/contextkey/common/contextkey.js";import"../../../../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as b}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import{getNotebookEditorFromEditorPane as p,cellRangeToViewCells as v}from"../notebookBrowser.js";import{IS_COMPOSITE_NOTEBOOK as O,NOTEBOOK_EDITOR_EDITABLE as S,NOTEBOOK_EDITOR_FOCUSED as T,NOTEBOOK_IS_ACTIVE_EDITOR as x,NOTEBOOK_KERNEL_COUNT as _,NOTEBOOK_KERNEL_SOURCE_COUNT as M}from"../../common/notebookContextKeys.js";import{isICellRange as I}from"../../common/notebookRange.js";import{IEditorService as m}from"../../../../services/editor/common/editorService.js";import{isEditorCommandsContext as R}from"../../../../common/editor.js";import{INotebookEditorService as W}from"../services/notebookEditorService.js";import{ITelemetryService as w}from"../../../../../platform/telemetry/common/telemetry.js";import"../../../../../base/common/actions.js";import"../../../../../base/common/types.js";import"../../../../../base/common/jsonSchema.js";import{MarshalledId as U}from"../../../../../base/common/marshallingIds.js";import"../../../../../editor/browser/editorBrowser.js";import{isEqual as L}from"../../../../../base/common/resources.js";const Ie="_notebook.selectKernel",k=y("notebookActions.category","Notebook"),ke="inline/cell",ge="inline/output",he=b.EditorContrib,Ne=b.WorkbenchContrib+1;var P=(i=>(i[i.EditCell=0]="EditCell",i[i.ExecuteAboveCells=1]="ExecuteAboveCells",i[i.ExecuteCellAndBelow=2]="ExecuteCellAndBelow",i[i.SaveCell=3]="SaveCell",i[i.SplitCell=4]="SplitCell",i[i.ClearCellOutput=5]="ClearCellOutput",i))(P||{}),F=(r=>(r.Copy="1_copy",r.Insert="2_insert",r.Edit="3_edit",r.Share="4_share",r))(F||{});function g(n){const e=p(n.activeEditorPane);if(!e||!e.hasModel())return;const t=e.getActiveCell(),o=e.getSelectionViewModels();return{cell:t,selectedCells:o,notebookEditor:e}}function K(n,e){const o=n.get(W).listNotebookEditors().find(r=>r.hasModel()&&r.textModel.uri.toString()===e.toString());if(o&&o.hasModel())return o}function V(n,e){const t=a.revive(e);if(t){const o=K(n,t);if(o)return{notebookEditor:o}}}function ye(n,e){let t;for(const[,o]of n.notebookEditor.codeEditors)if(L(o.getModel()?.uri,e.uri)){t=o;break}return t}class B extends E{constructor(e){if(e.f1!==!1){e.f1=!1;const t={id:s.CommandPalette,when:c.or(x,O)};e.menu?Array.isArray(e.menu)||(e.menu=[e.menu]):e.menu=[],e.menu=[...e.menu,t]}e.category=k,super(e)}async run(e,t,...o){if(f(e,this.desc.id,t),!(!this.isNotebookActionContext(t)&&(t=this.getEditorContextFromArgsOrActive(e,t,...o),!t)))return this.runWithContext(e,t)}isNotebookActionContext(e){return!!e&&!!e.notebookEditor}getEditorContextFromArgsOrActive(e,t,...o){return g(e.get(m))}}class ve extends E{constructor(e){if(e.f1!==!1){e.f1=!1;const t={id:s.CommandPalette,when:x};e.menu?Array.isArray(e.menu)||(e.menu=[e.menu]):e.menu=[],e.menu=[...e.menu,t]}e.category=k,super(e)}parseArgs(e,...t){}async run(e,...t){const o=t[0];if(f(e,this.desc.id,o),h(o))return this.runWithContext(e,o);const l=this.parseArgs(e,...t);if(l)return this.runWithContext(e,l);const i=A(e);if(i){const u=i.getSelections().length===0?[i.getFocus()]:i.getSelections();return this.runWithContext(e,{ui:!1,notebookEditor:i,selectedCells:v(i,u)})}}}class Oe extends B{isCellActionContext(e){return!!e&&!!e.notebookEditor&&!!e.cell}getCellContextFromArgs(e,t,...o){}async run(e,t,...o){if(f(e,this.desc.id,t),this.isCellActionContext(t))return this.runWithContext(e,t);const r=this.getCellContextFromArgs(e,t,...o);if(r)return this.runWithContext(e,r);const l=this.getEditorContextFromArgsOrActive(e);if(this.isCellActionContext(l))return this.runWithContext(e,l)}}const Se=c.or(c.greater(_.key,0),c.greater(M.key,0));function f(n,e,t){if(t){const o=n.get(w);if(t.source)o.publicLog2("workbenchActionExecuted",{id:e,from:t.source});else if(a.isUri(t))o.publicLog2("workbenchActionExecuted",{id:e,from:"cellEditorContextMenu"});else if(t&&"from"in t&&t.from==="cellContainer")o.publicLog2("workbenchActionExecuted",{id:e,from:"cellContainer"});else{const r=h(t)?"cellToolbar":R(t)?"editorToolbar":"other";o.publicLog2("workbenchActionExecuted",{id:e,from:r})}}}function h(n){return!!n&&!!n.notebookEditor&&n.$mid===U.NotebookCellActionContext}function D(n){if(n===void 0)return!1;const e=n.ranges;return!(!e||!Array.isArray(e)||e.some(t=>!I(t))||n.document&&!a.revive(n.document))}function A(n,e){const t=V(n,e)?.notebookEditor;if(t)return t;const o=p(n.get(m).activeEditorPane);if(!(!o||!o.hasModel()))return o}function Te(n,...e){const t=e[0];if(D(t)){const r=A(n,t.document);if(!r)return;const i=t.ranges.map(N=>r.getCellsInRange(N).slice(0)).flat(),u=t.autoReveal;return{ui:!1,notebookEditor:r,selectedCells:i,autoReveal:u}}if(I(t)){const r=e[1],l=A(n,r);return l?{ui:!1,notebookEditor:l,selectedCells:l.getCellsInRange(t)}:void 0}const o=g(n.get(m));return o?{ui:!1,notebookEditor:o.notebookEditor,selectedCells:o.selectedCells??[],cell:o.cell}:void 0}const _e=[{isOptional:!0,name:"options",description:"The cell range options",schema:{type:"object",required:["ranges"],properties:{ranges:{type:"array",items:[{type:"object",required:["start","end"],properties:{start:{type:"number"},end:{type:"number"}}}]},document:{type:"object",description:"The document uri"},autoReveal:{type:"boolean",description:"Whether the cell should be revealed into view automatically"}}}}];C.appendMenuItem(s.NotebookCellTitle,{submenu:s.NotebookCellInsert,title:d("notebookMenu.insertCell","Insert Cell"),group:"2_insert",when:S.isEqualTo(!0)}),C.appendMenuItem(s.EditorContext,{submenu:s.NotebookCellTitle,title:d("notebookMenu.cellTitle","Notebook Cell"),group:"2_insert",when:T}),C.appendMenuItem(s.NotebookCellTitle,{title:d("miShare","Share"),submenu:s.EditorContextShare,group:"4_share"});export{ke as CELL_TITLE_CELL_GROUP_ID,ge as CELL_TITLE_OUTPUT_GROUP_ID,F as CellOverflowToolbarGroups,P as CellToolbarOrder,k as NOTEBOOK_ACTIONS_CATEGORY,he as NOTEBOOK_EDITOR_WIDGET_ACTION_WEIGHT,Ne as NOTEBOOK_OUTPUT_WEBVIEW_ACTION_WEIGHT,B as NotebookAction,Oe as NotebookCellAction,ve as NotebookMultiCellAction,Ie as SELECT_KERNEL_ID,_e as cellExecutionArgs,Se as executeNotebookCondition,ye as findTargetCellEditor,g as getContextFromActiveEditor,V as getContextFromUri,A as getEditorFromArgsOrActivePane,Te as parseMultiCellExecutionArgs};
