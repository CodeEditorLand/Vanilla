var K=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var v=(u,s,e,o)=>{for(var t=o>1?void 0:o?C(s,e):s,n=u.length-1,i;n>=0;n--)(i=u[n])&&(t=(o?i(s,e,t):i(t))||t);return o&&t&&K(s,e,t),t},g=(u,s)=>(e,o)=>s(e,o,u);import{Emitter as l}from"../../../../../base/common/event.js";import{Disposable as N,toDisposable as b}from"../../../../../base/common/lifecycle.js";import"../../common/notebookCommon.js";import"../../common/notebookKernelService.js";import{LRUCache as T,ResourceMap as x}from"../../../../../base/common/map.js";import{IStorageService as M,StorageScope as S,StorageTarget as w}from"../../../../../platform/storage/common/storage.js";import{URI as E}from"../../../../../base/common/uri.js";import{INotebookService as B}from"../../common/notebookService.js";import{IMenuService as P,MenuId as R}from"../../../../../platform/actions/common/actions.js";import{IContextKeyService as L}from"../../../../../platform/contextkey/common/contextkey.js";import"../../../../../base/common/actions.js";import{MarshalledId as O}from"../../../../../base/common/marshallingIds.js";import{Schemas as U}from"../../../../../base/common/network.js";import{getActiveWindow as W,runWhenWindowIdle as $}from"../../../../../base/browser/dom.js";class p{static _logicClock=0;kernel;score;time;notebookPriorities=new x;constructor(s){this.kernel=s,this.score=-1,this.time=p._logicClock++}}class h{static str(s){return`${s.notebookType}/${s.uri.toString()}`}static obj(s){const e=s.indexOf("/");return{notebookType:s.substring(0,e),uri:E.parse(s.substring(e+1))}}}class F extends N{constructor(e,o,t){super();this.action=e;this.model=o;this.isPrimary=t}execution;_onDidChangeState=this._register(new l);onDidChangeState=this._onDidChangeState.event;async runAction(){if(this.execution)return this.execution;this.execution=this._runAction(),this._onDidChangeState.fire(),await this.execution,this.execution=void 0,this._onDidChangeState.fire()}async _runAction(){try{await this.action.run({uri:this.model.uri,$mid:O.NotebookActionContext})}catch{}}}let a=class extends N{constructor(e,o,t,n){super();this._notebookService=e;this._storageService=o;this._menuService=t;this._contextKeyService=n;this._register(e.onDidAddNotebookDocument(this._tryAutoBindNotebook,this)),this._register(e.onWillRemoveNotebookDocument(i=>{const c=h.str(i);this._notebookBindings.get(c)&&i.uri.scheme===U.untitled&&this.selectKernelForNotebook(void 0,i),this._kernelSourceActionsUpdates.get(c)?.dispose(),this._kernelSourceActionsUpdates.delete(c)}));try{const i=JSON.parse(this._storageService.get(a._storageNotebookBinding,S.WORKSPACE,"[]"));this._notebookBindings.fromJSON(i)}catch{}}_kernels=new Map;_notebookBindings=new T(1e3,.7);_onDidChangeNotebookKernelBinding=this._register(new l);_onDidAddKernel=this._register(new l);_onDidRemoveKernel=this._register(new l);_onDidChangeNotebookAffinity=this._register(new l);_onDidChangeSourceActions=this._register(new l);_onDidNotebookVariablesChange=this._register(new l);_kernelSources=new Map;_kernelSourceActionsUpdates=new Map;_kernelDetectionTasks=new Map;_onDidChangeKernelDetectionTasks=this._register(new l);_kernelSourceActionProviders=new Map;onDidChangeSelectedNotebooks=this._onDidChangeNotebookKernelBinding.event;onDidAddKernel=this._onDidAddKernel.event;onDidRemoveKernel=this._onDidRemoveKernel.event;onDidChangeNotebookAffinity=this._onDidChangeNotebookAffinity.event;onDidChangeSourceActions=this._onDidChangeSourceActions.event;onDidChangeKernelDetectionTasks=this._onDidChangeKernelDetectionTasks.event;onDidNotebookVariablesUpdate=this._onDidNotebookVariablesChange.event;static _storageNotebookBinding="notebook.controller2NotebookBindings";dispose(){this._kernels.clear(),this._kernelSources.forEach(e=>{e.menu.dispose(),e.actions.forEach(o=>o[1].dispose())}),this._kernelSourceActionsUpdates.forEach(e=>{e.dispose()}),this._kernelSourceActionsUpdates.clear(),super.dispose()}_persistSoonHandle;_persistMementos(){this._persistSoonHandle?.dispose(),this._persistSoonHandle=$(W(),()=>{this._storageService.store(a._storageNotebookBinding,JSON.stringify(this._notebookBindings),S.WORKSPACE,w.MACHINE)},100)}static _score(e,o){return e.viewType==="*"?5:e.viewType===o.notebookType?10:0}_tryAutoBindNotebook(e,o){const t=this._notebookBindings.get(h.str(e));if(!t)return;const n=this._kernels.get(t);!n||!a._score(n.kernel,e)||(!o||n.kernel===o)&&this._onDidChangeNotebookKernelBinding.fire({notebook:e.uri,oldKernel:void 0,newKernel:n.kernel.id})}notifyVariablesChange(e){this._onDidNotebookVariablesChange.fire(e)}registerKernel(e){if(this._kernels.has(e.id))throw new Error(`NOTEBOOK CONTROLLER with id '${e.id}' already exists`);this._kernels.set(e.id,new p(e)),this._onDidAddKernel.fire(e);for(const o of this._notebookService.getNotebookTextModels())this._tryAutoBindNotebook(o,e);return b(()=>{this._kernels.delete(e.id)&&this._onDidRemoveKernel.fire(e);for(const[o,t]of Array.from(this._notebookBindings))t===e.id&&this._onDidChangeNotebookKernelBinding.fire({notebook:h.obj(o).uri,oldKernel:e.id,newKernel:void 0})})}getMatchingKernel(e){const o=[];for(const r of this._kernels.values()){const d=a._score(r.kernel,e);d&&o.push({score:d,kernel:r.kernel,instanceAffinity:r.notebookPriorities.get(e.uri)??1})}o.sort((r,d)=>d.instanceAffinity-r.instanceAffinity||r.score-d.score||r.kernel.label.localeCompare(d.kernel.label));const t=o.map(r=>r.kernel),n=this._notebookBindings.get(h.str(e)),i=n?this._kernels.get(n)?.kernel:void 0,c=o.filter(r=>r.instanceAffinity>1).map(r=>r.kernel),k=o.filter(r=>r.instanceAffinity<0).map(r=>r.kernel);return{all:t,selected:i,suggestions:c,hidden:k}}getSelectedOrSuggestedKernel(e){const o=this.getMatchingKernel(e);if(o.selected)return o.selected;const t=o.all.filter(n=>this._kernels.get(n.id)?.notebookPriorities.get(e.uri)===2);return t.length===1?t[0]:o.all.length===1?o.all[0]:void 0}selectKernelForNotebook(e,o){const t=h.str(o),n=this._notebookBindings.get(t);n!==e?.id&&(e?this._notebookBindings.set(t,e.id):this._notebookBindings.delete(t),this._onDidChangeNotebookKernelBinding.fire({notebook:o.uri,oldKernel:n,newKernel:e?.id}),this._persistMementos())}preselectKernelForNotebook(e,o){const t=h.str(o);this._notebookBindings.get(t)!==e?.id&&(this._notebookBindings.set(t,e.id),this._persistMementos())}updateKernelNotebookAffinity(e,o,t){const n=this._kernels.get(e.id);if(!n)throw new Error(`UNKNOWN kernel '${e.id}'`);t===void 0?n.notebookPriorities.delete(o):n.notebookPriorities.set(o,t),this._onDidChangeNotebookAffinity.fire()}getRunningSourceActions(e){const o=h.str(e),t=this._kernelSources.get(o);return t?t.actions.filter(n=>n[0].execution).map(n=>n[0]):[]}getSourceActions(e,o){o=o??this._contextKeyService;const t=h.str(e),n=this._kernelSources.get(t);if(n)return n.actions.map(r=>r[0]);const i=this._register(this._menuService.createMenu(R.NotebookKernelSource,o)),c={menu:i,actions:[]},k=(r,d)=>{const m=r.getActions({shouldForwardArgs:!0}),f=[];m.forEach(_=>{const A=/^primary/.test(_[0]);_[1].forEach(y=>{const I=new F(y,d,A),D=I.onDidChangeState(()=>{this._onDidChangeSourceActions.fire({notebook:d.uri,viewType:d.notebookType})});f.push([I,D])})}),c.actions=f,this._kernelSources.set(t,c),this._onDidChangeSourceActions.fire({notebook:d.uri,viewType:d.notebookType})};return this._kernelSourceActionsUpdates.get(t)?.dispose(),this._kernelSourceActionsUpdates.set(t,i.onDidChange(()=>{k(i,e)})),k(i,e),c.actions.map(r=>r[0])}registerNotebookKernelDetectionTask(e){const o=e.notebookType,t=this._kernelDetectionTasks.get(o)??[];return t.push(e),this._kernelDetectionTasks.set(o,t),this._onDidChangeKernelDetectionTasks.fire(o),b(()=>{const n=this._kernelDetectionTasks.get(o)??[],i=n.indexOf(e);i>=0&&(n.splice(i,1),this._kernelDetectionTasks.set(o,n),this._onDidChangeKernelDetectionTasks.fire(o))})}getKernelDetectionTasks(e){return this._kernelDetectionTasks.get(e.notebookType)??[]}registerKernelSourceActionProvider(e,o){const t=this._kernelSourceActionProviders.get(e)??[];t.push(o),this._kernelSourceActionProviders.set(e,t),this._onDidChangeSourceActions.fire({viewType:e});const n=o.onDidChangeSourceActions?.(()=>{this._onDidChangeSourceActions.fire({viewType:e})});return b(()=>{const i=this._kernelSourceActionProviders.get(e)??[],c=i.indexOf(o);c>=0&&(i.splice(c,1),this._kernelSourceActionProviders.set(e,i)),n?.dispose()})}getKernelSourceActions2(e){const o=e.notebookType,n=(this._kernelSourceActionProviders.get(o)??[]).map(i=>i.provideKernelSourceActions());return Promise.all(n).then(i=>i.reduce((c,k)=>c.concat(k),[]))}};a=v([g(0,B),g(1,M),g(2,P),g(3,L)],a);export{a as NotebookKernelService};
