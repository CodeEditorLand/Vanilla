import{LcsDiff as I}from"../../../../../base/common/diff/diff.js";import{doHash as k,hash as s,numberHash as D}from"../../../../../base/common/hash.js";import"../../../../../base/common/lifecycle.js";import{URI as h}from"../../../../../base/common/uri.js";import"../../../../../base/common/worker/simpleWorker.js";import{PieceTreeTextBufferBuilder as x}from"../../../../../editor/common/model/pieceTreeTextBuffer/pieceTreeTextBufferBuilder.js";import{CellKind as v,NotebookCellsChangeType as r}from"../notebookCommon.js";import{Range as N}from"../../../../../editor/common/core/range.js";import"../../../../../base/common/buffer.js";import{SearchParams as _}from"../../../../../editor/common/model/textModelSearch.js";import{MirrorModel as w}from"../../../../../editor/common/services/textModelSync/textModelSync.impl.js";import{DefaultEndOfLine as f}from"../../../../../editor/common/model.js";import"../../../../../editor/common/model/mirrorTextModel.js";function y(a){let t=D(104579,0);for(let e=0;e<a.buffer.length;e++)t=k(a.buffer[e],t);return t}class p{constructor(t,e,o,l,n,d,c,u,M,i){this.handle=t;this._eol=l;this.language=d;this.cellKind=c;this.outputs=u;this.metadata=M;this.internalMetadata=i;this.textModel=new w(e,o,l,n)}textModel;_hash=null;get eol(){return this._eol===`\r
`?f.CRLF:f.LF}onEvents(t){this.textModel.onEvents(t),this._hash=null}getValue(){return this.textModel.getValue()}getComparisonValue(){return this._hash=s([s(this.language),s(this.getValue()),this.metadata,this.internalMetadata,this.outputs.map(t=>({outputs:t.outputs.map(e=>({mime:e.mime,data:y(e.data)})),metadata:t.metadata}))]),this._hash}}class E{constructor(t,e,o){this.uri=t;this.cells=e;this.metadata=o}acceptModelChanged(t){t.rawEvents.forEach(e=>{if(e.kind===r.ModelChange)this._spliceNotebookCells(e.changes);else if(e.kind===r.Move){const o=this.cells.splice(e.index,1);this.cells.splice(e.newIdx,0,...o)}else if(e.kind===r.Output){const o=this.cells[e.index];o.outputs=e.outputs}else if(e.kind===r.ChangeCellLanguage){this._assertIndex(e.index);const o=this.cells[e.index];o.language=e.language}else if(e.kind===r.ChangeCellMetadata){this._assertIndex(e.index);const o=this.cells[e.index];o.metadata=e.metadata}else if(e.kind===r.ChangeCellInternalMetadata){this._assertIndex(e.index);const o=this.cells[e.index];o.internalMetadata=e.internalMetadata}else e.kind===r.ChangeDocumentMetadata&&(this.metadata=e.metadata)})}_assertIndex(t){if(t<0||t>=this.cells.length)throw new Error(`Illegal index ${t}. Cells length: ${this.cells.length}`)}_spliceNotebookCells(t){t.reverse().forEach(e=>{const l=e[2].map(n=>new p(n.handle,h.parse(n.url),n.source,n.eol,n.versionId,n.language,n.cellKind,n.outputs,n.metadata));this.cells.splice(e[0],e[1],...l)})}}class g{constructor(t){this.textModel=t}getElements(){const t=new Int32Array(this.textModel.cells.length);for(let e=0;e<this.textModel.cells.length;e++)t[e]=this.textModel.cells[e].getComparisonValue();return t}getCellHash(t){const e=Array.isArray(t.source)?t.source.join(`
`):t.source;return s([s(e),t.metadata])}}class S{_requestHandlerBrand;_models;constructor(){this._models=Object.create(null)}dispose(){}$acceptNewModel(t,e,o){this._models[t]=new E(h.parse(t),o.map(l=>new p(l.handle,h.parse(l.url),l.source,l.eol,l.versionId,l.language,l.cellKind,l.outputs,l.metadata)),e)}$acceptModelChanged(t,e){this._models[t]?.acceptModelChanged(e)}$acceptCellModelChanged(t,e,o){this._models[t].cells.find(n=>n.handle===e)?.onEvents(o)}$acceptRemovedModel(t){this._models[t]&&delete this._models[t]}$computeDiff(t,e){const o=this._getModel(t),l=this._getModel(e),d=new I(new g(o),new g(l)).ComputeDiff(!1);return{metadataChanged:JSON.stringify(o.metadata)!==JSON.stringify(l.metadata),cellsDiff:d}}$canPromptRecommendation(t){const o=this._getModel(t).cells;for(let l=0;l<o.length;l++){const n=o[l];if(n.cellKind===v.Markup||n.language!=="python")continue;const c=new _("import\\s*pandas|from\\s*pandas",!0,!1,null).parseSearchRequest();if(!c)continue;const u=new x;u.acceptChunk(n.getValue());const i=u.finish(!0).create(n.eol).textBuffer,C=i.getLineCount(),m=Math.min(C,20),b=new N(1,1,m,i.getLineLength(m)+1);if(i.findMatchesLineByLine(b,c,!0,1).length>0)return!0}return!1}_getModel(t){return this._models[t]}}function re(a){return new S}export{S as NotebookEditorSimpleWorker,re as create};
