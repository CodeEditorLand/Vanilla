var C=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var m=(d,t,e,i)=>{for(var o=i>1?void 0:i?w(t,e):t,r=d.length-1,n;r>=0;r--)(n=d[r])&&(o=(i?n(t,e,o):n(o))||o);return i&&o&&C(t,e,o),o},s=(d,t)=>(e,i)=>t(e,i,d);import{IInstantiationService as I}from"../../../../platform/instantiation/common/instantiation.js";import{URI as g}from"../../../../base/common/uri.js";import{CellUri as R,NotebookSetting as M,NotebookWorkingCopyTypeIdentifier as E}from"./notebookCommon.js";import{NotebookFileWorkingCopyModelFactory as U,SimpleNotebookEditorModel as u}from"./notebookEditorModel.js";import{combinedDisposable as W,DisposableStore as F,dispose as S,ReferenceCollection as x,toDisposable as T}from"../../../../base/common/lifecycle.js";import{INotebookService as _}from"./notebookService.js";import{AsyncEmitter as L,Emitter as N}from"../../../../base/common/event.js";import{IExtensionService as O}from"../../../services/extensions/common/extensions.js";import{IUriIdentityService as P}from"../../../../platform/uriIdentity/common/uriIdentity.js";import"./notebookEditorModelResolverService.js";import{ResourceMap as A}from"../../../../base/common/map.js";import{FileWorkingCopyManager as $}from"../../../services/workingCopy/common/fileWorkingCopyManager.js";import{Schemas as k}from"../../../../base/common/network.js";import{NotebookProviderInfo as V}from"./notebookProvider.js";import{assertIsDefined as j}from"../../../../base/common/types.js";import{CancellationToken as q}from"../../../../base/common/cancellation.js";import{IConfigurationService as B}from"../../../../platform/configuration/common/configuration.js";import"../../../../platform/files/common/files.js";import{ITelemetryService as K}from"../../../../platform/telemetry/common/telemetry.js";import{INotebookLoggingService as z}from"./notebookLoggingService.js";let v=class extends x{constructor(e,i,o,r,n){super();this._instantiationService=e;this._notebookService=i;this._configurationService=o;this._telemetryService=r;this._notebookLoggingService=n}_disposables=new F;_workingCopyManagers=new Map;_modelListener=new Map;_onDidSaveNotebook=new N;onDidSaveNotebook=this._onDidSaveNotebook.event;_onDidChangeDirty=new N;onDidChangeDirty=this._onDidChangeDirty.event;_dirtyStates=new A;modelsToDispose=new Set;dispose(){this._disposables.dispose(),this._onDidSaveNotebook.dispose(),this._onDidChangeDirty.dispose(),S(this._modelListener.values()),S(this._workingCopyManagers.values())}isDirty(e){return this._dirtyStates.get(e)??!1}async createReferencedObject(e,i,o,r,n,c){this.modelsToDispose.delete(e);const h=g.parse(e),b=E.create(i,c);let f=this._workingCopyManagers.get(b);if(!f){const p=new U(i,this._notebookService,this._configurationService,this._telemetryService,this._notebookLoggingService);f=this._instantiationService.createInstance($,b,p,p),this._workingCopyManagers.set(b,f)}const D=n||i==="interactive"&&this._configurationService.getValue(M.InteractiveWindowPromptToSave)!==!0,a=await this._instantiationService.createInstance(u,h,o,i,f,D).load({limits:r});let l;return this._modelListener.set(a,W(a.onDidSave(()=>this._onDidSaveNotebook.fire(a.resource)),a.onDidChangeDirty(()=>{const p=a.isDirty();this._dirtyStates.set(a.resource,p),p&&!l?l=this.acquire(e,i):l&&(l.dispose(),l=void 0),this._onDidChangeDirty.fire(a)}),T(()=>l?.dispose()))),a}destroyReferencedObject(e,i){this.modelsToDispose.add(e),(async()=>{try{const o=await i;if(!this.modelsToDispose.has(e)||(o instanceof u&&await o.canDispose(),!this.modelsToDispose.has(e)))return;this._modelListener.get(o)?.dispose(),this._modelListener.delete(o),o.dispose()}catch(o){this._notebookLoggingService.error("NotebookModelCollection","FAILED to destory notebook - "+o)}finally{this.modelsToDispose.delete(e)}})()}};v=m([s(0,I),s(1,_),s(2,B),s(3,K),s(4,z)],v);let y=class{constructor(t,e,i,o){this._notebookService=e;this._extensionService=i;this._uriIdentService=o;this._data=t.createInstance(v),this.onDidSaveNotebook=this._data.onDidSaveNotebook,this.onDidChangeDirty=this._data.onDidChangeDirty}_serviceBrand;_data;onDidSaveNotebook;onDidChangeDirty;_onWillFailWithConflict=new L;onWillFailWithConflict=this._onWillFailWithConflict.event;dispose(){this._data.dispose()}isDirty(t){return this._data.isDirty(t)}createUntitledUri(t){const e=this._notebookService.getContributedNotebookType(j(t));if(!e)throw new Error("UNKNOWN notebook type: "+t);const i=V.possibleFileEnding(e.selectors)??"";for(let o=1;;o++){const r=g.from({scheme:k.untitled,path:`Untitled-${o}${i}`,query:t});if(!this._notebookService.getNotebookTextModel(r))return r}}async validateResourceViewType(t,e){if(!t&&!e)throw new Error("Must provide at least one of resource or viewType");if(t?.scheme===R.scheme)throw new Error(`CANNOT open a cell-uri as notebook. Tried with ${t.toString()}`);const i=this._uriIdentService.asCanonicalUri(t??this.createUntitledUri(e)),o=this._notebookService.getNotebookTextModel(i);if(!e)if(o)e=o.viewType;else{await this._extensionService.whenInstalledExtensionsRegistered();const r=this._notebookService.getContributedNotebookTypes(i);e=r.find(n=>n.priority==="exclusive")?.id??r.find(n=>n.priority==="default")?.id??r[0]?.id}if(!e)throw new Error(`Missing viewType for '${i}'`);if(o&&o.viewType!==e){await this._onWillFailWithConflict.fireAsync({resource:i,viewType:e},q.None);const r=this._notebookService.getNotebookTextModel(i)?.viewType;if(r&&r!==e)throw new Error(`A notebook with view type '${r}' already exists for '${i}', CANNOT create another notebook with view type ${e}`)}return{resource:i,viewType:e}}async createUntitledNotebookTextModel(t){const e=this._uriIdentService.asCanonicalUri(this.createUntitledUri(t));return await this._notebookService.createNotebookTextModel(t,e)}async resolve(t,e,i){let o,r;g.isUri(t)?o=t:t.untitledResource&&(t.untitledResource.scheme===k.untitled?o=t.untitledResource:(o=t.untitledResource.with({scheme:k.untitled}),r=!0));const n=await this.validateResourceViewType(o,e),c=this._data.acquire(n.resource.toString(),n.viewType,r,i?.limits,i?.scratchpad,i?.viewType);try{return{object:await c.object,dispose(){c.dispose()}}}catch(h){throw c.dispose(),h}}};y=m([s(0,I),s(1,_),s(2,O),s(3,P)],y);export{y as NotebookModelResolverServiceImpl};
