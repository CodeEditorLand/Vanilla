var w=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var k=(l,i,e,t)=>{for(var o=t>1?void 0:t?I(i,e):i,r=l.length-1,n;r>=0;r--)(n=l[r])&&(o=(t?n(i,e,o):n(o))||o);return t&&o&&w(i,e,o),o},p=(l,i)=>(e,t)=>i(e,t,l);import{bufferToStream as M,streamToBuffer as D}from"../../../../base/common/buffer.js";import{CancellationError as v}from"../../../../base/common/errors.js";import{Emitter as g}from"../../../../base/common/event.js";import{Disposable as F,DisposableStore as W}from"../../../../base/common/lifecycle.js";import{Schemas as C}from"../../../../base/common/network.js";import{filter as f}from"../../../../base/common/objects.js";import{assertType as m}from"../../../../base/common/types.js";import{IConfigurationService as R}from"../../../../platform/configuration/common/configuration.js";import{ITelemetryService as N}from"../../../../platform/telemetry/common/telemetry.js";import{EditorModel as E}from"../../../common/editor/editorModel.js";import{IFilesConfigurationService as T}from"../../../services/filesConfiguration/common/filesConfigurationService.js";import{SnapshotContext as P}from"../../../services/workingCopy/common/fileWorkingCopy.js";import{StoredFileWorkingCopyState as S}from"../../../services/workingCopy/common/storedFileWorkingCopy.js";import{WorkingCopyCapabilities as U}from"../../../services/workingCopy/common/workingCopy.js";import{NotebookCellsChangeType as L,NotebookSetting as _}from"./notebookCommon.js";import{INotebookLoggingService as O}from"./notebookLoggingService.js";import{INotebookService as z,SimpleNotebookProviderInfo as x}from"./notebookService.js";let s=class extends E{constructor(e,t,o,r,n,y){super();this.resource=e;this._hasAssociatedFilePath=t;this.viewType=o;this._workingCopyManager=r;this._filesConfigurationService=y;this.scratchPad=n}_onDidChangeDirty=this._register(new g);_onDidSave=this._register(new g);_onDidChangeOrphaned=this._register(new g);_onDidChangeReadonly=this._register(new g);_onDidRevertUntitled=this._register(new g);onDidChangeDirty=this._onDidChangeDirty.event;onDidSave=this._onDidSave.event;onDidChangeOrphaned=this._onDidChangeOrphaned.event;onDidChangeReadonly=this._onDidChangeReadonly.event;onDidRevertUntitled=this._onDidRevertUntitled.event;_workingCopy;_workingCopyListeners=this._register(new W);scratchPad;dispose(){this._workingCopy?.dispose(),super.dispose()}get notebook(){return this._workingCopy?.model?.notebookModel}isResolved(){return!!this._workingCopy?.model?.notebookModel}async canDispose(){return this._workingCopy&&s._isStoredFileWorkingCopy(this._workingCopy)?this._workingCopyManager.stored.canDispose(this._workingCopy):!0}isDirty(){return this._workingCopy?.isDirty()??!1}isModified(){return this._workingCopy?.isModified()??!1}isOrphaned(){return s._isStoredFileWorkingCopy(this._workingCopy)&&this._workingCopy.hasState(S.ORPHAN)}hasAssociatedFilePath(){return!s._isStoredFileWorkingCopy(this._workingCopy)&&!!this._workingCopy?.hasAssociatedFilePath}isReadonly(){return s._isStoredFileWorkingCopy(this._workingCopy)?this._workingCopy?.isReadonly():this._filesConfigurationService.isReadonly(this.resource)}get hasErrorState(){return this._workingCopy&&"hasState"in this._workingCopy?this._workingCopy.hasState(S.ERROR):!1}revert(e){return m(this.isResolved()),this._workingCopy.revert(e)}save(e){return m(this.isResolved()),this._workingCopy.save(e)}async load(e){return!this._workingCopy||!this._workingCopy.model?(this.resource.scheme===C.untitled?(this._hasAssociatedFilePath?this._workingCopy=await this._workingCopyManager.resolve({associatedResource:this.resource}):this._workingCopy=await this._workingCopyManager.resolve({untitledResource:this.resource,isScratchpad:this.scratchPad}),this._workingCopy.onDidRevert(()=>this._onDidRevertUntitled.fire())):(this._workingCopy=await this._workingCopyManager.resolve(this.resource,{limits:e?.limits,reload:e?.forceReadFromFile?{async:!1,force:!0}:void 0}),this._workingCopyListeners.add(this._workingCopy.onDidSave(t=>this._onDidSave.fire(t))),this._workingCopyListeners.add(this._workingCopy.onDidChangeOrphaned(()=>this._onDidChangeOrphaned.fire())),this._workingCopyListeners.add(this._workingCopy.onDidChangeReadonly(()=>this._onDidChangeReadonly.fire()))),this._workingCopyListeners.add(this._workingCopy.onDidChangeDirty(()=>this._onDidChangeDirty.fire(),void 0)),this._workingCopyListeners.add(this._workingCopy.onWillDispose(()=>{this._workingCopyListeners.clear(),this._workingCopy?.model?.dispose()}))):await this._workingCopyManager.resolve(this.resource,{reload:{async:!e?.forceReadFromFile,force:e?.forceReadFromFile},limits:e?.limits}),m(this.isResolved()),this}async saveAs(e){const t=await this._workingCopyManager.saveAs(this.resource,e);if(t)return{resource:t.resource}}static _isStoredFileWorkingCopy(e){return!(e&&e.capabilities&U.Untitled)}};s=k([p(5,T)],s);class A extends F{constructor(e,t,o,r,n){super();this._notebookModel=e;this._notebookService=t;this._configurationService=o;this._telemetryService=r;this._notebookLogService=n;this.onWillDispose=e.onWillDispose.bind(e),this._register(e.onDidChangeContent(a=>{for(const d of a.rawEvents)if(d.kind!==L.Initialize&&!d.transient){this._onDidChangeContent.fire({isRedoing:!1,isUndoing:!1,isInitial:!1});break}}));const y=this._configurationService.getValue(_.remoteSaving);(y||e.uri.scheme===C.vscodeRemote)&&(this.configuration={backupDelay:1e4}),y&&this.setSaveDelegate().catch(console.error)}_onDidChangeContent=this._register(new g);onDidChangeContent=this._onDidChangeContent.event;onWillDispose;configuration=void 0;save;async setSaveDelegate(){await this.getNotebookSerializer(),this.save=async(e,t)=>{try{let o=this._notebookService.tryGetDataProviderSync(this.notebookModel.viewType)?.serializer;if(o||(this._notebookLogService.info("WorkingCopyModel","No serializer found for notebook model, checking if provider still needs to be resolved"),o=await this.getNotebookSerializer()),t.isCancellationRequested)throw new v;return await o.save(this._notebookModel.uri,this._notebookModel.versionId,e,t)}catch(o){throw t.isCancellationRequested||this._telemetryService.publicLogError2("notebook/SaveError",{isRemote:this._notebookModel.uri.scheme===C.vscodeRemote,error:o}),o}}}dispose(){this._notebookModel.dispose(),super.dispose()}get notebookModel(){return this._notebookModel}async snapshot(e,t){const o=await this.getNotebookSerializer(),r={metadata:f(this._notebookModel.metadata,a=>!o.options.transientDocumentMetadata[a]),cells:[]};let n=0;for(const a of this._notebookModel.cells){const d={cellKind:a.cellKind,language:a.language,mime:a.mime,source:a.getValue(),outputs:[],internalMetadata:a.internalMetadata},u=this._configurationService.getValue(_.outputBackupSizeLimit)*1024;if(e===P.Backup&&u>0&&(a.outputs.forEach(c=>{c.outputs.forEach(b=>{n+=b.data.byteLength})}),n>u))throw new Error("Notebook too large to backup");d.outputs=o.options.transientOutputs?[]:a.outputs,d.metadata=f(a.metadata,c=>!o.options.transientCellMetadata[c]),r.cells.push(d)}const y=await o.notebookToData(r);if(t.isCancellationRequested)throw new v;return M(y)}async update(e,t){const o=await this.getNotebookSerializer(),r=await D(e),n=await o.dataToNotebook(r);if(t.isCancellationRequested)throw new v;this._notebookLogService.info("WorkingCopyModel","Notebook content updated from file system - "+this._notebookModel.uri.toString()),this._notebookModel.reset(n.cells,n.metadata,o.options)}async getNotebookSerializer(){const e=await this._notebookService.withNotebookDataProvider(this.notebookModel.viewType);if(!(e instanceof x))throw new Error("CANNOT open file notebook with this provider");return e.serializer}get versionId(){return this._notebookModel.alternativeVersionId}pushStackElement(){this._notebookModel.pushStackElement()}}let h=class{constructor(i,e,t,o,r){this._viewType=i;this._notebookService=e;this._configurationService=t;this._telemetryService=o;this._notebookLogService=r}async createModel(i,e,t){const o=this._notebookService.getNotebookTextModel(i)??await this._notebookService.createNotebookTextModel(this._viewType,i,e);return new A(o,this._notebookService,this._configurationService,this._telemetryService,this._notebookLogService)}};h=k([p(1,z),p(2,R),p(3,N),p(4,O)],h);export{A as NotebookFileWorkingCopyModel,h as NotebookFileWorkingCopyModelFactory,s as SimpleNotebookEditorModel};
