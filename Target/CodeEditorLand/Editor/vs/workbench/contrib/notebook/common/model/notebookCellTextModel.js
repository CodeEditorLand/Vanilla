import{ThrottledDelayer as m}from"../../../../../../vs/base/common/async.js";import{Emitter as o}from"../../../../../../vs/base/common/event.js";import{hash as d,StringSHA1 as c}from"../../../../../../vs/base/common/hash.js";import{Disposable as C,DisposableStore as x,dispose as v}from"../../../../../../vs/base/common/lifecycle.js";import"../../../../../../vs/base/common/uri.js";import*as M from"../../../../../../vs/base/common/uuid.js";import{Range as I}from"../../../../../../vs/editor/common/core/range.js";import"../../../../../../vs/editor/common/languages/language.js";import{PLAINTEXT_LANGUAGE_ID as D}from"../../../../../../vs/editor/common/languages/modesRegistry.js";import*as l from"../../../../../../vs/editor/common/model.js";import{PieceTreeTextBuffer as L}from"../../../../../../vs/editor/common/model/pieceTreeTextBuffer/pieceTreeTextBuffer.js";import{PieceTreeTextBufferBuilder as O}from"../../../../../../vs/editor/common/model/pieceTreeTextBuffer/pieceTreeTextBufferBuilder.js";import"../../../../../../vs/editor/common/model/textModel.js";import{NotebookCellOutputTextModel as T}from"../../../../../../vs/workbench/contrib/notebook/common/model/notebookCellOutputTextModel.js";import"../../../../../../vs/workbench/contrib/notebook/common/notebookCommon.js";import"../../../../../../vs/workbench/services/languageDetection/common/languageDetectionWorkerService.js";class g extends C{constructor(t,e,a,n,i,s,h,f,p,y,S,E,B=void 0){super();this.uri=t;this.handle=e;this._source=a;this._language=n;this._mime=i;this.cellKind=s;this.collapseState=y;this.transientOptions=S;this._languageService=E;this._languageDetectionService=B;this._outputs=h.map(_=>new T(_)),this._metadata=f??{},this._internalMetadata=p??{}}_onDidChangeOutputs=this._register(new o);onDidChangeOutputs=this._onDidChangeOutputs.event;_onDidChangeOutputItems=this._register(new o);onDidChangeOutputItems=this._onDidChangeOutputItems.event;_onDidChangeContent=this._register(new o);onDidChangeContent=this._onDidChangeContent.event;_onDidChangeMetadata=this._register(new o);onDidChangeMetadata=this._onDidChangeMetadata.event;_onDidChangeInternalMetadata=this._register(new o);onDidChangeInternalMetadata=this._onDidChangeInternalMetadata.event;_onDidChangeLanguage=this._register(new o);onDidChangeLanguage=this._onDidChangeLanguage.event;_outputs;get outputs(){return this._outputs}_metadata;get metadata(){return this._metadata}set metadata(t){this._metadata=t,this._hash=null,this._onDidChangeMetadata.fire()}_internalMetadata;get internalMetadata(){return this._internalMetadata}set internalMetadata(t){const e=this._internalMetadata.lastRunSuccess!==t.lastRunSuccess;t={...t,runStartTimeAdjustment:b(this._internalMetadata,t)},this._internalMetadata=t,this._hash=null,this._onDidChangeInternalMetadata.fire({lastRunSuccessChanged:e})}get language(){return this._language}set language(t){this._textModel&&this._textModel.getLanguageId()===this._languageService.getLanguageIdByLanguageName(t)&&this._textModel.getLanguageId()===this._languageService.getLanguageIdByLanguageName(this.language)||(this._hasLanguageSetExplicitly=!0,this._setLanguageInternal(t))}get mime(){return this._mime}set mime(t){this._mime!==t&&(this._mime=t,this._hash=null,this._onDidChangeContent.fire("mime"))}_textBuffer;get textBuffer(){if(this._textBuffer)return this._textBuffer;const t=new O;t.acceptChunk(this._source);const e=t.finish(!0),{textBuffer:a,disposable:n}=e.create(l.DefaultEndOfLine.LF);return this._textBuffer=a,this._register(n),this._register(this._textBuffer.onDidChangeContent(()=>{this._hash=null,this._textModel||this._onDidChangeContent.fire("content"),this.autoDetectLanguage()})),this._textBuffer}_textBufferHash=null;_hash=null;_versionId=1;_alternativeId=1;get alternativeId(){return this._alternativeId}_textModelDisposables=this._register(new x);_textModel=void 0;get textModel(){return this._textModel}set textModel(t){this._textModel!==t&&(this._textModelDisposables.clear(),this._textModel=t,this._textModel&&(this.setRegisteredLanguage(this._languageService,this._textModel.getLanguageId(),this.language),this._textModelDisposables.add(this._textModel.onDidChangeLanguage(e=>this.setRegisteredLanguage(this._languageService,e.newLanguage,this.language))),this._textModelDisposables.add(this._textModel.onWillDispose(()=>this.textModel=void 0)),this._textModelDisposables.add(this._textModel.onDidChangeContent(()=>{this._textModel&&(this._versionId=this._textModel.getVersionId(),this._alternativeId=this._textModel.getAlternativeVersionId()),this._onDidChangeContent.fire("content")})),this._textModel._overwriteVersionId(this._versionId),this._textModel._overwriteAlternativeVersionId(this._versionId)))}setRegisteredLanguage(t,e,a){const n=e===D||e==="jupyter";!t.isRegisteredLanguageId(a)&&n?this._onDidChangeLanguage.fire(a):this.language=e}static AUTO_DETECT_LANGUAGE_THROTTLE_DELAY=600;autoDetectLanguageThrottler=this._register(new m(g.AUTO_DETECT_LANGUAGE_THROTTLE_DELAY));_autoLanguageDetectionEnabled=!1;_hasLanguageSetExplicitly=!1;get hasLanguageSetExplicitly(){return this._hasLanguageSetExplicitly}enableAutoLanguageDetection(){this._autoLanguageDetectionEnabled=!0,this.autoDetectLanguage()}async autoDetectLanguage(){this._autoLanguageDetectionEnabled&&this.autoDetectLanguageThrottler.trigger(()=>this._doAutoDetectLanguage())}async _doAutoDetectLanguage(){if(this.hasLanguageSetExplicitly)return;const t=await this._languageDetectionService?.detectLanguage(this.uri);t&&(this._textModel&&this._textModel.getLanguageId()===this._languageService.getLanguageIdByLanguageName(t)&&this._textModel.getLanguageId()===this._languageService.getLanguageIdByLanguageName(this.language)||this._setLanguageInternal(t))}_setLanguageInternal(t){const e=this._languageService.getLanguageIdByLanguageName(t);if(e!==null){if(this._textModel){const a=this._languageService.createById(e);this._textModel.setLanguage(a.languageId)}this._language!==t&&(this._language=t,this._hash=null,this._onDidChangeLanguage.fire(t),this._onDidChangeContent.fire("language"))}}resetTextBuffer(t){this._textBuffer=t}getValue(){const t=this.getFullModelRange();return this.textBuffer.getEOL()===`
`?this.textBuffer.getValueInRange(t,l.EndOfLinePreference.LF):this.textBuffer.getValueInRange(t,l.EndOfLinePreference.CRLF)}getTextBufferHash(){if(this._textBufferHash!==null)return this._textBufferHash;const t=new c,e=this.textBuffer.createSnapshot(!1);let a;for(;a=e.read();)t.update(a);return this._textBufferHash=t.digest(),this._textBufferHash}getHashValue(){return this._hash!==null?this._hash:(this._hash=d([d(this.language),this.getTextBufferHash(),this._getPersisentMetadata(),this.transientOptions.transientOutputs?[]:this._outputs.map(t=>({outputs:t.outputs.map(e=>({mime:e.mime,data:Array.from(e.data.buffer)})),metadata:t.metadata}))]),this._hash)}_getPersisentMetadata(){const t={},e=this.transientOptions.transientCellMetadata,a=new Set([...Object.keys(this.metadata)]);for(const n of a)e[n]||(t[n]=this.metadata[n]);return t}getTextLength(){return this.textBuffer.getLength()}getFullModelRange(){const t=this.textBuffer.getLineCount();return new I(1,1,t,this.textBuffer.getLineLength(t)+1)}spliceNotebookCellOutputs(t){if(t.deleteCount>0&&t.newOutputs.length>0){const e=Math.min(t.deleteCount,t.newOutputs.length);for(let n=0;n<e;n++){const i=this.outputs[t.start+n],s=t.newOutputs[n];this.replaceOutput(i.outputId,s)}this.outputs.splice(t.start+e,t.deleteCount-e,...t.newOutputs.slice(e)).forEach(n=>n.dispose()),this._onDidChangeOutputs.fire({start:t.start+e,deleteCount:t.deleteCount-e,newOutputs:t.newOutputs.slice(e)})}else this.outputs.splice(t.start,t.deleteCount,...t.newOutputs).forEach(a=>a.dispose()),this._onDidChangeOutputs.fire(t)}replaceOutput(t,e){const a=this.outputs.findIndex(i=>i.outputId===t);return a<0?!1:(this.outputs[a].replaceData({outputs:e.outputs,outputId:e.outputId,metadata:e.metadata}),e.dispose(),this._onDidChangeOutputItems.fire(),!0)}changeOutputItems(t,e,a){const n=this.outputs.findIndex(s=>s.outputId===t);if(n<0)return!1;const i=this.outputs[n];return e?i.appendData(a):i.replaceData({outputId:t,outputs:a,metadata:i.metadata}),this._onDidChangeOutputItems.fire(),!0}_outputNotEqualFastCheck(t,e){if(t.length!==e.length)return!1;for(let a=0;a<this.outputs.length;a++){const n=t[a],i=e[a];if(n.outputs.length!==i.outputs.length)return!1;for(let s=0;s<n.outputs.length;s++)if(n.outputs[s].mime!==i.outputs[s].mime||n.outputs[s].data.byteLength!==i.outputs[s].data.byteLength)return!1}return!0}equal(t){return this.language!==t.language||this.getTextLength()!==t.getTextLength()||!this.transientOptions.transientOutputs&&!this._outputNotEqualFastCheck(this.outputs,t.outputs)?!1:this.getHashValue()===t.getHashValue()}fastEqual(t){return this.language!==t.language||this.mime!==t.mime||this.cellKind!==t.cellKind||this.internalMetadata?.executionOrder!==t.internalMetadata?.executionOrder||this.internalMetadata?.lastRunSuccess!==t.internalMetadata?.lastRunSuccess||this.internalMetadata?.runStartTime!==t.internalMetadata?.runStartTime||this.internalMetadata?.runStartTimeAdjustment!==t.internalMetadata?.runStartTimeAdjustment||this.internalMetadata?.runEndTime!==t.internalMetadata?.runEndTime||this._textBuffer&&this.getValue()!==t.source?!1:this._source===t.source}dispose(){v(this._outputs);const t=new L([],"",`
`,!1,!1,!0,!0);t.dispose(),this._textBuffer=t,super.dispose()}}function lt(u){return{source:u.getValue(),language:u.language,mime:u.mime,cellKind:u.cellKind,outputs:u.outputs.map(r=>({outputs:r.outputs,outputId:M.generateUuid()})),metadata:{}}}function b(u,r){if(u.runStartTime!==r.runStartTime&&typeof r.runStartTime=="number"){const t=Date.now()-r.runStartTime;return t<0?Math.abs(t):0}else return r.runStartTimeAdjustment}export{g as NotebookCellTextModel,lt as cloneNotebookCellTextModel};
