var E=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var v=(s,c,e,t)=>{for(var i=t>1?void 0:t?D(c,e):c,r=s.length-1,o;r>=0;r--)(o=s[r])&&(i=(t?o(c,e,i):o(i))||i);return t&&i&&E(c,e,i),i},n=(s,c)=>(e,t)=>c(e,t,s);import{VSBuffer as w}from"../../../../base/common/buffer.js";import{onUnexpectedError as C}from"../../../../base/common/errors.js";import*as _ from"../../../../base/common/glob.js";import"../../../../base/common/htmlContent.js";import"../../../../base/common/lifecycle.js";import{Schemas as N}from"../../../../base/common/network.js";import{isEqual as j,joinPath as I}from"../../../../base/common/resources.js";import"../../../../base/common/uri.js";import{ITextResourceConfigurationService as U}from"../../../../editor/common/services/textResourceConfiguration.js";import{localize as b}from"../../../../nls.js";import{IFileDialogService as x}from"../../../../platform/dialogs/common/dialogs.js";import"../../../../platform/editor/common/editor.js";import{IFileService as P}from"../../../../platform/files/common/files.js";import"../../../../platform/instantiation/common/instantiation.js";import{ILabelService as T}from"../../../../platform/label/common/label.js";import{EditorInputCapabilities as d,Verbosity as L}from"../../../common/editor.js";import"../../../common/editor/editorInput.js";import{AbstractResourceEditorInput as A}from"../../../common/editor/resourceEditorInput.js";import{ICustomEditorLabelService as O}from"../../../services/editor/common/customEditorLabelService.js";import{IEditorService as F}from"../../../services/editor/common/editorService.js";import{IExtensionService as $}from"../../../services/extensions/common/extensions.js";import{IFilesConfigurationService as G}from"../../../services/filesConfiguration/common/filesConfigurationService.js";import"../../../services/workingCopy/common/workingCopy.js";import{CellEditType as W}from"./notebookCommon.js";import{INotebookEditorModelResolverService as z}from"./notebookEditorModelResolverService.js";import"./notebookPerformance.js";import"./notebookProvider.js";import{INotebookService as B,SimpleNotebookProviderInfo as H}from"./notebookService.js";let l=class extends A{constructor(e,t,i,r,o,f,a,m,y,R,g,p,S,k){super(e,t,m,y,R,S,k);this.viewType=i;this.options=r;this._notebookService=o;this._notebookModelResolverService=f;this._fileDialogService=a;this._defaultDirtyState=!!r.startDirty,this._sideLoadedListener=o.onDidAddNotebookDocument(u=>{u.viewType===this.viewType&&u.uri.toString()===this.resource.toString()&&this.resolve().catch(C)}),this._register(g.onWillStop(u=>{if(!u.auto&&!this.isDirty())return;const M=u.auto?b("vetoAutoExtHostRestart","One of the opened editors is a notebook editor."):b("vetoExtHostRestart","Notebook '{0}' could not be saved.",this.resource.path);u.veto((async()=>{const h=p.findEditors(this);return u.auto?!0:!(h.length>0&&(await p.save(h[0])).success)})(),M)}))}static getOrCreate(e,t,i,r,o={}){const f=e.createInstance(l,t,i,r,o);return i&&f.setPreferredResource(i),f}static ID="workbench.input.notebook";editorModelReference=null;_sideLoadedListener;_defaultDirtyState=!1;dispose(){this._sideLoadedListener.dispose(),this.editorModelReference?.dispose(),this.editorModelReference=null,super.dispose()}get typeId(){return l.ID}get editorId(){return this.viewType}get capabilities(){let e=d.None;return this.resource.scheme===N.untitled&&(e|=d.Untitled),this.editorModelReference?this.editorModelReference.object.isReadonly()&&(e|=d.Readonly):this.filesConfigurationService.isReadonly(this.resource)&&(e|=d.Readonly),e&d.Readonly||(e|=d.CanDropIntoEditor),e}getDescription(e=L.MEDIUM){if(!this.hasCapability(d.Untitled)||this.editorModelReference?.object.hasAssociatedFilePath())return super.getDescription(e)}isReadonly(){return this.editorModelReference?this.editorModelReference.object.isReadonly():this.filesConfigurationService.isReadonly(this.resource)}isDirty(){return this.editorModelReference?this.editorModelReference.object.isDirty():this._defaultDirtyState}isSaving(){const e=this.editorModelReference?.object;return!e||!e.isDirty()||e.hasErrorState||this.hasCapability(d.Untitled)?!1:this.filesConfigurationService.hasShortAutoSaveDelay(this)}async save(e,t){if(this.editorModelReference)return this.hasCapability(d.Untitled)?this.saveAs(e,t):(await this.editorModelReference.object.save(t),this)}async saveAs(e,t){if(!this.editorModelReference)return;const i=this._notebookService.getContributedNotebookType(this.viewType);if(!i)return;const r=this.hasCapability(d.Untitled)?await this._suggestName(i,this.labelService.getUriBasenameLabel(this.resource)):this.editorModelReference.object.resource;let o;if(this.editorModelReference.object.hasAssociatedFilePath())o=r;else if(o=await this._fileDialogService.pickFileToSave(r,t?.availableFileSystems),!o)return;if(!i.matches(o)){const f=i.selectors.map(a=>typeof a=="string"?a:_.isRelativePattern(a)?`${a} (base ${a.base})`:a.exclude?`${a.include} (exclude: ${a.exclude})`:`${a.include}`).join(", ");throw new Error(`File name ${o} is not supported by ${i.providerDisplayName}.

Please make sure the file name matches following patterns:
${f}`)}return await this.editorModelReference.object.saveAs(o)}async _suggestName(e,t){const i=e.selectors[0];let r=i&&typeof i=="string"?i:void 0;if(!r&&i){const o=i.include;typeof o=="string"&&(r=o)}if(r){const o=/^\*\.([A-Za-z_-]*)$/.exec(r);if(o&&o.length>1){const f=o[1];if(!t.endsWith(f))return I(await this._fileDialogService.defaultFilePath(),t+"."+f)}}return I(await this._fileDialogService.defaultFilePath(),t)}async rename(e,t){if(this.editorModelReference)return{editor:{resource:t},options:{override:this.viewType}}}async revert(e,t){this.editorModelReference&&this.editorModelReference.object.isDirty()&&await this.editorModelReference.object.revert(t)}async resolve(e,t){if(!await this._notebookService.canResolve(this.viewType))return null;if(t?.mark("extensionActivated"),this._sideLoadedListener.dispose(),this.editorModelReference)this.editorModelReference.object.load({limits:this.ensureLimits(e)});else{const i=!!(this.capabilities&d.Scratchpad),r=await this._notebookModelResolverService.resolve(this.resource,this.viewType,{limits:this.ensureLimits(e),scratchpad:i});if(this.editorModelReference)return r.dispose(),this.editorModelReference.object;if(this.editorModelReference=r,this.isDisposed())return this.editorModelReference.dispose(),this.editorModelReference=null,null;this._register(this.editorModelReference.object.onDidChangeDirty(()=>this._onDidChangeDirty.fire())),this._register(this.editorModelReference.object.onDidChangeReadonly(()=>this._onDidChangeCapabilities.fire())),this._register(this.editorModelReference.object.onDidRevertUntitled(()=>this.dispose())),this.editorModelReference.object.isDirty()&&this._onDidChangeDirty.fire()}if(this.options._backupId){const i=await this._notebookService.withNotebookDataProvider(this.editorModelReference.object.notebook.viewType);if(!(i instanceof H))throw new Error("CANNOT open file notebook with this provider");const r=await i.serializer.dataToNotebook(w.fromString(JSON.stringify({__webview_backup:this.options._backupId})));this.editorModelReference.object.notebook.applyEdits([{editType:W.Replace,index:0,count:this.editorModelReference.object.notebook.length,cells:r.cells}],!0,void 0,()=>{},void 0,!1),this.options._workingCopy&&(this.options._backupId=void 0,this.options._workingCopy=void 0,this.options.startDirty=void 0)}return this.editorModelReference.object}toUntyped(){return{resource:this.resource,options:{override:this.viewType}}}matches(e){return super.matches(e)?!0:e instanceof l?this.editorId===e.editorId&&j(this.resource,e.resource):!1}};l=v([n(4,B),n(5,z),n(6,x),n(7,T),n(8,P),n(9,G),n(10,$),n(11,F),n(12,U),n(13,O)],l);function Oe(s){return!!s&&typeof s=="object"&&Array.isArray(s.editorInputs)&&s.editorInputs.every(c=>c instanceof l)}function Fe(s){return!!s&&typeof s=="object"&&s.typeId===l.ID}export{l as NotebookEditorInput,Oe as isCompositeNotebookEditorInput,Fe as isNotebookEditorInput};
