var E=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var v=(s,c,e,i)=>{for(var t=i>1?void 0:i?D(c,e):c,r=s.length-1,o;r>=0;r--)(o=s[r])&&(t=(i?o(c,e,t):o(t))||t);return i&&t&&E(c,e,t),t},n=(s,c)=>(e,i)=>c(e,i,s);import{VSBuffer as w}from"../../../../base/common/buffer.js";import{onUnexpectedError as C}from"../../../../base/common/errors.js";import*as j from"../../../../base/common/glob.js";import{Schemas as _}from"../../../../base/common/network.js";import{isEqual as N,joinPath as m}from"../../../../base/common/resources.js";import{ITextResourceConfigurationService as P}from"../../../../editor/common/services/textResourceConfiguration.js";import{localize as I}from"../../../../nls.js";import{IFileDialogService as U}from"../../../../platform/dialogs/common/dialogs.js";import{IFileService as x}from"../../../../platform/files/common/files.js";import{ILabelService as T}from"../../../../platform/label/common/label.js";import{EditorInputCapabilities as d,Verbosity as L}from"../../../common/editor.js";import{AbstractResourceEditorInput as A}from"../../../common/editor/resourceEditorInput.js";import{ICustomEditorLabelService as O}from"../../../services/editor/common/customEditorLabelService.js";import{IEditorService as F}from"../../../services/editor/common/editorService.js";import{IExtensionService as $}from"../../../services/extensions/common/extensions.js";import{IFilesConfigurationService as G}from"../../../services/filesConfiguration/common/filesConfigurationService.js";import{CellEditType as W}from"./notebookCommon.js";import{INotebookEditorModelResolverService as z}from"./notebookEditorModelResolverService.js";import{INotebookService as B,SimpleNotebookProviderInfo as H}from"./notebookService.js";let l=class extends A{constructor(e,i,t,r,o,f,a,b,y,R,g,u,S,k){super(e,i,b,y,R,S,k);this.viewType=t;this.options=r;this._notebookService=o;this._notebookModelResolverService=f;this._fileDialogService=a;this._defaultDirtyState=!!r.startDirty,this._sideLoadedListener=o.onDidAddNotebookDocument(p=>{p.viewType===this.viewType&&p.uri.toString()===this.resource.toString()&&this.resolve().catch(C)}),this._register(g.onWillStop(p=>{if(!p.auto&&!this.isDirty())return;const M=p.auto?I("vetoAutoExtHostRestart","One of the opened editors is a notebook editor."):I("vetoExtHostRestart","Notebook '{0}' could not be saved.",this.resource.path);p.veto((async()=>{const h=u.findEditors(this);return p.auto?!0:!(h.length>0&&(await u.save(h[0])).success)})(),M)}))}static getOrCreate(e,i,t,r,o={}){const f=e.createInstance(l,i,t,r,o);return t&&f.setPreferredResource(t),f}static ID="workbench.input.notebook";editorModelReference=null;_sideLoadedListener;_defaultDirtyState=!1;dispose(){this._sideLoadedListener.dispose(),this.editorModelReference?.dispose(),this.editorModelReference=null,super.dispose()}get typeId(){return l.ID}get editorId(){return this.viewType}get capabilities(){let e=d.None;return this.resource.scheme===_.untitled&&(e|=d.Untitled),this.editorModelReference?this.editorModelReference.object.isReadonly()&&(e|=d.Readonly):this.filesConfigurationService.isReadonly(this.resource)&&(e|=d.Readonly),e&d.Readonly||(e|=d.CanDropIntoEditor),e}getDescription(e=L.MEDIUM){if(!this.hasCapability(d.Untitled)||this.editorModelReference?.object.hasAssociatedFilePath())return super.getDescription(e)}isReadonly(){return this.editorModelReference?this.editorModelReference.object.isReadonly():this.filesConfigurationService.isReadonly(this.resource)}isDirty(){return this.editorModelReference?this.editorModelReference.object.isDirty():this._defaultDirtyState}isSaving(){const e=this.editorModelReference?.object;return!e||!e.isDirty()||e.hasErrorState||this.hasCapability(d.Untitled)?!1:this.filesConfigurationService.hasShortAutoSaveDelay(this)}async save(e,i){if(this.editorModelReference)return this.hasCapability(d.Untitled)?this.saveAs(e,i):(await this.editorModelReference.object.save(i),this)}async saveAs(e,i){if(!this.editorModelReference)return;const t=this._notebookService.getContributedNotebookType(this.viewType);if(!t)return;const r=this.hasCapability(d.Untitled)?await this._suggestName(t,this.labelService.getUriBasenameLabel(this.resource)):this.editorModelReference.object.resource;let o;if(this.editorModelReference.object.hasAssociatedFilePath())o=r;else if(o=await this._fileDialogService.pickFileToSave(r,i?.availableFileSystems),!o)return;if(!t.matches(o)){const f=t.selectors.map(a=>typeof a=="string"?a:j.isRelativePattern(a)?`${a} (base ${a.base})`:a.exclude?`${a.include} (exclude: ${a.exclude})`:`${a.include}`).join(", ");throw new Error(`File name ${o} is not supported by ${t.providerDisplayName}.

Please make sure the file name matches following patterns:
${f}`)}return await this.editorModelReference.object.saveAs(o)}async _suggestName(e,i){const t=e.selectors[0];let r=t&&typeof t=="string"?t:void 0;if(!r&&t){const o=t.include;typeof o=="string"&&(r=o)}if(r){const o=/^\*\.([A-Za-z_-]*)$/.exec(r);if(o&&o.length>1){const f=o[1];if(!i.endsWith(f))return m(await this._fileDialogService.defaultFilePath(),i+"."+f)}}return m(await this._fileDialogService.defaultFilePath(),i)}async rename(e,i){if(this.editorModelReference)return{editor:{resource:i},options:{override:this.viewType}}}async revert(e,i){this.editorModelReference&&this.editorModelReference.object.isDirty()&&await this.editorModelReference.object.revert(i)}async resolve(e,i){if(!await this._notebookService.canResolve(this.viewType))return null;if(i?.mark("extensionActivated"),this._sideLoadedListener.dispose(),this.editorModelReference)this.editorModelReference.object.load({limits:this.ensureLimits(e)});else{const t=!!(this.capabilities&d.Scratchpad),r=await this._notebookModelResolverService.resolve(this.resource,this.viewType,{limits:this.ensureLimits(e),scratchpad:t});if(this.editorModelReference)return r.dispose(),this.editorModelReference.object;if(this.editorModelReference=r,this.isDisposed())return this.editorModelReference.dispose(),this.editorModelReference=null,null;this._register(this.editorModelReference.object.onDidChangeDirty(()=>this._onDidChangeDirty.fire())),this._register(this.editorModelReference.object.onDidChangeReadonly(()=>this._onDidChangeCapabilities.fire())),this._register(this.editorModelReference.object.onDidRevertUntitled(()=>this.dispose())),this.editorModelReference.object.isDirty()&&this._onDidChangeDirty.fire()}if(this.options._backupId){const t=await this._notebookService.withNotebookDataProvider(this.editorModelReference.object.notebook.viewType);if(!(t instanceof H))throw new Error("CANNOT open file notebook with this provider");const r=await t.serializer.dataToNotebook(w.fromString(JSON.stringify({__webview_backup:this.options._backupId})));this.editorModelReference.object.notebook.applyEdits([{editType:W.Replace,index:0,count:this.editorModelReference.object.notebook.length,cells:r.cells}],!0,void 0,()=>{},void 0,!1),this.options._workingCopy&&(this.options._backupId=void 0,this.options._workingCopy=void 0,this.options.startDirty=void 0)}return this.editorModelReference.object}toUntyped(){return{resource:this.resource,options:{override:this.viewType}}}matches(e){return super.matches(e)?!0:e instanceof l?this.editorId===e.editorId&&N(this.resource,e.resource):!1}};l=v([n(4,B),n(5,z),n(6,U),n(7,T),n(8,x),n(9,G),n(10,$),n(11,F),n(12,P),n(13,O)],l);function pe(s){return!!s&&typeof s=="object"&&Array.isArray(s.editorInputs)&&s.editorInputs.every(c=>c instanceof l)}function ue(s){return!!s&&typeof s=="object"&&s.typeId===l.ID}export{l as NotebookEditorInput,pe as isCompositeNotebookEditorInput,ue as isNotebookEditorInput};
