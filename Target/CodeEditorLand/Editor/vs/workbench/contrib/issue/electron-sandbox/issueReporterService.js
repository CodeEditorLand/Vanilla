var G=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var T=(x,b,e,t)=>{for(var s=t>1?void 0:t?N(b,e):b,n=x.length-1,i;n>=0;n--)(i=x[n])&&(s=(t?i(b,e,s):i(s))||s);return t&&s&&G(b,e,s),s},R=(x,b)=>(e,t)=>b(e,t,x);import{$ as o,createStyleSheet as q,isHTMLInputElement as V,isHTMLTextAreaElement as W,reset as v,windowOpenNoOpener as D}from"../../../../base/browser/dom.js";import{Button as _,unthemedButtonStyles as F}from"../../../../base/browser/ui/button/button.js";import{renderIcon as z}from"../../../../base/browser/ui/iconLabel/iconLabels.js";import{mainWindow as c}from"../../../../base/browser/window.js";import{Delayer as j,RunOnceScheduler as K}from"../../../../base/common/async.js";import{Codicon as B}from"../../../../base/common/codicons.js";import{groupBy as Q}from"../../../../base/common/collections.js";import{debounce as C}from"../../../../base/common/decorators.js";import{CancellationError as Y}from"../../../../base/common/errors.js";import{Disposable as J}from"../../../../base/common/lifecycle.js";import{isLinuxSnap as X,isMacintosh as O}from"../../../../base/common/platform.js";import{escape as Z}from"../../../../base/common/strings.js";import{ThemeIcon as U}from"../../../../base/common/themables.js";import{URI as w}from"../../../../base/common/uri.js";import{localize as d}from"../../../../nls.js";import{isRemoteDiagnosticError as ee}from"../../../../platform/diagnostics/common/diagnostics.js";import{IIssueMainService as te,IProcessMainService as se,OldIssueType as E}from"../../../../platform/issue/common/issue.js";import{INativeHostService as ie}from"../../../../platform/native/common/native.js";import{getIconsStyleSheet as ne}from"../../../../platform/theme/browser/iconsStyleSheet.js";import{applyZoom as oe,zoomIn as re,zoomOut as ae}from"../../../../platform/window/electron-sandbox/window.js";import{IssueReporterModel as de}from"../browser/issueReporterModel.js";import{normalizeGitHubUrl as P}from"../common/issueReporterUtil.js";const $=7500;var le=(s=>(s.VSCode="vscode",s.Extension="extension",s.Marketplace="marketplace",s.Unknown="unknown",s))(le||{});let M=class extends J{constructor(e,t,s,n){super();this.configuration=e;this.nativeHostService=t;this.issueMainService=s;this.processMainService=n;const i=e.data.extensionId?e.data.enabledExtensions.find(m=>m.id.toLocaleLowerCase()===e.data.extensionId?.toLocaleLowerCase()):void 0;this.issueReporterModel=new de({...e.data,issueType:e.data.issueType||E.Bug,versionInfo:{vscodeVersion:`${e.product.nameShort} ${e.product.darwinUniversalAssetId?`${e.product.version} (Universal)`:e.product.version} (${e.product.commit||"Commit unknown"}, ${e.product.date||"Date unknown"})`,os:`${this.configuration.os.type} ${this.configuration.os.arch} ${this.configuration.os.release}${X?" snap":""}`},extensionsDisabled:!!e.disableExtensions,fileOnExtension:e.data.extensionId?!i?.isBuiltin:void 0,selectedExtension:i});const r=e.data.issueSource==="marketplace",a=e.data.issueSource==="vscode";this.issueReporterModel.update({fileOnMarketplace:r,fileOnProduct:a});const l=this.getElementById("issue-reporter");if(l){this.previewButton=new _(l,F);const m=document.createElement("a");l.appendChild(m),m.id="show-repo-name",m.classList.add("hidden"),this.updatePreviewButtonState()}const p=e.data.issueTitle;if(p){const m=this.getElementById("issue-title");m&&(m.value=p)}const h=e.data.issueBody;if(h){const m=this.getElementById("description");m&&(m.value=h,this.issueReporterModel.update({issueDescription:h}))}this.processMainService.$getSystemInfo().then(m=>{this.issueReporterModel.update({systemInfo:m}),this.receivedSystemInfo=!0,this.updateSystemInfo(this.issueReporterModel.getData()),this.updatePreviewButtonState()}),e.data.issueType===E.PerformanceIssue&&this.processMainService.$getPerformanceInfo().then(m=>{this.updatePerformanceInfo(m)}),c.document.documentElement.lang!=="en"&&u(this.getElementById("english"));const g=q();g.id="codiconStyles";const I=this._register(ne(void 0));function S(){g.textContent=I.getCSS()}const y=new K(S,0);I.onDidChange(()=>y.schedule()),y.schedule(),this.setUpTypes(),this.setEventHandlers(),oe(e.data.zoomLevel,c),this.applyStyles(e.data.styles),this.handleExtensionData(e.data.enabledExtensions),this.updateExperimentsInfo(e.data.experiments),this.updateRestrictedMode(e.data.restrictedMode),this.updateUnsupportedMode(e.data.isUnsupported),(e.data.data||e.data.uri)&&i&&this.updateExtensionStatus(i)}issueReporterModel;numberOfSearchResultsDisplayed=0;receivedSystemInfo=!1;receivedPerformanceInfo=!1;shouldQueueSearch=!1;hasBeenSubmitted=!1;openReporter=!1;loadingExtensionData=!1;selectedExtension="";delayedSubmit=new j(300);previewButton;nonGitHubIssueUrl=!1;render(){this.renderBlocks()}setInitialFocus(){const{fileOnExtension:e}=this.issueReporterModel.getData();e?c.document.getElementById("issue-title")?.focus():c.document.getElementById("issue-type")?.focus()}applyStyles(e){const t=document.createElement("style"),s=[];e.inputBackground&&s.push(`input[type="text"], textarea, select, .issues-container > .issue > .issue-state, .block-info { background-color: ${e.inputBackground}; }`),e.inputBorder?s.push(`input[type="text"], textarea, select { border: 1px solid ${e.inputBorder}; }`):s.push('input[type="text"], textarea, select { border: 1px solid transparent; }'),e.inputForeground&&s.push(`input[type="text"], textarea, select, .issues-container > .issue > .issue-state, .block-info { color: ${e.inputForeground}; }`),e.inputErrorBorder&&(s.push(`.invalid-input, .invalid-input:focus, .validation-error { border: 1px solid ${e.inputErrorBorder} !important; }`),s.push(`.required-input { color: ${e.inputErrorBorder}; }`)),e.inputErrorBackground&&s.push(`.validation-error { background: ${e.inputErrorBackground}; }`),e.inputErrorForeground&&s.push(`.validation-error { color: ${e.inputErrorForeground}; }`),e.inputActiveBorder&&s.push(`input[type='text']:focus, textarea:focus, select:focus, summary:focus, button:focus, a:focus, .workbenchCommand:focus  { border: 1px solid ${e.inputActiveBorder}; outline-style: none; }`),e.textLinkColor&&s.push(`a, .workbenchCommand { color: ${e.textLinkColor}; }`),e.textLinkColor&&s.push(`a { color: ${e.textLinkColor}; }`),e.textLinkActiveForeground&&s.push(`a:hover, .workbenchCommand:hover { color: ${e.textLinkActiveForeground}; }`),e.sliderBackgroundColor&&s.push(`::-webkit-scrollbar-thumb { background-color: ${e.sliderBackgroundColor}; }`),e.sliderActiveColor&&s.push(`::-webkit-scrollbar-thumb:active { background-color: ${e.sliderActiveColor}; }`),e.sliderHoverColor&&s.push(`::--webkit-scrollbar-thumb:hover { background-color: ${e.sliderHoverColor}; }`),e.buttonBackground&&s.push(`.monaco-text-button { background-color: ${e.buttonBackground} !important; }`),e.buttonForeground&&s.push(`.monaco-text-button { color: ${e.buttonForeground} !important; }`),e.buttonHoverBackground&&s.push(`.monaco-text-button:not(.disabled):hover, .monaco-text-button:focus { background-color: ${e.buttonHoverBackground} !important; }`),t.textContent=s.join(`
`),c.document.head.appendChild(t),c.document.body.style.color=e.color||""}handleExtensionData(e){const t=e.filter(r=>!r.isBuiltin),{nonThemes:s,themes:n}=Q(t,r=>r.isTheme?"themes":"nonThemes"),i=n&&n.length;this.issueReporterModel.update({numberOfThemeExtesions:i,enabledNonThemeExtesions:s,allExtensions:t}),this.updateExtensionTable(s,i),(this.configuration.disableExtensions||t.length===0)&&(this.getElementById("disableExtensions").disabled=!0),this.updateExtensionSelector(t)}async updateIssueReporterUri(e){try{if(e.uri){const t=w.revive(e.uri);e.bugsUrl=t.toString()}}catch{this.renderBlocks()}}async sendReporterMenu(e){try{return await this.issueMainService.$sendReporterMenu(e.id,e.name)}catch{return}}setEventHandlers(){this.addEventListener("issue-type","change",t=>{const s=parseInt(t.target.value);this.issueReporterModel.update({issueType:s}),s===E.PerformanceIssue&&!this.receivedPerformanceInfo&&this.processMainService.$getPerformanceInfo().then(i=>{this.updatePerformanceInfo(i)});const n=this.getElementById("issue-title");n&&(n.placeholder=d("undefinedPlaceholder","Please enter a title")),this.updatePreviewButtonState(),this.setSourceOptions(),this.render()}),["includeSystemInfo","includeProcessInfo","includeWorkspaceInfo","includeExtensions","includeExperiments","includeExtensionData"].forEach(t=>{this.addEventListener(t,"click",s=>{s.stopPropagation(),this.issueReporterModel.update({[t]:!this.issueReporterModel.getData()[t]})})});const e=c.document.getElementsByClassName("showInfo");for(let t=0;t<e.length;t++)e.item(t).addEventListener("click",n=>{n.preventDefault();const i=n.target;if(i){const r=i.parentElement&&i.parentElement.parentElement,a=r&&r.lastElementChild;a&&a.classList.contains("hidden")?(u(a),i.textContent=d("hide","hide")):(f(a),i.textContent=d("show","show"))}});this.addEventListener("issue-source","change",t=>{const s=t.target.value,n=this.getElementById("problem-source-help-text");if(s===""){this.issueReporterModel.update({fileOnExtension:void 0}),u(n),this.clearSearchResults(),this.render();return}else f(n);const i=this.getElementById("issue-title");s==="vscode"?i.placeholder=d("vscodePlaceholder","E.g Workbench is missing problems panel"):s==="extension"?i.placeholder=d("extensionPlaceholder","E.g. Missing alt text on extension readme image"):s==="marketplace"?i.placeholder=d("marketplacePlaceholder","E.g Cannot disable installed extension"):i.placeholder=d("undefinedPlaceholder","Please enter a title");let r,a=!1;s==="extension"?r=!0:s==="marketplace"&&(a=!0),this.issueReporterModel.update({fileOnExtension:r,fileOnMarketplace:a}),this.render();const l=this.getElementById("issue-title").value;this.searchIssues(l,r,a)}),this.addEventListener("description","input",t=>{const s=t.target.value;if(this.issueReporterModel.update({issueDescription:s}),this.issueReporterModel.fileOnExtension()===!1){const n=this.getElementById("issue-title").value;this.searchVSCodeIssues(n,s)}}),this.addEventListener("issue-title","input",t=>{const s=t.target.value,n=this.getElementById("issue-title-length-validation-error"),i=this.getIssueUrl();s&&this.getIssueUrlWithTitle(s,i).length>$?u(n):f(n);const r=this.getElementById("issue-source");if(!r||r.value==="")return;const{fileOnExtension:a,fileOnMarketplace:l}=this.issueReporterModel.getData();this.searchIssues(s,a,l)}),this.previewButton.onDidClick(async()=>{this.delayedSubmit.trigger(async()=>{this.createIssue()})}),this.addEventListener("disableExtensions","click",()=>{this.issueMainService.$reloadWithExtensionsDisabled()}),this.addEventListener("extensionBugsLink","click",t=>{const s=t.target.innerText;D(s)}),this.addEventListener("disableExtensions","keydown",t=>{t.stopPropagation(),(t.keyCode===13||t.keyCode===32)&&this.issueMainService.$reloadWithExtensionsDisabled()}),c.document.onkeydown=async t=>{const s=O?t.metaKey:t.ctrlKey;if(s&&t.keyCode===13&&this.delayedSubmit.trigger(async()=>{await this.createIssue()&&this.close()}),s&&t.keyCode===87){t.stopPropagation(),t.preventDefault();const n=this.getElementById("issue-title").value,{issueDescription:i}=this.issueReporterModel.getData();!this.hasBeenSubmitted&&(n||i)?this.issueMainService.$showConfirmCloseDialog():this.close()}s&&t.keyCode===187&&re(c),s&&t.keyCode===189&&ae(c),O&&s&&t.keyCode===65&&t.target&&(V(t.target)||W(t.target))&&t.target.select()}}updatePerformanceInfo(e){this.issueReporterModel.update(e),this.receivedPerformanceInfo=!0;const t=this.issueReporterModel.getData();this.updateProcessInfo(t),this.updateWorkspaceInfo(t),this.updatePreviewButtonState()}updatePreviewButtonState(){this.isPreviewEnabled()?(this.configuration.data.githubAccessToken?this.previewButton.label=d("createOnGitHub","Create on GitHub"):this.previewButton.label=d("previewOnGitHub","Preview on GitHub"),this.previewButton.enabled=!0):(this.previewButton.enabled=!1,this.previewButton.label=d("loadingData","Loading data..."));const e=this.getElementById("show-repo-name"),t=this.issueReporterModel.getData().selectedExtension;if(t&&t.uri){const s=w.revive(t.uri).toString();e.href=s,e.addEventListener("click",i=>this.openLink(i)),e.addEventListener("auxclick",i=>this.openLink(i));const n=this.parseGitHubUrl(s);e.textContent=n?n.owner+"/"+n.repositoryName:s,Object.assign(e.style,{alignSelf:"flex-end",display:"block",fontSize:"13px",marginBottom:"10px",padding:"4px 0px",textDecoration:"none",width:"auto"}),u(e)}else e.removeAttribute("style"),f(e);this.getExtensionGitHubUrl()}isPreviewEnabled(){const e=this.issueReporterModel.getData().issueType;return this.loadingExtensionData?!1:!!(e===E.Bug&&this.receivedSystemInfo||e===E.PerformanceIssue&&this.receivedSystemInfo&&this.receivedPerformanceInfo||e===E.FeatureRequest)}getExtensionRepositoryUrl(){const e=this.issueReporterModel.getData().selectedExtension;return e&&e.repositoryUrl}getExtensionBugsUrl(){const e=this.issueReporterModel.getData().selectedExtension;return e&&e.bugsUrl}searchVSCodeIssues(e,t){e?this.searchDuplicates(e,t):this.clearSearchResults()}searchIssues(e,t,s){if(t)return this.searchExtensionIssues(e);if(s)return this.searchMarketplaceIssues(e);const n=this.issueReporterModel.getData().issueDescription;this.searchVSCodeIssues(e,n)}searchExtensionIssues(e){const t=this.getExtensionGitHubUrl();if(e){const s=/^https?:\/\/github\.com\/(.*)/.exec(t);if(s&&s.length){const n=s[1];return this.searchGitHub(n,e)}if(this.issueReporterModel.getData().selectedExtension)return this.clearSearchResults(),this.displaySearchResults([])}this.clearSearchResults()}searchMarketplaceIssues(e){if(e){const t=this.parseGitHubUrl(this.configuration.product.reportMarketplaceIssueUrl);if(t)return this.searchGitHub(`${t.owner}/${t.repositoryName}`,e)}}async close(){await this.issueMainService.$closeReporter()}clearSearchResults(){const e=this.getElementById("similar-issues");e.innerText="",this.numberOfSearchResultsDisplayed=0}searchGitHub(e,t){const s=`is:issue+repo:${e}+${t}`,n=this.getElementById("similar-issues");fetch(`https://api.github.com/search/issues?q=${s}`).then(i=>{i.json().then(r=>{if(n.innerText="",r&&r.items)this.displaySearchResults(r.items);else{const a=o("div.list-title");a.textContent=d("rateLimited","GitHub query limit exceeded. Please wait."),n.appendChild(a);const l=i.headers.get("X-RateLimit-Reset"),p=l?parseInt(l)-Math.floor(Date.now()/1e3):1;this.shouldQueueSearch&&(this.shouldQueueSearch=!1,setTimeout(()=>{this.searchGitHub(e,t),this.shouldQueueSearch=!0},p*1e3))}}).catch(r=>{})}).catch(i=>{})}searchDuplicates(e,t){const s="https://vscode-probot.westus.cloudapp.azure.com:7890/duplicate_candidates",n={method:"POST",body:JSON.stringify({title:e,body:t}),headers:new Headers({"Content-Type":"application/json"})};fetch(s,n).then(i=>{i.json().then(r=>{if(this.clearSearchResults(),r&&r.candidates)this.displaySearchResults(r.candidates);else throw new Error("Unexpected response, no candidates property")}).catch(r=>{})}).catch(i=>{})}displaySearchResults(e){const t=this.getElementById("similar-issues");if(e.length){const s=o("div.issues-container"),n=o("div.list-title");n.textContent=d("similarIssues","Similar issues"),this.numberOfSearchResultsDisplayed=e.length<5?e.length:5;for(let i=0;i<this.numberOfSearchResultsDisplayed;i++){const r=e[i],a=o("a.issue-link",{href:r.html_url});a.textContent=r.title,a.title=r.title,a.addEventListener("click",h=>this.openLink(h)),a.addEventListener("auxclick",h=>this.openLink(h));let l,p;if(r.state){l=o("span.issue-state");const h=o("span.issue-icon");h.appendChild(z(r.state==="open"?B.issueOpened:B.issueClosed));const g=o("span.issue-state.label");g.textContent=r.state==="open"?d("open","Open"):d("closed","Closed"),l.title=r.state==="open"?d("open","Open"):d("closed","Closed"),l.appendChild(h),l.appendChild(g),p=o("div.issue",void 0,l,a)}else p=o("div.issue",void 0,a);s.appendChild(p)}t.appendChild(n),t.appendChild(s)}else{const s=o("div.list-title");s.textContent=d("noSimilarIssues","No similar issues found"),t.appendChild(s)}}setUpTypes(){const e=(n,i)=>o("option",{value:n.valueOf()},Z(i)),t=this.getElementById("issue-type"),{issueType:s}=this.issueReporterModel.getData();v(t,e(E.Bug,d("bugReporter","Bug Report")),e(E.FeatureRequest,d("featureRequest","Feature Request")),e(E.PerformanceIssue,d("performanceIssue","Performance Issue (freeze, slow, crash)"))),t.value=s.toString(),this.setSourceOptions()}makeOption(e,t,s){const n=document.createElement("option");return n.disabled=s,n.value=e,n.textContent=t,n}setSourceOptions(){const e=this.getElementById("issue-source"),{issueType:t,fileOnExtension:s,selectedExtension:n,fileOnMarketplace:i,fileOnProduct:r}=this.issueReporterModel.getData();let a=e.selectedIndex;a===-1&&(s!==void 0?a=s?2:1:n?.isBuiltin?a=1:i?a=3:r&&(a=1)),e.innerText="",e.append(this.makeOption("",d("selectSource","Select source"),!0)),e.append(this.makeOption("vscode",d("vscode","Visual Studio Code"),!1)),e.append(this.makeOption("extension",d("extension","A VS Code extension"),!1)),this.configuration.product.reportMarketplaceIssueUrl&&e.append(this.makeOption("marketplace",d("marketplace","Extensions Marketplace"),!1)),t!==E.FeatureRequest&&e.append(this.makeOption("unknown",d("unknown","Don't know"),!1)),a!==-1&&a<e.options.length?e.selectedIndex=a:(e.selectedIndex=0,f(this.getElementById("problem-source-help-text")))}renderBlocks(){const{issueType:e,fileOnExtension:t,fileOnMarketplace:s,selectedExtension:n}=this.issueReporterModel.getData(),i=this.getElementById("block-container"),r=c.document.querySelector(".block-system"),a=c.document.querySelector(".block-process"),l=c.document.querySelector(".block-workspace"),p=c.document.querySelector(".block-extensions"),h=c.document.querySelector(".block-experiments"),g=c.document.querySelector(".block-extension-data"),I=this.getElementById("problem-source"),S=this.getElementById("issue-description-label"),y=this.getElementById("issue-description-subtitle"),m=this.getElementById("extension-selection"),L=this.getElementById("issue-title-container"),H=this.getElementById("description"),k=this.getElementById("extension-data");if(f(i),f(r),f(a),f(l),f(p),f(h),f(m),f(k),f(g),u(I),u(L),u(H),t&&u(m),n&&this.nonGitHubIssueUrl){f(L),f(H),v(S,d("handlesIssuesElsewhere","This extension handles issues outside of VS Code")),v(y,d("elsewhereDescription","The '{0}' extension prefers to use an external issue reporter. To be taken to that issue reporting experience, click the button below.",n.displayName)),this.previewButton.label=d("openIssueReporter","Open External Issue Reporter");return}if(t&&n?.data){const A=n?.data;k.innerText=A.toString(),k.readOnly=!0,u(g)}t&&this.openReporter&&(k.readOnly=!0,setTimeout(()=>{this.openReporter&&u(g)},100)),e===E.Bug?(s||(u(i),u(r),u(h),t||u(p)),v(S,d("stepsToReproduce","Steps to Reproduce")+" ",o("span.required-input",void 0,"*")),v(y,d("bugDescription","Share the steps needed to reliably reproduce the problem. Please include actual and expected results. We support GitHub-flavored Markdown. You will be able to edit your issue and add screenshots when we preview it on GitHub."))):e===E.PerformanceIssue?(s||(u(i),u(r),u(a),u(l),u(h)),t?u(m):s||u(p),v(S,d("stepsToReproduce","Steps to Reproduce")+" ",o("span.required-input",void 0,"*")),v(y,d("performanceIssueDesciption","When did this performance issue happen? Does it occur on startup or after a specific series of actions? We support GitHub-flavored Markdown. You will be able to edit your issue and add screenshots when we preview it on GitHub."))):e===E.FeatureRequest&&(v(S,d("description","Description")+" ",o("span.required-input",void 0,"*")),v(y,d("featureRequestDescription","Please describe the feature you would like to see. We support GitHub-flavored Markdown. You will be able to edit your issue and add screenshots when we preview it on GitHub.")))}validateInput(e){const t=this.getElementById(e),s=this.getElementById(`${e}-empty-error`),n=this.getElementById("description-short-error");return t.value?e==="description"&&t.value.length<10?(t.classList.add("invalid-input"),n?.classList.remove("hidden"),s?.classList.add("hidden"),!1):(t.classList.remove("invalid-input"),s?.classList.add("hidden"),e==="description"&&n?.classList.add("hidden"),!0):(t.classList.add("invalid-input"),s?.classList.remove("hidden"),n?.classList.add("hidden"),!1)}validateInputs(){let e=!0;return["issue-title","description","issue-source"].forEach(t=>{e=this.validateInput(t)&&e}),this.issueReporterModel.fileOnExtension()&&(e=this.validateInput("extension-selector")&&e),e}async submitToGitHub(e,t,s){const n=`https://api.github.com/repos/${s.owner}/${s.repositoryName}/issues`,i={method:"POST",body:JSON.stringify({title:e,body:t}),headers:new Headers({"Content-Type":"application/json",Authorization:`Bearer ${this.configuration.data.githubAccessToken}`})},r=await fetch(n,i);if(!r.ok)return!1;const a=await r.json();return await this.nativeHostService.openExternal(a.html_url),this.close(),!0}async createIssue(){const e=this.issueReporterModel.getData().selectedExtension;if(this.nonGitHubIssueUrl){const p=this.getExtensionBugsUrl();if(p)return this.hasBeenSubmitted=!0,await this.nativeHostService.openExternal(p),!0}if(!this.validateInputs()){const p=c.document.getElementsByClassName("invalid-input");return p.length&&p[0].focus(),this.addEventListener("issue-title","input",h=>{this.validateInput("issue-title")}),this.addEventListener("description","input",h=>{this.validateInput("description")}),this.addEventListener("issue-source","change",h=>{this.validateInput("issue-source")}),this.issueReporterModel.fileOnExtension()&&this.addEventListener("extension-selector","change",h=>{this.validateInput("extension-selector")}),!1}this.hasBeenSubmitted=!0;const s=this.getElementById("issue-title").value,n=this.issueReporterModel.serialize();let i=this.getIssueUrl();if(!i)return!1;e?.uri&&(i=w.revive(e.uri).toString());const r=this.parseGitHubUrl(i),a=this.getIssueUrlWithTitle(this.getElementById("issue-title").value,i);let l=a+`&body=${encodeURIComponent(n)}`;if(l.length>$)try{l=await this.writeToClipboard(a,n)}catch{return!1}else if(this.configuration.data.githubAccessToken&&r)return this.submitToGitHub(s,n,r);return await this.nativeHostService.openExternal(l),!0}async writeToClipboard(e,t){if(!await this.issueMainService.$showClipboardDialog())throw new Y;return await this.nativeHostService.writeClipboardText(t),e+`&body=${encodeURIComponent(d("pasteData","We have written the needed data into your clipboard because it was too large to send. Please paste."))}`}getIssueUrl(){return this.issueReporterModel.fileOnExtension()?this.getExtensionGitHubUrl():this.issueReporterModel.getData().fileOnMarketplace?this.configuration.product.reportMarketplaceIssueUrl:this.configuration.product.reportIssueUrl}parseGitHubUrl(e){const t=/^https?:\/\/github\.com\/([^\/]*)\/([^\/]*).*/.exec(e);if(t&&t.length)return{owner:t[1],repositoryName:t[2]}}getExtensionGitHubUrl(){let e="";const t=this.getExtensionBugsUrl(),s=this.getExtensionRepositoryUrl();return t&&t.match(/^https?:\/\/github\.com\/([^\/]*)\/([^\/]*)\/?(\/issues)?$/)?e=P(t):s&&s.match(/^https?:\/\/github\.com\/([^\/]*)\/([^\/]*)$/)?e=P(s):(this.nonGitHubIssueUrl=!0,e=t||s||""),e}getIssueUrlWithTitle(e,t){this.issueReporterModel.fileOnExtension()&&(t=t+"/issues/new");const s=t.indexOf("?")===-1?"?":"&";return`${t}${s}title=${encodeURIComponent(e)}`}updateSystemInfo(e){const t=c.document.querySelector(".block-system .block-info");if(t){const s=e.systemInfo,n=o("table",void 0,o("tr",void 0,o("td",void 0,"CPUs"),o("td",void 0,s.cpus||"")),o("tr",void 0,o("td",void 0,"GPU Status"),o("td",void 0,Object.keys(s.gpuStatus).map(i=>`${i}: ${s.gpuStatus[i]}`).join(`
`))),o("tr",void 0,o("td",void 0,"Load (avg)"),o("td",void 0,s.load||"")),o("tr",void 0,o("td",void 0,"Memory (System)"),o("td",void 0,s.memory)),o("tr",void 0,o("td",void 0,"Process Argv"),o("td",void 0,s.processArgs)),o("tr",void 0,o("td",void 0,"Screen Reader"),o("td",void 0,s.screenReader)),o("tr",void 0,o("td",void 0,"VM"),o("td",void 0,s.vmHint)));v(t,n),s.remoteData.forEach(i=>{if(t.appendChild(o("hr")),ee(i)){const r=o("table",void 0,o("tr",void 0,o("td",void 0,"Remote"),o("td",void 0,i.hostName)),o("tr",void 0,o("td",void 0,""),o("td",void 0,i.errorMessage)));t.appendChild(r)}else{const r=o("table",void 0,o("tr",void 0,o("td",void 0,"Remote"),o("td",void 0,i.latency?`${i.hostName} (latency: ${i.latency.current.toFixed(2)}ms last, ${i.latency.average.toFixed(2)}ms average)`:i.hostName)),o("tr",void 0,o("td",void 0,"OS"),o("td",void 0,i.machineInfo.os)),o("tr",void 0,o("td",void 0,"CPUs"),o("td",void 0,i.machineInfo.cpus||"")),o("tr",void 0,o("td",void 0,"Memory (System)"),o("td",void 0,i.machineInfo.memory)),o("tr",void 0,o("td",void 0,"VM"),o("td",void 0,i.machineInfo.vmHint)));t.appendChild(r)}})}}updateExtensionSelector(e){const t=e.map(i=>({name:i.displayName||i.name||"",id:i.id}));t.sort((i,r)=>{const a=i.name.toLowerCase(),l=r.name.toLowerCase();return a>l?1:a<l?-1:0});const s=(i,r)=>{const a=r&&i.id===r.id;return o("option",{value:i.id,selected:a||""},i.name)},n=this.getElementById("extension-selector");if(n){const{selectedExtension:i}=this.issueReporterModel.getData();v(n,this.makeOption("",d("selectExtension","Select extension"),!0),...t.map(r=>s(r,i))),i||(n.selectedIndex=0),this.addEventListener("extension-selector","change",async r=>{this.clearExtensionData();const a=r.target.value;this.selectedExtension=a;const p=this.issueReporterModel.getData().allExtensions.filter(h=>h.id===a);if(p.length){this.issueReporterModel.update({selectedExtension:p[0]});const h=this.issueReporterModel.getData().selectedExtension;if(h){const g=document.createElement("span");g.classList.add(...U.asClassNameArray(B.loading),"codicon-modifier-spin"),this.setLoading(g);const I=await this.sendReporterMenu(h);I?this.selectedExtension===a?(this.removeLoading(g,!0),this.configuration.data=I):this.selectedExtension:(this.loadingExtensionData||g.classList.remove(...U.asClassNameArray(B.loading),"codicon-modifier-spin"),this.removeLoading(g),this.clearExtensionData(),h.data=void 0,h.uri=void 0),this.selectedExtension===a&&(this.updateExtensionStatus(p[0]),this.openReporter=!1)}else this.issueReporterModel.update({selectedExtension:void 0}),this.clearSearchResults(),this.clearExtensionData(),this.validateSelectedExtension(),this.updateExtensionStatus(p[0])}})}this.addEventListener("problem-source","change",i=>{this.validateSelectedExtension()})}clearExtensionData(){this.nonGitHubIssueUrl=!1,this.issueReporterModel.update({extensionData:void 0}),this.configuration.data.issueBody=void 0,this.configuration.data.data=void 0,this.configuration.data.uri=void 0}async updateExtensionStatus(e){this.issueReporterModel.update({selectedExtension:e});const t=this.configuration.data.issueBody;if(t){const r=this.getElementById("description"),a=r.value;if(a===""||!a.includes(t.toString())){const l=a+(a===""?"":`
`)+t.toString();r.value=l,this.issueReporterModel.update({issueDescription:l})}}const s=this.configuration.data.data;if(s){this.issueReporterModel.update({extensionData:s}),e.data=s;const r=c.document.querySelector(".block-extension-data");u(r),this.renderBlocks()}const n=this.configuration.data.uri;n&&(e.uri=n,this.updateIssueReporterUri(e)),this.validateSelectedExtension();const i=this.getElementById("issue-title").value;this.searchExtensionIssues(i),this.updatePreviewButtonState(),this.renderBlocks()}validateSelectedExtension(){const e=this.getElementById("extension-selection-validation-error"),t=this.getElementById("extension-selection-validation-error-no-url");if(f(e),f(t),!this.issueReporterModel.getData().selectedExtension){this.previewButton.enabled=!0;return}if(this.loadingExtensionData)return;this.getExtensionGitHubUrl()?this.previewButton.enabled=!0:(this.setExtensionValidationMessage(),this.previewButton.enabled=!1)}setLoading(e){this.openReporter=!0,this.loadingExtensionData=!0,this.updatePreviewButtonState();const t=this.getElementById("extension-id");f(t),Array.from(c.document.querySelectorAll(".ext-parens")).forEach(i=>f(i));const n=this.getElementById("ext-loading");for(u(n);n.firstChild;)n.firstChild.remove();n.append(e),this.renderBlocks()}removeLoading(e,t=!1){this.openReporter=t,this.loadingExtensionData=!1,this.updatePreviewButtonState();const s=this.getElementById("extension-id");u(s),Array.from(c.document.querySelectorAll(".ext-parens")).forEach(r=>u(r));const i=this.getElementById("ext-loading");f(i),i.firstChild&&e.remove(),this.renderBlocks()}setExtensionValidationMessage(){const e=this.getElementById("extension-selection-validation-error"),t=this.getElementById("extension-selection-validation-error-no-url"),s=this.getExtensionBugsUrl();if(s){u(e);const i=this.getElementById("extensionBugsLink");i.textContent=s;return}const n=this.getExtensionRepositoryUrl();if(n){u(e);const i=this.getElementById("extensionBugsLink");i.textContent=n;return}u(t)}updateProcessInfo(e){const t=c.document.querySelector(".block-process .block-info");t&&v(t,o("code",void 0,e.processInfo??""))}updateWorkspaceInfo(e){c.document.querySelector(".block-workspace .block-info code").textContent=`
`+e.workspaceInfo}updateExtensionTable(e,t){const s=c.document.querySelector(".block-extensions .block-info");if(s){if(this.configuration.disableExtensions){v(s,d("disabledExtensions","Extensions are disabled"));return}const n=t?`
(${t} theme extensions excluded)`:"";if(e=e||[],!e.length){s.innerText="Extensions: none"+n;return}v(s,this.getExtensionTableHtml(e),document.createTextNode(n))}}updateRestrictedMode(e){this.issueReporterModel.update({restrictedMode:e})}updateUnsupportedMode(e){this.issueReporterModel.update({isUnsupported:e})}updateExperimentsInfo(e){this.issueReporterModel.update({experimentInfo:e});const t=c.document.querySelector(".block-experiments .block-info");t&&(t.textContent=e||d("noCurrentExperiments","No current experiments."))}getExtensionTableHtml(e){return o("table",void 0,o("tr",void 0,o("th",void 0,"Extension"),o("th",void 0,"Author (truncated)"),o("th",void 0,"Version")),...e.map(t=>o("tr",void 0,o("td",void 0,t.name),o("td",void 0,t.publisher?.substr(0,3)??"N/A"),o("td",void 0,t.version))))}openLink(e){e.preventDefault(),e.stopPropagation(),e.which<3&&D(e.target.href)}getElementById(e){const t=c.document.getElementById(e);if(t)return t}addEventListener(e,t,s){this.getElementById(e)?.addEventListener(t,s)}};T([C(300)],M.prototype,"searchGitHub",1),T([C(300)],M.prototype,"searchDuplicates",1),M=T([R(1,ie),R(2,te),R(3,se)],M);function f(x){x?.classList.add("hidden")}function u(x){x?.classList.remove("hidden")}export{M as IssueReporter,f as hide,u as show};
