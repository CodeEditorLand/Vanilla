var x=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var v=(i,t,o,e)=>{for(var r=e>1?void 0:e?T(t,o):t,d=i.length-1,s;d>=0;d--)(s=i[d])&&(r=(e?s(t,o,r):s(r))||r);return e&&r&&x(t,o,r),r},l=(i,t)=>(o,e)=>t(o,e,i);import{KeyCode as g,KeyMod as b}from"../../../../base/common/keyCodes.js";import{Disposable as S}from"../../../../base/common/lifecycle.js";import{parse as D}from"../../../../base/common/marshalling.js";import{extname as P,isEqual as O}from"../../../../base/common/resources.js";import{isFalsyOrWhitespace as _}from"../../../../base/common/strings.js";import{assertType as K}from"../../../../base/common/types.js";import{URI as h}from"../../../../base/common/uri.js";import{IBulkEditService as z}from"../../../../editor/browser/services/bulkEditService.js";import{PLAINTEXT_LANGUAGE_ID as A}from"../../../../editor/common/languages/modesRegistry.js";import{localize2 as M}from"../../../../nls.js";import{Action2 as U,MenuId as j,registerAction2 as B}from"../../../../platform/actions/common/actions.js";import{IConfigurationService as F}from"../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as u}from"../../../../platform/contextkey/common/contextkey.js";import{SyncDescriptor as L}from"../../../../platform/instantiation/common/descriptors.js";import{IInstantiationService as w}from"../../../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as V,KeybindingsRegistry as q}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{Registry as R}from"../../../../platform/registry/common/platform.js";import{EditorPaneDescriptor as H}from"../../../browser/editor.js";import{WorkbenchPhase as C,registerWorkbenchContribution2 as W}from"../../../common/contributions.js";import{EditorExtensions as N}from"../../../common/editor.js";import{IEditorResolverService as G,RegisteredEditorPriority as J}from"../../../services/editor/common/editorResolverService.js";import{IEditorService as X}from"../../../services/editor/common/editorService.js";import{IExtensionService as Q}from"../../../services/extensions/common/extensions.js";import{IViewsService as Y}from"../../../services/views/common/viewsService.js";import{IWorkingCopyEditorService as Z}from"../../../services/workingCopy/common/workingCopyEditorService.js";import{ResourceNotebookCellEdit as $}from"../../bulkEdit/browser/bulkCellEdits.js";import{getReplView as ee}from"../../debug/browser/repl.js";import{REPL_VIEW_ID as oe}from"../../debug/common/debug.js";import{IInteractiveHistoryService as te}from"../../interactive/browser/interactiveHistoryService.js";import{NOTEBOOK_EDITOR_WIDGET_ACTION_WEIGHT as k}from"../../notebook/browser/controller/coreActions.js";import*as re from"../../notebook/browser/notebookIcons.js";import{INotebookEditorService as ie}from"../../notebook/browser/services/notebookEditorService.js";import{CellEditType as ne,CellKind as de,NotebookSetting as se,NotebookWorkingCopyTypeIdentifier as ae,REPL_EDITOR_ID as ce}from"../../notebook/common/notebookCommon.js";import{INotebookEditorModelResolverService as pe}from"../../notebook/common/notebookEditorModelResolverService.js";import{INotebookService as le}from"../../notebook/common/notebookService.js";import{ReplEditor as ue}from"./replEditor.js";import{ReplEditorInput as p}from"./replEditorInput.js";class Ee{canSerialize(t){return t.typeId===p.ID}serialize(t){K(t instanceof p);const o={resource:t.resource,preferredResource:t.preferredResource,viewType:t.viewType,options:t.options,label:t.getName()};return JSON.stringify(o)}deserialize(t,o){const e=D(o);if(!e)return;const{resource:r,viewType:d}=e;return!e||!h.isUri(r)||typeof d!="string"?void 0:t.createInstance(p,r,e.label)}}R.as(N.EditorPane).registerEditorPane(H.create(ue,ce,"REPL Editor"),[new L(p)]),R.as(N.EditorFactory).registerEditorSerializer(p.ID,Ee);let E=class extends S{constructor(o,e,r,d,s){super();this.notebookEditorModelResolverService=r;this.instantiationService=d;this.configurationService=s;e.registerEditor(" ",{id:"repl",label:"repl Editor",priority:J.option},{canSupportResource:c=>o.getNotebookTextModel(c)!==void 0,singlePerResource:!0},{createUntitledEditorInput:async({resource:c,options:n})=>{const a=this.configurationService.getValue(se.InteractiveWindowPromptToSave)!==!0,f=await this.notebookEditorModelResolverService.resolve({untitledResource:c},"jupyter-notebook",{scratchpad:a});f.object.notebook.onWillDispose(()=>{f.dispose()});const I=n?.label??void 0;return{editor:this.instantiationService.createInstance(p,c,I),options:n}},createEditorInput:async({resource:c,options:n})=>{const a=n?.label??void 0;return{editor:this.instantiationService.createInstance(p,c,a),options:n}}})}static ID="workbench.contrib.replDocument"};E=v([l(0,le),l(1,G),l(2,pe),l(3,w),l(4,F)],E);let m=class extends S{constructor(o,e,r){super();this.instantiationService=o;this.workingCopyEditorService=e;this.extensionService=r;this._installHandler()}static ID="workbench.contrib.replWorkingCopyEditorHandler";handles(o){const e=this._getViewType(o);return!!e&&e==="jupyter-notebook"&&P(o.resource)===".replNotebook"}isOpen(o,e){return this.handles(o)?e instanceof p&&O(o.resource,e.resource):!1}createEditor(o){return this.instantiationService.createInstance(p,o.resource,void 0)}async _installHandler(){await this.extensionService.whenInstalledExtensionsRegistered(),this._register(this.workingCopyEditorService.registerHandler(this))}_getViewType(o){return ae.parse(o.typeId)}};m=v([l(0,w),l(1,Z),l(2,Q)],m),W(m.ID,m,C.BlockRestore),W(E.ID,E,C.BlockRestore),B(class extends U{constructor(){super({id:"repl.execute",title:M("repl.execute","Execute REPL input"),category:"REPL",keybinding:[{when:u.equals("activeEditor","workbench.editor.repl"),primary:b.CtrlCmd|g.Enter,weight:k},{when:u.and(u.equals("activeEditor","workbench.editor.repl"),u.equals("config.interactiveWindow.executeWithShiftEnter",!0)),primary:b.Shift|g.Enter,weight:k},{when:u.and(u.equals("activeEditor","workbench.editor.repl"),u.equals("config.interactiveWindow.executeWithShiftEnter",!1)),primary:g.Enter,weight:k}],menu:[{id:j.ReplInputExecute}],icon:re.executeIcon,f1:!1,metadata:{description:"Execute the Contents of the Input Box",args:[{name:"resource",description:"Interactive resource Uri",isOptional:!0}]}})}async run(i,t){const o=i.get(X),e=i.get(z),r=i.get(te),d=i.get(ie);let s;if(t){const c=h.revive(t),n=o.findEditors(c);for(const a of n)if(a.editor.typeId===p.ID){s=(await o.openEditor(a.editor,a.groupId))?.getControl();break}}else s=o.activeEditorPane?.getControl();s&&me(e,r,d,s)}});async function me(i,t,o,e){if(e&&e.notebookEditor&&e.codeEditor){const r=e.notebookEditor.textModel,d=e.codeEditor.getModel(),c=e.notebookEditor.activeKernel?.supportedLanguages[0]??A;if(r&&d){const n=r.length-1,a=d.getValue();if(_(a))return;t.replaceLast(r.uri,a),t.addToHistory(r.uri,""),d.setValue(""),r.cells[n].resetTextBuffer(d.getTextBuffer());const f=e.notebookEditor.notebookOptions.getDisplayOptions().interactiveWindowCollapseCodeCells==="fromEditor"?{inputCollapsed:!1,outputCollapsed:!1}:void 0;await i.apply([new $(r.uri,{editType:ne.Replace,index:n,count:0,cells:[{cellKind:de.Code,mime:void 0,language:c,source:a,outputs:[],metadata:{},collapseState:f}]})]);const I={start:n,end:n+1};e.notebookEditor.revealCellRangeInView(I),await e.notebookEditor.executeNotebookCells(e.notebookEditor.getCellsInRange({start:n,end:n+1}));const y=o.getNotebookEditor(e.notebookEditor.getId());y&&(y.setSelections([I]),y.setFocus(I))}}}q.registerCommandAndKeybindingRule({id:"list.find.replInputFocus",weight:V.WorkbenchContrib+1,when:u.equals("view",oe),primary:b.CtrlCmd|b.Alt|g.KeyF,secondary:[g.F3],handler:i=>{ee(i.get(Y))?.openFind()}});export{E as ReplDocumentContribution};
