var x=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var k=(i,o,t,e)=>{for(var r=e>1?void 0:e?T(o,t):o,d=i.length-1,s;d>=0;d--)(s=i[d])&&(r=(e?s(o,t,r):s(r))||r);return e&&r&&x(o,t,r),r},l=(i,o)=>(t,e)=>o(t,e,i);import{SyncDescriptor as D}from"../../../../platform/instantiation/common/descriptors.js";import{Registry as S}from"../../../../platform/registry/common/platform.js";import{EditorPaneDescriptor as P}from"../../../browser/editor.js";import{EditorExtensions as h}from"../../../common/editor.js";import{parse as O}from"../../../../base/common/marshalling.js";import{assertType as _}from"../../../../base/common/types.js";import{URI as R}from"../../../../base/common/uri.js";import{IInstantiationService as w}from"../../../../platform/instantiation/common/instantiation.js";import"../../../common/editor/editorInput.js";import{CellEditType as K,CellKind as z,NotebookSetting as A,NotebookWorkingCopyTypeIdentifier as M,REPL_EDITOR_ID as U}from"../../notebook/common/notebookCommon.js";import"../../notebook/common/notebookEditorInput.js";import{ReplEditor as F}from"./replEditor.js";import{ReplEditorInput as p}from"./replEditorInput.js";import{Disposable as C}from"../../../../base/common/lifecycle.js";import{registerWorkbenchContribution2 as W,WorkbenchPhase as N}from"../../../common/contributions.js";import{IExtensionService as L}from"../../../services/extensions/common/extensions.js";import"../../../services/workingCopy/common/workingCopy.js";import{IWorkingCopyEditorService as V}from"../../../services/workingCopy/common/workingCopyEditorService.js";import{extname as B,isEqual as q}from"../../../../base/common/resources.js";import{INotebookService as H}from"../../notebook/common/notebookService.js";import{IEditorResolverService as G,RegisteredEditorPriority as j}from"../../../services/editor/common/editorResolverService.js";import{INotebookEditorModelResolverService as J}from"../../notebook/common/notebookEditorModelResolverService.js";import{isFalsyOrWhitespace as X}from"../../../../base/common/strings.js";import{IBulkEditService as Q}from"../../../../editor/browser/services/bulkEditService.js";import"../../../../editor/browser/widget/codeEditor/codeEditorWidget.js";import{PLAINTEXT_LANGUAGE_ID as Y}from"../../../../editor/common/languages/modesRegistry.js";import{ResourceNotebookCellEdit as Z}from"../../bulkEdit/browser/bulkCellEdits.js";import{IInteractiveHistoryService as $}from"../../interactive/browser/interactiveHistoryService.js";import"../../notebook/browser/notebookEditorWidget.js";import{INotebookEditorService as ee}from"../../notebook/browser/services/notebookEditorService.js";import{IConfigurationService as te}from"../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as u}from"../../../../platform/contextkey/common/contextkey.js";import{KeybindingsRegistry as oe,KeybindingWeight as re}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{getReplView as ie}from"../../debug/browser/repl.js";import{REPL_VIEW_ID as ne}from"../../debug/common/debug.js";import{IViewsService as de}from"../../../services/views/common/viewsService.js";import{KeyCode as g,KeyMod as v}from"../../../../base/common/keyCodes.js";import{Action2 as se,MenuId as ae,registerAction2 as ce}from"../../../../platform/actions/common/actions.js";import{localize2 as pe}from"../../../../nls.js";import{NOTEBOOK_EDITOR_WIDGET_ACTION_WEIGHT as y}from"../../notebook/browser/controller/coreActions.js";import*as le from"../../notebook/browser/notebookIcons.js";import{IEditorService as ue}from"../../../services/editor/common/editorService.js";import"../../notebook/browser/notebookBrowser.js";class Ee{canSerialize(o){return o.typeId===p.ID}serialize(o){_(o instanceof p);const t={resource:o.resource,preferredResource:o.preferredResource,viewType:o.viewType,options:o.options,label:o.getName()};return JSON.stringify(t)}deserialize(o,t){const e=O(t);if(!e)return;const{resource:r,viewType:d}=e;return!e||!R.isUri(r)||typeof d!="string"?void 0:o.createInstance(p,r,e.label)}}S.as(h.EditorPane).registerEditorPane(P.create(F,U,"REPL Editor"),[new D(p)]),S.as(h.EditorFactory).registerEditorSerializer(p.ID,Ee);let E=class extends C{constructor(t,e,r,d,s){super();this.notebookEditorModelResolverService=r;this.instantiationService=d;this.configurationService=s;e.registerEditor(" ",{id:"repl",label:"repl Editor",priority:j.option},{canSupportResource:c=>t.getNotebookTextModel(c)!==void 0,singlePerResource:!0},{createUntitledEditorInput:async({resource:c,options:n})=>{const a=this.configurationService.getValue(A.InteractiveWindowPromptToSave)!==!0,f=await this.notebookEditorModelResolverService.resolve({untitledResource:c},"jupyter-notebook",{scratchpad:a});f.object.notebook.onWillDispose(()=>{f.dispose()});const I=n?.label??void 0;return{editor:this.instantiationService.createInstance(p,c,I),options:n}},createEditorInput:async({resource:c,options:n})=>{const a=n?.label??void 0;return{editor:this.instantiationService.createInstance(p,c,a),options:n}}})}static ID="workbench.contrib.replDocument"};E=k([l(0,H),l(1,G),l(2,J),l(3,w),l(4,te)],E);let m=class extends C{constructor(t,e,r){super();this.instantiationService=t;this.workingCopyEditorService=e;this.extensionService=r;this._installHandler()}static ID="workbench.contrib.replWorkingCopyEditorHandler";handles(t){const e=this._getViewType(t);return!!e&&e==="jupyter-notebook"&&B(t.resource)===".replNotebook"}isOpen(t,e){return this.handles(t)?e instanceof p&&q(t.resource,e.resource):!1}createEditor(t){return this.instantiationService.createInstance(p,t.resource,void 0)}async _installHandler(){await this.extensionService.whenInstalledExtensionsRegistered(),this._register(this.workingCopyEditorService.registerHandler(this))}_getViewType(t){return M.parse(t.typeId)}};m=k([l(0,w),l(1,V),l(2,L)],m),W(m.ID,m,N.BlockRestore),W(E.ID,E,N.BlockRestore),ce(class extends se{constructor(){super({id:"repl.execute",title:pe("repl.execute","Execute REPL input"),category:"REPL",keybinding:[{when:u.equals("activeEditor","workbench.editor.repl"),primary:v.CtrlCmd|g.Enter,weight:y},{when:u.and(u.equals("activeEditor","workbench.editor.repl"),u.equals("config.interactiveWindow.executeWithShiftEnter",!0)),primary:v.Shift|g.Enter,weight:y},{when:u.and(u.equals("activeEditor","workbench.editor.repl"),u.equals("config.interactiveWindow.executeWithShiftEnter",!1)),primary:g.Enter,weight:y}],menu:[{id:ae.ReplInputExecute}],icon:le.executeIcon,f1:!1,metadata:{description:"Execute the Contents of the Input Box",args:[{name:"resource",description:"Interactive resource Uri",isOptional:!0}]}})}async run(i,o){const t=i.get(ue),e=i.get(Q),r=i.get($),d=i.get(ee);let s;if(o){const c=R.revive(o),n=t.findEditors(c);for(const a of n)if(a.editor.typeId===p.ID){s=(await t.openEditor(a.editor,a.groupId))?.getControl();break}}else s=t.activeEditorPane?.getControl();s&&me(e,r,d,s)}});async function me(i,o,t,e){if(e&&e.notebookEditor&&e.codeEditor){const r=e.notebookEditor.textModel,d=e.codeEditor.getModel(),c=e.notebookEditor.activeKernel?.supportedLanguages[0]??Y;if(r&&d){const n=r.length-1,a=d.getValue();if(X(a))return;o.replaceLast(r.uri,a),o.addToHistory(r.uri,""),d.setValue(""),r.cells[n].resetTextBuffer(d.getTextBuffer());const f=e.notebookEditor.notebookOptions.getDisplayOptions().interactiveWindowCollapseCodeCells==="fromEditor"?{inputCollapsed:!1,outputCollapsed:!1}:void 0;await i.apply([new Z(r.uri,{editType:K.Replace,index:n,count:0,cells:[{cellKind:z.Code,mime:void 0,language:c,source:a,outputs:[],metadata:{},collapseState:f}]})]);const I={start:n,end:n+1};e.notebookEditor.revealCellRangeInView(I),await e.notebookEditor.executeNotebookCells(e.notebookEditor.getCellsInRange({start:n,end:n+1}));const b=t.getNotebookEditor(e.notebookEditor.getId());b&&(b.setSelections([I]),b.setFocus(I))}}}oe.registerCommandAndKeybindingRule({id:"list.find.replInputFocus",weight:re.WorkbenchContrib+1,when:u.equals("view",ne),primary:v.CtrlCmd|v.Alt|g.KeyF,secondary:[g.F3],handler:i=>{ie(i.get(de))?.openFind()}});export{E as ReplDocumentContribution};
