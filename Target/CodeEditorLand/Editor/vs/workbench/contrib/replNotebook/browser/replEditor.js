var R=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var W=(c,t,e,i)=>{for(var o=i>1?void 0:i?H(t,e):t,n=c.length-1,r;n>=0;n--)(r=c[n])&&(o=(i?r(t,e,o):r(o))||o);return i&&o&&R(t,e,o),o},d=(c,t)=>(e,i)=>t(e,i,c);import"./media/interactive.css";import*as a from"../../../../base/browser/dom.js";import"../../../../base/common/cancellation.js";import{Emitter as k,Event as P}from"../../../../base/common/event.js";import{DisposableStore as A,MutableDisposable as K}from"../../../../base/common/lifecycle.js";import{ICodeEditorService as B}from"../../../../editor/browser/services/codeEditorService.js";import{CodeEditorWidget as x}from"../../../../editor/browser/widget/codeEditor/codeEditorWidget.js";import"../../../../editor/common/editorCommon.js";import{IContextKeyService as M}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as $}from"../../../../platform/instantiation/common/instantiation.js";import{IStorageService as F}from"../../../../platform/storage/common/storage.js";import{ITelemetryService as G}from"../../../../platform/telemetry/common/telemetry.js";import{IThemeService as U}from"../../../../platform/theme/common/themeService.js";import{EditorPane as z}from"../../../browser/parts/editor/editorPane.js";import{EditorPaneSelectionChangeReason as E}from"../../../common/editor.js";import{getSimpleEditorOptions as Y}from"../../codeEditor/browser/simpleEditorOptions.js";import"../../notebook/browser/notebookBrowser.js";import{NotebookEditorExtensionsRegistry as j}from"../../notebook/browser/notebookEditorExtensions.js";import{INotebookEditorService as J}from"../../notebook/browser/services/notebookEditorService.js";import{getDefaultNotebookCreationOptions as q,NotebookEditorWidget as Z}from"../../notebook/browser/notebookEditorWidget.js";import{GroupsOrder as Q,IEditorGroupsService as X}from"../../../services/editor/common/editorGroupsService.js";import{ExecutionStateCellStatusBarContrib as tt,TimerCellStatusBarContrib as et}from"../../notebook/browser/contrib/cellStatusBar/executionStatusBarItemController.js";import{INotebookKernelService as it}from"../../notebook/common/notebookKernelService.js";import{ILanguageService as ot}from"../../../../editor/common/languages/language.js";import{IMenuService as nt,MenuId as g}from"../../../../platform/actions/common/actions.js";import{IKeybindingService as rt}from"../../../../platform/keybinding/common/keybinding.js";import{InteractiveWindowSetting as T,INTERACTIVE_INPUT_CURSOR_BOUNDARY as st}from"../../interactive/browser/interactiveCommon.js";import{IConfigurationService as dt}from"../../../../platform/configuration/common/configuration.js";import{NotebookOptions as at}from"../../notebook/browser/notebookOptions.js";import{ToolBar as lt}from"../../../../base/browser/ui/toolbar/toolbar.js";import{IContextMenuService as ct}from"../../../../platform/contextview/browser/contextView.js";import{createActionViewItem as ht,createAndFillInActionBarActions as ut}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import"../../../../base/common/actions.js";import{EditorExtensionsRegistry as pt}from"../../../../editor/browser/editorExtensions.js";import{SelectionClipboardContributionID as gt}from"../../codeEditor/browser/selectionClipboard.js";import{ContextMenuController as _t}from"../../../../editor/contrib/contextmenu/browser/contextmenu.js";import{SuggestController as vt}from"../../../../editor/contrib/suggest/browser/suggestController.js";import{MarkerController as Et}from"../../../../editor/contrib/gotoError/browser/gotoError.js";import"../../../common/editor/editorInput.js";import{ITextResourceConfigurationService as mt}from"../../../../editor/common/services/textResourceConfiguration.js";import{TextEditorSelectionSource as D}from"../../../../platform/editor/common/editor.js";import{INotebookExecutionStateService as Ct,NotebookExecutionType as bt}from"../../notebook/common/notebookExecutionStateService.js";import{NOTEBOOK_KERNEL as St}from"../../notebook/common/notebookContextKeys.js";import"../../../../editor/common/cursorEvents.js";import{IExtensionService as ft}from"../../../services/extensions/common/extensions.js";import{isEqual as It}from"../../../../base/common/resources.js";import{NotebookFindContrib as kt}from"../../notebook/browser/contrib/find/notebookFindWidget.js";import{REPL_EDITOR_ID as Dt}from"../../notebook/common/notebookCommon.js";import"./interactiveEditor.css";import"../../../../editor/common/config/editorOptions.js";import{deepClone as yt}from"../../../../base/common/objects.js";import{GlyphHoverController as wt}from"../../../../editor/contrib/hover/browser/glyphHoverController.js";import{ContentHoverController as Wt}from"../../../../editor/contrib/hover/browser/contentHoverController.js";import{ReplEditorInput as O}from"./replEditorInput.js";import{ReplInputHintContentWidget as xt}from"../../interactive/browser/replInputHintContentWidget.js";import{ServiceCollection as Mt}from"../../../../platform/instantiation/common/serviceCollection.js";import"../../../../editor/browser/editorBrowser.js";const Tt="InteractiveEditorViewState",m=8,y=10,C=8;let S=class extends z{_rootElement;_styleElement;_notebookEditorContainer;_notebookWidget={value:void 0};_inputCellContainer;_inputFocusIndicator;_inputRunButtonContainer;_inputEditorContainer;_codeEditorWidget;_notebookWidgetService;_instantiationService;_languageService;_contextKeyService;_configurationService;_notebookKernelService;_keybindingService;_menuService;_contextMenuService;_editorGroupService;_extensionService;_widgetDisposableStore=this._register(new A);_lastLayoutDimensions;_editorOptions;_notebookOptions;_editorMemento;_groupListener=this._register(new K);_runbuttonToolbar;_hintElement;_onDidFocusWidget=this._register(new k);get onDidFocus(){return this._onDidFocusWidget.event}_onDidChangeSelection=this._register(new k);onDidChangeSelection=this._onDidChangeSelection.event;_onDidChangeScroll=this._register(new k);onDidChangeScroll=this._onDidChangeScroll.event;constructor(t,e,i,o,n,r,h,u,s,l,b,f,_,I,v,L,N,V){super(Dt,t,e,i,o),this._notebookWidgetService=r,this._configurationService=f,this._notebookKernelService=s,this._languageService=l,this._keybindingService=b,this._menuService=_,this._contextMenuService=I,this._editorGroupService=v,this._extensionService=V,this._rootElement=a.$(".interactive-editor"),this._contextKeyService=this._register(h.createScoped(this._rootElement)),this._contextKeyService.createKey("isCompositeNotebook",!0),this._instantiationService=this._register(n.createChild(new Mt([M,this._contextKeyService]))),this._editorOptions=this._computeEditorOptions(),this._register(this._configurationService.onDidChangeConfiguration(p=>{(p.affectsConfiguration("editor")||p.affectsConfiguration("notebook"))&&(this._editorOptions=this._computeEditorOptions())})),this._notebookOptions=n.createInstance(at,this.window,!0,{cellToolbarInteraction:"hover",globalToolbar:!0,stickyScrollEnabled:!1,dragAndDropEnabled:!1}),this._editorMemento=this.getEditorMemento(v,L,Tt),this._register(this._keybindingService.onDidUpdateKeybindings(this._updateInputHint,this)),this._register(N.onDidChangeExecution(p=>{if(p.type===bt.cell&&It(p.notebook,this._notebookWidget.value?.viewModel?.notebookDocument.uri)){const w=this._notebookWidget.value?.getCellByHandle(p.cellHandle);w&&p.changed?.state&&this._scrollIfNecessary(w)}}))}get inputCellContainerHeight(){return 21+m*2+C*2}get inputCellEditorHeight(){return 19+C*2}createEditor(t){a.append(t,this._rootElement),this._rootElement.style.position="relative",this._notebookEditorContainer=a.append(this._rootElement,a.$(".notebook-editor-container")),this._inputCellContainer=a.append(this._rootElement,a.$(".input-cell-container")),this._inputCellContainer.style.position="absolute",this._inputCellContainer.style.height=`${this.inputCellContainerHeight}px`,this._inputFocusIndicator=a.append(this._inputCellContainer,a.$(".input-focus-indicator")),this._inputRunButtonContainer=a.append(this._inputCellContainer,a.$(".run-button-container")),this._setupRunButtonToolbar(this._inputRunButtonContainer),this._inputEditorContainer=a.append(this._inputCellContainer,a.$(".input-editor-container")),this._createLayoutStyles()}_setupRunButtonToolbar(t){const e=this._register(this._menuService.createMenu(g.ReplInputExecute,this._contextKeyService));this._runbuttonToolbar=this._register(new lt(t,this._contextMenuService,{getKeyBinding:r=>this._keybindingService.lookupKeybinding(r.id),actionViewItemProvider:(r,h)=>ht(this._instantiationService,r,h),renderDropdownAsChildElement:!0}));const i=[],o=[];ut(e,{shouldForwardArgs:!0},{primary:i,secondary:o}),this._runbuttonToolbar.setActions([...i,...o])}_createLayoutStyles(){this._styleElement=a.createStyleSheet(this._rootElement);const t=[],{codeCellLeftMargin:e,cellRunGutter:i}=this._notebookOptions.getLayoutConfiguration(),{focusIndicator:o}=this._notebookOptions.getDisplayOptions(),n=this._notebookOptions.getCellEditorContainerLeftMargin();t.push(`
			.interactive-editor .input-cell-container {
				padding: ${m}px ${y}px ${m}px ${n}px;
			}
		`),o==="gutter"?t.push(`
				.interactive-editor .input-cell-container:focus-within .input-focus-indicator::before {
					border-color: var(--vscode-notebook-focusedCellBorder) !important;
				}
				.interactive-editor .input-focus-indicator::before {
					border-color: var(--vscode-notebook-inactiveFocusedCellBorder) !important;
				}
				.interactive-editor .input-cell-container .input-focus-indicator {
					display: block;
					top: ${m}px;
				}
				.interactive-editor .input-cell-container {
					border-top: 1px solid var(--vscode-notebook-inactiveFocusedCellBorder);
				}
			`):t.push(`
				.interactive-editor .input-cell-container {
					border-top: 1px solid var(--vscode-notebook-inactiveFocusedCellBorder);
				}
				.interactive-editor .input-cell-container .input-focus-indicator {
					display: none;
				}
			`),t.push(`
			.interactive-editor .input-cell-container .run-button-container {
				width: ${i}px;
				left: ${e}px;
				margin-top: ${C-2}px;
			}
		`),this._styleElement.textContent=t.join(`
`)}_computeEditorOptions(){let t;this._codeEditorWidget&&(t=this._codeEditorWidget.getModel()?.getLanguageId());const e=yt(this._configurationService.getValue("editor",{overrideIdentifier:t})),i=Y(this._configurationService);return Object.freeze({...e,...i,glyphMargin:!0,padding:{top:C,bottom:C},hover:{enabled:!0}})}saveState(){this._saveEditorViewState(this.input),super.saveState()}getViewState(){const t=this.input;if(t instanceof O)return this._saveEditorViewState(t),this._loadNotebookEditorViewState(t)}_saveEditorViewState(t){if(this._notebookWidget.value&&t instanceof O){if(this._notebookWidget.value.isDisposed)return;const e=this._notebookWidget.value.getEditorViewState(),i=this._codeEditorWidget.saveViewState();this._editorMemento.saveEditorState(this.group,t.resource,{notebook:e,input:i})}}_loadNotebookEditorViewState(t){const e=this._editorMemento.loadEditorState(this.group,t.resource);if(e)return e;for(const i of this._editorGroupService.getGroups(Q.MOST_RECENTLY_ACTIVE))if(i.activeEditorPane!==this&&i.activeEditorPane===this&&i.activeEditor?.matches(t)){const o=this._notebookWidget.value?.getEditorViewState(),n=this._codeEditorWidget.saveViewState();return{notebook:o,input:n}}}async setInput(t,e,i,o){if(this._notebookWidget.value?.onWillHide(),this._codeEditorWidget?.dispose(),this._widgetDisposableStore.clear(),this._notebookWidget=this._instantiationService.invokeFunction(this._notebookWidgetService.retrieveWidget,this.group.id,t,{isReplHistory:!0,isReadOnly:!0,contributions:j.getSomeEditorContributions([tt.id,et.id,kt.id]),menuIds:{notebookToolbar:g.InteractiveToolbar,cellTitleToolbar:g.InteractiveCellTitle,cellDeleteToolbar:g.InteractiveCellDelete,cellInsertToolbar:g.NotebookCellBetween,cellTopInsertToolbar:g.NotebookCellListTop,cellExecuteToolbar:g.InteractiveCellExecute,cellExecutePrimary:void 0},cellEditorContributions:pt.getSomeEditorContributions([gt,_t.ID,Wt.ID,wt.ID,Et.ID]),options:this._notebookOptions,codeWindow:this.window},void 0,this.window),this._codeEditorWidget=this._instantiationService.createInstance(x,this._inputEditorContainer,this._editorOptions,{isSimpleWidget:!1,contributions:q().cellEditorContributions}),this._lastLayoutDimensions){this._notebookEditorContainer.style.height=`${this._lastLayoutDimensions.dimension.height-this.inputCellContainerHeight}px`,this._notebookWidget.value.layout(new a.Dimension(this._lastLayoutDimensions.dimension.width,this._lastLayoutDimensions.dimension.height-this.inputCellContainerHeight),this._notebookEditorContainer);const s=this._notebookOptions.getCellEditorContainerLeftMargin(),l=Math.min(this._lastLayoutDimensions.dimension.height/2,this.inputCellEditorHeight);this._codeEditorWidget.layout(this._validateDimension(this._lastLayoutDimensions.dimension.width-s-y,l)),this._inputFocusIndicator.style.height=`${this.inputCellEditorHeight}px`,this._inputCellContainer.style.top=`${this._lastLayoutDimensions.dimension.height-this.inputCellContainerHeight}px`,this._inputCellContainer.style.width=`${this._lastLayoutDimensions.dimension.width}px`}await super.setInput(t,e,i,o);const n=await t.resolve();if(this._runbuttonToolbar&&(this._runbuttonToolbar.context=t.resource),n===null)throw new Error("The REPL model could not be resolved");this._notebookWidget.value?.setParentContextKeyService(this._contextKeyService);const r=e?.viewState??this._loadNotebookEditorViewState(t);await this._extensionService.whenInstalledExtensionsRegistered(),await this._notebookWidget.value.setModel(n.notebook,r?.notebook,void 0,"repl"),n.notebook.setCellCollapseDefault(this._notebookOptions.getCellCollapseDefault()),this._notebookWidget.value.setOptions({isReadOnly:!0}),this._widgetDisposableStore.add(this._notebookWidget.value.onDidResizeOutput(s=>{this._scrollIfNecessary(s)})),this._widgetDisposableStore.add(this._notebookWidget.value.onDidFocusWidget(()=>this._onDidFocusWidget.fire())),this._widgetDisposableStore.add(this._notebookOptions.onDidChangeOptions(s=>{(s.compactView||s.focusIndicator)&&(this._styleElement?.remove(),this._createLayoutStyles()),this._lastLayoutDimensions&&this.isVisible()&&this.layout(this._lastLayoutDimensions.dimension,this._lastLayoutDimensions.position),s.interactiveWindowCollapseCodeCells&&n.notebook.setCellCollapseDefault(this._notebookOptions.getCellCollapseDefault())}));const h=await t.resolveInput(n.notebook);this._codeEditorWidget.setModel(h),r?.input&&this._codeEditorWidget.restoreViewState(r.input),this._editorOptions=this._computeEditorOptions(),this._codeEditorWidget.updateOptions(this._editorOptions),this._widgetDisposableStore.add(this._codeEditorWidget.onDidFocusEditorWidget(()=>this._onDidFocusWidget.fire())),this._widgetDisposableStore.add(this._codeEditorWidget.onDidContentSizeChange(s=>{s.contentHeightChanged&&this._lastLayoutDimensions&&this._layoutWidgets(this._lastLayoutDimensions.dimension,this._lastLayoutDimensions.position)})),this._widgetDisposableStore.add(this._codeEditorWidget.onDidChangeCursorPosition(s=>this._onDidChangeSelection.fire({reason:this._toEditorPaneSelectionChangeReason(s)}))),this._widgetDisposableStore.add(this._codeEditorWidget.onDidChangeModelContent(()=>this._onDidChangeSelection.fire({reason:E.EDIT}))),this._widgetDisposableStore.add(this._notebookKernelService.onDidChangeNotebookAffinity(this._syncWithKernel,this)),this._widgetDisposableStore.add(this._notebookKernelService.onDidChangeSelectedNotebooks(this._syncWithKernel,this)),this._widgetDisposableStore.add(this.themeService.onDidColorThemeChange(()=>{this.isVisible()&&this._updateInputHint()})),this._widgetDisposableStore.add(this._codeEditorWidget.onDidChangeModelContent(()=>{this.isVisible()&&this._updateInputHint()})),this._codeEditorWidget.onDidChangeModelDecorations(()=>{this.isVisible()&&this._updateInputHint()});const u=st.bindTo(this._contextKeyService);t.resource&&t.historyService.has(t.resource)?u.set("top"):u.set("none"),this._widgetDisposableStore.add(this._codeEditorWidget.onDidChangeCursorPosition(({position:s})=>{const l=this._codeEditorWidget._getViewModel(),b=l.getLineCount(),f=l.getLineLength(b)+1,_=l.coordinatesConverter.convertModelPositionToViewPosition(s),I=_.lineNumber===1&&_.column===1,v=_.lineNumber===b&&_.column===f;I?v?u.set("both"):u.set("top"):v?u.set("bottom"):u.set("none")})),this._widgetDisposableStore.add(h.onDidChangeContent(()=>{const s=h.getValue();if(this.input?.resource&&s!==""){const l=this.input.historyService;l.matchesCurrent(this.input.resource,s)||l.replaceLast(this.input.resource,s)}})),this._widgetDisposableStore.add(this._notebookWidget.value.onDidScroll(()=>this._onDidChangeScroll.fire())),this._updateInputHint(),this._syncWithKernel()}setOptions(t){this._notebookWidget.value?.setOptions(t),super.setOptions(t)}_toEditorPaneSelectionChangeReason(t){switch(t.source){case D.PROGRAMMATIC:return E.PROGRAMMATIC;case D.NAVIGATION:return E.NAVIGATION;case D.JUMP:return E.JUMP;default:return E.USER}}_cellAtBottom(t){const e=this._notebookWidget.value?.visibleRanges||[];return this._notebookWidget.value?.getCellIndex(t)===Math.max(...e.map(o=>o.end-1))}_scrollIfNecessary(t){this._notebookWidget.value.getCellIndex(t)===this._notebookWidget.value.getLength()-1&&(this._configurationService.getValue(T.interactiveWindowAlwaysScrollOnNewCell)||this._cellAtBottom(t))&&this._notebookWidget.value.scrollToBottom()}_syncWithKernel(){const t=this._notebookWidget.value?.textModel,e=this._codeEditorWidget.getModel();if(t&&e){const i=this._notebookKernelService.getMatchingKernel(t),o=i.selected??(i.suggestions.length===1?i.suggestions[0]:void 0)??(i.all.length===1?i.all[0]:void 0);if(o){const n=o.supportedLanguages[0];if(n&&n!=="plaintext"){const r=this._languageService.createById(n).languageId;e.setLanguage(r)}St.bindTo(this._contextKeyService).set(o.id)}}}layout(t,e){this._rootElement.classList.toggle("mid-width",t.width<1e3&&t.width>=600),this._rootElement.classList.toggle("narrow-width",t.width<600);const i=t.height!==this._lastLayoutDimensions?.dimension.height;this._lastLayoutDimensions={dimension:t,position:e},this._notebookWidget.value&&(i&&this._codeEditorWidget&&vt.get(this._codeEditorWidget)?.cancelSuggestWidget(),this._notebookEditorContainer.style.height=`${this._lastLayoutDimensions.dimension.height-this.inputCellContainerHeight}px`,this._layoutWidgets(t,e))}_layoutWidgets(t,e){const i=this._codeEditorWidget.hasModel()?this._codeEditorWidget.getContentHeight():this.inputCellEditorHeight,o=Math.min(t.height/2,i),n=this._notebookOptions.getCellEditorContainerLeftMargin(),r=o+m*2;this._notebookEditorContainer.style.height=`${t.height-r}px`,this._notebookWidget.value.layout(t.with(t.width,t.height-r),this._notebookEditorContainer,e),this._codeEditorWidget.layout(this._validateDimension(t.width-n-y,o)),this._inputFocusIndicator.style.height=`${i}px`,this._inputCellContainer.style.top=`${t.height-r}px`,this._inputCellContainer.style.width=`${t.width}px`}_validateDimension(t,e){return new a.Dimension(Math.max(0,t),Math.max(0,e))}_hasConflictingDecoration(){return!!this._codeEditorWidget.getLineDecorations(1)?.find(t=>t.options.beforeContentClassName||t.options.afterContentClassName||t.options.before?.content||t.options.after?.content)}_updateInputHint(){if(!this._codeEditorWidget)return;const t=!this._codeEditorWidget.hasModel()||this._configurationService.getValue(T.showExecutionHint)===!1||this._codeEditorWidget.getModel().getValueLength()!==0||this._hasConflictingDecoration();!this._hintElement&&!t?this._hintElement=this._instantiationService.createInstance(xt,this._codeEditorWidget):this._hintElement&&t&&(this._hintElement.dispose(),this._hintElement=void 0)}getScrollPosition(){return{scrollTop:this._notebookWidget.value?.scrollTop??0,scrollLeft:0}}setScrollPosition(t){this._notebookWidget.value?.setScrollTop(t.scrollTop)}focus(){super.focus(),this._notebookWidget.value?.onShow(),this._codeEditorWidget.focus()}focusHistory(){this._notebookWidget.value.focus()}setEditorVisible(t){super.setEditorVisible(t),this._groupListener.value=this.group.onWillCloseEditor(e=>this._saveEditorViewState(e.editor)),t||(this._saveEditorViewState(this.input),this.input&&this._notebookWidget.value&&this._notebookWidget.value.onWillHide()),this._updateInputHint()}clearInput(){this._notebookWidget.value&&(this._saveEditorViewState(this.input),this._notebookWidget.value.onWillHide()),this._codeEditorWidget?.dispose(),this._notebookWidget={value:void 0},this._widgetDisposableStore.clear(),super.clearInput()}getControl(){return{notebookEditor:this._notebookWidget.value,activeCodeEditor:this.getActiveCodeEditor(),onDidChangeActiveEditor:P.None}}getActiveCodeEditor(){return this._codeEditorWidget.hasWidgetFocus()||!this._notebookWidget.value?.activeCodeEditor?this._codeEditorWidget:this._notebookWidget.value?.activeCodeEditor}};S=W([d(1,G),d(2,U),d(3,F),d(4,$),d(5,J),d(6,M),d(7,B),d(8,it),d(9,ot),d(10,rt),d(11,dt),d(12,nt),d(13,ct),d(14,X),d(15,mt),d(16,Ct),d(17,ft)],S);function ti(c){const t=c;return t?.activeCodeEditor instanceof x&&t?.notebookEditor instanceof Z}export{S as ReplEditor,ti as isReplEditorControl};
