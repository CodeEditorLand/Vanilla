var q=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var u=(s,r,e,i)=>{for(var t=i>1?void 0:i?G(r,e):r,a=s.length-1,o;a>=0;a--)(o=s[a])&&(t=(i?o(r,e,t):o(t))||t);return i&&t&&q(r,e,t),t},c=(s,r)=>(e,i)=>r(e,i,s);import{Action as v}from"../../../../../../vs/base/common/actions.js";import{toErrorMessage as $}from"../../../../../../vs/base/common/errorMessage.js";import{Event as L}from"../../../../../../vs/base/common/event.js";import{hash as A}from"../../../../../../vs/base/common/hash.js";import{Disposable as z,dispose as T}from"../../../../../../vs/base/common/lifecycle.js";import{ResourceMap as V}from"../../../../../../vs/base/common/map.js";import{Schemas as j}from"../../../../../../vs/base/common/network.js";import{isWindows as g}from"../../../../../../vs/base/common/platform.js";import{basename as p,isEqual as J}from"../../../../../../vs/base/common/resources.js";import{URI as Q}from"../../../../../../vs/base/common/uri.js";import{ITextModelService as Z}from"../../../../../../vs/editor/common/services/resolverService.js";import{localize as n}from"../../../../../../vs/nls.js";import{IContextKeyService as ee,RawContextKey as ie}from"../../../../../../vs/platform/contextkey/common/contextkey.js";import{FileOperationResult as C}from"../../../../../../vs/platform/files/common/files.js";import{IInstantiationService as _}from"../../../../../../vs/platform/instantiation/common/instantiation.js";import{INotificationService as N,Severity as U}from"../../../../../../vs/platform/notification/common/notification.js";import{IOpenerService as te}from"../../../../../../vs/platform/opener/common/opener.js";import{IProductService as re}from"../../../../../../vs/platform/product/common/productService.js";import{IStorageService as W,StorageScope as H,StorageTarget as oe}from"../../../../../../vs/platform/storage/common/storage.js";import"../../../../../../vs/workbench/common/contributions.js";import{SaveReason as S,SideBySideEditor as se}from"../../../../../../vs/workbench/common/editor.js";import{DiffEditorInput as ne}from"../../../../../../vs/workbench/common/editor/diffEditorInput.js";import{FileEditorInput as ae}from"../../../../../../vs/workbench/contrib/files/browser/editors/fileEditorInput.js";import{SAVE_FILE_AS_LABEL as ce}from"../../../../../../vs/workbench/contrib/files/browser/fileConstants.js";import{TextFileContentProvider as K}from"../../../../../../vs/workbench/contrib/files/common/files.js";import{IEditorService as w}from"../../../../../../vs/workbench/services/editor/common/editorService.js";import{IPreferencesService as de}from"../../../../../../vs/workbench/services/preferences/common/preferences.js";import{ITextFileService as le}from"../../../../../../vs/workbench/services/textfile/common/textfiles.js";const ve="saveConflictResolutionContext",P="conflictResolution",M="learnMoreDirtyWriteError",X=n("userGuide","Use the actions in the editor tool bar to either undo your changes or overwrite the content of the file with your changes.");let x=class extends z{constructor(e,i,t,a,o,d,l){super();this.notificationService=e;this.textFileService=i;this.contextKeyService=t;this.editorService=a;this.instantiationService=d;this.storageService=l;const f=this._register(d.createInstance(K));this._register(o.registerTextModelContentProvider(P,f)),this.textFileService.files.saveErrorHandler=this,this.registerListeners()}static ID="workbench.contrib.textFileSaveErrorHandler";messages=new V;conflictResolutionContext=new ie(ve,!1,!0).bindTo(this.contextKeyService);activeConflictResolutionResource=void 0;registerListeners(){this._register(this.textFileService.files.onDidSave(e=>this.onFileSavedOrReverted(e.model.resource))),this._register(this.textFileService.files.onDidRevert(e=>this.onFileSavedOrReverted(e.resource))),this._register(this.editorService.onDidActiveEditorChange(()=>this.onActiveEditorChanged()))}onActiveEditorChanged(){let e=!1,i;const t=this.editorService.activeEditor;t instanceof ne&&t.original.resource?.scheme===P&&(e=!0,i=t.modified.resource),this.conflictResolutionContext.set(e),this.activeConflictResolutionResource=i}onFileSavedOrReverted(e){const i=this.messages.get(e);i&&(i.close(),this.messages.delete(e))}onSaveError(e,i,t){const a=e,o=i.resource;let d;const l=[],f=[];if(a.fileOperationResult===C.FILE_MODIFIED_SINCE)if(this.activeConflictResolutionResource&&J(this.activeConflictResolutionResource,i.resource)){if(this.storageService.getBoolean(M,H.APPLICATION))return;d=X,l.push(this.instantiationService.createInstance(m)),f.push(this.instantiationService.createInstance(I))}else d=n("staleSaveError","Failed to save '{0}': The content of the file is newer. Please compare your version with the file contents or overwrite the content of the file with your changes.",p(o)),l.push(this.instantiationService.createInstance(h,i)),l.push(this.instantiationService.createInstance(Ie,i,t)),f.push(this.instantiationService.createInstance(y));else{const R=a.fileOperationResult===C.FILE_WRITE_LOCKED,F=R&&a.options?.unlock,D=a.fileOperationResult===C.FILE_PERMISSION_DENIED,O=o.scheme===j.file;O&&(D||F)?l.push(this.instantiationService.createInstance(ue,i,t,!!F)):R?l.push(this.instantiationService.createInstance(me,i,t)):l.push(this.instantiationService.createInstance(fe,i,t)),l.push(this.instantiationService.createInstance(E,i)),l.push(this.instantiationService.createInstance(Se,i)),R?F&&O?d=g?n("readonlySaveErrorAdmin","Failed to save '{0}': File is read-only. Select 'Overwrite as Admin' to retry as administrator.",p(o)):n("readonlySaveErrorSudo","Failed to save '{0}': File is read-only. Select 'Overwrite as Sudo' to retry as superuser.",p(o)):d=n("readonlySaveError","Failed to save '{0}': File is read-only. Select 'Overwrite' to attempt to make it writeable.",p(o)):O&&D?d=g?n("permissionDeniedSaveError","Failed to save '{0}': Insufficient permissions. Select 'Retry as Admin' to retry as administrator.",p(o)):n("permissionDeniedSaveErrorSudo","Failed to save '{0}': Insufficient permissions. Select 'Retry as Sudo' to retry as superuser.",p(o)):d=n({key:"genericSaveError",comment:["{0} is the resource that failed to save and {1} the error message"]},"Failed to save '{0}': {1}",p(o),$(e,!1))}const Y={primary:l,secondary:f},k=this.notificationService.notify({id:`${A(i.resource.toString())}`,severity:U.Error,message:d,actions:Y});L.once(k.onDidClose)(()=>{T(l),T(f)}),this.messages.set(i.resource,k)}dispose(){super.dispose(),this.messages.clear()}};x=u([c(0,N),c(1,le),c(2,ee),c(3,w),c(4,Z),c(5,_),c(6,W)],x);const b=[];function pe(){for(;b.length>0;)b.pop()?.close()}let m=class extends v{constructor(e){super("workbench.files.action.resolveConflictLearnMore",n("learnMore","Learn More"));this.openerService=e}async run(){await this.openerService.open(Q.parse("https://go.microsoft.com/fwlink/?linkid=868264"))}};m=u([c(0,te)],m);let I=class extends v{constructor(e){super("workbench.files.action.resolveConflictLearnMoreDoNotShowAgain",n("dontShowAgain","Don't Show Again"));this.storageService=e}async run(e){this.storageService.store(M,!0,H.APPLICATION,oe.USER),e.dispose()}};I=u([c(0,W)],I);let h=class extends v{constructor(e,i,t,a,o){super("workbench.files.action.resolveConflict",n("compareChanges","Compare"));this.model=e;this.editorService=i;this.notificationService=t;this.instantiationService=a;this.productService=o}async run(){if(!this.model.isDisposed()){const e=this.model.resource,i=p(e),t=n("saveConflictDiffLabel","{0} (in file) \u2194 {1} (in {2}) - Resolve save conflict",i,i,this.productService.nameLong);await K.open(e,P,t,this.editorService,{pinned:!0});const a={primary:[this.instantiationService.createInstance(m)]},o=this.notificationService.notify({id:`${A(e.toString())}`,severity:U.Info,message:X,actions:a,neverShowAgain:{id:M,isSecondary:!0}});L.once(o.onDidClose)(()=>T(a.primary)),b.push(o)}}};h=u([c(1,w),c(2,N),c(3,_),c(4,re)],h);class ue extends v{constructor(e,i,t){super("workbench.files.action.saveModelElevated",t?g?n("overwriteElevated","Overwrite as Admin..."):n("overwriteElevatedSudo","Overwrite as Sudo..."):g?n("saveElevated","Retry as Admin..."):n("saveElevatedSudo","Retry as Sudo..."));this.model=e;this.options=i;this.triedToUnlock=t}async run(){this.model.isDisposed()||await this.model.save({...this.options,writeElevated:!0,writeUnlock:this.triedToUnlock,reason:S.EXPLICIT})}}class fe extends v{constructor(e,i){super("workbench.files.action.saveModel",n("retry","Retry"));this.model=e;this.options=i}async run(){this.model.isDisposed()||await this.model.save({...this.options,reason:S.EXPLICIT})}}class Se extends v{constructor(e){super("workbench.files.action.revertModel",n("revert","Revert"));this.model=e}async run(){this.model.isDisposed()||await this.model.revert()}}let E=class extends v{constructor(e,i){super("workbench.files.action.saveModelAs",ce.value);this.model=e;this.editorService=i}async run(){if(!this.model.isDisposed()){const e=this.findEditor();e&&await this.editorService.save(e,{saveAs:!0,reason:S.EXPLICIT})}}findEditor(){let e;const i=this.editorService.findEditors(this.model.resource,{supportSideBySide:se.PRIMARY});for(const t of i)if(t.editor instanceof ae){e=t;break}else e||(e=t);return e}};E=u([c(1,w)],E);class me extends v{constructor(e,i){super("workbench.files.action.unlock",n("overwrite","Overwrite"));this.model=e;this.options=i}async run(){this.model.isDisposed()||await this.model.save({...this.options,writeUnlock:!0,reason:S.EXPLICIT})}}class Ie extends v{constructor(e,i){super("workbench.files.action.saveIgnoreModifiedSince",n("overwrite","Overwrite"));this.model=e;this.options=i}async run(){this.model.isDisposed()||await this.model.save({...this.options,ignoreModifiedSince:!0,reason:S.EXPLICIT})}}let y=class extends v{constructor(e){super("workbench.files.action.configureSaveConflict",n("configure","Configure"));this.preferencesService=e}async run(){this.preferencesService.openSettings({query:"files.saveConflictResolution"})}};y=u([c(0,de)],y);const si=(s,r)=>B(s,r,!0),ni=(s,r)=>B(s,r,!1);async function B(s,r,e){const i=s.get(w),t=i.activeEditorPane;if(!t)return;const a=t.input,o=t.group;if(pe(),e){const d={ignoreModifiedSince:!0,reason:S.EXPLICIT};await i.save({editor:a,groupId:o.id},d)}else await i.revert({editor:a,groupId:o.id});return await i.openEditor({resource:r},o),o.closeEditor(a)}export{ve as CONFLICT_RESOLUTION_CONTEXT,P as CONFLICT_RESOLUTION_SCHEME,x as TextFileSaveErrorHandler,si as acceptLocalChangesCommand,ni as revertLocalChangesCommand};
