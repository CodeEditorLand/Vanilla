import{toAction as q}from"../../../../base/common/actions.js";import{toErrorMessage as J}from"../../../../base/common/errorMessage.js";import{isCancellationError as ue}from"../../../../base/common/errors.js";import{hash as ve}from"../../../../base/common/hash.js";import{KeyChord as f,KeyCode as a,KeyMod as d}from"../../../../base/common/keyCodes.js";import{dispose as Q}from"../../../../base/common/lifecycle.js";import{Schemas as L}from"../../../../base/common/network.js";import{isWeb as Z,isWindows as $}from"../../../../base/common/platform.js";import{basename as fe,isEqual as Ee,joinPath as ee}from"../../../../base/common/resources.js";import{ICodeEditorService as Se}from"../../../../editor/browser/services/codeEditorService.js";import{EmbeddedCodeEditorWidget as ye}from"../../../../editor/browser/widget/codeEditor/embeddedCodeEditorWidget.js";import{EditorContextKeys as O}from"../../../../editor/common/editorContextKeys.js";import{ITextModelService as Ie}from"../../../../editor/common/services/resolverService.js";import*as I from"../../../../nls.js";import{IClipboardService as W}from"../../../../platform/clipboard/common/clipboardService.js";import{CommandsRegistry as E,ICommandService as he}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as N}from"../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as A,IContextKeyService as we}from"../../../../platform/contextkey/common/contextkey.js";import{IFileDialogService as Ae}from"../../../../platform/dialogs/common/dialogs.js";import{EditorOpenSource as be,EditorResolution as Re}from"../../../../platform/editor/common/editor.js";import{IEnvironmentService as _e}from"../../../../platform/environment/common/environment.js";import{IFileService as F}from"../../../../platform/files/common/files.js";import{IInstantiationService as te}from"../../../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as p,KeybindingsRegistry as g}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{ILabelService as V}from"../../../../platform/label/common/label.js";import{IListService as v}from"../../../../platform/list/browser/listService.js";import{INotificationService as re,Severity as Oe}from"../../../../platform/notification/common/notification.js";import{IUriIdentityService as xe}from"../../../../platform/uriIdentity/common/uriIdentity.js";import{isWorkspaceToOpen as De}from"../../../../platform/window/common/window.js";import{IWorkspaceContextService as ie,UNTITLED_WORKSPACE_NAME as Ke}from"../../../../platform/workspace/common/workspace.js";import{RemoveRootFolderAction as Me}from"../../../browser/actions/workspaceActions.js";import{resolveCommandsContext as Pe}from"../../../browser/parts/editor/editorCommandsContext.js";import{EditorInputCapabilities as x,EditorResourceAccessor as U,EditorsOrder as Te,SaveReason as w,SideBySideEditor as k}from"../../../common/editor.js";import{SideBySideEditorInput as Le}from"../../../common/editor/sideBySideEditorInput.js";import{ViewContainerLocation as D}from"../../../common/views.js";import{GroupsOrder as oe,IEditorGroupsService as S}from"../../../services/editor/common/editorGroupsService.js";import{IEditorService as c,SIDE_GROUP as We}from"../../../services/editor/common/editorService.js";import{IHostService as ne}from"../../../services/host/browser/host.js";import{IPaneCompositePartService as K}from"../../../services/panecomposite/browser/panecomposite.js";import{ITextFileService as Ne}from"../../../services/textfile/common/textfiles.js";import{IViewsService as Fe}from"../../../services/views/common/viewsService.js";import{IWorkspaceEditingService as Ve}from"../../../services/workspaces/common/workspaceEditing.js";import{ExplorerCompressedFirstFocusContext as de,ExplorerCompressedFocusContext as M,ExplorerCompressedLastFocusContext as ae,ExplorerFocusCondition as Ue,ExplorerFolderContext as ke,FilesExplorerFocusCondition as b,TextFileContentProvider as se,VIEWLET_ID as P,VIEW_ID as je}from"../common/files.js";import{COMPARE_RESOURCE_COMMAND_ID as Ge,COMPARE_SELECTED_COMMAND_ID as He,COMPARE_WITH_SAVED_COMMAND_ID as Xe,COPY_PATH_COMMAND_ID as me,COPY_RELATIVE_PATH_COMMAND_ID as le,FIRST_COMPRESSED_FOLDER as ze,LAST_COMPRESSED_FOLDER as Ye,NEW_FILE_COMMAND_ID as Be,NEW_UNTITLED_FILE_COMMAND_ID as qe,NEW_UNTITLED_FILE_LABEL as Je,NEXT_COMPRESSED_FOLDER as Qe,OPEN_TO_SIDE_COMMAND_ID as Ze,OPEN_WITH_EXPLORER_COMMAND_ID as $e,PREVIOUS_COMPRESSED_FOLDER as et,REMOVE_ROOT_FOLDER_COMMAND_ID as tt,REVEAL_IN_EXPLORER_COMMAND_ID as rt,REVERT_FILE_COMMAND_ID as it,ResourceSelectedForCompareContext as ot,SAVE_ALL_COMMAND_ID as nt,SAVE_ALL_IN_GROUP_COMMAND_ID as dt,SAVE_FILES_COMMAND_ID as at,SAVE_FILE_AS_COMMAND_ID as st,SAVE_FILE_COMMAND_ID as mt,SAVE_FILE_WITHOUT_FORMATTING_COMMAND_ID as lt,SELECT_FOR_COMPARE_COMMAND_ID as ct}from"./fileConstants.js";import{IExplorerService as h,getMultiSelectedResources as R,getOpenEditorsViewMultiSelection as ce,getResourceForCommand as _}from"./files.js";import{OpenEditorsView as pt}from"./views/openEditorsView.js";const or=(e,t,r)=>{if(Array.isArray(t)){const i=e.get(ne),o=e.get(_e);t=t.map(n=>De(n)&&n.workspaceUri.scheme===L.untitled?{workspaceUri:ee(o.untitledWorkspacesHome,n.workspaceUri.path,Ke)}:n),i.openWindow(t,r)}},nr=(e,t)=>{e.get(ne).openWindow(t)};g.registerCommandAndKeybindingRule({weight:p.WorkbenchContrib,when:Ue,primary:d.CtrlCmd|a.Enter,mac:{primary:d.WinCtrl|a.Enter},id:Ze,handler:async(e,t)=>{const r=e.get(c),i=e.get(F),o=e.get(h),n=R(t,e.get(v),r,e.get(S),o);if(n.length){const l=n.filter(u=>u.scheme===L.untitled),s=n.filter(u=>u.scheme!==L.untitled),T=(await Promise.all(s.map(async u=>{const B=o.findClosest(u);return B||await i.stat(u)}))).filter(u=>!u.isDirectory).map(u=>({resource:u.resource,options:{pinned:!0}})).concat(...l.map(u=>({resource:u,options:{pinned:!0}})));await r.openEditors(T,We)}}}),g.registerCommandAndKeybindingRule({weight:p.WorkbenchContrib+10,when:A.and(b,ke.toNegated()),primary:a.Enter,mac:{primary:d.CtrlCmd|a.DownArrow},id:"explorer.openAndPassFocus",handler:async(e,t)=>{const r=e.get(c),o=e.get(h).getContext(!0);o.length&&await r.openEditors(o.map(n=>({resource:n.resource,options:{preserveFocus:!1,pinned:!0}})))}});const j="showModifications";let y=[];g.registerCommandAndKeybindingRule({id:Xe,when:void 0,weight:p.WorkbenchContrib,primary:f(d.CtrlCmd|a.KeyK,a.KeyD),handler:async(e,t)=>{const r=e.get(te),i=e.get(Ie),o=e.get(c),n=e.get(F),l=e.get(v);let s=!1;if(y.length===0){s=!0;const C=r.createInstance(se);y.push(C),y.push(i.registerTextModelContentProvider(j,C))}const m=_(t,o,l);if(m&&n.hasProvider(m)){const C=fe(m),T=I.localize("modifiedLabel","{0} (in file) \u2194 {1}",C,C);try{await se.open(m,j,T,o,{pinned:!0}),s&&y.push(o.onDidVisibleEditorsChange(()=>{o.editors.some(u=>!!U.getCanonicalUri(u,{supportSideBySide:k.SECONDARY,filterByScheme:j}))||(y=Q(y))}))}catch{y=Q(y)}}}});let G,H;E.registerCommand({id:ct,handler:(e,t)=>{G=_(t,e.get(c),e.get(v)),H||(H=ot.bindTo(e.get(we))),H.set(!0)}}),E.registerCommand({id:He,handler:async(e,t)=>{const r=e.get(c),i=R(t,e.get(v),r,e.get(S),e.get(h));return i.length===2?r.openEditor({original:{resource:i[0]},modified:{resource:i[1]},options:{pinned:!0}}):!0}}),E.registerCommand({id:Ge,handler:(e,t)=>{const r=e.get(c),i=_(t,r,e.get(v));G&&i&&r.openEditor({original:{resource:G},modified:{resource:i},options:{pinned:!0}})}});async function X(e,t,r,i,o){if(e.length){const n=$?`\r
`:`
`;let l;if(t){const m=o.getValue("explorer.copyRelativePathSeparator");(m==="/"||m==="\\")&&(l=m)}const s=e.map(m=>i.getUriLabel(m,{relative:t,noPrefix:!0,separator:l})).join(n);await r.writeText(s)}}const pe=async(e,t)=>{const r=R(t,e.get(v),e.get(c),e.get(S),e.get(h));await X(r,!1,e.get(W),e.get(V),e.get(N))};g.registerCommandAndKeybindingRule({weight:p.WorkbenchContrib,when:O.focus.toNegated(),primary:d.CtrlCmd|d.Alt|a.KeyC,win:{primary:d.Shift|d.Alt|a.KeyC},id:me,handler:pe}),g.registerCommandAndKeybindingRule({weight:p.WorkbenchContrib,when:O.focus,primary:f(d.CtrlCmd|a.KeyK,d.CtrlCmd|d.Alt|a.KeyC),win:{primary:d.Shift|d.Alt|a.KeyC},id:me,handler:pe});const ge=async(e,t)=>{const r=R(t,e.get(v),e.get(c),e.get(S),e.get(h));await X(r,!0,e.get(W),e.get(V),e.get(N))};g.registerCommandAndKeybindingRule({weight:p.WorkbenchContrib,when:O.focus.toNegated(),primary:d.CtrlCmd|d.Shift|d.Alt|a.KeyC,win:{primary:f(d.CtrlCmd|a.KeyK,d.CtrlCmd|d.Shift|a.KeyC)},id:le,handler:ge}),g.registerCommandAndKeybindingRule({weight:p.WorkbenchContrib,when:O.focus,primary:f(d.CtrlCmd|a.KeyK,d.CtrlCmd|d.Shift|d.Alt|a.KeyC),win:{primary:f(d.CtrlCmd|a.KeyK,d.CtrlCmd|d.Shift|a.KeyC)},id:le,handler:ge}),g.registerCommandAndKeybindingRule({weight:p.WorkbenchContrib,when:void 0,primary:f(d.CtrlCmd|a.KeyK,a.KeyP),id:"workbench.action.files.copyPathOfActiveFile",handler:async e=>{const r=e.get(c).activeEditor,i=U.getOriginalUri(r,{supportSideBySide:k.PRIMARY});await X(i?[i]:[],!1,e.get(W),e.get(V),e.get(N))}}),E.registerCommand({id:rt,handler:async(e,t)=>{const r=e.get(Fe),i=e.get(ie),o=e.get(h),n=e.get(c),l=e.get(v),s=_(t,n,l);if(s&&i.isInsideWorkspace(s)){const m=await r.openView(je,!1);if(m){const C=m.autoReveal;m.autoReveal=!1,m.setExpanded(!0),await o.select(s,"force"),m.focus(),m.autoReveal=C}}else{const m=r.getViewWithId(pt.ID);m&&(m.setExpanded(!0),m.focus())}}}),E.registerCommand({id:$e,handler:async(e,t)=>{const r=e.get(c),i=e.get(v),o=_(t,r,i);if(o)return r.openEditor({resource:o,options:{override:Re.PICK,source:be.USER}})}});async function z(e,t){const r=e.get(S),i=e.get(Se),o=e.get(Ne);let n=ce(e);if(!n){const s=r.activeGroup;s.activeEditor&&(n=[],s.activeEditor instanceof Le&&!t?.saveAs&&!(s.activeEditor.primary.hasCapability(x.Untitled)||s.activeEditor.secondary.hasCapability(x.Untitled))&&s.activeEditor.secondary.isModified()?(n.push({groupId:s.id,editor:s.activeEditor.primary}),n.push({groupId:s.id,editor:s.activeEditor.secondary})):n.push({groupId:s.id,editor:s.activeEditor}))}if(!n||n.length===0)return;await Y(e,n,t);const l=i.getFocusedCodeEditor();if(l instanceof ye&&!l.isSimpleWidget){const s=l.getModel()?.uri;s&&!n.some(({editor:m})=>Ee(U.getCanonicalUri(m,{supportSideBySide:k.PRIMARY}),s))&&(o.files.get(s)?.isReadonly()||await o.save(s,t))}}function Ce(e,t,r){const i=[];for(const o of t)for(const n of o.getEditors(Te.MOST_RECENTLY_ACTIVE))n.isDirty()&&i.push({groupId:o.id,editor:n});return Y(e,i,r)}async function Y(e,t,r){const i=e.get(c),o=e.get(re),n=e.get(te);try{await i.save(t,r)}catch(l){if(!ue(l)){const s=[q({id:"workbench.action.files.saveEditors",label:I.localize("retry","Retry"),run:()=>n.invokeFunction(C=>Y(C,t,r))})],m=t.filter(({editor:C})=>!C.hasCapability(x.Untitled));m.length>0&&s.push(q({id:"workbench.action.files.revertEditors",label:m.length>1?I.localize("revertAll","Revert All"):I.localize("revert","Revert"),run:()=>i.revert(m)})),o.notify({id:t.map(({editor:C})=>ve(C.resource?.toString())).join(),severity:Oe.Error,message:I.localize({key:"genericSaveError",comment:["{0} is the resource that failed to save and {1} the error message"]},"Failed to save '{0}': {1}",t.map(({editor:C})=>C.getName()).join(", "),J(l,!1)),actions:{primary:s}})}}}g.registerCommandAndKeybindingRule({when:void 0,weight:p.WorkbenchContrib,primary:d.CtrlCmd|a.KeyS,id:mt,handler:e=>z(e,{reason:w.EXPLICIT,force:!0})}),g.registerCommandAndKeybindingRule({when:void 0,weight:p.WorkbenchContrib,primary:f(d.CtrlCmd|a.KeyK,a.KeyS),win:{primary:f(d.CtrlCmd|a.KeyK,d.CtrlCmd|d.Shift|a.KeyS)},id:lt,handler:e=>z(e,{reason:w.EXPLICIT,force:!0,skipSaveParticipants:!0})}),g.registerCommandAndKeybindingRule({id:st,weight:p.WorkbenchContrib,when:void 0,primary:d.CtrlCmd|d.Shift|a.KeyS,handler:e=>z(e,{reason:w.EXPLICIT,saveAs:!0})}),g.registerCommandAndKeybindingRule({when:void 0,weight:p.WorkbenchContrib,primary:void 0,mac:{primary:d.CtrlCmd|d.Alt|a.KeyS},win:{primary:f(d.CtrlCmd|a.KeyK,a.KeyS)},id:nt,handler:e=>Ce(e,e.get(S).getGroups(oe.MOST_RECENTLY_ACTIVE),{reason:w.EXPLICIT})}),E.registerCommand({id:dt,handler:(e,t,r)=>{const i=e.get(S),o=Pe([r],e.get(c),i,e.get(v));let n;return o.groupedEditors.length?n=o.groupedEditors.map(({group:l})=>l):n=i.getGroups(oe.MOST_RECENTLY_ACTIVE),Ce(e,n,{reason:w.EXPLICIT})}}),E.registerCommand({id:at,handler:async e=>(await e.get(c).saveAll({includeUntitled:!1,reason:w.EXPLICIT})).success}),E.registerCommand({id:it,handler:async e=>{const t=e.get(S),r=e.get(c);let i=ce(e);if(!i){const o=t.activeGroup;o.activeEditor&&(i=[{groupId:o.id,editor:o.activeEditor}])}if(!(!i||i.length===0))try{await r.revert(i.filter(({editor:o})=>!o.hasCapability(x.Untitled)),{force:!0})}catch(o){e.get(re).error(I.localize("genericRevertError","Failed to revert '{0}': {1}",i.map(({editor:l})=>l.getName()).join(", "),J(o,!1)))}}}),E.registerCommand({id:tt,handler:(e,t)=>{const r=e.get(ie),i=e.get(xe),o=r.getWorkspace(),n=R(t,e.get(v),e.get(c),e.get(S),e.get(h)).filter(s=>o.folders.some(m=>i.extUri.isEqual(m.uri,s)));return n.length===0?e.get(he).executeCommand(Me.ID):e.get(Ve).removeFolders(n)}}),g.registerCommandAndKeybindingRule({weight:p.WorkbenchContrib+10,when:A.and(b,M,de.negate()),primary:a.LeftArrow,id:et,handler:e=>{const r=e.get(K).getActivePaneComposite(D.Sidebar);if(r?.getId()!==P)return;r.getViewPaneContainer().getExplorerView().previousCompressedStat()}}),g.registerCommandAndKeybindingRule({weight:p.WorkbenchContrib+10,when:A.and(b,M,ae.negate()),primary:a.RightArrow,id:Qe,handler:e=>{const r=e.get(K).getActivePaneComposite(D.Sidebar);if(r?.getId()!==P)return;r.getViewPaneContainer().getExplorerView().nextCompressedStat()}}),g.registerCommandAndKeybindingRule({weight:p.WorkbenchContrib+10,when:A.and(b,M,de.negate()),primary:a.Home,id:ze,handler:e=>{const r=e.get(K).getActivePaneComposite(D.Sidebar);if(r?.getId()!==P)return;r.getViewPaneContainer().getExplorerView().firstCompressedStat()}}),g.registerCommandAndKeybindingRule({weight:p.WorkbenchContrib+10,when:A.and(b,M,ae.negate()),primary:a.End,id:Ye,handler:e=>{const r=e.get(K).getActivePaneComposite(D.Sidebar);if(r?.getId()!==P)return;r.getViewPaneContainer().getExplorerView().lastCompressedStat()}}),g.registerCommandAndKeybindingRule({weight:p.WorkbenchContrib,when:null,primary:Z?$?f(d.CtrlCmd|a.KeyK,a.KeyN):d.CtrlCmd|d.Alt|a.KeyN:d.CtrlCmd|a.KeyN,secondary:Z?[d.CtrlCmd|a.KeyN]:void 0,id:qe,metadata:{description:Je,args:[{isOptional:!0,name:"New Untitled Text File arguments",description:"The editor view type or language ID if known",schema:{type:"object",properties:{viewType:{type:"string"},languageId:{type:"string"}}}}]},handler:async(e,t)=>{await e.get(c).openEditor({resource:void 0,options:{override:t?.viewType,pinned:!0},languageId:t?.languageId})}}),E.registerCommand({id:Be,handler:async(e,t)=>{const r=e.get(c),i=e.get(Ae),o=e.get(F),n=I.localize("newFileCommand.saveLabel","Create File"),l=ee(await i.defaultFilePath(),t?.fileName??"Untitled.txt"),s=await i.showSaveDialog({saveLabel:n,title:n,defaultUri:l});s&&(await o.createFile(s,void 0,{overwrite:!0}),await r.openEditor({resource:s,options:{override:t?.viewType,pinned:!0},languageId:t?.languageId}))}});export{nr as newWindowCommand,or as openWindowCommand};
