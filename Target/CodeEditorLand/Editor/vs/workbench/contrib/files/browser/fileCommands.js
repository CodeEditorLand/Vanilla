import{toAction as q}from"../../../../../vs/base/common/actions.js";import{toErrorMessage as J}from"../../../../../vs/base/common/errorMessage.js";import{isCancellationError as ue}from"../../../../../vs/base/common/errors.js";import{hash as ve}from"../../../../../vs/base/common/hash.js";import{KeyChord as f,KeyCode as a,KeyMod as d}from"../../../../../vs/base/common/keyCodes.js";import{dispose as Q}from"../../../../../vs/base/common/lifecycle.js";import{Schemas as L}from"../../../../../vs/base/common/network.js";import{isWeb as Z,isWindows as $}from"../../../../../vs/base/common/platform.js";import{basename as fe,isEqual as Ee,joinPath as ee}from"../../../../../vs/base/common/resources.js";import"../../../../../vs/base/common/uri.js";import{ICodeEditorService as Se}from"../../../../../vs/editor/browser/services/codeEditorService.js";import{EmbeddedCodeEditorWidget as Ie}from"../../../../../vs/editor/browser/widget/codeEditor/embeddedCodeEditorWidget.js";import{EditorContextKeys as O}from"../../../../../vs/editor/common/editorContextKeys.js";import{ITextModelService as ye}from"../../../../../vs/editor/common/services/resolverService.js";import*as y from"../../../../../vs/nls.js";import{IClipboardService as N}from"../../../../../vs/platform/clipboard/common/clipboardService.js";import{CommandsRegistry as E,ICommandService as he}from"../../../../../vs/platform/commands/common/commands.js";import{IConfigurationService as W}from"../../../../../vs/platform/configuration/common/configuration.js";import{ContextKeyExpr as A,IContextKeyService as we}from"../../../../../vs/platform/contextkey/common/contextkey.js";import{IFileDialogService as Ae}from"../../../../../vs/platform/dialogs/common/dialogs.js";import{EditorOpenSource as Re,EditorResolution as be}from"../../../../../vs/platform/editor/common/editor.js";import{IEnvironmentService as _e}from"../../../../../vs/platform/environment/common/environment.js";import{IFileService as F}from"../../../../../vs/platform/files/common/files.js";import{IInstantiationService as te}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{KeybindingsRegistry as p,KeybindingWeight as g}from"../../../../../vs/platform/keybinding/common/keybindingsRegistry.js";import{ILabelService as U}from"../../../../../vs/platform/label/common/label.js";import{IListService as v}from"../../../../../vs/platform/list/browser/listService.js";import{INotificationService as re,Severity as Oe}from"../../../../../vs/platform/notification/common/notification.js";import{IUriIdentityService as De}from"../../../../../vs/platform/uriIdentity/common/uriIdentity.js";import{isWorkspaceToOpen as xe}from"../../../../../vs/platform/window/common/window.js";import{IWorkspaceContextService as ie,UNTITLED_WORKSPACE_NAME as Ke}from"../../../../../vs/platform/workspace/common/workspace.js";import{RemoveRootFolderAction as Me}from"../../../../../vs/workbench/browser/actions/workspaceActions.js";import{resolveCommandsContext as Pe}from"../../../../../vs/workbench/browser/parts/editor/editorCommandsContext.js";import{EditorInputCapabilities as D,EditorResourceAccessor as V,EditorsOrder as Te,SaveReason as w,SideBySideEditor as k}from"../../../../../vs/workbench/common/editor.js";import{SideBySideEditorInput as Le}from"../../../../../vs/workbench/common/editor/sideBySideEditorInput.js";import{ViewContainerLocation as x}from"../../../../../vs/workbench/common/views.js";import"../../../../../vs/workbench/contrib/files/browser/explorerViewlet.js";import{getMultiSelectedResources as R,getOpenEditorsViewMultiSelection as oe,getResourceForCommand as b,IExplorerService as h}from"../../../../../vs/workbench/contrib/files/browser/files.js";import"../../../../../vs/workbench/contrib/files/browser/views/explorerView.js";import{OpenEditorsView as Ne}from"../../../../../vs/workbench/contrib/files/browser/views/openEditorsView.js";import{ExplorerCompressedFirstFocusContext as ne,ExplorerCompressedFocusContext as K,ExplorerCompressedLastFocusContext as de,ExplorerFocusCondition as We,ExplorerFolderContext as Fe,FilesExplorerFocusCondition as _,TextFileContentProvider as ae,VIEW_ID as Ue,VIEWLET_ID as M}from"../../../../../vs/workbench/contrib/files/common/files.js";import{GroupsOrder as se,IEditorGroupsService as S}from"../../../../../vs/workbench/services/editor/common/editorGroupsService.js";import{IEditorService as c,SIDE_GROUP as Ve}from"../../../../../vs/workbench/services/editor/common/editorService.js";import{IHostService as me}from"../../../../../vs/workbench/services/host/browser/host.js";import{IPaneCompositePartService as P}from"../../../../../vs/workbench/services/panecomposite/browser/panecomposite.js";import{ITextFileService as ke}from"../../../../../vs/workbench/services/textfile/common/textfiles.js";import{IViewsService as je}from"../../../../../vs/workbench/services/views/common/viewsService.js";import{IWorkspaceEditingService as Ge}from"../../../../../vs/workbench/services/workspaces/common/workspaceEditing.js";import{COMPARE_RESOURCE_COMMAND_ID as He,COMPARE_SELECTED_COMMAND_ID as Xe,COMPARE_WITH_SAVED_COMMAND_ID as ze,COPY_PATH_COMMAND_ID as le,COPY_RELATIVE_PATH_COMMAND_ID as ce,FIRST_COMPRESSED_FOLDER as Ye,LAST_COMPRESSED_FOLDER as Be,NEW_FILE_COMMAND_ID as qe,NEW_UNTITLED_FILE_COMMAND_ID as Je,NEW_UNTITLED_FILE_LABEL as Qe,NEXT_COMPRESSED_FOLDER as Ze,OPEN_TO_SIDE_COMMAND_ID as $e,OPEN_WITH_EXPLORER_COMMAND_ID as et,PREVIOUS_COMPRESSED_FOLDER as tt,REMOVE_ROOT_FOLDER_COMMAND_ID as rt,ResourceSelectedForCompareContext as it,REVEAL_IN_EXPLORER_COMMAND_ID as ot,REVERT_FILE_COMMAND_ID as nt,SAVE_ALL_COMMAND_ID as dt,SAVE_ALL_IN_GROUP_COMMAND_ID as at,SAVE_FILE_AS_COMMAND_ID as st,SAVE_FILE_COMMAND_ID as mt,SAVE_FILE_WITHOUT_FORMATTING_COMMAND_ID as lt,SAVE_FILES_COMMAND_ID as ct,SELECT_FOR_COMPARE_COMMAND_ID as pt}from"./fileConstants.js";const hr=(e,t,r)=>{if(Array.isArray(t)){const i=e.get(me),o=e.get(_e);t=t.map(n=>xe(n)&&n.workspaceUri.scheme===L.untitled?{workspaceUri:ee(o.untitledWorkspacesHome,n.workspaceUri.path,Ke)}:n),i.openWindow(t,r)}},wr=(e,t)=>{e.get(me).openWindow(t)};p.registerCommandAndKeybindingRule({weight:g.WorkbenchContrib,when:We,primary:d.CtrlCmd|a.Enter,mac:{primary:d.WinCtrl|a.Enter},id:$e,handler:async(e,t)=>{const r=e.get(c),i=e.get(F),o=e.get(h),n=R(t,e.get(v),r,e.get(S),o);if(n.length){const l=n.filter(u=>u.scheme===L.untitled),s=n.filter(u=>u.scheme!==L.untitled),T=(await Promise.all(s.map(async u=>{const B=o.findClosest(u);return B||await i.stat(u)}))).filter(u=>!u.isDirectory).map(u=>({resource:u.resource,options:{pinned:!0}})).concat(...l.map(u=>({resource:u,options:{pinned:!0}})));await r.openEditors(T,Ve)}}}),p.registerCommandAndKeybindingRule({weight:g.WorkbenchContrib+10,when:A.and(_,Fe.toNegated()),primary:a.Enter,mac:{primary:d.CtrlCmd|a.DownArrow},id:"explorer.openAndPassFocus",handler:async(e,t)=>{const r=e.get(c),o=e.get(h).getContext(!0);o.length&&await r.openEditors(o.map(n=>({resource:n.resource,options:{preserveFocus:!1,pinned:!0}})))}});const j="showModifications";let I=[];p.registerCommandAndKeybindingRule({id:ze,when:void 0,weight:g.WorkbenchContrib,primary:f(d.CtrlCmd|a.KeyK,a.KeyD),handler:async(e,t)=>{const r=e.get(te),i=e.get(ye),o=e.get(c),n=e.get(F),l=e.get(v);let s=!1;if(I.length===0){s=!0;const C=r.createInstance(ae);I.push(C),I.push(i.registerTextModelContentProvider(j,C))}const m=b(t,o,l);if(m&&n.hasProvider(m)){const C=fe(m),T=y.localize("modifiedLabel","{0} (in file) \u2194 {1}",C,C);try{await ae.open(m,j,T,o,{pinned:!0}),s&&I.push(o.onDidVisibleEditorsChange(()=>{o.editors.some(u=>!!V.getCanonicalUri(u,{supportSideBySide:k.SECONDARY,filterByScheme:j}))||(I=Q(I))}))}catch{I=Q(I)}}}});let G,H;E.registerCommand({id:pt,handler:(e,t)=>{G=b(t,e.get(c),e.get(v)),H||(H=it.bindTo(e.get(we))),H.set(!0)}}),E.registerCommand({id:Xe,handler:async(e,t)=>{const r=e.get(c),i=R(t,e.get(v),r,e.get(S),e.get(h));return i.length===2?r.openEditor({original:{resource:i[0]},modified:{resource:i[1]},options:{pinned:!0}}):!0}}),E.registerCommand({id:He,handler:(e,t)=>{const r=e.get(c),i=b(t,r,e.get(v));G&&i&&r.openEditor({original:{resource:G},modified:{resource:i},options:{pinned:!0}})}});async function X(e,t,r,i,o){if(e.length){const n=$?`\r
`:`
`;let l;if(t){const m=o.getValue("explorer.copyRelativePathSeparator");(m==="/"||m==="\\")&&(l=m)}const s=e.map(m=>i.getUriLabel(m,{relative:t,noPrefix:!0,separator:l})).join(n);await r.writeText(s)}}const pe=async(e,t)=>{const r=R(t,e.get(v),e.get(c),e.get(S),e.get(h));await X(r,!1,e.get(N),e.get(U),e.get(W))};p.registerCommandAndKeybindingRule({weight:g.WorkbenchContrib,when:O.focus.toNegated(),primary:d.CtrlCmd|d.Alt|a.KeyC,win:{primary:d.Shift|d.Alt|a.KeyC},id:le,handler:pe}),p.registerCommandAndKeybindingRule({weight:g.WorkbenchContrib,when:O.focus,primary:f(d.CtrlCmd|a.KeyK,d.CtrlCmd|d.Alt|a.KeyC),win:{primary:d.Shift|d.Alt|a.KeyC},id:le,handler:pe});const ge=async(e,t)=>{const r=R(t,e.get(v),e.get(c),e.get(S),e.get(h));await X(r,!0,e.get(N),e.get(U),e.get(W))};p.registerCommandAndKeybindingRule({weight:g.WorkbenchContrib,when:O.focus.toNegated(),primary:d.CtrlCmd|d.Shift|d.Alt|a.KeyC,win:{primary:f(d.CtrlCmd|a.KeyK,d.CtrlCmd|d.Shift|a.KeyC)},id:ce,handler:ge}),p.registerCommandAndKeybindingRule({weight:g.WorkbenchContrib,when:O.focus,primary:f(d.CtrlCmd|a.KeyK,d.CtrlCmd|d.Shift|d.Alt|a.KeyC),win:{primary:f(d.CtrlCmd|a.KeyK,d.CtrlCmd|d.Shift|a.KeyC)},id:ce,handler:ge}),p.registerCommandAndKeybindingRule({weight:g.WorkbenchContrib,when:void 0,primary:f(d.CtrlCmd|a.KeyK,a.KeyP),id:"workbench.action.files.copyPathOfActiveFile",handler:async e=>{const r=e.get(c).activeEditor,i=V.getOriginalUri(r,{supportSideBySide:k.PRIMARY});await X(i?[i]:[],!1,e.get(N),e.get(U),e.get(W))}}),E.registerCommand({id:ot,handler:async(e,t)=>{const r=e.get(je),i=e.get(ie),o=e.get(h),n=e.get(c),l=e.get(v),s=b(t,n,l);if(s&&i.isInsideWorkspace(s)){const m=await r.openView(Ue,!1);if(m){const C=m.autoReveal;m.autoReveal=!1,m.setExpanded(!0),await o.select(s,"force"),m.focus(),m.autoReveal=C}}else{const m=await r.openView(Ne.ID,!1);m&&(m.setExpanded(!0),m.focus())}}}),E.registerCommand({id:et,handler:async(e,t)=>{const r=e.get(c),i=e.get(v),o=b(t,r,i);if(o)return r.openEditor({resource:o,options:{override:be.PICK,source:Re.USER}})}});async function z(e,t){const r=e.get(S),i=e.get(Se),o=e.get(ke);let n=oe(e);if(!n){const s=r.activeGroup;s.activeEditor&&(n=[],s.activeEditor instanceof Le&&!t?.saveAs&&!(s.activeEditor.primary.hasCapability(D.Untitled)||s.activeEditor.secondary.hasCapability(D.Untitled))&&s.activeEditor.secondary.isModified()?(n.push({groupId:s.id,editor:s.activeEditor.primary}),n.push({groupId:s.id,editor:s.activeEditor.secondary})):n.push({groupId:s.id,editor:s.activeEditor}))}if(!n||n.length===0)return;await Y(e,n,t);const l=i.getFocusedCodeEditor();if(l instanceof Ie&&!l.isSimpleWidget){const s=l.getModel()?.uri;s&&!n.some(({editor:m})=>Ee(V.getCanonicalUri(m,{supportSideBySide:k.PRIMARY}),s))&&(o.files.get(s)?.isReadonly()||await o.save(s,t))}}function Ce(e,t,r){const i=[];for(const o of t)for(const n of o.getEditors(Te.MOST_RECENTLY_ACTIVE))n.isDirty()&&i.push({groupId:o.id,editor:n});return Y(e,i,r)}async function Y(e,t,r){const i=e.get(c),o=e.get(re),n=e.get(te);try{await i.save(t,r)}catch(l){if(!ue(l)){const s=[q({id:"workbench.action.files.saveEditors",label:y.localize("retry","Retry"),run:()=>n.invokeFunction(C=>Y(C,t,r))})],m=t.filter(({editor:C})=>!C.hasCapability(D.Untitled));m.length>0&&s.push(q({id:"workbench.action.files.revertEditors",label:m.length>1?y.localize("revertAll","Revert All"):y.localize("revert","Revert"),run:()=>i.revert(m)})),o.notify({id:t.map(({editor:C})=>ve(C.resource?.toString())).join(),severity:Oe.Error,message:y.localize({key:"genericSaveError",comment:["{0} is the resource that failed to save and {1} the error message"]},"Failed to save '{0}': {1}",t.map(({editor:C})=>C.getName()).join(", "),J(l,!1)),actions:{primary:s}})}}}p.registerCommandAndKeybindingRule({when:void 0,weight:g.WorkbenchContrib,primary:d.CtrlCmd|a.KeyS,id:mt,handler:e=>z(e,{reason:w.EXPLICIT,force:!0})}),p.registerCommandAndKeybindingRule({when:void 0,weight:g.WorkbenchContrib,primary:f(d.CtrlCmd|a.KeyK,a.KeyS),win:{primary:f(d.CtrlCmd|a.KeyK,d.CtrlCmd|d.Shift|a.KeyS)},id:lt,handler:e=>z(e,{reason:w.EXPLICIT,force:!0,skipSaveParticipants:!0})}),p.registerCommandAndKeybindingRule({id:st,weight:g.WorkbenchContrib,when:void 0,primary:d.CtrlCmd|d.Shift|a.KeyS,handler:e=>z(e,{reason:w.EXPLICIT,saveAs:!0})}),p.registerCommandAndKeybindingRule({when:void 0,weight:g.WorkbenchContrib,primary:void 0,mac:{primary:d.CtrlCmd|d.Alt|a.KeyS},win:{primary:f(d.CtrlCmd|a.KeyK,a.KeyS)},id:dt,handler:e=>Ce(e,e.get(S).getGroups(se.MOST_RECENTLY_ACTIVE),{reason:w.EXPLICIT})}),E.registerCommand({id:at,handler:(e,t,r)=>{const i=e.get(S),o=Pe([r],e.get(c),i,e.get(v));let n;return o.groupedEditors.length?n=o.groupedEditors.map(({group:l})=>l):n=i.getGroups(se.MOST_RECENTLY_ACTIVE),Ce(e,n,{reason:w.EXPLICIT})}}),E.registerCommand({id:ct,handler:async e=>(await e.get(c).saveAll({includeUntitled:!1,reason:w.EXPLICIT})).success}),E.registerCommand({id:nt,handler:async e=>{const t=e.get(S),r=e.get(c);let i=oe(e);if(!i){const o=t.activeGroup;o.activeEditor&&(i=[{groupId:o.id,editor:o.activeEditor}])}if(!(!i||i.length===0))try{await r.revert(i.filter(({editor:o})=>!o.hasCapability(D.Untitled)),{force:!0})}catch(o){e.get(re).error(y.localize("genericRevertError","Failed to revert '{0}': {1}",i.map(({editor:l})=>l.getName()).join(", "),J(o,!1)))}}}),E.registerCommand({id:rt,handler:(e,t)=>{const r=e.get(ie),i=e.get(De),o=r.getWorkspace(),n=R(t,e.get(v),e.get(c),e.get(S),e.get(h)).filter(s=>o.folders.some(m=>i.extUri.isEqual(m.uri,s)));return n.length===0?e.get(he).executeCommand(Me.ID):e.get(Ge).removeFolders(n)}}),p.registerCommandAndKeybindingRule({weight:g.WorkbenchContrib+10,when:A.and(_,K,ne.negate()),primary:a.LeftArrow,id:tt,handler:e=>{const r=e.get(P).getActivePaneComposite(x.Sidebar);if(r?.getId()!==M)return;r.getViewPaneContainer().getExplorerView().previousCompressedStat()}}),p.registerCommandAndKeybindingRule({weight:g.WorkbenchContrib+10,when:A.and(_,K,de.negate()),primary:a.RightArrow,id:Ze,handler:e=>{const r=e.get(P).getActivePaneComposite(x.Sidebar);if(r?.getId()!==M)return;r.getViewPaneContainer().getExplorerView().nextCompressedStat()}}),p.registerCommandAndKeybindingRule({weight:g.WorkbenchContrib+10,when:A.and(_,K,ne.negate()),primary:a.Home,id:Ye,handler:e=>{const r=e.get(P).getActivePaneComposite(x.Sidebar);if(r?.getId()!==M)return;r.getViewPaneContainer().getExplorerView().firstCompressedStat()}}),p.registerCommandAndKeybindingRule({weight:g.WorkbenchContrib+10,when:A.and(_,K,de.negate()),primary:a.End,id:Be,handler:e=>{const r=e.get(P).getActivePaneComposite(x.Sidebar);if(r?.getId()!==M)return;r.getViewPaneContainer().getExplorerView().lastCompressedStat()}}),p.registerCommandAndKeybindingRule({weight:g.WorkbenchContrib,when:null,primary:Z?$?f(d.CtrlCmd|a.KeyK,a.KeyN):d.CtrlCmd|d.Alt|a.KeyN:d.CtrlCmd|a.KeyN,secondary:Z?[d.CtrlCmd|a.KeyN]:void 0,id:Je,metadata:{description:Qe,args:[{isOptional:!0,name:"New Untitled Text File arguments",description:"The editor view type or language ID if known",schema:{type:"object",properties:{viewType:{type:"string"},languageId:{type:"string"}}}}]},handler:async(e,t)=>{await e.get(c).openEditor({resource:void 0,options:{override:t?.viewType,pinned:!0},languageId:t?.languageId})}}),E.registerCommand({id:qe,handler:async(e,t)=>{const r=e.get(c),i=e.get(Ae),o=e.get(F),n=y.localize("newFileCommand.saveLabel","Create File"),l=ee(await i.defaultFilePath(),t?.fileName??"Untitled.txt"),s=await i.showSaveDialog({saveLabel:n,title:n,defaultUri:l});s&&(await o.createFile(s,void 0,{overwrite:!0}),await r.openEditor({resource:s,options:{override:t?.viewType,pinned:!0},languageId:t?.languageId}))}});export{wr as newWindowCommand,hr as openWindowCommand};
