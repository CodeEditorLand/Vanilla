var f=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var c=(n,o,e,i)=>{for(var r=i>1?void 0:i?S(o,e):o,s=n.length-1,d;s>=0;s--)(d=n[s])&&(r=(i?d(o,e,r):d(r))||r);return i&&r&&f(o,e,r),r},t=(n,o)=>(e,i)=>o(e,i,n);import"../../../../common/contributions.js";import"../../../../../base/common/uri.js";import{ITextFileService as h,TextFileEditorModelState as v}from"../../../../services/textfile/common/textfiles.js";import{ILifecycleService as u}from"../../../../services/lifecycle/common/lifecycle.js";import{Disposable as m}from"../../../../../base/common/lifecycle.js";import{distinct as a,coalesce as y}from"../../../../../base/common/arrays.js";import{IHostService as I}from"../../../../services/host/browser/host.js";import{IEditorService as D}from"../../../../services/editor/common/editorService.js";import{RunOnceWorker as g}from"../../../../../base/common/async.js";import{ICodeEditorService as F}from"../../../../../editor/browser/services/codeEditorService.js";import{IFilesConfigurationService as E}from"../../../../services/filesConfiguration/common/filesConfigurationService.js";import{FILE_EDITOR_INPUT_ID as x}from"../../common/files.js";import{Schemas as p}from"../../../../../base/common/network.js";import{UntitledTextEditorInput as C}from"../../../../services/untitled/common/untitledTextEditorInput.js";import{IWorkingCopyEditorService as k}from"../../../../services/workingCopy/common/workingCopyEditorService.js";import{DEFAULT_EDITOR_ASSOCIATION as O}from"../../../../common/editor.js";let l=class extends m{constructor(e,i,r,s,d,T,A){super();this.editorService=e;this.textFileService=i;this.lifecycleService=r;this.hostService=s;this.codeEditorService=d;this.filesConfigurationService=T;this.workingCopyEditorService=A;this.registerListeners()}static ID="workbench.contrib.textFileEditorTracker";registerListeners(){this._register(this.textFileService.files.onDidChangeDirty(e=>this.ensureDirtyFilesAreOpenedWorker.work(e.resource))),this._register(this.textFileService.files.onDidSaveError(e=>this.ensureDirtyFilesAreOpenedWorker.work(e.resource))),this._register(this.textFileService.untitled.onDidChangeDirty(e=>this.ensureDirtyFilesAreOpenedWorker.work(e.resource))),this._register(this.hostService.onDidChangeFocus(e=>e?this.reloadVisibleTextFileEditors():void 0)),this._register(this.lifecycleService.onDidShutdown(()=>this.dispose()))}ensureDirtyFilesAreOpenedWorker=this._register(new g(e=>this.ensureDirtyTextFilesAreOpened(e),this.getDirtyTextFileTrackerDelay()));getDirtyTextFileTrackerDelay(){return 800}ensureDirtyTextFilesAreOpened(e){this.doEnsureDirtyTextFilesAreOpened(a(e.filter(i=>{if(!this.textFileService.isDirty(i))return!1;const r=this.textFileService.files.get(i);if(r?.hasState(v.PENDING_SAVE)||i.scheme!==p.untitled&&!r?.hasState(v.ERROR)&&this.filesConfigurationService.hasShortAutoSaveDelay(i)||this.editorService.isOpened({resource:i,typeId:i.scheme===p.untitled?C.ID:x,editorId:O.id}))return!1;const s=r??this.textFileService.untitled.get(i);return!(s&&this.workingCopyEditorService.findEditor(s))}),i=>i.toString()))}doEnsureDirtyTextFilesAreOpened(e){e.length&&this.editorService.openEditors(e.map(i=>({resource:i,options:{inactive:!0,pinned:!0,preserveFocus:!0}})))}reloadVisibleTextFileEditors(){a(y(this.codeEditorService.listCodeEditors().map(e=>{const i=e.getModel()?.uri;if(!i)return;const r=this.textFileService.files.get(i);if(!(!r||r.isDirty()||!r.isResolved()))return r})),e=>e.resource.toString()).forEach(e=>this.textFileService.files.resolve(e.resource,{reload:{async:!0}}))}};l=c([t(0,D),t(1,h),t(2,u),t(3,I),t(4,F),t(5,E),t(6,k)],l);export{l as TextFileEditorTracker};
