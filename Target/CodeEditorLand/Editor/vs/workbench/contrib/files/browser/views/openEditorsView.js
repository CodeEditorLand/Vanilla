var ie=Object.defineProperty;var re=Object.getOwnPropertyDescriptor;var G=(c,i,e,t)=>{for(var o=t>1?void 0:t?re(i,e):i,n=c.length-1,r;n>=0;n--)(r=c[n])&&(o=(t?r(i,e,o):r(o))||o);return t&&o&&ie(i,e,o),o},l=(c,i)=>(e,t)=>i(e,t,c);import"./media/openeditors.css";import{DataTransfers as oe}from"../../../../../base/browser/dnd.js";import*as v from"../../../../../base/browser/dom.js";import{ActionBar as V}from"../../../../../base/browser/ui/actionbar/actionbar.js";import{ListDragOverEffectPosition as R,ListDragOverEffectType as P}from"../../../../../base/browser/ui/list/list.js";import{ElementsDragAndDropData as N,ListViewTargetSector as f,NativeDragAndDropData as ne}from"../../../../../base/browser/ui/list/listView.js";import{Orientation as H}from"../../../../../base/browser/ui/splitview/splitview.js";import{mainWindow as se}from"../../../../../base/browser/window.js";import{ActionRunner as de}from"../../../../../base/common/actions.js";import{RunOnceScheduler as ae}from"../../../../../base/common/async.js";import{Codicon as b}from"../../../../../base/common/codicons.js";import{compareFileNamesDefault as K}from"../../../../../base/common/comparers.js";import{memoize as ce}from"../../../../../base/common/decorators.js";import{KeyCode as z,KeyMod as D}from"../../../../../base/common/keyCodes.js";import{DisposableMap as le,dispose as ue}from"../../../../../base/common/lifecycle.js";import{Schemas as I}from"../../../../../base/common/network.js";import{extUriIgnorePathCase as U}from"../../../../../base/common/resources.js";import*as m from"../../../../../nls.js";import{Action2 as O,MenuId as g,MenuRegistry as pe,registerAction2 as C}from"../../../../../platform/actions/common/actions.js";import{ICommandService as W}from"../../../../../platform/commands/common/commands.js";import{IConfigurationService as he}from"../../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as S,IContextKeyService as fe}from"../../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as ve}from"../../../../../platform/contextview/browser/contextView.js";import{CodeDataTransfers as me,containsDragType as ge}from"../../../../../platform/dnd/browser/dnd.js";import{IFileService as Ee}from"../../../../../platform/files/common/files.js";import{IHoverService as Ie}from"../../../../../platform/hover/browser/hover.js";import{IInstantiationService as j}from"../../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as Se}from"../../../../../platform/keybinding/common/keybinding.js";import{KeybindingWeight as ye}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import{WorkbenchList as be}from"../../../../../platform/list/browser/listService.js";import{IOpenerService as De}from"../../../../../platform/opener/common/opener.js";import{ITelemetryService as Oe}from"../../../../../platform/telemetry/common/telemetry.js";import{asCssVariable as w,badgeBackground as Ce,badgeForeground as Te,contrastBorder as Le}from"../../../../../platform/theme/common/colorRegistry.js";import{IThemeService as Ae}from"../../../../../platform/theme/common/themeService.js";import{ResourcesDropHandler as xe,fillEditorsDragData as Ge}from"../../../../browser/dnd.js";import{ResourceLabels as Re}from"../../../../browser/labels.js";import{CloseAllEditorsAction as q,CloseEditorAction as M,UnpinEditorAction as _}from"../../../../browser/parts/editor/editorActions.js";import{EditorGroupView as $}from"../../../../browser/parts/editor/editorGroupView.js";import{ViewPane as we}from"../../../../browser/parts/views/viewPane.js";import{MultipleEditorGroupsContext as Me,ResourceContextKey as _e}from"../../../../common/contextkeys.js";import{EditorCloseMethod as ke,EditorResourceAccessor as Y,GroupModelChangeKind as h,SideBySideEditor as Be,Verbosity as X,preventEditorClose as Fe}from"../../../../common/editor.js";import{IViewDescriptorService as Ve}from"../../../../common/views.js";import{GroupOrientation as k,GroupsOrder as Pe,IEditorGroupsService as Z}from"../../../../services/editor/common/editorGroupsService.js";import{IFilesConfigurationService as Ne}from"../../../../services/filesConfiguration/common/filesConfigurationService.js";import{WorkingCopyCapabilities as He}from"../../../../services/workingCopy/common/workingCopy.js";import{IWorkingCopyService as Ke}from"../../../../services/workingCopy/common/workingCopyService.js";import{ExplorerFocusedContext as ze,OpenEditor as a,OpenEditorsFocusedContext as Ue}from"../../common/files.js";import{CloseGroupAction as B,SaveAllInGroupAction as F}from"../fileActions.js";import{NEW_UNTITLED_FILE_COMMAND_ID as We,OpenEditorsDirtyEditorContext as je,OpenEditorsGroupContext as qe,OpenEditorsReadonlyEditorContext as $e,OpenEditorsSelectedFileOrUntitledContext as Ye,SAVE_ALL_COMMAND_ID as Xe,SAVE_ALL_LABEL as Ze}from"../fileConstants.js";const T=v.$;let u=class extends we{constructor(e,t,o,n,r,s,d,p,E,Q,ee,tt,it,te,rt){super(e,d,n,s,p,o,t,te,E,Q,ee);this.editorGroupService=r;this.workingCopyService=tt;this.filesConfigurationService=it;this.fileService=rt;this.structuralRefreshDelay=0,this.sortOrder=s.getValue("explorer.openEditors.sortOrder"),this.registerUpdateEvents(),this._register(this.configurationService.onDidChangeConfiguration(x=>this.onConfigurationChange(x))),this._register(this.workingCopyService.onDidChangeDirty(x=>this.updateDirtyIndicator(x)))}static DEFAULT_VISIBLE_OPEN_EDITORS=9;static DEFAULT_MIN_VISIBLE_OPEN_EDITORS=0;static ID="workbench.explorer.openEditorsView";static NAME=m.localize2({key:"openEditors",comment:["Open is an adjective"]},"Open Editors");dirtyCountElement;listRefreshScheduler;structuralRefreshDelay;dnd;list;listLabels;needsRefresh=!1;elements=[];sortOrder;blockFocusActiveEditorTracking=!1;registerUpdateEvents(){const e=()=>{if(!this.isBodyVisible()||!this.list){this.needsRefresh=!0;return}this.listRefreshScheduler?.schedule(this.structuralRefreshDelay)},t=this._register(new le),o=n=>{const r=n.onDidModelChange(s=>{if(this.listRefreshScheduler?.isScheduled())return;if(!this.isBodyVisible()||!this.list){this.needsRefresh=!0;return}const d=this.getIndex(n,s.editor);switch(s.kind){case h.EDITOR_ACTIVE:this.focusActiveEditor();break;case h.GROUP_INDEX:case h.GROUP_LABEL:d>=0&&this.list.splice(d,1,[n]);break;case h.EDITOR_DIRTY:case h.EDITOR_STICKY:case h.EDITOR_CAPABILITIES:case h.EDITOR_PIN:case h.EDITOR_LABEL:this.list.splice(d,1,[new a(s.editor,n)]),this.focusActiveEditor();break;case h.EDITOR_OPEN:case h.EDITOR_MOVE:case h.EDITOR_CLOSE:e();break}});t.set(n.id,r)};this.editorGroupService.groups.forEach(n=>o(n)),this._register(this.editorGroupService.onDidAddGroup(n=>{o(n),e()})),this._register(this.editorGroupService.onDidMoveGroup(()=>e())),this._register(this.editorGroupService.onDidChangeActiveGroup(()=>this.focusActiveEditor())),this._register(this.editorGroupService.onDidRemoveGroup(n=>{t.deleteAndDispose(n.id),e()}))}renderHeaderTitle(e){super.renderHeaderTitle(e,this.title);const t=v.append(e,T(".open-editors-dirty-count-container"));this.dirtyCountElement=v.append(t,T(".dirty-count.monaco-count-badge.long")),this.dirtyCountElement.style.backgroundColor=w(Ce),this.dirtyCountElement.style.color=w(Te),this.dirtyCountElement.style.border=`1px solid ${w(Le)}`,this.updateDirtyIndicator()}renderBody(e){super.renderBody(e),e.classList.add("open-editors"),e.classList.add("show-file-icons");const t=new y;this.list&&this.list.dispose(),this.listLabels&&this.listLabels.clear(),this.dnd=new J(this.sortOrder,this.instantiationService,this.editorGroupService),this.listLabels=this.instantiationService.createInstance(Re,{onDidChangeVisibility:this.onDidChangeBodyVisibility}),this.list=this.instantiationService.createInstance(be,"OpenEditors",e,t,[new L(this.keybindingService,this.instantiationService),new A(this.listLabels,this.instantiationService,this.keybindingService,this.configurationService)],{identityProvider:{getId:r=>r instanceof a?r.getId():r.id.toString()},dnd:this.dnd,overrideStyles:this.getLocationBasedColors().listOverrideStyles,accessibilityProvider:new Qe}),this._register(this.list),this._register(this.listLabels);let o=[];this.listRefreshScheduler=this._register(new ae(()=>{if(!this.list)return;o=ue(o);const r=this.list.length,s=this.getElements();this.list.splice(0,this.list.length,s),this.focusActiveEditor(),r!==this.list.length&&this.updateSize(),this.needsRefresh=!1,(this.sortOrder==="alphabetical"||this.sortOrder==="fullPath")&&s.forEach(d=>{d instanceof a&&o.push(d.editor.onDidChangeLabel(()=>this.listRefreshScheduler?.schedule()))})},this.structuralRefreshDelay)),this.updateSize(),this.handleContextKeys(),this._register(this.list.onContextMenu(r=>this.onListContextMenu(r))),this._register(this.list.onMouseMiddleClick(r=>{if(r&&r.element instanceof a){if(Fe(r.element.group,r.element.editor,ke.MOUSE,this.editorGroupService.partOptions))return;r.element.group.closeEditor(r.element.editor,{preserveFocus:!0})}})),this._register(this.list.onDidOpen(r=>{const s=r.element;if(s)if(s instanceof a){if(v.isMouseEvent(r.browserEvent)&&r.browserEvent.button===1)return;this.withActiveEditorFocusTrackingDisabled(()=>{this.openEditor(s,{preserveFocus:r.editorOptions.preserveFocus,pinned:r.editorOptions.pinned,sideBySide:r.sideBySide})})}else this.withActiveEditorFocusTrackingDisabled(()=>{this.editorGroupService.activateGroup(s),r.editorOptions.preserveFocus||s.focus()});else return})),this.listRefreshScheduler.schedule(0),this._register(this.onDidChangeBodyVisibility(r=>{r&&this.needsRefresh&&this.listRefreshScheduler?.schedule(0)}));const n=this.viewDescriptorService.getViewContainerModel(this.viewDescriptorService.getViewContainerByViewId(this.id));this._register(n.onDidChangeAllViewDescriptors(()=>{this.updateSize()}))}handleContextKeys(){if(!this.list)return;Ue.bindTo(this.list.contextKeyService),ze.bindTo(this.list.contextKeyService);const e=qe.bindTo(this.contextKeyService),t=je.bindTo(this.contextKeyService),o=$e.bindTo(this.contextKeyService),n=Ye.bindTo(this.contextKeyService),r=this.instantiationService.createInstance(_e);this._register(r),this._register(this.list.onDidChangeFocus(s=>{r.reset(),e.reset(),t.reset(),o.reset();const d=s.elements.length?s.elements[0]:void 0;if(d instanceof a){const p=d.getResource();t.set(d.editor.isDirty()&&!d.editor.isSaving()),o.set(!!d.editor.isReadonly()),r.set(p??null)}else d&&e.set(!0)})),this._register(this.list.onDidChangeSelection(s=>{const d=s.elements.every(p=>{if(p instanceof a){const E=p.getResource();return E&&(E.scheme===I.untitled||this.fileService.hasProvider(E))}return!1});n.set(d)}))}focus(){super.focus(),this.list?.domFocus()}layoutBody(e,t){super.layoutBody(e,t),this.list?.layout(e,t)}get showGroups(){return this.editorGroupService.groups.length>1}getElements(){return this.elements=[],this.editorGroupService.getGroups(Pe.GRID_APPEARANCE).forEach(e=>{this.showGroups&&this.elements.push(e);let t=e.editors.map(o=>new a(o,e));this.sortOrder==="alphabetical"?t=t.sort((o,n)=>K(o.editor.getName(),n.editor.getName())):this.sortOrder==="fullPath"&&(t=t.sort((o,n)=>{const r=o.editor.resource,s=n.editor.resource;if(r===void 0&&s===void 0)return K(o.editor.getName(),n.editor.getName());if(r===void 0)return-1;if(s===void 0)return 1;{const d=r.scheme,p=s.scheme;return d!==I.file&&p!==I.file?U.compare(r,s):d!==I.file?-1:p!==I.file?1:U.compare(r,s)}})),this.elements.push(...t)}),this.elements}getIndex(e,t){return t?this.elements.findIndex(o=>o instanceof a&&o.editor===t&&o.group.id===e.id):this.elements.findIndex(o=>!(o instanceof a)&&o.id===e.id)}openEditor(e,t){e&&(this.telemetryService.publicLog2("workbenchActionExecuted",{id:"workbench.files.openFile",from:"openEditors"}),t.sideBySide&&t.preserveFocus||this.editorGroupService.activateGroup(e.group),(t.sideBySide?this.editorGroupService.sideGroup:e.group).openEditor(e.editor,t))}onListContextMenu(e){if(!e.element)return;const t=e.element;this.contextMenuService.showContextMenu({menuId:g.OpenEditorsContext,menuActionOptions:{shouldForwardArgs:!0,arg:t instanceof a?Y.getOriginalUri(t.editor):{}},contextKeyService:this.list?.contextKeyService,getAnchor:()=>e.anchor,getActionsContext:()=>t instanceof a?{groupId:t.groupId,editorIndex:t.group.getIndexOfEditor(t.editor)}:{groupId:t.id}})}withActiveEditorFocusTrackingDisabled(e){this.blockFocusActiveEditorTracking=!0;try{e()}finally{this.blockFocusActiveEditorTracking=!1}}focusActiveEditor(){if(!(!this.list||this.blockFocusActiveEditorTracking)){if(this.list.length&&this.editorGroupService.activeGroup){const e=this.getIndex(this.editorGroupService.activeGroup,this.editorGroupService.activeGroup.activeEditor);if(e>=0){try{this.list.setFocus([e]),this.list.setSelection([e]),this.list.reveal(e)}catch{}return}}this.list.setFocus([]),this.list.setSelection([])}}onConfigurationChange(e){e.affectsConfiguration("explorer.openEditors")&&this.updateSize(),(e.affectsConfiguration("explorer.decorations")||e.affectsConfiguration("explorer.openEditors.sortOrder"))&&(this.sortOrder=this.configurationService.getValue("explorer.openEditors.sortOrder"),this.dnd&&(this.dnd.sortOrder=this.sortOrder),this.listRefreshScheduler?.schedule())}updateSize(){this.minimumBodySize=this.orientation===H.VERTICAL?this.getMinExpandedBodySize():170,this.maximumBodySize=this.orientation===H.VERTICAL?this.getMaxExpandedBodySize():Number.POSITIVE_INFINITY}updateDirtyIndicator(e){if(e&&e.isDirty()&&!(e.capabilities&He.Untitled)&&this.filesConfigurationService.hasShortAutoSaveDelay(e.resource))return;const t=this.workingCopyService.dirtyCount;t===0?this.dirtyCountElement.classList.add("hidden"):(this.dirtyCountElement.textContent=m.localize("dirtyCounter","{0} unsaved",t),this.dirtyCountElement.classList.remove("hidden"))}get elementCount(){return this.editorGroupService.groups.map(e=>e.count).reduce((e,t)=>e+t,this.showGroups?this.editorGroupService.groups.length:0)}getMaxExpandedBodySize(){let e=this.configurationService.getValue("explorer.openEditors.minVisible");return typeof e!="number"&&(e=u.DEFAULT_MIN_VISIBLE_OPEN_EDITORS),this.viewDescriptorService.getViewContainerModel(this.viewDescriptorService.getViewContainerByViewId(this.id)).visibleViewDescriptors.length<=1?Number.POSITIVE_INFINITY:Math.max(this.elementCount,e)*y.ITEM_HEIGHT}getMinExpandedBodySize(){let e=this.configurationService.getValue("explorer.openEditors.visible");return typeof e!="number"&&(e=u.DEFAULT_VISIBLE_OPEN_EDITORS),this.computeMinExpandedBodySize(e)}computeMinExpandedBodySize(e=u.DEFAULT_VISIBLE_OPEN_EDITORS){return Math.min(Math.max(e,1),this.elementCount)*y.ITEM_HEIGHT}setStructuralRefreshDelay(e){this.structuralRefreshDelay=e}getOptimalWidth(){if(!this.list)return super.getOptimalWidth();const e=this.list.getHTMLElement(),t=[].slice.call(e.querySelectorAll(".open-editor > a"));return v.getLargestChildWidth(e,t)}};u=G([l(1,j),l(2,Ve),l(3,ve),l(4,Z),l(5,he),l(6,Se),l(7,fe),l(8,Ae),l(9,Oe),l(10,Ie),l(11,Ke),l(12,Ne),l(13,De),l(14,Ee)],u);class Je extends de{editor;async run(i){if(this.editor)return super.run(i,{groupId:this.editor.groupId,editorIndex:this.editor.group.getIndexOfEditor(this.editor.editor)})}}class y{static ITEM_HEIGHT=22;getHeight(i){return y.ITEM_HEIGHT}getTemplateId(i){return i instanceof a?A.ID:L.ID}}class L{constructor(i,e){this.keybindingService=i;this.instantiationService=e}static ID="editorgroup";get templateId(){return L.ID}renderTemplate(i){const e=Object.create(null);e.root=v.append(i,T(".editor-group")),e.name=v.append(e.root,T("span.name")),e.actionBar=new V(i);const t=this.instantiationService.createInstance(F,F.ID,F.LABEL),o=this.keybindingService.lookupKeybinding(t.id);e.actionBar.push(t,{icon:!0,label:!1,keybinding:o?o.getLabel():void 0});const n=this.instantiationService.createInstance(B,B.ID,B.LABEL),r=this.keybindingService.lookupKeybinding(n.id);return e.actionBar.push(n,{icon:!0,label:!1,keybinding:r?r.getLabel():void 0}),e}renderElement(i,e,t){t.editorGroup=i,t.name.textContent=i.label,t.actionBar.context={groupId:i.id}}disposeTemplate(i){i.actionBar.dispose()}}class A{constructor(i,e,t,o){this.labels=i;this.instantiationService=e;this.keybindingService=t;this.configurationService=o}static ID="openeditor";closeEditorAction=this.instantiationService.createInstance(M,M.ID,M.LABEL);unpinEditorAction=this.instantiationService.createInstance(_,_.ID,_.LABEL);get templateId(){return A.ID}renderTemplate(i){const e=Object.create(null);return e.container=i,e.actionRunner=new Je,e.actionBar=new V(i,{actionRunner:e.actionRunner}),e.root=this.labels.create(i),e}renderElement(i,e,t){const o=i.editor;t.actionRunner.editor=i,t.container.classList.toggle("dirty",o.isDirty()&&!o.isSaving()),t.container.classList.toggle("sticky",i.isSticky()),t.root.setResource({resource:Y.getOriginalUri(o,{supportSideBySide:Be.BOTH}),name:o.getName(),description:o.getDescription(X.MEDIUM)},{italic:i.isPreview(),extraClasses:["open-editor"].concat(i.editor.getLabelExtraClasses()),fileDecorations:this.configurationService.getValue().explorer.decorations,title:o.getTitle(X.LONG),icon:o.getIcon()});const n=i.isSticky()?this.unpinEditorAction:this.closeEditorAction;t.actionBar.hasAction(n)||(t.actionBar.isEmpty()||t.actionBar.clear(),t.actionBar.push(n,{icon:!0,label:!1,keybinding:this.keybindingService.lookupKeybinding(n.id)?.getLabel()}))}disposeTemplate(i){i.actionBar.dispose(),i.root.dispose(),i.actionRunner.dispose()}}class J{constructor(i,e,t){this.instantiationService=e;this.editorGroupService=t;this._sortOrder=i}_sortOrder;set sortOrder(i){this._sortOrder=i}get dropHandler(){return this.instantiationService.createInstance(xe,{allowWorkspaceOpen:!1})}getDragURI(i){if(i instanceof a){const e=i.getResource();if(e)return e.toString()}return null}getDragLabel(i){if(i.length>1)return String(i.length);const e=i[0];return e instanceof a?e.editor.getName():e.label}onDragStart(i,e){const t=i.elements,o=[];if(t)for(const n of t)n instanceof a&&o.push(n);o.length&&this.instantiationService.invokeFunction(Ge,o,e)}onDragOver(i,e,t,o,n){if(i instanceof ne&&!ge(n,oe.FILES,me.FILES))return!1;if(this._sortOrder!=="editorOrder")return i instanceof N?!1:{accept:!0,effect:{type:P.Move},feedback:[-1]};let r;switch(o){case f.TOP:case f.CENTER_TOP:r=t===0&&e instanceof $?R.After:R.Before;break;case f.CENTER_BOTTOM:case f.BOTTOM:r=R.After;break}return{accept:!0,effect:{type:P.Move,position:r},feedback:[t]}}drop(i,e,t,o,n){let r=e instanceof a?e.group:e||this.editorGroupService.groups[this.editorGroupService.count-1],s=e instanceof a?e.group.getIndexOfEditor(e.editor):0;switch(o){case f.TOP:case f.CENTER_TOP:e instanceof $&&r.index!==0&&(r=this.editorGroupService.groups[r.index-1],s=r.count);break;case f.BOTTOM:case f.CENTER_BOTTOM:e instanceof a&&s++;break}if(i instanceof N){for(const d of i.elements){const p=d.group.getIndexOfEditor(d.editor);d.group===r&&p<s&&s--,d.group.moveEditor(d.editor,r,{index:s,preserveFocus:!0}),s++}this.editorGroupService.activateGroup(r)}else this.dropHandler.handleDrop(n,se,()=>r,()=>r.focus(),{index:s})}dispose(){}}G([ce],J.prototype,"dropHandler",1);class Qe{getWidgetAriaLabel(){return m.localize("openEditors","Open Editors")}getAriaLabel(i){return i instanceof a?`${i.editor.getName()}, ${i.editor.getDescription()}`:i.ariaLabel}}const et="workbench.action.toggleEditorGroupLayout";C(class extends O{constructor(){super({id:"workbench.action.toggleEditorGroupLayout",title:m.localize2("flipLayout","Toggle Vertical/Horizontal Editor Layout"),f1:!0,keybinding:{primary:D.Shift|D.Alt|z.Digit0,mac:{primary:D.CtrlCmd|D.Alt|z.Digit0},weight:ye.WorkbenchContrib},icon:b.editorLayout,menu:{id:g.ViewTitle,group:"navigation",when:S.and(S.equals("view",u.ID),Me),order:10}})}async run(c){const i=c.get(Z),e=i.orientation===k.VERTICAL?k.HORIZONTAL:k.VERTICAL;i.setGroupOrientation(e),i.activeGroup.focus()}}),pe.appendMenuItem(g.MenubarLayoutMenu,{group:"5_flip",command:{id:et,title:{...m.localize2("miToggleEditorLayoutWithoutMnemonic","Flip Layout"),mnemonicTitle:m.localize({key:"miToggleEditorLayout",comment:["&& denotes a mnemonic"]},"Flip &&Layout")}},order:1}),C(class extends O{constructor(){super({id:"workbench.action.files.saveAll",title:Ze,f1:!0,icon:b.saveAll,menu:{id:g.ViewTitle,group:"navigation",when:S.equals("view",u.ID),order:20}})}async run(c){await c.get(W).executeCommand(Xe)}}),C(class extends O{constructor(){super({id:"openEditors.closeAll",title:q.LABEL,f1:!1,icon:b.closeAll,menu:{id:g.ViewTitle,group:"navigation",when:S.equals("view",u.ID),order:30}})}async run(c){const i=c.get(j),e=new q;await i.invokeFunction(t=>e.run(t))}}),C(class extends O{constructor(){super({id:"openEditors.newUntitledFile",title:m.localize2("newUntitledFile","New Untitled Text File"),f1:!1,icon:b.newFile,menu:{id:g.ViewTitle,group:"navigation",when:S.equals("view",u.ID),order:5}})}async run(c){await c.get(W).executeCommand(We)}});export{u as OpenEditorsView};
