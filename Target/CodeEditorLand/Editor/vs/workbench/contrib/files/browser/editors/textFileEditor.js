var T=Object.defineProperty;var g=Object.getOwnPropertyDescriptor;var m=(c,d,e,r)=>{for(var i=r>1?void 0:r?g(d,e):d,t=c.length-1,n;t>=0;t--)(n=c[t])&&(i=(r?n(d,e,i):n(i))||i);return r&&i&&T(d,e,i),i},o=(c,d)=>(e,r)=>d(e,r,c);import{toAction as E}from"../../../../../base/common/actions.js";import{mark as f}from"../../../../../base/common/performance.js";import{assertIsDefined as C}from"../../../../../base/common/types.js";import{ScrollType as x}from"../../../../../editor/common/editorCommon.js";import{ITextResourceConfigurationService as w}from"../../../../../editor/common/services/textResourceConfiguration.js";import{localize as s}from"../../../../../nls.js";import{IConfigurationService as R}from"../../../../../platform/configuration/common/configuration.js";import{EditorActivation as D}from"../../../../../platform/editor/common/editor.js";import{ByteSize as _,FileOperation as A,FileOperationError as b,FileOperationResult as I,IFileService as L,TooLargeFileOperationError as V}from"../../../../../platform/files/common/files.js";import{IInstantiationService as B}from"../../../../../platform/instantiation/common/instantiation.js";import{IStorageService as P}from"../../../../../platform/storage/common/storage.js";import{ITelemetryService as k}from"../../../../../platform/telemetry/common/telemetry.js";import{IThemeService as M}from"../../../../../platform/theme/common/themeService.js";import{IUriIdentityService as N}from"../../../../../platform/uriIdentity/common/uriIdentity.js";import{IWorkspaceContextService as z}from"../../../../../platform/workspace/common/workspace.js";import{AbstractTextCodeEditor as W}from"../../../../browser/parts/editor/textCodeEditor.js";import{DEFAULT_EDITOR_ASSOCIATION as S,createEditorOpenError as h,createTooLargeFileError as G,isTextEditorViewState as U}from"../../../../common/editor.js";import{BinaryEditorModel as H}from"../../../../common/editor/binaryEditorModel.js";import{applyTextEditorOptions as j}from"../../../../common/editor/editorOptions.js";import{ViewContainerLocation as Y}from"../../../../common/views.js";import{IEditorGroupsService as X}from"../../../../services/editor/common/editorGroupsService.js";import{IEditorService as q}from"../../../../services/editor/common/editorService.js";import{IFilesConfigurationService as J}from"../../../../services/filesConfiguration/common/filesConfigurationService.js";import{IHostService as K}from"../../../../services/host/browser/host.js";import{IPaneCompositePartService as Q}from"../../../../services/panecomposite/browser/panecomposite.js";import{IPathService as Z}from"../../../../services/path/common/pathService.js";import{IPreferencesService as $}from"../../../../services/preferences/common/preferences.js";import{ITextFileService as ee,TextFileOperationResult as re}from"../../../../services/textfile/common/textfiles.js";import{BINARY_TEXT_FILE_MODE as ie,TEXT_FILE_EDITOR_ID as te,VIEWLET_ID as oe}from"../../common/files.js";import{IExplorerService as ne}from"../files.js";import{FileEditorInput as ae}from"./fileEditorInput.js";let l=class extends W{constructor(e,r,i,t,n,u,a,p,F,y,O,se,de,le,pe,ce,fe,Ie,ue){super(l.ID,e,r,n,a,p,y,F,O,i);this.paneCompositeService=t;this.contextService=u;this.textFileService=se;this.explorerService=de;this.uriIdentityService=le;this.pathService=pe;this.configurationService=ce;this.preferencesService=fe;this.hostService=Ie;this.filesConfigurationService=ue;this._register(this.fileService.onDidFilesChange(v=>this.onDidFilesChange(v))),this._register(this.fileService.onDidRunOperation(v=>this.onDidRunOperation(v)))}static ID=te;onDidFilesChange(e){for(const r of e.rawDeleted)this.clearEditorViewState(r)}onDidRunOperation(e){e.operation===A.MOVE&&e.target&&this.moveEditorViewState(e.resource,e.target.resource,this.uriIdentityService.extUri)}getTitle(){return this.input?this.input.getName():s("textFileEditor","Text File Editor")}get input(){return this._input}async setInput(e,r,i,t){f("code/willSetInputToTextFileEditor"),await super.setInput(e,r,i,t);try{const n=await e.resolve(r);if(t.isCancellationRequested)return;if(n instanceof H)return this.openAsBinary(e,r);const u=n,a=C(this.editorControl);if(a.setModel(u.textEditorModel),!U(r?.viewState)){const p=this.loadEditorViewState(e,i);p&&(r?.selection&&(p.cursorState=[]),a.restoreViewState(p))}r&&j(r,a,x.Immediate),a.updateOptions(this.getReadonlyConfiguration(u.isReadonly())),a.handleInitialized&&a.handleInitialized()}catch(n){await this.handleSetInputError(n,e,r)}f("code/didSetInputToTextFileEditor")}async handleSetInputError(e,r,i){if(e.textFileOperationResult===re.FILE_IS_BINARY)return this.openAsBinary(r,i);if(e.fileOperationResult===I.FILE_IS_DIRECTORY){const t=[];throw t.push(E({id:"workbench.files.action.openFolder",label:s("openFolder","Open Folder"),run:async()=>this.hostService.openWindow([{folderUri:r.resource}],{forceNewWindow:!0})})),this.contextService.isInsideWorkspace(r.preferredResource)&&t.push(E({id:"workbench.files.action.reveal",label:s("reveal","Reveal Folder"),run:async()=>(await this.paneCompositeService.openPaneComposite(oe,Y.Sidebar,!0),this.explorerService.select(r.preferredResource,!0))})),h(s("fileIsDirectory","The file is not displayed in the text editor because it is a directory."),t,{forceMessage:!0})}if(e.fileOperationResult===I.FILE_TOO_LARGE){let t;throw e instanceof V?t=s("fileTooLargeForHeapErrorWithSize","The file is not displayed in the text editor because it is very large ({0}).",_.formatSize(e.size)):t=s("fileTooLargeForHeapErrorWithoutSize","The file is not displayed in the text editor because it is very large."),G(this.group,r,i,t,this.preferencesService)}throw e.fileOperationResult===I.FILE_NOT_FOUND&&!this.filesConfigurationService.isReadonly(r.preferredResource)&&await this.pathService.hasValidBasename(r.preferredResource)?h(new b(s("unavailableResourceErrorEditorText","The editor could not be opened because the file was not found."),I.FILE_NOT_FOUND),[E({id:"workbench.files.action.createMissingFile",label:s("createFile","Create File"),run:async()=>(await this.textFileService.create([{resource:r.preferredResource}]),this.editorService.openEditor({resource:r.preferredResource,options:{pinned:!0}}))})],{allowDialog:!0}):e}openAsBinary(e,r){const i=this.configurationService.getValue("workbench.editor.defaultBinaryEditor"),t={...r,activation:D.PRESERVE};i&&i!==""&&i!==S.id?this.doOpenAsBinaryInDifferentEditor(this.group,i,e,t):this.doOpenAsBinaryInSameEditor(this.group,i,e,t)}doOpenAsBinaryInDifferentEditor(e,r,i,t){this.editorService.replaceEditors([{editor:i,replacement:{resource:i.resource,options:{...t,override:r}}}],e)}doOpenAsBinaryInSameEditor(e,r,i,t){r===S.id?(i.setForceOpenAsText(),i.setPreferredLanguageId(ie),t={...t,forceReload:!0}):i.setForceOpenAsBinary(),e.openEditor(i,t)}clearInput(){super.clearInput(),this.editorControl?.setModel(null)}createEditorControl(e,r){f("code/willCreateTextFileEditorControl"),super.createEditorControl(e,r),f("code/didCreateTextFileEditorControl")}tracksEditorViewState(e){return e instanceof ae}tracksDisposedEditorViewState(){return!0}};l=m([o(1,k),o(2,L),o(3,Q),o(4,B),o(5,z),o(6,P),o(7,w),o(8,q),o(9,M),o(10,X),o(11,ee),o(12,ne),o(13,N),o(14,Z),o(15,R),o(16,$),o(17,K),o(18,J)],l);export{l as TextFileEditor};
