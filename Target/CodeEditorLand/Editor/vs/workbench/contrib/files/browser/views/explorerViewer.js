var ve=Object.defineProperty;var ge=Object.getOwnPropertyDescriptor;var y=(f,e,r,i)=>{for(var n=i>1?void 0:i?ge(e,r):e,t=f.length-1,s;t>=0;t--)(s=f[t])&&(n=(i?s(e,r,n):s(n))||n);return i&&n&&ve(e,r,n),n},u=(f,e)=>(r,i)=>e(r,i,f);import"../../../../../base/browser/ui/list/listWidget.js";import*as E from"../../../../../base/browser/dom.js";import*as Ie from"../../../../../base/common/glob.js";import{ListDragOverEffectPosition as R,ListDragOverEffectType as L}from"../../../../../base/browser/ui/list/list.js";import{IProgressService as xe,ProgressLocation as Ee}from"../../../../../platform/progress/common/progress.js";import{INotificationService as be,Severity as H}from"../../../../../platform/notification/common/notification.js";import{IFileService as z,FileKind as C,FileOperationResult as De,FileChangeType as Q}from"../../../../../platform/files/common/files.js";import{IWorkbenchLayoutService as Se}from"../../../../services/layout/browser/layoutService.js";import{isTemporaryWorkspace as ye,IWorkspaceContextService as T,WorkbenchState as K}from"../../../../../platform/workspace/common/workspace.js";import{Disposable as Ce,dispose as Z,toDisposable as q,DisposableStore as $}from"../../../../../base/common/lifecycle.js";import{KeyCode as G}from"../../../../../base/common/keyCodes.js";import"../../../../browser/labels.js";import{TreeVisibility as ee,TreeDragOverBubble as O}from"../../../../../base/browser/ui/tree/tree.js";import{IContextMenuService as Te,IContextViewService as Fe}from"../../../../../platform/contextview/browser/contextView.js";import{IThemeService as we}from"../../../../../platform/theme/common/themeService.js";import{IConfigurationService as N}from"../../../../../platform/configuration/common/configuration.js";import{UndoConfirmLevel as Y}from"../../common/files.js";import{dirname as M,joinPath as B,distinctParents as Re}from"../../../../../base/common/resources.js";import{InputBox as Le,MessageType as k}from"../../../../../base/browser/ui/inputbox/inputBox.js";import{localize as v}from"../../../../../nls.js";import{createSingleCallFunction as Oe}from"../../../../../base/common/functional.js";import"../../../../../base/browser/keyboardEvent.js";import{equals as Ne,deepClone as Me}from"../../../../../base/common/objects.js";import*as ke from"../../../../../base/common/path.js";import{ExplorerItem as P,NewExplorerItem as Pe}from"../../common/explorerModel.js";import{compareFileExtensionsDefault as _e,compareFileNamesDefault as Ae,compareFileNamesUpper as We,compareFileExtensionsUpper as Ue,compareFileNamesLower as Ve,compareFileExtensionsLower as He,compareFileNamesUnicode as ze,compareFileExtensionsUnicode as Ke}from"../../../../../base/common/comparers.js";import{CodeDataTransfers as re,containsDragType as qe}from"../../../../../platform/dnd/browser/dnd.js";import{fillEditorsDragData as $e}from"../../../../browser/dnd.js";import{IInstantiationService as ie}from"../../../../../platform/instantiation/common/instantiation.js";import{DataTransfers as te}from"../../../../../base/browser/dnd.js";import{Schemas as Ge}from"../../../../../base/common/network.js";import{NativeDragAndDropData as oe,ExternalElementsDragAndDropData as Ye,ListViewTargetSector as D}from"../../../../../base/browser/ui/list/listView.js";import{isMacintosh as _,isWeb as Be}from"../../../../../base/common/platform.js";import{IDialogService as je,getFileNamesMessage as Je}from"../../../../../platform/dialogs/common/dialogs.js";import{IWorkspaceEditingService as Xe}from"../../../../services/workspaces/common/workspaceEditing.js";import"../../../../../base/common/uri.js";import{IEditorService as ne}from"../../../../services/editor/common/editorService.js";import"../../../../../platform/workspaces/common/workspaces.js";import{findValidPasteFileTarget as Qe}from"../fileActions.js";import{createMatches as Ze}from"../../../../../base/common/filters.js";import{Emitter as j,Event as er,EventMultiplexer as rr}from"../../../../../base/common/event.js";import"../../../../../base/browser/ui/tree/asyncDataTree.js";import"../../../../../base/browser/ui/tree/objectTree.js";import"../../../../../base/browser/ui/tree/compressedObjectTreeModel.js";import{ILabelService as ir}from"../../../../../platform/label/common/label.js";import{isNumber as se}from"../../../../../base/common/types.js";import"../../../../common/views.js";import"../../../../common/editor/editorInput.js";import{IUriIdentityService as ae}from"../../../../../platform/uriIdentity/common/uriIdentity.js";import{ResourceFileEdit as J}from"../../../../../editor/browser/services/bulkEditService.js";import{IExplorerService as F}from"../files.js";import{BrowserFileUpload as tr,ExternalFileImport as or,getMultipleFilesOverwriteConfirm as nr}from"../fileImportExport.js";import{toErrorMessage as sr}from"../../../../../base/common/errorMessage.js";import{WebFileSystemAccess as ar}from"../../../../../platform/files/browser/webFileSystemAccess.js";import{IgnoreFile as lr}from"../../../../services/search/common/ignoreFile.js";import{ResourceSet as cr}from"../../../../../base/common/map.js";import{TernarySearchTree as dr}from"../../../../../base/common/ternarySearchTree.js";import{defaultInputBoxStyles as pr}from"../../../../../platform/theme/browser/defaultStyles.js";import{timeout as ur}from"../../../../../base/common/async.js";import{IFilesConfigurationService as fr}from"../../../../services/filesConfiguration/common/filesConfigurationService.js";import{mainWindow as le}from"../../../../../base/browser/window.js";import{explorerFileContribRegistry as ce}from"../explorerFileContrib.js";class fe{static ITEM_HEIGHT=22;getHeight(e){return fe.ITEM_HEIGHT}getTemplateId(e){return S.ID}}const de=new j;let A=class{constructor(e,r,i,n,t,s,o,a,c){this.fileFilter=e;this.progressService=r;this.configService=i;this.notificationService=n;this.layoutService=t;this.fileService=s;this.explorerService=o;this.contextService=a;this.filesConfigService=c}getParent(e){if(this.contextService.getWorkspace().folders.length>1){if(e.isRoot)return e;if(e.parent)return e.parent}else if(e.parent)return e.parent.isRoot?e:e.parent;throw new Error("getParent only supported for cached parents")}hasChildren(e){return Array.isArray(e)||e.hasChildren(r=>this.fileFilter.filter(r,ee.Visible))}getChildren(e){if(Array.isArray(e))return e;const r=e.error,i=this.explorerService.sortOrderConfiguration.sortOrder,n=e.fetchChildren(i);if(Array.isArray(n))return n;const t=n.then(s=>(e instanceof P&&e.isRoot&&!e.error&&r&&this.contextService.getWorkbenchState()!==K.FOLDER&&de.fire(e.resource),s),s=>{if(e instanceof P&&e.isRoot)if(this.contextService.getWorkbenchState()===K.FOLDER){const o=new P(e.resource,this.fileService,this.configService,this.filesConfigService,void 0,void 0,!1);return o.error=s,[o]}else de.fire(e.resource);else this.notificationService.error(s);return[]});return this.progressService.withProgress({location:Ee.Explorer,delay:this.layoutService.isRestored()?800:1500},s=>t),t}};A=y([u(1,xe),u(2,N),u(3,be),u(4,Se),u(5,z),u(6,F),u(7,T),u(8,fr)],A);class pe{constructor(e,r,i,n,t){this.id=e;this.items=r;this.depth=n;this.collapsed=t;this._index=r.length-1,this.updateLabels(i),this._updateLabelDisposable=i.label.onDidRender(()=>this.updateLabels(i))}static ID=0;_index;_labels;_updateLabelDisposable;get index(){return this._index}get count(){return this.items.length}get current(){return this.items[this._index]}get currentId(){return`${this.id}_${this.index}`}get labels(){return this._labels}_onDidChange=new j;onDidChange=this._onDidChange.event;updateLabels(e){this._labels=Array.from(e.container.querySelectorAll(".label-name"));let r="";for(let i=0;i<this.labels.length;i++){const n=r.length?`${this.items[i].name}, compact, ${r}`:this.items[i].name;this.labels[i].setAttribute("aria-label",n),this.labels[i].setAttribute("aria-level",`${this.depth+i}`),r=r.length?`${this.items[i].name} ${r}`:this.items[i].name}this.updateCollapsed(this.collapsed),this._index<this.labels.length&&this.labels[this._index].classList.add("active")}previous(){this._index<=0||this.setIndex(this._index-1)}next(){this._index>=this.items.length-1||this.setIndex(this._index+1)}first(){this._index!==0&&this.setIndex(0)}last(){this._index!==this.items.length-1&&this.setIndex(this.items.length-1)}setIndex(e){e<0||e>=this.items.length||(this.labels[this._index].classList.remove("active"),this._index=e,this.labels[this._index].classList.add("active"),this._onDidChange.fire())}updateCollapsed(e){this.collapsed=e;for(let r=0;r<this.labels.length;r++)this.labels[r].setAttribute("aria-expanded",e?"false":"true")}dispose(){this._onDidChange.dispose(),this._updateLabelDisposable.dispose()}}let S=class{constructor(e,r,i,n,t,s,o,a,c,d,m){this.labels=r;this.updateWidth=i;this.contextViewService=n;this.themeService=t;this.configurationService=s;this.explorerService=o;this.labelService=a;this.contextService=c;this.contextMenuService=d;this.instantiationService=m;this.config=this.configurationService.getValue();const l=()=>{const p=this.configurationService.getValue("workbench.tree.indent"),x=Math.max(22-p,0);e.style.setProperty("--vscode-explorer-align-offset-margin-left",`${x}px`)};this.configListener=this.configurationService.onDidChangeConfiguration(p=>{p.affectsConfiguration("explorer")&&(this.config=this.configurationService.getValue()),p.affectsConfiguration("workbench.tree.indent")&&l()}),l()}static ID="file";config;configListener;compressedNavigationControllers=new Map;_onDidChangeActiveDescendant=new rr;onDidChangeActiveDescendant=this._onDidChangeActiveDescendant.event;getWidgetAriaLabel(){return v("treeAriaLabel","Files Explorer")}get templateId(){return S.ID}renderTemplate(e){const r=new $,i=r.add(this.labels.create(e,{supportHighlights:!0}));r.add(i.onDidRender(()=>{try{t.currentContext&&this.updateWidth(t.currentContext)}catch{}}));const n=ce.create(this.instantiationService,e,r);r.add(ce.onDidRegisterDescriptor(s=>{const o=s.create(this.instantiationService,e);n.push(r.add(o)),o.setResource(t.currentContext?.resource)}));const t={templateDisposables:r,elementDisposables:r.add(new $),label:i,container:e,contribs:n};return t}renderElement(e,r,i){const n=e.element;i.currentContext=n;const t=this.explorerService.getEditableData(n);i.label.element.classList.remove("compressed"),t?(i.label.element.style.display="none",i.contribs.forEach(s=>s.setResource(void 0)),i.elementDisposables.add(this.renderInputBox(i.container,n,t))):(i.label.element.style.display="flex",this.renderStat(n,n.name,void 0,e.filterData,i))}renderCompressedElements(e,r,i,n){const t=e.element.elements[e.element.elements.length-1];i.currentContext=t;const s=e.element.elements.filter(a=>this.explorerService.isEditable(a)),o=s.length===0?void 0:this.explorerService.getEditableData(s[0]);if(o)i.label.element.classList.remove("compressed"),i.label.element.style.display="none",i.contribs.forEach(a=>a.setResource(void 0)),i.elementDisposables.add(this.renderInputBox(i.container,s[0],o));else{i.label.element.classList.add("compressed"),i.label.element.style.display="flex";const a=`compressed-explorer_${pe.ID++}`,c=e.element.elements.map(l=>l.name);this.renderStat(t,c,a,e.filterData,i);const d=new pe(a,e.element.elements,i,e.depth,e.collapsed);i.elementDisposables.add(d);const m=this.compressedNavigationControllers.get(t)??[];this.compressedNavigationControllers.set(t,[...m,d]),i.elementDisposables.add(this._onDidChangeActiveDescendant.add(d.onDidChange)),i.elementDisposables.add(E.addDisposableListener(i.container,"mousedown",l=>{const p=V(l.target);p&&d.setIndex(p.index)})),i.elementDisposables.add(q(()=>{const l=this.compressedNavigationControllers.get(t)??[],p=l.findIndex(x=>x===d);if(p<0)throw new Error("Disposing unknown navigation controller");l.length===1?this.compressedNavigationControllers.delete(t):l.splice(p,1)}))}}renderStat(e,r,i,n,t){t.label.element.style.display="flex";const s=["explorer-item"];this.explorerService.isCut(e)&&s.push("cut");const o=this.themeService.getFileIconTheme();t.container.parentElement?.parentElement?.querySelector(".monaco-tl-twistie")?.classList.toggle("force-twistie",e.hasNests&&o.hidesExplorerArrows);const c=o.hasFileIcons&&(o.hidesExplorerArrows||!o.hasFolderIcons),d=e.nestedParent&&c;t.contribs.forEach(m=>m.setResource(e.resource)),t.label.setResource({resource:e.resource,name:r},{fileKind:e.isRoot?C.ROOT_FOLDER:e.isDirectory?C.FOLDER:C.FILE,extraClasses:d?[...s,"align-nest-icon-with-parent-icon"]:s,fileDecorations:this.config.explorer.decorations,matches:e.isDirectory?[]:Ze(n),separator:this.labelService.getSeparator(e.resource.scheme,e.resource.authority),domId:i})}renderInputBox(e,r,i){const n=this.labels.create(e),t=["explorer-item","explorer-item-edited"],s=r.isRoot?C.ROOT_FOLDER:r.isDirectory?C.FOLDER:C.FILE,o=this.themeService.getFileIconTheme(),a=o.hasFileIcons&&(o.hidesExplorerArrows||!o.hasFolderIcons),c=r.nestedParent&&a,d={hidePath:!0,hideLabel:!0,fileKind:s,extraClasses:c?[...t,"align-nest-icon-with-parent-icon"]:t},m=r.name?M(r.resource):r.resource,l=r.name||"";n.setFile(B(m,l||" "),d),n.element.firstElementChild.style.display="none";const p=new Le(n.element,this.contextViewService,{validationOptions:{validation:h=>{const b=i.validationMessage(h);return!b||b.severity!==H.Error?null:{content:b.content,formatContent:!0,type:k.ERROR}}},ariaLabel:v("fileInputAriaLabel","Type file name. Press Enter to confirm or Escape to cancel."),inputBoxStyles:pr}),x=l.lastIndexOf(".");let I="prefix";p.value=l,p.focus(),p.select({start:0,end:x>0&&!r.isDirectory?x:l.length});const w=Oe((h,b)=>{n.element.style.display="none";const he=p.value;Z(me),n.element.remove(),b&&i.onFinish(he,h)}),X=()=>{if(p.isInputValid()){const h=i.validationMessage(p.value);h?p.showMessage({content:h.content,formatContent:!0,type:h.severity===H.Info?k.INFO:h.severity===H.Warning?k.WARNING:k.ERROR}):p.hideMessage()}};X();const me=[p,p.onDidChange(h=>{n.setFile(B(m,h||" "),d)}),E.addStandardDisposableListener(p.inputElement,E.EventType.KEY_DOWN,h=>{if(h.equals(G.F2)){const b=p.value.lastIndexOf(".");if(r.isDirectory||b===-1)return;I==="prefix"?(I="all",p.select({start:0,end:p.value.length})):I==="all"?(I="suffix",p.select({start:b+1,end:p.value.length})):(I="prefix",p.select({start:0,end:b}))}else h.equals(G.Enter)?p.validate()||w(!0,!0):h.equals(G.Escape)&&w(!1,!0)}),E.addStandardDisposableListener(p.inputElement,E.EventType.KEY_UP,h=>{X()}),E.addDisposableListener(p.inputElement,E.EventType.BLUR,async()=>{for(;;){await ur(0);const h=p.inputElement.ownerDocument;if(!h.hasFocus())break;if(E.isActiveElement(p.inputElement))return;if(E.isHTMLElement(h.activeElement)&&E.hasParentWithClass(h.activeElement,"context-view"))await er.toPromise(this.contextMenuService.onDidHideContextMenu);else break}w(p.isInputValid(),!0)}),n];return q(()=>{w(!1,!1)})}disposeElement(e,r,i){i.currentContext=void 0,i.elementDisposables.clear()}disposeCompressedElements(e,r,i){i.currentContext=void 0,i.elementDisposables.clear()}disposeTemplate(e){e.templateDisposables.dispose()}getCompressedNavigationController(e){return this.compressedNavigationControllers.get(e)}getAriaLabel(e){return e.name}getAriaLevel(e){let r=0,i=e.parent;for(;i;)i=i.parent,r++;return this.contextService.getWorkbenchState()===K.WORKSPACE&&(r=r+1),r}getActiveDescendantId(e){return this.compressedNavigationControllers.get(e)?.[0]?.currentId??void 0}dispose(){this.configListener.dispose()}};S=y([u(3,Fe),u(4,we),u(5,N),u(6,F),u(7,ir),u(8,T),u(9,Te),u(10,ie)],S);let W=class{constructor(e,r,i,n,t,s){this.contextService=e;this.configurationService=r;this.explorerService=i;this.editorService=n;this.uriIdentityService=t;this.fileService=s;this.toDispose.push(this.contextService.onDidChangeWorkspaceFolders(()=>this.updateConfiguration())),this.toDispose.push(this.configurationService.onDidChangeConfiguration(o=>{(o.affectsConfiguration("files.exclude")||o.affectsConfiguration("explorer.excludeGitIgnore"))&&this.updateConfiguration()})),this.toDispose.push(this.fileService.onDidFilesChange(o=>{for(const[a,c]of this.ignoreFileResourcesPerRoot.entries())c.forEach(async d=>{o.contains(d,Q.UPDATED)&&await this.processIgnoreFile(a,d,!0),o.contains(d,Q.DELETED)&&(this.ignoreTreesPerRoot.get(a)?.delete(M(d)),c.delete(d),this._onDidChange.fire())})})),this.toDispose.push(this.editorService.onDidVisibleEditorsChange(()=>{const o=this.editorService.visibleEditors;let a=!1;for(const c of o){if(!c.resource)continue;const d=this.explorerService.findClosest(c.resource);if(d&&d.isExcluded){a=!0;break}}for(const c of this.editorsAffectingFilter)if(!o.includes(c)){a=!0;break}a&&(this.editorsAffectingFilter.clear(),this._onDidChange.fire())})),this.updateConfiguration()}hiddenExpressionPerRoot=new Map;editorsAffectingFilter=new Set;_onDidChange=new j;toDispose=[];ignoreFileResourcesPerRoot=new Map;ignoreTreesPerRoot=new Map;get onDidChange(){return this._onDidChange.event}updateConfiguration(){let e=!1,r=!1;this.contextService.getWorkspace().folders.forEach(i=>{const n=this.configurationService.getValue({resource:i.uri}),t=n?.files?.exclude||Object.create(null),s=n.explorer.excludeGitIgnore;if(s&&!this.ignoreTreesPerRoot.has(i.uri.toString())&&(r=!0,this.ignoreFileResourcesPerRoot.set(i.uri.toString(),new cr),this.ignoreTreesPerRoot.set(i.uri.toString(),dr.forUris(a=>this.uriIdentityService.extUri.ignorePathCasing(a)))),!s&&this.ignoreTreesPerRoot.has(i.uri.toString())&&(r=!0,this.ignoreFileResourcesPerRoot.delete(i.uri.toString()),this.ignoreTreesPerRoot.delete(i.uri.toString())),!e){const a=this.hiddenExpressionPerRoot.get(i.uri.toString());e=!a||!Ne(a.original,t)}const o=Me(t);this.hiddenExpressionPerRoot.set(i.uri.toString(),{original:o,parsed:Ie.parse(o)})}),(e||r)&&(this.editorsAffectingFilter.clear(),this._onDidChange.fire())}async processIgnoreFile(e,r,i){const n=M(r),t=this.ignoreTreesPerRoot.get(e);if(!t||!i&&t.has(n))return;const s=await this.fileService.readFile(r);if(i)t.get(n)?.updateContents(s.value.toString());else{const o=t.findSubstr(n),a=new lr(s.value.toString(),n.path,o);t.set(n,a),this.ignoreFileResourcesPerRoot.get(e)?.has(r)||this.ignoreFileResourcesPerRoot.get(e)?.add(r)}this._onDidChange.fire()}filter(e,r){return e.name===".gitignore"&&this.ignoreTreesPerRoot.has(e.root.resource.toString())?(this.processIgnoreFile(e.root.resource.toString(),e.resource,!1),!0):this.isVisible(e,r)}isVisible(e,r){if(e.isExcluded=!1,r===ee.Hidden)return e.isExcluded=!0,!1;if(this.explorerService.getEditableData(e))return!0;const n=this.hiddenExpressionPerRoot.get(e.root.resource.toString())?.parsed(ke.relative(e.root.resource.path,e.resource.path),e.name,a=>!!(e.parent&&e.parent.getChild(a))),s=(n?void 0:this.ignoreTreesPerRoot.get(e.root.resource.toString())?.findSubstr(e.resource))?.isPathIncludedInTraversal(e.resource.path,e.isDirectory);if((s===void 0?!1:!s)||n||e.parent?.isExcluded){e.isExcluded=!0;const c=this.editorService.visibleEditors.find(d=>d.resource&&this.uriIdentityService.extUri.isEqualOrParent(d.resource,e.resource));return c&&e.root===this.explorerService.findClosestRoot(e.resource)?(this.editorsAffectingFilter.add(c),!0):!1}return!0}dispose(){Z(this.toDispose)}};W=y([u(0,T),u(1,N),u(2,F),u(3,ne),u(4,ae),u(5,z)],W);let U=class{constructor(e,r){this.explorerService=e;this.contextService=r}compare(e,r){if(e.isRoot){if(r.isRoot){const a=this.contextService.getWorkspaceFolder(e.resource),c=this.contextService.getWorkspaceFolder(r.resource);return a&&c?a.index-c.index:-1}return-1}if(r.isRoot)return 1;const i=this.explorerService.sortOrderConfiguration.sortOrder,n=this.explorerService.sortOrderConfiguration.lexicographicOptions;this.explorerService.sortOrderConfiguration.reverse&&([e,r]=[r,e]);let s,o;switch(n){case"upper":s=We,o=Ue;break;case"lower":s=Ve,o=He;break;case"unicode":s=ze,o=Ke;break;default:s=Ae,o=_e}switch(i){case"type":if(e.isDirectory&&!r.isDirectory)return-1;if(r.isDirectory&&!e.isDirectory)return 1;if(e.isDirectory&&r.isDirectory)return s(e.name,r.name);break;case"filesFirst":if(e.isDirectory&&!r.isDirectory)return 1;if(r.isDirectory&&!e.isDirectory)return-1;break;case"foldersNestsFiles":if(e.isDirectory&&!r.isDirectory)return-1;if(r.isDirectory&&!e.isDirectory)return 1;if(e.hasNests&&!r.hasNests)return-1;if(r.hasNests&&!e.hasNests)return 1;break;case"mixed":break;default:if(e.isDirectory&&!r.isDirectory)return-1;if(r.isDirectory&&!e.isDirectory)return 1;break}switch(i){case"type":return o(e.name,r.name);case"modified":return e.mtime!==r.mtime?e.mtime&&r.mtime&&e.mtime<r.mtime?1:-1:s(e.name,r.name);default:return s(e.name,r.name)}}};U=y([u(0,F),u(1,T)],U);let g=class{constructor(e,r,i,n,t,s,o,a,c,d){this.isCollapsed=e;this.explorerService=r;this.editorService=i;this.dialogService=n;this.contextService=t;this.fileService=s;this.configurationService=o;this.instantiationService=a;this.workspaceEditingService=c;this.uriIdentityService=d;const m=l=>{(!l||l.affectsConfiguration("explorer.enableDragAndDrop"))&&(this.dropEnabled=this.configurationService.getValue("explorer.enableDragAndDrop"))};m(void 0),this.disposables.add(this.configurationService.onDidChangeConfiguration(l=>m(l)))}static CONFIRM_DND_SETTING_KEY="explorer.confirmDragAndDrop";compressedDragOverElement;compressedDropTargetDisposable=Ce.None;disposables=new $;dropEnabled=!1;onDragOver(e,r,i,n,t){if(!this.dropEnabled)return!1;if(r){const s=g.getCompressedStatFromDragEvent(r,t);if(s){const o=V(t.target);if(o&&o.index<o.count-1){const a=this.handleDragOver(e,s,i,n,t);return a?(o.element!==this.compressedDragOverElement&&(this.compressedDragOverElement=o.element,this.compressedDropTargetDisposable.dispose(),this.compressedDropTargetDisposable=q(()=>{o.element.classList.remove("drop-target"),this.compressedDragOverElement=void 0}),o.element.classList.add("drop-target")),typeof a=="boolean"?a:{...a,feedback:[]}):(this.compressedDropTargetDisposable.dispose(),!1)}}}return this.compressedDropTargetDisposable.dispose(),this.handleDragOver(e,r,i,n,t)}handleDragOver(e,r,i,n,t){const s=t&&(t.ctrlKey&&!_||t.altKey&&_),o=e instanceof oe,c={type:o||s?L.Copy:L.Move,position:R.Over};if(o){if(!qe(t,te.FILES,re.FILES,te.RESOURCES))return!1}else{if(e instanceof Ye)return!1;{const d=g.getStatsFromDragAndDropData(e),m=d.every(l=>l.isRoot);if(!r)return!s&&d.every(l=>!!l.parent&&l.parent.isRoot)?!1:m?{accept:!0,effect:{type:L.Move,position:R.After}}:{accept:!0,bubble:O.Down,effect:c,autoExpand:!1};if(!Array.isArray(d)||!s&&d.every(l=>l.isReadonly)||d.some(l=>l.isRoot?!1:!!(this.uriIdentityService.extUri.isEqual(l.resource,r.resource)||!s&&this.uriIdentityService.extUri.isEqual(M(l.resource),r.resource)||this.uriIdentityService.extUri.isEqualOrParent(r.resource,l.resource))))return!1;if(m){if(!r.isRoot)return!1;let l;switch(n){case D.TOP:case D.CENTER_TOP:l=R.Before;break;case D.CENTER_BOTTOM:case D.BOTTOM:l=R.After;break}return{accept:!0,effect:{type:L.Move,position:l}}}}}if(r){if(r.isDirectory)return r.isReadonly?!1:{accept:!0,bubble:O.Down,effect:c,autoExpand:!0};if(this.contextService.getWorkspace().folders.every(d=>d.uri.toString()!==r.resource.toString()))return{accept:!0,bubble:O.Up,effect:c}}else return{accept:!0,bubble:O.Down,effect:c};return!1}getDragURI(e){return this.explorerService.isEditable(e)?null:e.resource.toString()}getDragLabel(e,r){return e.length===1?g.getCompressedStatFromDragEvent(e[0],r).name:String(e.length)}onDragStart(e,r){const i=g.getStatsFromDragAndDropData(e,r);if(i&&i.length&&r.dataTransfer){this.instantiationService.invokeFunction(t=>$e(t,i,r));const n=i.filter(t=>t.resource.scheme===Ge.file).map(t=>t.resource.fsPath);n.length&&r.dataTransfer.setData(re.FILES,JSON.stringify(n))}}async drop(e,r,i,n,t){if(this.compressedDropTargetDisposable.dispose(),r){const o=g.getCompressedStatFromDragEvent(r,t);o&&(r=o)}if(r||(r=this.explorerService.roots[this.explorerService.roots.length-1],n=D.BOTTOM),!r.isDirectory&&r.parent&&(r=r.parent),r.isReadonly)return;const s=r;if(s)try{e instanceof oe?!Be||ye(this.contextService.getWorkspace())&&ar.supported(le)?await this.instantiationService.createInstance(or).import(s,t,le):await this.instantiationService.createInstance(tr).upload(r,t):await this.handleExplorerDrop(e,s,i,n,t)}catch(o){this.dialogService.error(sr(o))}}async handleExplorerDrop(e,r,i,n,t){const s=g.getStatsFromDragAndDropData(e),o=new Map(s.map(l=>[l,this.isCollapsed(l)]));for(const[l,p]of o)if(p){const x=l.nestedChildren;if(x)for(const I of x)o.set(I,!0)}const a=Re([...o.keys()],l=>l.resource),c=t.ctrlKey&&!_||t.altKey&&_;if(!c&&this.configurationService.getValue(g.CONFIRM_DND_SETTING_KEY)){const l=a.length>1&&a.every(I=>I.isRoot)?v("confirmRootsMove","Are you sure you want to change the order of multiple root folders in your workspace?"):a.length>1?v("confirmMultiMove","Are you sure you want to move the following {0} files into '{1}'?",a.length,r.name):a[0].isRoot?v("confirmRootMove","Are you sure you want to change the order of root folder '{0}' in your workspace?",a[0].name):v("confirmMove","Are you sure you want to move '{0}' into '{1}'?",a[0].name,r.name),p=a.length>1&&!a.every(I=>I.isRoot)?Je(a.map(I=>I.resource)):void 0,x=await this.dialogService.confirm({message:l,detail:p,checkbox:{label:v("doNotAskAgain","Do not ask me again")},primaryButton:v({key:"moveButtonLabel",comment:["&& denotes a mnemonic"]},"&&Move")});if(!x.confirmed)return;x.checkboxChecked===!0&&await this.configurationService.updateValue(g.CONFIRM_DND_SETTING_KEY,!1)}await this.doHandleRootDrop(a.filter(l=>l.isRoot),r,n);const m=a.filter(l=>!l.isRoot);return c?this.doHandleExplorerDropOnCopy(m,r):this.doHandleExplorerDropOnMove(m,r)}async doHandleRootDrop(e,r,i){if(e.length===0)return;const n=this.contextService.getWorkspace().folders;let t;const s=[],o=[],a=[];for(let c=0;c<n.length;c++){const d={uri:n[c].uri,name:n[c].name};r instanceof P&&this.uriIdentityService.extUri.isEqual(n[c].uri,r.resource)&&(t=c);for(const m of e)if(this.uriIdentityService.extUri.isEqual(n[c].uri,m.resource)){s.push(c);break}e.every(m=>m.resource.toString()!==n[c].uri.toString())?o.push(d):a.push(d)}if(t===void 0)t=o.length;else{switch(i){case D.BOTTOM:case D.CENTER_BOTTOM:t++;break}for(const c of s)c<t&&t--}return o.splice(t,0,...a),this.workspaceEditingService.updateFolders(0,o.length,o)}async doHandleExplorerDropOnCopy(e,r){const i=this.configurationService.getValue().explorer,n=[];for(const{resource:o,isDirectory:a}of e){const c=i.incrementalNaming==="disabled",d=await Qe(this.explorerService,this.fileService,this.dialogService,r,{resource:o,isDirectory:a,allowOverwrite:c},i.incrementalNaming);if(!d)continue;const m=new J(o,d,{copy:!0,overwrite:c});n.push(m)}const t=ue(e);await this.explorerService.applyBulkEdit(n,{confirmBeforeUndo:i.confirmUndo===Y.Default||i.confirmUndo===Y.Verbose,undoLabel:v("copy","Copy {0}",t),progressLabel:v("copying","Copying {0}",t)});const s=n.filter(o=>{const a=o.newResource?this.explorerService.findClosest(o.newResource):void 0;return a&&!a.isDirectory}).map(o=>({resource:o.newResource,options:{pinned:!0}}));await this.editorService.openEditors(s)}async doHandleExplorerDropOnMove(e,r){const i=e.filter(s=>!s.isReadonly).map(s=>new J(s.resource,B(r.resource,s.name))),n=ue(e),t={confirmBeforeUndo:this.configurationService.getValue().explorer.confirmUndo===Y.Verbose,undoLabel:v("move","Move {0}",n),progressLabel:v("moving","Moving {0}",n)};try{await this.explorerService.applyBulkEdit(i,t)}catch(s){if(s.fileOperationResult===De.FILE_MOVE_CONFLICT){const o=[];for(const d of i)d.newResource&&await this.fileService.exists(d.newResource)&&o.push(d.newResource);const a=nr(o),{confirmed:c}=await this.dialogService.confirm(a);c&&await this.explorerService.applyBulkEdit(i.map(d=>new J(d.oldResource,d.newResource,{overwrite:!0})),t)}else throw s}}static getStatsFromDragAndDropData(e,r){return e.context?e.context:r&&e.elements.length===1?(e.context=[g.getCompressedStatFromDragEvent(e.elements[0],r)],e.context):e.elements}static getCompressedStatFromDragEvent(e,r){const i=E.getWindow(r).document.elementFromPoint(r.clientX,r.clientY),n=V(i);if(n){const{count:t,index:s}=n;let o=t-1;for(;o>s&&e.parent;)e=e.parent,o--;return e}return e}onDragEnd(){this.compressedDropTargetDisposable.dispose()}dispose(){this.compressedDropTargetDisposable.dispose()}};g=y([u(1,F),u(2,ne),u(3,je),u(4,T),u(5,z),u(6,N),u(7,ie),u(8,Xe),u(9,ae)],g);function V(f){if(!E.isHTMLElement(f))return null;let e=f;for(;e&&!e.classList.contains("monaco-list-row");){if(e.classList.contains("label-name")&&e.hasAttribute("data-icon-label-count")){const r=Number(e.getAttribute("data-icon-label-count")),i=Number(e.getAttribute("data-icon-label-index"));if(se(r)&&se(i))return{element:e,count:r,index:i}}e=e.parentElement}return null}function Yi(f){return!!V(f)}class Bi{isIncompressible(e){return e.isRoot||!e.isDirectory||e instanceof Pe||!e.parent||e.parent.isRoot}}function ue(f){return f.length===1?f[0].name:f.every(e=>e.isDirectory)?v("numberOfFolders","{0} folders",f.length):f.every(e=>!e.isDirectory)?v("numberOfFiles","{0} files",f.length):`${f.length} files and folders`}export{pe as CompressedNavigationController,Bi as ExplorerCompressionDelegate,A as ExplorerDataSource,fe as ExplorerDelegate,g as FileDragAndDrop,U as FileSorter,W as FilesFilter,S as FilesRenderer,de as explorerRootErrorEmitter,Yi as isCompressedFolderName};
