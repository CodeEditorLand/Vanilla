var P=Object.defineProperty;var y=Object.getOwnPropertyDescriptor;var m=(n,t,e,r)=>{for(var o=r>1?void 0:r?y(t,e):t,s=n.length-1,i;s>=0;s--)(i=n[s])&&(o=(r?i(t,e,o):i(o))||o);return r&&o&&P(t,e,o),o},u=(n,t)=>(e,r)=>t(e,r,n);import"../../../../base/common/jsonSchema.js";import{Disposable as v}from"../../../../base/common/lifecycle.js";import{isFalsyOrWhitespace as g}from"../../../../base/common/strings.js";import{localize as a}from"../../../../nls.js";import{MenuId as f,MenuRegistry as I,registerAction2 as p}from"../../../../platform/actions/common/actions.js";import{CommandsRegistry as S}from"../../../../platform/commands/common/commands.js";import{ContextKeyExpr as b}from"../../../../platform/contextkey/common/contextkey.js";import"../../../../platform/extensions/common/extensions.js";import{SyncDescriptor as A}from"../../../../platform/instantiation/common/descriptors.js";import{Registry as D}from"../../../../platform/registry/common/platform.js";import{WorkbenchPhase as _,registerWorkbenchContribution2 as x}from"../../../common/contributions.js";import{SignOutOfAccountAction as R}from"./actions/signOutOfAccountAction.js";import{IAuthenticationService as M}from"../../../services/authentication/common/authentication.js";import{IBrowserWorkbenchEnvironmentService as E}from"../../../services/environment/browser/environmentService.js";import{Extensions as C}from"../../../services/extensionManagement/common/extensionFeatures.js";import{ExtensionsRegistry as k}from"../../../services/extensions/common/extensionsRegistry.js";import{ManageTrustedExtensionsForAccountAction as w}from"./actions/manageTrustedExtensionsForAccountAction.js";import{ManageAccountPreferencesForExtensionAction as F}from"./actions/manageAccountPreferencesForExtensionAction.js";import{IAuthenticationUsageService as T}from"../../../services/authentication/browser/authenticationUsageService.js";const W=S.registerCommand("workbench.getCodeExchangeProxyEndpoints",function(n,t){return n.get(E).options?.codeExchangeProxyEndpoints}),U={type:"object",additionalProperties:!1,properties:{id:{type:"string",description:a("authentication.id","The id of the authentication provider.")},label:{type:"string",description:a("authentication.label","The human readable name of the authentication provider.")}}},H=k.registerExtensionPoint({extensionPoint:"authentication",jsonSchema:{description:a({key:"authenticationExtensionPoint",comment:["'Contributes' means adds here"]},"Contributes authentication"),type:"array",items:U},activationEventsGenerator:(n,t)=>{for(const e of n)e.id&&t.push(`onAuthenticationRequest:${e.id}`)}});class O extends v{type="table";shouldRender(t){return!!t.contributes?.authentication}render(t){const e=t.contributes?.authentication||[];if(!e.length)return{data:{headers:[],rows:[]},dispose:()=>{}};const r=[a("authenticationlabel","Label"),a("authenticationid","ID")],o=e.sort((s,i)=>s.label.localeCompare(i.label)).map(s=>[s.label,s.id]);return{data:{headers:r,rows:o},dispose:()=>{}}}}const z=D.as(C.ExtensionFeaturesRegistry).registerExtensionFeature({id:"authentication",label:a("authentication","Authentication"),access:{canToggle:!1},renderer:new A(O)});let d=class extends v{constructor(e,r){super();this._authenticationService=e;this._environmentService=r;this._register(W),this._register(z),e.getProviderIds().length&&this._clearPlaceholderMenuItem(),this._registerHandlers(),this._registerAuthenticationExtentionPointHandler(),this._registerEnvContributedAuthenticationProviders(),this._registerActions()}static ID="workbench.contrib.authentication";_placeholderMenuItem=I.appendMenuItem(f.AccountsContext,{command:{id:"noAuthenticationProviders",title:a("authentication.Placeholder","No accounts requested yet..."),precondition:b.false()}});_registerAuthenticationExtentionPointHandler(){H.setHandler((e,{added:r,removed:o})=>{r.forEach(i=>{for(const c of i.value){if(g(c.id)){i.collector.error(a("authentication.missingId","An authentication contribution must specify an id."));continue}if(g(c.label)){i.collector.error(a("authentication.missingLabel","An authentication contribution must specify a label."));continue}this._authenticationService.declaredProviders.some(l=>l.id===c.id)?i.collector.error(a("authentication.idConflict","This authentication id '{0}' has already been registered",c.id)):this._authenticationService.registerDeclaredAuthenticationProvider(c)}}),o.flatMap(i=>i.value).forEach(i=>{const c=this._authenticationService.declaredProviders.find(l=>l.id===i.id);c&&this._authenticationService.unregisterDeclaredAuthenticationProvider(c.id)})})}_registerEnvContributedAuthenticationProviders(){if(this._environmentService.options?.authenticationProviders?.length)for(const e of this._environmentService.options.authenticationProviders)this._authenticationService.registerAuthenticationProvider(e.id,e)}_registerHandlers(){this._register(this._authenticationService.onDidRegisterAuthenticationProvider(e=>{this._clearPlaceholderMenuItem()})),this._register(this._authenticationService.onDidUnregisterAuthenticationProvider(e=>{this._authenticationService.getProviderIds().length||(this._placeholderMenuItem=I.appendMenuItem(f.AccountsContext,{command:{id:"noAuthenticationProviders",title:a("loading","Loading..."),precondition:b.false()}}))}))}_registerActions(){this._register(p(R)),this._register(p(w)),this._register(p(F))}_clearPlaceholderMenuItem(){this._placeholderMenuItem?.dispose(),this._placeholderMenuItem=void 0}};d=m([u(0,M),u(1,E)],d);let h=class{constructor(t){this._authenticationUsageService=t;this._initializeExtensionUsageCache()}static ID="workbench.contrib.authenticationUsage";async _initializeExtensionUsageCache(){await this._authenticationUsageService.initializeExtensionUsageCache()}};h=m([u(0,T)],h),x(d.ID,d,_.AfterRestored),x(h.ID,h,_.Eventually);
