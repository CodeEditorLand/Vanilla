var P=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var m=(l,e,t,r)=>{for(var i=r>1?void 0:r?L(e,t):e,n=l.length-1,s;n>=0;n--)(s=l[n])&&(i=(r?s(e,t,i):s(i))||i);return r&&i&&P(e,t,i),i},h=(l,e)=>(t,r)=>e(t,r,l);import{distinct as D}from"../../../../base/common/arrays.js";import{CancellationToken as C}from"../../../../base/common/cancellation.js";import{matchesContiguousSubString as _,matchesWords as F}from"../../../../base/common/filters.js";import{Disposable as N}from"../../../../base/common/lifecycle.js";import*as O from"../../../../base/common/strings.js";import{TfIdfCalculator as w}from"../../../../base/common/tfIdf.js";import{IConfigurationService as b}from"../../../../platform/configuration/common/configuration.js";import{IExtensionManagementService as x}from"../../../../platform/extensionManagement/common/extensionManagement.js";import{ExtensionType as z}from"../../../../platform/extensions/common/extensions.js";import{InstantiationType as $,registerSingleton as K}from"../../../../platform/instantiation/common/extensions.js";import{IInstantiationService as H}from"../../../../platform/instantiation/common/instantiation.js";import{IAiRelatedInformationService as A,RelatedInformationType as V}from"../../../services/aiRelatedInformation/common/aiRelatedInformation.js";import{IWorkbenchExtensionEnablementService as Z}from"../../../services/extensionManagement/common/extensionManagement.js";import{SettingMatchType as g}from"../../../services/preferences/common/preferences.js";import{nullRange as W}from"../../../services/preferences/common/preferencesModels.js";import{IPreferencesSearchService as G}from"../common/preferences.js";let S=class extends N{constructor(t,r,i,n){super();this.instantiationService=t;this.configurationService=r;this.extensionManagementService=i;this.extensionEnablementService=n;this._installedExtensions=this.extensionManagementService.getInstalled(z.User).then(s=>s.filter(o=>this.extensionEnablementService.isEnabled(o)).filter(o=>o.manifest&&o.manifest.contributes&&o.manifest.contributes.configuration).filter(o=>!!o.identifier.uuid))}_installedExtensions;_remoteSearchProvider;get remoteSearchAllowed(){return this.configurationService.getValue().workbench.settings.enableNaturalLanguageSearch}getRemoteSearchProvider(t){if(this.remoteSearchAllowed)return this._remoteSearchProvider??=this.instantiationService.createInstance(y),this._remoteSearchProvider.setFilter(t),this._remoteSearchProvider}getLocalSearchProvider(t){return this.instantiationService.createInstance(u,t)}};S=m([h(0,H),h(1,b),h(2,x),h(3,Z)],S);function k(l){return l.replace(/[":]/g," ").replace(/ {2}/g," ").trim()}let u=class{constructor(e,t){this._filter=e;this.configurationService=t;this._filter=k(this._filter)}static EXACT_MATCH_SCORE=1e4;static START_SCORE=1e3;searchModel(e,t){if(!this._filter)return Promise.resolve(null);let r=u.START_SCORE;const i=o=>{const{matches:I,matchType:M}=new v(this._filter,o,!0,!0,(E,a)=>e.findValueMatches(E,a),this.configurationService),T=this._filter===o.key?u.EXACT_MATCH_SCORE:r--;return I.length?{matches:I,matchType:M,score:T}:null},n=e.filterSettings(this._filter,this.getGroupFilter(this._filter),i),s=n.find(o=>o.score===u.EXACT_MATCH_SCORE);return s?Promise.resolve({filterMatches:[s],exactMatch:!0}):Promise.resolve({filterMatches:n})}getGroupFilter(e){const t=O.createRegExp(e,!1,{global:!0});return r=>r.id!=="defaultOverrides"&&t.test(r.title)}};u=m([h(1,b)],u);let v=class{constructor(e,t,r,i,n,s){this.searchDescription=i;this.configurationService=s;this.matches=D(this._findMatchesInSetting(e,t),o=>`${o.startLineNumber}_${o.startColumn}_${o.endLineNumber}_${o.endColumn}_`)}matches;matchType=g.None;_findMatchesInSetting(e,t){return this._doFindMatchesInSetting(e,t)}_keyToLabel(e){return e.replace(/[-._]/g," ").replace(/([a-z]+)([A-Z])/g,"$1 $2").replace(/([A-Za-z]+)(\d+)/g,"$1 $2").replace(/(\d+)([A-Za-z]+)/g,"$1 $2").toLowerCase()}_doFindMatchesInSetting(e,t){const r=new Map,i=new Map,n=new Map,s=new Set(e.split(" ")),o=this._keyToLabel(t.key);for(const a of s){const c=F(a,o,!0);c?.length&&i.set(a,c.map(d=>this.toKeyRange(t,d)))}i.size===s.size?this.matchType|=g.KeyMatch:i.clear();const I=_(e,t.key);if(I?.length&&(i.set(t.key,I.map(a=>this.toKeyRange(t,a))),this.matchType|=g.KeyMatch),t.overrides?.length&&this.matchType&g.KeyMatch)return this.matchType=g.LanguageTagSettingMatch,[...i.size?Array.from(i.values()).flat():[]];if(this.searchDescription){for(const a of s)for(let c=0;c<t.description.length;c++){const d=_(a,t.description[c]);d?.length&&r.set(a,d.map(p=>this.toDescriptionRange(t,p,c)))}r.size===s.size?this.matchType|=g.DescriptionOrValueMatch:r.clear()}if(t.enum?.length){for(const a of t.enum)if(typeof a=="string"){n.clear();for(const c of s){const d=_(c,a);d?.length&&n.set(c,d.map(p=>this.toValueRange(t,p)))}if(n.size===s.size){this.matchType|=g.DescriptionOrValueMatch;break}else n.clear()}}else{const a=this.configurationService.getValue(t.key);if(typeof a=="string"){for(const c of s){const d=_(c,a);d?.length&&n.set(c,d.map(p=>this.toValueRange(t,p)))}n.size===s.size?this.matchType|=g.DescriptionOrValueMatch:n.clear()}}const M=r.size?Array.from(r.values()).flat():[],T=i.size?Array.from(i.values()).flat():[],E=n.size?Array.from(n.values()).flat():[];return[...M,...T,...E]}toKeyRange(e,t){return{startLineNumber:e.keyRange.startLineNumber,startColumn:e.keyRange.startColumn+t.start,endLineNumber:e.keyRange.startLineNumber,endColumn:e.keyRange.startColumn+t.end}}toDescriptionRange(e,t,r){const i=e.descriptionRanges[r];return i?{startLineNumber:i.startLineNumber,startColumn:i.startColumn+t.start,endLineNumber:i.endLineNumber,endColumn:i.startColumn+t.end}:W}toValueRange(e,t){return{startLineNumber:e.valueRange.startLineNumber,startColumn:e.valueRange.startColumn+t.start+1,endLineNumber:e.valueRange.startLineNumber,endColumn:e.valueRange.startColumn+t.end+1}}};v=m([h(5,b)],v);class X{constructor(e){this.aiRelatedInformationService=e}settingKeys=[];settingsRecord={};currentPreferencesModel;updateModel(e){e!==this.currentPreferencesModel&&(this.currentPreferencesModel=e,this.refresh())}refresh(){if(this.settingKeys=[],this.settingsRecord={},!(!this.currentPreferencesModel||!this.aiRelatedInformationService.isEnabled())){for(const e of this.currentPreferencesModel.settingsGroups)if(e.id!=="mostCommonlyUsed")for(const t of e.sections)for(const r of t.settings)this.settingKeys.push(r.key),this.settingsRecord[r.key]=r}}getSettingKeys(){return this.settingKeys}getSettingsRecord(){return this.settingsRecord}}let f=class{constructor(e){this.aiRelatedInformationService=e;this._keysProvider=new X(e)}static AI_RELATED_INFORMATION_THRESHOLD=.73;static AI_RELATED_INFORMATION_MAX_PICKS=5;_keysProvider;_filter="";setFilter(e){this._filter=k(e)}async searchModel(e,t){return!this._filter||!this.aiRelatedInformationService.isEnabled()?null:(this._keysProvider.updateModel(e),{filterMatches:await this.getAiRelatedInformationItems(t)})}async getAiRelatedInformationItems(e){const t=this._keysProvider.getSettingsRecord(),r=[],i=await this.aiRelatedInformationService.getRelatedInformation(this._filter,[V.SettingInformation],e??C.None);i.sort((n,s)=>s.weight-n.weight);for(const n of i){if(n.weight<f.AI_RELATED_INFORMATION_THRESHOLD||r.length===f.AI_RELATED_INFORMATION_MAX_PICKS)break;const s=n.setting;r.push({setting:t[s],matches:[t[s].range],matchType:g.RemoteMatch,score:n.weight})}return r}};f=m([h(0,A)],f);class R{static TF_IDF_PRE_NORMALIZE_THRESHOLD=50;static TF_IDF_POST_NORMALIZE_THRESHOLD=.7;static TF_IDF_MAX_PICKS=5;_currentPreferencesModel;_filter="";_documents=[];_settingsRecord={};constructor(){}setFilter(e){this._filter=k(e)}keyToLabel(e){return e.replace(/[-._]/g," ").replace(/([a-z]+)([A-Z])/g,"$1 $2").replace(/([A-Za-z]+)(\d+)/g,"$1 $2").replace(/(\d+)([A-Za-z]+)/g,"$1 $2").toLowerCase()}settingItemToEmbeddingString(e){let t=`Setting Id: ${e.key}
`;return t+=`Label: ${this.keyToLabel(e.key)}
`,t+=`Description: ${e.description}
`,t}async searchModel(e,t){if(!this._filter)return null;if(this._currentPreferencesModel!==e){this._currentPreferencesModel=e,this._documents=[],this._settingsRecord={};for(const r of e.settingsGroups)if(r.id!=="mostCommonlyUsed")for(const i of r.sections)for(const n of i.settings)this._documents.push({key:n.key,textChunks:[this.settingItemToEmbeddingString(n)]}),this._settingsRecord[n.key]=n}return{filterMatches:await this.getTfIdfItems(t)}}async getTfIdfItems(e){const t=[],r=new w;r.updateDocuments(this._documents);const i=r.calculateScores(this._filter,e??C.None);i.sort((s,o)=>o.score-s.score);const n=i[0].score;if(n<R.TF_IDF_PRE_NORMALIZE_THRESHOLD)return[];for(const s of i){if(s.score/n<R.TF_IDF_POST_NORMALIZE_THRESHOLD||t.length===R.TF_IDF_MAX_PICKS)break;const o=s.key;t.push({setting:this._settingsRecord[o],matches:[this._settingsRecord[o].range],matchType:g.RemoteMatch,score:s.score})}return t}}let y=class{constructor(e){this.aiRelatedInformationService=e}adaSearchProvider;tfIdfSearchProvider;filter="";initializeSearchProviders(){this.aiRelatedInformationService.isEnabled()&&(this.adaSearchProvider??=new f(this.aiRelatedInformationService)),this.tfIdfSearchProvider??=new R}setFilter(e){this.initializeSearchProviders(),this.filter=e,this.adaSearchProvider&&this.adaSearchProvider.setFilter(e),this.tfIdfSearchProvider.setFilter(e)}searchModel(e,t){return this.filter?this.adaSearchProvider?this.adaSearchProvider.searchModel(e,t).then(r=>r?.filterMatches.length?r:this.tfIdfSearchProvider.searchModel(e,t)):this.tfIdfSearchProvider.searchModel(e,t):Promise.resolve(null)}};y=m([h(0,A)],y),K(G,S,$.Delayed);export{u as LocalSearchProvider,S as PreferencesSearchService,v as SettingMatches};
