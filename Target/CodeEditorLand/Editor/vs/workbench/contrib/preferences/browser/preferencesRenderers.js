var L=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var f=(h,g,e,t)=>{for(var i=t>1?void 0:t?H(g,e):g,r=h.length-1,n;r>=0;r--)(n=h[r])&&(i=(t?n(g,e,i):n(i))||i);return t&&i&&L(g,e,i),i},o=(h,g)=>(e,t)=>g(e,t,h);import{EventHelper as N,getDomNodePagePosition as _}from"../../../../base/browser/dom.js";import{SubmenuAction as G}from"../../../../base/common/actions.js";import{Delayer as P}from"../../../../base/common/async.js";import"../../../../base/common/cancellation.js";import"../../../../base/common/collections.js";import{Emitter as V,Event as z}from"../../../../base/common/event.js";import"../../../../base/common/jsonSchema.js";import{Disposable as I}from"../../../../base/common/lifecycle.js";import{ResourceMap as K}from"../../../../base/common/map.js";import{isEqual as D}from"../../../../base/common/resources.js";import{ThemeIcon as B}from"../../../../base/common/themables.js";import{MouseTargetType as J}from"../../../../editor/browser/editorBrowser.js";import{EditorOption as b}from"../../../../editor/common/config/editorOptions.js";import{Position as Y}from"../../../../editor/common/core/position.js";import{Range as q}from"../../../../editor/common/core/range.js";import"../../../../editor/common/core/selection.js";import"../../../../editor/common/cursorEvents.js";import*as Q from"../../../../editor/common/editorCommon.js";import"../../../../editor/common/languages.js";import{TrackedRangeStickiness as X}from"../../../../editor/common/model.js";import{ModelDecorationOptions as $}from"../../../../editor/common/model/textModel.js";import{ILanguageFeaturesService as Z}from"../../../../editor/common/services/languageFeatures.js";import{CodeActionKind as j}from"../../../../editor/contrib/codeAction/common/types.js";import*as a from"../../../../nls.js";import{ConfigurationTarget as v,IConfigurationService as A}from"../../../../platform/configuration/common/configuration.js";import{Extensions as R,ConfigurationScope as c,OVERRIDE_PROPERTY_REGEX as ee,overrideIdentifiersFromKey as te}from"../../../../platform/configuration/common/configurationRegistry.js";import{IContextMenuService as ie}from"../../../../platform/contextview/browser/contextView.js";import{IInstantiationService as k}from"../../../../platform/instantiation/common/instantiation.js";import{IMarkerService as W,MarkerSeverity as l,MarkerTag as u}from"../../../../platform/markers/common/markers.js";import{Registry as w}from"../../../../platform/registry/common/platform.js";import{IUriIdentityService as re}from"../../../../platform/uriIdentity/common/uriIdentity.js";import{IUserDataProfilesService as ne}from"../../../../platform/userDataProfile/common/userDataProfile.js";import{IWorkspaceContextService as oe,WorkbenchState as se}from"../../../../platform/workspace/common/workspace.js";import{IWorkspaceTrustManagementService as ae}from"../../../../platform/workspace/common/workspaceTrust.js";import{RangeHighlightDecorations as x}from"../../../browser/codeeditor.js";import{settingsEditIcon as de}from"./preferencesIcons.js";import{EditPreferenceWidget as F}from"./preferencesWidgets.js";import{APPLY_ALL_PROFILES_SETTING as ge,IWorkbenchConfigurationService as ce}from"../../../services/configuration/common/configuration.js";import{IWorkbenchEnvironmentService as le}from"../../../services/environment/common/environmentService.js";import{IPreferencesService as U}from"../../../services/preferences/common/preferences.js";import{DefaultSettingsEditorModel as ue,WorkspaceConfigurationEditorModel as he}from"../../../services/preferences/common/preferencesModels.js";import{IUserDataProfileService as pe}from"../../../services/userDataProfile/common/userDataProfile.js";let m=class extends I{constructor(e,t,i,r,n){super();this.editor=e;this.preferencesModel=t;this.preferencesService=i;this.configurationService=r;this.instantiationService=n;this.settingHighlighter=this._register(n.createInstance(y,e)),this.editSettingActionRenderer=this._register(this.instantiationService.createInstance(M,this.editor,this.preferencesModel,this.settingHighlighter)),this._register(this.editSettingActionRenderer.onUpdateSetting(({key:s,value:d,source:S})=>this.updatePreference(s,d,S))),this._register(this.editor.getModel().onDidChangeContent(()=>this.modelChangeDelayer.trigger(()=>this.onModelChanged()))),this.unsupportedSettingsRenderer=this._register(n.createInstance(C,e,t))}settingHighlighter;editSettingActionRenderer;modelChangeDelayer=new P(200);associatedPreferencesModel;unsupportedSettingsRenderer;render(){this.editSettingActionRenderer.render(this.preferencesModel.settingsGroups,this.associatedPreferencesModel),this.unsupportedSettingsRenderer.render()}updatePreference(e,t,i){const r=i.overrideOf?te(i.overrideOf.key):null,n=this.preferencesModel.uri;this.configurationService.updateValue(e,t,{overrideIdentifiers:r,resource:n},this.preferencesModel.configurationTarget).then(()=>this.onSettingUpdated(i))}onModelChanged(){this.editor.hasModel()&&this.render()}onSettingUpdated(e){this.editor.focus(),e=this.getSetting(e),e&&(this.editor.setSelection(e.valueRange),this.settingHighlighter.highlight(e,!0))}getSetting(e){const{key:t,overrideOf:i}=e;if(i){const r=this.getSetting(i);for(const n of r.overrides)if(n.key===t)return n;return}return this.preferencesModel.getPreference(t)}focusPreference(e){const t=this.getSetting(e);t?(this.settingHighlighter.highlight(t,!0),this.editor.setPosition({lineNumber:t.keyRange.startLineNumber,column:t.keyRange.startColumn})):this.settingHighlighter.clear(!0)}clearFocus(e){this.settingHighlighter.clear(!0)}editPreference(e){const t=this.getSetting(e);return!!(t&&this.editSettingActionRenderer.activateOnSetting(t))}};m=f([o(2,U),o(3,A),o(4,k)],m);let E=class extends m{workspaceConfigurationRenderer;constructor(g,e,t,i,r){super(g,e,t,i,r),this.workspaceConfigurationRenderer=this._register(r.createInstance(p,g,e))}render(){super.render(),this.workspaceConfigurationRenderer.render()}};E=f([o(2,U),o(3,A),o(4,k)],E);let M=class extends I{constructor(e,t,i,r,n,s){super();this.editor=e;this.primarySettingsModel=t;this.settingHighlighter=i;this.configurationService=r;this.instantiationService=n;this.contextMenuService=s;this.editPreferenceWidgetForCursorPosition=this._register(this.instantiationService.createInstance(F,e)),this.editPreferenceWidgetForMouseMove=this._register(this.instantiationService.createInstance(F,e)),this.toggleEditPreferencesForMouseMoveDelayer=new P(75),this._register(this.editPreferenceWidgetForCursorPosition.onClick(d=>this.onEditSettingClicked(this.editPreferenceWidgetForCursorPosition,d))),this._register(this.editPreferenceWidgetForMouseMove.onClick(d=>this.onEditSettingClicked(this.editPreferenceWidgetForMouseMove,d))),this._register(this.editor.onDidChangeCursorPosition(d=>this.onPositionChanged(d))),this._register(this.editor.onMouseMove(d=>this.onMouseMoved(d))),this._register(this.editor.onDidChangeConfiguration(()=>this.onConfigurationChanged()))}editPreferenceWidgetForCursorPosition;editPreferenceWidgetForMouseMove;settingsGroups=[];associatedPreferencesModel;toggleEditPreferencesForMouseMoveDelayer;_onUpdateSetting=new V;onUpdateSetting=this._onUpdateSetting.event;render(e,t){this.editPreferenceWidgetForCursorPosition.hide(),this.editPreferenceWidgetForMouseMove.hide(),this.settingsGroups=e,this.associatedPreferencesModel=t;const i=this.getSettings(this.editor.getPosition().lineNumber);i.length&&this.showEditPreferencesWidget(this.editPreferenceWidgetForCursorPosition,i)}isDefaultSettings(){return this.primarySettingsModel instanceof ue}onConfigurationChanged(){this.editor.getOption(b.glyphMargin)||(this.editPreferenceWidgetForCursorPosition.hide(),this.editPreferenceWidgetForMouseMove.hide())}onPositionChanged(e){this.editPreferenceWidgetForMouseMove.hide();const t=this.getSettings(e.position.lineNumber);t.length?this.showEditPreferencesWidget(this.editPreferenceWidgetForCursorPosition,t):this.editPreferenceWidgetForCursorPosition.hide()}onMouseMoved(e){const t=this.getEditPreferenceWidgetUnderMouse(e);if(t){this.onMouseOver(t);return}this.settingHighlighter.clear(),this.toggleEditPreferencesForMouseMoveDelayer.trigger(()=>this.toggleEditPreferenceWidgetForMouseMove(e))}getEditPreferenceWidgetUnderMouse(e){if(e.target.type===J.GUTTER_GLYPH_MARGIN){const t=e.target.position.lineNumber;if(this.editPreferenceWidgetForMouseMove.getLine()===t&&this.editPreferenceWidgetForMouseMove.isVisible())return this.editPreferenceWidgetForMouseMove;if(this.editPreferenceWidgetForCursorPosition.getLine()===t&&this.editPreferenceWidgetForCursorPosition.isVisible())return this.editPreferenceWidgetForCursorPosition}}toggleEditPreferenceWidgetForMouseMove(e){const t=e.target.position?this.getSettings(e.target.position.lineNumber):null;t&&t.length?this.showEditPreferencesWidget(this.editPreferenceWidgetForMouseMove,t):this.editPreferenceWidgetForMouseMove.hide()}showEditPreferencesWidget(e,t){const i=t[0].valueRange.startLineNumber;this.editor.getOption(b.glyphMargin)&&this.marginFreeFromOtherDecorations(i)&&(e.show(i,a.localize("editTtile","Edit"),t),(e===this.editPreferenceWidgetForCursorPosition?this.editPreferenceWidgetForMouseMove:this.editPreferenceWidgetForCursorPosition).hide())}marginFreeFromOtherDecorations(e){const t=this.editor.getLineDecorations(e);if(t){for(const{options:i}of t)if(i.glyphMarginClassName&&i.glyphMarginClassName.indexOf(B.asClassName(de))===-1)return!1}return!0}getSettings(e){const t=this.getConfigurationsMap();return this.getSettingsAtLineNumber(e).filter(i=>{const r=t[i.key];if(r){if(r.policy&&this.configurationService.inspect(i.key).policyValue!==void 0)return!1;if(this.isDefaultSettings())return i.key!=="launch";if((r.type==="boolean"||r.enum)&&(this.primarySettingsModel.configurationTarget!==v.WORKSPACE_FOLDER||r.scope===c.RESOURCE||r.scope===c.LANGUAGE_OVERRIDABLE))return!0}return!1})}getSettingsAtLineNumber(e){let t=0;const i=[];for(const r of this.settingsGroups){if(r.range.startLineNumber>e)break;if(e>=r.range.startLineNumber&&e<=r.range.endLineNumber)for(const n of r.sections)for(const s of n.settings){if(s.range.startLineNumber>e)break;if(e>=s.range.startLineNumber&&e<=s.range.endLineNumber)if(!this.isDefaultSettings()&&s.overrides.length)for(const d of s.overrides)e>=d.range.startLineNumber&&e<=d.range.endLineNumber&&i.push({...d,index:t,groupId:r.id});else i.push({...s,index:t,groupId:r.id});t++}}return i}onMouseOver(e){this.settingHighlighter.highlight(e.preferences[0])}onEditSettingClicked(e,t){N.stop(t.event,!0);const i=this.getSettings(e.getLine()).length===1?this.getActions(e.preferences[0],this.getConfigurationsMap()[e.preferences[0].key]):e.preferences.map(r=>new G(`preferences.submenu.${r.key}`,r.key,this.getActions(r,this.getConfigurationsMap()[r.key])));this.contextMenuService.showContextMenu({getAnchor:()=>t.event,getActions:()=>i})}activateOnSetting(e){const t=e.keyRange.startLineNumber,i=this.getSettings(t);if(!i.length)return!1;this.editPreferenceWidgetForMouseMove.show(t,"",i);const r=this.getActions(this.editPreferenceWidgetForMouseMove.preferences[0],this.getConfigurationsMap()[this.editPreferenceWidgetForMouseMove.preferences[0].key]);return this.contextMenuService.showContextMenu({getAnchor:()=>this.toAbsoluteCoords(new Y(t,1)),getActions:()=>r}),!0}toAbsoluteCoords(e){const t=this.editor.getScrolledVisiblePosition(e),i=_(this.editor.getDomNode()),r=i.left+t.left,n=i.top+t.top+t.height;return{x:r,y:n+10}}getConfigurationsMap(){return w.as(R.Configuration).getConfigurationProperties()}getActions(e,t){return t.type==="boolean"?[{id:"truthyValue",label:"true",tooltip:"true",enabled:!0,run:()=>this.updateSetting(e.key,!0,e),class:void 0},{id:"falsyValue",label:"false",tooltip:"false",enabled:!0,run:()=>this.updateSetting(e.key,!1,e),class:void 0}]:t.enum?t.enum.map(i=>({id:i,label:JSON.stringify(i),tooltip:JSON.stringify(i),enabled:!0,run:()=>this.updateSetting(e.key,i,e),class:void 0})):this.getDefaultActions(e)}getDefaultActions(e){if(this.isDefaultSettings()){const t=this.associatedPreferencesModel.getPreference(e.key);return[{id:"setDefaultValue",label:t?a.localize("replaceDefaultValue","Replace in Settings"):a.localize("copyDefaultValue","Copy to Settings"),tooltip:t?a.localize("replaceDefaultValue","Replace in Settings"):a.localize("copyDefaultValue","Copy to Settings"),enabled:!0,run:()=>this.updateSetting(e.key,e.value,e),class:void 0}]}return[]}updateSetting(e,t,i){this._onUpdateSetting.fire({key:e,value:t,source:i})}};M=f([o(3,A),o(4,k),o(5,ie)],M);let y=class extends I{constructor(e,t){super();this.editor=e;this.fixedHighlighter=this._register(t.createInstance(x)),this.volatileHighlighter=this._register(t.createInstance(x))}fixedHighlighter;volatileHighlighter;highlight(e,t=!1){this.volatileHighlighter.removeHighlightRange(),this.fixedHighlighter.removeHighlightRange(),(t?this.fixedHighlighter:this.volatileHighlighter).highlightRange({range:e.valueRange,resource:this.editor.getModel().uri},this.editor),this.editor.revealLineInCenterIfOutsideViewport(e.valueRange.startLineNumber,Q.ScrollType.Smooth)}clear(e=!1){this.volatileHighlighter.removeHighlightRange(),e&&this.fixedHighlighter.removeHighlightRange()}};y=f([o(1,k)],y);let C=class extends I{constructor(e,t,i,r,n,s,d,S,T,fe){super();this.editor=e;this.settingsEditorModel=t;this.markerService=i;this.environmentService=r;this.configurationService=n;this.workspaceTrustManagementService=s;this.uriIdentityService=d;this.userDataProfileService=T;this.userDataProfilesService=fe;this._register(this.editor.getModel().onDidChangeContent(()=>this.delayedRender())),this._register(z.filter(this.configurationService.onDidChangeConfiguration,O=>O.source===v.DEFAULT)(()=>this.delayedRender())),this._register(S.codeActionProvider.register({pattern:t.uri.path},this)),this._register(T.onDidChangeCurrentProfile(()=>this.delayedRender()))}renderingDelayer=new P(200);codeActions=new K(e=>this.uriIdentityService.extUri.getComparisonKey(e));delayedRender(){this.renderingDelayer.trigger(()=>this.render())}render(){this.codeActions.clear();const e=this.generateMarkerData();e.length?this.markerService.changeOne("UnsupportedSettingsRenderer",this.settingsEditorModel.uri,e):this.markerService.remove("UnsupportedSettingsRenderer",[this.settingsEditorModel.uri])}async provideCodeActions(e,t,i,r){const n=[],s=this.codeActions.get(e.uri);if(s)for(const[d,S]of s)d.containsRange(t)&&n.push(...S);return{actions:n,dispose:()=>{}}}generateMarkerData(){const e=[],t=w.as(R.Configuration).getConfigurationProperties();for(const i of this.settingsEditorModel.settingsGroups)for(const r of i.sections)for(const n of r.settings){if(ee.test(n.key)){n.overrides&&this.handleOverrides(n.overrides,t,e);continue}const s=t[n.key];if(s){if(this.handlePolicyConfiguration(n,s,e))continue;switch(this.settingsEditorModel.configurationTarget){case v.USER_LOCAL:this.handleLocalUserConfiguration(n,s,e);break;case v.USER_REMOTE:this.handleRemoteUserConfiguration(n,s,e);break;case v.WORKSPACE:this.handleWorkspaceConfiguration(n,s,e);break;case v.WORKSPACE_FOLDER:this.handleWorkspaceFolderConfiguration(n,s,e);break}}else e.push(this.gemerateUnknownConfigurationMarker(n))}return e}handlePolicyConfiguration(e,t,i){return!t.policy||this.configurationService.inspect(e.key).policyValue===void 0||this.settingsEditorModel.configurationTarget===v.DEFAULT?!1:(i.push({severity:l.Hint,tags:[u.Unnecessary],...e.range,message:a.localize("unsupportedPolicySetting","This setting cannot be applied because it is configured in the system policy.")}),!0)}handleOverrides(e,t,i){for(const r of e||[]){const n=t[r.key];n?n.scope!==c.LANGUAGE_OVERRIDABLE&&i.push({severity:l.Hint,tags:[u.Unnecessary],...r.range,message:a.localize("unsupportLanguageOverrideSetting","This setting cannot be applied because it is not registered as language override setting.")}):i.push(this.gemerateUnknownConfigurationMarker(r))}}handleLocalUserConfiguration(e,t,i){!this.userDataProfileService.currentProfile.isDefault&&!this.userDataProfileService.currentProfile.useDefaultFlags?.settings&&(D(this.userDataProfilesService.defaultProfile.settingsResource,this.settingsEditorModel.uri)&&!this.configurationService.isSettingAppliedForAllProfiles(e.key)?i.push({severity:l.Hint,tags:[u.Unnecessary],...e.range,message:a.localize("defaultProfileSettingWhileNonDefaultActive","This setting cannot be applied while a non-default profile is active. It will be applied when the default profile is active.")}):D(this.userDataProfileService.currentProfile.settingsResource,this.settingsEditorModel.uri)&&(t.scope===c.APPLICATION?i.push(this.generateUnsupportedApplicationSettingMarker(e)):this.configurationService.isSettingAppliedForAllProfiles(e.key)&&i.push({severity:l.Hint,tags:[u.Unnecessary],...e.range,message:a.localize("allProfileSettingWhileInNonDefaultProfileSetting","This setting cannot be applied because it is configured to be applied in all profiles using setting {0}. Value from the default profile will be used instead.",ge)}))),this.environmentService.remoteAuthority&&(t.scope===c.MACHINE||t.scope===c.MACHINE_OVERRIDABLE)&&i.push({severity:l.Hint,tags:[u.Unnecessary],...e.range,message:a.localize("unsupportedRemoteMachineSetting","This setting cannot be applied in this window. It will be applied when you open a local window.")})}handleRemoteUserConfiguration(e,t,i){t.scope===c.APPLICATION&&i.push(this.generateUnsupportedApplicationSettingMarker(e))}handleWorkspaceConfiguration(e,t,i){if(t.scope===c.APPLICATION&&i.push(this.generateUnsupportedApplicationSettingMarker(e)),t.scope===c.MACHINE&&i.push(this.generateUnsupportedMachineSettingMarker(e)),!this.workspaceTrustManagementService.isWorkspaceTrusted()&&t.restricted){const r=this.generateUntrustedSettingMarker(e);i.push(r);const n=this.generateUntrustedSettingCodeActions([r]);this.addCodeActions(r,n)}}handleWorkspaceFolderConfiguration(e,t,i){if(t.scope===c.APPLICATION&&i.push(this.generateUnsupportedApplicationSettingMarker(e)),t.scope===c.MACHINE&&i.push(this.generateUnsupportedMachineSettingMarker(e)),t.scope===c.WINDOW&&i.push({severity:l.Hint,tags:[u.Unnecessary],...e.range,message:a.localize("unsupportedWindowSetting","This setting cannot be applied in this workspace. It will be applied when you open the containing workspace folder directly.")}),!this.workspaceTrustManagementService.isWorkspaceTrusted()&&t.restricted){const r=this.generateUntrustedSettingMarker(e);i.push(r);const n=this.generateUntrustedSettingCodeActions([r]);this.addCodeActions(r,n)}}generateUnsupportedApplicationSettingMarker(e){return{severity:l.Hint,tags:[u.Unnecessary],...e.range,message:a.localize("unsupportedApplicationSetting","This setting has an application scope and can be set only in the user settings file.")}}generateUnsupportedMachineSettingMarker(e){return{severity:l.Hint,tags:[u.Unnecessary],...e.range,message:a.localize("unsupportedMachineSetting","This setting can only be applied in user settings in local window or in remote settings in remote window.")}}generateUntrustedSettingMarker(e){return{severity:l.Warning,...e.range,message:a.localize("untrustedSetting","This setting can only be applied in a trusted workspace.")}}gemerateUnknownConfigurationMarker(e){return{severity:l.Hint,tags:[u.Unnecessary],...e.range,message:a.localize("unknown configuration setting","Unknown Configuration Setting")}}generateUntrustedSettingCodeActions(e){return[{title:a.localize("manage workspace trust","Manage Workspace Trust"),command:{id:"workbench.trust.manage",title:a.localize("manage workspace trust","Manage Workspace Trust")},diagnostics:e,kind:j.QuickFix.value}]}addCodeActions(e,t){let i=this.codeActions.get(this.settingsEditorModel.uri);i||(i=[],this.codeActions.set(this.settingsEditorModel.uri,i)),i.push([q.lift(e),t])}dispose(){this.markerService.remove("UnsupportedSettingsRenderer",[this.settingsEditorModel.uri]),this.codeActions.clear(),super.dispose()}};C=f([o(2,W),o(3,le),o(4,ce),o(5,ae),o(6,re),o(7,Z),o(8,pe),o(9,ne)],C);let p=class extends I{constructor(e,t,i,r){super();this.editor=e;this.workspaceSettingsEditorModel=t;this.workspaceContextService=i;this.markerService=r;this._register(this.editor.getModel().onDidChangeContent(()=>this.renderingDelayer.trigger(()=>this.render())))}static supportedKeys=["folders","tasks","launch","extensions","settings","remoteAuthority","transient"];decorations=this.editor.createDecorationsCollection();renderingDelayer=new P(200);render(){const e=[];if(this.workspaceContextService.getWorkbenchState()===se.WORKSPACE&&this.workspaceSettingsEditorModel instanceof he){const t=[];for(const i of this.workspaceSettingsEditorModel.configurationGroups)for(const r of i.sections)for(const n of r.settings)p.supportedKeys.includes(n.key)||e.push({severity:l.Hint,tags:[u.Unnecessary],...n.range,message:a.localize("unsupportedProperty","Unsupported Property")});this.decorations.set(t.map(i=>this.createDecoration(i)))}e.length?this.markerService.changeOne("WorkspaceConfigurationRenderer",this.workspaceSettingsEditorModel.uri,e):this.markerService.remove("WorkspaceConfigurationRenderer",[this.workspaceSettingsEditorModel.uri])}static _DIM_CONFIGURATION_=$.register({description:"dim-configuration",stickiness:X.NeverGrowsWhenTypingAtEdges,inlineClassName:"dim-configuration"});createDecoration(e){return{range:e,options:p._DIM_CONFIGURATION_}}dispose(){this.markerService.remove("WorkspaceConfigurationRenderer",[this.workspaceSettingsEditorModel.uri]),this.decorations.clear(),super.dispose()}};p=f([o(2,oe),o(3,W)],p);export{m as UserSettingsRenderer,E as WorkspaceSettingsRenderer};
