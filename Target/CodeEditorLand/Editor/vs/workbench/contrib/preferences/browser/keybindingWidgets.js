var E=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var g=(p,t,e,i)=>{for(var s=i>1?void 0:i?w(t,e):t,n=p.length-1,d;n>=0;n--)(d=p[n])&&(s=(i?d(t,e,s):d(s))||s);return i&&s&&E(t,e,s),s},h=(p,t)=>(e,i)=>t(e,i,p);import"./media/keybindings.css";import*as o from"../../../../base/browser/dom.js";import{createFastDomNode as K}from"../../../../base/browser/fastDomNode.js";import{StandardKeyboardEvent as x}from"../../../../base/browser/keyboardEvent.js";import*as S from"../../../../base/browser/ui/aria/aria.js";import{KeybindingLabel as v}from"../../../../base/browser/ui/keybindingLabel/keybindingLabel.js";import{Widget as D}from"../../../../base/browser/ui/widget.js";import{Promises as L,timeout as C}from"../../../../base/common/async.js";import{Emitter as a}from"../../../../base/common/event.js";import{KeyCode as y}from"../../../../base/common/keyCodes.js";import{Disposable as T,DisposableStore as b,toDisposable as k}from"../../../../base/common/lifecycle.js";import{OS as N}from"../../../../base/common/platform.js";import{ScrollType as H}from"../../../../editor/common/editorCommon.js";import*as u from"../../../../nls.js";import{IContextKeyService as V}from"../../../../platform/contextkey/common/contextkey.js";import{IContextViewService as B}from"../../../../platform/contextview/browser/contextView.js";import{IInstantiationService as _}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as W}from"../../../../platform/keybinding/common/keybinding.js";import{defaultInputBoxStyles as R,defaultKeybindingLabelStyles as f}from"../../../../platform/theme/browser/defaultStyles.js";import{asCssVariable as m,editorWidgetBackground as $,editorWidgetForeground as P,widgetShadow as M}from"../../../../platform/theme/common/colorRegistry.js";import{SearchWidget as O}from"./preferencesWidgets.js";let c=class extends O{_chords;_inputValue;recordDisposables=this._register(new b);_onKeybinding=this._register(new a);onKeybinding=this._onKeybinding.event;_onEnter=this._register(new a);onEnter=this._onEnter.event;_onEscape=this._register(new a);onEscape=this._onEscape.event;_onBlur=this._register(new a);onBlur=this._onBlur.event;constructor(t,e,i,s,n,d){super(t,e,i,s,n,d),this._register(k(()=>this.stopRecordingKeys())),this._chords=null,this._inputValue=""}clear(){this._chords=null,super.clear()}startRecordingKeys(){this.recordDisposables.add(o.addDisposableListener(this.inputBox.inputElement,o.EventType.KEY_DOWN,t=>this._onKeyDown(new x(t)))),this.recordDisposables.add(o.addDisposableListener(this.inputBox.inputElement,o.EventType.BLUR,()=>this._onBlur.fire())),this.recordDisposables.add(o.addDisposableListener(this.inputBox.inputElement,o.EventType.INPUT,()=>{this.setInputValue(this._inputValue)}))}stopRecordingKeys(){this._chords=null,this.recordDisposables.clear()}setInputValue(t){this._inputValue=t,this.inputBox.value=this._inputValue}_onKeyDown(t){if(t.preventDefault(),t.stopPropagation(),!this.options.recordEnter&&t.equals(y.Enter)){this._onEnter.fire();return}if(t.equals(y.Escape)){this._onEscape.fire();return}this.printKeybinding(t)}printKeybinding(t){const e=this.keybindingService.resolveKeyboardEvent(t),i=`code: ${t.browserEvent.code}, keyCode: ${t.browserEvent.keyCode}, key: ${t.browserEvent.key} => UI: ${e.getAriaLabel()}, user settings: ${e.getUserSettingsLabel()}, dispatch: ${e.getDispatchChords()[0]}`,s=this.options;this._chords||(this._chords=[]),this._chords.length>0&&this._chords[this._chords.length-1].getDispatchChords()[0]===null?this._chords[this._chords.length-1]=e:(this._chords.length===2&&(this._chords=[]),this._chords.push(e));const d=this._chords.map(I=>I.getUserSettingsLabel()||"").join(" ");this.setInputValue(s.quoteRecordedKeys?`"${d}"`:d),this.inputBox.inputElement.title=i,this._onKeybinding.fire(this._chords)}};c=g([h(2,B),h(3,_),h(4,V),h(5,W)],c);let r=class extends D{constructor(e,i){super();this.instantiationService=i;this._domNode=K(document.createElement("div")),this._domNode.setDisplay("none"),this._domNode.setClassName("defineKeybindingWidget"),this._domNode.setWidth(r.WIDTH),this._domNode.setHeight(r.HEIGHT);const s=u.localize("defineKeybinding.initial","Press desired key combination and then press ENTER.");o.append(this._domNode.domNode,o.$(".message",void 0,s)),this._domNode.domNode.style.backgroundColor=m($),this._domNode.domNode.style.color=m(P),this._domNode.domNode.style.boxShadow=`0 2px 8px ${m(M)}`,this._keybindingInputWidget=this._register(this.instantiationService.createInstance(c,this._domNode.domNode,{ariaLabel:s,history:[],inputBoxStyles:R})),this._keybindingInputWidget.startRecordingKeys(),this._register(this._keybindingInputWidget.onKeybinding(n=>this.onKeybinding(n))),this._register(this._keybindingInputWidget.onEnter(()=>this.hide())),this._register(this._keybindingInputWidget.onEscape(()=>this.clearOrHide())),this._register(this._keybindingInputWidget.onBlur(()=>this.onCancel())),this._outputNode=o.append(this._domNode.domNode,o.$(".output")),this._showExistingKeybindingsNode=o.append(this._domNode.domNode,o.$(".existing")),e&&o.append(e,this._domNode.domNode)}static WIDTH=400;static HEIGHT=110;_domNode;_keybindingInputWidget;_outputNode;_showExistingKeybindingsNode;_keybindingDisposables=this._register(new b);_chords=null;_isVisible=!1;_onHide=this._register(new a);_onDidChange=this._register(new a);onDidChange=this._onDidChange.event;_onShowExistingKeybindings=this._register(new a);onShowExistingKeybidings=this._onShowExistingKeybindings.event;get domNode(){return this._domNode.domNode}define(){return this._keybindingInputWidget.clear(),L.withAsyncBody(async e=>{this._isVisible||(this._isVisible=!0,this._domNode.setDisplay("block"),this._chords=null,this._keybindingInputWidget.setInputValue(""),o.clearNode(this._outputNode),o.clearNode(this._showExistingKeybindingsNode),await C(0),this._keybindingInputWidget.focus());const i=this._onHide.event(()=>{e(this.getUserSettingsLabel()),i.dispose()})})}layout(e){const i=Math.round((e.height-r.HEIGHT)/2);this._domNode.setTop(i);const s=Math.round((e.width-r.WIDTH)/2);this._domNode.setLeft(s)}printExisting(e){if(e>0){const i=o.$("span.existingText"),s=e===1?u.localize("defineKeybinding.oneExists","1 existing command has this keybinding",e):u.localize("defineKeybinding.existing","{0} existing commands have this keybinding",e);o.append(i,document.createTextNode(s)),S.alert(s),this._showExistingKeybindingsNode.appendChild(i),i.onmousedown=n=>{n.preventDefault()},i.onmouseup=n=>{n.preventDefault()},i.onclick=()=>{this._onShowExistingKeybindings.fire(this.getUserSettingsLabel())}}}onKeybinding(e){if(this._keybindingDisposables.clear(),this._chords=e,o.clearNode(this._outputNode),o.clearNode(this._showExistingKeybindingsNode),this._keybindingDisposables.add(new v(this._outputNode,N,f)).set(this._chords?.[0]??void 0),this._chords)for(let n=1;n<this._chords.length;n++)this._outputNode.appendChild(document.createTextNode(u.localize("defineKeybinding.chordsTo","chord to"))),this._keybindingDisposables.add(new v(this._outputNode,N,f)).set(this._chords[n]);const s=this.getUserSettingsLabel();s&&this._onDidChange.fire(s)}getUserSettingsLabel(){let e=null;return this._chords&&(e=this._chords.map(i=>i.getUserSettingsLabel()).join(" ")),e}onCancel(){this._chords=null,this.hide()}clearOrHide(){this._chords===null?this.hide():(this._chords=null,this._keybindingInputWidget.clear(),o.clearNode(this._outputNode),o.clearNode(this._showExistingKeybindingsNode))}hide(){this._domNode.setDisplay("none"),this._isVisible=!1,this._onHide.fire()}};r=g([h(1,_)],r);let l=class extends T{constructor(e,i){super();this._editor=e;this._widget=this._register(i.createInstance(r,null)),this._editor.addOverlayWidget(this)}static ID="editor.contrib.defineKeybindingWidget";_widget;getId(){return l.ID}getDomNode(){return this._widget.domNode}getPosition(){return{preference:null}}dispose(){this._editor.removeOverlayWidget(this),super.dispose()}start(){this._editor.hasModel()&&this._editor.revealPositionInCenterIfOutsideViewport(this._editor.getPosition(),H.Smooth);const e=this._editor.getLayoutInfo();return this._widget.layout(new o.Dimension(e.width,e.height)),this._widget.define()}};l=g([h(1,_)],l);export{l as DefineKeybindingOverlayWidget,r as DefineKeybindingWidget,c as KeybindingsSearchWidget};
