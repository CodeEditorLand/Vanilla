var P=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var S=(o,i,s,a)=>{for(var t=a>1?void 0:a?w(i,s):i,l=o.length-1,n;l>=0;l--)(n=o[l])&&(t=(a?n(i,s,t):n(t))||t);return a&&t&&P(i,s,t),t},I=(o,i)=>(s,a)=>i(s,a,o);import{VSBuffer as C}from"../../../../base/common/buffer.js";import{Disposable as D,MutableDisposable as A}from"../../../../base/common/lifecycle.js";import{isMacintosh as z,isWindows as Q}from"../../../../base/common/platform.js";import*as r from"../../../../nls.js";import{Action2 as x,registerAction2 as U}from"../../../../platform/actions/common/actions.js";import{IConfigurationService as O}from"../../../../platform/configuration/common/configuration.js";import{IEnvironmentService as T}from"../../../../platform/environment/common/environment.js";import{IFileService as V}from"../../../../platform/files/common/files.js";import{IKeyboardLayoutService as h,areKeyboardLayoutsEqual as E,getKeyboardLayoutId as W,parseKeyboardLayoutDescription as k}from"../../../../platform/keyboardLayout/common/keyboardLayout.js";import{IQuickInputService as _}from"../../../../platform/quickinput/common/quickInput.js";import{WorkbenchPhase as j,registerWorkbenchContribution2 as M}from"../../../common/contributions.js";import{IEditorService as R}from"../../../services/editor/common/editorService.js";import{IStatusbarService as N,StatusbarAlignment as K}from"../../../services/statusbar/browser/statusbar.js";import{KEYBOARD_LAYOUT_OPEN_PICKER as f}from"../common/preferences.js";let d=class extends D{constructor(s,a){super();this.keyboardLayoutService=s;this.statusbarService=a;const t=r.localize("status.workbench.keyboardLayout","Keyboard Layout"),l=this.keyboardLayoutService.getCurrentKeyboardLayout();if(l){const n=k(l),y=r.localize("keyboardLayout","Layout: {0}",n.label);this.pickerElement.value=this.statusbarService.addEntry({name:t,text:y,ariaLabel:y,command:f},"status.workbench.keyboardLayout",K.RIGHT)}this._register(this.keyboardLayoutService.onDidChangeKeyboardLayout(()=>{const n=this.keyboardLayoutService.getCurrentKeyboardLayout(),y=k(n);if(this.pickerElement.value){const c=r.localize("keyboardLayout","Layout: {0}",y.label);this.pickerElement.value.update({name:t,text:c,ariaLabel:c,command:f})}else{const c=r.localize("keyboardLayout","Layout: {0}",y.label);this.pickerElement.value=this.statusbarService.addEntry({name:t,text:c,ariaLabel:c,command:f},"status.workbench.keyboardLayout",K.RIGHT)}}))}static ID="workbench.contrib.keyboardLayoutPicker";pickerElement=this._register(new A)};d=S([I(0,h),I(1,N)],d),M(d.ID,d,j.BlockStartup);const B=[`// ${r.localize("displayLanguage","Defines the keyboard layout used in VS Code in the browser environment.")}`,`// ${r.localize("doc",'Open VS Code and run "Developer: Inspect Key Mappings (JSON)" from Command Palette.')}`,"","// Once you have the keyboard layout info, please paste it below.",`
`].join(`
`);U(class extends x{constructor(){super({id:f,title:r.localize2("keyboard.chooseLayout","Change Keyboard Layout"),f1:!0})}async run(o){const i=o.get(h),s=o.get(_),a=o.get(O),t=o.get(T),l=o.get(R),n=o.get(V),y=i.getAllKeyboardLayouts(),c=i.getCurrentKeyboardLayout(),p=a.getValue("keyboard.layout")==="autodetect",b=y.map(e=>{const u=!p&&E(c,e),v=k(e);return{layout:e,label:[v.label,e&&e.isUserKeyboardLayout?"(User configured layout)":""].join(" "),id:e.text||e.lang||e.layout,description:v.description+(u?" (Current layout)":""),picked:!p&&E(c,e)}}).sort((e,u)=>e.label<u.label?-1:e.label>u.label?1:0);if(b.length>0){const e=z?"Mac":Q?"Win":"Linux";b.unshift({type:"separator",label:r.localize("layoutPicks","Keyboard Layouts ({0})",e)})}const L={label:r.localize("configureKeyboardLayout","Configure Keyboard Layout")};b.unshift(L);const g={label:r.localize("autoDetect","Auto Detect"),description:p?`Current: ${k(c).label}`:void 0,picked:p?!0:void 0};b.unshift(g);const m=await s.pick(b,{placeHolder:r.localize("pickKeyboardLayout","Select Keyboard Layout"),matchOnDescription:!0});if(m){if(m===g){a.updateValue("keyboard.layout","autodetect");return}if(m===L){const e=t.keyboardLayoutResource;return await n.stat(e).then(void 0,()=>n.createFile(e,C.fromString(B))).then(u=>{if(u)return l.openEditor({resource:u.resource,languageId:"jsonc",options:{pinned:!0}})},u=>{throw new Error(r.localize("fail.createSettings","Unable to create '{0}' ({1}).",e.toString(),u))}),Promise.resolve()}a.updateValue("keyboard.layout",W(m.layout))}}});export{d as KeyboardLayoutPickerContribution};
