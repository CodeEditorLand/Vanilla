var P=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var S=(o,i,s,a)=>{for(var t=a>1?void 0:a?w(i,s):i,l=o.length-1,n;l>=0;l--)(n=o[l])&&(t=(a?n(i,s,t):n(t))||t);return a&&t&&P(i,s,t),t},I=(o,i)=>(s,a)=>i(s,a,o);import{VSBuffer as C}from"../../../../../vs/base/common/buffer.js";import{Disposable as D,MutableDisposable as A}from"../../../../../vs/base/common/lifecycle.js";import{isMacintosh as z,isWindows as Q}from"../../../../../vs/base/common/platform.js";import*as r from"../../../../../vs/nls.js";import{Action2 as x,registerAction2 as U}from"../../../../../vs/platform/actions/common/actions.js";import{IConfigurationService as O}from"../../../../../vs/platform/configuration/common/configuration.js";import{IEnvironmentService as T}from"../../../../../vs/platform/environment/common/environment.js";import{IFileService as V}from"../../../../../vs/platform/files/common/files.js";import"../../../../../vs/platform/instantiation/common/instantiation.js";import{areKeyboardLayoutsEqual as h,getKeyboardLayoutId as W,IKeyboardLayoutService as E,parseKeyboardLayoutDescription as k}from"../../../../../vs/platform/keyboardLayout/common/keyboardLayout.js";import{IQuickInputService as _}from"../../../../../vs/platform/quickinput/common/quickInput.js";import{registerWorkbenchContribution2 as M,WorkbenchPhase as R}from"../../../../../vs/workbench/common/contributions.js";import"../../../../../vs/workbench/common/editor.js";import{KEYBOARD_LAYOUT_OPEN_PICKER as f}from"../../../../../vs/workbench/contrib/preferences/common/preferences.js";import{IEditorService as N}from"../../../../../vs/workbench/services/editor/common/editorService.js";import{IStatusbarService as j,StatusbarAlignment as K}from"../../../../../vs/workbench/services/statusbar/browser/statusbar.js";let d=class extends D{constructor(s,a){super();this.keyboardLayoutService=s;this.statusbarService=a;const t=r.localize("status.workbench.keyboardLayout","Keyboard Layout"),l=this.keyboardLayoutService.getCurrentKeyboardLayout();if(l){const n=k(l),y=r.localize("keyboardLayout","Layout: {0}",n.label);this.pickerElement.value=this.statusbarService.addEntry({name:t,text:y,ariaLabel:y,command:f},"status.workbench.keyboardLayout",K.RIGHT)}this._register(this.keyboardLayoutService.onDidChangeKeyboardLayout(()=>{const n=this.keyboardLayoutService.getCurrentKeyboardLayout(),y=k(n);if(this.pickerElement.value){const c=r.localize("keyboardLayout","Layout: {0}",y.label);this.pickerElement.value.update({name:t,text:c,ariaLabel:c,command:f})}else{const c=r.localize("keyboardLayout","Layout: {0}",y.label);this.pickerElement.value=this.statusbarService.addEntry({name:t,text:c,ariaLabel:c,command:f},"status.workbench.keyboardLayout",K.RIGHT)}}))}static ID="workbench.contrib.keyboardLayoutPicker";pickerElement=this._register(new A)};d=S([I(0,E),I(1,j)],d),M(d.ID,d,R.BlockStartup);const B=[`// ${r.localize("displayLanguage","Defines the keyboard layout used in VS Code in the browser environment.")}`,`// ${r.localize("doc",'Open VS Code and run "Developer: Inspect Key Mappings (JSON)" from Command Palette.')}`,"","// Once you have the keyboard layout info, please paste it below.",`
`].join(`
`);U(class extends x{constructor(){super({id:f,title:r.localize2("keyboard.chooseLayout","Change Keyboard Layout"),f1:!0})}async run(o){const i=o.get(E),s=o.get(_),a=o.get(O),t=o.get(T),l=o.get(N),n=o.get(V),y=i.getAllKeyboardLayouts(),c=i.getCurrentKeyboardLayout(),m=a.getValue("keyboard.layout")==="autodetect",b=y.map(e=>{const u=!m&&h(c,e),v=k(e);return{layout:e,label:[v.label,e&&e.isUserKeyboardLayout?"(User configured layout)":""].join(" "),id:e.text||e.lang||e.layout,description:v.description+(u?" (Current layout)":""),picked:!m&&h(c,e)}}).sort((e,u)=>e.label<u.label?-1:e.label>u.label?1:0);if(b.length>0){const e=z?"Mac":Q?"Win":"Linux";b.unshift({type:"separator",label:r.localize("layoutPicks","Keyboard Layouts ({0})",e)})}const L={label:r.localize("configureKeyboardLayout","Configure Keyboard Layout")};b.unshift(L);const g={label:r.localize("autoDetect","Auto Detect"),description:m?`Current: ${k(c).label}`:void 0,picked:m?!0:void 0};b.unshift(g);const p=await s.pick(b,{placeHolder:r.localize("pickKeyboardLayout","Select Keyboard Layout"),matchOnDescription:!0});if(p){if(p===g){a.updateValue("keyboard.layout","autodetect");return}if(p===L){const e=t.keyboardLayoutResource;return await n.stat(e).then(void 0,()=>n.createFile(e,C.fromString(B))).then(u=>{if(u)return l.openEditor({resource:u.resource,languageId:"jsonc",options:{pinned:!0}})},u=>{throw new Error(r.localize("fail.createSettings","Unable to create '{0}' ({1}).",e.toString(),u))}),Promise.resolve()}a.updateValue("keyboard.layout",W(p.layout))}}});export{d as KeyboardLayoutPickerContribution};
