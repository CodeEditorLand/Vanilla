var C=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var p=(a,r,e,t)=>{for(var i=t>1?void 0:t?I(r,e):r,o=a.length-1,s;o>=0;o--)(s=a[o])&&(i=(t?s(r,e,i):s(i))||i);return t&&i&&C(r,e,i),i},m=(a,r)=>(e,t)=>r(e,t,a);import{VSBuffer as u}from"../../../../base/common/buffer.js";import{NotSupportedError as h}from"../../../../base/common/errors.js";import{Emitter as F,Event as v}from"../../../../base/common/event.js";import{Disposable as g}from"../../../../base/common/lifecycle.js";import{Schemas as D}from"../../../../base/common/network.js";import{URI as R}from"../../../../base/common/uri.js";import{FileChangeType as d,FilePermission as b,FileSystemProviderCapabilities as y,FileSystemProviderErrorCode as f,FileType as w}from"../../../../platform/files/common/files.js";import*as O from"../../../../platform/jsonschemas/common/jsonContributionRegistry.js";import{ILogService as U,LogLevel as S}from"../../../../platform/log/common/log.js";import{Registry as P}from"../../../../platform/registry/common/platform.js";import{IPreferencesService as N}from"../../../services/preferences/common/preferences.js";const l=P.as(O.Extensions.JSONContribution);let n=class extends g{constructor(e,t){super();this.preferencesService=e;this.logService=t;this._register(l.onDidChangeSchema(i=>{this._onDidChangeFile.fire([{resource:R.parse(i),type:d.UPDATED}])})),this._register(e.onDidDefaultSettingsContentChanged(i=>{this._onDidChangeFile.fire([{resource:i,type:d.UPDATED}])}))}static SCHEMA=D.vscode;_onDidChangeFile=this._register(new F);onDidChangeFile=this._onDidChangeFile.event;capabilities=y.Readonly+y.FileReadWrite;async readFile(e){if(e.scheme!==n.SCHEMA)throw new h;let t;if(e.authority==="schemas"?t=this.getSchemaContent(e):e.authority==="defaultsettings"&&(t=this.preferencesService.getDefaultSettingsContent(e)),t)return u.fromString(t).buffer;throw f.FileNotFound}async stat(e){if(l.hasSchemaContent(e.toString())||this.preferencesService.hasDefaultSettingsContent(e)){const t=Date.now();return{type:w.File,permissions:b.Readonly,mtime:t,ctime:t,size:0}}throw f.FileNotFound}onDidChangeCapabilities=v.None;watch(e,t){return g.None}async mkdir(e){}async readdir(e){return[]}async rename(e,t,i){}async delete(e,t){}async writeFile(){throw new h}getSchemaContent(e){const t=Date.now(),i=l.getSchemaContent(e.toString())??"{}",o=this.logService.getLevel();if(o===S.Debug||o===S.Trace){const s=Date.now(),c=JSON.stringify(l.getSchemaContributions().schemas[e.toString()]);this.logService.debug(`${e.toString()}: ${c.length} -> ${i.length} (${Math.round((c.length-i.length)/c.length*100)}%) Took ${s-t}ms`)}return i}};n=p([m(0,N),m(1,U)],n);export{n as SettingsFileSystemProvider};
