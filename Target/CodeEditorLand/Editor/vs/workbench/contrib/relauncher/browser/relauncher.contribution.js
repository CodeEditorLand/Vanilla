var C=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var u=(d,n,i,o)=>{for(var t=o>1?void 0:o?w(n,i):n,e=d.length-1,r;e>=0;e--)(r=d[e])&&(t=(o?r(n,i,t):r(t))||t);return o&&t&&C(n,i,t),t},a=(d,n)=>(i,o)=>n(i,o,d);import{RunOnceScheduler as k}from"../../../../base/common/async.js";import{Disposable as g,dispose as I,toDisposable as T}from"../../../../base/common/lifecycle.js";import{isLinux as f,isMacintosh as b,isNative as h}from"../../../../base/common/platform.js";import{isEqual as W}from"../../../../base/common/resources.js";import"../../../../base/common/uri.js";import{localize as c}from"../../../../nls.js";import{ConfigurationTarget as x,IConfigurationService as E}from"../../../../platform/configuration/common/configuration.js";import{IDialogService as D}from"../../../../platform/dialogs/common/dialogs.js";import{IProductService as F}from"../../../../platform/product/common/productService.js";import{Registry as R}from"../../../../platform/registry/common/platform.js";import{TitleBarSetting as P,TitlebarStyle as v}from"../../../../platform/window/common/window.js";import{IWorkspaceContextService as N,WorkbenchState as U}from"../../../../platform/workspace/common/workspace.js";import{Extensions as A}from"../../../common/contributions.js";import{IWorkbenchEnvironmentService as O}from"../../../services/environment/common/environmentService.js";import{IExtensionService as L}from"../../../services/extensions/common/extensions.js";import{IHostService as y}from"../../../services/host/browser/host.js";import{LifecyclePhase as m}from"../../../services/lifecycle/common/lifecycle.js";let l=class extends g{constructor(i,o,t,e){super();this.hostService=i;this.configurationService=o;this.productService=t;this.dialogService=e;this.onConfigurationChange(void 0),this._register(this.configurationService.onDidChangeConfiguration(r=>this.onConfigurationChange(r)))}static SETTINGS=[P.TITLE_BAR_STYLE,"window.nativeTabs","window.nativeFullScreen","window.clickThroughInactive","window.experimentalControlOverlay","update.mode","editor.accessibilitySupport","security.workspace.trust.enabled","workbench.enableExperiments","_extensionsGallery.enablePPE","security.restrictUNCAccess","accessibility.verbosity.debug"];titleBarStyle=new s("string");nativeTabs=new s("boolean");nativeFullScreen=new s("boolean");clickThroughInactive=new s("boolean");linuxWindowControlOverlay=new s("boolean");updateMode=new s("string");accessibilitySupport;workspaceTrustEnabled=new s("boolean");experimentsEnabled=new s("boolean");enablePPEExtensionsGallery=new s("boolean");restrictUNCAccess=new s("boolean");accessibilityVerbosityDebug=new s("boolean");onConfigurationChange(i){if(i&&!l.SETTINGS.some(r=>i.affectsConfiguration(r)))return;let o=!1;function t(r){o=o||r}const e=this.configurationService.getValue();h&&(t((e.window.titleBarStyle===v.NATIVE||e.window.titleBarStyle===v.CUSTOM)&&this.titleBarStyle.handleChange(e.window?.titleBarStyle)),t(b&&this.nativeTabs.handleChange(e.window?.nativeTabs)),t(b&&this.nativeFullScreen.handleChange(e.window?.nativeFullScreen)),t(b&&this.clickThroughInactive.handleChange(e.window?.clickThroughInactive)),t(f&&this.linuxWindowControlOverlay.handleChange(e.window?.experimentalControlOverlay)),t(this.updateMode.handleChange(e.update?.mode)),f&&typeof e.editor?.accessibilitySupport=="string"&&e.editor.accessibilitySupport!==this.accessibilitySupport&&(this.accessibilitySupport=e.editor.accessibilitySupport,this.accessibilitySupport==="on"&&(o=!0)),t(this.workspaceTrustEnabled.handleChange(e?.security?.workspace?.trust?.enabled)),t(this.restrictUNCAccess.handleChange(e?.security?.restrictUNCAccess)),t(this.accessibilityVerbosityDebug.handleChange(e?.accessibility?.verbosity?.debug))),t(this.experimentsEnabled.handleChange(e.workbench?.enableExperiments)),t(this.productService.quality!=="stable"&&this.enablePPEExtensionsGallery.handleChange(e._extensionsGallery?.enablePPE)),o&&i&&i.source!==x.DEFAULT&&this.doConfirm(h?c("relaunchSettingMessage","A setting has changed that requires a restart to take effect."):c("relaunchSettingMessageWeb","A setting has changed that requires a reload to take effect."),h?c("relaunchSettingDetail","Press the restart button to restart {0} and enable the setting.",this.productService.nameLong):c("relaunchSettingDetailWeb","Press the reload button to reload {0} and enable the setting.",this.productService.nameLong),h?c({key:"restart",comment:["&& denotes a mnemonic"]},"&&Restart"):c({key:"restartWeb",comment:["&& denotes a mnemonic"]},"&&Reload"),()=>this.hostService.restart())}async doConfirm(i,o,t,e){if(this.hostService.hasFocus){const{confirmed:r}=await this.dialogService.confirm({message:i,detail:o,primaryButton:t});r&&e()}}};l=u([a(0,y),a(1,E),a(2,F),a(3,D)],l);class s{constructor(n){this.typeName=n}static create(n){return new s(n)}lastValue=void 0;handleChange(n){return typeof n===this.typeName&&n!==this.lastValue?(this.lastValue=n,!0):!1}}let p=class extends g{constructor(i,o,t,e){super();this.contextService=i;this.extensionHostRestarter=this._register(new k(async()=>{e.extensionTestsLocationURI||(e.remoteAuthority?t.reload():h&&await o.stopExtensionHosts(c("restartExtensionHost.reason","Restarting extension host due to a workspace folder change."))&&o.startExtensionHosts())},10)),this.contextService.getCompleteWorkspace().then(r=>{this.firstFolderResource=r.folders.length>0?r.folders[0].uri:void 0,this.handleWorkbenchState(),this._register(this.contextService.onDidChangeWorkbenchState(()=>setTimeout(()=>this.handleWorkbenchState())))}),this._register(T(()=>{this.onDidChangeWorkspaceFoldersUnbind?.dispose()}))}firstFolderResource;extensionHostRestarter;onDidChangeWorkspaceFoldersUnbind;handleWorkbenchState(){if(this.contextService.getWorkbenchState()===U.WORKSPACE){const i=this.contextService.getWorkspace();this.firstFolderResource=i.folders.length>0?i.folders[0].uri:void 0,this.onDidChangeWorkspaceFoldersUnbind||(this.onDidChangeWorkspaceFoldersUnbind=this.contextService.onDidChangeWorkspaceFolders(()=>this.onDidChangeWorkspaceFolders()))}else I(this.onDidChangeWorkspaceFoldersUnbind),this.onDidChangeWorkspaceFoldersUnbind=void 0}onDidChangeWorkspaceFolders(){const i=this.contextService.getWorkspace(),o=i.folders.length>0?i.folders[0].uri:void 0;W(this.firstFolderResource,o)||(this.firstFolderResource=o,this.extensionHostRestarter.schedule())}};p=u([a(0,N),a(1,L),a(2,y),a(3,O)],p);const S=R.as(A.Workbench);S.registerWorkbenchContribution(l,m.Restored),S.registerWorkbenchContribution(p,m.Restored);export{l as SettingsChangeRelauncher,p as WorkspaceChangeExtHostRelauncher};
