var B=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var w=(u,e,t,r)=>{for(var i=r>1?void 0:r?N(e,t):e,s=u.length-1,a;s>=0;s--)(a=u[s])&&(i=(r?a(e,t,i):a(i))||i);return r&&i&&B(e,t,i),i},m=(u,e)=>(t,r)=>e(t,r,u);import"vs/css!./media/languageStatus";import*as g from"../../../../../vs/base/browser/dom.js";import{ActionBar as F}from"../../../../../vs/base/browser/ui/actionbar/actionbar.js";import{renderLabelWithIcons as D}from"../../../../../vs/base/browser/ui/iconLabel/iconLabels.js";import{Action as T}from"../../../../../vs/base/common/actions.js";import{equals as R}from"../../../../../vs/base/common/arrays.js";import{Codicon as M}from"../../../../../vs/base/common/codicons.js";import{Event as q}from"../../../../../vs/base/common/event.js";import{MarkdownString as G}from"../../../../../vs/base/common/htmlContent.js";import{Disposable as z,DisposableStore as k,dispose as x,toDisposable as J}from"../../../../../vs/base/common/lifecycle.js";import{parseLinkedText as K}from"../../../../../vs/base/common/linkedText.js";import S from"../../../../../vs/base/common/severity.js";import{ThemeIcon as V}from"../../../../../vs/base/common/themables.js";import{URI as U}from"../../../../../vs/base/common/uri.js";import{getCodeEditor as j}from"../../../../../vs/editor/browser/editorBrowser.js";import{localize as y,localize2 as Q}from"../../../../../vs/nls.js";import"../../../../../vs/platform/accessibility/common/accessibility.js";import{Categories as X}from"../../../../../vs/platform/action/common/actionCommonCategories.js";import{Action2 as Y,registerAction2 as Z}from"../../../../../vs/platform/actions/common/actions.js";import{IHoverService as ee,nativeHoverDelegate as W}from"../../../../../vs/platform/hover/browser/hover.js";import"../../../../../vs/platform/instantiation/common/instantiation.js";import{Link as P}from"../../../../../vs/platform/opener/browser/link.js";import{IOpenerService as te}from"../../../../../vs/platform/opener/common/opener.js";import{Registry as ie}from"../../../../../vs/platform/registry/common/platform.js";import{IStorageService as A,StorageScope as _,StorageTarget as O}from"../../../../../vs/platform/storage/common/storage.js";import{Extensions as re}from"../../../../../vs/workbench/common/contributions.js";import{IEditorGroupsService as se}from"../../../../../vs/workbench/services/editor/common/editorGroupsService.js";import{IEditorService as ae}from"../../../../../vs/workbench/services/editor/common/editorService.js";import{ILanguageStatusService as oe}from"../../../../../vs/workbench/services/languageStatus/common/languageStatusService.js";import{LifecyclePhase as ne}from"../../../../../vs/workbench/services/lifecycle/common/lifecycle.js";import{IStatusbarService as de,ShowTooltipCommand as ce,StatusbarAlignment as C}from"../../../../../vs/workbench/services/statusbar/browser/statusbar.js";class H{constructor(e,t){this.combined=e;this.dedicated=t}isEqual(e){return R(this.combined,e.combined)&&R(this.dedicated,e.dedicated)}}let E=class{constructor(e,t){this._storageService=e;this._key=t}get value(){return this._storageService.getNumber(this._key,_.PROFILE,0)}increment(){const e=this.value+1;return this._storageService.store(this._key,e,_.PROFILE,O.MACHINE),e}};E=w([m(0,A)],E);let L=class extends z{constructor(t){super();this.editorGroupService=t;for(const r of t.parts)this.createLanguageStatus(r);this._register(t.onDidCreateAuxiliaryEditorPart(r=>this.createLanguageStatus(r)))}createLanguageStatus(t){const r=new k;q.once(t.onWillDispose)(()=>r.dispose());const i=this.editorGroupService.getScopedInstantiationService(t);r.add(i.createInstance(o))}};L=w([m(0,se)],L);let o=class{constructor(e,t,r,i,s,a){this._languageStatusService=e;this._statusBarService=t;this._editorService=r;this._hoverService=i;this._openerService=s;this._storageService=a;a.onDidChangeValue(_.PROFILE,o._keyDedicatedItems,this._disposables)(this._handleStorageChange,this,this._disposables),this._restoreState(),this._interactionCounter=new E(a,"languageStatus.interactCount"),e.onDidChange(this._update,this,this._disposables),r.onDidActiveEditorChange(this._update,this,this._disposables),this._update(),t.onDidChangeEntryVisibility(l=>{!l.visible&&this._dedicated.has(l.id)&&(this._dedicated.delete(l.id),this._update(),this._storeState())},void 0,this._disposables)}static _id="status.languageStatus";static _keyDedicatedItems="languageStatus.dedicated";_disposables=new k;_interactionCounter;_dedicated=new Set;_model;_combinedEntry;_dedicatedEntries=new Map;_renderDisposables=new k;dispose(){this._disposables.dispose(),this._combinedEntry?.dispose(),x(this._dedicatedEntries.values()),this._renderDisposables.dispose()}_handleStorageChange(){this._restoreState(),this._update()}_restoreState(){const e=this._storageService.get(o._keyDedicatedItems,_.PROFILE,"[]");try{const t=JSON.parse(e);this._dedicated=new Set(t)}catch{this._dedicated.clear()}}_storeState(){if(this._dedicated.size===0)this._storageService.remove(o._keyDedicatedItems,_.PROFILE);else{const e=JSON.stringify(Array.from(this._dedicated.keys()));this._storageService.store(o._keyDedicatedItems,e,_.PROFILE,O.USER)}}_createViewModel(e){if(!e?.hasModel())return new H([],[]);const t=this._languageStatusService.getLanguageStatus(e.getModel()),r=[],i=[];for(const s of t)this._dedicated.has(s.id)&&i.push(s),r.push(s);return new H(r,i)}_update(){const e=j(this._editorService.activeTextEditorControl),t=this._createViewModel(e);if(this._model?.isEqual(t))return;if(this._renderDisposables.clear(),this._model=t,e?.onDidChangeModelLanguage(this._update,this,this._renderDisposables),t.combined.length===0)this._combinedEntry?.dispose(),this._combinedEntry=void 0;else{const[i]=t.combined,s=i.severity>=S.Warning,a=o._severityToComboCodicon(i.severity);let l=!1;const b=[],h=document.createElement("div");for(const d of t.combined){const n=t.dedicated.includes(d);h.appendChild(this._renderStatus(d,s,n,this._renderDisposables)),b.push(o._accessibilityInformation(d).label),l=l||!n&&d.busy}const f={name:y("langStatus.name","Editor Language Status"),ariaLabel:y("langStatus.aria","Editor Language Status: {0}",b.join(", next: ")),tooltip:h,command:ce,text:l?`${a}\xA0\xA0$(sync~spin)`:a};this._combinedEntry?this._combinedEntry.update(f):this._combinedEntry=this._statusBarService.addEntry(f,o._id,C.RIGHT,{id:"status.editor.mode",alignment:C.LEFT,compact:!0});const I=this._interactionCounter.value>=3,v=g.getWindow(e?.getContainerDomNode()),p=v.document.querySelector(".monaco-workbench .statusbar DIV#status\\.languageStatus A>SPAN.codicon"),c=v.document.querySelector(".monaco-workbench .statusbar DIV#status\\.languageStatus");if(g.isHTMLElement(p)&&c){const d="wiggle",n="flash";l?(p.classList.remove(d),c.classList.remove(n)):(p.classList.toggle(d,s||!I),this._renderDisposables.add(g.addDisposableListener(p,"animationend",$=>p.classList.remove(d))),c.classList.toggle(n,s),this._renderDisposables.add(g.addDisposableListener(c,"animationend",$=>c.classList.remove(n))))}if(!I){const d=v.document.querySelector(".monaco-workbench .context-view");if(g.isHTMLElement(d)){const n=new MutationObserver(()=>{v.document.contains(h)&&(this._interactionCounter.increment(),n.disconnect())});n.observe(d,{childList:!0,subtree:!0}),this._renderDisposables.add(J(()=>n.disconnect()))}}}const r=new Map;for(const i of t.dedicated){const s=o._asStatusbarEntry(i);let a=this._dedicatedEntries.get(i.id);a?(a.update(s),this._dedicatedEntries.delete(i.id)):a=this._statusBarService.addEntry(s,i.id,C.RIGHT,{id:"status.editor.mode",alignment:C.RIGHT}),r.set(i.id,a)}x(this._dedicatedEntries.values()),this._dedicatedEntries=r}_renderStatus(e,t,r,i){const s=document.createElement("div");s.classList.add("hover-language-status");const a=document.createElement("div");a.classList.add("severity",`sev${e.severity}`),a.classList.toggle("show",t);const l=o._severityToSingleCodicon(e.severity);g.append(a,...D(l)),s.appendChild(a);const b=document.createElement("div");b.classList.add("element"),s.appendChild(b);const h=document.createElement("div");h.classList.add("left"),b.appendChild(h);const f=document.createElement("span");f.classList.add("label");const I=typeof e.label=="string"?e.label:e.label.value;g.append(f,...D(e.busy?`$(sync~spin)\xA0\xA0${I}`:I)),h.appendChild(f);const v=document.createElement("span");v.classList.add("detail"),this._renderTextPlus(v,e.detail,i),h.appendChild(v);const p=document.createElement("div");p.classList.add("right"),b.appendChild(p);const{command:c}=e;c&&i.add(new P(p,{label:c.title,title:c.tooltip,href:U.from({scheme:"command",path:c.id,query:c.arguments&&JSON.stringify(c.arguments)}).toString()},{hoverDelegate:W},this._hoverService,this._openerService));const d=new F(p,{hoverDelegate:W});i.add(d);let n;return r?n=new T("unpin",y("unpin","Remove from Status Bar"),V.asClassName(M.pinned),!0,()=>{this._dedicated.delete(e.id),this._statusBarService.updateEntryVisibility(e.id,!1),this._update(),this._storeState()}):n=new T("pin",y("pin","Add to Status Bar"),V.asClassName(M.pin),!0,()=>{this._dedicated.add(e.id),this._statusBarService.updateEntryVisibility(e.id,!0),this._update(),this._storeState()}),d.push(n,{icon:!0,label:!1}),i.add(n),s}static _severityToComboCodicon(e){switch(e){case S.Error:return"$(bracket-error)";case S.Warning:return"$(bracket-dot)";default:return"$(bracket)"}}static _severityToSingleCodicon(e){switch(e){case S.Error:return"$(error)";case S.Warning:return"$(info)";default:return"$(check)"}}_renderTextPlus(e,t,r){for(const i of K(t).nodes)if(typeof i=="string"){const s=D(i);g.append(e,...s)}else r.add(new P(e,i,void 0,this._hoverService,this._openerService))}static _accessibilityInformation(e){if(e.accessibilityInfo)return e.accessibilityInfo;const t=typeof e.label=="string"?e.label:e.label.value;return e.detail?{label:y("aria.1","{0}, {1}",t,e.detail)}:{label:y("aria.2","{0}",t)}}static _asStatusbarEntry(e){let t;e.severity===S.Warning?t="warning":e.severity===S.Error&&(t="error");const r=typeof e.label=="string"?e.label:e.label.shortValue;return{name:y("name.pattern","{0} (Language Status)",e.name),text:e.busy?`${r}\xA0\xA0$(sync~spin)`:r,ariaLabel:o._accessibilityInformation(e).label,role:e.accessibilityInfo?.role,tooltip:e.command?.tooltip||new G(e.detail,{isTrusted:!0,supportThemeIcons:!0}),kind:t,command:e.command}}};o=w([m(0,oe),m(1,de),m(2,ae),m(3,ee),m(4,te),m(5,A)],o),ie.as(re.Workbench).registerWorkbenchContribution(L,ne.Restored),Z(class extends Y{constructor(){super({id:"editor.inlayHints.Reset",title:Q("reset","Reset Language Status Interaction Counter"),category:X.View,f1:!0})}run(u){u.get(A).remove("languageStatus.interactCount",_.PROFILE)}});
