var q=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var x=(f,c,t,e)=>{for(var o=e>1?void 0:e?B(c,t):c,i=f.length-1,s;i>=0;i--)(s=f[i])&&(o=(e?s(c,t,o):s(o))||o);return e&&o&&q(c,t,o),o},r=(f,c)=>(t,e)=>c(t,e,f);import"../common/walkThroughUtils.js";import"./media/walkThroughPart.css";import{addDisposableListener as j,isHTMLAnchorElement as $,isHTMLButtonElement as J,isHTMLElement as M,safeInnerHtml as P,size as Y}from"../../../../base/browser/dom.js";import{Gesture as Q,EventType as X}from"../../../../base/browser/touch.js";import{DomScrollableElement as Z}from"../../../../base/browser/ui/scrollbar/scrollableElement.js";import{UILabelProvider as tt}from"../../../../base/common/keybindingLabels.js";import{DisposableStore as H,dispose as k,toDisposable as et}from"../../../../base/common/lifecycle.js";import{deepClone as ot}from"../../../../base/common/objects.js";import{OS as N,OperatingSystem as it}from"../../../../base/common/platform.js";import{ScrollbarVisibility as K}from"../../../../base/common/scrollable.js";import*as st from"../../../../base/common/strings.js";import{isObject as rt}from"../../../../base/common/types.js";import{URI as A}from"../../../../base/common/uri.js";import{CodeEditorWidget as R}from"../../../../editor/browser/widget/codeEditor/codeEditorWidget.js";import{EditorOption as F}from"../../../../editor/common/config/editorOptions.js";import{ITextResourceConfigurationService as nt}from"../../../../editor/common/services/textResourceConfiguration.js";import{localize as z}from"../../../../nls.js";import{CommandsRegistry as lt}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as at}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as ct,RawContextKey as dt}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as ht}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as pt}from"../../../../platform/keybinding/common/keybinding.js";import{INotificationService as mt}from"../../../../platform/notification/common/notification.js";import{IOpenerService as ut}from"../../../../platform/opener/common/opener.js";import{IStorageService as gt}from"../../../../platform/storage/common/storage.js";import{ITelemetryService as ft}from"../../../../platform/telemetry/common/telemetry.js";import{IThemeService as vt}from"../../../../platform/theme/common/themeService.js";import{EditorPane as St}from"../../../browser/parts/editor/editorPane.js";import{IEditorGroupsService as bt}from"../../../services/editor/common/editorGroupsService.js";import{IExtensionService as Et}from"../../../services/extensions/common/extensions.js";import{WalkThroughInput as p}from"./walkThroughInput.js";const yt=new dt("interactivePlaygroundFocus",!1),V=z("walkThrough.unboundCommand","unbound"),Tt="walkThroughEditorViewState";let m=class extends St{constructor(t,e,o,i,s,d,u,n,T,l,C,h,E){super(m.ID,t,e,o,n);this.instantiationService=s;this.openerService=d;this.keybindingService=u;this.contextKeyService=T;this.configurationService=l;this.notificationService=C;this.extensionService=h;this.editorFocus=yt.bindTo(this.contextKeyService),this.editorMemento=this.getEditorMemento(E,i,Tt)}static ID="workbench.editor.walkThroughPart";disposables=new H;contentDisposables=[];content;scrollbar;editorFocus;lastFocus;size;editorMemento;createEditor(t){this.content=document.createElement("div"),this.content.classList.add("welcomePageFocusElement"),this.content.tabIndex=0,this.content.style.outlineStyle="none",this.scrollbar=new Z(this.content,{horizontal:K.Auto,vertical:K.Auto}),this.disposables.add(this.scrollbar),t.appendChild(this.scrollbar.getDomNode()),this.registerFocusHandlers(),this.registerClickHandler(),this.disposables.add(this.scrollbar.onScroll(e=>this.updatedScrollPosition()))}updatedScrollPosition(){const t=this.scrollbar.getScrollDimensions(),e=this.scrollbar.getScrollPosition(),o=t.scrollHeight;if(o&&this.input instanceof p){const i=e.scrollTop,s=t.height;this.input.relativeScrollPosition(i/o,(i+s)/o)}}onTouchChange(t){t.preventDefault(),t.stopPropagation();const e=this.scrollbar.getScrollPosition();this.scrollbar.setScrollPosition({scrollTop:e.scrollTop-t.translationY})}addEventListener(t,e,o,i){return t.addEventListener(e,o,i),et(()=>{t.removeEventListener(e,o,i)})}registerFocusHandlers(){this.disposables.add(this.addEventListener(this.content,"mousedown",t=>{this.focus()})),this.disposables.add(this.addEventListener(this.content,"focus",t=>{this.editorFocus.set(!0)})),this.disposables.add(this.addEventListener(this.content,"blur",t=>{this.editorFocus.reset()})),this.disposables.add(this.addEventListener(this.content,"focusin",t=>{if(M(t.target)&&t.target.classList.contains("zone-widget-container")){const e=this.scrollbar.getScrollPosition();this.content.scrollTop=e.scrollTop,this.content.scrollLeft=e.scrollLeft}M(t.target)&&(this.lastFocus=t.target)}))}registerClickHandler(){this.content.addEventListener("click",t=>{for(let e=t.target;e;e=e.parentNode)if($(e)&&e.href){const o=e.ownerDocument.getElementsByTagName("base")[0]||this.window.location;if(o&&e.href.indexOf(o.href)>=0&&e.hash){const i=this.content.querySelector(e.hash),s=this.content.firstElementChild;if(i&&s){const d=i.getBoundingClientRect().top-20,u=s.getBoundingClientRect().top;this.scrollbar.setScrollPosition({scrollTop:d-u})}}else this.open(A.parse(e.href));t.preventDefault();break}else if(J(e)){const o=e.getAttribute("data-href");o&&this.open(A.parse(o));break}else if(e===t.currentTarget)break})}open(t){if(t.scheme==="command"&&t.path==="git.clone"&&!lt.getCommand("git.clone")){this.notificationService.info(z("walkThrough.gitNotFound","It looks like Git is not installed on your system."));return}this.openerService.open(this.addFrom(t),{allowCommands:!0})}addFrom(t){if(t.scheme!=="command"||!(this.input instanceof p))return t;const e=t.query?JSON.parse(t.query):{};return e.from=this.input.getTelemetryFrom(),t.with({query:JSON.stringify(e)})}layout(t){this.size=t,Y(this.content,t.width,t.height),this.updateSizeClasses(),this.contentDisposables.forEach(o=>{o instanceof R&&o.layout()});const e=this.input instanceof p&&this.input;e&&e.layout&&e.layout(t),this.scrollbar.scanDomNode()}updateSizeClasses(){const t=this.content.firstElementChild;this.size&&t&&t.classList.toggle("max-height-685px",this.size.height<=685)}focus(){super.focus();let t=this.content.ownerDocument.activeElement;for(;t&&t!==this.content;)t=t.parentElement;t||(this.lastFocus||this.content).focus(),this.editorFocus.set(!0)}arrowUp(){const t=this.scrollbar.getScrollPosition();this.scrollbar.setScrollPosition({scrollTop:t.scrollTop-this.getArrowScrollHeight()})}arrowDown(){const t=this.scrollbar.getScrollPosition();this.scrollbar.setScrollPosition({scrollTop:t.scrollTop+this.getArrowScrollHeight()})}getArrowScrollHeight(){let t=this.configurationService.getValue("editor.fontSize");return(typeof t!="number"||t<1)&&(t=12),3*t}pageUp(){const t=this.scrollbar.getScrollDimensions(),e=this.scrollbar.getScrollPosition();this.scrollbar.setScrollPosition({scrollTop:e.scrollTop-t.height})}pageDown(){const t=this.scrollbar.getScrollDimensions(),e=this.scrollbar.getScrollPosition();this.scrollbar.setScrollPosition({scrollTop:e.scrollTop+t.height})}setInput(t,e,o,i){const s=new H;return this.contentDisposables.push(s),this.content.innerText="",super.setInput(t,e,o,i).then(async()=>(t.resource.path.endsWith(".md")&&await this.extensionService.whenInstalledExtensionsRegistered(),t.resolve())).then(d=>{if(i.isCancellationRequested)return;const u=d.main;if(!t.resource.path.endsWith(".md")){P(this.content,u,{ALLOW_UNKNOWN_PROTOCOLS:!0}),this.updateSizeClasses(),this.decorateContent(),this.contentDisposables.push(this.keybindingService.onDidUpdateKeybindings(()=>this.decorateContent())),t.onReady?.(this.content.firstElementChild,s),this.scrollbar.scanDomNode(),this.loadTextEditorViewState(t),this.updatedScrollPosition();return}const n=document.createElement("div");n.classList.add("walkThroughContent");const T=this.expandMacros(u);P(n,T,{ALLOW_UNKNOWN_PROTOCOLS:!0}),this.content.appendChild(n),d.snippets.forEach((l,C)=>{const h=l.textEditorModel;if(!h)return;const E=`snippet-${h.uri.fragment}`,v=n.querySelector(`#${E.replace(/[\\.]/g,"\\$&")}`),W=this.getEditorOptions(h.getLanguageId()),U={target:this.input instanceof p?this.input.getTelemetryFrom():void 0,snippet:C},a=this.instantiationService.createInstance(R,v,W,{telemetryData:U});a.setModel(h),this.contentDisposables.push(a);const I=g=>{const S=a.getOption(F.lineHeight),b=`${Math.max(h.getLineCount()+1,4)*S}px`;v.style.height!==b&&(v.style.height=b,a.layout(),g||this.scrollbar.scanDomNode())};I(!0),this.contentDisposables.push(a.onDidChangeModelContent(()=>I(!1))),this.contentDisposables.push(a.onDidChangeCursorPosition(g=>{const S=this.content.firstElementChild;if(S){const b=v.getBoundingClientRect().top,_=S.getBoundingClientRect().top,D=a.getOption(F.lineHeight),y=b+(g.position.lineNumber-1)*D-_,L=y+D,G=this.scrollbar.getScrollDimensions(),w=this.scrollbar.getScrollPosition().scrollTop,O=G.height;w>y?this.scrollbar.setScrollPosition({scrollTop:y}):w<L-O&&this.scrollbar.setScrollPosition({scrollTop:L-O})}})),this.contentDisposables.push(this.configurationService.onDidChangeConfiguration(g=>{g.affectsConfiguration("editor")&&l.textEditorModel&&a.updateOptions(this.getEditorOptions(l.textEditorModel.getLanguageId()))}))}),this.updateSizeClasses(),this.multiCursorModifier(),this.contentDisposables.push(this.configurationService.onDidChangeConfiguration(l=>{l.affectsConfiguration("editor.multiCursorModifier")&&this.multiCursorModifier()})),t.onReady?.(n,s),this.scrollbar.scanDomNode(),this.loadTextEditorViewState(t),this.updatedScrollPosition(),this.contentDisposables.push(Q.addTarget(n)),this.contentDisposables.push(j(n,X.Change,l=>this.onTouchChange(l)))})}getEditorOptions(t){const e=ot(this.configurationService.getValue("editor",{overrideIdentifier:t}));return{...rt(e)?e:Object.create(null),scrollBeyondLastLine:!1,scrollbar:{verticalScrollbarSize:14,horizontal:"auto",useShadows:!0,verticalHasArrows:!1,horizontalHasArrows:!1,alwaysConsumeMouseWheel:!1},overviewRulerLanes:3,fixedOverflowWidgets:!1,lineNumbersMinChars:1,minimap:{enabled:!1}}}expandMacros(t){return t.replace(/kb\(([a-z.\d-]+)\)/gi,(e,o)=>{const i=this.keybindingService.lookupKeybinding(o),s=i?i.getLabel()||"":V;return`<span class="shortcut">${st.escape(s)}</span>`})}decorateContent(){const t=this.content.querySelectorAll(".shortcut[data-command]");Array.prototype.forEach.call(t,o=>{const i=o.getAttribute("data-command"),s=i&&this.keybindingService.lookupKeybinding(i),d=s?s.getLabel()||"":V;for(;o.firstChild;)o.firstChild.remove();o.appendChild(document.createTextNode(d))});const e=this.content.querySelectorAll(".if_shortcut[data-command]");Array.prototype.forEach.call(e,o=>{const i=o.getAttribute("data-command"),s=i&&this.keybindingService.lookupKeybinding(i);o.style.display=s?"":"none"})}multiCursorModifier(){const t=tt.modifierLabels[N],e=this.configurationService.getValue("editor.multiCursorModifier"),o=t[e==="ctrlCmd"?N===it.Macintosh?"metaKey":"ctrlKey":"altKey"],i=this.content.querySelectorAll(".multi-cursor-modifier");Array.prototype.forEach.call(i,s=>{for(;s.firstChild;)s.firstChild.remove();s.appendChild(document.createTextNode(o))})}saveTextEditorViewState(t){const e=this.scrollbar.getScrollPosition();this.editorMemento.saveEditorState(this.group,t,{viewState:{scrollTop:e.scrollTop,scrollLeft:e.scrollLeft}})}loadTextEditorViewState(t){const e=this.editorMemento.loadEditorState(this.group,t);e&&this.scrollbar.setScrollPosition(e.viewState)}clearInput(){this.input instanceof p&&this.saveTextEditorViewState(this.input),this.contentDisposables=k(this.contentDisposables),super.clearInput()}saveState(){this.input instanceof p&&this.saveTextEditorViewState(this.input),super.saveState()}dispose(){this.editorFocus.reset(),this.contentDisposables=k(this.contentDisposables),this.disposables.dispose(),super.dispose()}};m=x([r(1,ft),r(2,vt),r(3,nt),r(4,ht),r(5,ut),r(6,pt),r(7,gt),r(8,ct),r(9,at),r(10,mt),r(11,Et),r(12,bt)],m);export{yt as WALK_THROUGH_FOCUS,m as WalkThroughPart};
