var _=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var L=(d,c,n,e)=>{for(var t=e>1?void 0:e?D(c,n):c,i=d.length-1,s;i>=0;i--)(s=d[i])&&(t=(e?s(c,n,t):s(t))||t);return e&&t&&_(c,n,t),t},o=(d,c)=>(n,e)=>c(n,e,d);import{CancellationToken as y}from"../../../../../vs/base/common/cancellation.js";import*as u from"../../../../../vs/base/common/platform.js";import w from"../../../../../vs/base/common/severity.js";import{localize as x}from"../../../../../vs/nls.js";import{IExtensionGalleryService as k,IExtensionManagementService as U,InstallOperation as M}from"../../../../../vs/platform/extensionManagement/common/extensionManagement.js";import{INotificationService as W,NeverShowAgainScope as K}from"../../../../../vs/platform/notification/common/notification.js";import{IProductService as V}from"../../../../../vs/platform/product/common/productService.js";import{Registry as $}from"../../../../../vs/platform/registry/common/platform.js";import{IStorageService as z,StorageScope as N,StorageTarget as F}from"../../../../../vs/platform/storage/common/storage.js";import{ITelemetryService as Y}from"../../../../../vs/platform/telemetry/common/telemetry.js";import{Extensions as q}from"../../../../../vs/workbench/common/contributions.js";import{ViewContainerLocation as J}from"../../../../../vs/workbench/common/views.js";import{VIEWLET_ID as j}from"../../../../../vs/workbench/contrib/extensions/common/extensions.js";import{BaseLocalizationWorkbenchContribution as B}from"../../../../../vs/workbench/contrib/localization/common/localization.contribution.js";import{minimumTranslatedStrings as P}from"../../../../../vs/workbench/contrib/localization/electron-sandbox/minimalTranslations.js";import{LifecyclePhase as X}from"../../../../../vs/workbench/services/lifecycle/common/lifecycle.js";import{ILocaleService as H}from"../../../../../vs/workbench/services/localization/common/locale.js";import{IPaneCompositePartService as Q}from"../../../../../vs/workbench/services/panecomposite/browser/panecomposite.js";let l=class extends B{constructor(n,e,t,i,s,r,g,v){super();this.notificationService=n;this.localeService=e;this.productService=t;this.storageService=i;this.extensionManagementService=s;this.galleryService=r;this.paneCompositeService=g;this.telemetryService=v;this.checkAndInstall(),this._register(this.extensionManagementService.onDidInstallExtensions(m=>this.onDidInstallExtensions(m))),this._register(this.extensionManagementService.onDidUninstallExtension(m=>this.onDidUninstallExtension(m)))}static LANGUAGEPACK_SUGGESTION_IGNORE_STORAGE_KEY="extensionsAssistant/languagePackSuggestionIgnore";async onDidInstallExtensions(n){for(const e of n)e.operation===M.Install&&e.local&&await this.onDidInstallExtension(e.local,!!e.context?.extensionsSync)}async onDidInstallExtension(n,e){const t=n.manifest.contributes?.localizations?.[0];if(!t||u.language===t.languageId)return;const{languageId:i,languageName:s}=t;this.notificationService.prompt(w.Info,x("updateLocale","Would you like to change {0}'s display language to {1} and restart?",this.productService.nameLong,s||i),[{label:x("changeAndRestart","Change Language and Restart"),run:async()=>{await this.localeService.setLocale({id:i,label:s??i,extensionId:n.identifier.id},!0)}}],{sticky:!0,neverShowAgain:{id:"langugage.update.donotask",isSecondary:!0,scope:K.APPLICATION}})}async onDidUninstallExtension(n){await this.isLocaleInstalled(u.language)||this.localeService.setLocale({id:"en",label:"English"})}async checkAndInstall(){const n=u.language;let e=u.locale??"";const t=JSON.parse(this.storageService.get(l.LANGUAGEPACK_SUGGESTION_IGNORE_STORAGE_KEY,N.APPLICATION,"[]"));if(!this.galleryService.isEnabled()||!n||!e||u.Language.isDefaultVariant()||e.startsWith(n)||t.includes(e)||await this.isLocaleInstalled(e))return;const s=e;let r=await this.galleryService.query({text:`tag:lp-${e}`},y.None);if(r.total===0&&(e=e.split("-")[0],r=await this.galleryService.query({text:`tag:lp-${e}`},y.None),r.total===0))return;const g=r.total===1?r.firstPage[0]:r.firstPage.find(a=>a.publisher==="MS-CEINTL"&&a.name.startsWith("vscode-language-pack")),v=g??r.firstPage[0];if(!v.assets.manifest)return;const[m,T]=await Promise.all([this.galleryService.getManifest(v,y.None),this.galleryService.getCoreTranslation(v,e)]),S=m?.contributes?.localizations?.find(a=>e.startsWith(a.languageId.toLowerCase())),f=S&&S.languageName||e,b=S&&(S.localizedLanguageName||S.languageName)||e,h=T?.contents?.["vs/workbench/contrib/localization/electron-sandbox/minimalTranslations"]??{},A=g?"installAndRestartMessage":"showLanguagePackExtensions",C=!h[A],p={};Object.keys(P).forEach(a=>{!h[a]||C?p[a]=P[a].replace("{0}",()=>f):p[a]=`${h[a].replace("{0}",()=>b)} (${P[a].replace("{0}",()=>f)})`});const I=a=>{this.telemetryService.publicLog("languagePackSuggestion:popup",{userReaction:a,language:e})},R={label:p.searchMarketplace,run:async()=>{I("search");const a=await this.paneCompositeService.openPaneComposite(j,J.Sidebar,!0);if(!a)return;const E=a.getViewPaneContainer();E&&(E.search(`tag:lp-${e}`),E.focus())}},G={label:p.installAndRestart,run:async()=>{I("installAndRestart"),await this.localeService.setLocale({id:e,label:f,extensionId:g?.identifier.id,galleryExtension:g},!0)}},O=p[A];this.notificationService.prompt(w.Info,O,[g?G:R,{label:x("neverAgain","Don't Show Again"),isSecondary:!0,run:()=>{t.push(s),this.storageService.store(l.LANGUAGEPACK_SUGGESTION_IGNORE_STORAGE_KEY,JSON.stringify(t),N.APPLICATION,F.USER),I("neverShowAgain")}}],{onCancel:()=>{I("cancelled")}})}async isLocaleInstalled(n){return(await this.extensionManagementService.getInstalled()).some(t=>!!t.manifest.contributes?.localizations?.length&&t.manifest.contributes.localizations.some(i=>n.startsWith(i.languageId.toLowerCase())))}};l=L([o(0,W),o(1,H),o(2,V),o(3,z),o(4,U),o(5,k),o(6,Q),o(7,Y)],l);const Z=$.as(q.Workbench);Z.registerWorkbenchContribution(l,X.Eventually);
