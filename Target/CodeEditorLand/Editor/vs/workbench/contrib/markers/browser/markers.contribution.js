var q=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var k=(s,r,i,t)=>{for(var a=t>1?void 0:t?$(r,i):r,d=s.length-1,n;d>=0;d--)(n=s[d])&&(a=(t?n(r,i,a):n(a))||a);return t&&a&&q(r,i,a),a},p=(s,r)=>(i,t)=>r(i,t,s);import"./markersFileDecorations.js";import{Codicon as v}from"../../../../base/common/codicons.js";import{KeyCode as u,KeyMod as w}from"../../../../base/common/keyCodes.js";import{Disposable as W,MutableDisposable as U}from"../../../../base/common/lifecycle.js";import{localize as o,localize2 as M}from"../../../../nls.js";import{Categories as H}from"../../../../platform/action/common/actionCommonCategories.js";import{Action2 as P,MenuId as g,registerAction2 as c}from"../../../../platform/actions/common/actions.js";import{IClipboardService as C}from"../../../../platform/clipboard/common/clipboardService.js";import{IConfigurationService as Y}from"../../../../platform/configuration/common/configuration.js";import{Extensions as j}from"../../../../platform/configuration/common/configurationRegistry.js";import{ContextKeyExpr as m}from"../../../../platform/contextkey/common/contextkey.js";import{SyncDescriptor as T}from"../../../../platform/instantiation/common/descriptors.js";import"../../../../platform/instantiation/common/instantiation.js";import{KeybindingsRegistry as h,KeybindingWeight as _}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{IMarkerService as D}from"../../../../platform/markers/common/markers.js";import{Registry as y}from"../../../../platform/registry/common/platform.js";import{registerIcon as z}from"../../../../platform/theme/common/iconRegistry.js";import{viewFilterSubmenu as A}from"../../../browser/parts/views/viewFilter.js";import{ViewAction as I}from"../../../browser/parts/views/viewPane.js";import{ViewPaneContainer as Q}from"../../../browser/parts/views/viewPaneContainer.js";import{problemsConfigurationNodeBase as X}from"../../../common/configuration.js";import{FocusedViewContext as O,getVisbileViewContextKey as x}from"../../../common/contextkeys.js";import{Extensions as J}from"../../../common/contributions.js";import{Extensions as F,ViewContainerLocation as Z}from"../../../common/views.js";import{IActivityService as ee,NumberBadge as re}from"../../../services/activity/common/activity.js";import{LifecyclePhase as N}from"../../../services/lifecycle/common/lifecycle.js";import{IStatusbarService as ie,StatusbarAlignment as L}from"../../../services/statusbar/browser/statusbar.js";import{IViewsService as S}from"../../../services/views/common/viewsService.js";import{Markers as e,MarkersContextKeys as l,MarkersViewMode as V}from"../common/markers.js";import"./markers.js";import{Marker as K,RelatedInformation as se,ResourceMarkers as te}from"./markersModel.js";import{MarkersView as oe}from"./markersView.js";import E from"./messages.js";h.registerCommandAndKeybindingRule({id:e.MARKER_OPEN_ACTION_ID,weight:_.WorkbenchContrib,when:m.and(l.MarkerFocusContextKey),primary:u.Enter,mac:{primary:u.Enter,secondary:[w.CtrlCmd|u.DownArrow]},handler:(s,r)=>{const i=s.get(S).getActiveViewWithId(e.MARKERS_VIEW_ID);i.openFileAtElement(i.getFocusElement(),!1,!1,!0)}}),h.registerCommandAndKeybindingRule({id:e.MARKER_OPEN_SIDE_ACTION_ID,weight:_.WorkbenchContrib,when:m.and(l.MarkerFocusContextKey),primary:w.CtrlCmd|u.Enter,mac:{primary:w.WinCtrl|u.Enter},handler:(s,r)=>{const i=s.get(S).getActiveViewWithId(e.MARKERS_VIEW_ID);i.openFileAtElement(i.getFocusElement(),!1,!0,!0)}}),h.registerCommandAndKeybindingRule({id:e.MARKER_SHOW_PANEL_ID,weight:_.WorkbenchContrib,when:void 0,primary:void 0,handler:async(s,r)=>{await s.get(S).openView(e.MARKERS_VIEW_ID)}}),h.registerCommandAndKeybindingRule({id:e.MARKER_SHOW_QUICK_FIX,weight:_.WorkbenchContrib,when:l.MarkerFocusContextKey,primary:w.CtrlCmd|u.Period,handler:(s,r)=>{const i=s.get(S).getActiveViewWithId(e.MARKERS_VIEW_ID),t=i.getFocusElement();t instanceof K&&i.showQuickFixes(t)}}),y.as(j.Configuration).registerConfiguration({...X,properties:{"problems.autoReveal":{description:E.PROBLEMS_PANEL_CONFIGURATION_AUTO_REVEAL,type:"boolean",default:!0},"problems.defaultViewMode":{description:E.PROBLEMS_PANEL_CONFIGURATION_VIEW_MODE,type:"string",default:"tree",enum:["table","tree"]},"problems.showCurrentInStatus":{description:E.PROBLEMS_PANEL_CONFIGURATION_SHOW_CURRENT_STATUS,type:"boolean",default:!1},"problems.sortOrder":{description:E.PROBLEMS_PANEL_CONFIGURATION_COMPARE_ORDER,type:"string",default:"severity",enum:["severity","position"],enumDescriptions:[E.PROBLEMS_PANEL_CONFIGURATION_COMPARE_ORDER_SEVERITY,E.PROBLEMS_PANEL_CONFIGURATION_COMPARE_ORDER_POSITION]}}});const G=z("markers-view-icon",v.warning,o("markersViewIcon","View icon of the markers view.")),ne=y.as(F.ViewContainersRegistry).registerViewContainer({id:e.MARKERS_CONTAINER_ID,title:E.MARKERS_PANEL_TITLE_PROBLEMS,icon:G,hideIfEmpty:!0,order:0,ctorDescriptor:new T(Q,[e.MARKERS_CONTAINER_ID,{mergeViewWithContainerWhenSingleView:!0}]),storageId:e.MARKERS_VIEW_STORAGE_ID},Z.Panel,{doNotRegisterOpenCommand:!0});y.as(F.ViewsRegistry).registerViews([{id:e.MARKERS_VIEW_ID,containerIcon:G,name:E.MARKERS_PANEL_TITLE_PROBLEMS,canToggleVisibility:!1,canMoveView:!0,ctorDescriptor:new T(oe),openCommandActionDescriptor:{id:"workbench.actions.view.problems",mnemonicTitle:o({key:"miMarker",comment:["&& denotes a mnemonic"]},"&&Problems"),keybindings:{primary:w.CtrlCmd|w.Shift|u.KeyM},order:0}}],ne);const B=y.as(J.Workbench);c(class extends I{constructor(){super({id:`workbench.actions.table.${e.MARKERS_VIEW_ID}.viewAsTree`,title:o("viewAsTree","View as Tree"),menu:{id:g.ViewTitle,when:m.and(m.equals("view",e.MARKERS_VIEW_ID),l.MarkersViewModeContextKey.isEqualTo(V.Table)),group:"navigation",order:3},icon:v.listTree,viewId:e.MARKERS_VIEW_ID})}async runInView(s,r){r.setViewMode(V.Tree)}}),c(class extends I{constructor(){super({id:`workbench.actions.table.${e.MARKERS_VIEW_ID}.viewAsTable`,title:o("viewAsTable","View as Table"),menu:{id:g.ViewTitle,when:m.and(m.equals("view",e.MARKERS_VIEW_ID),l.MarkersViewModeContextKey.isEqualTo(V.Tree)),group:"navigation",order:3},icon:v.listFlat,viewId:e.MARKERS_VIEW_ID})}async runInView(s,r){r.setViewMode(V.Table)}}),c(class extends I{constructor(){super({id:`workbench.actions.${e.MARKERS_VIEW_ID}.toggleErrors`,title:o("show errors","Show Errors"),category:o("problems","Problems"),toggled:l.ShowErrorsFilterContextKey,menu:{id:A,group:"1_filter",when:m.equals("view",e.MARKERS_VIEW_ID),order:1},viewId:e.MARKERS_VIEW_ID})}async runInView(s,r){r.filters.showErrors=!r.filters.showErrors}}),c(class extends I{constructor(){super({id:`workbench.actions.${e.MARKERS_VIEW_ID}.toggleWarnings`,title:o("show warnings","Show Warnings"),category:o("problems","Problems"),toggled:l.ShowWarningsFilterContextKey,menu:{id:A,group:"1_filter",when:m.equals("view",e.MARKERS_VIEW_ID),order:2},viewId:e.MARKERS_VIEW_ID})}async runInView(s,r){r.filters.showWarnings=!r.filters.showWarnings}}),c(class extends I{constructor(){super({id:`workbench.actions.${e.MARKERS_VIEW_ID}.toggleInfos`,title:o("show infos","Show Infos"),category:o("problems","Problems"),toggled:l.ShowInfoFilterContextKey,menu:{id:A,group:"1_filter",when:m.equals("view",e.MARKERS_VIEW_ID),order:3},viewId:e.MARKERS_VIEW_ID})}async runInView(s,r){r.filters.showInfos=!r.filters.showInfos}}),c(class extends I{constructor(){super({id:`workbench.actions.${e.MARKERS_VIEW_ID}.toggleActiveFile`,title:o("show active file","Show Active File Only"),category:o("problems","Problems"),toggled:l.ShowActiveFileFilterContextKey,menu:{id:A,group:"2_filter",when:m.equals("view",e.MARKERS_VIEW_ID),order:1},viewId:e.MARKERS_VIEW_ID})}async runInView(s,r){r.filters.activeFile=!r.filters.activeFile}}),c(class extends I{constructor(){super({id:`workbench.actions.${e.MARKERS_VIEW_ID}.toggleExcludedFiles`,title:o("show excluded files","Show Excluded Files"),category:o("problems","Problems"),toggled:l.ShowExcludedFilesFilterContextKey.negate(),menu:{id:A,group:"2_filter",when:m.equals("view",e.MARKERS_VIEW_ID),order:2},viewId:e.MARKERS_VIEW_ID})}async runInView(s,r){r.filters.excludedFiles=!r.filters.excludedFiles}}),c(class extends P{constructor(){super({id:"workbench.action.problems.focus",title:E.MARKERS_PANEL_SHOW_LABEL,category:H.View,f1:!0})}async run(s){s.get(S).openView(e.MARKERS_VIEW_ID,!0)}}),c(class extends I{constructor(){const s=m.and(O.isEqualTo(e.MARKERS_VIEW_ID),l.MarkersTreeVisibilityContextKey,l.RelatedInformationFocusContextKey.toNegated());super({id:e.MARKER_COPY_ACTION_ID,title:M("copyMarker","Copy"),menu:{id:g.ProblemsPanelContext,when:s,group:"navigation"},keybinding:{weight:_.WorkbenchContrib,primary:w.CtrlCmd|u.KeyC,when:s},viewId:e.MARKERS_VIEW_ID})}async runInView(s,r){const i=s.get(C),t=r.getFocusedSelectedElements()||r.getAllResourceMarkers(),a=[],d=n=>{a.includes(n)||a.push(n)};for(const n of t)n instanceof te?n.markers.forEach(d):n instanceof K&&d(n);a.length&&await i.writeText(`[${a}]`)}}),c(class extends I{constructor(){super({id:e.MARKER_COPY_MESSAGE_ACTION_ID,title:M("copyMessage","Copy Message"),menu:{id:g.ProblemsPanelContext,when:l.MarkerFocusContextKey,group:"navigation"},viewId:e.MARKERS_VIEW_ID})}async runInView(s,r){const i=s.get(C),t=r.getFocusElement();t instanceof K&&await i.writeText(t.marker.message)}}),c(class extends I{constructor(){super({id:e.RELATED_INFORMATION_COPY_MESSAGE_ACTION_ID,title:M("copyMessage","Copy Message"),menu:{id:g.ProblemsPanelContext,when:l.RelatedInformationFocusContextKey,group:"navigation"},viewId:e.MARKERS_VIEW_ID})}async runInView(s,r){const i=s.get(C),t=r.getFocusElement();t instanceof se&&await i.writeText(t.raw.message)}}),c(class extends I{constructor(){super({id:e.FOCUS_PROBLEMS_FROM_FILTER,title:o("focusProblemsList","Focus problems view"),keybinding:{when:l.MarkerViewFilterFocusContextKey,weight:_.WorkbenchContrib,primary:w.CtrlCmd|u.DownArrow},viewId:e.MARKERS_VIEW_ID})}async runInView(s,r){r.focus()}}),c(class extends I{constructor(){super({id:e.MARKERS_VIEW_FOCUS_FILTER,title:o("focusProblemsFilter","Focus problems filter"),keybinding:{when:O.isEqualTo(e.MARKERS_VIEW_ID),weight:_.WorkbenchContrib,primary:w.CtrlCmd|u.KeyF},viewId:e.MARKERS_VIEW_ID})}async runInView(s,r){r.focusFilter()}}),c(class extends I{constructor(){super({id:e.MARKERS_VIEW_SHOW_MULTILINE_MESSAGE,title:M("show multiline","Show message in multiple lines"),category:o("problems","Problems"),menu:{id:g.CommandPalette,when:m.has(x(e.MARKERS_VIEW_ID))},viewId:e.MARKERS_VIEW_ID})}async runInView(s,r){r.setMultiline(!0)}}),c(class extends I{constructor(){super({id:e.MARKERS_VIEW_SHOW_SINGLELINE_MESSAGE,title:M("show singleline","Show message in single line"),category:o("problems","Problems"),menu:{id:g.CommandPalette,when:m.has(x(e.MARKERS_VIEW_ID))},viewId:e.MARKERS_VIEW_ID})}async runInView(s,r){r.setMultiline(!1)}}),c(class extends I{constructor(){super({id:e.MARKERS_VIEW_CLEAR_FILTER_TEXT,title:o("clearFiltersText","Clear filters text"),category:o("problems","Problems"),keybinding:{when:l.MarkerViewFilterFocusContextKey,weight:_.WorkbenchContrib,primary:u.Escape},viewId:e.MARKERS_VIEW_ID})}async runInView(s,r){r.clearFilterText()}}),c(class extends I{constructor(){super({id:`workbench.actions.treeView.${e.MARKERS_VIEW_ID}.collapseAll`,title:o("collapseAll","Collapse All"),menu:{id:g.ViewTitle,when:m.and(m.equals("view",e.MARKERS_VIEW_ID),l.MarkersViewModeContextKey.isEqualTo(V.Tree)),group:"navigation",order:2},icon:v.collapseAll,viewId:e.MARKERS_VIEW_ID})}async runInView(s,r){return r.collapseAll()}}),c(class extends P{constructor(){super({id:e.TOGGLE_MARKERS_VIEW_ACTION_ID,title:E.MARKERS_PANEL_TOGGLE_LABEL})}async run(s){const r=s.get(S);r.isViewVisible(e.MARKERS_VIEW_ID)?r.closeView(e.MARKERS_VIEW_ID):r.openView(e.MARKERS_VIEW_ID,!0)}});let b=class extends W{constructor(i,t,a){super();this.markerService=i;this.statusbarService=t;this.configurationService=a;this.markersStatusItem=this._register(this.statusbarService.addEntry(this.getMarkersItem(),"status.problems",L.LEFT,50));const d=()=>{this.markersStatusItemOff=this.statusbarService.addEntry(this.getMarkersItemTurnedOff(),"status.problemsVisibility",L.LEFT,49)};let n=this.configurationService.getValue("problems.visibility");n||d(),this._register(this.markerService.onMarkerChanged(()=>{this.markersStatusItem.update(this.getMarkersItem())})),this._register(this.configurationService.onDidChangeConfiguration(R=>{R.affectsConfiguration("problems.visibility")&&(this.markersStatusItem.update(this.getMarkersItem()),n=this.configurationService.getValue("problems.visibility"),!n&&!this.markersStatusItemOff?d():n&&this.markersStatusItemOff&&(this.markersStatusItemOff.dispose(),this.markersStatusItemOff=void 0))}))}markersStatusItem;markersStatusItemOff;getMarkersItem(){const i=this.markerService.getStatistics(),t=this.getMarkersTooltip(i);return{name:o("status.problems","Problems"),text:this.getMarkersText(i),ariaLabel:t,tooltip:t,command:"workbench.actions.view.toggleProblems"}}getMarkersItemTurnedOff(){this.statusbarService.updateEntryVisibility("status.problemsVisibility",!0);const i="workbench.action.openSettings",t="@id:problems.visibility",a=o("status.problemsVisibilityOff","Problems are turned off. Click to open settings.");return{name:o("status.problemsVisibility","Problems Visibility"),text:"$(whole-word)",ariaLabel:a,tooltip:a,kind:"warning",command:{title:i,arguments:[t],id:i}}}getMarkersTooltip(i){const t=R=>o("totalErrors","Errors: {0}",R),a=R=>o("totalWarnings","Warnings: {0}",R),d=R=>o("totalInfos","Infos: {0}",R),n=[];return i.errors>0&&n.push(t(i.errors)),i.warnings>0&&n.push(a(i.warnings)),i.infos>0&&n.push(d(i.infos)),n.length===0?o("noProblems","No Problems"):n.join(", ")}getMarkersText(i){const t=[];return t.push("$(error) "+this.packNumber(i.errors)),t.push("$(warning) "+this.packNumber(i.warnings)),i.infos>0&&t.push("$(info) "+this.packNumber(i.infos)),t.join(" ")}packNumber(i){const t=o("manyProblems","10K+");return i>9999?t:i>999?i.toString().charAt(0)+"K":i.toString()}};b=k([p(0,D),p(1,ie),p(2,Y)],b),B.registerWorkbenchContribution(b,N.Restored);let f=class extends W{constructor(i,t){super();this.activityService=i;this.markerService=t;this._register(this.markerService.onMarkerChanged(()=>this.updateBadge())),this.updateBadge()}activity=this._register(new U);updateBadge(){const{errors:i,warnings:t,infos:a}=this.markerService.getStatistics(),d=i+t+a;if(d>0){const n=o("totalProblems","Total {0} Problems",d);this.activity.value=this.activityService.showViewActivity(e.MARKERS_VIEW_ID,{badge:new re(d,()=>n)})}else this.activity.value=void 0}};f=k([p(0,ee),p(1,D)],f),B.registerWorkbenchContribution(f,N.Restored);
