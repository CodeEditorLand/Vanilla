var z=Object.defineProperty;var J=Object.getOwnPropertyDescriptor;var p=(c,r,e,t)=>{for(var i=t>1?void 0:t?J(r,e):r,s=c.length-1,a;s>=0;s--)(a=c[s])&&(i=(t?a(r,e,i):a(i))||i);return t&&i&&z(r,e,i),i},d=(c,r)=>(e,t)=>r(e,t,c);import*as o from"../../../../base/browser/dom.js";import{ActionBar as y}from"../../../../base/browser/ui/actionbar/actionbar.js";import{ActionViewItem as X}from"../../../../base/browser/ui/actionbar/actionViewItems.js";import{CountBadge as Y}from"../../../../base/browser/ui/countBadge/countBadge.js";import{HighlightedLabel as h}from"../../../../base/browser/ui/highlightedlabel/highlightedLabel.js";import{getDefaultHoverDelegate as Z}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import"../../../../base/browser/ui/list/list.js";import"../../../../base/browser/ui/list/listWidget.js";import{TreeVisibility as f}from"../../../../base/browser/ui/tree/tree.js";import{Action as L}from"../../../../base/common/actions.js";import{createCancelablePromise as V,Delayer as ee}from"../../../../base/common/async.js";import{Codicon as P}from"../../../../base/common/codicons.js";import{Emitter as F}from"../../../../base/common/event.js";import"../../../../base/common/filters.js";import{Disposable as E,DisposableStore as N,dispose as H,toDisposable as $}from"../../../../base/common/lifecycle.js";import*as K from"../../../../base/common/path.js";import{basename as D,isEqual as te}from"../../../../base/common/resources.js";import re from"../../../../base/common/severity.js";import{ThemeIcon as O}from"../../../../base/common/themables.js";import{isUndefinedOrNull as ie}from"../../../../base/common/types.js";import"../../../../base/common/uri.js";import{Range as se}from"../../../../editor/common/core/range.js";import{CodeActionTriggerType as oe}from"../../../../editor/common/languages.js";import"../../../../editor/common/model.js";import{ILanguageFeaturesService as ae}from"../../../../editor/common/services/languageFeatures.js";import{IModelService as ne}from"../../../../editor/common/services/model.js";import{applyCodeAction as le,ApplyCodeActionReason as ce,getCodeActions as de}from"../../../../editor/contrib/codeAction/browser/codeAction.js";import{CodeActionKind as ue,CodeActionTriggerSource as me}from"../../../../editor/contrib/codeAction/common/types.js";import{localize as g}from"../../../../nls.js";import{IContextKeyService as pe}from"../../../../platform/contextkey/common/contextkey.js";import{IHoverService as he}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as C}from"../../../../platform/instantiation/common/instantiation.js";import{ILabelService as B}from"../../../../platform/label/common/label.js";import{MarkerSeverity as k}from"../../../../platform/markers/common/markers.js";import{unsupportedSchemas as Me}from"../../../../platform/markers/common/markerService.js";import{Link as ve}from"../../../../platform/opener/browser/link.js";import{IOpenerService as fe}from"../../../../platform/opener/common/opener.js";import{Progress as ge}from"../../../../platform/progress/common/progress.js";import{SeverityIcon as ke}from"../../../../platform/severityIcon/browser/severityIcon.js";import{defaultCountBadgeStyles as Ie}from"../../../../platform/theme/browser/defaultStyles.js";import{registerIcon as U}from"../../../../platform/theme/common/iconRegistry.js";import"../../../browser/labels.js";import{ACTIVE_GROUP as be,IEditorService as we}from"../../../services/editor/common/editorService.js";import{MarkersContextKeys as Re,MarkersViewMode as q}from"../common/markers.js";import{FilterOptions as M}from"./markersFilterOptions.js";import{Marker as w,MarkerTableItem as xe,RelatedInformation as Ae,ResourceMarkers as _}from"./markersModel.js";import{QuickFixAction as Q,QuickFixActionViewItem as Se}from"./markersViewActions.js";import I from"./messages.js";let R=class{constructor(r){this.labelService=r}getWidgetAriaLabel(){return g("problemsView","Problems View")}getAriaLabel(r){if(r instanceof _){const e=this.labelService.getUriLabel(r.resource,{relative:!0})||r.resource.fsPath;return I.MARKERS_TREE_ARIA_LABEL_RESOURCE(r.markers.length,r.name,K.dirname(e))}return r instanceof w||r instanceof xe?I.MARKERS_TREE_ARIA_LABEL_MARKER(r):r instanceof Ae?I.MARKERS_TREE_ARIA_LABEL_RELATED_INFORMATION(r.raw):null}};R=p([d(0,B)],R);var Te=(t=>(t.ResourceMarkers="rm",t.Marker="m",t.RelatedInformation="ri",t))(Te||{});class T{constructor(r){this.markersViewState=r}static LINE_HEIGHT=22;getHeight(r){if(r instanceof w){const e=this.markersViewState.getViewModel(r);return(!e||e.multiline?r.lines.length:1)*T.LINE_HEIGHT}return T.LINE_HEIGHT}getTemplateId(r){return r instanceof _?"rm":r instanceof w?"m":"ri"}}var Fe=(t=>(t[t.ResourceMarkers=0]="ResourceMarkers",t[t.Marker=1]="Marker",t[t.RelatedInformation=2]="RelatedInformation",t))(Fe||{});class Ee{constructor(r,e){this.labels=r;e(this.onDidChangeRenderNodeCount,this,this.disposables)}renderedNodes=new Map;disposables=new N;templateId="rm";renderTemplate(r){const e=o.append(r,o.$(".resource-label-container")),t=this.labels.create(e,{supportHighlights:!0}),i=o.append(r,o.$(".count-badge-wrapper"));return{count:new Y(i,{},Ie),resourceLabel:t}}renderElement(r,e,t){const i=r.element,s=r.filterData&&r.filterData.uriMatches||[];t.resourceLabel.setFile(i.resource,{matches:s}),this.updateCount(r,t);const a=this.renderedNodes.get(i)??[];this.renderedNodes.set(i,[...a,t])}disposeElement(r,e,t){const i=this.renderedNodes.get(r.element)??[],s=i.findIndex(a=>t===a);if(s<0)throw new Error("Disposing unknown resource marker");i.length===1?this.renderedNodes.delete(r.element):i.splice(s,1)}disposeTemplate(r){r.resourceLabel.dispose()}onDidChangeRenderNodeCount(r){const e=this.renderedNodes.get(r.element);e&&e.forEach(t=>this.updateCount(r,t))}updateCount(r,e){e.count.setCount(r.children.reduce((t,i)=>t+(i.visible?1:0),0))}dispose(){this.disposables.dispose()}}class Wt extends Ee{}let x=class{constructor(r,e,t,i){this.markersViewState=r;this.hoverService=e;this.instantiationService=t;this.openerService=i}templateId="m";renderTemplate(r){const e=Object.create(null);return e.markerWidget=new _e(r,this.markersViewState,this.hoverService,this.openerService,this.instantiationService),e}renderElement(r,e,t){t.markerWidget.render(r.element,r.filterData)}disposeTemplate(r){r.markerWidget.dispose()}};x=p([d(1,he),d(2,C),d(3,fe)],x);const W=U("markers-view-multi-line-expanded",P.chevronUp,g("expandedIcon","Icon indicating that multiple lines are shown in the markers view.")),De=U("markers-view-multi-line-collapsed",P.chevronDown,g("collapsedIcon","Icon indicating that multiple lines are collapsed in the markers view.")),G="problems.action.toggleMultiline";class Ce extends X{render(r){super.render(r),this.updateExpandedAttribute()}updateClass(){super.updateClass(),this.updateExpandedAttribute()}updateExpandedAttribute(){this.element?.setAttribute("aria-expanded",`${this._action.class===O.asClassName(W)}`)}}class _e extends E{constructor(e,t,i,s,a){super();this.parent=e;this.markersViewModel=t;this._hoverService=i;this._openerService=s;this.actionBar=this._register(new y(o.append(e,o.$(".actions")),{actionViewItemProvider:(n,l)=>n.id===Q.ID?a.createInstance(Se,n,l):void 0})),this.iconContainer=o.append(e,o.$("")),this.icon=o.append(this.iconContainer,o.$("")),this.messageAndDetailsContainer=o.append(e,o.$(".marker-message-details-container")),this.messageAndDetailsContainerHover=this._register(this._hoverService.setupManagedHover(Z("mouse"),this.messageAndDetailsContainer,""))}actionBar;icon;iconContainer;messageAndDetailsContainer;messageAndDetailsContainerHover;disposables=this._register(new N);render(e,t){this.actionBar.clear(),this.disposables.clear(),o.clearNode(this.messageAndDetailsContainer),this.iconContainer.className=`marker-icon ${re.toString(k.toSeverity(e.marker.severity))}`,this.icon.className=`codicon ${ke.className(k.toSeverity(e.marker.severity))}`,this.renderQuickfixActionbar(e),this.renderMessageAndDetails(e,t),this.disposables.add(o.addDisposableListener(this.parent,o.EventType.MOUSE_OVER,()=>this.markersViewModel.onMarkerMouseHover(e))),this.disposables.add(o.addDisposableListener(this.parent,o.EventType.MOUSE_LEAVE,()=>this.markersViewModel.onMarkerMouseLeave(e)))}renderQuickfixActionbar(e){const t=this.markersViewModel.getViewModel(e);if(t){const i=t.quickFixAction;this.actionBar.push([i],{icon:!0,label:!1}),this.iconContainer.classList.toggle("quickFix",i.enabled),i.onDidChange(({enabled:s})=>{ie(s)||this.iconContainer.classList.toggle("quickFix",s)},this,this.disposables),i.onShowQuickFixes(()=>{const s=this.actionBar.viewItems[0];s&&s.showQuickFixes()},this,this.disposables)}}renderMultilineActionbar(e,t){const i=this.disposables.add(new y(o.append(t,o.$(".multiline-actions")),{actionViewItemProvider:(l,u)=>{if(l.id===G)return new Ce(void 0,l,{...u,icon:!0})}}));this.disposables.add($(()=>i.dispose()));const s=this.markersViewModel.getViewModel(e),a=s&&s.multiline,n=new L(G);n.enabled=!!s&&e.lines.length>1,n.tooltip=a?g("single line","Show message in single line"):g("multi line","Show message in multiple lines"),n.class=O.asClassName(a?W:De),n.run=()=>(s&&(s.multiline=!s.multiline),Promise.resolve()),i.push([n],{icon:!0,label:!1})}renderMessageAndDetails(e,t){const{marker:i,lines:s}=e,a=this.markersViewModel.getViewModel(e),n=!a||a.multiline,l=t&&t.lineMatches||[];this.messageAndDetailsContainerHover.update(e.marker.message);const u=[];for(let m=0;m<(n?s.length:1);m++){const v=o.append(this.messageAndDetailsContainer,o.$(".marker-message-line")),j=o.append(v,o.$(".marker-message"));this.disposables.add(new h(j)).set(s[m].length>1e3?`${s[m].substring(0,1e3)}...`:s[m],l[m]),s[m]===""&&(v.style.height=`${T.LINE_HEIGHT}px`),u.push(v)}this.renderDetails(i,t,u[0]),this.renderMultilineActionbar(e,u[0])}renderDetails(e,t,i){if(i.classList.add("details-container"),e.source||e.code){const a=this.disposables.add(new h(o.append(i,o.$(".marker-source")))),n=t&&t.sourceMatches||[];if(a.set(e.source,n),e.code)if(typeof e.code=="string"){const l=this.disposables.add(new h(o.append(i,o.$(".marker-code")))),u=t&&t.codeMatches||[];l.set(e.code,u)}else{const l=o.$(".marker-code"),u=this.disposables.add(new h(l)),m=e.code.target.toString(!0);this.disposables.add(new ve(i,{href:m,label:l,title:m},void 0,this._hoverService,this._openerService));const v=t&&t.codeMatches||[];u.set(e.code.value,v)}}const s=o.append(i,o.$("span.marker-line"));s.textContent=I.MARKERS_PANEL_AT_LINE_COL_NUMBER(e.startLineNumber,e.startColumn)}}let A=class{constructor(r){this.labelService=r}templateId="ri";renderTemplate(r){const e=Object.create(null);o.append(r,o.$(".actions")),o.append(r,o.$(".icon")),e.resourceLabel=new h(o.append(r,o.$(".related-info-resource"))),e.lnCol=o.append(r,o.$("span.marker-line"));const t=o.append(r,o.$("span.related-info-resource-separator"));return t.textContent=":",t.style.paddingRight="4px",e.description=new h(o.append(r,o.$(".marker-description"))),e}renderElement(r,e,t){const i=r.element.raw,s=r.filterData&&r.filterData.uriMatches||[],a=r.filterData&&r.filterData.messageMatches||[],n=this.labelService.getUriLabel(i.resource,{relative:!0});t.resourceLabel.set(D(i.resource),s,n),t.lnCol.textContent=I.MARKERS_PANEL_AT_LINE_COL_NUMBER(i.startLineNumber,i.startColumn),t.description.set(i.message,a,i.message)}disposeTemplate(r){r.resourceLabel.dispose(),r.description.dispose()}};A=p([d(0,B)],A);class Gt{constructor(r){this.options=r}filter(r,e){return r instanceof _?this.filterResourceMarkers(r):r instanceof w?this.filterMarker(r,e):this.filterRelatedInformation(r,e)}filterResourceMarkers(r){if(Me.has(r.resource.scheme)||this.options.excludesMatcher.matches(r.resource))return!1;if(this.options.includesMatcher.matches(r.resource))return!0;if(this.options.textFilter.text&&!this.options.textFilter.negate){const e=M._filter(this.options.textFilter.text,D(r.resource));if(e)return{visibility:!0,data:{type:0,uriMatches:e||[]}}}return f.Recurse}filterMarker(r,e){if(!(this.options.showErrors&&k.Error===r.marker.severity||this.options.showWarnings&&k.Warning===r.marker.severity||this.options.showInfos&&k.Info===r.marker.severity))return!1;if(!this.options.textFilter.text)return!0;const i=[];for(const l of r.lines){const u=M._messageFilter(this.options.textFilter.text,l);i.push(u||[])}const s=r.marker.source?M._filter(this.options.textFilter.text,r.marker.source):void 0,a=r.marker.code?M._filter(this.options.textFilter.text,typeof r.marker.code=="string"?r.marker.code:r.marker.code.value):void 0,n=s||a||i.some(l=>l.length>0);return n&&!this.options.textFilter.negate?{visibility:!0,data:{type:1,lineMatches:i,sourceMatches:s||[],codeMatches:a||[]}}:n&&this.options.textFilter.negate&&e===f.Recurse?!1:!n&&this.options.textFilter.negate&&e===f.Recurse?!0:e}filterRelatedInformation(r,e){if(!this.options.textFilter.text)return!0;const t=M._filter(this.options.textFilter.text,D(r.raw.resource)),i=M._messageFilter(this.options.textFilter.text,K.basename(r.raw.message)),s=t||i;return s&&!this.options.textFilter.negate?{visibility:!0,data:{type:2,uriMatches:t||[],messageMatches:i||[]}}:s&&this.options.textFilter.negate&&e===f.Recurse?!1:!s&&this.options.textFilter.negate&&e===f.Recurse?!0:e}}let b=class extends E{constructor(e,t,i,s,a){super();this.marker=e;this.modelService=t;this.instantiationService=i;this.editorService=s;this.languageFeaturesService=a;this._register($(()=>{this.modelPromise&&this.modelPromise.cancel(),this.codeActionsPromise&&this.codeActionsPromise.cancel()}))}_onDidChange=this._register(new F);onDidChange=this._onDidChange.event;modelPromise=null;codeActionsPromise=null;_multiline=!0;get multiline(){return this._multiline}set multiline(e){this._multiline!==e&&(this._multiline=e,this._onDidChange.fire())}_quickFixAction=null;get quickFixAction(){return this._quickFixAction||(this._quickFixAction=this._register(this.instantiationService.createInstance(Q,this.marker))),this._quickFixAction}showLightBulb(){this.setQuickFixes(!0)}async setQuickFixes(e){const t=await this.getCodeActions(e);this.quickFixAction.quickFixes=t?this.toActions(t):[],this.quickFixAction.autoFixable(!!t&&t.hasAutoFix)}getCodeActions(e){return this.codeActionsPromise!==null?this.codeActionsPromise:this.getModel(e).then(t=>t?(this.codeActionsPromise||(this.codeActionsPromise=V(i=>de(this.languageFeaturesService.codeActionProvider,t,new se(this.marker.range.startLineNumber,this.marker.range.startColumn,this.marker.range.endLineNumber,this.marker.range.endColumn),{type:oe.Invoke,triggerAction:me.ProblemsView,filter:{include:ue.QuickFix}},ge.None,i).then(s=>this._register(s)))),this.codeActionsPromise):null)}toActions(e){return e.validActions.map(t=>new L(t.action.command?t.action.command.id:t.action.title,t.action.title,void 0,!0,()=>this.openFileAtMarker(this.marker).then(()=>this.instantiationService.invokeFunction(le,t,ce.FromProblemsView))))}openFileAtMarker(e){const{resource:t,selection:i}={resource:e.resource,selection:e.range};return this.editorService.openEditor({resource:t,options:{selection:i,preserveFocus:!0,pinned:!1,revealIfVisible:!0}},be).then(()=>{})}getModel(e){const t=this.modelService.getModel(this.marker.resource);return t?Promise.resolve(t):e?(this.modelPromise||(this.modelPromise=V(i=>new Promise(s=>{this._register(this.modelService.onModelAdded(a=>{te(a.uri,this.marker.resource)&&s(a)}))}))),this.modelPromise):Promise.resolve(null)}};b=p([d(1,ne),d(2,C),d(3,we),d(4,ae)],b);let S=class extends E{constructor(e=!0,t=q.Tree,i,s){super();this.contextKeyService=i;this.instantiationService=s;this._multiline=e,this._viewMode=t,this.viewModeContextKey=Re.MarkersViewModeContextKey.bindTo(this.contextKeyService),this.viewModeContextKey.set(t)}_onDidChange=this._register(new F);onDidChange=this._onDidChange.event;_onDidChangeViewMode=this._register(new F);onDidChangeViewMode=this._onDidChangeViewMode.event;markersViewStates=new Map;markersPerResource=new Map;bulkUpdate=!1;hoveredMarker=null;hoverDelayer=new ee(300);viewModeContextKey;add(e){if(!this.markersViewStates.has(e.id)){const t=this.instantiationService.createInstance(b,e),i=[t];t.multiline=this.multiline,t.onDidChange(()=>{this.bulkUpdate||this._onDidChange.fire(e)},this,i),this.markersViewStates.set(e.id,{viewModel:t,disposables:i});const s=this.markersPerResource.get(e.resource.toString())||[];s.push(e),this.markersPerResource.set(e.resource.toString(),s)}}remove(e){const t=this.markersPerResource.get(e.toString())||[];for(const i of t){const s=this.markersViewStates.get(i.id);s&&H(s.disposables),this.markersViewStates.delete(i.id),this.hoveredMarker===i&&(this.hoveredMarker=null)}this.markersPerResource.delete(e.toString())}getViewModel(e){const t=this.markersViewStates.get(e.id);return t?t.viewModel:null}onMarkerMouseHover(e){this.hoveredMarker=e,this.hoverDelayer.trigger(()=>{if(this.hoveredMarker){const t=this.getViewModel(this.hoveredMarker);t&&t.showLightBulb()}})}onMarkerMouseLeave(e){this.hoveredMarker===e&&(this.hoveredMarker=null)}_multiline=!0;get multiline(){return this._multiline}set multiline(e){let t=!1;this._multiline!==e&&(this._multiline=e,t=!0),this.bulkUpdate=!0,this.markersViewStates.forEach(({viewModel:i})=>{i.multiline!==e&&(i.multiline=e,t=!0)}),this.bulkUpdate=!1,t&&this._onDidChange.fire(void 0)}_viewMode=q.Tree;get viewMode(){return this._viewMode}set viewMode(e){this._viewMode!==e&&(this._viewMode=e,this._onDidChangeViewMode.fire(e),this.viewModeContextKey.set(e))}dispose(){this.markersViewStates.forEach(({disposables:e})=>H(e)),this.markersViewStates.clear(),this.markersPerResource.clear(),super.dispose()}};S=p([d(2,pe),d(3,C)],S);export{Wt as FileResourceMarkersRenderer,Gt as Filter,x as MarkerRenderer,b as MarkerViewModel,S as MarkersViewModel,R as MarkersWidgetAccessibilityProvider,A as RelatedInformationRenderer,Ee as ResourceMarkersRenderer,T as VirtualDelegate};
