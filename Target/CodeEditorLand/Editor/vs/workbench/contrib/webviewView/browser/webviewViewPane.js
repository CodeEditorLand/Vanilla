var D=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var l=(w,a,e,i)=>{for(var s=i>1?void 0:i?T(a,e):a,r=w.length-1,o;r>=0;r--)(o=w[r])&&(s=(i?o(a,e,s):o(s))||s);return i&&s&&D(a,e,s),s},t=(w,a)=>(e,i)=>a(e,i,w);import{addDisposableListener as V,Dimension as E,EventType as d,findParentWithClass as C,getWindow as h}from"../../../../base/browser/dom.js";import{CancellationTokenSource as O}from"../../../../base/common/cancellation.js";import{Emitter as c}from"../../../../base/common/event.js";import{DisposableStore as W,MutableDisposable as m,toDisposable as b}from"../../../../base/common/lifecycle.js";import{MenuId as x}from"../../../../platform/actions/common/actions.js";import{IConfigurationService as M}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as B}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as R}from"../../../../platform/contextview/browser/contextView.js";import"../../../../platform/extensions/common/extensions.js";import{IInstantiationService as A}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as L}from"../../../../platform/keybinding/common/keybinding.js";import{IOpenerService as K}from"../../../../platform/opener/common/opener.js";import{IProgressService as P}from"../../../../platform/progress/common/progress.js";import{IStorageService as H,StorageScope as z,StorageTarget as G}from"../../../../platform/storage/common/storage.js";import{ITelemetryService as N}from"../../../../platform/telemetry/common/telemetry.js";import{IThemeService as j}from"../../../../platform/theme/common/themeService.js";import{ViewPane as k,ViewPaneShowActions as $}from"../../../browser/parts/views/viewPane.js";import"../../../browser/parts/views/viewsViewlet.js";import{Memento as U}from"../../../common/memento.js";import{IViewDescriptorService as q}from"../../../common/views.js";import{IViewsService as F}from"../../../services/views/common/viewsService.js";import{ExtensionKeyedWebviewOriginStore as J,IWebviewService as Q,WebviewContentPurpose as X}from"../../webview/browser/webview.js";import{WebviewWindowDragMonitor as Y}from"../../webview/browser/webviewWindowDragMonitor.js";import{IWebviewViewService as Z}from"./webviewViewService.js";import{IActivityService as ee,NumberBadge as ie}from"../../../services/activity/common/activity.js";import{IExtensionService as te}from"../../../services/extensions/common/extensions.js";import{IHoverService as re}from"../../../../platform/hover/browser/hover.js";const p={webviewState:"webviewState"};let v=class extends k{constructor(e,i,s,r,o,n,u,S,y,f,g,oe,se,ne,_,ae,ve,de){super({...e,titleMenuId:x.ViewTitle,showActions:$.WhenExpanded},n,r,i,s,g,o,u,f,S,y);this.activityService=oe;this.extensionService=se;this.progressService=ne;this.storageService=_;this.viewService=ae;this.webviewService=ve;this.webviewViewService=de;this.extensionId=e.fromExtensionId,this.defaultTitle=this.title,this.memento=new U(`webviewView.${this.id}`,_),this.viewState=this.memento.getMemento(z.WORKSPACE,G.MACHINE),this._register(this.onDidChangeBodyVisibility(()=>this.updateTreeVisibility())),this._register(this.webviewViewService.onNewResolverRegistered(I=>{I.viewType===this.id&&this.updateTreeVisibility()})),this.updateTreeVisibility()}static _originStore;static getOriginStore(e){return this._originStore??=new J("webviewViews.origins",e),this._originStore}_webview=this._register(new m);_webviewDisposables=this._register(new W);_activated=!1;_container;_rootContainer;_resizeObserver;defaultTitle;setTitle;badge;activity=this._register(new m);memento;viewState;extensionId;_repositionTimeout;_onDidChangeVisibility=this._register(new c);onDidChangeVisibility=this._onDidChangeVisibility.event;_onDispose=this._register(new c);onDispose=this._onDispose.event;dispose(){this._onDispose.fire(),clearTimeout(this._repositionTimeout),super.dispose()}focus(){super.focus(),this._webview.value?.focus()}renderBody(e){super.renderBody(e),this._container=e,this._rootContainer=void 0,this._resizeObserver||(this._resizeObserver=new ResizeObserver(()=>{setTimeout(()=>{this.layoutWebview()},0)}),this._register(b(()=>{this._resizeObserver.disconnect()})),this._resizeObserver.observe(e))}saveState(){this._webview.value&&(this.viewState[p.webviewState]=this._webview.value.state),this.memento.saveMemento(),super.saveState()}layoutBody(e,i){super.layoutBody(e,i),this.layoutWebview(new E(i,e))}updateTreeVisibility(){this.isBodyVisible()?(this.activate(),this._webview.value?.claim(this,h(this.element),void 0)):this._webview.value?.release(this)}activate(){if(this._activated)return;this._activated=!0;const e=this.extensionId?v.getOriginStore(this.storageService).getOrigin(this.id,this.extensionId):void 0,i=this.webviewService.createWebviewOverlay({origin:e,providedViewType:this.id,title:this.title,options:{purpose:X.WebviewView},contentOptions:{},extension:this.extensionId?{id:this.extensionId}:void 0});i.state=this.viewState[p.webviewState],this._webview.value=i,this._container&&this.layoutWebview(),this._webviewDisposables.add(b(()=>{this._webview.value?.release(this)})),this._webviewDisposables.add(i.onDidUpdateState(()=>{this.viewState[p.webviewState]=i.state}));for(const r of[d.DRAG,d.DRAG_END,d.DRAG_ENTER,d.DRAG_LEAVE,d.DRAG_START])this._webviewDisposables.add(V(this._webview.value.container,r,o=>{o.preventDefault(),o.stopImmediatePropagation(),this.dropTargetElement.dispatchEvent(new DragEvent(o.type,o))}));this._webviewDisposables.add(new Y(h(this.element),()=>this._webview.value));const s=this._webviewDisposables.add(new O);this.withProgress(async()=>{await this.extensionService.activateByEvent(`onView:${this.id}`);const r=this,o={webview:i,onDidChangeVisibility:this.onDidChangeBodyVisibility,onDispose:this.onDispose,get title(){return r.setTitle},set title(n){r.updateTitle(n)},get description(){return r.titleDescription},set description(n){r.updateTitleDescription(n)},get badge(){return r.badge},set badge(n){r.updateBadge(n)},dispose:()=>{this._activated=!1,this._webview.clear(),this._webviewDisposables.clear()},show:n=>{this.viewService.openView(this.id,!n)}};await this.webviewViewService.resolve(this.id,o,s.token)})}updateTitle(e){this.setTitle=e,super.updateTitle(typeof e=="string"?e:this.defaultTitle)}updateBadge(e){if(!(this.badge?.value===e?.value&&this.badge?.tooltip===e?.tooltip)&&(this.badge=e,e)){const i={badge:new ie(e.value,()=>e.tooltip),priority:150};this.activity.value=this.activityService.showViewActivity(this.id,i)}}async withProgress(e){return this.progressService.withProgress({location:this.id,delay:500},e)}onDidScrollRoot(){this.layoutWebview()}doLayoutWebview(e){const i=this._webview.value;!this._container||!i||((!this._rootContainer||!this._rootContainer.isConnected)&&(this._rootContainer=this.findRootContainer(this._container)),i.layoutWebviewOverElement(this._container,e,this._rootContainer))}layoutWebview(e){this.doLayoutWebview(e),clearTimeout(this._repositionTimeout),this._repositionTimeout=setTimeout(()=>this.doLayoutWebview(e),200)}findRootContainer(e){return C(e,"monaco-scrollable-element")??void 0}};v=l([t(1,M),t(2,B),t(3,R),t(4,A),t(5,L),t(6,K),t(7,N),t(8,re),t(9,j),t(10,q),t(11,ee),t(12,te),t(13,P),t(14,H),t(15,F),t(16,Q),t(17,Z)],v);export{v as WebviewViewPane};
