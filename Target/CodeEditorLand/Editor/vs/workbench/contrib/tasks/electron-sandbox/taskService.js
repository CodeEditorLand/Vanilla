var G=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var f=(m,r,i,t)=>{for(var o=t>1?void 0:t?K(r,i):r,n=m.length-1,s;n>=0;n--)(s=m[n])&&(o=(t?s(r,i,o):s(o))||o);return t&&o&&G(r,i,o),o},e=(m,r)=>(i,t)=>r(i,t,m);import{TerminateResponseCode as Q}from"../../../../base/common/processes.js";import*as v from"../../../../base/common/semver/semver.js";import{IModelService as H}from"../../../../editor/common/services/model.js";import{ITextModelService as J}from"../../../../editor/common/services/resolverService.js";import*as c from"../../../../nls.js";import{IAccessibilitySignalService as U}from"../../../../platform/accessibilitySignal/browser/accessibilitySignalService.js";import{ICommandService as X}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as Y}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as Z}from"../../../../platform/contextkey/common/contextkey.js";import{IDialogService as $}from"../../../../platform/dialogs/common/dialogs.js";import{IFileService as ee}from"../../../../platform/files/common/files.js";import{InstantiationType as re,registerSingleton as ie}from"../../../../platform/instantiation/common/extensions.js";import{IInstantiationService as te}from"../../../../platform/instantiation/common/instantiation.js";import{ILogService as oe}from"../../../../platform/log/common/log.js";import{IMarkerService as se}from"../../../../platform/markers/common/markers.js";import{INotificationService as ne}from"../../../../platform/notification/common/notification.js";import{IOpenerService as me}from"../../../../platform/opener/common/opener.js";import{IProgressService as ae}from"../../../../platform/progress/common/progress.js";import{IQuickInputService as ce}from"../../../../platform/quickinput/common/quickInput.js";import{IStorageService as Se}from"../../../../platform/storage/common/storage.js";import{ITelemetryService as fe}from"../../../../platform/telemetry/common/telemetry.js";import{IThemeService as ve}from"../../../../platform/theme/common/themeService.js";import{IWorkspaceContextService as pe}from"../../../../platform/workspace/common/workspace.js";import{IWorkspaceTrustManagementService as Ie,IWorkspaceTrustRequestService as ue}from"../../../../platform/workspace/common/workspaceTrust.js";import{IViewDescriptorService as le}from"../../../common/views.js";import{IConfigurationResolverService as de}from"../../../services/configurationResolver/common/configurationResolver.js";import{IEditorService as ke}from"../../../services/editor/common/editorService.js";import{IWorkbenchEnvironmentService as ge}from"../../../services/environment/common/environmentService.js";import{IExtensionService as ye}from"../../../services/extensions/common/extensions.js";import{ILifecycleService as he}from"../../../services/lifecycle/common/lifecycle.js";import{IOutputService as Te}from"../../../services/output/common/output.js";import{IPaneCompositePartService as Ce}from"../../../services/panecomposite/browser/panecomposite.js";import{IPathService as Pe}from"../../../services/path/common/pathService.js";import{IPreferencesService as _e}from"../../../services/preferences/common/preferences.js";import{IRemoteAgentService as xe}from"../../../services/remote/common/remoteAgentService.js";import{ITextFileService as be}from"../../../services/textfile/common/textfiles.js";import{IViewsService as Ee}from"../../../services/views/common/viewsService.js";import{ITerminalGroupService as Re,ITerminalService as we}from"../../terminal/browser/terminal.js";import{ITerminalProfileResolverService as We}from"../../terminal/common/terminal.js";import{AbstractTaskService as Ae}from"../browser/abstractTaskService.js";import{TerminalTaskSystem as Fe}from"../browser/terminalTaskSystem.js";import{ITaskService as De}from"../common/taskService.js";import{ExecutionEngine as p}from"../common/tasks.js";let a=class extends Ae{constructor(r,i,t,o,n,s,I,u,l,d,k,S,g,y,h,T,C,P,_,x,b,E,R,w,W,A,F,D,M,L,V,z,O,B,N,j,Me){super(r,i,t,o,n,s,I,u,l,d,k,g,y,h,T,C,P,_,x,b,E,R,w,W,A,F,D,M,L,V,z,O,B,S,j,N),this._register(S.onBeforeShutdown(q=>q.veto(this.beforeShutdown(),"veto.tasks")))}_getTaskSystem(){if(this._taskSystem)return this._taskSystem;const r=this._createTerminalTaskSystem();return this._taskSystem=r,this._taskSystemListeners=[this._taskSystem.onDidStateChange(i=>{this._taskRunningState.set(this._taskSystem.isActiveSync()),this._onDidStateChange.fire(i)})],this._taskSystem}_computeLegacyConfiguration(r){const{config:i,hasParseErrors:t}=this._getConfiguration(r);return t?Promise.resolve({workspaceFolder:r,hasErrors:!0,config:void 0}):i?Promise.resolve({workspaceFolder:r,config:i,hasErrors:!1}):Promise.resolve({workspaceFolder:r,hasErrors:!0,config:void 0})}_versionAndEngineCompatible(r){const i=r&&r.version?r.version:void 0,t=this.executionEngine;return i===void 0||v.satisfies("0.1.0",i)&&t===p.Process||v.satisfies("2.0.0",i)&&t===p.Terminal}beforeShutdown(){if(!this._taskSystem||!this._taskSystem.isActiveSync()||this._taskSystem instanceof Fe)return!1;let r;return this._taskSystem.canAutoTerminate()?r=Promise.resolve({confirmed:!0}):r=this._dialogService.confirm({message:c.localize("TaskSystem.runningTask","There is a task running. Do you want to terminate it?"),primaryButton:c.localize({key:"TaskSystem.terminateTask",comment:["&& denotes a mnemonic"]},"&&Terminate Task")}),r.then(i=>i.confirmed?this._taskSystem.terminateAll().then(t=>{let o=!0,n;for(const s of t)o=o&&s.success,n===void 0&&s.code!==void 0&&(n=s.code);return o?(this._taskSystem=void 0,this._disposeTaskSystemListeners(),!1):n&&n===Q.ProcessNotFound?this._dialogService.confirm({message:c.localize("TaskSystem.noProcess","The launched task doesn't exist anymore. If the task spawned background processes exiting VS Code might result in orphaned processes. To avoid this start the last background process with a wait flag."),primaryButton:c.localize({key:"TaskSystem.exitAnyways",comment:["&& denotes a mnemonic"]},"&&Exit Anyways"),type:"info"}).then(s=>!s.confirmed):!0},t=>!0):!0)}};a=f([e(0,Y),e(1,se),e(2,Te),e(3,Ce),e(4,Ee),e(5,X),e(6,ke),e(7,ee),e(8,pe),e(9,fe),e(10,be),e(11,he),e(12,H),e(13,ye),e(14,ce),e(15,de),e(16,we),e(17,Re),e(18,Se),e(19,ae),e(20,me),e(21,$),e(22,ne),e(23,Z),e(24,ge),e(25,We),e(26,Pe),e(27,J),e(28,_e),e(29,le),e(30,ue),e(31,Ie),e(32,oe),e(33,ve),e(34,te),e(35,xe),e(36,U)],a),ie(De,a,re.Delayed);export{a as TaskService};
