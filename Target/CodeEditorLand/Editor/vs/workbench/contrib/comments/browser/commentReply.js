var T=Object.defineProperty;var y=Object.getOwnPropertyDescriptor;var u=(d,s,e,i)=>{for(var t=i>1?void 0:i?y(s,e):s,o=d.length-1,r;o>=0;o--)(r=d[o])&&(t=(i?r(s,e,t):r(t))||t);return i&&t&&T(s,e,t),t},a=(d,s)=>(e,i)=>s(e,i,d);import*as n from"../../../../base/browser/dom.js";import{getDefaultHoverDelegate as C}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import{MOUSE_CURSOR_TEXT_CSS_CLASS_NAME as I}from"../../../../base/browser/ui/mouseCursor/mouseCursor.js";import"../../../../base/common/actions.js";import{Disposable as x,dispose as A}from"../../../../base/common/lifecycle.js";import{MarshalledId as g}from"../../../../base/common/marshallingIds.js";import{Schemas as M}from"../../../../base/common/network.js";import{URI as R}from"../../../../base/common/uri.js";import{generateUuid as b}from"../../../../base/common/uuid.js";import"../../../../editor/browser/editorBrowser.js";import"../../../../editor/common/core/range.js";import"../../../../editor/common/languages.js";import"../../../../editor/common/model.js";import{ITextModelService as S}from"../../../../editor/common/services/resolverService.js";import*as c from"../../../../nls.js";import{IConfigurationService as D}from"../../../../platform/configuration/common/configuration.js";import"../../../../platform/contextkey/common/contextkey.js";import{IHoverService as L}from"../../../../platform/hover/browser/hover.js";import"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as H}from"../../../../platform/keybinding/common/keybinding.js";import"../../notebook/common/notebookRange.js";import{CommentContextKeys as w}from"../common/commentContextKeys.js";import"../common/commentThreadWidget.js";import{CommentFormActions as _}from"./commentFormActions.js";import"./commentMenus.js";import{ICommentService as O}from"./commentService.js";import{calculateEditorHeight as V,MIN_EDITOR_HEIGHT as F,SimpleCommentEditor as E}from"./simpleCommentEditor.js";let B=0;const Se="commenteditordecoration";let l=class extends x{constructor(e,i,t,o,r,h,m,p,K,$,v,N,W,f,z,j,k){super();this.owner=e;this._parentEditor=t;this._commentThread=o;this._scopedInstatiationService=r;this._contextKeyService=h;this._commentMenus=m;this._commentOptions=p;this._pendingComment=K;this._parentThread=$;this._actionRunDelegate=N;this.commentService=W;this.keybindingService=z;this.hoverService=j;this.textModelService=k;this.form=n.append(i,n.$(".comment-form")),this.commentEditor=this._register(this._scopedInstatiationService.createInstance(E,this.form,E.getEditorOptions(f),h,this._parentThread)),this.commentEditorIsEmpty=w.commentIsEmpty.bindTo(this._contextKeyService),this.commentEditorIsEmpty.set(!this._pendingComment),this.initialize(v)}commentEditor;form;commentEditorIsEmpty;_error;_formActions;_editorActions;_commentThreadDisposables=[];_commentFormActions;_commentEditorActions;_reviewThreadReplyButton;_editorHeight=F;async initialize(e){const i=this._commentThread.comments&&this._commentThread.comments.length>0,t=b()+"-"+(i?this._commentThread.threadId:++B),o=JSON.stringify({extensionId:this._commentThread.extensionId,commentThreadId:this._commentThread.threadId});let r=R.from({scheme:M.commentsInput,path:`/${this._commentThread.extensionId}/commentinput-${t}.md?${o}`});const h=this.commentService.getCommentController(this.owner);h&&(r=r.with({authority:h.id}));const m=await this.textModelService.createModelReference(r);m.object.textEditorModel.setValue(this._pendingComment||""),this._register(m),this.commentEditor.setModel(m.object.textEditorModel),this.calculateEditorHeight(),this._register(m.object.textEditorModel.onDidChangeContent(()=>{this.setCommentEditorDecorations(),this.commentEditorIsEmpty?.set(!this.commentEditor.getValue()),this.calculateEditorHeight()&&(this.commentEditor.layout({height:this._editorHeight,width:this.commentEditor.getLayoutInfo().width}),this.commentEditor.render(!0))})),this.createTextModelListener(this.commentEditor,this.form),this.setCommentEditorDecorations(),this._pendingComment?this.expandReplyArea():i?this.createReplyButton(this.commentEditor,this.form):e&&this._commentThread.comments&&this._commentThread.comments.length===0&&this.expandReplyArea(),this._error=n.append(this.form,n.$(".validation-error.hidden"));const p=n.append(this.form,n.$(".form-actions"));this._formActions=n.append(p,n.$(".other-actions")),this.createCommentWidgetFormActions(this._formActions,m.object.textEditorModel),this._editorActions=n.append(p,n.$(".editor-actions")),this.createCommentWidgetEditorActions(this._editorActions,m.object.textEditorModel)}calculateEditorHeight(){const e=V(this._parentEditor,this.commentEditor,this._editorHeight);return e!==this._editorHeight?(this._editorHeight=e,!0):!1}updateCommentThread(e){const i=this.commentEditor.hasTextFocus(),t=!this._commentThread.comments?.length&&!e.comments?.length;this._reviewThreadReplyButton||this.createReplyButton(this.commentEditor,this.form),this._commentThread.comments&&this._commentThread.comments.length===0&&!t&&this.expandReplyArea(),i&&this.commentEditor.focus()}getPendingComment(){const e=this.commentEditor.getModel();if(e&&e.getValueLength()>0)return e.getValue()}setPendingComment(e){this._pendingComment=e,this.expandReplyArea(),this.commentEditor.setValue(e)}layout(e){this.commentEditor.layout({height:this._editorHeight,width:e-54})}focusIfNeeded(){!this._commentThread.comments||!this._commentThread.comments.length?this.commentEditor.focus():(this.commentEditor.getModel()?.getValueLength()??0)>0&&this.expandReplyArea()}focusCommentEditor(){this.commentEditor.focus()}expandReplyAreaAndFocusCommentEditor(){this.expandReplyArea(),this.commentEditor.focus()}isCommentEditorFocused(){return this.commentEditor.hasWidgetFocus()}updateCanReply(){this._commentThread.canReply?this.form.style.display="block":this.form.style.display="none"}async submitComment(){await this._commentFormActions?.triggerDefaultAction(),this._pendingComment=void 0}setCommentEditorDecorations(){const i=this._commentThread.comments&&this._commentThread.comments.length>0?this._commentOptions?.placeHolder||c.localize("reply","Reply..."):this._commentOptions?.placeHolder||c.localize("newComment","Type a new comment");this.commentEditor.updateOptions({placeholder:i})}createTextModelListener(e,i){this._commentThreadDisposables.push(e.onDidFocusEditorWidget(()=>{this._commentThread.input={uri:e.getModel().uri,value:e.getValue()},this.commentService.setActiveEditingCommentThread(this._commentThread),this.commentService.setActiveCommentAndThread(this.owner,{thread:this._commentThread})})),this._commentThreadDisposables.push(e.getModel().onDidChangeContent(()=>{const t=e.getValue();if(this._commentThread.input&&this._commentThread.input.uri===e.getModel().uri&&this._commentThread.input.value!==t){const o=this._commentThread.input;o.value=t,this._commentThread.input=o}this.commentService.setActiveEditingCommentThread(this._commentThread)})),this._commentThreadDisposables.push(this._commentThread.onDidChangeInput(t=>{const o=this._commentThread,r=e.getModel();o.input&&r&&o.input.uri!==r.uri||t&&e.getValue()!==t.value&&(e.setValue(t.value),t.value===""&&(this._pendingComment="",i.classList.remove("expand"),e.getDomNode().style.outline="",this._error.textContent="",this._error.classList.add("hidden")))}))}createCommentWidgetFormActions(e,i){const t=this._commentMenus.getCommentThreadActions(this._contextKeyService);this._register(t),this._register(t.onDidChange(()=>{this._commentFormActions.setActions(t)})),this._commentFormActions=new _(this.keybindingService,this._contextKeyService,e,async o=>{await this._actionRunDelegate?.(),await o.run({thread:this._commentThread,text:this.commentEditor.getValue(),$mid:g.CommentThreadReply}),this.hideReplyArea()}),this._register(this._commentFormActions),this._commentFormActions.setActions(t)}createCommentWidgetEditorActions(e,i){const t=this._commentMenus.getCommentEditorActions(this._contextKeyService);this._register(t),this._register(t.onDidChange(()=>{this._commentEditorActions.setActions(t)})),this._commentEditorActions=new _(this.keybindingService,this._contextKeyService,e,async o=>{this._actionRunDelegate?.(),o.run({thread:this._commentThread,text:this.commentEditor.getValue(),$mid:g.CommentThreadReply}),this.focusCommentEditor()}),this._register(this._commentEditorActions),this._commentEditorActions.setActions(t,!0)}get isReplyExpanded(){return this.form.classList.contains("expand")}expandReplyArea(){this.isReplyExpanded||(this.form.classList.add("expand"),this.commentEditor.focus(),this.commentEditor.layout())}clearAndExpandReplyArea(){this.isReplyExpanded||(this.commentEditor.setValue(""),this.expandReplyArea())}hideReplyArea(){const e=this.commentEditor.getDomNode();e&&(e.style.outline=""),this.commentEditor.setValue(""),this._pendingComment="",this.form.classList.remove("expand"),this._error.textContent="",this._error.classList.add("hidden")}createReplyButton(e,i){this._reviewThreadReplyButton=n.append(i,n.$(`button.review-thread-reply-button.${I}`)),this._register(this.hoverService.setupManagedHover(C("mouse"),this._reviewThreadReplyButton,this._commentOptions?.prompt||c.localize("reply","Reply..."))),this._reviewThreadReplyButton.textContent=this._commentOptions?.prompt||c.localize("reply","Reply..."),this._register(n.addDisposableListener(this._reviewThreadReplyButton,"click",t=>this.clearAndExpandReplyArea())),this._register(n.addDisposableListener(this._reviewThreadReplyButton,"focus",t=>this.clearAndExpandReplyArea())),e.onDidBlurEditorWidget(()=>{e.getModel().getValueLength()===0&&i.classList.contains("expand")&&i.classList.remove("expand")})}dispose(){super.dispose(),A(this._commentThreadDisposables)}};l=u([a(12,O),a(13,D),a(14,H),a(15,L),a(16,S)],l);export{Se as COMMENTEDITOR_DECORATION_KEY,l as CommentReply};
