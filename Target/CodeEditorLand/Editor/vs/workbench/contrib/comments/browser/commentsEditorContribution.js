import{KeyChord as E,KeyCode as m,KeyMod as i}from"../../../../base/common/keyCodes.js";import"./media/review.css";import{isCodeEditor as S,isDiffEditor as M}from"../../../../editor/browser/editorBrowser.js";import{EditorContributionInstantiation as N,registerEditorContribution as F}from"../../../../editor/browser/editorExtensions.js";import{ICodeEditorService as h}from"../../../../editor/browser/services/codeEditorService.js";import{Range as H}from"../../../../editor/common/core/range.js";import{EditorContextKeys as y}from"../../../../editor/common/editorContextKeys.js";import*as d from"../../../../nls.js";import{AccessibleViewProviderId as A}from"../../../../platform/accessibility/browser/accessibleView.js";import{CONTEXT_ACCESSIBILITY_MODE_ENABLED as b}from"../../../../platform/accessibility/common/accessibility.js";import{MenuId as l,MenuRegistry as s}from"../../../../platform/actions/common/actions.js";import{CommandsRegistry as f}from"../../../../platform/commands/common/commands.js";import{ContextKeyExpr as p}from"../../../../platform/contextkey/common/contextkey.js";import{KeybindingWeight as c,KeybindingsRegistry as C}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{INotificationService as z}from"../../../../platform/notification/common/notification.js";import{WorkbenchPhase as k,registerWorkbenchContribution2 as W}from"../../../common/contributions.js";import{IEditorService as D}from"../../../services/editor/common/editorService.js";import{accessibilityHelpIsShown as R,accessibleViewCurrentProviderId as I}from"../../accessibility/browser/accessibilityConfiguration.js";import{CommentCommandId as n}from"../common/commentCommandIds.js";import{CommentContextKeys as a}from"../common/commentContextKeys.js";import{ICommentService as L}from"./commentService.js";import{CommentController as g,ID as U}from"./commentsController.js";import{CommentsInputContentProvider as w}from"./commentsInputContentProvider.js";import{SimpleCommentEditor as P,ctxCommentEditorFocused as x}from"./simpleCommentEditor.js";F(U,g,N.AfterFirstRender),W(w.ID,w,k.BlockRestore),C.registerCommandAndKeybindingRule({id:n.NextThread,handler:async(o,e)=>{const t=u(o);if(!t)return Promise.resolve();const r=g.get(t);if(!r)return Promise.resolve();r.nextCommentThread()},weight:c.EditorContrib,primary:i.Alt|m.F9}),C.registerCommandAndKeybindingRule({id:n.PreviousThread,handler:async(o,e)=>{const t=u(o);if(!t)return Promise.resolve();const r=g.get(t);if(!r)return Promise.resolve();r.previousCommentThread()},weight:c.EditorContrib,primary:i.Shift|i.Alt|m.F9}),C.registerCommandAndKeybindingRule({id:n.NextRange,handler:async(o,e)=>{const t=u(o);if(!t)return Promise.resolve();const r=g.get(t);if(!r)return Promise.resolve();r.nextCommentingRange()},when:p.and(b,p.or(y.focus,a.commentFocused,p.and(R,I.isEqualTo(A.Comments)))),primary:E(i.CtrlCmd|m.KeyK,i.CtrlCmd|i.Alt|m.DownArrow),weight:c.EditorContrib}),s.appendMenuItem(l.CommandPalette,{command:{id:n.NextRange,title:d.localize("comments.nextCommentingRange","Go to Next Commenting Range"),category:"Comments"},when:a.activeEditorHasCommentingRange}),C.registerCommandAndKeybindingRule({id:n.PreviousRange,handler:async(o,e)=>{const t=u(o);if(!t)return Promise.resolve();const r=g.get(t);if(!r)return Promise.resolve();r.previousCommentingRange()},when:p.and(b,p.or(y.focus,a.commentFocused,p.and(R,I.isEqualTo(A.Comments)))),primary:E(i.CtrlCmd|m.KeyK,i.CtrlCmd|i.Alt|m.UpArrow),weight:c.EditorContrib}),s.appendMenuItem(l.CommandPalette,{command:{id:n.PreviousRange,title:d.localize("comments.previousCommentingRange","Go to Previous Commenting Range"),category:"Comments"},when:a.activeEditorHasCommentingRange}),f.registerCommand({id:n.ToggleCommenting,handler:o=>{const e=o.get(L),t=e.isCommentingEnabled;e.enableCommenting(!t)}}),s.appendMenuItem(l.CommandPalette,{command:{id:n.ToggleCommenting,title:d.localize("comments.toggleCommenting","Toggle Editor Commenting"),category:"Comments"},when:a.WorkspaceHasCommenting}),C.registerCommandAndKeybindingRule({id:n.Add,handler:async(o,e)=>{const t=u(o);if(!t)return Promise.resolve();const r=g.get(t);if(!r)return Promise.resolve();const K=e?.range?new H(e.range.startLineNumber,e.range.startLineNumber,e.range.endLineNumber,e.range.endColumn):e?.fileComment?void 0:t.getSelection(),T=o.get(z);try{await r.addOrToggleCommentAtLine(K,void 0)}catch{T.error(d.localize("comments.addCommand.error","The cursor must be within a commenting range to add a comment"))}},weight:c.EditorContrib,primary:E(i.CtrlCmd|m.KeyK,i.CtrlCmd|i.Alt|m.KeyC)}),s.appendMenuItem(l.CommandPalette,{command:{id:n.Add,title:d.localize("comments.addCommand","Add Comment on Current Selection"),category:"Comments"},when:a.activeCursorHasCommentingRange}),f.registerCommand({id:n.CollapseAll,handler:o=>v(o)?.collapseAll()}),s.appendMenuItem(l.CommandPalette,{command:{id:n.CollapseAll,title:d.localize("comments.collapseAll","Collapse All Comments"),category:"Comments"},when:a.WorkspaceHasCommenting}),f.registerCommand({id:n.ExpandAll,handler:o=>v(o)?.expandAll()}),s.appendMenuItem(l.CommandPalette,{command:{id:n.ExpandAll,title:d.localize("comments.expandAll","Expand All Comments"),category:"Comments"},when:a.WorkspaceHasCommenting}),f.registerCommand({id:n.ExpandUnresolved,handler:o=>v(o)?.expandUnresolved()}),s.appendMenuItem(l.CommandPalette,{command:{id:n.ExpandUnresolved,title:d.localize("comments.expandUnresolved","Expand Unresolved Comments"),category:"Comments"},when:a.WorkspaceHasCommenting}),C.registerCommandAndKeybindingRule({id:n.Submit,weight:c.EditorContrib,primary:i.CtrlCmd|m.Enter,when:x,handler:(o,e)=>{const t=o.get(h).getFocusedCodeEditor();t instanceof P&&t.getParentThread().submitComment()}}),C.registerCommandAndKeybindingRule({id:n.Hide,weight:c.EditorContrib,primary:m.Escape,secondary:[i.Shift|m.Escape],when:x,handler:(o,e)=>{const t=o.get(h).getFocusedCodeEditor();t instanceof P&&t.getParentThread().collapse()}});function u(o){let e=o.get(D).activeTextEditorControl;return M(e)&&(e.getOriginalEditor().hasTextFocus()?e=e.getOriginalEditor():e=e.getModifiedEditor()),!S(e)||!e.hasModel()?null:e}function v(o){const e=u(o);if(!e)return;const t=g.get(e);if(t)return t}export{u as getActiveEditor};
