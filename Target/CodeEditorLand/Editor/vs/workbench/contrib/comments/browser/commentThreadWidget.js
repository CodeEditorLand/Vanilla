var L=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var x=(m,r,e,o)=>{for(var t=o>1?void 0:o?A(r,e):r,n=m.length-1,s;n>=0;n--)(s=m[n])&&(t=(o?s(r,e,t):s(t))||t);return o&&t&&L(r,e,t),t},d=(m,r)=>(e,o)=>r(e,o,m);import"./media/review.css";import*as i from"../../../../base/browser/dom.js";import{Emitter as F}from"../../../../base/common/event.js";import{Disposable as M,dispose as D,toDisposable as O}from"../../../../base/common/lifecycle.js";import"../../../../base/common/uri.js";import*as E from"../../../../editor/common/languages.js";import"../../../../editor/browser/widget/markdownRenderer/browser/markdownRenderer.js";import"../../../../platform/contextkey/common/contextkey.js";import"../../../../platform/instantiation/common/instantiation.js";import"./commentMenus.js";import{CommentReply as V}from"./commentReply.js";import{ICommentService as B}from"./commentService.js";import{CommentThreadBody as $}from"./commentThreadBody.js";import{CommentThreadHeader as N}from"./commentThreadHeader.js";import{CommentThreadAdditionalActions as P}from"./commentThreadAdditionalActions.js";import{CommentContextKeys as _}from"../common/commentContextKeys.js";import"../common/commentThreadWidget.js";import"../../../../platform/theme/common/themeService.js";import{contrastBorder as U,focusBorder as z,inputValidationErrorBackground as H,inputValidationErrorBorder as W,inputValidationErrorForeground as Q,textBlockQuoteBackground as q,textBlockQuoteBorder as j,textLinkActiveForeground as Y,textLinkForeground as G}from"../../../../platform/theme/common/colorRegistry.js";import{PANEL_BORDER as J}from"../../../common/theme.js";import{Range as X}from"../../../../editor/common/core/range.js";import{commentThreadStateBackgroundColorVar as Z,commentThreadStateColorVar as ee}from"./commentColors.js";import"../../notebook/common/notebookRange.js";import"../../../../editor/common/config/fontInfo.js";import{IContextMenuService as te}from"../../../../platform/contextview/browser/contextView.js";import{registerNavigableContainer as oe}from"../../../browser/actions/widgetNavigationCommands.js";import{IConfigurationService as ie}from"../../../../platform/configuration/common/configuration.js";import{COMMENTS_SECTION as ne}from"../common/commentsConfiguration.js";import{localize as I}from"../../../../nls.js";import{AccessibilityVerbositySettingId as k}from"../../accessibility/browser/accessibilityConfiguration.js";import{IKeybindingService as re}from"../../../../platform/keybinding/common/keybinding.js";import{AccessibilityCommandId as se}from"../../accessibility/common/accessibilityCommands.js";import"./simpleCommentEditor.js";import{DomEmitter as ae}from"../../../../base/browser/event.js";import{isCodeEditor as me}from"../../../../editor/browser/editorBrowser.js";const it="commenteditordecoration";let g=class extends M{constructor(e,o,t,n,s,c,a,y,C,h,f,v,b,l,R,T){super();this.container=e;this._parentEditor=o;this._owner=t;this._parentResourceUri=n;this._contextKeyService=s;this._scopedInstantiationService=c;this._commentThread=a;this._pendingComment=y;this._pendingEdits=C;this._markdownOptions=h;this._commentOptions=f;this._containerDelegate=v;this.commentService=b;this.configurationService=R;this._keybindingService=T;this._threadIsEmpty=_.commentThreadIsEmpty.bindTo(this._contextKeyService),this._threadIsEmpty.set(!a.comments||!a.comments.length),this._focusedContextKey=_.commentFocused.bindTo(this._contextKeyService),this._commentMenus=this.commentService.getCommentMenus(this._owner),this._register(this._header=new N(e,{collapse:this.collapse.bind(this)},this._commentMenus,this._commentThread,this._contextKeyService,this._scopedInstantiationService,l)),this._header.updateCommentThread(this._commentThread);const p=i.$(".body");e.appendChild(p),this._register(O(()=>p.remove()));const S=this._register(i.trackFocus(p));this._register(oe({name:"commentThreadWidget",focusNotifiers:[S],focusNextWidget:()=>{this._commentReply?.isCommentEditorFocused()||this._commentReply?.expandReplyAreaAndFocusCommentEditor()},focusPreviousWidget:()=>{this._commentReply?.isCommentEditorFocused()&&this._commentThread.comments?.length&&this._body.focus()}})),this._register(S.onDidFocus(()=>this._focusedContextKey.set(!0))),this._register(S.onDidBlur(()=>this._focusedContextKey.reset())),this._register(this.configurationService.onDidChangeConfiguration(u=>{u.affectsConfiguration(k.Comments)&&this._setAriaLabel()})),this._body=this._scopedInstantiationService.createInstance($,this._parentEditor,this._owner,this._parentResourceUri,p,this._markdownOptions,this._commentThread,this._pendingEdits,this._scopedInstantiationService,this),this._register(this._body),this._setAriaLabel(),this._styleElement=i.createStyleSheet(this.container),this._commentThreadContextValue=_.commentThreadContext.bindTo(this._contextKeyService),this._commentThreadContextValue.set(a.contextValue);const K=_.commentControllerContext.bindTo(this._contextKeyService),w=this.commentService.getCommentController(this._owner);w?.contextValue&&K.set(w.contextValue),this.currentThreadListeners(),this._register(new ae(this.container,"keydown").event(u=>{i.isKeyboardEvent(u)&&u.key==="Escape"&&(X.isIRange(this.commentThread.range)&&me(this._parentEditor)&&this._parentEditor.setSelection(this.commentThread.range),this.collapse())}))}_header;_body;_commentReply;_additionalActions;_commentMenus;_commentThreadDisposables=[];_threadIsEmpty;_styleElement;_commentThreadContextValue;_focusedContextKey;_onDidResize=new F;onDidResize=this._onDidResize.event;_commentThreadState;get commentThread(){return this._commentThread}_setAriaLabel(){let e=I("commentLabel","Comment"),o;const t=this.configurationService.getValue(k.Comments);t&&(o=this._keybindingService.lookupKeybinding(se.OpenAccessibilityHelp,this._contextKeyService)?.getLabel()??void 0),o?e=I("commentLabelWithKeybinding","{0}, use ({1}) for accessibility help",e,o):t&&(e=I("commentLabelWithKeybindingNoKeybinding","{0}, run the command Open Accessibility Help which is currently not triggerable via keybinding.",e)),this._body.container.ariaLabel=e}updateCurrentThread(e,o){e||o?this.commentService.setCurrentCommentThread(this.commentThread):this.commentService.setCurrentCommentThread(void 0)}currentThreadListeners(){let e=!1,o=!1;this._register(i.addDisposableListener(this.container,i.EventType.MOUSE_ENTER,t=>{t.toElement===this.container&&(e=!0,this.updateCurrentThread(e,o))},!0)),this._register(i.addDisposableListener(this.container,i.EventType.MOUSE_LEAVE,t=>{t.fromElement===this.container&&(e=!1,this.updateCurrentThread(e,o))},!0)),this._register(i.addDisposableListener(this.container,i.EventType.FOCUS_IN,()=>{o=!0,this.updateCurrentThread(e,o)},!0)),this._register(i.addDisposableListener(this.container,i.EventType.FOCUS_OUT,()=>{o=!1,this.updateCurrentThread(e,o)},!0))}async updateCommentThread(e){const o=this._commentThread.collapsibleState===E.CommentThreadCollapsibleState.Expanded&&this._commentThreadState===E.CommentThreadState.Unresolved&&e.state===E.CommentThreadState.Resolved;this._commentThreadState=e.state,this._commentThread=e,D(this._commentThreadDisposables),this._commentThreadDisposables=[],this._bindCommentThreadListeners(),await this._body.updateCommentThread(e,this._commentReply?.isCommentEditorFocused()??!1),this._threadIsEmpty.set(!this._body.length),this._header.updateCommentThread(e),this._commentReply?.updateCommentThread(e),this._commentThread.contextValue?this._commentThreadContextValue.set(this._commentThread.contextValue):this._commentThreadContextValue.reset(),o&&this.configurationService.getValue(ne).collapseOnResolve&&this.collapse()}async display(e,o){const t=Math.max(23,Math.ceil(e*1.2));this._header.updateHeight(t),await this._body.display(),this._commentThread.canReply&&this._createCommentForm(o),this._createAdditionalActions(),this._register(this._body.onDidResize(n=>{this._refresh(n)})),this._commentThread.canReply&&this._commentReply&&this._commentReply.focusIfNeeded(),this._bindCommentThreadListeners()}_refresh(e){this._body.layout(),this._onDidResize.fire(e)}dispose(){super.dispose(),D(this._commentThreadDisposables),this.updateCurrentThread(!1,!1)}_bindCommentThreadListeners(){this._commentThreadDisposables.push(this._commentThread.onDidChangeCanReply(()=>{this._commentReply?this._commentReply.updateCanReply():this._commentThread.canReply&&this._createCommentForm(!1)})),this._commentThreadDisposables.push(this._commentThread.onDidChangeComments(async e=>{await this.updateCommentThread(this._commentThread)})),this._commentThreadDisposables.push(this._commentThread.onDidChangeLabel(e=>{this._header.createThreadLabel()}))}_createCommentForm(e){this._commentReply=this._scopedInstantiationService.createInstance(V,this._owner,this._body.container,this._parentEditor,this._commentThread,this._scopedInstantiationService,this._contextKeyService,this._commentMenus,this._commentOptions,this._pendingComment,this,e,this._containerDelegate.actionRunner),this._register(this._commentReply)}_createAdditionalActions(){this._additionalActions=this._scopedInstantiationService.createInstance(P,this._body.container,this._commentThread,this._contextKeyService,this._commentMenus,this._containerDelegate.actionRunner),this._register(this._additionalActions)}getCommentCoords(e){return this._body.getCommentCoords(e)}getPendingEdits(){return this._body.getPendingEdits()}getPendingComment(){if(this._commentReply)return this._commentReply.getPendingComment()}setPendingComment(e){this._pendingComment=e,this._commentReply?.setPendingComment(e)}getDimensions(){return this._body.getDimensions()}layout(e){this._body.layout(e),e!==void 0&&this._commentReply?.layout(e)}ensureFocusIntoNewEditingComment(){this._body.ensureFocusIntoNewEditingComment()}focusCommentEditor(){this._commentReply?.expandReplyAreaAndFocusCommentEditor()}focus(e){this._body.focus(e)}async submitComment(){const e=this._body.activeComment;if(e)return e.submitComment();if((this._commentReply?.getPendingComment()?.length??0)>0)return this._commentReply?.submitComment()}collapse(){this._containerDelegate.collapse()}applyTheme(e,o){const t=[];t.push(`.monaco-editor .review-widget > .body { border-top: 1px solid var(${ee}) }`),t.push(`.monaco-editor .review-widget > .head { background-color: var(${Z}) }`);const n=e.getColor(G);n&&t.push(`.review-widget .body .comment-body a { color: ${n} }`);const s=e.getColor(Y);s&&t.push(`.review-widget .body .comment-body a:hover, a:active { color: ${s} }`);const c=e.getColor(z);c&&(t.push(`.review-widget .body .comment-body a:focus { outline: 1px solid ${c}; }`),t.push(`.review-widget .body .monaco-editor.focused { outline: 1px solid ${c}; }`));const a=e.getColor(q);a&&t.push(`.review-widget .body .review-comment blockquote { background: ${a}; }`);const y=e.getColor(j);y&&t.push(`.review-widget .body .review-comment blockquote { border-color: ${y}; }`);const C=e.getColor(J);C&&t.push(`.review-widget .body .review-comment .review-comment-contents .comment-reactions .action-item a.action-label { border-color: ${C}; }`);const h=e.getColor(U);h&&(t.push(`.review-widget .body .comment-form .review-thread-reply-button { outline-color: ${h}; }`),t.push(`.review-widget .body .monaco-editor { outline: 1px solid ${h}; }`));const f=e.getColor(W);f&&t.push(`.review-widget .validation-error { border: 1px solid ${f}; }`);const v=e.getColor(H);v&&t.push(`.review-widget .validation-error { background: ${v}; }`);const b=e.getColor(Q);b&&t.push(`.review-widget .body .comment-form .validation-error { color: ${b}; }`);const l="--comment-thread-editor-font-family",R="--comment-thread-editor-font-size",T="--comment-thread-editor-font-weight";this.container?.style.setProperty(l,o.fontFamily),this.container?.style.setProperty(R,`${o.fontSize}px`),this.container?.style.setProperty(T,o.fontWeight),t.push(`.review-widget .body code {
			font-family: var(${l});
			font-weight: var(${T});
		}`),this._styleElement.textContent=t.join(`
`),this._commentReply?.setCommentEditorDecorations()}};g=x([d(12,B),d(13,te),d(14,ie),d(15,re)],g);export{it as COMMENTEDITOR_DECORATION_KEY,g as CommentThreadWidget};
