import*as n from"../../../../base/browser/dom.js";import{StandardMouseEvent as d}from"../../../../base/browser/mouseEvent.js";import{ActionBar as p}from"../../../../base/browser/ui/actionbar/actionbar.js";import{Action as _,ActionRunner as u}from"../../../../base/common/actions.js";import{Codicon as c}from"../../../../base/common/codicons.js";import{Disposable as g,MutableDisposable as v,toDisposable as T}from"../../../../base/common/lifecycle.js";import{MarshalledId as C}from"../../../../base/common/marshallingIds.js";import*as A from"../../../../base/common/strings.js";import{ThemeIcon as l}from"../../../../base/common/themables.js";import"../../../../editor/common/core/range.js";import"../../../../editor/common/languages.js";import*as s from"../../../../nls.js";import{createActionViewItem as f}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import"../../../../platform/actions/common/actions.js";import"../../../../platform/contextkey/common/contextkey.js";import"../../../../platform/contextview/browser/contextView.js";import"../../../../platform/instantiation/common/instantiation.js";import{registerIcon as b}from"../../../../platform/theme/common/iconRegistry.js";import"../../../common/comments.js";import"./commentMenus.js";const I=b("review-comment-collapse",c.chevronUp,s.localize("collapseIcon","Icon to collapse a review comment.")),h="expand-review-action "+l.asClassName(I),M="expand-review-action "+l.asClassName(c.trashcan);function m(r){return!!r&&r.length>0}class te extends g{constructor(e,i,o,t,a,x,S){super();this._delegate=i;this._commentMenus=o;this._commentThread=t;this._contextKeyService=a;this.instantiationService=x;this._contextMenuService=S;this._headElement=n.$(".head"),e.appendChild(this._headElement),this._register(T(()=>this._headElement.remove())),this._fillHead()}_headElement;_headingLabel;_actionbarWidget;_collapseAction;_fillHead(){const e=n.append(this._headElement,n.$(".review-title"));this._headingLabel=n.append(e,n.$("span.filename")),this.createThreadLabel();const i=n.append(this._headElement,n.$(".review-actions"));this._actionbarWidget=new p(i,{actionViewItemProvider:f.bind(void 0,this.instantiationService)}),this._register(this._actionbarWidget);const o=m(this._commentThread.comments)?h:M;if(this._collapseAction=new _("review.expand",s.localize("label.collapse","Collapse"),o,!0,()=>this._delegate.collapse()),!m(this._commentThread.comments)){const a=this._register(new v);a.value=this._commentThread.onDidChangeComments(()=>{m(this._commentThread.comments)&&(this._collapseAction.class=h,a.clear())})}const t=this._commentMenus.getCommentThreadTitleActions(this._contextKeyService);this._register(t),this.setActionBarActions(t),this._register(t),this._register(t.onDidChange(a=>{this.setActionBarActions(t)})),this._register(n.addDisposableListener(this._headElement,n.EventType.CONTEXT_MENU,a=>this.onContextMenu(a))),this._actionbarWidget.context=this._commentThread}setActionBarActions(e){const i=e.getActions({shouldForwardArgs:!0}).reduce((o,[,t])=>[...o,...t],[]);this._actionbarWidget.clear(),this._actionbarWidget.push([...i,this._collapseAction],{label:!1,icon:!0})}updateCommentThread(e){this._commentThread=e,this._actionbarWidget.context=this._commentThread,this.createThreadLabel()}createThreadLabel(){let e;e=this._commentThread.label,e===void 0&&(this._commentThread.comments&&this._commentThread.comments.length||(e=s.localize("startThread","Start discussion"))),e&&(this._headingLabel.textContent=A.escape(e),this._headingLabel.setAttribute("aria-label",e))}updateHeight(e){this._headElement.style.height=`${e}px`,this._headElement.style.lineHeight=this._headElement.style.height}onContextMenu(e){const i=this._commentMenus.getCommentThreadTitleContextActions(this._contextKeyService).getActions({shouldForwardArgs:!0}).map(t=>t[1]).flat();if(!i.length)return;const o=new d(n.getWindow(this._headElement),e);this._contextMenuService.showContextMenu({getAnchor:()=>o,getActions:()=>i,actionRunner:new u,getActionsContext:()=>({commentControlHandle:this._commentThread.controllerHandle,commentThreadHandle:this._commentThread.commentThreadHandle,$mid:C.CommentThread})})}}export{te as CommentThreadHeader};
