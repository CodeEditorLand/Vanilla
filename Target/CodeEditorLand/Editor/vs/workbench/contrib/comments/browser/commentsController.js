var H=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var P=(p,e,t,n)=>{for(var i=n>1?void 0:n?U(e,t):e,o=p.length-1,r;o>=0;o--)(r=p[o])&&(i=(n?r(e,t,i):r(i))||i);return n&&i&&H(e,t,i),i},v=(p,e)=>(t,n)=>e(t,n,p);import{Action as k}from"../../../../base/common/actions.js";import{coalesce as M}from"../../../../base/common/arrays.js";import{findFirstIdxMonotonousOrArrLen as V}from"../../../../base/common/arraysFind.js";import{createCancelablePromise as Z,Delayer as B}from"../../../../base/common/async.js";import{onUnexpectedError as F}from"../../../../base/common/errors.js";import{DisposableStore as A,dispose as N}from"../../../../base/common/lifecycle.js";import"./media/review.css";import{isCodeEditor as x,isDiffEditor as K}from"../../../../editor/browser/editorBrowser.js";import{ICodeEditorService as Q}from"../../../../editor/browser/services/codeEditorService.js";import{Range as l}from"../../../../editor/common/core/range.js";import{EditorType as G}from"../../../../editor/common/editorCommon.js";import"../../../../editor/common/model.js";import{ModelDecorationOptions as O,TextModel as $}from"../../../../editor/common/model/textModel.js";import*as W from"../../../../editor/common/languages.js";import*as R from"../../../../nls.js";import{IContextMenuService as j}from"../../../../platform/contextview/browser/contextView.js";import{IInstantiationService as Y}from"../../../../platform/instantiation/common/instantiation.js";import{IQuickInputService as J}from"../../../../platform/quickinput/common/quickInput.js";import{CommentGlyphWidget as q}from"./commentGlyphWidget.js";import{ICommentService as X}from"./commentService.js";import{CommentWidgetFocus as w,isMouseUpEventDragFromMouseDown as z,parseMouseDownInfoFromEvent as ee,ReviewZoneWidget as te}from"./commentThreadZoneWidget.js";import{ACTIVE_GROUP as ne,IEditorService as ie,SIDE_GROUP as oe}from"../../../services/editor/common/editorService.js";import{EmbeddedCodeEditorWidget as re}from"../../../../editor/browser/widget/codeEditor/embeddedCodeEditorWidget.js";import{EditorOption as S}from"../../../../editor/common/config/editorOptions.js";import{IViewsService as se}from"../../../services/views/common/viewsService.js";import{COMMENTS_VIEW_ID as y}from"./commentsTreeViewer.js";import{IConfigurationService as ae}from"../../../../platform/configuration/common/configuration.js";import{COMMENTS_SECTION as me}from"../common/commentsConfiguration.js";import{COMMENTEDITOR_DECORATION_KEY as de}from"./commentReply.js";import{Emitter as ce}from"../../../../base/common/event.js";import{IContextKeyService as ge}from"../../../../platform/contextkey/common/contextkey.js";import"../../../../editor/common/core/position.js";import{CommentThreadRangeDecorator as le}from"./commentThreadRangeDecorator.js";import"../../../../editor/common/cursorEvents.js";import"./commentsView.js";import{status as T}from"../../../../base/browser/ui/aria/aria.js";import{CommentContextKeys as L}from"../common/commentContextKeys.js";import{AccessibilityVerbositySettingId as ue}from"../../accessibility/browser/accessibilityConfiguration.js";import{AccessibilityCommandId as he}from"../../accessibility/common/accessibilityCommands.js";import{IKeybindingService as pe}from"../../../../platform/keybinding/common/keybinding.js";import{IAccessibilityService as fe}from"../../../../platform/accessibility/common/accessibility.js";import{URI as Ce}from"../../../../base/common/uri.js";import"../../../../platform/uriIdentity/common/uriIdentity.js";import{threadHasMeaningfulComments as ve}from"./commentsModel.js";const be="editor.contrib.review";class I{constructor(e,t,n,i,o,r,a,s=!1){this._editor=e;this._ownerId=t;this._extensionId=n;this._label=i;this._range=o;this.options=r;this.commentingRangesInfo=a;this.isHover=s;this._startLineNumber=o.startLineNumber,this._endLineNumber=o.endLineNumber}_decorationId;_startLineNumber;_endLineNumber;get id(){return this._decorationId}set id(e){this._decorationId=e}get range(){return{startLineNumber:this._startLineNumber,startColumn:1,endLineNumber:this._endLineNumber,endColumn:1}}getCommentAction(){return{extensionId:this._extensionId,label:this._label,ownerId:this._ownerId,commentingRangesInfo:this.commentingRangesInfo}}getOriginalRange(){return this._range}getActiveRange(){return this.id?this._editor.getModel().getDecorationRange(this.id):void 0}}class E{static description="commenting-range-decorator";decorationOptions;hoverDecorationOptions;multilineDecorationOptions;commentingRangeDecorations=[];decorationIds=[];_editor;_infos;_lastHover=-1;_lastSelection;_lastSelectionCursor;_onDidChangeDecorationsCount=new ce;onDidChangeDecorationsCount=this._onDidChangeDecorationsCount.event;constructor(){const e={description:E.description,isWholeLine:!0,linesDecorationsClassName:"comment-range-glyph comment-diff-added"};this.decorationOptions=O.createDynamic(e);const t={description:E.description,isWholeLine:!0,linesDecorationsClassName:"comment-range-glyph line-hover"};this.hoverDecorationOptions=O.createDynamic(t);const n={description:E.description,isWholeLine:!0,linesDecorationsClassName:"comment-range-glyph multiline-add"};this.multilineDecorationOptions=O.createDynamic(n)}updateHover(e){this._editor&&this._infos&&e!==this._lastHover&&this._doUpdate(this._editor,this._infos,e),this._lastHover=e??-1}updateSelection(e,t=new l(0,0,0,0)){this._lastSelection=t.isEmpty()?void 0:t,this._lastSelectionCursor=t.isEmpty()?void 0:e,this._editor&&this._infos&&this._doUpdate(this._editor,this._infos,e,t)}update(e,t,n,i){e&&(this._editor=e,this._infos=t,this._doUpdate(e,t,n,i))}_lineHasThread(e,t){return e.getDecorationsInRange(t)?.find(n=>n.options.description===q.description)}_doUpdate(e,t,n=-1,i=this._lastSelection){if(!e.getModel())return;n=this._lastSelectionCursor??n;const r=[];for(const s of t)s.commentingRanges.ranges.forEach(m=>{const u=new l(m.startLineNumber,m.startColumn,m.endLineNumber,m.endColumn);let d=i?u.intersectRanges(i):void 0;if(i&&n>=0&&d&&!(d.startLineNumber===d.endLineNumber&&n===d.startLineNumber)){let g;n<=d.startLineNumber?(g=d.collapseToStart(),d=new l(d.startLineNumber+1,1,d.endLineNumber,1)):(g=new l(d.endLineNumber,1,d.endLineNumber,1),d=new l(d.startLineNumber,1,d.endLineNumber-1,1)),r.push(new I(e,s.uniqueOwner,s.extensionId,s.label,d,this.multilineDecorationOptions,s.commentingRanges,!0)),this._lineHasThread(e,g)||r.push(new I(e,s.uniqueOwner,s.extensionId,s.label,g,this.hoverDecorationOptions,s.commentingRanges,!0));const c=Math.min(g.startLineNumber,d.startLineNumber)-1,h=u.startLineNumber<=c,b=Math.max(g.endLineNumber,d.endLineNumber)+1,C=u.endLineNumber>=b;if(h){const f=new l(m.startLineNumber,1,c,1);r.push(new I(e,s.uniqueOwner,s.extensionId,s.label,f,this.decorationOptions,s.commentingRanges,!0))}if(C){const f=new l(b,1,m.endLineNumber,1);r.push(new I(e,s.uniqueOwner,s.extensionId,s.label,f,this.decorationOptions,s.commentingRanges,!0))}}else if(u.startLineNumber<=n&&n<=u.endLineNumber){if(u.startLineNumber<n){const c=new l(m.startLineNumber,1,n-1,1);r.push(new I(e,s.uniqueOwner,s.extensionId,s.label,c,this.decorationOptions,s.commentingRanges,!0))}const g=new l(n,1,n,1);if(this._lineHasThread(e,g)||r.push(new I(e,s.uniqueOwner,s.extensionId,s.label,g,this.hoverDecorationOptions,s.commentingRanges,!0)),n<u.endLineNumber){const c=new l(n+1,1,m.endLineNumber,1);r.push(new I(e,s.uniqueOwner,s.extensionId,s.label,c,this.decorationOptions,s.commentingRanges,!0))}}else r.push(new I(e,s.uniqueOwner,s.extensionId,s.label,m,this.decorationOptions,s.commentingRanges))});e.changeDecorations(s=>{this.decorationIds=s.deltaDecorations(this.decorationIds,r),r.forEach((m,u)=>m.id=this.decorationIds[u])});const a=this.commentingRangeDecorations.length-r.length;this.commentingRangeDecorations=r,a&&this._onDidChangeDecorationsCount.fire(this.commentingRangeDecorations.length)}areRangesIntersectingOrTouchingByLine(e,t){return!(e.endLineNumber<t.startLineNumber-1||t.endLineNumber+1<e.startLineNumber)}getMatchedCommentAction(e){if(e===void 0){const i=this._infos?.filter(o=>o.commentingRanges.fileComments);return i?i.map(o=>({action:{ownerId:o.uniqueOwner,extensionId:o.extensionId,label:o.label,commentingRangesInfo:o.commentingRanges}})):[]}const t=new Map;for(const i of this.commentingRangeDecorations){const o=i.getActiveRange();if(o&&this.areRangesIntersectingOrTouchingByLine(o,e)){const r=i.getCommentAction(),a=t.get(r.ownerId);if(a?.action.commentingRangesInfo===r.commentingRangesInfo){const s=new l(o.startLineNumber<a.range.startLineNumber?o.startLineNumber:a.range.startLineNumber,o.startColumn<a.range.startColumn?o.startColumn:a.range.startColumn,o.endLineNumber>a.range.endLineNumber?o.endLineNumber:a.range.endLineNumber,o.endColumn>a.range.endColumn?o.endColumn:a.range.endColumn);t.set(r.ownerId,{range:s,action:r})}else t.set(r.ownerId,{range:o,action:r})}}const n=new Set;return Array.from(t.values()).filter(i=>n.has(i.action.ownerId)?!1:(n.add(i.action.ownerId),!0))}getNearestCommentingRange(e,t){let n,i;if(t){i=[];for(let o=this.commentingRangeDecorations.length-1;o>=0;o--)i.push(this.commentingRangeDecorations[o])}else i=this.commentingRangeDecorations;for(const o of i){const r=o.getActiveRange();if(r){if(n&&this.areRangesIntersectingOrTouchingByLine(r,n)){n=l.plusRange(n,r);continue}if(r.startLineNumber<=e.lineNumber&&e.lineNumber<=r.endLineNumber){n=new l(r.startLineNumber,r.startColumn,r.endLineNumber,r.endColumn);continue}if(!(!t&&r.endLineNumber<e.lineNumber)&&!(t&&r.startLineNumber>e.lineNumber))return r}}return i.length>0?i[0].getActiveRange()??void 0:void 0}dispose(){this.commentingRangeDecorations=[]}}function yt(p,e){if(!p?.comment||!p?.thread?.comments)return;const t=p.thread.comments?.indexOf(p.comment);if(t===void 0||t<0||e==="previous"&&t===0||e==="next"&&t===p.thread.comments.length-1)return;const n=p.thread.comments?.[e==="previous"?t-1:t+1];if(n)return{...p,comment:n}}function Lt(p,e,t,n,i,o,r,a,s){if(!n.resource)return;p.isCommentingEnabled||p.enableCommenting(!0);const m=n.range,u=o?w.Editor:a?w.None:w.Widget,d=e.activeTextEditorControl,g=K(d)?[d.getOriginalEditor(),d.getModifiedEditor()]:d?[d]:[],c=n.threadId,h=i?.uniqueIdInThread,b=Ce.parse(n.resource);for(const C of g){const f=C.getModel();if(f instanceof $&&t.extUri.isEqual(b,f.uri)){c&&x(C)&&_.get(C)?.revealCommentThread(c,h,!0,u);return}}e.openEditor({resource:b,options:{pinned:r,preserveFocus:a,selection:m??new l(1,1,1,1)}},s?oe:ne).then(C=>{if(C){const f=C.getControl();c&&x(f)&&_.get(f)?.revealCommentThread(c,h,!0,u)}})}let _=class{constructor(e,t,n,i,o,r,a,s,m,u,d,g){this.commentService=t;this.instantiationService=n;this.codeEditorService=i;this.contextMenuService=o;this.quickInputService=r;this.viewsService=a;this.configurationService=s;this.editorService=u;this.keybindingService=d;this.accessibilityService=g;this._commentInfos=[],this._commentWidgets=[],this._pendingNewCommentCache={},this._pendingEditsCache={},this._computePromise=null,this._activeCursorHasCommentingRange=L.activeCursorHasCommentingRange.bindTo(m),this._activeCursorHasComment=L.activeCursorHasComment.bindTo(m),this._activeEditorHasCommentingRange=L.activeEditorHasCommentingRange.bindTo(m),!(e instanceof re)&&(this.editor=e,this._commentingRangeDecorator=new E,this.globalToDispose.add(this._commentingRangeDecorator.onDidChangeDecorationsCount(c=>{c===0?this.clearEditorListeners():this._editorDisposables.length===0&&this.registerEditorListeners()})),this.globalToDispose.add(this._commentThreadRangeDecorator=new le(this.commentService)),this.globalToDispose.add(this.commentService.onDidDeleteDataProvider(c=>{c?(delete this._pendingNewCommentCache[c],delete this._pendingEditsCache[c]):(this._pendingNewCommentCache={},this._pendingEditsCache={}),this.beginCompute()})),this.globalToDispose.add(this.commentService.onDidSetDataProvider(c=>this.beginComputeAndHandleEditorChange())),this.globalToDispose.add(this.commentService.onDidUpdateCommentingRanges(c=>this.beginComputeAndHandleEditorChange())),this.globalToDispose.add(this.commentService.onDidSetResourceCommentInfos(async c=>{const h=this.editor&&this.editor.hasModel()&&this.editor.getModel().uri;h&&h.toString()===c.resource.toString()&&await this.setComments(c.commentInfos.filter(b=>b!==null))})),this.globalToDispose.add(this.commentService.onDidChangeCommentingEnabled(c=>{c?(this.registerEditorListeners(),this.beginCompute()):(this.tryUpdateReservedSpace(),this.clearEditorListeners(),this._commentingRangeDecorator.update(this.editor,[]),this._commentThreadRangeDecorator.update(this.editor,[]),N(this._commentWidgets),this._commentWidgets=[])})),this.globalToDispose.add(this.editor.onWillChangeModel(c=>this.onWillChangeModel(c))),this.globalToDispose.add(this.editor.onDidChangeModel(c=>this.onModelChanged())),this.globalToDispose.add(this.configurationService.onDidChangeConfiguration(c=>{c.affectsConfiguration("diffEditor.renderSideBySide")&&this.beginCompute()})),this.onModelChanged(),this.codeEditorService.registerDecorationType("comment-controller",de,{}),this.globalToDispose.add(this.commentService.registerContinueOnCommentProvider({provideContinueOnComments:()=>{const c=[];if(this._commentWidgets)for(const h of this._commentWidgets){const C=h.getPendingComments().newComment;if(!C)continue;let f;if(h.commentThread.comments&&h.commentThread.comments.length){const D=h.commentThread.comments[h.commentThread.comments.length-1];typeof D.body=="string"?f=D.body:f=D.body.value}C!==f&&c.push({uniqueOwner:h.uniqueOwner,uri:h.editor.getModel().uri,range:h.commentThread.range,body:C,isReply:h.commentThread.comments!==void 0&&h.commentThread.comments.length>0})}return c}})))}globalToDispose=new A;localToDispose=new A;editor;_commentWidgets;_commentInfos;_commentingRangeDecorator;_commentThreadRangeDecorator;mouseDownInfo=null;_commentingRangeSpaceReserved=!1;_commentingRangeAmountReserved=0;_computePromise;_computeAndSetPromise;_addInProgress;_emptyThreadsToAddQueue=[];_computeCommentingRangePromise;_computeCommentingRangeScheduler;_pendingNewCommentCache;_pendingEditsCache;_inProcessContinueOnComments=new Map;_editorDisposables=[];_activeCursorHasCommentingRange;_activeCursorHasComment;_activeEditorHasCommentingRange;_hasRespondedToEditorChange=!1;registerEditorListeners(){this._editorDisposables=[],this.editor&&(this._editorDisposables.push(this.editor.onMouseMove(e=>this.onEditorMouseMove(e))),this._editorDisposables.push(this.editor.onMouseLeave(()=>this.onEditorMouseLeave())),this._editorDisposables.push(this.editor.onDidChangeCursorPosition(e=>this.onEditorChangeCursorPosition(e.position))),this._editorDisposables.push(this.editor.onDidFocusEditorWidget(()=>this.onEditorChangeCursorPosition(this.editor?.getPosition()??null))),this._editorDisposables.push(this.editor.onDidChangeCursorSelection(e=>this.onEditorChangeCursorSelection(e))),this._editorDisposables.push(this.editor.onDidBlurEditorWidget(()=>this.onEditorChangeCursorSelection())))}clearEditorListeners(){N(this._editorDisposables),this._editorDisposables=[]}onEditorMouseLeave(){this._commentingRangeDecorator.updateHover()}onEditorMouseMove(e){const t=e.target.position?.lineNumber;e.event.leftButton.valueOf()&&t&&this.mouseDownInfo?this._commentingRangeDecorator.updateSelection(t,new l(this.mouseDownInfo.lineNumber,1,t,1)):this._commentingRangeDecorator.updateHover(t)}onEditorChangeCursorSelection(e){const t=this.editor?.getPosition()?.lineNumber;t&&this._commentingRangeDecorator.updateSelection(t,e?.selection)}onEditorChangeCursorPosition(e){if(!e)return;const t=l.fromPositions(e,{column:-1,lineNumber:e.lineNumber}),n=this.editor?.getDecorationsInRange(t);let i=!1;if(n)for(const o of n)if(o.options.description===q.description){i=!1;break}else o.options.description===E.description&&(i=!0);this._activeCursorHasCommentingRange.set(i),this._activeCursorHasComment.set(this.getCommentsAtLine(t).length>0)}isEditorInlineOriginal(e){return this.configurationService.getValue("diffEditor.renderSideBySide")?!1:!!this.editorService.visibleTextEditorControls.find(n=>n.getEditorType()===G.IDiffEditor?n.getOriginalEditor()===e:!1)}beginCompute(){return this._computePromise=Z(e=>{const t=this.editor&&this.editor.hasModel()&&this.editor.getModel().uri;return t?this.commentService.getDocumentComments(t):Promise.resolve([])}),this._computeAndSetPromise=this._computePromise.then(async e=>{await this.setComments(M(e)),this._computePromise=null},e=>{}),this._computePromise.then(()=>this._computeAndSetPromise=void 0),this._computeAndSetPromise}beginComputeCommentingRanges(){this._computeCommentingRangeScheduler&&(this._computeCommentingRangePromise&&(this._computeCommentingRangePromise.cancel(),this._computeCommentingRangePromise=null),this._computeCommentingRangeScheduler.trigger(()=>{const e=this.editor&&this.editor.hasModel()&&this.editor.getModel().uri;return e?this.commentService.getDocumentComments(e):Promise.resolve([])}).then(e=>{if(this.commentService.isCommentingEnabled){const t=M(e);this._commentingRangeDecorator.update(this.editor,t,this.editor?.getPosition()?.lineNumber,this.editor?.getSelection()??void 0)}},e=>(F(e),null)))}static get(e){return e.getContribution(be)}revealCommentThread(e,t,n,i){const o=this._commentWidgets.filter(r=>r.commentThread.threadId===e);o.length===1?o[0].reveal(t,i):n&&(this._computeAndSetPromise?this._computeAndSetPromise.then(r=>{this.revealCommentThread(e,t,!1,i)}):this.beginCompute().then(r=>{this.revealCommentThread(e,t,!1,i)}))}collapseAll(){for(const e of this._commentWidgets)e.collapse()}expandAll(){for(const e of this._commentWidgets)e.expand()}expandUnresolved(){for(const e of this._commentWidgets)e.commentThread.state===W.CommentThreadState.Unresolved&&e.expand()}nextCommentThread(e){this._findNearestCommentThread(e)}_findNearestCommentThread(e,t){if(!this._commentWidgets.length||!this.editor?.hasModel())return;const n=t?this.editor.getSelection().getStartPosition():this.editor.getSelection().getEndPosition(),i=this._commentWidgets.sort((a,s)=>{if(t){const m=a;a=s,s=m}return a.commentThread.range===void 0?-1:s.commentThread.range===void 0?1:a.commentThread.range.startLineNumber<s.commentThread.range.startLineNumber?-1:a.commentThread.range.startLineNumber>s.commentThread.range.startLineNumber?1:a.commentThread.range.startColumn<s.commentThread.range.startColumn?-1:a.commentThread.range.startColumn>s.commentThread.range.startColumn?1:0}),o=V(i,a=>{const s=t?n.lineNumber:a.commentThread.range?.startLineNumber??0,m=t?a.commentThread.range?.startLineNumber??0:n.lineNumber,u=t?n.column:a.commentThread.range?.startColumn??0,d=t?a.commentThread.range?.startColumn??0:n.column;return s>m?!0:s<m?!1:u>d}),r=i[o];r!==void 0&&(this.editor.setSelection(r.commentThread.range??new l(1,1,1,1)),r.reveal(void 0,e?w.Widget:w.None))}previousCommentThread(e){this._findNearestCommentThread(e,!0)}_findNearestCommentingRange(e){if(!this.editor?.hasModel())return;const t=this.editor.getSelection().getEndPosition(),n=this._commentingRangeDecorator.getNearestCommentingRange(t,e);if(n){const i=e?n.getEndPosition():n.getStartPosition();this.editor.setPosition(i),this.editor.revealLineInCenterIfOutsideViewport(i.lineNumber)}if(this.accessibilityService.isScreenReaderOptimized()){const i=n?.getStartPosition().lineNumber,o=n?.getEndPosition().lineNumber;i&&o&&(i===o?T(R.localize("commentRange","Line {0}",i)):T(R.localize("commentRangeStart","Lines {0} to {1}",i,o)))}}nextCommentingRange(){this._findNearestCommentingRange()}previousCommentingRange(){this._findNearestCommentingRange(!0)}dispose(){this.globalToDispose.dispose(),this.localToDispose.dispose(),N(this._editorDisposables),N(this._commentWidgets),this.editor=null}onWillChangeModel(e){e.newModelUrl&&this.tryUpdateReservedSpace(e.newModelUrl)}async handleCommentAdded(e,t,n){if(this._commentWidgets.filter(d=>d.uniqueOwner===t&&d.commentThread.threadId===n.threadId).length)return;const o=this._commentWidgets.filter(d=>d.uniqueOwner===t&&d.commentThread.commentThreadHandle===-1&&l.equalsRange(d.commentThread.range,n.range));if(o.length){o[0].update(n);return}const r=this._inProcessContinueOnComments.get(t)?.findIndex(d=>d.range===void 0?n.range===void 0:l.lift(d.range).equalsRange(n.range));let a;r!==void 0&&r>=0&&(a=this._inProcessContinueOnComments.get(t)?.splice(r,1)[0].body);const s=(this._pendingNewCommentCache[t]&&this._pendingNewCommentCache[t][n.threadId])??a,m=this._pendingEditsCache[t]&&this._pendingEditsCache[t][n.threadId],u=n.canReply&&n.isTemplate&&(!n.comments||n.comments.length===0)&&(!n.editorId||n.editorId===e);await this.displayCommentThread(t,n,u,s,m),this._commentInfos.filter(d=>d.uniqueOwner===t)[0].threads.push(n),this.tryUpdateReservedSpace()}onModelChanged(){this.localToDispose.clear(),this.tryUpdateReservedSpace(),this.removeCommentWidgetsAndStoreCache(),this.editor&&(this._hasRespondedToEditorChange=!1,this.localToDispose.add(this.editor.onMouseDown(e=>this.onEditorMouseDown(e))),this.localToDispose.add(this.editor.onMouseUp(e=>this.onEditorMouseUp(e))),this._editorDisposables.length&&(this.clearEditorListeners(),this.registerEditorListeners()),this._computeCommentingRangeScheduler=new B(200),this.localToDispose.add({dispose:()=>{this._computeCommentingRangeScheduler?.cancel(),this._computeCommentingRangeScheduler=null}}),this.localToDispose.add(this.editor.onDidChangeModelContent(async()=>{this.beginComputeCommentingRanges()})),this.localToDispose.add(this.commentService.onDidUpdateCommentThreads(async e=>{const t=this.editor&&this.editor.hasModel()&&this.editor.getModel().uri;if(!t||!this.commentService.isCommentingEnabled)return;this._computePromise&&await this._computePromise;const n=this._commentInfos.filter(m=>m.uniqueOwner===e.uniqueOwner);if(!n||!n.length)return;const i=e.added.filter(m=>m.resource&&m.resource===t.toString()),o=e.removed.filter(m=>m.resource&&m.resource===t.toString()),r=e.changed.filter(m=>m.resource&&m.resource===t.toString()),a=e.pending.filter(m=>m.uri.toString()===t.toString());o.forEach(m=>{const u=this._commentWidgets.filter(g=>g.uniqueOwner===e.uniqueOwner&&g.commentThread.threadId===m.threadId&&g.commentThread.threadId!=="");if(u.length){const g=u[0],c=this._commentWidgets.indexOf(g);this._commentWidgets.splice(c,1),g.dispose()}const d=this._commentInfos.filter(g=>g.uniqueOwner===e.uniqueOwner)[0].threads;for(let g=0;g<d.length;g++)d[g]===m&&(d.splice(g,1),g--)});for(const m of r){const u=this._commentWidgets.filter(d=>d.uniqueOwner===e.uniqueOwner&&d.commentThread.threadId===m.threadId);u.length&&(u[0].update(m),this.openCommentsView(m))}const s=this.editor?.getId();for(const m of i)await this.handleCommentAdded(s,e.uniqueOwner,m);for(const m of a)await this.resumePendingComment(t,m);this._commentThreadRangeDecorator.update(this.editor,n)})),this.beginComputeAndHandleEditorChange())}async resumePendingComment(e,t){const n=this._commentWidgets.filter(i=>i.uniqueOwner===t.uniqueOwner&&l.lift(i.commentThread.range)?.equalsRange(t.range));if(t.isReply&&n.length)this.commentService.removeContinueOnComment({uniqueOwner:t.uniqueOwner,uri:e,range:t.range,isReply:!0}),n[0].setPendingComment(t.body);else if(n.length){this.commentService.removeContinueOnComment({uniqueOwner:t.uniqueOwner,uri:e,range:t.range,isReply:!1});const i=n[0].getPendingComments().newComment;let o;!i||t.body.includes(i)?o=t.body:i.includes(t.body)?o=i:o=`${i}
${t.body}`,n[0].setPendingComment(o)}else if(!t.isReply){if(!this.commentService.removeContinueOnComment({uniqueOwner:t.uniqueOwner,uri:e,range:t.range,isReply:!1}))return;this._inProcessContinueOnComments.has(t.uniqueOwner)||this._inProcessContinueOnComments.set(t.uniqueOwner,[]),this._inProcessContinueOnComments.get(t.uniqueOwner)?.push(t),await this.commentService.createCommentThreadTemplate(t.uniqueOwner,t.uri,t.range?l.lift(t.range):void 0)}}beginComputeAndHandleEditorChange(){this.beginCompute().then(()=>{if(!this._hasRespondedToEditorChange&&this._commentInfos.some(e=>e.commentingRanges.ranges.length>0||e.commentingRanges.fileComments))if(this._hasRespondedToEditorChange=!0,this.configurationService.getValue(ue.Comments)){const t=this.keybindingService.lookupKeybinding(he.OpenAccessibilityHelp)?.getAriaLabel();t?T(R.localize("hasCommentRangesKb","Editor has commenting ranges, run the command Open Accessibility Help ({0}), for more information.",t)):T(R.localize("hasCommentRangesNoKb","Editor has commenting ranges, run the command Open Accessibility Help, which is currently not triggerable via keybinding, for more information."))}else T(R.localize("hasCommentRanges","Editor has commenting ranges."))})}async openCommentsView(e){if(e.comments&&e.comments.length>0&&ve(e)){const t=this.configurationService.getValue(me).openView;if(t==="file")return this.viewsService.openView(y);if((t==="firstFile"||t==="firstFileUnresolved"&&e.state===W.CommentThreadState.Unresolved)&&!this.viewsService.getViewWithId(y)?.hasRendered)return this.viewsService.openView(y)}}async displayCommentThread(e,t,n,i,o){const r=this.editor?.getModel();if(!r||!this.editor||this.isEditorInlineOriginal(this.editor))return;let a;t.range&&!i&&(a=this.commentService.removeContinueOnComment({uniqueOwner:e,uri:r.uri,range:t.range,isReply:!0}));const s=this.instantiationService.createInstance(te,this.editor,e,t,i??a?.body,o);await s.display(t.range,n),this._commentWidgets.push(s),this.openCommentsView(t)}onEditorMouseDown(e){this.mouseDownInfo=ee(e)}onEditorMouseUp(e){const t=z(this.mouseDownInfo,e);if(this.mouseDownInfo=null,!this.editor||t===null||!e.target.element)return;const n=e.target.element.className.indexOf("comment-range-glyph")>=0,i=e.target.position.lineNumber;let o,r;t!==i?t>i?r=new l(t,this.editor.getModel().getLineLength(t)+1,i,1):r=new l(t,1,i,this.editor.getModel().getLineLength(i)+1):n&&(r=this.editor.getSelection()),r&&r.startLineNumber<=i&&i<=r.endLineNumber?(o=r,this.editor.setSelection(new l(r.endLineNumber,1,r.endLineNumber,1))):n&&(o=new l(i,1,i,1)),o&&this.addOrToggleCommentAtLine(o,e)}getCommentsAtLine(e){return this._commentWidgets.filter(t=>t.getGlyphPosition()===(e?e.endLineNumber:0))}async addOrToggleCommentAtLine(e,t){if(this._addInProgress)this._emptyThreadsToAddQueue.push([e,t]);else{this._addInProgress=!0;const n=this.getCommentsAtLine(e);if(n.length){const i=n.every(o=>o.expanded);n.forEach(i?o=>o.collapse():o=>o.expand(!0)),this.processNextThreadToAdd();return}else this.addCommentAtLine(e,t)}}processNextThreadToAdd(){this._addInProgress=!1;const e=this._emptyThreadsToAddQueue.shift();e&&this.addOrToggleCommentAtLine(e[0],e[1])}clipUserRangeToCommentRange(e,t){return e.startLineNumber<t.startLineNumber&&(e=new l(t.startLineNumber,t.startColumn,e.endLineNumber,e.endColumn)),e.endLineNumber>t.endLineNumber&&(e=new l(e.startLineNumber,e.startColumn,t.endLineNumber,t.endColumn)),e}addCommentAtLine(e,t){const n=this._commentingRangeDecorator.getMatchedCommentAction(e);if(!n.length||!this.editor?.hasModel()){if(this._addInProgress=!1,!n.length)throw new Error(`There are no commenting ranges at the current position (${e?"with range":"without range"}).`);return Promise.resolve()}if(n.length>1){if(t&&e)return this.contextMenuService.showContextMenu({getAnchor:()=>t.event,getActions:()=>this.getContextMenuActions(n,e),getActionsContext:()=>n.length?n[0]:void 0,onHide:()=>{this._addInProgress=!1}}),Promise.resolve();{const i=this.getCommentProvidersQuickPicks(n);return this.quickInputService.pick(i,{placeHolder:R.localize("pickCommentService","Select Comment Provider"),matchOnDescription:!0}).then(o=>{if(!o)return;const r=n.filter(a=>a.action.ownerId===o.id);if(r.length){const{ownerId:a}=r[0].action,s=e&&r[0].range?this.clipUserRangeToCommentRange(e,r[0].range):e;this.addCommentAtLine2(s,a)}}).then(()=>{this._addInProgress=!1})}}else{const{ownerId:i}=n[0].action,o=e&&n[0].range?this.clipUserRangeToCommentRange(e,n[0].range):e;this.addCommentAtLine2(o,i)}return Promise.resolve()}getCommentProvidersQuickPicks(e){return e.map(n=>{const{ownerId:i,extensionId:o,label:r}=n.action;return{label:r??o??i,id:i}})}getContextMenuActions(e,t){const n=[];return e.forEach(i=>{const{ownerId:o,extensionId:r,label:a}=i.action;n.push(new k("addCommentThread",`${a||r}`,void 0,!0,()=>{const s=i.range?this.clipUserRangeToCommentRange(t,i.range):t;return this.addCommentAtLine2(s,o),Promise.resolve()}))}),n}addCommentAtLine2(e,t){this.editor&&(this.commentService.createCommentThreadTemplate(t,this.editor.getModel().uri,e,this.editor.getId()),this.processNextThreadToAdd())}getExistingCommentEditorOptions(e){const t=e.getOption(S.lineDecorationsWidth);let n=[];const i=e.getRawOptions().extraEditorClassName;return i&&(n=i.split(" ")),{lineDecorationsWidth:t,extraEditorClassName:n}}getWithoutCommentsEditorOptions(e,t,n){let i=n;const o=t.findIndex(a=>a==="inline-comment");o>=0&&t.splice(o,1);const r=e.getOptions();return r.get(S.folding)&&r.get(S.showFoldingControls)!=="never"&&(i+=11),i-=24,{extraEditorClassName:t,lineDecorationsWidth:i}}getWithCommentsLineDecorationWidth(e,t){let n=t;const i=e.getOptions();return i.get(S.folding)&&i.get(S.showFoldingControls)!=="never"&&(n-=11),n+=24,this._commentingRangeAmountReserved=n,this._commentingRangeAmountReserved}getWithCommentsEditorOptions(e,t,n){return t.push("inline-comment"),{lineDecorationsWidth:this.getWithCommentsLineDecorationWidth(e,n),extraEditorClassName:t}}updateEditorLayoutOptions(e,t,n){e.updateOptions({extraEditorClassName:t.join(" "),lineDecorationsWidth:n})}ensureCommentingRangeReservedAmount(e){const t=this.getExistingCommentEditorOptions(e);t.lineDecorationsWidth!==this._commentingRangeAmountReserved&&e.updateOptions({lineDecorationsWidth:this.getWithCommentsLineDecorationWidth(e,t.lineDecorationsWidth)})}tryUpdateReservedSpace(e){if(!this.editor)return;const t=this._commentInfos.some(o=>!!(o.commentingRanges&&(Array.isArray(o.commentingRanges)?o.commentingRanges:o.commentingRanges.ranges).length)||o.threads.length>0);e=e??this.editor.getModel()?.uri;const n=e?this.commentService.resourceHasCommentingRanges(e):!1,i=t||n;if(i&&this.commentService.isCommentingEnabled)if(this._commentingRangeSpaceReserved)this.ensureCommentingRangeReservedAmount(this.editor);else{this._commentingRangeSpaceReserved=!0;const{lineDecorationsWidth:o,extraEditorClassName:r}=this.getExistingCommentEditorOptions(this.editor),a=this.getWithCommentsEditorOptions(this.editor,r,o);this.updateEditorLayoutOptions(this.editor,a.extraEditorClassName,a.lineDecorationsWidth)}else if((!i||!this.commentService.isCommentingEnabled)&&this._commentingRangeSpaceReserved){this._commentingRangeSpaceReserved=!1;const{lineDecorationsWidth:o,extraEditorClassName:r}=this.getExistingCommentEditorOptions(this.editor),a=this.getWithoutCommentsEditorOptions(this.editor,r,o);this.updateEditorLayoutOptions(this.editor,a.extraEditorClassName,a.lineDecorationsWidth)}}async setComments(e){if(!this.editor||!this.commentService.isCommentingEnabled)return;this._commentInfos=e,this.tryUpdateReservedSpace(),this.removeCommentWidgetsAndStoreCache();let t=!1;for(const n of this._commentInfos){!t&&(n.commentingRanges.ranges.length>0||n.commentingRanges.fileComments)&&(t=!0);const i=this._pendingNewCommentCache[n.uniqueOwner],o=this._pendingEditsCache[n.uniqueOwner];n.threads=n.threads.filter(r=>!r.isDisposed);for(const r of n.threads){let a;i&&(a=i[r.threadId]);let s;o&&(s=o[r.threadId]),await this.displayCommentThread(n.uniqueOwner,r,!1,a,s)}for(const r of n.pendingCommentThreads??[])this.resumePendingComment(this.editor.getModel().uri,r)}this._commentingRangeDecorator.update(this.editor,this._commentInfos),this._commentThreadRangeDecorator.update(this.editor,this._commentInfos),t?this._activeEditorHasCommentingRange.set(!0):this._activeEditorHasCommentingRange.set(!1)}closeWidget(){this._commentWidgets?.forEach(e=>e.hide()),this.editor&&(this.editor.focus(),this.editor.revealRangeInCenter(this.editor.getSelection()))}removeCommentWidgetsAndStoreCache(){this._commentWidgets&&this._commentWidgets.forEach(e=>{const t=e.getPendingComments(),n=t.newComment,i=this._pendingNewCommentCache[e.uniqueOwner];let o;if(e.commentThread.comments&&e.commentThread.comments.length){const s=e.commentThread.comments[e.commentThread.comments.length-1];typeof s.body=="string"?o=s.body:o=s.body.value}n&&n!==o?(i||(this._pendingNewCommentCache[e.uniqueOwner]={}),this._pendingNewCommentCache[e.uniqueOwner][e.commentThread.threadId]=n):i&&delete i[e.commentThread.threadId];const r=t.edits,a=this._pendingEditsCache[e.uniqueOwner];Object.keys(r).length>0?(a||(this._pendingEditsCache[e.uniqueOwner]={}),this._pendingEditsCache[e.uniqueOwner][e.commentThread.threadId]=r):a&&delete a[e.commentThread.threadId],e.dispose()}),this._commentWidgets=[]}};_=P([v(1,X),v(2,Y),v(3,Q),v(4,j),v(5,J),v(6,se),v(7,ae),v(8,ge),v(9,ie),v(10,pe),v(11,fe)],_);export{_ as CommentController,be as ID,yt as moveToNextCommentInThread,Lt as revealCommentThread};
