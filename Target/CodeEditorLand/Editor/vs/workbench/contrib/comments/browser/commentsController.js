var U=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var L=(v,e,t,n)=>{for(var i=n>1?void 0:n?k(e,t):e,r=v.length-1,o;r>=0;r--)(o=v[r])&&(i=(n?o(e,t,i):o(i))||i);return n&&i&&U(e,t,i),i},C=(v,e)=>(t,n)=>e(t,n,v);import{Action as H}from"../../../../../vs/base/common/actions.js";import{coalesce as P}from"../../../../../vs/base/common/arrays.js";import{findFirstIdxMonotonousOrArrLen as V}from"../../../../../vs/base/common/arraysFind.js";import{createCancelablePromise as Z,Delayer as B}from"../../../../../vs/base/common/async.js";import{onUnexpectedError as F}from"../../../../../vs/base/common/errors.js";import{DisposableStore as M,dispose as T}from"../../../../../vs/base/common/lifecycle.js";import"vs/css!./media/review";import{status as w}from"../../../../../vs/base/browser/ui/aria/aria.js";import{Emitter as K}from"../../../../../vs/base/common/event.js";import{URI as Q}from"../../../../../vs/base/common/uri.js";import{isCodeEditor as A,isDiffEditor as G}from"../../../../../vs/editor/browser/editorBrowser.js";import{ICodeEditorService as $}from"../../../../../vs/editor/browser/services/codeEditorService.js";import{EmbeddedCodeEditorWidget as j}from"../../../../../vs/editor/browser/widget/codeEditor/embeddedCodeEditorWidget.js";import{EditorOption as S}from"../../../../../vs/editor/common/config/editorOptions.js";import"../../../../../vs/editor/common/core/position.js";import{Range as l}from"../../../../../vs/editor/common/core/range.js";import"../../../../../vs/editor/common/cursorEvents.js";import{EditorType as Y}from"../../../../../vs/editor/common/editorCommon.js";import*as x from"../../../../../vs/editor/common/languages.js";import"../../../../../vs/editor/common/model.js";import{ModelDecorationOptions as O,TextModel as J}from"../../../../../vs/editor/common/model/textModel.js";import*as R from"../../../../../vs/nls.js";import{IAccessibilityService as X}from"../../../../../vs/platform/accessibility/common/accessibility.js";import{IConfigurationService as z}from"../../../../../vs/platform/configuration/common/configuration.js";import{IContextKeyService as ee}from"../../../../../vs/platform/contextkey/common/contextkey.js";import{IContextMenuService as te}from"../../../../../vs/platform/contextview/browser/contextView.js";import{IInstantiationService as ne}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{IKeybindingService as ie}from"../../../../../vs/platform/keybinding/common/keybinding.js";import{IQuickInputService as oe}from"../../../../../vs/platform/quickinput/common/quickInput.js";import"../../../../../vs/platform/uriIdentity/common/uriIdentity.js";import{AccessibilityVerbositySettingId as re}from"../../../../../vs/workbench/contrib/accessibility/browser/accessibilityConfiguration.js";import{AccessibilityCommandId as se}from"../../../../../vs/workbench/contrib/accessibility/common/accessibilityCommands.js";import{CommentGlyphWidget as W}from"../../../../../vs/workbench/contrib/comments/browser/commentGlyphWidget.js";import{COMMENTEDITOR_DECORATION_KEY as ae}from"../../../../../vs/workbench/contrib/comments/browser/commentReply.js";import{ICommentService as me}from"../../../../../vs/workbench/contrib/comments/browser/commentService.js";import{threadHasMeaningfulComments as de}from"../../../../../vs/workbench/contrib/comments/browser/commentsModel.js";import{COMMENTS_VIEW_ID as y}from"../../../../../vs/workbench/contrib/comments/browser/commentsTreeViewer.js";import"../../../../../vs/workbench/contrib/comments/browser/commentsView.js";import{CommentThreadRangeDecorator as ce}from"../../../../../vs/workbench/contrib/comments/browser/commentThreadRangeDecorator.js";import{CommentWidgetFocus as N,isMouseUpEventDragFromMouseDown as ge,parseMouseDownInfoFromEvent as le,ReviewZoneWidget as ue}from"../../../../../vs/workbench/contrib/comments/browser/commentThreadZoneWidget.js";import{CommentContextKeys as q}from"../../../../../vs/workbench/contrib/comments/common/commentContextKeys.js";import{COMMENTS_SECTION as he}from"../../../../../vs/workbench/contrib/comments/common/commentsConfiguration.js";import{ACTIVE_GROUP as pe,IEditorService as fe,SIDE_GROUP as Ce}from"../../../../../vs/workbench/services/editor/common/editorService.js";import{IViewsService as ve}from"../../../../../vs/workbench/services/views/common/viewsService.js";const be="editor.contrib.review";class I{constructor(e,t,n,i,r,o,a,s=!1){this._editor=e;this._ownerId=t;this._extensionId=n;this._label=i;this._range=r;this.options=o;this.commentingRangesInfo=a;this.isHover=s;this._startLineNumber=r.startLineNumber,this._endLineNumber=r.endLineNumber}_decorationId;_startLineNumber;_endLineNumber;get id(){return this._decorationId}set id(e){this._decorationId=e}get range(){return{startLineNumber:this._startLineNumber,startColumn:1,endLineNumber:this._endLineNumber,endColumn:1}}getCommentAction(){return{extensionId:this._extensionId,label:this._label,ownerId:this._ownerId,commentingRangesInfo:this.commentingRangesInfo}}getOriginalRange(){return this._range}getActiveRange(){return this.id?this._editor.getModel().getDecorationRange(this.id):void 0}}class E{static description="commenting-range-decorator";decorationOptions;hoverDecorationOptions;multilineDecorationOptions;commentingRangeDecorations=[];decorationIds=[];_editor;_infos;_lastHover=-1;_lastSelection;_lastSelectionCursor;_onDidChangeDecorationsCount=new K;onDidChangeDecorationsCount=this._onDidChangeDecorationsCount.event;constructor(){const e={description:E.description,isWholeLine:!0,linesDecorationsClassName:"comment-range-glyph comment-diff-added"};this.decorationOptions=O.createDynamic(e);const t={description:E.description,isWholeLine:!0,linesDecorationsClassName:"comment-range-glyph line-hover"};this.hoverDecorationOptions=O.createDynamic(t);const n={description:E.description,isWholeLine:!0,linesDecorationsClassName:"comment-range-glyph multiline-add"};this.multilineDecorationOptions=O.createDynamic(n)}updateHover(e){this._editor&&this._infos&&e!==this._lastHover&&this._doUpdate(this._editor,this._infos,e),this._lastHover=e??-1}updateSelection(e,t=new l(0,0,0,0)){this._lastSelection=t.isEmpty()?void 0:t,this._lastSelectionCursor=t.isEmpty()?void 0:e,this._editor&&this._infos&&this._doUpdate(this._editor,this._infos,e,t)}update(e,t,n,i){e&&(this._editor=e,this._infos=t,this._doUpdate(e,t,n,i))}_lineHasThread(e,t){return e.getDecorationsInRange(t)?.find(n=>n.options.description===W.description)}_doUpdate(e,t,n=-1,i=this._lastSelection){if(!e.getModel())return;n=this._lastSelectionCursor??n;const o=[];for(const s of t)s.commentingRanges.ranges.forEach(m=>{const u=new l(m.startLineNumber,m.startColumn,m.endLineNumber,m.endColumn);let d=i?u.intersectRanges(i):void 0;if(i&&n>=0&&d&&!(d.startLineNumber===d.endLineNumber&&n===d.startLineNumber)){let g;n<=d.startLineNumber?(g=d.collapseToStart(),d=new l(d.startLineNumber+1,1,d.endLineNumber,1)):(g=new l(d.endLineNumber,1,d.endLineNumber,1),d=new l(d.startLineNumber,1,d.endLineNumber-1,1)),o.push(new I(e,s.uniqueOwner,s.extensionId,s.label,d,this.multilineDecorationOptions,s.commentingRanges,!0)),this._lineHasThread(e,g)||o.push(new I(e,s.uniqueOwner,s.extensionId,s.label,g,this.hoverDecorationOptions,s.commentingRanges,!0));const c=Math.min(g.startLineNumber,d.startLineNumber)-1,h=u.startLineNumber<=c,b=Math.max(g.endLineNumber,d.endLineNumber)+1,f=u.endLineNumber>=b;if(h){const p=new l(m.startLineNumber,1,c,1);o.push(new I(e,s.uniqueOwner,s.extensionId,s.label,p,this.decorationOptions,s.commentingRanges,!0))}if(f){const p=new l(b,1,m.endLineNumber,1);o.push(new I(e,s.uniqueOwner,s.extensionId,s.label,p,this.decorationOptions,s.commentingRanges,!0))}}else if(u.startLineNumber<=n&&n<=u.endLineNumber){if(u.startLineNumber<n){const c=new l(m.startLineNumber,1,n-1,1);o.push(new I(e,s.uniqueOwner,s.extensionId,s.label,c,this.decorationOptions,s.commentingRanges,!0))}const g=new l(n,1,n,1);if(this._lineHasThread(e,g)||o.push(new I(e,s.uniqueOwner,s.extensionId,s.label,g,this.hoverDecorationOptions,s.commentingRanges,!0)),n<u.endLineNumber){const c=new l(n+1,1,m.endLineNumber,1);o.push(new I(e,s.uniqueOwner,s.extensionId,s.label,c,this.decorationOptions,s.commentingRanges,!0))}}else o.push(new I(e,s.uniqueOwner,s.extensionId,s.label,m,this.decorationOptions,s.commentingRanges))});e.changeDecorations(s=>{this.decorationIds=s.deltaDecorations(this.decorationIds,o),o.forEach((m,u)=>m.id=this.decorationIds[u])});const a=this.commentingRangeDecorations.length-o.length;this.commentingRangeDecorations=o,a&&this._onDidChangeDecorationsCount.fire(this.commentingRangeDecorations.length)}areRangesIntersectingOrTouchingByLine(e,t){return!(e.endLineNumber<t.startLineNumber-1||t.endLineNumber+1<e.startLineNumber)}getMatchedCommentAction(e){if(e===void 0){const i=this._infos?.filter(r=>r.commentingRanges.fileComments);return i?i.map(r=>({action:{ownerId:r.uniqueOwner,extensionId:r.extensionId,label:r.label,commentingRangesInfo:r.commentingRanges}})):[]}const t=new Map;for(const i of this.commentingRangeDecorations){const r=i.getActiveRange();if(r&&this.areRangesIntersectingOrTouchingByLine(r,e)){const o=i.getCommentAction(),a=t.get(o.ownerId);if(a?.action.commentingRangesInfo===o.commentingRangesInfo){const s=new l(r.startLineNumber<a.range.startLineNumber?r.startLineNumber:a.range.startLineNumber,r.startColumn<a.range.startColumn?r.startColumn:a.range.startColumn,r.endLineNumber>a.range.endLineNumber?r.endLineNumber:a.range.endLineNumber,r.endColumn>a.range.endColumn?r.endColumn:a.range.endColumn);t.set(o.ownerId,{range:s,action:o})}else t.set(o.ownerId,{range:r,action:o})}}const n=new Set;return Array.from(t.values()).filter(i=>n.has(i.action.ownerId)?!1:(n.add(i.action.ownerId),!0))}getNearestCommentingRange(e,t){let n,i;if(t){i=[];for(let r=this.commentingRangeDecorations.length-1;r>=0;r--)i.push(this.commentingRangeDecorations[r])}else i=this.commentingRangeDecorations;for(const r of i){const o=r.getActiveRange();if(o){if(n&&this.areRangesIntersectingOrTouchingByLine(o,n)){n=l.plusRange(n,o);continue}if(o.startLineNumber<=e.lineNumber&&e.lineNumber<=o.endLineNumber){n=new l(o.startLineNumber,o.startColumn,o.endLineNumber,o.endColumn);continue}if(!(!t&&o.endLineNumber<e.lineNumber)&&!(t&&o.startLineNumber>e.lineNumber))return o}}return i.length>0?i[0].getActiveRange()??void 0:void 0}dispose(){this.commentingRangeDecorations=[]}}function yt(v,e,t,n,i,r,o,a,s){if(!n.resource)return;v.isCommentingEnabled||v.enableCommenting(!0);const m=n.range,u=r?N.Editor:a?N.None:N.Widget,d=e.activeTextEditorControl,g=G(d)?[d.getOriginalEditor(),d.getModifiedEditor()]:d?[d]:[],c=n.threadId,h=i?.uniqueIdInThread,b=Q.parse(n.resource);for(const f of g){const p=f.getModel();if(p instanceof J&&t.extUri.isEqual(b,p.uri)){c&&A(f)&&_.get(f)?.revealCommentThread(c,h,!0,u);return}}e.openEditor({resource:b,options:{pinned:o,preserveFocus:a,selection:m??new l(1,1,1,1)}},s?Ce:pe).then(f=>{if(f){const p=f.getControl();c&&A(p)&&_.get(p)?.revealCommentThread(c,h,!0,u)}})}let _=class{constructor(e,t,n,i,r,o,a,s,m,u,d,g){this.commentService=t;this.instantiationService=n;this.codeEditorService=i;this.contextMenuService=r;this.quickInputService=o;this.viewsService=a;this.configurationService=s;this.editorService=u;this.keybindingService=d;this.accessibilityService=g;this._commentInfos=[],this._commentWidgets=[],this._pendingNewCommentCache={},this._pendingEditsCache={},this._computePromise=null,this._activeCursorHasCommentingRange=q.activeCursorHasCommentingRange.bindTo(m),this._activeEditorHasCommentingRange=q.activeEditorHasCommentingRange.bindTo(m),!(e instanceof j)&&(this.editor=e,this._commentingRangeDecorator=new E,this.globalToDispose.add(this._commentingRangeDecorator.onDidChangeDecorationsCount(c=>{c===0?this.clearEditorListeners():this._editorDisposables.length===0&&this.registerEditorListeners()})),this.globalToDispose.add(this._commentThreadRangeDecorator=new ce(this.commentService)),this.globalToDispose.add(this.commentService.onDidDeleteDataProvider(c=>{c?(delete this._pendingNewCommentCache[c],delete this._pendingEditsCache[c]):(this._pendingNewCommentCache={},this._pendingEditsCache={}),this.beginCompute()})),this.globalToDispose.add(this.commentService.onDidSetDataProvider(c=>this.beginComputeAndHandleEditorChange())),this.globalToDispose.add(this.commentService.onDidUpdateCommentingRanges(c=>this.beginComputeAndHandleEditorChange())),this.globalToDispose.add(this.commentService.onDidSetResourceCommentInfos(async c=>{const h=this.editor&&this.editor.hasModel()&&this.editor.getModel().uri;h&&h.toString()===c.resource.toString()&&await this.setComments(c.commentInfos.filter(b=>b!==null))})),this.globalToDispose.add(this.commentService.onDidChangeCommentingEnabled(c=>{c?(this.registerEditorListeners(),this.beginCompute()):(this.tryUpdateReservedSpace(),this.clearEditorListeners(),this._commentingRangeDecorator.update(this.editor,[]),this._commentThreadRangeDecorator.update(this.editor,[]),T(this._commentWidgets),this._commentWidgets=[])})),this.globalToDispose.add(this.editor.onWillChangeModel(c=>this.onWillChangeModel(c))),this.globalToDispose.add(this.editor.onDidChangeModel(c=>this.onModelChanged())),this.globalToDispose.add(this.configurationService.onDidChangeConfiguration(c=>{c.affectsConfiguration("diffEditor.renderSideBySide")&&this.beginCompute()})),this.onModelChanged(),this.codeEditorService.registerDecorationType("comment-controller",ae,{}),this.globalToDispose.add(this.commentService.registerContinueOnCommentProvider({provideContinueOnComments:()=>{const c=[];if(this._commentWidgets)for(const h of this._commentWidgets){const f=h.getPendingComments().newComment;if(!f)continue;let p;if(h.commentThread.comments&&h.commentThread.comments.length){const D=h.commentThread.comments[h.commentThread.comments.length-1];typeof D.body=="string"?p=D.body:p=D.body.value}f!==p&&c.push({uniqueOwner:h.uniqueOwner,uri:h.editor.getModel().uri,range:h.commentThread.range,body:f,isReply:h.commentThread.comments!==void 0&&h.commentThread.comments.length>0})}return c}})))}globalToDispose=new M;localToDispose=new M;editor;_commentWidgets;_commentInfos;_commentingRangeDecorator;_commentThreadRangeDecorator;mouseDownInfo=null;_commentingRangeSpaceReserved=!1;_commentingRangeAmountReserved=0;_computePromise;_computeAndSetPromise;_addInProgress;_emptyThreadsToAddQueue=[];_computeCommentingRangePromise;_computeCommentingRangeScheduler;_pendingNewCommentCache;_pendingEditsCache;_inProcessContinueOnComments=new Map;_editorDisposables=[];_activeCursorHasCommentingRange;_activeEditorHasCommentingRange;_hasRespondedToEditorChange=!1;registerEditorListeners(){this._editorDisposables=[],this.editor&&(this._editorDisposables.push(this.editor.onMouseMove(e=>this.onEditorMouseMove(e))),this._editorDisposables.push(this.editor.onMouseLeave(()=>this.onEditorMouseLeave())),this._editorDisposables.push(this.editor.onDidChangeCursorPosition(e=>this.onEditorChangeCursorPosition(e.position))),this._editorDisposables.push(this.editor.onDidFocusEditorWidget(()=>this.onEditorChangeCursorPosition(this.editor?.getPosition()??null))),this._editorDisposables.push(this.editor.onDidChangeCursorSelection(e=>this.onEditorChangeCursorSelection(e))),this._editorDisposables.push(this.editor.onDidBlurEditorWidget(()=>this.onEditorChangeCursorSelection())))}clearEditorListeners(){T(this._editorDisposables),this._editorDisposables=[]}onEditorMouseLeave(){this._commentingRangeDecorator.updateHover()}onEditorMouseMove(e){const t=e.target.position?.lineNumber;e.event.leftButton.valueOf()&&t&&this.mouseDownInfo?this._commentingRangeDecorator.updateSelection(t,new l(this.mouseDownInfo.lineNumber,1,t,1)):this._commentingRangeDecorator.updateHover(t)}onEditorChangeCursorSelection(e){const t=this.editor?.getPosition()?.lineNumber;t&&this._commentingRangeDecorator.updateSelection(t,e?.selection)}onEditorChangeCursorPosition(e){const t=e?this.editor?.getDecorationsInRange(l.fromPositions(e,{column:-1,lineNumber:e.lineNumber})):void 0;let n=!1;if(t)for(const i of t)if(i.options.description===W.description){n=!1;break}else i.options.description===E.description&&(n=!0);this._activeCursorHasCommentingRange.set(n)}isEditorInlineOriginal(e){return this.configurationService.getValue("diffEditor.renderSideBySide")?!1:!!this.editorService.visibleTextEditorControls.find(n=>n.getEditorType()===Y.IDiffEditor?n.getOriginalEditor()===e:!1)}beginCompute(){return this._computePromise=Z(e=>{const t=this.editor&&this.editor.hasModel()&&this.editor.getModel().uri;return t?this.commentService.getDocumentComments(t):Promise.resolve([])}),this._computeAndSetPromise=this._computePromise.then(async e=>{await this.setComments(P(e)),this._computePromise=null},e=>console.log(e)),this._computePromise.then(()=>this._computeAndSetPromise=void 0),this._computeAndSetPromise}beginComputeCommentingRanges(){this._computeCommentingRangeScheduler&&(this._computeCommentingRangePromise&&(this._computeCommentingRangePromise.cancel(),this._computeCommentingRangePromise=null),this._computeCommentingRangeScheduler.trigger(()=>{const e=this.editor&&this.editor.hasModel()&&this.editor.getModel().uri;return e?this.commentService.getDocumentComments(e):Promise.resolve([])}).then(e=>{if(this.commentService.isCommentingEnabled){const t=P(e);this._commentingRangeDecorator.update(this.editor,t,this.editor?.getPosition()?.lineNumber,this.editor?.getSelection()??void 0)}},e=>(F(e),null)))}static get(e){return e.getContribution(be)}revealCommentThread(e,t,n,i){const r=this._commentWidgets.filter(o=>o.commentThread.threadId===e);r.length===1?r[0].reveal(t,i):n&&(this._computeAndSetPromise?this._computeAndSetPromise.then(o=>{this.revealCommentThread(e,t,!1,i)}):this.beginCompute().then(o=>{this.revealCommentThread(e,t,!1,i)}))}collapseAll(){for(const e of this._commentWidgets)e.collapse()}expandAll(){for(const e of this._commentWidgets)e.expand()}expandUnresolved(){for(const e of this._commentWidgets)e.commentThread.state===x.CommentThreadState.Unresolved&&e.expand()}nextCommentThread(){this._findNearestCommentThread()}_findNearestCommentThread(e){if(!this._commentWidgets.length||!this.editor?.hasModel())return;const t=e?this.editor.getSelection().getStartPosition():this.editor.getSelection().getEndPosition(),n=this._commentWidgets.sort((o,a)=>{if(e){const s=o;o=a,a=s}return o.commentThread.range===void 0?-1:a.commentThread.range===void 0?1:o.commentThread.range.startLineNumber<a.commentThread.range.startLineNumber?-1:o.commentThread.range.startLineNumber>a.commentThread.range.startLineNumber?1:o.commentThread.range.startColumn<a.commentThread.range.startColumn?-1:o.commentThread.range.startColumn>a.commentThread.range.startColumn?1:0}),i=V(n,o=>{const a=e?t.lineNumber:o.commentThread.range?.startLineNumber??0,s=e?o.commentThread.range?.startLineNumber??0:t.lineNumber,m=e?t.column:o.commentThread.range?.startColumn??0,u=e?o.commentThread.range?.startColumn??0:t.column;return a>s?!0:a<s?!1:m>u});let r;i===this._commentWidgets.length?r=this._commentWidgets[0]:r=n[i],this.editor.setSelection(r.commentThread.range??new l(1,1,1,1)),r.reveal(void 0,N.Widget)}previousCommentThread(){this._findNearestCommentThread(!0)}_findNearestCommentingRange(e){if(!this.editor?.hasModel())return;const t=this.editor.getSelection().getEndPosition(),n=this._commentingRangeDecorator.getNearestCommentingRange(t,e);if(n){const i=e?n.getEndPosition():n.getStartPosition();this.editor.setPosition(i),this.editor.revealLineInCenterIfOutsideViewport(i.lineNumber)}if(this.accessibilityService.isScreenReaderOptimized()){const i=n?.getStartPosition().lineNumber,r=n?.getEndPosition().lineNumber;i&&r&&(i===r?w(R.localize("commentRange","Line {0}",i)):w(R.localize("commentRangeStart","Lines {0} to {1}",i,r)))}}nextCommentingRange(){this._findNearestCommentingRange()}previousCommentingRange(){this._findNearestCommentingRange(!0)}dispose(){this.globalToDispose.dispose(),this.localToDispose.dispose(),T(this._editorDisposables),T(this._commentWidgets),this.editor=null}onWillChangeModel(e){e.newModelUrl&&this.tryUpdateReservedSpace(e.newModelUrl)}async handleCommentAdded(e,t,n){if(this._commentWidgets.filter(d=>d.uniqueOwner===t&&d.commentThread.threadId===n.threadId).length)return;const r=this._commentWidgets.filter(d=>d.uniqueOwner===t&&d.commentThread.commentThreadHandle===-1&&l.equalsRange(d.commentThread.range,n.range));if(r.length){r[0].update(n);return}const o=this._inProcessContinueOnComments.get(t)?.findIndex(d=>d.range===void 0?n.range===void 0:l.lift(d.range).equalsRange(n.range));let a;o!==void 0&&o>=0&&(a=this._inProcessContinueOnComments.get(t)?.splice(o,1)[0].body);const s=(this._pendingNewCommentCache[t]&&this._pendingNewCommentCache[t][n.threadId])??a,m=this._pendingEditsCache[t]&&this._pendingEditsCache[t][n.threadId],u=n.canReply&&n.isTemplate&&(!n.comments||n.comments.length===0)&&(!n.editorId||n.editorId===e);await this.displayCommentThread(t,n,u,s,m),this._commentInfos.filter(d=>d.uniqueOwner===t)[0].threads.push(n),this.tryUpdateReservedSpace()}onModelChanged(){this.localToDispose.clear(),this.tryUpdateReservedSpace(),this.removeCommentWidgetsAndStoreCache(),this.editor&&(this._hasRespondedToEditorChange=!1,this.localToDispose.add(this.editor.onMouseDown(e=>this.onEditorMouseDown(e))),this.localToDispose.add(this.editor.onMouseUp(e=>this.onEditorMouseUp(e))),this._editorDisposables.length&&(this.clearEditorListeners(),this.registerEditorListeners()),this._computeCommentingRangeScheduler=new B(200),this.localToDispose.add({dispose:()=>{this._computeCommentingRangeScheduler?.cancel(),this._computeCommentingRangeScheduler=null}}),this.localToDispose.add(this.editor.onDidChangeModelContent(async()=>{this.beginComputeCommentingRanges()})),this.localToDispose.add(this.commentService.onDidUpdateCommentThreads(async e=>{const t=this.editor&&this.editor.hasModel()&&this.editor.getModel().uri;if(!t||!this.commentService.isCommentingEnabled)return;this._computePromise&&await this._computePromise;const n=this._commentInfos.filter(m=>m.uniqueOwner===e.uniqueOwner);if(!n||!n.length)return;const i=e.added.filter(m=>m.resource&&m.resource===t.toString()),r=e.removed.filter(m=>m.resource&&m.resource===t.toString()),o=e.changed.filter(m=>m.resource&&m.resource===t.toString()),a=e.pending.filter(m=>m.uri.toString()===t.toString());r.forEach(m=>{const u=this._commentWidgets.filter(g=>g.uniqueOwner===e.uniqueOwner&&g.commentThread.threadId===m.threadId&&g.commentThread.threadId!=="");if(u.length){const g=u[0],c=this._commentWidgets.indexOf(g);this._commentWidgets.splice(c,1),g.dispose()}const d=this._commentInfos.filter(g=>g.uniqueOwner===e.uniqueOwner)[0].threads;for(let g=0;g<d.length;g++)d[g]===m&&(d.splice(g,1),g--)});for(const m of o){const u=this._commentWidgets.filter(d=>d.uniqueOwner===e.uniqueOwner&&d.commentThread.threadId===m.threadId);u.length&&(u[0].update(m),this.openCommentsView(m))}const s=this.editor?.getId();for(const m of i)await this.handleCommentAdded(s,e.uniqueOwner,m);for(const m of a)await this.resumePendingComment(t,m);this._commentThreadRangeDecorator.update(this.editor,n)})),this.beginComputeAndHandleEditorChange())}async resumePendingComment(e,t){const n=this._commentWidgets.filter(i=>i.uniqueOwner===t.uniqueOwner&&l.lift(i.commentThread.range)?.equalsRange(t.range));if(t.isReply&&n.length)this.commentService.removeContinueOnComment({uniqueOwner:t.uniqueOwner,uri:e,range:t.range,isReply:!0}),n[0].setPendingComment(t.body);else if(n.length){this.commentService.removeContinueOnComment({uniqueOwner:t.uniqueOwner,uri:e,range:t.range,isReply:!1});const i=n[0].getPendingComments().newComment;let r;!i||t.body.includes(i)?r=t.body:i.includes(t.body)?r=i:r=`${i}
${t.body}`,n[0].setPendingComment(r)}else if(!t.isReply){if(!this.commentService.removeContinueOnComment({uniqueOwner:t.uniqueOwner,uri:e,range:t.range,isReply:!1}))return;this._inProcessContinueOnComments.has(t.uniqueOwner)||this._inProcessContinueOnComments.set(t.uniqueOwner,[]),this._inProcessContinueOnComments.get(t.uniqueOwner)?.push(t),await this.commentService.createCommentThreadTemplate(t.uniqueOwner,t.uri,t.range?l.lift(t.range):void 0)}}beginComputeAndHandleEditorChange(){this.beginCompute().then(()=>{if(!this._hasRespondedToEditorChange&&this._commentInfos.some(e=>e.commentingRanges.ranges.length>0||e.commentingRanges.fileComments))if(this._hasRespondedToEditorChange=!0,this.configurationService.getValue(re.Comments)){const t=this.keybindingService.lookupKeybinding(se.OpenAccessibilityHelp)?.getAriaLabel();t?w(R.localize("hasCommentRangesKb","Editor has commenting ranges, run the command Open Accessibility Help ({0}), for more information.",t)):w(R.localize("hasCommentRangesNoKb","Editor has commenting ranges, run the command Open Accessibility Help, which is currently not triggerable via keybinding, for more information."))}else w(R.localize("hasCommentRanges","Editor has commenting ranges."))})}async openCommentsView(e){if(e.comments&&e.comments.length>0&&de(e)){const t=this.configurationService.getValue(he).openView;if(t==="file")return this.viewsService.openView(y);if((t==="firstFile"||t==="firstFileUnresolved"&&e.state===x.CommentThreadState.Unresolved)&&!this.viewsService.getViewWithId(y)?.hasRendered)return this.viewsService.openView(y)}}async displayCommentThread(e,t,n,i,r){const o=this.editor?.getModel();if(!o||!this.editor||this.isEditorInlineOriginal(this.editor))return;let a;t.range&&!i&&(a=this.commentService.removeContinueOnComment({uniqueOwner:e,uri:o.uri,range:t.range,isReply:!0}));const s=this.instantiationService.createInstance(ue,this.editor,e,t,i??a?.body,r);await s.display(t.range,n),this._commentWidgets.push(s),this.openCommentsView(t)}onEditorMouseDown(e){this.mouseDownInfo=le(e)}onEditorMouseUp(e){const t=ge(this.mouseDownInfo,e);if(this.mouseDownInfo=null,!this.editor||t===null||!e.target.element)return;const n=e.target.element.className.indexOf("comment-range-glyph")>=0,i=e.target.position.lineNumber;let r,o;t!==i?t>i?o=new l(t,this.editor.getModel().getLineLength(t)+1,i,1):o=new l(t,1,i,this.editor.getModel().getLineLength(i)+1):n&&(o=this.editor.getSelection()),o&&o.startLineNumber<=i&&i<=o.endLineNumber?(r=o,this.editor.setSelection(new l(o.endLineNumber,1,o.endLineNumber,1))):n&&(r=new l(i,1,i,1)),r&&this.addOrToggleCommentAtLine(r,e)}async addOrToggleCommentAtLine(e,t){if(this._addInProgress)this._emptyThreadsToAddQueue.push([e,t]);else{this._addInProgress=!0;const n=this._commentWidgets.filter(i=>i.getGlyphPosition()===(e?e.endLineNumber:0));if(n.length){const i=n.every(r=>r.expanded);n.forEach(i?r=>r.collapse():r=>r.expand(!0)),this.processNextThreadToAdd();return}else this.addCommentAtLine(e,t)}}processNextThreadToAdd(){this._addInProgress=!1;const e=this._emptyThreadsToAddQueue.shift();e&&this.addOrToggleCommentAtLine(e[0],e[1])}clipUserRangeToCommentRange(e,t){return e.startLineNumber<t.startLineNumber&&(e=new l(t.startLineNumber,t.startColumn,e.endLineNumber,e.endColumn)),e.endLineNumber>t.endLineNumber&&(e=new l(e.startLineNumber,e.startColumn,t.endLineNumber,t.endColumn)),e}addCommentAtLine(e,t){const n=this._commentingRangeDecorator.getMatchedCommentAction(e);if(!n.length||!this.editor?.hasModel()){if(this._addInProgress=!1,!n.length)throw new Error(`There are no commenting ranges at the current position (${e?"with range":"without range"}).`);return Promise.resolve()}if(n.length>1){if(t&&e)return this.contextMenuService.showContextMenu({getAnchor:()=>t.event,getActions:()=>this.getContextMenuActions(n,e),getActionsContext:()=>n.length?n[0]:void 0,onHide:()=>{this._addInProgress=!1}}),Promise.resolve();{const i=this.getCommentProvidersQuickPicks(n);return this.quickInputService.pick(i,{placeHolder:R.localize("pickCommentService","Select Comment Provider"),matchOnDescription:!0}).then(r=>{if(!r)return;const o=n.filter(a=>a.action.ownerId===r.id);if(o.length){const{ownerId:a}=o[0].action,s=e&&o[0].range?this.clipUserRangeToCommentRange(e,o[0].range):e;this.addCommentAtLine2(s,a)}}).then(()=>{this._addInProgress=!1})}}else{const{ownerId:i}=n[0].action,r=e&&n[0].range?this.clipUserRangeToCommentRange(e,n[0].range):e;this.addCommentAtLine2(r,i)}return Promise.resolve()}getCommentProvidersQuickPicks(e){return e.map(n=>{const{ownerId:i,extensionId:r,label:o}=n.action;return{label:o??r??i,id:i}})}getContextMenuActions(e,t){const n=[];return e.forEach(i=>{const{ownerId:r,extensionId:o,label:a}=i.action;n.push(new H("addCommentThread",`${a||o}`,void 0,!0,()=>{const s=i.range?this.clipUserRangeToCommentRange(t,i.range):t;return this.addCommentAtLine2(s,r),Promise.resolve()}))}),n}addCommentAtLine2(e,t){this.editor&&(this.commentService.createCommentThreadTemplate(t,this.editor.getModel().uri,e,this.editor.getId()),this.processNextThreadToAdd())}getExistingCommentEditorOptions(e){const t=e.getOption(S.lineDecorationsWidth);let n=[];const i=e.getRawOptions().extraEditorClassName;return i&&(n=i.split(" ")),{lineDecorationsWidth:t,extraEditorClassName:n}}getWithoutCommentsEditorOptions(e,t,n){let i=n;const r=t.findIndex(a=>a==="inline-comment");r>=0&&t.splice(r,1);const o=e.getOptions();return o.get(S.folding)&&o.get(S.showFoldingControls)!=="never"&&(i+=11),i-=24,{extraEditorClassName:t,lineDecorationsWidth:i}}getWithCommentsLineDecorationWidth(e,t){let n=t;const i=e.getOptions();return i.get(S.folding)&&i.get(S.showFoldingControls)!=="never"&&(n-=11),n+=24,this._commentingRangeAmountReserved=n,this._commentingRangeAmountReserved}getWithCommentsEditorOptions(e,t,n){return t.push("inline-comment"),{lineDecorationsWidth:this.getWithCommentsLineDecorationWidth(e,n),extraEditorClassName:t}}updateEditorLayoutOptions(e,t,n){e.updateOptions({extraEditorClassName:t.join(" "),lineDecorationsWidth:n})}ensureCommentingRangeReservedAmount(e){const t=this.getExistingCommentEditorOptions(e);t.lineDecorationsWidth!==this._commentingRangeAmountReserved&&e.updateOptions({lineDecorationsWidth:this.getWithCommentsLineDecorationWidth(e,t.lineDecorationsWidth)})}tryUpdateReservedSpace(e){if(!this.editor)return;const t=this._commentInfos.some(r=>!!(r.commentingRanges&&(Array.isArray(r.commentingRanges)?r.commentingRanges:r.commentingRanges.ranges).length)||r.threads.length>0);e=e??this.editor.getModel()?.uri;const n=e?this.commentService.resourceHasCommentingRanges(e):!1,i=t||n;if(i&&this.commentService.isCommentingEnabled)if(this._commentingRangeSpaceReserved)this.ensureCommentingRangeReservedAmount(this.editor);else{this._commentingRangeSpaceReserved=!0;const{lineDecorationsWidth:r,extraEditorClassName:o}=this.getExistingCommentEditorOptions(this.editor),a=this.getWithCommentsEditorOptions(this.editor,o,r);this.updateEditorLayoutOptions(this.editor,a.extraEditorClassName,a.lineDecorationsWidth)}else if((!i||!this.commentService.isCommentingEnabled)&&this._commentingRangeSpaceReserved){this._commentingRangeSpaceReserved=!1;const{lineDecorationsWidth:r,extraEditorClassName:o}=this.getExistingCommentEditorOptions(this.editor),a=this.getWithoutCommentsEditorOptions(this.editor,o,r);this.updateEditorLayoutOptions(this.editor,a.extraEditorClassName,a.lineDecorationsWidth)}}async setComments(e){if(!this.editor||!this.commentService.isCommentingEnabled)return;this._commentInfos=e,this.tryUpdateReservedSpace(),this.removeCommentWidgetsAndStoreCache();let t=!1;for(const n of this._commentInfos){!t&&(n.commentingRanges.ranges.length>0||n.commentingRanges.fileComments)&&(t=!0);const i=this._pendingNewCommentCache[n.uniqueOwner],r=this._pendingEditsCache[n.uniqueOwner];n.threads=n.threads.filter(o=>!o.isDisposed);for(const o of n.threads){let a;i&&(a=i[o.threadId]);let s;r&&(s=r[o.threadId]),await this.displayCommentThread(n.uniqueOwner,o,!1,a,s)}for(const o of n.pendingCommentThreads??[])this.resumePendingComment(this.editor.getModel().uri,o)}this._commentingRangeDecorator.update(this.editor,this._commentInfos),this._commentThreadRangeDecorator.update(this.editor,this._commentInfos),t?this._activeEditorHasCommentingRange.set(!0):this._activeEditorHasCommentingRange.set(!1)}closeWidget(){this._commentWidgets?.forEach(e=>e.hide()),this.editor&&(this.editor.focus(),this.editor.revealRangeInCenter(this.editor.getSelection()))}removeCommentWidgetsAndStoreCache(){this._commentWidgets&&this._commentWidgets.forEach(e=>{const t=e.getPendingComments(),n=t.newComment,i=this._pendingNewCommentCache[e.uniqueOwner];let r;if(e.commentThread.comments&&e.commentThread.comments.length){const s=e.commentThread.comments[e.commentThread.comments.length-1];typeof s.body=="string"?r=s.body:r=s.body.value}n&&n!==r?(i||(this._pendingNewCommentCache[e.uniqueOwner]={}),this._pendingNewCommentCache[e.uniqueOwner][e.commentThread.threadId]=n):i&&delete i[e.commentThread.threadId];const o=t.edits,a=this._pendingEditsCache[e.uniqueOwner];Object.keys(o).length>0?(a||(this._pendingEditsCache[e.uniqueOwner]={}),this._pendingEditsCache[e.uniqueOwner][e.commentThread.threadId]=o):a&&delete a[e.commentThread.threadId],e.dispose()}),this._commentWidgets=[]}};_=L([C(1,me),C(2,ne),C(3,$),C(4,te),C(5,oe),C(6,ve),C(7,z),C(8,ee),C(9,fe),C(10,ie),C(11,X)],_);export{_ as CommentController,be as ID,yt as revealCommentThread};
