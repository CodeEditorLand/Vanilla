var I=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var _=(o,r,e,t)=>{for(var i=t>1?void 0:t?w(r,e):r,n=o.length-1,s;n>=0;n--)(s=o[n])&&(i=(t?s(r,e,i):s(i))||i);return t&&i&&I(r,e,i),i},l=(o,r)=>(e,t)=>r(e,t,o);import"../../../../base/browser/dom.js";import{Color as T}from"../../../../base/common/color.js";import{Emitter as C}from"../../../../base/common/event.js";import{DisposableStore as E}from"../../../../base/common/lifecycle.js";import{MouseTargetType as b}from"../../../../editor/browser/editorBrowser.js";import"../../../../editor/common/core/position.js";import{Range as m}from"../../../../editor/common/core/range.js";import*as a from"../../../../editor/common/languages.js";import{ZoneWidget as N}from"../../../../editor/contrib/zoneWidget/browser/zoneWidget.js";import{IContextKeyService as f}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as D}from"../../../../platform/instantiation/common/instantiation.js";import{IThemeService as L}from"../../../../platform/theme/common/themeService.js";import{CommentGlyphWidget as W}from"./commentGlyphWidget.js";import{ICommentService as x}from"./commentService.js";import"../common/commentThreadWidget.js";import{EDITOR_FONT_DEFAULTS as P,EditorOption as c}from"../../../../editor/common/config/editorOptions.js";import{ServiceCollection as O}from"../../../../platform/instantiation/common/serviceCollection.js";import{CommentThreadWidget as R}from"./commentThreadWidget.js";import"../../notebook/common/notebookRange.js";import{commentThreadStateBackgroundColorVar as G,commentThreadStateColorVar as M,getCommentThreadStateBorderColor as F}from"./commentColors.js";import{peekViewBorder as k}from"../../../../editor/contrib/peekView/browser/peekView.js";import{IConfigurationService as A}from"../../../../platform/configuration/common/configuration.js";import{StableEditorScrollState as Z}from"../../../../editor/browser/stableEditorScroll.js";function v(o,r){return F(o,r)??r.getColor(k)}var H=(t=>(t[t.None=0]="None",t[t.Widget=1]="Widget",t[t.Editor=2]="Editor",t))(H||{});function Se(o){const r=o.target.range;if(!r||!o.event.leftButton||o.target.type!==b.GUTTER_LINE_DECORATIONS)return null;const e=o.target.detail;return e.offsetX-e.glyphMarginWidth-e.lineNumbersWidth-e.glyphMarginLeft>20?null:{lineNumber:r.startLineNumber}}function ye(o,r){if(!o)return null;const{lineNumber:e}=o;return r.target.range?e:null}function Ie(o,r){if(!o)return null;const{lineNumber:e}=o,t=r.target.range;return!t||t.startLineNumber!==e||r.target.type!==b.GUTTER_LINE_DECORATIONS?null:e}let p=class extends N{constructor(e,t,i,n,s,d,h,u,S,q){super(e,{keepEditorSelection:!0,isAccessible:!0});this._uniqueOwner=t;this._commentThread=i;this._pendingComment=n;this._pendingEdits=s;this.themeService=h;this.commentService=u;this.configurationService=q;this._contextKeyService=S.createScoped(this.domNode),this._scopedInstantiationService=this._globalToDispose.add(d.createChild(new O([f,this._contextKeyService])));const g=this.commentService.getCommentController(this._uniqueOwner);g&&(this._commentOptions=g.options),this._initialCollapsibleState=n?a.CommentThreadCollapsibleState.Expanded:i.initialCollapsibleState,i.initialCollapsibleState=this._initialCollapsibleState,this._commentThreadDisposables=[],this.create(),this._globalToDispose.add(this.themeService.onDidColorThemeChange(this._applyTheme,this)),this._globalToDispose.add(this.editor.onDidChangeConfiguration(y=>{y.hasChanged(c.fontInfo)&&this._applyTheme(this.themeService.getColorTheme())})),this._applyTheme(this.themeService.getColorTheme())}_commentThreadWidget;_onDidClose=new C;_onDidCreateThread=new C;_isExpanded;_initialCollapsibleState;_commentGlyph;_globalToDispose=new E;_commentThreadDisposables=[];_contextKeyService;_scopedInstantiationService;get uniqueOwner(){return this._uniqueOwner}get commentThread(){return this._commentThread}get expanded(){return this._isExpanded}_commentOptions;get onDidClose(){return this._onDidClose.event}get onDidCreateThread(){return this._onDidCreateThread.event}getPosition(){if(this.position)return this.position;if(this._commentGlyph)return this._commentGlyph.getPosition().position??void 0}revealRange(){}reveal(e,t=0){this.makeVisible(e,t);const i=this._commentThread.comments?.find(n=>n.uniqueIdInThread===e);this.commentService.setActiveCommentAndThread(this.uniqueOwner,{thread:this._commentThread,comment:i})}_expandAndShowZoneWidget(){this._isExpanded||this.show(this.arrowPosition(this._commentThread.range),2)}_setFocus(e,t){t===1?this._commentThreadWidget.focus(e):t===2&&this._commentThreadWidget.focusCommentEditor()}_goToComment(e,t){const i=this.editor.getLayoutInfo().height,n=this._commentThreadWidget.getCommentCoords(e);if(n){let s=1;if(this._commentThread.range){const d=n.thread,h=n.comment;s=this.editor.getTopForLineNumber(this._commentThread.range.startLineNumber)-i/2+h.top-d.top}this.editor.setScrollTop(s),this._setFocus(e,t)}else this._goToThread(t)}_goToThread(e){const t=this._commentThread.range?new m(this._commentThread.range.startLineNumber,this._commentThread.range.startColumn,this._commentThread.range.endLineNumber+1,1):new m(1,1,1,1);this.editor.revealRangeInCenter(t),this._setFocus(void 0,e)}makeVisible(e,t=0){this._expandAndShowZoneWidget(),e!==void 0?this._goToComment(e,t):this._goToThread(t)}getPendingComments(){return{newComment:this._commentThreadWidget.getPendingComment(),edits:this._commentThreadWidget.getPendingEdits()}}setPendingComment(e){this._pendingComment=e,this.expand(),this._commentThreadWidget.setPendingComment(e)}_fillContainer(e){this.setCssClass("review-widget"),this._commentThreadWidget=this._scopedInstantiationService.createInstance(R,e,this.editor,this._uniqueOwner,this.editor.getModel().uri,this._contextKeyService,this._scopedInstantiationService,this._commentThread,this._pendingComment,this._pendingEdits,{editor:this.editor,codeBlockFontSize:"",codeBlockFontFamily:this.configurationService.getValue("editor").fontFamily||P.fontFamily},this._commentOptions,{actionRunner:async()=>{if(!this._commentThread.comments||!this._commentThread.comments.length){const t=this.getPosition();if(t){const i=this._commentThread.range;if(!i)return;let n;if(t.lineNumber!==i.endLineNumber){const s=t.lineNumber-i.endLineNumber;n=new m(i.startLineNumber+s,i.startColumn,i.endLineNumber+s,i.endColumn)}else n=new m(i.startLineNumber,i.startColumn,i.endLineNumber,i.endColumn);await this.commentService.updateCommentThreadTemplate(this.uniqueOwner,this._commentThread.commentThreadHandle,n)}}},collapse:()=>{this.collapse()}}),this._disposables.add(this._commentThreadWidget)}arrowPosition(e){if(e)return{lineNumber:e.endLineNumber,column:e.endLineNumber===e.startLineNumber?(e.startColumn+e.endColumn+1)/2:1}}deleteCommentThread(){this.dispose(),this.commentService.disposeCommentThread(this.uniqueOwner,this._commentThread.threadId)}collapse(){this._commentThread.collapsibleState=a.CommentThreadCollapsibleState.Collapsed}expand(e){this._commentThread.collapsibleState=a.CommentThreadCollapsibleState.Expanded,e&&this.commentService.setActiveCommentAndThread(this.uniqueOwner,{thread:this._commentThread})}getGlyphPosition(){return this._commentGlyph?this._commentGlyph.getPosition().position.lineNumber:0}async update(e){this._commentThread!==e&&(this._commentThreadDisposables.forEach(n=>n.dispose()),this._commentThread=e,this._commentThreadDisposables=[],this.bindCommentThreadListeners()),await this._commentThreadWidget.updateCommentThread(e);const t=this._commentThread.range?.endLineNumber??1;let i=!1;this._commentGlyph&&(this._commentGlyph.setThreadState(e.state),this._commentGlyph.getPosition().position.lineNumber!==t&&(i=!0,this._commentGlyph.setLineNumber(t))),i&&this._isExpanded||this._commentThread.collapsibleState===a.CommentThreadCollapsibleState.Expanded&&!this._isExpanded?this.show(this.arrowPosition(this._commentThread.range),2):this._commentThread.collapsibleState!==a.CommentThreadCollapsibleState.Expanded&&this.hide()}_onWidth(e){this._commentThreadWidget.layout(e)}_doLayout(e,t){this._commentThreadWidget.layout(t)}async display(e,t){e&&(this._commentGlyph=new W(this.editor,e?.endLineNumber??-1),this._commentGlyph.setThreadState(this._commentThread.state),this._globalToDispose.add(this._commentGlyph.onDidChangeLineNumber(async i=>{if(!this._commentThread.range)return;const n=i-this._commentThread.range.endLineNumber,s=new m(this._commentThread.range.startLineNumber+n,this._commentThread.range.startColumn,this._commentThread.range.endLineNumber+n,this._commentThread.range.endColumn);this._commentThread.range=s}))),await this._commentThreadWidget.display(this.editor.getOption(c.lineHeight),t),this._disposables.add(this._commentThreadWidget.onDidResize(i=>{this._refresh(i)})),(this._commentThread.collapsibleState===a.CommentThreadCollapsibleState.Expanded||e===void 0)&&this.show(this.arrowPosition(e),2),t&&this.makeVisible(),this.bindCommentThreadListeners()}bindCommentThreadListeners(){if(this._commentThreadDisposables.push(this._commentThread.onDidChangeComments(async e=>{await this.update(this._commentThread)})),this._commentThreadDisposables.push(this._commentThread.onDidChangeCollapsibleState(e=>{if(e===a.CommentThreadCollapsibleState.Expanded&&!this._isExpanded){this.show(this.arrowPosition(this._commentThread.range),2),this._commentThreadWidget.ensureFocusIntoNewEditingComment();return}if(e===a.CommentThreadCollapsibleState.Collapsed&&this._isExpanded){this.hide();return}})),this._initialCollapsibleState===void 0){const e=this._commentThread.onDidChangeInitialCollapsibleState(t=>{this._initialCollapsibleState=t,this._commentThread.collapsibleState=this._initialCollapsibleState,e.dispose()});this._commentThreadDisposables.push(e)}this._commentThreadDisposables.push(this._commentThread.onDidChangeState(()=>{const e=v(this._commentThread.state,this.themeService.getColorTheme())||T.transparent;this.style({frameColor:e,arrowColor:e}),this.container?.style.setProperty(M,`${e}`),this.container?.style.setProperty(G,`${e.transparent(.1)}`)}))}async submitComment(){return this._commentThreadWidget.submitComment()}_refresh(e){if(this._isExpanded===void 0&&e.height===0&&e.width===0){this.commentThread.collapsibleState=a.CommentThreadCollapsibleState.Collapsed;return}if(this._isExpanded){this._commentThreadWidget.layout();const t=Math.ceil(this.editor.getOption(c.lineHeight)*1.2),i=this.editor.getOption(c.lineHeight),n=Math.round(i/3),s=Math.round(i/9)*2,d=Math.ceil((t+e.height+n+s+8)/i);if(this._viewZone?.heightInLines===d)return;const h=this.getPosition();this._viewZone&&h&&h.lineNumber!==this._viewZone.afterLineNumber&&this._viewZone.afterLineNumber!==0&&(this._viewZone.afterLineNumber=h.lineNumber);const u=Z.capture(this.editor);this._relayout(d),u.restore(this.editor)}}_applyTheme(e){const t=v(this._commentThread.state,this.themeService.getColorTheme())||T.transparent;this.style({arrowColor:t,frameColor:t});const i=this.editor.getOption(c.fontInfo);this._commentThreadWidget.applyTheme(e,i)}show(e,t){const i=this._commentGlyph?.getPosition();let n=m.isIRange(e)?e:e?m.fromPositions(e):void 0;if(i?.position&&n&&i.position.lineNumber!==n.endLineNumber){const s=i.position.lineNumber-n.endLineNumber;n=new m(n.startLineNumber+s,n.startColumn,n.endLineNumber+s,n.endColumn)}this._isExpanded=!0,super.show(n??new m(0,0,0,0),t),this._commentThread.collapsibleState=a.CommentThreadCollapsibleState.Expanded,this._refresh(this._commentThreadWidget.getDimensions())}hide(){this._isExpanded&&(this._isExpanded=!1,this.editor.hasWidgetFocus()&&this.editor.focus(),(!this._commentThread.comments||!this._commentThread.comments.length)&&this.deleteCommentThread()),super.hide()}dispose(){super.dispose(),this._commentGlyph&&(this._commentGlyph.dispose(),this._commentGlyph=void 0),this._globalToDispose.dispose(),this._commentThreadDisposables.forEach(e=>e.dispose()),this._onDidClose.fire(void 0)}};p=_([l(5,D),l(6,L),l(7,x),l(8,f),l(9,A)],p);export{H as CommentWidgetFocus,p as ReviewZoneWidget,ye as isMouseUpEventDragFromMouseDown,Ie as isMouseUpEventMatchMouseDown,Se as parseMouseDownInfoFromEvent};
