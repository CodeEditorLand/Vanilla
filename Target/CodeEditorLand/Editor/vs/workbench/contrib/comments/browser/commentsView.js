var W=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var y=(d,a,e,t)=>{for(var i=t>1?void 0:t?R(a,e):a,o=d.length-1,n;o>=0;o--)(n=d[o])&&(i=(t?n(a,e,i):n(i))||i);return t&&i&&W(a,e,i),i},r=(d,a)=>(e,t)=>a(e,t,d);import"vs/css!./media/panel";import*as c from"../../../../../vs/base/browser/dom.js";import{basename as u}from"../../../../../vs/base/common/resources.js";import{CommentThreadApplicability as b,CommentThreadState as T}from"../../../../../vs/editor/common/languages.js";import*as s from"../../../../../vs/nls.js";import{IConfigurationService as A}from"../../../../../vs/platform/configuration/common/configuration.js";import{IContextKeyService as _,RawContextKey as g}from"../../../../../vs/platform/contextkey/common/contextkey.js";import{IContextMenuService as B}from"../../../../../vs/platform/contextview/browser/contextView.js";import{IHoverService as V}from"../../../../../vs/platform/hover/browser/hover.js";import{IInstantiationService as D}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{IKeybindingService as K}from"../../../../../vs/platform/keybinding/common/keybinding.js";import{IOpenerService as U}from"../../../../../vs/platform/opener/common/opener.js";import{IStorageService as H,StorageScope as z,StorageTarget as P}from"../../../../../vs/platform/storage/common/storage.js";import{ITelemetryService as k}from"../../../../../vs/platform/telemetry/common/telemetry.js";import{IThemeService as X}from"../../../../../vs/platform/theme/common/themeService.js";import{IUriIdentityService as $}from"../../../../../vs/platform/uriIdentity/common/uriIdentity.js";import{registerNavigableContainer as j}from"../../../../../vs/workbench/browser/actions/widgetNavigationCommands.js";import{ResourceLabels as Y}from"../../../../../vs/workbench/browser/labels.js";import{FilterViewPane as G}from"../../../../../vs/workbench/browser/parts/views/viewPane.js";import{Memento as q}from"../../../../../vs/workbench/common/memento.js";import{IViewDescriptorService as J}from"../../../../../vs/workbench/common/views.js";import{AccessibilityVerbositySettingId as Q}from"../../../../../vs/workbench/contrib/accessibility/browser/accessibilityConfiguration.js";import{AccessibleViewAction as Z}from"../../../../../vs/workbench/contrib/accessibility/browser/accessibleViewActions.js";import{CommentsViewFilterFocusContextKey as ee}from"../../../../../vs/workbench/contrib/comments/browser/comments.js";import{revealCommentThread as te}from"../../../../../vs/workbench/contrib/comments/browser/commentsController.js";import{ICommentService as ie}from"../../../../../vs/workbench/contrib/comments/browser/commentService.js";import{FilterOptions as I}from"../../../../../vs/workbench/contrib/comments/browser/commentsFilterOptions.js";import{CommentsModel as C,threadHasMeaningfulComments as re}from"../../../../../vs/workbench/contrib/comments/browser/commentsModel.js";import{COMMENTS_VIEW_TITLE as oe,CommentsList as se,Filter as ne}from"../../../../../vs/workbench/contrib/comments/browser/commentsTreeViewer.js";import{CommentsFilters as ae,CommentsSortOrder as w}from"../../../../../vs/workbench/contrib/comments/browser/commentsViewActions.js";import{CommentNode as h,ResourceWithCommentThreads as l}from"../../../../../vs/workbench/contrib/comments/common/commentModel.js";import{IEditorService as me}from"../../../../../vs/workbench/services/editor/common/editorService.js";import{IPathService as de}from"../../../../../vs/workbench/services/path/common/pathService.js";const ce=new g("commentsView.hasComments",!1),he=new g("commentsView.someCommentsExpanded",!1),le=new g("commentsView.commentFocused",!1),ue="commentsViewState";function fe(d){const a=[];for(const e of d.resourceCommentThreads){const t=[];for(const i of e.commentThreads)re(i.thread)&&t.push({element:i});t.length>0&&a.push({element:e,children:t})}return a}let f=class extends G{constructor(e,t,i,o,n,m,x,F,M,E,ve,N,L,pe,O,ge){const S=new q(ue,O),v=S.getMemento(z.WORKSPACE,P.MACHINE);super({...e,filterOptions:{placeholder:s.localize("comments.filter.placeholder","Filter (e.g. text, author)"),ariaLabel:s.localize("comments.filter.ariaLabel","Filter comments"),history:v.filterHistory||[],text:v.filter||"",focusContextKey:ee.key}},F,x,n,m,i,t,M,E,N,L);this.editorService=o;this.commentService=ve;this.uriIdentityService=pe;this.pathService=ge;this.hasCommentsContextKey=ce.bindTo(m),this.someCommentsExpandedContextKey=he.bindTo(m),this.commentsFocusedContextKey=le.bindTo(m),this.stateMemento=S,this.viewState=v,this.filters=this._register(new ae({showResolved:this.viewState.showResolved!==!1,showUnresolved:this.viewState.showUnresolved!==!1,sortBy:this.viewState.sortBy},this.contextKeyService)),this.filter=new ne(new I(this.filterWidget.getFilterText(),this.filters.showResolved,this.filters.showUnresolved)),this._register(this.filters.onDidChange(p=>{(p.showResolved||p.showUnresolved)&&this.updateFilter(),p.sortBy&&this.refresh()})),this._register(this.filterWidget.onDidChangeFilterText(()=>this.updateFilter()))}treeLabels;tree;treeContainer;messageBoxContainer;totalComments=0;hasCommentsContextKey;someCommentsExpandedContextKey;commentsFocusedContextKey;filter;filters;currentHeight=0;currentWidth=0;viewState;stateMemento;cachedFilterStats=void 0;onDidChangeVisibility=this.onDidChangeBodyVisibility;get focusedCommentNode(){const e=this.tree?.getFocus();if(e?.length===1&&e[0]instanceof h)return e[0]}get focusedCommentInfo(){if(this.focusedCommentNode)return this.getScreenReaderInfoForNode(this.focusedCommentNode)}focusNextNode(){if(!this.tree)return;const e=this.tree.getFocus()?.[0];if(!e)return;let t=this.tree.navigate(e).next();for(;t&&!(t instanceof h);)t=this.tree.navigate(t).next();t&&this.tree.setFocus([t])}focusPreviousNode(){if(!this.tree)return;const e=this.tree.getFocus()?.[0];if(!e)return;let t=this.tree.navigate(e).previous();for(;t&&!(t instanceof h);)t=this.tree.navigate(t).previous();t&&this.tree.setFocus([t])}saveState(){this.viewState.filter=this.filterWidget.getFilterText(),this.viewState.filterHistory=this.filterWidget.getHistory(),this.viewState.showResolved=this.filters.showResolved,this.viewState.showUnresolved=this.filters.showUnresolved,this.viewState.sortBy=this.filters.sortBy,this.stateMemento.saveMemento(),super.saveState()}render(){super.render(),this._register(j({name:"commentsView",focusNotifiers:[this,this.filterWidget],focusNextWidget:()=>{this.filterWidget.hasFocus()&&this.focus()},focusPreviousWidget:()=>{this.filterWidget.hasFocus()||this.focusFilter()}}))}focusFilter(){this.filterWidget.focus()}clearFilterText(){this.filterWidget.setFilterText("")}getFilterStats(){return this.cachedFilterStats||(this.cachedFilterStats={total:this.totalComments,filtered:this.tree?.getVisibleItemCount()??0}),this.cachedFilterStats}updateFilter(){this.filter.options=new I(this.filterWidget.getFilterText(),this.filters.showResolved,this.filters.showUnresolved),this.tree?.filterComments(),this.cachedFilterStats=void 0;const{total:e,filtered:t}=this.getFilterStats();this.filterWidget.updateBadge(e===t||e===0?void 0:s.localize("showing filtered results","Showing {0} of {1}",t,e)),this.filterWidget.checkMoreFilters(!this.filters.showResolved||!this.filters.showUnresolved)}renderBody(e){super.renderBody(e),e.classList.add("comments-panel");const t=c.append(e,c.$(".comments-panel-container"));this.treeContainer=c.append(t,c.$(".tree-container")),this.treeContainer.classList.add("file-icon-themable-tree","show-file-icons"),this.cachedFilterStats=void 0,this.createTree(),this.createMessageBox(t),this._register(this.commentService.onDidSetAllCommentThreads(this.onAllCommentsChanged,this)),this._register(this.commentService.onDidUpdateCommentThreads(this.onCommentsUpdated,this)),this._register(this.commentService.onDidDeleteDataProvider(this.onDataProviderDeleted,this)),this._register(this.onDidChangeBodyVisibility(i=>{i&&this.refresh()})),this.renderComments()}focus(){super.focus();const e=this.tree?.getHTMLElement();e&&c.isActiveElement(e)||(!this.commentService.commentsModel.hasCommentThreads()&&this.messageBoxContainer?this.messageBoxContainer.focus():this.tree&&this.tree.domFocus())}renderComments(){this.treeContainer.classList.toggle("hidden",!this.commentService.commentsModel.hasCommentThreads()),this.renderMessage(),this.tree?.setChildren(null,fe(this.commentService.commentsModel))}collapseAll(){this.tree&&(this.tree.collapseAll(),this.tree.setSelection([]),this.tree.setFocus([]),this.tree.domFocus(),this.tree.focusFirst())}expandAll(){this.tree&&(this.tree.expandAll(),this.tree.setSelection([]),this.tree.setFocus([]),this.tree.domFocus(),this.tree.focusFirst())}get hasRendered(){return!!this.tree}layoutBodyContent(e=this.currentHeight,t=this.currentWidth){this.messageBoxContainer&&(this.messageBoxContainer.style.height=`${e}px`),this.tree?.layout(e,t),this.currentHeight=e,this.currentWidth=t}createMessageBox(e){this.messageBoxContainer=c.append(e,c.$(".message-box-container")),this.messageBoxContainer.setAttribute("tabIndex","0")}renderMessage(){this.messageBoxContainer.textContent=this.commentService.commentsModel.getMessage(),this.messageBoxContainer.classList.toggle("hidden",this.commentService.commentsModel.hasCommentThreads())}getScreenReaderInfoForNode(e,t){let i="";if(t&&this.configurationService.getValue(Q.Comments)){const m=this.keybindingService.lookupKeybinding(Z.id)?.getAriaLabel();i=m?s.localize("acessibleViewHint",`Inspect this in the accessible view ({0}).
`,m):s.localize("acessibleViewHintNoKbOpen",`Inspect this in the accessible view via the command Open Accessible View which is currently not triggerable via keybinding.
`)}const o=this.getReplyCountAsString(e,t),n=this.getRepliesAsString(e,t);return e.range?e.threadRelevance===b.Outdated?i+s.localize("resourceWithCommentLabelOutdated","Outdated from {0} at line {1} column {2} in {3},{4} comment: {5}",e.comment.userName,e.range.startLineNumber,e.range.startColumn,u(e.resource),o,typeof e.comment.body=="string"?e.comment.body:e.comment.body.value)+n:i+s.localize("resourceWithCommentLabel","{0} at line {1} column {2} in {3},{4} comment: {5}",e.comment.userName,e.range.startLineNumber,e.range.startColumn,u(e.resource),o,typeof e.comment.body=="string"?e.comment.body:e.comment.body.value)+n:e.threadRelevance===b.Outdated?i+s.localize("resourceWithCommentLabelFileOutdated","Outdated from {0} in {1},{2} comment: {3}",e.comment.userName,u(e.resource),o,typeof e.comment.body=="string"?e.comment.body:e.comment.body.value)+n:i+s.localize("resourceWithCommentLabelFile","{0} in {1},{2} comment: {3}",e.comment.userName,u(e.resource),o,typeof e.comment.body=="string"?e.comment.body:e.comment.body.value)+n}getRepliesAsString(e,t){return!e.replies.length||t?"":`
`+e.replies.map(i=>s.localize("resourceWithRepliesLabel","{0} {1}",i.comment.userName,typeof i.comment.body=="string"?i.comment.body:i.comment.body.value)).join(`
`)}getReplyCountAsString(e,t){return e.replies.length&&!t?s.localize("replyCount"," {0} replies,",e.replies.length):""}createTree(){this.treeLabels=this._register(this.instantiationService.createInstance(Y,this)),this.tree=this._register(this.instantiationService.createInstance(se,this.treeLabels,this.treeContainer,{overrideStyles:this.getLocationBasedColors().listOverrideStyles,selectionNavigation:!0,filter:this.filter,sorter:{compare:(e,t)=>{if(e instanceof C||t instanceof C)return 0;if(this.filters.sortBy===w.UpdatedAtDescending)return e.lastUpdatedAt>t.lastUpdatedAt?-1:1;if(this.filters.sortBy===w.ResourceAscending){if(e instanceof l&&t instanceof l){const i=this.pathService.defaultUriScheme;return e.resource.scheme!==t.resource.scheme&&(e.resource.scheme===i||t.resource.scheme===i)?t.resource.scheme===i?1:-1:e.resource.toString()>t.resource.toString()?1:-1}else if(e instanceof h&&t instanceof h&&e.thread.range&&t.thread.range)return e.thread.range?.startLineNumber>t.thread.range?.startLineNumber?1:-1}return 0}},keyboardNavigationLabelProvider:{getKeyboardNavigationLabel:e=>{}},accessibilityProvider:{getAriaLabel:e=>e instanceof C?s.localize("rootCommentsLabel","Comments for current workspace"):e instanceof l?s.localize("resourceWithCommentThreadsLabel","Comments in {0}, full path {1}",u(e.resource),e.resource.fsPath):e instanceof h?this.getScreenReaderInfoForNode(e,!0):"",getWidgetAriaLabel(){return oe.value}}})),this._register(this.tree.onDidOpen(e=>{this.openFile(e.element,e.editorOptions.pinned,e.editorOptions.preserveFocus,e.sideBySide)})),this._register(this.tree.onDidChangeModel(()=>{this.updateSomeCommentsExpanded()})),this._register(this.tree.onDidChangeCollapseState(()=>{this.updateSomeCommentsExpanded()})),this._register(this.tree.onDidFocus(()=>this.commentsFocusedContextKey.set(!0))),this._register(this.tree.onDidBlur(()=>this.commentsFocusedContextKey.set(!1)))}openFile(e,t,i,o){if(!e||!(e instanceof l||e instanceof h))return;const n=e instanceof l?e.commentThreads[0].thread:e.thread,m=e instanceof l?e.commentThreads[0].comment:void 0;return te(this.commentService,this.editorService,this.uriIdentityService,n,m,!1,t,i,o)}async refresh(){if(this.tree&&this.isVisible()&&(this.hasCommentsContextKey.set(this.commentService.commentsModel.hasCommentThreads()),this.cachedFilterStats=void 0,this.renderComments(),this.tree.getSelection().length===0&&this.commentService.commentsModel.hasCommentThreads())){const e=this.commentService.commentsModel.resourceCommentThreads[0].commentThreads[0];e&&(this.tree.setFocus([e]),this.tree.setSelection([e]))}}onAllCommentsChanged(e){this.cachedFilterStats=void 0,this.totalComments+=e.commentThreads.length;let t=0;for(const i of e.commentThreads)i.state===T.Unresolved&&t++;this.refresh()}onCommentsUpdated(e){this.cachedFilterStats=void 0,this.totalComments+=e.added.length,this.totalComments-=e.removed.length;let t=0;for(const i of this.commentService.commentsModel.resourceCommentThreads)for(const o of i.commentThreads)o.threadState===T.Unresolved&&t++;this.refresh()}onDataProviderDeleted(e){this.cachedFilterStats=void 0,this.totalComments=0,this.refresh()}updateSomeCommentsExpanded(){this.someCommentsExpandedContextKey.set(this.isSomeCommentsExpanded())}areAllCommentsExpanded(){if(!this.tree)return!1;const e=this.tree.navigate();for(;e.next();)if(this.tree.isCollapsed(e.current()))return!1;return!0}isSomeCommentsExpanded(){if(!this.tree)return!1;const e=this.tree.navigate();for(;e.next();)if(!this.tree.isCollapsed(e.current()))return!0;return!1}};f=y([r(1,D),r(2,J),r(3,me),r(4,A),r(5,_),r(6,B),r(7,K),r(8,U),r(9,X),r(10,ie),r(11,k),r(12,V),r(13,$),r(14,H),r(15,de)],f);export{le as CONTEXT_KEY_COMMENT_FOCUSED,ce as CONTEXT_KEY_HAS_COMMENTS,he as CONTEXT_KEY_SOME_COMMENTS_EXPANDED,f as CommentsPanel};
