var T=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var b=(l,a,e,t)=>{for(var n=t>1?void 0:t?I(a,e):a,m=l.length-1,i;m>=0;m--)(i=l[m])&&(n=(t?i(a,e,n):i(n))||n);return t&&n&&T(a,e,n),n},_=(l,a)=>(e,t)=>a(e,t,l);import*as r from"../../../../base/browser/dom.js";import{StandardKeyboardEvent as w}from"../../../../base/browser/keyboardEvent.js";import{Emitter as N}from"../../../../base/common/event.js";import{KeyCode as E}from"../../../../base/common/keyCodes.js";import{Disposable as D,DisposableMap as y,DisposableStore as R}from"../../../../base/common/lifecycle.js";import{MarkdownRenderer as L}from"../../../../editor/browser/widget/markdownRenderer/browser/markdownRenderer.js";import*as v from"../../../../editor/common/languages.js";import{ILanguageService as S}from"../../../../editor/common/languages/language.js";import*as C from"../../../../nls.js";import{IOpenerService as M}from"../../../../platform/opener/common/opener.js";import{CommentNode as A}from"./commentNode.js";import{ICommentService as k}from"./commentService.js";let f=class extends D{constructor(e,t,n,m,i,g,h,p,u,o,d,c){super();this._parentEditor=e;this.owner=t;this.parentResourceUri=n;this.container=m;this._options=i;this._commentThread=g;this._pendingEdits=h;this._scopedInstatiationService=p;this._parentCommentThreadWidget=u;this.commentService=o;this.openerService=d;this.languageService=c;this._register(r.addDisposableListener(m,r.EventType.FOCUS_IN,s=>{this.commentService.setActiveEditingCommentThread(this._commentThread)})),this._markdownRenderer=this._register(new L(this._options,this.languageService,this.openerService))}_commentsElement;_commentElements=[];_resizeObserver;_focusedComment=void 0;_onDidResize=new N;onDidResize=this._onDidResize.event;_commentDisposable=new y;_markdownRenderer;get length(){return this._commentThread.comments?this._commentThread.comments.length:0}get activeComment(){return this._commentElements.filter(e=>e.isEditing)[0]}focus(){this._commentsElement.focus()}ensureFocusIntoNewEditingComment(){this._commentElements.length===1&&this._commentElements[0].isEditing&&this._commentElements[0].setFocus(!0)}async display(){if(this._commentsElement=r.append(this.container,r.$("div.comments-container")),this._commentsElement.setAttribute("role","presentation"),this._commentsElement.tabIndex=0,this._updateAriaLabel(),this._register(r.addDisposableListener(this._commentsElement,r.EventType.KEY_DOWN,e=>{const t=new w(e);if((t.equals(E.UpArrow)||t.equals(E.DownArrow))&&(!this._focusedComment||!this._commentElements[this._focusedComment].isEditing)){const n=m=>{if(this._focusedComment===void 0&&m>=0)return 0;if(this._focusedComment===void 0&&m<0)return this._commentElements.length-1;const i=this._focusedComment+m;return Math.min(Math.max(0,i),this._commentElements.length-1)};this._setFocusedComment(t.equals(E.UpArrow)?n(-1):n(1))}})),this._commentDisposable.clearAndDisposeAll(),this._commentElements=[],this._commentThread.comments)for(const e of this._commentThread.comments){const t=this.createNewCommentNode(e);this._commentElements.push(t),this._commentsElement.appendChild(t.domNode),e.mode===v.CommentMode.Editing&&await t.switchToEditMode()}this._resizeObserver=new MutationObserver(this._refresh.bind(this)),this._resizeObserver.observe(this.container,{attributes:!0,childList:!0,characterData:!0,subtree:!0})}_refresh(){const e=r.getClientArea(this.container);this._onDidResize.fire(e)}getDimensions(){return r.getClientArea(this.container)}layout(e){this._commentElements.forEach(t=>{t.layout(e)})}getPendingEdits(){const e={};return this._commentElements.forEach(t=>{if(t.isEditing){const n=t.getPendingEdit();n&&(e[t.comment.uniqueIdInThread]=n)}}),e}getCommentCoords(e){const t=this._commentElements.filter(n=>n.comment.uniqueIdInThread===e);if(t&&t.length){const n=r.getDomNodePagePosition(this._commentElements[0].domNode),m=r.getDomNodePagePosition(t[0].domNode);return{thread:n,comment:m}}}async updateCommentThread(e,t){const n=this._commentElements.length,m=e.comments?e.comments.length:0,i=[],g=[];for(let o=0;o<n;o++){const d=this._commentElements[o].comment,c=e.comments?e.comments.filter(s=>s.uniqueIdInThread===d.uniqueIdInThread):[];c.length?this._commentElements[o].update(c[0]):(g.push(o),i.push(this._commentElements[o]))}for(let o=i.length-1;o>=0;o--){const d=i[o];this._commentDisposable.deleteAndDispose(d),this._commentElements.splice(g[o],1),d.domNode.remove()}let h=null;const p=[],u=[];for(let o=m-1;o>=0;o--){const d=e.comments[o],c=this._commentElements.filter(s=>s.comment.uniqueIdInThread===d.uniqueIdInThread);if(c.length)h=c[0].domNode,p.unshift(c[0]);else{const s=this.createNewCommentNode(d);p.unshift(s),h?(this._commentsElement.insertBefore(s.domNode,h),h=s.domNode):(this._commentsElement.appendChild(s.domNode),h=s.domNode),d.mode===v.CommentMode.Editing&&(await s.switchToEditMode(),u.push(s))}}if(this._commentThread=e,this._commentElements=p,u.length){const o=this._commentElements.indexOf(u[u.length-1]);this._focusedComment=o}this._updateAriaLabel(),t||this._setFocusedComment(this._focusedComment)}_updateAriaLabel(){this._commentThread.isDocumentCommentThread()?this._commentThread.range?this._commentsElement.ariaLabel=C.localize("commentThreadAria.withRange","Comment thread with {0} comments on lines {1} through {2}. {3}.",this._commentThread.comments?.length,this._commentThread.range.startLineNumber,this._commentThread.range.endLineNumber,this._commentThread.label):this._commentsElement.ariaLabel=C.localize("commentThreadAria.document","Comment thread with {0} comments on the entire document. {1}.",this._commentThread.comments?.length,this._commentThread.label):this._commentsElement.ariaLabel=C.localize("commentThreadAria","Comment thread with {0} comments. {1}.",this._commentThread.comments?.length,this._commentThread.label)}_setFocusedComment(e){this._focusedComment!==void 0&&this._commentElements[this._focusedComment]?.setFocus(!1),this._commentElements.length===0||e===void 0?this._focusedComment=void 0:(this._focusedComment=Math.min(e,this._commentElements.length-1),this._commentElements[this._focusedComment].setFocus(!0))}createNewCommentNode(e){const t=this._scopedInstatiationService.createInstance(A,this._parentEditor,this._commentThread,e,this._pendingEdits?this._pendingEdits[e.uniqueIdInThread]:void 0,this.owner,this.parentResourceUri,this._parentCommentThreadWidget,this._markdownRenderer),n=new R;return n.add(t.onDidClick(m=>this._setFocusedComment(this._commentElements.findIndex(i=>i.comment.uniqueIdInThread===m.comment.uniqueIdInThread)))),n.add(t),this._commentDisposable.set(t,n),t}dispose(){super.dispose(),this._resizeObserver&&(this._resizeObserver.disconnect(),this._resizeObserver=null),this._commentDisposable.dispose()}};f=b([_(9,k),_(10,M),_(11,S)],f);export{f as CommentThreadBody};
