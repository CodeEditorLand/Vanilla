var I=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var v=(l,a,e,t)=>{for(var n=t>1?void 0:t?T(a,e):a,o=l.length-1,i;o>=0;o--)(i=l[o])&&(n=(t?i(a,e,n):i(n))||n);return t&&n&&I(a,e,n),n},p=(l,a)=>(e,t)=>a(e,t,l);import*as r from"../../../../base/browser/dom.js";import*as E from"../../../../nls.js";import{Disposable as w,DisposableMap as N,DisposableStore as D}from"../../../../base/common/lifecycle.js";import*as b from"../../../../editor/common/languages.js";import{Emitter as L}from"../../../../base/common/event.js";import{ICommentService as R}from"./commentService.js";import{StandardKeyboardEvent as S}from"../../../../base/browser/keyboardEvent.js";import{KeyCode as C}from"../../../../base/common/keyCodes.js";import{CommentNode as y}from"./commentNode.js";import"../../../../platform/instantiation/common/instantiation.js";import"../../../../base/common/uri.js";import"../common/commentThreadWidget.js";import{MarkdownRenderer as M}from"../../../../editor/browser/widget/markdownRenderer/browser/markdownRenderer.js";import{IOpenerService as A}from"../../../../platform/opener/common/opener.js";import{ILanguageService as O}from"../../../../editor/common/languages/language.js";import"../../notebook/common/notebookRange.js";import"../../../../editor/common/core/range.js";import"./simpleCommentEditor.js";let f=class extends w{constructor(e,t,n,o,i,g,h,_,u,m,d,c){super();this._parentEditor=e;this.owner=t;this.parentResourceUri=n;this.container=o;this._options=i;this._commentThread=g;this._pendingEdits=h;this._scopedInstatiationService=_;this._parentCommentThreadWidget=u;this.commentService=m;this.openerService=d;this.languageService=c;this._register(r.addDisposableListener(o,r.EventType.FOCUS_IN,s=>{this.commentService.setActiveEditingCommentThread(this._commentThread)})),this._markdownRenderer=this._register(new M(this._options,this.languageService,this.openerService))}_commentsElement;_commentElements=[];_resizeObserver;_focusedComment=void 0;_onDidResize=new L;onDidResize=this._onDidResize.event;_commentDisposable=new N;_markdownRenderer;get length(){return this._commentThread.comments?this._commentThread.comments.length:0}get activeComment(){return this._commentElements.filter(e=>e.isEditing)[0]}focus(){this._commentsElement.focus()}ensureFocusIntoNewEditingComment(){this._commentElements.length===1&&this._commentElements[0].isEditing&&this._commentElements[0].setFocus(!0)}async display(){if(this._commentsElement=r.append(this.container,r.$("div.comments-container")),this._commentsElement.setAttribute("role","presentation"),this._commentsElement.tabIndex=0,this._updateAriaLabel(),this._register(r.addDisposableListener(this._commentsElement,r.EventType.KEY_DOWN,e=>{const t=new S(e);if((t.equals(C.UpArrow)||t.equals(C.DownArrow))&&(!this._focusedComment||!this._commentElements[this._focusedComment].isEditing)){const n=o=>{if(this._focusedComment===void 0&&o>=0)return 0;if(this._focusedComment===void 0&&o<0)return this._commentElements.length-1;const i=this._focusedComment+o;return Math.min(Math.max(0,i),this._commentElements.length-1)};this._setFocusedComment(t.equals(C.UpArrow)?n(-1):n(1))}})),this._commentDisposable.clearAndDisposeAll(),this._commentElements=[],this._commentThread.comments)for(const e of this._commentThread.comments){const t=this.createNewCommentNode(e);this._commentElements.push(t),this._commentsElement.appendChild(t.domNode),e.mode===b.CommentMode.Editing&&await t.switchToEditMode()}this._resizeObserver=new MutationObserver(this._refresh.bind(this)),this._resizeObserver.observe(this.container,{attributes:!0,childList:!0,characterData:!0,subtree:!0})}_refresh(){const e=r.getClientArea(this.container);this._onDidResize.fire(e)}getDimensions(){return r.getClientArea(this.container)}layout(e){this._commentElements.forEach(t=>{t.layout(e)})}getPendingEdits(){const e={};return this._commentElements.forEach(t=>{if(t.isEditing){const n=t.getPendingEdit();n&&(e[t.comment.uniqueIdInThread]=n)}}),e}getCommentCoords(e){const t=this._commentElements.filter(n=>n.comment.uniqueIdInThread===e);if(t&&t.length){const n=r.getDomNodePagePosition(this._commentElements[0].domNode),o=r.getDomNodePagePosition(t[0].domNode);return{thread:n,comment:o}}}async updateCommentThread(e,t){const n=this._commentElements.length,o=e.comments?e.comments.length:0,i=[],g=[];for(let m=0;m<n;m++){const d=this._commentElements[m].comment,c=e.comments?e.comments.filter(s=>s.uniqueIdInThread===d.uniqueIdInThread):[];c.length?this._commentElements[m].update(c[0]):(g.push(m),i.push(this._commentElements[m]))}for(let m=i.length-1;m>=0;m--){const d=i[m];this._commentDisposable.deleteAndDispose(d),this._commentElements.splice(g[m],1),d.domNode.remove()}let h=null;const _=[],u=[];for(let m=o-1;m>=0;m--){const d=e.comments[m],c=this._commentElements.filter(s=>s.comment.uniqueIdInThread===d.uniqueIdInThread);if(c.length)h=c[0].domNode,_.unshift(c[0]);else{const s=this.createNewCommentNode(d);_.unshift(s),h?(this._commentsElement.insertBefore(s.domNode,h),h=s.domNode):(this._commentsElement.appendChild(s.domNode),h=s.domNode),d.mode===b.CommentMode.Editing&&(await s.switchToEditMode(),u.push(s))}}if(this._commentThread=e,this._commentElements=_,u.length){const m=this._commentElements.indexOf(u[u.length-1]);this._focusedComment=m}this._updateAriaLabel(),t||this._setFocusedComment(this._focusedComment)}_updateAriaLabel(){this._commentThread.isDocumentCommentThread()?this._commentThread.range?this._commentsElement.ariaLabel=E.localize("commentThreadAria.withRange","Comment thread with {0} comments on lines {1} through {2}. {3}.",this._commentThread.comments?.length,this._commentThread.range.startLineNumber,this._commentThread.range.endLineNumber,this._commentThread.label):this._commentsElement.ariaLabel=E.localize("commentThreadAria.document","Comment thread with {0} comments on the entire document. {1}.",this._commentThread.comments?.length,this._commentThread.label):this._commentsElement.ariaLabel=E.localize("commentThreadAria","Comment thread with {0} comments. {1}.",this._commentThread.comments?.length,this._commentThread.label)}_setFocusedComment(e){this._focusedComment!==void 0&&this._commentElements[this._focusedComment]?.setFocus(!1),this._commentElements.length===0||e===void 0?this._focusedComment=void 0:(this._focusedComment=Math.min(e,this._commentElements.length-1),this._commentElements[this._focusedComment].setFocus(!0))}createNewCommentNode(e){const t=this._scopedInstatiationService.createInstance(y,this._parentEditor,this._commentThread,e,this._pendingEdits?this._pendingEdits[e.uniqueIdInThread]:void 0,this.owner,this.parentResourceUri,this._parentCommentThreadWidget,this._markdownRenderer),n=new D;return n.add(t.onDidClick(o=>this._setFocusedComment(this._commentElements.findIndex(i=>i.comment.uniqueIdInThread===o.comment.uniqueIdInThread)))),n.add(t),this._commentDisposable.set(t,n),t}dispose(){super.dispose(),this._resizeObserver&&(this._resizeObserver.disconnect(),this._resizeObserver=null),this._commentDisposable.dispose()}};f=v([p(9,R),p(10,A),p(11,O)],f);export{f as CommentThreadBody};
