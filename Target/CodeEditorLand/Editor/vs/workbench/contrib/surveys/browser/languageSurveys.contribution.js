var b=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var C=(I,e,r,n)=>{for(var t=n>1?void 0:n?R(e,r):e,c=I.length-1,u;c>=0;c--)(u=I[c])&&(t=(n?u(e,r,t):u(t))||t);return n&&t&&b(e,r,t),t},s=(I,e)=>(r,n)=>e(r,n,I);import{RunOnceWorker as U}from"../../../../base/common/async.js";import{Disposable as k}from"../../../../base/common/lifecycle.js";import{language as _}from"../../../../base/common/platform.js";import{platform as D}from"../../../../base/common/process.js";import{URI as x}from"../../../../base/common/uri.js";import{ILanguageService as $}from"../../../../editor/common/languages/language.js";import{localize as d}from"../../../../nls.js";import{INotificationService as w,Severity as W}from"../../../../platform/notification/common/notification.js";import{IOpenerService as F}from"../../../../platform/opener/common/opener.js";import{IProductService as K}from"../../../../platform/product/common/productService.js";import{Registry as M}from"../../../../platform/registry/common/platform.js";import{IStorageService as Y,StorageScope as o,StorageTarget as i}from"../../../../platform/storage/common/storage.js";import{ITelemetryService as G}from"../../../../platform/telemetry/common/telemetry.js";import{Extensions as V}from"../../../common/contributions.js";import{IExtensionService as j}from"../../../services/extensions/common/extensions.js";import{LifecyclePhase as z}from"../../../services/lifecycle/common/lifecycle.js";import{ITextFileService as B}from"../../../services/textfile/common/textfiles.js";class H extends k{constructor(e,r,n,t,c,u,f,l){super();const A=`${e.surveyId}.sessionCount`,g=`${e.surveyId}.lastSessionDate`,S=`${e.surveyId}.skipVersion`,m=`${e.surveyId}.isCandidate`,a=`${e.surveyId}.editedCount`,E=`${e.surveyId}.editedDate`;if(r.get(S,o.APPLICATION,""))return;const v=new Date().toDateString();if(r.getNumber(a,o.APPLICATION,0)<e.editCount){const N=this._register(new U(y=>{y.forEach(L=>{if(L.getLanguageId()===e.languageId&&v!==r.get(E,o.APPLICATION)){const O=r.getNumber(a,o.APPLICATION,0)+1;r.store(a,O,o.APPLICATION,i.USER),r.store(E,v,o.APPLICATION,i.USER)}})},250));this._register(u.files.onDidSave(y=>N.work(y.model)))}const h=r.get(g,o.APPLICATION,new Date(0).toDateString());if(v===h)return;const P=r.getNumber(A,o.APPLICATION,0)+1;if(r.store(g,v,o.APPLICATION,i.USER),r.store(A,P,o.APPLICATION,i.USER),P<9||r.getNumber(a,o.APPLICATION,0)<e.editCount)return;const T=r.getBoolean(m,o.APPLICATION,!1)||Math.random()<e.userProbability;if(r.store(m,T,o.APPLICATION,i.USER),!T){r.store(S,l.version,o.APPLICATION,i.USER);return}n.prompt(W.Info,d("helpUs","Help us improve our support for {0}",c.getLanguageName(e.languageId)??e.languageId),[{label:d("takeShortSurvey","Take Short Survey"),run:()=>{t.publicLog(`${e.surveyId}.survey/takeShortSurvey`),f.open(x.parse(`${e.surveyUrl}?o=${encodeURIComponent(D)}&v=${encodeURIComponent(l.version)}&m=${encodeURIComponent(t.machineId)}`)),r.store(m,!1,o.APPLICATION,i.USER),r.store(S,l.version,o.APPLICATION,i.USER)}},{label:d("remindLater","Remind Me Later"),run:()=>{t.publicLog(`${e.surveyId}.survey/remindMeLater`),r.store(A,P-3,o.APPLICATION,i.USER)}},{label:d("neverAgain","Don't Show Again"),isSecondary:!0,run:()=>{t.publicLog(`${e.surveyId}.survey/dontShowAgain`),r.store(m,!1,o.APPLICATION,i.USER),r.store(S,l.version,o.APPLICATION,i.USER)}}],{sticky:!0})}}let p=class{constructor(e,r,n,t,c,u,f,l){this.storageService=e;this.notificationService=r;this.telemetryService=n;this.textFileService=t;this.openerService=c;this.productService=u;this.languageService=f;this.extensionService=l;this.handleSurveys()}async handleSurveys(){this.productService.surveys&&(await this.extensionService.whenInstalledExtensionsRegistered(),this.productService.surveys.filter(e=>e.surveyId&&e.editCount&&e.languageId&&e.surveyUrl&&e.userProbability).map(e=>new H(e,this.storageService,this.notificationService,this.telemetryService,this.languageService,this.textFileService,this.openerService,this.productService)))}};p=C([s(0,Y),s(1,w),s(2,G),s(3,B),s(4,F),s(5,K),s(6,$),s(7,j)],p),_==="en"&&M.as(V.Workbench).registerWorkbenchContribution(p,z.Restored);
