var ce=Object.defineProperty;var ue=Object.getOwnPropertyDescriptor;var P=(d,e,n,s)=>{for(var o=s>1?void 0:s?ue(e,n):e,l=d.length-1,a;l>=0;l--)(a=d[l])&&(o=(s?a(e,n,o):a(o))||o);return s&&o&&ce(e,n,o),o},g=(d,e)=>(n,s)=>e(n,s,d);import*as C from"../../../../../base/browser/dom.js";import{ActionBar as de}from"../../../../../base/browser/ui/actionbar/actionbar.js";import{renderLabelWithIcons as me}from"../../../../../base/browser/ui/iconLabel/iconLabels.js";import"../../../../../base/browser/ui/list/list.js";import"../../../../../base/browser/ui/tree/compressedObjectTreeModel.js";import"../../../../../base/browser/ui/tree/objectTree.js";import"../../../../../base/browser/ui/tree/tree.js";import{Action as f,Separator as pe}from"../../../../../base/common/actions.js";import{RunOnceScheduler as ge}from"../../../../../base/common/async.js";import{Codicon as S}from"../../../../../base/common/codicons.js";import{Emitter as H,Event as w}from"../../../../../base/common/event.js";import"../../../../../base/common/filters.js";import{Iterable as N}from"../../../../../base/common/iterator.js";import{Disposable as he,DisposableStore as U}from"../../../../../base/common/lifecycle.js";import{MarshalledId as Te}from"../../../../../base/common/marshallingIds.js";import{autorun as fe}from"../../../../../base/common/observable.js";import{count as be}from"../../../../../base/common/strings.js";import{ThemeIcon as T}from"../../../../../base/common/themables.js";import{isDefined as Ie}from"../../../../../base/common/types.js";import"../../../../../base/common/uri.js";import{localize as p}from"../../../../../nls.js";import{MenuEntryActionViewItem as ve,createAndFillInActionBarActions as ye}from"../../../../../platform/actions/browser/menuEntryActionViewItem.js";import{IMenuService as Ce,MenuId as ne,MenuItemAction as Ee}from"../../../../../platform/actions/common/actions.js";import{ICommandService as Re}from"../../../../../platform/commands/common/commands.js";import{IContextKeyService as xe}from"../../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as ke}from"../../../../../platform/contextview/browser/contextView.js";import{IInstantiationService as ie}from"../../../../../platform/instantiation/common/instantiation.js";import{WorkbenchCompressibleObjectTree as Se}from"../../../../../platform/list/browser/listService.js";import{IProgressService as we}from"../../../../../platform/progress/common/progress.js";import{ITelemetryService as Me}from"../../../../../platform/telemetry/common/telemetry.js";import{widgetClose as Oe}from"../../../../../platform/theme/common/iconRegistry.js";import{getTestItemContextOverlay as De}from"../explorerProjections/testItemContextOverlay.js";import*as E from"../icons.js";import{renderTestMessageAsText as Le}from"../testMessageColorizer.js";import{MessageSubject as re,TaskSubject as F,TestOutputSubject as z,getMessageArgs as Ae,mapFindTestMessage as Pe}from"./testResultsSubject.js";import{TestCommandId as Ne,Testing as Fe}from"../../common/constants.js";import{ITestCoverageService as ze}from"../../common/testCoverageService.js";import{ITestExplorerFilterState as Be}from"../../common/testExplorerFilterState.js";import{ITestProfileService as _e}from"../../common/testProfileService.js";import{LiveTestResult as K,TestResultItemChangeReason as $e,maxCountPriority as qe}from"../../common/testResult.js";import{ITestResultService as We}from"../../common/testResultService.js";import{InternalTestItem as je,TestMessageType as B,TestResultState as G,TestRunProfileBitset as L,testResultStateToContextValues as Ve}from"../../common/testTypes.js";import{TestingContextKeys as _}from"../../common/testingContextKeys.js";import{cmpPriority as He}from"../../common/testingStates.js";import{TestUriType as Ue,buildTestUri as Ke}from"../../common/testingUri.js";import{IEditorService as Ge}from"../../../../services/editor/common/editorService.js";class J{constructor(e){this.value=e}changeEmitter=new H;onDidChange=this.changeEmitter.event;type="result";context=this.value.id;id=this.value.id;label=this.value.name;get icon(){return E.testingStatesToIcons.get(this.value.completedAt===void 0?G.Running:qe(this.value.counts))}}const Je=p("openTestCoverage","View Test Coverage"),Qe=p("closeTestCoverage","Close Test Coverage");class oe{constructor(e,n,s){this.results=e;this.task=n;this.coverageService=s;this.onDidChange=w.fromObservableLight(s.selected)}type="coverage";context;id=`coverage-${this.results.id}/${this.task.id}`;onDidChange;get label(){return this.isOpen?Qe:Je}get icon(){return this.isOpen?Oe:E.testingCoverageReport}get isOpen(){return this.coverageService.selected.get()?.fromTaskId===this.task.id}}class ae{constructor(e){this.n=e;this.label=p("nOlderResults","{0} older results",e)}type="older";context;id=`older-${this.n}`;onDidChange=w.None;label}class M{constructor(e,n,s){this.results=e;this.test=n;this.taskIndex=s}type="test";context={$mid:Te.TestItemContext,tests:[je.serialize(this.test)]};id=`${this.results.id}/${this.test.item.extId}`;description;get onDidChange(){return this.results instanceof K?w.filter(this.results.onChange,e=>e.item.item.extId===this.test.item.extId):w.None}get state(){return this.test.tasks[this.taskIndex].state}get label(){return this.test.item.label}get labelWithIcons(){return me(this.label)}get icon(){return E.testingStatesToIcons.get(this.state)}get outputSubject(){return new z(this.results,this.taskIndex,this.test)}}class ${constructor(e,n,s){this.results=e;this.task=n;this.index=s;this.id=`${e.id}/${s}`,this.task=e.tasks[s],this.context={resultId:e.id,taskId:this.task.id},this.label=this.task.name}changeEmitter=new H;onDidChange=this.changeEmitter.event;type="task";context;id;label;itemsCache=new le;get icon(){return this.results.tasks[this.index].running?E.testingStatesToIcons.get(G.Running):void 0}}class O{constructor(e,n,s,o){this.result=e;this.test=n;this.taskIndex=s;this.messageIndex=o;const l=this.message=n.tasks[s].messages[o];this.location=l.location,this.contextValue=l.type===B.Error?l.contextValue:void 0,this.uri=Ke({type:Ue.ResultMessage,messageIndex:o,resultId:e.id,taskIndex:s,testExtId:n.item.extId}),this.id=this.uri.toString();const a=Le(l.message),m=be(a.trimEnd(),`
`);this.label=Xe(a),m>0&&(this.description=m>1?p("messageMoreLinesN","+ {0} more lines",m):p("messageMoreLines1","+ 1 more line"))}type="message";id;label;uri;location;description;contextValue;message;get onDidChange(){return this.result instanceof K?w.filter(this.result.onChange,e=>e.item.item.extId===this.test.item.extId):w.None}get context(){return Ae(this.test,this.message)}get outputSubject(){return new z(this.result,this.taskIndex,this.test)}}let q=class extends he{constructor(n,s,o,l,a,m,v,b,W,D){super();this.contextMenuService=l;this.treeActions=m.createInstance(A,o.showRevealLocationOnMessages,this.requestReveal);const x={getId(t){return t.id}};this.tree=this._register(m.createInstance(Se,"Test Output Peek",n,{getHeight:()=>22,getTemplateId:()=>R.ID},[m.createInstance(R,this.treeActions)],{compressionEnabled:!0,hideTwistiesOfChildlessElements:!0,identityProvider:x,sorter:{compare(t,i){return t instanceof M&&i instanceof M?He(t.state,i.state):0}},accessibilityProvider:{getAriaLabel(t){return t.ariaLabel||t.label},getWidgetAriaLabel(){return p("testingPeekLabel","Test Result Messages")}}}));const I=new le,Q=t=>{const{results:i,index:r,itemsCache:c,task:u}=t,h=N.filter(i.tests,k=>k.tasks[r].state>=G.Running||k.tasks[r].messages.length>0);let y=N.map(h,k=>({element:c.getOrCreate(k,()=>new M(i,k,r)),incompressible:!0,children:X(i,k,r)}));return u.coverage.get()&&(y=N.concat(N.single({element:new oe(i,u,b),collapsible:!0,incompressible:!0}),y)),y},X=(t,i,r)=>i.tasks[r].messages.map((c,u)=>c.type===B.Error?{element:I.getOrCreate(c,()=>new O(t,i,r,u)),incompressible:!1}:void 0).filter(Ie),Y=t=>t.tasks.map((i,r)=>{const c=I.getOrCreate(i,()=>new $(t,i,r));return{element:c,incompressible:!1,collapsible:!0,children:Q(c)}}),j=()=>{let t=[];const i=[];for(const r of a.results)if(!t.length&&r.tasks.length)t=Y(r);else if(t){const c=I.getOrCreate(r,()=>new J(r));i.push({element:c,incompressible:!0,collapsible:!0,collapsed:this.tree.hasElement(c)?this.tree.isCollapsed(c):!0,children:Y(r)})}return t.length?(i.length&&t.push({element:new ae(i.length),incompressible:!0,collapsible:!0,collapsed:!0,children:i}),t):i},V=new Set,Z=this._register(new ge(()=>{for(const t of V)this.tree.hasElement(t)&&this.tree.setChildren(t,Q(t),{diffIdentityProvider:x});V.clear()},300)),ee=t=>{V.add(t),Z.isScheduled()||Z.schedule()},te=t=>{const i=new U;i.add(t.onNewTask(r=>{this.tree.setChildren(null,j(),{diffIdentityProvider:x}),t.tasks.length===1&&this.requestReveal.fire(new F(t,0));const c=t.tasks[r];i.add(fe(u=>{c.coverage.read(u),ee(I.get(c))}))})),i.add(t.onEndTask(r=>{I.get(t.tasks[r])?.changeEmitter.fire()})),i.add(t.onChange(r=>{for(const[c,u]of t.tasks.entries()){const h=I.get(u);if(!this.tree.hasElement(h))continue;const y=h.itemsCache.get(r.item);if(y&&this.tree.hasElement(y)){r.reason===$e.NewMessage&&r.message.type===B.Error&&this.tree.setChildren(y,X(t,r.item,c),{diffIdentityProvider:x});return}ee(h)}})),i.add(t.onComplete(()=>{I.get(t)?.changeEmitter.fire(),i.dispose()}))};this._register(a.onResultsChanged(t=>{this.disposed||("completed"in t?I.get(t.completed)?.changeEmitter.fire():"started"in t?te(t.started):this.tree.setChildren(null,j(),{diffIdentityProvider:x}))}));const se=(t,i)=>{this.tree.setFocus([t]),this.tree.setSelection([t]),i||this.tree.domFocus()};this._register(s(async({subject:t,preserveFocus:i=!1})=>{if(t instanceof F){const u=this.tree.getNode(null).children.find(h=>h.element instanceof $?h.element.results.id===t.result.id&&h.element.index===t.taskIndex:h.element instanceof J?h.element.id===t.result.id:!1);u&&se(u.element,i);return}const r=t instanceof z?I.get(t.task)?.itemsCache.get(t.test):I.get(t.message);if(!r||!this.tree.hasElement(r))return;const c=[];for(let u=this.tree.getParentElement(r);u;u=this.tree.getParentElement(u))c.unshift(u);for(const u of c)this.tree.expand(u);this.tree.getRelativeTop(r)===null&&this.tree.reveal(r,.5),se(r,i)})),this._register(this.tree.onDidOpen(async t=>{if(t.element instanceof O)this.requestReveal.fire(new re(t.element.result,t.element.test,t.element.taskIndex,t.element.messageIndex));else if(t.element instanceof M){const i=t.element,r=Pe(t.element.test,(c,u,h,y)=>new re(i.results,i.test,y,h));this.requestReveal.fire(r||new z(i.results,0,i.test))}else if(t.element instanceof oe){const i=t.element.task;if(t.element.isOpen)return b.closeCoverage();W.withProgress({location:o.locationForProgress},()=>b.openCoverage(i,!0))}})),this._register(this.tree.onDidChangeSelection(t=>{for(const i of t.elements)if(i&&"test"in i){v.reveal.value=i.test.item.extId;break}})),this._register(this.tree.onContextMenu(t=>this.onContextMenu(t))),this._register(this.tree.onDidChangeCollapseState(t=>{t.node.element instanceof ae&&!t.node.collapsed&&D.publicLog2("testing.expandOlderResults")})),this.tree.setChildren(null,j());for(const t of a.results)!t.completedAt&&t instanceof K&&te(t)}disposed=!1;tree;treeActions;requestReveal=this._register(new H);onDidRequestReview=this.requestReveal.event;layout(n,s){this.tree.layout(n,s)}onContextMenu(n){if(!n.element)return;const s=this.treeActions.provideActionBar(n.element);this.contextMenuService.showContextMenu({getAnchor:()=>n.anchor,getActions:()=>s.secondary.length?[...s.primary,new pe,...s.secondary]:s.primary,getActionsContext:()=>n.element?.context})}dispose(){super.dispose(),this.disposed=!0}};q=P([g(3,ke),g(4,We),g(5,ie),g(6,Be),g(7,ze),g(8,we),g(9,Me)],q);let R=class{constructor(e,n){this.treeActions=e;this.instantiationService=n}static ID="testRunElementRenderer";templateId=R.ID;renderCompressedElements(e,n,s){const o=e.element.elements,l=o[o.length-1];(l instanceof $||l instanceof O)&&o.length>=2?this.doRender(o[o.length-2],s,l):this.doRender(l,s)}renderTemplate(e){const n=new U,s=C.append(e,C.$(".test-peek-item")),o=C.append(s,C.$(".state")),l=C.append(s,C.$(".name")),a=new de(s,{actionViewItemProvider:(v,b)=>v instanceof Ee?this.instantiationService.createInstance(ve,v,{hoverDelegate:b.hoverDelegate}):void 0}),m=new U;return n.add(m),n.add(a),{icon:o,label:l,actionBar:a,elementDisposable:m,templateDisposable:n}}renderElement(e,n,s){this.doRender(e.element,s)}disposeTemplate(e){e.templateDisposable.dispose()}doRender(e,n,s){n.elementDisposable.clear(),n.elementDisposable.add(e.onDidChange(()=>this.doRender(e,n,s))),this.doRenderInner(e,n,s)}doRenderInner(e,n,s){let{label:o,labelWithIcons:l,description:a}=e;s instanceof O&&(a=s.label);const m=a?C.$("span.test-label-description",{},a):"";l?C.reset(n.label,...l,m):C.reset(n.label,o,m);const v=e.icon;n.icon.className=`computed-state ${v?T.asClassName(v):""}`;const b=this.treeActions.provideActionBar(e);n.actionBar.clear(),n.actionBar.context=e.context,n.actionBar.push(b.primary,{icon:!0,label:!1})}};R=P([g(1,ie)],R);let A=class{constructor(e,n,s,o,l,a,m){this.showRevealLocationOnMessages=e;this.requestReveal=n;this.contextKeyService=s;this.menuService=o;this.commandService=l;this.testProfileService=a;this.editorService=m}provideActionBar(e){const n=e instanceof M?e.test:void 0,s=n?this.testProfileService.capabilitiesForTest(n.item):0,o=[["peek",Fe.OutputPeekContributionId],[_.peekItemType.key,e.type]];let l=ne.TestPeekElement;const a=[],m=[];if(e instanceof $&&(a.push(new f("testing.outputPeek.showResultOutput",p("testing.showResultOutput","Show Result Output"),T.asClassName(S.terminal),void 0,()=>this.requestReveal.fire(new F(e.results,e.index)))),e.task.running&&a.push(new f("testing.outputPeek.cancel",p("testing.cancelRun","Cancel Test Run"),T.asClassName(E.testingCancelIcon),void 0,()=>this.commandService.executeCommand(Ne.CancelTestRunAction,e.results.id,e.task.id)))),e instanceof J&&(e.value.tasks.length===1&&a.push(new f("testing.outputPeek.showResultOutput",p("testing.showResultOutput","Show Result Output"),T.asClassName(S.terminal),void 0,()=>this.requestReveal.fire(new F(e.value,0)))),a.push(new f("testing.outputPeek.reRunLastRun",p("testing.reRunLastRun","Rerun Test Run"),T.asClassName(E.testingRunIcon),void 0,()=>this.commandService.executeCommand("testing.reRunLastRun",e.value.id))),s&L.Debug&&a.push(new f("testing.outputPeek.debugLastRun",p("testing.debugLastRun","Debug Test Run"),T.asClassName(E.testingDebugIcon),void 0,()=>this.commandService.executeCommand("testing.debugLastRun",e.value.id)))),e instanceof M||e instanceof O){o.push([_.testResultOutdated.key,e.test.retired],[_.testResultState.key,Ve[e.test.ownComputedState]],...De(e.test,s));const D=e.test.item.extId;e.test.tasks[e.taskIndex].messages.some(x=>x.type===B.Output)&&a.push(new f("testing.outputPeek.showResultOutput",p("testing.showResultOutput","Show Result Output"),T.asClassName(S.terminal),void 0,()=>this.requestReveal.fire(e.outputSubject))),m.push(new f("testing.outputPeek.revealInExplorer",p("testing.revealInExplorer","Reveal in Test Explorer"),T.asClassName(S.listTree),void 0,()=>this.commandService.executeCommand("_revealTestInExplorer",D))),s&L.Run&&a.push(new f("testing.outputPeek.runTest",p("run test","Run Test"),T.asClassName(E.testingRunIcon),void 0,()=>this.commandService.executeCommand("vscode.runTestsById",L.Run,D))),s&L.Debug&&a.push(new f("testing.outputPeek.debugTest",p("debug test","Debug Test"),T.asClassName(E.testingDebugIcon),void 0,()=>this.commandService.executeCommand("vscode.runTestsById",L.Debug,D)))}e instanceof O&&(l=ne.TestMessageContext,o.push([_.testMessageContext.key,e.contextValue]),a.push(new f("testing.outputPeek.goToTest",p("testing.goToTest","Go to Test"),T.asClassName(S.goToFile),void 0,()=>this.commandService.executeCommand("vscode.revealTest",e.test.item.extId))),this.showRevealLocationOnMessages&&e.location&&a.push(new f("testing.outputPeek.goToError",p("testing.goToError","Go to Error"),T.asClassName(S.goToFile),void 0,()=>this.editorService.openEditor({resource:e.location.uri,options:{selection:e.location.range,preserveFocus:!0}}))));const v=this.contextKeyService.createOverlay(o),b={primary:a,secondary:m},W=this.menuService.getMenuActions(l,v,{arg:e.context});return ye(W,b,"inline"),b}};A=P([g(2,xe),g(3,Ce),g(4,Re),g(5,_e),g(6,Ge)],A);class le{v=new WeakMap;get(e){return this.v.get(e)}getOrCreate(e,n){const s=this.v.get(e);if(s)return s;const o=n();return this.v.set(e,o),o}}const Xe=d=>{const e=d.indexOf(`
`);return e===-1?d:d.slice(0,e)};export{q as OutputPeekTree};
