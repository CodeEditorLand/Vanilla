import{groupBy as h}from"../../../../../vs/base/common/arrays.js";import{DisposableStore as k}from"../../../../../vs/base/common/lifecycle.js";import{ThemeIcon as R}from"../../../../../vs/base/common/themables.js";import{isDefined as S}from"../../../../../vs/base/common/types.js";import"../../../../../vs/editor/browser/editorExtensions.js";import{localize as P}from"../../../../../vs/nls.js";import{CommandsRegistry as g}from"../../../../../vs/platform/commands/common/commands.js";import{IQuickInputService as b}from"../../../../../vs/platform/quickinput/common/quickInput.js";import{testingUpdateProfiles as v}from"../../../../../vs/workbench/contrib/testing/browser/icons.js";import{testConfigurationGroupNames as w}from"../../../../../vs/workbench/contrib/testing/common/constants.js";import{canUseProfileWithTest as Q,ITestProfileService as I}from"../../../../../vs/workbench/contrib/testing/common/testProfileService.js";import"../../../../../vs/workbench/contrib/testing/common/testTypes.js";function T(o,{onlyGroup:r,showConfigureButtons:s=!0,onlyForTest:e,onlyConfigurable:t,placeholder:l=P("testConfigurationUi.pick","Pick a test profile to use")}){const i=o.get(I),n=[],d=(f,p)=>{for(const m of h(f,(u,c)=>u.group-c.group)){let u=!1;if(r){if(m[0].group!==r)continue;u=!0}for(const c of m)t&&!c.hasConfigurationHandler||(u||(n.push({type:"separator",label:w[m[0].group]}),u=!0),n.push({type:"item",profile:c,label:c.label,description:p,alwaysShow:!0,buttons:c.hasConfigurationHandler&&s?[{iconClass:R.asClassName(v),tooltip:P("updateTestConfiguration","Update Test Configuration")}]:[]}))}};if(e!==void 0)d(i.getControllerProfiles(e.controllerId).filter(f=>Q(f,e)));else for(const{profiles:f,controller:p}of i.all())d(f,p.label.get());const a=o.get(b).createQuickPick({useSeparators:!0});return a.items=n,a.placeholder=l,a}const C=(o,r)=>s=>{const e=s.item.profile;e&&(o.configure(e.controllerId,e.profileId),r(void 0))};g.registerCommand({id:"vscode.pickMultipleTestProfiles",handler:async(o,r)=>{const s=o.get(I),e=T(o,r);if(!e)return;const t=new k;t.add(e),e.canSelectMany=!0,r.selected&&(e.selectedItems=e.items.filter(i=>i.type==="item").filter(i=>r.selected.some(n=>n.controllerId===i.profile.controllerId&&n.profileId===i.profile.profileId)));const l=await new Promise(i=>{t.add(e.onDidAccept(()=>{const n=e.selectedItems;i(n.map(d=>d.profile).filter(S))})),t.add(e.onDidHide(()=>i(void 0))),t.add(e.onDidTriggerItemButton(C(s,i))),e.show()});return t.dispose(),l}}),g.registerCommand({id:"vscode.pickTestProfile",handler:async(o,r)=>{const s=o.get(I),e=T(o,r);if(!e)return;const t=new k;t.add(e);const l=await new Promise(i=>{t.add(e.onDidAccept(()=>i(e.selectedItems[0]?.profile))),t.add(e.onDidHide(()=>i(void 0))),t.add(e.onDidTriggerItemButton(C(s,i))),e.show()});return t.dispose(),l}});
