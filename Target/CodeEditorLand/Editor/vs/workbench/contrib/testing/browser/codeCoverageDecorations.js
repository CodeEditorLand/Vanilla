var pe=Object.defineProperty;var ue=Object.getOwnPropertyDescriptor;var F=(l,a,e,o)=>{for(var t=o>1?void 0:o?ue(a,e):a,s=l.length-1,d;s>=0;s--)(d=l[s])&&(t=(o?d(a,e,t):d(t))||t);return o&&t&&pe(a,e,t),t},f=(l,a)=>(e,o)=>a(e,o,l);import*as S from"../../../../../vs/base/browser/dom.js";import{ActionBar as me,ActionsOrientation as ve}from"../../../../../vs/base/browser/ui/actionbar/actionbar.js";import{ActionViewItem as fe}from"../../../../../vs/base/browser/ui/actionbar/actionViewItems.js";import{renderIcon as Ie}from"../../../../../vs/base/browser/ui/iconLabel/iconLabels.js";import{Action as Ce}from"../../../../../vs/base/common/actions.js";import{mapFindFirst as be}from"../../../../../vs/base/common/arraysFind.js";import{assert as Te,assertNever as Se}from"../../../../../vs/base/common/assert.js";import{CancellationTokenSource as z}from"../../../../../vs/base/common/cancellation.js";import{Codicon as q}from"../../../../../vs/base/common/codicons.js";import{MarkdownString as w}from"../../../../../vs/base/common/htmlContent.js";import{KeyChord as ye,KeyCode as Z,KeyMod as W}from"../../../../../vs/base/common/keyCodes.js";import{Lazy as we}from"../../../../../vs/base/common/lazy.js";import{Disposable as G,DisposableStore as H,MutableDisposable as De,toDisposable as x}from"../../../../../vs/base/common/lifecycle.js";import{autorun as O,derived as Me,observableFromEvent as Q}from"../../../../../vs/base/common/observable.js";import{ThemeIcon as Ee}from"../../../../../vs/base/common/themables.js";import{isUriComponents as Ne,URI as xe}from"../../../../../vs/base/common/uri.js";import{MouseTargetType as X,OverlayWidgetPositionPreference as Oe}from"../../../../../vs/editor/browser/editorBrowser.js";import{ICodeEditorService as ke}from"../../../../../vs/editor/browser/services/codeEditorService.js";import{EditorOption as Y}from"../../../../../vs/editor/common/config/editorOptions.js";import{Position as K}from"../../../../../vs/editor/common/core/position.js";import{Range as k}from"../../../../../vs/editor/common/core/range.js";import"../../../../../vs/editor/common/editorCommon.js";import{InjectedTextCursorStops as J}from"../../../../../vs/editor/common/model.js";import{localize as v,localize2 as R}from"../../../../../vs/nls.js";import{Categories as V}from"../../../../../vs/platform/action/common/actionCommonCategories.js";import{Action2 as $,MenuId as y,registerAction2 as j}from"../../../../../vs/platform/actions/common/actions.js";import{ICommandService as Re}from"../../../../../vs/platform/commands/common/commands.js";import{IConfigurationService as U}from"../../../../../vs/platform/configuration/common/configuration.js";import{ContextKeyExpr as ee}from"../../../../../vs/platform/contextkey/common/contextkey.js";import{IContextMenuService as Ae}from"../../../../../vs/platform/contextview/browser/contextView.js";import{IInstantiationService as te}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{IKeybindingService as Le}from"../../../../../vs/platform/keybinding/common/keybinding.js";import{KeybindingWeight as _e}from"../../../../../vs/platform/keybinding/common/keybindingsRegistry.js";import{ILogService as Be}from"../../../../../vs/platform/log/common/log.js";import{observableConfigValue as Pe}from"../../../../../vs/platform/observable/common/platformObservableUtils.js";import{IQuickInputService as Fe}from"../../../../../vs/platform/quickinput/common/quickInput.js";import*as A from"../../../../../vs/workbench/contrib/testing/browser/codeCoverageDisplayUtils.js";import{testingCoverageMissingBranch as We,testingCoverageReport as oe,testingFilterIcon as ie,testingRerunIcon as He}from"../../../../../vs/workbench/contrib/testing/browser/icons.js";import{ManagedTestCoverageBars as Ke}from"../../../../../vs/workbench/contrib/testing/browser/testCoverageBars.js";import{getTestingConfiguration as Ve,TestingConfigKeys as D}from"../../../../../vs/workbench/contrib/testing/common/configuration.js";import{TestCommandId as L}from"../../../../../vs/workbench/contrib/testing/common/constants.js";import{FileCoverage as $e}from"../../../../../vs/workbench/contrib/testing/common/testCoverage.js";import{ITestCoverageService as _}from"../../../../../vs/workbench/contrib/testing/common/testCoverageService.js";import{TestId as ne}from"../../../../../vs/workbench/contrib/testing/common/testId.js";import{TestingContextKeys as C}from"../../../../../vs/workbench/contrib/testing/common/testingContextKeys.js";import{ITestService as je}from"../../../../../vs/workbench/contrib/testing/common/testService.js";import{DetailType as T}from"../../../../../vs/workbench/contrib/testing/common/testTypes.js";const re="coverage-deco-hit",se="coverage-deco-miss",Ue=v("testing.toggleInlineCoverage","Toggle Inline"),ae="testing.toggleInlineCoverage",ze=4;let B=class extends G{constructor(e,o,t,s,d){super();this.editor=e;this.coverage=t;this.log=d;this.summaryWidget=new we(()=>this._register(o.createInstance(M,this.editor)));const i=Q(this,e.onDidChangeModel,()=>e.getModel()),n=Q(this,e.onDidChangeConfiguration,r=>r),c=Me(r=>{const g=t.selected.read(r);if(!g)return;const u=i.read(r);if(!u)return;const m=g.getUri(u.uri);if(m)return g.didAddCoverage.read(r),{file:m,testId:t.filterToTest.read(r)}});this._register(O(r=>{const g=c.read(r);g?this.apply(e.getModel(),g.file,g.testId,t.showInline.read(r)):this.clear()}));const h=Pe(D.CoverageToolbarEnabled,!0,s);this._register(O(r=>{const g=c.read(r);g&&h.read(r)?this.summaryWidget.value.setCoverage(g.file,g.testId):this.summaryWidget.rawValue?.clearCoverage()})),this._register(O(r=>{c.read(r)&&n.read(r)?.hasChanged(Y.lineHeight)!==!1&&this.updateEditorStyles()})),this._register(e.onMouseMove(r=>{const g=e.getModel();r.target.type===X.GUTTER_LINE_NUMBERS&&g?this.hoverLineNumber(e.getModel(),r.target.position.lineNumber):t.showInline.get()&&r.target.type===X.CONTENT_TEXT&&g?this.hoverInlineDecoration(g,r.target.position):this.hoveredStore.clear()})),this._register(e.onWillChangeModel(()=>{const r=e.getModel();if(!(!this.details||!r))for(const g of r.getAllDecorations()){const u=this.decorationIds.get(g.id);u&&(u.detail.range=g.range)}}))}loadingCancellation;displayedStore=this._register(new H);hoveredStore=this._register(new H);summaryWidget;decorationIds=new Map;hoveredSubject;details;updateEditorStyles(){const e=this.editor.getOption(Y.lineHeight),{style:o}=this.editor.getContainerDomNode();o.setProperty("--vscode-testing-coverage-lineHeight",`${e}px`)}hoverInlineDecoration(e,o){const t=e.getDecorationsInRange(k.fromPositions(o)),s=be(t,({id:d})=>this.decorationIds.has(d)?{id:d,deco:this.decorationIds.get(d)}:void 0);s!==this.hoveredSubject&&(this.hoveredStore.clear(),this.hoveredSubject=s,s&&(e.changeDecorations(d=>{d.changeDecorationOptions(s.id,{...s.deco.options,className:`${s.deco.options.className} coverage-deco-hovered`})}),this.hoveredStore.add(x(()=>{this.hoveredSubject=void 0,e.changeDecorations(d=>{d.changeDecorationOptions(s.id,s.deco.options)})}))))}hoverLineNumber(e,o){if(o===this.hoveredSubject||!this.details)return;this.hoveredStore.clear(),this.hoveredSubject=o;const t=[{line:o,dir:0}],s=new Set,d=this.editor.getVisibleRanges();if(!this.coverage.showInline.get()){for(let i=0;i<t.length;i++){const{line:n,dir:c}=t[i];if(!d.some(r=>r.startLineNumber<=n&&r.endLineNumber>=n))continue;let h=!1;for(const r of e.getLineDecorations(n))this.decorationIds.has(r.id)&&(s.add(r.id),h=!0);h&&(c<=0&&t.push({line:n-1,dir:-1}),c>=0&&t.push({line:n+1,dir:1}))}e.changeDecorations(i=>{for(const n of s){const{applyHoverOptions:c,options:h}=this.decorationIds.get(n),r={...h};c(r),i.changeDecorationOptions(n,r)}})}this.hoveredStore.add(this.editor.onMouseLeave(()=>{this.hoveredStore.clear()})),this.hoveredStore.add(x(()=>{this.hoveredSubject=void 0,e.changeDecorations(i=>{for(const n of s){const c=this.decorationIds.get(n);c&&i.changeDecorationOptions(n,c.options)}})}))}async apply(e,o,t,s){const d=this.details=await this.loadDetails(o,t,e);if(!d)return this.clear();this.displayedStore.clear(),e.changeDecorations(i=>{for(const n of d.ranges){const{metadata:{detail:c,description:h},range:r,primary:g}=n;if(c.type===T.Branch){const u=c.detail.branches[c.branch].count,m=u?re:se,p=!u&&r.isEmpty()&&c.detail.branches.some(I=>I.count),b={showIfCollapsed:p,description:"coverage-gutter",lineNumberClassName:`coverage-deco-gutter ${m}`},N=I=>{I.hoverMessage=h,p?I.after={content:"\xA0".repeat(ze),inlineClassName:`coverage-deco-branch-miss-indicator ${Ee.asClassName(We)}`,inlineClassNameAffectsLetterSpacing:!0,cursorStops:J.None}:(I.className=`coverage-deco-inline ${m}`,g&&typeof u=="number"&&(I.before=ce(u)))};s&&N(b),this.decorationIds.set(i.addDecoration(r,b),{options:b,applyHoverOptions:N,detail:n})}else if(c.type===T.Statement){const u=c.count?re:se,m={showIfCollapsed:!1,description:"coverage-inline",lineNumberClassName:`coverage-deco-gutter ${u}`},p=b=>{b.className=`coverage-deco-inline ${u}`,b.hoverMessage=h,g&&typeof c.count=="number"&&(b.before=ce(c.count))};s&&p(m),this.decorationIds.set(i.addDecoration(r,m),{options:m,applyHoverOptions:p,detail:n})}}}),this.displayedStore.add(x(()=>{e.changeDecorations(i=>{for(const n of this.decorationIds.keys())i.removeDecoration(n);this.decorationIds.clear()})}))}clear(){this.loadingCancellation?.cancel(),this.loadingCancellation=void 0,this.displayedStore.clear(),this.hoveredStore.clear()}async loadDetails(e,o,t){const s=this.loadingCancellation=new z;this.displayedStore.add(this.loadingCancellation);try{const d=o?await e.detailsForTest(o,this.loadingCancellation.token):await e.details(this.loadingCancellation.token);return s.token.isCancellationRequested?void 0:new qe(d,t)}catch(d){this.log.error("Error loading coverage details",d)}}};B=F([f(1,te),f(2,_),f(3,U),f(4,Be)],B);const ce=l=>{if(l!==0)return{content:`${l>99?"99+":l}x`,cursorStops:J.None,inlineClassName:"coverage-deco-inline-count",inlineClassNameAffectsLetterSpacing:!0}};class qe{constructor(a,e){this.details=a;const o=a.map(i=>({range:P(i.location),primary:!0,metadata:{detail:i,description:this.describe(i,e)}}));for(const{range:i,metadata:{detail:n}}of o)if(n.type===T.Statement&&n.branches)for(let c=0;c<n.branches.length;c++){const h={type:T.Branch,branch:c,detail:n};o.push({range:P(n.branches[c].location||k.fromPositions(i.getEndPosition())),primary:!0,metadata:{detail:h,description:this.describe(h,e)}})}o.sort((i,n)=>k.compareRangesUsingStarts(i.range,n.range)||i.metadata.detail.type-n.metadata.detail.type);const t=[],s=this.ranges=[],d=()=>{const i=t.pop(),n=t[t.length-1];n&&(n.range=n.range.setStartPosition(i.range.endLineNumber,i.range.endColumn)),s.push(i)};for(const i of o){const n=i.range.getStartPosition();for(;t[t.length-1]?.range.containsPosition(n)===!1;)d();if(i.range.isEmpty()){s.push(i);continue}const c=t[t.length-1];if(c){const h=c.primary,r=c.range.setEndPosition(n.lineNumber,n.column);c.range=c.range.setStartPosition(i.range.endLineNumber,i.range.endColumn),c.primary=!1,c.range.isEmpty()&&t.pop(),s.push({range:r,primary:h,metadata:c.metadata})}t.push(i)}for(;t.length;)d()}ranges=[];describe(a,e){if(a.type===T.Declaration)return de(a.name,a);if(a.type===T.Statement){const o=ge(e.getValueInRange(P(a.location)).trim()||"<empty statement>");if(a.branches?.length){const t=a.branches.filter(s=>!!s.count).length;return new w().appendMarkdown(v("coverage.branches","{0} of {1} of branches in {2} were covered.",t,a.branches.length,o))}else return de(o,a)}else if(a.type===T.Branch){const o=ge(e.getValueInRange(P(a.detail.location)).trim()||"<empty statement>"),{count:t,label:s}=a.detail.branches[a.branch],d=s?le(s):`#${a.branch+1}`;return t?t===!0?new w().appendMarkdown(v("coverage.branchCoveredYes","Branch {0} in {1} was executed.",d,o)):new w().appendMarkdown(v("coverage.branchCovered","Branch {0} in {1} was executed {2} time(s).",d,o,t)):new w().appendMarkdown(v("coverage.branchNotCovered","Branch {0} in {1} was not covered.",d,o))}Se(a)}}function de(l,a){return new w().appendMarkdown(a.count?typeof a.count=="number"?v("coverage.declExecutedCount","`{0}` was executed {1} time(s).",l,a.count):v("coverage.declExecutedYes","`{0}` was executed.",l):v("coverage.declExecutedNo","`{0}` was not executed.",l))}function P(l){return l instanceof K?k.fromPositions(l,new K(l.lineNumber,2147483647)):l}function le(l){return"`"+l.replace(/[\n\r`]/g,"")+"`"}function ge(l){return l.length>50&&(l=l.slice(0,40)+"..."),le(l)}let M=class extends G{constructor(e,o,t,s,d,i,n,c){super();this.editor=e;this.configurationService=o;this.contextMenuService=t;this.testService=s;this.keybindingService=d;this.commandService=i;this.coverage=n;this.bars=this._register(c.createInstance(Ke,{compact:!1,overall:!1,container:this._domNode.bars})),this.actionBar=this._register(c.createInstance(me,this._domNode.toolbar,{orientation:ve.HORIZONTAL,actionViewItemProvider:(h,r)=>{const g=new Ze(void 0,h,r);return h instanceof E&&(g.themeIcon=h.icon),g}})),this._register(O(h=>{n.showInline.read(h),this.setActions()})),this._register(S.addStandardDisposableListener(this._domNode.root,S.EventType.CONTEXT_MENU,h=>{this.contextMenuService.showContextMenu({menuId:y.StickyScrollContext,getAnchor:()=>h})}))}current;registered=!1;isRunning=!1;showStore=this._register(new H);actionBar;_domNode=S.h("div.coverage-summary-widget",[S.h("div",[S.h("span.bars@bars"),S.h("span.toolbar@toolbar")])]);bars;getId(){return"coverage-summary-widget"}getDomNode(){return this._domNode.root}getPosition(){return{preference:Oe.TOP_CENTER,stackOridinal:9}}clearCoverage(){this.current=void 0,this.bars.setCoverageInfo(void 0),this.hide()}setCoverage(e,o){this.current={coverage:e,testId:o},this.bars.setCoverageInfo(e),e?(this.setActions(),this.show()):this.hide()}setActions(){this.actionBar.clear();const e=this.current;if(!e)return;const o=new E("toggleInline",this.coverage.showInline.get()?v("testing.hideInlineCoverage","Hide Inline Coverage"):v("testing.showInlineCoverage","Show Inline Coverage"),oe,void 0,()=>this.coverage.showInline.set(!this.coverage.showInline.get(),void 0)),t=this.keybindingService.lookupKeybinding(ae);if(t&&(o.tooltip=`${Ue} (${t.getLabel()})`),this.actionBar.push(o),e.testId){const s=e.coverage.fromResult.getTestById(e.testId.toString());Te(!!s,"got coverage for an unreported test"),this.actionBar.push(new E("perTestFilter",A.labels.showingFilterFor(s.label),ie,void 0,()=>this.commandService.executeCommand(L.CoverageFilterToTestInEditor,this.current,this.editor)))}else e.coverage.perTestData?.size&&this.actionBar.push(new E("perTestFilter",v("testing.coverageForTestAvailable","{0} test(s) ran code in this file",e.coverage.perTestData.size),ie,void 0,()=>this.commandService.executeCommand(L.CoverageFilterToTestInEditor,this.current,this.editor)));this.actionBar.push(new E("rerun",v("testing.rerun","Rerun"),He,!this.isRunning,()=>this.rerunTest()))}show(){if(this.registered)return;this.registered=!0;let e;const o=this.showStore;this.editor.addOverlayWidget(this),this.editor.changeViewZones(t=>{e=t.addZone({afterLineNumber:0,afterColumn:0,domNode:document.createElement("div"),heightInPx:30,ordinal:-1})}),o.add(x(()=>{this.registered=!1,this.editor.removeOverlayWidget(this),this.editor.changeViewZones(t=>{t.removeZone(e)})})),o.add(this.configurationService.onDidChangeConfiguration(t=>{this.current&&(t.affectsConfiguration(D.CoverageBarThresholds)||t.affectsConfiguration(D.CoveragePercent))&&this.setCoverage(this.current.coverage,this.current.testId)}))}rerunTest(){const e=this.current;e&&(this.isRunning=!0,this.setActions(),this.testService.runResolvedTests(e.coverage.fromResult.request).finally(()=>{this.isRunning=!1,this.setActions()}))}hide(){this.showStore.clear()}};M=F([f(1,U),f(2,Ae),f(3,je),f(4,Le),f(5,Re),f(6,_),f(7,te)],M),j(class extends ${constructor(){super({id:ae,title:R("coverage.toggleInline","Toggle Inline Coverage"),category:V.Test,keybinding:{weight:_e.WorkbenchContrib,primary:ye(W.CtrlCmd|Z.Semicolon,W.CtrlCmd|W.Shift|Z.KeyI)},toggled:{condition:C.inlineCoverageEnabled,title:v("coverage.hideInline","Hide Inline Coverage")},icon:oe,menu:[{id:y.CommandPalette,when:C.isTestCoverageOpen},{id:y.EditorTitle,when:ee.and(C.isTestCoverageOpen,C.coverageToolbarEnabled.notEqualsTo(!0)),group:"navigation"}]})}run(a){const e=a.get(_);e.showInline.set(!e.showInline.get(),void 0)}}),j(class extends ${constructor(){super({id:L.CoverageToggleToolbar,title:R("testing.toggleToolbarTitle","Test Coverage Toolbar"),metadata:{description:R("testing.toggleToolbarDesc","Toggle the sticky coverage bar in the editor.")},category:V.Test,toggled:{condition:C.coverageToolbarEnabled},menu:[{id:y.CommandPalette,when:C.isTestCoverageOpen},{id:y.StickyScrollContext,when:C.isTestCoverageOpen},{id:y.EditorTitle,when:C.isTestCoverageOpen,group:"coverage@1"}]})}run(a){const e=a.get(U),o=Ve(e,D.CoverageToolbarEnabled);e.updateValue(D.CoverageToolbarEnabled,!o)}}),j(class extends ${constructor(){super({id:L.CoverageFilterToTestInEditor,title:R("testing.filterActionLabel","Filter Coverage to Test"),category:V.Test,icon:q.filter,toggled:{icon:q.filterFilled,condition:C.isCoverageFilteredToTest},menu:[{id:y.EditorTitle,when:ee.and(C.isTestCoverageOpen,C.coverageToolbarEnabled.notEqualsTo(!0)),group:"navigation"}]})}run(a,e,o){const t=a.get(_),s=a.get(Fe),d=o??a.get(ke).getActiveCodeEditor();let i;if(e instanceof $e)i=e;else if(Ne(e))i=t.selected.get()?.getUri(xe.from(e));else{const p=d?.getModel()?.uri;i=p&&t.selected.get()?.getUri(p)}if(!i||!i.perTestData?.size)return;const n=[...i.perTestData].map(ne.fromString),c=ne.getLengthOfCommonPrefix(n.length,p=>n[p]),h=i.fromResult,r=t.filterToTest.get(),g=[{label:A.labels.allTests,testId:void 0},{type:"separator"},...n.map(p=>({label:A.getLabelForItem(h,p,c),testId:p}))],u=d?.getScrollTop()||0,m=new De;s.pick(g,{activeItem:g.find(p=>"item"in p&&p.item===i),placeHolder:A.labels.pickShowCoverage,onDidFocus:p=>{if(!p.testId)m.clear(),d?.setScrollTop(u),t.filterToTest.set(void 0,void 0);else{const b=m.value=new z;i.detailsForTest(p.testId,b.token).then(N=>{const I=N.find(he=>he.type===T.Statement);!b.token.isCancellationRequested&&I&&d?.revealLineNearTop(I.location instanceof K?I.location.lineNumber:I.location.startLineNumber)},()=>{}),t.filterToTest.set(p.testId,void 0)}}}).then(p=>{p||d?.setScrollTop(u),m.dispose(),t.filterToTest.set(p?p.testId:r,void 0)})}});class E extends Ce{constructor(e,o,t,s,d){super(e,o,void 0,s,d);this.icon=t}}class Ze extends fe{themeIcon;updateLabel(){this.options.label&&this.label&&this.themeIcon&&S.reset(this.label,Ie(this.themeIcon),this.action.label)}}export{B as CodeCoverageDecorations,qe as CoverageDetailsModel};
