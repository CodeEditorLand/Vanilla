var he=Object.defineProperty;var ue=Object.getOwnPropertyDescriptor;var F=(c,n,e,o)=>{for(var t=o>1?void 0:o?ue(n,e):n,i=c.length-1,s;i>=0;i--)(s=c[i])&&(t=(o?s(n,e,t):s(t))||t);return o&&t&&he(n,e,t),t},f=(c,n)=>(e,o)=>n(e,o,c);import*as y from"../../../../base/browser/dom.js";import{ActionViewItem as me}from"../../../../base/browser/ui/actionbar/actionViewItems.js";import{ActionBar as ve,ActionsOrientation as fe}from"../../../../base/browser/ui/actionbar/actionbar.js";import{renderIcon as Ie}from"../../../../base/browser/ui/iconLabel/iconLabels.js";import{Action as Ce}from"../../../../base/common/actions.js";import{mapFindFirst as be}from"../../../../base/common/arraysFind.js";import{assert as Te,assertNever as ye}from"../../../../base/common/assert.js";import{CancellationTokenSource as z}from"../../../../base/common/cancellation.js";import{Codicon as q}from"../../../../base/common/codicons.js";import{MarkdownString as w}from"../../../../base/common/htmlContent.js";import{KeyChord as Se,KeyCode as Z,KeyMod as W}from"../../../../base/common/keyCodes.js";import{Lazy as we}from"../../../../base/common/lazy.js";import{Disposable as G,DisposableStore as H,MutableDisposable as De,toDisposable as x}from"../../../../base/common/lifecycle.js";import{autorun as O,derived as Me,observableFromEvent as Q}from"../../../../base/common/observable.js";import{ThemeIcon as Ee}from"../../../../base/common/themables.js";import{URI as Ne,isUriComponents as xe}from"../../../../base/common/uri.js";import{MouseTargetType as X,OverlayWidgetPositionPreference as Oe}from"../../../../editor/browser/editorBrowser.js";import{ICodeEditorService as ke}from"../../../../editor/browser/services/codeEditorService.js";import{EditorOption as Y}from"../../../../editor/common/config/editorOptions.js";import{Position as j}from"../../../../editor/common/core/position.js";import{Range as k}from"../../../../editor/common/core/range.js";import{InjectedTextCursorStops as J}from"../../../../editor/common/model.js";import{localize as v,localize2 as R}from"../../../../nls.js";import{Categories as K}from"../../../../platform/action/common/actionCommonCategories.js";import{Action2 as $,MenuId as S,registerAction2 as V}from"../../../../platform/actions/common/actions.js";import{ICommandService as Re}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as U}from"../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as ee}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as Ae}from"../../../../platform/contextview/browser/contextView.js";import{IInstantiationService as te}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as _e}from"../../../../platform/keybinding/common/keybinding.js";import{KeybindingWeight as Le}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{ILogService as Be}from"../../../../platform/log/common/log.js";import{observableConfigValue as Pe}from"../../../../platform/observable/common/platformObservableUtils.js";import{IQuickInputService as Fe}from"../../../../platform/quickinput/common/quickInput.js";import{TestingConfigKeys as D,getTestingConfiguration as We}from"../common/configuration.js";import{TestCommandId as A}from"../common/constants.js";import{FileCoverage as He}from"../common/testCoverage.js";import{ITestCoverageService as _}from"../common/testCoverageService.js";import{TestId as oe}from"../common/testId.js";import{ITestService as je}from"../common/testService.js";import{DetailType as T}from"../common/testTypes.js";import{TestingContextKeys as C}from"../common/testingContextKeys.js";import*as L from"./codeCoverageDisplayUtils.js";import{testingCoverageMissingBranch as Ke,testingCoverageReport as ie,testingFilterIcon as ne,testingRerunIcon as $e}from"./icons.js";import{ManagedTestCoverageBars as Ve}from"./testCoverageBars.js";const re="coverage-deco-hit",se="coverage-deco-miss",Ue=v("testing.toggleInlineCoverage","Toggle Inline"),ae="testing.toggleInlineCoverage",ze=4;let B=class extends G{constructor(e,o,t,i,s){super();this.editor=e;this.coverage=t;this.log=s;this.summaryWidget=new we(()=>this._register(o.createInstance(M,this.editor)));const r=Q(this,e.onDidChangeModel,()=>e.getModel()),a=Q(this,e.onDidChangeConfiguration,d=>d),l=Me(d=>{const g=t.selected.read(d);if(!g)return;const u=r.read(d);if(!u)return;const m=g.getUri(u.uri);if(m)return g.didAddCoverage.read(d),{file:m,testId:t.filterToTest.read(d)}});this._register(O(d=>{const g=l.read(d);g?this.apply(e.getModel(),g.file,g.testId,t.showInline.read(d)):this.clear()}));const h=Pe(D.CoverageToolbarEnabled,!0,i);this._register(O(d=>{const g=l.read(d);g&&h.read(d)?this.summaryWidget.value.setCoverage(g.file,g.testId):this.summaryWidget.rawValue?.clearCoverage()})),this._register(O(d=>{l.read(d)&&a.read(d)?.hasChanged(Y.lineHeight)!==!1&&this.updateEditorStyles()})),this._register(e.onMouseMove(d=>{const g=e.getModel();d.target.type===X.GUTTER_LINE_NUMBERS&&g?this.hoverLineNumber(e.getModel()):t.showInline.get()&&d.target.type===X.CONTENT_TEXT&&g?this.hoverInlineDecoration(g,d.target.position):this.hoveredStore.clear()})),this._register(e.onWillChangeModel(()=>{const d=e.getModel();if(!(!this.details||!d))for(const g of d.getAllDecorations()){const u=this.decorationIds.get(g.id);u&&(u.detail.range=g.range)}}))}loadingCancellation;displayedStore=this._register(new H);hoveredStore=this._register(new H);summaryWidget;decorationIds=new Map;hoveredSubject;details;updateEditorStyles(){const e=this.editor.getOption(Y.lineHeight),{style:o}=this.editor.getContainerDomNode();o.setProperty("--vscode-testing-coverage-lineHeight",`${e}px`)}hoverInlineDecoration(e,o){const t=e.getDecorationsInRange(k.fromPositions(o)),i=be(t,({id:s})=>this.decorationIds.has(s)?{id:s,deco:this.decorationIds.get(s)}:void 0);i!==this.hoveredSubject&&(this.hoveredStore.clear(),this.hoveredSubject=i,i&&(e.changeDecorations(s=>{s.changeDecorationOptions(i.id,{...i.deco.options,className:`${i.deco.options.className} coverage-deco-hovered`})}),this.hoveredStore.add(x(()=>{this.hoveredSubject=void 0,e.changeDecorations(s=>{s.changeDecorationOptions(i.id,i.deco.options)})}))))}hoverLineNumber(e){this.hoveredSubject==="lineNo"||!this.details||this.coverage.showInline.get()||(this.hoveredStore.clear(),this.hoveredSubject="lineNo",e.changeDecorations(o=>{for(const[t,i]of this.decorationIds){const{applyHoverOptions:s,options:r}=i,a={...r};s(a),o.changeDecorationOptions(t,a)}}),this.hoveredStore.add(this.editor.onMouseLeave(()=>{this.hoveredStore.clear()})),this.hoveredStore.add(x(()=>{this.hoveredSubject=void 0,e.changeDecorations(o=>{for(const[t,i]of this.decorationIds)o.changeDecorationOptions(t,i.options)})})))}async apply(e,o,t,i){const s=this.details=await this.loadDetails(o,t,e);if(!s)return this.clear();this.displayedStore.clear(),e.changeDecorations(r=>{for(const a of s.ranges){const{metadata:{detail:l,description:h},range:d,primary:g}=a;if(l.type===T.Branch){const u=l.detail.branches[l.branch].count,m=u?re:se,p=!u&&d.isEmpty()&&l.detail.branches.some(I=>I.count),b={showIfCollapsed:p,description:"coverage-gutter",lineNumberClassName:`coverage-deco-gutter ${m}`},N=I=>{I.hoverMessage=h,p?I.after={content:"\xA0".repeat(ze),inlineClassName:`coverage-deco-branch-miss-indicator ${Ee.asClassName(Ke)}`,inlineClassNameAffectsLetterSpacing:!0,cursorStops:J.None}:(I.className=`coverage-deco-inline ${m}`,g&&typeof u=="number"&&(I.before=ce(u)))};i&&N(b),this.decorationIds.set(r.addDecoration(d,b),{options:b,applyHoverOptions:N,detail:a})}else if(l.type===T.Statement){const u=l.count?re:se,m={showIfCollapsed:!1,description:"coverage-inline",lineNumberClassName:`coverage-deco-gutter ${u}`},p=b=>{b.className=`coverage-deco-inline ${u}`,b.hoverMessage=h,g&&typeof l.count=="number"&&(b.before=ce(l.count))};i&&p(m),this.decorationIds.set(r.addDecoration(d,m),{options:m,applyHoverOptions:p,detail:a})}}}),this.displayedStore.add(x(()=>{e.changeDecorations(r=>{for(const a of this.decorationIds.keys())r.removeDecoration(a);this.decorationIds.clear()})}))}clear(){this.loadingCancellation?.cancel(),this.loadingCancellation=void 0,this.displayedStore.clear(),this.hoveredStore.clear()}async loadDetails(e,o,t){const i=this.loadingCancellation=new z;this.displayedStore.add(this.loadingCancellation);try{const s=o?await e.detailsForTest(o,this.loadingCancellation.token):await e.details(this.loadingCancellation.token);return i.token.isCancellationRequested?void 0:new qe(s,t)}catch(s){this.log.error("Error loading coverage details",s)}}};B=F([f(1,te),f(2,_),f(3,U),f(4,Be)],B);const ce=c=>{if(c!==0)return{content:`${c>99?"99+":c}x`,cursorStops:J.None,inlineClassName:"coverage-deco-inline-count",inlineClassNameAffectsLetterSpacing:!0}};class qe{constructor(n,e){this.details=n;const o=n.map(r=>({range:P(r.location),primary:!0,metadata:{detail:r,description:this.describe(r,e)}}));for(const{range:r,metadata:{detail:a}}of o)if(a.type===T.Statement&&a.branches)for(let l=0;l<a.branches.length;l++){const h={type:T.Branch,branch:l,detail:a};o.push({range:P(a.branches[l].location||k.fromPositions(r.getEndPosition())),primary:!0,metadata:{detail:h,description:this.describe(h,e)}})}o.sort((r,a)=>k.compareRangesUsingStarts(r.range,a.range)||r.metadata.detail.type-a.metadata.detail.type);const t=[],i=this.ranges=[],s=()=>{const r=t.pop(),a=t[t.length-1];a&&(a.range=a.range.setStartPosition(r.range.endLineNumber,r.range.endColumn)),i.push(r)};for(const r of o){const a=r.range.getStartPosition();for(;t[t.length-1]?.range.containsPosition(a)===!1;)s();if(r.range.isEmpty()){i.push(r);continue}const l=t[t.length-1];if(l){const h=l.primary,d=l.range.setEndPosition(a.lineNumber,a.column);l.range=l.range.setStartPosition(r.range.endLineNumber,r.range.endColumn),l.primary=!1,l.range.isEmpty()&&t.pop(),i.push({range:d,primary:h,metadata:l.metadata})}t.push(r)}for(;t.length;)s()}ranges=[];describe(n,e){if(n.type===T.Declaration)return de(n.name,n);if(n.type===T.Statement){const o=ge(e.getValueInRange(P(n.location)).trim()||"<empty statement>");if(n.branches?.length){const t=n.branches.filter(i=>!!i.count).length;return new w().appendMarkdown(v("coverage.branches","{0} of {1} of branches in {2} were covered.",t,n.branches.length,o))}else return de(o,n)}else if(n.type===T.Branch){const o=ge(e.getValueInRange(P(n.detail.location)).trim()||"<empty statement>"),{count:t,label:i}=n.detail.branches[n.branch],s=i?le(i):`#${n.branch+1}`;return t?t===!0?new w().appendMarkdown(v("coverage.branchCoveredYes","Branch {0} in {1} was executed.",s,o)):new w().appendMarkdown(v("coverage.branchCovered","Branch {0} in {1} was executed {2} time(s).",s,o,t)):new w().appendMarkdown(v("coverage.branchNotCovered","Branch {0} in {1} was not covered.",s,o))}ye(n)}}function de(c,n){return new w().appendMarkdown(n.count?typeof n.count=="number"?v("coverage.declExecutedCount","`{0}` was executed {1} time(s).",c,n.count):v("coverage.declExecutedYes","`{0}` was executed.",c):v("coverage.declExecutedNo","`{0}` was not executed.",c))}function P(c){return c instanceof j?k.fromPositions(c,new j(c.lineNumber,2147483647)):c}function le(c){return"`"+c.replace(/[\n\r`]/g,"")+"`"}function ge(c){return c.length>50&&(c=c.slice(0,40)+"..."),le(c)}let M=class extends G{constructor(e,o,t,i,s,r,a,l){super();this.editor=e;this.configurationService=o;this.contextMenuService=t;this.testService=i;this.keybindingService=s;this.commandService=r;this.coverage=a;this.bars=this._register(l.createInstance(Ve,{compact:!1,overall:!1,container:this._domNode.bars})),this.actionBar=this._register(l.createInstance(ve,this._domNode.toolbar,{orientation:fe.HORIZONTAL,actionViewItemProvider:(h,d)=>{const g=new Ze(void 0,h,d);return h instanceof E&&(g.themeIcon=h.icon),g}})),this._register(O(h=>{a.showInline.read(h),this.setActions()})),this._register(y.addStandardDisposableListener(this._domNode.root,y.EventType.CONTEXT_MENU,h=>{this.contextMenuService.showContextMenu({menuId:S.StickyScrollContext,getAnchor:()=>h})}))}current;registered=!1;isRunning=!1;showStore=this._register(new H);actionBar;_domNode=y.h("div.coverage-summary-widget",[y.h("div",[y.h("span.bars@bars"),y.h("span.toolbar@toolbar")])]);bars;getId(){return"coverage-summary-widget"}getDomNode(){return this._domNode.root}getPosition(){return{preference:Oe.TOP_CENTER,stackOridinal:9}}clearCoverage(){this.current=void 0,this.bars.setCoverageInfo(void 0),this.hide()}setCoverage(e,o){this.current={coverage:e,testId:o},this.bars.setCoverageInfo(e),e?(this.setActions(),this.show()):this.hide()}setActions(){this.actionBar.clear();const e=this.current;if(!e)return;const o=new E("toggleInline",this.coverage.showInline.get()?v("testing.hideInlineCoverage","Hide Inline Coverage"):v("testing.showInlineCoverage","Show Inline Coverage"),ie,void 0,()=>this.coverage.showInline.set(!this.coverage.showInline.get(),void 0)),t=this.keybindingService.lookupKeybinding(ae);if(t&&(o.tooltip=`${Ue} (${t.getLabel()})`),this.actionBar.push(o),e.testId){const i=e.coverage.fromResult.getTestById(e.testId.toString());Te(!!i,"got coverage for an unreported test"),this.actionBar.push(new E("perTestFilter",L.labels.showingFilterFor(i.label),ne,void 0,()=>this.commandService.executeCommand(A.CoverageFilterToTestInEditor,this.current,this.editor)))}else e.coverage.perTestData?.size&&this.actionBar.push(new E("perTestFilter",v("testing.coverageForTestAvailable","{0} test(s) ran code in this file",e.coverage.perTestData.size),ne,void 0,()=>this.commandService.executeCommand(A.CoverageFilterToTestInEditor,this.current,this.editor)));this.actionBar.push(new E("rerun",v("testing.rerun","Rerun"),$e,!this.isRunning,()=>this.rerunTest()))}show(){if(this.registered)return;this.registered=!0;let e;const o=this.showStore;this.editor.addOverlayWidget(this),this.editor.changeViewZones(t=>{e=t.addZone({afterLineNumber:0,afterColumn:0,domNode:document.createElement("div"),heightInPx:30,ordinal:-1})}),o.add(x(()=>{this.registered=!1,this.editor.removeOverlayWidget(this),this.editor.changeViewZones(t=>{t.removeZone(e)})})),o.add(this.configurationService.onDidChangeConfiguration(t=>{this.current&&(t.affectsConfiguration(D.CoverageBarThresholds)||t.affectsConfiguration(D.CoveragePercent))&&this.setCoverage(this.current.coverage,this.current.testId)}))}rerunTest(){const e=this.current;e&&(this.isRunning=!0,this.setActions(),this.testService.runResolvedTests(e.coverage.fromResult.request).finally(()=>{this.isRunning=!1,this.setActions()}))}hide(){this.showStore.clear()}};M=F([f(1,U),f(2,Ae),f(3,je),f(4,_e),f(5,Re),f(6,_),f(7,te)],M),V(class extends ${constructor(){super({id:ae,title:R("coverage.toggleInline","Toggle Inline Coverage"),category:K.Test,keybinding:{weight:Le.WorkbenchContrib,primary:Se(W.CtrlCmd|Z.Semicolon,W.CtrlCmd|W.Shift|Z.KeyI)},toggled:{condition:C.inlineCoverageEnabled,title:v("coverage.hideInline","Hide Inline Coverage")},icon:ie,menu:[{id:S.CommandPalette,when:C.isTestCoverageOpen},{id:S.EditorTitle,when:ee.and(C.isTestCoverageOpen,C.coverageToolbarEnabled.notEqualsTo(!0)),group:"navigation"}]})}run(n){const e=n.get(_);e.showInline.set(!e.showInline.get(),void 0)}}),V(class extends ${constructor(){super({id:A.CoverageToggleToolbar,title:R("testing.toggleToolbarTitle","Test Coverage Toolbar"),metadata:{description:R("testing.toggleToolbarDesc","Toggle the sticky coverage bar in the editor.")},category:K.Test,toggled:{condition:C.coverageToolbarEnabled},menu:[{id:S.CommandPalette,when:C.isTestCoverageOpen},{id:S.StickyScrollContext,when:C.isTestCoverageOpen},{id:S.EditorTitle,when:C.isTestCoverageOpen,group:"coverage@1"}]})}run(n){const e=n.get(U),o=We(e,D.CoverageToolbarEnabled);e.updateValue(D.CoverageToolbarEnabled,!o)}}),V(class extends ${constructor(){super({id:A.CoverageFilterToTestInEditor,title:R("testing.filterActionLabel","Filter Coverage to Test"),category:K.Test,icon:q.filter,toggled:{icon:q.filterFilled,condition:C.isCoverageFilteredToTest},menu:[{id:S.EditorTitle,when:ee.and(C.isTestCoverageOpen,C.coverageToolbarEnabled.notEqualsTo(!0)),group:"navigation"}]})}run(n,e,o){const t=n.get(_),i=n.get(Fe),s=o??n.get(ke).getActiveCodeEditor();let r;if(e instanceof He)r=e;else if(xe(e))r=t.selected.get()?.getUri(Ne.from(e));else{const p=s?.getModel()?.uri;r=p&&t.selected.get()?.getUri(p)}if(!r||!r.perTestData?.size)return;const a=[...r.perTestData].map(oe.fromString),l=oe.getLengthOfCommonPrefix(a.length,p=>a[p]),h=r.fromResult,d=t.filterToTest.get(),g=[{label:L.labels.allTests,testId:void 0},{type:"separator"},...a.map(p=>({label:L.getLabelForItem(h,p,l),testId:p}))],u=s?.getScrollTop()||0,m=new De;i.pick(g,{activeItem:g.find(p=>"item"in p&&p.item===r),placeHolder:L.labels.pickShowCoverage,onDidFocus:p=>{if(p.testId){const b=m.value=new z;r.detailsForTest(p.testId,b.token).then(N=>{const I=N.find(pe=>pe.type===T.Statement);!b.token.isCancellationRequested&&I&&s?.revealLineNearTop(I.location instanceof j?I.location.lineNumber:I.location.startLineNumber)},()=>{}),t.filterToTest.set(p.testId,void 0)}else m.clear(),s?.setScrollTop(u),t.filterToTest.set(void 0,void 0)}}).then(p=>{p||s?.setScrollTop(u),m.dispose(),t.filterToTest.set(p?p.testId:d,void 0)})}});class E extends Ce{constructor(e,o,t,i,s){super(e,o,void 0,i,s);this.icon=t}}class Ze extends me{themeIcon;updateLabel(){this.options.label&&this.label&&this.themeIcon&&y.reset(this.label,Ie(this.themeIcon),this.action.label)}}export{B as CodeCoverageDecorations,qe as CoverageDetailsModel};
