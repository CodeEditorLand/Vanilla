var me=Object.defineProperty;var fe=Object.getOwnPropertyDescriptor;var x=(f,t,e,n)=>{for(var r=n>1?void 0:n?fe(t,e):t,s=f.length-1,a;s>=0;s--)(a=f[s])&&(r=(n?a(t,e,r):a(r))||r);return n&&r&&me(t,e,r),r},g=(f,t)=>(e,n)=>t(e,n,f);import*as R from"../../../../base/browser/dom.js";import{StandardKeyboardEvent as X}from"../../../../base/browser/keyboardEvent.js";import{Action as E,Separator as Y,SubmenuAction as he}from"../../../../base/common/actions.js";import{equals as Ie}from"../../../../base/common/arrays.js";import{RunOnceScheduler as ve}from"../../../../base/common/async.js";import{Emitter as be,Event as W}from"../../../../base/common/event.js";import{MarkdownString as _}from"../../../../base/common/htmlContent.js";import{stripIcons as ye}from"../../../../base/common/iconLabels.js";import{Iterable as Ce}from"../../../../base/common/iterator.js";import{KeyCode as G}from"../../../../base/common/keyCodes.js";import{Disposable as J,DisposableStore as ee,MutableDisposable as te}from"../../../../base/common/lifecycle.js";import{ResourceMap as Se}from"../../../../base/common/map.js";import{isMacintosh as Te}from"../../../../base/common/platform.js";import{ThemeIcon as ie}from"../../../../base/common/themables.js";import{Constants as Me}from"../../../../base/common/uint.js";import"../../../../base/common/uri.js";import{generateUuid as ne}from"../../../../base/common/uuid.js";import{ContentWidgetPositionPreference as De,MouseTargetType as xe}from"../../../../editor/browser/editorBrowser.js";import{ICodeEditorService as k}from"../../../../editor/browser/services/codeEditorService.js";import{EditorOption as S}from"../../../../editor/common/config/editorOptions.js";import{overviewRulerError as we,overviewRulerInfo as Ee}from"../../../../editor/common/core/editorColorRegistry.js";import"../../../../editor/common/core/range.js";import"../../../../editor/common/editorCommon.js";import{GlyphMarginLane as ke,OverviewRulerLane as Ae,TrackedRangeStickiness as oe}from"../../../../editor/common/model.js";import{IModelService as Re}from"../../../../editor/common/services/model.js";import{localize as h}from"../../../../nls.js";import{createAndFillInContextMenuActions as Le}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{IMenuService as B,MenuId as Ue}from"../../../../platform/actions/common/actions.js";import{ICommandService as $}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as O}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as K}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as z}from"../../../../platform/contextview/browser/contextView.js";import{IInstantiationService as Ne}from"../../../../platform/instantiation/common/instantiation.js";import{IQuickInputService as Fe}from"../../../../platform/quickinput/common/quickInput.js";import{themeColorFromId as _e}from"../../../../platform/theme/common/themeService.js";import{IUriIdentityService as Oe}from"../../../../platform/uriIdentity/common/uriIdentity.js";import{EditorLineNumberContextMenu as Pe,GutterActionsRegistry as We}from"../../codeEditor/browser/editorLineNumberMenu.js";import{DefaultGutterClickAction as T,getTestingConfiguration as A,TestingConfigKeys as w}from"../common/configuration.js";import{labelForTestInState as Ge,Testing as Be}from"../common/constants.js";import{TestId as $e}from"../common/testId.js";import{ITestingDecorationsService as Ke,TestDecorations as ze}from"../common/testingDecorations.js";import{ITestingPeekOpener as Ve}from"../common/testingPeekOpener.js";import{isFailedState as je,maxPriority as Ze}from"../common/testingStates.js";import{buildTestUri as He,parseTestUri as Qe,TestUriType as V}from"../common/testingUri.js";import{ITestProfileService as j}from"../common/testProfileService.js";import{LiveTestResult as qe}from"../common/testResult.js";import{ITestResultService as Xe}from"../common/testResultService.js";import{getContextForTestItem as Ye,ITestService as L,simplifyTestsToExecute as Je,testsInFile as et}from"../common/testService.js";import{TestDiffOpType as tt,TestMessageType as Z,TestResultState as H,TestRunProfileBitset as y}from"../common/testTypes.js";import{getTestItemContextOverlay as it}from"./explorerProjections/testItemContextOverlay.js";import{testingDebugAllIcon as nt,testingDebugIcon as ot,testingRunAllIcon as re,testingRunIcon as se,testingStatesToIcons as rt}from"./icons.js";import{renderTestMessageAsText as st}from"./testMessageColorizer.js";const ae=128,ce=30,le=ke.Center;function at(f,t){const e=f.listDiffEditors();for(const n of e)if(n.getOriginalEditor()===t)return!0;return!1}class Q{runByIdKey=new Map;messages=new Map;get size(){return this.runByIdKey.size+this.messages.size}getForExactTests(t){const e=t.sort().join("\0\0");return this.runByIdKey.get(e)}getMessage(t){return this.messages.get(t)}removeMessage(t){this.messages.delete(t)}addMessage(t){this.messages.set(t.testMessage,t)}addTest(t){const e=t.testIds.sort().join("\0\0");this.runByIdKey.set(e,t)}getById(t){for(const e of this.runByIdKey.values())if(e.id===t)return e;for(const e of this.messages.values())if(e.id===t)return e}*[Symbol.iterator](){for(const t of this.runByIdKey.values())yield t;for(const t of this.messages.values())yield t}}let P=class extends J{constructor(e,n,r,s,a,c){super();this.configurationService=n;this.testService=r;this.results=s;this.instantiationService=a;this.modelService=c;e.registerDecorationType("test-message-decoration",C.decorationId,{},void 0),this._register(c.onModelRemoved(i=>this.decorationCache.delete(i.uri)));const d=this._register(new ve(()=>this.invalidate(),100));this._register(this.testService.onWillProcessDiff(i=>{for(const o of i){if(o.op!==tt.DocumentSynced)continue;const u=this.decorationCache.get(o.uri);u&&(u.rangeUpdateVersionId=o.docv)}d.isScheduled()||d.schedule()})),this._register(W.any(this.results.onResultsChanged,this.results.onTestChanged,this.testService.excluded.onTestExclusionsChanged,this.testService.showInlineOutput.onDidChange,W.filter(n.onDidChangeConfiguration,i=>i.affectsConfiguration(w.GutterEnabled)))(()=>{d.isScheduled()||d.schedule()})),this._register(We.registerGutterActionsGenerator((i,o)=>{const u=i.editor.getModel(),l=U.get(i.editor);if(!u||!l?.currentUri)return;const m=this.syncDecorations(l.currentUri);if(!m.size)return;const p=u.getLinesDecorations(i.lineNumber,i.lineNumber);for(const{id:I}of p){const v=m.getById(I);if(v){const{object:b}=v.getContextMenuActions();for(const D of b)o.push(D,"1_testing")}}}))}generation=0;changeEmitter=new be;decorationCache=new Se;invalidatedMessages=new WeakSet;onDidChange=this.changeEmitter.event;invalidateResultMessage(e){this.invalidatedMessages.add(e),this.invalidate()}syncDecorations(e){const n=this.modelService.getModel(e);if(!n)return new Q;const r=this.decorationCache.get(e);return r&&r.generation===this.generation&&(r.rangeUpdateVersionId===void 0||r.rangeUpdateVersionId!==n.getVersionId())?r.value:this.applyDecorations(n)}getDecoratedTestPosition(e,n){const r=this.modelService.getModel(e);if(!r)return;const s=Ce.find(this.syncDecorations(e),a=>a instanceof M&&a.isForTest(n));if(s)return r.getDecorationRange(s.id)?.getStartPosition()}invalidate(){this.generation++,this.changeEmitter.fire()}updateDecorationsAlternateAction(e,n){const r=this.modelService.getModel(e),s=this.decorationCache.get(e);!r||!s||s.isAlt===n||(s.isAlt=n,r.changeDecorations(a=>{for(const c of s.value)c instanceof M&&c.editorDecoration.alternate&&a.changeDecorationOptions(c.id,n?c.editorDecoration.alternate:c.editorDecoration.options)}))}applyDecorations(e){const n=A(this.configurationService,w.GutterEnabled),r=e.uri.toString(),s=this.decorationCache.get(e.uri),a=s?.rangeUpdateVersionId===e.getVersionId(),c=s?.value??new Q;return e.changeDecorations(i=>{const o=new Q,u=new ze;for(const p of this.testService.collection.getNodeByUrl(e.uri)){if(!p.item.range)continue;const I=this.results.getStateById(p.item.extId),v=p.item.range.startLineNumber;u.push({line:v,id:"",test:p,resultItem:I?.[1]})}for(const[p,I]of u.lines()){const v=I.length>1;let b=c.getForExactTests(I.map(D=>D.test.item.extId));b&&a&&e.getDecorationRange(b.id)?.startLineNumber!==p&&(b=void 0),b?(b.replaceOptions(I,n)&&i.changeDecorationOptions(b.id,b.editorDecoration.options),o.addTest(b)):o.addTest(v?this.instantiationService.createInstance(N,I,n,e):this.instantiationService.createInstance(F,I[0].test,I[0].resultItem,e,n))}const l=new Set;A(this.configurationService,w.ShowAllMessages)?this.results.results.forEach(p=>this.applyDecorationsFromResult(p,l,r,c,e,o)):this.applyDecorationsFromResult(this.results.results[0],l,r,c,e,o);const m=new Set;for(const p of o)p.id===""?p.id=i.addDecoration(p.editorDecoration.range,p.editorDecoration.options):m.add(p.id);for(const p of c)m.has(p.id)||i.removeDecoration(p.id);return this.decorationCache.set(e.uri,{generation:this.generation,rangeUpdateVersionId:s?.rangeUpdateVersionId,value:o}),o})||c}applyDecorationsFromResult(e,n,r,s,a,c){if(this.testService.showInlineOutput.value&&e instanceof qe){for(const d of e.tasks)for(const i of d.otherMessages)if(!this.invalidatedMessages.has(i)&&i.location?.uri.toString()===r){const o=s.getMessage(i)||this.instantiationService.createInstance(C,i,void 0,a);c.addMessage(o)}for(const d of e.tests)for(let i=0;i<d.tasks.length;i++){const o=d.tasks[i];for(const u of[Z.Error,Z.Output])for(let l=0;l<o.messages.length;l++){const m=o.messages[l];if(m.type!==u||this.invalidatedMessages.has(m)||m.location?.uri.toString()!==r)continue;const p=m.location.range.startLineNumber;if(!n.has(p)){const I=s.getMessage(m)||this.instantiationService.createInstance(C,m,He({type:V.ResultActualOutput,messageIndex:l,taskIndex:i,resultId:e.id,testExtId:d.item.extId}),a);c.addMessage(I),n.add(p)}}}}}};P=x([g(0,k),g(1,O),g(2,L),g(3,Xe),g(4,Ne),g(5,Re)],P);let U=class extends J{constructor(e,n,r,s,a){super();this.editor=e;this.codeEditorService=n;this.testService=r;this.decorations=s;this.uriIdentityService=a;n.registerDecorationType("test-message-decoration",C.decorationId,{},void 0,e),this.attachModel(e.getModel()?.uri),this._register(s.onDidChange(()=>{this._currentUri&&s.syncDecorations(this._currentUri)}));const c=R.getWindow(e.getDomNode());this._register(R.addDisposableListener(c,"keydown",i=>{new X(i).keyCode===G.Alt&&this._currentUri&&s.updateDecorationsAlternateAction(this._currentUri,!0)})),this._register(R.addDisposableListener(c,"keyup",i=>{new X(i).keyCode===G.Alt&&this._currentUri&&s.updateDecorationsAlternateAction(this._currentUri,!1)})),this._register(R.addDisposableListener(c,"blur",()=>{this._currentUri&&s.updateDecorationsAlternateAction(this._currentUri,!1)})),this._register(this.editor.onKeyUp(i=>{i.keyCode===G.Alt&&this._currentUri&&s.updateDecorationsAlternateAction(this._currentUri,!1)})),this._register(this.editor.onDidChangeModel(i=>this.attachModel(i.newModelUrl||void 0))),this._register(this.editor.onMouseDown(i=>{if(i.target.position&&this.currentUri){const o=e.getModel()?.getLineDecorations(i.target.position.lineNumber)??[];if(!o.length)return;const u=s.syncDecorations(this.currentUri);for(const{id:l}of o)if(u.getById(l)?.click(i)){i.event.stopPropagation();return}}})),this._register(W.accumulate(this.editor.onDidChangeModelContent,0,this._store)(i=>{const o=e.getModel();if(!this._currentUri||!o)return;const u=s.syncDecorations(this._currentUri);if(u.size)for(const l of i)for(const m of l.changes){const p=o.getLinesDecorations(m.range.startLineNumber,m.range.endLineNumber);for(const{id:I}of p){const v=u.getById(I);v instanceof C&&s.invalidateResultMessage(v.testMessage)}}}));const d=()=>{this.editor.getContainerDomNode().style.setProperty("--testMessageDecorationFontFamily",e.getOption(S.fontFamily)),this.editor.getContainerDomNode().style.setProperty("--testMessageDecorationFontSize",`${e.getOption(S.fontSize)}px`)};this._register(this.editor.onDidChangeConfiguration(i=>{i.hasChanged(S.fontFamily)&&d()})),d()}static get(e){return e.getContribution(Be.DecorationsContributionId)}get currentUri(){return this._currentUri}_currentUri;expectedWidget=new te;actualWidget=new te;attachModel(e){switch(e&&Qe(e)?.type){case V.ResultExpectedOutput:this.expectedWidget.value=new lt(this.editor),this.actualWidget.clear();break;case V.ResultActualOutput:this.expectedWidget.clear(),this.actualWidget.value=new dt(this.editor);break;default:this.expectedWidget.clear(),this.actualWidget.clear()}at(this.codeEditorService,this.editor)&&(e=void 0),this._currentUri=e,e&&(this.decorations.syncDecorations(e),(async()=>{for await(const n of et(this.testService,this.uriIdentityService,e,!1))if(this._currentUri!==e)break})())}};U=x([g(1,k),g(2,L),g(3,Ke),g(4,Oe)],U);const de=f=>({startLineNumber:f.startLineNumber,endLineNumber:f.startLineNumber,startColumn:f.startColumn,endColumn:f.startColumn}),ue=(f,t,e,n)=>{const r=f[0]?.item.range;if(!r)throw new Error("Test decorations can only be created for tests with a range");if(!e)return{range:de(r),options:{isWholeLine:!0,description:"run-test-decoration"}};let s=H.Unset;const a=[];let c,d=!1;for(let v=0;v<f.length;v++){const b=f[v],D=t[v],q=D?.computedState??H.Unset;a.length<10&&a.push(Ge(b.item.label,q)),s=Ze(s,q),d=d||!!D?.retired,!c&&D?.tasks.some(pe=>pe.messages.length)&&(c=b.item.extId)}const i=f.length>1||f[0].children.size>0,o=s===H.Unset?i?re:se:rt.get(s),u=n===T.Debug?i?re:se:i?nt:ot;let l,m="testing-run-glyph";d&&(m+=" retired");const p={description:"run-test-decoration",showIfCollapsed:!0,get hoverMessage(){if(!l){const v=l=new _("",!0).appendText(a.join(", ")+".");if(c){const b=encodeURIComponent(JSON.stringify([c]));v.appendMarkdown(` [${h("peekTestOutout","Peek Test Output")}](command:vscode.peekTestError?${b})`)}}return l},glyphMargin:{position:le},glyphMarginClassName:`${ie.asClassName(o)} ${m}`,stickiness:oe.NeverGrowsWhenTypingAtEdges,zIndex:1e4},I={...p,glyphMarginClassName:`${ie.asClassName(u)} ${m}`};return{range:de(r),options:p,alternate:I}};var ct=(e=>(e.FontFamily="testingDiffLensFontFamily",e.FontFeatures="testingDiffLensFontFeatures",e))(ct||{});class ge{constructor(t){this.editor=t;queueMicrotask(()=>{this.applyStyling(),this.editor.addContentWidget(this)})}allowEditorOverflow=!1;suppressMouseDown=!0;_domNode=R.$("span");viewZoneId;applyStyling(){let t=this.editor.getOption(S.codeLensFontSize),e;!t||t<5?(t=this.editor.getOption(S.fontSize)*.9|0,e=this.editor.getOption(S.lineHeight)):e=t*Math.max(1.3,this.editor.getOption(S.lineHeight)/this.editor.getOption(S.fontSize))|0;const n=this.editor.getOption(S.fontInfo),r=this._domNode;r.classList.add("testing-diff-lens-widget"),r.textContent=this.getText(),r.style.lineHeight=`${e}px`,r.style.fontSize=`${t}px`,r.style.fontFamily="var(--testingDiffLensFontFamily)",r.style.fontFeatureSettings="var(--testingDiffLensFontFeatures)";const s=this.editor.getContainerDomNode().style;s.setProperty("testingDiffLensFontFamily",this.editor.getOption(S.codeLensFontFamily)??"inherit"),s.setProperty("testingDiffLensFontFeatures",n.fontFeatureSettings),this.editor.changeViewZones(a=>{this.viewZoneId&&a.removeZone(this.viewZoneId),this.viewZoneId=a.addZone({afterLineNumber:0,afterColumn:Me.MAX_SAFE_SMALL_INTEGER,domNode:document.createElement("div"),heightInPx:20})})}getDomNode(){return this._domNode}dispose(){this.editor.changeViewZones(t=>{this.viewZoneId&&t.removeZone(this.viewZoneId)}),this.editor.removeContentWidget(this)}getPosition(){return{position:{column:0,lineNumber:0},preference:[De.ABOVE]}}}class lt extends ge{getId(){return"expectedTestingLens"}getText(){return h("expected.title","Expected")}}class dt extends ge{getId(){return"actualTestingLens"}getText(){return h("actual.title","Actual")}}let M=class{constructor(t,e,n,r,s,a,c,d,i,o,u){this.tests=t;this.visible=e;this.model=n;this.codeEditorService=r;this.testService=s;this.contextMenuService=a;this.commandService=c;this.configurationService=d;this.testProfileService=i;this.contextKeyService=o;this.menuService=u;this.displayedStates=t.map(l=>l.resultItem?.computedState),this.editorDecoration=ue(t.map(l=>l.test),t.map(l=>l.resultItem),e,A(this.configurationService,w.DefaultGutterClickAction)),this.editorDecoration.options.glyphMarginHoverMessage=new _().appendText(this.getGutterLabel())}id="";get line(){return this.editorDecoration.range.startLineNumber}get testIds(){return this.tests.map(t=>t.test.item.extId)}editorDecoration;displayedStates;click(t){if(t.target.type!==xe.GUTTER_GLYPH_MARGIN||t.target.detail.glyphMarginLane!==le||t.event.rightButton||Te&&t.event.leftButton&&t.event.ctrlKey)return!1;const e=t.event.altKey;switch(A(this.configurationService,w.DefaultGutterClickAction)){case T.ContextMenu:this.showContextMenu(t);break;case T.Debug:this.runWith(e?y.Run:y.Debug);break;case T.Coverage:this.runWith(e?y.Debug:y.Coverage);break;case T.Run:default:this.runWith(e?y.Debug:y.Run);break}return!0}replaceOptions(t,e){const n=t.map(a=>a.resultItem?.computedState);if(e===this.visible&&Ie(this.displayedStates,n))return!1;this.tests=t,this.displayedStates=n,this.visible=e;const{options:r,alternate:s}=ue(t.map(a=>a.test),t.map(a=>a.resultItem),e,A(this.configurationService,w.DefaultGutterClickAction));return this.editorDecoration.options=r,this.editorDecoration.alternate=s,this.editorDecoration.options.glyphMarginHoverMessage=new _().appendText(this.getGutterLabel()),!0}isForTest(t){return this.tests.some(e=>e.test.item.extId===t)}runWith(t){return this.testService.runTests({tests:Je(this.testService.collection,this.tests.map(({test:e})=>e)),group:t})}showContextMenu(t){this.codeEditorService.listCodeEditors().find(n=>n.getModel()===this.model)?.getContribution(Pe.ID)?.show(t)}getGutterLabel(){switch(A(this.configurationService,w.DefaultGutterClickAction)){case T.ContextMenu:return h("testing.gutterMsg.contextMenu","Click for test options");case T.Debug:return h("testing.gutterMsg.debug","Click to debug tests, right click for more options");case T.Coverage:return h("testing.gutterMsg.coverage","Click to run tests with coverage, right click for more options");case T.Run:default:return h("testing.gutterMsg.run","Click to run tests, right click for more options")}}getTestContextMenuActions(t,e){const n=[],r=this.testProfileService.capabilitiesForTest(t.item);[{bitset:y.Run,label:h("run test","Run Test")},{bitset:y.Debug,label:h("debug test","Debug Test")},{bitset:y.Coverage,label:h("coverage test","Run with Coverage")}].forEach(({bitset:a,label:c})=>{r&a&&n.push(new E(`testing.gutter.${a}`,c,void 0,void 0,()=>this.testService.runTests({group:a,tests:[t]})))}),r&y.HasNonDefaultProfile&&n.push(new E("testing.runUsing",h("testing.runUsing","Execute Using Profile..."),void 0,void 0,async()=>{const a=await this.commandService.executeCommand("vscode.pickTestProfile",{onlyForTest:t});a&&this.testService.runResolvedTests({group:a.group,targets:[{profileId:a.profileId,controllerId:a.controllerId,testIds:[t.item.extId]}]})})),e&&je(e.computedState)&&n.push(new E("testing.gutter.peekFailure",h("peek failure","Peek Error"),void 0,void 0,()=>this.commandService.executeCommand("vscode.peekTestError",t.item.extId))),n.push(new E("testing.gutter.reveal",h("reveal test","Reveal in Test Explorer"),void 0,void 0,()=>this.commandService.executeCommand("_revealTestInExplorer",t.item.extId)));const s=this.getContributedTestActions(t,r);return{object:Y.join(n,s),dispose(){}}}getContributedTestActions(t,e){const n=this.contextKeyService.createOverlay(it(t,e)),r=[],s=Ye(this.testService.collection,t.item.extId),a=this.menuService.getMenuActions(Ue.TestItemGutter,n,{shouldForwardArgs:!0,arg:s});return Le(a,r),r}};M=x([g(3,k),g(4,L),g(5,z),g(6,$),g(7,O),g(8,j),g(9,K),g(10,B)],M);let N=class extends M{constructor(e,n,r,s,a,c,d,i,o,u,l,m){super(e,n,r,s,a,c,d,i,o,u,l);this.quickInputService=m}getContextMenuActions(){const e=[];[{bitset:y.Run,label:h("run all test","Run All Tests")},{bitset:y.Coverage,label:h("run all test with coverage","Run All Tests with Coverage")},{bitset:y.Debug,label:h("debug all test","Debug All Tests")}].forEach(({bitset:o,label:u},l)=>{this.tests.some(({test:p})=>this.testProfileService.capabilitiesForTest(p.item)&o)&&e.push(new E(`testing.gutter.run${l}`,u,void 0,void 0,()=>this.runWith(o)))});const n=this.tests.map(o=>({currentLabel:o.test.item.label,testItem:o,parent:$e.fromString(o.test.item.extId).parentId})),r=o=>{const u=new Map;for(const l of o)u.set(l.currentLabel,(u.get(l.currentLabel)||0)+1);return o.filter(l=>u.get(l.currentLabel)>1)};let s,a=!0;for(;(s=r(n)).length&&a;)for(const o of s)if(o.parent){const u=this.testService.collection.getNodeById(o.parent.toString());o.currentLabel=u?.item.label+" > "+o.currentLabel,o.parent=o.parent.parentId}else a=!1;n.sort((o,u)=>{const l=o.testItem.test.item,m=u.testItem.test.item;return(l.sortText||l.label).localeCompare(m.sortText||m.label)});const c=new ee;let d=n.map(({currentLabel:o,testItem:u})=>{const l=this.getTestContextMenuActions(u.test,u.resultItem);c.add(l);let m=ye(o);const p=m.indexOf(`
`);return p!==-1&&(m=m.slice(0,p)),new he(u.test.item.extId,m,l.object)});const i=d.length-ce;return i>0&&(d=d.slice(0,ce),d.push(new E("testing.gutter.overflow",h("testOverflowItems","{0} more tests...",i),void 0,void 0,()=>this.pickAndRun(n)))),{object:Y.join(e,d),dispose:()=>c.dispose()}}async pickAndRun(e){const n=(a,c)=>new Promise(d=>{const i=new ee,o=i.add(this.quickInputService.createQuickPick());o.placeholder=c,o.items=a,i.add(o.onDidHide(()=>{d(void 0),i.dispose()})),i.add(o.onDidAccept(()=>{d(o.selectedItems[0]),i.dispose()})),o.show()}),r=await n(e.map(({currentLabel:a,testItem:c})=>({label:a,test:c.test,result:c.resultItem})),h("selectTestToRun","Select a test to run"));if(!r)return;const s=this.getTestContextMenuActions(r.test,r.result);try{(await n(s.object,r.label))?.run()}finally{s.dispose()}}};N=x([g(3,k),g(4,L),g(5,z),g(6,$),g(7,O),g(8,j),g(9,K),g(10,B),g(11,Fe)],N);let F=class extends M{constructor(t,e,n,r,s,a,c,d,i,o,u,l){super([{test:t,resultItem:e}],r,n,s,a,d,c,i,o,u,l)}getContextMenuActions(){return this.getTestContextMenuActions(this.tests[0].test,this.tests[0].resultItem)}};F=x([g(4,k),g(5,L),g(6,$),g(7,z),g(8,O),g(9,j),g(10,K),g(11,B)],F);const ut=/\r?\n\s*/g;let C=class{constructor(t,e,n,r,s){this.testMessage=t;this.messageUri=e;this.peekOpener=r;this.location=t.location,this.line=this.location.range.startLineNumber;const a=t.type,c=t.message,d=s.resolveDecorationOptions(C.decorationId,!0);d.hoverMessage=typeof c=="string"?new _().appendText(c):c,d.zIndex=10,d.className=`testing-inline-message-severity-${a}`,d.isWholeLine=!0,d.stickiness=oe.NeverGrowsWhenTypingAtEdges,d.collapseOnReplaceEdit=!0;let i=st(c).replace(ut," ");i.length>ae&&(i=i.slice(0,ae-1)+"\u2026"),d.after={content:" ".repeat(4)+i,inlineClassName:`test-message-inline-content test-message-inline-content-s${a} ${this.contentIdClass} ${e?"test-message-inline-content-clickable":""}`},d.showIfCollapsed=!0;const o=a===Z.Error?we:Ee;o&&(d.overviewRuler={color:_e(o),position:Ae.Right});const u=n.getLineLength(this.location.range.startLineNumber),l=u?u+1:this.location.range.endColumn;this.editorDecoration={options:d,range:{startLineNumber:this.location.range.startLineNumber,startColumn:l,endColumn:l,endLineNumber:this.location.range.startLineNumber}}}static inlineClassName="test-message-inline-content";static decorationId=`testmessage-${ne()}`;id="";editorDecoration;location;line;contentIdClass=`test-message-inline-content-id${ne()}`;click(t){return t.event.rightButton||!this.messageUri||t.target.element?.className.includes(this.contentIdClass)&&this.peekOpener.peekUri(this.messageUri),!1}getContextMenuActions(){return{object:[],dispose:()=>{}}}};C=x([g(3,Ve),g(4,k)],C);export{P as TestingDecorationService,U as TestingDecorations};
