var N=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var m=(n,s,e,t)=>{for(var i=t>1?void 0:t?A(s,e):s,r=n.length-1,o;r>=0;r--)(o=n[r])&&(i=(t?o(s,e,i):o(i))||i);return t&&i&&N(s,e,i),i},u=(n,s)=>(e,t)=>s(e,t,n);import*as T from"../../../../../../vs/base/browser/dom.js";import{Delayer as B}from"../../../../../../vs/base/common/async.js";import"../../../../../../vs/base/common/buffer.js";import{Event as E}from"../../../../../../vs/base/common/event.js";import{Iterable as F}from"../../../../../../vs/base/common/iterator.js";import{Lazy as z}from"../../../../../../vs/base/common/lazy.js";import{combinedDisposable as H,Disposable as v,MutableDisposable as c,toDisposable as V}from"../../../../../../vs/base/common/lifecycle.js";import"../../../../../../vs/base/common/uri.js";import"../../../../../../vs/editor/browser/editorBrowser.js";import{CodeEditorWidget as U}from"../../../../../../vs/editor/browser/widget/codeEditor/codeEditorWidget.js";import{EmbeddedCodeEditorWidget as G}from"../../../../../../vs/editor/browser/widget/codeEditor/embeddedCodeEditorWidget.js";import{DiffEditorWidget as K}from"../../../../../../vs/editor/browser/widget/diffEditor/diffEditorWidget.js";import{EmbeddedDiffEditorWidget as P}from"../../../../../../vs/editor/browser/widget/diffEditor/embeddedDiffEditorWidget.js";import{MarkdownRenderer as J}from"../../../../../../vs/editor/browser/widget/markdownRenderer/browser/markdownRenderer.js";import"../../../../../../vs/editor/common/config/editorOptions.js";import{ITextModelService as R}from"../../../../../../vs/editor/common/services/resolverService.js";import{peekViewResultsBackground as X}from"../../../../../../vs/editor/contrib/peekView/browser/peekView.js";import{localize as p}from"../../../../../../vs/nls.js";import{IInstantiationService as C}from"../../../../../../vs/platform/instantiation/common/instantiation.js";import{TerminalCapability as M}from"../../../../../../vs/platform/terminal/common/capabilities/capabilities.js";import{TerminalCapabilityStore as $}from"../../../../../../vs/platform/terminal/common/capabilities/terminalCapabilityStore.js";import{formatMessageForTerminal as q}from"../../../../../../vs/platform/terminal/common/terminalStrings.js";import{IWorkspaceContextService as Q}from"../../../../../../vs/platform/workspace/common/workspace.js";import{EditorModel as Y}from"../../../../../../vs/workbench/common/editor/editorModel.js";import{PANEL_BACKGROUND as Z,SIDE_BAR_BACKGROUND as j}from"../../../../../../vs/workbench/common/theme.js";import{IViewDescriptorService as ee,ViewContainerLocation as te}from"../../../../../../vs/workbench/common/views.js";import{DetachedProcessInfo as ie}from"../../../../../../vs/workbench/contrib/terminal/browser/detachedTerminal.js";import{ITerminalService as re}from"../../../../../../vs/workbench/contrib/terminal/browser/terminal.js";import{getXtermScaledDimensions as oe}from"../../../../../../vs/workbench/contrib/terminal/browser/xterm/xtermTerminal.js";import{TERMINAL_BACKGROUND_COLOR as ae}from"../../../../../../vs/workbench/contrib/terminal/common/terminalColorRegistry.js";import{colorizeTestMessageInEditor as ne}from"../../../../../../vs/workbench/contrib/testing/browser/testMessageColorizer.js";import{MessageSubject as f,TaskSubject as se,TestOutputSubject as x}from"../../../../../../vs/workbench/contrib/testing/browser/testResultsView/testResultsSubject.js";import{Testing as le}from"../../../../../../vs/workbench/contrib/testing/common/constants.js";import{MutableObservableValue as L}from"../../../../../../vs/workbench/contrib/testing/common/observableValue.js";import{LiveTestResult as k,TestResultItemChangeReason as de}from"../../../../../../vs/workbench/contrib/testing/common/testResult.js";import{getMarkId as W,ITestMessage as O,TestMessageType as h}from"../../../../../../vs/workbench/contrib/testing/common/testTypes.js";class ue extends Y{constructor(e,t){super();this._original=e;this._modified=t}original=this._original.object.textEditorModel;modified=this._modified.object.textEditorModel;dispose(){super.dispose(),this._original.dispose(),this._modified.dispose()}}const I={scrollBeyondLastLine:!1,links:!0,lineNumbers:"off",glyphMargin:!1,scrollbar:{verticalScrollbarSize:14,horizontal:"auto",useShadows:!1,verticalHasArrows:!1,horizontalHasArrows:!1,alwaysConsumeMouseWheel:!1},overviewRulerLanes:0,fixedOverflowWidgets:!0,readOnly:!0,stickyScroll:{enabled:!1},minimap:{enabled:!1},automaticLayout:!1},w={...I,enableSplitViewResizing:!0,isInEmbeddedEditor:!0,renderOverviewRuler:!1,ignoreTrimWhitespace:!1,renderSideBySide:!0,useInlineViewWhenSpaceIsLimited:!1,originalAriaLabel:p("testingOutputExpected","Expected result"),modifiedAriaLabel:p("testingOutputActual","Actual result"),diffAlgorithm:"advanced"};let y=class extends v{constructor(e,t,i,r){super();this.editor=e;this.container=t;this.instantiationService=i;this.modelService=r}widget=this._register(new c);model=this._register(new c);dimension;get onDidContentSizeChange(){return this.widget.value?.onDidContentSizeChange||E.None}async update(e){if(!(e instanceof f))return this.clear(),!1;const t=e.message;if(!O.isDiffable(t))return this.clear(),!1;const[i,r]=await Promise.all([this.modelService.createModelReference(e.expectedUri),this.modelService.createModelReference(e.actualUri)]),o=this.model.value=new ue(i,r);return this.widget.value||(this.widget.value=this.editor?this.instantiationService.createInstance(P,this.container,w,{},this.editor):this.instantiationService.createInstance(K,this.container,w,{}),this.dimension&&this.widget.value.layout(this.dimension)),this.widget.value.setModel(o),this.widget.value.updateOptions(this.getOptions(_(t.expected)||_(t.actual))),!0}clear(){this.model.clear(),this.widget.clear()}layout(e,t){this.dimension=e;const i=this.widget.value;if(!i)return;if(i.layout(e),!t)return e.height;const r=Math.min(1e4,Math.max(i.getOriginalEditor().getContentHeight(),i.getModifiedEditor().getContentHeight()));return i.layout({height:r,width:e.width}),r}getOptions(e){return e?{...w,lineNumbers:"on"}:{...w,lineNumbers:"off"}}};y=m([u(2,C),u(3,R)],y);let D=class extends v{constructor(e,t){super();this.container=e;this.instantiationService=t;this._register(V(()=>this.clear()))}markdown=new z(()=>this._register(this.instantiationService.createInstance(J,{})));element;async update(e){if(!(e instanceof f))return this.clear(),!1;const t=e.message;if(O.isDiffable(t)||typeof t.message=="string")return this.clear(),!1;const i=this._register(this.markdown.value.render(t.message,{}));return i.element.style.userSelect="text",i.element.classList.add("preview-text"),this.container.appendChild(i.element),this.element=i.element,!0}layout(e){if(this.element)return this.element.style.width=`${e.width-32}px`,this.element.clientHeight}clear(){this.element&&(this.element.remove(),this.element=void 0)}};D=m([u(1,C)],D);let S=class extends v{constructor(e,t,i,r){super();this.editor=e;this.container=t;this.instantiationService=i;this.modelService=r}widgetDecorations=this._register(new c);widget=this._register(new c);model=this._register(new c);dimension;get onDidContentSizeChange(){return this.widget.value?.onDidContentSizeChange||E.None}async update(e){if(!(e instanceof f))return this.clear(),!1;const t=e.message;if(O.isDiffable(t)||t.type===h.Output||typeof t.message!="string")return this.clear(),!1;const i=this.model.value=await this.modelService.createModelReference(e.messageUri);return this.widget.value||(this.widget.value=this.editor?this.instantiationService.createInstance(G,this.container,I,{},this.editor):this.instantiationService.createInstance(U,this.container,I,{isSimpleWidget:!0}),this.dimension&&this.widget.value.layout(this.dimension)),this.widget.value.setModel(i.object.textEditorModel),this.widget.value.updateOptions(I),this.widgetDecorations.value=ne(t.message,this.widget.value),!0}clear(){this.widgetDecorations.clear(),this.widget.clear(),this.model.clear()}layout(e,t){this.dimension=e;const i=this.widget.value;if(!i)return;if(i.layout(e),!t)return e.height;const r=i.getContentHeight();return i.layout({height:r,width:e.width}),r}};S=m([u(2,C),u(3,R)],S);let b=class extends v{constructor(e,t,i,r,o){super();this.container=e;this.isInPeekView=t;this.terminalService=i;this.viewDescriptorService=r;this.workspaceContext=o}dimensions;terminalCwd=this._register(new L(""));xtermLayoutDelayer=this._register(new B(50));terminal=this._register(new c);outputDataListener=this._register(new c);async makeTerminal(){const e=this.terminal.value;if(e)return e.xterm.clearBuffer(),e.xterm.clearSearchDecorations(),e.xterm.write("\x1B[2J\x1B[0;0H"),e;const t=new $,i=this.terminalCwd;return t.add(M.CwdDetection,{type:M.CwdDetection,get cwds(){return[i.value]},onDidChangeCwd:i.onDidChange,getCwd:()=>i.value,updateCwd:()=>{}}),this.terminal.value=await this.terminalService.createDetachedTerminal({rows:10,cols:80,readonly:!0,capabilities:t,processInfo:new ie({initialCwd:i.value}),colorProvider:{getBackgroundColor:r=>{const o=r.getColor(ae);return o||(this.isInPeekView?r.getColor(X):this.viewDescriptorService.getViewLocationById(le.ResultsViewId)===te.Panel?r.getColor(Z):r.getColor(j))}}})}async update(e){if(this.outputDataListener.clear(),e instanceof se)await this.updateForTaskSubject(e);else if(e instanceof x||e instanceof f&&e.message.type===h.Output)await this.updateForTestSubject(e);else return this.clear(),!1;return!0}async updateForTestSubject(e){const t=this,i=e instanceof x?e.test.item:e.test,r=await this.updateGenerically({subject:e,noOutputMessage:p("caseNoOutput","The test case did not report any output."),getTarget:o=>o?.tasks[e.taskIndex].output,*doInitialWrite(o,d){t.updateCwd(i.uri);const l=e instanceof x?e.test:d.getStateById(i.extId);if(l)for(const a of l.tasks[e.taskIndex].messages)a.type===h.Output&&(yield*o.getRangeIter(a.offset,a.length))},doListenForMoreData:(o,d,l)=>d.onChange(a=>{if(a.reason===de.NewMessage&&a.item.item.extId===i.extId&&a.message.type===h.Output)for(const g of o.getRangeIter(a.message.offset,a.message.length))l(g.buffer)})});e instanceof f&&e.message.type===h.Output&&e.message.marker!==void 0&&r?.xterm.selectMarkedRange(W(e.message.marker,!0),W(e.message.marker,!1),!0)}updateForTaskSubject(e){return this.updateGenerically({subject:e,noOutputMessage:p("runNoOutput","The test run did not record any output."),getTarget:t=>t?.tasks[e.taskIndex],doInitialWrite:(t,i)=>(this.updateCwd(F.find(i.tests,r=>!!r.item.uri)?.item.uri),t.output.buffers),doListenForMoreData:(t,i,r)=>t.output.onDidWriteData(o=>r(o.buffer))})}async updateGenerically(e){const t=e.subject.result,i=e.getTarget(t);if(!i)return this.clear();const r=await this.makeTerminal();let o=!1;const d=new L(0);if(t instanceof k)for(const l of e.doInitialWrite(i,t))o||=l.byteLength>0,d.value++,r.xterm.write(l.buffer,()=>d.value--);else o=!0,this.writeNotice(r,p("runNoOutputForPast","Test output is only available for new test runs."));if(this.attachTerminalToDom(r),this.outputDataListener.clear(),t instanceof k&&!t.completedAt){const l=t.onComplete(()=>{o||this.writeNotice(r,e.noOutputMessage)}),a=e.doListenForMoreData(i,t,g=>{r.xterm.write(g),o||=g.byteLength>0});this.outputDataListener.value=H(l,a)}return!this.outputDataListener.value&&!o&&this.writeNotice(r,e.noOutputMessage),d.value>0&&await new Promise(l=>{const a=d.onDidChange(()=>{d.value===0&&(a.dispose(),l())})}),r}updateCwd(e){const t=e&&this.workspaceContext.getWorkspaceFolder(e)||this.workspaceContext.getWorkspace().folders[0];t&&(this.terminalCwd.value=t.uri.fsPath)}writeNotice(e,t){e.xterm.write(q(t))}attachTerminalToDom(e){e.xterm.write("\x1B[?25l"),T.scheduleAtNextAnimationFrame(T.getWindow(this.container),()=>this.layoutTerminal(e)),e.attachToElement(this.container,{enableGpu:!1})}clear(){this.outputDataListener.clear(),this.xtermLayoutDelayer.cancel(),this.terminal.clear()}layout(e){if(this.dimensions=e,this.terminal.value)return this.layoutTerminal(this.terminal.value,e.width,e.height),e.height}layoutTerminal({xterm:e},t=this.dimensions?.width??this.container.clientWidth,i=this.dimensions?.height??this.container.clientHeight){t-=30,this.xtermLayoutDelayer.trigger(()=>{const r=oe(T.getWindow(this.container),e.getFont(),t,i);r&&e.resize(r.cols,r.rows)})}};b=m([u(2,re),u(3,ee),u(4,Q)],b);const _=n=>!!n&&n.includes(`
`);export{y as DiffContentProvider,D as MarkdownTestMessagePeek,S as PlainTextMessagePeek,b as TerminalMessagePeek};
