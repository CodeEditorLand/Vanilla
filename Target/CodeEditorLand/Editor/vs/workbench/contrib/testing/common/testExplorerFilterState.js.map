{
  "version": 3,
  "sources": ["../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/contrib/testing/common/testExplorerFilterState.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nimport { Emitter, type Event } from \"../../../../base/common/event.js\";\nimport { splitGlobAware } from \"../../../../base/common/glob.js\";\nimport { Disposable } from \"../../../../base/common/lifecycle.js\";\nimport { createDecorator } from \"../../../../platform/instantiation/common/instantiation.js\";\nimport {\n\tIStorageService,\n\tStorageScope,\n\tStorageTarget,\n} from \"../../../../platform/storage/common/storage.js\";\nimport {\n\ttype IObservableValue,\n\tMutableObservableValue,\n} from \"./observableValue.js\";\nimport { StoredValue } from \"./storedValue.js\";\nimport { namespaceTestTag } from \"./testTypes.js\";\n\nexport interface ITestExplorerFilterState {\n\t_serviceBrand: undefined;\n\n\t/** Current filter text */\n\treadonly text: IObservableValue<string>;\n\n\t/** Test ID the user wants to reveal in the explorer */\n\treadonly reveal: MutableObservableValue<string | undefined>;\n\n\t/** Event that fires when {@link focusInput} is invoked. */\n\treadonly onDidRequestInputFocus: Event<void>;\n\n\t/**\n\t * Glob list to filter for based on the {@link text}\n\t */\n\treadonly globList: readonly { include: boolean; text: string }[];\n\n\t/**\n\t * The user requested to filter including tags.\n\t */\n\treadonly includeTags: ReadonlySet<string>;\n\n\t/**\n\t * The user requested to filter excluding tags.\n\t */\n\treadonly excludeTags: ReadonlySet<string>;\n\n\t/**\n\t * Whether fuzzy searching is enabled.\n\t */\n\treadonly fuzzy: MutableObservableValue<boolean>;\n\n\t/**\n\t * Focuses the filter input in the test explorer view.\n\t */\n\tfocusInput(): void;\n\n\t/**\n\t * Replaces the filter {@link text}.\n\t */\n\tsetText(text: string): void;\n\n\t/**\n\t * Sets whether the {@link text} is filtering for a special term.\n\t */\n\tisFilteringFor(term: TestFilterTerm): boolean;\n\n\t/**\n\t * Sets whether the {@link text} includes a special filter term.\n\t */\n\ttoggleFilteringFor(term: TestFilterTerm, shouldFilter?: boolean): void;\n}\n\nexport const ITestExplorerFilterState =\n\tcreateDecorator<ITestExplorerFilterState>(\"testingFilterState\");\n\nconst tagRe = /!?@([^ ,:]+)/g;\nconst trimExtraWhitespace = (str: string) => str.replace(/\\s\\s+/g, \" \").trim();\n\nexport class TestExplorerFilterState\n\textends Disposable\n\timplements ITestExplorerFilterState\n{\n\tdeclare _serviceBrand: undefined;\n\tprivate readonly focusEmitter = new Emitter<void>();\n\t/**\n\t * Mapping of terms to whether they're included in the text.\n\t */\n\tprivate termFilterState: { [K in TestFilterTerm]?: true } = {};\n\n\t/** @inheritdoc */\n\tpublic globList: { include: boolean; text: string }[] = [];\n\n\t/** @inheritdoc */\n\tpublic includeTags = new Set<string>();\n\n\t/** @inheritdoc */\n\tpublic excludeTags = new Set<string>();\n\n\t/** @inheritdoc */\n\tpublic readonly text = this._register(new MutableObservableValue(\"\"));\n\n\t/** @inheritdoc */\n\tpublic readonly fuzzy = this._register(\n\t\tMutableObservableValue.stored(\n\t\t\tnew StoredValue<boolean>(\n\t\t\t\t{\n\t\t\t\t\tkey: \"testHistoryFuzzy\",\n\t\t\t\t\tscope: StorageScope.PROFILE,\n\t\t\t\t\ttarget: StorageTarget.USER,\n\t\t\t\t},\n\t\t\t\tthis.storageService,\n\t\t\t),\n\t\t\tfalse,\n\t\t),\n\t);\n\n\tpublic readonly reveal = this._register(\n\t\tnew MutableObservableValue</* test ID */ string | undefined>(undefined),\n\t);\n\n\tpublic readonly onDidRequestInputFocus = this.focusEmitter.event;\n\n\tconstructor(\n\t\t@IStorageService private readonly storageService: IStorageService,\n\t) {\n\t\tsuper();\n\t}\n\n\t/** @inheritdoc */\n\tpublic focusInput() {\n\t\tthis.focusEmitter.fire();\n\t}\n\n\t/** @inheritdoc */\n\tpublic setText(text: string) {\n\t\tif (text === this.text.value) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.termFilterState = {};\n\t\tthis.globList = [];\n\t\tthis.includeTags.clear();\n\t\tthis.excludeTags.clear();\n\n\t\tlet globText = \"\";\n\t\tlet lastIndex = 0;\n\t\tfor (const match of text.matchAll(tagRe)) {\n\t\t\tlet nextIndex = match.index + match[0].length;\n\n\t\t\tconst tag = match[0];\n\t\t\tif (allTestFilterTerms.includes(tag as TestFilterTerm)) {\n\t\t\t\tthis.termFilterState[tag as TestFilterTerm] = true;\n\t\t\t}\n\n\t\t\t// recognize and parse @ctrlId:tagId or quoted like @ctrlId:\"tag \\\\\"id\"\n\t\t\tif (text[nextIndex] === \":\") {\n\t\t\t\tnextIndex++;\n\n\t\t\t\tlet delimiter = text[nextIndex];\n\t\t\t\tif (delimiter !== `\"` && delimiter !== `'`) {\n\t\t\t\t\tdelimiter = \" \";\n\t\t\t\t} else {\n\t\t\t\t\tnextIndex++;\n\t\t\t\t}\n\n\t\t\t\tlet tagId = \"\";\n\t\t\t\twhile (\n\t\t\t\t\tnextIndex < text.length &&\n\t\t\t\t\ttext[nextIndex] !== delimiter\n\t\t\t\t) {\n\t\t\t\t\tif (text[nextIndex] === \"\\\\\") {\n\t\t\t\t\t\ttagId += text[nextIndex + 1];\n\t\t\t\t\t\tnextIndex += 2;\n\t\t\t\t\t} else {\n\t\t\t\t\t\ttagId += text[nextIndex];\n\t\t\t\t\t\tnextIndex++;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (match[0].startsWith(\"!\")) {\n\t\t\t\t\tthis.excludeTags.add(namespaceTestTag(match[1], tagId));\n\t\t\t\t} else {\n\t\t\t\t\tthis.includeTags.add(namespaceTestTag(match[1], tagId));\n\t\t\t\t}\n\t\t\t\tnextIndex++;\n\t\t\t}\n\n\t\t\tglobText += text.slice(lastIndex, match.index);\n\t\t\tlastIndex = nextIndex;\n\t\t}\n\n\t\tglobText += text.slice(lastIndex).trim();\n\n\t\tif (globText.length) {\n\t\t\tfor (const filter of splitGlobAware(globText, \",\")\n\t\t\t\t.map((s) => s.trim())\n\t\t\t\t.filter((s) => !!s.length)) {\n\t\t\t\tif (filter.startsWith(\"!\")) {\n\t\t\t\t\tthis.globList.push({\n\t\t\t\t\t\tinclude: false,\n\t\t\t\t\t\ttext: filter.slice(1).toLowerCase(),\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tthis.globList.push({\n\t\t\t\t\t\tinclude: true,\n\t\t\t\t\t\ttext: filter.toLowerCase(),\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis.text.value = text; // purposely afterwards so everything is updated when the change event happen\n\t}\n\n\t/** @inheritdoc */\n\tpublic isFilteringFor(term: TestFilterTerm) {\n\t\treturn !!this.termFilterState[term];\n\t}\n\n\t/** @inheritdoc */\n\tpublic toggleFilteringFor(term: TestFilterTerm, shouldFilter?: boolean) {\n\t\tconst text = this.text.value.trim();\n\t\tif (shouldFilter !== false && !this.termFilterState[term]) {\n\t\t\tthis.setText(text ? `${text} ${term}` : term);\n\t\t} else if (shouldFilter !== true && this.termFilterState[term]) {\n\t\t\tthis.setText(trimExtraWhitespace(text.replace(term, \"\")));\n\t\t}\n\t}\n}\n\nexport enum TestFilterTerm {\n\tFailed = \"@failed\",\n\tExecuted = \"@executed\",\n\tCurrentDoc = \"@doc\",\n\tOpenedFiles = \"@openedFiles\",\n\tHidden = \"@hidden\",\n}\n\nconst allTestFilterTerms: readonly TestFilterTerm[] = [\n\tTestFilterTerm.Failed,\n\tTestFilterTerm.Executed,\n\tTestFilterTerm.CurrentDoc,\n\tTestFilterTerm.OpenedFiles,\n\tTestFilterTerm.Hidden,\n];\n"],
  "mappings": "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",
  "names": ["TestFilterTerm"]
}
