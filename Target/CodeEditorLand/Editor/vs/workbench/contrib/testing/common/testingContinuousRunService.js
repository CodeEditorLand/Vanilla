var c=Object.defineProperty;var h=Object.getOwnPropertyDescriptor;var g=(a,o,e,i)=>{for(var t=i>1?void 0:i?h(o,e):o,s=a.length-1,n;s>=0;s--)(n=a[s])&&(t=(i?n(o,e,t):n(t))||t);return i&&t&&c(o,e,t),t},u=(a,o)=>(e,i)=>o(e,i,a);import{CancellationTokenSource as m}from"../../../../base/common/cancellation.js";import{Disposable as b,DisposableStore as S,toDisposable as p}from"../../../../base/common/lifecycle.js";import{IContextKeyService as y}from"../../../../platform/contextkey/common/contextkey.js";import{createDecorator as v}from"../../../../platform/instantiation/common/instantiation.js";import{IStorageService as R,StorageScope as I,StorageTarget as P}from"../../../../platform/storage/common/storage.js";import{StoredValue as C}from"./storedValue.js";import{TestingContextKeys as T}from"./testingContextKeys.js";import{ITestService as E}from"./testService.js";import"./testServiceImpl.js";import"./testTypes.js";import{Emitter as O}from"../../../../base/common/event.js";import{TestId as l}from"./testId.js";import{WellDefinedPrefixTree as D}from"../../../../base/common/prefixTree.js";import{ITestProfileService as x}from"./testProfileService.js";import*as K from"../../../../base/common/arrays.js";const Z=v("testingContinuousRunService");let d=class extends b{constructor(e,i,t,s){super();this.testService=e;this.testProfileService=s;this.isGloballyOn=T.isContinuousModeOn.bindTo(t),this.lastRun=this._register(new C({key:"lastContinuousRunProfileIds",scope:I.WORKSPACE,target:P.MACHINE,serialization:{deserialize:n=>new Set(JSON.parse(n)),serialize:n=>JSON.stringify([...n])}},i)),this._register(p(()=>{this.globallyRunning?.dispose();for(const n of this.running.values())n.dispose()}))}changeEmitter=new O;globallyRunning;running=new D;lastRun;isGloballyOn;onDidChange=this.changeEmitter.event;get lastRunProfileIds(){return this.lastRun.get(new Set)}isSpecificallyEnabledFor(e){return this.running.size>0&&this.running.hasKey(l.fromString(e).path)}isEnabledForAParentOf(e){return this.globallyRunning?!0:this.running.size>0&&this.running.hasKeyOrParent(l.fromString(e).path)}isEnabledForAChildOf(e){return this.running.size>0&&this.running.hasKeyOrChildren(l.fromString(e).path)}isEnabled(){return!!this.globallyRunning||this.running.size>0}start(e,i){const t=new S,s=new m;t.add(p(()=>s.dispose(!0))),i===void 0&&this.isGloballyOn.set(!0),i?this.running.mutate(l.fromString(i).path,r=>(r?.dispose(),t)):(this.globallyRunning?.dispose(),this.globallyRunning=t);let n;if(e instanceof Array)n=e;else{const r=()=>this.testProfileService.getGroupDefaultProfiles(e).filter(f=>f.supportsContinuousRun&&(!i||l.root(i)===f.controllerId));n=r(),t.add(this.testProfileService.onDidChange(()=>{K.equals(r(),n)||this.start(e,i)}))}this.lastRun.store(new Set(n.map(r=>r.profileId))),n.length&&this.testService.startContinuousRun({continuous:!0,group:n[0].group,targets:n.map(r=>({testIds:[i??r.controllerId],controllerId:r.controllerId,profileId:r.profileId}))},s.token),this.changeEmitter.fire(i)}stop(e){if(!e)this.globallyRunning?.dispose(),this.globallyRunning=void 0;else{const i=[...this.running.deleteRecursive(l.fromString(e).path)];for(let t=i.length-1;t>=0;t--)i[t].dispose()}e===void 0&&this.isGloballyOn.set(!1),this.changeEmitter.fire(e)}};d=g([u(0,E),u(1,R),u(2,y),u(3,x)],d);export{Z as ITestingContinuousRunService,d as TestingContinuousRunService};
