var c=Object.defineProperty;var h=Object.getOwnPropertyDescriptor;var g=(a,o,e,t)=>{for(var i=t>1?void 0:t?h(o,e):o,s=a.length-1,n;s>=0;s--)(n=a[s])&&(i=(t?n(o,e,i):n(i))||i);return t&&i&&c(o,e,i),i},u=(a,o)=>(e,t)=>o(e,t,a);import*as m from"../../../../base/common/arrays.js";import{CancellationTokenSource as b}from"../../../../base/common/cancellation.js";import{Emitter as y}from"../../../../base/common/event.js";import{Disposable as S,DisposableStore as v,toDisposable as p}from"../../../../base/common/lifecycle.js";import{WellDefinedPrefixTree as R}from"../../../../base/common/prefixTree.js";import{IContextKeyService as I}from"../../../../platform/contextkey/common/contextkey.js";import{createDecorator as P}from"../../../../platform/instantiation/common/instantiation.js";import{IStorageService as C,StorageScope as T,StorageTarget as E}from"../../../../platform/storage/common/storage.js";import{StoredValue as O}from"./storedValue.js";import{TestId as l}from"./testId.js";import{ITestProfileService as D}from"./testProfileService.js";import{ITestService as x}from"./testService.js";import{TestingContextKeys as K}from"./testingContextKeys.js";const W=P("testingContinuousRunService");let d=class extends S{constructor(e,t,i,s){super();this.testService=e;this.testProfileService=s;this.isGloballyOn=K.isContinuousModeOn.bindTo(i),this.lastRun=this._register(new O({key:"lastContinuousRunProfileIds",scope:T.WORKSPACE,target:E.MACHINE,serialization:{deserialize:n=>new Set(JSON.parse(n)),serialize:n=>JSON.stringify([...n])}},t)),this._register(p(()=>{this.globallyRunning?.dispose();for(const n of this.running.values())n.dispose()}))}changeEmitter=new y;globallyRunning;running=new R;lastRun;isGloballyOn;onDidChange=this.changeEmitter.event;get lastRunProfileIds(){return this.lastRun.get(new Set)}isSpecificallyEnabledFor(e){return this.running.size>0&&this.running.hasKey(l.fromString(e).path)}isEnabledForAParentOf(e){return this.globallyRunning?!0:this.running.size>0&&this.running.hasKeyOrParent(l.fromString(e).path)}isEnabledForAChildOf(e){return this.running.size>0&&this.running.hasKeyOrChildren(l.fromString(e).path)}isEnabled(){return!!this.globallyRunning||this.running.size>0}start(e,t){const i=new v,s=new b;i.add(p(()=>s.dispose(!0))),t===void 0&&this.isGloballyOn.set(!0),t?this.running.mutate(l.fromString(t).path,r=>(r?.dispose(),i)):(this.globallyRunning?.dispose(),this.globallyRunning=i);let n;if(e instanceof Array)n=e;else{const r=()=>this.testProfileService.getGroupDefaultProfiles(e).filter(f=>f.supportsContinuousRun&&(!t||l.root(t)===f.controllerId));n=r(),i.add(this.testProfileService.onDidChange(()=>{m.equals(r(),n)||this.start(e,t)}))}this.lastRun.store(new Set(n.map(r=>r.profileId))),n.length&&this.testService.startContinuousRun({continuous:!0,group:n[0].group,targets:n.map(r=>({testIds:[t??r.controllerId],controllerId:r.controllerId,profileId:r.profileId}))},s.token),this.changeEmitter.fire(t)}stop(e){if(e){const t=[...this.running.deleteRecursive(l.fromString(e).path)];for(let i=t.length-1;i>=0;i--)t[i].dispose()}else this.globallyRunning?.dispose(),this.globallyRunning=void 0;e===void 0&&this.isGloballyOn.set(!1),this.changeEmitter.fire(e)}};d=g([u(0,x),u(1,C),u(2,I),u(3,D)],d);export{W as ITestingContinuousRunService,d as TestingContinuousRunService};
