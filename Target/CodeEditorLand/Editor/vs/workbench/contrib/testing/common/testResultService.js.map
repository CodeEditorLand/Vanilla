{
  "version": 3,
  "sources": ["../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/contrib/testing/common/testResultService.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { findFirstIdxMonotonousOrArrLen } from '../../../../base/common/arraysFind.js';\nimport { RunOnceScheduler } from '../../../../base/common/async.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { createSingleCallFunction } from '../../../../base/common/functional.js';\nimport { Disposable, DisposableStore, dispose, toDisposable } from '../../../../base/common/lifecycle.js';\nimport { generateUuid } from '../../../../base/common/uuid.js';\nimport { IContextKey, IContextKeyService } from '../../../../platform/contextkey/common/contextkey.js';\nimport { createDecorator } from '../../../../platform/instantiation/common/instantiation.js';\nimport { ITelemetryService } from '../../../../platform/telemetry/common/telemetry.js';\nimport { TestingContextKeys } from './testingContextKeys.js';\nimport { ITestProfileService } from './testProfileService.js';\nimport { ITestResult, LiveTestResult, TestResultItemChange, TestResultItemChangeReason } from './testResult.js';\nimport { ITestResultStorage, RETAIN_MAX_RESULTS } from './testResultStorage.js';\nimport { ExtensionRunTestsRequest, ITestRunProfile, ResolvedTestRunRequest, TestResultItem, TestResultState, TestRunProfileBitset } from './testTypes.js';\n\nexport type ResultChangeEvent =\n\t| { completed: LiveTestResult }\n\t| { started: LiveTestResult }\n\t| { inserted: ITestResult }\n\t| { removed: ITestResult[] };\n\nexport interface ITestResultService {\n\treadonly _serviceBrand: undefined;\n\t/**\n\t * Fired after any results are added, removed, or completed.\n\t */\n\treadonly onResultsChanged: Event<ResultChangeEvent>;\n\n\t/**\n\t * Fired when a test changed it state, or its computed state is updated.\n\t */\n\treadonly onTestChanged: Event<TestResultItemChange>;\n\n\t/**\n\t * List of known test results.\n\t */\n\treadonly results: ReadonlyArray<ITestResult>;\n\n\t/**\n\t * Discards all completed test results.\n\t */\n\tclear(): void;\n\n\t/**\n\t * Creates a new, live test result.\n\t */\n\tcreateLiveResult(req: ResolvedTestRunRequest | ExtensionRunTestsRequest): LiveTestResult;\n\n\t/**\n\t * Adds a new test result to the collection.\n\t */\n\tpush<T extends ITestResult>(result: T): T;\n\n\t/**\n\t * Looks up a set of test results by ID.\n\t */\n\tgetResult(resultId: string): ITestResult | undefined;\n\n\t/**\n\t * Looks up a test's most recent state, by its extension-assigned ID.\n\t */\n\tgetStateById(extId: string): [results: ITestResult, item: TestResultItem] | undefined;\n}\n\nconst isRunningTests = (service: ITestResultService) =>\n\tservice.results.length > 0 && service.results[0].completedAt === undefined;\n\nexport const ITestResultService = createDecorator<ITestResultService>('testResultService');\n\nexport class TestResultService extends Disposable implements ITestResultService {\n\tdeclare _serviceBrand: undefined;\n\tprivate changeResultEmitter = this._register(new Emitter<ResultChangeEvent>());\n\tprivate _results: ITestResult[] = [];\n\tprivate readonly _resultsDisposables: DisposableStore[] = [];\n\tprivate testChangeEmitter = this._register(new Emitter<TestResultItemChange>());\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic get results() {\n\t\tthis.loadResults();\n\t\treturn this._results;\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic readonly onResultsChanged = this.changeResultEmitter.event;\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic readonly onTestChanged = this.testChangeEmitter.event;\n\n\tprivate readonly isRunning: IContextKey<boolean>;\n\tprivate readonly hasAnyResults: IContextKey<boolean>;\n\tprivate readonly loadResults = createSingleCallFunction(() => this.storage.read().then(loaded => {\n\t\tfor (let i = loaded.length - 1; i >= 0; i--) {\n\t\t\tthis.push(loaded[i]);\n\t\t}\n\t}));\n\n\tprotected readonly persistScheduler = new RunOnceScheduler(() => this.persistImmediately(), 500);\n\n\tconstructor(\n\t\t@IContextKeyService contextKeyService: IContextKeyService,\n\t\t@ITestResultStorage private readonly storage: ITestResultStorage,\n\t\t@ITestProfileService private readonly testProfiles: ITestProfileService,\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t) {\n\t\tsuper();\n\t\tthis._register(toDisposable(() => dispose(this._resultsDisposables)));\n\t\tthis.isRunning = TestingContextKeys.isRunning.bindTo(contextKeyService);\n\t\tthis.hasAnyResults = TestingContextKeys.hasAnyResults.bindTo(contextKeyService);\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic getStateById(extId: string): [results: ITestResult, item: TestResultItem] | undefined {\n\t\tfor (const result of this.results) {\n\t\t\tconst lookup = result.getStateById(extId);\n\t\t\tif (lookup && lookup.computedState !== TestResultState.Unset) {\n\t\t\t\treturn [result, lookup];\n\t\t\t}\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic createLiveResult(req: ResolvedTestRunRequest | ExtensionRunTestsRequest) {\n\t\tif ('targets' in req) {\n\t\t\tconst id = generateUuid();\n\t\t\treturn this.push(new LiveTestResult(id, true, req, this.telemetryService));\n\t\t}\n\n\t\tlet profile: ITestRunProfile | undefined;\n\t\tif (req.profile) {\n\t\t\tconst profiles = this.testProfiles.getControllerProfiles(req.controllerId);\n\t\t\tprofile = profiles.find(c => c.profileId === req.profile!.id);\n\t\t}\n\n\t\tconst resolved: ResolvedTestRunRequest = {\n\t\t\tpreserveFocus: req.preserveFocus,\n\t\t\ttargets: [],\n\t\t\texclude: req.exclude,\n\t\t\tcontinuous: req.continuous,\n\t\t\tgroup: profile?.group ?? TestRunProfileBitset.Run,\n\t\t};\n\n\t\tif (profile) {\n\t\t\tresolved.targets.push({\n\t\t\t\tprofileId: profile.profileId,\n\t\t\t\tcontrollerId: req.controllerId,\n\t\t\t\ttestIds: req.include,\n\t\t\t});\n\t\t}\n\n\t\treturn this.push(new LiveTestResult(req.id, req.persist, resolved, this.telemetryService));\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic push<T extends ITestResult>(result: T): T {\n\t\tif (result.completedAt === undefined) {\n\t\t\tthis.results.unshift(result);\n\t\t} else {\n\t\t\tconst index = findFirstIdxMonotonousOrArrLen(this.results, r => r.completedAt !== undefined && r.completedAt <= result.completedAt!);\n\t\t\tthis.results.splice(index, 0, result);\n\t\t\tthis.persistScheduler.schedule();\n\t\t}\n\n\t\tthis.hasAnyResults.set(true);\n\t\tif (this.results.length > RETAIN_MAX_RESULTS) {\n\t\t\tthis.results.pop();\n\t\t\tthis._resultsDisposables.pop()?.dispose();\n\t\t}\n\n\t\tconst ds = new DisposableStore();\n\t\tthis._resultsDisposables.push(ds);\n\n\t\tif (result instanceof LiveTestResult) {\n\t\t\tds.add(result);\n\t\t\tds.add(result.onComplete(() => this.onComplete(result)));\n\t\t\tds.add(result.onChange(this.testChangeEmitter.fire, this.testChangeEmitter));\n\t\t\tthis.isRunning.set(true);\n\t\t\tthis.changeResultEmitter.fire({ started: result });\n\t\t} else {\n\t\t\tthis.changeResultEmitter.fire({ inserted: result });\n\t\t\t// If this is not a new result, go through each of its tests. For each\n\t\t\t// test for which the new result is the most recently inserted, fir\n\t\t\t// a change event so that UI updates.\n\t\t\tfor (const item of result.tests) {\n\t\t\t\tfor (const otherResult of this.results) {\n\t\t\t\t\tif (otherResult === result) {\n\t\t\t\t\t\tthis.testChangeEmitter.fire({ item, result, reason: TestResultItemChangeReason.ComputedStateChange });\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t} else if (otherResult.getStateById(item.item.extId) !== undefined) {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic getResult(id: string) {\n\t\treturn this.results.find(r => r.id === id);\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic clear() {\n\t\tconst keep: ITestResult[] = [];\n\t\tconst removed: ITestResult[] = [];\n\t\tfor (const result of this.results) {\n\t\t\tif (result.completedAt !== undefined) {\n\t\t\t\tremoved.push(result);\n\t\t\t} else {\n\t\t\t\tkeep.push(result);\n\t\t\t}\n\t\t}\n\n\t\tthis._results = keep;\n\t\tthis.persistScheduler.schedule();\n\t\tif (keep.length === 0) {\n\t\t\tthis.hasAnyResults.set(false);\n\t\t}\n\t\tthis.changeResultEmitter.fire({ removed });\n\t}\n\n\tprivate onComplete(result: LiveTestResult) {\n\t\tthis.resort();\n\t\tthis.updateIsRunning();\n\t\tthis.persistScheduler.schedule();\n\t\tthis.changeResultEmitter.fire({ completed: result });\n\t}\n\n\tprivate resort() {\n\t\tthis.results.sort((a, b) => (b.completedAt ?? Number.MAX_SAFE_INTEGER) - (a.completedAt ?? Number.MAX_SAFE_INTEGER));\n\t}\n\n\tprivate updateIsRunning() {\n\t\tthis.isRunning.set(isRunningTests(this));\n\t}\n\n\tprotected async persistImmediately() {\n\t\t// ensure results are loaded before persisting to avoid deleting once\n\t\t// that we don't have yet.\n\t\tawait this.loadResults();\n\t\tthis.storage.persist(this.results);\n\t}\n}\n"],
  "mappings": "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",
  "names": []
}
