var k=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var C=(s,e,i,o)=>{for(var t=o>1?void 0:o?K(e,i):e,n=s.length-1,v;n>=0;n--)(v=s[n])&&(t=(o?v(e,i,t):v(t))||t);return o&&t&&k(e,i,t),t},d=(s,e)=>(i,o)=>e(i,o,s);import{CancellationTokenSource as E}from"../../../../base/common/cancellation.js";import{Codicon as w}from"../../../../base/common/codicons.js";import{isCancellationError as M}from"../../../../base/common/errors.js";import{Event as I}from"../../../../base/common/event.js";import{KeyCode as m,KeyMod as y}from"../../../../base/common/keyCodes.js";import{DisposableStore as x}from"../../../../base/common/lifecycle.js";import"../../../../editor/browser/editorBrowser.js";import{EditorAction2 as p,EditorContributionInstantiation as W,registerEditorContribution as A}from"../../../../editor/browser/editorExtensions.js";import{ICodeEditorService as R}from"../../../../editor/browser/services/codeEditorService.js";import"../../../../editor/common/core/position.js";import{Range as F}from"../../../../editor/common/core/range.js";import"../../../../editor/common/editorCommon.js";import{PeekContext as D}from"../../../../editor/contrib/peekView/browser/peekView.js";import{localize as c,localize2 as _}from"../../../../nls.js";import{MenuId as V,registerAction2 as h}from"../../../../platform/actions/common/actions.js";import{ContextKeyExpr as l,IContextKeyService as q,RawContextKey as f}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as L}from"../../../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as b}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{IStorageService as z,StorageScope as P,StorageTarget as O}from"../../../../platform/storage/common/storage.js";import{TypeHierarchyTreePeekWidget as S}from"./typeHierarchyPeek.js";import{TypeHierarchyDirection as a,TypeHierarchyModel as N,TypeHierarchyProviderRegistry as H}from"../common/typeHierarchy.js";const T=new f("editorHasTypeHierarchyProvider",!1,c("editorHasTypeHierarchyProvider","Whether a type hierarchy provider is available")),u=new f("typeHierarchyVisible",!1,c("typeHierarchyVisible","Whether type hierarchy peek is currently showing")),g=new f("typeHierarchyDirection",void 0,{type:"string",description:c("typeHierarchyDirection","whether type hierarchy shows super types or subtypes")});function U(s){return s===a.Subtypes||s===a.Supertypes?s:a.Subtypes}let r=class{constructor(e,i,o,t,n){this._editor=e;this._contextKeyService=i;this._storageService=o;this._editorService=t;this._instantiationService=n;this._ctxHasProvider=T.bindTo(this._contextKeyService),this._ctxIsVisible=u.bindTo(this._contextKeyService),this._ctxDirection=g.bindTo(this._contextKeyService),this._disposables.add(I.any(e.onDidChangeModel,e.onDidChangeModelLanguage,H.onDidChange)(()=>{this._ctxHasProvider.set(e.hasModel()&&H.has(e.getModel()))})),this._disposables.add(this._sessionDisposables)}static Id="typeHierarchy";static get(e){return e.getContribution(r.Id)}static _storageDirectionKey="typeHierarchy/defaultDirection";_ctxHasProvider;_ctxIsVisible;_ctxDirection;_disposables=new x;_sessionDisposables=new x;_widget;dispose(){this._disposables.dispose()}async startTypeHierarchyFromEditor(){if(this._sessionDisposables.clear(),!this._editor.hasModel())return;const e=this._editor.getModel(),i=this._editor.getPosition();if(!H.has(e))return;const o=new E,t=N.create(e,i,o.token),n=U(this._storageService.get(r._storageDirectionKey,P.PROFILE,a.Subtypes));this._showTypeHierarchyWidget(i,n,t,o)}_showTypeHierarchyWidget(e,i,o,t){this._ctxIsVisible.set(!0),this._ctxDirection.set(i),I.any(this._editor.onDidChangeModel,this._editor.onDidChangeModelLanguage)(this.endTypeHierarchy,this,this._sessionDisposables),this._widget=this._instantiationService.createInstance(S,this._editor,e,i),this._widget.showLoading(),this._sessionDisposables.add(this._widget.onDidClose(()=>{this.endTypeHierarchy(),this._storageService.store(r._storageDirectionKey,this._widget.direction,P.PROFILE,O.USER)})),this._sessionDisposables.add({dispose(){t.dispose(!0)}}),this._sessionDisposables.add(this._widget),o.then(n=>{t.token.isCancellationRequested||(n?(this._sessionDisposables.add(n),this._widget.showModel(n)):this._widget.showMessage(c("no.item","No results")))}).catch(n=>{if(M(n)){this.endTypeHierarchy();return}this._widget.showMessage(c("error","Failed to show type hierarchy"))})}async startTypeHierarchyFromTypeHierarchy(){if(!this._widget)return;const e=this._widget.getModel(),i=this._widget.getFocused();if(!i||!e)return;const o=await this._editorService.openCodeEditor({resource:i.item.uri},this._editor);if(!o)return;const t=e.fork(i.item);this._sessionDisposables.clear(),r.get(o)?._showTypeHierarchyWidget(F.lift(t.root.selectionRange).getStartPosition(),this._widget.direction,Promise.resolve(t),new E)}showSupertypes(){this._widget?.updateDirection(a.Supertypes),this._ctxDirection.set(a.Supertypes)}showSubtypes(){this._widget?.updateDirection(a.Subtypes),this._ctxDirection.set(a.Subtypes)}endTypeHierarchy(){this._sessionDisposables.clear(),this._ctxIsVisible.set(!1),this._editor.focus()}};r=C([d(1,q),d(2,z),d(3,R),d(4,L)],r),A(r.Id,r,W.Eager),h(class extends p{constructor(){super({id:"editor.showTypeHierarchy",title:_("title","Peek Type Hierarchy"),menu:{id:V.EditorContextPeek,group:"navigation",order:1e3,when:l.and(T,D.notInPeekEditor)},precondition:l.and(T,D.notInPeekEditor),f1:!0})}async runEditorCommand(e,i){return r.get(i)?.startTypeHierarchyFromEditor()}}),h(class extends p{constructor(){super({id:"editor.showSupertypes",title:_("title.supertypes","Show Supertypes"),icon:w.typeHierarchySuper,precondition:l.and(u,g.isEqualTo(a.Subtypes)),keybinding:{weight:b.WorkbenchContrib,primary:y.Shift+y.Alt+m.KeyH},menu:{id:S.TitleMenu,when:g.isEqualTo(a.Subtypes),order:1}})}runEditorCommand(s,e){return r.get(e)?.showSupertypes()}}),h(class extends p{constructor(){super({id:"editor.showSubtypes",title:_("title.subtypes","Show Subtypes"),icon:w.typeHierarchySub,precondition:l.and(u,g.isEqualTo(a.Supertypes)),keybinding:{weight:b.WorkbenchContrib,primary:y.Shift+y.Alt+m.KeyH},menu:{id:S.TitleMenu,when:g.isEqualTo(a.Supertypes),order:1}})}runEditorCommand(s,e){return r.get(e)?.showSubtypes()}}),h(class extends p{constructor(){super({id:"editor.refocusTypeHierarchy",title:_("title.refocusTypeHierarchy","Refocus Type Hierarchy"),precondition:u,keybinding:{weight:b.WorkbenchContrib,primary:y.Shift+m.Enter}})}async runEditorCommand(s,e){return r.get(e)?.startTypeHierarchyFromTypeHierarchy()}}),h(class extends p{constructor(){super({id:"editor.closeTypeHierarchy",title:c("close","Close"),icon:w.close,precondition:u,keybinding:{weight:b.WorkbenchContrib+10,primary:m.Escape,when:l.not("config.editor.stablePeek")},menu:{id:S.TitleMenu,order:1e3}})}runEditorCommand(s,e){return r.get(e)?.endTypeHierarchy()}});
