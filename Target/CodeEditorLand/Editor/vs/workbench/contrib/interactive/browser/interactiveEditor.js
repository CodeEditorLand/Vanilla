var $=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var M=(v,t,e,i)=>{for(var o=i>1?void 0:i?G(t,e):t,s=v.length-1,n;s>=0;s--)(n=v[s])&&(o=(i?n(t,e,o):n(o))||o);return i&&o&&$(t,e,o),o},a=(v,t)=>(e,i)=>t(e,i,v);import"./media/interactive.css";import*as d from"../../../../base/browser/dom.js";import"../../../../base/common/cancellation.js";import{Emitter as y,Event as F}from"../../../../base/common/event.js";import{DisposableStore as U,MutableDisposable as Y}from"../../../../base/common/lifecycle.js";import{ICodeEditorService as z}from"../../../../editor/browser/services/codeEditorService.js";import{CodeEditorWidget as j}from"../../../../editor/browser/widget/codeEditor/codeEditorWidget.js";import"../../../../editor/common/editorCommon.js";import{IContextKeyService as O}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as J}from"../../../../platform/instantiation/common/instantiation.js";import{IStorageService as q}from"../../../../platform/storage/common/storage.js";import{ITelemetryService as X}from"../../../../platform/telemetry/common/telemetry.js";import{IThemeService as Z}from"../../../../platform/theme/common/themeService.js";import{EditorPane as Q}from"../../../browser/parts/editor/editorPane.js";import{EditorPaneSelectionChangeReason as m}from"../../../common/editor.js";import{getSimpleEditorOptions as tt}from"../../codeEditor/browser/simpleEditorOptions.js";import{InteractiveEditorInput as L}from"./interactiveEditorInput.js";import"../../notebook/browser/notebookBrowser.js";import{NotebookEditorExtensionsRegistry as et}from"../../notebook/browser/notebookEditorExtensions.js";import{INotebookEditorService as it}from"../../notebook/browser/services/notebookEditorService.js";import"../../notebook/browser/notebookEditorWidget.js";import{GroupsOrder as ot,IEditorGroupsService as nt}from"../../../services/editor/common/editorGroupsService.js";import{ExecutionStateCellStatusBarContrib as rt,TimerCellStatusBarContrib as st}from"../../notebook/browser/contrib/cellStatusBar/executionStatusBarItemController.js";import{INotebookKernelService as at}from"../../notebook/common/notebookKernelService.js";import{PLAINTEXT_LANGUAGE_ID as dt}from"../../../../editor/common/languages/modesRegistry.js";import{ILanguageService as lt}from"../../../../editor/common/languages/language.js";import{IMenuService as ct,MenuId as g}from"../../../../platform/actions/common/actions.js";import{IKeybindingService as ht}from"../../../../platform/keybinding/common/keybinding.js";import{InteractiveWindowSetting as w,INTERACTIVE_INPUT_CURSOR_BOUNDARY as ut}from"./interactiveCommon.js";import{IConfigurationService as pt}from"../../../../platform/configuration/common/configuration.js";import{NotebookOptions as gt}from"../../notebook/browser/notebookOptions.js";import{ToolBar as _t}from"../../../../base/browser/ui/toolbar/toolbar.js";import{IContextMenuService as vt}from"../../../../platform/contextview/browser/contextView.js";import{createActionViewItem as mt,createAndFillInActionBarActions as Et}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import"../../../../base/common/actions.js";import{EditorExtensionsRegistry as N}from"../../../../editor/browser/editorExtensions.js";import{ParameterHintsController as Ct}from"../../../../editor/contrib/parameterHints/browser/parameterHints.js";import{MenuPreventer as St}from"../../codeEditor/browser/menuPreventer.js";import{SelectionClipboardContributionID as V}from"../../codeEditor/browser/selectionClipboard.js";import{ContextMenuController as H}from"../../../../editor/contrib/contextmenu/browser/contextmenu.js";import{SuggestController as P}from"../../../../editor/contrib/suggest/browser/suggestController.js";import{SnippetController2 as bt}from"../../../../editor/contrib/snippet/browser/snippetController2.js";import{TabCompletionController as It}from"../../snippets/browser/tabCompletion.js";import{MarkerController as R}from"../../../../editor/contrib/gotoError/browser/gotoError.js";import"../../../common/editor/editorInput.js";import{ITextResourceConfigurationService as ft}from"../../../../editor/common/services/textResourceConfiguration.js";import{TextEditorSelectionSource as W}from"../../../../platform/editor/common/editor.js";import{INotebookExecutionStateService as Dt,NotebookExecutionType as kt}from"../../notebook/common/notebookExecutionStateService.js";import{NOTEBOOK_KERNEL as yt}from"../../notebook/common/notebookContextKeys.js";import"../../../../editor/common/cursorEvents.js";import{IExtensionService as wt}from"../../../services/extensions/common/extensions.js";import{isEqual as Wt}from"../../../../base/common/resources.js";import{NotebookFindContrib as xt}from"../../notebook/browser/contrib/find/notebookFindWidget.js";import{INTERACTIVE_WINDOW_EDITOR_ID as Tt}from"../../notebook/common/notebookCommon.js";import"./interactiveEditor.css";import"../../../../editor/common/config/editorOptions.js";import{deepClone as Mt}from"../../../../base/common/objects.js";import{ContentHoverController as A}from"../../../../editor/contrib/hover/browser/contentHoverController.js";import{GlyphHoverController as K}from"../../../../editor/contrib/hover/browser/glyphHoverController.js";import{ReplInputHintContentWidget as Ot}from"./replInputHintContentWidget.js";import{ServiceCollection as Lt}from"../../../../platform/instantiation/common/serviceCollection.js";import{INLINE_CHAT_ID as Nt}from"../../inlineChat/common/inlineChat.js";import"../../replNotebook/browser/replEditor.js";const Vt="interactiveInputDecoration",Ht="InteractiveEditorViewState",E=8,x=10,C=8;let f=class extends Q{_rootElement;_styleElement;_notebookEditorContainer;_notebookWidget={value:void 0};_inputCellContainer;_inputFocusIndicator;_inputRunButtonContainer;_inputEditorContainer;_codeEditorWidget;_notebookWidgetService;_instantiationService;_languageService;_contextKeyService;_configurationService;_notebookKernelService;_keybindingService;_menuService;_contextMenuService;_editorGroupService;_notebookExecutionStateService;_extensionService;_widgetDisposableStore=this._register(new U);_lastLayoutDimensions;_editorOptions;_notebookOptions;_editorMemento;_groupListener=this._register(new Y);_runbuttonToolbar;_hintElement;_onDidFocusWidget=this._register(new y);get onDidFocus(){return this._onDidFocusWidget.event}_onDidChangeSelection=this._register(new y);onDidChangeSelection=this._onDidChangeSelection.event;_onDidChangeScroll=this._register(new y);onDidChangeScroll=this._onDidChangeScroll.event;constructor(t,e,i,o,s,n,h,S,_,c,r,l,b,D,u,k,I,B){super(Tt,t,e,i,o),this._notebookWidgetService=n,this._configurationService=l,this._notebookKernelService=_,this._languageService=c,this._keybindingService=r,this._menuService=b,this._contextMenuService=D,this._editorGroupService=u,this._notebookExecutionStateService=I,this._extensionService=B,this._rootElement=d.$(".interactive-editor"),this._contextKeyService=this._register(h.createScoped(this._rootElement)),this._contextKeyService.createKey("isCompositeNotebook",!0),this._instantiationService=this._register(s.createChild(new Lt([O,this._contextKeyService]))),this._editorOptions=this._computeEditorOptions(),this._register(this._configurationService.onDidChangeConfiguration(p=>{(p.affectsConfiguration("editor")||p.affectsConfiguration("notebook"))&&(this._editorOptions=this._computeEditorOptions())})),this._notebookOptions=s.createInstance(gt,this.window,!0,{cellToolbarInteraction:"hover",globalToolbar:!0,stickyScrollEnabled:!1,dragAndDropEnabled:!1}),this._editorMemento=this.getEditorMemento(u,k,Ht),S.registerDecorationType("interactive-decoration",Vt,{}),this._register(this._keybindingService.onDidUpdateKeybindings(this._updateInputHint,this)),this._register(this._notebookExecutionStateService.onDidChangeExecution(p=>{if(p.type===kt.cell&&Wt(p.notebook,this._notebookWidget.value?.viewModel?.notebookDocument.uri)){const T=this._notebookWidget.value?.getCellByHandle(p.cellHandle);T&&p.changed?.state&&this._scrollIfNecessary(T)}}))}get inputCellContainerHeight(){return 21+E*2+C*2}get inputCellEditorHeight(){return 19+C*2}createEditor(t){d.append(t,this._rootElement),this._rootElement.style.position="relative",this._notebookEditorContainer=d.append(this._rootElement,d.$(".notebook-editor-container")),this._inputCellContainer=d.append(this._rootElement,d.$(".input-cell-container")),this._inputCellContainer.style.position="absolute",this._inputCellContainer.style.height=`${this.inputCellContainerHeight}px`,this._inputFocusIndicator=d.append(this._inputCellContainer,d.$(".input-focus-indicator")),this._inputRunButtonContainer=d.append(this._inputCellContainer,d.$(".run-button-container")),this._setupRunButtonToolbar(this._inputRunButtonContainer),this._inputEditorContainer=d.append(this._inputCellContainer,d.$(".input-editor-container")),this._createLayoutStyles()}_setupRunButtonToolbar(t){const e=this._register(this._menuService.createMenu(g.InteractiveInputExecute,this._contextKeyService));this._runbuttonToolbar=this._register(new _t(t,this._contextMenuService,{getKeyBinding:n=>this._keybindingService.lookupKeybinding(n.id),actionViewItemProvider:(n,h)=>mt(this._instantiationService,n,h),renderDropdownAsChildElement:!0}));const i=[],o=[];Et(e,{shouldForwardArgs:!0},{primary:i,secondary:o}),this._runbuttonToolbar.setActions([...i,...o])}_createLayoutStyles(){this._styleElement=d.createStyleSheet(this._rootElement);const t=[],{codeCellLeftMargin:e,cellRunGutter:i}=this._notebookOptions.getLayoutConfiguration(),{focusIndicator:o}=this._notebookOptions.getDisplayOptions(),s=this._notebookOptions.getCellEditorContainerLeftMargin();t.push(`
			.interactive-editor .input-cell-container {
				padding: ${E}px ${x}px ${E}px ${s}px;
			}
		`),o==="gutter"?t.push(`
				.interactive-editor .input-cell-container:focus-within .input-focus-indicator::before {
					border-color: var(--vscode-notebook-focusedCellBorder) !important;
				}
				.interactive-editor .input-focus-indicator::before {
					border-color: var(--vscode-notebook-inactiveFocusedCellBorder) !important;
				}
				.interactive-editor .input-cell-container .input-focus-indicator {
					display: block;
					top: ${E}px;
				}
				.interactive-editor .input-cell-container {
					border-top: 1px solid var(--vscode-notebook-inactiveFocusedCellBorder);
				}
			`):t.push(`
				.interactive-editor .input-cell-container {
					border-top: 1px solid var(--vscode-notebook-inactiveFocusedCellBorder);
				}
				.interactive-editor .input-cell-container .input-focus-indicator {
					display: none;
				}
			`),t.push(`
			.interactive-editor .input-cell-container .run-button-container {
				width: ${i}px;
				left: ${e}px;
				margin-top: ${C-2}px;
			}
		`),this._styleElement.textContent=t.join(`
`)}_computeEditorOptions(){let t;this._codeEditorWidget&&(t=this._codeEditorWidget.getModel()?.getLanguageId());const e=Mt(this._configurationService.getValue("editor",{overrideIdentifier:t})),i=tt(this._configurationService);return Object.freeze({...e,...i,glyphMargin:!0,padding:{top:C,bottom:C},hover:{enabled:!0}})}saveState(){this._saveEditorViewState(this.input),super.saveState()}getViewState(){const t=this.input;if(t instanceof L)return this._saveEditorViewState(t),this._loadNotebookEditorViewState(t)}_saveEditorViewState(t){if(this._notebookWidget.value&&t instanceof L){if(this._notebookWidget.value.isDisposed)return;const e=this._notebookWidget.value.getEditorViewState(),i=this._codeEditorWidget.saveViewState();this._editorMemento.saveEditorState(this.group,t.notebookEditorInput.resource,{notebook:e,input:i})}}_loadNotebookEditorViewState(t){const e=this._editorMemento.loadEditorState(this.group,t.notebookEditorInput.resource);if(e)return e;for(const i of this._editorGroupService.getGroups(ot.MOST_RECENTLY_ACTIVE))if(i.activeEditorPane!==this&&i.activeEditorPane===this&&i.activeEditor?.matches(t)){const o=this._notebookWidget.value?.getEditorViewState(),s=this._codeEditorWidget.saveViewState();return{notebook:o,input:s}}}async setInput(t,e,i,o){const s=t.notebookEditorInput;if(this._notebookWidget.value?.onWillHide(),this._codeEditorWidget?.dispose(),this._widgetDisposableStore.clear(),this._notebookWidget=this._instantiationService.invokeFunction(this._notebookWidgetService.retrieveWidget,this.group.id,s,{isReplHistory:!0,isReadOnly:!0,contributions:et.getSomeEditorContributions([rt.id,st.id,xt.id]),menuIds:{notebookToolbar:g.InteractiveToolbar,cellTitleToolbar:g.InteractiveCellTitle,cellDeleteToolbar:g.InteractiveCellDelete,cellInsertToolbar:g.NotebookCellBetween,cellTopInsertToolbar:g.NotebookCellListTop,cellExecuteToolbar:g.InteractiveCellExecute,cellExecutePrimary:void 0},cellEditorContributions:N.getSomeEditorContributions([V,H.ID,A.ID,K.ID,R.ID]),options:this._notebookOptions,codeWindow:this.window},void 0,this.window),this._codeEditorWidget=this._instantiationService.createInstance(j,this._inputEditorContainer,this._editorOptions,{isSimpleWidget:!1,contributions:N.getSomeEditorContributions([St.ID,V,H.ID,P.ID,Ct.ID,bt.ID,It.ID,A.ID,K.ID,R.ID,Nt])}),this._lastLayoutDimensions){this._notebookEditorContainer.style.height=`${this._lastLayoutDimensions.dimension.height-this.inputCellContainerHeight}px`,this._notebookWidget.value.layout(new d.Dimension(this._lastLayoutDimensions.dimension.width,this._lastLayoutDimensions.dimension.height-this.inputCellContainerHeight),this._notebookEditorContainer);const r=this._notebookOptions.getCellEditorContainerLeftMargin(),l=Math.min(this._lastLayoutDimensions.dimension.height/2,this.inputCellEditorHeight);this._codeEditorWidget.layout(this._validateDimension(this._lastLayoutDimensions.dimension.width-r-x,l)),this._inputFocusIndicator.style.height=`${this.inputCellEditorHeight}px`,this._inputCellContainer.style.top=`${this._lastLayoutDimensions.dimension.height-this.inputCellContainerHeight}px`,this._inputCellContainer.style.width=`${this._lastLayoutDimensions.dimension.width}px`}await super.setInput(t,e,i,o);const n=await t.resolve();if(this._runbuttonToolbar&&(this._runbuttonToolbar.context=t.resource),n===null)throw new Error("The Interactive Window model could not be resolved");this._notebookWidget.value?.setParentContextKeyService(this._contextKeyService);const h=e?.viewState??this._loadNotebookEditorViewState(t);await this._extensionService.whenInstalledExtensionsRegistered(),await this._notebookWidget.value.setModel(n.notebook,h?.notebook),n.notebook.setCellCollapseDefault(this._notebookOptions.getCellCollapseDefault()),this._notebookWidget.value.setOptions({isReadOnly:!0}),this._widgetDisposableStore.add(this._notebookWidget.value.onDidResizeOutput(r=>{this._scrollIfNecessary(r)})),this._widgetDisposableStore.add(this._notebookWidget.value.onDidFocusWidget(()=>this._onDidFocusWidget.fire())),this._widgetDisposableStore.add(this._notebookOptions.onDidChangeOptions(r=>{(r.compactView||r.focusIndicator)&&(this._styleElement?.remove(),this._createLayoutStyles()),this._lastLayoutDimensions&&this.isVisible()&&this.layout(this._lastLayoutDimensions.dimension,this._lastLayoutDimensions.position),r.interactiveWindowCollapseCodeCells&&n.notebook.setCellCollapseDefault(this._notebookOptions.getCellCollapseDefault())}));const S=this._notebookWidget.value?.activeKernel?.supportedLanguages[0]??t.language??dt,_=await t.resolveInput(S);_.setLanguage(S),this._codeEditorWidget.setModel(_),h?.input&&this._codeEditorWidget.restoreViewState(h.input),this._editorOptions=this._computeEditorOptions(),this._codeEditorWidget.updateOptions(this._editorOptions),this._widgetDisposableStore.add(this._codeEditorWidget.onDidFocusEditorWidget(()=>this._onDidFocusWidget.fire())),this._widgetDisposableStore.add(this._codeEditorWidget.onDidContentSizeChange(r=>{r.contentHeightChanged&&this._lastLayoutDimensions&&this._layoutWidgets(this._lastLayoutDimensions.dimension,this._lastLayoutDimensions.position)})),this._widgetDisposableStore.add(this._codeEditorWidget.onDidChangeCursorPosition(r=>this._onDidChangeSelection.fire({reason:this._toEditorPaneSelectionChangeReason(r)}))),this._widgetDisposableStore.add(this._codeEditorWidget.onDidChangeModelContent(()=>this._onDidChangeSelection.fire({reason:m.EDIT}))),this._widgetDisposableStore.add(this._notebookKernelService.onDidChangeNotebookAffinity(this._syncWithKernel,this)),this._widgetDisposableStore.add(this._notebookKernelService.onDidChangeSelectedNotebooks(this._syncWithKernel,this)),this._widgetDisposableStore.add(this.themeService.onDidColorThemeChange(()=>{this.isVisible()&&this._updateInputHint()})),this._widgetDisposableStore.add(this._codeEditorWidget.onDidChangeModelContent(()=>{this.isVisible()&&this._updateInputHint()})),this._codeEditorWidget.onDidChangeModelDecorations(()=>{this.isVisible()&&this._updateInputHint()}),this._widgetDisposableStore.add(this._codeEditorWidget.onDidChangeModel(()=>{this._updateInputHint()})),this._configurationService.onDidChangeConfiguration(r=>{r.affectsConfiguration(w.showExecutionHint)&&this._updateInputHint()});const c=ut.bindTo(this._contextKeyService);t.resource&&t.historyService.has(t.resource)?c.set("top"):c.set("none"),this._widgetDisposableStore.add(this._codeEditorWidget.onDidChangeCursorPosition(({position:r})=>{const l=this._codeEditorWidget._getViewModel(),b=l.getLineCount(),D=l.getLineLength(b)+1,u=l.coordinatesConverter.convertModelPositionToViewPosition(r),k=u.lineNumber===1&&u.column===1,I=u.lineNumber===b&&u.column===D;k?I?c.set("both"):c.set("top"):I?c.set("bottom"):c.set("none")})),this._widgetDisposableStore.add(_.onDidChangeContent(()=>{const r=_.getValue();if(this.input?.resource){const l=this.input.historyService;l.matchesCurrent(this.input.resource,r)||l.replaceLast(this.input.resource,r)}})),this._widgetDisposableStore.add(this._notebookWidget.value.onDidScroll(()=>this._onDidChangeScroll.fire())),this._syncWithKernel(),this._updateInputHint()}setOptions(t){this._notebookWidget.value?.setOptions(t),super.setOptions(t)}_toEditorPaneSelectionChangeReason(t){switch(t.source){case W.PROGRAMMATIC:return m.PROGRAMMATIC;case W.NAVIGATION:return m.NAVIGATION;case W.JUMP:return m.JUMP;default:return m.USER}}_cellAtBottom(t){const e=this._notebookWidget.value?.visibleRanges||[];return this._notebookWidget.value?.getCellIndex(t)===Math.max(...e.map(o=>o.end-1))}_scrollIfNecessary(t){this._notebookWidget.value.getCellIndex(t)===this._notebookWidget.value.getLength()-1&&(this._configurationService.getValue(w.interactiveWindowAlwaysScrollOnNewCell)||this._cellAtBottom(t))&&this._notebookWidget.value.scrollToBottom()}_syncWithKernel(){const t=this._notebookWidget.value?.textModel,e=this._codeEditorWidget.getModel();if(t&&e){const i=this._notebookKernelService.getMatchingKernel(t),o=i.selected??(i.suggestions.length===1?i.suggestions[0]:void 0)??(i.all.length===1?i.all[0]:void 0);if(o){const s=o.supportedLanguages[0];if(s&&s!=="plaintext"){const n=this._languageService.createById(s).languageId;e.setLanguage(n)}yt.bindTo(this._contextKeyService).set(o.id)}}}layout(t,e){this._rootElement.classList.toggle("mid-width",t.width<1e3&&t.width>=600),this._rootElement.classList.toggle("narrow-width",t.width<600);const i=t.height!==this._lastLayoutDimensions?.dimension.height;this._lastLayoutDimensions={dimension:t,position:e},this._notebookWidget.value&&(i&&this._codeEditorWidget&&P.get(this._codeEditorWidget)?.cancelSuggestWidget(),this._notebookEditorContainer.style.height=`${this._lastLayoutDimensions.dimension.height-this.inputCellContainerHeight}px`,this._layoutWidgets(t,e))}_layoutWidgets(t,e){const i=this._codeEditorWidget.hasModel()?this._codeEditorWidget.getContentHeight():this.inputCellEditorHeight,o=Math.min(t.height/2,i),s=this._notebookOptions.getCellEditorContainerLeftMargin(),n=o+E*2;this._notebookEditorContainer.style.height=`${t.height-n}px`,this._notebookWidget.value.layout(t.with(t.width,t.height-n),this._notebookEditorContainer,e),this._codeEditorWidget.layout(this._validateDimension(t.width-s-x,o)),this._inputFocusIndicator.style.height=`${i}px`,this._inputCellContainer.style.top=`${t.height-n}px`,this._inputCellContainer.style.width=`${t.width}px`}_validateDimension(t,e){return new d.Dimension(Math.max(0,t),Math.max(0,e))}_hasConflictingDecoration(){return!!this._codeEditorWidget.getLineDecorations(1)?.find(t=>t.options.beforeContentClassName||t.options.afterContentClassName||t.options.before?.content||t.options.after?.content)}_updateInputHint(){if(!this._codeEditorWidget)return;const t=!this._codeEditorWidget.hasModel()||this._configurationService.getValue(w.showExecutionHint)===!1||this._codeEditorWidget.getModel().getValueLength()!==0||this._hasConflictingDecoration();!this._hintElement&&!t?this._hintElement=this._instantiationService.createInstance(Ot,this._codeEditorWidget):this._hintElement&&t&&(this._hintElement.dispose(),this._hintElement=void 0)}getScrollPosition(){return{scrollTop:this._notebookWidget.value?.scrollTop??0,scrollLeft:0}}setScrollPosition(t){this._notebookWidget.value?.setScrollTop(t.scrollTop)}focus(){super.focus(),this._notebookWidget.value?.onShow(),this._codeEditorWidget.focus()}focusHistory(){this._notebookWidget.value.focus()}setEditorVisible(t){super.setEditorVisible(t),this._groupListener.value=this.group.onWillCloseEditor(e=>this._saveEditorViewState(e.editor)),t||(this._saveEditorViewState(this.input),this.input&&this._notebookWidget.value&&this._notebookWidget.value.onWillHide()),this._updateInputHint()}clearInput(){this._notebookWidget.value&&(this._saveEditorViewState(this.input),this._notebookWidget.value.onWillHide()),this._codeEditorWidget?.dispose(),this._notebookWidget={value:void 0},this._widgetDisposableStore.clear(),super.clearInput()}getControl(){return{notebookEditor:this._notebookWidget.value,activeCodeEditor:this._codeEditorWidget,onDidChangeActiveEditor:F.None}}};f=M([a(1,X),a(2,Z),a(3,q),a(4,J),a(5,it),a(6,O),a(7,z),a(8,at),a(9,lt),a(10,ht),a(11,pt),a(12,ct),a(13,vt),a(14,nt),a(15,ft),a(16,Dt),a(17,wt)],f);export{f as InteractiveEditor};
