var H=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var b=(c,a,e,n)=>{for(var o=n>1?void 0:n?B(a,e):a,t=c.length-1,i;t>=0;t--)(i=c[t])&&(o=(n?i(a,e,o):i(o))||o);return n&&o&&H(a,e,o),o},r=(c,a)=>(e,n)=>a(e,n,c);import{Registry as M}from"../../../../platform/registry/common/platform.js";import{registerWorkbenchContribution2 as K,WorkbenchPhase as D}from"../../../common/contributions.js";import{Disposable as P,MutableDisposable as T}from"../../../../base/common/lifecycle.js";import{ContextKeyExpr as k,IContextKeyService as S,RawContextKey as y}from"../../../../platform/contextkey/common/contextkey.js";import"../../../../platform/instantiation/common/instantiation.js";import{ICommandService as R}from"../../../../platform/commands/common/commands.js";import{ITelemetryService as E}from"../../../../platform/telemetry/common/telemetry.js";import{IAuthenticationService as N}from"../../../services/authentication/common/authentication.js";import{Action2 as q,MenuId as L,registerAction2 as W}from"../../../../platform/actions/common/actions.js";import{IActivityService as _,NumberBadge as z}from"../../../services/activity/common/activity.js";import{IProductService as I}from"../../../../platform/product/common/productService.js";import{IExtensionManagementService as O}from"../../../../platform/extensionManagement/common/extensionManagement.js";import{ExtensionIdentifier as g}from"../../../../platform/extensions/common/extensions.js";import{IStorageService as x,StorageScope as h,StorageTarget as C}from"../../../../platform/storage/common/storage.js";import{IExtensionService as F}from"../../../services/extensions/common/extensions.js";import{Extensions as G,ConfigurationScope as J}from"../../../../platform/configuration/common/configurationRegistry.js";import{applicationConfigurationNodeBase as U}from"../../../common/configuration.js";import{localize as V}from"../../../../nls.js";import{IConfigurationService as $}from"../../../../platform/configuration/common/configuration.js";import{IRequestService as j,asText as Q}from"../../../../platform/request/common/request.js";import{CancellationToken as X}from"../../../../base/common/cancellation.js";import{IDialogService as Y}from"../../../../platform/dialogs/common/dialogs.js";import{isWeb as Z}from"../../../../base/common/platform.js";const s="workbench.accounts.experimental.showEntitlements";let m=class extends P{constructor(e,n,o,t,i,l,u,v,f,d){super();this.contextService=e;this.telemetryService=n;this.authenticationService=o;this.productService=t;this.storageService=i;this.extensionManagementService=l;this.activityService=u;this.extensionService=v;this.configurationService=f;this.requestService=d;!(!this.productService.gitHubEntitlement||Z)&&this.extensionManagementService.getInstalled().then(async p=>{p.find(w=>g.equals(w.identifier.id,this.productService.gitHubEntitlement.extensionId))?this.disableEntitlements():this.registerListeners()})}isInitialized=!1;showAccountsBadgeContextKey=new y(s,!1).bindTo(this.contextService);accountsMenuBadgeDisposable=this._register(new T);registerListeners(){this.storageService.getBoolean(s,h.APPLICATION)!==!1&&(this._register(this.extensionService.onDidChangeExtensions(async e=>{for(const n of e.added)if(g.equals(this.productService.gitHubEntitlement.extensionId,n.identifier)){this.disableEntitlements();return}})),this._register(this.authenticationService.onDidChangeSessions(async e=>{e.providerId===this.productService.gitHubEntitlement.providerId&&e.event.added?.length?await this.enableEntitlements(e.event.added[0]):e.providerId===this.productService.gitHubEntitlement.providerId&&e.event.removed?.length&&(this.showAccountsBadgeContextKey.set(!1),this.accountsMenuBadgeDisposable.clear())})),this._register(this.authenticationService.onDidRegisterAuthenticationProvider(async e=>{e.id===this.productService.gitHubEntitlement.providerId&&await this.enableEntitlements((await this.authenticationService.getSessions(e.id))[0])})))}async getEntitlementsInfo(e){if(this.isInitialized)return[!1,""];const n=await this.requestService.request({type:"GET",url:this.productService.gitHubEntitlement.entitlementUrl,headers:{Authorization:`Bearer ${e.accessToken}`}},X.None);if(n.res.statusCode&&n.res.statusCode!==200)return[!1,""];const o=await Q(n);if(!o)return[!1,""];let t;try{t=JSON.parse(o)}catch{return[!1,""]}if(!(this.productService.gitHubEntitlement.enablementKey in t)||!t[this.productService.gitHubEntitlement.enablementKey])return this.telemetryService.publicLog2("entitlements.enabled",{enabled:!1}),[!1,""];this.telemetryService.publicLog2("entitlements.enabled",{enabled:!0}),this.isInitialized=!0;const i=t.organization_list;return[!0,i&&i.length>0?i[0].name?i[0].name:i[0].login:void 0]}async enableEntitlements(e){if(!e)return;if((await this.extensionManagementService.getInstalled()).find(u=>g.equals(u.identifier.id,this.productService.gitHubEntitlement.extensionId))){this.disableEntitlements();return}const t=this.configurationService.inspect(s).value??!1,[i,l]=await this.getEntitlementsInfo(e);i&&t&&(this.createAccountsBadge(l),this.showAccountsBadgeContextKey.set(t),this.telemetryService.publicLog2(s,{enabled:!0}))}disableEntitlements(){this.storageService.store(s,!1,h.APPLICATION,C.MACHINE),this.showAccountsBadgeContextKey.set(!1),this.accountsMenuBadgeDisposable.clear()}async createAccountsBadge(e){const n=e?this.productService.gitHubEntitlement.command.title.replace("{{org}}",e):this.productService.gitHubEntitlement.command.titleWithoutPlaceHolder,o=new z(1,()=>n);this.accountsMenuBadgeDisposable.value=this.activityService.showAccountsActivity({badge:o}),this.contextService.onDidChangeContext(t=>{t.affectsSome(new Set([s]))&&(this.contextService.getContextKeyValue(s)||this.accountsMenuBadgeDisposable.clear())}),this._register(W(class extends q{constructor(){super({id:"workbench.action.entitlementAction",title:n,f1:!1,menu:{id:L.AccountsContext,group:"5_AccountsEntitlements",when:k.equals(s,!0)}})}async run(t){const i=t.get(I),l=t.get(R),u=t.get(S),v=t.get(x),f=t.get(Y),d=t.get(E);(await f.confirm({type:"question",message:i.gitHubEntitlement.confirmationMessage,primaryButton:i.gitHubEntitlement.confirmationAction})).confirmed?(l.executeCommand(i.gitHubEntitlement.command.action,i.gitHubEntitlement.extensionId),d.publicLog2("accountsEntitlements.action",{command:i.gitHubEntitlement.command.action})):d.publicLog2("accountsEntitlements.action",{command:i.gitHubEntitlement.command.action+"-dismissed"}),new y(s,!1).bindTo(u).set(!1),v.store(s,!1,h.APPLICATION,C.MACHINE)}}))}};m=b([r(0,S),r(1,E),r(2,N),r(3,I),r(4,x),r(5,O),r(6,_),r(7,F),r(8,$),r(9,j)],m);const ee=M.as(G.Configuration);ee.registerConfiguration({...U,properties:{"workbench.accounts.experimental.showEntitlements":{scope:J.MACHINE,type:"boolean",default:!1,tags:["experimental"],description:V("workbench.accounts.showEntitlements","When enabled, available entitlements for the account will be show in the accounts menu.")}}}),K("workbench.contrib.entitlements",m,D.BlockRestore);
