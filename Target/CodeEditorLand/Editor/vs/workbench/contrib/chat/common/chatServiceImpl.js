var Re=Object.defineProperty;var ye=Object.getOwnPropertyDescriptor;var Y=(R,m,e,s)=>{for(var t=s>1?void 0:s?ye(m,e):m,n=R.length-1,i;n>=0;n--)(i=R[n])&&(t=(s?i(m,e,t):i(t))||t);return s&&t&&Re(m,e,t),t},u=(R,m)=>(e,s)=>m(e,s,R);import{DeferredPromise as we}from"../../../../base/common/async.js";import{CancellationToken as H,CancellationTokenSource as Z}from"../../../../base/common/cancellation.js";import{toErrorMessage as De}from"../../../../base/common/errorMessage.js";import{ErrorNoTelemetry as ee}from"../../../../base/common/errors.js";import{Emitter as te}from"../../../../base/common/event.js";import{MarkdownString as x}from"../../../../base/common/htmlContent.js";import{Iterable as Ae}from"../../../../base/common/iterator.js";import{Disposable as qe,DisposableMap as j}from"../../../../base/common/lifecycle.js";import{revive as se}from"../../../../base/common/marshalling.js";import{StopWatch as Pe}from"../../../../base/common/stopwatch.js";import{URI as ne}from"../../../../base/common/uri.js";import{localize as ie}from"../../../../nls.js";import{IConfigurationService as be}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as _e}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as Te}from"../../../../platform/instantiation/common/instantiation.js";import{ILogService as Me}from"../../../../platform/log/common/log.js";import{Progress as ke}from"../../../../platform/progress/common/progress.js";import{IStorageService as Ee,StorageScope as v,StorageTarget as z}from"../../../../platform/storage/common/storage.js";import{ITelemetryService as Fe}from"../../../../platform/telemetry/common/telemetry.js";import{IWorkspaceContextService as $e}from"../../../../platform/workspace/common/workspace.js";import{ChatAgentLocation as _,IChatAgentService as Oe}from"./chatAgents.js";import{CONTEXT_VOTE_UP_ENABLED as xe}from"./chatContextKeys.js";import{ChatModel as ae,ChatRequestModel as ze,ChatRequestRemovalReason as Le,ChatWelcomeMessageModel as Ne,normalizeSerializableChatData as We,updateRanges as oe}from"./chatModel.js";import{ChatRequestAgentPart as re,ChatRequestAgentSubcommandPart as ce,ChatRequestSlashCommandPart as Ue,chatAgentLeader as Ve,chatSubcommandLeader as He,getPromptText as de}from"./chatParserTypes.js";import{ChatRequestParser as le}from"./chatRequestParser.js";import{ChatServiceTelemetry as je}from"./chatServiceTelemetry.js";import{IChatSlashCommandService as Be}from"./chatSlashCommands.js";import{IChatVariablesService as Je}from"./chatVariables.js";import{ChatMessageRole as he}from"./languageModels.js";import{IWorkbenchAssignmentService as Ke}from"../../../services/assignment/common/assignmentService.js";import{IExtensionService as Xe}from"../../../services/extensions/common/extensions.js";const L="interactive.sessions",N="chat.workspaceTransfer",ue=1e3*60,ge=25;class Qe{constructor(m,e){this.cancellationTokenSource=m;this.requestId=e}dispose(){this.cancellationTokenSource.dispose()}cancel(){this.cancellationTokenSource.cancel()}}let W=class extends qe{constructor(e,s,t,n,i,a,o,r,l,c,h,f){super();this.storageService=e;this.logService=s;this.extensionService=t;this.instantiationService=n;this.telemetryService=i;this.workspaceContextService=a;this.chatSlashCommandService=o;this.chatVariablesService=r;this.chatAgentService=l;this.configurationService=f;this._chatServiceTelemetry=this.instantiationService.createInstance(je);const g=!a.getWorkspace().folders.length,T=e.get(L,g?v.APPLICATION:v.WORKSPACE,"");if(T){this._persistedSessions=this.deserializeChats(T);const A=Object.keys(this._persistedSessions).length;A>0&&this.trace("constructor",`Restored ${A} persisted sessions`)}else this._persistedSessions={};const M=this.getTransferredSessionData(),C=M?.chat;C&&(this.trace("constructor",`Transferred session ${C.sessionId}`),this._persistedSessions[C.sessionId]=C,this._transferredSessionData={sessionId:C.sessionId,inputValue:M.inputValue}),this._register(e.onWillSaveState(()=>this.saveState()));const E=xe.bindTo(h);c.getTreatment("chatVoteUpEnabled").then(A=>E.set(!!A))}_sessionModels=this._register(new j);_pendingRequests=this._register(new j);_persistedSessions;_deletedChatIds=new Set;_transferredSessionData;get transferredSessionData(){return this._transferredSessionData}_onDidPerformUserAction=this._register(new te);onDidPerformUserAction=this._onDidPerformUserAction.event;_onDidDisposeSession=this._register(new te);onDidDisposeSession=this._onDidDisposeSession.event;_sessionFollowupCancelTokens=this._register(new j);_chatServiceTelemetry;isEnabled(e){return this.chatAgentService.getContributedDefaultAgent(e)!==void 0}saveState(){const e=Array.from(this._sessionModels.values()).filter(t=>t.initialLocation===_.Panel).filter(t=>t.getRequests().length>0);if(!this.workspaceContextService.getWorkspace().folders.length)this.syncEmptyWindowChats(e);else{let t=e;t=t.concat(Object.values(this._persistedSessions).filter(i=>!this._sessionModels.has(i.sessionId)).filter(i=>i.requests.length)),t.sort((i,a)=>(a.creationDate??0)-(i.creationDate??0)),t=t.slice(0,ge),t.length&&this.trace("onWillSaveState",`Persisting ${t.length} sessions`);const n=JSON.stringify(t);t.length&&this.trace("onWillSaveState",`Persisting ${n.length} chars`),this.storageService.store(L,n,v.WORKSPACE,z.MACHINE)}this._deletedChatIds.clear()}syncEmptyWindowChats(e){const s=this.storageService.get(L,v.APPLICATION,""),t=this._persistedSessions;let n;if(s){n=this.deserializeChats(s);const r=Object.keys(n).length;r>0&&this.trace("constructor",`Restored ${r} persisted sessions`)}else n={};this._deletedChatIds.forEach(r=>delete n[r]),Object.values(t).forEach(r=>{const l=n[r.sessionId];l&&r.requests.length>l.requests.length?n[r.sessionId]=r:!l&&r.isNew&&(r.isNew=!1,n[r.sessionId]=r)}),this._persistedSessions=n;const i={...this._persistedSessions};for(const r of e)i[r.sessionId]=r;let a=Object.values(i);a.sort((r,l)=>(l.creationDate??0)-(r.creationDate??0)),a=a.slice(0,ge);const o=JSON.stringify(a);this.storageService.store(L,o,v.APPLICATION,z.MACHINE)}notifyUserAction(e){this._chatServiceTelemetry.notifyUserAction(e),this._onDidPerformUserAction.fire(e)}setChatSessionTitle(e,s){const t=this._sessionModels.get(e);if(t){t.setCustomTitle(s);return}const n=this._persistedSessions[e];n&&(n.customTitle=s)}trace(e,s){s?this.logService.trace(`ChatService#${e}: ${s}`):this.logService.trace(`ChatService#${e}`)}error(e,s){this.logService.error(`ChatService#${e} ${s}`)}deserializeChats(e){try{const s=se(JSON.parse(e));if(!Array.isArray(s))throw new Error("Expected array");return s.reduce((n,i)=>{for(const a of i.requests)Array.isArray(a.response)?a.response=a.response.map(o=>typeof o=="string"?new x(o):o):typeof a.response=="string"&&(a.response=[new x(a.response)]);return n[i.sessionId]=We(i),n},{})}catch(s){return this.error("deserializeChats",`Malformed session data: ${s}. [${e.substring(0,20)}${e.length>20?"...":""}]`),{}}}getTransferredSessionData(){const e=this.storageService.getObject(N,v.PROFILE,[]),s=this.workspaceContextService.getWorkspace().folders[0]?.uri;if(!s)return;const t=s.toString(),n=Date.now(),i=e.find(o=>ne.revive(o.toWorkspace).toString()===t&&n-o.timestampInMilliseconds<ue),a=e.filter(o=>ne.revive(o.toWorkspace).toString()!==t&&n-o.timestampInMilliseconds<ue);return this.storageService.store(N,JSON.stringify(a),v.PROFILE,z.MACHINE),i}getHistory(){const s=Object.values(this._persistedSessions).filter(n=>n.requests.length>0).filter(n=>!this._sessionModels.has(n.sessionId)).filter(n=>!n.isImported).map(n=>{const i=n.customTitle??ae.getDefaultTitle(n.requests);return{sessionId:n.sessionId,title:i,lastMessageDate:n.lastMessageDate,isActive:!1}});return[...Array.from(this._sessionModels.values()).filter(n=>!n.isImported).map(n=>{const i=n.title||ie("newChat","New Chat");return{sessionId:n.sessionId,title:i,lastMessageDate:n.lastMessageDate,isActive:!0}}),...s]}removeHistoryEntry(e){this._persistedSessions[e]&&(this._deletedChatIds.add(e),delete this._persistedSessions[e],this.saveState())}clearAllHistoryEntries(){Object.values(this._persistedSessions).forEach(e=>this._deletedChatIds.add(e.sessionId)),this._persistedSessions={},this.saveState()}startSession(e,s){return this.trace("startSession"),this._startSession(void 0,e,s)}_startSession(e,s,t){const n=this.instantiationService.createInstance(ae,e,s);return this._sessionModels.set(n.sessionId,n),this.initializeSession(n,t),n}async initializeSession(e,s){try{this.trace("initializeSession",`Initialize session ${e.sessionId}`),e.startInitialize(),await this.extensionService.whenInstalledExtensionsRegistered();const t=this.chatAgentService.getContributedDefaultAgent(e.initialLocation)??this.chatAgentService.getContributedDefaultAgent(_.Panel);if(!t)throw new ee("No default agent contributed");await this.extensionService.activateByEvent(`onChatParticipant:${t.id}`);const n=this.chatAgentService.getActivatedAgents().find(o=>o.id===t.id);if(!n)throw new ee("No default agent registered");const i=e.welcomeMessage?void 0:await n.provideWelcomeMessage?.(e.initialLocation,s)??void 0,a=i&&this.instantiationService.createInstance(Ne,i.map(o=>typeof o=="string"?new x(o):o),await n.provideSampleQuestions?.(e.initialLocation,s)??[]);e.initialize(a)}catch(t){this.trace("startSession",`initializeSession failed: ${t}`),e.setInitializationError(t),this._sessionModels.deleteAndDispose(e.sessionId),this._onDidDisposeSession.fire({sessionId:e.sessionId,reason:"initializationFailed"})}}getSession(e){return this._sessionModels.get(e)}getOrRestoreSession(e){this.trace("getOrRestoreSession",`sessionId: ${e}`);const s=this._sessionModels.get(e);if(s)return s;const t=se(this._persistedSessions[e]);if(t)return e===this.transferredSessionData?.sessionId&&(this._transferredSessionData=void 0),this._startSession(t,t.initialLocation??_.Panel,H.None)}loadSessionFromContent(e){return this._startSession(e,e.initialLocation??_.Panel,H.None)}async resendRequest(e,s){const t=this._sessionModels.get(e.session.sessionId);if(!t&&t!==e.session)throw new Error(`Unknown session: ${e.session.sessionId}`);await t.waitForInitialization();const n=this._pendingRequests.get(e.session.sessionId);n&&(this.trace("resendRequest",`Session ${e.session.sessionId} already has a pending request, cancelling...`),n.cancel());const i=s?.location??t.initialLocation,a=s?.attempt??0,o=!s?.noCommandDetection,r=this.chatAgentService.getDefaultAgent(i);t.removeRequest(e.id,Le.Resend);const l={...s,locationData:e.locationData,attachedContext:e.attachedContext};await this._sendRequestAsync(t,t.sessionId,e.message,a,o,r,i,l).responseCompletePromise}async sendRequest(e,s,t){if(this.trace("sendRequest",`sessionId: ${e}, message: ${s.substring(0,20)}${s.length>20?"[...]":""}}`),!s.trim()&&!t?.slashCommand&&!t?.agentId){this.trace("sendRequest","Rejected empty message");return}const n=this._sessionModels.get(e);if(!n)throw new Error(`Unknown session: ${e}`);if(await n.waitForInitialization(),this._pendingRequests.has(e)){this.trace("sendRequest",`Session ${e} already has a pending request`);return}const i=t?.location??n.initialLocation,a=t?.attempt??0,o=this.chatAgentService.getDefaultAgent(i),r=this.parseChatRequest(e,s,i,t),l=r.parts.find(h=>h instanceof re)?.agent??o,c=r.parts.find(h=>h instanceof ce);return{...this._sendRequestAsync(n,e,r,a,!t?.noCommandDetection,o,i,t),agent:l,slashCommand:c?.command}}parseChatRequest(e,s,t,n){let i=n?.parserContext;if(n?.agentId){const o=this.chatAgentService.getAgent(n.agentId);if(!o)throw new Error(`Unknown agent: ${n.agentId}`);i={selectedAgent:o};const r=n.slashCommand?` ${He}${n.slashCommand}`:"";s=`${Ve}${o.name}${r} ${s}`}return this.instantiationService.createInstance(le).parseChatRequest(e,s,t,i)}refreshFollowupsCancellationToken(e){this._sessionFollowupCancelTokens.get(e)?.cancel();const s=new Z;return this._sessionFollowupCancelTokens.set(e,s),s.token}_sendRequestAsync(e,s,t,n,i,a,o,r){const l=this.refreshFollowupsCancellationToken(s);let c;const h="kind"in t?void 0:t.parts.find(S=>S instanceof re),f="kind"in t?void 0:t.parts.find(S=>S instanceof ce),g="kind"in t?void 0:t.parts.find(S=>S instanceof Ue),T=[...e.getRequests()];let M=!1;const C=g?"slashCommand":"string",E=new we;let A=!1;function k(){!A&&c?.response&&(E.complete(c.response),A=!0)}const B=new Z,q=B.token,J=(async()=>{const S=d=>{q.isCancellationRequested||(M=!0,d.kind==="markdownContent"?this.trace("sendRequest",`Provider returned progress for session ${e.sessionId}, ${d.content.value.length} chars`):this.trace("sendRequest",`Provider returned progress: ${JSON.stringify(d)}`),e.acceptResponseProgress(c,d),k())};let P,K;const pe=new Pe(!1),fe=q.onCancellationRequested(()=>{this.trace("sendRequest",`Request for session ${e.sessionId} was cancelled`),this.telemetryService.publicLog2("interactiveSessionProviderInvoked",{timeToFirstProgress:void 0,totalTime:pe.elapsed(),result:"cancelled",requestType:C,agent:h?.agent.id??"",agentExtensionId:h?.agent.extensionId.value??"",slashCommand:f?f.command.name:g?.slashCommand.command,chatSessionId:e.sessionId,location:o,citations:c?.response?.codeCitations.length??0,numCodeBlocks:me(c.response?.response.toString()??"").length,isParticipantDetected:!!P}),e.cancelRequest(c)});try{let d,b,F;if(h||a&&!g){const y=async($,O,D,Ce,Se)=>{const Ie={variables:[]};c=Ce??e.addRequest(t,Ie,n,$,O,r?.confirmation,r?.locationData,r?.attachedContext);const Q=await this.chatVariablesService.resolveVariables(t,c.attachedContext,e,S,q);e.updateRequest(c,Q);const G=de(c.message),ve=oe(Q,G.diff);return{sessionId:s,requestId:c.id,agentId:$.id,message:G.message,command:O?.name,variables:ve,enableCommandDetection:D,isParticipantDetected:Se,attempt:n,location:o,locationData:c.locationData,acceptedConfirmationData:r?.acceptedConfirmationData,rejectedConfirmationData:r?.rejectedConfirmationData}};if(this.configurationService.getValue("chat.experimental.detectParticipant.enabled")!==!1&&this.chatAgentService.hasChatParticipantDetectionProviders()&&!h&&!g&&i){const $=this.getHistoryEntriesFromModel(T,e.sessionId,o,a.id),O=await y(a,f?.command,i,void 0,!1),D=await this.chatAgentService.detectAgentOrCommand(O,$,{location:o},q);D&&this.chatAgentService.getAgent(D.agent.id)?.locations?.includes(o)&&(c.response?.setAgent(D.agent,D.command),P=D.agent,K=D.command)}const p=P??h?.agent??a,I=K??f?.command;await this.extensionService.activateByEvent(`onChatParticipant:${p.id}`);const w=this.getHistoryEntriesFromModel(T,e.sessionId,o,p.id),U=await y(p,I,i,c,!!P),V=this._pendingRequests.get(s);V&&!V.requestId&&(V.requestId=U.requestId),k();const X=await this.chatAgentService.invokeAgent(p.id,U,S,w,q);d=X,b=this.chatAgentService.getFollowups(p.id,U,X,w,l),F=e.getRequests().length===1&&!e.customTitle?this.chatAgentService.getChatTitle(a.id,this.getHistoryEntriesFromModel(e.getRequests(),e.sessionId,o,p.id),H.None):void 0}else if(g&&this.chatSlashCommandService.hasCommand(g.slashCommand.command)){c=e.addRequest(t,{variables:[]},n),k();const y=[];for(const w of e.getRequests())w.response&&(y.push({role:he.User,content:[{type:"text",value:w.message.text}]}),y.push({role:he.Assistant,content:[{type:"text",value:w.response.response.toString()}]}));const p=t.text,I=await this.chatSlashCommandService.executeCommand(g.slashCommand.command,p.substring(g.slashCommand.command.length+1).trimStart(),new ke(w=>{S(w)}),y,o,q);b=Promise.resolve(I?.followUp),d={}}else throw new Error("Cannot handle request");if(q.isCancellationRequested)return;{d||(this.trace("sendRequest",`Provider returned no response for session ${e.sessionId}`),d={errorDetails:{message:ie("emptyResponse","Provider returned null response")}});const y=d.errorDetails?.responseIsFiltered?"filtered":d.errorDetails&&M?"errorWithOutput":d.errorDetails?"error":"success",p=f?f.command.name:g?.slashCommand.command;this.telemetryService.publicLog2("interactiveSessionProviderInvoked",{timeToFirstProgress:d.timings?.firstProgress,totalTime:d.timings?.totalElapsed,result:y,requestType:C,agent:h?.agent.id??"",agentExtensionId:h?.agent.extensionId.value??"",slashCommand:p,chatSessionId:e.sessionId,isParticipantDetected:!!P,location:o,citations:c.response?.codeCitations.length??0,numCodeBlocks:me(c.response?.response.toString()??"").length}),e.setResponse(c,d),k(),this.trace("sendRequest",`Provider returned response for session ${e.sessionId}`),e.completeResponse(c),b&&b.then(I=>{e.setFollowups(c,I),this._chatServiceTelemetry.retrievedFollowups(h?.agent.id??"",p,I?.length??0)}),F?.then(I=>{I&&e.setCustomTitle(I)})}}catch(d){const b="error";if(this.telemetryService.publicLog2("interactiveSessionProviderInvoked",{timeToFirstProgress:void 0,totalTime:void 0,result:b,requestType:C,agent:h?.agent.id??"",agentExtensionId:h?.agent.extensionId.value??"",slashCommand:f?f.command.name:g?.slashCommand.command,chatSessionId:e.sessionId,location:o,citations:0,numCodeBlocks:0,isParticipantDetected:!!P}),this.logService.error(`Error while handling chat request: ${De(d,!0)}`),c){const F={errorDetails:{message:d.message}};e.setResponse(c,F),k(),e.completeResponse(c)}}finally{fe.dispose()}})();return this._pendingRequests.set(e.sessionId,new Qe(B)),J.finally(()=>{this._pendingRequests.deleteAndDispose(e.sessionId)}),{responseCreatedPromise:E.p,responseCompletePromise:J}}getHistoryEntriesFromModel(e,s,t,n){const i=[];for(const a of e){if(!a.response)continue;const o=this.chatAgentService.getDefaultAgent(t)?.id;if(n!==a.response.agent?.id&&n!==o)continue;const r=de(a.message),l={sessionId:s,requestId:a.id,agentId:a.response.agent?.id??"",message:r.message,command:a.response.slashCommand?.name,variables:oe(a.variableData,r.diff),location:_.Panel};i.push({request:l,response:a.response.response.value,result:a.response.result??{}})}return i}async removeRequest(e,s){const t=this._sessionModels.get(e);if(!t)throw new Error(`Unknown session: ${e}`);await t.waitForInitialization();const n=this._pendingRequests.get(e);n?.requestId===s&&(n.cancel(),this._pendingRequests.deleteAndDispose(e)),t.removeRequest(s)}async adoptRequest(e,s){if(!(s instanceof ze))throw new TypeError("Can only adopt requests of type ChatRequestModel");const t=this._sessionModels.get(e);if(!t)throw new Error(`Unknown session: ${e}`);await t.waitForInitialization();const n=s.session;if(t.adoptRequest(s),s.response&&!s.response.isComplete){const i=this._pendingRequests.deleteAndLeak(n.sessionId);i&&(i.requestId=s.id,this._pendingRequests.set(t.sessionId,i))}}async addCompleteRequest(e,s,t,n,i){this.trace("addCompleteRequest",`message: ${s}`);const a=this._sessionModels.get(e);if(!a)throw new Error(`Unknown session: ${e}`);await a.waitForInitialization();const o=typeof s=="string"?this.instantiationService.createInstance(le).parseChatRequest(e,s):s,r=a.addRequest(o,t||{variables:[]},n??0);if(typeof i.message=="string")a.acceptResponseProgress(r,{content:new x(i.message),kind:"markdownContent"});else for(const l of i.message)a.acceptResponseProgress(r,l,!0);a.setResponse(r,i.result||{}),i.followups!==void 0&&a.setFollowups(r,i.followups),a.completeResponse(r)}cancelCurrentRequestForSession(e){this.trace("cancelCurrentRequestForSession",`sessionId: ${e}`),this._pendingRequests.get(e)?.cancel(),this._pendingRequests.deleteAndDispose(e)}clearSession(e){this.trace("clearSession",`sessionId: ${e}`);const s=this._sessionModels.get(e);if(!s)throw new Error(`Unknown session: ${e}`);if(s.initialLocation===_.Panel){const t=JSON.parse(JSON.stringify(s));t.isNew=!0,this._persistedSessions[e]=t}this._sessionModels.deleteAndDispose(e),this._pendingRequests.get(e)?.cancel(),this._pendingRequests.deleteAndDispose(e),this._onDidDisposeSession.fire({sessionId:e,reason:"cleared"})}hasSessions(){return!!Object.values(this._persistedSessions)}transferChatSession(e,s){const t=Ae.find(this._sessionModels.values(),i=>i.sessionId===e.sessionId);if(!t)throw new Error(`Failed to transfer session. Unknown session ID: ${e.sessionId}`);const n=this.storageService.getObject(N,v.PROFILE,[]);n.push({chat:t.toJSON(),timestampInMilliseconds:Date.now(),toWorkspace:s,inputValue:e.inputValue}),this.storageService.store(N,JSON.stringify(n),v.PROFILE,z.MACHINE),this.trace("transferChatSession",`Transferred session ${t.sessionId} to workspace ${s.toString()}`)}};W=Y([u(0,Ee),u(1,Me),u(2,Xe),u(3,Te),u(4,Fe),u(5,$e),u(6,Be),u(7,Je),u(8,Oe),u(9,Ke),u(10,_e),u(11,be)],W);function me(R){const m=R.split(`
`),e=[];let s;for(let t=0;t<m.length;t++){const n=m[t];if(s)new RegExp(`^\\s*${s.delimiter}\\s*$`).test(n)&&(e.push(s.languageId),s=void 0);else{const i=n.match(/^(\s*)(`{3,}|~{3,})(\w*)/);i&&(s={delimiter:i[2],languageId:i[3]})}}return e}export{W as ChatService};
