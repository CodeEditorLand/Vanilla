var b=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var C=(r,t,e,n)=>{for(var a=n>1?void 0:n?x(t,e):t,i=r.length-1,o;i>=0;i--)(o=r[i])&&(a=(n?o(t,e,a):o(a))||a);return n&&a&&b(t,e,a),a},l=(r,t)=>(e,n)=>t(e,n,r);import{findLast as R}from"../../../../base/common/arraysFind.js";import{timeout as w}from"../../../../base/common/async.js";import{CancellationToken as k}from"../../../../base/common/cancellation.js";import{Emitter as T}from"../../../../base/common/event.js";import{Iterable as I}from"../../../../base/common/iterator.js";import{toDisposable as p}from"../../../../base/common/lifecycle.js";import{revive as E}from"../../../../base/common/marshalling.js";import{observableValue as S}from"../../../../base/common/observable.js";import{equalsIgnoreCase as _}from"../../../../base/common/strings.js";import{ContextKeyExpr as D,IContextKeyService as N}from"../../../../platform/contextkey/common/contextkey.js";import{ExtensionIdentifier as q}from"../../../../platform/extensions/common/extensions.js";import{createDecorator as P}from"../../../../platform/instantiation/common/instantiation.js";import{ILogService as L}from"../../../../platform/log/common/log.js";import{IProductService as M}from"../../../../platform/product/common/productService.js";import{IRequestService as H,asJson as F}from"../../../../platform/request/common/request.js";import{IStorageService as O,StorageScope as A,StorageTarget as K}from"../../../../platform/storage/common/storage.js";import{CONTEXT_CHAT_ENABLED as B,CONTEXT_CHAT_PANEL_PARTICIPANT_REGISTERED as Q}from"./chatContextKeys.js";var f=(a=>(a.Panel="panel",a.Terminal="terminal",a.Notebook="notebook",a.Editor="editor",a))(f||{});(t=>{function r(e){switch(e){case"panel":return"panel";case"terminal":return"terminal";case"notebook":return"notebook";case"editor":return"editor"}return"panel"}t.fromRaw=r})(f||={});const gt=P("chatAgentService");let m=class{constructor(t){this.contextKeyService=t;this._hasDefaultAgent=B.bindTo(this.contextKeyService),this._defaultAgentRegistered=Q.bindTo(this.contextKeyService)}static AGENT_LEADER="@";_agents=new Map;_onDidChangeAgents=new T;onDidChangeAgents=this._onDidChangeAgents.event;_hasDefaultAgent;_defaultAgentRegistered;registerAgent(t,e){if(this.getAgent(t))throw new Error(`Agent already registered: ${JSON.stringify(t)}`);e.isDefault&&this._defaultAgentRegistered.set(!0);const a=this,i=e.slashCommands;e={...e,get slashCommands(){return i.filter(g=>!g.when||a.contextKeyService.contextMatchesRules(D.deserialize(g.when)))}};const o={data:e};return this._agents.set(t,o),this._onDidChangeAgents.fire(void 0),p(()=>{this._agents.delete(t),e.isDefault&&this._defaultAgentRegistered.set(!1),this._onDidChangeAgents.fire(void 0)})}registerAgentImplementation(t,e){const n=this._agents.get(t);if(!n)throw new Error(`Unknown agent: ${JSON.stringify(t)}`);if(n.impl)throw new Error(`Agent already has implementation: ${JSON.stringify(t)}`);return n.data.isDefault&&this._hasDefaultAgent.set(!0),n.impl=e,this._onDidChangeAgents.fire(new u(n.data,e)),p(()=>{n.impl=void 0,this._onDidChangeAgents.fire(void 0),n.data.isDefault&&this._hasDefaultAgent.set(!1)})}registerDynamicAgent(t,e){t.isDynamic=!0;const n={data:t,impl:e};return this._agents.set(t.id,n),this._onDidChangeAgents.fire(new u(t,e)),p(()=>{this._agents.delete(t.id),this._onDidChangeAgents.fire(void 0)})}_agentCompletionProviders=new Map;registerAgentCompletionProvider(t,e){return this._agentCompletionProviders.set(t,e),{dispose:()=>{this._agentCompletionProviders.delete(t)}}}async getAgentCompletionItems(t,e,n){return await this._agentCompletionProviders.get(t)?.(e,n)??[]}updateAgent(t,e){const n=this._agents.get(t);if(!n?.impl)throw new Error(`No activated agent with id ${JSON.stringify(t)} registered`);n.data.metadata={...n.data.metadata,...e},this._onDidChangeAgents.fire(new u(n.data,n.impl))}getDefaultAgent(t){return R(this.getActivatedAgents(),e=>!!e.isDefault&&e.locations.includes(t))}getContributedDefaultAgent(t){return this.getAgents().find(e=>!!e.isDefault&&e.locations.includes(t))}getSecondaryAgent(){return I.find(this._agents.values(),t=>!!t.data.metadata.isSecondary)?.data}getAgent(t){if(this._agentIsEnabled(t))return this._agents.get(t)?.data}_agentIsEnabled(t){const e=this._agents.get(t);return!e?.data.when||this.contextKeyService.contextMatchesRules(D.deserialize(e.data.when))}getAgentByFullyQualifiedId(t){const e=I.find(this._agents.values(),n=>j(n.data)===t)?.data;if(!(e&&!this._agentIsEnabled(e.id)))return e}getAgents(){return Array.from(this._agents.values()).map(t=>t.data).filter(t=>this._agentIsEnabled(t.id))}getActivatedAgents(){return Array.from(this._agents.values()).filter(t=>!!t.impl).filter(t=>this._agentIsEnabled(t.data.id)).map(t=>new u(t.data,t.impl))}getAgentsByName(t){return this.getAgents().filter(e=>e.name===t)}agentHasDupeName(t){const e=this.getAgent(t);return e?this.getAgentsByName(e.name).filter(n=>n.extensionId.value!==e.extensionId.value).length>0:!1}async invokeAgent(t,e,n,a,i){const o=this._agents.get(t);if(!o?.impl)throw new Error(`No activated agent with id "${t}"`);return await o.impl.invoke(e,n,a,i)}async getFollowups(t,e,n,a,i){const o=this._agents.get(t);if(!o?.impl)throw new Error(`No activated agent with id "${t}"`);return o.impl?.provideFollowups?o.impl.provideFollowups(e,n,a,i):[]}async getChatTitle(t,e,n){const a=this._agents.get(t);if(!a?.impl)throw new Error(`No activated agent with id "${t}"`);if(a.impl?.provideChatTitle)return a.impl.provideChatTitle(e,n)}_chatParticipantDetectionProviders=new Map;registerChatParticipantDetectionProvider(t,e){return this._chatParticipantDetectionProviders.set(t,e),p(()=>{this._chatParticipantDetectionProviders.delete(t)})}hasChatParticipantDetectionProviders(){return this._chatParticipantDetectionProviders.size>0}async detectAgentOrCommand(t,e,n,a){const i=I.first(this._chatParticipantDetectionProviders.values());if(!i)return;const o=this.getAgents().reduce((d,c)=>{d.push({participant:c.id,disambiguation:c.disambiguation??[]});for(const v of c.slashCommands)d.push({participant:c.id,command:v.name,disambiguation:v.disambiguation??[]});return d},[]),g=await i.provideParticipantDetection(t,e,{...n,participants:o},a);if(!g)return;const h=this.getAgent(g.participant);if(!h)return;if(!g.command)return{agent:h};const y=h?.slashCommands.find(d=>d.name===g.command);if(y)return{agent:h,command:y}}};m=C([l(0,N)],m);class u{constructor(t,e){this.data=t;this.impl=e}when;publisherDisplayName;isDynamic;get id(){return this.data.id}get name(){return this.data.name??""}get fullName(){return this.data.fullName??""}get description(){return this.data.description??""}get extensionId(){return this.data.extensionId}get extensionPublisherId(){return this.data.extensionPublisherId}get extensionPublisherDisplayName(){return this.data.publisherDisplayName}get extensionDisplayName(){return this.data.extensionDisplayName}get isDefault(){return this.data.isDefault}get metadata(){return this.data.metadata}get slashCommands(){return this.data.slashCommands}get locations(){return this.data.locations}get disambiguation(){return this.data.disambiguation}async invoke(t,e,n,a){return this.impl.invoke(t,e,n,a)}async provideFollowups(t,e,n,a){return this.impl.provideFollowups?this.impl.provideFollowups(t,e,n,a):[]}provideWelcomeMessage(t,e){if(this.impl.provideWelcomeMessage)return this.impl.provideWelcomeMessage(t,e)}provideSampleQuestions(t,e){if(this.impl.provideSampleQuestions)return this.impl.provideSampleQuestions(t,e)}toJSON(){return this.data}}const lt=P("chatAgentNameService");let s=class{constructor(t,e,n,a){this.requestService=e;this.logService=n;this.storageService=a;if(!t.chatParticipantRegistry)return;this.url=t.chatParticipantRegistry;const i=a.get(s.StorageKey,A.APPLICATION);try{this.registry.set(JSON.parse(i??"{}"),void 0)}catch{a.remove(s.StorageKey,A.APPLICATION)}this.refresh()}static StorageKey="chat.participantNameRegistry";url;registry=S(this,Object.create(null));disposed=!1;refresh(){this.disposed||this.update().catch(t=>this.logService.warn("Failed to fetch chat participant registry",t)).then(()=>w(5*60*1e3)).then(()=>this.refresh())}async update(){const t=await this.requestService.request({type:"GET",url:this.url},k.None);if(t.res.statusCode!==200)throw new Error("Could not get extensions report.");const e=await F(t);if(!e||e.version!==1)throw new Error("Unexpected chat participant registry response.");const n=e.restrictedChatParticipants;this.registry.set(n,void 0),this.storageService.store(s.StorageKey,JSON.stringify(n),A.APPLICATION,K.MACHINE)}getAgentNameRestriction(t){const e=this.checkAgentNameRestriction(t.name,t).get(),n=!t.fullName||this.checkAgentNameRestriction(t.fullName.replace(/\s/g,""),t).get();return e&&n}checkAgentNameRestriction(t,e){return this.registry.map(a=>a[t.toLowerCase()]).map(a=>a?a.some(i=>_(i,i.includes(".")?e.extensionId.value:e.extensionPublisherId)):!0)}dispose(){this.disposed=!0}};s=C([l(0,M),l(1,H),l(2,L),l(3,O)],s);function j(r){return`${r.extensionId.value}.${r.id}`}function dt(r){const t="name"in r?r:{...r,name:r.id};return"extensionPublisherId"in t||(t.extensionPublisherId=t.extensionPublisher??""),"extensionDisplayName"in t||(t.extensionDisplayName=""),"extensionId"in t||(t.extensionId=new q("")),E(t)}export{f as ChatAgentLocation,s as ChatAgentNameService,m as ChatAgentService,lt as IChatAgentNameService,gt as IChatAgentService,u as MergedChatAgent,j as getFullyQualifiedId,dt as reviveSerializedAgent};
