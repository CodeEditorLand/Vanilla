var V=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var q=(R,u,t,a)=>{for(var r=a>1?void 0:a?T(u,t):u,e=R.length-1,o;e>=0;e--)(o=R[e])&&(r=(a?o(u,t,r):o(r))||r);return a&&r&&V(u,t,r),r},A=(R,u)=>(t,a)=>u(t,a,R);import{OffsetRange as v}from"../../../../editor/common/core/offsetRange.js";import{Position as y}from"../../../../editor/common/core/position.js";import{Range as S}from"../../../../editor/common/core/range.js";import{ChatAgentLocation as E,IChatAgentService as N}from"./chatAgents.js";import{ChatRequestAgentPart as b,ChatRequestAgentSubcommandPart as p,ChatRequestDynamicVariablePart as L,ChatRequestSlashCommandPart as x,ChatRequestTextPart as w,ChatRequestToolPart as D,ChatRequestVariablePart as M,chatAgentLeader as B,chatSubcommandLeader as _,chatVariableLeader as $}from"./chatParserTypes.js";import{IChatSlashCommandService as k}from"./chatSlashCommands.js";import{IChatVariablesService as F}from"./chatVariables.js";import{ILanguageModelToolsService as O}from"./languageModelToolsService.js";const Q=/^@([\w_\-\.]+)(?=(\s|$|\b))/i,j=/^#([\w_\-]+)(:\d+)?(?=(\s|$|\b))/i,z=/\/([\w_\-]+)(?=(\s|$|\b))/i;let I=class{constructor(u,t,a,r){this.agentService=u;this.variableService=t;this.slashCommandService=a;this.toolsService=r}parseChatRequest(u,t,a=E.Panel,r){const e=[],o=this.variableService.getDynamicVariables(u);let s=1,c=1;for(let n=0;n<t.length;n++){const f=t.charAt(n-1),l=t.charAt(n);let i;if((f.match(/\s/)||n===0)&&(l===$?i=this.tryToParseVariable(t.slice(n),n,new y(s,c),e):l===B?i=this.tryToParseAgent(t.slice(n),t,n,new y(s,c),e,a,r):l===_&&(i=this.tryToParseSlashCommand(t.slice(n),t,n,new y(s,c),e,a)),i||(i=this.tryToParseDynamicVariable(t.slice(n),n,new y(s,c),o))),i){if(n!==0){const P=e.at(-1),C=P?.range.endExclusive??0,g=P?.editorRange.endLineNumber??1,h=P?.editorRange.endColumn??1;e.push(new w(new v(C,n),new S(g,h,s,c),t.slice(C,n)))}e.push(i)}l===`
`?(s++,c=1):c++}const d=e.at(-1),m=d?.range.endExclusive??0;return m<t.length&&e.push(new w(new v(m,t.length),new S(d?.editorRange.endLineNumber??1,d?.editorRange.endColumn??1,s,c),t.slice(m,t.length))),{parts:e,text:t}}tryToParseAgent(u,t,a,r,e,o,s){const c=u.match(Q);if(!c)return;const[d,m]=c,n=new v(a,a+d.length),f=new S(r.lineNumber,r.column,r.lineNumber,r.column+d.length);let l=this.agentService.getAgentsByName(m);if(!l.length){const h=this.agentService.getAgentByFullyQualifiedId(m);h&&(l=[h])}const i=l.length>1&&s?.selectedAgent?s.selectedAgent:l.find(h=>h.locations.includes(o));if(!i||e.some(h=>h instanceof b)||e.some(h=>h instanceof w&&h.text.trim()!==""||!(h instanceof b)))return;const C=e.at(-1)?.range.endExclusive??0;if(t.slice(C,a).trim()==="")return new b(n,f,i)}tryToParseVariable(u,t,a,r){const e=u.match(j);if(!e)return;const[o,s]=e,c=e[2]??"",d=new v(t,t+o.length),m=new S(a.lineNumber,a.column,a.lineNumber,a.column+o.length),n=r.find(P=>P instanceof b),f=!n||n.agent.metadata.supportsSlowVariables,l=this.variableService.getVariable(s);if(l&&(!l.isSlow||f))return new M(d,m,s,c,l.id);const i=this.toolsService.getToolByName(s);if(i&&i.canBeInvokedManually&&(!n||n.agent.supportsToolReferences))return new D(d,m,s,i.id,i.displayName,i.icon)}tryToParseSlashCommand(u,t,a,r,e,o){const s=u.match(z);if(!s||e.some(l=>l instanceof x))return;const[c,d]=s,m=new v(a,a+c.length),n=new S(r.lineNumber,r.column,r.lineNumber,r.column+c.length),f=e.find(l=>l instanceof b);if(f){if(e.some(g=>g instanceof w&&g.text.trim()!==""||!(g instanceof b)&&!(g instanceof w)))return;const i=e.at(-1)?.range.endExclusive??0;if(t.slice(i,a).trim()!=="")return;const C=f.agent.slashCommands.find(g=>g.name===d);if(C)return new p(m,n,C)}else{const i=this.slashCommandService.getCommands(o).find(P=>P.command===d);if(i)return new x(m,n,i);{const C=this.agentService.getDefaultAgent(o)?.slashCommands.find(g=>g.name===d);if(C)return new p(m,n,C)}}}tryToParseDynamicVariable(u,t,a,r){const e=r.find(o=>o.range.startLineNumber===a.lineNumber&&o.range.startColumn===a.column);if(e){const o=e.range.endColumn-e.range.startColumn,s=u.substring(0,o),c=new v(t,t+o);return new L(c,e.range,s,e.id,e.modelDescription,e.data,e.fullName,e.icon)}}};I=q([A(0,N),A(1,F),A(2,k),A(3,O)],I);export{I as ChatRequestParser};
