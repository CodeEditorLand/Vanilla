import{MarkdownString as a}from"../../../../base/common/htmlContent.js";import{basename as I}from"../../../../base/common/resources.js";import{URI as v}from"../../../../base/common/uri.js";import"../../../../editor/common/core/range.js";import{appendMarkdownString as c,canMergeMarkdownStrings as x}from"./chatModel.js";import"./chatService.js";const R="http://_vscodecontentref_";function $(l){const e=[];for(const n of l){const t=e[e.length-1];if(n.kind==="inlineReference"){const i="uri"in n.inlineReference?n.inlineReference:{uri:n.inlineReference},o=v.parse(R).with({fragment:JSON.stringify(i)}),r=`[${n.name||I(i.uri)}](${o.toString()})`;if(t?.kind==="markdownContent"){const s=c(t.content,new a(r));e[e.length-1]={content:s,kind:"markdownContent"}}else e.push({content:new a(r),kind:"markdownContent"})}else if(n.kind==="markdownContent"&&t?.kind==="markdownContent"&&x(t.content,n.content)){const i=c(t.content,n.content);e[e.length-1]={content:i,kind:"markdownContent"}}else if(n.kind==="markdownVuln"){const o=`<vscode_annotation details='${encodeURIComponent(JSON.stringify(n.vulnerabilities))}'>${n.content.value}</vscode_annotation>`;if(t?.kind==="markdownContent"){const r=c(t.content,new a(o));e[e.length-1]={content:r,kind:"markdownContent"}}else e.push({content:new a(o),kind:"markdownContent"})}else e.push(n)}return e}function A(l){const e=[];for(const n of l){const t=e[e.length-1];if(n.kind==="markdownContent")t?.kind==="markdownContent"?e[e.length-1]={content:new a(t.content.value+n.content.value,{isTrusted:t.content.isTrusted}),kind:"markdownContent"}:e.push(n);else if(n.kind==="markdownVuln"){const o=`<vscode_annotation details='${encodeURIComponent(JSON.stringify(n.vulnerabilities))}'>${n.content.value}</vscode_annotation>`;t?.kind==="markdownContent"?e[e.length-1]={content:new a(t.content.value+o,{isTrusted:t.content.isTrusted}),kind:"markdownContent"}:e.push({content:new a(o),kind:"markdownContent"})}}return e}function D(l){const e=[];let n=l,t;for(;(t=/<vscode_annotation details='(.*?)'>(.*?)<\/vscode_annotation>/ms.exec(n))!==null;){const[i,o,r]=t,s=t.index,d=n.substring(0,s),u=d.split(`
`).length-1,m=r.split(`
`).length-1,k=d.lastIndexOf(`
`),g=s-(k+1)+1,w=(d+r).lastIndexOf(`
`),C=s+r.length-(w+1)+1;try{JSON.parse(decodeURIComponent(o)).forEach(({title:f,description:h})=>e.push({title:f,description:h,range:{startLineNumber:u+1,startColumn:g,endLineNumber:u+m+1,endColumn:C}}))}catch{}n=n.substring(0,s)+r+n.substring(s+i.length)}return{newText:n,vulnerabilities:e}}export{$ as annotateSpecialMarkdownContent,A as annotateVulnerabilitiesInText,R as contentRefUrl,D as extractVulnerabilitiesFromText};
