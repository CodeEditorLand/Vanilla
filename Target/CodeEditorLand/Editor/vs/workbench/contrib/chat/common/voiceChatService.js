var M=Object.defineProperty;var u=Object.getOwnPropertyDescriptor;var R=(g,l,t,e)=>{for(var a=e>1?void 0:e?u(l,t):l,i=g.length-1,o;i>=0;i--)(o=g[i])&&(a=(e?o(l,t,a):o(a))||a);return e&&a&&M(l,t,a),a},I=(g,l)=>(t,e)=>l(t,e,g);import"../../../../../vs/base/common/cancellation.js";import{Emitter as N}from"../../../../../vs/base/common/event.js";import{Disposable as v,DisposableStore as y}from"../../../../../vs/base/common/lifecycle.js";import{rtrim as f}from"../../../../../vs/base/common/strings.js";import{localize as D}from"../../../../../vs/nls.js";import{IContextKeyService as O,RawContextKey as _}from"../../../../../vs/platform/contextkey/common/contextkey.js";import{createDecorator as F}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{IChatAgentService as G}from"../../../../../vs/workbench/contrib/chat/common/chatAgents.js";import"../../../../../vs/workbench/contrib/chat/common/chatModel.js";import{chatAgentLeader as W,chatSubcommandLeader as X}from"../../../../../vs/workbench/contrib/chat/common/chatParserTypes.js";import{ISpeechService as b,SpeechToTextStatus as h}from"../../../../../vs/workbench/contrib/speech/common/speechService.js";const se=F("voiceChatService");var $=(e=>(e[e.AGENT=1]="AGENT",e[e.COMMAND=2]="COMMAND",e[e.AGENT_AND_COMMAND=3]="AGENT_AND_COMMAND",e))($||{});const L=new _("voiceChatInProgress",!1,{type:"boolean",description:D("voiceChatInProgress","A speech-to-text session is in progress for chat.")});let s=class extends v{constructor(t,e,a){super();this.speechService=t;this.chatAgentService=e;this.contextKeyService=a}_serviceBrand;static AGENT_PREFIX=W;static COMMAND_PREFIX=X;static PHRASES_LOWER={[this.AGENT_PREFIX]:"at",[this.COMMAND_PREFIX]:"slash"};static PHRASES_UPPER={[this.AGENT_PREFIX]:"At",[this.COMMAND_PREFIX]:"Slash"};static CHAT_AGENT_ALIAS=new Map([["vscode","code"]]);voiceChatInProgress=L.bindTo(this.contextKeyService);activeVoiceChatSessions=0;createPhrases(t){const e=new Map;for(const a of this.chatAgentService.getActivatedAgents()){const i=`${s.PHRASES_LOWER[s.AGENT_PREFIX]} ${s.CHAT_AGENT_ALIAS.get(a.name)??a.name}`.toLowerCase();e.set(i,{agent:a.name});for(const o of a.slashCommands){const d=`${s.PHRASES_LOWER[s.COMMAND_PREFIX]} ${o.name}`.toLowerCase();e.set(d,{agent:a.name,command:o.name});const m=`${i} ${d}`.toLowerCase();e.set(m,{agent:a.name,command:o.name})}}return e}toText(t,e){switch(e){case 1:return`${s.AGENT_PREFIX}${t.agent}`;case 2:return`${s.COMMAND_PREFIX}${t.command}`;case 3:return`${s.AGENT_PREFIX}${t.agent} ${s.COMMAND_PREFIX}${t.command}`}}async createVoiceChatSession(t,e){const a=new y,i=n=>{this.activeVoiceChatSessions=Math.max(0,this.activeVoiceChatSessions-1),this.activeVoiceChatSessions===0&&this.voiceChatInProgress.reset(),n&&a.dispose()};a.add(t.onCancellationRequested(()=>i(!0)));let o=!1,d=!1;const m=a.add(new N),x=await this.speechService.createSpeechToTextSession(t,"chat");t.isCancellationRequested&&i(!0);const C=this.createPhrases(e.model);return a.add(x.onDidChange(n=>{switch(n.status){case h.Recognizing:case h.Recognized:{let S=n;if(n.text){const P=n.text.startsWith(s.PHRASES_UPPER[s.AGENT_PREFIX])||n.text.startsWith(s.PHRASES_LOWER[s.AGENT_PREFIX]),T=n.text.startsWith(s.PHRASES_UPPER[s.COMMAND_PREFIX])||n.text.startsWith(s.PHRASES_LOWER[s.COMMAND_PREFIX]);if(P||T){const r=n.text.split(" ");let p,E=!1;if(e.usesAgents&&P&&!o&&!d&&r.length>=4){const c=C.get(r.slice(0,4).map(A=>this.normalizeWord(A)).join(" "));c&&(p=[this.toText(c,3),...r.slice(4)],E=r.length===4,n.status===h.Recognized&&(o=!0,d=!0))}if(e.usesAgents&&P&&!o&&!p&&r.length>=2){const c=C.get(r.slice(0,2).map(A=>this.normalizeWord(A)).join(" "));c&&(p=[this.toText(c,1),...r.slice(2)],E=r.length===2,n.status===h.Recognized&&(o=!0))}if(T&&!d&&!p&&r.length>=2){const c=C.get(r.slice(0,2).map(A=>this.normalizeWord(A)).join(" "));c&&(p=[this.toText(c,e.usesAgents&&!o?3:2),...r.slice(2)],E=r.length===2,n.status===h.Recognized&&(d=!0))}S={status:n.status,text:(p??r).join(" "),waitingForInput:E}}}m.fire(S);break}case h.Started:this.activeVoiceChatSessions++,this.voiceChatInProgress.set(!0),m.fire(n);break;case h.Stopped:i(!1),m.fire(n);break;case h.Error:m.fire(n);break}})),{onDidChange:m.event}}normalizeWord(t){return t=f(t,"."),t=f(t,","),t=f(t,"?"),t.toLowerCase()}};s=R([I(0,b),I(1,G),I(2,O)],s);export{se as IVoiceChatService,L as VoiceChatInProgress,s as VoiceChatService};
