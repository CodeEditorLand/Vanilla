var We=Object.defineProperty;var Ue=Object.getOwnPropertyDescriptor;var H=(a,e,t,i)=>{for(var o=i>1?void 0:i?Ue(e,t):e,n=a.length-1,r;n>=0;n--)(r=a[n])&&(o=(i?r(e,t,o):r(o))||o);return i&&o&&We(e,t,o),o},p=(a,e)=>(t,i)=>e(t,i,a);import"./media/voiceChatActions.css";import{RunOnceScheduler as re,disposableTimeout as se,raceCancellation as ae}from"../../../../../base/common/async.js";import{CancellationTokenSource as z}from"../../../../../base/common/cancellation.js";import{Codicon as L}from"../../../../../base/common/codicons.js";import"../../../../../base/common/color.js";import{Event as B}from"../../../../../base/common/event.js";import{KeyCode as D,KeyMod as X}from"../../../../../base/common/keyCodes.js";import{Disposable as ce,DisposableStore as de,MutableDisposable as qe,toDisposable as he}from"../../../../../base/common/lifecycle.js";import{isNumber as Ge}from"../../../../../base/common/types.js";import{getCodeEditor as pe}from"../../../../../editor/browser/editorBrowser.js";import{EditorContextKeys as ue}from"../../../../../editor/common/editorContextKeys.js";import{localize as u,localize2 as f}from"../../../../../nls.js";import{Action2 as A,MenuId as w}from"../../../../../platform/actions/common/actions.js";import{CommandsRegistry as ze,ICommandService as le}from"../../../../../platform/commands/common/commands.js";import{IConfigurationService as $}from"../../../../../platform/configuration/common/configuration.js";import{Extensions as Be}from"../../../../../platform/configuration/common/configurationRegistry.js";import{ContextKeyExpr as d,IContextKeyService as ve,RawContextKey as O}from"../../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as b}from"../../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as Se}from"../../../../../platform/keybinding/common/keybinding.js";import{KeybindingWeight as R}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import{ProgressLocation as Xe}from"../../../../../platform/progress/common/progress.js";import{Registry as $e}from"../../../../../platform/registry/common/platform.js";import{contrastBorder as ge,focusBorder as Ye}from"../../../../../platform/theme/common/colorRegistry.js";import{spinningLoading as Qe,syncing as je}from"../../../../../platform/theme/common/iconRegistry.js";import{ColorScheme as Ce}from"../../../../../platform/theme/common/theme.js";import{registerThemingParticipant as Je}from"../../../../../platform/theme/common/themeService.js";import{ActiveEditorContext as Ze}from"../../../../common/contextkeys.js";import"../../../../common/contributions.js";import{ACTIVITY_BAR_BADGE_BACKGROUND as et}from"../../../../common/theme.js";import{AccessibilityVoiceSettingId as Ie,SpeechTimeoutDefault as tt,accessibilityConfigurationNodeBase as it}from"../../../accessibility/browser/accessibilityConfiguration.js";import{CHAT_CATEGORY as V}from"../../browser/actions/chatActions.js";import"../../browser/actions/chatExecuteActions.js";import{IChatWidgetService as Y,IQuickChatService as ot,showChatView as fe}from"../../browser/chat.js";import{ChatAgentLocation as m,IChatAgentService as me}from"../../common/chatAgents.js";import{CONTEXT_CHAT_REQUEST_IN_PROGRESS as K,CONTEXT_IN_CHAT_INPUT as nt,CONTEXT_CHAT_ENABLED as rt,CONTEXT_RESPONSE as M,CONTEXT_RESPONSE_FILTERED as F,CONTEXT_CHAT_LOCATION as P}from"../../common/chatContextKeys.js";import{KEYWORD_ACTIVIATION_SETTING_ID as N}from"../../common/chatService.js";import{ChatResponseViewModel as st,isResponseVM as be}from"../../common/chatViewModel.js";import{IVoiceChatService as at,VoiceChatInProgress as ye}from"../../common/voiceChatService.js";import{IExtensionsWorkbenchService as ct}from"../../../extensions/common/extensions.js";import{InlineChatController as dt}from"../../../inlineChat/browser/inlineChatController.js";import{CTX_INLINE_CHAT_FOCUSED as ht,MENU_INLINE_CHAT_WIDGET_SECONDARY as Te}from"../../../inlineChat/common/inlineChat.js";import{NOTEBOOK_EDITOR_FOCUSED as Ae}from"../../../notebook/common/notebookContextKeys.js";import{HasSpeechProvider as Q,ISpeechService as j,KeywordRecognitionStatus as pt,SpeechToTextInProgress as ut,SpeechToTextStatus as W,TextToSpeechStatus as we,TextToSpeechInProgress as lt}from"../../../speech/common/speechService.js";import{ITerminalService as xe}from"../../../terminal/browser/terminal.js";import{TerminalChatContextKeys as vt,TerminalChatController as U}from"../../../terminal/terminalContribExports.js";import{IEditorService as ke}from"../../../../services/editor/common/editorService.js";import{IHostService as St}from"../../../../services/host/browser/host.js";import{IWorkbenchLayoutService as gt,Parts as x}from"../../../../services/layout/browser/layoutService.js";import{IStatusbarService as Ct,StatusbarAlignment as It}from"../../../../services/statusbar/browser/statusbar.js";import{IViewsService as Ee}from"../../../../services/views/common/viewsService.js";import"../../common/chatModel.js";import{IAccessibilityService as ft}from"../../../../../platform/accessibility/common/accessibility.js";import{renderStringAsPlaintext as mt}from"../../../../../base/browser/markdownRenderer.js";const bt=["view","inline","terminal","quick","editor"],k=d.and(rt,Q),J=d.or(ht,nt),yt=d.or(K,vt.requestActive),Ve=new O("scopedVoiceChatGettingReady",!1,{type:"boolean",description:u("scopedVoiceChatGettingReady","True when getting ready for receiving voice input from the microphone for voice chat. This key is only defined scoped, per chat context.")}),De=new O("scopedVoiceChatInProgress",void 0,{type:"string",description:u("scopedVoiceChatInProgress","Defined as a location where voice recording from microphone is in progress for voice chat. This key is only defined scoped, per chat context.")}),_=d.or(...bt.map(a=>De.isEqualTo(a)));var Tt=(i=>(i[i.Stopped=1]="Stopped",i[i.GettingReady=2]="GettingReady",i[i.Started=3]="Started",i))(Tt||{});class I{static async create(e,t){const i=e.get(Y),o=e.get(ot),n=e.get(gt),r=e.get(ke),s=e.get(xe),h=e.get(Ee);switch(t){case"focused":return I.doCreateForFocusedChat(s,i,n)??I.create(e,"view");case"view":{const c=await fe(h);if(c)return I.doCreateForChatWidget("view",c);break}case"inline":{const c=pe(r.activeTextEditorControl);if(c){const C=dt.get(c);if(C)return C.joinCurrentRun()||C.run(),I.doCreateForChatWidget("inline",C.chatWidget)}break}case"quick":return o.open(),I.create(e,"focused")}}static doCreateForFocusedChat(e,t,i){const o=e.activeInstance;if(o){const r=U.activeChatController||U.get(o);if(r?.hasFocus())return I.doCreateForTerminalChat(r)}const n=t.lastFocusedWidget;if(n?.hasInputFocus()){let r;return i.hasFocus(x.EDITOR_PART)?r=n.location===m.Panel?"editor":"inline":[x.SIDEBAR_PART,x.PANEL_PART,x.AUXILIARYBAR_PART,x.TITLEBAR_PART,x.STATUSBAR_PART,x.BANNER_PART,x.ACTIVITYBAR_PART].some(s=>i.hasFocus(s))?r="view":r="quick",I.doCreateForChatWidget(r,n)}}static createChatContextKeyController(e,t){const i=Ve.bindTo(e),o=De.bindTo(e);return n=>{switch(n){case 2:i.set(!0),o.reset();break;case 3:i.reset(),o.set(t);break;case 1:i.reset(),o.reset();break}}}static doCreateForChatWidget(e,t){return{context:e,scopedContextKeyService:t.scopedContextKeyService,onDidAcceptInput:t.onDidAcceptInput,onDidHideInput:t.onDidHide,focusInput:()=>t.focusInput(),acceptInput:()=>t.acceptInput(void 0,!0),updateInput:i=>t.setInput(i),getInput:()=>t.getInput(),setInputPlaceholder:i=>t.setInputPlaceholder(i),clearInputPlaceholder:()=>t.resetInputPlaceholder(),updateState:I.createChatContextKeyController(t.scopedContextKeyService,e)}}static doCreateForTerminalChat(e){const t="terminal";return{context:t,scopedContextKeyService:e.scopedContextKeyService,onDidAcceptInput:e.onDidAcceptInput,onDidHideInput:e.onDidHide,focusInput:()=>e.focus(),acceptInput:()=>e.acceptInput(!0),updateInput:i=>e.updateInput(i,!1),getInput:()=>e.getInput(),setInputPlaceholder:i=>e.setPlaceholder(i),clearInputPlaceholder:()=>e.resetPlaceholder(),updateState:I.createChatContextKeyController(e.scopedContextKeyService,t)}}}let l=class{constructor(e,t,i,o){this.voiceChatService=e;this.configurationService=t;this.instantiationService=i;this.accessibilityService=o}static instance=void 0;static getInstance(e){return l.instance||(l.instance=e.createInstance(l)),l.instance}currentVoiceChatSession=void 0;voiceChatSessionIds=0;async start(e,t){this.stop(),v.getInstance(this.instantiationService).stop();let i=!1;const o=++this.voiceChatSessionIds,n=this.currentVoiceChatSession={id:o,controller:e,hasRecognizedInput:!1,disposables:new de,setTimeoutDisabled:E=>{i=E},accept:()=>this.accept(o),stop:()=>this.stop(o,e.context)},r=new z;n.disposables.add(he(()=>r.dispose(!0))),n.disposables.add(e.onDidAcceptInput(()=>this.stop(o,e.context))),n.disposables.add(e.onDidHideInput(()=>this.stop(o,e.context))),e.focusInput(),e.updateState(2);const s=await this.voiceChatService.createVoiceChatSession(r.token,{usesAgents:e.context!=="inline",model:t?.widget?.viewModel?.model});let h=e.getInput(),c=this.configurationService.getValue(Ie.SpeechTimeout);(!Ge(c)||c<0)&&(c=tt);const C=n.disposables.add(new re(()=>this.accept(o),c));return n.disposables.add(s.onDidChange(({status:E,text:T,waitingForInput:Fe})=>{if(!r.token.isCancellationRequested)switch(E){case W.Started:this.onDidSpeechToTextSessionStart(e,n.disposables);break;case W.Recognizing:T&&(n.hasRecognizedInput=!0,n.controller.updateInput(h?[h,T].join(" "):T),c>0&&t?.voice?.disableTimeout!==!0&&!i&&C.cancel());break;case W.Recognized:T&&(n.hasRecognizedInput=!0,h=h?[h,T].join(" "):T,n.controller.updateInput(h),c>0&&t?.voice?.disableTimeout!==!0&&!Fe&&!i&&C.schedule());break;case W.Stopped:this.stop(n.id,e.context);break}})),n}onDidSpeechToTextSessionStart(e,t){e.updateState(3);let i=0;const o=()=>{i=(i+1)%4,e.setInputPlaceholder(`${u("listening","I'm listening")}${".".repeat(i)}`),n.schedule()},n=t.add(new re(o,500));o()}stop(e=this.voiceChatSessionIds,t){!this.currentVoiceChatSession||this.voiceChatSessionIds!==e||t&&this.currentVoiceChatSession.controller.context!==t||(this.currentVoiceChatSession.controller.clearInputPlaceholder(),this.currentVoiceChatSession.controller.updateState(1),this.currentVoiceChatSession.disposables.dispose(),this.currentVoiceChatSession=void 0)}async accept(e=this.voiceChatSessionIds){if(!this.currentVoiceChatSession||this.voiceChatSessionIds!==e)return;if(!this.currentVoiceChatSession.hasRecognizedInput){this.stop(e,this.currentVoiceChatSession.controller.context);return}const t=this.currentVoiceChatSession.controller,i=await t.acceptInput();if(!i)return;const o=this.configurationService.getValue(Ie.AutoSynthesize);if(o==="on"||o==="auto"&&!this.accessibilityService.isScreenReaderOptimized()){let n;t.context==="inline"?n="focused":n=t,v.getInstance(this.instantiationService).start(this.instantiationService.invokeFunction(r=>G.create(r,n,i)))}}};l=H([p(0,at),p(1,$),p(2,b),p(3,ft)],l);const Re=500;async function Pe(a,e,t,i){const o=e.get(b),r=e.get(Se).enableKeybindingHoldMode(a),s=await I.create(e,t);if(!s)return;const h=await l.getInstance(o).start(s,i);let c=!1;const C=se(()=>{c=!0,h?.setTimeoutDisabled(!0)},Re);await r,C.dispose(),c&&h.accept()}class Z extends A{constructor(t,i){super(t);this.target=i}run(t,i){return Pe(this.desc.id,t,this.target,i)}}class ie extends Z{static ID="workbench.action.chat.voiceChatInChatView";constructor(){super({id:ie.ID,title:f("workbench.action.chat.voiceChatInView.label","Voice Chat in Chat View"),category:V,precondition:d.and(k,K.negate()),f1:!0},"view")}}class te extends A{static ID="workbench.action.chat.holdToVoiceChatInChatView";constructor(){super({id:te.ID,title:f("workbench.action.chat.holdToVoiceChatInChatView.label","Hold to Voice Chat in Chat View"),keybinding:{weight:R.WorkbenchContrib,when:d.and(k,K.negate(),J?.negate(),ue.focus.negate(),Ae.negate()),primary:X.CtrlCmd|D.KeyI}})}async run(e,t){const i=e.get(b),o=e.get(Se),n=e.get(Ee),r=o.enableKeybindingHoldMode(te.ID);let s;const h=se(async()=>{const c=await I.create(e,"view");c&&(s=await l.getInstance(i).start(c,t),s.setTimeoutDisabled(!0))},Re);(await fe(n))?.focusInput(),await r,h.dispose(),s&&s.accept()}}class q extends Z{static ID="workbench.action.chat.inlineVoiceChat";constructor(){super({id:q.ID,title:f("workbench.action.chat.inlineVoiceChat","Inline Voice Chat"),category:V,precondition:d.and(k,Ze,K.negate()),f1:!0},"inline")}}class oe extends Z{static ID="workbench.action.chat.quickVoiceChat";constructor(){super({id:oe.ID,title:f("workbench.action.chat.quickVoiceChat.label","Quick Voice Chat"),category:V,precondition:d.and(k,K.negate()),f1:!0},"quick")}}class He extends A{static ID="workbench.action.chat.startVoiceChat";constructor(){const e=d.and(Q,y.negate(),_?.negate());super({id:He.ID,title:f("workbench.action.chat.startVoiceChat.label","Start Voice Chat"),category:V,f1:!0,keybinding:{weight:R.WorkbenchContrib,when:d.and(J,ue.focus.negate(),Ae.negate()),primary:X.CtrlCmd|D.KeyI},icon:L.mic,precondition:d.and(k,Ve.negate(),yt?.negate(),ut.negate()),menu:[{id:w.ChatInput,when:d.and(P.isEqualTo(m.Panel),e),group:"navigation",order:3},{id:w.ChatExecute,when:d.and(P.isEqualTo(m.Panel).negate(),e),group:"navigation",order:2}]})}async run(e,t){const i=t?.widget;return i&&i.focusInput(),Pe(this.desc.id,e,"focused",t)}}class Ke extends A{static ID="workbench.action.chat.stopListening";constructor(){super({id:Ke.ID,title:f("workbench.action.chat.stopListening.label","Stop Listening"),category:V,f1:!0,keybinding:{weight:R.WorkbenchContrib+100,primary:D.Escape,when:_},icon:Qe,precondition:ye,menu:[{id:w.ChatInput,when:d.and(P.isEqualTo(m.Panel),_),group:"navigation",order:3},{id:w.ChatExecute,when:d.and(P.isEqualTo(m.Panel).negate(),_),group:"navigation",order:2}]})}async run(e){l.getInstance(e.get(b)).stop()}}class _e extends A{static ID="workbench.action.chat.stopListeningAndSubmit";constructor(){super({id:_e.ID,title:f("workbench.action.chat.stopListeningAndSubmit.label","Stop Listening and Submit"),category:V,f1:!0,keybinding:{weight:R.WorkbenchContrib,when:d.and(J,_),primary:X.CtrlCmd|D.KeyI},precondition:ye})}run(e){l.getInstance(e.get(b)).accept()}}const y=new O("scopedChatSynthesisInProgress",!1,{type:"boolean",description:u("scopedChatSynthesisInProgress","Defined as a location where voice recording from microphone is in progress for voice chat. This key is only defined scoped, per chat context.")});class G{static create(e,t,i){return t==="focused"?G.doCreateForFocusedChat(e,i):{onDidHideChat:t.onDidHideInput,contextKeyService:t.scopedContextKeyService,response:i}}static doCreateForFocusedChat(e,t){const i=e.get(Y),o=e.get(ve),r=e.get(xe).activeInstance;if(r){const h=U.activeChatController||U.get(r);if(h?.hasFocus())return{onDidHideChat:h.onDidHide,contextKeyService:h.scopedContextKeyService,response:t}}let s=i.getWidgetBySessionId(t.session.sessionId);return s?.location===m.Editor&&(s=i.lastFocusedWidget),{onDidHideChat:s?.onDidHide??B.None,contextKeyService:s?.scopedContextKeyService??o,response:t}}}let v=class{constructor(e,t){this.speechService=e;this.instantiationService=t}static instance=void 0;static getInstance(e){return v.instance||(v.instance=e.createInstance(v)),v.instance}activeSession=void 0;async start(e){this.stop(),l.getInstance(this.instantiationService).stop();const t=this.activeSession=new z,i=new de;t.token.onCancellationRequested(()=>i.dispose());const o=await this.speechService.createTextToSpeechSession(t.token,"chat");if(t.token.isCancellationRequested)return;i.add(e.onDidHideChat(()=>this.stop()));const n=y.bindTo(e.contextKeyService);i.add(he(()=>n.reset())),i.add(o.onDidChange(r=>{switch(r.status){case we.Started:n.set(!0);break;case we.Stopped:n.reset();break}}));for await(const r of this.nextChatResponseChunk(e.response,t.token)){if(t.token.isCancellationRequested)return;await ae(o.synthesize(r),t.token)}}async*nextChatResponseChunk(e,t){let i=0,o=!1;do{const n=e.response.toString().length,{chunk:r,offset:s}=this.parseNextChatResponseChunk(e,i);if(i=s,o=e.isComplete,r&&(yield r),t.isCancellationRequested)return;!o&&n===e.response.toString().length&&await ae(B.toPromise(e.onDidChange),t)}while(!t.isCancellationRequested&&!o)}parseNextChatResponseChunk(e,t){let i;const o=e.response.toString();if(e.isComplete)i=o.substring(t),t=o.length+1;else{const n=kt(o,t);i=n.chunk,t=n.offset}return{chunk:i&&mt({value:i}),offset:t}}stop(){this.activeSession?.dispose(!0),this.activeSession=void 0}};v=H([p(0,j),p(1,b)],v);const At=[".","!","?",":"],wt=`
`,xt=" ";function kt(a,e){let t;for(let i=a.length-1;i>=e;i--){const o=a[i],n=a[i+1];if(At.includes(o)&&n===xt||wt===o){t=a.substring(e,i+1).trim(),e=i+1;break}}return{chunk:t,offset:e}}class Fi extends A{constructor(){super({id:"workbench.action.chat.readChatResponseAloud",title:f("workbench.action.chat.readChatResponseAloud","Read Aloud"),icon:L.unmute,precondition:k,menu:[{id:w.ChatMessageFooter,when:d.and(k,M,y.negate(),F.negate()),group:"navigation"},{id:Te,when:d.and(k,M,y.negate(),F.negate()),group:"navigation"}]})}run(e,...t){const i=e.get(b),o=e.get(Y);let n;if(t.length>0){const s=t[0];be(s)&&(n=s)}else{const s=o.lastFocusedWidget;if(s){const h=s.getFocus();if(h instanceof st)n=h;else{const c=s.viewModel;if(c){const C=c.getItems();for(let E=C.length-1;E>=0;E--){const T=C[E];if(be(T)){n=T;break}}}}}}if(!n)return;const r=G.create(e,"focused",n.model);v.getInstance(i).start(r)}}class Le extends A{static ID="workbench.action.speech.stopReadAloud";constructor(){super({id:Le.ID,icon:je,title:f("workbench.action.speech.stopReadAloud","Stop Reading Aloud"),f1:!0,category:V,precondition:lt,keybinding:{weight:R.WorkbenchContrib+100,primary:D.Escape,when:y},menu:[{id:w.ChatInput,when:d.and(P.isEqualTo(m.Panel),y),group:"navigation",order:3},{id:w.ChatExecute,when:d.and(P.isEqualTo(m.Panel).negate(),y),group:"navigation",order:2}]})}async run(e){v.getInstance(e.get(b)).stop()}}class Oe extends A{static ID="workbench.action.chat.stopReadChatItemAloud";constructor(){super({id:Oe.ID,icon:L.mute,title:f("workbench.action.chat.stopReadChatItemAloud","Stop Reading Aloud"),precondition:y,keybinding:{weight:R.WorkbenchContrib+100,primary:D.Escape},menu:[{id:w.ChatMessageFooter,when:d.and(y,M,F.negate()),group:"navigation"},{id:Te,when:d.and(y,M,F.negate()),group:"navigation"}]})}async run(e,...t){v.getInstance(e.get(b)).stop()}}function Ne(a,e,t){if(!e.hasSpeechProvider||!t.getDefaultAgent(m.Panel))return!1;const i=a.getValue(N);return typeof i=="string"&&i!==S.SETTINGS_VALUE.OFF}let S=class extends ce{constructor(t,i,o,n,r,s,h){super();this.speechService=t;this.configurationService=i;this.commandService=o;this.editorService=r;this.hostService=s;this.chatAgentService=h;this._register(n.createInstance(g)),this.registerListeners()}static ID="workbench.contrib.keywordActivation";static SETTINGS_VALUE={OFF:"off",INLINE_CHAT:"inlineChat",QUICK_CHAT:"quickChat",VIEW_CHAT:"chatInView",CHAT_IN_CONTEXT:"chatInContext"};activeSession=void 0;registerListeners(){this._register(B.runAndSubscribe(this.speechService.onDidChangeHasSpeechProvider,()=>{this.updateConfiguration(),this.handleKeywordActivation()}));const t=this._register(this.chatAgentService.onDidChangeAgents(()=>{this.chatAgentService.getDefaultAgent(m.Panel)&&(this.updateConfiguration(),this.handleKeywordActivation(),t.dispose())}));this._register(this.speechService.onDidStartSpeechToTextSession(()=>this.handleKeywordActivation())),this._register(this.speechService.onDidEndSpeechToTextSession(()=>this.handleKeywordActivation())),this._register(this.configurationService.onDidChangeConfiguration(i=>{i.affectsConfiguration(N)&&this.handleKeywordActivation()}))}updateConfiguration(){if(!this.speechService.hasSpeechProvider||!this.chatAgentService.getDefaultAgent(m.Panel))return;$e.as(Be.Configuration).registerConfiguration({...it,properties:{[N]:{type:"string",enum:[S.SETTINGS_VALUE.OFF,S.SETTINGS_VALUE.VIEW_CHAT,S.SETTINGS_VALUE.QUICK_CHAT,S.SETTINGS_VALUE.INLINE_CHAT,S.SETTINGS_VALUE.CHAT_IN_CONTEXT],enumDescriptions:[u("voice.keywordActivation.off","Keyword activation is disabled."),u("voice.keywordActivation.chatInView","Keyword activation is enabled and listening for 'Hey Code' to start a voice chat session in the chat view."),u("voice.keywordActivation.quickChat","Keyword activation is enabled and listening for 'Hey Code' to start a voice chat session in the quick chat."),u("voice.keywordActivation.inlineChat","Keyword activation is enabled and listening for 'Hey Code' to start a voice chat session in the active editor if possible."),u("voice.keywordActivation.chatInContext","Keyword activation is enabled and listening for 'Hey Code' to start a voice chat session in the active editor or view depending on keyboard focus.")],description:u("voice.keywordActivation","Controls whether the keyword phrase 'Hey Code' is recognized to start a voice chat session. Enabling this will start recording from the microphone but the audio is processed locally and never sent to a server."),default:"off",tags:["accessibility"]}}})}handleKeywordActivation(){const t=Ne(this.configurationService,this.speechService,this.chatAgentService)&&!this.speechService.hasActiveSpeechToTextSession;t&&this.activeSession||!t&&!this.activeSession||(t?this.enableKeywordActivation():this.disableKeywordActivation())}async enableKeywordActivation(){const t=this.activeSession=new z,i=await this.speechService.recognizeKeyword(t.token);t.token.isCancellationRequested||t!==this.activeSession||(this.activeSession=void 0,i===pt.Recognized&&(this.hostService.hasFocus&&this.commandService.executeCommand(this.getKeywordCommand()),this.handleKeywordActivation()))}getKeywordCommand(){switch(this.configurationService.getValue(N)){case S.SETTINGS_VALUE.INLINE_CHAT:return q.ID;case S.SETTINGS_VALUE.QUICK_CHAT:return oe.ID;case S.SETTINGS_VALUE.CHAT_IN_CONTEXT:if(pe(this.editorService.activeTextEditorControl)?.hasWidgetFocus())return q.ID;default:return ie.ID}}disableKeywordActivation(){this.activeSession?.dispose(!0),this.activeSession=void 0}dispose(){this.activeSession?.dispose(),super.dispose()}};S=H([p(0,j),p(1,$),p(2,le),p(3,b),p(4,ke),p(5,St),p(6,me)],S);let g=class extends ce{constructor(t,i,o,n,r){super();this.speechService=t;this.statusbarService=i;this.commandService=o;this.configurationService=n;this.chatAgentService=r;this._register(ze.registerCommand(g.STATUS_COMMAND,()=>this.commandService.executeCommand("workbench.action.openSettings",N))),this.registerListeners(),this.updateStatusEntry()}entry=this._register(new qe);static STATUS_NAME=u("keywordActivation.status.name","Voice Keyword Activation");static STATUS_COMMAND="keywordActivation.status.command";static STATUS_ACTIVE=u("keywordActivation.status.active","Listening to 'Hey Code'...");static STATUS_INACTIVE=u("keywordActivation.status.inactive","Waiting for voice chat to end...");registerListeners(){this._register(this.speechService.onDidStartKeywordRecognition(()=>this.updateStatusEntry())),this._register(this.speechService.onDidEndKeywordRecognition(()=>this.updateStatusEntry())),this._register(this.configurationService.onDidChangeConfiguration(t=>{t.affectsConfiguration(N)&&this.updateStatusEntry()}))}updateStatusEntry(){Ne(this.configurationService,this.speechService,this.chatAgentService)?(this.entry.value||this.createStatusEntry(),this.updateStatusLabel()):this.entry.clear()}createStatusEntry(){this.entry.value=this.statusbarService.addEntry(this.getStatusEntryProperties(),"status.voiceKeywordActivation",It.RIGHT,103)}getStatusEntryProperties(){return{name:g.STATUS_NAME,text:this.speechService.hasActiveKeywordRecognition?"$(mic-filled)":"$(mic)",tooltip:this.speechService.hasActiveKeywordRecognition?g.STATUS_ACTIVE:g.STATUS_INACTIVE,ariaLabel:this.speechService.hasActiveKeywordRecognition?g.STATUS_ACTIVE:g.STATUS_INACTIVE,command:g.STATUS_COMMAND,kind:"prominent",showInAllWindows:!0}}updateStatusLabel(){this.entry.value?.update(this.getStatusEntryProperties())}};g=H([p(0,j),p(1,Ct),p(2,le),p(3,$),p(4,me)],g);const ee=new O("installingSpeechProvider",!1,!0);class ne extends A{static SPEECH_EXTENSION_ID="ms-vscode.vscode-speech";async run(e){const t=e.get(ve),i=e.get(ct);try{ee.bindTo(t).set(!0),await i.install(ne.SPEECH_EXTENSION_ID,{justification:this.getJustification(),enable:!0},Xe.Notification)}finally{ee.bindTo(t).reset()}}}class Me extends ne{static ID="workbench.action.chat.installProviderForVoiceChat";constructor(){super({id:Me.ID,title:f("workbench.action.chat.installProviderForVoiceChat.label","Start Voice Chat"),icon:L.mic,precondition:ee.negate(),menu:[{id:w.ChatInput,when:Q.negate(),group:"navigation",order:3}]})}getJustification(){return u("installProviderForVoiceChat.justification","Microphone support requires this extension.")}}Je((a,e)=>{let t,i;a.type===Ce.LIGHT||a.type===Ce.DARK?(t=a.getColor(et)??a.getColor(Ye),i=t?.transparent(.38)):(t=a.getColor(ge),i=a.getColor(ge)),e.addRule(`
		.monaco-workbench:not(.reduce-motion) .interactive-input-part .monaco-action-bar .action-label.codicon-sync.codicon-modifier-spin:not(.disabled),
		.monaco-workbench:not(.reduce-motion) .interactive-input-part .monaco-action-bar .action-label.codicon-loading.codicon-modifier-spin:not(.disabled) {
			color: ${t};
			outline: 1px solid ${t};
			outline-offset: -1px;
			animation: pulseAnimation 1s infinite;
			border-radius: 50%;
		}

		.monaco-workbench:not(.reduce-motion) .interactive-input-part .monaco-action-bar .action-label.codicon-sync.codicon-modifier-spin:not(.disabled)::before,
		.monaco-workbench:not(.reduce-motion) .interactive-input-part .monaco-action-bar .action-label.codicon-loading.codicon-modifier-spin:not(.disabled)::before {
			position: absolute;
			outline: 1px solid ${t};
			outline-offset: 2px;
			border-radius: 50%;
			width: 16px;
			height: 16px;
		}

		.monaco-workbench:not(.reduce-motion) .interactive-input-part .monaco-action-bar .action-label.codicon-sync.codicon-modifier-spin:not(.disabled)::after,
		.monaco-workbench:not(.reduce-motion) .interactive-input-part .monaco-action-bar .action-label.codicon-loading.codicon-modifier-spin:not(.disabled)::after {
			outline: 2px solid ${t};
			outline-offset: -1px;
			animation: pulseAnimation 1500ms cubic-bezier(0.75, 0, 0.25, 1) infinite;
		}

		.monaco-workbench:not(.reduce-motion) .interactive-input-part .monaco-action-bar .action-label.codicon-sync.codicon-modifier-spin:not(.disabled)::before,
		.monaco-workbench:not(.reduce-motion) .interactive-input-part .monaco-action-bar .action-label.codicon-loading.codicon-modifier-spin:not(.disabled)::before {
			position: absolute;
			outline: 1px solid ${t};
			outline-offset: 2px;
			border-radius: 50%;
			width: 16px;
			height: 16px;
		}

		@keyframes pulseAnimation {
			0% {
				outline-width: 2px;
			}
			62% {
				outline-width: 5px;
				outline-color: ${i};
			}
			100% {
				outline-width: 2px;
			}
		}
	`)});export{te as HoldToVoiceChatInChatViewAction,q as InlineVoiceChatAction,Me as InstallSpeechProviderForVoiceChatAction,S as KeywordActivationContribution,oe as QuickVoiceChatAction,Fi as ReadChatResponseAloud,He as StartVoiceChatAction,Ke as StopListeningAction,_e as StopListeningAndSubmitAction,Le as StopReadAloud,Oe as StopReadChatItemAloud,Re as VOICE_KEY_HOLD_THRESHOLD,ie as VoiceChatInChatViewAction,kt as parseNextChatResponseChunk};
