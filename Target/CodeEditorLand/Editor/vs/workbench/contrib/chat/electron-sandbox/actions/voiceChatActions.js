var Ue=Object.defineProperty;var Ge=Object.getOwnPropertyDescriptor;var H=(a,e,t,i)=>{for(var o=i>1?void 0:i?Ge(e,t):e,n=a.length-1,r;n>=0;n--)(r=a[n])&&(o=(i?r(e,t,o):r(o))||o);return i&&o&&Ue(e,t,o),o},h=(a,e)=>(t,i)=>e(t,i,a);import"./media/voiceChatActions.css";import{RunOnceScheduler as re,disposableTimeout as se,raceCancellation as ae}from"../../../../../base/common/async.js";import{CancellationTokenSource as $}from"../../../../../base/common/cancellation.js";import{Codicon as K}from"../../../../../base/common/codicons.js";import"../../../../../base/common/color.js";import{Event as Y}from"../../../../../base/common/event.js";import{KeyCode as D,KeyMod as j}from"../../../../../base/common/keyCodes.js";import{Disposable as ce,DisposableStore as de,MutableDisposable as qe,toDisposable as he}from"../../../../../base/common/lifecycle.js";import{isNumber as Be}from"../../../../../base/common/types.js";import{getCodeEditor as pe}from"../../../../../editor/browser/editorBrowser.js";import{EditorContextKeys as ue}from"../../../../../editor/common/editorContextKeys.js";import{localize as u,localize2 as I}from"../../../../../nls.js";import{Action2 as T,MenuId as A}from"../../../../../platform/actions/common/actions.js";import{CommandsRegistry as Xe,ICommandService as le}from"../../../../../platform/commands/common/commands.js";import{IConfigurationService as Q}from"../../../../../platform/configuration/common/configuration.js";import{Extensions as ze}from"../../../../../platform/configuration/common/configurationRegistry.js";import{ContextKeyExpr as p,IContextKeyService as ve,RawContextKey as O}from"../../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as b}from"../../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as Se}from"../../../../../platform/keybinding/common/keybinding.js";import{KeybindingWeight as V}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import{ProgressLocation as $e}from"../../../../../platform/progress/common/progress.js";import{Registry as Ye}from"../../../../../platform/registry/common/platform.js";import{contrastBorder as ge,focusBorder as je}from"../../../../../platform/theme/common/colorRegistry.js";import{spinningLoading as Qe,syncing as Je}from"../../../../../platform/theme/common/iconRegistry.js";import{ColorScheme as Ce}from"../../../../../platform/theme/common/theme.js";import{registerThemingParticipant as Ze}from"../../../../../platform/theme/common/themeService.js";import{ActiveEditorContext as et}from"../../../../common/contextkeys.js";import"../../../../common/contributions.js";import{ACTIVITY_BAR_BADGE_BACKGROUND as tt}from"../../../../common/theme.js";import{AccessibilityVoiceSettingId as Ie,SpeechTimeoutDefault as it,accessibilityConfigurationNodeBase as ot}from"../../../accessibility/browser/accessibilityConfiguration.js";import{CHAT_CATEGORY as E}from"../../browser/actions/chatActions.js";import"../../browser/actions/chatExecuteActions.js";import{IChatWidgetService as J,IQuickChatService as nt,showChatView as fe}from"../../browser/chat.js";import{ChatAgentLocation as _,IChatAgentService as me}from"../../common/chatAgents.js";import{CONTEXT_CHAT_REQUEST_IN_PROGRESS as L,CONTEXT_IN_CHAT_INPUT as rt,CONTEXT_CHAT_ENABLED as st,CONTEXT_RESPONSE as M,CONTEXT_RESPONSE_FILTERED as W}from"../../common/chatContextKeys.js";import{KEYWORD_ACTIVIATION_SETTING_ID as R}from"../../common/chatService.js";import{ChatResponseViewModel as at,isResponseVM as be}from"../../common/chatViewModel.js";import{IVoiceChatService as ct,VoiceChatInProgress as ye}from"../../common/voiceChatService.js";import{IExtensionsWorkbenchService as dt}from"../../../extensions/common/extensions.js";import{InlineChatController as ht}from"../../../inlineChat/browser/inlineChatController.js";import{CTX_INLINE_CHAT_FOCUSED as pt,MENU_INLINE_CHAT_WIDGET_SECONDARY as Te}from"../../../inlineChat/common/inlineChat.js";import{NOTEBOOK_EDITOR_FOCUSED as Ae}from"../../../notebook/common/notebookContextKeys.js";import{HasSpeechProvider as P,ISpeechService as Z,KeywordRecognitionStatus as ut,SpeechToTextInProgress as lt,SpeechToTextStatus as F,TextToSpeechStatus as we,TextToSpeechInProgress as vt}from"../../../speech/common/speechService.js";import{ITerminalService as ke}from"../../../terminal/browser/terminal.js";import{TerminalChatContextKeys as St,TerminalChatController as U}from"../../../terminal/terminalContribExports.js";import{IEditorService as xe}from"../../../../services/editor/common/editorService.js";import{IHostService as gt}from"../../../../services/host/browser/host.js";import{IWorkbenchLayoutService as Ct,Parts as w}from"../../../../services/layout/browser/layoutService.js";import{IStatusbarService as It,StatusbarAlignment as ft}from"../../../../services/statusbar/browser/statusbar.js";import{IViewsService as Ee}from"../../../../services/views/common/viewsService.js";import"../../common/chatModel.js";import{IAccessibilityService as mt}from"../../../../../platform/accessibility/common/accessibility.js";import{renderStringAsPlaintext as bt}from"../../../../../base/browser/markdownRenderer.js";const yt=["view","inline","terminal","quick","editor"],G=A.for("terminalChatInput"),k=p.and(st,P),ee=p.or(pt,rt),Tt=p.or(L,St.requestActive),De=new O("scopedVoiceChatGettingReady",!1,{type:"boolean",description:u("scopedVoiceChatGettingReady","True when getting ready for receiving voice input from the microphone for voice chat. This key is only defined scoped, per chat context.")}),Ve=new O("scopedVoiceChatInProgress",void 0,{type:"string",description:u("scopedVoiceChatInProgress","Defined as a location where voice recording from microphone is in progress for voice chat. This key is only defined scoped, per chat context.")}),N=p.or(...yt.map(a=>Ve.isEqualTo(a)));var At=(i=>(i[i.Stopped=1]="Stopped",i[i.GettingReady=2]="GettingReady",i[i.Started=3]="Started",i))(At||{});class f{static async create(e,t){const i=e.get(J),o=e.get(nt),n=e.get(Ct),r=e.get(xe),s=e.get(ke),d=e.get(Ee);switch(t){case"focused":return f.doCreateForFocusedChat(s,i,n)??f.create(e,"view");case"view":{const c=await fe(d);if(c)return f.doCreateForChatWidget("view",c);break}case"inline":{const c=pe(r.activeTextEditorControl);if(c){const C=ht.get(c);if(C)return C.joinCurrentRun()||C.run(),f.doCreateForChatWidget("inline",C.chatWidget)}break}case"quick":return o.open(),f.create(e,"focused")}}static doCreateForFocusedChat(e,t,i){const o=e.activeInstance;if(o){const r=U.activeChatWidget||U.get(o);if(r?.hasFocus())return f.doCreateForTerminalChat(r)}const n=t.lastFocusedWidget;if(n?.hasInputFocus()){let r;return i.hasFocus(w.EDITOR_PART)?r=n.location===_.Panel?"editor":"inline":[w.SIDEBAR_PART,w.PANEL_PART,w.AUXILIARYBAR_PART,w.TITLEBAR_PART,w.STATUSBAR_PART,w.BANNER_PART,w.ACTIVITYBAR_PART].some(s=>i.hasFocus(s))?r="view":r="quick",f.doCreateForChatWidget(r,n)}}static createChatContextKeyController(e,t){const i=De.bindTo(e),o=Ve.bindTo(e);return n=>{switch(n){case 2:i.set(!0),o.reset();break;case 3:i.reset(),o.set(t);break;case 1:i.reset(),o.reset();break}}}static doCreateForChatWidget(e,t){return{context:e,scopedContextKeyService:t.scopedContextKeyService,onDidAcceptInput:t.onDidAcceptInput,onDidHideInput:t.onDidHide,focusInput:()=>t.focusInput(),acceptInput:()=>t.acceptInput(void 0,!0),updateInput:i=>t.setInput(i),getInput:()=>t.getInput(),setInputPlaceholder:i=>t.setInputPlaceholder(i),clearInputPlaceholder:()=>t.resetInputPlaceholder(),updateState:f.createChatContextKeyController(t.scopedContextKeyService,e)}}static doCreateForTerminalChat(e){const t="terminal";return{context:t,scopedContextKeyService:e.scopedContextKeyService,onDidAcceptInput:e.onDidAcceptInput,onDidHideInput:e.onDidHide,focusInput:()=>e.focus(),acceptInput:()=>e.acceptInput(!0),updateInput:i=>e.updateInput(i,!1),getInput:()=>e.getInput(),setInputPlaceholder:i=>e.setPlaceholder(i),clearInputPlaceholder:()=>e.resetPlaceholder(),updateState:f.createChatContextKeyController(e.scopedContextKeyService,t)}}}let l=class{constructor(e,t,i,o){this.voiceChatService=e;this.configurationService=t;this.instantiationService=i;this.accessibilityService=o}static instance=void 0;static getInstance(e){return l.instance||(l.instance=e.createInstance(l)),l.instance}currentVoiceChatSession=void 0;voiceChatSessionIds=0;async start(e,t){this.stop(),v.getInstance(this.instantiationService).stop();let i=!1;const o=++this.voiceChatSessionIds,n=this.currentVoiceChatSession={id:o,controller:e,disposables:new de,setTimeoutDisabled:x=>{i=x},accept:()=>this.accept(o),stop:()=>this.stop(o,e.context)},r=new $;n.disposables.add(he(()=>r.dispose(!0))),n.disposables.add(e.onDidAcceptInput(()=>this.stop(o,e.context))),n.disposables.add(e.onDidHideInput(()=>this.stop(o,e.context))),e.focusInput(),e.updateState(2);const s=await this.voiceChatService.createVoiceChatSession(r.token,{usesAgents:e.context!=="inline",model:t?.widget?.viewModel?.model});let d=e.getInput(),c=this.configurationService.getValue(Ie.SpeechTimeout);(!Be(c)||c<0)&&(c=it);const C=n.disposables.add(new re(()=>this.accept(o),c));return n.disposables.add(s.onDidChange(({status:x,text:y,waitingForInput:Fe})=>{if(!r.token.isCancellationRequested)switch(x){case F.Started:this.onDidSpeechToTextSessionStart(e,n.disposables);break;case F.Recognizing:y&&(n.controller.updateInput(d?[d,y].join(" "):y),c>0&&t?.voice?.disableTimeout!==!0&&!i&&C.cancel());break;case F.Recognized:y&&(d=d?[d,y].join(" "):y,n.controller.updateInput(d),c>0&&t?.voice?.disableTimeout!==!0&&!Fe&&!i&&C.schedule());break;case F.Stopped:this.stop(n.id,e.context);break}})),n}onDidSpeechToTextSessionStart(e,t){e.updateState(3);let i=0;const o=()=>{i=(i+1)%4,e.setInputPlaceholder(`${u("listening","I'm listening")}${".".repeat(i)}`),n.schedule()},n=t.add(new re(o,500));o()}stop(e=this.voiceChatSessionIds,t){!this.currentVoiceChatSession||this.voiceChatSessionIds!==e||t&&this.currentVoiceChatSession.controller.context!==t||(this.currentVoiceChatSession.controller.clearInputPlaceholder(),this.currentVoiceChatSession.controller.updateState(1),this.currentVoiceChatSession.disposables.dispose(),this.currentVoiceChatSession=void 0)}async accept(e=this.voiceChatSessionIds){if(!this.currentVoiceChatSession||this.voiceChatSessionIds!==e)return;const t=this.currentVoiceChatSession.controller,i=await t.acceptInput();if(!i)return;const o=this.configurationService.getValue(Ie.AutoSynthesize);if(o==="on"||o==="auto"&&!this.accessibilityService.isScreenReaderOptimized()){let n;t.context==="inline"?n="focused":n=t,v.getInstance(this.instantiationService).start(this.instantiationService.invokeFunction(r=>X.create(r,n,i)))}}};l=H([h(0,ct),h(1,Q),h(2,b),h(3,mt)],l);const Re=500;async function Pe(a,e,t,i){const o=e.get(b),r=e.get(Se).enableKeybindingHoldMode(a),s=await f.create(e,t);if(!s)return;const d=await l.getInstance(o).start(s,i);let c=!1;const C=se(()=>{c=!0,d?.setTimeoutDisabled(!0)},Re);await r,C.dispose(),c&&d.accept()}class te extends T{constructor(t,i){super(t);this.target=i}run(t,i){return Pe(this.desc.id,t,this.target,i)}}class oe extends te{static ID="workbench.action.chat.voiceChatInChatView";constructor(){super({id:oe.ID,title:I("workbench.action.chat.voiceChatInView.label","Voice Chat in Chat View"),category:E,precondition:p.and(k,L.negate()),f1:!0},"view")}}class ie extends T{static ID="workbench.action.chat.holdToVoiceChatInChatView";constructor(){super({id:ie.ID,title:I("workbench.action.chat.holdToVoiceChatInChatView.label","Hold to Voice Chat in Chat View"),keybinding:{weight:V.WorkbenchContrib,when:p.and(k,L.negate(),ee?.negate(),ue.focus.negate(),Ae.negate()),primary:j.CtrlCmd|D.KeyI}})}async run(e,t){const i=e.get(b),o=e.get(Se),n=e.get(Ee),r=o.enableKeybindingHoldMode(ie.ID);let s;const d=se(async()=>{const c=await f.create(e,"view");c&&(s=await l.getInstance(i).start(c,t),s.setTimeoutDisabled(!0))},Re);(await fe(n))?.focusInput(),await r,d.dispose(),s&&s.accept()}}class B extends te{static ID="workbench.action.chat.inlineVoiceChat";constructor(){super({id:B.ID,title:I("workbench.action.chat.inlineVoiceChat","Inline Voice Chat"),category:E,precondition:p.and(k,et,L.negate()),f1:!0},"inline")}}class ne extends te{static ID="workbench.action.chat.quickVoiceChat";constructor(){super({id:ne.ID,title:I("workbench.action.chat.quickVoiceChat.label","Quick Voice Chat"),category:E,precondition:p.and(k,L.negate()),f1:!0},"quick")}}class He extends T{static ID="workbench.action.chat.startVoiceChat";constructor(){super({id:He.ID,title:I("workbench.action.chat.startVoiceChat.label","Start Voice Chat"),category:E,f1:!0,keybinding:{weight:V.WorkbenchContrib,when:p.and(ee,ue.focus.negate(),Ae.negate()),primary:j.CtrlCmd|D.KeyI},icon:K.mic,precondition:p.and(k,De.negate(),Tt?.negate(),lt.negate()),menu:[{id:A.ChatInput,when:p.and(P,m.negate(),N?.negate()),group:"navigation",order:-1},{id:G,when:p.and(P,m.negate(),N?.negate()),group:"navigation",order:-1}]})}async run(e,t){const i=t?.widget;return i&&i.focusInput(),Pe(this.desc.id,e,"focused",t)}}class Ke extends T{static ID="workbench.action.chat.stopListening";constructor(){super({id:Ke.ID,title:I("workbench.action.chat.stopListening.label","Stop Listening"),category:E,f1:!0,keybinding:{weight:V.WorkbenchContrib+100,primary:D.Escape,when:N},icon:Qe,precondition:ye,menu:[{id:A.ChatInput,when:N,group:"navigation",order:-1},{id:G,when:N,group:"navigation",order:-1}]})}async run(e){l.getInstance(e.get(b)).stop()}}class _e extends T{static ID="workbench.action.chat.stopListeningAndSubmit";constructor(){super({id:_e.ID,title:I("workbench.action.chat.stopListeningAndSubmit.label","Stop Listening and Submit"),category:E,f1:!0,keybinding:{weight:V.WorkbenchContrib,when:p.and(ee,N),primary:j.CtrlCmd|D.KeyI},precondition:ye})}run(e){l.getInstance(e.get(b)).accept()}}const m=new O("scopedChatSynthesisInProgress",!1,{type:"boolean",description:u("scopedChatSynthesisInProgress","Defined as a location where voice recording from microphone is in progress for voice chat. This key is only defined scoped, per chat context.")});class X{static create(e,t,i){return t==="focused"?X.doCreateForFocusedChat(e,i):{onDidHideChat:t.onDidHideInput,contextKeyService:t.scopedContextKeyService,response:i}}static doCreateForFocusedChat(e,t){const i=e.get(J),o=e.get(ve),r=e.get(ke).activeInstance;if(r){const d=U.activeChatWidget||U.get(r);if(d?.hasFocus())return{onDidHideChat:d.onDidHide,contextKeyService:d.scopedContextKeyService,response:t}}let s=i.getWidgetBySessionId(t.session.sessionId);return s?.location===_.Editor&&(s=i.lastFocusedWidget),{onDidHideChat:s?.onDidHide??Y.None,contextKeyService:s?.scopedContextKeyService??o,response:t}}}let v=class{constructor(e,t){this.speechService=e;this.instantiationService=t}static instance=void 0;static getInstance(e){return v.instance||(v.instance=e.createInstance(v)),v.instance}activeSession=void 0;async start(e){this.stop(),l.getInstance(this.instantiationService).stop();const t=this.activeSession=new $,i=new de;t.token.onCancellationRequested(()=>i.dispose());const o=await this.speechService.createTextToSpeechSession(t.token,"chat");if(t.token.isCancellationRequested)return;i.add(e.onDidHideChat(()=>this.stop()));const n=m.bindTo(e.contextKeyService);i.add(he(()=>n.reset())),i.add(o.onDidChange(r=>{switch(r.status){case we.Started:n.set(!0);break;case we.Stopped:n.reset();break}}));for await(const r of this.nextChatResponseChunk(e.response,t.token)){if(t.token.isCancellationRequested)return;await ae(o.synthesize(r),t.token)}}async*nextChatResponseChunk(e,t){let i=0,o=!1;do{const n=e.response.toString().length,{chunk:r,offset:s}=this.parseNextChatResponseChunk(e,i);if(i=s,o=e.isComplete,r&&(yield r),t.isCancellationRequested)return;!o&&n===e.response.toString().length&&await ae(Y.toPromise(e.onDidChange),t)}while(!t.isCancellationRequested&&!o)}parseNextChatResponseChunk(e,t){let i;const o=e.response.toString();if(e.isComplete)i=o.substring(t),t=o.length+1;else{const n=Et(o,t);i=n.chunk,t=n.offset}return{chunk:i&&bt({value:i}),offset:t}}stop(){this.activeSession?.dispose(!0),this.activeSession=void 0}};v=H([h(0,Z),h(1,b)],v);const wt=[".","!","?",":"],kt=`
`,xt=" ";function Et(a,e){let t;for(let i=a.length-1;i>=e;i--){const o=a[i],n=a[i+1];if(wt.includes(o)&&n===xt||kt===o){t=a.substring(e,i+1).trim(),e=i+1;break}}return{chunk:t,offset:e}}class Fi extends T{constructor(){super({id:"workbench.action.chat.readChatResponseAloud",title:I("workbench.action.chat.readChatResponseAloud","Read Aloud"),icon:K.unmute,precondition:k,menu:[{id:A.ChatMessageTitle,when:p.and(k,M,m.negate(),W.negate()),group:"navigation"},{id:Te,when:p.and(k,M,m.negate(),W.negate()),group:"navigation"}]})}run(e,...t){const i=e.get(b),o=e.get(J);let n;if(t.length>0){const s=t[0];be(n)&&(n=s)}else{const s=o.lastFocusedWidget;if(s){const d=s.getFocus();if(d instanceof at)n=d;else{const c=s.viewModel;if(c){const C=c.getItems();for(let x=C.length-1;x>=0;x--){const y=C[x];if(be(y)){n=y;break}}}}}}if(!n)return;const r=X.create(e,"focused",n.model);v.getInstance(i).start(r)}}class Le extends T{static ID="workbench.action.speech.stopReadAloud";constructor(){super({id:Le.ID,icon:Je,title:I("workbench.action.speech.stopReadAloud","Stop Reading Aloud"),f1:!0,category:E,precondition:vt,keybinding:{weight:V.WorkbenchContrib+100,primary:D.Escape,when:m},menu:[{id:A.ChatInput,when:m,group:"navigation",order:-1},{id:G,when:m,group:"navigation",order:-1}]})}async run(e){v.getInstance(e.get(b)).stop()}}class Oe extends T{static ID="workbench.action.chat.stopReadChatItemAloud";constructor(){super({id:Oe.ID,icon:K.mute,title:I("workbench.action.chat.stopReadChatItemAloud","Stop Reading Aloud"),precondition:m,keybinding:{weight:V.WorkbenchContrib+100,primary:D.Escape},menu:[{id:A.ChatMessageTitle,when:p.and(m,M,W.negate()),group:"navigation"},{id:Te,when:p.and(m,M,W.negate()),group:"navigation"}]})}async run(e,...t){v.getInstance(e.get(b)).stop()}}function Ne(a,e,t){if(!e.hasSpeechProvider||!t.getDefaultAgent(_.Panel))return!1;const i=a.getValue(R);return typeof i=="string"&&i!==S.SETTINGS_VALUE.OFF}let S=class extends ce{constructor(t,i,o,n,r,s,d){super();this.speechService=t;this.configurationService=i;this.commandService=o;this.editorService=r;this.hostService=s;this.chatAgentService=d;this._register(n.createInstance(g)),this.registerListeners()}static ID="workbench.contrib.keywordActivation";static SETTINGS_VALUE={OFF:"off",INLINE_CHAT:"inlineChat",QUICK_CHAT:"quickChat",VIEW_CHAT:"chatInView",CHAT_IN_CONTEXT:"chatInContext"};activeSession=void 0;registerListeners(){this._register(Y.runAndSubscribe(this.speechService.onDidChangeHasSpeechProvider,()=>{this.updateConfiguration(),this.handleKeywordActivation()}));const t=this._register(this.chatAgentService.onDidChangeAgents(()=>{this.chatAgentService.getDefaultAgent(_.Panel)&&(this.updateConfiguration(),this.handleKeywordActivation(),t.dispose())}));this._register(this.speechService.onDidStartSpeechToTextSession(()=>this.handleKeywordActivation())),this._register(this.speechService.onDidEndSpeechToTextSession(()=>this.handleKeywordActivation())),this._register(this.configurationService.onDidChangeConfiguration(i=>{i.affectsConfiguration(R)&&this.handleKeywordActivation()}))}updateConfiguration(){if(!this.speechService.hasSpeechProvider||!this.chatAgentService.getDefaultAgent(_.Panel))return;Ye.as(ze.Configuration).registerConfiguration({...ot,properties:{[R]:{type:"string",enum:[S.SETTINGS_VALUE.OFF,S.SETTINGS_VALUE.VIEW_CHAT,S.SETTINGS_VALUE.QUICK_CHAT,S.SETTINGS_VALUE.INLINE_CHAT,S.SETTINGS_VALUE.CHAT_IN_CONTEXT],enumDescriptions:[u("voice.keywordActivation.off","Keyword activation is disabled."),u("voice.keywordActivation.chatInView","Keyword activation is enabled and listening for 'Hey Code' to start a voice chat session in the chat view."),u("voice.keywordActivation.quickChat","Keyword activation is enabled and listening for 'Hey Code' to start a voice chat session in the quick chat."),u("voice.keywordActivation.inlineChat","Keyword activation is enabled and listening for 'Hey Code' to start a voice chat session in the active editor if possible."),u("voice.keywordActivation.chatInContext","Keyword activation is enabled and listening for 'Hey Code' to start a voice chat session in the active editor or view depending on keyboard focus.")],description:u("voice.keywordActivation","Controls whether the keyword phrase 'Hey Code' is recognized to start a voice chat session. Enabling this will start recording from the microphone but the audio is processed locally and never sent to a server."),default:"off",tags:["accessibility"]}}})}handleKeywordActivation(){const t=Ne(this.configurationService,this.speechService,this.chatAgentService)&&!this.speechService.hasActiveSpeechToTextSession;t&&this.activeSession||!t&&!this.activeSession||(t?this.enableKeywordActivation():this.disableKeywordActivation())}async enableKeywordActivation(){const t=this.activeSession=new $,i=await this.speechService.recognizeKeyword(t.token);t.token.isCancellationRequested||t!==this.activeSession||(this.activeSession=void 0,i===ut.Recognized&&(this.hostService.hasFocus&&this.commandService.executeCommand(this.getKeywordCommand()),this.handleKeywordActivation()))}getKeywordCommand(){switch(this.configurationService.getValue(R)){case S.SETTINGS_VALUE.INLINE_CHAT:return B.ID;case S.SETTINGS_VALUE.QUICK_CHAT:return ne.ID;case S.SETTINGS_VALUE.CHAT_IN_CONTEXT:if(pe(this.editorService.activeTextEditorControl)?.hasWidgetFocus())return B.ID;default:return oe.ID}}disableKeywordActivation(){this.activeSession?.dispose(!0),this.activeSession=void 0}dispose(){this.activeSession?.dispose(),super.dispose()}};S=H([h(0,Z),h(1,Q),h(2,le),h(3,b),h(4,xe),h(5,gt),h(6,me)],S);let g=class extends ce{constructor(t,i,o,n,r){super();this.speechService=t;this.statusbarService=i;this.commandService=o;this.configurationService=n;this.chatAgentService=r;this._register(Xe.registerCommand(g.STATUS_COMMAND,()=>this.commandService.executeCommand("workbench.action.openSettings",R))),this.registerListeners(),this.updateStatusEntry()}entry=this._register(new qe);static STATUS_NAME=u("keywordActivation.status.name","Voice Keyword Activation");static STATUS_COMMAND="keywordActivation.status.command";static STATUS_ACTIVE=u("keywordActivation.status.active","Listening to 'Hey Code'...");static STATUS_INACTIVE=u("keywordActivation.status.inactive","Waiting for voice chat to end...");registerListeners(){this._register(this.speechService.onDidStartKeywordRecognition(()=>this.updateStatusEntry())),this._register(this.speechService.onDidEndKeywordRecognition(()=>this.updateStatusEntry())),this._register(this.configurationService.onDidChangeConfiguration(t=>{t.affectsConfiguration(R)&&this.updateStatusEntry()}))}updateStatusEntry(){Ne(this.configurationService,this.speechService,this.chatAgentService)?(this.entry.value||this.createStatusEntry(),this.updateStatusLabel()):this.entry.clear()}createStatusEntry(){this.entry.value=this.statusbarService.addEntry(this.getStatusEntryProperties(),"status.voiceKeywordActivation",ft.RIGHT,103)}getStatusEntryProperties(){return{name:g.STATUS_NAME,text:this.speechService.hasActiveKeywordRecognition?"$(mic-filled)":"$(mic)",tooltip:this.speechService.hasActiveKeywordRecognition?g.STATUS_ACTIVE:g.STATUS_INACTIVE,ariaLabel:this.speechService.hasActiveKeywordRecognition?g.STATUS_ACTIVE:g.STATUS_INACTIVE,command:g.STATUS_COMMAND,kind:"prominent",showInAllWindows:!0}}updateStatusLabel(){this.entry.value?.update(this.getStatusEntryProperties())}};g=H([h(0,Z),h(1,It),h(2,le),h(3,Q),h(4,me)],g);const q=new O("installingSpeechProvider",!1,!0);class z extends T{static SPEECH_EXTENSION_ID="ms-vscode.vscode-speech";async run(e){const t=e.get(ve),i=e.get(dt);try{q.bindTo(t).set(!0),await i.install(z.SPEECH_EXTENSION_ID,{justification:this.getJustification(),enable:!0},$e.Notification)}finally{q.bindTo(t).reset()}}}class Me extends z{static ID="_workbench.action.chat.installProviderForVoiceChat";constructor(){super({id:Me.ID,title:I("workbench.action.chat.installProviderForVoiceChat.label","Start Voice Chat"),icon:K.mic,precondition:q.negate(),menu:[{id:A.ChatInput,when:P.negate(),group:"navigation",order:-1},{id:G,when:P.negate(),group:"navigation",order:-1}]})}getJustification(){return u("installProviderForVoiceChat.justification","Microphone support requires this extension.")}}class We extends z{static ID="_workbench.action.chat.installProviderForSynthesis";constructor(){super({id:We.ID,title:I("workbench.action.chat.installProviderForSynthesis.label","Read Aloud"),icon:K.unmute,precondition:q.negate(),menu:[{id:A.ChatMessageTitle,when:P.negate(),group:"navigation"}]})}getJustification(){return u("installProviderForSynthesis.justification","Speaker support requires this extension.")}}Ze((a,e)=>{let t,i;a.type===Ce.LIGHT||a.type===Ce.DARK?(t=a.getColor(tt)??a.getColor(je),i=t?.transparent(.38)):(t=a.getColor(ge),i=a.getColor(ge)),e.addRule(`
		.monaco-workbench:not(.reduce-motion) .interactive-input-part .monaco-action-bar .action-label.codicon-sync.codicon-modifier-spin:not(.disabled),
		.monaco-workbench:not(.reduce-motion) .interactive-input-part .monaco-action-bar .action-label.codicon-loading.codicon-modifier-spin:not(.disabled) {
			color: ${t};
			outline: 1px solid ${t};
			outline-offset: -1px;
			animation: pulseAnimation 1s infinite;
			border-radius: 50%;
		}

		.monaco-workbench:not(.reduce-motion) .interactive-input-part .monaco-action-bar .action-label.codicon-sync.codicon-modifier-spin:not(.disabled)::before,
		.monaco-workbench:not(.reduce-motion) .interactive-input-part .monaco-action-bar .action-label.codicon-loading.codicon-modifier-spin:not(.disabled)::before {
			position: absolute;
			outline: 1px solid ${t};
			outline-offset: 2px;
			border-radius: 50%;
			width: 16px;
			height: 16px;
		}

		.monaco-workbench:not(.reduce-motion) .interactive-input-part .monaco-action-bar .action-label.codicon-sync.codicon-modifier-spin:not(.disabled)::after,
		.monaco-workbench:not(.reduce-motion) .interactive-input-part .monaco-action-bar .action-label.codicon-loading.codicon-modifier-spin:not(.disabled)::after {
			outline: 2px solid ${t};
			outline-offset: -1px;
			animation: pulseAnimation 1500ms cubic-bezier(0.75, 0, 0.25, 1) infinite;
		}

		.monaco-workbench:not(.reduce-motion) .interactive-input-part .monaco-action-bar .action-label.codicon-sync.codicon-modifier-spin:not(.disabled)::before,
		.monaco-workbench:not(.reduce-motion) .interactive-input-part .monaco-action-bar .action-label.codicon-loading.codicon-modifier-spin:not(.disabled)::before {
			position: absolute;
			outline: 1px solid ${t};
			outline-offset: 2px;
			border-radius: 50%;
			width: 16px;
			height: 16px;
		}

		@keyframes pulseAnimation {
			0% {
				outline-width: 2px;
			}
			62% {
				outline-width: 5px;
				outline-color: ${i};
			}
			100% {
				outline-width: 2px;
			}
		}
	`)});export{ie as HoldToVoiceChatInChatViewAction,B as InlineVoiceChatAction,We as InstallSpeechProviderForSynthesizeChatAction,Me as InstallSpeechProviderForVoiceChatAction,S as KeywordActivationContribution,ne as QuickVoiceChatAction,Fi as ReadChatResponseAloud,He as StartVoiceChatAction,Ke as StopListeningAction,_e as StopListeningAndSubmitAction,Le as StopReadAloud,Oe as StopReadChatItemAloud,Re as VOICE_KEY_HOLD_THRESHOLD,oe as VoiceChatInChatViewAction,Et as parseNextChatResponseChunk};
