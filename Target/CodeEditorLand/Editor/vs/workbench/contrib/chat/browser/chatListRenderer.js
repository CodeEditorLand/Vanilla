var Z=Object.defineProperty;var ee=Object.getOwnPropertyDescriptor;var b=(y,l,e,r)=>{for(var t=r>1?void 0:r?ee(l,e):l,n=y.length-1,o;n>=0;n--)(o=y[n])&&(t=(r?o(l,e,t):o(t))||t);return r&&t&&Z(l,e,t),t},g=(y,l)=>(e,r)=>l(e,r,y);import*as d from"../../../../../vs/base/browser/dom.js";import{renderFormattedText as te}from"../../../../../vs/base/browser/formattedTextRenderer.js";import{StandardKeyboardEvent as re}from"../../../../../vs/base/browser/keyboardEvent.js";import"../../../../../vs/base/browser/ui/actionbar/actionViewItems.js";import{getDefaultHoverDelegate as ne}from"../../../../../vs/base/browser/ui/hover/hoverDelegateFactory.js";import"../../../../../vs/base/browser/ui/list/list.js";import"../../../../../vs/base/browser/ui/tree/tree.js";import"../../../../../vs/base/common/actions.js";import{coalesce as oe,distinct as ie}from"../../../../../vs/base/common/arrays.js";import{Codicon as x}from"../../../../../vs/base/common/codicons.js";import{Emitter as w}from"../../../../../vs/base/common/event.js";import"../../../../../vs/base/common/filters.js";import{MarkdownString as k}from"../../../../../vs/base/common/htmlContent.js";import{KeyCode as L}from"../../../../../vs/base/common/keyCodes.js";import{Disposable as se,DisposableStore as O,dispose as V,toDisposable as H}from"../../../../../vs/base/common/lifecycle.js";import{ResourceMap as ae}from"../../../../../vs/base/common/map.js";import{FileAccess as de}from"../../../../../vs/base/common/network.js";import{clamp as ce}from"../../../../../vs/base/common/numbers.js";import{autorun as he}from"../../../../../vs/base/common/observable.js";import{ThemeIcon as le}from"../../../../../vs/base/common/themables.js";import{URI as Ce}from"../../../../../vs/base/common/uri.js";import"../../../../../vs/editor/browser/widget/markdownRenderer/browser/markdownRenderer.js";import{localize as M}from"../../../../../vs/nls.js";import{createActionViewItem as ue,MenuEntryActionViewItem as pe}from"../../../../../vs/platform/actions/browser/menuEntryActionViewItem.js";import{MenuWorkbenchToolBar as fe}from"../../../../../vs/platform/actions/browser/toolbar.js";import{MenuId as Ie,MenuItemAction as me}from"../../../../../vs/platform/actions/common/actions.js";import{ICommandService as ge}from"../../../../../vs/platform/commands/common/commands.js";import{IConfigurationService as ve}from"../../../../../vs/platform/configuration/common/configuration.js";import{IContextKeyService as _}from"../../../../../vs/platform/contextkey/common/contextkey.js";import{IHoverService as Re}from"../../../../../vs/platform/hover/browser/hover.js";import{IInstantiationService as Te}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{ServiceCollection as $}from"../../../../../vs/platform/instantiation/common/serviceCollection.js";import{ILogService as U}from"../../../../../vs/platform/log/common/log.js";import{ColorScheme as ye}from"../../../../../vs/platform/theme/common/theme.js";import{IThemeService as Pe}from"../../../../../vs/platform/theme/common/themeService.js";import{GeneratingPhrase as we}from"../../../../../vs/workbench/contrib/chat/browser/chat.js";import{ChatAgentHover as Se,getChatAgentHoverOptions as Ee}from"../../../../../vs/workbench/contrib/chat/browser/chatAgentHover.js";import{ChatAttachmentsContentPart as be}from"../../../../../vs/workbench/contrib/chat/browser/chatContentParts/chatAttachmentsContentPart.js";import{ChatCodeCitationContentPart as ke}from"../../../../../vs/workbench/contrib/chat/browser/chatContentParts/chatCodeCitationContentPart.js";import{ChatCommandButtonContentPart as Le}from"../../../../../vs/workbench/contrib/chat/browser/chatContentParts/chatCommandContentPart.js";import{ChatConfirmationContentPart as He}from"../../../../../vs/workbench/contrib/chat/browser/chatContentParts/chatConfirmationContentPart.js";import"../../../../../vs/workbench/contrib/chat/browser/chatContentParts/chatContentParts.js";import{ChatMarkdownContentPart as K,EditorPool as Me}from"../../../../../vs/workbench/contrib/chat/browser/chatContentParts/chatMarkdownContentPart.js";import{ChatProgressContentPart as _e}from"../../../../../vs/workbench/contrib/chat/browser/chatContentParts/chatProgressContentPart.js";import{ChatCollapsibleListContentPart as De,CollapsibleListPool as Be}from"../../../../../vs/workbench/contrib/chat/browser/chatContentParts/chatReferencesContentPart.js";import{ChatTaskContentPart as Ae}from"../../../../../vs/workbench/contrib/chat/browser/chatContentParts/chatTaskContentPart.js";import{ChatTextEditContentPart as Fe,DiffEditorPool as Ne}from"../../../../../vs/workbench/contrib/chat/browser/chatContentParts/chatTextEditContentPart.js";import{ChatTreeContentPart as q,TreePool as We}from"../../../../../vs/workbench/contrib/chat/browser/chatContentParts/chatTreeContentPart.js";import{ChatWarningContentPart as z}from"../../../../../vs/workbench/contrib/chat/browser/chatContentParts/chatWarningContentPart.js";import{ChatFollowups as xe}from"../../../../../vs/workbench/contrib/chat/browser/chatFollowups.js";import{ChatMarkdownDecorationsRenderer as Oe}from"../../../../../vs/workbench/contrib/chat/browser/chatMarkdownDecorationsRenderer.js";import{ChatMarkdownRenderer as Ve}from"../../../../../vs/workbench/contrib/chat/browser/chatMarkdownRenderer.js";import"../../../../../vs/workbench/contrib/chat/browser/chatOptions.js";import{ChatCodeBlockContentProvider as $e}from"../../../../../vs/workbench/contrib/chat/browser/codeBlockPart.js";import"../../../../../vs/workbench/contrib/chat/common/chatAgents.js";import{CONTEXT_CHAT_RESPONSE_SUPPORT_ISSUE_REPORTING as Ue,CONTEXT_REQUEST as Ke,CONTEXT_RESPONSE as qe,CONTEXT_RESPONSE_DETECTED_AGENT_COMMAND as ze,CONTEXT_RESPONSE_ERROR as Xe,CONTEXT_RESPONSE_FILTERED as Ge,CONTEXT_RESPONSE_VOTE as X}from"../../../../../vs/workbench/contrib/chat/common/chatContextKeys.js";import"../../../../../vs/workbench/contrib/chat/common/chatModel.js";import{chatSubcommandLeader as Je}from"../../../../../vs/workbench/contrib/chat/common/chatParserTypes.js";import{ChatAgentVoteDirection as G}from"../../../../../vs/workbench/contrib/chat/common/chatService.js";import{isRequestVM as v,isResponseVM as h,isWelcomeVM as Qe}from"../../../../../vs/workbench/contrib/chat/common/chatViewModel.js";import{getNWords as Ye}from"../../../../../vs/workbench/contrib/chat/common/chatWordCounter.js";import{annotateSpecialMarkdownContent as J}from"../common/annotations.js";import"../common/codeBlockModelCollection.js";const p=d.$,Q=!1;let T=class extends se{constructor(e,r,t,n,o,a,s,c,i,u,C,I,D){super();this.location=r;this.rendererOptions=t;this.delegate=n;this.codeBlockModelCollection=o;this.instantiationService=s;this.logService=i;this.contextKeyService=u;this.themeService=C;this.commandService=I;this.hoverService=D;this.renderer=this._register(this.instantiationService.createInstance(Ve,void 0)),this.markdownDecorationsRenderer=this.instantiationService.createInstance(Oe),this._editorPool=this._register(this.instantiationService.createInstance(Me,e,n,a)),this._diffEditorPool=this._register(this.instantiationService.createInstance(Ne,e,n,a)),this._treePool=this._register(this.instantiationService.createInstance(We,this._onDidChangeVisibility.event)),this._contentReferencesListPool=this._register(this.instantiationService.createInstance(Be,this._onDidChangeVisibility.event)),this._register(this.instantiationService.createInstance($e))}static ID="item";codeBlocksByResponseId=new Map;codeBlocksByEditorUri=new ae;fileTreesByResponseId=new Map;focusedFileTreesByResponseId=new Map;renderer;markdownDecorationsRenderer;_onDidClickFollowup=this._register(new w);onDidClickFollowup=this._onDidClickFollowup.event;_onDidClickRerunWithAgentOrCommandDetection=new w;onDidClickRerunWithAgentOrCommandDetection=this._onDidClickRerunWithAgentOrCommandDetection.event;_onDidChangeItemHeight=this._register(new w);onDidChangeItemHeight=this._onDidChangeItemHeight.event;_editorPool;_diffEditorPool;_treePool;_contentReferencesListPool;_currentLayoutWidth=0;_isVisible=!0;_onDidChangeVisibility=this._register(new w);get templateId(){return T.ID}editorsInUse(){return this._editorPool.inUse()}traceLayout(e,r){Q?this.logService.info(`ChatListItemRenderer#${e}: ${r}`):this.logService.trace(`ChatListItemRenderer#${e}: ${r}`)}getProgressiveRenderRate(e){if(e.isComplete)return 80;if(e.contentUpdateTimings&&e.contentUpdateTimings.impliedWordLoadRate){const n=e.contentUpdateTimings.impliedWordLoadRate;return ce(n,5,80)}return 8}getCodeBlockInfosForResponse(e){return this.codeBlocksByResponseId.get(e.id)??[]}getCodeBlockInfoForEditor(e){return this.codeBlocksByEditorUri.get(e)}getFileTreeInfosForResponse(e){return this.fileTreesByResponseId.get(e.id)??[]}getLastFocusedFileTreeForResponse(e){const r=this.fileTreesByResponseId.get(e.id),t=this.focusedFileTreesByResponseId.get(e.id);if(r?.length&&t!==void 0&&t<r.length)return r[t]}setVisible(e){this._isVisible=e,this._onDidChangeVisibility.fire(e)}layout(e){this._currentLayoutWidth=e-(this.rendererOptions.noPadding?0:40);for(const r of this._editorPool.inUse())r.layout(this._currentLayoutWidth);for(const r of this._diffEditorPool.inUse())r.layout(this._currentLayoutWidth)}renderTemplate(e){const r=new O,t=d.append(e,p(".interactive-item-container"));this.rendererOptions.renderStyle==="compact"&&t.classList.add("interactive-item-compact"),this.rendererOptions.noPadding&&t.classList.add("no-padding");let n=t,o=t,a,s;if(this.rendererOptions.renderStyle==="minimal"){t.classList.add("interactive-item-compact"),t.classList.add("minimal");const f=d.append(t,p(".column.left")),m=d.append(t,p(".column.right"));n=f,a=m,o=m,s=d.append(t,p(".header"))}const c=d.append(n,p(".header")),i=d.append(c,p(".user"));i.tabIndex=0,i.role="toolbar";const u=d.append(i,p(".avatar-container")),C=d.append(i,p("h3.username")),I=d.append(a??i,p("span.detail-container")),D=d.append(I,p("span.detail"));d.append(I,p("span.chat-animated-ellipsis"));const Y=d.append(o,p(".value")),j=new O,B=r.add(this.contextKeyService.createScoped(t)),P=r.add(this.instantiationService.createChild(new $([_,B])));let A;this.rendererOptions.noHeader?c.classList.add("hidden"):A=r.add(P.createInstance(fe,s??c,Ie.ChatMessageTitle,{menuOptions:{shouldForwardArgs:!0},toolbarOptions:{shouldInlineSubmenu:f=>f.actions.length<=1},actionViewItemProvider:(f,m)=>f instanceof me&&(f.item.id==="workbench.action.chat.voteDown"||f.item.id==="workbench.action.chat.voteUp")?P.createInstance(je,f,m):ue(P,f,m)}));const E=r.add(this.instantiationService.createInstance(Se)),F=()=>{if(h(R.currentElement)&&R.currentElement.agent&&!R.currentElement.agent.isDefault)return E.setAgent(R.currentElement.agent.id),E.domNode},N=Ee(()=>h(R.currentElement)?R.currentElement.agent:void 0,this.commandService);r.add(this.hoverService.setupManagedHover(ne("element"),i,F,N)),r.add(d.addDisposableListener(i,d.EventType.KEY_DOWN,f=>{const m=new re(f);if(m.equals(L.Space)||m.equals(L.Enter)){const W=F();W&&this.hoverService.showHover({content:W,target:i,trapFocus:!0,actions:N.actions},!0)}else m.equals(L.Escape)&&this.hoverService.hideHover()}));const R={avatarContainer:u,username:C,detail:D,value:Y,rowContainer:t,elementDisposables:j,titleToolbar:A,templateDisposables:r,contextKeyService:B,instantiationService:P,agentHover:E};return R}renderElement(e,r,t){this.renderChatTreeItem(e.element,r,t)}renderChatTreeItem(e,r,t){t.currentElement=e;const n=v(e)?"request":h(e)?"response":"welcome";this.traceLayout("renderElement",`${n}, index=${r}`),qe.bindTo(t.contextKeyService).set(h(e)),Ke.bindTo(t.contextKeyService).set(v(e)),ze.bindTo(t.contextKeyService).set(h(e)&&e.agentOrSlashCommandDetected),h(e)?(Ue.bindTo(t.contextKeyService).set(!!e.agent?.metadata.supportIssueReporting),X.bindTo(t.contextKeyService).set(e.vote===G.Up?"up":e.vote===G.Down?"down":"")):X.bindTo(t.contextKeyService).set(""),t.titleToolbar&&(t.titleToolbar.context=e),Xe.bindTo(t.contextKeyService).set(h(e)&&!!e.errorDetails);const o=!!(h(e)&&e.errorDetails?.responseIsFiltered);if(Ge.bindTo(t.contextKeyService).set(o),t.rowContainer.classList.toggle("interactive-request",v(e)),t.rowContainer.classList.toggle("interactive-response",h(e)),t.rowContainer.classList.toggle("interactive-welcome",Qe(e)),t.rowContainer.classList.toggle("show-detail-progress",h(e)&&!e.isComplete&&!e.progressMessages.length),t.username.textContent=e.username,this.rendererOptions.noHeader||this.renderAvatar(e,t),d.clearNode(t.detail),h(e)&&this.renderDetail(e,t),v(e)&&e.confirmation&&this.renderConfirmationAction(e,t),h(e)&&r===this.delegate.getListLength()-1&&(!e.isComplete||e.renderData)&&e.response.value.length){this.traceLayout("renderElement",`start progressive render ${n}, index=${r}`);const a=t.elementDisposables.add(new d.WindowIntervalTimer),s=c=>{try{this.doNextProgressiveRender(e,r,t,!!c)&&a.cancel()}catch(i){a.cancel(),this.logService.error(i)}};a.cancelAndSet(s,50,d.getWindow(t.rowContainer)),s(!0)}else h(e)?this.basicRenderElement(e,r,t):v(e)?this.basicRenderElement(e,r,t):this.renderWelcomeMessage(e,t)}renderDetail(e,r){r.elementDisposables.add(he(t=>{this._renderDetail(e,r)}))}_renderDetail(e,r){if(d.clearNode(r.detail),e.agentOrSlashCommandDetected){const t=e.slashCommand?M("usedAgentSlashCommand","used {0} [[(rerun without)]]",`${Je}${e.slashCommand.name}`):M("usedAgent","[[(rerun without)]]");d.reset(r.detail,te(t,{className:"agentOrSlashCommandDetected",inline:!0,actionHandler:{disposables:r.elementDisposables,callback:n=>{this._onDidClickRerunWithAgentOrCommandDetection.fire(e)}}}))}else e.isComplete||(r.detail.textContent=we)}renderConfirmationAction(e,r){d.clearNode(r.detail),e.confirmation&&(r.detail.textContent=M("chatConfirmationAction",'selected "{0}"',e.confirmation))}renderAvatar(e,r){const t=h(e)?this.getAgentIcon(e.agent?.metadata):e.avatarIcon??x.account;if(t instanceof Ce){const n=d.$("img.icon");n.src=de.uriToBrowserUri(t).toString(!0),r.avatarContainer.replaceChildren(d.$(".avatar",void 0,n))}else{const n=d.$(le.asCSSSelector(t));r.avatarContainer.replaceChildren(d.$(".avatar.codicon-avatar",void 0,n))}}getAgentIcon(e){return e?.themeIcon?e.themeIcon:e?.iconDark&&this.themeService.getColorTheme().type===ye.DARK?e.iconDark:e?.icon?e.icon:x.copilot}basicRenderElement(e,r,t){let n=[];if(v(e)&&!e.confirmation){const i="message"in e.message?e.message.message:this.markdownDecorationsRenderer.convertParsedRequestToMarkdown(e.message);n=[{content:new k(i),kind:"markdownContent"}]}else h(e)&&(e.contentReferences.length&&n.push({kind:"references",references:e.contentReferences}),n.push(...J(e.response.value)),e.codeCitations.length&&n.push({kind:"codeCitations",citations:e.codeCitations}));d.clearNode(t.value),h(e)&&this.renderDetail(e,t);const o=!!(h(e)&&e.errorDetails?.responseIsFiltered),a=[];if(o||n.forEach((i,u)=>{const C={element:e,index:u,content:n,preceedingContentParts:a},I=this.renderChatContentPart(i,t,C);I&&(t.value.appendChild(I.domNode),a.push(I))}),t.renderedParts&&V(t.renderedParts),t.renderedParts=a,!o&&v(e)&&e.variables.length){const i=this.renderAttachments(e.variables,e.contentReferences,t);i&&(t.value.appendChild(i.domNode),t.elementDisposables.add(i))}if(h(e)&&e.errorDetails?.message){const i=this.instantiationService.createInstance(z,e.errorDetails.responseIsFiltered?"info":"error",new k(e.errorDetails.message),this.renderer);t.elementDisposables.add(i),t.value.appendChild(i.domNode)}const s=t.rowContainer.offsetHeight,c=!e.currentRenderedHeight||e.currentRenderedHeight!==s;if(e.currentRenderedHeight=s,c){const i=t.elementDisposables.add(d.scheduleAtNextAnimationFrame(d.getWindow(t.value),()=>{e.currentRenderedHeight=t.rowContainer.offsetHeight,i.dispose(),this._onDidChangeItemHeight.fire({element:e,height:e.currentRenderedHeight})}))}}updateItemHeight(e){if(!e.currentElement)return;const r=e.rowContainer.offsetHeight;e.currentElement.currentRenderedHeight=r,this._onDidChangeItemHeight.fire({element:e.currentElement,height:r})}renderWelcomeMessage(e,r){d.clearNode(r.value),e.content.forEach((o,a)=>{if(Array.isArray(o)){const s=r.elementDisposables.add(this.instantiationService.createChild(new $([_,r.contextKeyService])));r.elementDisposables.add(s.createInstance(xe,r.value,o,this.location,void 0,c=>this._onDidClickFollowup.fire(c)))}else{const s={element:e,index:a,content:[],preceedingContentParts:[]},c=this.renderMarkdown(o,r,s);r.value.appendChild(c.domNode),r.elementDisposables.add(c)}});const t=r.rowContainer.offsetHeight,n=!e.currentRenderedHeight||e.currentRenderedHeight!==t;if(e.currentRenderedHeight=t,n){const o=r.elementDisposables.add(d.scheduleAtNextAnimationFrame(d.getWindow(r.value),()=>{e.currentRenderedHeight=r.rowContainer.offsetHeight,o.dispose(),this._onDidChangeItemHeight.fire({element:e,height:e.currentRenderedHeight})}))}}doNextProgressiveRender(e,r,t,n){if(!this._isVisible)return!0;if(e.isCanceled)return this.traceLayout("doNextProgressiveRender",`canceled, index=${r}`),e.renderData=void 0,this.basicRenderElement(e,r,t),!0;let o=!1;this.traceLayout("doNextProgressiveRender",`START progressive render, index=${r}, renderData=${JSON.stringify(e.renderData)}`);const a=this.getNextProgressiveRenderContent(e),s=this.diff(t.renderedParts??[],a,e);if(o=s.every(i=>i===null),o)return e.isComplete?(this.traceLayout("doNextProgressiveRender",`END progressive render, index=${r} and clearing renderData, response is complete`),e.renderData=void 0,this.basicRenderElement(e,r,t),!0):(this.traceLayout("doNextProgressiveRender","caught up with the stream- no new content to render"),!1);this.traceLayout("doNextProgressiveRender",`doing progressive render, ${s.length} parts to render`),this.renderChatContentDiff(s,a,e,t);const c=t.rowContainer.offsetHeight;return e.currentRenderedHeight=c,n||this._onDidChangeItemHeight.fire({element:e,height:t.rowContainer.offsetHeight}),!1}renderChatContentDiff(e,r,t,n){const o=n.renderedParts??[];n.renderedParts=o,e.forEach((a,s)=>{if(!a)return;const c=n.renderedParts?.[s];c&&c.dispose();const i=o.slice(0,s),u={element:t,content:r,preceedingContentParts:i,index:s},C=this.renderChatContentPart(a,n,u);if(C){if(c)try{c.domNode.replaceWith(C.domNode)}catch(I){this.logService.error("ChatListItemRenderer#renderChatContentDiff: error replacing part",I)}else n.value.appendChild(C.domNode);o[s]=C}else c&&c.domNode.remove()})}getNextProgressiveRenderContent(e){const r=this.getDataForProgressiveRender(e),t=J(e.response.value);this.traceLayout("getNextProgressiveRenderContent",`Want to render ${r.numWordsToRender} at ${r.rate} words/s, counting...`);let n=r.numWordsToRender;const o=[];e.contentReferences.length&&o.push({kind:"references",references:e.contentReferences});for(let i=0;i<t.length;i++){const u=t[i];if(n<=0)break;if(u.kind==="markdownContent"){const C=Ye(u.content.value,n);C.isFullString?o.push(u):o.push({kind:"markdownContent",content:new k(C.value,u.content)}),this.traceLayout("getNextProgressiveRenderContent",`  Chunk ${i}: Want to render ${n} words and found ${C.returnedWordCount} words. Total words in chunk: ${C.totalWordCount}`),n-=C.returnedWordCount}else o.push(u)}const a=e.contentUpdateTimings?.lastWordCount??0,s=r.numWordsToRender-n,c=a-s;return this.traceLayout("getNextProgressiveRenderContent",`Want to render ${r.numWordsToRender} words. Rendering ${s} words. Buffer: ${c} words`),s>0&&s!==e.renderData?.renderedWordCount&&(e.renderData={lastRenderTime:Date.now(),renderedWordCount:s,renderedParts:o}),o}getDataForProgressiveRender(e){const r=e.renderData??{lastRenderTime:0,renderedWordCount:0},t=this.getProgressiveRenderRate(e);return{numWordsToRender:r.lastRenderTime===0?1:r.renderedWordCount+Math.floor((Date.now()-r.lastRenderTime)/1e3*t),rate:t}}diff(e,r,t){const n=[];for(let o=0;o<r.length;o++){const a=r[o],s=e[o];!s||!s.hasSameContent(a,r.slice(o+1),t)?n.push(a):n.push(null)}return n}renderChatContentPart(e,r,t){if(e.kind==="treeData")return this.renderTreeData(e,r,t);if(e.kind==="progressMessage")return this.instantiationService.createInstance(_e,e,this.renderer,t);if(e.kind==="progressTask")return this.renderProgressTask(e,r,t);if(e.kind==="command")return this.instantiationService.createInstance(Le,e,t);if(e.kind==="textEditGroup")return this.renderTextEdit(t,e,r);if(e.kind==="confirmation")return this.renderConfirmation(t,e,r);if(e.kind==="warning")return this.instantiationService.createInstance(z,"warning",e.content,this.renderer);if(e.kind==="markdownContent")return this.renderMarkdown(e.content,r,t);if(e.kind==="references")return this.renderContentReferencesListData(e,void 0,t,r);if(e.kind==="codeCitations")return this.renderCodeCitationsListData(e,t,r)}renderTreeData(e,r,t){const n=e.treeData,o=t.preceedingContentParts.filter(s=>s instanceof q).length,a=this.instantiationService.createInstance(q,n,t.element,this._treePool,o);if(a.addDisposable(a.onDidChangeHeight(()=>{this.updateItemHeight(r)})),h(t.element)){const s={treeDataId:n.uri.toString(),treeIndex:o,focus(){a.domFocus()}};a.addDisposable(a.onDidFocus(()=>{this.focusedFileTreesByResponseId.set(t.element.id,s.treeIndex)}));const c=this.fileTreesByResponseId.get(t.element.id)??[];c.push(s),this.fileTreesByResponseId.set(t.element.id,ie(c,i=>i.treeDataId)),a.addDisposable(H(()=>this.fileTreesByResponseId.set(t.element.id,c.filter(i=>i.treeDataId!==n.uri.toString()))))}return a}renderContentReferencesListData(e,r,t,n){const o=this.instantiationService.createInstance(De,e.references,r,t.element,this._contentReferencesListPool);return o.addDisposable(o.onDidChangeHeight(()=>{this.updateItemHeight(n)})),o}renderCodeCitationsListData(e,r,t){return this.instantiationService.createInstance(ke,e,r)}renderProgressTask(e,r,t){if(!h(t.element))return;const n=this.instantiationService.createInstance(Ae,e,this._contentReferencesListPool,this.renderer,t);return n.addDisposable(n.onDidChangeHeight(()=>{this.updateItemHeight(r)})),n}renderConfirmation(e,r,t){const n=this.instantiationService.createInstance(He,r,e);return n.addDisposable(n.onDidChangeHeight(()=>this.updateItemHeight(t))),n}renderAttachments(e,r,t){return this.instantiationService.createInstance(be,e,r,void 0)}renderTextEdit(e,r,t){const n=this.instantiationService.createInstance(Fe,r,e,this.rendererOptions,this._diffEditorPool,this._currentLayoutWidth);return n.addDisposable(n.onDidChangeHeight(()=>{n.layout(this._currentLayoutWidth),this.updateItemHeight(t)})),n}renderMarkdown(e,r,t){const n=t.element,o=h(n)&&(!n.isComplete||n.isCanceled||n.errorDetails?.responseIsFiltered||n.errorDetails?.responseIsIncomplete||!!n.renderData),a=t.preceedingContentParts.reduce((i,u)=>i+(u instanceof K?u.codeblocks.length:0),0),s=this.instantiationService.createInstance(K,e,t,this._editorPool,o,a,this.renderer,this._currentLayoutWidth,this.codeBlockModelCollection,this.rendererOptions);s.addDisposable(s.onDidChangeHeight(()=>{s.layout(this._currentLayoutWidth),this.updateItemHeight(r)}));const c=this.codeBlocksByResponseId.get(n.id)??[];return this.codeBlocksByResponseId.set(n.id,c),s.addDisposable(H(()=>{const i=this.codeBlocksByResponseId.get(n.id);i&&s.codeblocks.forEach((u,C)=>delete i[a+C])})),s.codeblocks.forEach((i,u)=>{if(c[a+u]=i,i.uri){const C=i.uri;this.codeBlocksByEditorUri.set(C,i),s.addDisposable(H(()=>this.codeBlocksByEditorUri.delete(C)))}}),s}disposeElement(e,r,t){if(this.traceLayout("disposeElement",`Disposing element, index=${r}`),t.renderedParts)try{V(oe(t.renderedParts)),t.renderedParts=void 0,d.clearNode(t.value)}catch(n){throw n}t.currentElement=void 0,t.elementDisposables.clear()}disposeTemplate(e){e.templateDisposables.dispose()}};T=b([g(6,Te),g(7,ve),g(8,U),g(9,_),g(10,Pe),g(11,ge),g(12,Re)],T);let S=class{constructor(l,e){this.defaultElementHeight=l;this.logService=e}_traceLayout(l,e){Q?this.logService.info(`ChatListDelegate#${l}: ${e}`):this.logService.trace(`ChatListDelegate#${l}: ${e}`)}getHeight(l){const e=v(l)?"request":"response",r=("currentRenderedHeight"in l?l.currentRenderedHeight:void 0)??this.defaultElementHeight;return this._traceLayout("getHeight",`${e}, height=${r}`),r}getTemplateId(l){return T.ID}hasDynamicHeight(l){return!0}};S=b([g(1,U)],S);class je extends pe{render(l){super.render(l),l.classList.toggle("checked",this.action.checked)}}export{S as ChatListDelegate,T as ChatListItemRenderer};
