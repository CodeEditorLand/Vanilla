import{Codicon as d}from"../../../../../base/common/codicons.js";import{KeyCode as v,KeyMod as M}from"../../../../../base/common/keyCodes.js";import{marked as D}from"../../../../../base/common/marked/marked.js";import"../../../../../editor/browser/editorExtensions.js";import{IBulkEditService as U}from"../../../../../editor/browser/services/bulkEditService.js";import{localize2 as u}from"../../../../../nls.js";import{Action2 as l,MenuId as m,registerAction2 as g}from"../../../../../platform/actions/common/actions.js";import{ContextKeyExpr as i}from"../../../../../platform/contextkey/common/contextkey.js";import{KeybindingWeight as q}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import{IEditorService as P}from"../../../../services/editor/common/editorService.js";import{ResourceNotebookCellEdit as V}from"../../../bulkEdit/browser/bulkCellEdits.js";import{MENU_INLINE_CHAT_WIDGET_SECONDARY as I}from"../../../inlineChat/common/inlineChat.js";import"../../../notebook/browser/notebookBrowser.js";import{CellEditType as B,CellKind as S,NOTEBOOK_EDITOR_ID as H}from"../../../notebook/common/notebookCommon.js";import{NOTEBOOK_IS_ACTIVE_EDITOR as X}from"../../../notebook/common/notebookContextKeys.js";import{CONTEXT_CHAT_RESPONSE_SUPPORT_ISSUE_REPORTING as k,CONTEXT_IN_CHAT_INPUT as K,CONTEXT_IN_CHAT_SESSION as F,CONTEXT_REQUEST as W,CONTEXT_RESPONSE as s,CONTEXT_RESPONSE_ERROR as h,CONTEXT_RESPONSE_FILTERED as L,CONTEXT_RESPONSE_VOTE as w,CONTEXT_VOTE_UP_ENABLED as y}from"../../common/chatContextKeys.js";import{ChatAgentVoteDirection as E,IChatService as C}from"../../common/chatService.js";import{isRequestVM as R,isResponseVM as p}from"../../common/chatViewModel.js";import{IChatWidgetService as G}from"../chat.js";import{CHAT_CATEGORY as f}from"./chatActions.js";const Y="workbench.action.chat.markUnhelpful";function we(){g(class extends l{constructor(){super({id:"workbench.action.chat.markHelpful",title:u("interactive.helpful.label","Helpful"),f1:!1,category:f,icon:d.thumbsup,toggled:w.isEqualTo("up"),menu:[{id:m.ChatMessageTitle,group:"navigation",order:1,when:i.and(s,y,h.negate())},{id:I,group:"navigation",order:1,when:i.and(s,y,h.negate())}]})}run(o,...n){const e=n[0];if(!p(e))return;o.get(C).notifyUserAction({agentId:e.agent?.id,command:e.slashCommand?.name,sessionId:e.sessionId,requestId:e.requestId,result:e.result,action:{kind:"vote",direction:E.Up,reason:void 0}}),e.setVote(E.Up),e.setVoteDownReason(void 0)}}),g(class extends l{constructor(){super({id:Y,title:u("interactive.unhelpful.label","Unhelpful"),f1:!1,category:f,icon:d.thumbsdown,toggled:w.isEqualTo("down"),menu:[{id:m.ChatMessageTitle,group:"navigation",order:2,when:i.and(s,h.negate())},{id:I,group:"navigation",order:2,when:i.and(s,h.negate())}]})}run(o,...n){const e=n[0];if(!p(e))return;const t=n[1];if(typeof t!="string")return;e.setVote(E.Down),e.setVoteDownReason(t),o.get(C).notifyUserAction({agentId:e.agent?.id,command:e.slashCommand?.name,sessionId:e.sessionId,requestId:e.requestId,result:e.result,action:{kind:"vote",direction:E.Down,reason:e.voteDownReason}})}}),g(class extends l{constructor(){super({id:"workbench.action.chat.reportIssueForBug",title:u("interactive.reportIssueForBug.label","Report Issue"),f1:!1,category:f,icon:d.report,menu:[{id:m.ChatMessageTitle,group:"navigation",order:3,when:i.and(k,s)},{id:I,group:"navigation",order:3,when:i.and(k,s)}]})}run(o,...n){const e=n[0];if(!p(e))return;o.get(C).notifyUserAction({agentId:e.agent?.id,command:e.slashCommand?.name,sessionId:e.sessionId,requestId:e.requestId,result:e.result,action:{kind:"bug"}})}}),g(class extends l{constructor(){super({id:"workbench.action.chat.insertIntoNotebook",title:u("interactive.insertIntoNotebook.label","Insert into Notebook"),f1:!1,category:f,icon:d.insert,menu:{id:m.ChatMessageTitle,group:"navigation",isHiddenByDefault:!0,when:i.and(X,s,L.negate())}})}async run(o,...n){const e=n[0];if(!p(e))return;const t=o.get(P);if(t.activeEditorPane?.getId()===H){const r=t.activeEditorPane.getControl();if(!r.hasModel()||r.isReadOnly)return;const T=e.response.toString(),N=z(T),_=r.getFocus(),A=Math.max(_.end,0);await o.get(U).apply([new V(r.textModel.uri,{editType:B.Replace,index:A,count:0,cells:N.map(c=>{const O=c.type==="markdown"?S.Markup:S.Code,b=c.type==="markdown"?"markdown":c.language,x=c.type==="markdown"?"text/markdown":`text/x-${c.language}`;return{cellKind:O,language:b,mime:x,source:c.content,outputs:[],metadata:{}}})})],{quotableLabel:"Insert into Notebook"})}}}),g(class extends l{constructor(){super({id:"workbench.action.chat.remove",title:u("chat.remove.label","Remove Request and Response"),f1:!1,category:f,icon:d.x,keybinding:{primary:v.Delete,mac:{primary:M.CtrlCmd|v.Backspace},when:i.and(F,K.negate()),weight:q.WorkbenchContrib},menu:{id:m.ChatMessageTitle,group:"navigation",order:2,when:W}})}run(o,...n){let e=n[0];R(e)||(e=o.get(G).lastFocusedWidget?.getFocus());const t=R(e)?e.id:p(e)?e.requestId:void 0;t&&o.get(C).removeRequest(e.sessionId,t)}})}function z(a){const n=new D.Lexer().lex(a),e=[];let t="";return n.forEach(r=>{r.type==="code"?(t.trim()&&(e.push({type:"markdown",content:t}),t=""),e.push({type:"code",language:r.lang||"",content:r.text})):t+=r.raw}),t.trim()&&e.push({type:"markdown",content:t}),e}export{Y as MarkUnhelpfulActionId,we as registerChatTitleActions};
