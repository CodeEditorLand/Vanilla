import{Codicon as d}from"../../../../../base/common/codicons.js";import{KeyCode as T,KeyMod as x}from"../../../../../base/common/keyCodes.js";import{marked as M}from"../../../../../base/common/marked/marked.js";import"../../../../../editor/browser/editorExtensions.js";import{IBulkEditService as q}from"../../../../../editor/browser/services/bulkEditService.js";import{localize2 as u}from"../../../../../nls.js";import{Action2 as l,MenuId as m,registerAction2 as g}from"../../../../../platform/actions/common/actions.js";import{ContextKeyExpr as i}from"../../../../../platform/contextkey/common/contextkey.js";import{KeybindingWeight as D}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import{IEditorService as U}from"../../../../services/editor/common/editorService.js";import{ResourceNotebookCellEdit as F}from"../../../bulkEdit/browser/bulkCellEdits.js";import{MENU_INLINE_CHAT_WIDGET_SECONDARY as E}from"../../../inlineChat/common/inlineChat.js";import"../../../notebook/browser/notebookBrowser.js";import{CellEditType as P,CellKind as S,NOTEBOOK_EDITOR_ID as V}from"../../../notebook/common/notebookCommon.js";import{NOTEBOOK_IS_ACTIVE_EDITOR as X}from"../../../notebook/common/notebookContextKeys.js";import{CONTEXT_CHAT_RESPONSE_SUPPORT_ISSUE_REPORTING as k,CONTEXT_IN_CHAT_INPUT as B,CONTEXT_IN_CHAT_SESSION as H,CONTEXT_ITEM_ID as K,CONTEXT_LAST_ITEM_ID as W,CONTEXT_REQUEST as L,CONTEXT_RESPONSE as s,CONTEXT_RESPONSE_ERROR as v,CONTEXT_RESPONSE_FILTERED as G,CONTEXT_RESPONSE_VOTE as y}from"../../common/chatContextKeys.js";import{ChatAgentVoteDirection as I,IChatService as h}from"../../common/chatService.js";import{isRequestVM as w,isResponseVM as p}from"../../common/chatViewModel.js";import{IChatWidgetService as Y}from"../chat.js";import{CHAT_CATEGORY as f}from"./chatActions.js";const z="workbench.action.chat.markUnhelpful";function Re(){g(class extends l{constructor(){super({id:"workbench.action.chat.markHelpful",title:u("interactive.helpful.label","Helpful"),f1:!1,category:f,icon:d.thumbsup,toggled:y.isEqualTo("up"),menu:[{id:m.ChatMessageFooter,group:"navigation",order:1,when:i.and(s,v.negate())},{id:E,group:"navigation",order:1,when:i.and(s,v.negate())}]})}run(o,...n){const e=n[0];if(!p(e))return;o.get(h).notifyUserAction({agentId:e.agent?.id,command:e.slashCommand?.name,sessionId:e.sessionId,requestId:e.requestId,result:e.result,action:{kind:"vote",direction:I.Up,reason:void 0}}),e.setVote(I.Up),e.setVoteDownReason(void 0)}}),g(class extends l{constructor(){super({id:z,title:u("interactive.unhelpful.label","Unhelpful"),f1:!1,category:f,icon:d.thumbsdown,toggled:y.isEqualTo("down"),menu:[{id:m.ChatMessageFooter,group:"navigation",order:2,when:i.and(s)},{id:E,group:"navigation",order:2,when:i.and(s,v.negate())}]})}run(o,...n){const e=n[0];if(!p(e))return;const t=n[1];if(typeof t!="string")return;e.setVote(I.Down),e.setVoteDownReason(t),o.get(h).notifyUserAction({agentId:e.agent?.id,command:e.slashCommand?.name,sessionId:e.sessionId,requestId:e.requestId,result:e.result,action:{kind:"vote",direction:I.Down,reason:e.voteDownReason}})}}),g(class extends l{constructor(){super({id:"workbench.action.chat.reportIssueForBug",title:u("interactive.reportIssueForBug.label","Report Issue"),f1:!1,category:f,icon:d.report,menu:[{id:m.ChatMessageFooter,group:"navigation",order:3,when:i.and(k,s)},{id:E,group:"navigation",order:3,when:i.and(k,s)}]})}run(o,...n){const e=n[0];if(!p(e))return;o.get(h).notifyUserAction({agentId:e.agent?.id,command:e.slashCommand?.name,sessionId:e.sessionId,requestId:e.requestId,result:e.result,action:{kind:"bug"}})}}),g(class extends l{constructor(){super({id:"workbench.action.chat.retry",title:u("chat.retry.label","Retry"),f1:!1,category:f,icon:d.refresh,menu:[{id:m.ChatMessageFooter,group:"navigation",when:i.and(s,i.in(K.key,W.key))}]})}run(o,...n){const e=n[0];if(!p(e))return;const t=o.get(h),r=t.getSession(e.sessionId)?.getRequests().find(C=>C.id===e.requestId);t.resendRequest(r)}}),g(class extends l{constructor(){super({id:"workbench.action.chat.insertIntoNotebook",title:u("interactive.insertIntoNotebook.label","Insert into Notebook"),f1:!1,category:f,icon:d.insert,menu:{id:m.ChatMessageFooter,group:"navigation",isHiddenByDefault:!0,when:i.and(X,s,G.negate())}})}async run(o,...n){const e=n[0];if(!p(e))return;const t=o.get(U);if(t.activeEditorPane?.getId()===V){const r=t.activeEditorPane.getControl();if(!r.hasModel()||r.isReadOnly)return;const C=e.response.toString(),R=Q(C),N=r.getFocus(),_=Math.max(N.end,0);await o.get(q).apply([new F(r.textModel.uri,{editType:P.Replace,index:_,count:0,cells:R.map(c=>{const A=c.type==="markdown"?S.Markup:S.Code,b=c.type==="markdown"?"markdown":c.language,O=c.type==="markdown"?"text/markdown":`text/x-${c.language}`;return{cellKind:A,language:b,mime:O,source:c.content,outputs:[],metadata:{}}})})],{quotableLabel:"Insert into Notebook"})}}}),g(class extends l{constructor(){super({id:"workbench.action.chat.remove",title:u("chat.remove.label","Remove Request and Response"),f1:!1,category:f,icon:d.x,keybinding:{primary:T.Delete,mac:{primary:x.CtrlCmd|T.Backspace},when:i.and(H,B.negate()),weight:D.WorkbenchContrib},menu:{id:m.ChatMessageTitle,group:"navigation",order:2,when:L}})}run(o,...n){let e=n[0];w(e)||(e=o.get(Y).lastFocusedWidget?.getFocus());const t=w(e)?e.id:p(e)?e.requestId:void 0;t&&o.get(h).removeRequest(e.sessionId,t)}})}function Q(a){const n=new M.Lexer().lex(a),e=[];let t="";return n.forEach(r=>{r.type==="code"?(t.trim()&&(e.push({type:"markdown",content:t}),t=""),e.push({type:"code",language:r.lang||"",content:r.text})):t+=r.raw}),t.trim()&&e.push({type:"markdown",content:t}),e}export{z as MarkUnhelpfulActionId,Re as registerChatTitleActions};
