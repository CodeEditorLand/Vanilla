var m=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var l=(o,t,e,i)=>{for(var r=i>1?void 0:i?I(t,e):t,a=o.length-1,n;a>=0;a--)(n=o[a])&&(r=(i?n(t,e,r):n(r))||r);return i&&r&&m(t,e,r),r},p=(o,t)=>(e,i)=>t(e,i,o);import{CancellationToken as f}from"../../../../../vs/base/common/cancellation.js";import{Codicon as g}from"../../../../../vs/base/common/codicons.js";import{Emitter as v}from"../../../../../vs/base/common/event.js";import{Disposable as S,toDisposable as b}from"../../../../../vs/base/common/lifecycle.js";import{Schemas as y}from"../../../../../vs/base/common/network.js";import"../../../../../vs/base/common/themables.js";import{URI as h}from"../../../../../vs/base/common/uri.js";import*as u from"../../../../../vs/nls.js";import"../../../../../vs/platform/instantiation/common/instantiation.js";import{registerIcon as C}from"../../../../../vs/platform/theme/common/iconRegistry.js";import{EditorInputCapabilities as E}from"../../../../../vs/workbench/common/editor.js";import{EditorInput as D}from"../../../../../vs/workbench/common/editor/editorInput.js";import{ChatAgentLocation as z}from"../../../../../vs/workbench/contrib/chat/common/chatAgents.js";import"../../../../../vs/workbench/contrib/chat/common/chatModel.js";import{IChatService as R}from"../../../../../vs/workbench/contrib/chat/common/chatService.js";const w=C("chat-editor-label-icon",g.commentDiscussion,u.localize("chatEditorLabelIcon","Icon of the chat editor label."));let s=class extends D{constructor(e,i,r){super();this.resource=e;this.options=i;this.chatService=r;if(typeof d.parse(e)?.handle!="number")throw new Error("Invalid chat URI");this.sessionId=i.target&&"sessionId"in i.target?i.target.sessionId:void 0,this.inputCount=s.getNextCount(),s.countsInUse.add(this.inputCount),this._register(b(()=>s.countsInUse.delete(this.inputCount)))}static countsInUse=new Set;static TypeID="workbench.input.chatSession";static EditorID="workbench.editor.chatSession";inputCount;sessionId;model;static getNewEditorUri(){const e=Math.floor(Math.random()*1e9);return d.generate(e)}static getNextCount(){let e=0;for(;s.countsInUse.has(e);)e++;return e}get editorId(){return s.EditorID}get capabilities(){return super.capabilities|E.Singleton}matches(e){return e instanceof s&&e.resource.toString()===this.resource.toString()}get typeId(){return s.TypeID}getName(){return this.model?.title||u.localize("chatEditorName","Chat")+(this.inputCount>0?` ${this.inputCount+1}`:"")}getIcon(){return w}async resolve(){return typeof this.sessionId=="string"?this.model=this.chatService.getOrRestoreSession(this.sessionId):this.options.target?"data"in this.options.target&&(this.model=this.chatService.loadSessionFromContent(this.options.target.data)):this.model=this.chatService.startSession(z.Panel,f.None),this.model?(this.sessionId=this.model.sessionId,this._register(this.model.onDidChange(()=>this._onDidChangeLabel.fire())),this._register(new x(this.model))):null}dispose(){super.dispose(),this.sessionId&&this.chatService.clearSession(this.sessionId)}};s=l([p(2,R)],s);class x extends S{constructor(e){super();this.model=e}_onWillDispose=this._register(new v);onWillDispose=this._onWillDispose.event;_isDisposed=!1;_isResolved=!1;async resolve(){this._isResolved=!0}isResolved(){return this._isResolved}isDisposed(){return this._isDisposed}dispose(){super.dispose(),this._isDisposed=!0}}var d;(i=>{i.scheme=y.vscodeChatSesssion;function t(r){return h.from({scheme:i.scheme,path:`chat-${r}`})}i.generate=t;function e(r){if(r.scheme!==i.scheme)return;const n=r.path.match(/chat-(\d+)/)?.[1];if(typeof n!="string")return;const c=parseInt(n);if(!isNaN(c))return{handle:c}}i.parse=e})(d||={});class Q{canSerialize(t){return t instanceof s&&typeof t.sessionId=="string"}serialize(t){if(!this.canSerialize(t))return;const e={options:t.options,sessionId:t.sessionId,resource:t.resource};return JSON.stringify(e)}deserialize(t,e){try{const i=JSON.parse(e),r=h.revive(i.resource);return t.createInstance(s,r,{...i.options,target:{sessionId:i.sessionId}})}catch{return}}}export{s as ChatEditorInput,Q as ChatEditorInputSerializer,x as ChatEditorModel,d as ChatUri};
