var O=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var k=(l,t,e,o)=>{for(var r=o>1?void 0:o?V(t,e):t,s=l.length-1,i;s>=0;s--)(i=l[s])&&(r=(o?i(t,e,r):i(r))||r);return o&&r&&O(t,e,r),r},c=(l,t)=>(e,o)=>t(e,o,l);import*as F from"../../../../../base/browser/dom.js";import{Emitter as K}from"../../../../../base/common/event.js";import{Disposable as D}from"../../../../../base/common/lifecycle.js";import{equalsIgnoreCase as q}from"../../../../../base/common/strings.js";import{Range as A}from"../../../../../editor/common/core/range.js";import{ITextModelService as N}from"../../../../../editor/common/services/resolverService.js";import{MenuId as U}from"../../../../../platform/actions/common/actions.js";import{IContextKeyService as $}from"../../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as M}from"../../../../../platform/instantiation/common/instantiation.js";import{ResourcePool as z}from"./chatCollections.js";import{ChatMarkdownDecorationsRenderer as G}from"../chatMarkdownDecorationsRenderer.js";import{CodeBlockPart as J,localFileLanguageId as Q,parseLocalFileData as W}from"../codeBlockPart.js";import{isRequestVM as x,isResponseVM as h}from"../../common/chatViewModel.js";const _=F.$;let C=class extends D{constructor(e,o,r,s=!1,i=0,u,S,X,P,w,Y,T){super();this.markdown=e;this.editorPool=r;this.codeBlockModelCollection=X;this.textModelService=Y;const n=o.element,j=T.createInstance(G),b=[];let E=i;const R=this._register(u.render(e,{fillInIncompleteTokens:s,codeBlockRendererSync:(m,v)=>{const p=E++;let g,B,y;if(q(m,Q))try{const a=W(v);B=a.range&&A.lift(a.range),g=this.textModelService.createModelReference(a.uri).then(I=>I.object)}catch{return _("div")}else{if(!x(n)&&!h(n))return console.error("Trying to render code block in welcome",n.id,p),_("div");const a=h(n)||x(n)?n.sessionId:"",I=this.codeBlockModelCollection.getOrCreate(a,n,p);y=I.vulns,g=I.model}const H=h(n)&&n.errorDetails?.responseIsFiltered,d=this.renderCodeBlock({languageId:m,textModel:g,codeBlockIndex:p,element:n,range:B,hideToolbar:H,parentContextKeyService:w,vulns:y},v,S,P.editableCodeBlock);this.allRefs.push(d),this._register(d.object.onDidChangeContentHeight(()=>this._onDidChangeHeight.fire()));const L={codeBlockIndex:p,element:n,focus(){d.object.focus()},uri:d.object.uri};return this.codeblocks.push(L),b.push(d),d.object.element},asyncRenderCallback:()=>this._onDidChangeHeight.fire()}));this._register(j.walkTreeAndAnnotateReferenceLinks(R.element)),b.reverse().forEach(m=>this._register(m)),this.domNode=R.element}domNode;allRefs=[];_onDidChangeHeight=this._register(new K);onDidChangeHeight=this._onDidChangeHeight.event;codeblocks=[];renderCodeBlock(e,o,r,s){const i=this.editorPool.get(),u=i.object;return h(e.element)&&this.codeBlockModelCollection.update(e.element.sessionId,e.element,e.codeBlockIndex,{text:o,languageId:e.languageId}),u.render(e,r,s),i}hasSameContent(e){return e.kind==="markdownContent"&&e.content.value===this.markdown.value}layout(e){this.allRefs.forEach(o=>o.object.layout(e))}addDisposable(e){this._register(e)}};C=k([c(9,$),c(10,N),c(11,M)],C);let f=class extends D{_pool;inUse(){return this._pool.inUse}constructor(t,e,o,r){super(),this._pool=this._register(new z(()=>r.createInstance(J,t,U.ChatCodeBlock,e,o)))}get(){const t=this._pool.get();let e=!1;return{object:t,isStale:()=>e,dispose:()=>{t.reset(),e=!0,this._pool.release(t)}}}};f=k([c(3,M)],f);export{C as ChatMarkdownContentPart,f as EditorPool};
