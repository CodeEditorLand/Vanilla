var N=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var L=(u,a,e,i)=>{for(var t=i>1?void 0:i?q(a,e):a,n=u.length-1,s;n>=0;n--)(s=u[n])&&(t=(i?s(a,e,t):s(t))||t);return i&&t&&N(a,e,t),t},c=(u,a)=>(e,i)=>a(e,i,u);import*as d from"../../../../base/browser/dom.js";import{renderIcon as $}from"../../../../base/browser/ui/iconLabel/iconLabels.js";import"../../../../base/browser/ui/tree/tree.js";import{disposableTimeout as U,timeout as K}from"../../../../base/common/async.js";import{toErrorMessage as Q}from"../../../../base/common/errorMessage.js";import{Emitter as p,Event as X}from"../../../../base/common/event.js";import{MarkdownString as j}from"../../../../base/common/htmlContent.js";import{Disposable as z,DisposableStore as G,MutableDisposable as J,combinedDisposable as Y,toDisposable as Z}from"../../../../base/common/lifecycle.js";import{Schemas as ee}from"../../../../base/common/network.js";import{extUri as te,isEqual as ie}from"../../../../base/common/resources.js";import{isDefined as ne}from"../../../../base/common/types.js";import"../../../../base/common/uri.js";import"../../../../editor/browser/editorBrowser.js";import{ICodeEditorService as se}from"../../../../editor/browser/services/codeEditorService.js";import{MarkdownRenderer as oe}from"../../../../editor/browser/widget/markdownRenderer/browser/markdownRenderer.js";import{localize as re}from"../../../../nls.js";import{MenuId as R}from"../../../../platform/actions/common/actions.js";import{IContextKeyService as O}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as ae}from"../../../../platform/contextview/browser/contextView.js";import"../../../../platform/editor/common/editor.js";import{IInstantiationService as de}from"../../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as he}from"../../../../platform/instantiation/common/serviceCollection.js";import{WorkbenchObjectTree as le}from"../../../../platform/list/browser/listService.js";import{ILogService as ce}from"../../../../platform/log/common/log.js";import{IStorageService as ue,StorageScope as W,StorageTarget as ge}from"../../../../platform/storage/common/storage.js";import{IThemeService as pe}from"../../../../platform/theme/common/themeService.js";import{TerminalChatController as Ce}from"../../terminal/terminalContribExports.js";import{IChatAgentService as me,isChatWelcomeMessageContent as Ie}from"../common/chatAgents.js";import{CONTEXT_CHAT_INPUT_HAS_AGENT as ve,CONTEXT_CHAT_LOCATION as fe,CONTEXT_CHAT_REQUEST_IN_PROGRESS as ye,CONTEXT_IN_CHAT_SESSION as Se,CONTEXT_IN_QUICK_CHAT as we,CONTEXT_LAST_ITEM_ID as De,CONTEXT_PARTICIPANT_SUPPORTS_MODEL_PICKER as _e,CONTEXT_RESPONSE_FILTERED as be}from"../common/chatContextKeys.js";import{IChatEditingService as Me}from"../common/chatEditingService.js";import"../common/chatModel.js";import{ChatRequestAgentPart as Te,chatAgentLeader as Ee,chatSubcommandLeader as k,formatChatQuestion as Pe}from"../common/chatParserTypes.js";import{ChatRequestParser as Ae}from"../common/chatRequestParser.js";import{IChatService as Fe}from"../common/chatService.js";import{IChatSlashCommandService as xe}from"../common/chatSlashCommands.js";import{ChatViewModel as He,isRequestVM as E,isResponseVM as C}from"../common/chatViewModel.js";import{CodeBlockModelCollection as Le}from"../common/codeBlockModelCollection.js";import{IChatAccessibilityService as Re,IChatWidgetService as Oe}from"./chat.js";import{ChatAccessibilityProvider as We}from"./chatAccessibilityProvider.js";import{ChatDragAndDrop as ke}from"./chatDragAndDrop.js";import{ChatImageDropAndPaste as Be}from"./chatImagePaste.js";import{ChatInputPart as Ve}from"./chatInputPart.js";import{ChatListDelegate as Ne,ChatListItemRenderer as qe}from"./chatListRenderer.js";import{ChatEditorOptions as $e}from"./chatOptions.js";import"./media/chat.css";import"./media/chatAgentHover.css";const m=d.$;function I(u){u.scrollTop=u.scrollHeight-u.renderHeight}function Ue(u){return"viewContext"in u&&"isQuickChat"in u.viewContext&&!!u.viewContext.isQuickChat}const B="chat.welcomeMessageContent";let v=class extends z{constructor(e,i,t,n,s,r,o,l,g,f,P,A,D,Ke,Qe,Xe,V){super();this.viewOptions=t;this.styles=n;this.contextKeyService=r;this.instantiationService=o;this.chatService=l;this.chatAgentService=g;this.contextMenuService=P;this.chatAccessibilityService=A;this.logService=D;this.themeService=Ke;this.chatSlashCommandService=Qe;this.chatEditingService=Xe;this.storageService=V;this.viewContext=i??{},typeof e=="object"?this._location=e:this._location={location:e},Se.bindTo(r).set(!0),fe.bindTo(r).set(this._location.location),we.bindTo(r).set(Ue(this)),this.agentInInput=ve.bindTo(r),this.agentSupportsModelPicker=_e.bindTo(r),this.requestInProgress=ye.bindTo(r),this._register(f.register(this)),this._codeBlockModelCollection=this._register(o.createInstance(Le));let F=null;this._register(this.chatEditingService.onDidCreateEditingSession(h=>{h.chatSessionId===this.viewModel?.sessionId&&(F=this._register(h.onDidChange(()=>{this.renderChatEditingSessionState(h)})),this.renderChatEditingSessionState(h))})),this._register(this.chatEditingService.onDidDisposeEditingSession(h=>{(h.chatSessionId===this.viewModel?.sessionId||!this.viewModel)&&(F?.dispose(),this.renderChatEditingSessionState(null))})),this._register(s.registerCodeEditorOpenHandler(async(h,je,ze)=>{const _=h.resource;if(_.scheme!==ee.vscodeChatCodeBlock)return null;const H=_.path.split("/").at(1);if(!H)return null;const b=this.viewModel?.getItems().find(S=>S.id===H);if(!b)return null;this.reveal(b),await K(0);for(const S of this.renderer.editorsInUse())if(te.isEqual(S.uri,_,!0)){const y=S.editor;let M=0;const T=y.getDomNode();if(T){const w=d.findParentWithClass(T,"monaco-list-row");w&&(M=d.getTopLeftOffset(T).top-d.getTopLeftOffset(w).top)}if(h.options?.selection){const w=y.getTopForPosition(h.options.selection.startLineNumber,h.options.selection.startColumn);M+=w,y.focus(),y.setSelection({startLineNumber:h.options.selection.startLineNumber,startColumn:h.options.selection.startColumn,endLineNumber:h.options.selection.endLineNumber??h.options.selection.startLineNumber,endColumn:h.options.selection.endColumn??h.options.selection.startColumn})}return this.reveal(b,M),y}return null}));const x=V.getObject(B,W.APPLICATION);Ie(x)&&(this.persistedWelcomeMessage=x),this._register(this.onDidChangeParsedInput(()=>this.updateChatInputContext()))}static CONTRIBS=[];_onDidSubmitAgent=this._register(new p);onDidSubmitAgent=this._onDidSubmitAgent.event;_onDidChangeAgent=this._register(new p);onDidChangeAgent=this._onDidChangeAgent.event;_onDidFocus=this._register(new p);onDidFocus=this._onDidFocus.event;_onDidChangeViewModel=this._register(new p);onDidChangeViewModel=this._onDidChangeViewModel.event;_onDidScroll=this._register(new p);onDidScroll=this._onDidScroll.event;_onDidClear=this._register(new p);onDidClear=this._onDidClear.event;_onDidAcceptInput=this._register(new p);onDidAcceptInput=this._onDidAcceptInput.event;_onDidChangeContext=this._register(new p);onDidChangeContext=this._onDidChangeContext.event;_onDidHide=this._register(new p);onDidHide=this._onDidHide.event;_onDidChangeParsedInput=this._register(new p);onDidChangeParsedInput=this._onDidChangeParsedInput.event;_onWillMaybeChangeHeight=new p;onWillMaybeChangeHeight=this._onWillMaybeChangeHeight.event;_onDidChangeHeight=this._register(new p);onDidChangeHeight=this._onDidChangeHeight.event;_onDidChangeContentHeight=new p;onDidChangeContentHeight=this._onDidChangeContentHeight.event;contribs=[];tree;renderer;_codeBlockModelCollection;inputPart;editorOptions;listContainer;container;welcomeMessageContainer;persistedWelcomeMessage;bodyDimension;visibleChangeCount=0;requestInProgress;agentInInput;agentSupportsModelPicker;_visible=!1;get visible(){return this._visible}previousTreeScrollHeight=0;viewModelDisposables=this._register(new G);_viewModel;set viewModel(e){this._viewModel!==e&&(this.viewModelDisposables.clear(),this._viewModel=e,e&&this.viewModelDisposables.add(e),this._onDidChangeViewModel.fire())}get viewModel(){return this._viewModel}parsedChatRequest;get parsedInput(){if(this.parsedChatRequest===void 0){if(!this.viewModel)return{text:"",parts:[]};this.parsedChatRequest=this.instantiationService.createInstance(Ae).parseChatRequest(this.viewModel.sessionId,this.getInput(),this.location,{selectedAgent:this._lastSelectedAgent})}return this.parsedChatRequest}get scopedContextKeyService(){return this.contextKeyService}_location;get location(){return this._location.location}viewContext;_lastSelectedAgent;set lastSelectedAgent(e){this.parsedChatRequest=void 0,this._lastSelectedAgent=e,this._onDidChangeParsedInput.fire()}get lastSelectedAgent(){return this._lastSelectedAgent}get supportsFileReferences(){return!!this.viewOptions.supportsFileReferences}get input(){return this.inputPart}get inputEditor(){return this.inputPart.inputEditor}get inputUri(){return this.inputPart.inputUri}get contentHeight(){return this.inputPart.contentHeight+this.tree.contentHeight}render(e){const i="viewId"in this.viewContext?this.viewContext.viewId:void 0;this.editorOptions=this._register(this.instantiationService.createInstance($e,i,this.styles.listForeground,this.styles.inputEditorBackground,this.styles.resultEditorBackground));const t=this.viewOptions.renderInputOnTop??!1,n=this.viewOptions.renderFollowups??!t,s=this.viewOptions.renderStyle;this.container=d.append(e,m(".interactive-session")),this.welcomeMessageContainer=d.append(this.container,m(".chat-welcome-view",{style:"display: none"})),this.renderWelcomeViewContentIfNeeded(),t?(this.createInput(this.container,{renderFollowups:n,renderStyle:s}),this.listContainer=d.append(this.container,m(".interactive-list"))):(this.listContainer=d.append(this.container,m(".interactive-list")),this.createInput(this.container,{renderFollowups:n,renderStyle:s})),this.createList(this.listContainer,{...this.viewOptions.rendererOptions,renderStyle:s}),this._register(this.editorOptions.onDidChange(()=>this.onDidStyleChange())),this.onDidStyleChange(),this.viewModel&&(this.onDidChangeItems(),I(this.tree)),this.contribs=v.CONTRIBS.map(r=>{try{return this._register(this.instantiationService.createInstance(r,this))}catch(o){this.logService.error("Failed to instantiate chat widget contrib",Q(o));return}}).filter(ne),this._register(this.instantiationService.createInstance(ke,this.container,this.inputPart,this.styles)),this._register(this.instantiationService.createInstance(Be,this.inputPart))}getContrib(e){return this.contribs.find(i=>i.id===e)}focusInput(){this.inputPart.focus()}hasInputFocus(){return this.inputPart.hasFocus()}getSibling(e,i){if(!C(e))return;const t=this.viewModel?.getItems();if(!t)return;const n=t.filter(o=>C(o)),s=n.indexOf(e);if(s===void 0)return;const r=i==="next"?s+1:s-1;if(!(r<0||r>n.length-1))return n[r]}clear(){this._dynamicMessageLayoutData&&(this._dynamicMessageLayoutData.enabled=!0),this._onDidClear.fire()}onDidChangeItems(e){if(this.tree&&this._visible){const i=(this.viewModel?.getItems()??[]).map(n=>({element:n,collapsed:!1,collapsible:!1}));this.renderWelcomeViewContentIfNeeded(),this._onWillMaybeChangeHeight.fire(),this.tree.setChildren(null,i,{diffIdentityProvider:{getId:n=>n.dataId+`${E(n)}${C(n)&&n.renderData?`_${this.visibleChangeCount}`:""}`+(C(n)?`_${n.contentReferences.length}`:"")+(E(n)&&n.contentReferences?`_${n.contentReferences?.length}`:"")}}),!e&&this._dynamicMessageLayoutData&&this.layoutDynamicChatTreeItemMode();const t=i[i.length-1]?.element;t&&De.bindTo(this.contextKeyService).set([t.id]),t&&C(t)&&t.isComplete?this.renderFollowups(t.replyFollowups,t):!i.length&&this.viewModel?this.renderFollowups(this.viewModel.model.sampleQuestions):this.renderFollowups(void 0)}}renderWelcomeViewContentIfNeeded(){const e=this.viewModel?.model.welcomeMessage??this.persistedWelcomeMessage;if(e&&this.welcomeMessageContainer.children.length===0&&!this.viewOptions.renderStyle){const i=d.append(this.welcomeMessageContainer,m(".chat-welcome-view-icon")),t=d.append(this.welcomeMessageContainer,m(".chat-welcome-view-title")),n=d.append(this.welcomeMessageContainer,m(".chat-welcome-view-message")),s=d.append(this.welcomeMessageContainer,m(".chat-welcome-view-tips"));i.appendChild($(e.icon)),t.textContent=e.title;const r=this.instantiationService.createInstance(oe,{}),o=this._register(r.render(e.message));d.append(n,o.element);const l=new j(re("chatWidget.tips",`{0} to attach context

{1} to chat with extensions`,"$(attach)","$(mention)"),{supportThemeIcons:!0}),g=this._register(r.render(l));s.appendChild(g.element)}if(!this.viewOptions.renderStyle&&this.viewModel){const i=this.viewModel.getItems();d.setVisibility(i.length===0,this.welcomeMessageContainer),d.setVisibility(i.length!==0,this.listContainer)}}async renderChatEditingSessionState(e){this.inputPart.renderChatEditingSessionState(e),this.bodyDimension&&this.layout(this.bodyDimension.height,this.bodyDimension.width)}async renderFollowups(e,i){this.inputPart.renderFollowups(e,i),this.bodyDimension&&this.layout(this.bodyDimension.height,this.bodyDimension.width)}setVisible(e){const i=this._visible;this._visible=e,this.visibleChangeCount++,this.renderer.setVisible(e),this.input.setVisible(e),e?this._register(U(()=>{this._visible&&this.onDidChangeItems(!0)},0)):i&&this._onDidHide.fire()}createList(e,i){const t=this._register(this._register(this.instantiationService.createChild(new he([O,this.contextKeyService])))),n=t.createInstance(Ne,this.viewOptions.defaultElementHeight??200),s={getListLength:()=>this.tree.getNode(null).visibleChildrenCount,onDidScroll:this.onDidScroll},r=document.createElement("div");r.classList.add("chat-overflow-widget-container","monaco-editor"),e.append(r),this.renderer=this._register(t.createInstance(qe,this.editorOptions,i,s,this._codeBlockModelCollection,r)),this._register(this.renderer.onDidClickFollowup(o=>{this.acceptInput(o.message)})),this._register(this.renderer.onDidClickRerunWithAgentOrCommandDetection(o=>{const l=this.chatService.getSession(o.sessionId)?.getRequests().find(g=>g.id===o.requestId);l&&this.chatService.resendRequest(l,{noCommandDetection:!0,attempt:l.attempt+1,location:this.location}).catch(g=>this.logService.error("FAILED to rerun request",g))})),this.tree=this._register(t.createInstance(le,"Chat",e,n,[this.renderer],{identityProvider:{getId:o=>o.id},horizontalScrolling:!1,alwaysConsumeMouseWheel:!1,supportDynamicHeights:!0,hideTwistiesOfChildlessElements:!0,accessibilityProvider:this.instantiationService.createInstance(We),keyboardNavigationLabelProvider:{getKeyboardNavigationLabel:o=>E(o)?o.message:C(o)?o.response.value:""},setRowLineHeight:!1,filter:this.viewOptions.filter?{filter:this.viewOptions.filter.bind(this.viewOptions)}:void 0,overrideStyles:{listFocusBackground:this.styles.listBackground,listInactiveFocusBackground:this.styles.listBackground,listActiveSelectionBackground:this.styles.listBackground,listFocusAndSelectionBackground:this.styles.listBackground,listInactiveSelectionBackground:this.styles.listBackground,listHoverBackground:this.styles.listBackground,listBackground:this.styles.listBackground,listFocusForeground:this.styles.listForeground,listHoverForeground:this.styles.listForeground,listInactiveFocusForeground:this.styles.listForeground,listInactiveSelectionForeground:this.styles.listForeground,listActiveSelectionForeground:this.styles.listForeground,listFocusAndSelectionForeground:this.styles.listForeground,listActiveSelectionIconForeground:void 0,listInactiveSelectionIconForeground:void 0}})),this._register(this.tree.onContextMenu(o=>this.onContextMenu(o))),this._register(this.tree.onDidChangeContentHeight(()=>{this.onDidChangeTreeContentHeight()})),this._register(this.renderer.onDidChangeItemHeight(o=>{this.tree.updateElementHeight(o.element,o.height)})),this._register(this.tree.onDidFocus(()=>{this._onDidFocus.fire()})),this._register(this.tree.onDidScroll(()=>{this._onDidScroll.fire()}))}onContextMenu(e){e.browserEvent.preventDefault(),e.browserEvent.stopPropagation();const i=e.element,t=this.contextKeyService.createOverlay([[be.key,C(i)&&!!i.errorDetails?.responseIsFiltered]]);this.contextMenuService.showContextMenu({menuId:R.ChatContext,menuActionOptions:{shouldForwardArgs:!0},contextKeyService:t,getAnchor:()=>e.anchor,getActionsContext:()=>i})}onDidChangeTreeContentHeight(){this.tree.scrollHeight!==this.previousTreeScrollHeight&&this.tree.scrollTop+this.tree.renderHeight>=this.previousTreeScrollHeight-2&&d.scheduleAtNextAnimationFrame(d.getWindow(this.listContainer),()=>{I(this.tree)},0),this.previousTreeScrollHeight=this.tree.scrollHeight,this._onDidChangeContentHeight.fire()}createInput(e,i){this.inputPart=this._register(this.instantiationService.createInstance(Ve,this.location,{renderFollowups:i?.renderFollowups??!0,renderStyle:i?.renderStyle==="minimal"?"compact":i?.renderStyle,menus:{executeToolbar:R.ChatExecute,...this.viewOptions.menus},editorOverflowWidgetsDomNode:this.viewOptions.editorOverflowWidgetsDomNode},()=>this.collectInputState())),this.inputPart.render(e,"",this),this._register(this.inputPart.onDidLoadInputState(t=>{this.contribs.forEach(n=>{if(n.setInputState){const s=(typeof t=="object"&&t?.[n.id])??{};n.setInputState(s)}})})),this._register(this.inputPart.onDidFocus(()=>this._onDidFocus.fire())),this._register(this.inputPart.onDidChangeContext(t=>this._onDidChangeContext.fire(t))),this._register(this.inputPart.onDidAcceptFollowup(t=>{if(!this.viewModel)return;let n="";if(t.followup.agentId&&t.followup.agentId!==this.chatAgentService.getDefaultAgent(this.location)?.id){const s=this.chatAgentService.getAgent(t.followup.agentId);if(!s)return;this.lastSelectedAgent=s,n=`${Ee}${s.name} `,t.followup.subCommand&&(n+=`${k}${t.followup.subCommand} `)}else!t.followup.agentId&&t.followup.subCommand&&this.chatSlashCommandService.hasCommand(t.followup.subCommand)&&(n=`${k}${t.followup.subCommand} `);n+=t.followup.message,this.acceptInput(n),t.response&&this.chatService.notifyUserAction({sessionId:this.viewModel.sessionId,requestId:t.response.requestId,agentId:t.response.agent?.id,command:t.response.slashCommand?.name,result:t.response.result,action:{kind:"followUp",followup:t.followup}})})),this._register(this.inputPart.onDidChangeHeight(()=>{this.bodyDimension&&this.layout(this.bodyDimension.height,this.bodyDimension.width),this._onDidChangeContentHeight.fire()})),this._register(this.inputEditor.onDidChangeModelContent(()=>{this.parsedChatRequest=void 0,this.updateChatInputContext()})),this._register(this.chatAgentService.onDidChangeAgents(()=>this.parsedChatRequest=void 0))}onDidStyleChange(){this.container.style.setProperty("--vscode-interactive-result-editor-background-color",this.editorOptions.configuration.resultEditor.backgroundColor?.toString()??""),this.container.style.setProperty("--vscode-interactive-session-foreground",this.editorOptions.configuration.foreground?.toString()??""),this.container.style.setProperty("--vscode-chat-list-background",this.themeService.getColorTheme().getColor(this.styles.listBackground)?.toString()??"")}setModel(e,i){if(!this.container)throw new Error("Call render() before setModel()");e.sessionId!==this.viewModel?.sessionId&&(this._codeBlockModelCollection.clear(),this.container.setAttribute("data-session-id",e.sessionId),this.viewModel=this.instantiationService.createInstance(He,e,this._codeBlockModelCollection),this.viewModelDisposables.add(X.accumulate(this.viewModel.onDidChange,0)(t=>{this.viewModel&&(this.requestInProgress.set(this.viewModel.requestInProgress),this.onDidChangeItems(),t.some(n=>n?.kind==="addRequest")&&this.visible&&(I(this.tree),this.focusInput()))})),this.viewModelDisposables.add(this.viewModel.onDidDisposeModel(()=>{this.inputPart.saveState(),this.viewModel=void 0,this.onDidChangeItems()})),this.inputPart.initForNewChatModel(i),this.contribs.forEach(t=>{t.setInputState&&i.inputState?.[t.id]&&t.setInputState(i.inputState?.[t.id])}),this.viewModelDisposables.add(e.onDidChange(t=>{t.kind==="setAgent"&&this._onDidChangeAgent.fire({agent:t.agent,slashCommand:t.command})})),this.tree&&(this.onDidChangeItems(),I(this.tree)),this.updateChatInputContext())}getFocus(){return this.tree.getFocus()[0]??void 0}reveal(e,i){this.tree.reveal(e,i)}focus(e){const t=this.tree.getNode(null).children.find(n=>n.element?.id===e.id);t&&(this.tree.setFocus([t.element]),this.tree.domFocus())}refilter(){this.tree.refilter()}setInputPlaceholder(e){this.viewModel?.setInputPlaceholder(e)}resetInputPlaceholder(){this.viewModel?.resetInputPlaceholder()}setInput(e=""){this.inputPart.setValue(e,!1)}getInput(){return this.inputPart.inputEditor.getValue()}logInputHistory(){this.inputPart.logInputHistory()}async acceptInput(e,i){return this._acceptInput(e?{query:e}:void 0,i)}async acceptInputWithPrefix(e){this._acceptInput({prefix:e})}collectInputState(){const e={};return this.contribs.forEach(i=>{i.getInputState&&(e[i.id]=i.getInputState())}),e}async _acceptInput(e,i){if(this.viewModel){this._onDidAcceptInput.fire();const t=this.getInput(),n=this.chatAccessibilityService.acceptRequest(),s=e?"query"in e?e.query:`${e.prefix} ${t}`:t,r=!e||"prefix"in e,o=await this.chatService.sendRequest(this.viewModel.sessionId,s,{userSelectedModelId:this.inputPart.currentLanguageModel,location:this.location,locationData:this._location.resolveData?.(),parserContext:{selectedAgent:this._lastSelectedAgent},attachedContext:[...this.inputPart.attachedContext.values()]});if(o)return this.inputPart.acceptInput(r),this._onDidSubmitAgent.fire({agent:o.agent,slashCommand:o.slashCommand}),o.responseCompletePromise.then(()=>{const l=this.viewModel?.getItems().filter(C),g=l?.[l.length-1];if(this.chatAccessibilityService.acceptResponse(g,n,i),g?.result?.nextQuestion){const{prompt:f,participant:P,command:A}=g.result.nextQuestion,D=Pe(this.chatAgentService,this.location,f,P,A);D&&this.input.setValue(D,!1)}}),o.responseCreatedPromise}}setContext(e,...i){this.inputPart.attachContext(e,...i)}getCodeBlockInfosForResponse(e){return this.renderer.getCodeBlockInfosForResponse(e)}getCodeBlockInfoForEditor(e){return this.renderer.getCodeBlockInfoForEditor(e)}getFileTreeInfosForResponse(e){return this.renderer.getFileTreeInfosForResponse(e)}getLastFocusedFileTreeForResponse(e){return this.renderer.getLastFocusedFileTreeForResponse(e)}focusLastMessage(){if(!this.viewModel)return;const e=this.tree.getNode(null).children,i=e[e.length-1];i&&(this.tree.setFocus([i.element]),this.tree.domFocus())}layout(e,i){i=Math.min(i,850),this.bodyDimension=new d.Dimension(i,e),this.inputPart.layout(e,i);const t=this.inputPart.inputPartHeight,n=this.tree.scrollTop+this.tree.renderHeight>=this.tree.scrollHeight,s=e-t;this.tree.layout(s,i),this.tree.getHTMLElement().style.height=`${s}px`;const r=100-this.inputPart.followupsHeight;this.welcomeMessageContainer.style.height=`${s-r}px`,this.welcomeMessageContainer.style.paddingBottom=`${r}px`,this.renderer.layout(i),n&&I(this.tree),this.listContainer.style.height=`${e-t}px`,this._onDidChangeHeight.fire(e)}_dynamicMessageLayoutData;setDynamicChatTreeItemLayout(e,i){this._dynamicMessageLayoutData={numOfMessages:e,maxHeight:i,enabled:!0},this._register(this.renderer.onDidChangeItemHeight(()=>this.layoutDynamicChatTreeItemMode()));const t=this._register(new J);this._register(this.tree.onDidScroll(n=>{this._dynamicMessageLayoutData?.enabled&&(t.value=d.scheduleAtNextAnimationFrame(d.getWindow(this.listContainer),()=>{if(!n.scrollTopChanged||n.heightChanged||n.scrollHeightChanged)return;const s=n.height,r=n.scrollHeight-s-n.scrollTop;if(r===0)return;const o=this._dynamicMessageLayoutData?.maxHeight??i,l=this.bodyDimension?.width??this.container.offsetWidth;this.inputPart.layout(o,l);const g=this.inputPart.inputPartHeight,f=Math.min(s+r,o-g);this.layout(f+g,l)}))}))}updateDynamicChatTreeItemLayout(e,i){this._dynamicMessageLayoutData={numOfMessages:e,maxHeight:i,enabled:!0};let t=!1,n=this.bodyDimension.height,s=this.bodyDimension.width;i<this.bodyDimension.height&&(n=i,t=!0);const r=this.container.offsetWidth;this.bodyDimension?.width!==r&&(s=r,t=!0),t&&this.layout(n,s)}get isDynamicChatTreeItemLayoutEnabled(){return this._dynamicMessageLayoutData?.enabled??!1}set isDynamicChatTreeItemLayoutEnabled(e){this._dynamicMessageLayoutData&&(this._dynamicMessageLayoutData.enabled=e)}layoutDynamicChatTreeItemMode(){if(!this.viewModel||!this._dynamicMessageLayoutData?.enabled)return;const e=this.bodyDimension?.width??this.container.offsetWidth;this.inputPart.layout(this._dynamicMessageLayoutData.maxHeight,e);const i=this.inputPart.inputPartHeight,t=this.viewModel.getItems(),n=t.slice(-this._dynamicMessageLayoutData.numOfMessages),s=n.some(o=>o.currentRenderedHeight===void 0),r=s?this._dynamicMessageLayoutData.maxHeight:n.reduce((o,l)=>o+l.currentRenderedHeight,0);this.layout(Math.min(i+r+(t.length>2?18:0),this._dynamicMessageLayoutData.maxHeight),e),(s||!r)&&I(this.tree)}saveState(){this.inputPart.saveState(),this.viewModel?.model.welcomeMessage&&this.storageService.store(B,this.viewModel?.model.welcomeMessage,W.APPLICATION,ge.MACHINE)}getViewState(){return{inputValue:this.getInput(),inputState:this.collectInputState(),selectedLanguageModelId:this.inputPart.currentLanguageModel}}updateChatInputContext(){const e=this.parsedInput.parts.find(i=>i instanceof Te);this.agentInInput.set(!!e),this.agentSupportsModelPicker.set(!e||!!e.agent.supportsModelPicker)}};v=L([c(4,se),c(5,O),c(6,de),c(7,Fe),c(8,me),c(9,Oe),c(10,ae),c(11,Re),c(12,ce),c(13,pe),c(14,xe),c(15,Me),c(16,ue)],v);class Ci{_widgets=[];_lastFocusedWidget=void 0;get lastFocusedWidget(){return Ce.activeChatController?.chatWidget??this._lastFocusedWidget}constructor(){}getWidgetByInputUri(a){return this._widgets.find(e=>ie(e.inputUri,a))}getWidgetBySessionId(a){return this._widgets.find(e=>e.viewModel?.sessionId===a)}setLastFocusedWidget(a){a!==this._lastFocusedWidget&&(this._lastFocusedWidget=a)}register(a){if(this._widgets.some(e=>e===a))throw new Error("Cannot register the same widget multiple times");return this._widgets.push(a),Y(a.onDidFocus(()=>this.setLastFocusedWidget(a)),Z(()=>this._widgets.splice(this._widgets.indexOf(a),1)))}}export{v as ChatWidget,Ci as ChatWidgetService,Ue as isQuickChat};
