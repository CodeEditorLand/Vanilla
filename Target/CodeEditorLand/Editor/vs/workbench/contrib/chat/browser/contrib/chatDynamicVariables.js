var S=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var y=(s,r,n,t)=>{for(var e=t>1?void 0:t?w(r,n):r,a=s.length-1,i;a>=0;a--)(i=s[a])&&(e=(t?i(r,n,e):i(e))||e);return t&&e&&S(r,n,e),e},C=(s,r)=>(n,t)=>r(n,t,s);import{coalesce as R}from"../../../../../base/common/arrays.js";import{MarkdownString as k}from"../../../../../base/common/htmlContent.js";import{Disposable as N}from"../../../../../base/common/lifecycle.js";import{basename as L}from"../../../../../base/common/resources.js";import{URI as V}from"../../../../../base/common/uri.js";import{Range as g}from"../../../../../editor/common/core/range.js";import{ITextModelService as E}from"../../../../../editor/common/services/resolverService.js";import{localize as x}from"../../../../../nls.js";import{Action2 as D,registerAction2 as A}from"../../../../../platform/actions/common/actions.js";import{ICommandService as F}from"../../../../../platform/commands/common/commands.js";import{ILabelService as O}from"../../../../../platform/label/common/label.js";import{ILogService as W}from"../../../../../platform/log/common/log.js";import{IQuickInputService as q}from"../../../../../platform/quickinput/common/quickInput.js";import{IChatVariablesService as M}from"../../common/chatVariables.js";import{ChatWidget as T}from"../chatWidget.js";const j="chat-dynamic-variable";let d=class extends N{constructor(n,t){super();this.widget=n;this.labelService=t;this._register(n.inputEditor.onDidChangeModelContent(e=>{e.changes.forEach(a=>{this._variables=R(this._variables.map(i=>{const c=g.intersectRanges(i.range,a.range);if(c&&!c.isEmpty()){if(!g.containsRange(a.range,i.range)){const o=new g(i.range.startLineNumber,i.range.startColumn,i.range.endLineNumber,i.range.endColumn-1);this.widget.inputEditor.executeEdits(this.id,[{range:o,text:""}])}return null}else if(g.compareRangesUsingStarts(i.range,a.range)>0){const o=a.text.length-a.rangeLength;return{...i,range:{startLineNumber:i.range.startLineNumber,startColumn:i.range.startColumn+o,endLineNumber:i.range.endLineNumber,endColumn:i.range.endColumn+o}}}return i}))}),this.updateDecorations()}))}static ID="chatDynamicVariableModel";_variables=[];get variables(){return[...this._variables]}get id(){return d.ID}getInputState(){return this.variables}setInputState(n){Array.isArray(n)||(n=[]),this._variables=n,this.updateDecorations()}addReference(n){this._variables.push(n),this.updateDecorations()}updateDecorations(){this.widget.inputEditor.setDecorationsByType("chat",j,this._variables.map(n=>({range:n.range,hoverMessage:this.getHoverForReference(n)})))}getHoverForReference(n){const t=n.data;if(V.isUri(t))return new k(this.labelService.getUriLabel(t,{relative:!0}))}};d=y([C(1,O)],d),T.CONTRIBS.push(d);function Q(s){return"widget"in s&&"range"in s}class l extends D{static Name="files";static Item={label:x("allFiles","All Files"),description:x("allFilesDescription","Search for relevant files in the workspace and provide context from them")};static ID="workbench.action.chat.selectAndInsertFile";constructor(){super({id:l.ID,title:""})}async run(r,...n){const t=r.get(E),e=r.get(W),a=r.get(q),i=r.get(M),c=n[0];if(!Q(c))return;const o=()=>{c.widget.inputEditor.executeEdits("chatInsertFile",[{range:c.range,text:""}])};let u;i.hasVariable(l.Name)&&(u={providerOptions:{additionPicks:[l.Item,{type:"separator"}]}});const p=await a.quickAccess.pick("",u);if(!p?.length){e.trace("SelectAndInsertFileAction: no file selected"),o();return}const b=c.widget.inputEditor,m=c.range;if(p[0]===l.Item){const v=`#${l.Name}`;b.executeEdits("chatInsertFile",[{range:m,text:v+" "}])||(e.trace(`SelectAndInsertFileAction: failed to insert "${v}"`),o());return}const h=p[0].resource;if(!t.canHandleResource(h)){e.trace("SelectAndInsertFileAction: non-text resource selected"),o();return}const I=`#file:${L(h)}`;if(!b.executeEdits("chatInsertFile",[{range:m,text:I+" "}])){e.trace(`SelectAndInsertFileAction: failed to insert "${I}"`),o();return}c.widget.getContrib(d.ID)?.addReference({id:"vscode.file",range:{startLineNumber:m.startLineNumber,startColumn:m.startColumn,endLineNumber:m.endLineNumber,endColumn:m.startColumn+I.length},data:h})}}A(l);function U(s){return"widget"in s&&"range"in s&&"variableData"in s}class f extends D{static ID="workbench.action.chat.addDynamicVariable";constructor(){super({id:f.ID,title:""})}async run(r,...n){const t=n[0];if(!U(t))return;let e=t.range;const a=t.variableData,i=()=>{t.widget.inputEditor.executeEdits("chatInsertDynamicVariableWithArguments",[{range:t.range,text:""}])};if(t.command){const o=await r.get(F).executeCommand(t.command.id,...t.command.arguments??[]);if(!o){i();return}const u=":"+o,p=new g(e.startLineNumber,e.endColumn,e.endLineNumber,e.endColumn+u.length);if(e=new g(e.startLineNumber,e.startColumn,e.endLineNumber,e.endColumn+u.length),!t.widget.inputEditor.executeEdits("chatInsertDynamicVariableWithArguments",[{range:p,text:u+" "}])){i();return}}t.widget.getContrib(d.ID)?.addReference({id:t.id,range:e,data:a})}}A(f);export{f as AddDynamicVariableAction,d as ChatDynamicVariableModel,l as SelectAndInsertFileAction,j as dynamicVariableDecorationType};
