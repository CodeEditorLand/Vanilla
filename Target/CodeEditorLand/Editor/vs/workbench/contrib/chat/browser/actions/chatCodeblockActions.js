import{CancellationTokenSource as V}from"../../../../../base/common/cancellation.js";import{Codicon as E}from"../../../../../base/common/codicons.js";import{KeyCode as g,KeyMod as l}from"../../../../../base/common/keyCodes.js";import{isEqual as te}from"../../../../../base/common/resources.js";import{isCodeEditor as oe,isDiffEditor as ne}from"../../../../../editor/browser/editorBrowser.js";import"../../../../../editor/browser/editorExtensions.js";import{IBulkEditService as re,ResourceTextEdit as N}from"../../../../../editor/browser/services/bulkEditService.js";import{ICodeEditorService as R}from"../../../../../editor/browser/services/codeEditorService.js";import{Range as ie}from"../../../../../editor/common/core/range.js";import{EditorContextKeys as B}from"../../../../../editor/common/editorContextKeys.js";import{isLocation as ce}from"../../../../../editor/common/languages.js";import{ILanguageService as se}from"../../../../../editor/common/languages/language.js";import"../../../../../editor/common/model.js";import{ILanguageFeaturesService as de}from"../../../../../editor/common/services/languageFeatures.js";import{CopyAction as ae}from"../../../../../editor/contrib/clipboard/browser/clipboard.js";import{localize as _,localize2 as I}from"../../../../../nls.js";import{Action2 as b,MenuId as y,registerAction2 as h}from"../../../../../platform/actions/common/actions.js";import{IClipboardService as K}from"../../../../../platform/clipboard/common/clipboardService.js";import{ContextKeyExpr as m}from"../../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as H}from"../../../../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as T}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import{INotificationService as le,Severity as ue}from"../../../../../platform/notification/common/notification.js";import{IProgressService as me,ProgressLocation as pe}from"../../../../../platform/progress/common/progress.js";import{TerminalLocation as Ce}from"../../../../../platform/terminal/common/terminal.js";import"../../../../common/editor.js";import{accessibleViewInCodeBlock as D}from"../../../accessibility/browser/accessibilityConfiguration.js";import{CHAT_CATEGORY as v}from"./chatActions.js";import{IChatWidgetService as z,IChatCodeBlockContextProviderService as ge}from"../chat.js";import{DefaultChatTextEditor as X}from"../codeBlockPart.js";import{CONTEXT_IN_CHAT_INPUT as j,CONTEXT_IN_CHAT_SESSION as k,CONTEXT_CHAT_ENABLED as S,CONTEXT_CHAT_EDIT_APPLIED as G}from"../../common/chatContextKeys.js";import{ChatCopyKind as Y,IChatService as w}from"../../common/chatService.js";import{isRequestVM as fe,isResponseVM as f}from"../../common/chatViewModel.js";import{insertCell as Ie}from"../../../notebook/browser/controller/cellOperations.js";import"../../../notebook/browser/notebookBrowser.js";import{CellKind as he,NOTEBOOK_EDITOR_ID as ve}from"../../../notebook/common/notebookCommon.js";import{ITerminalEditorService as ke,ITerminalGroupService as ye,ITerminalService as Ee}from"../../../terminal/browser/terminal.js";import{IEditorService as W}from"../../../../services/editor/common/editorService.js";import{ITextFileService as Ae}from"../../../../services/textfile/common/textfiles.js";import*as Se from"../../../../../base/common/strings.js";import{CharCode as J}from"../../../../../base/common/charCode.js";import{InlineChatController as we}from"../../../inlineChat/browser/inlineChatController.js";import{coalesce as xe}from"../../../../../base/common/arrays.js";import{AsyncIterableObject as Be}from"../../../../../base/common/async.js";import{ResourceMap as be}from"../../../../../base/common/map.js";import{URI as Te}from"../../../../../base/common/uri.js";const L=["fish","ps1","pwsh","powershell","sh","shellscript","zsh"];function U(c){return typeof c=="object"&&c!==null&&"code"in c&&"element"in c}function Me(c){return typeof c=="object"&&c!==null&&"element"in c}function F(c){return f(c.element)&&c.element.errorDetails?.responseIsFiltered}function Re(c){return f(c.element)?c.element.usedContext?.documents:void 0}function We(c){const r=new be;for(const e of c){let t,o;if(Te.isUri(e.reference)?t=e.reference:ce(e.reference)&&(t=e.reference.uri,o=e.reference.range),t){const n=r.get(t);n?o&&n.ranges.push(o):r.set(t,{uri:t,version:-1,ranges:o?[o]:[]})}}return[...r.values()]}function Fe(c){return f(c.element)?[{type:"response",message:c.element.response.toMarkdown(),references:We(c.element.contentReferences)}]:fe(c.element)?[{type:"request",message:c.element.messageText}]:[]}class q extends b{run(r,...e){let t=e[0];if(!U(t)){const o=r.get(R),n=o.getFocusedCodeEditor()||o.getActiveCodeEditor();if(!n||(t=$(n,r),!U(t)))return}return this.runWithContext(r,t)}}class Q extends q{async runWithContext(r,e){const t=r.get(W),o=r.get(Ae);if(F(e))return;if(t.activeEditorPane?.getId()===ve)return this.handleNotebookEditor(r,t.activeEditorPane.getControl(),e);let n=t.activeTextEditorControl;if(ne(n)&&(n=n.getOriginalEditor().hasTextFocus()?n.getOriginalEditor():n.getModifiedEditor()),!oe(n)||!n.hasModel())return;const d=n.getModel().uri,s=o.files.get(d)??o.untitled.get(d);!s||s.isReadonly()||await this.handleTextEditor(r,n,e)}async handleNotebookEditor(r,e,t){if(!e.hasModel()||e.isReadOnly)return;if(e.activeCodeEditor?.hasTextFocus()){const a=e.activeCodeEditor;if(a.hasModel())return this.handleTextEditor(r,a,t)}const o=r.get(se),n=r.get(w),d=e.getFocus(),s=Math.max(d.end-1,0);Ie(o,e,s,he.Code,"below",t.code,!0),this.notifyUserAction(n,t)}async computeEdits(r,e,t){const o=e.getModel(),n=e.getSelection()??new ie(o.getLineCount(),1,o.getLineCount(),1),d=Pe(t.code,o,n.startLineNumber);if(d!==void 0)return{edits:[new N(o.uri,{range:n,text:d})]}}get showPreview(){return!1}async handleTextEditor(r,e,t){const o=r.get(re),n=r.get(R),d=r.get(w),s=await this.computeEdits(r,e,t);if(this.notifyUserAction(d,t,s),!!s)if(this.showPreview){if(!await this.applyWithInlinePreview(n,s.edits,e)){await o.apply(s.edits,{showPreview:!0});const i=e.getModel();n.listCodeEditors().find(p=>p.getModel()?.uri.toString()===i.uri.toString())?.focus()}}else{await o.apply(s.edits);const a=e.getModel();n.listCodeEditors().find(i=>i.getModel()?.uri.toString()===a.uri.toString())?.focus()}}async applyWithInlinePreview(r,e,t){const o=e[0];if(!N.is(o))return!1;const n=o.resource,d=xe(e.map(a=>N.is(a)&&te(n,a.resource)?a.textEdit:void 0));if(d.length!==e.length)return!1;const s=await r.openCodeEditor({resource:n},t);if(s){const a=we.get(s);if(a){const i=new V;try{return await a.reviewEdits(d[0].range,Be.fromArray(d),i.token)}finally{i.dispose()}}}return!1}notifyUserAction(r,e,t){f(e.element)&&r.notifyUserAction({agentId:e.element.agent?.id,command:e.element.slashCommand?.name,sessionId:e.element.sessionId,requestId:e.element.requestId,result:e.element.result,action:{kind:"insert",codeBlockIndex:e.codeBlockIndex,totalCharacters:e.code.length,userAction:this.desc.id,codeMapper:t?.codeMapper}})}}function Pe(c,r,e){const t=Se.splitLines(c);if(t.length===0)return;const o=r.getFormattingOptions(),n=Z(r.getLineContent(e),o.tabSize).level,d=t.map(i=>Z(i,o.tabSize)),s=d.reduce((i,p,u)=>p.length!==t[u].length?Math.min(p.level,i):i,Number.MAX_VALUE);if(s===Number.MAX_VALUE||s===n)return;const a=[];for(let i=0;i<t.length;i++){const{level:p,length:u}=d[i],C=Math.max(0,n+p-s),A=o.insertSpaces?" ".repeat(o.tabSize*C):"	".repeat(C);a.push(A+t[i].substring(u))}return a.join(`
`)}function Z(c,r){let e=0,t=0,o=0,n=0;const d=c.length;for(;o<d;){const s=c.charCodeAt(o);if(s===J.Space)e++,e===r&&(t++,e=0,n=o+1);else if(s===J.Tab)t++,e=0,n=o+1;else break;o++}return{level:t,length:n}}function Gt(){h(class extends b{constructor(){super({id:"workbench.action.chat.copyCodeBlock",title:I("interactive.copyCodeBlock.label","Copy"),f1:!1,category:v,icon:E.copy,menu:{id:y.ChatCodeBlock,group:"navigation",order:30}})}run(e,...t){const o=t[0];if(!U(o)||F(o))return;e.get(K).writeText(o.code),f(o.element)&&e.get(w).notifyUserAction({agentId:o.element.agent?.id,command:o.element.slashCommand?.name,sessionId:o.element.sessionId,requestId:o.element.requestId,result:o.element.result,action:{kind:"copy",codeBlockIndex:o.codeBlockIndex,copyKind:Y.Toolbar,copiedCharacters:o.code.length,totalCharacters:o.code.length,copiedText:o.code}})}}),ae?.addImplementation(5e4,"chat-codeblock",r=>{const e=r.get(R).getFocusedCodeEditor();if(!e)return!1;const t=e.getModel();if(!t)return!1;const o=$(e,r);if(!o)return!1;const n=e.getSelections()?.length===1&&e.getSelection()?.isEmpty(),d=n?t.getValue():e.getSelections()?.reduce((p,u)=>p+t.getValueInRange(u),"")??"",s=t.getValueLength(),a=r.get(w),i=o.element;return i&&a.notifyUserAction({agentId:i.agent?.id,command:i.slashCommand?.name,sessionId:i.sessionId,requestId:i.requestId,result:i.result,action:{kind:"copy",codeBlockIndex:o.codeBlockIndex,copyKind:Y.Action,copiedText:d,copiedCharacters:d.length,totalCharacters:s}}),n?(r.get(K).writeText(o.code),!0):!1}),h(class extends Q{constructor(){super({id:"workbench.action.chat.applyInEditor",title:I("interactive.applyInEditor.label","Apply in Editor"),precondition:S,f1:!0,category:v,icon:E.sparkle,menu:{id:y.ChatCodeBlock,group:"navigation",when:m.and(k,...L.map(e=>m.notEquals(B.languageId.key,e))),order:10},keybinding:{when:m.or(m.and(k,j.negate()),D),primary:l.CtrlCmd|g.Enter,mac:{primary:l.WinCtrl|g.Enter},weight:T.ExternalExtension+1}})}async computeEdits(e,t,o){const n=e.get(me),d=e.get(le),s=t.getModel(),a=e.get(de).mappedEditsProvider.ordered(s);if(a.length>0){const i=[],p=s.uri,u=s.getVersionId(),C=t.getSelections();C.length>0&&i.push([{uri:p,version:u,ranges:C}]);const A=Re(o);A&&i.push(A);const x=new V;try{const M=await n.withProgress({location:pe.Notification,delay:500,sticky:!0,cancellable:!0},async ee=>{for(const P of a){ee.report({message:_("applyCodeBlock.progress","Applying code block using {0}...",P.displayName)});const O=await P.provideMappedEdits(s,[o.code],{documents:i,conversation:Fe(o)},x.token);if(O)return{edits:O.edits,codeMapper:P.displayName}}},()=>x.cancel());if(M)return M}catch(M){d.notify({severity:ue.Error,message:_("applyCodeBlock.error","Failed to apply code block: {0}",M.message)})}finally{x.dispose()}}}get showPreview(){return!0}}),h(class extends Q{constructor(){super({id:"workbench.action.chat.insertCodeBlock",title:I("interactive.insertCodeBlock.label","Insert At Cursor"),precondition:S,f1:!0,category:v,icon:E.insert,menu:{id:y.ChatCodeBlock,group:"navigation",when:k,order:20},keybinding:{when:m.or(m.and(k,j.negate()),D),primary:l.CtrlCmd|g.Enter,mac:{primary:l.WinCtrl|g.Enter},weight:T.ExternalExtension+1}})}}),h(class extends q{constructor(){super({id:"workbench.action.chat.insertIntoNewFile",title:I("interactive.insertIntoNewFile.label","Insert into New File"),precondition:S,f1:!0,category:v,icon:E.newFile,menu:{id:y.ChatCodeBlock,group:"navigation",isHiddenByDefault:!0,order:40}})}async runWithContext(e,t){if(F(t))return;const o=e.get(W),n=e.get(w);o.openEditor({contents:t.code,languageId:t.languageId,resource:void 0}),f(t.element)&&n.notifyUserAction({agentId:t.element.agent?.id,command:t.element.slashCommand?.name,sessionId:t.element.sessionId,requestId:t.element.requestId,result:t.element.result,action:{kind:"insert",codeBlockIndex:t.codeBlockIndex,totalCharacters:t.code.length,newFile:!0,userAction:this.desc.id}})}}),h(class extends q{constructor(){super({id:"workbench.action.chat.runInTerminal",title:I("interactive.runInTerminal.label","Insert into Terminal"),precondition:S,f1:!0,category:v,icon:E.terminal,menu:[{id:y.ChatCodeBlock,group:"navigation",when:m.and(k,m.or(...L.map(e=>m.equals(B.languageId.key,e))))},{id:y.ChatCodeBlock,group:"navigation",isHiddenByDefault:!0,when:m.and(k,...L.map(e=>m.notEquals(B.languageId.key,e)))}],keybinding:[{primary:l.CtrlCmd|l.Alt|g.Enter,mac:{primary:l.WinCtrl|l.Alt|g.Enter},weight:T.EditorContrib,when:m.or(k,D)}]})}async runWithContext(e,t){if(F(t))return;const o=e.get(w),n=e.get(Ee),d=e.get(W),s=e.get(ke),a=e.get(ye);let i=await n.getActiveOrCreateInstance();if(i=i.xterm?.isStdinDisabled||i.shellLaunchConfig.isFeatureTerminal?await n.createTerminal():i,n.setActiveInstance(i),await i.focusWhenReady(!0),i.target===Ce.Editor){const u=d.findEditors(i.resource);s.openEditor(i,{viewColumn:u?.[0].groupId})}else a.showPanel(!0);i.runCommand(t.code,!1),f(t.element)&&o.notifyUserAction({agentId:t.element.agent?.id,command:t.element.slashCommand?.name,sessionId:t.element.sessionId,requestId:t.element.requestId,result:t.element.result,action:{kind:"runInTerminal",codeBlockIndex:t.codeBlockIndex,languageId:t.languageId}})}});function c(r,e){const t=r.get(R),n=r.get(z).lastFocusedWidget;if(!n)return;const s=t.getFocusedCodeEditor()?.getModel()?.uri,a=s?n.getCodeBlockInfoForEditor(s):void 0,i=!n.inputEditor.hasWidgetFocus()&&n.getFocus(),p=f(i)?i:void 0,u=a?a.element:p??n.viewModel?.getItems().reverse().find(x=>f(x));if(!u||!f(u))return;n.reveal(u);const C=n.getCodeBlockInfosForResponse(u),A=a?(a.codeBlockIndex+(e?-1:1)+C.length)%C.length:e?C.length-1:0;C[A]?.focus()}h(class extends b{constructor(){super({id:"workbench.action.chat.nextCodeBlock",title:I("interactive.nextCodeBlock.label","Next Code Block"),keybinding:{primary:l.CtrlCmd|l.Alt|g.PageDown,mac:{primary:l.CtrlCmd|l.Alt|g.PageDown},weight:T.WorkbenchContrib,when:k},precondition:S,f1:!0,category:v})}run(e,...t){c(e)}}),h(class extends b{constructor(){super({id:"workbench.action.chat.previousCodeBlock",title:I("interactive.previousCodeBlock.label","Previous Code Block"),keybinding:{primary:l.CtrlCmd|l.Alt|g.PageUp,mac:{primary:l.CtrlCmd|l.Alt|g.PageUp},weight:T.WorkbenchContrib,when:k},precondition:S,f1:!0,category:v})}run(e,...t){c(e,!0)}})}function $(c,r){const e=r.get(z),t=r.get(ge),o=c.getModel();if(!o)return;const d=e.lastFocusedWidget?.getCodeBlockInfoForEditor(o.uri);if(!d){for(const s of t.providers){const a=s.getCodeBlockContext(c);if(a)return a}return}return{element:d.element,codeBlockIndex:d.codeBlockIndex,code:c.getValue(),languageId:c.getModel().getLanguageId()}}function Qt(){class c extends b{run(e,...t){const o=t[0];if(Me(o))return this.runWithContext(e,o)}}h(class extends c{constructor(){super({id:"workbench.action.chat.applyCompareEdits",title:I("interactive.compare.apply","Apply Edits"),f1:!1,category:v,icon:E.check,precondition:m.and(B.hasChanges,G.negate()),menu:{id:y.ChatCompareBlock,group:"navigation",order:1}})}async runWithContext(e,t){const o=e.get(W);await e.get(H).createInstance(X).apply(t.element,t.edit,t.diffEditor),await o.openEditor({resource:t.edit.uri,options:{revealIfVisible:!0}})}}),h(class extends c{constructor(){super({id:"workbench.action.chat.discardCompareEdits",title:I("interactive.compare.discard","Discard Edits"),f1:!1,category:v,icon:E.trash,precondition:m.and(B.hasChanges,G.negate()),menu:{id:y.ChatCompareBlock,group:"navigation",order:2}})}async runWithContext(e,t){e.get(H).createInstance(X).discard(t.element,t.edit)}})}export{U as isCodeBlockActionContext,Me as isCodeCompareBlockActionContext,Gt as registerChatCodeBlockActions,Qt as registerChatCodeCompareBlockActions};
