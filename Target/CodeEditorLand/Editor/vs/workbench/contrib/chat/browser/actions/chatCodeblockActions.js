import{coalesce as te}from"../../../../../../vs/base/common/arrays.js";import{AsyncIterableObject as oe}from"../../../../../../vs/base/common/async.js";import{CancellationTokenSource as V}from"../../../../../../vs/base/common/cancellation.js";import{CharCode as q}from"../../../../../../vs/base/common/charCode.js";import{Codicon as A}from"../../../../../../vs/base/common/codicons.js";import{KeyCode as g,KeyMod as u}from"../../../../../../vs/base/common/keyCodes.js";import{isEqual as ne}from"../../../../../../vs/base/common/resources.js";import*as ie from"../../../../../../vs/base/common/strings.js";import{isCodeEditor as re,isDiffEditor as ce}from"../../../../../../vs/editor/browser/editorBrowser.js";import"../../../../../../vs/editor/browser/editorExtensions.js";import{IBulkEditService as se,ResourceTextEdit as D}from"../../../../../../vs/editor/browser/services/bulkEditService.js";import{ICodeEditorService as W}from"../../../../../../vs/editor/browser/services/codeEditorService.js";import{Range as de}from"../../../../../../vs/editor/common/core/range.js";import{EditorContextKeys as F}from"../../../../../../vs/editor/common/editorContextKeys.js";import"../../../../../../vs/editor/common/languages.js";import{ILanguageService as ae}from"../../../../../../vs/editor/common/languages/language.js";import"../../../../../../vs/editor/common/model.js";import{ILanguageFeaturesService as le}from"../../../../../../vs/editor/common/services/languageFeatures.js";import{CopyAction as ue}from"../../../../../../vs/editor/contrib/clipboard/browser/clipboard.js";import{localize as K,localize2 as I}from"../../../../../../vs/nls.js";import{Action2 as B,MenuId as E,registerAction2 as h}from"../../../../../../vs/platform/actions/common/actions.js";import{IClipboardService as H}from"../../../../../../vs/platform/clipboard/common/clipboardService.js";import{ContextKeyExpr as p}from"../../../../../../vs/platform/contextkey/common/contextkey.js";import{IInstantiationService as z}from"../../../../../../vs/platform/instantiation/common/instantiation.js";import{KeybindingWeight as b}from"../../../../../../vs/platform/keybinding/common/keybindingsRegistry.js";import{INotificationService as me,Severity as pe}from"../../../../../../vs/platform/notification/common/notification.js";import{IProgressService as Ce,ProgressLocation as ge}from"../../../../../../vs/platform/progress/common/progress.js";import{TerminalLocation as fe}from"../../../../../../vs/platform/terminal/common/terminal.js";import"../../../../../../vs/workbench/common/editor.js";import{accessibleViewInCodeBlock as L}from"../../../../../../vs/workbench/contrib/accessibility/browser/accessibilityConfiguration.js";import{CHAT_CATEGORY as v}from"../../../../../../vs/workbench/contrib/chat/browser/actions/chatActions.js";import{IChatCodeBlockContextProviderService as Ie,IChatWidgetService as X}from"../../../../../../vs/workbench/contrib/chat/browser/chat.js";import{DefaultChatTextEditor as j}from"../../../../../../vs/workbench/contrib/chat/browser/codeBlockPart.js";import{CONTEXT_CHAT_EDIT_APPLIED as G,CONTEXT_CHAT_ENABLED as S,CONTEXT_IN_CHAT_INPUT as Y,CONTEXT_IN_CHAT_SESSION as k}from"../../../../../../vs/workbench/contrib/chat/common/chatContextKeys.js";import{ChatCopyKind as J,IChatService as w}from"../../../../../../vs/workbench/contrib/chat/common/chatService.js";import{isResponseVM as y}from"../../../../../../vs/workbench/contrib/chat/common/chatViewModel.js";import{InlineChatController as he}from"../../../../../../vs/workbench/contrib/inlineChat/browser/inlineChatController.js";import{insertCell as ve}from"../../../../../../vs/workbench/contrib/notebook/browser/controller/cellOperations.js";import"../../../../../../vs/workbench/contrib/notebook/browser/notebookBrowser.js";import{CellKind as ke,NOTEBOOK_EDITOR_ID as ye}from"../../../../../../vs/workbench/contrib/notebook/common/notebookCommon.js";import{ITerminalEditorService as Ee,ITerminalGroupService as Ae,ITerminalService as Se}from"../../../../../../vs/workbench/contrib/terminal/browser/terminal.js";import{IEditorService as N}from"../../../../../../vs/workbench/services/editor/common/editorService.js";import{ITextFileService as we}from"../../../../../../vs/workbench/services/textfile/common/textfiles.js";function U(c){return typeof c=="object"&&c!==null&&"code"in c&&"element"in c}function xe(c){return typeof c=="object"&&c!==null&&"element"in c}function P(c){return y(c.element)&&c.element.errorDetails?.responseIsFiltered}function Be(c){return y(c.element)?c.element.usedContext?.documents:void 0}class O extends B{run(r,...o){let e=o[0];if(!U(e)){const t=r.get(W),n=t.getFocusedCodeEditor()||t.getActiveCodeEditor();if(!n||(e=$(n,r),!U(e)))return}return this.runWithContext(r,e)}}class Q extends O{async runWithContext(r,o){const e=r.get(N),t=r.get(we);if(P(o))return;if(e.activeEditorPane?.getId()===ye)return this.handleNotebookEditor(r,e.activeEditorPane.getControl(),o);let n=e.activeTextEditorControl;if(ce(n)&&(n=n.getOriginalEditor().hasTextFocus()?n.getOriginalEditor():n.getModifiedEditor()),!re(n)||!n.hasModel())return;const i=n.getModel().uri,d=t.files.get(i)??t.untitled.get(i);!d||d.isReadonly()||await this.handleTextEditor(r,n,o)}async handleNotebookEditor(r,o,e){if(!o.hasModel()||o.isReadOnly)return;if(o.activeCodeEditor?.hasTextFocus()){const a=o.activeCodeEditor;if(a.hasModel())return this.handleTextEditor(r,a,e)}const t=r.get(ae),n=r.get(w),i=o.getFocus(),d=Math.max(i.end-1,0);ve(t,o,d,ke.Code,"below",e.code,!0),this.notifyUserAction(n,e)}async computeEdits(r,o,e){const t=o.getModel(),n=o.getSelection()??new de(t.getLineCount(),1,t.getLineCount(),1),i=be(e.code,t,n.startLineNumber);return{edits:[new D(t.uri,{range:n,text:i})]}}async handleTextEditor(r,o,e){const t=r.get(se),n=r.get(W),i=r.get(w),d=await this.computeEdits(r,o,e);if(this.notifyUserAction(i,e,d),!await this.applyWithInlinePreview(n,d.edits,o)){await t.apply(d.edits,{showPreview:!0});const l=o.getModel();n.listCodeEditors().find(s=>s.getModel()?.uri.toString()===l.uri.toString())?.focus()}}async applyWithInlinePreview(r,o,e){const t=o[0];if(!D.is(t))return!1;const n=t.resource,i=te(o.map(a=>D.is(a)&&ne(n,a.resource)?a.textEdit:void 0));if(i.length!==o.length)return!1;const d=await r.openCodeEditor({resource:n},e);if(d){const a=he.get(d);if(a){const l=new V;try{return await a.reviewEdits(i[0].range,oe.fromArray(i),l.token)}finally{l.dispose()}}}return!1}notifyUserAction(r,o,e){y(o.element)&&r.notifyUserAction({agentId:o.element.agent?.id,command:o.element.slashCommand?.name,sessionId:o.element.sessionId,requestId:o.element.requestId,result:o.element.result,action:{kind:"insert",codeBlockIndex:o.codeBlockIndex,totalCharacters:o.code.length,userAction:this.desc.id,codeMapper:e?.codeMapper}})}}function be(c,r,o){const e=ie.splitLines(c);if(e.length===0)return c;const t=r.getFormattingOptions(),n=Z(r.getLineContent(o),t.tabSize).level,i=e.map(l=>Z(l,t.tabSize)),d=i.reduce((l,s,C)=>s.length!==e[C].length?Math.min(s.level,l):l,Number.MAX_VALUE);if(d===Number.MAX_VALUE||d===n)return c;const a=[];for(let l=0;l<e.length;l++){const{level:s,length:C}=i[l],m=Math.max(0,n+s-d),f=t.insertSpaces?" ".repeat(t.tabSize*m):"	".repeat(m);a.push(f+e[l].substring(C))}return a.join(`
`)}function Z(c,r){let o=0,e=0,t=0,n=0;const i=c.length;for(;t<i;){const d=c.charCodeAt(t);if(d===q.Space)o++,o===r&&(e++,o=0,n=t+1);else if(d===q.Tab)e++,o=0,n=t+1;else break;t++}return{level:e,length:n}}function Lt(){h(class extends B{constructor(){super({id:"workbench.action.chat.copyCodeBlock",title:I("interactive.copyCodeBlock.label","Copy"),f1:!1,category:v,icon:A.copy,menu:{id:E.ChatCodeBlock,group:"navigation",order:30}})}run(e,...t){const n=t[0];if(!U(n)||P(n))return;e.get(H).writeText(n.code),y(n.element)&&e.get(w).notifyUserAction({agentId:n.element.agent?.id,command:n.element.slashCommand?.name,sessionId:n.element.sessionId,requestId:n.element.requestId,result:n.element.result,action:{kind:"copy",codeBlockIndex:n.codeBlockIndex,copyKind:J.Toolbar,copiedCharacters:n.code.length,totalCharacters:n.code.length,copiedText:n.code}})}}),ue?.addImplementation(5e4,"chat-codeblock",o=>{const e=o.get(W).getFocusedCodeEditor();if(!e)return!1;const t=e.getModel();if(!t)return!1;const n=$(e,o);if(!n)return!1;const i=e.getSelections()?.length===1&&e.getSelection()?.isEmpty(),d=i?t.getValue():e.getSelections()?.reduce((C,m)=>C+t.getValueInRange(m),"")??"",a=t.getValueLength(),l=o.get(w),s=n.element;return s&&l.notifyUserAction({agentId:s.agent?.id,command:s.slashCommand?.name,sessionId:s.sessionId,requestId:s.requestId,result:s.result,action:{kind:"copy",codeBlockIndex:n.codeBlockIndex,copyKind:J.Action,copiedText:d,copiedCharacters:d.length,totalCharacters:a}}),i?(o.get(H).writeText(n.code),!0):!1}),h(class extends Q{constructor(){super({id:"workbench.action.chat.applyInEditor",title:I("interactive.applyInEditor.label","Apply in Editor"),precondition:S,f1:!0,category:v,icon:A.sparkle,menu:{id:E.ChatCodeBlock,group:"navigation",when:k,order:10},keybinding:{when:p.or(p.and(k,Y.negate()),L),primary:u.CtrlCmd|g.Enter,mac:{primary:u.WinCtrl|g.Enter},weight:b.ExternalExtension+1}})}async computeEdits(e,t,n){const i=e.get(Ce),d=e.get(me),a=t.getModel(),l=e.get(le).mappedEditsProvider.ordered(a);if(l.length>0){const s=[],C=a.uri,m=a.getVersionId(),f=t.getSelections();f.length>0&&s.push([{uri:C,version:m,ranges:f}]);const T=Be(n);T&&s.push(T);const x=new V;try{const M=await i.withProgress({location:ge.Notification,delay:500,sticky:!0,cancellable:!0},async ee=>{for(const R of l){ee.report({message:K("applyCodeBlock.progress","Applying code block using {0}...",R.displayName)});const _=await R.provideMappedEdits(a,[n.code],{documents:s},x.token);if(_)return{edits:_.edits,codeMapper:R.displayName}}},()=>x.cancel());if(M)return M}catch(M){d.notify({severity:pe.Error,message:K("applyCodeBlock.error","Failed to apply code block: {0}",M.message)})}finally{x.dispose()}}return super.computeEdits(e,t,n)}}),h(class extends Q{constructor(){super({id:"workbench.action.chat.insertCodeBlock",title:I("interactive.insertCodeBlock.label","Insert At Cursor"),precondition:S,f1:!0,category:v,icon:A.insert,menu:{id:E.ChatCodeBlock,group:"navigation",when:k,order:20},keybinding:{when:p.or(p.and(k,Y.negate()),L),primary:u.CtrlCmd|g.Enter,mac:{primary:u.WinCtrl|g.Enter},weight:b.ExternalExtension+1}})}}),h(class extends O{constructor(){super({id:"workbench.action.chat.insertIntoNewFile",title:I("interactive.insertIntoNewFile.label","Insert into New File"),precondition:S,f1:!0,category:v,icon:A.newFile,menu:{id:E.ChatCodeBlock,group:"navigation",isHiddenByDefault:!0,order:40}})}async runWithContext(e,t){if(P(t))return;const n=e.get(N),i=e.get(w);n.openEditor({contents:t.code,languageId:t.languageId,resource:void 0}),y(t.element)&&i.notifyUserAction({agentId:t.element.agent?.id,command:t.element.slashCommand?.name,sessionId:t.element.sessionId,requestId:t.element.requestId,result:t.element.result,action:{kind:"insert",codeBlockIndex:t.codeBlockIndex,totalCharacters:t.code.length,newFile:!0,userAction:this.desc.id}})}});const c=["fish","ps1","pwsh","powershell","sh","shellscript","zsh"];h(class extends O{constructor(){super({id:"workbench.action.chat.runInTerminal",title:I("interactive.runInTerminal.label","Insert into Terminal"),precondition:S,f1:!0,category:v,icon:A.terminal,menu:[{id:E.ChatCodeBlock,group:"navigation",when:p.and(k,p.or(...c.map(e=>p.equals(F.languageId.key,e))))},{id:E.ChatCodeBlock,group:"navigation",isHiddenByDefault:!0,when:p.and(k,...c.map(e=>p.notEquals(F.languageId.key,e)))}],keybinding:[{primary:u.CtrlCmd|u.Alt|g.Enter,mac:{primary:u.WinCtrl|u.Alt|g.Enter},weight:b.EditorContrib,when:p.or(k,L)}]})}async runWithContext(e,t){if(P(t))return;const n=e.get(w),i=e.get(Se),d=e.get(N),a=e.get(Ee),l=e.get(Ae);let s=await i.getActiveOrCreateInstance();if(s=s.xterm?.isStdinDisabled||s.shellLaunchConfig.isFeatureTerminal?await i.createTerminal():s,i.setActiveInstance(s),await s.focusWhenReady(!0),s.target===fe.Editor){const m=d.findEditors(s.resource);a.openEditor(s,{viewColumn:m?.[0].groupId})}else l.showPanel(!0);s.runCommand(t.code,!1),y(t.element)&&n.notifyUserAction({agentId:t.element.agent?.id,command:t.element.slashCommand?.name,sessionId:t.element.sessionId,requestId:t.element.requestId,result:t.element.result,action:{kind:"runInTerminal",codeBlockIndex:t.codeBlockIndex,languageId:t.languageId}})}});function r(o,e){const t=o.get(W),i=o.get(X).lastFocusedWidget;if(!i)return;const a=t.getFocusedCodeEditor()?.getModel()?.uri,l=a?i.getCodeBlockInfoForEditor(a):void 0,s=!i.inputEditor.hasWidgetFocus()&&i.getFocus(),C=y(s)?s:void 0,m=l?l.element:C??i.viewModel?.getItems().reverse().find(x=>y(x));if(!m||!y(m))return;i.reveal(m);const f=i.getCodeBlockInfosForResponse(m),T=l?(l.codeBlockIndex+(e?-1:1)+f.length)%f.length:e?f.length-1:0;f[T]?.focus()}h(class extends B{constructor(){super({id:"workbench.action.chat.nextCodeBlock",title:I("interactive.nextCodeBlock.label","Next Code Block"),keybinding:{primary:u.CtrlCmd|u.Alt|g.PageDown,mac:{primary:u.CtrlCmd|u.Alt|g.PageDown},weight:b.WorkbenchContrib,when:k},precondition:S,f1:!0,category:v})}run(e,...t){r(e)}}),h(class extends B{constructor(){super({id:"workbench.action.chat.previousCodeBlock",title:I("interactive.previousCodeBlock.label","Previous Code Block"),keybinding:{primary:u.CtrlCmd|u.Alt|g.PageUp,mac:{primary:u.CtrlCmd|u.Alt|g.PageUp},weight:b.WorkbenchContrib,when:k},precondition:S,f1:!0,category:v})}run(e,...t){r(e,!0)}})}function $(c,r){const o=r.get(X),e=r.get(Ie),t=c.getModel();if(!t)return;const i=o.lastFocusedWidget?.getCodeBlockInfoForEditor(t.uri);if(!i){for(const d of e.providers){const a=d.getCodeBlockContext(c);if(a)return a}return}return{element:i.element,codeBlockIndex:i.codeBlockIndex,code:c.getValue(),languageId:c.getModel().getLanguageId()}}function _t(){class c extends B{run(o,...e){const t=e[0];if(xe(t))return this.runWithContext(o,t)}}h(class extends c{constructor(){super({id:"workbench.action.chat.applyCompareEdits",title:I("interactive.compare.apply","Apply Edits"),f1:!1,category:v,icon:A.check,precondition:p.and(F.hasChanges,G.negate()),menu:{id:E.ChatCompareBlock,group:"navigation",order:1}})}async runWithContext(o,e){const t=o.get(N);await o.get(z).createInstance(j).apply(e.element,e.edit,e.diffEditor),await t.openEditor({resource:e.edit.uri,options:{revealIfVisible:!0}})}}),h(class extends c{constructor(){super({id:"workbench.action.chat.discardCompareEdits",title:I("interactive.compare.discard","Discard Edits"),f1:!1,category:v,icon:A.trash,precondition:p.and(F.hasChanges,G.negate()),menu:{id:E.ChatCompareBlock,group:"navigation",order:2}})}async runWithContext(o,e){o.get(z).createInstance(j).discard(e.element,e.edit)}})}export{U as isCodeBlockActionContext,xe as isCodeCompareBlockActionContext,Lt as registerChatCodeBlockActions,_t as registerChatCodeCompareBlockActions};
