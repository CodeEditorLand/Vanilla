import{Codicon as k}from"../../../../../base/common/codicons.js";import{KeyCode as u,KeyMod as s}from"../../../../../base/common/keyCodes.js";import"../../../../../editor/browser/editorBrowser.js";import"../../../../../editor/browser/editorExtensions.js";import{ICodeEditorService as W}from"../../../../../editor/browser/services/codeEditorService.js";import{EditorContextKeys as y}from"../../../../../editor/common/editorContextKeys.js";import{CopyAction as G}from"../../../../../editor/contrib/clipboard/browser/clipboard.js";import{localize2 as C}from"../../../../../nls.js";import{Action2 as B,MenuId as f,registerAction2 as m}from"../../../../../platform/actions/common/actions.js";import{IClipboardService as q}from"../../../../../platform/clipboard/common/clipboardService.js";import{ContextKeyExpr as d}from"../../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as w}from"../../../../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as x}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import{TerminalLocation as X}from"../../../../../platform/terminal/common/terminal.js";import"../../../../common/editor.js";import{IEditorService as F}from"../../../../services/editor/common/editorService.js";import{accessibleViewInCodeBlock as R}from"../../../accessibility/browser/accessibilityConfiguration.js";import{ITerminalEditorService as j,ITerminalGroupService as z,ITerminalService as Y}from"../../../terminal/browser/terminal.js";import{CONTEXT_CHAT_EDIT_APPLIED as D,CONTEXT_CHAT_ENABLED as A,CONTEXT_IN_CHAT_INPUT as U,CONTEXT_IN_CHAT_SESSION as p}from"../../common/chatContextKeys.js";import{ChatCopyKind as _,IChatService as b}from"../../common/chatService.js";import{isResponseVM as v}from"../../common/chatViewModel.js";import{IChatCodeBlockContextProviderService as J,IChatWidgetService as V}from"../chat.js";import{DefaultChatTextEditor as O}from"../codeBlockPart.js";import{CHAT_CATEGORY as g}from"./chatActions.js";import{InsertCodeBlockOperation as Q,ApplyCodeBlockOperation as Z}from"./codeBlockOperations.js";const N=["fish","ps1","pwsh","powershell","sh","shellscript","zsh"];function P(r){return typeof r=="object"&&r!==null&&"code"in r&&"element"in r}function $(r){return typeof r=="object"&&r!==null&&"element"in r}function M(r){return v(r.element)&&r.element.errorDetails?.responseIsFiltered}class T extends B{run(n,...t){let e=t[0];if(!P(e)){const o=n.get(W),i=o.getFocusedCodeEditor()||o.getActiveCodeEditor();if(!i||(e=K(i,n),!P(e)))return}return this.runWithContext(n,e)}}function Ue(){m(class extends B{constructor(){super({id:"workbench.action.chat.copyCodeBlock",title:C("interactive.copyCodeBlock.label","Copy"),f1:!1,category:g,icon:k.copy,menu:{id:f.ChatCodeBlock,group:"navigation",order:30}})}run(t,...e){const o=e[0];if(!P(o)||M(o))return;t.get(q).writeText(o.code),v(o.element)&&t.get(b).notifyUserAction({agentId:o.element.agent?.id,command:o.element.slashCommand?.name,sessionId:o.element.sessionId,requestId:o.element.requestId,result:o.element.result,action:{kind:"copy",codeBlockIndex:o.codeBlockIndex,copyKind:_.Toolbar,copiedCharacters:o.code.length,totalCharacters:o.code.length,copiedText:o.code}})}}),G?.addImplementation(5e4,"chat-codeblock",n=>{const t=n.get(W).getFocusedCodeEditor();if(!t)return!1;const e=t.getModel();if(!e)return!1;const o=K(t,n);if(!o)return!1;const i=t.getSelections()?.length===1&&t.getSelection()?.isEmpty(),a=i?e.getValue():t.getSelections()?.reduce((E,h)=>E+e.getValueInRange(h),"")??"",I=e.getValueLength(),l=n.get(b),c=o.element;return c&&l.notifyUserAction({agentId:c.agent?.id,command:c.slashCommand?.name,sessionId:c.sessionId,requestId:c.requestId,result:c.result,action:{kind:"copy",codeBlockIndex:o.codeBlockIndex,copyKind:_.Action,copiedText:a,copiedCharacters:a.length,totalCharacters:I}}),i?(n.get(q).writeText(o.code),!0):!1}),m(class extends T{operation;constructor(){super({id:"workbench.action.chat.applyInEditor",title:C("interactive.applyInEditor.label","Apply in Editor"),precondition:A,f1:!0,category:g,icon:k.gitPullRequestGoToChanges,menu:{id:f.ChatCodeBlock,group:"navigation",when:d.and(p,...N.map(t=>d.notEquals(y.languageId.key,t))),order:10},keybinding:{when:d.or(d.and(p,U.negate()),R),primary:s.CtrlCmd|u.Enter,mac:{primary:s.WinCtrl|u.Enter},weight:x.ExternalExtension+1}})}runWithContext(t,e){return this.operation||(this.operation=t.get(w).createInstance(Z)),this.operation.run(e)}}),m(class extends T{constructor(){super({id:"workbench.action.chat.insertCodeBlock",title:C("interactive.insertCodeBlock.label","Insert At Cursor"),precondition:A,f1:!0,category:g,icon:k.insert,menu:{id:f.ChatCodeBlock,group:"navigation",when:p,order:20},keybinding:{when:d.or(d.and(p,U.negate()),R),primary:s.CtrlCmd|u.Enter,mac:{primary:s.WinCtrl|u.Enter},weight:x.ExternalExtension+1}})}runWithContext(t,e){return t.get(w).createInstance(Q).run(e)}}),m(class extends T{constructor(){super({id:"workbench.action.chat.insertIntoNewFile",title:C("interactive.insertIntoNewFile.label","Insert into New File"),precondition:A,f1:!0,category:g,icon:k.newFile,menu:{id:f.ChatCodeBlock,group:"navigation",isHiddenByDefault:!0,order:40}})}async runWithContext(t,e){if(M(e))return;const o=t.get(F),i=t.get(b);o.openEditor({contents:e.code,languageId:e.languageId,resource:void 0}),v(e.element)&&i.notifyUserAction({agentId:e.element.agent?.id,command:e.element.slashCommand?.name,sessionId:e.element.sessionId,requestId:e.element.requestId,result:e.element.result,action:{kind:"insert",codeBlockIndex:e.codeBlockIndex,totalCharacters:e.code.length,newFile:!0}})}}),m(class extends T{constructor(){super({id:"workbench.action.chat.runInTerminal",title:C("interactive.runInTerminal.label","Insert into Terminal"),precondition:A,f1:!0,category:g,icon:k.terminal,menu:[{id:f.ChatCodeBlock,group:"navigation",when:d.and(p,d.or(...N.map(t=>d.equals(y.languageId.key,t))))},{id:f.ChatCodeBlock,group:"navigation",isHiddenByDefault:!0,when:d.and(p,...N.map(t=>d.notEquals(y.languageId.key,t)))}],keybinding:[{primary:s.CtrlCmd|s.Alt|u.Enter,mac:{primary:s.WinCtrl|s.Alt|u.Enter},weight:x.EditorContrib,when:d.or(p,R)}]})}async runWithContext(t,e){if(M(e))return;const o=t.get(b),i=t.get(Y),a=t.get(F),I=t.get(j),l=t.get(z);let c=await i.getActiveOrCreateInstance();if(c=c.xterm?.isStdinDisabled||c.shellLaunchConfig.isFeatureTerminal?await i.createTerminal():c,i.setActiveInstance(c),await c.focusWhenReady(!0),c.target===X.Editor){const h=a.findEditors(c.resource);I.openEditor(c,{viewColumn:h?.[0].groupId})}else l.showPanel(!0);c.runCommand(e.code,!1),v(e.element)&&o.notifyUserAction({agentId:e.element.agent?.id,command:e.element.slashCommand?.name,sessionId:e.element.sessionId,requestId:e.element.requestId,result:e.element.result,action:{kind:"runInTerminal",codeBlockIndex:e.codeBlockIndex,languageId:e.languageId}})}});function r(n,t){const e=n.get(W),i=n.get(V).lastFocusedWidget;if(!i)return;const I=e.getFocusedCodeEditor()?.getModel()?.uri,l=I?i.getCodeBlockInfoForEditor(I):void 0,c=!i.inputEditor.hasWidgetFocus()&&i.getFocus(),E=v(c)?c:void 0,h=l?l.element:E??i.viewModel?.getItems().reverse().find(L=>v(L));if(!h||!v(h))return;i.reveal(h);const S=i.getCodeBlockInfosForResponse(h),H=l?(l.codeBlockIndex+(t?-1:1)+S.length)%S.length:t?S.length-1:0;S[H]?.focus()}m(class extends B{constructor(){super({id:"workbench.action.chat.nextCodeBlock",title:C("interactive.nextCodeBlock.label","Next Code Block"),keybinding:{primary:s.CtrlCmd|s.Alt|u.PageDown,mac:{primary:s.CtrlCmd|s.Alt|u.PageDown},weight:x.WorkbenchContrib,when:p},precondition:A,f1:!0,category:g})}run(t,...e){r(t)}}),m(class extends B{constructor(){super({id:"workbench.action.chat.previousCodeBlock",title:C("interactive.previousCodeBlock.label","Previous Code Block"),keybinding:{primary:s.CtrlCmd|s.Alt|u.PageUp,mac:{primary:s.CtrlCmd|s.Alt|u.PageUp},weight:x.WorkbenchContrib,when:p},precondition:A,f1:!0,category:g})}run(t,...e){r(t,!0)}})}function K(r,n){const t=n.get(V),e=n.get(J),o=r.getModel();if(!o)return;const a=t.lastFocusedWidget?.getCodeBlockInfoForEditor(o.uri);if(!a){for(const I of e.providers){const l=I.getCodeBlockContext(r);if(l)return l}return}return{element:a.element,codeBlockIndex:a.codeBlockIndex,code:r.getValue(),languageId:r.getModel().getLanguageId(),codemapperUri:a.codemapperUri}}function Oe(){class r extends B{run(t,...e){const o=e[0];if($(o))return this.runWithContext(t,o)}}m(class extends r{constructor(){super({id:"workbench.action.chat.applyCompareEdits",title:C("interactive.compare.apply","Apply Edits"),f1:!1,category:g,icon:k.check,precondition:d.and(y.hasChanges,D.negate()),menu:{id:f.ChatCompareBlock,group:"navigation",order:1}})}async runWithContext(t,e){const o=t.get(F);await t.get(w).createInstance(O).apply(e.element,e.edit,e.diffEditor),await o.openEditor({resource:e.edit.uri,options:{revealIfVisible:!0}})}}),m(class extends r{constructor(){super({id:"workbench.action.chat.discardCompareEdits",title:C("interactive.compare.discard","Discard Edits"),f1:!1,category:g,icon:k.trash,precondition:d.and(y.hasChanges,D.negate()),menu:{id:f.ChatCompareBlock,group:"navigation",order:2}})}async runWithContext(t,e){t.get(w).createInstance(O).discard(e.element,e.edit)}})}export{P as isCodeBlockActionContext,$ as isCodeCompareBlockActionContext,Ue as registerChatCodeBlockActions,Oe as registerChatCodeCompareBlockActions};
