import{coalesce as te}from"../../../../../base/common/arrays.js";import{AsyncIterableObject as oe}from"../../../../../base/common/async.js";import{CancellationTokenSource as V}from"../../../../../base/common/cancellation.js";import{CharCode as q}from"../../../../../base/common/charCode.js";import{Codicon as E}from"../../../../../base/common/codicons.js";import{KeyCode as g,KeyMod as l}from"../../../../../base/common/keyCodes.js";import{isEqual as ne}from"../../../../../base/common/resources.js";import*as ie from"../../../../../base/common/strings.js";import{isCodeEditor as re,isDiffEditor as ce}from"../../../../../editor/browser/editorBrowser.js";import"../../../../../editor/browser/editorExtensions.js";import{IBulkEditService as se,ResourceTextEdit as R}from"../../../../../editor/browser/services/bulkEditService.js";import{ICodeEditorService as W}from"../../../../../editor/browser/services/codeEditorService.js";import{Range as de}from"../../../../../editor/common/core/range.js";import{EditorContextKeys as B}from"../../../../../editor/common/editorContextKeys.js";import"../../../../../editor/common/languages.js";import{ILanguageService as ae}from"../../../../../editor/common/languages/language.js";import"../../../../../editor/common/model.js";import{ILanguageFeaturesService as le}from"../../../../../editor/common/services/languageFeatures.js";import{CopyAction as ue}from"../../../../../editor/contrib/clipboard/browser/clipboard.js";import{localize as K,localize2 as f}from"../../../../../nls.js";import{Action2 as b,MenuId as y,registerAction2 as I}from"../../../../../platform/actions/common/actions.js";import{IClipboardService as H}from"../../../../../platform/clipboard/common/clipboardService.js";import{ContextKeyExpr as m}from"../../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as z}from"../../../../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as T}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import{INotificationService as me,Severity as pe}from"../../../../../platform/notification/common/notification.js";import{IProgressService as Ce,ProgressLocation as ge}from"../../../../../platform/progress/common/progress.js";import{TerminalLocation as fe}from"../../../../../platform/terminal/common/terminal.js";import"../../../../common/editor.js";import{IEditorService as F}from"../../../../services/editor/common/editorService.js";import{ITextFileService as Ie}from"../../../../services/textfile/common/textfiles.js";import{accessibleViewInCodeBlock as D}from"../../../accessibility/browser/accessibilityConfiguration.js";import{InlineChatController as he}from"../../../inlineChat/browser/inlineChatController.js";import{insertCell as ve}from"../../../notebook/browser/controller/cellOperations.js";import"../../../notebook/browser/notebookBrowser.js";import{CellKind as ke,NOTEBOOK_EDITOR_ID as ye}from"../../../notebook/common/notebookCommon.js";import{ITerminalEditorService as Ee,ITerminalGroupService as Ae,ITerminalService as Se}from"../../../terminal/browser/terminal.js";import{CONTEXT_CHAT_EDIT_APPLIED as X,CONTEXT_CHAT_ENABLED as S,CONTEXT_IN_CHAT_INPUT as j,CONTEXT_IN_CHAT_SESSION as h}from"../../common/chatContextKeys.js";import{ChatCopyKind as G,IChatService as w}from"../../common/chatService.js";import{isResponseVM as v}from"../../common/chatViewModel.js";import{IChatCodeBlockContextProviderService as we,IChatWidgetService as Y}from"../chat.js";import{DefaultChatTextEditor as J}from"../codeBlockPart.js";import{CHAT_CATEGORY as k}from"./chatActions.js";const L=["fish","ps1","pwsh","powershell","sh","shellscript","zsh"];function U(c){return typeof c=="object"&&c!==null&&"code"in c&&"element"in c}function xe(c){return typeof c=="object"&&c!==null&&"element"in c}function P(c){return v(c.element)&&c.element.errorDetails?.responseIsFiltered}function Be(c){return v(c.element)?c.element.usedContext?.documents:void 0}class O extends b{run(i,...e){let t=e[0];if(!U(t)){const o=i.get(W),n=o.getFocusedCodeEditor()||o.getActiveCodeEditor();if(!n||(t=$(n,i),!U(t)))return}return this.runWithContext(i,t)}}class Q extends O{async runWithContext(i,e){const t=i.get(F),o=i.get(Ie);if(P(e))return;if(t.activeEditorPane?.getId()===ye)return this.handleNotebookEditor(i,t.activeEditorPane.getControl(),e);let n=t.activeTextEditorControl;if(ce(n)&&(n=n.getOriginalEditor().hasTextFocus()?n.getOriginalEditor():n.getModifiedEditor()),!re(n)||!n.hasModel())return;const d=n.getModel().uri,s=o.files.get(d)??o.untitled.get(d);!s||s.isReadonly()||await this.handleTextEditor(i,n,e)}async handleNotebookEditor(i,e,t){if(!e.hasModel()||e.isReadOnly)return;if(e.activeCodeEditor?.hasTextFocus()){const a=e.activeCodeEditor;if(a.hasModel())return this.handleTextEditor(i,a,t)}const o=i.get(ae),n=i.get(w),d=e.getFocus(),s=Math.max(d.end-1,0);ve(o,e,s,ke.Code,"below",t.code,!0),this.notifyUserAction(n,t)}async computeEdits(i,e,t){const o=e.getModel(),n=e.getSelection()??new de(o.getLineCount(),1,o.getLineCount(),1),d=be(t.code,o,n.startLineNumber);return{edits:[new R(o.uri,{range:n,text:d})]}}get showPreview(){return!1}async handleTextEditor(i,e,t){const o=i.get(se),n=i.get(W),d=i.get(w),s=await this.computeEdits(i,e,t);if(this.notifyUserAction(d,t,s),this.showPreview){if(!await this.applyWithInlinePreview(n,s.edits,e)){await o.apply(s.edits,{showPreview:!0});const r=e.getModel();n.listCodeEditors().find(p=>p.getModel()?.uri.toString()===r.uri.toString())?.focus()}}else{await o.apply(s.edits);const a=e.getModel();n.listCodeEditors().find(r=>r.getModel()?.uri.toString()===a.uri.toString())?.focus()}}async applyWithInlinePreview(i,e,t){const o=e[0];if(!R.is(o))return!1;const n=o.resource,d=te(e.map(a=>R.is(a)&&ne(n,a.resource)?a.textEdit:void 0));if(d.length!==e.length)return!1;const s=await i.openCodeEditor({resource:n},t);if(s){const a=he.get(s);if(a){const r=new V;try{return await a.reviewEdits(d[0].range,oe.fromArray(d),r.token)}finally{r.dispose()}}}return!1}notifyUserAction(i,e,t){v(e.element)&&i.notifyUserAction({agentId:e.element.agent?.id,command:e.element.slashCommand?.name,sessionId:e.element.sessionId,requestId:e.element.requestId,result:e.element.result,action:{kind:"insert",codeBlockIndex:e.codeBlockIndex,totalCharacters:e.code.length,userAction:this.desc.id,codeMapper:t?.codeMapper}})}}function be(c,i,e){const t=ie.splitLines(c);if(t.length===0)return c;const o=i.getFormattingOptions(),n=Z(i.getLineContent(e),o.tabSize).level,d=t.map(r=>Z(r,o.tabSize)),s=d.reduce((r,p,u)=>p.length!==t[u].length?Math.min(p.level,r):r,Number.MAX_VALUE);if(s===Number.MAX_VALUE||s===n)return c;const a=[];for(let r=0;r<t.length;r++){const{level:p,length:u}=d[r],C=Math.max(0,n+p-s),A=o.insertSpaces?" ".repeat(o.tabSize*C):"	".repeat(C);a.push(A+t[r].substring(u))}return a.join(`
`)}function Z(c,i){let e=0,t=0,o=0,n=0;const d=c.length;for(;o<d;){const s=c.charCodeAt(o);if(s===q.Space)e++,e===i&&(t++,e=0,n=o+1);else if(s===q.Tab)t++,e=0,n=o+1;else break;o++}return{level:t,length:n}}function Lt(){I(class extends b{constructor(){super({id:"workbench.action.chat.copyCodeBlock",title:f("interactive.copyCodeBlock.label","Copy"),f1:!1,category:k,icon:E.copy,menu:{id:y.ChatCodeBlock,group:"navigation",order:30}})}run(e,...t){const o=t[0];if(!U(o)||P(o))return;e.get(H).writeText(o.code),v(o.element)&&e.get(w).notifyUserAction({agentId:o.element.agent?.id,command:o.element.slashCommand?.name,sessionId:o.element.sessionId,requestId:o.element.requestId,result:o.element.result,action:{kind:"copy",codeBlockIndex:o.codeBlockIndex,copyKind:G.Toolbar,copiedCharacters:o.code.length,totalCharacters:o.code.length,copiedText:o.code}})}}),ue?.addImplementation(5e4,"chat-codeblock",i=>{const e=i.get(W).getFocusedCodeEditor();if(!e)return!1;const t=e.getModel();if(!t)return!1;const o=$(e,i);if(!o)return!1;const n=e.getSelections()?.length===1&&e.getSelection()?.isEmpty(),d=n?t.getValue():e.getSelections()?.reduce((p,u)=>p+t.getValueInRange(u),"")??"",s=t.getValueLength(),a=i.get(w),r=o.element;return r&&a.notifyUserAction({agentId:r.agent?.id,command:r.slashCommand?.name,sessionId:r.sessionId,requestId:r.requestId,result:r.result,action:{kind:"copy",codeBlockIndex:o.codeBlockIndex,copyKind:G.Action,copiedText:d,copiedCharacters:d.length,totalCharacters:s}}),n?(i.get(H).writeText(o.code),!0):!1}),I(class extends Q{constructor(){super({id:"workbench.action.chat.applyInEditor",title:f("interactive.applyInEditor.label","Apply in Editor"),precondition:S,f1:!0,category:k,icon:E.sparkle,menu:{id:y.ChatCodeBlock,group:"navigation",when:m.and(h,...L.map(e=>m.notEquals(B.languageId.key,e))),order:10},keybinding:{when:m.or(m.and(h,j.negate()),D),primary:l.CtrlCmd|g.Enter,mac:{primary:l.WinCtrl|g.Enter},weight:T.ExternalExtension+1}})}async computeEdits(e,t,o){const n=e.get(Ce),d=e.get(me),s=t.getModel(),a=e.get(le).mappedEditsProvider.ordered(s);if(a.length>0){const r=[],p=s.uri,u=s.getVersionId(),C=t.getSelections();C.length>0&&r.push([{uri:p,version:u,ranges:C}]);const A=Be(o);A&&r.push(A);const x=new V;try{const M=await n.withProgress({location:ge.Notification,delay:500,sticky:!0,cancellable:!0},async ee=>{for(const N of a){ee.report({message:K("applyCodeBlock.progress","Applying code block using {0}...",N.displayName)});const _=await N.provideMappedEdits(s,[o.code],{documents:r},x.token);if(_)return{edits:_.edits,codeMapper:N.displayName}}},()=>x.cancel());if(M)return M}catch(M){d.notify({severity:pe.Error,message:K("applyCodeBlock.error","Failed to apply code block: {0}",M.message)})}finally{x.dispose()}}return super.computeEdits(e,t,o)}get showPreview(){return!0}}),I(class extends Q{constructor(){super({id:"workbench.action.chat.insertCodeBlock",title:f("interactive.insertCodeBlock.label","Insert At Cursor"),precondition:S,f1:!0,category:k,icon:E.insert,menu:{id:y.ChatCodeBlock,group:"navigation",when:h,order:20},keybinding:{when:m.or(m.and(h,j.negate()),D),primary:l.CtrlCmd|g.Enter,mac:{primary:l.WinCtrl|g.Enter},weight:T.ExternalExtension+1}})}}),I(class extends O{constructor(){super({id:"workbench.action.chat.insertIntoNewFile",title:f("interactive.insertIntoNewFile.label","Insert into New File"),precondition:S,f1:!0,category:k,icon:E.newFile,menu:{id:y.ChatCodeBlock,group:"navigation",isHiddenByDefault:!0,order:40}})}async runWithContext(e,t){if(P(t))return;const o=e.get(F),n=e.get(w);o.openEditor({contents:t.code,languageId:t.languageId,resource:void 0}),v(t.element)&&n.notifyUserAction({agentId:t.element.agent?.id,command:t.element.slashCommand?.name,sessionId:t.element.sessionId,requestId:t.element.requestId,result:t.element.result,action:{kind:"insert",codeBlockIndex:t.codeBlockIndex,totalCharacters:t.code.length,newFile:!0,userAction:this.desc.id}})}}),I(class extends O{constructor(){super({id:"workbench.action.chat.runInTerminal",title:f("interactive.runInTerminal.label","Insert into Terminal"),precondition:S,f1:!0,category:k,icon:E.terminal,menu:[{id:y.ChatCodeBlock,group:"navigation",when:m.and(h,m.or(...L.map(e=>m.equals(B.languageId.key,e))))},{id:y.ChatCodeBlock,group:"navigation",isHiddenByDefault:!0,when:m.and(h,...L.map(e=>m.notEquals(B.languageId.key,e)))}],keybinding:[{primary:l.CtrlCmd|l.Alt|g.Enter,mac:{primary:l.WinCtrl|l.Alt|g.Enter},weight:T.EditorContrib,when:m.or(h,D)}]})}async runWithContext(e,t){if(P(t))return;const o=e.get(w),n=e.get(Se),d=e.get(F),s=e.get(Ee),a=e.get(Ae);let r=await n.getActiveOrCreateInstance();if(r=r.xterm?.isStdinDisabled||r.shellLaunchConfig.isFeatureTerminal?await n.createTerminal():r,n.setActiveInstance(r),await r.focusWhenReady(!0),r.target===fe.Editor){const u=d.findEditors(r.resource);s.openEditor(r,{viewColumn:u?.[0].groupId})}else a.showPanel(!0);r.runCommand(t.code,!1),v(t.element)&&o.notifyUserAction({agentId:t.element.agent?.id,command:t.element.slashCommand?.name,sessionId:t.element.sessionId,requestId:t.element.requestId,result:t.element.result,action:{kind:"runInTerminal",codeBlockIndex:t.codeBlockIndex,languageId:t.languageId}})}});function c(i,e){const t=i.get(W),n=i.get(Y).lastFocusedWidget;if(!n)return;const s=t.getFocusedCodeEditor()?.getModel()?.uri,a=s?n.getCodeBlockInfoForEditor(s):void 0,r=!n.inputEditor.hasWidgetFocus()&&n.getFocus(),p=v(r)?r:void 0,u=a?a.element:p??n.viewModel?.getItems().reverse().find(x=>v(x));if(!u||!v(u))return;n.reveal(u);const C=n.getCodeBlockInfosForResponse(u),A=a?(a.codeBlockIndex+(e?-1:1)+C.length)%C.length:e?C.length-1:0;C[A]?.focus()}I(class extends b{constructor(){super({id:"workbench.action.chat.nextCodeBlock",title:f("interactive.nextCodeBlock.label","Next Code Block"),keybinding:{primary:l.CtrlCmd|l.Alt|g.PageDown,mac:{primary:l.CtrlCmd|l.Alt|g.PageDown},weight:T.WorkbenchContrib,when:h},precondition:S,f1:!0,category:k})}run(e,...t){c(e)}}),I(class extends b{constructor(){super({id:"workbench.action.chat.previousCodeBlock",title:f("interactive.previousCodeBlock.label","Previous Code Block"),keybinding:{primary:l.CtrlCmd|l.Alt|g.PageUp,mac:{primary:l.CtrlCmd|l.Alt|g.PageUp},weight:T.WorkbenchContrib,when:h},precondition:S,f1:!0,category:k})}run(e,...t){c(e,!0)}})}function $(c,i){const e=i.get(Y),t=i.get(we),o=c.getModel();if(!o)return;const d=e.lastFocusedWidget?.getCodeBlockInfoForEditor(o.uri);if(!d){for(const s of t.providers){const a=s.getCodeBlockContext(c);if(a)return a}return}return{element:d.element,codeBlockIndex:d.codeBlockIndex,code:c.getValue(),languageId:c.getModel().getLanguageId()}}function _t(){class c extends b{run(e,...t){const o=t[0];if(xe(o))return this.runWithContext(e,o)}}I(class extends c{constructor(){super({id:"workbench.action.chat.applyCompareEdits",title:f("interactive.compare.apply","Apply Edits"),f1:!1,category:k,icon:E.check,precondition:m.and(B.hasChanges,X.negate()),menu:{id:y.ChatCompareBlock,group:"navigation",order:1}})}async runWithContext(e,t){const o=e.get(F);await e.get(z).createInstance(J).apply(t.element,t.edit,t.diffEditor),await o.openEditor({resource:t.edit.uri,options:{revealIfVisible:!0}})}}),I(class extends c{constructor(){super({id:"workbench.action.chat.discardCompareEdits",title:f("interactive.compare.discard","Discard Edits"),f1:!1,category:k,icon:E.trash,precondition:m.and(B.hasChanges,X.negate()),menu:{id:y.ChatCompareBlock,group:"navigation",order:2}})}async runWithContext(e,t){e.get(z).createInstance(J).discard(t.element,t.edit)}})}export{U as isCodeBlockActionContext,xe as isCodeCompareBlockActionContext,Lt as registerChatCodeBlockActions,_t as registerChatCodeCompareBlockActions};
