var $=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var H=(g,f,t,i)=>{for(var o=i>1?void 0:i?X(f,t):f,e=g.length-1,d;e>=0;e--)(d=g[e])&&(o=(i?d(f,t,o):d(o))||o);return i&&o&&$(f,t,o),o},h=(g,f)=>(t,i)=>f(t,i,g);import*as r from"../../../../base/browser/dom.js";import{DEFAULT_FONT_FAMILY as j}from"../../../../base/browser/fonts.js";import"../../../../base/browser/history.js";import{StandardKeyboardEvent as G}from"../../../../base/browser/keyboardEvent.js";import*as J from"../../../../base/browser/ui/aria/aria.js";import{Button as Q}from"../../../../base/browser/ui/button/button.js";import"../../../../base/common/actions.js";import{Codicon as L}from"../../../../base/common/codicons.js";import{Emitter as I}from"../../../../base/common/event.js";import{HistoryNavigator2 as M}from"../../../../base/common/history.js";import{KeyCode as N}from"../../../../base/common/keyCodes.js";import{Disposable as Y,DisposableStore as P}from"../../../../base/common/lifecycle.js";import{basename as Z,dirname as tt}from"../../../../base/common/path.js";import{isMacintosh as et}from"../../../../base/common/platform.js";import{URI as T}from"../../../../base/common/uri.js";import"../../../../editor/browser/config/editorConfiguration.js";import{EditorExtensionsRegistry as it}from"../../../../editor/browser/editorExtensions.js";import{CodeEditorWidget as ot}from"../../../../editor/browser/widget/codeEditor/codeEditorWidget.js";import"../../../../editor/common/core/dimension.js";import"../../../../editor/common/core/position.js";import{Range as nt}from"../../../../editor/common/core/range.js";import"../../../../editor/common/model.js";import{IModelService as rt}from"../../../../editor/common/services/model.js";import{ContentHoverController as st}from"../../../../editor/contrib/hover/browser/contentHoverController.js";import{GlyphHoverController as at}from"../../../../editor/contrib/hover/browser/glyphHoverController.js";import{localize as b}from"../../../../nls.js";import{IAccessibilityService as F}from"../../../../platform/accessibility/common/accessibility.js";import{DropdownWithPrimaryActionViewItem as ht}from"../../../../platform/actions/browser/dropdownWithPrimaryActionViewItem.js";import{createAndFillInActionBarActions as dt}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{HiddenItemStrategy as W,MenuWorkbenchToolBar as D}from"../../../../platform/actions/browser/toolbar.js";import{IMenuService as lt,MenuId as V,MenuItemAction as O}from"../../../../platform/actions/common/actions.js";import{IConfigurationService as ct}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as w}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as ut}from"../../../../platform/contextview/browser/contextView.js";import{FileKind as pt}from"../../../../platform/files/common/files.js";import{registerAndCreateHistoryNavigationContext as gt}from"../../../../platform/history/browser/contextScopedHistoryWidget.js";import{IInstantiationService as mt}from"../../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as ft}from"../../../../platform/instantiation/common/serviceCollection.js";import{IKeybindingService as B}from"../../../../platform/keybinding/common/keybinding.js";import{ILogService as yt}from"../../../../platform/log/common/log.js";import{INotificationService as Ct}from"../../../../platform/notification/common/notification.js";import{IThemeService as vt}from"../../../../platform/theme/common/themeService.js";import{ResourceLabels as bt}from"../../../browser/labels.js";import{AccessibilityVerbositySettingId as K}from"../../accessibility/browser/accessibilityConfiguration.js";import{AccessibilityCommandId as It}from"../../accessibility/common/accessibilityCommands.js";import{getSimpleCodeEditorWidgetOptions as Et,getSimpleEditorOptions as St,setupSimpleEditorSelectionStyling as _t}from"../../codeEditor/browser/simpleEditorOptions.js";import{ChatAgentLocation as xt,IChatAgentService as Ht}from"../common/chatAgents.js";import{CONTEXT_CHAT_INPUT_CURSOR_AT_TOP as Tt,CONTEXT_CHAT_INPUT_HAS_FOCUS as Dt,CONTEXT_CHAT_INPUT_HAS_TEXT as wt,CONTEXT_IN_CHAT_INPUT as At}from"../common/chatContextKeys.js";import"../common/chatModel.js";import"../common/chatService.js";import"../common/chatViewModel.js";import{IChatWidgetHistoryService as Lt}from"../common/chatWidgetHistoryService.js";import{CancelAction as Mt,ChatSubmitSecondaryAgentAction as Nt,SubmitAction as Pt}from"./actions/chatExecuteActions.js";import"./chat.js";import{ChatFollowups as Ft}from"./chatFollowups.js";const R=r.$,k=250;let E=class extends Y{constructor(t,i,o,e,d,l,u,p,c,m,C){super();this.location=t;this.options=i;this.getInputState=o;this.historyService=e;this.modelService=d;this.instantiationService=l;this.contextKeyService=u;this.configurationService=p;this.keybindingService=c;this.accessibilityService=m;this.logService=C;this.inputEditorMaxHeight=this.options.renderStyle==="compact"?k/3:k,this.inputEditorHasText=wt.bindTo(u),this.chatCursorAtTop=Tt.bindTo(u),this.inputEditorHasFocus=Dt.bindTo(u),this.history=this.loadHistory(),this._register(this.historyService.onDidClearHistory(()=>this.history=new M([{text:""}],50,U))),this._register(this.configurationService.onDidChangeConfiguration(a=>{a.affectsConfiguration(K.Chat)&&this.inputEditor.updateOptions({ariaLabel:this._getAriaLabel()})}))}static INPUT_SCHEME="chatSessionInput";static _counter=0;_onDidLoadInputState=this._register(new I);onDidLoadInputState=this._onDidLoadInputState.event;_onDidChangeHeight=this._register(new I);onDidChangeHeight=this._onDidChangeHeight.event;_onDidFocus=this._register(new I);onDidFocus=this._onDidFocus.event;_onDidBlur=this._register(new I);onDidBlur=this._onDidBlur.event;_onDidChangeContext=this._register(new I);onDidChangeContext=this._onDidChangeContext.event;_onDidAcceptFollowup=this._register(new I);onDidAcceptFollowup=this._onDidAcceptFollowup.event;get attachedContext(){return this._attachedContext}_indexOfLastAttachedContextDeletedWithKeyboard=-1;_attachedContext=new Set;_onDidChangeVisibility=this._register(new I);_contextResourceLabels=this.instantiationService.createInstance(bt,{onDidChangeVisibility:this._onDidChangeVisibility.event});inputEditorMaxHeight;inputEditorHeight=0;container;inputSideToolbarContainer;followupsContainer;followupsDisposables=this._register(new P);attachedContextContainer;attachedContextDisposables=this._register(new P);_inputPartHeight=0;get inputPartHeight(){return this._inputPartHeight}_inputEditor;_inputEditorElement;executeToolbar;inputActionsToolbar;get inputEditor(){return this._inputEditor}history;historyNavigationBackwardsEnablement;historyNavigationForewardsEnablement;inHistoryNavigation=!1;inputModel;inputEditorHasText;chatCursorAtTop;inputEditorHasFocus;cachedDimensions;cachedExecuteToolbarWidth;cachedInputToolbarWidth;inputUri=T.parse(`${E.INPUT_SCHEME}:input-${E._counter++}`);loadHistory(){const t=this.historyService.getHistory(this.location);return t.length===0&&t.push({text:""}),new M(t,50,U)}_getAriaLabel(){if(this.configurationService.getValue(K.Chat)){const i=this.keybindingService.lookupKeybinding(It.OpenAccessibilityHelp)?.getLabel();return i?b("actions.chat.accessibiltyHelp","Chat Input,  Type to ask questions or type / for topics, press enter to send out the request. Use {0} for Chat Accessibility Help.",i):b("chatInput.accessibilityHelpNoKb","Chat Input,  Type code here and press Enter to run. Use the Chat Accessibility Help command for more information.")}return b("chatInput","Chat Input")}updateState(t){if(this.inHistoryNavigation)return;const i={text:this._inputEditor.getValue(),state:t};this.history.isAtEnd()?this.history.replaceLast(i):(this.history.replaceLast(i),this.history.resetCursor())}initForNewChatModel(t,i){this.history=this.loadHistory(),this.history.add({text:t??this.history.current().text,state:i}),t&&this.setValue(t,!1)}logInputHistory(){const t=[...this.history].map(i=>JSON.stringify(i)).join(`
`);this.logService.info(`[${this.location}] Chat input history:`,t)}setVisible(t){this._onDidChangeVisibility.fire(t)}get element(){return this.container}showPreviousValue(){const t=this.getInputState();this.history.isAtEnd()?this.saveCurrentValue(t):this.history.has({text:this._inputEditor.getValue(),state:t})||(this.saveCurrentValue(t),this.history.resetCursor()),this.navigateHistory(!0)}showNextValue(){const t=this.getInputState();this.history.isAtEnd()||(this.history.has({text:this._inputEditor.getValue(),state:t})||(this.saveCurrentValue(t),this.history.resetCursor()),this.navigateHistory(!1))}navigateHistory(t){const i=t?this.history.previous():this.history.next();if(J.status(i.text),this.inHistoryNavigation=!0,this.setValue(i.text,!0),this.inHistoryNavigation=!1,this._onDidLoadInputState.fire(i.state),t)this._inputEditor.setPosition({lineNumber:1,column:1});else{const o=this._inputEditor.getModel();if(!o)return;this._inputEditor.setPosition(z(o))}}setValue(t,i){this.inputEditor.setValue(t),this.inputEditor.setPosition({lineNumber:1,column:t.length+1}),i||this.saveCurrentValue(this.getInputState())}saveCurrentValue(t){const i={text:this._inputEditor.getValue(),state:t};this.history.replaceLast(i)}focus(){this._inputEditor.focus()}hasFocus(){return this._inputEditor.hasWidgetFocus()}async acceptInput(t){if(t){const o={text:this._inputEditor.getValue(),state:this.getInputState()};this.history.replaceLast(o),this.history.add({text:""})}this._attachedContext.clear(),this._onDidLoadInputState.fire({}),this.accessibilityService.isScreenReaderOptimized()&&et?this._acceptInputForVoiceover():(this._inputEditor.focus(),this._inputEditor.setValue(""))}_acceptInputForVoiceover(){const t=this._inputEditor.getDomNode();t&&(t.remove(),this._inputEditor.setValue(""),this._inputEditorElement.appendChild(t),this._inputEditor.focus())}attachContext(t,...i){const o=[];if(t&&(o.push(...Array.from(this._attachedContext)),this._attachedContext.clear()),i.length>0)for(const e of i)this._attachedContext.add(e);(o.length>0||i.length>0)&&(this.initAttachedContext(this.attachedContextContainer),t||this._onDidChangeContext.fire({removed:o,added:i}))}render(t,i,o){let e;this.options.renderStyle==="compact"?e=r.h(".interactive-input-part",[r.h(".interactive-input-and-side-toolbar@inputAndSideToolbar",[r.h(".chat-input-container@inputContainer",[r.h(".chat-editor-container@editorContainer"),r.h(".chat-input-toolbars@inputToolbars")])]),r.h(".chat-attached-context@attachedContextContainer"),r.h(".interactive-input-followups@followupsContainer")]):e=r.h(".interactive-input-part",[r.h(".interactive-input-followups@followupsContainer"),r.h(".interactive-input-and-side-toolbar@inputAndSideToolbar",[r.h(".chat-input-container@inputContainer",[r.h(".chat-editor-container@editorContainer"),r.h(".chat-attached-context@attachedContextContainer"),r.h(".chat-input-toolbars@inputToolbars")])])]),this.container=e.root,t.append(this.container),this.container.classList.toggle("compact",this.options.renderStyle==="compact"),this.followupsContainer=e.followupsContainer;const d=e.inputAndSideToolbar,l=e.inputContainer,u=e.editorContainer;this.attachedContextContainer=e.attachedContextContainer;const p=e.inputToolbars;this.initAttachedContext(this.attachedContextContainer);const c=this._register(this.contextKeyService.createScoped(l));At.bindTo(c).set(!0);const m=this._register(this.instantiationService.createChild(new ft([w,c]))),{historyNavigationBackwardsEnablement:C,historyNavigationForwardsEnablement:a}=this._register(gt(c,this));this.historyNavigationBackwardsEnablement=C,this.historyNavigationForewardsEnablement=a;const n=St(this.configurationService);n.overflowWidgetsDomNode=this.options.editorOverflowWidgetsDomNode,n.readOnly=!1,n.ariaLabel=this._getAriaLabel(),n.fontFamily=j,n.fontSize=13,n.lineHeight=20,n.padding=this.options.renderStyle==="compact"?{top:2,bottom:2}:{top:8,bottom:8},n.cursorWidth=1,n.wrappingStrategy="advanced",n.bracketPairColorization={enabled:!1},n.suggest={showIcons:!1,showSnippets:!1,showWords:!0,showStatusBar:!1,insertMode:"replace"},n.scrollbar={...n.scrollbar??{},vertical:"hidden"},n.stickyScroll={enabled:!1},this._inputEditorElement=r.append(u,R(q));const y=Et();if(y.contributions?.push(...it.getSomeEditorContributions([st.ID,at.ID])),this._inputEditor=this._register(m.createInstance(ot,this._inputEditorElement,n,y)),this._register(this._inputEditor.onDidChangeModelContent(()=>{const s=Math.min(this._inputEditor.getContentHeight(),this.inputEditorMaxHeight);s!==this.inputEditorHeight&&(this.inputEditorHeight=s,this._onDidChangeHeight.fire());const v=this._inputEditor.getModel(),_=!!v&&v.getValue().trim().length>0;this.inputEditorHasText.set(_)})),this._register(this._inputEditor.onDidFocusEditorText(()=>{this.inputEditorHasFocus.set(!0),this._onDidFocus.fire(),l.classList.toggle("focused",!0)})),this._register(this._inputEditor.onDidBlurEditorText(()=>{this.inputEditorHasFocus.set(!1),l.classList.toggle("focused",!1),this._onDidBlur.fire()})),this._register(r.addStandardDisposableListener(p,r.EventType.CLICK,s=>this.inputEditor.focus())),this.inputActionsToolbar=this._register(this.instantiationService.createInstance(D,p,V.ChatInput,{telemetrySource:this.options.menus.telemetrySource,menuOptions:{shouldForwardArgs:!0},hiddenItemStrategy:W.Ignore})),this.inputActionsToolbar.context={widget:o},this._register(this.inputActionsToolbar.onDidChangeMenuItems(()=>{this.cachedDimensions&&typeof this.cachedInputToolbarWidth=="number"&&this.cachedInputToolbarWidth!==this.inputActionsToolbar.getItemsWidth()&&this.layout(this.cachedDimensions.height,this.cachedDimensions.width)})),this.executeToolbar=this._register(this.instantiationService.createInstance(D,p,this.options.menus.executeToolbar,{telemetrySource:this.options.menus.telemetrySource,menuOptions:{shouldForwardArgs:!0},hiddenItemStrategy:W.Ignore,actionViewItemProvider:(s,v)=>{if(this.location===xt.Panel&&(s.id===Pt.ID||s.id===Mt.ID)&&s instanceof O){const _=this.instantiationService.createInstance(O,{id:"chat.moreExecuteActions",title:b("notebook.moreExecuteActionsLabel","More..."),icon:L.chevronDown},void 0,void 0,void 0,void 0);return this.instantiationService.createInstance(x,s,_)}}})),this.executeToolbar.context={widget:o},this._register(this.executeToolbar.onDidChangeMenuItems(()=>{this.cachedDimensions&&typeof this.cachedExecuteToolbarWidth=="number"&&this.cachedExecuteToolbarWidth!==this.executeToolbar.getItemsWidth()&&this.layout(this.cachedDimensions.height,this.cachedDimensions.width)})),this.options.menus.inputSideToolbar){const s=this._register(this.instantiationService.createInstance(D,d,this.options.menus.inputSideToolbar,{telemetrySource:this.options.menus.telemetrySource,menuOptions:{shouldForwardArgs:!0}}));this.inputSideToolbarContainer=s.getElement(),s.getElement().classList.add("chat-side-toolbar"),s.context={widget:o}}let S=this.modelService.getModel(this.inputUri);if(S||(S=this.modelService.createModel("",null,this.inputUri,!0),this._register(S)),this.inputModel=S,this.inputModel.updateOptions({bracketColorizationOptions:{enabled:!1,independentColorPoolPerBracketType:!1}}),this._inputEditor.setModel(this.inputModel),i){this.inputModel.setValue(i);const s=this.inputModel.getLineCount();this._inputEditor.setPosition({lineNumber:s,column:this.inputModel.getLineMaxColumn(s)})}const A=()=>{const s=this._inputEditor.getModel();if(!s)return;const v=this._inputEditor.getPosition();if(!v)return;const _=v.column===1&&v.lineNumber===1;this.chatCursorAtTop.set(_),this.historyNavigationBackwardsEnablement.set(_),this.historyNavigationForewardsEnablement.set(v.equals(z(s)))};this._register(this._inputEditor.onDidChangeCursorPosition(s=>A())),A()}initAttachedContext(t,i=!1){const o=t.offsetHeight;r.clearNode(t),this.attachedContextDisposables.clear(),r.setVisibility(!!this.attachedContext.size,this.attachedContextContainer),this.attachedContext.size||(this._indexOfLastAttachedContextDeletedWithKeyboard=-1),[...this.attachedContext.values()].forEach((e,d)=>{const l=r.append(t,R(".chat-attached-context-attachment.show-file-icons")),u=this._contextResourceLabels.create(l,{supportIcons:!0}),p=T.isUri(e.value)?e.value:e.value&&typeof e.value=="object"&&"uri"in e.value&&T.isUri(e.value.uri)?e.value.uri:void 0,c=e.value&&typeof e.value=="object"&&"range"in e.value&&nt.isIRange(e.value.range)?e.value.range:void 0;if(p&&e.isFile){const a=Z(p.path),n=tt(p.path),y=`${a} ${n}`,S=c?b("chat.fileAttachmentWithRange","Attached file, {0}, line {1} to line {2}",y,c.startLineNumber,c.endLineNumber):b("chat.fileAttachment","Attached file, {0}",y);u.setFile(p,{fileKind:pt.FILE,hidePath:!0,range:c}),l.ariaLabel=S,l.tabIndex=0}else{const a=e.fullName??e.name,n=e.icon?.id?`$(${e.icon.id}) ${a}`:a;u.setLabel(n,void 0),l.ariaLabel=b("chat.attachment","Attached context, {0}",e.name),l.tabIndex=0}const m=new Q(l,{supportIcons:!0});d===Math.min(this._indexOfLastAttachedContextDeletedWithKeyboard,this.attachedContext.size-1)&&m.focus(),this.attachedContextDisposables.add(m),m.icon=L.close;const C=m.onDidClick(a=>{if(this._attachedContext.delete(e),C.dispose(),r.isKeyboardEvent(a)){const n=new G(a);(n.equals(N.Enter)||n.equals(N.Space))&&(this._indexOfLastAttachedContextDeletedWithKeyboard=d)}this._onDidChangeHeight.fire(),this._onDidChangeContext.fire({removed:[e]})});this.attachedContextDisposables.add(C)}),o!==t.offsetHeight&&!i&&this._onDidChangeHeight.fire()}async renderFollowups(t,i){this.options.renderFollowups&&(this.followupsDisposables.clear(),r.clearNode(this.followupsContainer),t&&t.length>0&&this.followupsDisposables.add(this.instantiationService.createInstance(Ft,this.followupsContainer,t,this.location,void 0,o=>this._onDidAcceptFollowup.fire({followup:o,response:i}))),this._onDidChangeHeight.fire())}get contentHeight(){const t=this.getLayoutData();return t.followupsHeight+t.inputPartEditorHeight+t.inputPartVerticalPadding+t.inputEditorBorder+t.attachmentsHeight+t.toolbarsHeight}layout(t,i){return this.cachedDimensions=new r.Dimension(i,t),this._layout(t,i)}previousInputEditorDimension;_layout(t,i,o=!0){this.initAttachedContext(this.attachedContextContainer,!0);const e=this.getLayoutData(),d=Math.min(e.inputPartEditorHeight,t-e.followupsHeight-e.attachmentsHeight-e.inputPartVerticalPadding-e.toolbarsHeight),l=i-e.inputPartHorizontalPadding;this.followupsContainer.style.width=`${l}px`,this._inputPartHeight=e.inputPartVerticalPadding+e.followupsHeight+d+e.inputEditorBorder+e.attachmentsHeight+e.toolbarsHeight;const u=this._inputEditor.getScrollWidth(),c={width:i-e.inputPartHorizontalPadding-e.editorBorder-e.inputPartHorizontalPaddingInside-e.toolbarsWidth-e.sideToolbarWidth,height:d};if((!this.previousInputEditorDimension||this.previousInputEditorDimension.width!==c.width||this.previousInputEditorDimension.height!==c.height)&&(this._inputEditor.layout(c),this.previousInputEditorDimension=c),o&&u<10)return this._layout(t,i,!1)}getLayoutData(){const t=this.cachedExecuteToolbarWidth=this.executeToolbar.getItemsWidth(),i=this.cachedInputToolbarWidth=this.inputActionsToolbar.getItemsWidth(),o=(this.executeToolbar.getItemsLength()-1)*4,e=(this.inputActionsToolbar.getItemsLength()-1)*4;return{inputEditorBorder:2,followupsHeight:this.followupsContainer.offsetHeight,inputPartEditorHeight:Math.min(this._inputEditor.getContentHeight(),this.inputEditorMaxHeight),inputPartHorizontalPadding:this.options.renderStyle==="compact"?12:32,inputPartVerticalPadding:this.options.renderStyle==="compact"?12:30,attachmentsHeight:this.attachedContextContainer.offsetHeight,editorBorder:2,inputPartHorizontalPaddingInside:12,toolbarsWidth:this.options.renderStyle==="compact"?t+o+i+e:0,toolbarsHeight:this.options.renderStyle==="compact"?0:22,sideToolbarWidth:this.inputSideToolbarContainer?r.getTotalWidth(this.inputSideToolbarContainer)+4:0}}saveState(){this.saveCurrentValue(this.getInputState());const t=[...this.history];this.historyService.saveHistory(this.location,t)}};E=H([h(3,Lt),h(4,rt),h(5,mt),h(6,w),h(7,ct),h(8,B),h(9,F),h(10,yt)],E);const U=g=>JSON.stringify(g);function z(g){return{lineNumber:g.getLineCount(),column:g.getLineLength(g.getLineCount())+1}}let x=class extends ht{constructor(f,t,i,o,e,d,l,u,p,c){super(f,t,[],"",o,{getKeyBinding:a=>l.lookupKeybinding(a.id,d)},l,u,d,p,c);const m=i.createMenu(V.ChatExecuteSecondary,d),C=()=>{const a=[];dt(m,{shouldForwardArgs:!0},a);const n=e.getSecondaryAgent();n&&a.forEach(y=>(y.id===Nt.ID&&(y.label=b("chat.submitToSecondaryAgent","Send to @{0}",n.name)),y)),this.update(t,a)};C(),this._register(m.onDidChange(()=>C()))}};x=H([h(2,lt),h(3,ut),h(4,Ht),h(5,w),h(6,B),h(7,Ct),h(8,vt),h(9,F)],x);const q=".interactive-input-editor";_t(q);export{E as ChatInputPart};
