var rt=Object.defineProperty;var at=Object.getOwnPropertyDescriptor;var A=(C,E,t,o)=>{for(var i=o>1?void 0:o?at(E,t):E,e=C.length-1,n;e>=0;e--)(n=C[e])&&(i=(o?n(E,t,i):n(i))||i);return o&&i&&rt(E,t,i),i},d=(C,E)=>(t,o)=>E(t,o,C);import*as s from"../../../../base/browser/dom.js";import{DEFAULT_FONT_FAMILY as dt}from"../../../../base/browser/fonts.js";import"../../../../base/browser/history.js";import{StandardKeyboardEvent as R}from"../../../../base/browser/keyboardEvent.js";import*as lt from"../../../../base/browser/ui/aria/aria.js";import{Button as W}from"../../../../base/browser/ui/button/button.js";import"../../../../base/browser/ui/hover/hover.js";import"../../../../base/browser/ui/hover/hoverDelegate.js";import{createInstantHoverDelegate as K}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import{renderLabelWithIcons as ht}from"../../../../base/browser/ui/iconLabel/iconLabels.js";import{ProgressBar as ct}from"../../../../base/browser/ui/progressbar/progressbar.js";import"../../../../base/common/actions.js";import{Codicon as V}from"../../../../base/common/codicons.js";import{Emitter as S}from"../../../../base/common/event.js";import{HistoryNavigator2 as $}from"../../../../base/common/history.js";import{KeyCode as T}from"../../../../base/common/keyCodes.js";import{Disposable as ut,DisposableStore as P,MutableDisposable as pt}from"../../../../base/common/lifecycle.js";import{basename as gt,dirname as mt}from"../../../../base/common/path.js";import{isMacintosh as ft}from"../../../../base/common/platform.js";import{URI as _}from"../../../../base/common/uri.js";import"../../../../editor/browser/config/editorConfiguration.js";import{EditorExtensionsRegistry as vt}from"../../../../editor/browser/editorExtensions.js";import{CodeEditorWidget as Ct}from"../../../../editor/browser/widget/codeEditor/codeEditorWidget.js";import{EditorOptions as bt}from"../../../../editor/common/config/editorOptions.js";import"../../../../editor/common/core/dimension.js";import"../../../../editor/common/core/position.js";import{Range as yt}from"../../../../editor/common/core/range.js";import"../../../../editor/common/model.js";import{IModelService as Et}from"../../../../editor/common/services/model.js";import{CopyPasteController as It}from"../../../../editor/contrib/dropOrPasteInto/browser/copyPasteController.js";import{ContentHoverController as St}from"../../../../editor/contrib/hover/browser/contentHoverController.js";import{GlyphHoverController as _t}from"../../../../editor/contrib/hover/browser/glyphHoverController.js";import{SuggestController as Lt}from"../../../../editor/contrib/suggest/browser/suggestController.js";import{localize as b}from"../../../../nls.js";import{IAccessibilityService as N}from"../../../../platform/accessibility/common/accessibility.js";import{DropdownWithPrimaryActionViewItem as Mt}from"../../../../platform/actions/browser/dropdownWithPrimaryActionViewItem.js";import{createAndFillInActionBarActions as Dt,MenuEntryActionViewItem as xt}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{HiddenItemStrategy as q,MenuWorkbenchToolBar as O}from"../../../../platform/actions/browser/toolbar.js";import{IMenuService as Ht,MenuId as B,MenuItemAction as U}from"../../../../platform/actions/common/actions.js";import{ICommandService as wt}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as At}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as F}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as z}from"../../../../platform/contextview/browser/contextView.js";import{FileKind as Tt,IFileService as Pt}from"../../../../platform/files/common/files.js";import{registerAndCreateHistoryNavigationContext as Ft}from"../../../../platform/history/browser/contextScopedHistoryWidget.js";import{IHoverService as Wt}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as Vt}from"../../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as Nt}from"../../../../platform/instantiation/common/serviceCollection.js";import{IKeybindingService as k}from"../../../../platform/keybinding/common/keybinding.js";import"../../../../platform/list/browser/listService.js";import{ILogService as Ot}from"../../../../platform/log/common/log.js";import{INotificationService as j}from"../../../../platform/notification/common/notification.js";import{IThemeService as X}from"../../../../platform/theme/common/themeService.js";import{ResourceLabels as Bt}from"../../../browser/labels.js";import{IEditorService as Ut}from"../../../services/editor/common/editorService.js";import{AccessibilityVerbositySettingId as G}from"../../accessibility/browser/accessibilityConfiguration.js";import{AccessibilityCommandId as kt}from"../../accessibility/common/accessibilityCommands.js";import{getSimpleCodeEditorWidgetOptions as Rt,getSimpleEditorOptions as Kt,setupSimpleEditorSelectionStyling as $t}from"../../codeEditor/browser/simpleEditorOptions.js";import{ChatAgentLocation as qt,IChatAgentService as zt}from"../common/chatAgents.js";import{CONTEXT_CHAT_INPUT_CURSOR_AT_TOP as jt,CONTEXT_CHAT_INPUT_HAS_FOCUS as Xt,CONTEXT_CHAT_INPUT_HAS_TEXT as Gt,CONTEXT_IN_CHAT_INPUT as Jt}from"../common/chatContextKeys.js";import{ChatEditingSessionState as J,ModifiedFileEntryState as Qt}from"../common/chatEditingService.js";import"../common/chatModel.js";import"../common/chatService.js";import"../common/chatViewModel.js";import{IChatWidgetHistoryService as Yt}from"../common/chatWidgetHistoryService.js";import{ILanguageModelsService as Q}from"../common/languageModels.js";import{CancelAction as Zt,ChatModelPickerActionId as te,ChatSubmitSecondaryAgentAction as ee,SubmitAction as ie}from"./actions/chatExecuteActions.js";import"./chat.js";import"./chatContentParts/chatCollections.js";import{CollapsibleListPool as oe}from"./chatContentParts/chatReferencesContentPart.js";import{ChatEditingAcceptAllAction as Y,ChatEditingDiscardAllAction as Z,ChatEditingShowChangesAction as tt}from"./chatEditingService.js";import{ChatFollowups as ne}from"./chatFollowups.js";import"./chatWidget.js";const D=s.$,et=250;let M=class extends ut{constructor(t,o,i,e,n,c,a,u,l,h,g,m,r,f,v,L){super();this.location=t;this.options=o;this.getInputState=i;this.historyService=e;this.modelService=n;this.instantiationService=c;this.contextKeyService=a;this.configurationService=u;this.keybindingService=l;this.accessibilityService=h;this.languageModelsService=g;this.logService=m;this.hoverService=r;this.fileService=f;this.commandService=v;this.editorService=L;this.inputEditorMaxHeight=this.options.renderStyle==="compact"?et/3:et,this.inputEditorHasText=Gt.bindTo(a),this.chatCursorAtTop=jt.bindTo(a),this.inputEditorHasFocus=Xt.bindTo(a),this.history=this.loadHistory(),this._register(this.historyService.onDidClearHistory(()=>this.history=new $([{text:""}],50,it))),this._register(this.configurationService.onDidChangeConfiguration(w=>{w.affectsConfiguration(G.Chat)&&this.inputEditor.updateOptions({ariaLabel:this._getAriaLabel()})})),this._chatEditsListPool=this._register(this.instantiationService.createInstance(oe,this._onDidChangeVisibility.event,B.ChatEditingSessionWidgetToolbar,{enableFileDecorations:!0}))}static INPUT_SCHEME="chatSessionInput";static _counter=0;_onDidLoadInputState=this._register(new S);onDidLoadInputState=this._onDidLoadInputState.event;_onDidChangeHeight=this._register(new S);onDidChangeHeight=this._onDidChangeHeight.event;_onDidFocus=this._register(new S);onDidFocus=this._onDidFocus.event;_onDidBlur=this._register(new S);onDidBlur=this._onDidBlur.event;_onDidChangeContext=this._register(new S);onDidChangeContext=this._onDidChangeContext.event;_onDidAcceptFollowup=this._register(new S);onDidAcceptFollowup=this._onDidAcceptFollowup.event;get attachedContext(){return this._attachedContext}_indexOfLastAttachedContextDeletedWithKeyboard=-1;_attachedContext=new Set;_onDidChangeVisibility=this._register(new S);_contextResourceLabels=this.instantiationService.createInstance(Bt,{onDidChangeVisibility:this._onDidChangeVisibility.event});inputEditorMaxHeight;inputEditorHeight=0;container;inputSideToolbarContainer;followupsContainer;followupsDisposables=this._register(new P);attachedContextContainer;attachedContextDisposables=this._register(new P);chatEditingSessionWidgetContainer;_inputPartHeight=0;get inputPartHeight(){return this._inputPartHeight}_followupsHeight=0;get followupsHeight(){return this._followupsHeight}_inputEditor;_inputEditorElement;executeToolbar;inputActionsToolbar;get inputEditor(){return this._inputEditor}history;historyNavigationBackwardsEnablement;historyNavigationForewardsEnablement;inHistoryNavigation=!1;inputModel;inputEditorHasText;chatCursorAtTop;inputEditorHasFocus;_waitForPersistedLanguageModel=this._register(new pt);_onDidChangeCurrentLanguageModel=new S;_currentLanguageModel;get currentLanguageModel(){return this._currentLanguageModel}cachedDimensions;cachedExecuteToolbarWidth;cachedInputToolbarWidth;inputUri=_.parse(`${M.INPUT_SCHEME}:input-${M._counter++}`);_chatEditsActionsDisposables=this._register(new P);_chatEditsDisposables=this._register(new P);_chatEditsProgress;_chatEditsListPool;_chatEditList;get selectedElements(){const t=[],i=this._chatEditList?.object?.getSelectedElements()??[];for(const e of i)e.kind==="reference"&&_.isUri(e.reference)&&t.push(e.reference);return t}setCurrentLanguageModelToDefault(){const t=this.languageModelsService.getLanguageModelIds().find(i=>this.languageModelsService.lookupLanguageModel(i)?.isDefault),o=this.languageModelsService.getLanguageModelIds().find(i=>{const e=this.languageModelsService.lookupLanguageModel(i);return e?.isUserSelectable&&!e.isDefault});this._currentLanguageModel=o?t:void 0}setCurrentLanguageModelByUser(t){this._currentLanguageModel=t,this._waitForPersistedLanguageModel.clear(),this.cachedDimensions&&this.layout(this.cachedDimensions.height,this.cachedDimensions.width)}loadHistory(){const t=this.historyService.getHistory(this.location);return t.length===0&&t.push({text:""}),new $(t,50,it)}_getAriaLabel(){if(this.configurationService.getValue(G.Chat)){const o=this.keybindingService.lookupKeybinding(kt.OpenAccessibilityHelp)?.getLabel();return o?b("actions.chat.accessibiltyHelp","Chat Input,  Type to ask questions or type / for topics, press enter to send out the request. Use {0} for Chat Accessibility Help.",o):b("chatInput.accessibilityHelpNoKb","Chat Input,  Type code here and press Enter to run. Use the Chat Accessibility Help command for more information.")}return b("chatInput","Chat Input")}updateState(t){if(this.inHistoryNavigation)return;const o={text:this._inputEditor.getValue(),state:t};this.history.isAtEnd()?this.history.replaceLast(o):(this.history.replaceLast(o),this.history.resetCursor())}initForNewChatModel(t){this.history=this.loadHistory(),this.history.add({text:t.inputValue??this.history.current().text,state:t.inputState??this.getInputState()}),t.inputValue&&this.setValue(t.inputValue,!1),t.selectedLanguageModelId&&(this.languageModelsService.lookupLanguageModel(t.selectedLanguageModelId)?(this._currentLanguageModel=t.selectedLanguageModelId,this._onDidChangeCurrentLanguageModel.fire(this._currentLanguageModel)):this._waitForPersistedLanguageModel.value=this.languageModelsService.onDidChangeLanguageModels(i=>{const e=i.added?.find(n=>n.identifier===t.selectedLanguageModelId);e&&(this._waitForPersistedLanguageModel.clear(),e.metadata.isUserSelectable&&(this._currentLanguageModel=t.selectedLanguageModelId,this._onDidChangeCurrentLanguageModel.fire(this._currentLanguageModel)))}))}logInputHistory(){const t=[...this.history].map(o=>JSON.stringify(o)).join(`
`);this.logService.info(`[${this.location}] Chat input history:`,t)}setVisible(t){this._onDidChangeVisibility.fire(t)}get element(){return this.container}showPreviousValue(){const t=this.getInputState();this.history.isAtEnd()?this.saveCurrentValue(t):this.history.has({text:this._inputEditor.getValue(),state:t})||(this.saveCurrentValue(t),this.history.resetCursor()),this.navigateHistory(!0)}showNextValue(){const t=this.getInputState();this.history.isAtEnd()||(this.history.has({text:this._inputEditor.getValue(),state:t})||(this.saveCurrentValue(t),this.history.resetCursor()),this.navigateHistory(!1))}navigateHistory(t){const o=t?this.history.previous():this.history.next();lt.status(o.text),this.inHistoryNavigation=!0,this.setValue(o.text,!0),this.inHistoryNavigation=!1,this._onDidLoadInputState.fire(o.state);const i=this._inputEditor.getModel();if(i)if(t){const e=this._inputEditor._getViewModel()?.getLineLength(1)??1,n=i.getLineLength(1);e===n?this._inputEditor.setPosition({lineNumber:1,column:e+1}):this._inputEditor.setPosition({lineNumber:1,column:e})}else this._inputEditor.setPosition(ot(i))}setValue(t,o){this.inputEditor.setValue(t),this.inputEditor.setPosition({lineNumber:1,column:t.length+1}),o||this.saveCurrentValue(this.getInputState())}saveCurrentValue(t){const o={text:this._inputEditor.getValue(),state:t};this.history.replaceLast(o)}focus(){this._inputEditor.focus()}hasFocus(){return this._inputEditor.hasWidgetFocus()}async acceptInput(t){if(t){const i={text:this._inputEditor.getValue(),state:this.getInputState()};this.history.replaceLast(i),this.history.add({text:""})}this._attachedContext.clear(),this._onDidLoadInputState.fire({}),this.accessibilityService.isScreenReaderOptimized()&&ft?this._acceptInputForVoiceover():(this._inputEditor.focus(),this._inputEditor.setValue(""))}_acceptInputForVoiceover(){const t=this._inputEditor.getDomNode();t&&(t.remove(),this._inputEditor.setValue(""),this._inputEditorElement.appendChild(t),this._inputEditor.focus())}attachContext(t,...o){const i=[];if(t&&(i.push(...Array.from(this._attachedContext)),this._attachedContext.clear()),o.length>0)for(const e of o)this._attachedContext.add(e);(i.length>0||o.length>0)&&(this.initAttachedContext(this.attachedContextContainer),t||this._onDidChangeContext.fire({removed:i,added:o}))}render(t,o,i){let e;this.options.renderStyle==="compact"?e=s.h(".interactive-input-part",[s.h(".interactive-input-and-edit-session",[s.h(".chat-editing-session@chatEditingSessionWidgetContainer"),s.h(".interactive-input-and-side-toolbar@inputAndSideToolbar",[s.h(".chat-input-container@inputContainer",[s.h(".chat-editor-container@editorContainer"),s.h(".chat-input-toolbars@inputToolbars")])]),s.h(".chat-attached-context@attachedContextContainer"),s.h(".interactive-input-followups@followupsContainer")])]):e=s.h(".interactive-input-part",[s.h(".interactive-input-followups@followupsContainer"),s.h(".chat-editing-session@chatEditingSessionWidgetContainer"),s.h(".interactive-input-and-side-toolbar@inputAndSideToolbar",[s.h(".chat-input-container@inputContainer",[s.h(".chat-editor-container@editorContainer"),s.h(".chat-attached-context@attachedContextContainer"),s.h(".chat-input-toolbars@inputToolbars")])])]),this.container=e.root,t.append(this.container),this.container.classList.toggle("compact",this.options.renderStyle==="compact"),this.followupsContainer=e.followupsContainer;const n=e.inputAndSideToolbar,c=e.inputContainer,a=e.editorContainer;this.attachedContextContainer=e.attachedContextContainer;const u=e.inputToolbars;this.chatEditingSessionWidgetContainer=e.chatEditingSessionWidgetContainer,this.initAttachedContext(this.attachedContextContainer),this.renderChatEditingSessionState(null);const l=this._register(this.contextKeyService.createScoped(c));Jt.bindTo(l).set(!0);const h=this._register(this.instantiationService.createChild(new Nt([F,l]))),{historyNavigationBackwardsEnablement:g,historyNavigationForwardsEnablement:m}=this._register(Ft(l,this));this.historyNavigationBackwardsEnablement=g,this.historyNavigationForewardsEnablement=m;const r=Kt(this.configurationService);r.overflowWidgetsDomNode=this.options.editorOverflowWidgetsDomNode,r.pasteAs=bt.pasteAs.defaultValue,r.readOnly=!1,r.ariaLabel=this._getAriaLabel(),r.fontFamily=dt,r.fontSize=13,r.lineHeight=20,r.padding=this.options.renderStyle==="compact"?{top:2,bottom:2}:{top:8,bottom:8},r.cursorWidth=1,r.wrappingStrategy="advanced",r.bracketPairColorization={enabled:!1},r.suggest={showIcons:!1,showSnippets:!1,showWords:!0,showStatusBar:!1,insertMode:"replace"},r.scrollbar={...r.scrollbar??{},vertical:"hidden"},r.stickyScroll={enabled:!1},this._inputEditorElement=s.append(a,D(nt));const f=Rt();f.contributions?.push(...vt.getSomeEditorContributions([St.ID,_t.ID,It.ID])),this._inputEditor=this._register(h.createInstance(Ct,this._inputEditorElement,r,f)),Lt.get(this._inputEditor)?.forceRenderingAbove(),this._register(this._inputEditor.onDidChangeModelContent(()=>{const p=Math.min(this._inputEditor.getContentHeight(),this.inputEditorMaxHeight);p!==this.inputEditorHeight&&(this.inputEditorHeight=p,this._onDidChangeHeight.fire());const y=this._inputEditor.getModel(),I=!!y&&y.getValue().trim().length>0;this.inputEditorHasText.set(I)})),this._register(this._inputEditor.onDidFocusEditorText(()=>{this.inputEditorHasFocus.set(!0),this._onDidFocus.fire(),c.classList.toggle("focused",!0)})),this._register(this._inputEditor.onDidBlurEditorText(()=>{this.inputEditorHasFocus.set(!1),c.classList.toggle("focused",!1),this._onDidBlur.fire()}));const v=this._register(K());if(this._register(s.addStandardDisposableListener(u,s.EventType.CLICK,p=>this.inputEditor.focus())),this.inputActionsToolbar=this._register(this.instantiationService.createInstance(O,u,B.ChatInput,{telemetrySource:this.options.menus.telemetrySource,menuOptions:{shouldForwardArgs:!0},hiddenItemStrategy:q.Ignore,hoverDelegate:v})),this.inputActionsToolbar.context={widget:i},this._register(this.inputActionsToolbar.onDidChangeMenuItems(()=>{this.cachedDimensions&&typeof this.cachedInputToolbarWidth=="number"&&this.cachedInputToolbarWidth!==this.inputActionsToolbar.getItemsWidth()&&this.layout(this.cachedDimensions.height,this.cachedDimensions.width)})),this.executeToolbar=this._register(this.instantiationService.createInstance(O,u,this.options.menus.executeToolbar,{telemetrySource:this.options.menus.telemetrySource,menuOptions:{shouldForwardArgs:!0},hoverDelegate:v,hiddenItemStrategy:q.Ignore,actionViewItemProvider:(p,y)=>{if(this.location===qt.Panel&&(p.id===ie.ID||p.id===Zt.ID)&&p instanceof U){const I=this.instantiationService.createInstance(U,{id:"chat.moreExecuteActions",title:b("notebook.moreExecuteActionsLabel","More..."),icon:V.chevronDown},void 0,void 0,void 0,void 0);return this.instantiationService.createInstance(x,p,I,y)}if(p.id===te&&p instanceof U&&(this._currentLanguageModel||this.setCurrentLanguageModelToDefault(),this._currentLanguageModel)){const I={onDidChangeModel:this._onDidChangeCurrentLanguageModel.event,setModel:st=>{this.setCurrentLanguageModelByUser(st)}};return this.instantiationService.createInstance(H,p,this._currentLanguageModel,I,{hoverDelegate:y.hoverDelegate,keybinding:y.keybinding??void 0})}}})),this.executeToolbar.context={widget:i},this._register(this.executeToolbar.onDidChangeMenuItems(()=>{this.cachedDimensions&&typeof this.cachedExecuteToolbarWidth=="number"&&this.cachedExecuteToolbarWidth!==this.executeToolbar.getItemsWidth()&&this.layout(this.cachedDimensions.height,this.cachedDimensions.width)})),this.options.menus.inputSideToolbar){const p=this._register(this.instantiationService.createInstance(O,n,this.options.menus.inputSideToolbar,{telemetrySource:this.options.menus.telemetrySource,menuOptions:{shouldForwardArgs:!0},hoverDelegate:v}));this.inputSideToolbarContainer=p.getElement(),p.getElement().classList.add("chat-side-toolbar"),p.context={widget:i}}let L=this.modelService.getModel(this.inputUri);if(L||(L=this.modelService.createModel("",null,this.inputUri,!0),this._register(L)),this.inputModel=L,this.inputModel.updateOptions({bracketColorizationOptions:{enabled:!1,independentColorPoolPerBracketType:!1}}),this._inputEditor.setModel(this.inputModel),o){this.inputModel.setValue(o);const p=this.inputModel.getLineCount();this._inputEditor.setPosition({lineNumber:p,column:this.inputModel.getLineMaxColumn(p)})}const w=()=>{const p=this._inputEditor.getModel();if(!p)return;const y=this._inputEditor.getPosition();if(!y)return;const I=y.lineNumber===1&&y.column-1<=(this._inputEditor._getViewModel()?.getLineLength(1)??0);this.chatCursorAtTop.set(I),this.historyNavigationBackwardsEnablement.set(I),this.historyNavigationForewardsEnablement.set(y.equals(ot(p)))};this._register(this._inputEditor.onDidChangeCursorPosition(p=>w())),w()}initAttachedContext(t,o=!1){const i=t.offsetHeight;s.clearNode(t),this.attachedContextDisposables.clear();const e=this.attachedContextDisposables.add(K());s.setVisibility(!!this.attachedContext.size,this.attachedContextContainer),this.attachedContext.size||(this._indexOfLastAttachedContextDeletedWithKeyboard=-1),[...this.attachedContext.values()].forEach(async(n,c)=>{const a=s.append(t,D(".chat-attached-context-attachment.show-file-icons")),u=this._contextResourceLabels.create(a,{supportIcons:!0,hoverDelegate:e});let l,h;const g=_.isUri(n.value)?n.value:n.value&&typeof n.value=="object"&&"uri"in n.value&&_.isUri(n.value.uri)?n.value.uri:void 0,m=n.value&&typeof n.value=="object"&&"range"in n.value&&yt.isIRange(n.value.range)?n.value.range:void 0;if(g&&n.isFile){const r=gt(g.path),f=mt(g.path),v=`${r} ${f}`;h=m?b("chat.fileAttachmentWithRange","Attached file, {0}, line {1} to line {2}",v,m.startLineNumber,m.endLineNumber):b("chat.fileAttachment","Attached file, {0}",v),l=g.fsPath,u.setFile(g,{fileKind:Tt.FILE,hidePath:!0,range:m}),this.attachButtonAndDisposables(a,c,n,e)}else if(n.isImage){h=b("chat.imageAttachment","Attached image, {0}",n.name),l=s.$("div.chat-attached-context-hover"),l.setAttribute("aria-label",h);const r=s.$("div.chat-attached-context-pill",{},s.$("span.codicon.codicon-file-media")),f=s.$("span.chat-attached-context-custom-text",{},n.name);a.appendChild(r),a.appendChild(f);let v;try{n.value instanceof _?(this.attachButtonAndDisposables(a,c,n,e),v=(await this.fileService.readFile(n.value)).value.buffer):(v=n.value,this.attachButtonAndDisposables(a,c,n,e)),this.createImageElements(v,a,l)}catch{}a.style.position="relative"}else{const r=n.fullName??n.name,f=n.icon?.id?`$(${n.icon.id}) ${r}`:r;u.setLabel(f,void 0),h=b("chat.attachment","Attached context, {0}",n.name),l=r,this.attachButtonAndDisposables(a,c,n,e)}a.tabIndex=0,a.ariaLabel=h,this.attachedContextDisposables.isDisposed||this.attachedContextDisposables.add(this.hoverService.setupManagedHover(e,a,l,{trapFocus:!1}))}),i!==t.offsetHeight&&!o&&this._onDidChangeHeight.fire()}attachButtonAndDisposables(t,o,i,e){const n=new W(t,{supportIcons:!0,hoverDelegate:e,title:b("remove","Remove")});o===Math.min(this._indexOfLastAttachedContextDeletedWithKeyboard,this.attachedContext.size-1)&&n.focus(),this.attachedContextDisposables.add(n),n.icon=V.close;const c=n.onDidClick(a=>{if(this._attachedContext.delete(i),c.dispose(),s.isKeyboardEvent(a)){const u=new R(a);(u.equals(T.Enter)||u.equals(T.Space))&&(this._indexOfLastAttachedContextDeletedWithKeyboard=o)}this._attachedContext.size===0&&this.focus(),this._onDidChangeHeight.fire(),this._onDidChangeContext.fire({removed:[i]})});this.attachedContextDisposables.add(c)}createImageElements(t,o,i){const e=new Blob([t],{type:"image/png"}),n=URL.createObjectURL(e),c=s.$("img.chat-attached-context-image",{src:n,alt:""}),a=s.$("img.chat-attached-context-pill-image",{src:n,alt:""}),u=s.$("div.chat-attached-context-pill",{},a),l=o.querySelector(".chat-attached-context-pill");l&&l.replaceWith(u),i.appendChild(c)}async renderChatEditingSessionState(t){if(s.setVisibility(!!t,this.chatEditingSessionWidgetContainer),!t){s.clearNode(this.chatEditingSessionWidgetContainer),this._chatEditsDisposables.clear(),this._chatEditList=void 0,this._chatEditsProgress?.dispose(),this._chatEditsProgress=void 0;return}this._chatEditList&&t.state.get()===J.Idle&&(this._chatEditsProgress?.stop(),this._chatEditsProgress?.dispose(),this._chatEditsProgress=void 0);const o=this.chatEditingSessionWidgetContainer.querySelector(".chat-editing-session-container.show-file-icons")??s.append(this.chatEditingSessionWidgetContainer,D(".chat-editing-session-container.show-file-icons")),i=t.entries.get().length,e=o.querySelector(".chat-editing-session-overview")??s.append(o,D(".chat-editing-session-overview"));if(i!==this._chatEditList?.object.length){const h=e.querySelector("span")??s.append(e,D("span"));h.textContent=i===1?b("chatEditingSessionOverview.oneFileChanged","1 file changed"):b("chatEditingSessionOverview","{0} files changed",i)}{const h=e.querySelector(".chat-editing-session-actions")??s.append(e,D(".chat-editing-session-actions"));if(this._chatEditsActionsDisposables.clear(),s.clearNode(h),t.entries.get().find(m=>m.state.get()===Qt.Undecided)){const m=[];m.push({command:tt.ID,label:tt.LABEL,isSecondary:!0},{command:Z.ID,label:Z.LABEL,isSecondary:!0},{command:Y.ID,label:Y.LABEL,isSecondary:!1});for(const r of m){const f=this._chatEditsActionsDisposables.add(new W(h,{supportIcons:!1,secondary:r.isSecondary}));f.label=r.label,this._chatEditsActionsDisposables.add(f.onDidClick(()=>{this.commandService.executeCommand(r.command)})),s.append(h,f.element)}}const g=this._chatEditsActionsDisposables.add(new W(h,{supportIcons:!0}));g.icon=V.close,this._chatEditsActionsDisposables.add(g.onDidClick(m=>{t.stop()})),s.append(h,g.element)}if(!this._chatEditsProgress&&t.state.get()===J.StreamingEdits&&(this._chatEditsProgress=new ct(o),this._chatEditsProgress.infinite().show(500)),!this._chatEditList){this._chatEditList=this._chatEditsListPool.get();const h=this._chatEditList.object;this._chatEditsDisposables.add(this._chatEditList),this._chatEditsDisposables.add(h.onDidOpen(g=>{if(g.element?.kind==="reference"&&_.isUri(g.element.reference)){const m=g.element.reference,r=t.entries.get().find(f=>f.modifiedURI.toString()===m.toString());r&&this.editorService.openEditor({original:{resource:_.from(r.originalURI,!0)},modified:{resource:_.from(r.modifiedURI,!0)}})}})),s.append(o,h.getHTMLElement())}const a=Math.min(i,6)*22,u=this._chatEditList.object;u.layout(a),u.getHTMLElement().style.height=`${a}px`;const l=t.entries.get().map(h=>({reference:h.modifiedURI,kind:"reference"}));u.splice(0,u.length,l)}async renderFollowups(t,o){this.options.renderFollowups&&(this.followupsDisposables.clear(),s.clearNode(this.followupsContainer),t&&t.length>0&&this.followupsDisposables.add(this.instantiationService.createInstance(ne,this.followupsContainer,t,this.location,void 0,i=>this._onDidAcceptFollowup.fire({followup:i,response:o}))),this._onDidChangeHeight.fire())}get contentHeight(){const t=this.getLayoutData();return t.followupsHeight+t.inputPartEditorHeight+t.inputPartVerticalPadding+t.inputEditorBorder+t.attachmentsHeight+t.toolbarsHeight+t.chatEditingStateHeight}layout(t,o){return this.cachedDimensions=new s.Dimension(o,t),this._layout(t,o)}previousInputEditorDimension;_layout(t,o,i=!0){this.initAttachedContext(this.attachedContextContainer,!0);const e=this.getLayoutData(),n=Math.min(e.inputPartEditorHeight,t-e.followupsHeight-e.attachmentsHeight-e.inputPartVerticalPadding-e.toolbarsHeight),c=o-e.inputPartHorizontalPadding;this.followupsContainer.style.width=`${c}px`,this._inputPartHeight=e.inputPartVerticalPadding+e.followupsHeight+n+e.inputEditorBorder+e.attachmentsHeight+e.toolbarsHeight+e.chatEditingStateHeight,this._followupsHeight=e.followupsHeight;const a=this._inputEditor.getScrollWidth(),l={width:o-e.inputPartHorizontalPadding-e.editorBorder-e.inputPartHorizontalPaddingInside-e.toolbarsWidth-e.sideToolbarWidth,height:n};if((!this.previousInputEditorDimension||this.previousInputEditorDimension.width!==l.width||this.previousInputEditorDimension.height!==l.height)&&(this._inputEditor.layout(l),this.previousInputEditorDimension=l),i&&a<10)return this._layout(t,o,!1)}getLayoutData(){const t=this.cachedExecuteToolbarWidth=this.executeToolbar.getItemsWidth(),o=this.cachedInputToolbarWidth=this.inputActionsToolbar.getItemsWidth(),i=(this.executeToolbar.getItemsLength()-1)*4,e=this.inputActionsToolbar.getItemsLength()?(this.inputActionsToolbar.getItemsLength()-1)*4:0;return{inputEditorBorder:2,followupsHeight:this.followupsContainer.offsetHeight,inputPartEditorHeight:Math.min(this._inputEditor.getContentHeight(),this.inputEditorMaxHeight),inputPartHorizontalPadding:this.options.renderStyle==="compact"?16:32,inputPartVerticalPadding:this.options.renderStyle==="compact"?12:28,attachmentsHeight:this.attachedContextContainer.offsetHeight,editorBorder:2,inputPartHorizontalPaddingInside:12,toolbarsWidth:this.options.renderStyle==="compact"?t+i+o+e:0,toolbarsHeight:this.options.renderStyle==="compact"?0:22,chatEditingStateHeight:this.chatEditingSessionWidgetContainer.offsetHeight,sideToolbarWidth:this.inputSideToolbarContainer?s.getTotalWidth(this.inputSideToolbarContainer)+4:0}}saveState(){this.saveCurrentValue(this.getInputState());const t=[...this.history];this.historyService.saveHistory(this.location,t)}};M=A([d(3,Yt),d(4,Et),d(5,Vt),d(6,F),d(7,At),d(8,k),d(9,N),d(10,Q),d(11,Ot),d(12,Wt),d(13,Pt),d(14,wt),d(15,Ut)],M);const it=C=>JSON.stringify(C);function ot(C){return{lineNumber:C.getLineCount(),column:C.getLineLength(C.getLineCount())+1}}let x=class extends Mt{constructor(E,t,o,i,e,n,c,a,u,l,h){super(E,t,[],"",{...o,getKeyBinding:r=>a.lookupKeybinding(r.id,c)},e,a,u,c,l,h);const g=i.createMenu(B.ChatExecuteSecondary,c),m=()=>{const r=[];Dt(g,{shouldForwardArgs:!0},r);const f=n.getSecondaryAgent();f&&r.forEach(v=>(v.id===ee.ID&&(v.label=b("chat.submitToSecondaryAgent","Send to @{0}",f.name)),v)),this.update(t,r)};m(),this._register(g.onDidChange(()=>m()))}};x=A([d(3,Ht),d(4,z),d(5,zt),d(6,F),d(7,k),d(8,j),d(9,X),d(10,N)],x);let H=class extends xt{constructor(t,o,i,e,n,c,a,u,l,h,g){super(t,e,n,c,a,u,l,g);this.currentLanguageModel=o;this.delegate=i;this._languageModelsService=h;this._register(i.onDidChangeModel(m=>{this.currentLanguageModel=m,this.updateLabel()}))}async onClick(t){this._openContextMenu()}render(t){super.render(t),t.classList.add("chat-modelPicker-item"),this._register(s.addDisposableListener(t,s.EventType.KEY_UP,o=>{const i=new R(o);(i.equals(T.Enter)||i.equals(T.Space))&&this._openContextMenu()}))}updateLabel(){if(this.label){const t=this._languageModelsService.lookupLanguageModel(this.currentLanguageModel);t&&(this.label.textContent=t.name,s.reset(this.label,...ht(`${t.name}$(chevron-down)`)))}}_openContextMenu(){const t=(i,e)=>({id:i,label:e.name,tooltip:"",class:void 0,enabled:!0,checked:i===this.currentLanguageModel,run:()=>{this.currentLanguageModel=i,this.updateLabel(),this.delegate.setModel(i)}}),o=this._languageModelsService.getLanguageModelIds().map(i=>({id:i,model:this._languageModelsService.lookupLanguageModel(i)})).filter(i=>i.model?.isUserSelectable);this._contextMenuService.showContextMenu({getAnchor:()=>this.element,getActions:()=>o.map(i=>t(i.id,i.model))})}};H=A([d(4,k),d(5,j),d(6,F),d(7,X),d(8,z),d(9,Q),d(10,N)],H);const nt=".interactive-input-editor";$t(nt);export{M as ChatInputPart};
