var rt=Object.defineProperty;var st=Object.getOwnPropertyDescriptor;var A=(C,S,t,o)=>{for(var i=o>1?void 0:o?st(S,t):S,e=C.length-1,n;e>=0;e--)(n=C[e])&&(i=(o?n(S,t,i):n(i))||i);return o&&i&&rt(S,t,i),i},d=(C,S)=>(t,o)=>S(t,o,C);import*as r from"../../../../base/browser/dom.js";import{DEFAULT_FONT_FAMILY as at}from"../../../../base/browser/fonts.js";import"../../../../base/browser/history.js";import{StandardKeyboardEvent as F}from"../../../../base/browser/keyboardEvent.js";import*as dt from"../../../../base/browser/ui/aria/aria.js";import{Button as W}from"../../../../base/browser/ui/button/button.js";import"../../../../base/browser/ui/hover/hoverDelegate.js";import{createInstantHoverDelegate as K}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import{renderLabelWithIcons as lt}from"../../../../base/browser/ui/iconLabel/iconLabels.js";import"../../../../base/common/actions.js";import{Codicon as V}from"../../../../base/common/codicons.js";import{Emitter as L}from"../../../../base/common/event.js";import{HistoryNavigator2 as $}from"../../../../base/common/history.js";import{KeyCode as D}from"../../../../base/common/keyCodes.js";import{Disposable as ht,DisposableStore as N,MutableDisposable as ct}from"../../../../base/common/lifecycle.js";import{basename as ut,dirname as pt}from"../../../../base/common/path.js";import{isMacintosh as gt}from"../../../../base/common/platform.js";import{URI as M}from"../../../../base/common/uri.js";import"../../../../editor/browser/config/editorConfiguration.js";import{EditorExtensionsRegistry as mt}from"../../../../editor/browser/editorExtensions.js";import{CodeEditorWidget as ft}from"../../../../editor/browser/widget/codeEditor/codeEditorWidget.js";import{EditorOptions as vt}from"../../../../editor/common/config/editorOptions.js";import"../../../../editor/common/core/dimension.js";import"../../../../editor/common/core/position.js";import{Range as Ct}from"../../../../editor/common/core/range.js";import"../../../../editor/common/model.js";import{IModelService as bt}from"../../../../editor/common/services/model.js";import{CopyPasteController as yt}from"../../../../editor/contrib/dropOrPasteInto/browser/copyPasteController.js";import{ContentHoverController as It}from"../../../../editor/contrib/hover/browser/contentHoverController.js";import{GlyphHoverController as Et}from"../../../../editor/contrib/hover/browser/glyphHoverController.js";import{SuggestController as St}from"../../../../editor/contrib/suggest/browser/suggestController.js";import{localize as I}from"../../../../nls.js";import{IAccessibilityService as O}from"../../../../platform/accessibility/common/accessibility.js";import{DropdownWithPrimaryActionViewItem as _t}from"../../../../platform/actions/browser/dropdownWithPrimaryActionViewItem.js";import{createAndFillInActionBarActions as Lt,MenuEntryActionViewItem as Mt}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{HiddenItemStrategy as q,MenuWorkbenchToolBar as k}from"../../../../platform/actions/browser/toolbar.js";import{IMenuService as xt,MenuId as B,MenuItemAction as U}from"../../../../platform/actions/common/actions.js";import{ICommandService as Dt}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as Ht}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as P}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as z}from"../../../../platform/contextview/browser/contextView.js";import{FileKind as wt,IFileService as Tt}from"../../../../platform/files/common/files.js";import{registerAndCreateHistoryNavigationContext as At}from"../../../../platform/history/browser/contextScopedHistoryWidget.js";import{IHoverService as Pt}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as Ft}from"../../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as Wt}from"../../../../platform/instantiation/common/serviceCollection.js";import{IKeybindingService as R}from"../../../../platform/keybinding/common/keybinding.js";import"../../../../platform/list/browser/listService.js";import{ILogService as Vt}from"../../../../platform/log/common/log.js";import{INotificationService as j}from"../../../../platform/notification/common/notification.js";import{IThemeService as X}from"../../../../platform/theme/common/themeService.js";import{ResourceLabels as Nt}from"../../../browser/labels.js";import{IEditorService as Ot}from"../../../services/editor/common/editorService.js";import{AccessibilityVerbositySettingId as G}from"../../accessibility/browser/accessibilityConfiguration.js";import{AccessibilityCommandId as kt}from"../../accessibility/common/accessibilityCommands.js";import{getSimpleCodeEditorWidgetOptions as Bt,getSimpleEditorOptions as Ut,setupSimpleEditorSelectionStyling as Rt}from"../../codeEditor/browser/simpleEditorOptions.js";import{ChatAgentLocation as Kt,IChatAgentService as $t}from"../common/chatAgents.js";import{CONTEXT_CHAT_INPUT_CURSOR_AT_TOP as qt,CONTEXT_CHAT_INPUT_HAS_FOCUS as zt,CONTEXT_CHAT_INPUT_HAS_TEXT as jt,CONTEXT_IN_CHAT_INPUT as Xt}from"../common/chatContextKeys.js";import{ModifiedFileEntryState as Gt}from"../common/chatEditingService.js";import"../common/chatModel.js";import"../common/chatService.js";import"../common/chatViewModel.js";import{IChatWidgetHistoryService as Jt}from"../common/chatWidgetHistoryService.js";import{ILanguageModelsService as J}from"../common/languageModels.js";import{CancelAction as Qt,ChatModelPickerActionId as Yt,ChatSubmitSecondaryAgentAction as Zt,SubmitAction as te}from"./actions/chatExecuteActions.js";import"./chat.js";import"./chatContentParts/chatCollections.js";import{CollapsibleListPool as ee}from"./chatContentParts/chatReferencesContentPart.js";import{ChatEditingAcceptAllAction as Q,ChatEditingDiscardAllAction as Y,ChatEditingShowChangesAction as Z}from"./chatEditingService.js";import{ChatFollowups as ie}from"./chatFollowups.js";import"./chatWidget.js";const H=r.$,tt=250;let x=class extends ht{constructor(t,o,i,e,n,c,s,u,h,b,m,g,a,v,E,y){super();this.location=t;this.options=o;this.getInputState=i;this.historyService=e;this.modelService=n;this.instantiationService=c;this.contextKeyService=s;this.configurationService=u;this.keybindingService=h;this.accessibilityService=b;this.languageModelsService=m;this.logService=g;this.hoverService=a;this.fileService=v;this.commandService=E;this.editorService=y;this.inputEditorMaxHeight=this.options.renderStyle==="compact"?tt/3:tt,this.inputEditorHasText=jt.bindTo(s),this.chatCursorAtTop=qt.bindTo(s),this.inputEditorHasFocus=zt.bindTo(s),this.history=this.loadHistory(),this._register(this.historyService.onDidClearHistory(()=>this.history=new $([{text:""}],50,et))),this._register(this.configurationService.onDidChangeConfiguration(p=>{p.affectsConfiguration(G.Chat)&&this.inputEditor.updateOptions({ariaLabel:this._getAriaLabel()})})),this._chatEditsListPool=this._register(this.instantiationService.createInstance(ee,this._onDidChangeVisibility.event,B.ChatEditingSessionWidgetToolbar))}static INPUT_SCHEME="chatSessionInput";static _counter=0;_onDidLoadInputState=this._register(new L);onDidLoadInputState=this._onDidLoadInputState.event;_onDidChangeHeight=this._register(new L);onDidChangeHeight=this._onDidChangeHeight.event;_onDidFocus=this._register(new L);onDidFocus=this._onDidFocus.event;_onDidBlur=this._register(new L);onDidBlur=this._onDidBlur.event;_onDidChangeContext=this._register(new L);onDidChangeContext=this._onDidChangeContext.event;_onDidAcceptFollowup=this._register(new L);onDidAcceptFollowup=this._onDidAcceptFollowup.event;get attachedContext(){return this._attachedContext}_indexOfLastAttachedContextDeletedWithKeyboard=-1;_attachedContext=new Set;_onDidChangeVisibility=this._register(new L);_contextResourceLabels=this.instantiationService.createInstance(Nt,{onDidChangeVisibility:this._onDidChangeVisibility.event});inputEditorMaxHeight;inputEditorHeight=0;container;inputSideToolbarContainer;followupsContainer;followupsDisposables=this._register(new N);attachedContextContainer;attachedContextDisposables=this._register(new N);chatEditingSessionWidgetContainer;_inputPartHeight=0;get inputPartHeight(){return this._inputPartHeight}_followupsHeight=0;get followupsHeight(){return this._followupsHeight}_inputEditor;_inputEditorElement;executeToolbar;inputActionsToolbar;get inputEditor(){return this._inputEditor}history;historyNavigationBackwardsEnablement;historyNavigationForewardsEnablement;inHistoryNavigation=!1;inputModel;inputEditorHasText;chatCursorAtTop;inputEditorHasFocus;_waitForPersistedLanguageModel=this._register(new ct);_onDidChangeCurrentLanguageModel=new L;_currentLanguageModel;get currentLanguageModel(){return this._currentLanguageModel}cachedDimensions;cachedExecuteToolbarWidth;cachedInputToolbarWidth;inputUri=M.parse(`${x.INPUT_SCHEME}:input-${x._counter++}`);_chatEditsDisposables=this._register(new N);_chatEditsListPool;_chatEditList;get selectedElements(){const t=[],i=this._chatEditList?.object?.getSelectedElements()??[];for(const e of i)e.kind==="reference"&&M.isUri(e.reference)&&t.push(e.reference);return t}setCurrentLanguageModelToDefault(){const t=this.languageModelsService.getLanguageModelIds().find(i=>this.languageModelsService.lookupLanguageModel(i)?.isDefault),o=this.languageModelsService.getLanguageModelIds().find(i=>{const e=this.languageModelsService.lookupLanguageModel(i);return e?.isUserSelectable&&!e.isDefault});this._currentLanguageModel=o?t:void 0}setCurrentLanguageModelByUser(t){this._currentLanguageModel=t,this._waitForPersistedLanguageModel.clear(),this.cachedDimensions&&this.layout(this.cachedDimensions.height,this.cachedDimensions.width)}loadHistory(){const t=this.historyService.getHistory(this.location);return t.length===0&&t.push({text:""}),new $(t,50,et)}_getAriaLabel(){if(this.configurationService.getValue(G.Chat)){const o=this.keybindingService.lookupKeybinding(kt.OpenAccessibilityHelp)?.getLabel();return o?I("actions.chat.accessibiltyHelp","Chat Input,  Type to ask questions or type / for topics, press enter to send out the request. Use {0} for Chat Accessibility Help.",o):I("chatInput.accessibilityHelpNoKb","Chat Input,  Type code here and press Enter to run. Use the Chat Accessibility Help command for more information.")}return I("chatInput","Chat Input")}updateState(t){if(this.inHistoryNavigation)return;const o={text:this._inputEditor.getValue(),state:t};this.history.isAtEnd()?this.history.replaceLast(o):(this.history.replaceLast(o),this.history.resetCursor())}initForNewChatModel(t){this.history=this.loadHistory(),this.history.add({text:t.inputValue??this.history.current().text,state:t.inputState??this.getInputState()}),t.inputValue&&this.setValue(t.inputValue,!1),t.selectedLanguageModelId&&(this.languageModelsService.lookupLanguageModel(t.selectedLanguageModelId)?(this._currentLanguageModel=t.selectedLanguageModelId,this._onDidChangeCurrentLanguageModel.fire(this._currentLanguageModel)):this._waitForPersistedLanguageModel.value=this.languageModelsService.onDidChangeLanguageModels(i=>{const e=i.added?.find(n=>n.identifier===t.selectedLanguageModelId);e&&(this._waitForPersistedLanguageModel.clear(),e.metadata.isUserSelectable&&(this._currentLanguageModel=t.selectedLanguageModelId,this._onDidChangeCurrentLanguageModel.fire(this._currentLanguageModel)))}))}logInputHistory(){const t=[...this.history].map(o=>JSON.stringify(o)).join(`
`);this.logService.info(`[${this.location}] Chat input history:`,t)}setVisible(t){this._onDidChangeVisibility.fire(t)}get element(){return this.container}showPreviousValue(){const t=this.getInputState();this.history.isAtEnd()?this.saveCurrentValue(t):this.history.has({text:this._inputEditor.getValue(),state:t})||(this.saveCurrentValue(t),this.history.resetCursor()),this.navigateHistory(!0)}showNextValue(){const t=this.getInputState();this.history.isAtEnd()||(this.history.has({text:this._inputEditor.getValue(),state:t})||(this.saveCurrentValue(t),this.history.resetCursor()),this.navigateHistory(!1))}navigateHistory(t){const o=t?this.history.previous():this.history.next();dt.status(o.text),this.inHistoryNavigation=!0,this.setValue(o.text,!0),this.inHistoryNavigation=!1,this._onDidLoadInputState.fire(o.state);const i=this._inputEditor.getModel();if(i)if(t){const e=this._inputEditor._getViewModel()?.getLineLength(1)??1,n=i.getLineLength(1);e===n?this._inputEditor.setPosition({lineNumber:1,column:e+1}):this._inputEditor.setPosition({lineNumber:1,column:e})}else this._inputEditor.setPosition(it(i))}setValue(t,o){this.inputEditor.setValue(t),this.inputEditor.setPosition({lineNumber:1,column:t.length+1}),o||this.saveCurrentValue(this.getInputState())}saveCurrentValue(t){const o={text:this._inputEditor.getValue(),state:t};this.history.replaceLast(o)}focus(){this._inputEditor.focus()}hasFocus(){return this._inputEditor.hasWidgetFocus()}async acceptInput(t){if(t){const i={text:this._inputEditor.getValue(),state:this.getInputState()};this.history.replaceLast(i),this.history.add({text:""})}this._attachedContext.clear(),this._onDidLoadInputState.fire({}),this.accessibilityService.isScreenReaderOptimized()&&gt?this._acceptInputForVoiceover():(this._inputEditor.focus(),this._inputEditor.setValue(""))}_acceptInputForVoiceover(){const t=this._inputEditor.getDomNode();t&&(t.remove(),this._inputEditor.setValue(""),this._inputEditorElement.appendChild(t),this._inputEditor.focus())}attachContext(t,...o){const i=[];if(t&&(i.push(...Array.from(this._attachedContext)),this._attachedContext.clear()),o.length>0)for(const e of o)this._attachedContext.add(e);(i.length>0||o.length>0)&&(this.initAttachedContext(this.attachedContextContainer),t||this._onDidChangeContext.fire({removed:i,added:o}))}render(t,o,i){let e;this.options.renderStyle==="compact"?e=r.h(".interactive-input-part",[r.h(".interactive-input-and-edit-session",[r.h(".chat-editing-session@chatEditingSessionWidgetContainer"),r.h(".interactive-input-and-side-toolbar@inputAndSideToolbar",[r.h(".chat-input-container@inputContainer",[r.h(".chat-editor-container@editorContainer"),r.h(".chat-input-toolbars@inputToolbars")])]),r.h(".chat-attached-context@attachedContextContainer"),r.h(".interactive-input-followups@followupsContainer")])]):e=r.h(".interactive-input-part",[r.h(".interactive-input-followups@followupsContainer"),r.h(".chat-editing-session@chatEditingSessionWidgetContainer"),r.h(".interactive-input-and-side-toolbar@inputAndSideToolbar",[r.h(".chat-input-container@inputContainer",[r.h(".chat-editor-container@editorContainer"),r.h(".chat-attached-context@attachedContextContainer"),r.h(".chat-input-toolbars@inputToolbars")])])]),this.container=e.root,t.append(this.container),this.container.classList.toggle("compact",this.options.renderStyle==="compact"),this.followupsContainer=e.followupsContainer;const n=e.inputAndSideToolbar,c=e.inputContainer,s=e.editorContainer;this.attachedContextContainer=e.attachedContextContainer;const u=e.inputToolbars;this.chatEditingSessionWidgetContainer=e.chatEditingSessionWidgetContainer,this.initAttachedContext(this.attachedContextContainer),this.renderChatEditingSessionState(null);const h=this._register(this.contextKeyService.createScoped(c));Xt.bindTo(h).set(!0);const b=this._register(this.instantiationService.createChild(new Wt([P,h]))),{historyNavigationBackwardsEnablement:m,historyNavigationForwardsEnablement:g}=this._register(At(h,this));this.historyNavigationBackwardsEnablement=m,this.historyNavigationForewardsEnablement=g;const a=Ut(this.configurationService);a.overflowWidgetsDomNode=this.options.editorOverflowWidgetsDomNode,a.pasteAs=vt.pasteAs.defaultValue,a.readOnly=!1,a.ariaLabel=this._getAriaLabel(),a.fontFamily=at,a.fontSize=13,a.lineHeight=20,a.padding=this.options.renderStyle==="compact"?{top:2,bottom:2}:{top:8,bottom:8},a.cursorWidth=1,a.wrappingStrategy="advanced",a.bracketPairColorization={enabled:!1},a.suggest={showIcons:!1,showSnippets:!1,showWords:!0,showStatusBar:!1,insertMode:"replace"},a.scrollbar={...a.scrollbar??{},vertical:"hidden"},a.stickyScroll={enabled:!1},this._inputEditorElement=r.append(s,H(ot));const v=Bt();v.contributions?.push(...mt.getSomeEditorContributions([It.ID,Et.ID,yt.ID])),this._inputEditor=this._register(b.createInstance(ft,this._inputEditorElement,a,v)),St.get(this._inputEditor)?.forceRenderingAbove(),this._register(this._inputEditor.onDidChangeModelContent(()=>{const l=Math.min(this._inputEditor.getContentHeight(),this.inputEditorMaxHeight);l!==this.inputEditorHeight&&(this.inputEditorHeight=l,this._onDidChangeHeight.fire());const f=this._inputEditor.getModel(),_=!!f&&f.getValue().trim().length>0;this.inputEditorHasText.set(_)})),this._register(this._inputEditor.onDidFocusEditorText(()=>{this.inputEditorHasFocus.set(!0),this._onDidFocus.fire(),c.classList.toggle("focused",!0)})),this._register(this._inputEditor.onDidBlurEditorText(()=>{this.inputEditorHasFocus.set(!1),c.classList.toggle("focused",!1),this._onDidBlur.fire()}));const E=this._register(K());if(this._register(r.addStandardDisposableListener(u,r.EventType.CLICK,l=>this.inputEditor.focus())),this.inputActionsToolbar=this._register(this.instantiationService.createInstance(k,u,B.ChatInput,{telemetrySource:this.options.menus.telemetrySource,menuOptions:{shouldForwardArgs:!0},hiddenItemStrategy:q.Ignore,hoverDelegate:E})),this.inputActionsToolbar.context={widget:i},this._register(this.inputActionsToolbar.onDidChangeMenuItems(()=>{this.cachedDimensions&&typeof this.cachedInputToolbarWidth=="number"&&this.cachedInputToolbarWidth!==this.inputActionsToolbar.getItemsWidth()&&this.layout(this.cachedDimensions.height,this.cachedDimensions.width)})),this.executeToolbar=this._register(this.instantiationService.createInstance(k,u,this.options.menus.executeToolbar,{telemetrySource:this.options.menus.telemetrySource,menuOptions:{shouldForwardArgs:!0},hoverDelegate:E,hiddenItemStrategy:q.Ignore,actionViewItemProvider:(l,f)=>{if(this.location===Kt.Panel&&(l.id===te.ID||l.id===Qt.ID)&&l instanceof U){const _=this.instantiationService.createInstance(U,{id:"chat.moreExecuteActions",title:I("notebook.moreExecuteActionsLabel","More..."),icon:V.chevronDown},void 0,void 0,void 0,void 0);return this.instantiationService.createInstance(w,l,_,f)}if(l.id===Yt&&l instanceof U&&(this._currentLanguageModel||this.setCurrentLanguageModelToDefault(),this._currentLanguageModel)){const _={onDidChangeModel:this._onDidChangeCurrentLanguageModel.event,setModel:nt=>{this.setCurrentLanguageModelByUser(nt)}};return this.instantiationService.createInstance(T,l,this._currentLanguageModel,_,{hoverDelegate:f.hoverDelegate,keybinding:f.keybinding??void 0})}}})),this.executeToolbar.context={widget:i},this._register(this.executeToolbar.onDidChangeMenuItems(()=>{this.cachedDimensions&&typeof this.cachedExecuteToolbarWidth=="number"&&this.cachedExecuteToolbarWidth!==this.executeToolbar.getItemsWidth()&&this.layout(this.cachedDimensions.height,this.cachedDimensions.width)})),this.options.menus.inputSideToolbar){const l=this._register(this.instantiationService.createInstance(k,n,this.options.menus.inputSideToolbar,{telemetrySource:this.options.menus.telemetrySource,menuOptions:{shouldForwardArgs:!0},hoverDelegate:E}));this.inputSideToolbarContainer=l.getElement(),l.getElement().classList.add("chat-side-toolbar"),l.context={widget:i}}let y=this.modelService.getModel(this.inputUri);if(y||(y=this.modelService.createModel("",null,this.inputUri,!0),this._register(y)),this.inputModel=y,this.inputModel.updateOptions({bracketColorizationOptions:{enabled:!1,independentColorPoolPerBracketType:!1}}),this._inputEditor.setModel(this.inputModel),o){this.inputModel.setValue(o);const l=this.inputModel.getLineCount();this._inputEditor.setPosition({lineNumber:l,column:this.inputModel.getLineMaxColumn(l)})}const p=()=>{const l=this._inputEditor.getModel();if(!l)return;const f=this._inputEditor.getPosition();if(!f)return;const _=f.lineNumber===1&&f.column-1<=(this._inputEditor._getViewModel()?.getLineLength(1)??0);this.chatCursorAtTop.set(_),this.historyNavigationBackwardsEnablement.set(_),this.historyNavigationForewardsEnablement.set(f.equals(it(l)))};this._register(this._inputEditor.onDidChangeCursorPosition(l=>p())),p()}initAttachedContext(t,o=!1){const i=t.offsetHeight;r.clearNode(t),this.attachedContextDisposables.clear();const e=this.attachedContextDisposables.add(K());r.setVisibility(!!this.attachedContext.size,this.attachedContextContainer),this.attachedContext.size||(this._indexOfLastAttachedContextDeletedWithKeyboard=-1),[...this.attachedContext.values()].forEach(async(n,c)=>{const s=r.append(t,H(".chat-attached-context-attachment.show-file-icons")),u=this._contextResourceLabels.create(s,{supportIcons:!0,hoverDelegate:e}),h=M.isUri(n.value)?n.value:n.value&&typeof n.value=="object"&&"uri"in n.value&&M.isUri(n.value.uri)?n.value.uri:void 0,b=n.value&&typeof n.value=="object"&&"range"in n.value&&Ct.isIRange(n.value.range)?n.value.range:void 0;if(h&&n.isFile){const m=ut(h.path),g=pt(h.path),a=`${m} ${g}`,v=b?I("chat.fileAttachmentWithRange","Attached file, {0}, line {1} to line {2}",a,b.startLineNumber,b.endLineNumber):I("chat.fileAttachment","Attached file, {0}",a);u.setFile(h,{fileKind:wt.FILE,hidePath:!0,range:b}),s.ariaLabel=v,s.tabIndex=0,this.attachButtonAndDisposables(s,c,n,e)}else if(n.isImage){let m;const g=I("chat.imageAttachment","Attached image, {0}",n.name),a=r.$("div.chat-attached-context-pill",{},r.$("span.codicon.codicon-file-media")),v=r.$("div.chat-attached-context-hover");v.setAttribute("aria-label",g);const E=r.$("span.chat-attached-context-custom-text",{},n.name);s.appendChild(a),s.appendChild(E);try{n.value instanceof M?(this.attachButtonAndDisposables(s,c,n,e),m=(await this.fileService.readFile(n.value)).value.buffer):(m=n.value,this.attachButtonAndDisposables(s,c,n,e)),this.createImageElements(m,s,v)}catch{}s.style.position="relative",s.ariaLabel=g,s.tabIndex=0,this.attachedContextDisposables.isDisposed||(this.attachedContextDisposables.add(this.hoverService.setupManagedHover(e,s,v,{trapFocus:!1})),this.attachedContextDisposables.add(r.addDisposableListener(s,"keydown",y=>{const p=new F(y);(p.keyCode===D.Enter||p.keyCode===D.Space)&&this.hoverService.showManagedHover(s)})))}else{const m=n.fullName??n.name,g=n.icon?.id?`$(${n.icon.id}) ${m}`:m;u.setLabel(g,void 0),s.ariaLabel=I("chat.attachment","Attached context, {0}",n.name),s.tabIndex=0,this.attachButtonAndDisposables(s,c,n,e)}}),i!==t.offsetHeight&&!o&&this._onDidChangeHeight.fire()}attachButtonAndDisposables(t,o,i,e){const n=new W(t,{supportIcons:!0,hoverDelegate:e,title:I("remove","Remove")});o===Math.min(this._indexOfLastAttachedContextDeletedWithKeyboard,this.attachedContext.size-1)&&n.focus(),this.attachedContextDisposables.add(n),n.icon=V.close;const c=n.onDidClick(s=>{if(this._attachedContext.delete(i),c.dispose(),r.isKeyboardEvent(s)){const u=new F(s);(u.equals(D.Enter)||u.equals(D.Space))&&(this._indexOfLastAttachedContextDeletedWithKeyboard=o)}this._attachedContext.size===0&&this.focus(),this._onDidChangeHeight.fire(),this._onDidChangeContext.fire({removed:[i]})});this.attachedContextDisposables.add(c)}createImageElements(t,o,i){const e=new Blob([t],{type:"image/png"}),n=URL.createObjectURL(e),c=r.$("img.chat-attached-context-image",{src:n,alt:""}),s=r.$("img.chat-attached-context-pill-image",{src:n,alt:""}),u=r.$("div.chat-attached-context-pill",{},s),h=o.querySelector(".chat-attached-context-pill");h&&h.replaceWith(u),i.appendChild(c)}async renderChatEditingSessionState(t){if(r.clearNode(this.chatEditingSessionWidgetContainer),r.setVisibility(!!t,this.chatEditingSessionWidgetContainer),this._chatEditsDisposables.clear(),this._chatEditList=void 0,!t)return;const o=r.append(this.chatEditingSessionWidgetContainer,H(".chat-editing-session-container.show-file-icons")),i=t.entries.get(),e=i.length,n=r.append(o,H(".chat-editing-session-overview")),c=r.append(n,H("span"));c.textContent=e===1?I("chatEditingSessionOverview.oneFileChanged","1 file changed"):I("chatEditingSessionOverview","{0} files changed",e);const s=r.append(n,H(".chat-editing-session-actions")),u=[];i.find(p=>p.state.get()===Gt.Undecided)&&u.push({command:Z.ID,label:Z.LABEL,isSecondary:!0},{command:Y.ID,label:Y.LABEL,isSecondary:!0},{command:Q.ID,label:Q.LABEL,isSecondary:!1});for(const p of u){const l=this._register(new W(s,{supportIcons:!1,secondary:p.isSecondary}));l.label=p.label,this._register(l.onDidClick(()=>{this.commandService.executeCommand(p.command)})),r.append(s,l.element)}const h=new W(s,{supportIcons:!0});this._chatEditsDisposables.add(h),h.icon=V.close;const b=h.onDidClick(p=>{b.dispose(),t.dispose()});if(r.append(s,h.element),!i.length)return;const m=i.map(p=>({reference:p.modifiedURI,kind:"reference"})),g=this._chatEditsListPool.get();this._chatEditList=g;const a=g.object;this._chatEditsDisposables.add(g),this._chatEditsDisposables.add(a.onDidOpen(p=>{if(p.element?.kind==="reference"&&M.isUri(p.element.reference)){const l=p.element.reference,f=i.find(_=>_.modifiedURI.toString()===l.toString());f&&this.editorService.openEditor({original:{resource:M.from(f.originalURI,!0)},modified:{resource:M.from(f.modifiedURI,!0)}})}}));const y=Math.min(e,6)*22;a.layout(y),a.getHTMLElement().style.height=`${y}px`,a.splice(0,a.length,m),r.append(o,g.object.getHTMLElement())}async renderFollowups(t,o){this.options.renderFollowups&&(this.followupsDisposables.clear(),r.clearNode(this.followupsContainer),t&&t.length>0&&this.followupsDisposables.add(this.instantiationService.createInstance(ie,this.followupsContainer,t,this.location,void 0,i=>this._onDidAcceptFollowup.fire({followup:i,response:o}))),this._onDidChangeHeight.fire())}get contentHeight(){const t=this.getLayoutData();return t.followupsHeight+t.inputPartEditorHeight+t.inputPartVerticalPadding+t.inputEditorBorder+t.attachmentsHeight+t.toolbarsHeight+t.chatEditingStateHeight}layout(t,o){return this.cachedDimensions=new r.Dimension(o,t),this._layout(t,o)}previousInputEditorDimension;_layout(t,o,i=!0){this.initAttachedContext(this.attachedContextContainer,!0);const e=this.getLayoutData(),n=Math.min(e.inputPartEditorHeight,t-e.followupsHeight-e.attachmentsHeight-e.inputPartVerticalPadding-e.toolbarsHeight),c=o-e.inputPartHorizontalPadding;this.followupsContainer.style.width=`${c}px`,this._inputPartHeight=e.inputPartVerticalPadding+e.followupsHeight+n+e.inputEditorBorder+e.attachmentsHeight+e.toolbarsHeight+e.chatEditingStateHeight,this._followupsHeight=e.followupsHeight;const s=this._inputEditor.getScrollWidth(),h={width:o-e.inputPartHorizontalPadding-e.editorBorder-e.inputPartHorizontalPaddingInside-e.toolbarsWidth-e.sideToolbarWidth,height:n};if((!this.previousInputEditorDimension||this.previousInputEditorDimension.width!==h.width||this.previousInputEditorDimension.height!==h.height)&&(this._inputEditor.layout(h),this.previousInputEditorDimension=h),i&&s<10)return this._layout(t,o,!1)}getLayoutData(){const t=this.cachedExecuteToolbarWidth=this.executeToolbar.getItemsWidth(),o=this.cachedInputToolbarWidth=this.inputActionsToolbar.getItemsWidth(),i=(this.executeToolbar.getItemsLength()-1)*4,e=this.inputActionsToolbar.getItemsLength()?(this.inputActionsToolbar.getItemsLength()-1)*4:0;return{inputEditorBorder:2,followupsHeight:this.followupsContainer.offsetHeight,inputPartEditorHeight:Math.min(this._inputEditor.getContentHeight(),this.inputEditorMaxHeight),inputPartHorizontalPadding:this.options.renderStyle==="compact"?16:32,inputPartVerticalPadding:this.options.renderStyle==="compact"?12:28,attachmentsHeight:this.attachedContextContainer.offsetHeight,editorBorder:2,inputPartHorizontalPaddingInside:12,toolbarsWidth:this.options.renderStyle==="compact"?t+i+o+e:0,toolbarsHeight:this.options.renderStyle==="compact"?0:22,chatEditingStateHeight:this.chatEditingSessionWidgetContainer.offsetHeight,sideToolbarWidth:this.inputSideToolbarContainer?r.getTotalWidth(this.inputSideToolbarContainer)+4:0}}saveState(){this.saveCurrentValue(this.getInputState());const t=[...this.history];this.historyService.saveHistory(this.location,t)}};x=A([d(3,Jt),d(4,bt),d(5,Ft),d(6,P),d(7,Ht),d(8,R),d(9,O),d(10,J),d(11,Vt),d(12,Pt),d(13,Tt),d(14,Dt),d(15,Ot)],x);const et=C=>JSON.stringify(C);function it(C){return{lineNumber:C.getLineCount(),column:C.getLineLength(C.getLineCount())+1}}let w=class extends _t{constructor(S,t,o,i,e,n,c,s,u,h,b){super(S,t,[],"",{...o,getKeyBinding:a=>s.lookupKeybinding(a.id,c)},e,s,u,c,h,b);const m=i.createMenu(B.ChatExecuteSecondary,c),g=()=>{const a=[];Lt(m,{shouldForwardArgs:!0},a);const v=n.getSecondaryAgent();v&&a.forEach(E=>(E.id===Zt.ID&&(E.label=I("chat.submitToSecondaryAgent","Send to @{0}",v.name)),E)),this.update(t,a)};g(),this._register(m.onDidChange(()=>g()))}};w=A([d(3,xt),d(4,z),d(5,$t),d(6,P),d(7,R),d(8,j),d(9,X),d(10,O)],w);let T=class extends Mt{constructor(t,o,i,e,n,c,s,u,h,b,m){super(t,e,n,c,s,u,h,m);this.currentLanguageModel=o;this.delegate=i;this._languageModelsService=b;this._register(i.onDidChangeModel(g=>{this.currentLanguageModel=g,this.updateLabel()}))}async onClick(t){this._openContextMenu()}render(t){super.render(t),t.classList.add("chat-modelPicker-item"),this._register(r.addDisposableListener(t,r.EventType.KEY_UP,o=>{const i=new F(o);(i.equals(D.Enter)||i.equals(D.Space))&&this._openContextMenu()}))}updateLabel(){if(this.label){const t=this._languageModelsService.lookupLanguageModel(this.currentLanguageModel);t&&(this.label.textContent=t.name,r.reset(this.label,...lt(`${t.name}$(chevron-down)`)))}}_openContextMenu(){const t=(i,e)=>({id:i,label:e.name,tooltip:"",class:void 0,enabled:!0,checked:i===this.currentLanguageModel,run:()=>{this.currentLanguageModel=i,this.updateLabel(),this.delegate.setModel(i)}}),o=this._languageModelsService.getLanguageModelIds().map(i=>({id:i,model:this._languageModelsService.lookupLanguageModel(i)})).filter(i=>i.model?.isUserSelectable);this._contextMenuService.showContextMenu({getAnchor:()=>this.element,getActions:()=>o.map(i=>t(i.id,i.model))})}};T=A([d(4,R),d(5,j),d(6,P),d(7,X),d(8,z),d(9,J),d(10,O)],T);const ot=".interactive-input-editor";Rt(ot);export{x as ChatInputPart};
