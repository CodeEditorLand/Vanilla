var R=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var x=(m,v,t,i)=>{for(var o=i>1?void 0:i?U(v,t):v,e=m.length-1,s;e>=0;e--)(s=m[e])&&(o=(i?s(v,t,o):s(o))||o);return i&&o&&R(v,t,o),o},h=(m,v)=>(t,i)=>v(t,i,m);import*as d from"../../../../base/browser/dom.js";import{DEFAULT_FONT_FAMILY as k}from"../../../../base/browser/fonts.js";import{StandardKeyboardEvent as j}from"../../../../base/browser/keyboardEvent.js";import*as q from"../../../../base/browser/ui/aria/aria.js";import{Button as z}from"../../../../base/browser/ui/button/button.js";import{Codicon as w}from"../../../../base/common/codicons.js";import{Emitter as E}from"../../../../base/common/event.js";import{HistoryNavigator2 as D}from"../../../../base/common/history.js";import{KeyCode as A}from"../../../../base/common/keyCodes.js";import{Disposable as $,DisposableStore as M}from"../../../../base/common/lifecycle.js";import{basename as X,dirname as G}from"../../../../base/common/path.js";import{isMacintosh as J}from"../../../../base/common/platform.js";import{URI as H}from"../../../../base/common/uri.js";import{EditorExtensionsRegistry as Q}from"../../../../editor/browser/editorExtensions.js";import{CodeEditorWidget as Y}from"../../../../editor/browser/widget/codeEditor/codeEditorWidget.js";import{Range as Z}from"../../../../editor/common/core/range.js";import{IModelService as tt}from"../../../../editor/common/services/model.js";import{ContentHoverController as et}from"../../../../editor/contrib/hover/browser/contentHoverController.js";import{GlyphHoverController as it}from"../../../../editor/contrib/hover/browser/glyphHoverController.js";import{localize as b}from"../../../../nls.js";import{IAccessibilityService as L}from"../../../../platform/accessibility/common/accessibility.js";import{DropdownWithPrimaryActionViewItem as ot}from"../../../../platform/actions/browser/dropdownWithPrimaryActionViewItem.js";import{createAndFillInActionBarActions as nt}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{HiddenItemStrategy as rt,MenuWorkbenchToolBar as N}from"../../../../platform/actions/browser/toolbar.js";import{IMenuService as st,MenuId as at,MenuItemAction as P}from"../../../../platform/actions/common/actions.js";import{IConfigurationService as dt}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as T}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as ht}from"../../../../platform/contextview/browser/contextView.js";import{FileKind as lt}from"../../../../platform/files/common/files.js";import{registerAndCreateHistoryNavigationContext as ct}from"../../../../platform/history/browser/contextScopedHistoryWidget.js";import{IInstantiationService as pt}from"../../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as ut}from"../../../../platform/instantiation/common/serviceCollection.js";import{IKeybindingService as F}from"../../../../platform/keybinding/common/keybinding.js";import{ILogService as mt}from"../../../../platform/log/common/log.js";import{INotificationService as gt}from"../../../../platform/notification/common/notification.js";import{IThemeService as ft}from"../../../../platform/theme/common/themeService.js";import{ResourceLabels as yt}from"../../../browser/labels.js";import{AccessibilityVerbositySettingId as V}from"../../accessibility/browser/accessibilityConfiguration.js";import{AccessibilityCommandId as vt}from"../../accessibility/common/accessibilityCommands.js";import{getSimpleCodeEditorWidgetOptions as Ct,getSimpleEditorOptions as bt,setupSimpleEditorSelectionStyling as Et}from"../../codeEditor/browser/simpleEditorOptions.js";import{ChatAgentLocation as It,IChatAgentService as _t}from"../common/chatAgents.js";import{CONTEXT_CHAT_INPUT_CURSOR_AT_TOP as St,CONTEXT_CHAT_INPUT_HAS_FOCUS as xt,CONTEXT_CHAT_INPUT_HAS_TEXT as Ht,CONTEXT_IN_CHAT_INPUT as Tt}from"../common/chatContextKeys.js";import{IChatWidgetHistoryService as wt}from"../common/chatWidgetHistoryService.js";import{CancelAction as Dt,ChatSubmitSecondaryAgentAction as At,SubmitAction as Mt}from"./actions/chatExecuteActions.js";import{ChatFollowups as Lt}from"./chatFollowups.js";const g=d.$,W=250;let I=class extends ${constructor(t,i,o,e,s,l,p,f,c,r,C){super();this.location=t;this.options=i;this.getInputState=o;this.historyService=e;this.modelService=s;this.instantiationService=l;this.contextKeyService=p;this.configurationService=f;this.keybindingService=c;this.accessibilityService=r;this.logService=C;this.inputEditorMaxHeight=this.options.renderStyle==="compact"?W/3:W,this.inputEditorHasText=Ht.bindTo(p),this.chatCursorAtTop=St.bindTo(p),this.inputEditorHasFocus=xt.bindTo(p),this.history=this.loadHistory(),this._register(this.historyService.onDidClearHistory(()=>this.history=new D([{text:""}],50,O))),this._register(this.configurationService.onDidChangeConfiguration(a=>{a.affectsConfiguration(V.Chat)&&this.inputEditor.updateOptions({ariaLabel:this._getAriaLabel()})}))}static INPUT_SCHEME="chatSessionInput";static _counter=0;_onDidLoadInputState=this._register(new E);onDidLoadInputState=this._onDidLoadInputState.event;_onDidChangeHeight=this._register(new E);onDidChangeHeight=this._onDidChangeHeight.event;_onDidFocus=this._register(new E);onDidFocus=this._onDidFocus.event;_onDidBlur=this._register(new E);onDidBlur=this._onDidBlur.event;_onDidChangeContext=this._register(new E);onDidChangeContext=this._onDidChangeContext.event;_onDidAcceptFollowup=this._register(new E);onDidAcceptFollowup=this._onDidAcceptFollowup.event;get attachedContext(){return this._attachedContext}_indexOfLastAttachedContextDeletedWithKeyboard=-1;_attachedContext=new Set;_onDidChangeVisibility=this._register(new E);_contextResourceLabels=this.instantiationService.createInstance(yt,{onDidChangeVisibility:this._onDidChangeVisibility.event});inputEditorMaxHeight;inputEditorHeight=0;container;inputSideToolbarContainer;followupsContainer;followupsDisposables=this._register(new M);attachedContextContainer;attachedContextDisposables=this._register(new M);_inputPartHeight=0;get inputPartHeight(){return this._inputPartHeight}_inputEditor;_inputEditorElement;toolbar;get inputEditor(){return this._inputEditor}history;historyNavigationBackwardsEnablement;historyNavigationForewardsEnablement;inHistoryNavigation=!1;inputModel;inputEditorHasText;chatCursorAtTop;inputEditorHasFocus;cachedDimensions;cachedToolbarWidth;inputUri=H.parse(`${I.INPUT_SCHEME}:input-${I._counter++}`);loadHistory(){const t=this.historyService.getHistory(this.location);return t.length===0&&t.push({text:""}),new D(t,50,O)}_getAriaLabel(){if(this.configurationService.getValue(V.Chat)){const i=this.keybindingService.lookupKeybinding(vt.OpenAccessibilityHelp)?.getLabel();return i?b("actions.chat.accessibiltyHelp","Chat Input,  Type to ask questions or type / for topics, press enter to send out the request. Use {0} for Chat Accessibility Help.",i):b("chatInput.accessibilityHelpNoKb","Chat Input,  Type code here and press Enter to run. Use the Chat Accessibility Help command for more information.")}return b("chatInput","Chat Input")}updateState(t){if(this.inHistoryNavigation)return;const i={text:this._inputEditor.getValue(),state:t};this.history.isAtEnd()?this.history.replaceLast(i):(this.history.replaceLast(i),this.history.resetCursor())}initForNewChatModel(t,i){this.history=this.loadHistory(),this.history.add({text:t??this.history.current().text,state:i}),t&&this.setValue(t,!1)}logInputHistory(){const t=[...this.history].map(i=>JSON.stringify(i)).join(`
`);this.logService.info(`[${this.location}] Chat input history:`,t)}setVisible(t){this._onDidChangeVisibility.fire(t)}get element(){return this.container}showPreviousValue(){const t=this.getInputState();this.history.isAtEnd()?this.saveCurrentValue(t):this.history.has({text:this._inputEditor.getValue(),state:t})||(this.saveCurrentValue(t),this.history.resetCursor()),this.navigateHistory(!0)}showNextValue(){const t=this.getInputState();this.history.isAtEnd()||(this.history.has({text:this._inputEditor.getValue(),state:t})||(this.saveCurrentValue(t),this.history.resetCursor()),this.navigateHistory(!1))}navigateHistory(t){const i=t?this.history.previous():this.history.next();if(q.status(i.text),this.inHistoryNavigation=!0,this.setValue(i.text,!0),this.inHistoryNavigation=!1,this._onDidLoadInputState.fire(i.state),t)this._inputEditor.setPosition({lineNumber:1,column:1});else{const o=this._inputEditor.getModel();if(!o)return;this._inputEditor.setPosition(B(o))}}setValue(t,i){this.inputEditor.setValue(t),this.inputEditor.setPosition({lineNumber:1,column:t.length+1}),i||this.saveCurrentValue(this.getInputState())}saveCurrentValue(t){const i={text:this._inputEditor.getValue(),state:t};this.history.replaceLast(i)}focus(){this._inputEditor.focus()}hasFocus(){return this._inputEditor.hasWidgetFocus()}async acceptInput(t){if(t){const o={text:this._inputEditor.getValue(),state:this.getInputState()};this.history.replaceLast(o),this.history.add({text:""})}this._attachedContext.clear(),this._onDidLoadInputState.fire({}),this.accessibilityService.isScreenReaderOptimized()&&J?this._acceptInputForVoiceover():(this._inputEditor.focus(),this._inputEditor.setValue(""))}_acceptInputForVoiceover(){const t=this._inputEditor.getDomNode();t&&(t.remove(),this._inputEditor.setValue(""),this._inputEditorElement.appendChild(t),this._inputEditor.focus())}attachContext(t,...i){const o=[];if(t&&(o.push(...Array.from(this._attachedContext)),this._attachedContext.clear()),i.length>0)for(const e of i)this._attachedContext.add(e);(o.length>0||i.length>0)&&(this.initAttachedContext(this.attachedContextContainer),t||this._onDidChangeContext.fire({removed:o,added:i}))}render(t,i,o){this.container=d.append(t,g(".interactive-input-part")),this.container.classList.toggle("compact",this.options.renderStyle==="compact");let e,s;this.options.renderStyle==="compact"?(s=d.append(this.container,g(".interactive-input-and-side-toolbar")),this.followupsContainer=d.append(this.container,g(".interactive-input-followups")),e=d.append(s,g(".interactive-input-and-execute-toolbar")),this.attachedContextContainer=d.append(this.container,g(".chat-attached-context"))):(this.followupsContainer=d.append(this.container,g(".interactive-input-followups")),this.attachedContextContainer=d.append(this.container,g(".chat-attached-context")),s=d.append(this.container,g(".interactive-input-and-side-toolbar")),e=d.append(s,g(".interactive-input-and-execute-toolbar"))),this.initAttachedContext(this.attachedContextContainer);const l=this._register(this.contextKeyService.createScoped(e));Tt.bindTo(l).set(!0);const p=this._register(this.instantiationService.createChild(new ut([T,l]))),{historyNavigationBackwardsEnablement:f,historyNavigationForwardsEnablement:c}=this._register(ct(l,this));this.historyNavigationBackwardsEnablement=f,this.historyNavigationForewardsEnablement=c;const r=bt(this.configurationService);r.overflowWidgetsDomNode=this.options.editorOverflowWidgetsDomNode,r.readOnly=!1,r.ariaLabel=this._getAriaLabel(),r.fontFamily=k,r.fontSize=13,r.lineHeight=20,r.padding=this.options.renderStyle==="compact"?{top:2,bottom:2}:{top:8,bottom:8},r.cursorWidth=1,r.wrappingStrategy="advanced",r.bracketPairColorization={enabled:!1},r.suggest={showIcons:!1,showSnippets:!1,showWords:!0,showStatusBar:!1,insertMode:"replace"},r.scrollbar={...r.scrollbar??{},vertical:"hidden"},r.stickyScroll={enabled:!1},this._inputEditorElement=d.append(e,g(K));const C=Ct();if(C.contributions?.push(...Q.getSomeEditorContributions([et.ID,it.ID])),this._inputEditor=this._register(p.createInstance(Y,this._inputEditorElement,r,C)),this._register(this._inputEditor.onDidChangeModelContent(()=>{const n=Math.min(this._inputEditor.getContentHeight(),this.inputEditorMaxHeight);n!==this.inputEditorHeight&&(this.inputEditorHeight=n,this._onDidChangeHeight.fire());const y=this._inputEditor.getModel(),_=!!y&&y.getValue().trim().length>0;this.inputEditorHasText.set(_)})),this._register(this._inputEditor.onDidFocusEditorText(()=>{this.inputEditorHasFocus.set(!0),this._onDidFocus.fire(),e.classList.toggle("focused",!0)})),this._register(this._inputEditor.onDidBlurEditorText(()=>{this.inputEditorHasFocus.set(!1),e.classList.toggle("focused",!1),this._onDidBlur.fire()})),this.toolbar=this._register(this.instantiationService.createInstance(N,e,this.options.menus.executeToolbar,{telemetrySource:this.options.menus.telemetrySource,menuOptions:{shouldForwardArgs:!0},hiddenItemStrategy:rt.Ignore,actionViewItemProvider:(n,y)=>{if(this.location===It.Panel&&(n.id===Mt.ID||n.id===Dt.ID)&&n instanceof P){const _=this.instantiationService.createInstance(P,{id:"chat.moreExecuteActions",title:b("notebook.moreExecuteActionsLabel","More..."),icon:w.chevronDown},void 0,void 0,void 0,void 0);return this.instantiationService.createInstance(S,n,_)}}})),this.toolbar.getElement().classList.add("interactive-execute-toolbar"),this.toolbar.context={widget:o},this._register(this.toolbar.onDidChangeMenuItems(()=>{this.cachedDimensions&&typeof this.cachedToolbarWidth=="number"&&this.cachedToolbarWidth!==this.toolbar.getItemsWidth()&&this.layout(this.cachedDimensions.height,this.cachedDimensions.width)})),this.options.menus.inputSideToolbar){const n=this._register(this.instantiationService.createInstance(N,s,this.options.menus.inputSideToolbar,{telemetrySource:this.options.menus.telemetrySource,menuOptions:{shouldForwardArgs:!0}}));this.inputSideToolbarContainer=n.getElement(),n.getElement().classList.add("chat-side-toolbar"),n.context={widget:o}}let a=this.modelService.getModel(this.inputUri);if(a||(a=this.modelService.createModel("",null,this.inputUri,!0),this._register(a)),this.inputModel=a,this.inputModel.updateOptions({bracketColorizationOptions:{enabled:!1,independentColorPoolPerBracketType:!1}}),this._inputEditor.setModel(this.inputModel),i){this.inputModel.setValue(i);const n=this.inputModel.getLineCount();this._inputEditor.setPosition({lineNumber:n,column:this.inputModel.getLineMaxColumn(n)})}const u=()=>{const n=this._inputEditor.getModel();if(!n)return;const y=this._inputEditor.getPosition();if(!y)return;const _=y.column===1&&y.lineNumber===1;this.chatCursorAtTop.set(_),this.historyNavigationBackwardsEnablement.set(_),this.historyNavigationForewardsEnablement.set(y.equals(B(n)))};this._register(this._inputEditor.onDidChangeCursorPosition(n=>u())),u()}initAttachedContext(t,i=!1){const o=t.offsetHeight;d.clearNode(t),this.attachedContextDisposables.clear(),d.setVisibility(!!this.attachedContext.size,this.attachedContextContainer),this.attachedContext.size||(this._indexOfLastAttachedContextDeletedWithKeyboard=-1),[...this.attachedContext.values()].forEach((e,s)=>{const l=d.append(t,g(".chat-attached-context-attachment.show-file-icons")),p=this._contextResourceLabels.create(l,{supportIcons:!0}),f=H.isUri(e.value)?e.value:e.value&&typeof e.value=="object"&&"uri"in e.value&&H.isUri(e.value.uri)?e.value.uri:void 0,c=e.value&&typeof e.value=="object"&&"range"in e.value&&Z.isIRange(e.value.range)?e.value.range:void 0;if(f&&e.isFile){const a=X(f.path),u=G(f.path),n=`${a} ${u}`,y=c?b("chat.fileAttachmentWithRange","Attached file, {0}, line {1} to line {2}",n,c.startLineNumber,c.endLineNumber):b("chat.fileAttachment","Attached file, {0}",n);p.setFile(f,{fileKind:lt.FILE,hidePath:!0,range:c}),l.ariaLabel=y,l.tabIndex=0}else{const a=e.fullName??e.name,u=e.icon?.id?`$(${e.icon.id}) ${a}`:a;p.setLabel(u,void 0),l.ariaLabel=b("chat.attachment","Attached context, {0}",e.name),l.tabIndex=0}const r=new z(l,{supportIcons:!0});s===Math.min(this._indexOfLastAttachedContextDeletedWithKeyboard,this.attachedContext.size-1)&&r.focus(),this.attachedContextDisposables.add(r),r.icon=w.close;const C=r.onDidClick(a=>{if(this._attachedContext.delete(e),C.dispose(),d.isKeyboardEvent(a)){const u=new j(a);(u.equals(A.Enter)||u.equals(A.Space))&&(this._indexOfLastAttachedContextDeletedWithKeyboard=s)}this._onDidChangeHeight.fire(),this._onDidChangeContext.fire({removed:[e]})});this.attachedContextDisposables.add(C)}),o!==t.offsetHeight&&!i&&this._onDidChangeHeight.fire()}async renderFollowups(t,i){this.options.renderFollowups&&(this.followupsDisposables.clear(),d.clearNode(this.followupsContainer),t&&t.length>0&&this.followupsDisposables.add(this.instantiationService.createInstance(Lt,this.followupsContainer,t,this.location,void 0,o=>this._onDidAcceptFollowup.fire({followup:o,response:i}))),this._onDidChangeHeight.fire())}get contentHeight(){const t=this.getLayoutData();return t.followupsHeight+t.inputPartEditorHeight+t.inputPartVerticalPadding+t.inputEditorBorder+t.implicitContextHeight+t.executeToolbarHeight}layout(t,i){return this.cachedDimensions=new d.Dimension(i,t),this._layout(t,i)}previousInputEditorDimension;_layout(t,i,o=!0){this.initAttachedContext(this.attachedContextContainer,!0);const e=this.getLayoutData(),s=Math.min(e.inputPartEditorHeight,t-e.followupsHeight-e.inputPartVerticalPadding),l=i-e.inputPartHorizontalPadding;this.followupsContainer.style.width=`${l}px`,this._inputPartHeight=e.followupsHeight+s+e.inputPartVerticalPadding+e.inputEditorBorder+e.implicitContextHeight+e.executeToolbarHeight;const p=this._inputEditor.getScrollWidth(),c={width:i-e.inputPartHorizontalPadding-e.editorBorder-e.editorPadding-e.executeToolbarWidth-e.sideToolbarWidth,height:s};if((!this.previousInputEditorDimension||this.previousInputEditorDimension.width!==c.width||this.previousInputEditorDimension.height!==c.height)&&(this._inputEditor.layout(c),this.previousInputEditorDimension=c),o&&p<10)return this._layout(t,i,!1)}getLayoutData(){const t=this.cachedToolbarWidth=this.toolbar.getItemsWidth(),i=(this.toolbar.getItemsLength()-1)*4;return{inputEditorBorder:2,followupsHeight:this.followupsContainer.offsetHeight,inputPartEditorHeight:Math.min(this._inputEditor.getContentHeight(),this.inputEditorMaxHeight),inputPartHorizontalPadding:this.options.renderStyle==="compact"?12:40,inputPartVerticalPadding:this.options.renderStyle==="compact"?12:24,implicitContextHeight:this.attachedContextContainer.offsetHeight,editorBorder:2,editorPadding:12,executeToolbarWidth:this.options.renderStyle==="compact"?t+i:0,executeToolbarHeight:this.options.renderStyle==="compact"?0:22,sideToolbarWidth:this.inputSideToolbarContainer?d.getTotalWidth(this.inputSideToolbarContainer)+4:0}}saveState(){this.saveCurrentValue(this.getInputState());const t=[...this.history];this.historyService.saveHistory(this.location,t)}};I=x([h(3,wt),h(4,tt),h(5,pt),h(6,T),h(7,dt),h(8,F),h(9,L),h(10,mt)],I);const O=m=>JSON.stringify(m);function B(m){return{lineNumber:m.getLineCount(),column:m.getLineLength(m.getLineCount())+1}}let S=class extends ot{constructor(v,t,i,o,e,s,l,p,f,c){super(v,t,[],"",o,{getKeyBinding:a=>l.lookupKeybinding(a.id,s)},l,p,s,f,c);const r=i.createMenu(at.ChatExecuteSecondary,s),C=()=>{const a=[];nt(r,{shouldForwardArgs:!0},a);const u=e.getSecondaryAgent();u&&a.forEach(n=>(n.id===At.ID&&(n.label=b("chat.submitToSecondaryAgent","Send to @{0}",u.name)),n)),this.update(t,a)};C(),this._register(r.onDidChange(()=>C()))}};S=x([h(2,st),h(3,ht),h(4,_t),h(5,T),h(6,F),h(7,gt),h(8,ft),h(9,L)],S);const K=".interactive-input-editor";Et(K);export{I as ChatInputPart};
