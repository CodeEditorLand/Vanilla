{
  "version": 3,
  "sources": ["../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/contrib/chat/browser/codeBlockPart.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport \"./codeBlockPart.css\";\n\nimport * as dom from \"../../../../base/browser/dom.js\";\nimport { renderFormattedText } from \"../../../../base/browser/formattedTextRenderer.js\";\nimport { Button } from \"../../../../base/browser/ui/button/button.js\";\nimport type { CancellationToken } from \"../../../../base/common/cancellation.js\";\nimport { Codicon } from \"../../../../base/common/codicons.js\";\nimport { Emitter, Event } from \"../../../../base/common/event.js\";\nimport {\n\tDisposable,\n\tDisposableStore,\n\tMutableDisposable,\n\tcombinedDisposable,\n} from \"../../../../base/common/lifecycle.js\";\nimport { Schemas } from \"../../../../base/common/network.js\";\nimport { isEqual } from \"../../../../base/common/resources.js\";\nimport { assertType } from \"../../../../base/common/types.js\";\nimport { URI, type UriComponents } from \"../../../../base/common/uri.js\";\nimport type { IEditorConstructionOptions } from \"../../../../editor/browser/config/editorConfiguration.js\";\nimport { TabFocus } from \"../../../../editor/browser/config/tabFocus.js\";\nimport type { IDiffEditor } from \"../../../../editor/browser/editorBrowser.js\";\nimport { EditorExtensionsRegistry } from \"../../../../editor/browser/editorExtensions.js\";\nimport { ICodeEditorService } from \"../../../../editor/browser/services/codeEditorService.js\";\nimport {\n\tCodeEditorWidget,\n\ttype ICodeEditorWidgetOptions,\n} from \"../../../../editor/browser/widget/codeEditor/codeEditorWidget.js\";\nimport { DiffEditorWidget } from \"../../../../editor/browser/widget/diffEditor/diffEditorWidget.js\";\nimport {\n\tEDITOR_FONT_DEFAULTS,\n\tEditorOption,\n\ttype IEditorOptions,\n} from \"../../../../editor/common/config/editorOptions.js\";\nimport { type IRange, Range } from \"../../../../editor/common/core/range.js\";\nimport { ScrollType } from \"../../../../editor/common/editorCommon.js\";\nimport { TextEdit } from \"../../../../editor/common/languages.js\";\nimport {\n\tEndOfLinePreference,\n\ttype ITextModel,\n} from \"../../../../editor/common/model.js\";\nimport { TextModelText } from \"../../../../editor/common/model/textModelText.js\";\nimport { IModelService } from \"../../../../editor/common/services/model.js\";\nimport { DefaultModelSHA1Computer } from \"../../../../editor/common/services/modelService.js\";\nimport {\n\ttype IResolvedTextEditorModel,\n\ttype ITextModelContentProvider,\n\tITextModelService,\n} from \"../../../../editor/common/services/resolverService.js\";\nimport { BracketMatchingController } from \"../../../../editor/contrib/bracketMatching/browser/bracketMatching.js\";\nimport { ColorDetector } from \"../../../../editor/contrib/colorPicker/browser/colorDetector.js\";\nimport { ContextMenuController } from \"../../../../editor/contrib/contextmenu/browser/contextmenu.js\";\nimport { GotoDefinitionAtPositionEditorContribution } from \"../../../../editor/contrib/gotoSymbol/browser/link/goToDefinitionAtPosition.js\";\nimport { ContentHoverController } from \"../../../../editor/contrib/hover/browser/contentHoverController.js\";\nimport { GlyphHoverController } from \"../../../../editor/contrib/hover/browser/glyphHoverController.js\";\nimport { LinkDetector } from \"../../../../editor/contrib/links/browser/links.js\";\nimport { MessageController } from \"../../../../editor/contrib/message/browser/messageController.js\";\nimport { ViewportSemanticTokensContribution } from \"../../../../editor/contrib/semanticTokens/browser/viewportSemanticTokens.js\";\nimport { SmartSelectController } from \"../../../../editor/contrib/smartSelect/browser/smartSelect.js\";\nimport { WordHighlighterContribution } from \"../../../../editor/contrib/wordHighlighter/browser/wordHighlighter.js\";\nimport { localize } from \"../../../../nls.js\";\nimport { IAccessibilityService } from \"../../../../platform/accessibility/common/accessibility.js\";\nimport { MenuWorkbenchToolBar } from \"../../../../platform/actions/browser/toolbar.js\";\nimport type { MenuId } from \"../../../../platform/actions/common/actions.js\";\nimport { IConfigurationService } from \"../../../../platform/configuration/common/configuration.js\";\nimport { IContextKeyService } from \"../../../../platform/contextkey/common/contextkey.js\";\nimport { IDialogService } from \"../../../../platform/dialogs/common/dialogs.js\";\nimport { FileKind } from \"../../../../platform/files/common/files.js\";\nimport { IInstantiationService } from \"../../../../platform/instantiation/common/instantiation.js\";\nimport { ServiceCollection } from \"../../../../platform/instantiation/common/serviceCollection.js\";\nimport { ILabelService } from \"../../../../platform/label/common/label.js\";\nimport { IOpenerService } from \"../../../../platform/opener/common/opener.js\";\nimport { ResourceLabel } from \"../../../browser/labels.js\";\nimport { ResourceContextKey } from \"../../../common/contextkeys.js\";\nimport { AccessibilityVerbositySettingId } from \"../../accessibility/browser/accessibilityConfiguration.js\";\nimport { InspectEditorTokensController } from \"../../codeEditor/browser/inspectEditorTokens/inspectEditorTokens.js\";\nimport { MenuPreventer } from \"../../codeEditor/browser/menuPreventer.js\";\nimport { SelectionClipboardContributionID } from \"../../codeEditor/browser/selectionClipboard.js\";\nimport { getSimpleEditorOptions } from \"../../codeEditor/browser/simpleEditorOptions.js\";\nimport type { IMarkdownVulnerability } from \"../common/annotations.js\";\nimport { CONTEXT_CHAT_EDIT_APPLIED } from \"../common/chatContextKeys.js\";\nimport type {\n\tIChatResponseModel,\n\tIChatTextEditGroup,\n} from \"../common/chatModel.js\";\nimport {\n\ttype IChatResponseViewModel,\n\tisResponseVM,\n} from \"../common/chatViewModel.js\";\nimport type { ChatTreeItem } from \"./chat.js\";\nimport type { IChatRendererDelegate } from \"./chatListRenderer.js\";\nimport type { ChatEditorOptions } from \"./chatOptions.js\";\n\nconst $ = dom.$;\n\nexport interface ICodeBlockData {\n\treadonly codeBlockIndex: number;\n\treadonly element: unknown;\n\n\treadonly textModel: Promise<IResolvedTextEditorModel>;\n\treadonly languageId: string;\n\n\treadonly codemapperUri?: URI;\n\n\treadonly vulns?: readonly IMarkdownVulnerability[];\n\treadonly range?: Range;\n\n\treadonly parentContextKeyService?: IContextKeyService;\n\treadonly hideToolbar?: boolean;\n}\n\n/**\n * Special markdown code block language id used to render a local file.\n *\n * The text of the code path should be a {@link LocalFileCodeBlockData} json object.\n */\nexport const localFileLanguageId = \"vscode-local-file\";\n\nexport function parseLocalFileData(text: string) {\n\tinterface RawLocalFileCodeBlockData {\n\t\treadonly uri: UriComponents;\n\t\treadonly range?: IRange;\n\t}\n\n\tlet data: RawLocalFileCodeBlockData;\n\ttry {\n\t\tdata = JSON.parse(text);\n\t} catch (e) {\n\t\tthrow new Error(\"Could not parse code block local file data\");\n\t}\n\n\tlet uri: URI;\n\ttry {\n\t\turi = URI.revive(data?.uri);\n\t} catch (e) {\n\t\tthrow new Error(\"Invalid code block local file data URI\");\n\t}\n\n\tlet range: IRange | undefined;\n\tif (data.range) {\n\t\t// Note that since this is coming from extensions, position are actually zero based and must be converted.\n\t\trange = new Range(\n\t\t\tdata.range.startLineNumber + 1,\n\t\t\tdata.range.startColumn + 1,\n\t\t\tdata.range.endLineNumber + 1,\n\t\t\tdata.range.endColumn + 1,\n\t\t);\n\t}\n\n\treturn { uri, range };\n}\n\nexport interface ICodeBlockActionContext {\n\tcode: string;\n\tcodemapperUri?: URI;\n\tlanguageId?: string;\n\tcodeBlockIndex: number;\n\telement: unknown;\n}\n\nconst defaultCodeblockPadding = 10;\nexport class CodeBlockPart extends Disposable {\n\tprotected readonly _onDidChangeContentHeight = this._register(\n\t\tnew Emitter<void>(),\n\t);\n\tpublic readonly onDidChangeContentHeight =\n\t\tthis._onDidChangeContentHeight.event;\n\n\tpublic readonly editor: CodeEditorWidget;\n\tprotected readonly toolbar: MenuWorkbenchToolBar;\n\tprivate readonly contextKeyService: IContextKeyService;\n\n\tpublic readonly element: HTMLElement;\n\n\tprivate readonly vulnsButton: Button;\n\tprivate readonly vulnsListElement: HTMLElement;\n\n\tprivate currentCodeBlockData: ICodeBlockData | undefined;\n\tprivate currentScrollWidth = 0;\n\n\tprivate readonly disposableStore = this._register(new DisposableStore());\n\tprivate isDisposed = false;\n\n\tprivate resourceContextKey: ResourceContextKey;\n\n\tconstructor(\n\t\tprivate readonly options: ChatEditorOptions,\n\t\treadonly menuId: MenuId,\n\t\tdelegate: IChatRendererDelegate,\n\t\toverflowWidgetsDomNode: HTMLElement | undefined,\n\t\t@IInstantiationService instantiationService: IInstantiationService,\n\t\t@IContextKeyService contextKeyService: IContextKeyService,\n\t\t@IModelService protected readonly modelService: IModelService,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService,\n\t\t@IAccessibilityService private readonly accessibilityService: IAccessibilityService,\n\t) {\n\t\tsuper();\n\t\tthis.element = $('.interactive-result-code-block');\n\n\t\tthis.resourceContextKey = this._register(instantiationService.createInstance(ResourceContextKey));\n\t\tthis.contextKeyService = this._register(contextKeyService.createScoped(this.element));\n\t\tconst scopedInstantiationService = this._register(instantiationService.createChild(new ServiceCollection([IContextKeyService, this.contextKeyService])));\n\t\tconst editorElement = dom.append(this.element, $('.interactive-result-editor'));\n\t\tthis.editor = this.createEditor(scopedInstantiationService, editorElement, {\n\t\t\t...getSimpleEditorOptions(this.configurationService),\n\t\t\treadOnly: true,\n\t\t\tlineNumbers: 'off',\n\t\t\tselectOnLineNumbers: true,\n\t\t\tscrollBeyondLastLine: false,\n\t\t\tlineDecorationsWidth: 8,\n\t\t\tdragAndDrop: false,\n\t\t\tpadding: { top: defaultCodeblockPadding, bottom: defaultCodeblockPadding },\n\t\t\tmouseWheelZoom: false,\n\t\t\tscrollbar: {\n\t\t\t\tvertical: 'hidden',\n\t\t\t\talwaysConsumeMouseWheel: false\n\t\t\t},\n\t\t\tdefinitionLinkOpensInPeek: false,\n\t\t\tgotoLocation: {\n\t\t\t\tmultiple: 'goto',\n\t\t\t\tmultipleDeclarations: 'goto',\n\t\t\t\tmultipleDefinitions: 'goto',\n\t\t\t\tmultipleImplementations: 'goto',\n\t\t\t},\n\t\t\tariaLabel: localize('chat.codeBlockHelp', 'Code block'),\n\t\t\toverflowWidgetsDomNode,\n\t\t\t...this.getEditorOptionsFromConfig(),\n\t\t});\n\n\t\tconst toolbarElement = dom.append(this.element, $('.interactive-result-code-block-toolbar'));\n\t\tconst editorScopedService = this.editor.contextKeyService.createScoped(toolbarElement);\n\t\tconst editorScopedInstantiationService = this._register(scopedInstantiationService.createChild(new ServiceCollection([IContextKeyService, editorScopedService])));\n\t\tthis.toolbar = this._register(editorScopedInstantiationService.createInstance(MenuWorkbenchToolBar, toolbarElement, menuId, {\n\t\t\tmenuOptions: {\n\t\t\t\tshouldForwardArgs: true\n\t\t\t}\n\t\t}));\n\n\t\tconst vulnsContainer = dom.append(this.element, $('.interactive-result-vulns'));\n\t\tconst vulnsHeaderElement = dom.append(vulnsContainer, $('.interactive-result-vulns-header', undefined));\n\t\tthis.vulnsButton = this._register(new Button(vulnsHeaderElement, {\n\t\t\tbuttonBackground: undefined,\n\t\t\tbuttonBorder: undefined,\n\t\t\tbuttonForeground: undefined,\n\t\t\tbuttonHoverBackground: undefined,\n\t\t\tbuttonSecondaryBackground: undefined,\n\t\t\tbuttonSecondaryForeground: undefined,\n\t\t\tbuttonSecondaryHoverBackground: undefined,\n\t\t\tbuttonSeparator: undefined,\n\t\t\tsupportIcons: true\n\t\t}));\n\n\t\tthis.vulnsListElement = dom.append(vulnsContainer, $('ul.interactive-result-vulns-list'));\n\n\t\tthis._register(this.vulnsButton.onDidClick(() => {\n\t\t\tconst element = this.currentCodeBlockData!.element as IChatResponseViewModel;\n\t\t\telement.vulnerabilitiesListExpanded = !element.vulnerabilitiesListExpanded;\n\t\t\tthis.vulnsButton.label = this.getVulnerabilitiesLabel();\n\t\t\tthis.element.classList.toggle('chat-vulnerabilities-collapsed', !element.vulnerabilitiesListExpanded);\n\t\t\tthis._onDidChangeContentHeight.fire();\n\t\t\t// this.updateAriaLabel(collapseButton.element, referencesLabel, element.usedReferencesExpanded);\n\t\t}));\n\n\t\tthis._register(this.toolbar.onDidChangeDropdownVisibility(e => {\n\t\t\ttoolbarElement.classList.toggle('force-visibility', e);\n\t\t}));\n\n\t\tthis._configureForScreenReader();\n\t\tthis._register(this.accessibilityService.onDidChangeScreenReaderOptimized(() => this._configureForScreenReader()));\n\t\tthis._register(this.configurationService.onDidChangeConfiguration((e) => {\n\t\t\tif (e.affectedKeys.has(AccessibilityVerbositySettingId.Chat)) {\n\t\t\t\tthis._configureForScreenReader();\n\t\t\t}\n\t\t}));\n\n\t\tthis._register(this.options.onDidChange(() => {\n\t\t\tthis.editor.updateOptions(this.getEditorOptionsFromConfig());\n\t\t}));\n\n\t\tthis._register(this.editor.onDidScrollChange(e => {\n\t\t\tthis.currentScrollWidth = e.scrollWidth;\n\t\t}));\n\t\tthis._register(this.editor.onDidContentSizeChange(e => {\n\t\t\tif (e.contentHeightChanged) {\n\t\t\t\tthis._onDidChangeContentHeight.fire();\n\t\t\t}\n\t\t}));\n\t\tthis._register(this.editor.onDidBlurEditorWidget(() => {\n\t\t\tthis.element.classList.remove('focused');\n\t\t\tWordHighlighterContribution.get(this.editor)?.stopHighlighting();\n\t\t\tthis.clearWidgets();\n\t\t}));\n\t\tthis._register(this.editor.onDidFocusEditorWidget(() => {\n\t\t\tthis.element.classList.add('focused');\n\t\t\tWordHighlighterContribution.get(this.editor)?.restoreViewState(true);\n\t\t}));\n\n\t\t// Parent list scrolled\n\t\tif (delegate.onDidScroll) {\n\t\t\tthis._register(delegate.onDidScroll(e => {\n\t\t\t\tthis.clearWidgets();\n\t\t\t}));\n\t\t}\n\t}\n\n\toverride dispose() {\n\t\tthis.isDisposed = true;\n\t\tsuper.dispose();\n\t}\n\n\tget uri(): URI | undefined {\n\t\treturn this.editor.getModel()?.uri;\n\t}\n\n\tprivate createEditor(\n\t\tinstantiationService: IInstantiationService,\n\t\tparent: HTMLElement,\n\t\toptions: Readonly<IEditorConstructionOptions>,\n\t): CodeEditorWidget {\n\t\treturn this._register(\n\t\t\tinstantiationService.createInstance(\n\t\t\t\tCodeEditorWidget,\n\t\t\t\tparent,\n\t\t\t\toptions,\n\t\t\t\t{\n\t\t\t\t\tisSimpleWidget: false,\n\t\t\t\t\tcontributions:\n\t\t\t\t\t\tEditorExtensionsRegistry.getSomeEditorContributions([\n\t\t\t\t\t\t\tMenuPreventer.ID,\n\t\t\t\t\t\t\tSelectionClipboardContributionID,\n\t\t\t\t\t\t\tContextMenuController.ID,\n\n\t\t\t\t\t\t\tWordHighlighterContribution.ID,\n\t\t\t\t\t\t\tViewportSemanticTokensContribution.ID,\n\t\t\t\t\t\t\tBracketMatchingController.ID,\n\t\t\t\t\t\t\tSmartSelectController.ID,\n\t\t\t\t\t\t\tContentHoverController.ID,\n\t\t\t\t\t\t\tGlyphHoverController.ID,\n\t\t\t\t\t\t\tMessageController.ID,\n\t\t\t\t\t\t\tGotoDefinitionAtPositionEditorContribution.ID,\n\t\t\t\t\t\t\tColorDetector.ID,\n\t\t\t\t\t\t\tLinkDetector.ID,\n\n\t\t\t\t\t\t\tInspectEditorTokensController.ID,\n\t\t\t\t\t\t]),\n\t\t\t\t},\n\t\t\t),\n\t\t);\n\t}\n\n\tfocus(): void {\n\t\tthis.editor.focus();\n\t}\n\n\tprivate updatePaddingForLayout() {\n\t\t// scrollWidth = \"the width of the content that needs to be scrolled\"\n\t\t// contentWidth = \"the width of the area where content is displayed\"\n\t\tconst horizontalScrollbarVisible =\n\t\t\tthis.currentScrollWidth > this.editor.getLayoutInfo().contentWidth;\n\t\tconst scrollbarHeight =\n\t\t\tthis.editor.getLayoutInfo().horizontalScrollbarHeight;\n\t\tconst bottomPadding = horizontalScrollbarVisible\n\t\t\t? Math.max(defaultCodeblockPadding - scrollbarHeight, 2)\n\t\t\t: defaultCodeblockPadding;\n\t\tthis.editor.updateOptions({\n\t\t\tpadding: { top: defaultCodeblockPadding, bottom: bottomPadding },\n\t\t});\n\t}\n\n\tprivate _configureForScreenReader(): void {\n\t\tconst toolbarElt = this.toolbar.getElement();\n\t\tif (this.accessibilityService.isScreenReaderOptimized()) {\n\t\t\ttoolbarElt.style.display = \"block\";\n\t\t\ttoolbarElt.ariaLabel = this.configurationService.getValue(\n\t\t\t\tAccessibilityVerbositySettingId.Chat,\n\t\t\t)\n\t\t\t\t? localize(\n\t\t\t\t\t\t\"chat.codeBlock.toolbarVerbose\",\n\t\t\t\t\t\t\"Toolbar for code block which can be reached via tab\",\n\t\t\t\t\t)\n\t\t\t\t: localize(\"chat.codeBlock.toolbar\", \"Code block toolbar\");\n\t\t} else {\n\t\t\ttoolbarElt.style.display = \"\";\n\t\t}\n\t}\n\n\tprivate getEditorOptionsFromConfig(): IEditorOptions {\n\t\treturn {\n\t\t\twordWrap: this.options.configuration.resultEditor.wordWrap,\n\t\t\tfontLigatures:\n\t\t\t\tthis.options.configuration.resultEditor.fontLigatures,\n\t\t\tbracketPairColorization:\n\t\t\t\tthis.options.configuration.resultEditor.bracketPairColorization,\n\t\t\tfontFamily:\n\t\t\t\tthis.options.configuration.resultEditor.fontFamily === \"default\"\n\t\t\t\t\t? EDITOR_FONT_DEFAULTS.fontFamily\n\t\t\t\t\t: this.options.configuration.resultEditor.fontFamily,\n\t\t\tfontSize: this.options.configuration.resultEditor.fontSize,\n\t\t\tfontWeight: this.options.configuration.resultEditor.fontWeight,\n\t\t\tlineHeight: this.options.configuration.resultEditor.lineHeight,\n\t\t};\n\t}\n\n\tlayout(width: number): void {\n\t\tconst contentHeight = this.getContentHeight();\n\t\tconst editorBorder = 2;\n\t\tthis.editor.layout({\n\t\t\twidth: width - editorBorder,\n\t\t\theight: contentHeight,\n\t\t});\n\t\tthis.updatePaddingForLayout();\n\t}\n\n\tprivate getContentHeight() {\n\t\tif (this.currentCodeBlockData?.range) {\n\t\t\tconst lineCount =\n\t\t\t\tthis.currentCodeBlockData.range.endLineNumber -\n\t\t\t\tthis.currentCodeBlockData.range.startLineNumber +\n\t\t\t\t1;\n\t\t\tconst lineHeight = this.editor.getOption(EditorOption.lineHeight);\n\t\t\treturn lineCount * lineHeight;\n\t\t}\n\t\treturn this.editor.getContentHeight();\n\t}\n\n\tasync render(\n\t\tdata: ICodeBlockData,\n\t\twidth: number,\n\t\teditable: boolean | undefined,\n\t) {\n\t\tthis.currentCodeBlockData = data;\n\t\tif (data.parentContextKeyService) {\n\t\t\tthis.contextKeyService.updateParent(data.parentContextKeyService);\n\t\t}\n\n\t\tif (this.options.configuration.resultEditor.wordWrap === \"on\") {\n\t\t\t// Initialize the editor with the new proper width so that getContentHeight\n\t\t\t// will be computed correctly in the next call to layout()\n\t\t\tthis.layout(width);\n\t\t}\n\n\t\tawait this.updateEditor(data);\n\t\tif (this.isDisposed) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.layout(width);\n\t\tif (editable) {\n\t\t\tthis.disposableStore.clear();\n\t\t\tthis.disposableStore.add(\n\t\t\t\tthis.editor.onDidFocusEditorWidget(() =>\n\t\t\t\t\tTabFocus.setTabFocusMode(true),\n\t\t\t\t),\n\t\t\t);\n\t\t\tthis.disposableStore.add(\n\t\t\t\tthis.editor.onDidBlurEditorWidget(() =>\n\t\t\t\t\tTabFocus.setTabFocusMode(false),\n\t\t\t\t),\n\t\t\t);\n\t\t}\n\t\tthis.editor.updateOptions({\n\t\t\tariaLabel: localize(\n\t\t\t\t\"chat.codeBlockLabel\",\n\t\t\t\t\"Code block {0}\",\n\t\t\t\tdata.codeBlockIndex + 1,\n\t\t\t),\n\t\t\treadOnly: !editable,\n\t\t});\n\n\t\tif (data.hideToolbar) {\n\t\t\tdom.hide(this.toolbar.getElement());\n\t\t} else {\n\t\t\tdom.show(this.toolbar.getElement());\n\t\t}\n\n\t\tif (data.vulns?.length && isResponseVM(data.element)) {\n\t\t\tdom.clearNode(this.vulnsListElement);\n\t\t\tthis.element.classList.remove(\"no-vulns\");\n\t\t\tthis.element.classList.toggle(\n\t\t\t\t\"chat-vulnerabilities-collapsed\",\n\t\t\t\t!data.element.vulnerabilitiesListExpanded,\n\t\t\t);\n\t\t\tdom.append(\n\t\t\t\tthis.vulnsListElement,\n\t\t\t\t...data.vulns.map((v) =>\n\t\t\t\t\t$(\n\t\t\t\t\t\t\"li\",\n\t\t\t\t\t\tundefined,\n\t\t\t\t\t\t$(\"span.chat-vuln-title\", undefined, v.title),\n\t\t\t\t\t\t\" \" + v.description,\n\t\t\t\t\t),\n\t\t\t\t),\n\t\t\t);\n\t\t\tthis.vulnsButton.label = this.getVulnerabilitiesLabel();\n\t\t} else {\n\t\t\tthis.element.classList.add(\"no-vulns\");\n\t\t}\n\t}\n\n\treset() {\n\t\tthis.clearWidgets();\n\t}\n\n\tprivate clearWidgets() {\n\t\tContentHoverController.get(this.editor)?.hideContentHover();\n\t\tGlyphHoverController.get(this.editor)?.hideContentHover();\n\t}\n\n\tprivate async updateEditor(data: ICodeBlockData): Promise<void> {\n\t\tconst textModel = (await data.textModel).textEditorModel;\n\t\tthis.editor.setModel(textModel);\n\t\tif (data.range) {\n\t\t\tthis.editor.setSelection(data.range);\n\t\t\tthis.editor.revealRangeInCenter(data.range, ScrollType.Immediate);\n\t\t}\n\n\t\tthis.toolbar.context = {\n\t\t\tcode: textModel\n\t\t\t\t.getTextBuffer()\n\t\t\t\t.getValueInRange(\n\t\t\t\t\tdata.range ?? textModel.getFullModelRange(),\n\t\t\t\t\tEndOfLinePreference.TextDefined,\n\t\t\t\t),\n\t\t\tcodeBlockIndex: data.codeBlockIndex,\n\t\t\telement: data.element,\n\t\t\tlanguageId: textModel.getLanguageId(),\n\t\t\tcodemapperUri: data.codemapperUri,\n\t\t} satisfies ICodeBlockActionContext;\n\t\tthis.resourceContextKey.set(textModel.uri);\n\t}\n\n\tprivate getVulnerabilitiesLabel(): string {\n\t\tif (!this.currentCodeBlockData || !this.currentCodeBlockData.vulns) {\n\t\t\treturn \"\";\n\t\t}\n\n\t\tconst referencesLabel =\n\t\t\tthis.currentCodeBlockData.vulns.length > 1\n\t\t\t\t? localize(\n\t\t\t\t\t\t\"vulnerabilitiesPlural\",\n\t\t\t\t\t\t\"{0} vulnerabilities\",\n\t\t\t\t\t\tthis.currentCodeBlockData.vulns.length,\n\t\t\t\t\t)\n\t\t\t\t: localize(\"vulnerabilitiesSingular\", \"{0} vulnerability\", 1);\n\t\tconst icon = (element: IChatResponseViewModel) =>\n\t\t\telement.vulnerabilitiesListExpanded\n\t\t\t\t? Codicon.chevronDown\n\t\t\t\t: Codicon.chevronRight;\n\t\treturn `${referencesLabel} $(${icon(this.currentCodeBlockData.element as IChatResponseViewModel).id})`;\n\t}\n}\n\nexport class ChatCodeBlockContentProvider\n\textends Disposable\n\timplements ITextModelContentProvider\n{\n\tconstructor(\n\t\t@ITextModelService textModelService: ITextModelService,\n\t\t@IModelService private readonly _modelService: IModelService,\n\t) {\n\t\tsuper();\n\t\tthis._register(textModelService.registerTextModelContentProvider(Schemas.vscodeChatCodeBlock, this));\n\t}\n\n\tasync provideTextContent(resource: URI): Promise<ITextModel | null> {\n\t\tconst existing = this._modelService.getModel(resource);\n\t\tif (existing) {\n\t\t\treturn existing;\n\t\t}\n\t\treturn this._modelService.createModel(\"\", null, resource);\n\t}\n}\n\n//\n\nexport interface ICodeCompareBlockActionContext {\n\treadonly element: IChatResponseViewModel;\n\treadonly diffEditor: IDiffEditor;\n\treadonly edit: IChatTextEditGroup;\n}\n\nexport interface ICodeCompareBlockDiffData {\n\tmodified: ITextModel;\n\toriginal: ITextModel;\n\toriginalSha1: string;\n}\n\nexport interface ICodeCompareBlockData {\n\treadonly element: ChatTreeItem;\n\n\treadonly edit: IChatTextEditGroup;\n\n\treadonly diffData: Promise<ICodeCompareBlockDiffData | undefined>;\n\n\treadonly parentContextKeyService?: IContextKeyService;\n\t// readonly hideToolbar?: boolean;\n}\n\n// long-lived object that sits in the DiffPool and that gets reused\nexport class CodeCompareBlockPart extends Disposable {\n\tprotected readonly _onDidChangeContentHeight = this._register(\n\t\tnew Emitter<void>(),\n\t);\n\tpublic readonly onDidChangeContentHeight =\n\t\tthis._onDidChangeContentHeight.event;\n\n\tprivate readonly contextKeyService: IContextKeyService;\n\tprivate readonly diffEditor: DiffEditorWidget;\n\tprivate readonly resourceLabel: ResourceLabel;\n\tprivate readonly toolbar: MenuWorkbenchToolBar;\n\treadonly element: HTMLElement;\n\tprivate readonly messageElement: HTMLElement;\n\n\tprivate readonly _lastDiffEditorViewModel = this._store.add(\n\t\tnew MutableDisposable(),\n\t);\n\tprivate currentScrollWidth = 0;\n\n\tconstructor(\n\t\tprivate readonly options: ChatEditorOptions,\n\t\treadonly menuId: MenuId,\n\t\tdelegate: IChatRendererDelegate,\n\t\toverflowWidgetsDomNode: HTMLElement | undefined,\n\t\t@IInstantiationService instantiationService: IInstantiationService,\n\t\t@IContextKeyService contextKeyService: IContextKeyService,\n\t\t@IModelService protected readonly modelService: IModelService,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService,\n\t\t@IAccessibilityService private readonly accessibilityService: IAccessibilityService,\n\t\t@ILabelService private readonly labelService: ILabelService,\n\t\t@IOpenerService private readonly openerService: IOpenerService,\n\t) {\n\t\tsuper();\n\t\tthis.element = $('.interactive-result-code-block');\n\t\tthis.element.classList.add('compare');\n\n\t\tthis.messageElement = dom.append(this.element, $('.message'));\n\t\tthis.messageElement.setAttribute('role', 'status');\n\t\tthis.messageElement.tabIndex = 0;\n\n\t\tthis.contextKeyService = this._register(contextKeyService.createScoped(this.element));\n\t\tconst scopedInstantiationService = this._register(instantiationService.createChild(new ServiceCollection([IContextKeyService, this.contextKeyService])));\n\t\tconst editorHeader = dom.append(this.element, $('.interactive-result-header.show-file-icons'));\n\t\tconst editorElement = dom.append(this.element, $('.interactive-result-editor'));\n\t\tthis.diffEditor = this.createDiffEditor(scopedInstantiationService, editorElement, {\n\t\t\t...getSimpleEditorOptions(this.configurationService),\n\t\t\tlineNumbers: 'on',\n\t\t\tselectOnLineNumbers: true,\n\t\t\tscrollBeyondLastLine: false,\n\t\t\tlineDecorationsWidth: 12,\n\t\t\tdragAndDrop: false,\n\t\t\tpadding: { top: defaultCodeblockPadding, bottom: defaultCodeblockPadding },\n\t\t\tmouseWheelZoom: false,\n\t\t\tscrollbar: {\n\t\t\t\tvertical: 'hidden',\n\t\t\t\talwaysConsumeMouseWheel: false\n\t\t\t},\n\t\t\tdefinitionLinkOpensInPeek: false,\n\t\t\tgotoLocation: {\n\t\t\t\tmultiple: 'goto',\n\t\t\t\tmultipleDeclarations: 'goto',\n\t\t\t\tmultipleDefinitions: 'goto',\n\t\t\t\tmultipleImplementations: 'goto',\n\t\t\t},\n\t\t\tariaLabel: localize('chat.codeBlockHelp', 'Code block'),\n\t\t\toverflowWidgetsDomNode,\n\t\t\t...this.getEditorOptionsFromConfig(),\n\t\t});\n\n\t\tthis.resourceLabel = this._register(scopedInstantiationService.createInstance(ResourceLabel, editorHeader, { supportIcons: true }));\n\n\t\tconst editorScopedService = this.diffEditor.getModifiedEditor().contextKeyService.createScoped(editorHeader);\n\t\tconst editorScopedInstantiationService = this._register(scopedInstantiationService.createChild(new ServiceCollection([IContextKeyService, editorScopedService])));\n\t\tthis.toolbar = this._register(editorScopedInstantiationService.createInstance(MenuWorkbenchToolBar, editorHeader, menuId, {\n\t\t\tmenuOptions: {\n\t\t\t\tshouldForwardArgs: true\n\t\t\t}\n\t\t}));\n\n\t\tthis._configureForScreenReader();\n\t\tthis._register(this.accessibilityService.onDidChangeScreenReaderOptimized(() => this._configureForScreenReader()));\n\t\tthis._register(this.configurationService.onDidChangeConfiguration((e) => {\n\t\t\tif (e.affectedKeys.has(AccessibilityVerbositySettingId.Chat)) {\n\t\t\t\tthis._configureForScreenReader();\n\t\t\t}\n\t\t}));\n\n\t\tthis._register(this.options.onDidChange(() => {\n\t\t\tthis.diffEditor.updateOptions(this.getEditorOptionsFromConfig());\n\t\t}));\n\n\t\tthis._register(this.diffEditor.getModifiedEditor().onDidScrollChange(e => {\n\t\t\tthis.currentScrollWidth = e.scrollWidth;\n\t\t}));\n\t\tthis._register(this.diffEditor.onDidContentSizeChange(e => {\n\t\t\tif (e.contentHeightChanged) {\n\t\t\t\tthis._onDidChangeContentHeight.fire();\n\t\t\t}\n\t\t}));\n\t\tthis._register(this.diffEditor.getModifiedEditor().onDidBlurEditorWidget(() => {\n\t\t\tthis.element.classList.remove('focused');\n\t\t\tWordHighlighterContribution.get(this.diffEditor.getModifiedEditor())?.stopHighlighting();\n\t\t\tthis.clearWidgets();\n\t\t}));\n\t\tthis._register(this.diffEditor.getModifiedEditor().onDidFocusEditorWidget(() => {\n\t\t\tthis.element.classList.add('focused');\n\t\t\tWordHighlighterContribution.get(this.diffEditor.getModifiedEditor())?.restoreViewState(true);\n\t\t}));\n\n\n\t\t// Parent list scrolled\n\t\tif (delegate.onDidScroll) {\n\t\t\tthis._register(delegate.onDidScroll(e => {\n\t\t\t\tthis.clearWidgets();\n\t\t\t}));\n\t\t}\n\t}\n\n\tget uri(): URI | undefined {\n\t\treturn this.diffEditor.getModifiedEditor().getModel()?.uri;\n\t}\n\n\tprivate createDiffEditor(\n\t\tinstantiationService: IInstantiationService,\n\t\tparent: HTMLElement,\n\t\toptions: Readonly<IEditorConstructionOptions>,\n\t): DiffEditorWidget {\n\t\tconst widgetOptions: ICodeEditorWidgetOptions = {\n\t\t\tisSimpleWidget: false,\n\t\t\tcontributions: EditorExtensionsRegistry.getSomeEditorContributions([\n\t\t\t\tMenuPreventer.ID,\n\t\t\t\tSelectionClipboardContributionID,\n\t\t\t\tContextMenuController.ID,\n\n\t\t\t\tWordHighlighterContribution.ID,\n\t\t\t\tViewportSemanticTokensContribution.ID,\n\t\t\t\tBracketMatchingController.ID,\n\t\t\t\tSmartSelectController.ID,\n\t\t\t\tContentHoverController.ID,\n\t\t\t\tGlyphHoverController.ID,\n\t\t\t\tGotoDefinitionAtPositionEditorContribution.ID,\n\t\t\t]),\n\t\t};\n\n\t\treturn this._register(\n\t\t\tinstantiationService.createInstance(\n\t\t\t\tDiffEditorWidget,\n\t\t\t\tparent,\n\t\t\t\t{\n\t\t\t\t\tscrollbar: {\n\t\t\t\t\t\tuseShadows: false,\n\t\t\t\t\t\talwaysConsumeMouseWheel: false,\n\t\t\t\t\t\tignoreHorizontalScrollbarInContentHeight: true,\n\t\t\t\t\t},\n\t\t\t\t\trenderMarginRevertIcon: false,\n\t\t\t\t\tdiffCodeLens: false,\n\t\t\t\t\tscrollBeyondLastLine: false,\n\t\t\t\t\tstickyScroll: { enabled: false },\n\t\t\t\t\toriginalAriaLabel: localize(\"original\", \"Original\"),\n\t\t\t\t\tmodifiedAriaLabel: localize(\"modified\", \"Modified\"),\n\t\t\t\t\tdiffAlgorithm: \"advanced\",\n\t\t\t\t\treadOnly: false,\n\t\t\t\t\tisInEmbeddedEditor: true,\n\t\t\t\t\tuseInlineViewWhenSpaceIsLimited: true,\n\t\t\t\t\texperimental: {\n\t\t\t\t\t\tuseTrueInlineView: true,\n\t\t\t\t\t},\n\t\t\t\t\trenderSideBySideInlineBreakpoint: 300,\n\t\t\t\t\trenderOverviewRuler: false,\n\t\t\t\t\tcompactMode: true,\n\t\t\t\t\thideUnchangedRegions: {\n\t\t\t\t\t\tenabled: true,\n\t\t\t\t\t\tcontextLineCount: 1,\n\t\t\t\t\t},\n\t\t\t\t\trenderGutterMenu: false,\n\t\t\t\t\tlineNumbersMinChars: 1,\n\t\t\t\t\t...options,\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\toriginalEditor: widgetOptions,\n\t\t\t\t\tmodifiedEditor: widgetOptions,\n\t\t\t\t},\n\t\t\t),\n\t\t);\n\t}\n\n\tfocus(): void {\n\t\tthis.diffEditor.focus();\n\t}\n\n\tprivate updatePaddingForLayout() {\n\t\t// scrollWidth = \"the width of the content that needs to be scrolled\"\n\t\t// contentWidth = \"the width of the area where content is displayed\"\n\t\tconst horizontalScrollbarVisible =\n\t\t\tthis.currentScrollWidth >\n\t\t\tthis.diffEditor.getModifiedEditor().getLayoutInfo().contentWidth;\n\t\tconst scrollbarHeight = this.diffEditor\n\t\t\t.getModifiedEditor()\n\t\t\t.getLayoutInfo().horizontalScrollbarHeight;\n\t\tconst bottomPadding = horizontalScrollbarVisible\n\t\t\t? Math.max(defaultCodeblockPadding - scrollbarHeight, 2)\n\t\t\t: defaultCodeblockPadding;\n\t\tthis.diffEditor.updateOptions({\n\t\t\tpadding: { top: defaultCodeblockPadding, bottom: bottomPadding },\n\t\t});\n\t}\n\n\tprivate _configureForScreenReader(): void {\n\t\tconst toolbarElt = this.toolbar.getElement();\n\t\tif (this.accessibilityService.isScreenReaderOptimized()) {\n\t\t\ttoolbarElt.style.display = \"block\";\n\t\t\ttoolbarElt.ariaLabel = this.configurationService.getValue(\n\t\t\t\tAccessibilityVerbositySettingId.Chat,\n\t\t\t)\n\t\t\t\t? localize(\n\t\t\t\t\t\t\"chat.codeBlock.toolbarVerbose\",\n\t\t\t\t\t\t\"Toolbar for code block which can be reached via tab\",\n\t\t\t\t\t)\n\t\t\t\t: localize(\"chat.codeBlock.toolbar\", \"Code block toolbar\");\n\t\t} else {\n\t\t\ttoolbarElt.style.display = \"\";\n\t\t}\n\t}\n\n\tprivate getEditorOptionsFromConfig(): IEditorOptions {\n\t\treturn {\n\t\t\twordWrap: this.options.configuration.resultEditor.wordWrap,\n\t\t\tfontLigatures:\n\t\t\t\tthis.options.configuration.resultEditor.fontLigatures,\n\t\t\tbracketPairColorization:\n\t\t\t\tthis.options.configuration.resultEditor.bracketPairColorization,\n\t\t\tfontFamily:\n\t\t\t\tthis.options.configuration.resultEditor.fontFamily === \"default\"\n\t\t\t\t\t? EDITOR_FONT_DEFAULTS.fontFamily\n\t\t\t\t\t: this.options.configuration.resultEditor.fontFamily,\n\t\t\tfontSize: this.options.configuration.resultEditor.fontSize,\n\t\t\tfontWeight: this.options.configuration.resultEditor.fontWeight,\n\t\t\tlineHeight: this.options.configuration.resultEditor.lineHeight,\n\t\t};\n\t}\n\n\tlayout(width: number): void {\n\t\tconst contentHeight = this.getContentHeight();\n\t\tconst editorBorder = 2;\n\t\tconst dimension = {\n\t\t\twidth: width - editorBorder,\n\t\t\theight: contentHeight,\n\t\t};\n\t\tthis.element.style.height = `${dimension.height}px`;\n\t\tthis.element.style.width = `${dimension.width}px`;\n\t\tthis.diffEditor.layout(dimension);\n\t\tthis.updatePaddingForLayout();\n\t}\n\n\tprivate getContentHeight() {\n\t\treturn this.diffEditor.getModel()\n\t\t\t? this.diffEditor.getContentHeight()\n\t\t\t: dom.getTotalHeight(this.messageElement);\n\t}\n\n\tasync render(\n\t\tdata: ICodeCompareBlockData,\n\t\twidth: number,\n\t\ttoken: CancellationToken,\n\t) {\n\t\tif (data.parentContextKeyService) {\n\t\t\tthis.contextKeyService.updateParent(data.parentContextKeyService);\n\t\t}\n\n\t\tif (this.options.configuration.resultEditor.wordWrap === \"on\") {\n\t\t\t// Initialize the editor with the new proper width so that getContentHeight\n\t\t\t// will be computed correctly in the next call to layout()\n\t\t\tthis.layout(width);\n\t\t}\n\n\t\tawait this.updateEditor(data, token);\n\n\t\tthis.layout(width);\n\t\tthis.diffEditor.updateOptions({\n\t\t\tariaLabel: localize(\"chat.compareCodeBlockLabel\", \"Code Edits\"),\n\t\t});\n\n\t\tthis.resourceLabel.element.setFile(data.edit.uri, {\n\t\t\tfileKind: FileKind.FILE,\n\t\t\tfileDecorations: { colors: true, badges: false },\n\t\t});\n\t}\n\n\treset() {\n\t\tthis.clearWidgets();\n\t}\n\n\tprivate clearWidgets() {\n\t\tContentHoverController.get(\n\t\t\tthis.diffEditor.getOriginalEditor(),\n\t\t)?.hideContentHover();\n\t\tContentHoverController.get(\n\t\t\tthis.diffEditor.getModifiedEditor(),\n\t\t)?.hideContentHover();\n\t\tGlyphHoverController.get(\n\t\t\tthis.diffEditor.getOriginalEditor(),\n\t\t)?.hideContentHover();\n\t\tGlyphHoverController.get(\n\t\t\tthis.diffEditor.getModifiedEditor(),\n\t\t)?.hideContentHover();\n\t}\n\n\tprivate async updateEditor(\n\t\tdata: ICodeCompareBlockData,\n\t\ttoken: CancellationToken,\n\t): Promise<void> {\n\t\tif (!isResponseVM(data.element)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst isEditApplied = Boolean(data.edit.state?.applied ?? 0);\n\n\t\tCONTEXT_CHAT_EDIT_APPLIED.bindTo(this.contextKeyService).set(\n\t\t\tisEditApplied,\n\t\t);\n\n\t\tthis.element.classList.toggle(\"no-diff\", isEditApplied);\n\n\t\tif (isEditApplied) {\n\t\t\tassertType(data.edit.state?.applied);\n\n\t\t\tconst uriLabel = this.labelService.getUriLabel(data.edit.uri, {\n\t\t\t\trelative: true,\n\t\t\t\tnoPrefix: true,\n\t\t\t});\n\n\t\t\tlet template: string;\n\t\t\tif (data.edit.state.applied === 1) {\n\t\t\t\ttemplate = localize(\n\t\t\t\t\t\"chat.edits.1\",\n\t\t\t\t\t\"Made 1 change in [[``{0}``]]\",\n\t\t\t\t\turiLabel,\n\t\t\t\t);\n\t\t\t} else if (data.edit.state.applied < 0) {\n\t\t\t\ttemplate = localize(\n\t\t\t\t\t\"chat.edits.rejected\",\n\t\t\t\t\t\"Edits in [[``{0}``]] have been rejected\",\n\t\t\t\t\turiLabel,\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\ttemplate = localize(\n\t\t\t\t\t\"chat.edits.N\",\n\t\t\t\t\t\"Made {0} changes in [[``{1}``]]\",\n\t\t\t\t\tdata.edit.state.applied,\n\t\t\t\t\turiLabel,\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tconst message = renderFormattedText(template, {\n\t\t\t\trenderCodeSegments: true,\n\t\t\t\tactionHandler: {\n\t\t\t\t\tcallback: () => {\n\t\t\t\t\t\tthis.openerService.open(data.edit.uri, {\n\t\t\t\t\t\t\tfromUserGesture: true,\n\t\t\t\t\t\t\tallowCommands: false,\n\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t\tdisposables: this._store,\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tdom.reset(this.messageElement, message);\n\t\t}\n\n\t\tconst diffData = await data.diffData;\n\n\t\tif (!isEditApplied && diffData) {\n\t\t\tconst viewModel = this.diffEditor.createViewModel({\n\t\t\t\toriginal: diffData.original,\n\t\t\t\tmodified: diffData.modified,\n\t\t\t});\n\n\t\t\tawait viewModel.waitForDiff();\n\n\t\t\tif (token.isCancellationRequested) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst listener = Event.any(\n\t\t\t\tdiffData.original.onWillDispose,\n\t\t\t\tdiffData.modified.onWillDispose,\n\t\t\t)(() => {\n\t\t\t\t// this a bit weird and basically duplicates https://github.com/microsoft/vscode/blob/7cbcafcbcc88298cfdcd0238018fbbba8eb6853e/src/vs/editor/browser/widget/diffEditor/diffEditorWidget.ts#L328\n\t\t\t\t// which cannot call `setModel(null)` without first complaining\n\t\t\t\tthis.diffEditor.setModel(null);\n\t\t\t});\n\t\t\tthis.diffEditor.setModel(viewModel);\n\t\t\tthis._lastDiffEditorViewModel.value = combinedDisposable(\n\t\t\t\tlistener,\n\t\t\t\tviewModel,\n\t\t\t);\n\t\t} else {\n\t\t\tthis.diffEditor.setModel(null);\n\t\t\tthis._lastDiffEditorViewModel.value = undefined;\n\t\t\tthis._onDidChangeContentHeight.fire();\n\t\t}\n\n\t\tthis.toolbar.context = {\n\t\t\tedit: data.edit,\n\t\t\telement: data.element,\n\t\t\tdiffEditor: this.diffEditor,\n\t\t} satisfies ICodeCompareBlockActionContext;\n\t}\n}\n\nexport class DefaultChatTextEditor {\n\tprivate readonly _sha1 = new DefaultModelSHA1Computer();\n\n\tconstructor(\n\t\t@ITextModelService private readonly modelService: ITextModelService,\n\t\t@ICodeEditorService private readonly editorService: ICodeEditorService,\n\t\t@IDialogService private readonly dialogService: IDialogService,\n\t) { }\n\n\tasync apply(\n\t\tresponse: IChatResponseModel | IChatResponseViewModel,\n\t\titem: IChatTextEditGroup,\n\t\tdiffEditor: IDiffEditor | undefined,\n\t): Promise<void> {\n\t\tif (!response.response.value.includes(item)) {\n\t\t\t// bogous item\n\t\t\treturn;\n\t\t}\n\n\t\tif (item.state?.applied) {\n\t\t\t// already applied\n\t\t\treturn;\n\t\t}\n\n\t\tif (!diffEditor) {\n\t\t\tfor (const candidate of this.editorService.listDiffEditors()) {\n\t\t\t\tif (!candidate.getContainerDomNode().isConnected) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tconst model = candidate.getModel();\n\t\t\t\tif (\n\t\t\t\t\t!model ||\n\t\t\t\t\t!isEqual(model.original.uri, item.uri) ||\n\t\t\t\t\tmodel.modified.uri.scheme !==\n\t\t\t\t\t\tSchemas.vscodeChatCodeCompareBlock\n\t\t\t\t) {\n\t\t\t\t\tdiffEditor = candidate;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst edits = diffEditor\n\t\t\t? await this._applyWithDiffEditor(diffEditor, item)\n\t\t\t: await this._apply(item);\n\n\t\tresponse.setEditApplied(item, edits);\n\t}\n\n\tprivate async _applyWithDiffEditor(\n\t\tdiffEditor: IDiffEditor,\n\t\titem: IChatTextEditGroup,\n\t) {\n\t\tconst model = diffEditor.getModel();\n\t\tif (!model) {\n\t\t\treturn 0;\n\t\t}\n\n\t\tconst diff = diffEditor.getDiffComputationResult();\n\t\tif (!diff || diff.identical) {\n\t\t\treturn 0;\n\t\t}\n\n\t\tif (!(await this._checkSha1(model.original, item))) {\n\t\t\treturn 0;\n\t\t}\n\n\t\tconst modified = new TextModelText(model.modified);\n\t\tconst edits = diff.changes2.map((i) =>\n\t\t\ti.toRangeMapping().toTextEdit(modified).toSingleEditOperation(),\n\t\t);\n\n\t\tmodel.original.pushStackElement();\n\t\tmodel.original.pushEditOperations(null, edits, () => null);\n\t\tmodel.original.pushStackElement();\n\n\t\treturn edits.length;\n\t}\n\n\tprivate async _apply(item: IChatTextEditGroup) {\n\t\tconst ref = await this.modelService.createModelReference(item.uri);\n\t\ttry {\n\t\t\tif (!(await this._checkSha1(ref.object.textEditorModel, item))) {\n\t\t\t\treturn 0;\n\t\t\t}\n\n\t\t\tref.object.textEditorModel.pushStackElement();\n\t\t\tlet total = 0;\n\t\t\tfor (const group of item.edits) {\n\t\t\t\tconst edits = group.map(TextEdit.asEditOperation);\n\t\t\t\tref.object.textEditorModel.pushEditOperations(\n\t\t\t\t\tnull,\n\t\t\t\t\tedits,\n\t\t\t\t\t() => null,\n\t\t\t\t);\n\t\t\t\ttotal += edits.length;\n\t\t\t}\n\t\t\tref.object.textEditorModel.pushStackElement();\n\t\t\treturn total;\n\t\t} finally {\n\t\t\tref.dispose();\n\t\t}\n\t}\n\n\tprivate async _checkSha1(model: ITextModel, item: IChatTextEditGroup) {\n\t\tif (\n\t\t\titem.state?.sha1 &&\n\t\t\tthis._sha1.computeSHA1(model) &&\n\t\t\tthis._sha1.computeSHA1(model) !== item.state.sha1\n\t\t) {\n\t\t\tconst result = await this.dialogService.confirm({\n\t\t\t\tmessage: localize(\n\t\t\t\t\t\"interactive.compare.apply.confirm\",\n\t\t\t\t\t\"The original file has been modified.\",\n\t\t\t\t),\n\t\t\t\tdetail: localize(\n\t\t\t\t\t\"interactive.compare.apply.confirm.detail\",\n\t\t\t\t\t\"Do you want to apply the changes anyway?\",\n\t\t\t\t),\n\t\t\t});\n\n\t\t\tif (!result.confirmed) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\tdiscard(\n\t\tresponse: IChatResponseModel | IChatResponseViewModel,\n\t\titem: IChatTextEditGroup,\n\t) {\n\t\tif (!response.response.value.includes(item)) {\n\t\t\t// bogous item\n\t\t\treturn;\n\t\t}\n\n\t\tif (item.state?.applied) {\n\t\t\t// already applied\n\t\t\treturn;\n\t\t}\n\n\t\tresponse.setEditApplied(item, -1);\n\t}\n}\n"],
  "mappings": "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",
  "names": []
}
