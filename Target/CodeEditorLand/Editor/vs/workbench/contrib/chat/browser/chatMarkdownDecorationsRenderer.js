var D=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var I=(o,s,e,t)=>{for(var i=t>1?void 0:t?$(s,e):s,n=o.length-1,r;n>=0;n--)(r=o[n])&&(i=(t?r(s,e,i):r(i))||i);return t&&i&&D(s,e,i),i},d=(o,s)=>(e,t)=>s(e,t,o);import*as m from"../../../../base/browser/dom.js";import{Button as C}from"../../../../base/browser/ui/button/button.js";import{getDefaultHoverDelegate as A}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import{toErrorMessage as S}from"../../../../base/common/errorMessage.js";import{Lazy as L}from"../../../../base/common/lazy.js";import{Disposable as k,DisposableStore as H}from"../../../../base/common/lifecycle.js";import{revive as w}from"../../../../base/common/marshalling.js";import{URI as f}from"../../../../base/common/uri.js";import{ICommandService as T}from"../../../../platform/commands/common/commands.js";import{IHoverService as q}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as N}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as M}from"../../../../platform/keybinding/common/keybinding.js";import{ILabelService as x}from"../../../../platform/label/common/label.js";import{ILogService as P}from"../../../../platform/log/common/log.js";import{asCssVariable as h}from"../../../../platform/theme/common/colorUtils.js";import{contentRefUrl as U}from"../common/annotations.js";import{getFullyQualifiedId as E,IChatAgentNameService as O,IChatAgentService as b}from"../common/chatAgents.js";import{chatSlashCommandBackground as W,chatSlashCommandForeground as y}from"../common/chatColors.js";import{chatAgentLeader as J,ChatRequestAgentPart as F,ChatRequestAgentSubcommandPart as V,ChatRequestDynamicVariablePart as B,ChatRequestSlashCommandPart as K,ChatRequestTextPart as _,ChatRequestToolPart as j,ChatRequestVariablePart as z,chatSubcommandLeader as Q}from"../common/chatParserTypes.js";import{IChatService as G}from"../common/chatService.js";import{IChatVariablesService as X}from"../common/chatVariables.js";import{ILanguageModelToolsService as Y}from"../common/languageModelToolsService.js";import{IChatWidgetService as Z}from"./chat.js";import{ChatAgentHover as ee,getChatAgentHoverOptions as te}from"./chatAgentHover.js";import{InlineAnchorWidget as ne}from"./chatInlineAnchorWidget.js";import"./media/chatInlineAnchorWidget.css";const p="http://_vscodedecoration_",v="http://_chatagent_",R="http://_chatslash_";function ie(o,s,e){const t=e.get(O),i=e.get(b),n=t.getAgentNameRestriction(o);let r=`${n?o.name:E(o)}`;n&&i.agentHasDupeName(o.id)&&(r+=` (${o.publisherDisplayName})`);const c={agentId:o.id,name:r,isClickable:s};return`[${o.name}](${v}?${encodeURIComponent(JSON.stringify(c))})`}function Ee(o,s){const e=`${Q}${s.name}`,t={agentId:o.id,command:s.name};return`[${e}](${R}?${encodeURIComponent(JSON.stringify(t))})`}let u=class extends k{constructor(e,t,i,n,r,a,c,l,g,re,ae){super();this.keybindingService=e;this.logService=t;this.chatAgentService=i;this.instantiationService=n;this.hoverService=r;this.chatService=a;this.chatWidgetService=c;this.commandService=l;this.chatVariablesService=g;this.labelService=re;this.toolsService=ae}convertParsedRequestToMarkdown(e){let t="";for(const i of e.parts)i instanceof _?t+=i.text:i instanceof F?t+=this.instantiationService.invokeFunction(n=>ie(i.agent,!1,n)):t+=this.genericDecorationToMarkdown(i);return t}genericDecorationToMarkdown(e){const t=e instanceof B&&e.data instanceof f?e.data:void 0,n={title:t?this.labelService.getUriLabel(t,{relative:!0}):e instanceof K?e.slashCommand.detail:e instanceof V?e.command.description:e instanceof z?this.chatVariablesService.getVariable(e.variableName)?.description:e instanceof j?this.toolsService.getTool(e.toolId)?.userDescription:""};return`[${e.text}](${p}?${encodeURIComponent(JSON.stringify(n))})`}walkTreeAndAnnotateReferenceLinks(e){const t=new H;return e.querySelectorAll("a").forEach(i=>{const n=i.getAttribute("data-href");if(n)if(n.startsWith(v)){let r;try{r=JSON.parse(decodeURIComponent(n.slice(v.length+1)))}catch(a){this.logService.error("Invalid chat widget render data JSON",S(a))}r&&i.parentElement.replaceChild(this.renderAgentWidget(r,t),i)}else if(n.startsWith(R)){let r;try{r=JSON.parse(decodeURIComponent(n.slice(v.length+1)))}catch(a){this.logService.error("Invalid chat slash command render data JSON",S(a))}r&&i.parentElement.replaceChild(this.renderSlashCommandWidget(i.textContent,r,t),i)}else if(n.startsWith(p)){let r;try{r=JSON.parse(decodeURIComponent(n.slice(p.length+1)))}catch{}i.parentElement.replaceChild(this.renderResourceWidget(i.textContent,r,t),i)}else n.startsWith(U)?this.renderFileWidget(n,i,t):n.startsWith("command:")&&this.injectKeybindingHint(i,n,this.keybindingService)}),t}renderAgentWidget(e,t){const i=`${J}${e.name}`;let n;if(e.isClickable){n=m.$("span.chat-agent-widget");const c=t.add(new C(n,{buttonBackground:h(W),buttonForeground:h(y),buttonHoverBackground:void 0}));c.label=i,t.add(c.onDidClick(()=>{const l=this.chatAgentService.getAgent(e.agentId),g=this.chatWidgetService.lastFocusedWidget;!g||!l||this.chatService.sendRequest(g.viewModel.sessionId,l.metadata.sampleRequest??"",{location:g.location,agentId:l.id})}))}else n=this.renderResourceWidget(i,void 0,t);const r=this.chatAgentService.getAgent(e.agentId),a=new L(()=>t.add(this.instantiationService.createInstance(ee)));return t.add(this.hoverService.setupManagedHover(A("element"),n,()=>(a.value.setAgent(e.agentId),a.value.domNode),r&&te(()=>r,this.commandService))),n}renderSlashCommandWidget(e,t,i){const n=m.$("span.chat-agent-widget.chat-command-widget"),r=this.chatAgentService.getAgent(t.agentId),a=i.add(new C(n,{buttonBackground:h(W),buttonForeground:h(y),buttonHoverBackground:void 0}));return a.label=e,i.add(a.onDidClick(()=>{const c=this.chatWidgetService.lastFocusedWidget;if(!c||!r)return;const l=r.slashCommands.find(g=>g.name===t.command);this.chatService.sendRequest(c.viewModel.sessionId,l?.sampleRequest??"",{location:c.location,agentId:r.id,slashCommand:t.command})})),n}renderFileWidget(e,t,i){const n=f.parse(e);let r;try{r=w(JSON.parse(n.fragment))}catch(a){this.logService.error("Invalid chat widget render data JSON",S(a));return}if(r.kind!=="symbol"&&!f.isUri(r.uri)){this.logService.error(`Invalid chat widget render data: ${n.fragment}`);return}i.add(this.instantiationService.createInstance(ne,t,r))}renderResourceWidget(e,t,i){const n=m.$("span.chat-resource-widget"),r=m.$("span",void 0,e);return t?.title&&i.add(this.hoverService.setupManagedHover(A("element"),n,t.title)),n.appendChild(r),n}injectKeybindingHint(e,t,i){const n=t.match(/command:([^\)]+)/)?.[1];if(n){const r=i.lookupKeybinding(n);if(r){const a=r.getLabel();a&&(e.textContent=`${e.textContent} (${a})`)}}}};u=I([d(0,M),d(1,P),d(2,b),d(3,N),d(4,q),d(5,G),d(6,Z),d(7,T),d(8,X),d(9,x),d(10,Y)],u);export{u as ChatMarkdownDecorationsRenderer,Ee as agentSlashCommandToMarkdown,ie as agentToMarkdown};
