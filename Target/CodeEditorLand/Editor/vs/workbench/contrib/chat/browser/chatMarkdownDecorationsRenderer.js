var R=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var p=(o,t,i,n)=>{for(var e=n>1?void 0:n?L(t,i):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(e=(n?a(t,i,e):a(e))||e);return n&&e&&R(t,i,e),e},s=(o,t)=>(i,n)=>t(i,n,o);import*as l from"../../../../../vs/base/browser/dom.js";import{Button as I}from"../../../../../vs/base/browser/ui/button/button.js";import{getDefaultHoverDelegate as C}from"../../../../../vs/base/browser/ui/hover/hoverDelegateFactory.js";import{toErrorMessage as u}from"../../../../../vs/base/common/errorMessage.js";import{Lazy as $}from"../../../../../vs/base/common/lazy.js";import{DisposableStore as D}from"../../../../../vs/base/common/lifecycle.js";import{revive as N}from"../../../../../vs/base/common/marshalling.js";import{URI as f}from"../../../../../vs/base/common/uri.js";import"../../../../../vs/editor/common/languages.js";import{ICommandService as w}from"../../../../../vs/platform/commands/common/commands.js";import{IHoverService as H}from"../../../../../vs/platform/hover/browser/hover.js";import{IInstantiationService as k}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{IKeybindingService as T}from"../../../../../vs/platform/keybinding/common/keybinding.js";import{ILabelService as q}from"../../../../../vs/platform/label/common/label.js";import{ILogService as M}from"../../../../../vs/platform/log/common/log.js";import{asCssVariable as m}from"../../../../../vs/platform/theme/common/colorUtils.js";import{IChatWidgetService as U}from"../../../../../vs/workbench/contrib/chat/browser/chat.js";import{ChatAgentHover as P,getChatAgentHoverOptions as x}from"../../../../../vs/workbench/contrib/chat/browser/chatAgentHover.js";import{getFullyQualifiedId as E,IChatAgentNameService as O,IChatAgentService as b}from"../../../../../vs/workbench/contrib/chat/common/chatAgents.js";import{chatSlashCommandBackground as A,chatSlashCommandForeground as W}from"../../../../../vs/workbench/contrib/chat/common/chatColors.js";import{chatAgentLeader as J,ChatRequestAgentPart as F,ChatRequestAgentSubcommandPart as V,ChatRequestDynamicVariablePart as B,ChatRequestSlashCommandPart as K,ChatRequestTextPart as _,ChatRequestToolPart as j,ChatRequestVariablePart as z,chatSubcommandLeader as Q}from"../../../../../vs/workbench/contrib/chat/common/chatParserTypes.js";import{IChatService as G}from"../../../../../vs/workbench/contrib/chat/common/chatService.js";import{IChatVariablesService as X}from"../../../../../vs/workbench/contrib/chat/common/chatVariables.js";import{ILanguageModelToolsService as Y}from"../../../../../vs/workbench/contrib/chat/common/languageModelToolsService.js";import{contentRefUrl as Z}from"../common/annotations.js";const S="http://_vscodedecoration_",h="http://_chatagent_",y="http://_chatslash_";function ee(o,t,i){const n=i.get(O),e=i.get(b),r=n.getAgentNameRestriction(o);let a=`${r?o.name:E(o)}`;r&&e.agentHasDupeName(o.id)&&(a+=` (${o.publisherDisplayName})`);const d={agentId:o.id,name:a,isClickable:t};return`[${o.name}](${h}?${encodeURIComponent(JSON.stringify(d))})`}function Me(o,t){const i=`${Q}${t.name}`,n={agentId:o.id,command:t.name};return`[${i}](${y}?${encodeURIComponent(JSON.stringify(n))})`}let v=class{constructor(t,i,n,e,r,a,c,d,g,te,ne){this.keybindingService=t;this.labelService=i;this.logService=n;this.chatAgentService=e;this.instantiationService=r;this.hoverService=a;this.chatService=c;this.chatWidgetService=d;this.commandService=g;this.chatVariablesService=te;this.toolsService=ne}convertParsedRequestToMarkdown(t){let i="";for(const n of t.parts)n instanceof _?i+=n.text:n instanceof F?i+=this.instantiationService.invokeFunction(e=>ee(n.agent,!1,e)):i+=this.genericDecorationToMarkdown(n);return i}genericDecorationToMarkdown(t){const i=t instanceof B&&t.data instanceof f?t.data:void 0,e={title:i?this.labelService.getUriLabel(i,{relative:!0}):t instanceof K?t.slashCommand.detail:t instanceof V?t.command.description:t instanceof z?this.chatVariablesService.getVariable(t.variableName)?.description:t instanceof j?this.toolsService.getTool(t.toolId)?.userDescription:""};return`[${t.text}](${S}?${encodeURIComponent(JSON.stringify(e))})`}walkTreeAndAnnotateReferenceLinks(t){const i=new D;return t.querySelectorAll("a").forEach(n=>{const e=n.getAttribute("data-href");if(e)if(e.startsWith(h)){let r;try{r=JSON.parse(decodeURIComponent(e.slice(h.length+1)))}catch(a){this.logService.error("Invalid chat widget render data JSON",u(a))}r&&n.parentElement.replaceChild(this.renderAgentWidget(r,i),n)}else if(e.startsWith(y)){let r;try{r=JSON.parse(decodeURIComponent(e.slice(h.length+1)))}catch(a){this.logService.error("Invalid chat slash command render data JSON",u(a))}r&&n.parentElement.replaceChild(this.renderSlashCommandWidget(n.textContent,r,i),n)}else if(e.startsWith(S)){let r;try{r=JSON.parse(decodeURIComponent(e.slice(S.length+1)))}catch{}n.parentElement.replaceChild(this.renderResourceWidget(n.textContent,r,i),n)}else e.startsWith(Z)?this.renderFileWidget(e,n):e.startsWith("command:")&&this.injectKeybindingHint(n,e,this.keybindingService)}),i}renderAgentWidget(t,i){const n=`${J}${t.name}`;let e;if(t.isClickable){e=l.$("span.chat-agent-widget");const c=i.add(new I(e,{buttonBackground:m(A),buttonForeground:m(W),buttonHoverBackground:void 0}));c.label=n,i.add(c.onDidClick(()=>{const d=this.chatAgentService.getAgent(t.agentId),g=this.chatWidgetService.lastFocusedWidget;!g||!d||this.chatService.sendRequest(g.viewModel.sessionId,d.metadata.sampleRequest??"",{location:g.location,agentId:d.id})}))}else e=this.renderResourceWidget(n,void 0,i);const r=this.chatAgentService.getAgent(t.agentId),a=new $(()=>i.add(this.instantiationService.createInstance(P)));return i.add(this.hoverService.setupManagedHover(C("element"),e,()=>(a.value.setAgent(t.agentId),a.value.domNode),r&&x(()=>r,this.commandService))),e}renderSlashCommandWidget(t,i,n){const e=l.$("span.chat-agent-widget.chat-command-widget"),r=this.chatAgentService.getAgent(i.agentId),a=n.add(new I(e,{buttonBackground:m(A),buttonForeground:m(W),buttonHoverBackground:void 0}));return a.label=t,n.add(a.onDidClick(()=>{const c=this.chatWidgetService.lastFocusedWidget;if(!c||!r)return;const d=r.slashCommands.find(g=>g.name===i.command);this.chatService.sendRequest(c.viewModel.sessionId,d?.sampleRequest??"",{location:c.location,agentId:r.id,slashCommand:i.command})})),e}renderFileWidget(t,i){const n=f.parse(t);let e;try{e=N(JSON.parse(n.fragment))}catch(c){this.logService.error("Invalid chat widget render data JSON",u(c));return}if(!e.uri||!f.isUri(e.uri)){this.logService.error(`Invalid chat widget render data: ${n.fragment}`);return}const r=e.range?`${e.range.startLineNumber}-${e.range.endLineNumber}`:"";i.setAttribute("data-href",e.uri.with({fragment:r}).toString());const a=this.labelService.getUriLabel(e.uri,{relative:!0});i.title=e.range?`${a}#${e.range.startLineNumber}-${e.range.endLineNumber}`:a}renderResourceWidget(t,i,n){const e=l.$("span.chat-resource-widget"),r=l.$("span",void 0,t);return i?.title&&n.add(this.hoverService.setupManagedHover(C("element"),e,i.title)),e.appendChild(r),e}injectKeybindingHint(t,i,n){const e=i.match(/command:([^\)]+)/)?.[1];if(e){const r=n.lookupKeybinding(e);if(r){const a=r.getLabel();a&&(t.textContent=`${t.textContent} (${a})`)}}}};v=p([s(0,T),s(1,q),s(2,M),s(3,b),s(4,k),s(5,H),s(6,G),s(7,U),s(8,w),s(9,X),s(10,Y)],v);export{v as ChatMarkdownDecorationsRenderer,Me as agentSlashCommandToMarkdown,ee as agentToMarkdown};
