var U=Object.defineProperty;var j=Object.getOwnPropertyDescriptor;var P=(c,s,o,i)=>{for(var t=i>1?void 0:i?j(s,o):s,d=c.length-1,n;d>=0;d--)(n=c[d])&&(t=(i?n(s,o,t):n(t))||t);return i&&t&&U(s,o,t),t},m=(c,s)=>(o,i)=>s(o,i,c);import{MarkdownString as z}from"../../../../../base/common/htmlContent.js";import{Disposable as I,MutableDisposable as K}from"../../../../../base/common/lifecycle.js";import{ICodeEditorService as G}from"../../../../../editor/browser/services/codeEditorService.js";import{Range as b}from"../../../../../editor/common/core/range.js";import{IInstantiationService as H}from"../../../../../platform/instantiation/common/instantiation.js";import{inputPlaceholderForeground as J}from"../../../../../platform/theme/common/colorRegistry.js";import{IThemeService as Q}from"../../../../../platform/theme/common/themeService.js";import{IChatAgentService as X}from"../../common/chatAgents.js";import{chatSlashCommandBackground as T,chatSlashCommandForeground as E}from"../../common/chatColors.js";import{ChatRequestAgentPart as w,ChatRequestAgentSubcommandPart as A,ChatRequestSlashCommandPart as O,ChatRequestTextPart as D,ChatRequestToolPart as L,ChatRequestVariablePart as _,chatAgentLeader as F,chatSubcommandLeader as Y}from"../../common/chatParserTypes.js";import{ChatRequestParser as Z}from"../../common/chatRequestParser.js";import{ChatWidget as N}from"../chatWidget.js";import{dynamicVariableDecorationType as W}from"./chatDynamicVariables.js";const g="chat",x="chat-session-detail",M="chat-session-text",q="chat-variable-text";function V(c,s){return s?`${c.id}__${s}`:c.id}let C=class extends I{constructor(o,i,t,d){super();this.widget=o;this.codeEditorService=i;this.themeService=t;this.chatAgentService=d;this.codeEditorService.registerDecorationType(g,x,{}),this._register(this.themeService.onDidColorThemeChange(()=>this.updateRegisteredDecorationTypes())),this.updateRegisteredDecorationTypes(),this.updateInputEditorDecorations(),this._register(this.widget.inputEditor.onDidChangeModelContent(()=>this.updateInputEditorDecorations())),this._register(this.widget.onDidChangeParsedInput(()=>this.updateInputEditorDecorations())),this._register(this.widget.onDidChangeViewModel(()=>{this.registerViewModelListeners(),this.previouslyUsedAgents.clear(),this.updateInputEditorDecorations()})),this._register(this.widget.onDidSubmitAgent(n=>{this.previouslyUsedAgents.add(V(n.agent,n.slashCommand?.name))})),this._register(this.chatAgentService.onDidChangeAgents(()=>this.updateInputEditorDecorations())),this.registerViewModelListeners()}id="inputEditorDecorations";previouslyUsedAgents=new Set;viewModelDisposables=this._register(new K);registerViewModelListeners(){this.viewModelDisposables.value=this.widget.viewModel?.onDidChange(o=>{(o?.kind==="changePlaceholder"||o?.kind==="initialize")&&this.updateInputEditorDecorations()})}updateRegisteredDecorationTypes(){this.codeEditorService.removeDecorationType(q),this.codeEditorService.removeDecorationType(W),this.codeEditorService.removeDecorationType(M);const o=this.themeService.getColorTheme();this.codeEditorService.registerDecorationType(g,M,{color:o.getColor(E)?.toString(),backgroundColor:o.getColor(T)?.toString(),borderRadius:"3px"}),this.codeEditorService.registerDecorationType(g,q,{color:o.getColor(E)?.toString(),backgroundColor:o.getColor(T)?.toString(),borderRadius:"3px"}),this.codeEditorService.registerDecorationType(g,W,{color:o.getColor(E)?.toString(),backgroundColor:o.getColor(T)?.toString(),borderRadius:"3px"}),this.updateInputEditorDecorations()}getPlaceholderColor(){return this.themeService.getColorTheme().getColor(J)?.toString()}async updateInputEditorDecorations(){const o=this.widget.inputEditor.getValue(),i=this.widget.viewModel;if(!i)return;if(!o){const e=this.chatAgentService.getDefaultAgent(this.widget.location),l=[{range:{startLineNumber:1,endLineNumber:1,startColumn:1,endColumn:1e3},renderOptions:{after:{contentText:i.inputPlaceholder||(e?.description??""),color:this.getPlaceholderColor()}}}];this.widget.inputEditor.setDecorationsByType(g,x,l);return}const t=this.widget.parsedInput.parts;let d;const n=t.find(e=>e instanceof w),r=t.find(e=>e instanceof A),v=t.find(e=>e instanceof O),h=e=>{const l=t.indexOf(e);if(t.length>l+2)return!1;const R=t[l+1];return R&&R instanceof D&&R.text===" "},y=e=>({startLineNumber:e.editorRange.startLineNumber,endLineNumber:e.editorRange.endLineNumber,startColumn:e.editorRange.endColumn+1,endColumn:1e3});if(n&&t.every(e=>e instanceof D&&!e.text.trim().length||e instanceof w)){const l=this.previouslyUsedAgents.has(V(n.agent,void 0))&&n.agent.metadata.followupPlaceholder;n.agent.description&&h(n)&&(d=[{range:y(n),renderOptions:{after:{contentText:l?n.agent.metadata.followupPlaceholder:n.agent.description,color:this.getPlaceholderColor()}}}])}if(n&&r&&t.every(e=>e instanceof D&&!e.text.trim().length||e instanceof w||e instanceof A)){const l=this.previouslyUsedAgents.has(V(n.agent,r.command.name))&&r.command.followupPlaceholder;r?.command.description&&h(r)&&(d=[{range:y(r),renderOptions:{after:{contentText:l?r.command.followupPlaceholder:r.command.description,color:this.getPlaceholderColor()}}}])}r&&t.every(e=>e instanceof D&&!e.text.trim().length||e instanceof A)&&r?.command.description&&h(r)&&(d=[{range:y(r),renderOptions:{after:{contentText:r.command.description,color:this.getPlaceholderColor()}}}]),this.widget.inputEditor.setDecorationsByType(g,x,d??[]);const p=[];n&&p.push({range:n.editorRange}),r&&p.push({range:r.editorRange,hoverMessage:new z(r.command.description)}),v&&p.push({range:v.editorRange}),this.widget.inputEditor.setDecorationsByType(g,M,p);const u=[],k=t.filter(e=>e instanceof _);for(const e of k)u.push({range:e.editorRange});const B=t.filter(e=>e instanceof L);for(const e of B)u.push({range:e.editorRange});this.widget.inputEditor.setDecorationsByType(g,q,u)}};C=P([m(1,G),m(2,Q),m(3,X)],C);class ee extends I{constructor(o){super();this.widget=o;this._register(this.widget.onDidChangeAgent(i=>{(i.slashCommand&&i.slashCommand.isSticky||!i.slashCommand&&i.agent.metadata.isSticky)&&this.repopulateAgentCommand(i.agent,i.slashCommand)})),this._register(this.widget.onDidSubmitAgent(i=>{this.repopulateAgentCommand(i.agent,i.slashCommand)}))}id="InputEditorSlashCommandMode";async repopulateAgentCommand(o,i){if(this.widget.inputEditor.getValue().trim())return;let t;i&&i.isSticky?t=`${F}${o.name} ${Y}${i.name} `:o.metadata.isSticky&&(t=`${F}${o.name} `),t&&(this.widget.inputEditor.setValue(t),this.widget.inputEditor.setPosition({lineNumber:1,column:t.length+1}))}}N.CONTRIBS.push(C,ee);let f=class extends I{constructor(o,i){super();this.widget=o;this.instantiationService=i;const t=this.instantiationService.createInstance(Z),d=this.widget.inputEditor.getValue();let n,r;this._register(this.widget.inputEditor.onDidChangeModelContent(v=>{n||(n=d,r=this.widget.lastSelectedAgent);const h=v.changes[0];!h.text&&this.widget.viewModel&&t.parseChatRequest(this.widget.viewModel.sessionId,n,o.location,{selectedAgent:r}).parts.filter(a=>a instanceof w||a instanceof A||a instanceof O||a instanceof _||a instanceof L).forEach(a=>{const S=b.intersectRanges(a.editorRange,h.range);if(S&&b.compareRangesUsingStarts(a.editorRange,h.range)<0){const p=S.endColumn-S.startColumn,u=new b(a.editorRange.startLineNumber,a.editorRange.startColumn,a.editorRange.endLineNumber,a.editorRange.endColumn-p);this.widget.inputEditor.executeEdits(this.id,[{range:u,text:""}])}}),n=this.widget.inputEditor.getValue(),r=this.widget.lastSelectedAgent}))}id="chatTokenDeleter"};f=P([m(1,H)],f),N.CONTRIBS.push(f);
