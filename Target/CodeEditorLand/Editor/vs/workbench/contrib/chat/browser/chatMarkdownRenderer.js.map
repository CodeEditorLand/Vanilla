{
  "version": 3,
  "sources": ["../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/contrib/chat/browser/chatMarkdownRenderer.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type {\n\tMarkdownRenderOptions,\n\tMarkedOptions,\n} from \"../../../../base/browser/markdownRenderer.js\";\nimport { getDefaultHoverDelegate } from \"../../../../base/browser/ui/hover/hoverDelegateFactory.js\";\nimport type { IMarkdownString } from \"../../../../base/common/htmlContent.js\";\nimport { DisposableStore } from \"../../../../base/common/lifecycle.js\";\nimport { URI } from \"../../../../base/common/uri.js\";\nimport {\n\ttype IMarkdownRenderResult,\n\ttype IMarkdownRendererOptions,\n\tMarkdownRenderer,\n} from \"../../../../editor/browser/widget/markdownRenderer/browser/markdownRenderer.js\";\nimport { ILanguageService } from \"../../../../editor/common/languages/language.js\";\nimport { ICommandService } from \"../../../../platform/commands/common/commands.js\";\nimport { IFileService } from \"../../../../platform/files/common/files.js\";\nimport { IHoverService } from \"../../../../platform/hover/browser/hover.js\";\nimport { IOpenerService } from \"../../../../platform/opener/common/opener.js\";\nimport { REVEAL_IN_EXPLORER_COMMAND_ID } from \"../../files/browser/fileConstants.js\";\nimport { ITrustedDomainService } from \"../../url/browser/trustedDomainService.js\";\n\nconst allowedHtmlTags = [\n\t\"b\",\n\t\"blockquote\",\n\t\"br\",\n\t\"code\",\n\t\"em\",\n\t\"h1\",\n\t\"h2\",\n\t\"h3\",\n\t\"h4\",\n\t\"h5\",\n\t\"h6\",\n\t\"hr\",\n\t\"i\",\n\t\"li\",\n\t\"ol\",\n\t\"p\",\n\t\"pre\",\n\t\"strong\",\n\t\"sub\",\n\t\"sup\",\n\t\"table\",\n\t\"tbody\",\n\t\"td\",\n\t\"th\",\n\t\"thead\",\n\t\"tr\",\n\t\"ul\",\n\t\"a\",\n\t\"img\",\n\n\t// TODO@roblourens when we sanitize attributes in markdown source, we can ban these elements at that step. microsoft/vscode-copilot#5091\n\t// Not in the official list, but used for codicons and other vscode markdown extensions\n\t\"span\",\n\t\"div\",\n];\n\n/**\n * This wraps the MarkdownRenderer and applies sanitizer options needed for Chat.\n */\nexport class ChatMarkdownRenderer extends MarkdownRenderer {\n\tconstructor(\n\t\toptions: IMarkdownRendererOptions | undefined,\n\t\t@ILanguageService languageService: ILanguageService,\n\t\t@IOpenerService openerService: IOpenerService,\n\t\t@ITrustedDomainService\n\t\tprivate readonly trustedDomainService: ITrustedDomainService,\n\t\t@IHoverService private readonly hoverService: IHoverService,\n\t\t@IFileService private readonly fileService: IFileService,\n\t\t@ICommandService private readonly commandService: ICommandService,\n\t) {\n\t\tsuper(options ?? {}, languageService, openerService);\n\t}\n\n\toverride render(\n\t\tmarkdown: IMarkdownString | undefined,\n\t\toptions?: MarkdownRenderOptions,\n\t\tmarkedOptions?: MarkedOptions,\n\t): IMarkdownRenderResult {\n\t\toptions = {\n\t\t\t...options,\n\t\t\tremoteImageIsAllowed: (uri) =>\n\t\t\t\tthis.trustedDomainService.isValid(uri),\n\t\t\tsanitizerOptions: {\n\t\t\t\treplaceWithPlaintext: true,\n\t\t\t\tallowedTags: allowedHtmlTags,\n\t\t\t},\n\t\t};\n\n\t\tconst mdWithBody: IMarkdownString | undefined =\n\t\t\tmarkdown && markdown.supportHtml\n\t\t\t\t? {\n\t\t\t\t\t\t...markdown,\n\n\t\t\t\t\t\t// dompurify uses DOMParser, which strips leading comments. Wrapping it all in 'body' prevents this.\n\t\t\t\t\t\t// The \\n\\n prevents marked.js from parsing the body contents as just text in an 'html' token, instead of actual markdown.\n\t\t\t\t\t\tvalue: `<body>\\n\\n${markdown.value}</body>`,\n\t\t\t\t\t}\n\t\t\t\t: markdown;\n\t\tconst result = super.render(mdWithBody, options, markedOptions);\n\t\treturn this.attachCustomHover(result);\n\t}\n\n\tprivate attachCustomHover(\n\t\tresult: IMarkdownRenderResult,\n\t): IMarkdownRenderResult {\n\t\tconst store = new DisposableStore();\n\t\tresult.element.querySelectorAll(\"a\").forEach((element) => {\n\t\t\tif (element.title) {\n\t\t\t\tconst title = element.title;\n\t\t\t\telement.title = \"\";\n\t\t\t\tstore.add(\n\t\t\t\t\tthis.hoverService.setupManagedHover(\n\t\t\t\t\t\tgetDefaultHoverDelegate(\"element\"),\n\t\t\t\t\t\telement,\n\t\t\t\t\t\ttitle,\n\t\t\t\t\t),\n\t\t\t\t);\n\t\t\t}\n\t\t});\n\n\t\treturn {\n\t\t\telement: result.element,\n\t\t\tdispose: () => {\n\t\t\t\tresult.dispose();\n\t\t\t\tstore.dispose();\n\t\t\t},\n\t\t};\n\t}\n\n\tprotected override async openMarkdownLink(\n\t\tlink: string,\n\t\tmarkdown: IMarkdownString,\n\t) {\n\t\ttry {\n\t\t\tconst uri = URI.parse(link);\n\t\t\tif ((await this.fileService.stat(uri)).isDirectory) {\n\t\t\t\treturn this.commandService.executeCommand(\n\t\t\t\t\tREVEAL_IN_EXPLORER_COMMAND_ID,\n\t\t\t\t\turi,\n\t\t\t\t);\n\t\t\t}\n\t\t} catch {\n\t\t\t// noop\n\t\t}\n\n\t\treturn super.openMarkdownLink(link, markdown);\n\t}\n}\n"],
  "mappings": ";;;;;;;;;;;;AASA,SAAS,+BAA+B;AAExC,SAAS,uBAAuB;AAChC,SAAS,WAAW;AACpB;AAAA,EAGC;AAAA,OACM;AACP,SAAS,wBAAwB;AACjC,SAAS,uBAAuB;AAChC,SAAS,oBAAoB;AAC7B,SAAS,qBAAqB;AAC9B,SAAS,sBAAsB;AAC/B,SAAS,qCAAqC;AAC9C,SAAS,6BAA6B;AAEtC,MAAM,kBAAkB;AAAA,EACvB;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA;AAAA;AAAA,EAIA;AAAA,EACA;AACD;AAKO,IAAM,uBAAN,cAAmC,iBAAiB;AAAA,EAC1D,YACC,SACkB,iBACF,eAEC,sBACe,cACD,aACG,gBACjC;AACD,UAAM,WAAW,CAAC,GAAG,iBAAiB,aAAa;AALlC;AACe;AACD;AACG;AAAA,EAGnC;AAAA,EA9ED,OAkE2D;AAAA;AAAA;AAAA,EAcjD,OACR,UACA,SACA,eACwB;AACxB,cAAU;AAAA,MACT,GAAG;AAAA,MACH,sBAAsB,wBAAC,QACtB,KAAK,qBAAqB,QAAQ,GAAG,GADhB;AAAA,MAEtB,kBAAkB;AAAA,QACjB,sBAAsB;AAAA,QACtB,aAAa;AAAA,MACd;AAAA,IACD;AAEA,UAAM,aACL,YAAY,SAAS,cAClB;AAAA,MACA,GAAG;AAAA;AAAA;AAAA,MAIH,OAAO;AAAA;AAAA,EAAa,SAAS,KAAK;AAAA,IACnC,IACC;AACJ,UAAM,SAAS,MAAM,OAAO,YAAY,SAAS,aAAa;AAC9D,WAAO,KAAK,kBAAkB,MAAM;AAAA,EACrC;AAAA,EAEQ,kBACP,QACwB;AACxB,UAAM,QAAQ,IAAI,gBAAgB;AAClC,WAAO,QAAQ,iBAAiB,GAAG,EAAE,QAAQ,CAAC,YAAY;AACzD,UAAI,QAAQ,OAAO;AAClB,cAAM,QAAQ,QAAQ;AACtB,gBAAQ,QAAQ;AAChB,cAAM;AAAA,UACL,KAAK,aAAa;AAAA,YACjB,wBAAwB,SAAS;AAAA,YACjC;AAAA,YACA;AAAA,UACD;AAAA,QACD;AAAA,MACD;AAAA,IACD,CAAC;AAED,WAAO;AAAA,MACN,SAAS,OAAO;AAAA,MAChB,SAAS,6BAAM;AACd,eAAO,QAAQ;AACf,cAAM,QAAQ;AAAA,MACf,GAHS;AAAA,IAIV;AAAA,EACD;AAAA,EAEA,MAAyB,iBACxB,MACA,UACC;AACD,QAAI;AACH,YAAM,MAAM,IAAI,MAAM,IAAI;AAC1B,WAAK,MAAM,KAAK,YAAY,KAAK,GAAG,GAAG,aAAa;AACnD,eAAO,KAAK,eAAe;AAAA,UAC1B;AAAA,UACA;AAAA,QACD;AAAA,MACD;AAAA,IACD,QAAQ;AAAA,IAER;AAEA,WAAO,MAAM,iBAAiB,MAAM,QAAQ;AAAA,EAC7C;AACD;AAxFa,uBAAN;AAAA,EAGJ;AAAA,EACA;AAAA,EACA;AAAA,EAEA;AAAA,EACA;AAAA,EACA;AAAA,GATU;",
  "names": []
}
