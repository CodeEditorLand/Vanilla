{
  "version": 3,
  "sources": ["../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/contrib/chat/browser/chatMarkdownRenderer.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { MarkdownRenderOptions, MarkedOptions } from '../../../../base/browser/markdownRenderer.js';\nimport { getDefaultHoverDelegate } from '../../../../base/browser/ui/hover/hoverDelegateFactory.js';\nimport { IMarkdownString } from '../../../../base/common/htmlContent.js';\nimport { DisposableStore } from '../../../../base/common/lifecycle.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { IMarkdownRendererOptions, IMarkdownRenderResult, MarkdownRenderer } from '../../../../editor/browser/widget/markdownRenderer/browser/markdownRenderer.js';\nimport { ILanguageService } from '../../../../editor/common/languages/language.js';\nimport { ICommandService } from '../../../../platform/commands/common/commands.js';\nimport { IFileService } from '../../../../platform/files/common/files.js';\nimport { IHoverService } from '../../../../platform/hover/browser/hover.js';\nimport { IOpenerService } from '../../../../platform/opener/common/opener.js';\nimport { REVEAL_IN_EXPLORER_COMMAND_ID } from '../../files/browser/fileConstants.js';\nimport { ITrustedDomainService } from '../../url/browser/trustedDomainService.js';\n\nconst allowedHtmlTags = [\n\t'b',\n\t'blockquote',\n\t'br',\n\t'code',\n\t'em',\n\t'h1',\n\t'h2',\n\t'h3',\n\t'h4',\n\t'h5',\n\t'h6',\n\t'hr',\n\t'i',\n\t'li',\n\t'ol',\n\t'p',\n\t'pre',\n\t'strong',\n\t'sub',\n\t'sup',\n\t'table',\n\t'tbody',\n\t'td',\n\t'th',\n\t'thead',\n\t'tr',\n\t'ul',\n\t'a',\n\t'img',\n\n\t// TODO@roblourens when we sanitize attributes in markdown source, we can ban these elements at that step. microsoft/vscode-copilot#5091\n\t// Not in the official list, but used for codicons and other vscode markdown extensions\n\t'span',\n\t'div',\n];\n\n/**\n * This wraps the MarkdownRenderer and applies sanitizer options needed for Chat.\n */\nexport class ChatMarkdownRenderer extends MarkdownRenderer {\n\tconstructor(\n\t\toptions: IMarkdownRendererOptions | undefined,\n\t\t@ILanguageService languageService: ILanguageService,\n\t\t@IOpenerService openerService: IOpenerService,\n\t\t@ITrustedDomainService private readonly trustedDomainService: ITrustedDomainService,\n\t\t@IHoverService private readonly hoverService: IHoverService,\n\t\t@IFileService private readonly fileService: IFileService,\n\t\t@ICommandService private readonly commandService: ICommandService,\n\t) {\n\t\tsuper(options ?? {}, languageService, openerService);\n\t}\n\n\toverride render(markdown: IMarkdownString | undefined, options?: MarkdownRenderOptions, markedOptions?: MarkedOptions): IMarkdownRenderResult {\n\t\toptions = {\n\t\t\t...options,\n\t\t\tremoteImageIsAllowed: (uri) => this.trustedDomainService.isValid(uri),\n\t\t\tsanitizerOptions: {\n\t\t\t\treplaceWithPlaintext: true,\n\t\t\t\tallowedTags: allowedHtmlTags,\n\t\t\t}\n\t\t};\n\n\t\tconst mdWithBody: IMarkdownString | undefined = (markdown && markdown.supportHtml) ?\n\t\t\t{\n\t\t\t\t...markdown,\n\n\t\t\t\t// dompurify uses DOMParser, which strips leading comments. Wrapping it all in 'body' prevents this.\n\t\t\t\t// The \\n\\n prevents marked.js from parsing the body contents as just text in an 'html' token, instead of actual markdown.\n\t\t\t\tvalue: `<body>\\n\\n${markdown.value}</body>`,\n\t\t\t}\n\t\t\t: markdown;\n\t\tconst result = super.render(mdWithBody, options, markedOptions);\n\t\treturn this.attachCustomHover(result);\n\t}\n\n\tprivate attachCustomHover(result: IMarkdownRenderResult): IMarkdownRenderResult {\n\t\tconst store = new DisposableStore();\n\t\tresult.element.querySelectorAll('a').forEach((element) => {\n\t\t\tif (element.title) {\n\t\t\t\tconst title = element.title;\n\t\t\t\telement.title = '';\n\t\t\t\tstore.add(this.hoverService.setupManagedHover(getDefaultHoverDelegate('element'), element, title));\n\t\t\t}\n\t\t});\n\n\t\treturn {\n\t\t\telement: result.element,\n\t\t\tdispose: () => {\n\t\t\t\tresult.dispose();\n\t\t\t\tstore.dispose();\n\t\t\t}\n\t\t};\n\t}\n\n\tprotected override async openMarkdownLink(link: string, markdown: IMarkdownString) {\n\t\ttry {\n\t\t\tconst uri = URI.parse(link);\n\t\t\tif ((await this.fileService.stat(uri)).isDirectory) {\n\t\t\t\treturn this.commandService.executeCommand(REVEAL_IN_EXPLORER_COMMAND_ID, uri);\n\t\t\t}\n\t\t} catch {\n\t\t\t// noop\n\t\t}\n\n\t\treturn super.openMarkdownLink(link, markdown);\n\t}\n}\n"],
  "mappings": ";;;;;;;;;;;;AAKA,SAAS,uBAAuB,qBAAqB;AACrD,SAAS,+BAA+B;AACxC,SAAS,uBAAuB;AAChC,SAAS,uBAAuB;AAChC,SAAS,WAAW;AACpB,SAAS,0BAA0B,uBAAuB,wBAAwB;AAClF,SAAS,wBAAwB;AACjC,SAAS,uBAAuB;AAChC,SAAS,oBAAoB;AAC7B,SAAS,qBAAqB;AAC9B,SAAS,sBAAsB;AAC/B,SAAS,qCAAqC;AAC9C,SAAS,6BAA6B;AAEtC,MAAM,kBAAkB;AAAA,EACvB;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA;AAAA;AAAA,EAIA;AAAA,EACA;AACD;AAKO,IAAM,uBAAN,cAAmC,iBAAiB;AAAA,EAC1D,YACC,SACkB,iBACF,eACwB,sBACR,cACD,aACG,gBACjC;AACD,UAAM,WAAW,CAAC,GAAG,iBAAiB,aAAa;AALX;AACR;AACD;AACG;AAAA,EAGnC;AAAA,EAtED,OA2D2D;AAAA;AAAA;AAAA,EAajD,OAAO,UAAuC,SAAiC,eAAsD;AAC7I,cAAU;AAAA,MACT,GAAG;AAAA,MACH,sBAAsB,wBAAC,QAAQ,KAAK,qBAAqB,QAAQ,GAAG,GAA9C;AAAA,MACtB,kBAAkB;AAAA,QACjB,sBAAsB;AAAA,QACtB,aAAa;AAAA,MACd;AAAA,IACD;AAEA,UAAM,aAA2C,YAAY,SAAS,cACrE;AAAA,MACC,GAAG;AAAA;AAAA;AAAA,MAIH,OAAO;AAAA;AAAA,EAAa,SAAS,KAAK;AAAA,IACnC,IACE;AACH,UAAM,SAAS,MAAM,OAAO,YAAY,SAAS,aAAa;AAC9D,WAAO,KAAK,kBAAkB,MAAM;AAAA,EACrC;AAAA,EAEQ,kBAAkB,QAAsD;AAC/E,UAAM,QAAQ,IAAI,gBAAgB;AAClC,WAAO,QAAQ,iBAAiB,GAAG,EAAE,QAAQ,CAAC,YAAY;AACzD,UAAI,QAAQ,OAAO;AAClB,cAAM,QAAQ,QAAQ;AACtB,gBAAQ,QAAQ;AAChB,cAAM,IAAI,KAAK,aAAa,kBAAkB,wBAAwB,SAAS,GAAG,SAAS,KAAK,CAAC;AAAA,MAClG;AAAA,IACD,CAAC;AAED,WAAO;AAAA,MACN,SAAS,OAAO;AAAA,MAChB,SAAS,6BAAM;AACd,eAAO,QAAQ;AACf,cAAM,QAAQ;AAAA,MACf,GAHS;AAAA,IAIV;AAAA,EACD;AAAA,EAEA,MAAyB,iBAAiB,MAAc,UAA2B;AAClF,QAAI;AACH,YAAM,MAAM,IAAI,MAAM,IAAI;AAC1B,WAAK,MAAM,KAAK,YAAY,KAAK,GAAG,GAAG,aAAa;AACnD,eAAO,KAAK,eAAe,eAAe,+BAA+B,GAAG;AAAA,MAC7E;AAAA,IACD,QAAQ;AAAA,IAER;AAEA,WAAO,MAAM,iBAAiB,MAAM,QAAQ;AAAA,EAC7C;AACD;AAnEa,uBAAN;AAAA,EAGJ;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,GARU;",
  "names": []
}
