import{CancellationToken as X}from"../../../../../base/common/cancellation.js";import{Codicon as C}from"../../../../../base/common/codicons.js";import{KeyCode as G,KeyMod as H}from"../../../../../base/common/keyCodes.js";import{Schemas as g}from"../../../../../base/common/network.js";import{compare as z}from"../../../../../base/common/strings.js";import{ThemeIcon as m}from"../../../../../base/common/themables.js";import{URI as B}from"../../../../../base/common/uri.js";import"../../../../../editor/browser/editorExtensions.js";import"../../../../../editor/common/core/range.js";import{EditorType as R}from"../../../../../editor/common/editorCommon.js";import"../../../../../editor/common/languages.js";import{AbstractGotoSymbolQuickAccessProvider as Y}from"../../../../../editor/contrib/quickAccess/browser/gotoSymbolQuickAccess.js";import{localize as k,localize2 as P}from"../../../../../nls.js";import{Action2 as S,MenuId as x,registerAction2 as Q}from"../../../../../platform/actions/common/actions.js";import{ICommandService as J}from"../../../../../platform/commands/common/commands.js";import{ContextKeyExpr as u}from"../../../../../platform/contextkey/common/contextkey.js";import{KeybindingWeight as Z}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import"../../../../../platform/quickinput/common/quickAccess.js";import{IQuickInputService as ee}from"../../../../../platform/quickinput/common/quickInput.js";import{CHAT_CATEGORY as T}from"./chatActions.js";import{IChatWidgetService as te,IQuickChatService as ie,showChatView as V}from"../chat.js";import{isQuickChat as oe}from"../chatWidget.js";import{ChatContextAttachments as _}from"../contrib/chatContextAttachments.js";import{ChatAgentLocation as d,IChatAgentService as ne}from"../../common/chatAgents.js";import{CONTEXT_CHAT_LOCATION as b,CONTEXT_IN_CHAT_INPUT as ae}from"../../common/chatContextKeys.js";import"../../common/chatModel.js";import{ChatRequestAgentPart as q}from"../../common/chatParserTypes.js";import{IChatVariablesService as E}from"../../common/chatVariables.js";import{ILanguageModelToolsService as re}from"../../common/languageModelToolsService.js";import{AnythingQuickAccessProvider as ce}from"../../../search/browser/anythingQuickAccess.js";import{SymbolsQuickAccessProvider as U}from"../../../search/browser/symbolsQuickAccess.js";import{IEditorService as L}from"../../../../services/editor/common/editorService.js";import{IClipboardService as se}from"../../../../../platform/clipboard/common/clipboardService.js";import{imageToHash as O,isImage as le}from"../chatImagePaste.js";import{IConfigurationService as me}from"../../../../../platform/configuration/common/configuration.js";import{ActiveEditorContext as W}from"../../../../common/contextkeys.js";import{IViewsService as K}from"../../../../services/views/common/viewsService.js";function at(){Q(v),Q(A),Q(w)}class A extends S{static ID="workbench.action.chat.attachFile";constructor(){super({id:A.ID,title:P("workbench.action.chat.attachFile.label","Add File to Chat"),category:T,f1:!1,precondition:W.isEqualTo("workbench.editors.files.textFileEditor"),menu:{id:x.ChatCommandCenter,group:"a_chat",order:10}})}async run(t,...f){const c=t.get(E),a=t.get(L),n=a.activeEditor?.resource;a.activeTextEditorControl?.getEditorType()===R.ICodeEditor&&n&&[g.file,g.vscodeRemote,g.untitled].includes(n.scheme)&&((await V(t.get(K)))?.focusInput(),c.attachContext("file",n,d.Panel))}}class w extends S{static ID="workbench.action.chat.attachSelection";constructor(){super({id:w.ID,title:P("workbench.action.chat.attachSelection.label","Add Selection to Chat"),category:T,f1:!1,precondition:W.isEqualTo("workbench.editors.files.textFileEditor"),menu:{id:x.ChatCommandCenter,group:"a_chat",order:11}})}async run(t,...f){const c=t.get(E),a=t.get(L),n=a.activeTextEditorControl,e=a.activeEditor?.resource;if(a.activeTextEditorControl?.getEditorType()===R.ICodeEditor&&e&&[g.file,g.vscodeRemote,g.untitled].includes(e.scheme)){const r=n?.getSelection();r&&((await V(t.get(K)))?.focusInput(),c.attachContext("file",{uri:e,range:r},d.Panel))}}}class v extends S{static ID="workbench.action.chat.attachContext";static _cdt=u.or(u.and(b.isEqualTo(d.Panel)),u.and(b.isEqualTo(d.Editor),u.equals("config.chat.experimental.variables.editor",!0)),u.and(b.isEqualTo(d.Notebook),u.equals("config.chat.experimental.variables.notebook",!0)),u.and(b.isEqualTo(d.Terminal),u.equals("config.chat.experimental.variables.terminal",!0)));constructor(){super({id:v.ID,title:P("workbench.action.chat.attachContext.label","Attach Context"),icon:C.attach,category:T,precondition:v._cdt,keybinding:{when:ae,primary:H.CtrlCmd|G.Slash,weight:Z.EditorContrib},menu:[{when:u.and(b.isEqualTo(d.Panel),v._cdt),id:x.ChatInput,group:"navigation",order:2},{when:u.and(b.isEqualTo(d.Panel).negate(),v._cdt),id:x.ChatExecute,group:"navigation",order:1}]})}_getFileContextId(t){return"resource"in t?t.resource.toString():t.uri.toString()+(t.range.startLineNumber!==t.range.endLineNumber?`:${t.range.startLineNumber}-${t.range.endLineNumber}`:`:${t.range.startLineNumber}`)}async _attachContext(t,f,c,...a){const n=[];for(const e of a)if(e&&typeof e=="object"&&"command"in e&&e.command){const r=await f.executeCommand(e.command.id,...e.command.arguments??[]);if(!r)continue;n.push({...e,isDynamic:e.isDynamic,value:e.value,name:`${typeof e.value=="string"&&e.value.startsWith("#")?e.value.slice(1):""}${r}`,fullName:r})}else if("symbol"in e&&e.symbol)n.push({...e,id:this._getFileContextId(e.symbol.location),value:e.symbol.location,fullName:e.label,name:e.symbol.name,isDynamic:!0});else if(e&&typeof e=="object"&&"resource"in e&&e.resource)/\.(png|jpg|jpeg|bmp|gif|tiff)$/i.test(e.resource.path)?n.push({id:e.resource.toString(),name:e.label,fullName:e.label,value:e.resource,isDynamic:!0,isImage:!0}):n.push({...e,id:this._getFileContextId({resource:e.resource}),value:e.resource,name:e.label,isFile:!0,isDynamic:!0});else if("symbolName"in e&&e.uri&&e.range)n.push({...e,range:void 0,id:this._getFileContextId({uri:e.uri,range:e.range.decoration}),value:{uri:e.uri,range:e.range.decoration},fullName:e.label,name:e.symbolName,isDynamic:!0});else if("kind"in e&&e.kind==="tool")n.push({id:e.id,name:e.label,fullName:e.label,value:void 0,icon:e.icon,isTool:!0});else if("kind"in e&&e.kind==="image"){const r=await c.readImage();n.push({id:await O(r),name:k("pastedImage","Pasted Image"),fullName:k("pastedImage","Pasted Image"),value:r,isDynamic:!0,isImage:!0})}else n.push({...e,range:void 0,id:e.id??"",value:"value"in e?e.value:void 0,fullName:e.label,name:"name"in e&&typeof e.name=="string"?e.name:e.label,icon:"icon"in e&&m.isThemeIcon(e.icon)?e.icon:void 0});t.getContrib(_.ID)?.setContext(!1,...n)}async run(t,...f){const c=t.get(ee),a=t.get(ne),n=t.get(E),e=t.get(J),r=t.get(te),o=t.get(re),h=t.get(ie),N=t.get(se),M=t.get(me),I=f[0]?.widget??r.lastFocusedWidget;if(!I)return;const D=await N.readImage(),y=I.parsedInput.parts.find(i=>i instanceof q),$=y?y.agent.metadata.supportsSlowVariables:!0,p=[];for(const i of n.getVariables(I.location))i.fullName&&(!i.isSlow||$)&&p.push({label:i.fullName,name:i.name,id:i.id,iconClass:i.icon?m.asClassName(i.icon):void 0,icon:i.icon});if(le(D)&&M.getValue("chat.experimental.imageAttachments")&&p.push({id:await O(D),kind:"image",label:k("imageFromClipboard","Image from Clipboard"),iconClass:m.asClassName(C.fileMedia)}),I.viewModel?.sessionId){const i=I.parsedInput.parts.find(s=>s instanceof q);if(i){const s=await a.getAgentCompletionItems(i.agent.id,"",X.None);for(const l of s)l.fullName&&p.push({label:l.fullName,id:l.id,command:l.command,icon:l.icon,iconClass:l.icon?m.asClassName(l.icon):void 0,value:l.value,isDynamic:!0,name:l.name})}}if(!y||y.agent.supportsToolReferences){for(const i of o.getTools())if(i.canBeInvokedManually){const s={kind:"tool",label:i.displayName??i.name??"",id:i.id,icon:m.isThemeIcon(i.icon)?i.icon:void 0};m.isThemeIcon(i.icon)?s.iconClass=m.asClassName(i.icon):i.icon&&(s.iconPath=i.icon),p.push(s)}}p.push({label:k("chatContext.symbol","Symbol..."),icon:m.fromId(C.symbolField.id),iconClass:m.asClassName(C.symbolField),prefix:U.PREFIX}),I.location===d.Notebook&&p.push({kind:"dynamic",id:"chatContext.notebook.kernelVariable",isDynamic:!0,icon:m.fromId(C.serverEnvironment.id),iconClass:m.asClassName(C.serverEnvironment),value:"kernelVariable",label:k("chatContext.notebook.kernelVariable","Kernel Variable..."),command:{id:"notebook.chat.selectAndInsertKernelVariable",title:k("chatContext.notebook.selectkernelVariable","Select and Insert Kernel Variable"),arguments:[{widget:I,range:void 0}]}});function F(i){if(!i)return"";const s=i.match(/\$\([^\)]+\)\s*(.+)/);return s?s[1]:i}this._show(c,e,I,h,p.sort(function(i,s){const l=F(i.label).toUpperCase(),j=F(s.label).toUpperCase();return z(l,j)}),N,"")}_show(t,f,c,a,n,e,r=""){t.quickAccess.show(r,{enabledProviderPrefixes:[ce.PREFIX,U.PREFIX,Y.PREFIX],placeholder:k("chatContext.attach.placeholder","Search attachments"),providerOptions:{handleAccept:o=>{if("prefix"in o)this._show(t,f,c,a,n,e,o.prefix);else{if(!e)return;this._attachContext(c,f,e,o),oe(c)&&a.open()}},additionPicks:n,filter:o=>{const h=c.getContrib(_.ID)?.getContext()??new Set;return"kind"in o&&o.kind==="image"?!h.has(o.id):"symbol"in o&&o.symbol?!h.has(this._getFileContextId(o.symbol.location)):o&&typeof o=="object"&&"resource"in o&&B.isUri(o.resource)?[g.file,g.vscodeRemote].includes(o.resource.scheme)&&!h.has(this._getFileContextId({resource:o.resource})):o&&typeof o=="object"&&"uri"in o&&o.uri&&o.range?!h.has(this._getFileContextId({uri:o.uri,range:o.range.decoration})):!("command"in o)&&o.id?!h.has(o.id):!0}}})}}export{at as registerChatContextActions};
