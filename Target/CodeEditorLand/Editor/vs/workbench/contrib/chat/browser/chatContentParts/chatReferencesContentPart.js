var V=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var y=(f,e,n,t)=>{for(var o=t>1?void 0:t?H(e,n):e,r=f.length-1,s;r>=0;r--)(s=f[r])&&(o=(t?s(e,n,o):s(o))||o);return t&&o&&V(e,n,o),o},p=(f,e)=>(n,t)=>e(n,t,f);import*as F from"../../../../../base/browser/dom.js";import{Button as O}from"../../../../../base/browser/ui/button/button.js";import"../../../../../base/browser/ui/list/list.js";import{coalesce as M}from"../../../../../base/common/arrays.js";import{Codicon as g}from"../../../../../base/common/codicons.js";import{Emitter as W}from"../../../../../base/common/event.js";import{Disposable as k,DisposableStore as $}from"../../../../../base/common/lifecycle.js";import{matchesSomeScheme as B,Schemas as E}from"../../../../../base/common/network.js";import{basename as N}from"../../../../../base/common/path.js";import{basenameOrAuthority as j,isEqualAuthority as _}from"../../../../../base/common/resources.js";import{ThemeIcon as R}from"../../../../../base/common/themables.js";import{URI as I}from"../../../../../base/common/uri.js";import{localize as m}from"../../../../../nls.js";import{MenuWorkbenchToolBar as K}from"../../../../../platform/actions/browser/toolbar.js";import"../../../../../platform/actions/common/actions.js";import{IClipboardService as G}from"../../../../../platform/clipboard/common/clipboardService.js";import{IContextMenuService as q}from"../../../../../platform/contextview/browser/contextView.js";import{FileKind as z}from"../../../../../platform/files/common/files.js";import{IInstantiationService as U}from"../../../../../platform/instantiation/common/instantiation.js";import{ILabelService as Y}from"../../../../../platform/label/common/label.js";import{WorkbenchList as J}from"../../../../../platform/list/browser/listService.js";import{IOpenerService as Q}from"../../../../../platform/opener/common/opener.js";import{IProductService as X}from"../../../../../platform/product/common/productService.js";import{IThemeService as A}from"../../../../../platform/theme/common/themeService.js";import{fillEditorsDragData as Z}from"../../../../browser/dnd.js";import{ResourceLabels as ee}from"../../../../browser/labels.js";import{ColorScheme as te}from"../../../../browser/web.api.js";import{SETTINGS_AUTHORITY as ie}from"../../../../services/preferences/common/preferences.js";import{createFileIconThemableTreeContainerScope as ne}from"../../../files/browser/views/explorerView.js";import{ChatResponseReferencePartStatusKind as P}from"../../common/chatService.js";import{IChatVariablesService as re}from"../../common/chatVariables.js";import"../../common/chatViewModel.js";import"../chat.js";import{ResourcePool as oe}from"./chatCollections.js";import"./chatContentParts.js";const L=F.$;let T=class extends k{constructor(n,t,o,r,s,a,i){super();this.data=n;this.contextMenuService=a;this.clipboardService=i;const c=t??(n.length>1?m("usedReferencesPlural","Used {0} references",n.length):m("usedReferencesSingular","Used {0} reference",1)),d=L(".chat-used-context-icon"),v=l=>l.usedReferencesExpanded?g.chevronDown:g.chevronRight;d.classList.add(...R.asClassNameArray(v(o)));const D=L(".chat-used-context-label",void 0),C=this._register(new O(D,{buttonBackground:void 0,buttonBorder:void 0,buttonForeground:void 0,buttonHoverBackground:void 0,buttonSecondaryBackground:void 0,buttonSecondaryForeground:void 0,buttonSecondaryHoverBackground:void 0,buttonSeparator:void 0}));this.domNode=L(".chat-used-context",void 0,D),C.label=c,C.element.prepend(d),this.updateAriaLabel(C.element,c,o.usedReferencesExpanded),this.domNode.classList.toggle("chat-used-context-collapsed",!o.usedReferencesExpanded),this._register(C.onDidClick(()=>{d.classList.remove(...R.asClassNameArray(v(o))),o.usedReferencesExpanded=!o.usedReferencesExpanded,d.classList.add(...R.asClassNameArray(v(o))),this.domNode.classList.toggle("chat-used-context-collapsed",!o.usedReferencesExpanded),this._onDidChangeHeight.fire(),this.updateAriaLabel(C.element,c,o.usedReferencesExpanded)}));const b=this._register(r.get()).object;this.domNode.appendChild(b.getHTMLElement().parentElement),this._register(b.onDidOpen(l=>{if(l.element&&"reference"in l.element&&typeof l.element.reference=="object"){const u="variableName"in l.element.reference?l.element.reference.value:l.element.reference,S=I.isUri(u)?u:u?.uri;S&&s.open(S,{fromUserGesture:!0,editorOptions:{...l.editorOptions,selection:u&&"range"in u?u.range:void 0}})}})),this._register(b.onContextMenu(l=>{if(l.browserEvent.preventDefault(),l.browserEvent.stopPropagation(),l.element&&"reference"in l.element&&typeof l.element.reference=="object"){const u="variableName"in l.element.reference?l.element.reference.value:l.element.reference,S=I.isUri(u)?u:u?.uri;S&&this.contextMenuService.showContextMenu({getAnchor:()=>l.anchor,getActions:()=>[{id:"workbench.action.chat.copyReference",title:m("copyReference","Copy"),label:m("copyReference","Copy"),tooltip:m("copyReference","Copy"),enabled:l.element?.kind==="reference",class:void 0,run:()=>{this.clipboardService.writeResources([S])}}]})}}));const w=Math.min(n.length,6)*22;b.layout(w),b.getHTMLElement().style.height=`${w}px`,b.splice(0,b.length,n)}domNode;_onDidChangeHeight=this._register(new W);onDidChangeHeight=this._onDidChangeHeight.event;hasSameContent(n,t,o){return n.kind==="references"&&n.references.length===this.data.length||n.kind==="codeCitations"&&n.citations.length===this.data.length}updateAriaLabel(n,t,o){n.ariaLabel=o?m("usedReferencesExpanded","{0}, expanded",t):m("usedReferencesCollapsed","{0}, collapsed",t)}addDisposable(n){this._register(n)}};T=y([p(4,Q),p(5,q),p(6,G)],T);let x=class extends k{constructor(n,t,o,r,s,a){super();this._onDidChangeVisibility=n;this.menuId=t;this.options=o;this.instantiationService=r;this.themeService=s;this.labelService=a;this._pool=this._register(new oe(()=>this.listFactory()))}_pool;get inUse(){return this._pool.inUse}listFactory(){const n=this._register(this.instantiationService.createInstance(ee,{onDidChangeVisibility:this._onDidChangeVisibility})),t=L(".chat-used-context-list");this._register(ne(t,this.themeService));const o=s=>{if(s.kind==="warning")return null;const{reference:a}=s;return typeof a=="string"||"variableName"in a?null:I.isUri(a)?a:a.uri};return this.instantiationService.createInstance(J,"ChatListRenderer",t,new se,[this.instantiationService.createInstance(h,n,this.menuId,this.options)],{alwaysConsumeMouseWheel:!1,accessibilityProvider:{getAriaLabel:s=>{if(s.kind==="warning")return s.content.value;const a=s.reference;return typeof a=="string"?a:"variableName"in a?a.variableName:I.isUri(a)?N(a.path):N(a.uri.path)},getWidgetAriaLabel:()=>m("chatCollapsibleList","Collapsible Chat List")},dnd:{getDragURI:s=>o(s)?.toString()??null,getDragLabel:(s,a)=>{const i=M(s.map(o));if(i.length)return i.length===1?this.labelService.getUriLabel(i[0],{relative:!0}):`${i.length}`},dispose:()=>{},onDragOver:()=>!1,drop:()=>{},onDragStart:(s,a)=>{try{const i=s.getData(),c=M(i.map(o));this.instantiationService.invokeFunction(d=>Z(d,c,a))}catch{}}}})}get(){const n=this._pool.get();let t=!1;return{object:n,isStale:()=>t,dispose:()=>{t=!0,this._pool.release(n)}}}};x=y([p(3,U),p(4,A),p(5,Y)],x);class se{getHeight(e){return 22}getTemplateId(e){return h.TEMPLATE_ID}}let h=class{constructor(e,n,t,o,r,s,a){this.labels=e;this.menuId=n;this.options=t;this.themeService=o;this.chatVariablesService=r;this.productService=s;this.instantiationService=a}static TEMPLATE_ID="chatCollapsibleListRenderer";templateId=h.TEMPLATE_ID;renderTemplate(e){const n=new $,t=n.add(this.labels.create(e,{supportHighlights:!0,supportIcons:!0}));return{templateDisposables:n,label:t,toolbar:void 0}}getReferenceIcon(e){return R.isThemeIcon(e.iconPath)?e.iconPath:this.themeService.getColorTheme().type===te.DARK&&e.iconPath?.dark?e.iconPath?.dark:e.iconPath?.light}renderElement(e,n,t,o){if(t.toolbar?.dispose(),e.kind==="warning"){t.label.setResource({name:e.content.value},{icon:g.warning});return}const r=e.reference,s=this.getReferenceIcon(e);t.label.element.style.display="flex";let a;if(typeof r=="object"&&"variableName"in r)if(r.value){const i=I.isUri(r.value)?r.value:r.value.uri;t.label.setResource({resource:i,name:j(i),description:`#${r.variableName}`,range:"range"in r.value?r.value.range:void 0},{icon:s,title:e.options?.status?.description??e.title})}else if(r.variableName.startsWith("kernelVariable")){const c=`${r.variableName.split(":")[1]}`;t.label.setLabel("Kernel variable",c,{title:e.options?.status?.description})}else{const i=this.chatVariablesService.getVariable(r.variableName),c=i?.icon?`$(${i.icon.id}) `:"",d=`#${r.variableName}`,v=`${c}${i?.fullName??d}`;t.label.setLabel(v,d,{title:e.options?.status?.description??i?.description})}else if(typeof r=="string")t.label.setLabel(r,void 0,{iconPath:I.isUri(s)?s:void 0,title:e.options?.status?.description??e.title});else{const i="uri"in r?r.uri:r;if(a=i,i.scheme==="https"&&_(i.authority,"github.com")&&i.path.includes("/tree/")){const c=i.path.split("/").slice(1,3).join("/"),d=i.path.split("/").slice(5).join("/");t.label.setResource({resource:i,name:c,description:d},{icon:g.github,title:e.title})}else if(i.scheme===this.productService.urlProtocol&&_(i.authority,ie)){const c=i.path.substring(1);t.label.setResource({resource:i,name:c},{icon:g.settingsGear,title:m("setting.hover","Open setting '{0}'",c)})}else B(i,E.mailto,E.http,E.https)?t.label.setResource({resource:i,name:i.toString()},{icon:s??g.globe,title:e.options?.status?.description??e.title??i.toString()}):t.label.setFile(i,{fileKind:z.FILE,fileDecorations:this.options?.enableFileDecorations?{badges:!0,colors:!0}:{badges:!1,colors:!1},range:"range"in r?r.range:void 0,title:e.options?.status?.description??e.title})}for(const i of[".monaco-icon-suffix-container",".monaco-icon-name-container"]){const c=t.label.element.querySelector(i);c&&(e.options?.status?.kind===P.Omitted||e.options?.status?.kind===P.Partial?c.classList.add("warning"):c.classList.remove("warning"))}if(this.menuId){const i=L(".chat-collapsible-list-action-bar");t.toolbar=t.templateDisposables.add(this.instantiationService.createInstance(K,i,this.menuId,{menuOptions:{shouldForwardArgs:!0,arg:a}})),t.label.element.appendChild(i)}}disposeTemplate(e){e.templateDisposables.dispose()}};h=y([p(3,A),p(4,re),p(5,X),p(6,U)],h);export{T as ChatCollapsibleListContentPart,x as CollapsibleListPool};
