var P=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var y=(f,t,n,i)=>{for(var r=i>1?void 0:i?V(t,n):t,o=f.length-1,s;o>=0;o--)(s=f[o])&&(r=(i?s(t,n,r):s(r))||r);return i&&r&&P(t,n,r),r},d=(f,t)=>(n,i)=>t(n,i,f);import*as H from"../../../../../base/browser/dom.js";import{Button as O}from"../../../../../base/browser/ui/button/button.js";import{coalesce as _}from"../../../../../base/common/arrays.js";import{Codicon as g}from"../../../../../base/common/codicons.js";import{Emitter as j}from"../../../../../base/common/event.js";import{Disposable as k,DisposableStore as $}from"../../../../../base/common/lifecycle.js";import{Schemas as E,matchesSomeScheme as F}from"../../../../../base/common/network.js";import{basename as M}from"../../../../../base/common/path.js";import{basenameOrAuthority as W,isEqualAuthority as N}from"../../../../../base/common/resources.js";import{ThemeIcon as L}from"../../../../../base/common/themables.js";import{URI as I}from"../../../../../base/common/uri.js";import{localize as m}from"../../../../../nls.js";import{IClipboardService as B}from"../../../../../platform/clipboard/common/clipboardService.js";import{IContextMenuService as K}from"../../../../../platform/contextview/browser/contextView.js";import{FileKind as G}from"../../../../../platform/files/common/files.js";import{IInstantiationService as q}from"../../../../../platform/instantiation/common/instantiation.js";import{ILabelService as z}from"../../../../../platform/label/common/label.js";import{WorkbenchList as Y}from"../../../../../platform/list/browser/listService.js";import{IOpenerService as J}from"../../../../../platform/opener/common/opener.js";import{IProductService as Q}from"../../../../../platform/product/common/productService.js";import{IThemeService as U}from"../../../../../platform/theme/common/themeService.js";import{fillEditorsDragData as X}from"../../../../browser/dnd.js";import{ResourceLabels as Z}from"../../../../browser/labels.js";import{ColorScheme as ee}from"../../../../browser/web.api.js";import{SETTINGS_AUTHORITY as te}from"../../../../services/preferences/common/preferences.js";import{createFileIconThemableTreeContainerScope as ie}from"../../../files/browser/views/explorerView.js";import{ChatResponseReferencePartStatusKind as A}from"../../common/chatService.js";import{IChatVariablesService as ne}from"../../common/chatVariables.js";import{ResourcePool as re}from"./chatCollections.js";const S=H.$;let R=class extends k{constructor(n,i,r,o,s,e,l){super();this.data=n;this.contextMenuService=e;this.clipboardService=l;const c=i??(n.length>1?m("usedReferencesPlural","Used {0} references",n.length):m("usedReferencesSingular","Used {0} reference",1)),u=S(".chat-used-context-icon"),x=a=>a.usedReferencesExpanded?g.chevronDown:g.chevronRight;u.classList.add(...L.asClassNameArray(x(r)));const D=S(".chat-used-context-label",void 0),v=this._register(new O(D,{buttonBackground:void 0,buttonBorder:void 0,buttonForeground:void 0,buttonHoverBackground:void 0,buttonSecondaryBackground:void 0,buttonSecondaryForeground:void 0,buttonSecondaryHoverBackground:void 0,buttonSeparator:void 0}));this.domNode=S(".chat-used-context",void 0,D),v.label=c,v.element.prepend(u),this.updateAriaLabel(v.element,c,r.usedReferencesExpanded),this.domNode.classList.toggle("chat-used-context-collapsed",!r.usedReferencesExpanded),this._register(v.onDidClick(()=>{u.classList.remove(...L.asClassNameArray(x(r))),r.usedReferencesExpanded=!r.usedReferencesExpanded,u.classList.add(...L.asClassNameArray(x(r))),this.domNode.classList.toggle("chat-used-context-collapsed",!r.usedReferencesExpanded),this._onDidChangeHeight.fire(),this.updateAriaLabel(v.element,c,r.usedReferencesExpanded)}));const b=this._register(o.get()).object;this.domNode.appendChild(b.getHTMLElement().parentElement),this._register(b.onDidOpen(a=>{if(a.element&&"reference"in a.element&&typeof a.element.reference=="object"){const p="variableName"in a.element.reference?a.element.reference.value:a.element.reference,C=I.isUri(p)?p:p?.uri;C&&s.open(C,{fromUserGesture:!0,editorOptions:{...a.editorOptions,selection:p&&"range"in p?p.range:void 0}})}})),this._register(b.onContextMenu(a=>{if(a.browserEvent.preventDefault(),a.browserEvent.stopPropagation(),a.element&&"reference"in a.element&&typeof a.element.reference=="object"){const p="variableName"in a.element.reference?a.element.reference.value:a.element.reference,C=I.isUri(p)?p:p?.uri;C&&this.contextMenuService.showContextMenu({getAnchor:()=>a.anchor,getActions:()=>[{id:"workbench.action.chat.copyReference",title:m("copyReference","Copy"),label:m("copyReference","Copy"),tooltip:m("copyReference","Copy"),enabled:a.element?.kind==="reference",class:void 0,run:()=>{this.clipboardService.writeResources([C])}}]})}}));const w=Math.min(n.length,6)*22;b.layout(w),b.getHTMLElement().style.height=`${w}px`,b.splice(0,b.length,n)}domNode;_onDidChangeHeight=this._register(new j);onDidChangeHeight=this._onDidChangeHeight.event;hasSameContent(n,i,r){return n.kind==="references"&&n.references.length===this.data.length||n.kind==="codeCitations"&&n.citations.length===this.data.length}updateAriaLabel(n,i,r){n.ariaLabel=r?m("usedReferencesExpanded","{0}, expanded",i):m("usedReferencesCollapsed","{0}, collapsed",i)}addDisposable(n){this._register(n)}};R=y([d(4,J),d(5,K),d(6,B)],R);let T=class extends k{constructor(n,i,r,o){super();this._onDidChangeVisibility=n;this.instantiationService=i;this.themeService=r;this.labelService=o;this._pool=this._register(new re(()=>this.listFactory()))}_pool;get inUse(){return this._pool.inUse}listFactory(){const n=this._register(this.instantiationService.createInstance(Z,{onDidChangeVisibility:this._onDidChangeVisibility})),i=S(".chat-used-context-list");this._register(ie(i,this.themeService));const r=s=>{if(s.kind==="warning")return null;const{reference:e}=s;return typeof e=="string"||"variableName"in e?null:I.isUri(e)?e:e.uri};return this.instantiationService.createInstance(Y,"ChatListRenderer",i,new oe,[this.instantiationService.createInstance(h,n)],{alwaysConsumeMouseWheel:!1,accessibilityProvider:{getAriaLabel:s=>{if(s.kind==="warning")return s.content.value;const e=s.reference;return typeof e=="string"?e:"variableName"in e?e.variableName:I.isUri(e)?M(e.path):M(e.uri.path)},getWidgetAriaLabel:()=>m("chatCollapsibleList","Collapsible Chat List")},dnd:{getDragURI:s=>r(s)?.toString()??null,getDragLabel:(s,e)=>{const l=_(s.map(r));if(l.length)return l.length===1?this.labelService.getUriLabel(l[0],{relative:!0}):`${l.length}`},dispose:()=>{},onDragOver:()=>!1,drop:()=>{},onDragStart:(s,e)=>{try{const l=s.getData(),c=_(l.map(r));this.instantiationService.invokeFunction(u=>X(u,c,e))}catch{}}}})}get(){const n=this._pool.get();let i=!1;return{object:n,isStale:()=>i,dispose:()=>{i=!0,this._pool.release(n)}}}};T=y([d(1,q),d(2,U),d(3,z)],T);class oe{getHeight(t){return 22}getTemplateId(t){return h.TEMPLATE_ID}}let h=class{constructor(t,n,i,r){this.labels=t;this.themeService=n;this.chatVariablesService=i;this.productService=r}static TEMPLATE_ID="chatCollapsibleListRenderer";templateId=h.TEMPLATE_ID;renderTemplate(t){const n=new $,i=n.add(this.labels.create(t,{supportHighlights:!0,supportIcons:!0}));return{templateDisposables:n,label:i}}getReferenceIcon(t){return L.isThemeIcon(t.iconPath)?t.iconPath:this.themeService.getColorTheme().type===ee.DARK&&t.iconPath?.dark?t.iconPath?.dark:t.iconPath?.light}renderElement(t,n,i,r){if(t.kind==="warning"){i.label.setResource({name:t.content.value},{icon:g.warning});return}const o=t.reference,s=this.getReferenceIcon(t);if(i.label.element.style.display="flex",typeof o=="object"&&"variableName"in o)if(o.value){const e=I.isUri(o.value)?o.value:o.value.uri;i.label.setResource({resource:e,name:W(e),description:`#${o.variableName}`,range:"range"in o.value?o.value.range:void 0},{icon:s,title:t.options?.status?.description??t.title})}else{const e=this.chatVariablesService.getVariable(o.variableName),l=e?.icon?`$(${e.icon.id}) `:"",c=`#${o.variableName}`,u=`${l}${e?.fullName??c}`;i.label.setLabel(u,c,{title:t.options?.status?.description??e?.description})}else if(typeof o=="string")i.label.setLabel(o,void 0,{iconPath:I.isUri(s)?s:void 0,title:t.options?.status?.description??t.title});else{const e="uri"in o?o.uri:o;if(e.scheme==="https"&&N(e.authority,"github.com")&&e.path.includes("/tree/")){const l=e.path.split("/").slice(1,3).join("/"),c=e.path.split("/").slice(5).join("/");i.label.setResource({resource:e,name:l,description:c},{icon:g.github,title:t.title})}else if(e.scheme===this.productService.urlProtocol&&N(e.authority,te)){const l=e.path.substring(1);i.label.setResource({resource:e,name:l},{icon:g.settingsGear,title:m("setting.hover","Open setting '{0}'",l)})}else F(e,E.mailto,E.http,E.https)?i.label.setResource({resource:e,name:e.toString()},{icon:s??g.globe,title:t.options?.status?.description??t.title??e.toString()}):i.label.setFile(e,{fileKind:G.FILE,fileDecorations:{badges:!1,colors:!1},range:"range"in o?o.range:void 0,title:t.options?.status?.description??t.title})}for(const e of[".monaco-icon-suffix-container",".monaco-icon-name-container"]){const l=i.label.element.querySelector(e);l&&(t.options?.status?.kind===A.Omitted||t.options?.status?.kind===A.Partial?l.classList.add("warning"):l.classList.remove("warning"))}}disposeTemplate(t){t.templateDisposables.dispose()}};h=y([d(1,U),d(2,ne),d(3,Q)],h);export{R as ChatCollapsibleListContentPart,T as CollapsibleListPool};
