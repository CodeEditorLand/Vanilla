var j=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var $=(C,c,s,a)=>{for(var i=a>1?void 0:a?Q(c,s):c,h=C.length-1,o;h>=0;h--)(o=C[h])&&(i=(a?o(c,s,i):o(i))||i);return a&&i&&j(c,s,i),i},u=(C,c)=>(s,a)=>c(s,a,C);import"../../../../../base/common/cancellation.js";import{Disposable as F}from"../../../../../base/common/lifecycle.js";import"../../../../../editor/common/core/position.js";import{Range as y}from"../../../../../editor/common/core/range.js";import{getWordAtText as O}from"../../../../../editor/common/core/wordHelper.js";import{CompletionItemKind as A}from"../../../../../editor/common/languages.js";import"../../../../../editor/common/model.js";import{ILanguageFeaturesService as _}from"../../../../../editor/common/services/languageFeatures.js";import{localize as G}from"../../../../../nls.js";import{Action2 as J,registerAction2 as X}from"../../../../../platform/actions/common/actions.js";import{IConfigurationService as Y}from"../../../../../platform/configuration/common/configuration.js";import{IInstantiationService as Z}from"../../../../../platform/instantiation/common/instantiation.js";import{Registry as E}from"../../../../../platform/registry/common/platform.js";import{Extensions as U}from"../../../../common/contributions.js";import{SubmitAction as ee}from"../actions/chatExecuteActions.js";import{IChatWidgetService as q}from"../chat.js";import{ChatInputPart as R}from"../chatInputPart.js";import{ChatDynamicVariableModel as te,SelectAndInsertFileAction as H}from"./chatDynamicVariables.js";import{ChatAgentLocation as z,getFullyQualifiedId as re,IChatAgentNameService as ie,IChatAgentService as ne}from"../../common/chatAgents.js";import{ChatRequestAgentPart as V,ChatRequestAgentSubcommandPart as ae,ChatRequestTextPart as se,ChatRequestToolPart as oe,ChatRequestVariablePart as ce,chatAgentLeader as le,chatSubcommandLeader as N,chatVariableLeader as b}from"../../common/chatParserTypes.js";import{IChatSlashCommandService as de}from"../../common/chatSlashCommands.js";import{IChatVariablesService as ue}from"../../common/chatVariables.js";import{ILanguageModelToolsService as ge}from"../../common/languageModelToolsService.js";import{LifecyclePhase as B}from"../../../../services/lifecycle/common/lifecycle.js";import{IHistoryService as me}from"../../../../services/history/common/history.js";import{ILabelService as he}from"../../../../../platform/label/common/label.js";import{ResourceSet as pe}from"../../../../../base/common/map.js";import{CommandsRegistry as fe}from"../../../../../platform/commands/common/commands.js";import{isPatternInWord as ve}from"../../../../../base/common/filters.js";import{ISearchService as Ce}from"../../../../services/search/common/search.js";import{QueryBuilder as Ie}from"../../../../services/search/common/queryBuilder.js";import{IWorkspaceContextService as be}from"../../../../../platform/workspace/common/workspace.js";import"../../../../../base/common/uri.js";import{generateUuid as Se}from"../../../../../base/common/uuid.js";let L=class extends F{constructor(s,a,i){super();this.languageFeaturesService=s;this.chatWidgetService=a;this.chatSlashCommandService=i;this._register(this.languageFeaturesService.completionProvider.register({scheme:R.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"globalSlashCommands",triggerCharacters:["/"],provideCompletionItems:async(h,o,g,S)=>{const v=this.chatWidgetService.getWidgetByInputUri(h.uri);if(!v||!v.viewModel||!D(h,o,/\/\w*/g))return null;if(v.parsedInput.parts.find(l=>l instanceof V))return;const m=this.chatSlashCommandService.getCommands(v.location);return m?{suggestions:m.map((l,d)=>{const e=`/${l.command}`;return{label:e,insertText:l.executeImmediately?"":`${e} `,detail:l.detail,range:new y(1,1,1,1),sortText:l.sortText??"a".repeat(d+1),kind:A.Text,command:l.executeImmediately?{id:ee.ID,title:e,arguments:[{widget:v,inputValue:`${e} `}]}:void 0}})}:null}}))}};L=$([u(0,_),u(1,q),u(2,de)],L),E.as(U.Workbench).registerWorkbenchContribution(L,B.Eventually);let M=class extends F{constructor(s,a,i,h){super();this.languageFeaturesService=s;this.chatWidgetService=a;this.chatAgentService=i;this.chatAgentNameService=h;this._register(this.languageFeaturesService.completionProvider.register({scheme:R.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatAgent",triggerCharacters:["@"],provideCompletionItems:async(o,g,S,v)=>{const t=this.chatWidgetService.getWidgetByInputUri(o.uri);if(!t||!t.viewModel)return null;const n=t.parsedInput.parts.find(d=>d instanceof V);return n&&!y.containsPosition(n.editorRange,g)?void 0:D(o,g,/@\w*/g)?{suggestions:this.chatAgentService.getAgents().filter(d=>!d.isDefault).filter(d=>d.locations.includes(t.location)).map((d,e)=>{const{label:f,isDupe:I}=this.getAgentCompletionDetails(d);return{label:I?{label:f,description:d.description,detail:` (${d.publisherDisplayName})`}:f,insertText:`${f} `,detail:d.description,range:new y(1,1,1,1),command:{id:x.ID,title:x.ID,arguments:[{agent:d,widget:t}]},kind:A.Text}})}:null}})),this._register(this.languageFeaturesService.completionProvider.register({scheme:R.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatAgentSubcommand",triggerCharacters:["/"],provideCompletionItems:async(o,g,S,v)=>{const t=this.chatWidgetService.getWidgetByInputUri(o.uri);if(!t||!t.viewModel)return;const p=D(o,g,/\/\w*/g);if(!p)return null;const n=t.parsedInput.parts,m=n.findIndex(e=>e instanceof V);if(m<0||n.find(e=>e instanceof ae))return;for(const e of n.slice(m+1))if(!(e instanceof se)||!e.text.trim().match(/^(\/\w*)?$/))return;return{suggestions:n[m].agent.slashCommands.map((e,f)=>{const I=`/${e.name}`;return{label:I,insertText:`${I} `,detail:e.description,range:p,kind:A.Text}})}}})),this._register(this.languageFeaturesService.completionProvider.register({scheme:R.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatAgentAndSubcommand",triggerCharacters:["/"],provideCompletionItems:async(o,g,S,v)=>{const t=this.chatWidgetService.getWidgetByInputUri(o.uri),p=t?.viewModel;if(!t||!p)return;if(!D(o,g,/\/\w*/g))return null;const m=this.chatAgentService.getAgents().filter(e=>e.locations.includes(t.location)),l=(e,f)=>{const I=e.id==="github.copilot.terminalPanel"?"0000":"";return`${N}${I}${e.name}.${f}`};return{suggestions:m.filter(e=>!e.isDefault).map(e=>{const{label:f,isDupe:I}=this.getAgentCompletionDetails(e),w=e.description;return{label:I?{label:f,description:e.description,detail:` (${e.publisherDisplayName})`}:f,detail:w,filterText:`${N}${e.name}`,insertText:`${f} `,range:new y(1,1,1,1),kind:A.Text,sortText:`${N}${e.name}`,command:{id:x.ID,title:x.ID,arguments:[{agent:e,widget:t}]}}}).concat(m.flatMap(e=>e.slashCommands.map((f,I)=>{const{label:w,isDupe:K}=this.getAgentCompletionDetails(e),W=`${N}${f.name}`,r={label:{label:W,description:w,detail:K?` (${e.publisherDisplayName})`:void 0},filterText:l(e,f.name),commitCharacters:[" "],insertText:`${w} ${W} `,detail:`(${w}) ${f.description??""}`,range:new y(1,1,1,1),kind:A.Text,sortText:`${N}${e.name}${f.name}`,command:{id:x.ID,title:x.ID,arguments:[{agent:e,widget:t}]}};return e.isDefault&&(r.label=W,r.insertText=`${W} `,r.detail=f.description),r})))}}}))}getAgentCompletionDetails(s){const a=this.chatAgentNameService.getAgentNameRestriction(s),i=`${le}${a?s.name:re(s)}`,h=a&&this.chatAgentService.agentHasDupeName(s.id);return{label:i,isDupe:h}}};M=$([u(0,_),u(1,q),u(2,ne),u(3,ie)],M),E.as(U.Workbench).registerWorkbenchContribution(M,B.Eventually);class x extends J{static ID="workbench.action.chat.assignSelectedAgent";constructor(){super({id:x.ID,title:""})}async run(c,...s){const a=s[0];!a||!a.widget||!a.agent||(a.widget.lastSelectedAgent=a.agent)}}X(x);class ye{constructor(c,s){this.widget=c;this.variable=s}}let T=class extends F{constructor(s,a,i,h,o,g,S){super();this.historyService=s;this.workspaceContextService=a;this.searchService=i;this.labelService=h;this.languageFeaturesService=o;this.chatWidgetService=g;this.instantiationService=S;this._register(this.languageFeaturesService.completionProvider.register({scheme:R.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatDynamicCompletions",triggerCharacters:[b],provideCompletionItems:async(v,t,p,n)=>{const m=this.chatWidgetService.getWidgetByInputUri(v.uri);if(!m||!m.supportsFileReferences)return null;const l=D(v,t,T.VariableNameDef,!0);if(!l)return null;const d={suggestions:[]},e=new y(t.lineNumber,l.replace.startColumn,t.lineNumber,l.replace.startColumn+6);return d.suggestions.push({label:`${b}file`,insertText:`${b}file:`,detail:G("pickFileLabel","Pick a file"),range:l,kind:A.Text,command:{id:H.ID,title:H.ID,arguments:[{widget:m,range:e}]},sortText:"z"}),await this.addFileEntries(m,d,l,n),d}})),this._register(fe.registerCommand(T.addReferenceCommand,(v,t)=>this.cmdAddReference(t))),this.queryBuilder=this.instantiationService.createInstance(Ie)}static addReferenceCommand="_addReferenceCmd";static VariableNameDef=new RegExp(`${b}\\w*`,"g");queryBuilder;cacheKey;async addFileEntries(s,a,i,h){const o=t=>{const p=this.labelService.getUriBasenameLabel(t),n=`${b}file:${p} `;return{label:{label:p,description:this.labelService.getUriLabel(t,{relative:!0})},filterText:`${b}${p}`,insertText:n,range:i,kind:A.File,sortText:"{",command:{id:T.addReferenceCommand,title:"",arguments:[new ye(s,{id:"vscode.file",range:{startLineNumber:i.replace.startLineNumber,startColumn:i.replace.startColumn,endLineNumber:i.replace.endLineNumber,endColumn:i.replace.startColumn+n.length},data:t})]}}};let g;i.varWord?.word&&i.varWord.word.startsWith(b)&&(g=i.varWord.word.toLowerCase().slice(1));const S=new pe,v=a.suggestions.length;for(const t of this.historyService.getHistory()){if(!t.resource||!this.workspaceContextService.getWorkspaceFolder(t.resource))continue;if(g){const n=this.labelService.getUriBasenameLabel(t.resource).toLowerCase();if(!ve(g,0,g.length,n,0,n.length))continue}if(S.add(t.resource),a.suggestions.push(o(t.resource))-v>=5)break}if(g){this.cacheKey&&Date.now()-this.cacheKey.time>6e4&&(this.searchService.clearCache(this.cacheKey.key),this.cacheKey=void 0),this.cacheKey||(this.cacheKey={key:Se(),time:Date.now()}),this.cacheKey.time=Date.now();const t=this.queryBuilder.file(this.workspaceContextService.getWorkspace().folders,{filePattern:g,sortByScore:!0,maxResults:250,cacheKey:this.cacheKey.key}),p=await this.searchService.fileSearch(t,h);for(const n of p.results)S.has(n.resource)||a.suggestions.push(o(n.resource))}a.incomplete=!0}cmdAddReference(s){s.widget.getContrib(te.ID)?.addReference(s.variable)}};T=$([u(0,me),u(1,be),u(2,Ce),u(3,he),u(4,_),u(5,q),u(6,Z)],T),E.as(U.Workbench).registerWorkbenchContribution(T,B.Eventually);function D(C,c,s,a=!1){const i=O(c.column,s,C.getLineContent(c.lineNumber),0);if(!i&&C.getWordUntilPosition(c).word||i&&a&&C.getWordUntilPosition({lineNumber:c.lineNumber,column:i.startColumn}).word)return;let h,o;return i?(h=new y(c.lineNumber,i.startColumn,c.lineNumber,c.column),o=new y(c.lineNumber,i.startColumn,c.lineNumber,i.endColumn)):h=o=y.fromPositions(c),{insert:h,replace:o,varWord:i}}let k=class extends F{constructor(s,a,i,h,o){super();this.languageFeaturesService=s;this.chatWidgetService=a;this.chatVariablesService=i;this._register(this.languageFeaturesService.completionProvider.register({scheme:R.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatVariables",triggerCharacters:[b],provideCompletionItems:async(g,S,v,t)=>{const p=new Set;p.add(z.Panel);for(const r of Object.values(z))typeof r=="string"&&h.getValue(`chat.experimental.variables.${r}`)&&p.add(r);const n=this.chatWidgetService.getWidgetByInputUri(g.uri);if(!n||!p.has(n.location))return null;const m=D(g,S,k.VariableNameDef,!0);if(!m)return null;const l=n.parsedInput.parts.find(r=>r instanceof V),d=l?l.agent.metadata.supportsSlowVariables:!0,e=n.parsedInput.parts.filter(r=>r instanceof ce),f=new Set(e.map(r=>r.variableName)),I=Array.from(this.chatVariablesService.getVariables(n.location)).filter(r=>!f.has(r.name)).filter(r=>!r.isSlow||d).map(r=>{const P=`${b}${r.name}`;return{label:P,range:m,insertText:P+" ",detail:r.description,kind:A.Text,sortText:"z"}}),w=n.parsedInput.parts.filter(r=>r instanceof oe),K=new Set(w.map(r=>r.toolName)),W=[];return(!l||l.agent.supportsToolReferences)&&W.push(...Array.from(o.getTools()).filter(r=>r.canBeInvokedManually).filter(r=>!K.has(r.name??"")).map(r=>{const P=`${b}${r.name}`;return{label:P,range:m,insertText:P+" ",detail:r.userDescription,kind:A.Text,sortText:"z"}})),{suggestions:[...I,...W]}}}))}static VariableNameDef=new RegExp(`${b}\\w*`,"g")};k=$([u(0,_),u(1,q),u(2,ue),u(3,Y),u(4,ge)],k),E.as(U.Workbench).registerWorkbenchContribution(k,B.Eventually);
