var z=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var $=(C,c,s,a)=>{for(var i=a>1?void 0:a?Q(c,s):c,p=C.length-1,o;p>=0;p--)(o=C[p])&&(i=(a?o(c,s,i):o(i))||i);return a&&i&&z(c,s,i),i},u=(C,c)=>(s,a)=>c(s,a,C);import{isPatternInWord as O}from"../../../../../base/common/filters.js";import{Disposable as F}from"../../../../../base/common/lifecycle.js";import{ResourceSet as G}from"../../../../../base/common/map.js";import{generateUuid as J}from"../../../../../base/common/uuid.js";import{Range as y}from"../../../../../editor/common/core/range.js";import{getWordAtText as X}from"../../../../../editor/common/core/wordHelper.js";import{CompletionItemKind as A}from"../../../../../editor/common/languages.js";import{ILanguageFeaturesService as _}from"../../../../../editor/common/services/languageFeatures.js";import{localize as Y}from"../../../../../nls.js";import{Action2 as Z,registerAction2 as ee}from"../../../../../platform/actions/common/actions.js";import{CommandsRegistry as te}from"../../../../../platform/commands/common/commands.js";import{IConfigurationService as re}from"../../../../../platform/configuration/common/configuration.js";import{IInstantiationService as ie}from"../../../../../platform/instantiation/common/instantiation.js";import{ILabelService as ne}from"../../../../../platform/label/common/label.js";import{Registry as E}from"../../../../../platform/registry/common/platform.js";import{IWorkspaceContextService as ae}from"../../../../../platform/workspace/common/workspace.js";import{Extensions as U}from"../../../../common/contributions.js";import{IHistoryService as se}from"../../../../services/history/common/history.js";import{LifecyclePhase as q}from"../../../../services/lifecycle/common/lifecycle.js";import{QueryBuilder as oe}from"../../../../services/search/common/queryBuilder.js";import{ISearchService as ce}from"../../../../services/search/common/search.js";import{ChatAgentLocation as H,IChatAgentNameService as le,IChatAgentService as de,getFullyQualifiedId as ue}from"../../common/chatAgents.js";import{ChatRequestAgentPart as V,ChatRequestAgentSubcommandPart as me,ChatRequestTextPart as ge,ChatRequestToolPart as pe,ChatRequestVariablePart as he,chatAgentLeader as fe,chatSubcommandLeader as N,chatVariableLeader as b}from"../../common/chatParserTypes.js";import{IChatSlashCommandService as ve}from"../../common/chatSlashCommands.js";import{IChatVariablesService as Ce}from"../../common/chatVariables.js";import{ILanguageModelToolsService as Ie}from"../../common/languageModelToolsService.js";import{SubmitAction as be}from"../actions/chatExecuteActions.js";import{IChatWidgetService as B}from"../chat.js";import{ChatInputPart as R}from"../chatInputPart.js";import{ChatDynamicVariableModel as Se,SelectAndInsertFileAction as j}from"./chatDynamicVariables.js";let L=class extends F{constructor(s,a,i){super();this.languageFeaturesService=s;this.chatWidgetService=a;this.chatSlashCommandService=i;this._register(this.languageFeaturesService.completionProvider.register({scheme:R.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"globalSlashCommands",triggerCharacters:["/"],provideCompletionItems:async(p,o,m,S)=>{const v=this.chatWidgetService.getWidgetByInputUri(p.uri);if(!v||!v.viewModel||!D(p,o,/\/\w*/g))return null;if(v.parsedInput.parts.find(l=>l instanceof V))return;const g=this.chatSlashCommandService.getCommands(v.location);return g?{suggestions:g.map((l,d)=>{const e=`/${l.command}`;return{label:e,insertText:l.executeImmediately?"":`${e} `,detail:l.detail,range:new y(1,1,1,1),sortText:l.sortText??"a".repeat(d+1),kind:A.Text,command:l.executeImmediately?{id:be.ID,title:e,arguments:[{widget:v,inputValue:`${e} `}]}:void 0}})}:null}}))}};L=$([u(0,_),u(1,B),u(2,ve)],L),E.as(U.Workbench).registerWorkbenchContribution(L,q.Eventually);let M=class extends F{constructor(s,a,i,p){super();this.languageFeaturesService=s;this.chatWidgetService=a;this.chatAgentService=i;this.chatAgentNameService=p;this._register(this.languageFeaturesService.completionProvider.register({scheme:R.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatAgent",triggerCharacters:["@"],provideCompletionItems:async(o,m,S,v)=>{const t=this.chatWidgetService.getWidgetByInputUri(o.uri);if(!t||!t.viewModel)return null;const n=t.parsedInput.parts.find(d=>d instanceof V);return n&&!y.containsPosition(n.editorRange,m)?void 0:D(o,m,/@\w*/g)?{suggestions:this.chatAgentService.getAgents().filter(d=>!d.isDefault).filter(d=>d.locations.includes(t.location)).map((d,e)=>{const{label:f,isDupe:I}=this.getAgentCompletionDetails(d);return{label:I?{label:f,description:d.description,detail:` (${d.publisherDisplayName})`}:f,insertText:`${f} `,detail:d.description,range:new y(1,1,1,1),command:{id:x.ID,title:x.ID,arguments:[{agent:d,widget:t}]},kind:A.Text}})}:null}})),this._register(this.languageFeaturesService.completionProvider.register({scheme:R.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatAgentSubcommand",triggerCharacters:["/"],provideCompletionItems:async(o,m,S,v)=>{const t=this.chatWidgetService.getWidgetByInputUri(o.uri);if(!t||!t.viewModel)return;const h=D(o,m,/\/\w*/g);if(!h)return null;const n=t.parsedInput.parts,g=n.findIndex(e=>e instanceof V);if(g<0||n.find(e=>e instanceof me))return;for(const e of n.slice(g+1))if(!(e instanceof ge)||!e.text.trim().match(/^(\/\w*)?$/))return;return{suggestions:n[g].agent.slashCommands.map((e,f)=>{const I=`/${e.name}`;return{label:I,insertText:`${I} `,detail:e.description,range:h,kind:A.Text}})}}})),this._register(this.languageFeaturesService.completionProvider.register({scheme:R.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatAgentAndSubcommand",triggerCharacters:["/"],provideCompletionItems:async(o,m,S,v)=>{const t=this.chatWidgetService.getWidgetByInputUri(o.uri),h=t?.viewModel;if(!t||!h)return;if(!D(o,m,/\/\w*/g))return null;const g=this.chatAgentService.getAgents().filter(e=>e.locations.includes(t.location)),l=(e,f)=>{const I=e.id==="github.copilot.terminalPanel"?"0000":"";return`${N}${I}${e.name}.${f}`};return{suggestions:g.filter(e=>!e.isDefault).map(e=>{const{label:f,isDupe:I}=this.getAgentCompletionDetails(e),w=e.description;return{label:I?{label:f,description:e.description,detail:` (${e.publisherDisplayName})`}:f,detail:w,filterText:`${N}${e.name}`,insertText:`${f} `,range:new y(1,1,1,1),kind:A.Text,sortText:`${N}${e.name}`,command:{id:x.ID,title:x.ID,arguments:[{agent:e,widget:t}]}}}).concat(g.flatMap(e=>e.slashCommands.map((f,I)=>{const{label:w,isDupe:K}=this.getAgentCompletionDetails(e),W=`${N}${f.name}`,r={label:{label:W,description:w,detail:K?` (${e.publisherDisplayName})`:void 0},filterText:l(e,f.name),commitCharacters:[" "],insertText:`${w} ${W} `,detail:`(${w}) ${f.description??""}`,range:new y(1,1,1,1),kind:A.Text,sortText:`${N}${e.name}${f.name}`,command:{id:x.ID,title:x.ID,arguments:[{agent:e,widget:t}]}};return e.isDefault&&(r.label=W,r.insertText=`${W} `,r.detail=f.description),r})))}}}))}getAgentCompletionDetails(s){const a=this.chatAgentNameService.getAgentNameRestriction(s),i=`${fe}${a?s.name:ue(s)}`,p=a&&this.chatAgentService.agentHasDupeName(s.id);return{label:i,isDupe:p}}};M=$([u(0,_),u(1,B),u(2,de),u(3,le)],M),E.as(U.Workbench).registerWorkbenchContribution(M,q.Eventually);class x extends Z{static ID="workbench.action.chat.assignSelectedAgent";constructor(){super({id:x.ID,title:""})}async run(c,...s){const a=s[0];!a||!a.widget||!a.agent||(a.widget.lastSelectedAgent=a.agent)}}ee(x);class ye{constructor(c,s){this.widget=c;this.variable=s}}let T=class extends F{constructor(s,a,i,p,o,m,S){super();this.historyService=s;this.workspaceContextService=a;this.searchService=i;this.labelService=p;this.languageFeaturesService=o;this.chatWidgetService=m;this.instantiationService=S;this._register(this.languageFeaturesService.completionProvider.register({scheme:R.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatDynamicCompletions",triggerCharacters:[b],provideCompletionItems:async(v,t,h,n)=>{const g=this.chatWidgetService.getWidgetByInputUri(v.uri);if(!g||!g.supportsFileReferences)return null;const l=D(v,t,T.VariableNameDef,!0);if(!l)return null;const d={suggestions:[]},e=new y(t.lineNumber,l.replace.startColumn,t.lineNumber,l.replace.startColumn+6);return d.suggestions.push({label:`${b}file`,insertText:`${b}file:`,detail:Y("pickFileLabel","Pick a file"),range:l,kind:A.Text,command:{id:j.ID,title:j.ID,arguments:[{widget:g,range:e}]},sortText:"z"}),await this.addFileEntries(g,d,l,n),d}})),this._register(te.registerCommand(T.addReferenceCommand,(v,t)=>this.cmdAddReference(t))),this.queryBuilder=this.instantiationService.createInstance(oe)}static addReferenceCommand="_addReferenceCmd";static VariableNameDef=new RegExp(`${b}\\w*`,"g");queryBuilder;cacheKey;async addFileEntries(s,a,i,p){const o=t=>{const h=this.labelService.getUriBasenameLabel(t),n=`${b}file:${h} `;return{label:{label:h,description:this.labelService.getUriLabel(t,{relative:!0})},filterText:`${b}${h}`,insertText:n,range:i,kind:A.File,sortText:"{",command:{id:T.addReferenceCommand,title:"",arguments:[new ye(s,{id:"vscode.file",range:{startLineNumber:i.replace.startLineNumber,startColumn:i.replace.startColumn,endLineNumber:i.replace.endLineNumber,endColumn:i.replace.startColumn+n.length},data:t})]}}};let m;i.varWord?.word&&i.varWord.word.startsWith(b)&&(m=i.varWord.word.toLowerCase().slice(1));const S=new G,v=a.suggestions.length;for(const t of this.historyService.getHistory()){if(!t.resource||!this.workspaceContextService.getWorkspaceFolder(t.resource))continue;if(m){const n=this.labelService.getUriBasenameLabel(t.resource).toLowerCase();if(!O(m,0,m.length,n,0,n.length))continue}if(S.add(t.resource),a.suggestions.push(o(t.resource))-v>=5)break}if(m){this.cacheKey&&Date.now()-this.cacheKey.time>6e4&&(this.searchService.clearCache(this.cacheKey.key),this.cacheKey=void 0),this.cacheKey||(this.cacheKey={key:J(),time:Date.now()}),this.cacheKey.time=Date.now();const t=this.queryBuilder.file(this.workspaceContextService.getWorkspace().folders,{filePattern:m,sortByScore:!0,maxResults:250,cacheKey:this.cacheKey.key}),h=await this.searchService.fileSearch(t,p);for(const n of h.results)S.has(n.resource)||a.suggestions.push(o(n.resource))}a.incomplete=!0}cmdAddReference(s){s.widget.getContrib(Se.ID)?.addReference(s.variable)}};T=$([u(0,se),u(1,ae),u(2,ce),u(3,ne),u(4,_),u(5,B),u(6,ie)],T),E.as(U.Workbench).registerWorkbenchContribution(T,q.Eventually);function D(C,c,s,a=!1){const i=X(c.column,s,C.getLineContent(c.lineNumber),0);if(!i&&C.getWordUntilPosition(c).word||i&&a&&C.getWordUntilPosition({lineNumber:c.lineNumber,column:i.startColumn}).word)return;let p,o;return i?(p=new y(c.lineNumber,i.startColumn,c.lineNumber,c.column),o=new y(c.lineNumber,i.startColumn,c.lineNumber,i.endColumn)):p=o=y.fromPositions(c),{insert:p,replace:o,varWord:i}}let k=class extends F{constructor(s,a,i,p,o){super();this.languageFeaturesService=s;this.chatWidgetService=a;this.chatVariablesService=i;this._register(this.languageFeaturesService.completionProvider.register({scheme:R.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatVariables",triggerCharacters:[b],provideCompletionItems:async(m,S,v,t)=>{const h=new Set;h.add(H.Panel);for(const r of Object.values(H))typeof r=="string"&&p.getValue(`chat.experimental.variables.${r}`)&&h.add(r);const n=this.chatWidgetService.getWidgetByInputUri(m.uri);if(!n||!h.has(n.location))return null;const g=D(m,S,k.VariableNameDef,!0);if(!g)return null;const l=n.parsedInput.parts.find(r=>r instanceof V),d=l?l.agent.metadata.supportsSlowVariables:!0,e=n.parsedInput.parts.filter(r=>r instanceof he),f=new Set(e.map(r=>r.variableName)),I=Array.from(this.chatVariablesService.getVariables(n.location)).filter(r=>!f.has(r.name)).filter(r=>!r.isSlow||d).map(r=>{const P=`${b}${r.name}`;return{label:P,range:g,insertText:P+" ",detail:r.description,kind:A.Text,sortText:"z"}}),w=n.parsedInput.parts.filter(r=>r instanceof pe),K=new Set(w.map(r=>r.toolName)),W=[];return(!l||l.agent.supportsToolReferences)&&W.push(...Array.from(o.getTools()).filter(r=>r.canBeInvokedManually).filter(r=>!K.has(r.name??"")).map(r=>{const P=`${b}${r.name}`;return{label:P,range:g,insertText:P+" ",detail:r.userDescription,kind:A.Text,sortText:"z"}})),{suggestions:[...I,...W]}}}))}static VariableNameDef=new RegExp(`${b}\\w*`,"g")};k=$([u(0,_),u(1,B),u(2,Ce),u(3,re),u(4,Ie)],k),E.as(U.Workbench).registerWorkbenchContribution(k,q.Eventually);
