var Q=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var N=(C,l,s,a)=>{for(var r=a>1?void 0:a?K(l,s):l,p=C.length-1,o;p>=0;p--)(o=C[p])&&(r=(a?o(l,s,r):o(r))||r);return a&&r&&Q(l,s,r),r},u=(C,l)=>(s,a)=>l(s,a,C);import{Disposable as F}from"../../../../../base/common/lifecycle.js";import{Range as A}from"../../../../../editor/common/core/range.js";import{getWordAtText as O}from"../../../../../editor/common/core/wordHelper.js";import{CompletionItemKind as y}from"../../../../../editor/common/languages.js";import{ILanguageFeaturesService as _}from"../../../../../editor/common/services/languageFeatures.js";import{localize as G}from"../../../../../nls.js";import{Action2 as J,registerAction2 as X}from"../../../../../platform/actions/common/actions.js";import{IConfigurationService as Y}from"../../../../../platform/configuration/common/configuration.js";import{IInstantiationService as Z}from"../../../../../platform/instantiation/common/instantiation.js";import{Registry as E}from"../../../../../platform/registry/common/platform.js";import{Extensions as U}from"../../../../common/contributions.js";import{SubmitAction as ee}from"../actions/chatExecuteActions.js";import{IChatWidgetService as q}from"../chat.js";import{ChatInputPart as k}from"../chatInputPart.js";import{ChatDynamicVariableModel as te,SelectAndInsertFileAction as z}from"./chatDynamicVariables.js";import{ChatAgentLocation as j,getFullyQualifiedId as re,IChatAgentNameService as ie,IChatAgentService as ne}from"../../common/chatAgents.js";import{ChatRequestAgentPart as V,ChatRequestAgentSubcommandPart as ae,ChatRequestTextPart as se,ChatRequestToolPart as oe,ChatRequestVariablePart as le,chatAgentLeader as ce,chatSubcommandLeader as $,chatVariableLeader as b}from"../../common/chatParserTypes.js";import{IChatSlashCommandService as de}from"../../common/chatSlashCommands.js";import{IChatVariablesService as ue}from"../../common/chatVariables.js";import{ILanguageModelToolsService as ge}from"../../common/languageModelToolsService.js";import{LifecyclePhase as B}from"../../../../services/lifecycle/common/lifecycle.js";import{IHistoryService as me}from"../../../../services/history/common/history.js";import{ILabelService as pe}from"../../../../../platform/label/common/label.js";import{ResourceSet as he}from"../../../../../base/common/map.js";import{CommandsRegistry as fe}from"../../../../../platform/commands/common/commands.js";import{isPatternInWord as ve}from"../../../../../base/common/filters.js";import{ISearchService as Ce}from"../../../../services/search/common/search.js";import{QueryBuilder as Ie}from"../../../../services/search/common/queryBuilder.js";import{IWorkspaceContextService as be}from"../../../../../platform/workspace/common/workspace.js";let L=class extends F{constructor(s,a,r){super();this.languageFeaturesService=s;this.chatWidgetService=a;this.chatSlashCommandService=r;this._register(this.languageFeaturesService.completionProvider.register({scheme:k.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"globalSlashCommands",triggerCharacters:["/"],provideCompletionItems:async(p,o,g,S)=>{const v=this.chatWidgetService.getWidgetByInputUri(p.uri);if(!v||!v.viewModel||!P(p,o,/\/\w*/g))return null;if(v.parsedInput.parts.find(c=>c instanceof V))return;const m=this.chatSlashCommandService.getCommands(v.location);return m?{suggestions:m.map((c,d)=>{const e=`/${c.command}`;return{label:e,insertText:c.executeImmediately?"":`${e} `,detail:c.detail,range:new A(1,1,1,1),sortText:c.sortText??"a".repeat(d+1),kind:y.Text,command:c.executeImmediately?{id:ee.ID,title:e,arguments:[{widget:v,inputValue:`${e} `}]}:void 0}})}:null}}))}};L=N([u(0,_),u(1,q),u(2,de)],L),E.as(U.Workbench).registerWorkbenchContribution(L,B.Eventually);let M=class extends F{constructor(s,a,r,p){super();this.languageFeaturesService=s;this.chatWidgetService=a;this.chatAgentService=r;this.chatAgentNameService=p;this._register(this.languageFeaturesService.completionProvider.register({scheme:k.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatAgent",triggerCharacters:["@"],provideCompletionItems:async(o,g,S,v)=>{const t=this.chatWidgetService.getWidgetByInputUri(o.uri);if(!t||!t.viewModel)return null;const n=t.parsedInput.parts.find(d=>d instanceof V);return n&&!A.containsPosition(n.editorRange,g)?void 0:P(o,g,/@\w*/g)?{suggestions:this.chatAgentService.getAgents().filter(d=>!d.isDefault).filter(d=>d.locations.includes(t.location)).map((d,e)=>{const{label:h,isDupe:I}=this.getAgentCompletionDetails(d);return{label:I?{label:h,description:d.description,detail:` (${d.publisherDisplayName})`}:h,insertText:`${h} `,detail:d.description,range:new A(1,1,1,1),command:{id:x.ID,title:x.ID,arguments:[{agent:d,widget:t}]},kind:y.Text}})}:null}})),this._register(this.languageFeaturesService.completionProvider.register({scheme:k.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatAgentSubcommand",triggerCharacters:["/"],provideCompletionItems:async(o,g,S,v)=>{const t=this.chatWidgetService.getWidgetByInputUri(o.uri);if(!t||!t.viewModel)return;const f=P(o,g,/\/\w*/g);if(!f)return null;const n=t.parsedInput.parts,m=n.findIndex(e=>e instanceof V);if(m<0||n.find(e=>e instanceof ae))return;for(const e of n.slice(m+1))if(!(e instanceof se)||!e.text.trim().match(/^(\/\w*)?$/))return;return{suggestions:n[m].agent.slashCommands.map((e,h)=>{const I=`/${e.name}`;return{label:I,insertText:`${I} `,detail:e.description,range:f,kind:y.Text}})}}})),this._register(this.languageFeaturesService.completionProvider.register({scheme:k.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatAgentAndSubcommand",triggerCharacters:["/"],provideCompletionItems:async(o,g,S,v)=>{const t=this.chatWidgetService.getWidgetByInputUri(o.uri),f=t?.viewModel;if(!t||!f)return;if(!P(o,g,/\/\w*/g))return null;const m=this.chatAgentService.getAgents().filter(e=>e.locations.includes(t.location)),c=(e,h)=>{const I=e.id==="github.copilot.terminalPanel"?"0000":"";return`${$}${I}${e.name}.${h}`};return{suggestions:m.filter(e=>!e.isDefault).map(e=>{const{label:h,isDupe:I}=this.getAgentCompletionDetails(e),w=e.description;return{label:I?{label:h,description:e.description,detail:` (${e.publisherDisplayName})`}:h,detail:w,filterText:`${$}${e.name}`,insertText:`${h} `,range:new A(1,1,1,1),kind:y.Text,sortText:`${$}${e.name}`,command:{id:x.ID,title:x.ID,arguments:[{agent:e,widget:t}]}}}).concat(m.flatMap(e=>e.slashCommands.map((h,I)=>{const{label:w,isDupe:H}=this.getAgentCompletionDetails(e),W=`${$}${h.name}`,i={label:{label:W,description:w,detail:H?` (${e.publisherDisplayName})`:void 0},filterText:c(e,h.name),commitCharacters:[" "],insertText:`${w} ${W} `,detail:`(${w}) ${h.description??""}`,range:new A(1,1,1,1),kind:y.Text,sortText:`${$}${e.name}${h.name}`,command:{id:x.ID,title:x.ID,arguments:[{agent:e,widget:t}]}};return e.isDefault&&(i.label=W,i.insertText=`${W} `,i.detail=h.description),i})))}}}))}getAgentCompletionDetails(s){const a=this.chatAgentNameService.getAgentNameRestriction(s),r=`${ce}${a?s.name:re(s)}`,p=a&&this.chatAgentService.agentHasDupeName(s.id);return{label:r,isDupe:p}}};M=N([u(0,_),u(1,q),u(2,ne),u(3,ie)],M),E.as(U.Workbench).registerWorkbenchContribution(M,B.Eventually);class x extends J{static ID="workbench.action.chat.assignSelectedAgent";constructor(){super({id:x.ID,title:""})}async run(l,...s){const a=s[0];!a||!a.widget||!a.agent||(a.widget.lastSelectedAgent=a.agent)}}X(x);class Se{constructor(l,s){this.widget=l;this.variable=s}}let T=class extends F{constructor(s,a,r,p,o,g,S){super();this.historyService=s;this.workspaceContextService=a;this.searchService=r;this.labelService=p;this.languageFeaturesService=o;this.chatWidgetService=g;this.instantiationService=S;this._register(this.languageFeaturesService.completionProvider.register({scheme:k.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatDynamicCompletions",triggerCharacters:[b],provideCompletionItems:async(v,t,f,n)=>{const m=this.chatWidgetService.getWidgetByInputUri(v.uri);if(!m||!m.supportsFileReferences)return null;const c=P(v,t,T.VariableNameDef,!0);if(!c)return null;const d={suggestions:[]},e=new A(t.lineNumber,c.replace.startColumn,t.lineNumber,c.replace.startColumn+6);return d.suggestions.push({label:`${b}file`,insertText:`${b}file:`,detail:G("pickFileLabel","Pick a file"),range:c,kind:y.Text,command:{id:z.ID,title:z.ID,arguments:[{widget:m,range:e}]},sortText:"z"}),await this.addFileEntries(m,d,c,n),d}})),this._register(fe.registerCommand(T.addReferenceCommand,(v,t)=>this.cmdAddReference(t))),this.queryBuilder=this.instantiationService.createInstance(Ie)}static addReferenceCommand="_addReferenceCmd";static VariableNameDef=new RegExp(`${b}\\w*`,"g");queryBuilder;async addFileEntries(s,a,r,p){const o=t=>{const f=this.labelService.getUriBasenameLabel(t),n=`${b}file:${f} `;return{label:{label:f,description:this.labelService.getUriLabel(t)},filterText:r.varWord?.word,insertText:n,range:r,kind:y.File,sortText:"{",command:{id:T.addReferenceCommand,title:"",arguments:[new Se(s,{id:"vscode.file",range:{startLineNumber:r.replace.startLineNumber,startColumn:r.replace.startColumn,endLineNumber:r.replace.endLineNumber,endColumn:r.replace.startColumn+n.length},data:t})]}}};let g;r.varWord?.word&&r.varWord.word.startsWith(b)&&(g=r.varWord.word.toLowerCase().slice(1));const S=new he,v=a.suggestions.length;for(const t of this.historyService.getHistory()){if(!t.resource||!this.workspaceContextService.getWorkspaceFolder(t.resource))continue;if(g){const n=this.labelService.getUriBasenameLabel(t.resource).toLowerCase();if(!ve(g,0,g.length,n,0,n.length))continue}if(S.add(t.resource),a.suggestions.push(o(t.resource))-v>=5)break}if(g){const t=this.queryBuilder.file(this.workspaceContextService.getWorkspace().folders,{filePattern:g,sortByScore:!0,maxResults:100}),f=await this.searchService.fileSearch(t,p);for(const n of f.results)S.has(n.resource)||a.suggestions.push(o(n.resource))}a.incomplete=!0}cmdAddReference(s){s.widget.getContrib(te.ID)?.addReference(s.variable)}};T=N([u(0,me),u(1,be),u(2,Ce),u(3,pe),u(4,_),u(5,q),u(6,Z)],T),E.as(U.Workbench).registerWorkbenchContribution(T,B.Eventually);function P(C,l,s,a=!1){const r=O(l.column,s,C.getLineContent(l.lineNumber),0);if(!r&&C.getWordUntilPosition(l).word||r&&a&&C.getWordUntilPosition({lineNumber:l.lineNumber,column:r.startColumn}).word)return;let p,o;return r?(p=new A(l.lineNumber,r.startColumn,l.lineNumber,l.column),o=new A(l.lineNumber,r.startColumn,l.lineNumber,r.endColumn)):p=o=A.fromPositions(l),{insert:p,replace:o,varWord:r}}let R=class extends F{constructor(s,a,r,p,o){super();this.languageFeaturesService=s;this.chatWidgetService=a;this.chatVariablesService=r;this._register(this.languageFeaturesService.completionProvider.register({scheme:k.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatVariables",triggerCharacters:[b],provideCompletionItems:async(g,S,v,t)=>{const f=new Set;f.add(j.Panel);for(const i of Object.values(j))typeof i=="string"&&p.getValue(`chat.experimental.variables.${i}`)&&f.add(i);const n=this.chatWidgetService.getWidgetByInputUri(g.uri);if(!n||!f.has(n.location))return null;const m=P(g,S,R.VariableNameDef,!0);if(!m)return null;const c=n.parsedInput.parts.find(i=>i instanceof V),d=c?c.agent.metadata.supportsSlowVariables:!0,e=n.parsedInput.parts.filter(i=>i instanceof le),h=new Set(e.map(i=>i.variableName)),I=Array.from(this.chatVariablesService.getVariables(n.location)).filter(i=>!h.has(i.name)).filter(i=>!i.isSlow||d).map(i=>{const D=`${b}${i.name}`;return{label:D,range:m,insertText:D+" ",detail:i.description,kind:y.Text,sortText:"z"}}),w=n.parsedInput.parts.filter(i=>i instanceof oe),H=new Set(w.map(i=>i.toolName)),W=[];return(!c||c.agent.supportsToolReferences)&&W.push(...Array.from(o.getTools()).filter(i=>i.canBeInvokedManually).filter(i=>!H.has(i.name??"")).map(i=>{const D=`${b}${i.name}`;return{label:D,range:m,insertText:D+" ",detail:i.userDescription,kind:y.Text,sortText:"z"}})),{suggestions:[...I,...W]}}}))}static VariableNameDef=new RegExp(`${b}\\w*`,"g")};R=N([u(0,_),u(1,q),u(2,ue),u(3,Y),u(4,ge)],R),E.as(U.Workbench).registerWorkbenchContribution(R,B.Eventually);
