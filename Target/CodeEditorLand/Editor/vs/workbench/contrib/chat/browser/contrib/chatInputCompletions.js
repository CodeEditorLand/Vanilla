var Q=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var D=(C,l,s,a)=>{for(var i=a>1?void 0:a?K(l,s):l,p=C.length-1,o;p>=0;p--)(o=C[p])&&(i=(a?o(l,s,i):o(i))||i);return a&&i&&Q(l,s,i),i},u=(C,l)=>(s,a)=>l(s,a,C);import"../../../../../base/common/cancellation.js";import{Disposable as F}from"../../../../../base/common/lifecycle.js";import"../../../../../editor/common/core/position.js";import{Range as A}from"../../../../../editor/common/core/range.js";import{getWordAtText as O}from"../../../../../editor/common/core/wordHelper.js";import{CompletionItemKind as y}from"../../../../../editor/common/languages.js";import"../../../../../editor/common/model.js";import{ILanguageFeaturesService as _}from"../../../../../editor/common/services/languageFeatures.js";import{localize as G}from"../../../../../nls.js";import{Action2 as J,registerAction2 as X}from"../../../../../platform/actions/common/actions.js";import{IConfigurationService as Y}from"../../../../../platform/configuration/common/configuration.js";import{IInstantiationService as Z}from"../../../../../platform/instantiation/common/instantiation.js";import{Registry as E}from"../../../../../platform/registry/common/platform.js";import{Extensions as U}from"../../../../common/contributions.js";import{SubmitAction as ee}from"../actions/chatExecuteActions.js";import{IChatWidgetService as q}from"../chat.js";import{ChatInputPart as k}from"../chatInputPart.js";import{ChatDynamicVariableModel as te,SelectAndInsertFileAction as z}from"./chatDynamicVariables.js";import{ChatAgentLocation as j,getFullyQualifiedId as re,IChatAgentNameService as ie,IChatAgentService as ne}from"../../common/chatAgents.js";import{ChatRequestAgentPart as V,ChatRequestAgentSubcommandPart as ae,ChatRequestTextPart as se,ChatRequestToolPart as oe,ChatRequestVariablePart as le,chatAgentLeader as ce,chatSubcommandLeader as N,chatVariableLeader as b}from"../../common/chatParserTypes.js";import{IChatSlashCommandService as de}from"../../common/chatSlashCommands.js";import{IChatVariablesService as ue}from"../../common/chatVariables.js";import{ILanguageModelToolsService as ge}from"../../common/languageModelToolsService.js";import{LifecyclePhase as B}from"../../../../services/lifecycle/common/lifecycle.js";import{IHistoryService as me}from"../../../../services/history/common/history.js";import{ILabelService as pe}from"../../../../../platform/label/common/label.js";import{ResourceSet as he}from"../../../../../base/common/map.js";import{CommandsRegistry as fe}from"../../../../../platform/commands/common/commands.js";import{isPatternInWord as ve}from"../../../../../base/common/filters.js";import{ISearchService as Ce}from"../../../../services/search/common/search.js";import{QueryBuilder as Ie}from"../../../../services/search/common/queryBuilder.js";import{IWorkspaceContextService as be}from"../../../../../platform/workspace/common/workspace.js";import"../../../../../base/common/uri.js";let L=class extends F{constructor(s,a,i){super();this.languageFeaturesService=s;this.chatWidgetService=a;this.chatSlashCommandService=i;this._register(this.languageFeaturesService.completionProvider.register({scheme:k.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"globalSlashCommands",triggerCharacters:["/"],provideCompletionItems:async(p,o,g,S)=>{const v=this.chatWidgetService.getWidgetByInputUri(p.uri);if(!v||!v.viewModel||!P(p,o,/\/\w*/g))return null;if(v.parsedInput.parts.find(c=>c instanceof V))return;const m=this.chatSlashCommandService.getCommands(v.location);return m?{suggestions:m.map((c,d)=>{const e=`/${c.command}`;return{label:e,insertText:c.executeImmediately?"":`${e} `,detail:c.detail,range:new A(1,1,1,1),sortText:c.sortText??"a".repeat(d+1),kind:y.Text,command:c.executeImmediately?{id:ee.ID,title:e,arguments:[{widget:v,inputValue:`${e} `}]}:void 0}})}:null}}))}};L=D([u(0,_),u(1,q),u(2,de)],L),E.as(U.Workbench).registerWorkbenchContribution(L,B.Eventually);let M=class extends F{constructor(s,a,i,p){super();this.languageFeaturesService=s;this.chatWidgetService=a;this.chatAgentService=i;this.chatAgentNameService=p;this._register(this.languageFeaturesService.completionProvider.register({scheme:k.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatAgent",triggerCharacters:["@"],provideCompletionItems:async(o,g,S,v)=>{const t=this.chatWidgetService.getWidgetByInputUri(o.uri);if(!t||!t.viewModel)return null;const n=t.parsedInput.parts.find(d=>d instanceof V);return n&&!A.containsPosition(n.editorRange,g)?void 0:P(o,g,/@\w*/g)?{suggestions:this.chatAgentService.getAgents().filter(d=>!d.isDefault).filter(d=>d.locations.includes(t.location)).map((d,e)=>{const{label:f,isDupe:I}=this.getAgentCompletionDetails(d);return{label:I?{label:f,description:d.description,detail:` (${d.publisherDisplayName})`}:f,insertText:`${f} `,detail:d.description,range:new A(1,1,1,1),command:{id:x.ID,title:x.ID,arguments:[{agent:d,widget:t}]},kind:y.Text}})}:null}})),this._register(this.languageFeaturesService.completionProvider.register({scheme:k.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatAgentSubcommand",triggerCharacters:["/"],provideCompletionItems:async(o,g,S,v)=>{const t=this.chatWidgetService.getWidgetByInputUri(o.uri);if(!t||!t.viewModel)return;const h=P(o,g,/\/\w*/g);if(!h)return null;const n=t.parsedInput.parts,m=n.findIndex(e=>e instanceof V);if(m<0||n.find(e=>e instanceof ae))return;for(const e of n.slice(m+1))if(!(e instanceof se)||!e.text.trim().match(/^(\/\w*)?$/))return;return{suggestions:n[m].agent.slashCommands.map((e,f)=>{const I=`/${e.name}`;return{label:I,insertText:`${I} `,detail:e.description,range:h,kind:y.Text}})}}})),this._register(this.languageFeaturesService.completionProvider.register({scheme:k.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatAgentAndSubcommand",triggerCharacters:["/"],provideCompletionItems:async(o,g,S,v)=>{const t=this.chatWidgetService.getWidgetByInputUri(o.uri),h=t?.viewModel;if(!t||!h)return;if(!P(o,g,/\/\w*/g))return null;const m=this.chatAgentService.getAgents().filter(e=>e.locations.includes(t.location)),c=(e,f)=>{const I=e.id==="github.copilot.terminalPanel"?"0000":"";return`${N}${I}${e.name}.${f}`};return{suggestions:m.filter(e=>!e.isDefault).map(e=>{const{label:f,isDupe:I}=this.getAgentCompletionDetails(e),w=e.description;return{label:I?{label:f,description:e.description,detail:` (${e.publisherDisplayName})`}:f,detail:w,filterText:`${N}${e.name}`,insertText:`${f} `,range:new A(1,1,1,1),kind:y.Text,sortText:`${N}${e.name}`,command:{id:x.ID,title:x.ID,arguments:[{agent:e,widget:t}]}}}).concat(m.flatMap(e=>e.slashCommands.map((f,I)=>{const{label:w,isDupe:H}=this.getAgentCompletionDetails(e),W=`${N}${f.name}`,r={label:{label:W,description:w,detail:H?` (${e.publisherDisplayName})`:void 0},filterText:c(e,f.name),commitCharacters:[" "],insertText:`${w} ${W} `,detail:`(${w}) ${f.description??""}`,range:new A(1,1,1,1),kind:y.Text,sortText:`${N}${e.name}${f.name}`,command:{id:x.ID,title:x.ID,arguments:[{agent:e,widget:t}]}};return e.isDefault&&(r.label=W,r.insertText=`${W} `,r.detail=f.description),r})))}}}))}getAgentCompletionDetails(s){const a=this.chatAgentNameService.getAgentNameRestriction(s),i=`${ce}${a?s.name:re(s)}`,p=a&&this.chatAgentService.agentHasDupeName(s.id);return{label:i,isDupe:p}}};M=D([u(0,_),u(1,q),u(2,ne),u(3,ie)],M),E.as(U.Workbench).registerWorkbenchContribution(M,B.Eventually);class x extends J{static ID="workbench.action.chat.assignSelectedAgent";constructor(){super({id:x.ID,title:""})}async run(l,...s){const a=s[0];!a||!a.widget||!a.agent||(a.widget.lastSelectedAgent=a.agent)}}X(x);class Se{constructor(l,s){this.widget=l;this.variable=s}}let T=class extends F{constructor(s,a,i,p,o,g,S){super();this.historyService=s;this.workspaceContextService=a;this.searchService=i;this.labelService=p;this.languageFeaturesService=o;this.chatWidgetService=g;this.instantiationService=S;this._register(this.languageFeaturesService.completionProvider.register({scheme:k.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatDynamicCompletions",triggerCharacters:[b],provideCompletionItems:async(v,t,h,n)=>{const m=this.chatWidgetService.getWidgetByInputUri(v.uri);if(!m||!m.supportsFileReferences)return null;const c=P(v,t,T.VariableNameDef,!0);if(!c)return null;const d={suggestions:[]},e=new A(t.lineNumber,c.replace.startColumn,t.lineNumber,c.replace.startColumn+6);return d.suggestions.push({label:`${b}file`,insertText:`${b}file:`,detail:G("pickFileLabel","Pick a file"),range:c,kind:y.Text,command:{id:z.ID,title:z.ID,arguments:[{widget:m,range:e}]},sortText:"z"}),await this.addFileEntries(m,d,c,n),d}})),this._register(fe.registerCommand(T.addReferenceCommand,(v,t)=>this.cmdAddReference(t))),this.queryBuilder=this.instantiationService.createInstance(Ie)}static addReferenceCommand="_addReferenceCmd";static VariableNameDef=new RegExp(`${b}\\w*`,"g");queryBuilder;async addFileEntries(s,a,i,p){const o=t=>{const h=this.labelService.getUriBasenameLabel(t),n=`${b}file:${h} `;return{label:{label:h,description:this.labelService.getUriLabel(t)},filterText:`${b}${h}`,insertText:n,range:i,kind:y.File,sortText:"{",command:{id:T.addReferenceCommand,title:"",arguments:[new Se(s,{id:"vscode.file",range:{startLineNumber:i.replace.startLineNumber,startColumn:i.replace.startColumn,endLineNumber:i.replace.endLineNumber,endColumn:i.replace.startColumn+n.length},data:t})]}}};let g;i.varWord?.word&&i.varWord.word.startsWith(b)&&(g=i.varWord.word.toLowerCase().slice(1));const S=new he,v=a.suggestions.length;for(const t of this.historyService.getHistory()){if(!t.resource||!this.workspaceContextService.getWorkspaceFolder(t.resource))continue;if(g){const n=this.labelService.getUriBasenameLabel(t.resource).toLowerCase();if(!ve(g,0,g.length,n,0,n.length))continue}if(S.add(t.resource),a.suggestions.push(o(t.resource))-v>=5)break}if(g){const t=this.queryBuilder.file(this.workspaceContextService.getWorkspace().folders,{filePattern:g,sortByScore:!0,maxResults:100}),h=await this.searchService.fileSearch(t,p);for(const n of h.results)S.has(n.resource)||a.suggestions.push(o(n.resource))}a.incomplete=!0}cmdAddReference(s){s.widget.getContrib(te.ID)?.addReference(s.variable)}};T=D([u(0,me),u(1,be),u(2,Ce),u(3,pe),u(4,_),u(5,q),u(6,Z)],T),E.as(U.Workbench).registerWorkbenchContribution(T,B.Eventually);function P(C,l,s,a=!1){const i=O(l.column,s,C.getLineContent(l.lineNumber),0);if(!i&&C.getWordUntilPosition(l).word||i&&a&&C.getWordUntilPosition({lineNumber:l.lineNumber,column:i.startColumn}).word)return;let p,o;return i?(p=new A(l.lineNumber,i.startColumn,l.lineNumber,l.column),o=new A(l.lineNumber,i.startColumn,l.lineNumber,i.endColumn)):p=o=A.fromPositions(l),{insert:p,replace:o,varWord:i}}let R=class extends F{constructor(s,a,i,p,o){super();this.languageFeaturesService=s;this.chatWidgetService=a;this.chatVariablesService=i;this._register(this.languageFeaturesService.completionProvider.register({scheme:k.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatVariables",triggerCharacters:[b],provideCompletionItems:async(g,S,v,t)=>{const h=new Set;h.add(j.Panel);for(const r of Object.values(j))typeof r=="string"&&p.getValue(`chat.experimental.variables.${r}`)&&h.add(r);const n=this.chatWidgetService.getWidgetByInputUri(g.uri);if(!n||!h.has(n.location))return null;const m=P(g,S,R.VariableNameDef,!0);if(!m)return null;const c=n.parsedInput.parts.find(r=>r instanceof V),d=c?c.agent.metadata.supportsSlowVariables:!0,e=n.parsedInput.parts.filter(r=>r instanceof le),f=new Set(e.map(r=>r.variableName)),I=Array.from(this.chatVariablesService.getVariables(n.location)).filter(r=>!f.has(r.name)).filter(r=>!r.isSlow||d).map(r=>{const $=`${b}${r.name}`;return{label:$,range:m,insertText:$+" ",detail:r.description,kind:y.Text,sortText:"z"}}),w=n.parsedInput.parts.filter(r=>r instanceof oe),H=new Set(w.map(r=>r.toolName)),W=[];return(!c||c.agent.supportsToolReferences)&&W.push(...Array.from(o.getTools()).filter(r=>r.canBeInvokedManually).filter(r=>!H.has(r.name??"")).map(r=>{const $=`${b}${r.name}`;return{label:$,range:m,insertText:$+" ",detail:r.userDescription,kind:y.Text,sortText:"z"}})),{suggestions:[...I,...W]}}}))}static VariableNameDef=new RegExp(`${b}\\w*`,"g")};R=D([u(0,_),u(1,q),u(2,ue),u(3,Y),u(4,ge)],R),E.as(U.Workbench).registerWorkbenchContribution(R,B.Eventually);
