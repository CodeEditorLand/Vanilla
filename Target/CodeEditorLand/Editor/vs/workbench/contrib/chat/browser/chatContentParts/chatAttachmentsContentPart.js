var D=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var R=(f,m,o,n)=>{for(var e=n>1?void 0:n?$(m,o):m,t=f.length-1,s;t>=0;t--)(s=f[t])&&(e=(n?s(m,o,e):s(e))||e);return n&&e&&D(m,o,e),e},u=(f,m)=>(o,n)=>m(o,n,f);import*as i from"../../../../../base/browser/dom.js";import{Disposable as w,DisposableStore as F}from"../../../../../base/common/lifecycle.js";import"../../common/chatModel.js";import{Emitter as N}from"../../../../../base/common/event.js";import{IInstantiationService as H}from"../../../../../platform/instantiation/common/instantiation.js";import{ResourceLabels as O}from"../../../../browser/labels.js";import{URI as I}from"../../../../../base/common/uri.js";import{FileKind as U,IFileService as M}from"../../../../../platform/files/common/files.js";import{Range as k}from"../../../../../editor/common/core/range.js";import{basename as K,dirname as V}from"../../../../../base/common/path.js";import{localize as h}from"../../../../../nls.js";import{ChatResponseReferencePartStatusKind as E}from"../../common/chatService.js";import{IOpenerService as _}from"../../../../../platform/opener/common/opener.js";import{StandardKeyboardEvent as T}from"../../../../../base/browser/keyboardEvent.js";import{KeyCode as A}from"../../../../../base/common/keyCodes.js";import{IHoverService as j}from"../../../../../platform/hover/browser/hover.js";import{createInstantHoverDelegate as q}from"../../../../../base/browser/ui/hover/hoverDelegateFactory.js";let y=class extends w{constructor(o,n=[],e=i.$(".chat-attached-context"),t,s,l,a){super();this.variables=o;this.contentReferences=n;this.domNode=e;this.instantiationService=t;this.openerService=s;this.hoverService=l;this.fileService=a;this.initAttachedContext(e)}attachedContextDisposables=this._register(new F);_onDidChangeVisibility=this._register(new N);_contextResourceLabels=this.instantiationService.createInstance(O,{onDidChangeVisibility:this._onDidChangeVisibility.event});initAttachedContext(o){i.clearNode(o),this.attachedContextDisposables.clear(),i.setVisibility(!!this.variables.length,this.domNode);const n=this.attachedContextDisposables.add(q());this.variables.forEach(async e=>{const t=i.append(o,i.$(".chat-attached-context-attachment.show-file-icons")),s=this._contextResourceLabels.create(t,{supportIcons:!0}),l=I.isUri(e.value)?e.value:e.value&&typeof e.value=="object"&&"uri"in e.value&&I.isUri(e.value.uri)?e.value.uri:void 0,a=e.value&&typeof e.value=="object"&&"range"in e.value&&k.isIRange(e.value.range)?e.value.range:void 0,v=this.contentReferences.find(r=>typeof r.reference=="object"&&"variableName"in r.reference&&r.reference.variableName===e.name),b=v?.options?.status?.kind===E.Omitted,g=b||v?.options?.status?.kind===E.Partial;if(l&&e.isFile){const r=K(l.path),c=V(l.path),d=`${r} ${c}`;let p;b?p=a?h("chat.omittedFileAttachmentWithRange","Omitted: {0}, line {1} to line {2}.",d,a.startLineNumber,a.endLineNumber):h("chat.omittedFileAttachment","Omitted: {0}.",d):g?p=a?h("chat.partialFileAttachmentWithRange","Partially attached: {0}, line {1} to line {2}.",d,a.startLineNumber,a.endLineNumber):h("chat.partialFileAttachment","Partially attached: {0}.",d):p=a?h("chat.fileAttachmentWithRange3","Attached: {0}, line {1} to line {2}.",d,a.startLineNumber,a.endLineNumber):h("chat.fileAttachment3","Attached: {0}.",d),s.setFile(l,{fileKind:U.FILE,hidePath:!0,range:a,title:v?.options?.status?.description}),t.ariaLabel=p,t.tabIndex=0,t.style.cursor="pointer",this.attachedContextDisposables.add(i.addDisposableListener(t,i.EventType.CLICK,async L=>{i.EventHelper.stop(L,!0),l&&this.openerService.open(l,{fromUserGesture:!0,editorOptions:{selection:a}})}))}else if(e.isImage){let r;const c=h("chat.imageAttachment","Attached image, {0}",e.name),d=i.$("div.chat-attached-context-pill",{},i.$("span.codicon.codicon-file-media")),p=i.$("div.chat-attached-context-hover");p.setAttribute("aria-label",c);const L=i.$("span.chat-attached-context-custom-text",{},e.name);t.appendChild(d),t.appendChild(L);try{e.value instanceof I?r=(await this.fileService.readFile(e.value)).value.buffer:r=e.value,await this.createImageElements(r,t,p)}catch{}t.style.position="relative",t.ariaLabel=c,t.tabIndex=0,this.attachedContextDisposables.isDisposed||(this.attachedContextDisposables.add(this.hoverService.setupManagedHover(n,t,p)),this.attachedContextDisposables.add(i.addDisposableListener(t,"keydown",x=>{const C=new T(x);(C.keyCode===A.Enter||C.keyCode===A.Space)&&this.hoverService.showManagedHover(t)})))}else{const r=e.fullName??e.name,c=e.icon?.id?`$(${e.icon.id}) ${r}`:r;s.setLabel(c,v?.options?.status?.description),t.ariaLabel=h("chat.attachment3","Attached context: {0}.",e.name),t.tabIndex=0}g&&t.classList.add("warning");const S=v?.options?.status?.description;if(g){t.ariaLabel=`${t.ariaLabel}${S?` ${S}`:""}`;for(const r of[".monaco-icon-suffix-container",".monaco-icon-name-container"]){const c=s.element.querySelector(r);c&&c.classList.add("warning")}}})}async createImageElements(o,n,e){const t=new Blob([o],{type:"image/png"}),s=URL.createObjectURL(t),l=i.$("img.chat-attached-context-image",{src:s,alt:""}),a=i.$("img.chat-attached-context-pill-image",{src:s,alt:""}),v=i.$("div.chat-attached-context-pill",{},a),b=n.querySelector(".chat-attached-context-pill");b&&b.replaceWith(v),e.appendChild(l)}};y=R([u(3,H),u(4,_),u(5,j),u(6,M)],y);export{y as ChatAttachmentsContentPart};
