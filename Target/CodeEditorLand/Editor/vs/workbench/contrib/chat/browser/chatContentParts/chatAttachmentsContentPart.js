var A=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var R=(u,h,o,n)=>{for(var e=n>1?void 0:n?$(h,o):h,t=u.length-1,s;t>=0;t--)(s=u[t])&&(e=(n?s(h,o,e):s(e))||e);return n&&e&&A(h,o,e),e},y=(u,h)=>(o,n)=>h(o,n,u);import*as a from"../../../../../base/browser/dom.js";import{Disposable as D,DisposableStore as E}from"../../../../../base/common/lifecycle.js";import"../../common/chatModel.js";import{Emitter as F}from"../../../../../base/common/event.js";import{IInstantiationService as N}from"../../../../../platform/instantiation/common/instantiation.js";import{ResourceLabels as O}from"../../../../browser/labels.js";import{URI as L}from"../../../../../base/common/uri.js";import{FileKind as H,IFileService as w}from"../../../../../platform/files/common/files.js";import{Range as U}from"../../../../../editor/common/core/range.js";import{basename as M,dirname as V}from"../../../../../base/common/path.js";import{localize as m}from"../../../../../nls.js";import{ChatResponseReferencePartStatusKind as C}from"../../common/chatService.js";import{IOpenerService as _}from"../../../../../platform/opener/common/opener.js";import{IHoverService as P}from"../../../../../platform/hover/browser/hover.js";import{createInstantHoverDelegate as T}from"../../../../../base/browser/ui/hover/hoverDelegateFactory.js";import"../../../../../base/browser/ui/hover/hover.js";let g=class extends D{constructor(o,n=[],e=a.$(".chat-attached-context"),t,s,l,r){super();this.variables=o;this.contentReferences=n;this.domNode=e;this.instantiationService=t;this.openerService=s;this.hoverService=l;this.fileService=r;this.initAttachedContext(e)}attachedContextDisposables=this._register(new E);_onDidChangeVisibility=this._register(new F);_contextResourceLabels=this.instantiationService.createInstance(O,{onDidChangeVisibility:this._onDidChangeVisibility.event});initAttachedContext(o){a.clearNode(o),this.attachedContextDisposables.clear(),a.setVisibility(!!this.variables.length,this.domNode);const n=this.attachedContextDisposables.add(T());this.variables.forEach(async e=>{const t=a.append(o,a.$(".chat-attached-context-attachment.show-file-icons")),s=this._contextResourceLabels.create(t,{supportIcons:!0,hoverDelegate:n}),l=L.isUri(e.value)?e.value:e.value&&typeof e.value=="object"&&"uri"in e.value&&L.isUri(e.value.uri)?e.value.uri:void 0,r=e.value&&typeof e.value=="object"&&"range"in e.value&&U.isIRange(e.value.range)?e.value.range:void 0,f=this.contentReferences.find(i=>typeof i.reference=="object"&&"variableName"in i.reference&&i.reference.variableName===e.name),b=f?.options?.status?.kind===C.Omitted,I=b||f?.options?.status?.kind===C.Partial;let v,d;if(l&&e.isFile){const i=M(l.path),p=V(l.path),c=`${i} ${p}`;b?d=r?m("chat.omittedFileAttachmentWithRange","Omitted: {0}, line {1} to line {2}.",c,r.startLineNumber,r.endLineNumber):m("chat.omittedFileAttachment","Omitted: {0}.",c):I?d=r?m("chat.partialFileAttachmentWithRange","Partially attached: {0}, line {1} to line {2}.",c,r.startLineNumber,r.endLineNumber):m("chat.partialFileAttachment","Partially attached: {0}.",c):d=r?m("chat.fileAttachmentWithRange3","Attached: {0}, line {1} to line {2}.",c,r.startLineNumber,r.endLineNumber):m("chat.fileAttachment3","Attached: {0}.",c),v=l.fsPath,s.setFile(l,{fileKind:H.FILE,hidePath:!0,range:r,title:f?.options?.status?.description})}else if(e.isImage){d=m("chat.imageAttachment","Attached image, {0}",e.name),v=a.$("div.chat-attached-context-hover"),v.setAttribute("aria-label",d);const i=a.$("div.chat-attached-context-pill",{},a.$("span.codicon.codicon-file-media")),p=a.$("span.chat-attached-context-custom-text",{},e.name);t.appendChild(i),t.appendChild(p);let c;try{e.value instanceof L?c=(await this.fileService.readFile(e.value)).value.buffer:c=e.value,await this.createImageElements(c,t,v)}catch{}t.style.position="relative"}else{const i=e.fullName??e.name,p=e.icon?.id?`$(${e.icon.id}) ${i}`:i;s.setLabel(p,f?.options?.status?.description),v=i,d=m("chat.attachment3","Attached context: {0}.",e.name)}I&&t.classList.add("warning");const x=f?.options?.status?.description;if(I){d=`${d}${x?` ${x}`:""}`,v=x;for(const i of[".monaco-icon-suffix-container",".monaco-icon-name-container"]){const p=s.element.querySelector(i);p&&p.classList.add("warning")}}l&&(t.style.cursor="pointer",this.attachedContextDisposables.add(a.addDisposableListener(t,a.EventType.CLICK,async i=>{a.EventHelper.stop(i,!0),this.openerService.open(l,{fromUserGesture:!0,editorOptions:{selection:r}})}))),t.ariaLabel=d,t.tabIndex=0,this.attachedContextDisposables.isDisposed||this.attachedContextDisposables.add(this.hoverService.setupManagedHover(n,t,v))})}async createImageElements(o,n,e){const t=new Blob([o],{type:"image/png"}),s=URL.createObjectURL(t),l=a.$("img.chat-attached-context-image",{src:s,alt:""}),r=a.$("img.chat-attached-context-pill-image",{src:s,alt:""}),f=a.$("div.chat-attached-context-pill",{},r),b=n.querySelector(".chat-attached-context-pill");b&&b.replaceWith(f),e.appendChild(l)}};g=R([y(3,N),y(4,_),y(5,P),y(6,w)],g);export{g as ChatAttachmentsContentPart};
