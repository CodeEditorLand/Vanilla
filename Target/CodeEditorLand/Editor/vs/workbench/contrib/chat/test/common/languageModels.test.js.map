{
  "version": 3,
  "sources": ["../../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/contrib/chat/test/common/languageModels.test.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { AsyncIterableSource, DeferredPromise, timeout } from '../../../../../base/common/async.js';\nimport { CancellationTokenSource } from '../../../../../base/common/cancellation.js';\nimport { DisposableStore } from '../../../../../base/common/lifecycle.js';\nimport { mock } from '../../../../../base/test/common/mock.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../base/test/common/utils.js';\nimport { NullLogService } from '../../../../../platform/log/common/log.js';\nimport { ChatMessageRole, IChatResponseFragment, languageModelExtensionPoint, LanguageModelsService } from '../../common/languageModels.js';\nimport { IExtensionService, nullExtensionDescription } from '../../../../services/extensions/common/extensions.js';\nimport { ExtensionsRegistry } from '../../../../services/extensions/common/extensionsRegistry.js';\n\nsuite('LanguageModels', function () {\n\n\tlet languageModels: LanguageModelsService;\n\n\tconst store = new DisposableStore();\n\tconst activationEvents = new Set<string>();\n\n\tsetup(function () {\n\n\t\tlanguageModels = new LanguageModelsService(\n\t\t\tnew class extends mock<IExtensionService>() {\n\t\t\t\toverride activateByEvent(name: string) {\n\t\t\t\t\tactivationEvents.add(name);\n\t\t\t\t\treturn Promise.resolve();\n\t\t\t\t}\n\t\t\t},\n\t\t\tnew NullLogService()\n\t\t);\n\n\t\tconst ext = ExtensionsRegistry.getExtensionPoints().find(e => e.name === languageModelExtensionPoint.name)!;\n\n\t\text.acceptUsers([{\n\t\t\tdescription: { ...nullExtensionDescription, enabledApiProposals: ['chatProvider'] },\n\t\t\tvalue: { vendor: 'test-vendor' },\n\t\t\tcollector: null!\n\t\t}]);\n\n\n\t\tstore.add(languageModels.registerLanguageModelChat('1', {\n\t\t\tmetadata: {\n\t\t\t\textension: nullExtensionDescription.identifier,\n\t\t\t\tname: 'Pretty Name',\n\t\t\t\tvendor: 'test-vendor',\n\t\t\t\tfamily: 'test-family',\n\t\t\t\tversion: 'test-version',\n\t\t\t\tid: 'test-id',\n\t\t\t\tmaxInputTokens: 100,\n\t\t\t\tmaxOutputTokens: 100,\n\t\t\t},\n\t\t\tsendChatRequest: async () => {\n\t\t\t\tthrow new Error();\n\t\t\t},\n\t\t\tprovideTokenCount: async () => {\n\t\t\t\tthrow new Error();\n\t\t\t}\n\t\t}));\n\n\t\tstore.add(languageModels.registerLanguageModelChat('12', {\n\t\t\tmetadata: {\n\t\t\t\textension: nullExtensionDescription.identifier,\n\t\t\t\tname: 'Pretty Name',\n\t\t\t\tvendor: 'test-vendor',\n\t\t\t\tfamily: 'test2-family',\n\t\t\t\tversion: 'test2-version',\n\t\t\t\tid: 'test-id',\n\t\t\t\tmaxInputTokens: 100,\n\t\t\t\tmaxOutputTokens: 100,\n\t\t\t},\n\t\t\tsendChatRequest: async () => {\n\t\t\t\tthrow new Error();\n\t\t\t},\n\t\t\tprovideTokenCount: async () => {\n\t\t\t\tthrow new Error();\n\t\t\t}\n\t\t}));\n\t});\n\n\tteardown(function () {\n\t\tlanguageModels.dispose();\n\t\tactivationEvents.clear();\n\t\tstore.clear();\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\ttest('empty selector returns all', async function () {\n\n\t\tconst result1 = await languageModels.selectLanguageModels({});\n\t\tassert.deepStrictEqual(result1.length, 2);\n\t\tassert.deepStrictEqual(result1[0], '1');\n\t\tassert.deepStrictEqual(result1[1], '12');\n\t});\n\n\ttest('no warning that a matching model was not found #213716', async function () {\n\t\tconst result1 = await languageModels.selectLanguageModels({ vendor: 'test-vendor' });\n\t\tassert.deepStrictEqual(result1.length, 2);\n\n\t\tconst result2 = await languageModels.selectLanguageModels({ vendor: 'test-vendor', family: 'FAKE' });\n\t\tassert.deepStrictEqual(result2.length, 0);\n\t});\n\n\ttest('sendChatRequest returns a response-stream', async function () {\n\n\t\tstore.add(languageModels.registerLanguageModelChat('actual', {\n\t\t\tmetadata: {\n\t\t\t\textension: nullExtensionDescription.identifier,\n\t\t\t\tname: 'Pretty Name',\n\t\t\t\tvendor: 'test-vendor',\n\t\t\t\tfamily: 'actual-family',\n\t\t\t\tversion: 'actual-version',\n\t\t\t\tid: 'actual-lm',\n\t\t\t\tmaxInputTokens: 100,\n\t\t\t\tmaxOutputTokens: 100,\n\t\t\t},\n\t\t\tsendChatRequest: async (messages, _from, _options, token) => {\n\t\t\t\t// const message = messages.at(-1);\n\n\t\t\t\tconst defer = new DeferredPromise();\n\t\t\t\tconst stream = new AsyncIterableSource<IChatResponseFragment>();\n\n\t\t\t\t(async () => {\n\t\t\t\t\twhile (!token.isCancellationRequested) {\n\t\t\t\t\t\tstream.emitOne({ index: 0, part: { type: 'text', value: Date.now().toString() } });\n\t\t\t\t\t\tawait timeout(10);\n\t\t\t\t\t}\n\t\t\t\t\tdefer.complete(undefined);\n\t\t\t\t})();\n\n\t\t\t\treturn {\n\t\t\t\t\tstream: stream.asyncIterable,\n\t\t\t\t\tresult: defer.p\n\t\t\t\t};\n\t\t\t},\n\t\t\tprovideTokenCount: async () => {\n\t\t\t\tthrow new Error();\n\t\t\t}\n\t\t}));\n\n\t\tconst models = await languageModels.selectLanguageModels({ identifier: 'actual-lm' });\n\t\tassert.ok(models.length === 1);\n\n\t\tconst first = models[0];\n\n\t\tconst cts = new CancellationTokenSource();\n\n\t\tconst request = await languageModels.sendChatRequest(first, nullExtensionDescription.identifier, [{ role: ChatMessageRole.User, content: [{ type: 'text', value: 'hello' }] }], {}, cts.token);\n\n\t\tassert.ok(request);\n\n\t\tcts.dispose(true);\n\n\t\tawait request.result;\n\t});\n});\n"],
  "mappings": "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",
  "names": []
}
