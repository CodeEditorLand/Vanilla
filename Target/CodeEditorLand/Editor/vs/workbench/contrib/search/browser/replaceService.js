var g=Object.defineProperty;var y=Object.getOwnPropertyDescriptor;var v=(c,e,o,i)=>{for(var r=i>1?void 0:i?y(e,o):e,t=c.length-1,s;t>=0;t--)(s=c[t])&&(r=(i?s(e,o,r):s(r))||r);return i&&r&&g(e,o,r),r},a=(c,e)=>(o,i)=>e(o,i,c);import*as I from"../../../../nls.js";import*as m from"../../../../base/common/network.js";import{Disposable as b}from"../../../../base/common/lifecycle.js";import{IReplaceService as x}from"./replace.js";import{IEditorService as P}from"../../../services/editor/common/editorService.js";import{IModelService as T}from"../../../../editor/common/services/model.js";import{ILanguageService as k}from"../../../../editor/common/languages/language.js";import{Match as f,FileMatch as F,ISearchViewModelWorkbenchService as w,MatchInNotebook as C}from"./searchModel.js";import{ITextModelService as S}from"../../../../editor/common/services/resolverService.js";import{ScrollType as U}from"../../../../editor/common/editorCommon.js";import{IInstantiationService as L}from"../../../../platform/instantiation/common/instantiation.js";import{createTextBufferFactoryFromSnapshot as O}from"../../../../editor/common/model/textModel.js";import{ITextFileService as _}from"../../../services/textfile/common/textfiles.js";import{IBulkEditService as N,ResourceTextEdit as W}from"../../../../editor/browser/services/bulkEditService.js";import{Range as M}from"../../../../editor/common/core/range.js";import{EditOperation as V}from"../../../../editor/common/core/editOperation.js";import{ILabelService as A}from"../../../../platform/label/common/label.js";import{dirname as D}from"../../../../base/common/resources.js";import{Promises as B}from"../../../../base/common/async.js";import{SaveSourceRegistry as j}from"../../../common/editor.js";import{CellUri as q}from"../../notebook/common/notebookCommon.js";import{INotebookEditorModelResolverService as z}from"../../notebook/common/notebookEditorModelResolverService.js";const E="replacePreview",R=c=>c.with({scheme:m.Schemas.internal,fragment:E,query:JSON.stringify({scheme:c.scheme})}),J=c=>c.with({scheme:JSON.parse(c.query).scheme,fragment:"",query:""});let u=class{constructor(e,o){this.instantiationService=e;this.textModelResolverService=o;this.textModelResolverService.registerTextModelContentProvider(m.Schemas.internal,this)}static ID="workbench.contrib.replacePreviewContentProvider";provideTextContent(e){return e.fragment===E?this.instantiationService.createInstance(h).resolve(e):null}};u=v([a(0,L),a(1,S)],u);let h=class extends b{constructor(o,i,r,t,s){super();this.modelService=o;this.languageService=i;this.textModelResolverService=r;this.replaceService=t;this.searchWorkbenchService=s}async resolve(o){const i=J(o),r=this.searchWorkbenchService.searchModel.searchResult.matches().filter(p=>p.resource.toString()===i.toString())[0],s=this._register(await this.textModelResolverService.createModelReference(i)).object.textEditorModel,n=s.getLanguageId(),l=this.modelService.createModel(O(s.createSnapshot()),this.languageService.createById(n),o);return this._register(r.onChange(({forceUpdateModel:p})=>this.update(s,l,r,p))),this._register(this.searchWorkbenchService.searchModel.onReplaceTermChanged(()=>this.update(s,l,r))),this._register(r.onDispose(()=>l.dispose())),this._register(l.onWillDispose(()=>this.dispose())),this._register(s.onWillDispose(()=>this.dispose())),l}update(o,i,r,t=!1){!o.isDisposed()&&!i.isDisposed()&&this.replaceService.updateReplacePreview(r,t)}};h=v([a(0,T),a(1,k),a(2,S),a(3,x),a(4,w)],h);let d=class{constructor(e,o,i,r,t,s){this.textFileService=e;this.editorService=o;this.textModelResolverService=i;this.bulkEditorService=r;this.labelService=t;this.notebookEditorModelResolverService=s}static REPLACE_SAVE_SOURCE=j.registerSource("searchReplace.source",I.localize("searchReplace.source","Search and Replace"));async replace(e,o=void 0,i=null){const r=this.createEdits(e,i);await this.bulkEditorService.apply(r,{progress:o});const t=r.map(async s=>{if(s.resource.scheme===m.Schemas.vscodeNotebookCell){const n=q.parse(s.resource)?.notebook;if(n){let l;try{l=await this.notebookEditorModelResolverService.resolve(n),await l.object.save({source:d.REPLACE_SAVE_SOURCE})}finally{l?.dispose()}}return}else return this.textFileService.files.get(s.resource)?.save({source:d.REPLACE_SAVE_SOURCE})});return B.settled(t)}async openReplacePreview(e,o,i,r){const t=e instanceof f?e.parent():e,s=await this.editorService.openEditor({original:{resource:t.resource},modified:{resource:R(t.resource)},label:I.localize("fileReplaceChanges","{0} \u2194 {1} (Replace Preview)",t.name(),t.name()),description:this.labelService.getUriLabel(D(t.resource),{relative:!0}),options:{preserveFocus:o,pinned:r,revealIfVisible:!0}}),n=s?.input,l=t.onDispose(()=>{n?.dispose(),l.dispose()});if(await this.updateReplacePreview(t),s){const p=s.getControl();e instanceof f&&p&&p.revealLineInCenter(e.range().startLineNumber,U.Immediate)}}async updateReplacePreview(e,o=!1){const i=R(e.resource),[r,t]=await Promise.all([this.textModelResolverService.createModelReference(e.resource),this.textModelResolverService.createModelReference(i)]),s=r.object.textEditorModel,n=t.object.textEditorModel;try{s&&n&&(o?n.setValue(s.getValue()):n.undo(),this.applyEditsToPreview(e,n))}finally{r.dispose(),t.dispose()}}applyEditsToPreview(e,o){const i=this.createEdits(e,o.uri),r=[];for(const t of i)r.push(V.replaceMove(M.lift(t.textEdit.range),t.textEdit.text));o.pushEditOperations([],r.sort((t,s)=>M.compareRangesUsingStarts(t.range,s.range)),()=>[])}createEdits(e,o=null){const i=[];if(e instanceof f)if(e instanceof C){if(!e.isReadonly()){const r=e;i.push(this.createEdit(r,r.replaceString,r.cell?.uri))}}else{const r=e;i.push(this.createEdit(r,r.replaceString,o))}return e instanceof F&&(e=[e]),e instanceof Array&&e.forEach(r=>{const t=r;t.count()>0&&i.push(...t.matches().flatMap(s=>this.createEdits(s,o)))}),i}createEdit(e,o,i=null){const r=e.parent();return new W(i??r.resource,{range:e.range(),text:o},void 0,void 0)}};d=v([a(0,_),a(1,P),a(2,S),a(3,N),a(4,A),a(5,z)],d);export{u as ReplacePreviewContentProvider,d as ReplaceService};
