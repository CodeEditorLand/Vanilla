var ye=Object.defineProperty;var Re=Object.getOwnPropertyDescriptor;var v=(h,s,e,t)=>{for(var r=t>1?void 0:t?Re(s,e):s,i=h.length-1,o;i>=0;i--)(o=h[i])&&(r=(t?o(s,e,r):o(r))||r);return t&&r&&ye(s,e,r),r},l=(h,s)=>(e,t)=>s(e,t,h);import{coalesce as Z}from"../../../../base/common/arrays.js";import{RunOnceScheduler as B}from"../../../../base/common/async.js";import{CancellationToken as Fe,CancellationTokenSource as ee}from"../../../../base/common/cancellation.js";import{compareFileExtensions as te,compareFileNames as U,comparePaths as re}from"../../../../base/common/comparers.js";import{memoize as we}from"../../../../base/common/decorators.js";import*as xe from"../../../../base/common/errors.js";import{Emitter as w,Event as Ee,PauseableEmitter as ie}from"../../../../base/common/event.js";import{Lazy as z}from"../../../../base/common/lazy.js";import{Disposable as A,DisposableStore as ke}from"../../../../base/common/lifecycle.js";import{ResourceMap as D}from"../../../../base/common/map.js";import{Schemas as $}from"../../../../base/common/network.js";import{lcut as Pe}from"../../../../base/common/strings.js";import{TernarySearchTree as m}from"../../../../base/common/ternarySearchTree.js";import{URI as De}from"../../../../base/common/uri.js";import{Range as V}from"../../../../editor/common/core/range.js";import{FindMatch as Te,MinimapPosition as se,OverviewRulerLane as oe,TrackedRangeStickiness as G}from"../../../../editor/common/model.js";import{ModelDecorationOptions as j}from"../../../../editor/common/model/textModel.js";import{IModelService as X}from"../../../../editor/common/services/model.js";import{IConfigurationService as We}from"../../../../platform/configuration/common/configuration.js";import{IInstantiationService as S,createDecorator as Ne}from"../../../../platform/instantiation/common/instantiation.js";import{ILabelService as T}from"../../../../platform/label/common/label.js";import{ILogService as Ue}from"../../../../platform/log/common/log.js";import{IProgressService as Ae,ProgressLocation as Le}from"../../../../platform/progress/common/progress.js";import{ITelemetryService as He}from"../../../../platform/telemetry/common/telemetry.js";import{minimapFindMatch as ae,overviewRulerFindMatchForeground as ne}from"../../../../platform/theme/common/colorRegistry.js";import{themeColorFromId as L}from"../../../../platform/theme/common/themeService.js";import{IUriIdentityService as W}from"../../../../platform/uriIdentity/common/uriIdentity.js";import{ReplacePattern as he}from"../../../services/search/common/replace.js";import{DEFAULT_MAX_SEARCH_RESULTS as ce,ISearchService as Qe,OneLineRange as Oe,QueryType as qe,SearchCompletionExitCode as ze,SearchSortOrder as _,resultIsMatch as H}from"../../../services/search/common/search.js";import{editorMatchesToTextSearchResults as $e,getTextSearchMatchWithModelContext as le}from"../../../services/search/common/searchHelpers.js";import{FindMatchDecorationModel as Ve}from"../../notebook/browser/contrib/find/findMatchDecorationModel.js";import{CellFindMatchModel as Ge}from"../../notebook/browser/contrib/find/findModel.js";import{NotebookEditorWidget as je}from"../../notebook/browser/notebookEditorWidget.js";import{INotebookEditorService as de}from"../../notebook/browser/services/notebookEditorService.js";import{NotebookCellsChangeType as ue}from"../../notebook/common/notebookCommon.js";import{CellSearchModel as Xe}from"../common/cellSearchModel.js";import{INotebookSearchService as Ke}from"../common/notebookSearch.js";import{isINotebookFileMatchNoModel as pe,rawCellPrefix as Me}from"../common/searchNotebookHelpers.js";import{contentMatchesToTextSearchMatches as Je,getIDFromINotebookCellMatch as Ye,isINotebookCellMatchWithModel as Ze,isINotebookFileMatchWithModel as ge,webviewMatchesToTextSearchMatches as Be}from"./notebookSearch/searchNotebookHelpers.js";import{IReplaceService as x}from"./replace.js";const O=class O{constructor(s,e,t,r,i){this._parent=s;this._fullPreviewLines=e;this.aiContributed=i;this._oneLinePreviewText=e[t.startLineNumber];const o=t.startLineNumber===t.endLineNumber?t.endColumn:this._oneLinePreviewText.length;this._rangeInPreviewText=new Oe(1,t.startColumn+1,o+1),this._range=new V(r.startLineNumber+1,r.startColumn+1,r.endLineNumber+1,r.endColumn+1),this._fullPreviewRange=t,this._id=this._parent.id()+">"+this._range+this.getMatchString()}static MAX_PREVIEW_CHARS=250;_id;_range;_oneLinePreviewText;_rangeInPreviewText;_fullPreviewRange;id(){return this._id}parent(){return this._parent}text(){return this._oneLinePreviewText}range(){return this._range}preview(){const s=this._oneLinePreviewText.substring(0,this._rangeInPreviewText.startColumn-1),e=Pe(s,26,"\u2026");let t=this.getMatchString(),r=this._oneLinePreviewText.substring(this._rangeInPreviewText.endColumn-1),i=O.MAX_PREVIEW_CHARS-e.length;return t=t.substr(0,i),i-=t.length,r=r.substr(0,i),{before:e,fullBefore:s,inside:t,after:r}}get replaceString(){const s=this.parent().parent().searchModel;if(!s.replacePattern)throw new Error("searchModel.replacePattern must be set before accessing replaceString");const e=this.fullMatchText();let t=s.replacePattern.getReplaceString(e,s.preserveCase);if(t!==null)return t;const r=e.replace(/\r\n/g,`
`);if(r!==e&&(t=s.replacePattern.getReplaceString(r,s.preserveCase),t!==null))return t;const i=this.fullMatchText(!0);if(t=s.replacePattern.getReplaceString(i,s.preserveCase),t!==null)return t;const o=i.replace(/\r\n/g,`
`);return o!==i&&(t=s.replacePattern.getReplaceString(o,s.preserveCase),t!==null)?t:s.replacePattern.pattern}fullMatchText(s=!1){let e;return s?e=this._fullPreviewLines:(e=this._fullPreviewLines.slice(this._fullPreviewRange.startLineNumber,this._fullPreviewRange.endLineNumber+1),e[e.length-1]=e[e.length-1].slice(0,this._fullPreviewRange.endColumn),e[0]=e[0].slice(this._fullPreviewRange.startColumn)),e.join(`
`)}rangeInPreview(){return{...this._fullPreviewRange,startColumn:this._fullPreviewRange.startColumn+1,endColumn:this._fullPreviewRange.endColumn+1}}fullPreviewLines(){return this._fullPreviewLines.slice(this._fullPreviewRange.startLineNumber,this._fullPreviewRange.endLineNumber+1)}getMatchString(){return this._oneLinePreviewText.substring(this._rangeInPreviewText.startColumn-1,this._rangeInPreviewText.endColumn-1)}};v([we],O.prototype,"preview",1);let C=O;class fe{constructor(s,e,t){this._parent=s;this._cell=e;this._cellIndex=t;this._contentMatches=new Map,this._webviewMatches=new Map,this._context=new Map}_contentMatches;_webviewMatches;_context;hasCellViewModel(){return!(this._cell instanceof Xe)}get context(){return new Map(this._context)}matches(){return[...this._contentMatches.values(),...this._webviewMatches.values()]}get contentMatches(){return Array.from(this._contentMatches.values())}get webviewMatches(){return Array.from(this._webviewMatches.values())}remove(s){Array.isArray(s)||(s=[s]);for(const e of s)this._contentMatches.delete(e.id()),this._webviewMatches.delete(e.id())}clearAllMatches(){this._contentMatches.clear(),this._webviewMatches.clear()}addContentMatches(s){_e(s,this).forEach(t=>{this._contentMatches.set(t.id(),t)}),this.addContext(s)}addContext(s){this.cell&&this.cell.resolveTextModel().then(e=>{le(s,e,this.parent.parent().query).filter(i=>!H(i)).map(i=>({...i,lineNumber:i.lineNumber+1})).forEach(i=>{this._context.set(i.lineNumber,i.text)})})}addWebviewMatches(s){_e(s,this).forEach(t=>{this._webviewMatches.set(t.id(),t)})}setCellModel(s){this._cell=s}get parent(){return this._parent}get id(){return this._cell?.id??`${Me}${this.cellIndex}`}get cellIndex(){return this._cellIndex}get cell(){return this._cell}}class b extends C{constructor(e,t,r,i,o){super(e.parent,t,r,i,!1);this._cellParent=e;this._id=this._parent.id()+">"+this._cellParent.cellIndex+(o?"_"+o:"")+"_"+this.notebookMatchTypeString()+this._range+this.getMatchString(),this._webviewIndex=o}_webviewIndex;parent(){return this._cellParent.parent}get cellParent(){return this._cellParent}notebookMatchTypeString(){return this.isWebviewMatch()?"webview":"content"}isWebviewMatch(){return this._webviewIndex!==void 0}isReadonly(){return!this._cellParent.hasCellViewModel()||this.isWebviewMatch()}get cellIndex(){return this._cellParent.cellIndex}get webviewIndex(){return this._webviewIndex}get cell(){return this._cellParent.cell}}let p=class extends A{constructor(e,t,r,i,o,a,n,c,u,d,f){super();this._query=e;this._previewOptions=t;this._maxResults=r;this._parent=i;this.rawMatch=o;this._closestRoot=a;this.searchInstanceID=n;this.modelService=c;this.replaceService=u;this.notebookEditorService=f;this._resource=this.rawMatch.resource,this._textMatches=new Map,this._removedTextMatches=new Set,this._updateScheduler=new B(this.updateMatchesForModel.bind(this),250),this._name=new z(()=>d.getUriBasenameLabel(this.resource)),this._cellMatches=new Map,this._notebookUpdateScheduler=new B(this.updateMatchesForEditorWidget.bind(this),250)}static _CURRENT_FIND_MATCH=j.register({description:"search-current-find-match",stickiness:G.NeverGrowsWhenTypingAtEdges,zIndex:13,className:"currentFindMatch",overviewRuler:{color:L(ne),position:oe.Center},minimap:{color:L(ae),position:se.Inline}});static _FIND_MATCH=j.register({description:"search-find-match",stickiness:G.NeverGrowsWhenTypingAtEdges,className:"findMatch",overviewRuler:{color:L(ne),position:oe.Center},minimap:{color:L(ae),position:se.Inline}});static getDecorationOption(e){return e?p._CURRENT_FIND_MATCH:p._FIND_MATCH}_onChange=this._register(new w);onChange=this._onChange.event;_onDispose=this._register(new w);onDispose=this._onDispose.event;_resource;_fileStat;_model=null;_modelListener=null;_textMatches;_cellMatches;_removedTextMatches;_selectedMatch=null;_name;_updateScheduler;_modelDecorations=[];_context=new Map;get context(){return new Map(this._context)}get cellContext(){const e=new Map;return this._cellMatches.forEach(t=>{e.set(t.id,t.context)}),e}_notebookEditorWidget=null;_editorWidgetListener=null;_notebookUpdateScheduler;_findMatchDecorationModel;_lastEditorWidgetIdForUpdate;addWebviewMatchesToCell(e,t){const r=this.getCellMatch(e);r!==void 0&&r.addWebviewMatches(t)}addContentMatchesToCell(e,t){const r=this.getCellMatch(e);r!==void 0&&r.addContentMatches(t)}getCellMatch(e){return this._cellMatches.get(e)}addCellMatch(e){const t=new fe(this,Ze(e)?e.cell:void 0,e.index);this._cellMatches.set(t.id,t),this.addWebviewMatchesToCell(t.id,e.webviewResults),this.addContentMatchesToCell(t.id,e.contentResults)}get closestRoot(){return this._closestRoot}hasReadonlyMatches(){return this.matches().some(e=>e instanceof b&&e.isReadonly())}createMatches(e){const t=this.modelService.getModel(this._resource);if(t&&!e)this.bindModel(t),this.updateMatchesForModel();else{const r=this.notebookEditorService.retrieveExistingWidgetFromURI(this.resource);r?.value&&this.bindNotebookEditorWidget(r.value),this.rawMatch.results&&this.rawMatch.results.filter(H).forEach(i=>{Y(i,this,e).forEach(o=>this.add(o))}),(ge(this.rawMatch)||pe(this.rawMatch))&&(this.rawMatch.cellResults?.forEach(i=>this.addCellMatch(i)),this.setNotebookFindMatchDecorationsUsingCellMatches(this.cellMatches()),this._onChange.fire({forceUpdateModel:!0})),this.addContext(this.rawMatch.results)}}bindModel(e){this._model=e,this._modelListener=this._model.onDidChangeContent(()=>{this._updateScheduler.schedule()}),this._model.onWillDispose(()=>this.onModelWillDispose()),this.updateHighlights()}onModelWillDispose(){this.updateMatchesForModel(),this.unbindModel()}unbindModel(){this._model&&(this._updateScheduler.cancel(),this._model.changeDecorations(e=>{this._modelDecorations=e.deltaDecorations(this._modelDecorations,[])}),this._model=null,this._modelListener.dispose())}updateMatchesForModel(){if(!this._model)return;this._textMatches=new Map;const e=this._query.isWordMatch&&this._query.wordSeparators?this._query.wordSeparators:null,t=this._model.findMatches(this._query.pattern,this._model.getFullModelRange(),!!this._query.isRegExp,!!this._query.isCaseSensitive,e,!1,this._maxResults??ce);this.updateMatches(t,!0,this._model,!1)}async updatesMatchesForLineAfterReplace(e,t){if(!this._model)return;const r={startLineNumber:e,startColumn:this._model.getLineMinColumn(e),endLineNumber:e,endColumn:this._model.getLineMaxColumn(e)};Array.from(this._textMatches.values()).filter(n=>n.range().startLineNumber===e).forEach(n=>this._textMatches.delete(n.id()));const o=this._query.isWordMatch&&this._query.wordSeparators?this._query.wordSeparators:null,a=this._model.findMatches(this._query.pattern,r,!!this._query.isRegExp,!!this._query.isCaseSensitive,o,!1,this._maxResults??ce);this.updateMatches(a,t,this._model,!1)}updateMatches(e,t,r,i){const o=$e(e,r,this._previewOptions);o.forEach(a=>{Y(a,this,i).forEach(n=>{this._removedTextMatches.has(n.id())||(this.add(n),this.isMatchSelected(n)&&(this._selectedMatch=n))})}),this.addContext(le(o,r,this.parent().parent().query)),this._onChange.fire({forceUpdateModel:t}),this.updateHighlights()}updateHighlights(){this._model&&this._model.changeDecorations(e=>{const t=this.parent().showHighlights?this.matches().map(r=>({range:r.range(),options:p.getDecorationOption(this.isMatchSelected(r))})):[];this._modelDecorations=e.deltaDecorations(this._modelDecorations,t)})}id(){return this.resource.toString()}parent(){return this._parent}matches(){const e=Array.from(this._cellMatches.values()).flatMap(t=>t.matches());return[...this._textMatches.values(),...e]}textMatches(){return Array.from(this._textMatches.values())}cellMatches(){return Array.from(this._cellMatches.values())}remove(e){Array.isArray(e)||(e=[e]);for(const t of e)this.removeMatch(t),this._removedTextMatches.add(t.id());this._onChange.fire({didRemove:!0})}replaceQ=Promise.resolve();async replace(e){return this.replaceQ=this.replaceQ.finally(async()=>{await this.replaceService.replace(e),await this.updatesMatchesForLineAfterReplace(e.range().startLineNumber,!1)})}setSelectedMatch(e){if(e){if(!this.isMatchSelected(e)&&e instanceof b){this._selectedMatch=e;return}if(!this._textMatches.has(e.id())||this.isMatchSelected(e))return}this._selectedMatch=e,this.updateHighlights()}getSelectedMatch(){return this._selectedMatch}isMatchSelected(e){return!!this._selectedMatch&&this._selectedMatch.id()===e.id()}count(){return this.matches().length}get resource(){return this._resource}name(){return this._name.value}addContext(e){return e?e.filter(r=>!H(r)).forEach(r=>this._context.set(r.lineNumber,r.text)):void 0}add(e,t){this._textMatches.set(e.id(),e),t&&this._onChange.fire({forceUpdateModel:!0})}removeMatch(e){e instanceof b?(e.cellParent.remove(e),e.cellParent.matches().length===0&&this._cellMatches.delete(e.cellParent.id)):this._textMatches.delete(e.id()),this.isMatchSelected(e)?(this.setSelectedMatch(null),this._findMatchDecorationModel?.clearCurrentFindMatchDecoration()):this.updateHighlights(),e instanceof b&&this.setNotebookFindMatchDecorationsUsingCellMatches(this.cellMatches())}async resolveFileStat(e){this._fileStat=await e.stat(this.resource).catch(()=>{})}get fileStat(){return this._fileStat}set fileStat(e){this._fileStat=e}dispose(){this.setSelectedMatch(null),this.unbindModel(),this.unbindNotebookEditorWidget(),this._onDispose.fire(),super.dispose()}hasOnlyReadOnlyMatches(){return this.matches().every(e=>e instanceof b&&e.isReadonly())}bindNotebookEditorWidget(e){this._notebookEditorWidget!==e&&(this._notebookEditorWidget=e,this._editorWidgetListener=this._notebookEditorWidget.textModel?.onDidChangeContent(t=>{t.rawEvents.some(r=>r.kind===ue.ChangeCellContent||r.kind===ue.ModelChange)&&this._notebookUpdateScheduler.schedule()})??null,this._addNotebookHighlights())}unbindNotebookEditorWidget(e){e&&this._notebookEditorWidget!==e||(this._notebookEditorWidget&&(this._notebookUpdateScheduler.cancel(),this._editorWidgetListener?.dispose()),this._removeNotebookHighlights(),this._notebookEditorWidget=null)}updateNotebookHighlights(){this.parent().showHighlights?(this._addNotebookHighlights(),this.setNotebookFindMatchDecorationsUsingCellMatches(Array.from(this._cellMatches.values()))):this._removeNotebookHighlights()}_addNotebookHighlights(){this._notebookEditorWidget&&(this._findMatchDecorationModel?.stopWebviewFind(),this._findMatchDecorationModel?.dispose(),this._findMatchDecorationModel=new Ve(this._notebookEditorWidget,this.searchInstanceID),this._selectedMatch instanceof b&&this.highlightCurrentFindMatchDecoration(this._selectedMatch))}_removeNotebookHighlights(){this._findMatchDecorationModel&&(this._findMatchDecorationModel?.stopWebviewFind(),this._findMatchDecorationModel?.dispose(),this._findMatchDecorationModel=void 0)}updateNotebookMatches(e,t){if(!this._notebookEditorWidget)return;const r=new Map(this._cellMatches);this._notebookEditorWidget.getId()!==this._lastEditorWidgetIdForUpdate&&(this._cellMatches.clear(),this._lastEditorWidgetIdForUpdate=this._notebookEditorWidget.getId()),e.forEach(i=>{let o=this._cellMatches.get(i.cell.id);if(this._notebookEditorWidget&&!o){const n=this._notebookEditorWidget.getCellIndex(i.cell),c=r.get(`${Me}${n}`);c&&(c.setCellModel(i.cell),c.clearAllMatches(),o=c)}o?.clearAllMatches();const a=o??new fe(this,i.cell,i.index);a.addContentMatches(Je(i.contentMatches,i.cell)),a.addWebviewMatches(Be(i.webviewMatches)),this._cellMatches.set(a.id,a)}),this._findMatchDecorationModel?.setAllFindMatchesDecorations(e),this._selectedMatch instanceof b&&this.highlightCurrentFindMatchDecoration(this._selectedMatch),this._onChange.fire({forceUpdateModel:t})}setNotebookFindMatchDecorationsUsingCellMatches(e){if(!this._findMatchDecorationModel)return;const t=Z(e.map(r=>{const i=Z(r.webviewMatches.map(a=>{if(a.webviewIndex)return{index:a.webviewIndex}}));if(!r.cell)return;const o=r.contentMatches.map(a=>new Te(a.range(),[a.text()]));return new Ge(r.cell,r.cellIndex,o,i)}));try{this._findMatchDecorationModel.setAllFindMatchesDecorations(t)}catch{}}async updateMatchesForEditorWidget(){if(!this._notebookEditorWidget)return;this._textMatches=new Map;const e=this._query.isWordMatch&&this._query.wordSeparators?this._query.wordSeparators:null,t=await this._notebookEditorWidget.find(this._query.pattern,{regex:this._query.isRegExp,wholeWord:this._query.isWordMatch,caseSensitive:this._query.isCaseSensitive,wordSeparators:e??void 0,includeMarkupInput:this._query.notebookInfo?.isInNotebookMarkdownInput,includeMarkupPreview:this._query.notebookInfo?.isInNotebookMarkdownPreview,includeCodeInput:this._query.notebookInfo?.isInNotebookCellInput,includeOutput:this._query.notebookInfo?.isInNotebookCellOutput},Fe.None,!1,!0,this.searchInstanceID);this.updateNotebookMatches(t,!0)}async showMatch(e){const t=await this.highlightCurrentFindMatchDecoration(e);this.setSelectedMatch(e),this.revealCellRange(e,t)}async highlightCurrentFindMatchDecoration(e){return!this._findMatchDecorationModel||!e.cell?null:e.webviewIndex===void 0?this._findMatchDecorationModel.highlightCurrentFindMatchDecorationInCell(e.cell,e.range()):this._findMatchDecorationModel.highlightCurrentFindMatchDecorationInWebview(e.cell,e.webviewIndex)}revealCellRange(e,t){!this._notebookEditorWidget||!e.cell||(e.webviewIndex!==void 0?this._notebookEditorWidget.getCellIndex(e.cell)!==void 0&&this._notebookEditorWidget.revealCellOffsetInCenter(e.cell,t??0):(e.cell.updateEditState(e.cell.getEditState(),"focusNotebookCell"),this._notebookEditorWidget.setCellEditorSelection(e.cell,e.range()),this._notebookEditorWidget.revealRangeInCenterIfOutsideViewportAsync(e.cell,e.range())))}};p=v([l(7,X),l(8,x),l(9,T),l(10,de)],p);let g=class extends A{constructor(e,t,r,i,o,a,n,c,u,d,f){super();this._resource=e;this._id=t;this._index=r;this._query=i;this._parent=o;this._searchResult=a;this._closestRoot=n;this.replaceService=c;this.instantiationService=u;this.uriIdentityService=f;this._fileMatches=new D,this._folderMatches=new D,this._folderMatchesMap=m.forUris(M=>this.uriIdentityService.extUri.ignorePathCasing(M)),this._unDisposedFileMatches=new D,this._unDisposedFolderMatches=new D,this._name=new z(()=>this.resource?d.getUriBasenameLabel(this.resource):"")}_onChange=this._register(new w);onChange=this._onChange.event;_onDispose=this._register(new w);onDispose=this._onDispose.event;_fileMatches;_folderMatches;_folderMatchesMap;_unDisposedFileMatches;_unDisposedFolderMatches;_replacingAll=!1;_name;get searchModel(){return this._searchResult.searchModel}get showHighlights(){return this._parent.showHighlights}get closestRoot(){return this._closestRoot}set replacingAll(e){this._replacingAll=e}id(){return this._id}get resource(){return this._resource}index(){return this._index}name(){return this._name.value}parent(){return this._parent}bindModel(e){const t=this._fileMatches.get(e.uri);t?t.bindModel(e):this.getFolderMatch(e.uri)?.getDownstreamFileMatch(e.uri)?.bindModel(e)}async bindNotebookEditorWidget(e,t){const r=this._fileMatches.get(t);if(r)r.bindNotebookEditorWidget(e),await r.updateMatchesForEditorWidget();else{const i=this.folderMatchesIterator();for(const o of i)await o.bindNotebookEditorWidget(e,t)}}unbindNotebookEditorWidget(e,t){const r=this._fileMatches.get(t);if(r)r.unbindNotebookEditorWidget(e);else{const i=this.folderMatchesIterator();for(const o of i)o.unbindNotebookEditorWidget(e,t)}}createIntermediateFolderMatch(e,t,r,i,o){const a=this._register(this.instantiationService.createInstance(y,e,t,r,i,this,this._searchResult,o));return this.configureIntermediateMatch(a),this.doAddFolder(a),a}configureIntermediateMatch(e){const t=e.onChange(r=>this.onFolderChange(e,r));this._register(e.onDispose(()=>t.dispose()))}clear(e=!1){const t=this.allDownstreamFileMatches();this.disposeMatches(),this._onChange.fire({elements:t,removed:!0,added:!1,clearingAll:e})}remove(e){Array.isArray(e)||(e=[e]);const t=be(e);this.doRemoveFile(t)}async replace(e){return this.replaceService.replace([e]).then(()=>{this.doRemoveFile([e],!0,!0,!0)})}replaceAll(){const e=this.matches();return this.batchReplace(e)}matches(){return[...this.fileMatchesIterator(),...this.folderMatchesIterator()]}fileMatchesIterator(){return this._fileMatches.values()}folderMatchesIterator(){return this._folderMatches.values()}isEmpty(){return this.fileCount()+this.folderCount()===0}getDownstreamFileMatch(e){const t=this._fileMatches.get(e);if(t)return t;const i=this.getFolderMatch(e)?.getDownstreamFileMatch(e);return i||null}allDownstreamFileMatches(){let e=[];const t=this.folderMatchesIterator();for(const r of t)e=e.concat(r.allDownstreamFileMatches());return[...this.fileMatchesIterator(),...e]}fileCount(){return this._fileMatches.size}folderCount(){return this._folderMatches.size}count(){return this.fileCount()+this.folderCount()}recursiveFileCount(){return this.allDownstreamFileMatches().length}recursiveMatchCount(){return this.allDownstreamFileMatches().reduce((e,t)=>e+t.count(),0)}get query(){return this._query}addFileMatch(e,t,r,i){const o=[],a=[];e.forEach(c=>{const u=this.getDownstreamFileMatch(c.resource);if(u)c.results&&c.results.filter(H).forEach(d=>{Y(d,u,i).forEach(f=>u.add(f))}),(ge(c)||pe(c))&&c.cellResults?.forEach(d=>{const f=u.getCellMatch(Ye(d));f?(f.addContentMatches(d.contentResults),f.addWebviewMatches(d.webviewResults)):u.addCellMatch(d)}),a.push(u),c.results&&c.results.length>0&&u.addContext(c.results);else if(this instanceof E||this instanceof k){const d=this.createAndConfigureFileMatch(c,r);o.push(d)}});const n=[...o,...a];!t&&n.length&&this._onChange.fire({elements:n,added:!!o.length})}doAddFile(e){this._fileMatches.set(e.resource,e),this._unDisposedFileMatches.has(e.resource)&&this._unDisposedFileMatches.delete(e.resource)}hasOnlyReadOnlyMatches(){return Array.from(this._fileMatches.values()).every(e=>e.hasOnlyReadOnlyMatches())}uriHasParent(e,t){return this.uriIdentityService.extUri.isEqualOrParent(t,e)&&!this.uriIdentityService.extUri.isEqual(t,e)}isInParentChain(e){let t=this;for(;t instanceof g;){if(t.id()===e.id())return!0;t=t.parent()}return!1}getFolderMatch(e){return this._folderMatchesMap.findSubstr(e)}doAddFolder(e){if(this instanceof y&&!this.uriHasParent(this.resource,e.resource))throw Error(`${e.resource} does not belong as a child of ${this.resource}`);if(this.isInParentChain(e))throw Error(`${e.resource} is a parent of ${this.resource}`);this._folderMatches.set(e.resource,e),this._folderMatchesMap.set(e.resource,e),this._unDisposedFolderMatches.has(e.resource)&&this._unDisposedFolderMatches.delete(e.resource)}async batchReplace(e){const t=be(e);await this.replaceService.replace(t),this.doRemoveFile(t,!0,!0,!0)}onFileChange(e,t=!1){let r=!1;this._fileMatches.has(e.resource)||(this.doAddFile(e),r=!0),e.count()===0&&(this.doRemoveFile([e],!1,!1),r=!1,t=!0),this._replacingAll||this._onChange.fire({elements:[e],added:r,removed:t})}onFolderChange(e,t){this._folderMatches.has(e.resource)||this.doAddFolder(e),e.isEmpty()&&(this._folderMatches.delete(e.resource),e.dispose()),this._onChange.fire(t)}doRemoveFile(e,t=!0,r=!0,i=!1){const o=[];for(const a of e)if(this._fileMatches.get(a.resource)){if(i&&a.hasReadonlyMatches())continue;this._fileMatches.delete(a.resource),t?a.dispose():this._unDisposedFileMatches.set(a.resource,a),o.push(a)}else{const n=this.getFolderMatch(a.resource);if(n)n.doRemoveFile([a],t,r);else throw Error(`FileMatch ${a.resource} is not located within FolderMatch ${this.resource}`)}r&&this._onChange.fire({elements:o,removed:!0})}disposeMatches(){[...this._fileMatches.values()].forEach(e=>e.dispose()),[...this._folderMatches.values()].forEach(e=>e.disposeMatches()),[...this._unDisposedFileMatches.values()].forEach(e=>e.dispose()),[...this._unDisposedFolderMatches.values()].forEach(e=>e.disposeMatches()),this._fileMatches.clear(),this._folderMatches.clear(),this._unDisposedFileMatches.clear(),this._unDisposedFolderMatches.clear()}dispose(){this.disposeMatches(),this._onDispose.fire(),super.dispose()}};g=v([l(7,x),l(8,S),l(9,T),l(10,W)],g);let y=class extends g{_normalizedResource;constructor(s,e,t,r,i,o,a,n,c,u,d){super(s,e,t,r,i,o,a,n,c,u,d),this._normalizedResource=new z(()=>this.uriIdentityService.extUri.removeTrailingPathSeparator(this.uriIdentityService.extUri.normalizePath(this.resource)))}get resource(){return this._resource}get normalizedResource(){return this._normalizedResource.value}};y=v([l(7,x),l(8,S),l(9,T),l(10,W)],y);let E=class extends y{constructor(e,t,r,i,o,a,n,c,u,d){super(e,t,r,i,o,o,null,n,c,u,d);this._ai=a}normalizedUriParent(e){return this.uriIdentityService.extUri.normalizePath(this.uriIdentityService.extUri.dirname(e))}uriEquals(e,t){return this.uriIdentityService.extUri.isEqual(e,t)}createFileMatch(e,t,r,i,o,a,n){const c=this.instantiationService.createInstance(p,e,t,r,i,o,a,n);c.createMatches(this._ai),i.doAddFile(c);const u=c.onChange(({didRemove:d})=>i.onFileChange(c,d));return this._register(c.onDispose(()=>u.dispose())),c}createAndConfigureFileMatch(e,t){if(!this.uriHasParent(this.resource,e.resource))throw Error(`${e.resource} is not a descendant of ${this.resource}`);const r=[];let i=this.normalizedUriParent(e.resource);for(;!this.uriEquals(this.normalizedResource,i);){r.unshift(i);const n=i;if(i=this.uriIdentityService.extUri.removeTrailingPathSeparator(this.normalizedUriParent(i)),this.uriEquals(n,i))throw Error(`${e.resource} is not correctly configured as a child of ${this.normalizedResource}`)}const o=this.closestRoot??this;let a=this;for(let n=0;n<r.length;n++){let c=a.getFolderMatch(r[n]);c||(c=a.createIntermediateFolderMatch(r[n],r[n].toString(),-1,this._query,o)),a=c}return this.createFileMatch(this._query.contentPattern,this._query.previewOptions,this._query.maxResults,a,e,o,t)}};E=v([l(6,x),l(7,S),l(8,T),l(9,W)],E);let k=class extends g{constructor(s,e,t,r,i,o,a,n){super(null,s,e,t,r,r,null,i,o,a,n)}createAndConfigureFileMatch(s,e){const t=this._register(this.instantiationService.createInstance(p,this._query.contentPattern,this._query.previewOptions,this._query.maxResults,this,s,null,e));t.createMatches(!1),this.doAddFile(t);const r=t.onChange(({didRemove:i})=>this.onFileChange(t,i));return this._register(t.onDispose(()=>r.dispose())),t}};k=v([l(4,x),l(5,S),l(6,T),l(7,W)],k);let K=-1,J=-1;function et(h,s,e=_.Default){if(h instanceof p&&s instanceof g)return 1;if(s instanceof p&&h instanceof g)return-1;if(h instanceof g&&s instanceof g){if(K=h.index(),J=s.index(),K!==-1&&J!==-1)return K-J;switch(e){case _.CountDescending:return s.count()-h.count();case _.CountAscending:return h.count()-s.count();case _.Type:return te(h.name(),s.name());case _.FileNames:return U(h.name(),s.name());default:return!h.resource||!s.resource?0:re(h.resource.fsPath,s.resource.fsPath)||U(h.name(),s.name())}}if(h instanceof p&&s instanceof p)switch(e){case _.CountDescending:return s.count()-h.count();case _.CountAscending:return h.count()-s.count();case _.Type:return te(h.name(),s.name());case _.FileNames:return U(h.name(),s.name());case _.Modified:{const t=h.fileStat,r=s.fileStat;if(t&&r)return r.mtime-t.mtime}default:return re(h.resource.fsPath,s.resource.fsPath)||U(h.name(),s.name())}return h instanceof b&&s instanceof b?tt(h,s):h instanceof C&&s instanceof C?V.compareRangesUsingStarts(h.range(),s.range()):0}function tt(h,s){return h.cellIndex===s.cellIndex?h.webviewIndex!==void 0&&s.webviewIndex!==void 0?h.webviewIndex-s.webviewIndex:h.webviewIndex===void 0&&s.webviewIndex===void 0?V.compareRangesUsingStarts(h.range(),s.range()):h.webviewIndex!==void 0?1:-1:h.cellIndex<s.cellIndex?-1:1}function $t(h,s,e=_.Default){const t=ve(h),r=ve(s);let i=t.length-1,o=r.length-1;for(;i>=0&&o>=0;){if(t[i].id()!==r[o].id())return et(t[i],r[o],e);i--,o--}const a=i===0,n=o===0;return a&&!n?1:!a&&n?-1:0}function ve(h){const s=[];let e=h;for(;!(e instanceof R);)s.push(e),e=e.parent();return s}let R=class extends A{constructor(e,t,r,i,o,a){super();this.searchModel=e;this.replaceService=t;this.instantiationService=r;this.modelService=i;this.uriIdentityService=o;this.notebookEditorService=a;this._rangeHighlightDecorations=this.instantiationService.createInstance(F),this.modelService.getModels().forEach(n=>this.onModelAdded(n)),this._register(this.modelService.onModelAdded(n=>this.onModelAdded(n))),this._register(this.notebookEditorService.onDidAddNotebookEditor(n=>{n instanceof je&&this.onDidAddNotebookEditorWidget(n)})),this._register(this.onChange(n=>{n.removed&&(this._isDirty=!this.isEmpty()||!this.isEmpty(!0))}))}_onChange=this._register(new ie({merge:me}));onChange=this._onChange.event;_folderMatches=[];_aiFolderMatches=[];_otherFilesMatch=null;_folderMatchesMap=m.forUris(e=>this.uriIdentityService.extUri.ignorePathCasing(e));_aiFolderMatchesMap=m.forUris(e=>this.uriIdentityService.extUri.ignorePathCasing(e));_showHighlights=!1;_query=null;_rangeHighlightDecorations;disposePastResults=()=>Promise.resolve();_isDirty=!1;_onWillChangeModelListener;_onDidChangeModelListener;_cachedSearchComplete;_aiCachedSearchComplete;async batchReplace(e){try{this._onChange.pause(),await Promise.all(e.map(async t=>{const r=t.parent();(r instanceof g||r instanceof p)&&Ie(r,e)||(t instanceof p?await t.parent().replace(t):t instanceof C?await t.parent().replace(t):t instanceof g&&await t.replaceAll())}))}finally{this._onChange.resume()}}batchRemove(e){const t=[];try{this._onChange.pause(),e.forEach(r=>{Ie(r,t)||(r.parent().remove(r),t.push(r))})}finally{this._onChange.resume()}}get isDirty(){return this._isDirty}get query(){return this._query}set query(e){const t=this.folderMatches();this.disposePastResults=async()=>{t.forEach(r=>r.clear()),t.forEach(r=>r.dispose()),this._isDirty=!1},this._cachedSearchComplete=void 0,this._aiCachedSearchComplete=void 0,this._rangeHighlightDecorations.removeHighlightRange(),this._folderMatchesMap=m.forUris(r=>this.uriIdentityService.extUri.ignorePathCasing(r)),this._aiFolderMatchesMap=m.forUris(r=>this.uriIdentityService.extUri.ignorePathCasing(r)),e&&(this._folderMatches=(e&&e.folderQueries||[]).map(r=>r.folder).map((r,i)=>this._createBaseFolderMatch(r,r.toString(),i,e,!1)),this._folderMatches.forEach(r=>this._folderMatchesMap.set(r.resource,r)),this._aiFolderMatches=(e&&e.folderQueries||[]).map(r=>r.folder).map((r,i)=>this._createBaseFolderMatch(r,r.toString(),i,e,!0)),this._aiFolderMatches.forEach(r=>this._aiFolderMatchesMap.set(r.resource,r)),this._otherFilesMatch=this._createBaseFolderMatch(null,"otherFiles",this._folderMatches.length+this._aiFolderMatches.length+1,e,!1),this._query=e)}setCachedSearchComplete(e,t){t?this._aiCachedSearchComplete=e:this._cachedSearchComplete=e}getCachedSearchComplete(e){return e?this._aiCachedSearchComplete:this._cachedSearchComplete}onDidAddNotebookEditorWidget(e){this._onWillChangeModelListener?.dispose(),this._onWillChangeModelListener=e.onWillChangeModel(t=>{t&&this.onNotebookEditorWidgetRemoved(e,t?.uri)}),this._onDidChangeModelListener?.dispose(),this._onDidChangeModelListener=e.onDidAttachViewModel(()=>{e.hasModel()&&this.onNotebookEditorWidgetAdded(e,e.textModel.uri)})}onModelAdded(e){this._folderMatchesMap.findSubstr(e.uri)?.bindModel(e)}async onNotebookEditorWidgetAdded(e,t){await this._folderMatchesMap.findSubstr(t)?.bindNotebookEditorWidget(e,t)}onNotebookEditorWidgetRemoved(e,t){this._folderMatchesMap.findSubstr(t)?.unbindNotebookEditorWidget(e,t)}_createBaseFolderMatch(e,t,r,i,o){let a;e?a=this._register(this.instantiationService.createInstance(E,e,t,r,i,this,o)):a=this._register(this.instantiationService.createInstance(k,t,r,i,this));const n=a.onChange(c=>this._onChange.fire(c));return this._register(a.onDispose(()=>n.dispose())),a}add(e,t,r,i=!1){const{byFolder:o,other:a}=this.groupFilesByFolder(e,r);o.forEach(n=>{if(!n.length)return;(r?this.getAIFolderMatch(n[0].resource):this.getFolderMatch(n[0].resource))?.addFileMatch(n,i,t,r)}),r||this._otherFilesMatch?.addFileMatch(a,i,t,!1),this.disposePastResults()}clear(){this.folderMatches().forEach(e=>e.clear(!0)),this.folderMatches(!0),this.disposeMatches(),this._folderMatches=[],this._aiFolderMatches=[],this._otherFilesMatch=null}remove(e,t=!1){Array.isArray(e)||(e=[e]),e.forEach(a=>{a instanceof g&&a.clear()});const r=e.filter(a=>a instanceof p),{byFolder:i,other:o}=this.groupFilesByFolder(r,t);i.forEach(a=>{a.length&&this.getFolderMatch(a[0].resource).remove(a)}),o.length&&this.getFolderMatch(o[0].resource).remove(o)}replace(e){return this.getFolderMatch(e.resource).replace(e)}replaceAll(e){return this.replacingAll=!0,this.replaceService.replace(this.matches(),e).then(()=>{this.replacingAll=!1,this.clear()},()=>{this.replacingAll=!1})}folderMatches(e=!1){return e?this._aiFolderMatches:this._otherFilesMatch?[...this._folderMatches,this._otherFilesMatch]:[...this._folderMatches]}matches(e=!1){const t=[];return this.folderMatches(e).forEach(r=>{t.push(r.allDownstreamFileMatches())}),[].concat(...t)}isEmpty(e=!1){return this.folderMatches(e).every(t=>t.isEmpty())}fileCount(e=!1){return this.folderMatches(e).reduce((t,r)=>t+r.recursiveFileCount(),0)}count(e=!1){return this.matches(e).reduce((t,r)=>t+r.count(),0)}get showHighlights(){return this._showHighlights}toggleHighlights(e){if(this._showHighlights===e)return;this._showHighlights=e;let t=null;this.matches().forEach(r=>{r.updateHighlights(),r.updateNotebookHighlights(),t||(t=r.getSelectedMatch())}),this._showHighlights&&t?this._rangeHighlightDecorations.highlightRange(t.parent().resource,t.range()):this._rangeHighlightDecorations.removeHighlightRange()}get rangeHighlightDecorations(){return this._rangeHighlightDecorations}getFolderMatch(e){const t=this._folderMatchesMap.findSubstr(e);return t||this._otherFilesMatch}getAIFolderMatch(e){return this._aiFolderMatchesMap.findSubstr(e)}set replacingAll(e){this.folderMatches().forEach(t=>{t.replacingAll=e})}groupFilesByFolder(e,t){const r=new D,i=[];return(t?this._aiFolderMatches:this._folderMatches).forEach(o=>r.set(o.resource,[])),e.forEach(o=>{const a=t?this.getAIFolderMatch(o.resource):this.getFolderMatch(o.resource);if(!a)return;const n=a.resource;n?r.get(n).push(o):i.push(o)}),{byFolder:r,other:i}}disposeMatches(){this.folderMatches().forEach(e=>e.dispose()),this.folderMatches(!0).forEach(e=>e.dispose()),this._folderMatches=[],this._aiFolderMatches=[],this._folderMatchesMap=m.forUris(e=>this.uriIdentityService.extUri.ignorePathCasing(e)),this._aiFolderMatchesMap=m.forUris(e=>this.uriIdentityService.extUri.ignorePathCasing(e)),this._rangeHighlightDecorations.removeHighlightRange()}async dispose(){this._onWillChangeModelListener?.dispose(),this._onDidChangeModelListener?.dispose(),this._rangeHighlightDecorations.dispose(),this.disposeMatches(),super.dispose(),await this.disposePastResults()}};R=v([l(1,x),l(2,S),l(3,X),l(4,W),l(5,de)],R);var rt=(e=>(e[e.PANEL=0]="PANEL",e[e.QUICK_ACCESS=1]="QUICK_ACCESS",e))(rt||{});let N=class extends A{constructor(e,t,r,i,o,a,n){super();this.searchService=e;this.telemetryService=t;this.configurationService=r;this.instantiationService=i;this.logService=o;this.notebookSearchService=a;this.progressService=n;this._searchResult=this.instantiationService.createInstance(R,this),this._register(this._searchResult.onChange(c=>this._onSearchResultChanged.fire(c)))}_searchResult;_searchQuery=null;_replaceActive=!1;_replaceString=null;_replacePattern=null;_preserveCase=!1;_startStreamDelay=Promise.resolve();_resultQueue=[];_aiResultQueue=[];_onReplaceTermChanged=this._register(new w);onReplaceTermChanged=this._onReplaceTermChanged.event;_onSearchResultChanged=this._register(new ie({merge:me}));onSearchResultChanged=this._onSearchResultChanged.event;currentCancelTokenSource=null;currentAICancelTokenSource=null;searchCancelledForNewSearch=!1;aiSearchCancelledForNewSearch=!1;location=0;isReplaceActive(){return this._replaceActive}set replaceActive(e){this._replaceActive=e}get replacePattern(){return this._replacePattern}get replaceString(){return this._replaceString||""}set preserveCase(e){this._preserveCase=e}get preserveCase(){return this._preserveCase}set replaceString(e){this._replaceString=e,this._searchQuery&&(this._replacePattern=new he(e,this._searchQuery.contentPattern)),this._onReplaceTermChanged.fire()}get searchResult(){return this._searchResult}async addAIResults(e){this.searchResult.count(!0)||this._searchQuery&&await this.aiSearch({...this._searchQuery,contentPattern:this._searchQuery.contentPattern.pattern,type:qe.aiText},e,this.currentCancelTokenSource?.token)}async doAISearchWithModal(e,t,r,i){const o=this.searchService.aiTextSearch(e,r,async a=>{this.onSearchProgress(a,t,!1,!0),i?.(a)});return this.progressService.withProgress({location:Le.Notification,type:"syncing",title:"Searching for AI results..."},async a=>o)}aiSearch(e,t,r){const i=Date.now().toString(),o=this.currentAICancelTokenSource=new ee(r),a=Date.now();return this.doAISearchWithModal(e,i,this.currentAICancelTokenSource.token,async c=>{this.onSearchProgress(c,i,!1,!0),t?.(c)}).then(c=>(this.onSearchCompleted(c,Date.now()-a,i,!0),c),c=>{throw this.onSearchError(c,Date.now()-a,!0),c}).finally(()=>o.dispose())}doSearch(e,t,r,i,o,a){const n=async I=>{t.fire(),this.onSearchProgress(I,i,!1,!1),o?.(I)},c=I=>{t.fire(),this.onSearchProgress(I,i,!0),o?.(I)},u=this.currentCancelTokenSource=new ee(a),d=this.notebookSearchService.notebookSearch(e,u.token,i,n),f=this.searchService.textSearchSplitSyncAsync(r,this.currentCancelTokenSource.token,n,d.openFilesToScan,d.allScannedFiles),M=f.syncResults.results;return M.forEach(I=>{I&&c(I)}),{asyncResults:(async()=>{const I=Date.now(),P=await f.asyncResults,q=await d.completeData;u.dispose();const Se=Date.now()-I,Ce={results:[...P.results,...q.results],messages:[...P.messages,...q.messages],limitHit:P.limitHit||q.limitHit,exit:P.exit,stats:P.stats};return this.logService.trace(`whole search time | ${Se}ms`),Ce})(),syncResults:M}}search(e,t,r){this.cancelSearch(!0),this._searchQuery=e,this.searchConfig.searchOnType||this.searchResult.clear();const i=Date.now().toString();this._searchResult.query=this._searchQuery;const o=this._register(new w);this._replacePattern=new he(this.replaceString,this._searchQuery.contentPattern),this._startStreamDelay=new Promise(M=>setTimeout(M,this.searchConfig.searchOnType?150:0));const a=this.doSearch(e,o,this._searchQuery,i,t,r),n=a.asyncResults,c=a.syncResults;t&&c.forEach(M=>{M&&t(M)});const u=Date.now();let d;const f=new Promise(M=>(d=Ee.once(o.event)(M),d));Promise.race([n,f]).finally(()=>{d?.dispose(),this.telemetryService.publicLog("searchResultsFirstRender",{duration:Date.now()-u})});try{return{asyncResults:n.then(M=>(this.onSearchCompleted(M,Date.now()-u,i,!1),M),M=>{throw this.onSearchError(M,Date.now()-u,!1),M}),syncResults:c}}finally{this.telemetryService.publicLog("searchResultsFinished",{duration:Date.now()-u})}}onSearchCompleted(e,t,r,i){if(!this._searchQuery)throw new Error("onSearchCompleted must be called after a search is started");i?(this._searchResult.add(this._aiResultQueue,r,!0),this._aiResultQueue.length=0):(this._searchResult.add(this._resultQueue,r,!1),this._resultQueue.length=0),this.searchResult.setCachedSearchComplete(e,i);const o=Object.assign({},this._searchQuery.contentPattern);delete o.pattern;const a=e&&e.stats,n=this._searchQuery.folderQueries.every(d=>d.folder.scheme===$.file),c=this._searchQuery.folderQueries.every(d=>d.folder.scheme!==$.file),u=n?$.file:c?"other":"mixed";return this.telemetryService.publicLog("searchResultsShown",{count:this._searchResult.count(),fileCount:this._searchResult.fileCount(),options:o,duration:t,type:a&&a.type,scheme:u,searchOnTypeEnabled:this.searchConfig.searchOnType}),e}onSearchError(e,t,r){xe.isCancellationError(e)&&(this.onSearchCompleted((r?this.aiSearchCancelledForNewSearch:this.searchCancelledForNewSearch)?{exit:ze.NewSearchStarted,results:[],messages:[]}:void 0,t,"",r),r?this.aiSearchCancelledForNewSearch=!1:this.searchCancelledForNewSearch=!1)}onSearchProgress(e,t,r=!0,i=!1){const o=i?this._aiResultQueue:this._resultQueue;e.resource&&(o.push(e),r?o.length&&(this._searchResult.add(o,t,!1,!0),o.length=0):this._startStreamDelay.then(()=>{o.length&&(this._searchResult.add(o,t,i,!0),o.length=0)}))}get searchConfig(){return this.configurationService.getValue("search")}cancelSearch(e=!1){return this.currentCancelTokenSource?(this.searchCancelledForNewSearch=e,this.currentCancelTokenSource.cancel(),!0):!1}cancelAISearch(e=!1){return this.currentAICancelTokenSource?(this.aiSearchCancelledForNewSearch=e,this.currentAICancelTokenSource.cancel(),!0):!1}dispose(){this.cancelSearch(),this.cancelAISearch(),this.searchResult.dispose(),super.dispose()}};N=v([l(0,Qe),l(1,He),l(2,We),l(3,S),l(4,Ue),l(5,Ke),l(6,Ae)],N);let Q=class{constructor(s){this.instantiationService=s}_searchModel=null;get searchModel(){return this._searchModel||(this._searchModel=this.instantiationService.createInstance(N)),this._searchModel}set searchModel(s){this._searchModel?.dispose(),this._searchModel=s}};Q=v([l(0,S)],Q);const Vt=Ne("searchViewModelWorkbenchService");let F=class{constructor(s){this._modelService=s}_decorationId=null;_model=null;_modelDisposables=new ke;removeHighlightRange(){if(this._model&&this._decorationId){const s=this._decorationId;this._model.changeDecorations(e=>{e.removeDecoration(s)})}this._decorationId=null}highlightRange(s,e,t=0){let r;De.isUri(s)?r=this._modelService.getModel(s):r=s,r&&this.doHighlightRange(r,e)}doHighlightRange(s,e){this.removeHighlightRange(),s.changeDecorations(t=>{this._decorationId=t.addDecoration(e,F._RANGE_HIGHLIGHT_DECORATION)}),this.setModel(s)}setModel(s){this._model!==s&&(this.clearModelListeners(),this._model=s,this._modelDisposables.add(this._model.onDidChangeDecorations(e=>{this.clearModelListeners(),this.removeHighlightRange(),this._model=null})),this._modelDisposables.add(this._model.onWillDispose(()=>{this.clearModelListeners(),this.removeHighlightRange(),this._model=null})))}clearModelListeners(){this._modelDisposables.clear()}dispose(){this._model&&(this.removeHighlightRange(),this._model=null),this._modelDisposables.dispose()}static _RANGE_HIGHLIGHT_DECORATION=j.register({description:"search-range-highlight",stickiness:G.NeverGrowsWhenTypingAtEdges,className:"rangeHighlight",isWholeLine:!0})};F=v([l(0,X)],F);function Y(h,s,e){const t=h.previewText.split(`
`);return h.rangeLocations.map(r=>{const i=r.preview;return new C(s,t,i,r.source,e)})}function _e(h,s){const e=[];return h.forEach(t=>{const r=t.previewText.split(`
`);t.rangeLocations.map(i=>{const o=i.preview,a=new b(s,r,o,i.source,t.webviewIndex);e.push(a)})}),e}function Ie(h,s){do if(s.includes(h))return!0;while(!(h.parent()instanceof R)&&(h=h.parent()));return!1}function be(h){const s=[],e=[];return h.forEach(t=>{t instanceof p?e.push(t):s.push(t)}),e.concat(s.flatMap(t=>t.allDownstreamFileMatches()))}function me(h){const s={elements:[],added:!1,removed:!1};return h.forEach(e=>{e.added&&(s.added=!0),e.removed&&(s.removed=!0),s.elements=s.elements.concat(e.elements)}),s}export{fe as CellMatch,p as FileMatch,g as FolderMatch,k as FolderMatchNoRoot,y as FolderMatchWithResource,E as FolderMatchWorkspaceRoot,Vt as ISearchViewModelWorkbenchService,C as Match,b as MatchInNotebook,F as RangeHighlightDecorations,N as SearchModel,rt as SearchModelLocation,R as SearchResult,Q as SearchViewModelWorkbenchService,Ie as arrayContainsElementOrParent,tt as compareNotebookPos,$t as searchComparer,et as searchMatchComparer,_e as textSearchMatchesToNotebookMatches};
