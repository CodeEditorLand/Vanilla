var _=Object.defineProperty;var j=Object.getOwnPropertyDescriptor;var M=(T,s,r,o)=>{for(var e=o>1?void 0:o?j(s,r):s,t=T.length-1,i;t>=0;t--)(i=T[t])&&(e=(o?i(s,r,e):i(e))||e);return o&&e&&_(s,r,e),e},l=(T,s)=>(r,o)=>s(r,o,T);import*as a from"../../../../base/browser/dom.js";import{CountBadge as A}from"../../../../base/browser/ui/countBadge/countBadge.js";import{getDefaultHoverDelegate as R}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import{Disposable as C,DisposableStore as g}from"../../../../base/common/lifecycle.js";import*as G from"../../../../base/common/path.js";import{isEqual as q}from"../../../../base/common/resources.js";import*as d from"../../../../nls.js";import{HiddenItemStrategy as L,MenuWorkbenchToolBar as w}from"../../../../platform/actions/browser/toolbar.js";import{MenuId as F}from"../../../../platform/actions/common/actions.js";import{IConfigurationService as O}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as S}from"../../../../platform/contextkey/common/contextkey.js";import{FileKind as y}from"../../../../platform/files/common/files.js";import{IHoverService as U}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as E}from"../../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as K}from"../../../../platform/instantiation/common/serviceCollection.js";import{ILabelService as V}from"../../../../platform/label/common/label.js";import{defaultCountBadgeStyles as H}from"../../../../platform/theme/browser/defaultStyles.js";import{IWorkspaceContextService as N}from"../../../../platform/workspace/common/workspace.js";import{SearchContext as p}from"../common/constants.js";import{FileMatch as P,FolderMatch as B,FolderMatchNoRoot as J,FolderMatchWorkspaceRoot as Q,Match as $,MatchInNotebook as z}from"./searchModel.js";class k{static ITEM_HEIGHT=22;getHeight(s){return k.ITEM_HEIGHT}getTemplateId(s){if(s instanceof B)return I.TEMPLATE_ID;if(s instanceof P)return v.TEMPLATE_ID;if(s instanceof $)return f.TEMPLATE_ID;throw new Error("Invalid search tree element")}}let I=class extends C{constructor(r,o,e,t,i,n){super();this.searchView=r;this.labels=o;this.contextService=e;this.labelService=t;this.instantiationService=i;this.contextKeyService=n}static TEMPLATE_ID="folderMatch";templateId=I.TEMPLATE_ID;renderCompressedElements(r,o,e,t){const i=r.element,n=i.elements[i.elements.length-1],m=i.elements.map(c=>c.name());if(n.resource){const c=n instanceof Q?y.ROOT_FOLDER:y.FOLDER;e.label.setResource({resource:n.resource,name:m},{fileKind:c,separator:this.labelService.getSeparator(n.resource.scheme)})}else e.label.setLabel(d.localize("searchFolderMatch.other.label","Other files"));this.renderFolderDetails(n,e)}renderTemplate(r){const o=new g,e=a.append(r,a.$(".foldermatch")),t=this.labels.create(e,{supportDescriptionHighlights:!0,supportHighlights:!0});o.add(t);const i=new A(a.append(e,a.$(".badge")),{},H),n=a.append(e,a.$(".actionBarContainer")),m=new g;o.add(m);const c=o.add(this.contextKeyService.createScoped(r));p.MatchFocusKey.bindTo(c).set(!1),p.FileFocusKey.bindTo(c).set(!1),p.FolderFocusKey.bindTo(c).set(!0);const u=this._register(this.instantiationService.createChild(new K([S,c]))),h=o.add(u.createInstance(w,n,F.SearchActionMenu,{menuOptions:{shouldForwardArgs:!0},hiddenItemStrategy:L.Ignore,toolbarOptions:{primaryGroup:b=>/^inline/.test(b)}}));return{label:t,badge:i,actions:h,disposables:o,elementDisposables:m,contextKeyService:c}}renderElement(r,o,e){const t=r.element;if(t.resource){const i=this.contextService.getWorkspaceFolder(t.resource);i&&q(i.uri,t.resource)?e.label.setFile(t.resource,{fileKind:y.ROOT_FOLDER,hidePath:!0}):e.label.setFile(t.resource,{fileKind:y.FOLDER,hidePath:this.searchView.isTreeLayoutViewVisible})}else e.label.setLabel(d.localize("searchFolderMatch.other.label","Other files"));p.IsEditableItemKey.bindTo(e.contextKeyService).set(!t.hasOnlyReadOnlyMatches()),e.elementDisposables.add(t.onChange(()=>{p.IsEditableItemKey.bindTo(e.contextKeyService).set(!t.hasOnlyReadOnlyMatches())})),this.renderFolderDetails(t,e)}disposeElement(r,o,e){e.elementDisposables.clear()}disposeCompressedElements(r,o,e,t){e.elementDisposables.clear()}disposeTemplate(r){r.disposables.dispose()}renderFolderDetails(r,o){const e=r.recursiveMatchCount();o.badge.setCount(e),o.badge.setTitleFormat(e>1?d.localize("searchFileMatches","{0} files found",e):d.localize("searchFileMatch","{0} file found",e)),o.actions.context={viewer:this.searchView.getControl(),element:r}}};I=M([l(2,N),l(3,V),l(4,E),l(5,S)],I);let v=class extends C{constructor(r,o,e,t,i,n){super();this.searchView=r;this.labels=o;this.contextService=e;this.configurationService=t;this.instantiationService=i;this.contextKeyService=n}static TEMPLATE_ID="fileMatch";templateId=v.TEMPLATE_ID;renderCompressedElements(r,o,e,t){throw new Error("Should never happen since node is incompressible.")}renderTemplate(r){const o=new g,e=new g;o.add(e);const t=a.append(r,a.$(".filematch")),i=this.labels.create(t);o.add(i);const n=new A(a.append(t,a.$(".badge")),{},H),m=a.append(t,a.$(".actionBarContainer")),c=o.add(this.contextKeyService.createScoped(r));p.MatchFocusKey.bindTo(c).set(!1),p.FileFocusKey.bindTo(c).set(!0),p.FolderFocusKey.bindTo(c).set(!1);const u=this._register(this.instantiationService.createChild(new K([S,c]))),h=o.add(u.createInstance(w,m,F.SearchActionMenu,{menuOptions:{shouldForwardArgs:!0},hiddenItemStrategy:L.Ignore,toolbarOptions:{primaryGroup:b=>/^inline/.test(b)}}));return{el:t,label:i,badge:n,actions:h,disposables:o,elementDisposables:e,contextKeyService:c}}renderElement(r,o,e){const t=r.element;e.el.setAttribute("data-resource",t.resource.toString());const i=this.configurationService.getValue("search").decorations;e.label.setFile(t.resource,{hidePath:this.searchView.isTreeLayoutViewVisible&&!(t.parent()instanceof J),hideIcon:!1,fileDecorations:{colors:i.colors,badges:i.badges}});const n=t.count();e.badge.setCount(n),e.badge.setTitleFormat(n>1?d.localize("searchMatches","{0} matches found",n):d.localize("searchMatch","{0} match found",n)),e.actions.context={viewer:this.searchView.getControl(),element:t},p.IsEditableItemKey.bindTo(e.contextKeyService).set(!t.hasOnlyReadOnlyMatches()),e.elementDisposables.add(t.onChange(()=>{p.IsEditableItemKey.bindTo(e.contextKeyService).set(!t.hasOnlyReadOnlyMatches())})),e.el.parentElement?.parentElement?.querySelector(".monaco-tl-twistie")?.classList.add("force-twistie")}disposeElement(r,o,e){e.elementDisposables.clear()}disposeTemplate(r){r.disposables.dispose()}};v=M([l(2,N),l(3,O),l(4,E),l(5,S)],v);let f=class extends C{constructor(r,o,e,t,i,n){super();this.searchView=r;this.contextService=o;this.configurationService=e;this.instantiationService=t;this.contextKeyService=i;this.hoverService=n}static TEMPLATE_ID="match";templateId=f.TEMPLATE_ID;renderCompressedElements(r,o,e,t){throw new Error("Should never happen since node is incompressible.")}renderTemplate(r){r.classList.add("linematch");const o=a.append(r,a.$("span.matchLineNum")),e=a.append(r,a.$("a.plain.match")),t=a.append(e,a.$("span")),i=a.append(e,a.$("span.findInFileMatch")),n=a.append(e,a.$("span.replaceMatch")),m=a.append(e,a.$("span")),c=a.append(r,a.$("span.actionBarContainer")),u=new g,h=u.add(this.contextKeyService.createScoped(r));p.MatchFocusKey.bindTo(h).set(!0),p.FileFocusKey.bindTo(h).set(!1),p.FolderFocusKey.bindTo(h).set(!1);const b=this._register(this.instantiationService.createChild(new K([S,h]))),D=u.add(b.createInstance(w,c,F.SearchActionMenu,{menuOptions:{shouldForwardArgs:!0},hiddenItemStrategy:L.Ignore,toolbarOptions:{primaryGroup:W=>/^inline/.test(W)}}));return{parent:e,before:t,match:i,replace:n,after:m,lineNumber:o,actions:D,disposables:u,contextKeyService:h}}renderElement(r,o,e){const t=r.element,i=t.preview(),n=this.searchView.model.isReplaceActive()&&!!this.searchView.model.replaceString&&!(t instanceof z&&t.isReadonly());e.before.textContent=i.before,e.match.textContent=i.inside,e.match.classList.toggle("replace",n),e.replace.textContent=n?t.replaceString:"",e.after.textContent=i.after;const m=(i.fullBefore+(n?t.replaceString:i.inside)+i.after).trim().substr(0,999);e.disposables.add(this.hoverService.setupManagedHover(R("mouse"),e.parent,m)),p.IsEditableItemKey.bindTo(e.contextKeyService).set(!(t instanceof z&&t.isReadonly()));const c=t.range().endLineNumber-t.range().startLineNumber,u=c>0?`+${c}`:"",h=this.configurationService.getValue("search").showLineNumbers,b=h?`${t.range().startLineNumber}:`:"";e.lineNumber.classList.toggle("show",c>0||h),e.lineNumber.textContent=b+u,e.disposables.add(this.hoverService.setupManagedHover(R("mouse"),e.lineNumber,this.getMatchTitle(t,h))),e.actions.context={viewer:this.searchView.getControl(),element:t}}disposeTemplate(r){r.disposables.dispose()}getMatchTitle(r,o){const e=r.range().startLineNumber,t=r.range().endLineNumber-r.range().startLineNumber,i=o?d.localize("lineNumStr","From line {0}",e,t)+" ":"",n=t>0?"+ "+d.localize("numLinesStr","{0} more lines",t):"";return i+n}};f=M([l(1,N),l(2,O),l(3,E),l(4,S),l(5,U)],f);let x=class{constructor(s,r){this.searchView=s;this.labelService=r}getWidgetAriaLabel(){return d.localize("search","Search")}getAriaLabel(s){if(s instanceof B){const r=s.allDownstreamFileMatches().reduce((o,e)=>o+e.count(),0);return s.resource?d.localize("folderMatchAriaLabel","{0} matches in folder root {1}, Search result",r,s.name()):d.localize("otherFilesAriaLabel","{0} matches outside of the workspace, Search result",r)}if(s instanceof P){const r=this.labelService.getUriLabel(s.resource,{relative:!0})||s.resource.fsPath;return d.localize("fileMatchAriaLabel","{0} matches in file {1} of folder {2}, Search result",s.count(),s.name(),G.dirname(r))}if(s instanceof $){const r=s,o=this.searchView.model,e=o.isReplaceActive()&&!!o.replaceString,t=r.getMatchString(),i=r.range(),n=r.text().substr(0,i.endColumn+150);return e?d.localize("replacePreviewResultAria","'{0}' at column {1} replace {2} with {3}",n,i.startColumn,t,r.replaceString):d.localize("searchResultAria","'{0}' at column {1} found {2}",n,i.startColumn,t)}return null}};x=M([l(1,V)],x);export{v as FileMatchRenderer,I as FolderMatchRenderer,f as MatchRenderer,x as SearchAccessibilityProvider,k as SearchDelegate};
