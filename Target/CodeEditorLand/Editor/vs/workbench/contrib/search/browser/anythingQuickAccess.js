var U=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var O=(k,f,e,i)=>{for(var o=i>1?void 0:i?H(f,e):f,t=k.length-1,r;t>=0;t--)(r=k[t])&&(o=(i?r(f,e,o):r(o))||o);return i&&o&&U(f,e,o),o},u=(k,f)=>(e,i)=>f(e,i,k);import"./media/anythingQuickAccess.css";import{top as B}from"../../../../base/common/arrays.js";import{ThrottledDelayer as _}from"../../../../base/common/async.js";import"../../../../base/common/cancellation.js";import{Codicon as y}from"../../../../base/common/codicons.js";import{Event as D}from"../../../../base/common/event.js";import{compareItemsByFuzzyScore as T,prepareQuery as N,scoreItemFuzzy as A}from"../../../../base/common/fuzzyScorer.js";import{stripIcons as W}from"../../../../base/common/iconLabels.js";import{untildify as G}from"../../../../base/common/labels.js";import{Lazy as Q}from"../../../../base/common/lazy.js";import{Disposable as E,DisposableStore as K,MutableDisposable as V,toDisposable as z}from"../../../../base/common/lifecycle.js";import{ResourceMap as F}from"../../../../base/common/map.js";import{Schemas as v}from"../../../../base/common/network.js";import{basenameOrAuthority as X,dirname as q,toLocalResource as L}from"../../../../base/common/resources.js";import{ThemeIcon as P}from"../../../../base/common/themables.js";import{URI as b}from"../../../../base/common/uri.js";import{Range as Y}from"../../../../editor/common/core/range.js";import{ScrollType as j}from"../../../../editor/common/editorCommon.js";import{ILanguageService as $}from"../../../../editor/common/languages/language.js";import{getIconClasses as J}from"../../../../editor/common/services/getIconClasses.js";import{IModelService as Z}from"../../../../editor/common/services/model.js";import{ITextModelService as ee}from"../../../../editor/common/services/resolverService.js";import{localize as p}from"../../../../nls.js";import{IConfigurationService as ie}from"../../../../platform/configuration/common/configuration.js";import"../../../../platform/editor/common/editor.js";import{IFileService as te}from"../../../../platform/files/common/files.js";import{IInstantiationService as re}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as ne}from"../../../../platform/keybinding/common/keybinding.js";import{ILabelService as oe}from"../../../../platform/label/common/label.js";import{ILogService as se}from"../../../../platform/log/common/log.js";import{PickerQuickAccessProvider as ae,TriggerAction as R}from"../../../../platform/quickinput/browser/pickerQuickAccess.js";import{DefaultQuickAccessFilterValue as ce,Extensions as le}from"../../../../platform/quickinput/common/quickAccess.js";import{IQuickInputService as ue,QuickInputHideReason as de,quickPickItemScorerAccessor as C,QuickPickItemScorerAccessor as he}from"../../../../platform/quickinput/common/quickInput.js";import{Registry as pe}from"../../../../platform/registry/common/platform.js";import{IUriIdentityService as fe}from"../../../../platform/uriIdentity/common/uriIdentity.js";import{IWorkspaceContextService as me}from"../../../../platform/workspace/common/workspace.js";import{PickerEditorState as Se}from"../../../browser/quickaccess.js";import{EditorResourceAccessor as ke,isEditorInput as M}from"../../../common/editor.js";import"../../../common/editor/editorInput.js";import{ICustomEditorLabelService as ge}from"../../../services/editor/common/customEditorLabelService.js";import{ACTIVE_GROUP as Ie,IEditorService as ye,SIDE_GROUP as x}from"../../../services/editor/common/editorService.js";import{IWorkbenchEnvironmentService as ve}from"../../../services/environment/common/environmentService.js";import{IFilesConfigurationService as Pe}from"../../../services/filesConfiguration/common/filesConfigurationService.js";import{IHistoryService as be}from"../../../services/history/common/history.js";import{IPathService as Re}from"../../../services/path/common/pathService.js";import{QueryBuilder as Ce}from"../../../services/search/common/queryBuilder.js";import{ISearchService as Ae}from"../../../services/search/common/search.js";import{IWorkingCopyService as Qe}from"../../../services/workingCopy/common/workingCopyService.js";import{ASK_QUICK_QUESTION_ACTION_ID as Ee}from"../../chat/browser/actions/chatQuickInputActions.js";import{IQuickChatService as Fe}from"../../chat/browser/chat.js";import{GotoSymbolQuickAccessProvider as I}from"../../codeEditor/browser/quickaccess/gotoSymbolQuickAccess.js";import{FileQueryCacheState as we}from"../common/cacheState.js";import{extractRangeFromFilter as Oe,getOutOfWorkspaceEditorResources as De}from"../common/search.js";import{SymbolsQuickAccessProvider as Te}from"./symbolsQuickAccess.js";function w(k){const f=k;return!!f?.range&&!!f.resource}let d=class extends ae{constructor(e,i,o,t,r,n,s,a,c,l,h,g,m,S,Le,Me,xe,Ue,He,Be,_e){super(d.PREFIX,{canAcceptInBackground:!0,noResultsPick:d.NO_RESULTS_PICK});this.instantiationService=e;this.searchService=i;this.contextService=o;this.pathService=t;this.environmentService=r;this.fileService=n;this.labelService=s;this.modelService=a;this.languageService=c;this.workingCopyService=l;this.configurationService=h;this.editorService=g;this.historyService=m;this.filesConfigurationService=S;this.textModelService=Le;this.uriIdentityService=Me;this.quickInputService=xe;this.keybindingService=Ue;this.quickChatService=He;this.logService=Be;this.customEditorLabelService=_e}static PREFIX="";static NO_RESULTS_PICK={label:p("noAnythingResults","No matching results")};static MAX_RESULTS=512;static TYPING_SEARCH_DELAY=200;static SYMBOL_PICKS_MERGE_DELAY=200;pickState=this._register(new class extends E{constructor(i,o){super();this.provider=i;this.instantiationService=o}picker=void 0;editorViewState=this._register(this.instantiationService.createInstance(Se));scorerCache=Object.create(null);fileQueryCache=void 0;lastOriginalFilter=void 0;lastFilter=void 0;lastRange=void 0;lastGlobalPicks=void 0;isQuickNavigating=void 0;set(i){this.picker=i,D.once(i.onDispose)(()=>{i===this.picker&&(this.picker=void 0)});const o=!!i.quickNavigate;o||(this.fileQueryCache=this.provider.createFileQueryCache(),this.scorerCache=Object.create(null)),this.isQuickNavigating=o,this.lastOriginalFilter=void 0,this.lastFilter=void 0,this.lastRange=void 0,this.lastGlobalPicks=void 0,this.editorViewState.reset()}}(this,this.instantiationService));get defaultFilterValue(){if(this.configuration.preserveInput)return ce.LAST}get configuration(){const e=this.configurationService.getValue().workbench?.editor,i=this.configurationService.getValue().search,o=this.configurationService.getValue().workbench.quickOpen;return{openEditorPinned:!e?.enablePreviewFromQuickOpen||!e?.enablePreview,openSideBySideDirection:e?.openSideBySideDirection,includeSymbols:i?.quickOpen.includeSymbols,includeHistory:i?.quickOpen.includeHistory,historyFilterSortOrder:i?.quickOpen.history.filterSortOrder,preserveInput:o.preserveInput}}provide(e,i,o){const t=new K;this.pickState.set(e);const r=t.add(new V);return t.add(e.onDidChangeActive(()=>{r.value=void 0;const[n]=e.activeItems;w(n)&&(r.value=this.decorateAndRevealSymbolRange(n))})),t.add(D.once(e.onDidHide)(({reason:n})=>{n===de.Gesture&&this.pickState.editorViewState.restore()})),t.add(super.provide(e,i,o)),t}decorateAndRevealSymbolRange(e){const i=this.editorService.activeEditor;if(!this.uriIdentityService.extUri.isEqual(e.resource,i?.resource))return E.None;const o=this.editorService.activeTextEditorControl;return o?(this.pickState.editorViewState.set(),o.revealRangeInCenter(e.range.selection,j.Smooth),this.addDecorations(o,e.range.decoration),z(()=>this.clearDecorations(o))):E.None}_getPicks(e,i,o,t){const r=Oe(e,[I.PREFIX]);let n;if(r?n=r.filter:n=e,this.pickState.lastRange=r?.range,e!==this.pickState.lastOriginalFilter&&n===this.pickState.lastFilter)return null;const s=!!this.pickState.lastOriginalFilter;this.pickState.lastOriginalFilter=e,this.pickState.lastFilter=n;const a=this.pickState.picker?.items,c=this.pickState.picker?.activeItems[0];if(a&&c){const l=w(c),h=c===d.NO_RESULTS_PICK&&n.indexOf(I.PREFIX)>=0;!l&&!h&&(this.pickState.lastGlobalPicks={items:a,active:c})}return this.doGetPicks(n,{...t,enableEditorSymbolSearch:s},i,o)}doGetPicks(e,i,o,t){const r=N(e);if(i.enableEditorSymbolSearch){const c=this.getEditorSymbolPicks(r,o,t);if(c)return c}const n=this.pickState.picker?.activeItems[0];if(w(n)&&this.pickState.lastGlobalPicks)return this.pickState.lastGlobalPicks;const s=this.getEditorHistoryPicks(r);let a=new Array;if(i.additionPicks)for(const c of i.additionPicks){if(c.type==="separator"){a.push(c);continue}if(!r.original){c.highlights=void 0,a.push(c);continue}const{score:l,labelMatch:h,descriptionMatch:g}=A(c,r,!0,C,this.pickState.scorerCache);l&&(c.highlights={label:h,description:g},a.push(c))}return this.pickState.isQuickNavigating?(a.length>0&&a.push({type:"separator",label:p("recentlyOpenedSeparator","recently opened")}),a=s):(i.includeHelp&&a.push(...this.getHelpPicks(r,t,i)),s.length!==0&&(a.push({type:"separator",label:p("recentlyOpenedSeparator","recently opened")}),a.push(...s))),{picks:i.filter?a.filter(c=>i.filter?.(c)):a,additionalPicks:(async()=>{const c=new F;for(const h of s)h.resource&&c.set(h.resource,!0);let l=await this.getAdditionalPicks(r,c,this.configuration.includeSymbols,t);return i.filter&&(l=l.filter(h=>i.filter?.(h))),t.isCancellationRequested?[]:l.length>0?[{type:"separator",label:this.configuration.includeSymbols?p("fileAndSymbolResultsSeparator","file and symbol results"):p("fileResultsSeparator","file results")},...l]:[]})(),mergeDelay:d.SYMBOL_PICKS_MERGE_DELAY}}async getAdditionalPicks(e,i,o,t){const[r,n]=await Promise.all([this.getFilePicks(e,i,t),this.getWorkspaceSymbolPicks(e,o,t)]);if(t.isCancellationRequested)return[];const s=B([...r,...n],(c,l)=>T(c,l,e,!0,C,this.pickState.scorerCache),d.MAX_RESULTS),a=[];for(const c of s)if(c.highlights)a.push(c);else{const{score:l,labelMatch:h,descriptionMatch:g}=A(c,e,!0,C,this.pickState.scorerCache);if(!l)continue;c.highlights={label:h,description:g},a.push(c)}return a}labelOnlyEditorHistoryPickAccessor=new he({skipDescription:!0});getEditorHistoryPicks(e){const i=this.configuration;if(!e.normalized)return this.historyService.getHistory().map(r=>this.createAnythingPick(r,i));if(!this.configuration.includeHistory)return[];const o=e.containsPathSeparator?C:this.labelOnlyEditorHistoryPickAccessor,t=[];for(const r of this.historyService.getHistory()){const n=r.resource;if(!n||!this.fileService.hasProvider(n)&&n.scheme!==v.untitled&&n.scheme!==v.vscodeTerminal)continue;const s=this.createAnythingPick(r,i),{score:a,labelMatch:c,descriptionMatch:l}=A(s,e,!1,o,this.pickState.scorerCache);a&&(s.highlights={label:c,description:l},t.push(s))}return this.configuration.historyFilterSortOrder==="recency"?t:t.sort((r,n)=>T(r,n,e,!1,o,this.pickState.scorerCache))}fileQueryDelayer=this._register(new _(d.TYPING_SEARCH_DELAY));fileQueryBuilder=this.instantiationService.createInstance(Ce);createFileQueryCache(){return new we(e=>this.fileQueryBuilder.file(this.contextService.getWorkspace().folders,this.getFileQueryOptions({cacheKey:e})),e=>this.searchService.fileSearch(e),e=>this.searchService.clearCache(e),this.pickState.fileQueryCache).load()}async getFilePicks(e,i,o){if(!e.normalized)return[];const t=await this.getAbsolutePathFileResult(e,o);if(o.isCancellationRequested)return[];let r;if(t){if(i.has(t))return[];const s=this.createAnythingPick(t,this.configuration);return s.highlights={label:[{start:0,end:s.label.length}],description:s.description?[{start:0,end:s.description.length}]:void 0},[s]}if(this.pickState.fileQueryCache?.isLoaded?r=await this.doFileSearch(e,o):r=await this.fileQueryDelayer.trigger(async()=>o.isCancellationRequested?[]:this.doFileSearch(e,o)),o.isCancellationRequested)return[];const n=this.configuration;return r.filter(s=>!i.has(s)).map(s=>this.createAnythingPick(s,n))}async doFileSearch(e,i){const[o,t]=await Promise.all([this.getFileSearchResults(e,i),this.getRelativePathFileResults(e,i)]);if(i.isCancellationRequested)return[];if(!t)return o;const r=new F;for(const n of t)r.set(n,!0);return[...o.filter(n=>!r.has(n)),...t]}async getFileSearchResults(e,i){let o="";e.values&&e.values.length>1?o=e.values[0].original:o=e.original;const t=await this.doGetFileSearchResults(o,i);if(i.isCancellationRequested)return[];if(t.limitHit&&e.values&&e.values.length>1){const r=await this.doGetFileSearchResults(e.original,i);if(i.isCancellationRequested)return[];const n=new F;for(const s of t.results)n.set(s.resource,!0);for(const s of r.results)n.has(s.resource)||t.results.push(s)}return t.results.map(r=>r.resource)}doGetFileSearchResults(e,i){const o=Date.now();return this.searchService.fileSearch(this.fileQueryBuilder.file(this.contextService.getWorkspace().folders,this.getFileQueryOptions({filePattern:e,cacheKey:this.pickState.fileQueryCache?.cacheKey,maxResults:d.MAX_RESULTS})),i).finally(()=>{this.logService.trace(`QuickAccess fileSearch ${Date.now()-o}ms`)})}getFileQueryOptions(e){return{_reason:"openFileHandler",extraFileResources:this.instantiationService.invokeFunction(De),filePattern:e.filePattern||"",cacheKey:e.cacheKey,maxResults:e.maxResults||0,sortByScore:!0}}async getAbsolutePathFileResult(e,i){if(!e.containsPathSeparator)return;const o=await this.pathService.userHome(),t=G(e.original,o.scheme===v.file?o.fsPath:o.path);if(i.isCancellationRequested)return;const r=(await this.pathService.path).isAbsolute(t);if(!i.isCancellationRequested&&r){const n=L(await this.pathService.fileURI(t),this.environmentService.remoteAuthority,this.pathService.defaultUriScheme);if(i.isCancellationRequested)return;try{if((await this.fileService.stat(n)).isFile)return n}catch{}}}async getRelativePathFileResults(e,i){if(!e.containsPathSeparator)return;if(!(await this.pathService.path).isAbsolute(e.original)){const t=[];for(const r of this.contextService.getWorkspace().folders){if(i.isCancellationRequested)break;const n=L(r.toResource(e.original),this.environmentService.remoteAuthority,this.pathService.defaultUriScheme);try{(await this.fileService.stat(n)).isFile&&t.push(n)}catch{}}return t}}lazyRegistry=new Q(()=>pe.as(le.Quickaccess));getHelpPicks(e,i,o){if(e.normalized)return[];const t=this.lazyRegistry.value.getQuickAccessProviders().filter(r=>r.helpEntries.some(n=>n.commandCenterOrder!==void 0)).flatMap(r=>r.helpEntries.filter(n=>n.commandCenterOrder!==void 0).map(n=>{const s={...o,includeHelp:r.prefix===d.PREFIX?!1:o?.includeHelp},a=n.commandCenterLabel??n.description;return{label:a,description:n.prefix??r.prefix,commandCenterOrder:n.commandCenterOrder,keybinding:n.commandId?this.keybindingService.lookupKeybinding(n.commandId):void 0,ariaLabel:p("helpPickAriaLabel","{0}, {1}",a,n.description),accept:()=>{this.quickInputService.quickAccess.show(r.prefix,{preserveValue:!0,providerOptions:s})}}}));return this.quickChatService.enabled&&t.push({label:p("chat","Open Quick Chat"),commandCenterOrder:30,keybinding:this.keybindingService.lookupKeybinding(Ee),accept:()=>this.quickChatService.toggle()}),t.sort((r,n)=>r.commandCenterOrder-n.commandCenterOrder)}workspaceSymbolsQuickAccess=this._register(this.instantiationService.createInstance(Te));async getWorkspaceSymbolPicks(e,i,o){return!e.normalized||!i||this.pickState.lastRange?[]:this.workspaceSymbolsQuickAccess.getSymbolPicks(e.original,{skipLocal:!0,skipSorting:!0,delay:d.TYPING_SEARCH_DELAY},o)}editorSymbolsQuickAccess=this.instantiationService.createInstance(I);getEditorSymbolPicks(e,i,o){const t=e.original.split(I.PREFIX),r=t.length>1?t[t.length-1].trim():void 0;if(typeof r!="string")return null;const n=this.pickState.lastGlobalPicks?.active;if(!n)return null;const s=n.resource;return!s||!this.fileService.hasProvider(s)&&s.scheme!==v.untitled||(n.label.includes(I.PREFIX)||n.description?.includes(I.PREFIX))&&t.length<3?null:this.doGetEditorSymbolPicks(n,s,r,i,o)}async doGetEditorSymbolPicks(e,i,o,t,r){try{this.pickState.editorViewState.set(),await this.pickState.editorViewState.openTransientEditor({resource:i,options:{preserveFocus:!0,revealIfOpened:!0,ignoreError:!0}})}catch{return[]}if(r.isCancellationRequested)return[];let n=this.modelService.getModel(i);if(!n)try{const a=t.add(await this.textModelService.createModelReference(i));if(r.isCancellationRequested)return[];n=a.object.textEditorModel}catch{return[]}const s=await this.editorSymbolsQuickAccess.getSymbolPicks(n,o,{extraContainerLabel:W(e.label)},t,r);return r.isCancellationRequested?[]:s.map(a=>a.type==="separator"?a:{...a,resource:i,description:a.description,trigger:(c,l)=>(this.openAnything(i,{keyMods:l,range:a.range?.selection,forceOpenSideBySide:!0}),R.CLOSE_PICKER),accept:(c,l)=>this.openAnything(i,{keyMods:c,range:a.range?.selection,preserveFocus:l.inBackground,forcePinned:l.inBackground})})}addDecorations(e,i){this.editorSymbolsQuickAccess.addDecorations(e,i)}clearDecorations(e){this.editorSymbolsQuickAccess.clearDecorations(e)}createAnythingPick(e,i){const o=!b.isUri(e);let t,r,n,s,a,c;if(M(e))t=ke.getOriginalUri(e),r=e.getName(),n=e.getDescription(),s=e.isDirty()&&!e.isSaving(),a=e.getLabelExtraClasses(),c=e.getIcon();else{t=b.isUri(e)?e:e.resource;const m=this.customEditorLabelService.getName(t);r=m||X(t),n=this.labelService.getUriLabel(m?t:q(t),{relative:!0}),s=this.workingCopyService.isDirty(t)&&!this.filesConfigurationService.hasShortAutoSaveDelay(t),a=[]}const l=n?`${r} ${n}`:r,h=new Q(()=>J(this.modelService,this.languageService,t,void 0,c).concat(a)),g=new Q(()=>{const m=i.openSideBySideDirection,S=[];return S.push({iconClass:m==="right"?P.asClassName(y.splitHorizontal):P.asClassName(y.splitVertical),tooltip:m==="right"?p({key:"openToSide",comment:["Open this file in a split editor on the left/right side"]},"Open to the Side"):p({key:"openToBottom",comment:["Open this file in a split editor on the bottom"]},"Open to the Bottom")}),o&&S.push({iconClass:s?"dirty-anything "+P.asClassName(y.circleFilled):P.asClassName(y.close),tooltip:p("closeEditor","Remove from Recently Opened"),alwaysVisible:s}),S});return{resource:t,label:r,ariaLabel:s?p("filePickAriaLabelDirty","{0} unsaved changes",l):l,description:n,get iconClasses(){return h.value},get buttons(){return g.value},trigger:(m,S)=>{switch(m){case 0:return this.openAnything(e,{keyMods:S,range:this.pickState.lastRange,forceOpenSideBySide:!0}),R.CLOSE_PICKER;case 1:if(!b.isUri(e))return this.historyService.removeFromHistory(e),R.REMOVE_ITEM}return R.NO_ACTION},accept:(m,S)=>this.openAnything(e,{keyMods:m,range:this.pickState.lastRange,preserveFocus:S.inBackground,forcePinned:S.inBackground})}}async openAnything(e,i){const o={preserveFocus:i.preserveFocus,pinned:i.keyMods?.ctrlCmd||i.forcePinned||this.configuration.openEditorPinned,selection:i.range?Y.collapseToStart(i.range):void 0},t=i.keyMods?.alt||this.configuration.openEditorPinned&&i.keyMods?.ctrlCmd||i.forceOpenSideBySide?x:Ie;if(t===x&&await this.pickState.editorViewState.restore(),M(e))await this.editorService.openEditor(e,o,t);else{let r;b.isUri(e)?r={resource:e,options:o}:r={...e,options:{...e.options,...o}},await this.editorService.openEditor(r,t)}}};d=O([u(0,re),u(1,Ae),u(2,me),u(3,Re),u(4,ve),u(5,te),u(6,oe),u(7,Z),u(8,$),u(9,Qe),u(10,ie),u(11,ye),u(12,be),u(13,Pe),u(14,ee),u(15,fe),u(16,ue),u(17,ne),u(18,Fe),u(19,se),u(20,ge)],d);export{d as AnythingQuickAccessProvider};
