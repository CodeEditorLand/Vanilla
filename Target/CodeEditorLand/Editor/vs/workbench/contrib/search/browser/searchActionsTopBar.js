import{KeyCode as b}from"../../../../../vs/base/common/keyCodes.js";import*as c from"../../../../../vs/nls.js";import{Action2 as n,MenuId as S,registerAction2 as l}from"../../../../../vs/platform/actions/common/actions.js";import"../../../../../vs/platform/commands/common/commands.js";import{ContextKeyExpr as o}from"../../../../../vs/platform/contextkey/common/contextkey.js";import"../../../../../vs/platform/instantiation/common/instantiation.js";import{KeybindingWeight as K}from"../../../../../vs/platform/keybinding/common/keybindingsRegistry.js";import{WorkbenchListFocusContextKey as E}from"../../../../../vs/platform/list/browser/listService.js";import{category as d,getSearchView as u}from"../../../../../vs/workbench/contrib/search/browser/searchActionsBase.js";import{searchClearIcon as F,searchCollapseAllIcon as L,searchExpandAllIcon as q,searchRefreshIcon as N,searchShowAsList as z,searchShowAsTree as P,searchStopIcon as M}from"../../../../../vs/workbench/contrib/search/browser/searchIcons.js";import{FileMatch as H,FolderMatch as g,FolderMatchNoRoot as R,FolderMatchWorkspaceRoot as V,Match as x,SearchResult as k}from"../../../../../vs/workbench/contrib/search/browser/searchModel.js";import*as e from"../../../../../vs/workbench/contrib/search/common/constants.js";import{SearchStateKey as y,SearchUIState as I}from"../../../../../vs/workbench/contrib/search/common/search.js";import{ISearchHistoryService as W}from"../../../../../vs/workbench/contrib/search/common/searchHistoryService.js";import{VIEW_ID as m}from"../../../../../vs/workbench/services/search/common/search.js";import{IViewsService as p}from"../../../../../vs/workbench/services/views/common/viewsService.js";l(class extends n{constructor(){super({id:e.SearchCommandIds.ClearSearchHistoryCommandId,title:c.localize2("clearSearchHistoryLabel","Clear Search History"),category:d,f1:!0})}async run(r){D(r)}}),l(class extends n{constructor(){super({id:e.SearchCommandIds.CancelSearchActionId,title:c.localize2("CancelSearchAction.label","Cancel Search"),icon:M,category:d,f1:!0,precondition:y.isEqualTo(I.Idle).negate(),keybinding:{weight:K.WorkbenchContrib,when:o.and(e.SearchContext.SearchViewVisibleKey,E),primary:b.Escape},menu:[{id:S.ViewTitle,group:"navigation",order:0,when:o.and(o.equals("view",m),y.isEqualTo(I.SlowSearch))}]})}run(r){return _(r)}}),l(class extends n{constructor(){super({id:e.SearchCommandIds.RefreshSearchResultsActionId,title:c.localize2("RefreshAction.label","Refresh"),icon:N,precondition:e.SearchContext.ViewHasSearchPatternKey,category:d,f1:!0,menu:[{id:S.ViewTitle,group:"navigation",order:0,when:o.and(o.equals("view",m),y.isEqualTo(I.SlowSearch).negate())}]})}run(r,...i){return j(r)}}),l(class extends n{constructor(){super({id:e.SearchCommandIds.CollapseSearchResultsActionId,title:c.localize2("CollapseDeepestExpandedLevelAction.label","Collapse All"),category:d,icon:L,f1:!0,precondition:o.and(e.SearchContext.HasSearchResults,e.SearchContext.ViewHasSomeCollapsibleKey),menu:[{id:S.ViewTitle,group:"navigation",order:4,when:o.and(o.equals("view",m),o.or(e.SearchContext.HasSearchResults.negate(),e.SearchContext.ViewHasSomeCollapsibleKey))}]})}run(r,...i){return B(r)}}),l(class extends n{constructor(){super({id:e.SearchCommandIds.ExpandSearchResultsActionId,title:c.localize2("ExpandAllAction.label","Expand All"),category:d,icon:q,f1:!0,precondition:o.and(e.SearchContext.HasSearchResults,e.SearchContext.ViewHasSomeCollapsibleKey.toNegated()),menu:[{id:S.ViewTitle,group:"navigation",order:4,when:o.and(o.equals("view",m),e.SearchContext.HasSearchResults,e.SearchContext.ViewHasSomeCollapsibleKey.toNegated())}]})}run(r,...i){return Q(r)}}),l(class extends n{constructor(){super({id:e.SearchCommandIds.ClearSearchResultsActionId,title:c.localize2("ClearSearchResultsAction.label","Clear Search Results"),category:d,icon:F,f1:!0,precondition:o.or(e.SearchContext.HasSearchResults,e.SearchContext.ViewHasSearchPatternKey,e.SearchContext.ViewHasReplacePatternKey,e.SearchContext.ViewHasFilePatternKey),menu:[{id:S.ViewTitle,group:"navigation",order:1,when:o.equals("view",m)}]})}run(r,...i){return U(r)}}),l(class extends n{constructor(){super({id:e.SearchCommandIds.ViewAsTreeActionId,title:c.localize2("ViewAsTreeAction.label","View as Tree"),category:d,icon:z,f1:!0,precondition:o.and(e.SearchContext.HasSearchResults,e.SearchContext.InTreeViewKey.toNegated()),menu:[{id:S.ViewTitle,group:"navigation",order:2,when:o.and(o.equals("view",m),e.SearchContext.InTreeViewKey.toNegated())}]})}run(r,...i){const t=u(r.get(p));t&&t.setTreeView(!0)}}),l(class extends n{constructor(){super({id:e.SearchCommandIds.ViewAsListActionId,title:c.localize2("ViewAsListAction.label","View as List"),category:d,icon:P,f1:!0,precondition:o.and(e.SearchContext.HasSearchResults,e.SearchContext.InTreeViewKey),menu:[{id:S.ViewTitle,group:"navigation",order:2,when:o.and(o.equals("view",m),e.SearchContext.InTreeViewKey)}]})}run(r,...i){const t=u(r.get(p));t&&t.setTreeView(!1)}});const D=a=>{a.get(W).clearHistory()};function Q(a){const r=a.get(p),i=u(r);i&&i.getControl().expandAll()}function U(a){const r=a.get(p);u(r)?.clearSearchResults()}function _(a){const r=a.get(p);u(r)?.cancelSearch()}function j(a){const r=a.get(p);u(r)?.triggerQueryChange({preserveFocus:!1})}function B(a){const r=a.get(p),i=u(r);if(i){const t=i.getControl(),f=t.navigate();let s=f.first(),T=!1,v=!1;if(s instanceof V||i.isTreeLayoutViewVisible)for(;s=f.next();){if(s instanceof x){T=!0;break}if(i.isTreeLayoutViewVisible&&!v){let A=s;if(s instanceof g){const h=t.getCompressedTreeNode(s).element?.elements[0];A=h&&!(h instanceof x)?h:s}const w=A.parent();w instanceof V||w instanceof R||w instanceof k||(v=!0)}}if(T){s=f.first();do s instanceof H&&t.collapse(s);while(s=f.next())}else if(v){if(s=f.first(),s)do{let A=s;if(s instanceof g){const h=t.getCompressedTreeNode(s).element?.elements[0];A=h&&!(h instanceof x)?h:s}const w=A.parent();(w instanceof V||w instanceof R)&&(t.hasElement(s)?t.collapse(s,!0):t.collapseAll())}while(s=f.next())}else t.collapseAll();const C=t.getFocus()[0]?.parent();C&&(C instanceof g||C instanceof H)&&t.hasElement(C)&&t.isCollapsed(C)&&(t.domFocus(),t.focusFirst(),t.setSelection(t.getFocus()))}}
