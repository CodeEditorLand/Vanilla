var me=Object.defineProperty;var ye=Object.getOwnPropertyDescriptor;var q=(b,c,e,t)=>{for(var s=t>1?void 0:t?ye(c,e):c,r=b.length-1,i;r>=0;r--)(i=b[r])&&(s=(t?i(c,e,s):i(s))||s);return t&&s&&me(c,e,s),s},d=(b,c)=>(e,t)=>c(e,t,b);import*as o from"../../../../base/browser/dom.js";import{StandardKeyboardEvent as U}from"../../../../base/browser/keyboardEvent.js";import*as N from"../../../../base/browser/ui/aria/aria.js";import{MessageType as te}from"../../../../base/browser/ui/inputbox/inputBox.js";import"../../../../base/browser/ui/list/list.js";import{ObjectTreeElementCollapseState as Y}from"../../../../base/browser/ui/tree/tree.js";import{Delayer as z,RunOnceScheduler as Ie}from"../../../../base/common/async.js";import*as O from"../../../../base/common/errors.js";import{Event as G}from"../../../../base/common/event.js";import{KeyCode as H,KeyMod as be}from"../../../../base/common/keyCodes.js";import{Disposable as Ce,DisposableStore as se}from"../../../../base/common/lifecycle.js";import*as ie from"../../../../base/common/platform.js";import*as xe from"../../../../base/common/strings.js";import{URI as Ee}from"../../../../base/common/uri.js";import*as Re from"../../../../base/common/network.js";import"./media/searchview.css";import{getCodeEditor as we,isCodeEditor as j,isDiffEditor as Me}from"../../../../editor/browser/editorBrowser.js";import{ICodeEditorService as Fe}from"../../../../editor/browser/services/codeEditorService.js";import{EmbeddedCodeEditorWidget as Pe}from"../../../../editor/browser/widget/codeEditor/embeddedCodeEditorWidget.js";import"../../../../editor/common/config/editorOptions.js";import{Selection as We}from"../../../../editor/common/core/selection.js";import"../../../../editor/common/editorCommon.js";import{CommonFindController as Te}from"../../../../editor/contrib/find/browser/findController.js";import{MultiCursorSelectionController as De}from"../../../../editor/contrib/multicursor/browser/multicursor.js";import*as n from"../../../../nls.js";import{IAccessibilityService as Ae}from"../../../../platform/accessibility/common/accessibility.js";import{MenuId as Oe}from"../../../../platform/actions/common/actions.js";import{ICommandService as He}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as re}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as ae}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as _e,IContextViewService as Ke}from"../../../../platform/contextview/browser/contextView.js";import{IDialogService as ke}from"../../../../platform/dialogs/common/dialogs.js";import{FileChangeType as Le,IFileService as Ve}from"../../../../platform/files/common/files.js";import{IInstantiationService as Ne}from"../../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as ze}from"../../../../platform/instantiation/common/serviceCollection.js";import{IKeybindingService as Be}from"../../../../platform/keybinding/common/keybinding.js";import{getSelectionKeyboardEvent as B,WorkbenchCompressibleAsyncDataTree as Qe}from"../../../../platform/list/browser/listService.js";import{INotificationService as qe}from"../../../../platform/notification/common/notification.js";import{IOpenerService as Ue,withSelection as Ye}from"../../../../platform/opener/common/opener.js";import{IProgressService as Ge}from"../../../../platform/progress/common/progress.js";import{IStorageService as je,StorageScope as oe,StorageTarget as $e}from"../../../../platform/storage/common/storage.js";import{ITelemetryService as Xe}from"../../../../platform/telemetry/common/telemetry.js";import{defaultInputBoxStyles as $,defaultToggleStyles as Je}from"../../../../platform/theme/browser/defaultStyles.js";import{IThemeService as Ze}from"../../../../platform/theme/common/themeService.js";import{ThemeIcon as et}from"../../../../base/common/themables.js";import{IWorkspaceContextService as tt,WorkbenchState as _}from"../../../../platform/workspace/common/workspace.js";import{OpenFileFolderAction as st,OpenFolderAction as it}from"../../../browser/actions/workspaceActions.js";import{ResourceListDnDHandler as rt}from"../../../browser/dnd.js";import{ResourceLabels as at}from"../../../browser/labels.js";import{ViewPane as ot}from"../../../browser/parts/views/viewPane.js";import"../../../common/editor.js";import{Memento as nt}from"../../../common/memento.js";import{IViewDescriptorService as ct}from"../../../common/views.js";import{NotebookEditor as lt}from"../../notebook/browser/notebookEditor.js";import{ExcludePatternInputWidget as ht,IncludePatternInputWidget as ut}from"./patternInputWidget.js";import{appendKeyBindingLabel as dt}from"./searchActionsBase.js";import"./searchActionsFind.js";import{searchDetailsIcon as pt}from"./searchIcons.js";import{renderSearchMessage as gt}from"./searchMessage.js";import{FileMatchRenderer as ft,FolderMatchRenderer as vt,MatchRenderer as St,SearchAccessibilityProvider as mt,SearchDelegate as ne,TextSearchResultRenderer as yt}from"./searchResultsView.js";import{SearchWidget as It}from"./searchWidget.js";import*as f from"../common/constants.js";import{IReplaceService as bt}from"./replace.js";import{getOutOfWorkspaceEditorResources as Ct,SearchStateKey as xt,SearchUIState as w}from"../common/search.js";import{ISearchHistoryService as Et,SearchHistoryService as Rt}from"../common/searchHistoryService.js";import{AI_TEXT_SEARCH_RESULT_ID as Q,FileMatch as P,FolderMatch as K,FolderMatchNoRoot as wt,FolderMatchWithResource as ce,FolderMatchWorkspaceRoot as Mt,ISearchViewModelWorkbenchService as Ft,Match as S,MatchInNotebook as X,searchMatchComparer as J,SearchModelLocation as Pt,SearchResult as le,TextSearchResult as Z}from"./searchModel.js";import{createEditorFromSearchResult as Wt}from"../../searchEditor/browser/searchEditorActions.js";import{ACTIVE_GROUP as Tt,IEditorService as Dt,SIDE_GROUP as At}from"../../../services/editor/common/editorService.js";import{IPreferencesService as Ot}from"../../../services/preferences/common/preferences.js";import{QueryBuilder as Ht}from"../../../services/search/common/queryBuilder.js";import{SearchCompletionExitCode as _t,SearchSortOrder as D,TextSearchCompleteMessageType as Kt,ViewMode as kt}from"../../../services/search/common/search.js";import"../../../services/search/common/searchExtTypes.js";import{ITextFileService as Lt}from"../../../services/textfile/common/textfiles.js";import{INotebookService as Vt}from"../../notebook/common/notebookService.js";import{ILogService as Nt}from"../../../../platform/log/common/log.js";import{AccessibilitySignal as zt,IAccessibilitySignalService as Bt}from"../../../../platform/accessibilitySignal/browser/accessibilitySignalService.js";import{getDefaultHoverDelegate as he}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import{IHoverService as Qt}from"../../../../platform/hover/browser/hover.js";const C=o.$;var qt=(e=>(e[e.SideBar=0]="SideBar",e[e.Panel=1]="Panel",e))(qt||{});const ue=n.localize("searchCanceled","Search was canceled before any results could be found - "),de=75;let A=class extends ot{constructor(e,t,s,r,i,a,l,p,h,v,u,y,E,x,I,R,M,g,F,ee,L,V,T,pe,ge,fe,ve,Gt,jt,$t){super(e,T,L,y,I,u,v,ge,F,fe,ve);this.fileService=t;this.editorService=s;this.codeEditorService=r;this.progressService=i;this.notificationService=a;this.dialogService=l;this.commandService=p;this.contextViewService=h;this.contextService=E;this.searchViewModelWorkbenchService=x;this.replaceService=R;this.textFileService=M;this.preferencesService=g;this.searchHistoryService=ee;this.accessibilityService=V;this.storageService=pe;this.notebookService=Gt;this.logService=jt;this.accessibilitySignalService=$t;this.container=o.$(".search-view"),this.viewletVisible=f.SearchContext.SearchViewVisibleKey.bindTo(this.contextKeyService),this.firstMatchFocused=f.SearchContext.FirstMatchFocusKey.bindTo(this.contextKeyService),this.fileMatchOrMatchFocused=f.SearchContext.FileMatchOrMatchFocusKey.bindTo(this.contextKeyService),this.fileMatchOrFolderMatchFocus=f.SearchContext.FileMatchOrFolderMatchFocusKey.bindTo(this.contextKeyService),this.fileMatchOrFolderMatchWithResourceFocus=f.SearchContext.FileMatchOrFolderMatchWithResourceFocusKey.bindTo(this.contextKeyService),this.fileMatchFocused=f.SearchContext.FileFocusKey.bindTo(this.contextKeyService),this.folderMatchFocused=f.SearchContext.FolderFocusKey.bindTo(this.contextKeyService),this.folderMatchWithResourceFocused=f.SearchContext.ResourceFolderFocusKey.bindTo(this.contextKeyService),this.hasSearchResultsKey=f.SearchContext.HasSearchResults.bindTo(this.contextKeyService),this.matchFocused=f.SearchContext.MatchFocusKey.bindTo(this.contextKeyService),this.searchStateKey=xt.bindTo(this.contextKeyService),this.hasSearchPatternKey=f.SearchContext.ViewHasSearchPatternKey.bindTo(this.contextKeyService),this.hasReplacePatternKey=f.SearchContext.ViewHasReplacePatternKey.bindTo(this.contextKeyService),this.hasFilePatternKey=f.SearchContext.ViewHasFilePatternKey.bindTo(this.contextKeyService),this.hasSomeCollapsibleResultKey=f.SearchContext.ViewHasSomeCollapsibleKey.bindTo(this.contextKeyService),this.treeViewKey=f.SearchContext.InTreeViewKey.bindTo(this.contextKeyService),this._register(this.contextKeyService.onDidChangeContext(m=>{const Se=f.SearchContext.hasAIResultProvider.keys();m.affectsSome(new Set(Se))&&this.refreshHasAISetting()})),this.contextKeyService=this._register(this.contextKeyService.createScoped(this.container)),f.SearchContext.SearchViewFocusedKey.bindTo(this.contextKeyService).set(!0),this.inputBoxFocused=f.SearchContext.InputBoxFocusedKey.bindTo(this.contextKeyService),this.inputPatternIncludesFocused=f.SearchContext.PatternIncludesFocusedKey.bindTo(this.contextKeyService),this.inputPatternExclusionsFocused=f.SearchContext.PatternExcludesFocusedKey.bindTo(this.contextKeyService),this.isEditableItem=f.SearchContext.IsEditableItemKey.bindTo(this.contextKeyService),this.instantiationService=this._register(this.instantiationService.createChild(new ze([ae,this.contextKeyService]))),this._register(this.configurationService.onDidChangeConfiguration(async m=>{m.affectsConfiguration("search.sortOrder")&&(this.searchConfig.sortOrder===D.Modified&&this.removeFileStats(),await this.refreshTree())})),this.viewModel=this.searchViewModelWorkbenchService.searchModel,this.queryBuilder=this.instantiationService.createInstance(Ht),this.memento=new nt(this.id,pe),this.viewletState=this.memento.getMemento(oe.WORKSPACE,$e.MACHINE),this._register(this.fileService.onDidFilesChange(m=>this.onFilesChanged(m))),this._register(this.textFileService.untitled.onWillDispose(m=>this.onUntitledDidDispose(m.resource))),this._register(this.contextService.onDidChangeWorkbenchState(()=>this.onDidChangeWorkbenchState())),this._register(this.searchHistoryService.onDidClearHistory(()=>this.clearHistory())),this._register(this.configurationService.onDidChangeConfiguration(m=>this.onConfigurationUpdated(m))),this.delayedRefresh=this._register(new z(250)),this.addToSearchHistoryDelayer=this._register(new z(2e3)),this.toggleCollapseStateDelayer=this._register(new z(100)),this.triggerQueryDelayer=this._register(new z(0)),this.treeAccessibilityProvider=this.instantiationService.createInstance(mt,this),this.isTreeLayoutViewVisible=this.viewletState["view.treeLayout"]??this.searchConfig.defaultViewMode===kt.Tree,this._refreshResultsScheduler=this._register(new Ie(this._updateResults.bind(this),80)),this._register(this.storageService.onWillSaveState(()=>{this._saveSearchHistoryService()})),this._register(this.storageService.onDidChangeValue(oe.WORKSPACE,Rt.SEARCH_HISTORY_KEY,this._register(new se))(()=>{const m=this.searchHistoryService.load();m.include&&this.inputPatternIncludes.prependHistory(m.include),m.exclude&&this.inputPatternExcludes.prependHistory(m.exclude),m.search&&this.searchWidget.prependSearchHistory(m.search),m.replace&&this.searchWidget.prependReplaceHistory(m.replace)})),this.changedWhileHidden=this.hasSearchResults()}static ACTIONS_RIGHT_CLASS_NAME="actions-right";isDisposed=!1;container;queryBuilder;viewModel;memento;viewletVisible;inputBoxFocused;inputPatternIncludesFocused;inputPatternExclusionsFocused;firstMatchFocused;fileMatchOrMatchFocused;fileMatchOrFolderMatchFocus;fileMatchOrFolderMatchWithResourceFocus;fileMatchFocused;folderMatchFocused;folderMatchWithResourceFocused;matchFocused;isEditableItem;hasSearchResultsKey;lastFocusState="input";searchStateKey;hasSearchPatternKey;hasReplacePatternKey;hasFilePatternKey;hasSomeCollapsibleResultKey;tree;treeLabels;viewletState;messagesElement;messageDisposables=new se;searchWidgetsContainerElement;searchWidget;size;queryDetails;toggleQueryDetailsButton;inputPatternExcludes;inputPatternIncludes;resultsElement;currentSelectedFileMatch;delayedRefresh;changedWhileHidden;searchWithoutFolderMessageElement;currentSearchQ=Promise.resolve();addToSearchHistoryDelayer;toggleCollapseStateDelayer;triggerQueryDelayer;pauseSearching=!1;treeAccessibilityProvider;treeViewKey;_visibleMatches=0;_refreshResultsScheduler;_onSearchResultChangedDisposable;searchDataSource;get isTreeLayoutViewVisible(){return this.treeViewKey.get()??!1}set isTreeLayoutViewVisible(e){this.treeViewKey.set(e)}async setTreeView(e){if(e!==this.isTreeLayoutViewVisible)return this.isTreeLayoutViewVisible=e,this.updateIndentStyles(this.themeService.getFileIconTheme()),this.refreshTree()}get state(){return this.searchStateKey.get()??w.Idle}set state(e){this.searchStateKey.set(e)}getContainer(){return this.container}get searchResult(){return this.viewModel&&this.viewModel.searchResult}get model(){return this.viewModel}async refreshHasAISetting(){const e=this.shouldShowAIResults();if(this.tree.hasNode(this.searchResult)){if(e&&!this.tree.hasNode(this.searchResult.aiTextSearchResult)){if(this.model.searchResult.getCachedSearchComplete(!1))return this.refreshAndUpdateCount()}else if(!e&&this.tree.hasNode(this.searchResult.aiTextSearchResult))return this.refreshAndUpdateCount()}}onDidChangeWorkbenchState(){this.contextService.getWorkbenchState()!==_.EMPTY&&this.searchWithoutFolderMessageElement&&o.hide(this.searchWithoutFolderMessageElement)}refreshInputs(){this.pauseSearching=!0,this.searchWidget.setValue(this.viewModel.searchResult.query?.contentPattern.pattern??""),this.searchWidget.setReplaceAllActionState(!1),this.searchWidget.toggleReplace(!0),this.inputPatternIncludes.setOnlySearchInOpenEditors(this.viewModel.searchResult.query?.onlyOpenEditors||!1),this.inputPatternExcludes.setUseExcludesAndIgnoreFiles(!this.viewModel.searchResult.query?.userDisabledExcludesAndIgnoreFiles||!0),this.searchIncludePattern.setValue(""),this.searchExcludePattern.setValue(""),this.pauseSearching=!1}async replaceSearchModel(e,t){let s;this.progressService.withProgress({location:this.getProgressLocation(),delay:0},a=>new Promise(l=>s=l));const r=setTimeout(()=>{this.state=w.SlowSearch},2e3);if(this._refreshResultsScheduler.schedule(),e.location=Pt.PANEL,e.replaceActive=this.viewModel.isReplaceActive(),e.replaceString=this.searchWidget.getReplaceValue(),this._onSearchResultChangedDisposable?.dispose(),this._onSearchResultChangedDisposable=this._register(e.onSearchResultChanged(async a=>this.onSearchResultsChanged(a))),this.searchViewModelWorkbenchService.searchModel=e,this.viewModel=e,this.tree.setInput(this.viewModel.searchResult),await this.onSearchResultsChanged(),this.refreshInputs(),t.then(a=>(clearTimeout(r),this.onSearchComplete(s,void 0,void 0,a)),a=>(clearTimeout(r),this.onSearchError(a,s,void 0,void 0))),this.searchConfig.collapseResults!=="alwaysCollapse"&&this.viewModel.searchResult.matches().length===1){const a=this.viewModel.searchResult.matches()[0];a.count()<50&&await this.tree.expand(a)}}renderBody(e){super.renderBody(e),this.container=o.append(e,o.$(".search-view")),this.searchWidgetsContainerElement=o.append(this.container,C(".search-widgets-container")),this.createSearchWidget(this.searchWidgetsContainerElement);const t=this.searchHistoryService.load(),s=this.viewletState["query.filePatterns"]||"",r=this.viewletState["query.folderExclusions"]||"",i=t.exclude||[],a=this.viewletState["query.folderIncludes"]||"",l=t.include||[],p=this.viewletState["query.onlyOpenEditors"]||!1,h=this.viewletState["query.queryDetailsExpanded"]||"",v=typeof this.viewletState["query.useExcludesAndIgnoreFiles"]=="boolean"?this.viewletState["query.useExcludesAndIgnoreFiles"]:!0;this.queryDetails=o.append(this.searchWidgetsContainerElement,C(".query-details"));const u=n.localize("moreSearch","Toggle Search Details");this.toggleQueryDetailsButton=o.append(this.queryDetails,C(".more"+et.asCSSSelector(pt),{tabindex:0,role:"button","aria-label":u})),this._register(this.hoverService.setupManagedHover(he("element"),this.toggleQueryDetailsButton,u)),this._register(o.addDisposableListener(this.toggleQueryDetailsButton,o.EventType.CLICK,g=>{o.EventHelper.stop(g),this.toggleQueryDetails(!this.accessibilityService.isScreenReaderOptimized())})),this._register(o.addDisposableListener(this.toggleQueryDetailsButton,o.EventType.KEY_UP,g=>{const F=new U(g);(F.equals(H.Enter)||F.equals(H.Space))&&(o.EventHelper.stop(g),this.toggleQueryDetails(!1))})),this._register(o.addDisposableListener(this.toggleQueryDetailsButton,o.EventType.KEY_DOWN,g=>{new U(g).equals(be.Shift|H.Tab)&&(this.searchWidget.isReplaceActive()?this.searchWidget.focusReplaceAllAction():this.searchWidget.isReplaceShown()?this.searchWidget.replaceInput?.focusOnPreserve():this.searchWidget.focusRegexAction(),o.EventHelper.stop(g))}));const y=o.append(this.queryDetails,C(".file-types.includes")),E=n.localize("searchScope.includes","files to include");o.append(y,C("h4",void 0,E)),this.inputPatternIncludes=this._register(this.instantiationService.createInstance(ut,y,this.contextViewService,{ariaLabel:E,placeholder:n.localize("placeholder.includes","e.g. *.ts, src/**/include"),showPlaceholderOnFocus:!0,history:l,inputBoxStyles:$})),this.inputPatternIncludes.setValue(a),this.inputPatternIncludes.setOnlySearchInOpenEditors(p),this._register(this.inputPatternIncludes.onCancel(()=>this.cancelSearch(!1))),this._register(this.inputPatternIncludes.onChangeSearchInEditorsBox(()=>this.triggerQueryChange())),this.trackInputBox(this.inputPatternIncludes.inputFocusTracker,this.inputPatternIncludesFocused);const x=o.append(this.queryDetails,C(".file-types.excludes")),I=n.localize("searchScope.excludes","files to exclude");o.append(x,C("h4",void 0,I)),this.inputPatternExcludes=this._register(this.instantiationService.createInstance(ht,x,this.contextViewService,{ariaLabel:I,placeholder:n.localize("placeholder.excludes","e.g. *.ts, src/**/exclude"),showPlaceholderOnFocus:!0,history:i,inputBoxStyles:$})),this.inputPatternExcludes.setValue(r),this.inputPatternExcludes.setUseExcludesAndIgnoreFiles(v),this._register(this.inputPatternExcludes.onCancel(()=>this.cancelSearch(!1))),this._register(this.inputPatternExcludes.onChangeIgnoreBox(()=>this.triggerQueryChange())),this.trackInputBox(this.inputPatternExcludes.inputFocusTracker,this.inputPatternExclusionsFocused);const R=()=>this.hasFilePatternKey.set(this.inputPatternIncludes.getValue().length>0||this.inputPatternExcludes.getValue().length>0);R();const M=g=>{this.triggerQueryChange({triggeredOnType:g,delay:this.searchConfig.searchOnTypeDebouncePeriod}),g&&R()};this._register(this.inputPatternIncludes.onSubmit(M)),this._register(this.inputPatternExcludes.onSubmit(M)),this.messagesElement=o.append(this.container,C(".messages.text-search-provider-messages")),this.contextService.getWorkbenchState()===_.EMPTY&&this.showSearchWithoutFolderMessage(),this.createSearchResultsView(this.container),(s!==""||r!==""||a!==""||h!==""||!v)&&this.toggleQueryDetails(!0,!0,!0),this._onSearchResultChangedDisposable=this._register(this.viewModel.onSearchResultChanged(async g=>await this.onSearchResultsChanged(g))),this._register(this.onDidChangeBodyVisibility(g=>this.onVisibilityChanged(g))),this.updateIndentStyles(this.themeService.getFileIconTheme()),this._register(this.themeService.onDidFileIconThemeChange(this.updateIndentStyles,this))}updateIndentStyles(e){this.resultsElement.classList.toggle("hide-arrows",this.isTreeLayoutViewVisible&&e.hidesExplorerArrows)}async onVisibilityChanged(e){this.viewletVisible.set(e),e?this.changedWhileHidden&&(await this.refreshAndUpdateCount(),this.changedWhileHidden=!1):this.lastFocusState="input",this.viewModel?.searchResult.toggleHighlights(e)}get searchAndReplaceWidget(){return this.searchWidget}get searchIncludePattern(){return this.inputPatternIncludes}get searchExcludePattern(){return this.inputPatternExcludes}createSearchWidget(e){const t=this.viewletState["query.contentPattern"]||"",s=this.viewletState["query.replaceText"]||"",r=this.viewletState["query.regex"]===!0,i=this.viewletState["query.wholeWords"]===!0,a=this.viewletState["query.caseSensitive"]===!0,l=this.searchHistoryService.load(),p=l.search||this.viewletState["query.searchHistory"]||[],h=l.replace||this.viewletState["query.replaceHistory"]||[],v=typeof this.viewletState["view.showReplace"]=="boolean"?this.viewletState["view.showReplace"]:!0,u=this.viewletState["query.preserveCase"]===!0,y=this.viewletState["query.isInNotebookMarkdownInput"]??!0,E=this.viewletState["query.isInNotebookMarkdownPreview"]??!0,x=this.viewletState["query.isInNotebookCellInput"]??!0,I=this.viewletState["query.isInNotebookCellOutput"]??!0;if(this.searchWidget=this._register(this.instantiationService.createInstance(It,e,{value:t,replaceValue:s,isRegex:r,isCaseSensitive:a,isWholeWords:i,searchHistory:p,replaceHistory:h,preserveCase:u,inputBoxStyles:$,toggleStyles:Je,notebookOptions:{isInNotebookMarkdownInput:y,isInNotebookMarkdownPreview:E,isInNotebookCellInput:x,isInNotebookCellOutput:I}})),!this.searchWidget.searchInput||!this.searchWidget.replaceInput){this.logService.warn(`Cannot fully create search widget. Search or replace input undefined. SearchInput: ${this.searchWidget.searchInput}, ReplaceInput: ${this.searchWidget.replaceInput}`);return}v&&this.searchWidget.toggleReplace(!0),this._register(this.searchWidget.onSearchSubmit(g=>this.triggerQueryChange(g))),this._register(this.searchWidget.onSearchCancel(({focus:g})=>this.cancelSearch(g))),this._register(this.searchWidget.searchInput.onDidOptionChange(()=>{this.triggerQueryChange()})),this._register(this.searchWidget.getNotebookFilters().onDidChange(()=>this.triggerQueryChange()));const R=()=>this.hasSearchPatternKey.set(this.searchWidget.searchInput?this.searchWidget.searchInput.getValue().length>0:!1);R(),this._register(this.searchWidget.searchInput.onDidChange(()=>R()));const M=()=>this.hasReplacePatternKey.set(this.searchWidget.getReplaceValue().length>0);M(),this._register(this.searchWidget.replaceInput.inputBox.onDidChange(()=>M())),this._register(this.searchWidget.onDidHeightChange(()=>this.reLayout())),this._register(this.searchWidget.onReplaceToggled(()=>this.reLayout())),this._register(this.searchWidget.onReplaceStateChange(async g=>{this.viewModel.replaceActive=g,await this.refreshTree()})),this._register(this.searchWidget.onPreserveCaseChange(async g=>{this.viewModel.preserveCase=g,await this.refreshTree()})),this._register(this.searchWidget.onReplaceValueChanged(()=>{this.viewModel.replaceString=this.searchWidget.getReplaceValue(),this.delayedRefresh.trigger(async()=>this.refreshTree())})),this._register(this.searchWidget.onBlur(()=>{this.toggleQueryDetailsButton.focus()})),this._register(this.searchWidget.onReplaceAll(()=>this.replaceAll())),this.trackInputBox(this.searchWidget.searchInputFocusTracker),this.trackInputBox(this.searchWidget.replaceInputFocusTracker)}shouldShowAIResults(){return!!f.SearchContext.hasAIResultProvider.getValue(this.contextKeyService)}async onConfigurationUpdated(e){if(e&&(e.affectsConfiguration("search.decorations.colors")||e.affectsConfiguration("search.decorations.badges")))return this.refreshTree()}trackInputBox(e,t){e&&(this._register(e.onDidFocus(()=>{this.lastFocusState="input",this.inputBoxFocused.set(!0),t?.set(!0)})),this._register(e.onDidBlur(()=>{this.inputBoxFocused.set(this.searchWidget.searchInputHasFocus()||this.searchWidget.replaceInputHasFocus()||this.inputPatternIncludes.inputHasFocus()||this.inputPatternExcludes.inputHasFocus()),t?.set(!1)})))}async onSearchResultsChanged(e){if(this.isVisible())return this.refreshAndUpdateCount(e);this.changedWhileHidden=!0}refreshTreePromiseSerializer=Promise.resolve();async refreshAndUpdateCount(e){return this.searchWidget.setReplaceAllActionState(!this.viewModel.searchResult.isEmpty()),this.updateSearchResultCount(this.viewModel.searchResult.query.userDisabledExcludesAndIgnoreFiles,this.viewModel.searchResult.query?.onlyOpenEditors,e?.clearingAll),this.refreshTree(e)}async refreshTree(e){return this.refreshTreePromiseSerializer=this.refreshTreePromiseSerializer.then(async()=>{!e||e.added||e.removed?this.searchConfig.sortOrder===D.Modified?await this.retrieveFileStats().then(()=>this.tree.updateChildren(void 0)):await this.tree.updateChildren(void 0):this.searchConfig.sortOrder===D.CountAscending||this.searchConfig.sortOrder===D.CountDescending?await this.tree.updateChildren(void 0):await Promise.all(e.elements.map(async t=>{await this.tree.updateChildren(t),this.tree.rerender(t)}))}),this.refreshTreePromiseSerializer}originalShouldCollapse(e){const t=this.searchConfig.collapseResults;return t==="alwaysCollapse"||!(e instanceof S)&&e.count()>10&&t!=="alwaysExpand"?Y.PreserveOrCollapsed:Y.PreserveOrExpanded}shouldCollapse(e){return this.originalShouldCollapse(e)===Y.PreserveOrCollapsed}replaceAll(){if(this.viewModel.searchResult.count()===0)return;const e=this.viewModel.searchResult.count(),t=this.viewModel.searchResult.fileCount(),s=this.searchWidget.getReplaceValue()||"",r=this.buildAfterReplaceAllMessage(e,t,s);let i,a;this.progressService.withProgress({location:this.getProgressLocation(),delay:100,total:e},p=>(a=p,new Promise(h=>i=h)));const l={title:n.localize("replaceAll.confirmation.title","Replace All"),message:this.buildReplaceAllConfirmationMessage(e,t,s),primaryButton:n.localize({key:"replaceAll.confirm.button",comment:["&& denotes a mnemonic"]},"&&Replace")};this.dialogService.confirm(l).then(p=>{p.confirmed?(this.searchWidget.setReplaceAllActionState(!1),this.viewModel.searchResult.replaceAll(a).then(()=>{i();const h=this.clearMessage();o.append(h,r),this.reLayout()},h=>{i(),O.isCancellationError(h),this.notificationService.error(h)})):i()})}buildAfterReplaceAllMessage(e,t,s){return e===1?t===1?s?n.localize("replaceAll.occurrence.file.message","Replaced {0} occurrence across {1} file with '{2}'.",e,t,s):n.localize("removeAll.occurrence.file.message","Replaced {0} occurrence across {1} file.",e,t):s?n.localize("replaceAll.occurrence.files.message","Replaced {0} occurrence across {1} files with '{2}'.",e,t,s):n.localize("removeAll.occurrence.files.message","Replaced {0} occurrence across {1} files.",e,t):t===1?s?n.localize("replaceAll.occurrences.file.message","Replaced {0} occurrences across {1} file with '{2}'.",e,t,s):n.localize("removeAll.occurrences.file.message","Replaced {0} occurrences across {1} file.",e,t):s?n.localize("replaceAll.occurrences.files.message","Replaced {0} occurrences across {1} files with '{2}'.",e,t,s):n.localize("removeAll.occurrences.files.message","Replaced {0} occurrences across {1} files.",e,t)}buildReplaceAllConfirmationMessage(e,t,s){return e===1?t===1?s?n.localize("removeAll.occurrence.file.confirmation.message","Replace {0} occurrence across {1} file with '{2}'?",e,t,s):n.localize("replaceAll.occurrence.file.confirmation.message","Replace {0} occurrence across {1} file?",e,t):s?n.localize("removeAll.occurrence.files.confirmation.message","Replace {0} occurrence across {1} files with '{2}'?",e,t,s):n.localize("replaceAll.occurrence.files.confirmation.message","Replace {0} occurrence across {1} files?",e,t):t===1?s?n.localize("removeAll.occurrences.file.confirmation.message","Replace {0} occurrences across {1} file with '{2}'?",e,t,s):n.localize("replaceAll.occurrences.file.confirmation.message","Replace {0} occurrences across {1} file?",e,t):s?n.localize("removeAll.occurrences.files.confirmation.message","Replace {0} occurrences across {1} files with '{2}'?",e,t,s):n.localize("replaceAll.occurrences.files.confirmation.message","Replace {0} occurrences across {1} files?",e,t)}clearMessage(){this.searchWithoutFolderMessageElement=void 0;const e=this.messagesElement.style.display==="none";o.clearNode(this.messagesElement),o.show(this.messagesElement),this.messageDisposables.clear();const t=o.append(this.messagesElement,C(".message"));return e&&this.reLayout(),t}createSearchResultsView(e){this.resultsElement=o.append(e,C(".results.show-file-icons.file-icon-themable-tree"));const t=this.instantiationService.createInstance(ne),s={getId(i){return i.id()}};this.searchDataSource=this.instantiationService.createInstance(k,this),this.treeLabels=this._register(this.instantiationService.createInstance(at,{onDidChangeVisibility:this.onDidChangeBodyVisibility})),this.tree=this._register(this.instantiationService.createInstance(Qe,"SearchView",this.resultsElement,t,{isIncompressible:i=>!(i instanceof K&&!(i.parent()instanceof Z)&&!(i.parent()instanceof Mt)&&!(i.parent()instanceof wt))},[this._register(this.instantiationService.createInstance(vt,this,this.treeLabels)),this._register(this.instantiationService.createInstance(ft,this,this.treeLabels)),this._register(this.instantiationService.createInstance(yt,this.treeLabels)),this._register(this.instantiationService.createInstance(St,this))],this.searchDataSource,{identityProvider:s,accessibilityProvider:this.treeAccessibilityProvider,dnd:this.instantiationService.createInstance(rt,i=>i instanceof P?i.resource:i instanceof S?Ye(i.parent().resource,i.range()):null),multipleSelectionSupport:!0,selectionNavigation:!0,overrideStyles:this.getLocationBasedColors().listOverrideStyles,paddingBottom:ne.ITEM_HEIGHT,collapseByDefault:i=>i.id()===Q?!0:this.shouldCollapse(i)})),this.tree.setInput(this.viewModel.searchResult),this._register(this.tree.onContextMenu(i=>this.onContextMenu(i)));const r=()=>this.toggleCollapseStateDelayer.trigger(()=>this.hasSomeCollapsibleResultKey.set(this.hasSomeCollapsible()));r(),this._register(this.tree.onDidChangeCollapseState(()=>r())),this._register(this.tree.onDidChangeModel(()=>r())),this._register(G.debounce(this.tree.onDidOpen,(i,a)=>a,de,!0)(i=>{if(i.element instanceof S){const a=i.element;this.currentSelectedFileMatch?.setSelectedMatch(null),this.currentSelectedFileMatch=a.parent(),this.currentSelectedFileMatch.setSelectedMatch(a),this.onFocus(a,i.editorOptions.preserveFocus,i.sideBySide,i.editorOptions.pinned)}})),this._register(G.debounce(this.tree.onDidChangeFocus,(i,a)=>a,de,!0)(()=>{const i=this.tree.getSelection(),a=this.tree.getFocus()[0];i.length>1&&a instanceof S&&this.onFocus(a,!0)})),this._register(G.any(this.tree.onDidFocus,this.tree.onDidChangeFocus)(()=>{const i=this.tree.getFocus()[0];if(this.tree.isDOMFocused()){const l=this.tree.getFirstElementChild(this.tree.getInput());this.firstMatchFocused.set(l===i),this.fileMatchOrMatchFocused.set(!!i),this.fileMatchFocused.set(i instanceof P),this.folderMatchFocused.set(i instanceof K),this.matchFocused.set(i instanceof S),this.fileMatchOrFolderMatchFocus.set(i instanceof P||i instanceof K),this.fileMatchOrFolderMatchWithResourceFocus.set(i instanceof P||i instanceof ce),this.folderMatchWithResourceFocused.set(i instanceof ce),this.lastFocusState="tree"}let a=!1;i instanceof S?a=!i.isReadonly():(i instanceof P||i instanceof K)&&(a=!i.hasOnlyReadOnlyMatches()),this.isEditableItem.set(a)})),this._register(this.tree.onDidBlur(()=>{this.firstMatchFocused.reset(),this.fileMatchOrMatchFocused.reset(),this.fileMatchFocused.reset(),this.folderMatchFocused.reset(),this.matchFocused.reset(),this.fileMatchOrFolderMatchFocus.reset(),this.fileMatchOrFolderMatchWithResourceFocus.reset(),this.folderMatchWithResourceFocused.reset(),this.isEditableItem.reset()}))}onContextMenu(e){e.browserEvent.preventDefault(),e.browserEvent.stopPropagation(),this.contextMenuService.showContextMenu({menuId:Oe.SearchContext,menuActionOptions:{shouldForwardArgs:!0},contextKeyService:this.contextKeyService,getAnchor:()=>e.anchor,getActionsContext:()=>e.element})}hasSomeCollapsible(){const e=this.getControl(),t=e.navigate();let s=t.first();do if(s&&!e.isCollapsed(s)&&(this.viewModel.hasAIResults||s.id()!==Q))return!0;while(s=t.next());return!1}async selectNextMatch(){if(!this.hasSearchResults())return;const[e]=this.tree.getSelection();e&&!(e instanceof S)&&this.tree.isCollapsed(e)&&await this.tree.expand(e);const t=this.tree.navigate(e);let s=t.next();for(s||(s=t.first());s&&!(s instanceof S);)this.tree.isCollapsed(s)&&await this.tree.expand(s),s=t.next();if(s){s===e&&this.tree.setFocus([]);const r=B(void 0,!1,!1);this.tree.setFocus([s],r),this.tree.setSelection([s],r),this.tree.reveal(s);const i=this.treeAccessibilityProvider.getAriaLabel(s);i&&N.status(i)}}async selectPreviousMatch(){if(!this.hasSearchResults())return;const[e]=this.tree.getSelection();let t=this.tree.navigate(e),s=t.previous();for(;!s||!(s instanceof S)&&!this.tree.isCollapsed(s);){const r=s?t.previous():t.last();if(!s&&!r)return;s=r}for(;s&&!(s instanceof S);){const r=t.next();if(!r)break;await this.tree.expand(s),t=this.tree.navigate(r),s=r?t.previous():t.last()}if(s){s===e&&this.tree.setFocus([]);const r=B(void 0,!1,!1);this.tree.setFocus([s],r),this.tree.setSelection([s],r),this.tree.reveal(s);const i=this.treeAccessibilityProvider.getAriaLabel(s);i&&N.status(i)}}moveFocusToResults(){this.tree.domFocus()}focus(){if(super.focus(),this.lastFocusState==="input"||!this.hasSearchResults()){const e=this.searchConfig.seedOnFocus?this.updateTextFromSelection({allowSearchOnType:!1}):!1;this.searchWidget.focus(void 0,void 0,e)}else this.tree.domFocus()}updateTextFromFindWidgetOrSelection({allowUnselectedWord:e=!0,allowSearchOnType:t=!0}){let s=this.editorService.activeTextEditorControl;if(j(s)&&!s?.hasTextFocus()){const r=Te.get(s);if(r&&r.isFindInputFocused())return this.updateTextFromFindWidget(r,{allowSearchOnType:t});s=this.codeEditorService.listCodeEditors().find(a=>a instanceof Pe&&a.getParentEditor()===s&&a.hasTextFocus())??s}return this.updateTextFromSelection({allowUnselectedWord:e,allowSearchOnType:t},s)}updateTextFromFindWidget(e,{allowSearchOnType:t=!0}){if(!this.searchConfig.seedWithNearestWord&&(o.getActiveWindow().getSelection()?.toString()??"")==="")return!1;const s=e.getState().searchString;return s===""?!1:(this.searchWidget.searchInput?.setCaseSensitive(e.getState().matchCase),this.searchWidget.searchInput?.setWholeWords(e.getState().wholeWord),this.searchWidget.searchInput?.setRegex(e.getState().isRegex),this.updateText(s,t),!0)}updateTextFromSelection({allowUnselectedWord:e=!0,allowSearchOnType:t=!0},s){const r=this.configurationService.getValue("editor").find.seedSearchStringFromSelection;if(!r||r==="never")return!1;let i=this.getSearchTextFromEditor(e,s);return i===null?!1:(this.searchWidget.searchInput?.getRegex()&&(i=xe.escapeRegExpCharacters(i)),this.updateText(i,t),!0)}updateText(e,t=!0){t&&!this.viewModel.searchResult.isDirty?this.searchWidget.setValue(e):(this.pauseSearching=!0,this.searchWidget.setValue(e),this.pauseSearching=!1)}focusNextInputBox(){if(this.searchWidget.searchInputHasFocus()){this.searchWidget.isReplaceShown()?this.searchWidget.focus(!0,!0):this.moveFocusFromSearchOrReplace();return}if(this.searchWidget.replaceInputHasFocus()){this.moveFocusFromSearchOrReplace();return}if(this.inputPatternIncludes.inputHasFocus()){this.inputPatternExcludes.focus(),this.inputPatternExcludes.select();return}if(this.inputPatternExcludes.inputHasFocus()){this.selectTreeIfNotSelected();return}}moveFocusFromSearchOrReplace(){this.showsFileTypes()?this.toggleQueryDetails(!0,this.showsFileTypes()):this.selectTreeIfNotSelected()}focusPreviousInputBox(){if(!this.searchWidget.searchInputHasFocus()){if(this.searchWidget.replaceInputHasFocus()){this.searchWidget.focus(!0);return}if(this.inputPatternIncludes.inputHasFocus()){this.searchWidget.focus(!0,!0);return}if(this.inputPatternExcludes.inputHasFocus()){this.inputPatternIncludes.focus(),this.inputPatternIncludes.select();return}if(this.tree.isDOMFocused()){this.moveFocusFromResults();return}}}moveFocusFromResults(){this.showsFileTypes()?this.toggleQueryDetails(!0,!0,!1,!0):this.searchWidget.focus(!0,!0)}reLayout(){if(this.isDisposed||!this.size)return;const e=this.searchConfig.actionsPosition;this.getContainer().classList.toggle(A.ACTIONS_RIGHT_CLASS_NAME,e==="right"),this.searchWidget.setWidth(this.size.width-28),this.inputPatternExcludes.setWidth(this.size.width-28),this.inputPatternIncludes.setWidth(this.size.width-28);const t=o.getTotalHeight(this.searchWidgetsContainerElement),s=o.getTotalHeight(this.messagesElement);this.tree.layout(this.size.height-t-s,this.size.width-28)}layoutBody(e,t){super.layoutBody(e,t),this.size=new o.Dimension(t,e),this.reLayout()}getControl(){return this.tree}allSearchFieldsClear(){return this.searchWidget.getReplaceValue()===""&&(!this.searchWidget.searchInput||this.searchWidget.searchInput.getValue()==="")}allFilePatternFieldsClear(){return this.searchExcludePattern.getValue()===""&&this.searchIncludePattern.getValue()===""}hasSearchResults(){return!this.viewModel.searchResult.isEmpty()}clearSearchResults(e=!0){this.viewModel.searchResult.clear(),this.showEmptyStage(!0),this.contextService.getWorkbenchState()===_.EMPTY&&this.showSearchWithoutFolderMessage(),e&&(this.allSearchFieldsClear()&&this.clearFilePatternFields(),this.searchWidget.clear()),this.viewModel.cancelSearch(),this.tree.ariaLabel=n.localize("emptySearch","Empty Search"),this.accessibilitySignalService.playSignal(zt.clear),this.reLayout()}clearFilePatternFields(){this.searchExcludePattern.clear(),this.searchIncludePattern.clear()}cancelSearch(e=!0){return this.viewModel.cancelSearch()?(e&&this.searchWidget.focus(),!0):!1}selectTreeIfNotSelected(){if(this.tree.getNode(void 0)&&(this.tree.domFocus(),this.tree.getSelection().length===0)){const t=B();this.tree.focusNext(void 0,void 0,t),this.tree.setSelection(this.tree.getFocus(),t)}}getSearchTextFromEditor(e,t){if(o.isAncestorOfActiveElement(this.getContainer())||(t=t??this.editorService.activeTextEditorControl,!t))return null;const s=this.searchConfig.seedWithNearestWord&&e;return Yt(s,t)}showsFileTypes(){return this.queryDetails.classList.contains("more")}toggleCaseSensitive(){this.searchWidget.searchInput?.setCaseSensitive(!this.searchWidget.searchInput.getCaseSensitive()),this.triggerQueryChange()}toggleWholeWords(){this.searchWidget.searchInput?.setWholeWords(!this.searchWidget.searchInput.getWholeWords()),this.triggerQueryChange()}toggleRegex(){this.searchWidget.searchInput?.setRegex(!this.searchWidget.searchInput.getRegex()),this.triggerQueryChange()}togglePreserveCase(){this.searchWidget.replaceInput?.setPreserveCase(!this.searchWidget.replaceInput.getPreserveCase()),this.triggerQueryChange()}setSearchParameters(e={}){typeof e.isCaseSensitive=="boolean"&&this.searchWidget.searchInput?.setCaseSensitive(e.isCaseSensitive),typeof e.matchWholeWord=="boolean"&&this.searchWidget.searchInput?.setWholeWords(e.matchWholeWord),typeof e.isRegex=="boolean"&&this.searchWidget.searchInput?.setRegex(e.isRegex),typeof e.filesToInclude=="string"&&this.searchIncludePattern.setValue(String(e.filesToInclude)),typeof e.filesToExclude=="string"&&this.searchExcludePattern.setValue(String(e.filesToExclude)),typeof e.query=="string"&&this.searchWidget.searchInput?.setValue(e.query),typeof e.replace=="string"?this.searchWidget.replaceInput?.setValue(e.replace):this.searchWidget.replaceInput&&this.searchWidget.replaceInput.getValue()!==""&&this.searchWidget.replaceInput.setValue(""),typeof e.triggerSearch=="boolean"&&e.triggerSearch&&this.triggerQueryChange(),typeof e.preserveCase=="boolean"&&this.searchWidget.replaceInput?.setPreserveCase(e.preserveCase),typeof e.useExcludeSettingsAndIgnoreFiles=="boolean"&&this.inputPatternExcludes.setUseExcludesAndIgnoreFiles(e.useExcludeSettingsAndIgnoreFiles),typeof e.onlyOpenEditors=="boolean"&&this.searchIncludePattern.setOnlySearchInOpenEditors(e.onlyOpenEditors)}toggleQueryDetails(e=!0,t,s,r){const i="more";t=typeof t>"u"?!this.queryDetails.classList.contains(i):!!t,this.viewletState["query.queryDetailsExpanded"]=t,s=!!s,t?(this.toggleQueryDetailsButton.setAttribute("aria-expanded","true"),this.queryDetails.classList.add(i),e&&(r?(this.inputPatternExcludes.focus(),this.inputPatternExcludes.select()):(this.inputPatternIncludes.focus(),this.inputPatternIncludes.select()))):(this.toggleQueryDetailsButton.setAttribute("aria-expanded","false"),this.queryDetails.classList.remove(i),e&&this.searchWidget.focus()),!s&&this.size&&this.reLayout()}searchInFolders(e=[]){this._searchWithIncludeOrExclude(!0,e)}searchOutsideOfFolders(e=[]){this._searchWithIncludeOrExclude(!1,e)}_searchWithIncludeOrExclude(e,t){if(!t.length||t.some(s=>s===".")){this.inputPatternIncludes.setValue(""),this.searchWidget.focus();return}this.showsFileTypes()||this.toggleQueryDetails(!0,!0),(e?this.inputPatternIncludes:this.inputPatternExcludes).setValue(t.join(", ")),this.searchWidget.focus(!1)}triggerQueryChange(e){const t={preserveFocus:!0,triggeredOnType:!1,delay:0,...e};if(!(t.triggeredOnType&&!this.searchConfig.searchOnType)&&!this.pauseSearching){const s=t.triggeredOnType?t.delay:0;this.triggerQueryDelayer.trigger(()=>{this._onQueryChanged(t.preserveFocus,t.triggeredOnType)},s)}}_getExcludePattern(){return this.inputPatternExcludes.getValue().trim()}_getIncludePattern(){return this.inputPatternIncludes.getValue().trim()}_onQueryChanged(e,t=!1){if(!this.searchWidget.searchInput?.inputBox.isInputValid())return;this.tree.hasNode(this.searchResult.aiTextSearchResult)&&this.tree.collapse(this.searchResult.aiTextSearchResult);const s=this.searchWidget.searchInput.getRegex(),r=this.searchWidget.getNotebookFilters().markupInput,i=this.searchWidget.getNotebookFilters().markupPreview,a=this.searchWidget.getNotebookFilters().codeInput,l=this.searchWidget.getNotebookFilters().codeOutput,p=this.searchWidget.searchInput.getWholeWords(),h=this.searchWidget.searchInput.getCaseSensitive(),v=this.searchWidget.searchInput.getValue(),u=this._getExcludePattern(),y=this._getIncludePattern(),E=this.inputPatternExcludes.useExcludesAndIgnoreFiles(),x=this.inputPatternIncludes.onlySearchInOpenEditors();if(v.length===0){this.clearSearchResults(!1),this.clearMessage();return}const I={pattern:v,isRegExp:s,isCaseSensitive:h,isWordMatch:p,notebookInfo:{isInNotebookMarkdownInput:r,isInNotebookMarkdownPreview:i,isInNotebookCellInput:a,isInNotebookCellOutput:l}},R=[{pattern:this.inputPatternExcludes.getValue()}],M=this.inputPatternIncludes.getValue(),g=I.isRegExp?1e4:1e3,F={_reason:"searchView",extraFileResources:this.instantiationService.invokeFunction(Ct),maxResults:this.searchConfig.maxResults??void 0,disregardIgnoreFiles:!E||void 0,disregardExcludeSettings:!E||void 0,onlyOpenEditors:x,excludePattern:R,includePattern:M,previewOptions:{matchLines:1,charsPerLine:g},isSmartCase:this.searchConfig.smartCase,expandPatterns:!0},ee=this.contextService.getWorkspace().folders,L=T=>{this.searchWidget.searchInput?.showMessage({content:T.message,type:te.ERROR}),this.viewModel.searchResult.clear()};let V;try{V=this.queryBuilder.text(I,ee.map(T=>T.uri),F)}catch(T){L(T);return}this.validateQuery(V).then(()=>{this.onQueryTriggered(V,F,u,y,t),e||this.searchWidget.focus(!1,void 0,!0)},L)}validateQuery(e){const t=e.folderQueries.map(s=>this.fileService.exists(s.folder).catch(()=>!1));return Promise.all(t).then(s=>{const r=e.folderQueries.filter((i,a)=>s[a]);if(!e.folderQueries.length||r.length)e.folderQueries=r;else{const i=e.folderQueries[0].folder.fsPath,a=n.localize("searchPathNotFoundError","Search path not found: {0}",i);return Promise.reject(new Error(a))}})}onQueryTriggered(e,t,s,r,i){this.addToSearchHistoryDelayer.trigger(()=>{this.searchWidget.searchInput?.onSearchSubmit(),this.inputPatternExcludes.onSearchSubmit(),this.inputPatternIncludes.onSearchSubmit()}),this.viewModel.cancelSearch(!0),this.viewModel.cancelAISearch(!0),this.currentSearchQ=this.currentSearchQ.then(()=>this.doSearch(e,s,r,i)).then(()=>{},()=>{})}async _updateResults(){if(this.state!==w.Idle)try{const e=this.viewModel.searchResult.fileCount();this._visibleMatches!==e&&(this._visibleMatches=e,await this.refreshAndUpdateCount())}finally{this._refreshResultsScheduler.schedule()}}async onSearchComplete(e,t,s,r){if(this.state=w.Idle,e(),this.onSearchResultsChanged(),this.searchConfig.collapseResults!=="alwaysCollapse"&&this.viewModel.searchResult.matches().length===1){const l=this.viewModel.searchResult.matches()[0];l.count()<50&&await this.tree.expand(l)}const a=!this.viewModel.searchResult.isEmpty();if(r?.exit!==_t.NewSearchStarted){if(a)this.viewModel.searchResult.toggleHighlights(this.isVisible()),N.status(n.localize("ariaSearchResultsStatus","Search returned {0} results in {1} files",this.viewModel.searchResult.count(),this.viewModel.searchResult.fileCount()));else{const l=!!t,p=!!s;let h;r?this.inputPatternIncludes.onlySearchInOpenEditors()?p&&l?h=n.localize("noOpenEditorResultsIncludesExcludes","No results found in open editors matching '{0}' excluding '{1}' - ",s,t):p?h=n.localize("noOpenEditorResultsIncludes","No results found in open editors matching '{0}' - ",s):l?h=n.localize("noOpenEditorResultsExcludes","No results found in open editors excluding '{0}' - ",t):h=n.localize("noOpenEditorResultsFound","No results found in open editors. Review your settings for configured exclusions and check your gitignore files - "):p&&l?h=n.localize("noResultsIncludesExcludes","No results found in '{0}' excluding '{1}' - ",s,t):p?h=n.localize("noResultsIncludes","No results found in '{0}' - ",s):l?h=n.localize("noResultsExcludes","No results found excluding '{0}' - ",t):h=n.localize("noResultsFound","No results found. Review your settings for configured exclusions and check your gitignore files - "):h=ue,N.status(h);const v=this.clearMessage();if(o.append(v,h),r)if(p||l){const u=this.messageDisposables.add(new W(n.localize("rerunSearchInAll.message","Search again in all files"),this.onSearchAgain.bind(this),this.hoverService));o.append(v,u.element)}else{const u=this.messageDisposables.add(new W(n.localize("openSettings.message","Open Settings"),this.onOpenSettings.bind(this),this.hoverService));o.append(v,u.element)}else{const u=this.messageDisposables.add(new W(n.localize("rerunSearch.message","Search again"),()=>this.triggerQueryChange({preserveFocus:!1}),this.hoverService));o.append(v,u.element)}if(r){o.append(v,C("span",void 0," - "));const u=this.messageDisposables.add(new W(n.localize("openSettings.learnMore","Learn More"),this.onLearnMore.bind(this),this.hoverService));o.append(v,u.element)}this.contextService.getWorkbenchState()===_.EMPTY&&this.showSearchWithoutFolderMessage(),this.reLayout()}if(r&&r.limitHit&&r.messages.push({type:Kt.Warning,text:n.localize("searchMaxResultsWarning","The result set only contains a subset of all matches. Be more specific in your search to narrow down the results.")}),r&&r.messages)for(const l of r.messages)this.addMessage(l);this.reLayout()}}async onSearchError(e,t,s,r,i){return this.state=w.Idle,O.isCancellationError(e)?this.onSearchComplete(t,s,r,i):(t(),this.searchWidget.searchInput?.showMessage({content:e.message,type:te.ERROR}),this.viewModel.searchResult.clear(),Promise.resolve())}async addAIResults(){const e=this._getExcludePattern(),t=this._getIncludePattern();let s;this.progressService.withProgress({location:this.getProgressLocation(),delay:0},a=>new Promise(l=>s=l)),this.searchWidget.searchInput?.clearMessage(),this.state=w.Searching,this.showEmptyStage();const r=setTimeout(()=>{this.state=w.SlowSearch},2e3);return this._visibleMatches=0,this._refreshResultsScheduler.schedule(),this.searchWidget.setReplaceAllActionState(!1),this.tree.setSelection([]),this.tree.setFocus([]),this.viewModel.replaceString=this.searchWidget.getReplaceValue(),this.viewModel.addAIResults().then(a=>(clearTimeout(r),this.onSearchComplete(s,e,t,a)),a=>(clearTimeout(r),this.onSearchError(a,s,e,t)))}doSearch(e,t,s,r){let i;this.progressService.withProgress({location:this.getProgressLocation(),delay:r?300:0},p=>new Promise(h=>i=h)),this.searchWidget.searchInput?.clearMessage(),this.state=w.Searching,this.showEmptyStage();const a=setTimeout(()=>{this.state=w.SlowSearch},2e3);return this._visibleMatches=0,this._refreshResultsScheduler.schedule(),this.searchWidget.setReplaceAllActionState(!1),this.tree.setSelection([]),this.tree.setFocus([]),this.viewModel.replaceString=this.searchWidget.getReplaceValue(),this.viewModel.search(e).asyncResults.then(p=>(clearTimeout(a),this.onSearchComplete(i,t,s,p)),p=>(clearTimeout(a),this.onSearchError(p,i,t,s)))}onOpenSettings(e){o.EventHelper.stop(e,!1),this.openSettings("@id:files.exclude,search.exclude,search.useParentIgnoreFiles,search.useGlobalIgnoreFiles,search.useIgnoreFiles")}openSettings(e){const t={query:e};return this.contextService.getWorkbenchState()!==_.EMPTY?this.preferencesService.openWorkspaceSettings(t):this.preferencesService.openUserSettings(t)}onLearnMore(){this.openerService.open(Ee.parse("https://go.microsoft.com/fwlink/?linkid=853977"))}onSearchAgain(){this.inputPatternExcludes.setValue(""),this.inputPatternIncludes.setValue(""),this.inputPatternIncludes.setOnlySearchInOpenEditors(!1),this.triggerQueryChange({preserveFocus:!1})}onEnableExcludes(){this.toggleQueryDetails(!1,!0),this.searchExcludePattern.setUseExcludesAndIgnoreFiles(!0)}onDisableSearchInOpenEditors(){this.toggleQueryDetails(!1,!0),this.inputPatternIncludes.setOnlySearchInOpenEditors(!1)}updateSearchResultCount(e,t,s=!1){const r=this.viewModel.searchResult.fileCount(),i=this.viewModel.searchResult.count();this.hasSearchResultsKey.set(r>0);const a=this.messagesElement.style.display==="none",l=this.clearMessage(),p=s?"":this.buildResultCountMessage(i,r);if(this.tree.ariaLabel=p+n.localize("forTerm"," - Search: {0}",this.searchResult.query?.contentPattern.pattern??""),o.append(l,p),r>0){if(e){const u=" - "+n.localize("useIgnoresAndExcludesDisabled","exclude settings and ignore files are disabled")+" ",y=this.messageDisposables.add(new W(n.localize("excludes.enable","enable"),this.onEnableExcludes.bind(this),this.hoverService,n.localize("useExcludesAndIgnoreFilesDescription","Use Exclude Settings and Ignore Files")));o.append(l,C("span",void 0,u,"(",y.element,")"))}if(t){const u=" - "+n.localize("onlyOpenEditors","searching only in open files")+" ",y=this.messageDisposables.add(new W(n.localize("openEditors.disable","disable"),this.onDisableSearchInOpenEditors.bind(this),this.hoverService,n.localize("disableOpenEditors","Search in entire workspace")));o.append(l,C("span",void 0,u,"(",y.element,")"))}o.append(l," - ");const h=dt(n.localize("openInEditor.tooltip","Copy current search results to an editor"),this.keybindingService.lookupKeybinding(f.SearchCommandIds.OpenInEditorCommandId)),v=this.messageDisposables.add(new W(n.localize("openInEditor.message","Open in editor"),()=>this.instantiationService.invokeFunction(Wt,this.searchResult,this.searchIncludePattern.getValue(),this.searchExcludePattern.getValue(),this.searchIncludePattern.onlySearchInOpenEditors()),this.hoverService,h));o.append(l,v.element),this.reLayout()}else a||o.hide(this.messagesElement)}addMessage(e){const t=this.messagesElement.firstChild;t&&o.append(t,gt(e,this.instantiationService,this.notificationService,this.openerService,this.commandService,this.messageDisposables,()=>this.triggerQueryChange()))}buildResultCountMessage(e,t){return e===1&&t===1?n.localize("search.file.result","{0} result in {1} file",e,t):e===1?n.localize("search.files.result","{0} result in {1} files",e,t):t===1?n.localize("search.file.results","{0} results in {1} file",e,t):n.localize("search.files.results","{0} results in {1} files",e,t)}showSearchWithoutFolderMessage(){this.searchWithoutFolderMessageElement=this.clearMessage();const e=o.append(this.searchWithoutFolderMessageElement,C("p",void 0,n.localize("searchWithoutFolder","You have not opened or specified a folder. Only open files are currently searched - "))),t=this.messageDisposables.add(new W(n.localize("openFolder","Open Folder"),()=>{this.commandService.executeCommand(ie.isMacintosh&&ie.isNative?st.ID:it.ID).catch(s=>O.onUnexpectedError(s))},this.hoverService));o.append(e,t.element)}showEmptyStage(e=!1){((this.messagesElement.firstChild?.textContent?.indexOf(ue)??-1)>-1||e||!this.configurationService.getValue().search.searchOnType)&&o.hide(this.messagesElement),o.show(this.resultsElement),this.currentSelectedFileMatch=void 0}shouldOpenInNotebookEditor(e,t){return e instanceof X||t.scheme!==Re.Schemas.untitled&&this.notebookService.getContributedNotebookTypes(t).length>0}onFocus(e,t,s,r){const i=this.configurationService.getValue().search.useReplacePreview,a=e instanceof S?e.parent().resource:e.resource;return i&&this.viewModel.isReplaceActive()&&this.viewModel.replaceString&&!this.shouldOpenInNotebookEditor(e,a)?this.replaceService.openReplacePreview(e,t,s,r):this.open(e,t,s,r,a)}async open(e,t,s,r,i){const a=Ut(e,this.viewModel),l=e instanceof S?e.parent().matches():[],p=i??(e instanceof S?e.parent().resource:e.resource);let h;const v={preserveFocus:t,pinned:r,selection:a,revealIfVisible:!0};try{h=await this.editorService.openEditor({resource:p,options:v},s?At:Tt);const u=h?.getControl();e instanceof S&&t&&j(u)?this.viewModel.searchResult.getRangeHighlightDecorations().highlightRange(u.getModel(),e.range()):this.viewModel.searchResult.getRangeHighlightDecorations().removeHighlightRange()}catch(u){O.onUnexpectedError(u);return}if(h instanceof lt){const u=e.parent();if(e instanceof S)if(e instanceof X)e.parent().showMatch(e);else{const y=h.getControl();if(y){u.bindNotebookEditorWidget(y),await u.updateMatchesForEditorWidget();const E=l.findIndex(R=>R.id()===e.id()),x=u.matches(),I=E>=x.length?x[x.length-1]:x[E];I instanceof X&&(u.showMatch(I),(!this.tree.getFocus().includes(I)||!this.tree.getSelection().includes(I))&&(this.tree.setSelection([I],B()),this.tree.setFocus([I])))}}}}openEditorWithMultiCursor(e){const t=e instanceof S?e.parent().resource:e.resource;return this.editorService.openEditor({resource:t,options:{preserveFocus:!1,pinned:!0,revealIfVisible:!0}}).then(s=>{if(s){let r=null;if(e instanceof P?r=e:e instanceof S&&(r=e.parent()),r){const i=r.matches().map(l=>new We(l.range().startLineNumber,l.range().startColumn,l.range().endLineNumber,l.range().endColumn)),a=we(s.getControl());a&&De.get(a)?.selectAllUsingSelections(i)}}this.viewModel.searchResult.getRangeHighlightDecorations().removeHighlightRange()},O.onUnexpectedError)}onUntitledDidDispose(e){if(!this.viewModel)return;let t=this.viewModel.searchResult.matches();for(let s=0,r=t.length;s<r;s++)e.toString()===t[s].resource.toString()&&this.viewModel.searchResult.remove(t[s]);t=this.viewModel.searchResult.matches(!0);for(let s=0,r=t.length;s<r;s++)e.toString()===t[s].resource.toString()&&this.viewModel.searchResult.remove(t[s])}onFilesChanged(e){if(!this.viewModel||this.searchConfig.sortOrder!==D.Modified&&!e.gotDeleted())return;const t=this.viewModel.searchResult.matches();if(e.gotDeleted()){const s=t.filter(r=>e.contains(r.resource,Le.DELETED));this.viewModel.searchResult.remove(s)}else{const s=t.filter(r=>e.contains(r.resource));s.length&&this.searchConfig.sortOrder===D.Modified&&this.updateFileStats(s).then(async()=>this.refreshTree())}}get searchConfig(){return this.configurationService.getValue("search")}clearHistory(){this.searchWidget.clearHistory(),this.inputPatternExcludes.clearHistory(),this.inputPatternIncludes.clearHistory()}saveState(){if(!this.searchWidget)return;const e=this.inputPatternExcludes?.getValue().trim()??"",t=this.inputPatternIncludes?.getValue().trim()??"",s=this.inputPatternIncludes?.onlySearchInOpenEditors()??!1,r=this.inputPatternExcludes?.useExcludesAndIgnoreFiles()??!0,i=this.viewModel.preserveCase;if(this.searchWidget.searchInput){const l=this.searchWidget.searchInput.getRegex(),p=this.searchWidget.searchInput.getWholeWords(),h=this.searchWidget.searchInput.getCaseSensitive(),v=this.searchWidget.searchInput.getValue(),u=this.searchWidget.getNotebookFilters().codeInput,y=this.searchWidget.getNotebookFilters().codeOutput,E=this.searchWidget.getNotebookFilters().markupInput,x=this.searchWidget.getNotebookFilters().markupPreview;this.viewletState["query.contentPattern"]=v,this.viewletState["query.regex"]=l,this.viewletState["query.wholeWords"]=p,this.viewletState["query.caseSensitive"]=h,this.viewletState["query.isInNotebookMarkdownInput"]=E,this.viewletState["query.isInNotebookMarkdownPreview"]=x,this.viewletState["query.isInNotebookCellInput"]=u,this.viewletState["query.isInNotebookCellOutput"]=y}this.viewletState["query.folderExclusions"]=e,this.viewletState["query.folderIncludes"]=t,this.viewletState["query.useExcludesAndIgnoreFiles"]=r,this.viewletState["query.preserveCase"]=i,this.viewletState["query.onlyOpenEditors"]=s;const a=this.searchAndReplaceWidget.isReplaceShown();this.viewletState["view.showReplace"]=a,this.viewletState["view.treeLayout"]=this.isTreeLayoutViewVisible,this.viewletState["query.replaceText"]=a&&this.searchWidget.getReplaceValue(),this._saveSearchHistoryService(),this.memento.saveMemento(),super.saveState()}_saveSearchHistoryService(){if(this.searchWidget===void 0)return;const e=Object.create(null),t=this.searchWidget.getSearchHistory();t&&t.length&&(e.search=t);const s=this.searchWidget.getReplaceHistory();s&&s.length&&(e.replace=s);const r=this.inputPatternExcludes.getHistory();r&&r.length&&(e.exclude=r);const i=this.inputPatternIncludes.getHistory();i&&i.length&&(e.include=i),this.searchHistoryService.save(e)}async retrieveFileStats(){const e=this.searchResult.matches().filter(t=>!t.fileStat).map(t=>t.resolveFileStat(this.fileService));await Promise.all(e)}async updateFileStats(e){const t=e.map(s=>s.resolveFileStat(this.fileService));await Promise.all(t)}removeFileStats(){for(const e of this.searchResult.matches())e.fileStat=void 0;for(const e of this.searchResult.matches(!0))e.fileStat=void 0}dispose(){this.isDisposed=!0,this.saveState(),super.dispose()}};A=q([d(1,Ve),d(2,Dt),d(3,Fe),d(4,Ge),d(5,qe),d(6,ke),d(7,He),d(8,Ke),d(9,Ne),d(10,ct),d(11,re),d(12,tt),d(13,Ft),d(14,ae),d(15,bt),d(16,Lt),d(17,Ot),d(18,Ze),d(19,Et),d(20,_e),d(21,Ae),d(22,Be),d(23,je),d(24,Ue),d(25,Xe),d(26,Qt),d(27,Vt),d(28,Nt),d(29,Bt)],A);class W extends Ce{element;constructor(c,e,t,s){super(),this.element=C("a.pointer",{tabindex:0},c),this._register(t.setupManagedHover(he("mouse"),this.element,s)),this.addEventHandlers(e)}addEventHandlers(c){const e=t=>{o.EventHelper.stop(t,!1),c(t)};this._register(o.addDisposableListener(this.element,o.EventType.CLICK,e)),this._register(o.addDisposableListener(this.element,o.EventType.KEY_DOWN,t=>{const s=new U(t);(s.equals(H.Space)||s.equals(H.Enter))&&(e(t),s.preventDefault(),s.stopPropagation())}))}}function Ut(b,c){let e=null;if(b instanceof S&&(e=b),b instanceof P&&b.count()>0&&(e=b.matches()[b.matches().length-1]),e){const t=e.range();if(c.isReplaceActive()&&c.replaceString){const s=e.replaceString;return{startLineNumber:t.startLineNumber,startColumn:t.startColumn,endLineNumber:t.startLineNumber,endColumn:t.startColumn+s.length}}return t}}function Yt(b,c){let e=c;if(Me(e)&&(e.getOriginalEditor().hasTextFocus()?e=e.getOriginalEditor():e=e.getModifiedEditor()),!j(e)||!e.hasModel())return null;const t=e.getSelection();if(!t)return null;if(t.isEmpty())return b?e.getModel().getWordAtPosition(t.getStartPosition())?.word??null:null;let s="";for(let r=t.startLineNumber;r<=t.endLineNumber;r++){let i=e.getModel().getLineContent(r);r===t.endLineNumber&&(i=i.substring(0,t.endColumn-1)),r===t.startLineNumber&&(i=i.substring(t.startColumn-1)),r!==t.startLineNumber&&(i=`
`+i),s+=i}return s}let k=class{constructor(c,e){this.searchView=c;this.configurationService=e}get searchConfig(){return this.configurationService.getValue("search")}createSearchResultIterator(c){const e=[];if(!c.plainTextSearchResult.isEmpty()){if(!this.searchView.shouldShowAIResults())return this.createTextSearchResultIterator(c.plainTextSearchResult);e.push(c.plainTextSearchResult)}return this.searchView.shouldShowAIResults()&&c.searchModel.hasPlainResults&&!c.aiTextSearchResult.hidden&&e.push(c.aiTextSearchResult),e}createTextSearchResultIterator(c){const e=c.folderMatches().filter(t=>!t.isEmpty()).sort(J);return e.length===1?this.createFolderIterator(e[0]):e}createFolderIterator(c){return(this.searchView.isTreeLayoutViewVisible?c.matches():c.allDownstreamFileMatches()).sort((s,r)=>J(s,r,this.searchConfig.sortOrder))}createFileIterator(c){return c.matches().sort(J)}hasChildren(c){return c instanceof S?!1:c instanceof Z&&c.id()===Q?!0:c.hasChildren}getChildren(c){return c instanceof le?this.createSearchResultIterator(c):c instanceof Z?c.id()===Q&&!this.searchView.model.hasAIResults?this.searchView.addAIResults().then(()=>this.createTextSearchResultIterator(c)):this.createTextSearchResultIterator(c):c instanceof K?this.createFolderIterator(c):c instanceof P?this.createFileIterator(c):[]}getParent(c){const e=c.parent();if(e instanceof le)throw new Error("Invalid element passed to getParent");return e}};k=q([d(1,re)],k);export{A as SearchView,qt as SearchViewPosition,Ut as getEditorSelectionFromMatch,Yt as getSelectionTextFromEditor};
