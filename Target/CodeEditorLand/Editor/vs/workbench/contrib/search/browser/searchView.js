var ge=Object.defineProperty;var fe=Object.getOwnPropertyDescriptor;var J=(C,y,e,t)=>{for(var i=t>1?void 0:t?fe(y,e):y,r=C.length-1,s;r>=0;r--)(s=C[r])&&(i=(t?s(y,e,i):s(i))||i);return t&&i&&ge(y,e,i),i},d=(C,y)=>(e,t)=>y(e,t,C);import*as a from"../../../../../vs/base/browser/dom.js";import{StandardKeyboardEvent as z}from"../../../../../vs/base/browser/keyboardEvent.js";import*as k from"../../../../../vs/base/browser/ui/aria/aria.js";import{MessageType as X}from"../../../../../vs/base/browser/ui/inputbox/inputBox.js";import"../../../../../vs/base/browser/ui/list/list.js";import"../../../../../vs/base/browser/ui/tree/compressedObjectTreeModel.js";import{ObjectTreeElementCollapseState as Z}from"../../../../../vs/base/browser/ui/tree/tree.js";import{Delayer as L,RunOnceScheduler as ve}from"../../../../../vs/base/common/async.js";import*as A from"../../../../../vs/base/common/errors.js";import{Event as q}from"../../../../../vs/base/common/event.js";import{Iterable as U}from"../../../../../vs/base/common/iterator.js";import{KeyCode as V,KeyMod as Se}from"../../../../../vs/base/common/keyCodes.js";import{Disposable as me,DisposableStore as ee}from"../../../../../vs/base/common/lifecycle.js";import*as ye from"../../../../../vs/base/common/network.js";import*as te from"../../../../../vs/base/common/platform.js";import*as Ie from"../../../../../vs/base/common/strings.js";import{URI as be}from"../../../../../vs/base/common/uri.js";import"vs/css!./media/searchview";import{getDefaultHoverDelegate as ie}from"../../../../../vs/base/browser/ui/hover/hoverDelegateFactory.js";import{ThemeIcon as Ce}from"../../../../../vs/base/common/themables.js";import{getCodeEditor as Ee,isCodeEditor as Y,isDiffEditor as xe}from"../../../../../vs/editor/browser/editorBrowser.js";import{ICodeEditorService as Re}from"../../../../../vs/editor/browser/services/codeEditorService.js";import{EmbeddedCodeEditorWidget as Me}from"../../../../../vs/editor/browser/widget/codeEditor/embeddedCodeEditorWidget.js";import"../../../../../vs/editor/common/config/editorOptions.js";import{Selection as Fe}from"../../../../../vs/editor/common/core/selection.js";import"../../../../../vs/editor/common/editorCommon.js";import{CommonFindController as we}from"../../../../../vs/editor/contrib/find/browser/findController.js";import{MultiCursorSelectionController as We}from"../../../../../vs/editor/contrib/multicursor/browser/multicursor.js";import*as n from"../../../../../vs/nls.js";import{IAccessibilityService as Pe}from"../../../../../vs/platform/accessibility/common/accessibility.js";import{AccessibilitySignal as Te,IAccessibilitySignalService as De}from"../../../../../vs/platform/accessibilitySignal/browser/accessibilitySignalService.js";import{MenuId as Oe}from"../../../../../vs/platform/actions/common/actions.js";import{ICommandService as Ae}from"../../../../../vs/platform/commands/common/commands.js";import{IConfigurationService as Ve}from"../../../../../vs/platform/configuration/common/configuration.js";import{IContextKeyService as se}from"../../../../../vs/platform/contextkey/common/contextkey.js";import{IContextMenuService as He,IContextViewService as Ke}from"../../../../../vs/platform/contextview/browser/contextView.js";import{IDialogService as _e}from"../../../../../vs/platform/dialogs/common/dialogs.js";import{FileChangeType as ke,IFileService as Le}from"../../../../../vs/platform/files/common/files.js";import{IHoverService as Ne}from"../../../../../vs/platform/hover/browser/hover.js";import{IInstantiationService as Qe}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{ServiceCollection as Be}from"../../../../../vs/platform/instantiation/common/serviceCollection.js";import{IKeybindingService as ze}from"../../../../../vs/platform/keybinding/common/keybinding.js";import{getSelectionKeyboardEvent as N,WorkbenchCompressibleObjectTree as qe}from"../../../../../vs/platform/list/browser/listService.js";import{ILogService as Ue}from"../../../../../vs/platform/log/common/log.js";import{INotificationService as Ye}from"../../../../../vs/platform/notification/common/notification.js";import{IOpenerService as je,withSelection as Ge}from"../../../../../vs/platform/opener/common/opener.js";import{IProgressService as $e}from"../../../../../vs/platform/progress/common/progress.js";import{IStorageService as Je,StorageScope as re,StorageTarget as Xe}from"../../../../../vs/platform/storage/common/storage.js";import{ITelemetryService as Ze}from"../../../../../vs/platform/telemetry/common/telemetry.js";import{defaultInputBoxStyles as j,defaultToggleStyles as et}from"../../../../../vs/platform/theme/browser/defaultStyles.js";import{IThemeService as tt}from"../../../../../vs/platform/theme/common/themeService.js";import{IWorkspaceContextService as it,WorkbenchState as H}from"../../../../../vs/platform/workspace/common/workspace.js";import{OpenFileFolderAction as st,OpenFolderAction as rt}from"../../../../../vs/workbench/browser/actions/workspaceActions.js";import{ResourceListDnDHandler as ot}from"../../../../../vs/workbench/browser/dnd.js";import{ResourceLabels as at}from"../../../../../vs/workbench/browser/labels.js";import{ViewPane as nt}from"../../../../../vs/workbench/browser/parts/views/viewPane.js";import"../../../../../vs/workbench/common/editor.js";import{Memento as ct}from"../../../../../vs/workbench/common/memento.js";import{IViewDescriptorService as lt}from"../../../../../vs/workbench/common/views.js";import{NotebookEditor as ht}from"../../../../../vs/workbench/contrib/notebook/browser/notebookEditor.js";import{INotebookService as ut}from"../../../../../vs/workbench/contrib/notebook/common/notebookService.js";import{ExcludePatternInputWidget as dt,IncludePatternInputWidget as pt}from"../../../../../vs/workbench/contrib/search/browser/patternInputWidget.js";import{IReplaceService as gt}from"../../../../../vs/workbench/contrib/search/browser/replace.js";import{appendKeyBindingLabel as ft}from"../../../../../vs/workbench/contrib/search/browser/searchActionsBase.js";import"../../../../../vs/workbench/contrib/search/browser/searchActionsFind.js";import{searchDetailsIcon as vt}from"../../../../../vs/workbench/contrib/search/browser/searchIcons.js";import{renderSearchMessage as St}from"../../../../../vs/workbench/contrib/search/browser/searchMessage.js";import{FileMatch as M,FolderMatch as Q,FolderMatchWithResource as oe,ISearchViewModelWorkbenchService as mt,Match as m,MatchInNotebook as B,searchMatchComparer as G,SearchModelLocation as yt,SearchResult as It}from"../../../../../vs/workbench/contrib/search/browser/searchModel.js";import{FileMatchRenderer as bt,FolderMatchRenderer as Ct,MatchRenderer as Et,SearchAccessibilityProvider as xt,SearchDelegate as ae}from"../../../../../vs/workbench/contrib/search/browser/searchResultsView.js";import{SearchWidget as Rt}from"../../../../../vs/workbench/contrib/search/browser/searchWidget.js";import*as g from"../../../../../vs/workbench/contrib/search/common/constants.js";import{getOutOfWorkspaceEditorResources as Mt,SearchStateKey as Ft,SearchUIState as T}from"../../../../../vs/workbench/contrib/search/common/search.js";import{ISearchHistoryService as wt,SearchHistoryService as Wt}from"../../../../../vs/workbench/contrib/search/common/searchHistoryService.js";import{createEditorFromSearchResult as Pt}from"../../../../../vs/workbench/contrib/searchEditor/browser/searchEditorActions.js";import{ACTIVE_GROUP as Tt,IEditorService as Dt,SIDE_GROUP as Ot}from"../../../../../vs/workbench/services/editor/common/editorService.js";import{IPreferencesService as At}from"../../../../../vs/workbench/services/preferences/common/preferences.js";import{QueryBuilder as Vt}from"../../../../../vs/workbench/services/search/common/queryBuilder.js";import{QueryType as Ht,SearchCompletionExitCode as Kt,SearchSortOrder as D,TextSearchCompleteMessageType as _t,ViewMode as kt}from"../../../../../vs/workbench/services/search/common/search.js";import"../../../../../vs/workbench/services/search/common/searchExtTypes.js";import{ITextFileService as Lt}from"../../../../../vs/workbench/services/textfile/common/textfiles.js";const b=a.$;var Nt=(e=>(e[e.SideBar=0]="SideBar",e[e.Panel=1]="Panel",e))(Nt||{});const ne=n.localize("searchCanceled","Search was canceled before any results could be found - "),ce=75;let O=class extends nt{constructor(e,t,i,r,s,o,c,h,l,f,u,S,x,E,I,R,F,p,w,$,K,_,P,le,he,ue,de,zt,qt,Ut){super(e,P,K,S,I,u,f,he,w,ue,de);this.fileService=t;this.editorService=i;this.codeEditorService=r;this.progressService=s;this.notificationService=o;this.dialogService=c;this.commandService=h;this.contextViewService=l;this.contextService=x;this.searchViewModelWorkbenchService=E;this.replaceService=R;this.textFileService=F;this.preferencesService=p;this.searchHistoryService=$;this.accessibilityService=_;this.storageService=le;this.notebookService=zt;this.logService=qt;this.accessibilitySignalService=Ut;this.container=a.$(".search-view"),this.viewletVisible=g.SearchContext.SearchViewVisibleKey.bindTo(this.contextKeyService),this.firstMatchFocused=g.SearchContext.FirstMatchFocusKey.bindTo(this.contextKeyService),this.fileMatchOrMatchFocused=g.SearchContext.FileMatchOrMatchFocusKey.bindTo(this.contextKeyService),this.fileMatchOrFolderMatchFocus=g.SearchContext.FileMatchOrFolderMatchFocusKey.bindTo(this.contextKeyService),this.fileMatchOrFolderMatchWithResourceFocus=g.SearchContext.FileMatchOrFolderMatchWithResourceFocusKey.bindTo(this.contextKeyService),this.fileMatchFocused=g.SearchContext.FileFocusKey.bindTo(this.contextKeyService),this.folderMatchFocused=g.SearchContext.FolderFocusKey.bindTo(this.contextKeyService),this.folderMatchWithResourceFocused=g.SearchContext.ResourceFolderFocusKey.bindTo(this.contextKeyService),this.hasSearchResultsKey=g.SearchContext.HasSearchResults.bindTo(this.contextKeyService),this.matchFocused=g.SearchContext.MatchFocusKey.bindTo(this.contextKeyService),this.searchStateKey=Ft.bindTo(this.contextKeyService),this.hasSearchPatternKey=g.SearchContext.ViewHasSearchPatternKey.bindTo(this.contextKeyService),this.hasReplacePatternKey=g.SearchContext.ViewHasReplacePatternKey.bindTo(this.contextKeyService),this.hasFilePatternKey=g.SearchContext.ViewHasFilePatternKey.bindTo(this.contextKeyService),this.hasSomeCollapsibleResultKey=g.SearchContext.ViewHasSomeCollapsibleKey.bindTo(this.contextKeyService),this.treeViewKey=g.SearchContext.InTreeViewKey.bindTo(this.contextKeyService),this.aiResultsVisibleKey=g.SearchContext.AIResultsVisibleKey.bindTo(this.contextKeyService),this._register(this.contextKeyService.onDidChangeContext(v=>{const pe=g.SearchContext.hasAIResultProvider.keys();v.affectsSome(new Set(pe))&&this.refreshHasAISetting()})),this.contextKeyService=this._register(this.contextKeyService.createScoped(this.container)),g.SearchContext.SearchViewFocusedKey.bindTo(this.contextKeyService).set(!0),this.inputBoxFocused=g.SearchContext.InputBoxFocusedKey.bindTo(this.contextKeyService),this.inputPatternIncludesFocused=g.SearchContext.PatternIncludesFocusedKey.bindTo(this.contextKeyService),this.inputPatternExclusionsFocused=g.SearchContext.PatternExcludesFocusedKey.bindTo(this.contextKeyService),this.isEditableItem=g.SearchContext.IsEditableItemKey.bindTo(this.contextKeyService),this.instantiationService=this._register(this.instantiationService.createChild(new Be([se,this.contextKeyService]))),this._register(this.configurationService.onDidChangeConfiguration(v=>{v.affectsConfiguration("search.sortOrder")?(this.searchConfig.sortOrder===D.Modified&&this.removeFileStats(),this.refreshTree()):v.affectsConfiguration("search.aiResults")&&this.refreshHasAISetting()})),this.viewModel=this.searchViewModelWorkbenchService.searchModel,this.queryBuilder=this.instantiationService.createInstance(Vt),this.memento=new ct(this.id,le),this.viewletState=this.memento.getMemento(re.WORKSPACE,Xe.MACHINE),this._register(this.fileService.onDidFilesChange(v=>this.onFilesChanged(v))),this._register(this.textFileService.untitled.onWillDispose(v=>this.onUntitledDidDispose(v.resource))),this._register(this.contextService.onDidChangeWorkbenchState(()=>this.onDidChangeWorkbenchState())),this._register(this.searchHistoryService.onDidClearHistory(()=>this.clearHistory())),this._register(this.configurationService.onDidChangeConfiguration(v=>this.onConfigurationUpdated(v))),this.delayedRefresh=this._register(new L(250)),this.addToSearchHistoryDelayer=this._register(new L(2e3)),this.toggleCollapseStateDelayer=this._register(new L(100)),this.triggerQueryDelayer=this._register(new L(0)),this.treeAccessibilityProvider=this.instantiationService.createInstance(xt,this),this.isTreeLayoutViewVisible=this.viewletState["view.treeLayout"]??this.searchConfig.defaultViewMode===kt.Tree,this._refreshResultsScheduler=this._register(new ve(this._updateResults.bind(this),80)),this._register(this.storageService.onWillSaveState(()=>{this._saveSearchHistoryService()})),this._register(this.storageService.onDidChangeValue(re.WORKSPACE,Wt.SEARCH_HISTORY_KEY,this._register(new ee))(()=>{const v=this.searchHistoryService.load();v.include&&this.inputPatternIncludes.prependHistory(v.include),v.exclude&&this.inputPatternExcludes.prependHistory(v.exclude),v.search&&this.searchWidget.prependSearchHistory(v.search),v.replace&&this.searchWidget.prependReplaceHistory(v.replace)})),this.changedWhileHidden=this.hasSearchResults()}static ACTIONS_RIGHT_CLASS_NAME="actions-right";isDisposed=!1;container;queryBuilder;viewModel;memento;viewletVisible;inputBoxFocused;inputPatternIncludesFocused;inputPatternExclusionsFocused;firstMatchFocused;fileMatchOrMatchFocused;fileMatchOrFolderMatchFocus;fileMatchOrFolderMatchWithResourceFocus;fileMatchFocused;folderMatchFocused;folderMatchWithResourceFocused;matchFocused;isEditableItem;hasSearchResultsKey;lastFocusState="input";searchStateKey;hasSearchPatternKey;hasReplacePatternKey;hasFilePatternKey;hasSomeCollapsibleResultKey;tree;treeLabels;viewletState;messagesElement;messageDisposables=new ee;searchWidgetsContainerElement;searchWidget;size;queryDetails;toggleQueryDetailsButton;inputPatternExcludes;inputPatternIncludes;resultsElement;currentSelectedFileMatch;delayedRefresh;changedWhileHidden;searchWithoutFolderMessageElement;currentSearchQ=Promise.resolve();addToSearchHistoryDelayer;toggleCollapseStateDelayer;triggerQueryDelayer;pauseSearching=!1;treeAccessibilityProvider;treeViewKey;aiResultsVisibleKey;_visibleMatches=0;_refreshResultsScheduler;_onSearchResultChangedDisposable;_stashedQueryDetailsVisibility=void 0;_stashedReplaceVisibility=void 0;get isTreeLayoutViewVisible(){return this.treeViewKey.get()??!1}set isTreeLayoutViewVisible(e){this.treeViewKey.set(e)}get aiResultsVisible(){return this.aiResultsVisibleKey.get()??!1}set aiResultsVisible(e){this.aiResultsVisibleKey.set(e)}setTreeView(e){e!==this.isTreeLayoutViewVisible&&(this.isTreeLayoutViewVisible=e,this.updateIndentStyles(this.themeService.getFileIconTheme()),this.refreshTree())}async setAIResultsVisible(e){e!==this.aiResultsVisible&&(e?(this._stashedQueryDetailsVisibility=this._queryDetailsHidden(),this._stashedReplaceVisibility=this.searchWidget.isReplaceShown(),this.searchWidget.toggleReplace(!1),this.toggleQueryDetailsButton.style.display="none",this.searchWidget.replaceButtonVisibility=!1,this.toggleQueryDetails(void 0,!1)):(this.toggleQueryDetailsButton.style.display="",this.searchWidget.replaceButtonVisibility=!0,this._stashedReplaceVisibility&&this.searchWidget.toggleReplace(this._stashedReplaceVisibility),this._stashedQueryDetailsVisibility&&this.toggleQueryDetails(void 0,this._stashedQueryDetailsVisibility)),this.aiResultsVisible=e,!this.viewModel.searchResult.isEmpty()&&(this.model.cancelAISearch(),e&&await this.model.addAIResults(),this.onSearchResultsChanged(),this.onSearchComplete(()=>{},void 0,void 0,this.viewModel.searchResult.getCachedSearchComplete(e))))}get state(){return this.searchStateKey.get()??T.Idle}set state(e){this.searchStateKey.set(e)}getContainer(){return this.container}get searchResult(){return this.viewModel&&this.viewModel.searchResult}get model(){return this.viewModel}refreshHasAISetting(){const e=this.shouldShowAIButton();e&&this.searchWidget.searchInput&&(this.searchWidget.searchInput.sparkleVisible=e)}onDidChangeWorkbenchState(){this.contextService.getWorkbenchState()!==H.EMPTY&&this.searchWithoutFolderMessageElement&&a.hide(this.searchWithoutFolderMessageElement)}refreshInputs(){this.pauseSearching=!0,this.searchWidget.setValue(this.viewModel.searchResult.query?.contentPattern.pattern??""),this.searchWidget.setReplaceAllActionState(!1),this.searchWidget.toggleReplace(!0),this.inputPatternIncludes.setOnlySearchInOpenEditors(this.viewModel.searchResult.query?.onlyOpenEditors||!1),this.inputPatternExcludes.setUseExcludesAndIgnoreFiles(!this.viewModel.searchResult.query?.userDisabledExcludesAndIgnoreFiles||!0),this.searchIncludePattern.setValue(""),this.searchExcludePattern.setValue(""),this.pauseSearching=!1}async replaceSearchModel(e,t){let i;this.progressService.withProgress({location:this.getProgressLocation(),delay:0},o=>new Promise(c=>i=c));const r=setTimeout(()=>{this.state=T.SlowSearch},2e3);if(this._refreshResultsScheduler.schedule(),e.location=yt.PANEL,e.replaceActive=this.viewModel.isReplaceActive(),e.replaceString=this.searchWidget.getReplaceValue(),this._onSearchResultChangedDisposable?.dispose(),this._onSearchResultChangedDisposable=this._register(e.onSearchResultChanged(o=>this.onSearchResultsChanged(o))),this.searchViewModelWorkbenchService.searchModel=e,this.viewModel=e,this.onSearchResultsChanged(),this.refreshInputs(),t.then(o=>{clearTimeout(r),this.onSearchComplete(i,void 0,void 0,o)},o=>{clearTimeout(r),this.onSearchError(o,i,void 0,void 0)}),this.searchConfig.collapseResults!=="alwaysCollapse"&&this.viewModel.searchResult.matches(this.aiResultsVisible).length===1){const o=this.viewModel.searchResult.matches(this.aiResultsVisible)[0];o.count()<50&&this.tree.expand(o)}}renderBody(e){super.renderBody(e),this.container=a.append(e,a.$(".search-view")),this.searchWidgetsContainerElement=a.append(this.container,b(".search-widgets-container")),this.createSearchWidget(this.searchWidgetsContainerElement),this.refreshHasAISetting();const t=this.searchHistoryService.load(),i=this.viewletState["query.filePatterns"]||"",r=this.viewletState["query.folderExclusions"]||"",s=t.exclude||[],o=this.viewletState["query.folderIncludes"]||"",c=t.include||[],h=this.viewletState["query.onlyOpenEditors"]||!1,l=this.viewletState["query.queryDetailsExpanded"]||"",f=typeof this.viewletState["query.useExcludesAndIgnoreFiles"]=="boolean"?this.viewletState["query.useExcludesAndIgnoreFiles"]:!0;this.queryDetails=a.append(this.searchWidgetsContainerElement,b(".query-details"));const u=n.localize("moreSearch","Toggle Search Details");this.toggleQueryDetailsButton=a.append(this.queryDetails,b(".more"+Ce.asCSSSelector(vt),{tabindex:0,role:"button","aria-label":u})),this._register(this.hoverService.setupManagedHover(ie("element"),this.toggleQueryDetailsButton,u)),this._register(a.addDisposableListener(this.toggleQueryDetailsButton,a.EventType.CLICK,p=>{a.EventHelper.stop(p),this.toggleQueryDetails(!this.accessibilityService.isScreenReaderOptimized())})),this._register(a.addDisposableListener(this.toggleQueryDetailsButton,a.EventType.KEY_UP,p=>{const w=new z(p);(w.equals(V.Enter)||w.equals(V.Space))&&(a.EventHelper.stop(p),this.toggleQueryDetails(!1))})),this._register(a.addDisposableListener(this.toggleQueryDetailsButton,a.EventType.KEY_DOWN,p=>{new z(p).equals(Se.Shift|V.Tab)&&(this.searchWidget.isReplaceActive()?this.searchWidget.focusReplaceAllAction():this.searchWidget.isReplaceShown()?this.searchWidget.replaceInput?.focusOnPreserve():this.searchWidget.focusRegexAction(),a.EventHelper.stop(p))}));const S=a.append(this.queryDetails,b(".file-types.includes")),x=n.localize("searchScope.includes","files to include");a.append(S,b("h4",void 0,x)),this.inputPatternIncludes=this._register(this.instantiationService.createInstance(pt,S,this.contextViewService,{ariaLabel:x,placeholder:n.localize("placeholder.includes","e.g. *.ts, src/**/include"),showPlaceholderOnFocus:!0,history:c,inputBoxStyles:j})),this.inputPatternIncludes.setValue(o),this.inputPatternIncludes.setOnlySearchInOpenEditors(h),this._register(this.inputPatternIncludes.onCancel(()=>this.cancelSearch(!1))),this._register(this.inputPatternIncludes.onChangeSearchInEditorsBox(()=>this.triggerQueryChange())),this.trackInputBox(this.inputPatternIncludes.inputFocusTracker,this.inputPatternIncludesFocused);const E=a.append(this.queryDetails,b(".file-types.excludes")),I=n.localize("searchScope.excludes","files to exclude");a.append(E,b("h4",void 0,I)),this.inputPatternExcludes=this._register(this.instantiationService.createInstance(dt,E,this.contextViewService,{ariaLabel:I,placeholder:n.localize("placeholder.excludes","e.g. *.ts, src/**/exclude"),showPlaceholderOnFocus:!0,history:s,inputBoxStyles:j})),this.inputPatternExcludes.setValue(r),this.inputPatternExcludes.setUseExcludesAndIgnoreFiles(f),this._register(this.inputPatternExcludes.onCancel(()=>this.cancelSearch(!1))),this._register(this.inputPatternExcludes.onChangeIgnoreBox(()=>this.triggerQueryChange())),this.trackInputBox(this.inputPatternExcludes.inputFocusTracker,this.inputPatternExclusionsFocused);const R=()=>this.hasFilePatternKey.set(this.inputPatternIncludes.getValue().length>0||this.inputPatternExcludes.getValue().length>0);R();const F=p=>{this.triggerQueryChange({triggeredOnType:p,delay:this.searchConfig.searchOnTypeDebouncePeriod}),p&&R()};this._register(this.inputPatternIncludes.onSubmit(F)),this._register(this.inputPatternExcludes.onSubmit(F)),this.messagesElement=a.append(this.container,b(".messages.text-search-provider-messages")),this.contextService.getWorkbenchState()===H.EMPTY&&this.showSearchWithoutFolderMessage(),this.createSearchResultsView(this.container),(i!==""||r!==""||o!==""||l!==""||!f)&&this.toggleQueryDetails(!0,!0,!0),this._onSearchResultChangedDisposable=this._register(this.viewModel.onSearchResultChanged(p=>this.onSearchResultsChanged(p))),this._register(this.onDidChangeBodyVisibility(p=>this.onVisibilityChanged(p))),this.updateIndentStyles(this.themeService.getFileIconTheme()),this._register(this.themeService.onDidFileIconThemeChange(this.updateIndentStyles,this))}updateIndentStyles(e){this.resultsElement.classList.toggle("hide-arrows",this.isTreeLayoutViewVisible&&e.hidesExplorerArrows)}onVisibilityChanged(e){this.viewletVisible.set(e),e?this.changedWhileHidden&&(this.refreshAndUpdateCount(),this.changedWhileHidden=!1):this.lastFocusState="input",this.viewModel?.searchResult.toggleHighlights(e)}get searchAndReplaceWidget(){return this.searchWidget}get searchIncludePattern(){return this.inputPatternIncludes}get searchExcludePattern(){return this.inputPatternExcludes}createSearchWidget(e){const t=this.viewletState["query.contentPattern"]||"",i=this.viewletState["query.replaceText"]||"",r=this.viewletState["query.regex"]===!0,s=this.viewletState["query.wholeWords"]===!0,o=this.viewletState["query.caseSensitive"]===!0,c=this.searchHistoryService.load(),h=c.search||this.viewletState["query.searchHistory"]||[],l=c.replace||this.viewletState["query.replaceHistory"]||[],f=typeof this.viewletState["view.showReplace"]=="boolean"?this.viewletState["view.showReplace"]:!0,u=this.viewletState["query.preserveCase"]===!0,S=this.viewletState["query.isInNotebookMarkdownInput"]??!0,x=this.viewletState["query.isInNotebookMarkdownPreview"]??!0,E=this.viewletState["query.isInNotebookCellInput"]??!0,I=this.viewletState["query.isInNotebookCellOutput"]??!0;if(this.searchWidget=this._register(this.instantiationService.createInstance(Rt,e,{value:t,replaceValue:i,isRegex:r,isCaseSensitive:o,isWholeWords:s,searchHistory:h,replaceHistory:l,preserveCase:u,inputBoxStyles:j,toggleStyles:et,notebookOptions:{isInNotebookMarkdownInput:S,isInNotebookMarkdownPreview:x,isInNotebookCellInput:E,isInNotebookCellOutput:I},initialAIButtonVisibility:this.shouldShowAIButton()})),!this.searchWidget.searchInput||!this.searchWidget.replaceInput){this.logService.warn(`Cannot fully create search widget. Search or replace input undefined. SearchInput: ${this.searchWidget.searchInput}, ReplaceInput: ${this.searchWidget.replaceInput}`);return}f&&this.searchWidget.toggleReplace(!0),this._register(this.searchWidget.onSearchSubmit(p=>this.triggerQueryChange(p))),this._register(this.searchWidget.onSearchCancel(({focus:p})=>this.cancelSearch(p))),this._register(this.searchWidget.searchInput.onDidOptionChange(()=>{this.searchWidget.searchInput&&this.searchWidget.searchInput.isAIEnabled!==this.aiResultsVisible?this.setAIResultsVisible(this.searchWidget.searchInput.isAIEnabled):this.triggerQueryChange()})),this._register(this.searchWidget.getNotebookFilters().onDidChange(()=>this.triggerQueryChange()));const R=()=>this.hasSearchPatternKey.set(this.searchWidget.searchInput?this.searchWidget.searchInput.getValue().length>0:!1);R(),this._register(this.searchWidget.searchInput.onDidChange(()=>R()));const F=()=>this.hasReplacePatternKey.set(this.searchWidget.getReplaceValue().length>0);F(),this._register(this.searchWidget.replaceInput.inputBox.onDidChange(()=>F())),this._register(this.searchWidget.onDidHeightChange(()=>this.reLayout())),this._register(this.searchWidget.onReplaceToggled(()=>this.reLayout())),this._register(this.searchWidget.onReplaceStateChange(p=>{this.viewModel.replaceActive=p,this.refreshTree()})),this._register(this.searchWidget.onPreserveCaseChange(p=>{this.viewModel.preserveCase=p,this.refreshTree()})),this._register(this.searchWidget.onReplaceValueChanged(()=>{this.viewModel.replaceString=this.searchWidget.getReplaceValue(),this.delayedRefresh.trigger(()=>this.refreshTree())})),this._register(this.searchWidget.onBlur(()=>{this.toggleQueryDetailsButton.focus()})),this._register(this.searchWidget.onReplaceAll(()=>this.replaceAll())),this.trackInputBox(this.searchWidget.searchInputFocusTracker),this.trackInputBox(this.searchWidget.replaceInputFocusTracker)}shouldShowAIButton(){const e=g.SearchContext.hasAIResultProvider.getValue(this.contextKeyService);return!!(this.configurationService.getValue("search.aiResults")&&e)}onConfigurationUpdated(e){e&&(e.affectsConfiguration("search.decorations.colors")||e.affectsConfiguration("search.decorations.badges"))&&this.refreshTree()}trackInputBox(e,t){e&&(this._register(e.onDidFocus(()=>{this.lastFocusState="input",this.inputBoxFocused.set(!0),t?.set(!0)})),this._register(e.onDidBlur(()=>{this.inputBoxFocused.set(this.searchWidget.searchInputHasFocus()||this.searchWidget.replaceInputHasFocus()||this.inputPatternIncludes.inputHasFocus()||this.inputPatternExcludes.inputHasFocus()),t?.set(!1)})))}onSearchResultsChanged(e){if(this.isVisible())return this.refreshAndUpdateCount(e);this.changedWhileHidden=!0}refreshAndUpdateCount(e){return this.searchWidget.setReplaceAllActionState(!this.viewModel.searchResult.isEmpty(this.aiResultsVisible)),this.updateSearchResultCount(this.viewModel.searchResult.query.userDisabledExcludesAndIgnoreFiles,this.viewModel.searchResult.query?.onlyOpenEditors,e?.clearingAll),this.refreshTree(e)}refreshTree(e){const t=this.searchConfig.collapseResults;!e||e.added||e.removed?this.searchConfig.sortOrder===D.Modified?this.retrieveFileStats().then(()=>this.tree.setChildren(null,this.createResultIterator(t))):this.tree.setChildren(null,this.createResultIterator(t)):this.searchConfig.sortOrder===D.CountAscending||this.searchConfig.sortOrder===D.CountDescending?this.tree.setChildren(null,this.createResultIterator(t)):e.elements.forEach(i=>{this.tree.setChildren(i,this.createIterator(i,t)),this.tree.rerender(i)})}createResultIterator(e){const t=this.searchResult.folderMatches(this.aiResultsVisible).filter(i=>!i.isEmpty()).sort(G);return t.length===1?this.createFolderIterator(t[0],e,!0):U.map(t,i=>{const r=this.createFolderIterator(i,e,!0);return{element:i,children:r,incompressible:!0}})}createFolderIterator(e,t,i){const r=this.searchConfig.sortOrder,o=(this.isTreeLayoutViewVisible?e.matches():e.allDownstreamFileMatches()).sort((c,h)=>G(c,h,r));return U.map(o,c=>{let h;c instanceof M?h=this.createFileIterator(c):h=this.createFolderIterator(c,t,!1);const l=t==="alwaysCollapse"||c.count()>10&&t!=="alwaysExpand"?Z.PreserveOrCollapsed:Z.PreserveOrExpanded;return{element:c,children:h,collapsed:l,incompressible:c instanceof M?!0:i}})}createFileIterator(e){let t=e.matches().sort(G);return this.aiResultsVisible||(t=t.filter(i=>!i.aiContributed)),U.map(t,i=>({element:i,incompressible:!0}))}createIterator(e,t){return e instanceof It?this.createResultIterator(t):e instanceof Q?this.createFolderIterator(e,t,!1):this.createFileIterator(e)}replaceAll(){if(this.viewModel.searchResult.count()===0)return;const e=this.viewModel.searchResult.count(),t=this.viewModel.searchResult.fileCount(),i=this.searchWidget.getReplaceValue()||"",r=this.buildAfterReplaceAllMessage(e,t,i);let s,o;this.progressService.withProgress({location:this.getProgressLocation(),delay:100,total:e},h=>(o=h,new Promise(l=>s=l)));const c={title:n.localize("replaceAll.confirmation.title","Replace All"),message:this.buildReplaceAllConfirmationMessage(e,t,i),primaryButton:n.localize({key:"replaceAll.confirm.button",comment:["&& denotes a mnemonic"]},"&&Replace")};this.dialogService.confirm(c).then(h=>{h.confirmed?(this.searchWidget.setReplaceAllActionState(!1),this.viewModel.searchResult.replaceAll(o).then(()=>{s();const l=this.clearMessage();a.append(l,r),this.reLayout()},l=>{s(),A.isCancellationError(l),this.notificationService.error(l)})):s()})}buildAfterReplaceAllMessage(e,t,i){return e===1?t===1?i?n.localize("replaceAll.occurrence.file.message","Replaced {0} occurrence across {1} file with '{2}'.",e,t,i):n.localize("removeAll.occurrence.file.message","Replaced {0} occurrence across {1} file.",e,t):i?n.localize("replaceAll.occurrence.files.message","Replaced {0} occurrence across {1} files with '{2}'.",e,t,i):n.localize("removeAll.occurrence.files.message","Replaced {0} occurrence across {1} files.",e,t):t===1?i?n.localize("replaceAll.occurrences.file.message","Replaced {0} occurrences across {1} file with '{2}'.",e,t,i):n.localize("removeAll.occurrences.file.message","Replaced {0} occurrences across {1} file.",e,t):i?n.localize("replaceAll.occurrences.files.message","Replaced {0} occurrences across {1} files with '{2}'.",e,t,i):n.localize("removeAll.occurrences.files.message","Replaced {0} occurrences across {1} files.",e,t)}buildReplaceAllConfirmationMessage(e,t,i){return e===1?t===1?i?n.localize("removeAll.occurrence.file.confirmation.message","Replace {0} occurrence across {1} file with '{2}'?",e,t,i):n.localize("replaceAll.occurrence.file.confirmation.message","Replace {0} occurrence across {1} file?",e,t):i?n.localize("removeAll.occurrence.files.confirmation.message","Replace {0} occurrence across {1} files with '{2}'?",e,t,i):n.localize("replaceAll.occurrence.files.confirmation.message","Replace {0} occurrence across {1} files?",e,t):t===1?i?n.localize("removeAll.occurrences.file.confirmation.message","Replace {0} occurrences across {1} file with '{2}'?",e,t,i):n.localize("replaceAll.occurrences.file.confirmation.message","Replace {0} occurrences across {1} file?",e,t):i?n.localize("removeAll.occurrences.files.confirmation.message","Replace {0} occurrences across {1} files with '{2}'?",e,t,i):n.localize("replaceAll.occurrences.files.confirmation.message","Replace {0} occurrences across {1} files?",e,t)}clearMessage(){this.searchWithoutFolderMessageElement=void 0;const e=this.messagesElement.style.display==="none";a.clearNode(this.messagesElement),a.show(this.messagesElement),this.messageDisposables.clear();const t=a.append(this.messagesElement,b(".message"));return e&&this.reLayout(),t}createSearchResultsView(e){this.resultsElement=a.append(e,b(".results.show-file-icons.file-icon-themable-tree"));const t=this.instantiationService.createInstance(ae),i={getId(s){return s.id()}};this.treeLabels=this._register(this.instantiationService.createInstance(at,{onDidChangeVisibility:this.onDidChangeBodyVisibility})),this.tree=this._register(this.instantiationService.createInstance(qe,"SearchView",this.resultsElement,t,[this._register(this.instantiationService.createInstance(Ct,this,this.treeLabels)),this._register(this.instantiationService.createInstance(bt,this,this.treeLabels)),this._register(this.instantiationService.createInstance(Et,this))],{identityProvider:i,accessibilityProvider:this.treeAccessibilityProvider,dnd:this.instantiationService.createInstance(ot,s=>s instanceof M?s.resource:s instanceof m?Ge(s.parent().resource,s.range()):null),multipleSelectionSupport:!0,selectionNavigation:!0,overrideStyles:this.getLocationBasedColors().listOverrideStyles,paddingBottom:ae.ITEM_HEIGHT})),this._register(this.tree.onContextMenu(s=>this.onContextMenu(s)));const r=()=>this.toggleCollapseStateDelayer.trigger(()=>this.hasSomeCollapsibleResultKey.set(this.hasSomeCollapsible()));r(),this._register(this.tree.onDidChangeCollapseState(()=>r())),this._register(this.tree.onDidChangeModel(()=>r())),this._register(q.debounce(this.tree.onDidOpen,(s,o)=>o,ce,!0)(s=>{if(s.element instanceof m){const o=s.element;this.currentSelectedFileMatch?.setSelectedMatch(null),this.currentSelectedFileMatch=o.parent(),this.currentSelectedFileMatch.setSelectedMatch(o),this.onFocus(o,s.editorOptions.preserveFocus,s.sideBySide,s.editorOptions.pinned)}})),this._register(q.debounce(this.tree.onDidChangeFocus,(s,o)=>o,ce,!0)(()=>{const s=this.tree.getSelection(),o=this.tree.getFocus()[0];s.length>1&&o instanceof m&&this.onFocus(o,!0)})),this._register(q.any(this.tree.onDidFocus,this.tree.onDidChangeFocus)(()=>{const s=this.tree.getFocus()[0];this.tree.isDOMFocused()&&(this.firstMatchFocused.set(this.tree.navigate().first()===s),this.fileMatchOrMatchFocused.set(!!s),this.fileMatchFocused.set(s instanceof M),this.folderMatchFocused.set(s instanceof Q),this.matchFocused.set(s instanceof m),this.fileMatchOrFolderMatchFocus.set(s instanceof M||s instanceof Q),this.fileMatchOrFolderMatchWithResourceFocus.set(s instanceof M||s instanceof oe),this.folderMatchWithResourceFocused.set(s instanceof oe),this.lastFocusState="tree");let o=!1;s instanceof m?o=s instanceof B?!s.isReadonly():!0:(s instanceof M||s instanceof Q)&&(o=!s.hasOnlyReadOnlyMatches()),this.isEditableItem.set(o)})),this._register(this.tree.onDidBlur(()=>{this.firstMatchFocused.reset(),this.fileMatchOrMatchFocused.reset(),this.fileMatchFocused.reset(),this.folderMatchFocused.reset(),this.matchFocused.reset(),this.fileMatchOrFolderMatchFocus.reset(),this.fileMatchOrFolderMatchWithResourceFocus.reset(),this.folderMatchWithResourceFocused.reset(),this.isEditableItem.reset()}))}onContextMenu(e){e.browserEvent.preventDefault(),e.browserEvent.stopPropagation(),this.contextMenuService.showContextMenu({menuId:Oe.SearchContext,menuActionOptions:{shouldForwardArgs:!0},contextKeyService:this.contextKeyService,getAnchor:()=>e.anchor,getActionsContext:()=>e.element})}hasSomeCollapsible(){const e=this.getControl(),t=e.navigate();let i=t.first();do if(!e.isCollapsed(i))return!0;while(i=t.next());return!1}selectNextMatch(){if(!this.hasSearchResults())return;const[e]=this.tree.getSelection();e&&!(e instanceof m)&&this.tree.isCollapsed(e)&&this.tree.expand(e);const t=this.tree.navigate(e);let i=t.next();for(i||(i=t.first());i&&!(i instanceof m);)this.tree.isCollapsed(i)&&this.tree.expand(i),i=t.next();if(i){i===e&&this.tree.setFocus([]);const r=N(void 0,!1,!1);this.tree.setFocus([i],r),this.tree.setSelection([i],r),this.tree.reveal(i);const s=this.treeAccessibilityProvider.getAriaLabel(i);s&&k.status(s)}}selectPreviousMatch(){if(!this.hasSearchResults())return;const[e]=this.tree.getSelection();let t=this.tree.navigate(e),i=t.previous();for(;!i||!(i instanceof m)&&!this.tree.isCollapsed(i);){const r=i?t.previous():t.last();if(!i&&!r)return;i=r}for(;!(i instanceof m);){const r=t.next();this.tree.expand(i),t=this.tree.navigate(r),i=r?t.previous():t.last()}if(i){i===e&&this.tree.setFocus([]);const r=N(void 0,!1,!1);this.tree.setFocus([i],r),this.tree.setSelection([i],r),this.tree.reveal(i);const s=this.treeAccessibilityProvider.getAriaLabel(i);s&&k.status(s)}}moveFocusToResults(){this.tree.domFocus()}focus(){if(super.focus(),this.lastFocusState==="input"||!this.hasSearchResults()){const e=this.searchConfig.seedOnFocus?this.updateTextFromSelection({allowSearchOnType:!1}):!1;this.searchWidget.focus(void 0,void 0,e)}else this.tree.domFocus()}updateTextFromFindWidgetOrSelection({allowUnselectedWord:e=!0,allowSearchOnType:t=!0}){let i=this.editorService.activeTextEditorControl;if(Y(i)&&!i?.hasTextFocus()){const r=we.get(i);if(r&&r.isFindInputFocused())return this.updateTextFromFindWidget(r,{allowSearchOnType:t});i=this.codeEditorService.listCodeEditors().find(o=>o instanceof Me&&o.getParentEditor()===i&&o.hasTextFocus())??i}return this.updateTextFromSelection({allowUnselectedWord:e,allowSearchOnType:t},i)}updateTextFromFindWidget(e,{allowSearchOnType:t=!0}){if(!this.searchConfig.seedWithNearestWord&&(a.getActiveWindow().getSelection()?.toString()??"")==="")return!1;const i=e.getState().searchString;return i===""?!1:(this.searchWidget.searchInput?.setCaseSensitive(e.getState().matchCase),this.searchWidget.searchInput?.setWholeWords(e.getState().wholeWord),this.searchWidget.searchInput?.setRegex(e.getState().isRegex),this.updateText(i,t),!0)}updateTextFromSelection({allowUnselectedWord:e=!0,allowSearchOnType:t=!0},i){const r=this.configurationService.getValue("editor").find.seedSearchStringFromSelection;if(!r||r==="never")return!1;let s=this.getSearchTextFromEditor(e,i);return s===null?!1:(this.searchWidget.searchInput?.getRegex()&&(s=Ie.escapeRegExpCharacters(s)),this.updateText(s,t),!0)}updateText(e,t=!0){t&&!this.viewModel.searchResult.isDirty?this.searchWidget.setValue(e):(this.pauseSearching=!0,this.searchWidget.setValue(e),this.pauseSearching=!1)}focusNextInputBox(){if(this.searchWidget.searchInputHasFocus()){this.searchWidget.isReplaceShown()?this.searchWidget.focus(!0,!0):this.moveFocusFromSearchOrReplace();return}if(this.searchWidget.replaceInputHasFocus()){this.moveFocusFromSearchOrReplace();return}if(this.inputPatternIncludes.inputHasFocus()){this.inputPatternExcludes.focus(),this.inputPatternExcludes.select();return}if(this.inputPatternExcludes.inputHasFocus()){this.selectTreeIfNotSelected();return}}moveFocusFromSearchOrReplace(){this.showsFileTypes()?this.toggleQueryDetails(!0,this.showsFileTypes()):this.selectTreeIfNotSelected()}focusPreviousInputBox(){if(!this.searchWidget.searchInputHasFocus()){if(this.searchWidget.replaceInputHasFocus()){this.searchWidget.focus(!0);return}if(this.inputPatternIncludes.inputHasFocus()){this.searchWidget.focus(!0,!0);return}if(this.inputPatternExcludes.inputHasFocus()){this.inputPatternIncludes.focus(),this.inputPatternIncludes.select();return}if(this.tree.isDOMFocused()){this.moveFocusFromResults();return}}}moveFocusFromResults(){this.showsFileTypes()?this.toggleQueryDetails(!0,!0,!1,!0):this.searchWidget.focus(!0,!0)}reLayout(){if(this.isDisposed||!this.size)return;const e=this.searchConfig.actionsPosition;this.getContainer().classList.toggle(O.ACTIONS_RIGHT_CLASS_NAME,e==="right"),this.searchWidget.setWidth(this.size.width-28),this.inputPatternExcludes.setWidth(this.size.width-28),this.inputPatternIncludes.setWidth(this.size.width-28);const t=a.getTotalHeight(this.searchWidgetsContainerElement),i=a.getTotalHeight(this.messagesElement);this.tree.layout(this.size.height-t-i,this.size.width-28)}layoutBody(e,t){super.layoutBody(e,t),this.size=new a.Dimension(t,e),this.reLayout()}getControl(){return this.tree}allSearchFieldsClear(){return this.searchWidget.getReplaceValue()===""&&(!this.searchWidget.searchInput||this.searchWidget.searchInput.getValue()==="")}allFilePatternFieldsClear(){return this.searchExcludePattern.getValue()===""&&this.searchIncludePattern.getValue()===""}hasSearchResults(){return!this.viewModel.searchResult.isEmpty(this.aiResultsVisible)}clearSearchResults(e=!0){this.viewModel.searchResult.clear(),this.showEmptyStage(!0),this.contextService.getWorkbenchState()===H.EMPTY&&this.showSearchWithoutFolderMessage(),e&&(this.allSearchFieldsClear()&&this.clearFilePatternFields(),this.searchWidget.clear()),this.viewModel.cancelSearch(),this.tree.ariaLabel=n.localize("emptySearch","Empty Search"),this.accessibilitySignalService.playSignal(Te.clear),this.reLayout()}clearFilePatternFields(){this.searchExcludePattern.clear(),this.searchIncludePattern.clear()}cancelSearch(e=!0){return this.viewModel.cancelSearch()?(e&&this.searchWidget.focus(),!0):!1}selectTreeIfNotSelected(){if(this.tree.getNode(null)&&(this.tree.domFocus(),this.tree.getSelection().length===0)){const t=N();this.tree.focusNext(void 0,void 0,t),this.tree.setSelection(this.tree.getFocus(),t)}}getSearchTextFromEditor(e,t){if(a.isAncestorOfActiveElement(this.getContainer())||(t=t??this.editorService.activeTextEditorControl,!t))return null;const i=this.searchConfig.seedWithNearestWord&&e;return Bt(i,t)}showsFileTypes(){return this.queryDetails.classList.contains("more")}toggleCaseSensitive(){this.searchWidget.searchInput?.setCaseSensitive(!this.searchWidget.searchInput.getCaseSensitive()),this.triggerQueryChange()}toggleWholeWords(){this.searchWidget.searchInput?.setWholeWords(!this.searchWidget.searchInput.getWholeWords()),this.triggerQueryChange()}toggleRegex(){this.searchWidget.searchInput?.setRegex(!this.searchWidget.searchInput.getRegex()),this.triggerQueryChange()}togglePreserveCase(){this.searchWidget.replaceInput?.setPreserveCase(!this.searchWidget.replaceInput.getPreserveCase()),this.triggerQueryChange()}setSearchParameters(e={}){typeof e.isCaseSensitive=="boolean"&&this.searchWidget.searchInput?.setCaseSensitive(e.isCaseSensitive),typeof e.matchWholeWord=="boolean"&&this.searchWidget.searchInput?.setWholeWords(e.matchWholeWord),typeof e.isRegex=="boolean"&&this.searchWidget.searchInput?.setRegex(e.isRegex),typeof e.filesToInclude=="string"&&this.searchIncludePattern.setValue(String(e.filesToInclude)),typeof e.filesToExclude=="string"&&this.searchExcludePattern.setValue(String(e.filesToExclude)),typeof e.query=="string"&&this.searchWidget.searchInput?.setValue(e.query),typeof e.replace=="string"?this.searchWidget.replaceInput?.setValue(e.replace):this.searchWidget.replaceInput&&this.searchWidget.replaceInput.getValue()!==""&&this.searchWidget.replaceInput.setValue(""),typeof e.triggerSearch=="boolean"&&e.triggerSearch&&this.triggerQueryChange(),typeof e.preserveCase=="boolean"&&this.searchWidget.replaceInput?.setPreserveCase(e.preserveCase),typeof e.useExcludeSettingsAndIgnoreFiles=="boolean"&&this.inputPatternExcludes.setUseExcludesAndIgnoreFiles(e.useExcludeSettingsAndIgnoreFiles),typeof e.onlyOpenEditors=="boolean"&&this.searchIncludePattern.setOnlySearchInOpenEditors(e.onlyOpenEditors)}toggleQueryDetails(e=!0,t,i,r){const s="more";t=typeof t>"u"?!this.queryDetails.classList.contains(s):!!t,this.viewletState["query.queryDetailsExpanded"]=t,i=!!i,t?(this.toggleQueryDetailsButton.setAttribute("aria-expanded","true"),this.queryDetails.classList.add(s),e&&(r?(this.inputPatternExcludes.focus(),this.inputPatternExcludes.select()):(this.inputPatternIncludes.focus(),this.inputPatternIncludes.select()))):(this.toggleQueryDetailsButton.setAttribute("aria-expanded","false"),this.queryDetails.classList.remove(s),e&&this.searchWidget.focus()),!i&&this.size&&this.reLayout()}_queryDetailsHidden(){return this.queryDetails.classList.contains("more")}searchInFolders(e=[]){this._searchWithIncludeOrExclude(!0,e)}searchOutsideOfFolders(e=[]){this._searchWithIncludeOrExclude(!1,e)}_searchWithIncludeOrExclude(e,t){if(!t.length||t.some(i=>i===".")){this.inputPatternIncludes.setValue(""),this.searchWidget.focus();return}this.showsFileTypes()||this.toggleQueryDetails(!0,!0),(e?this.inputPatternIncludes:this.inputPatternExcludes).setValue(t.join(", ")),this.searchWidget.focus(!1)}triggerQueryChange(e){const t={preserveFocus:!0,triggeredOnType:!1,delay:0,...e};if(!(t.triggeredOnType&&!this.searchConfig.searchOnType)&&!this.pauseSearching){const i=t.triggeredOnType?t.delay:0;this.triggerQueryDelayer.trigger(()=>{this._onQueryChanged(t.preserveFocus,t.triggeredOnType)},i)}}_onQueryChanged(e,t=!1){if(!this.searchWidget.searchInput?.inputBox.isInputValid())return;const i=this.searchWidget.searchInput.getRegex(),r=this.searchWidget.getNotebookFilters().markupInput,s=this.searchWidget.getNotebookFilters().markupPreview,o=this.searchWidget.getNotebookFilters().codeInput,c=this.searchWidget.getNotebookFilters().codeOutput,h=this.searchWidget.searchInput.getWholeWords(),l=this.searchWidget.searchInput.getCaseSensitive(),f=this.searchWidget.searchInput.getValue(),u=this.inputPatternExcludes.getValue().trim(),S=this.inputPatternIncludes.getValue().trim(),x=this.inputPatternExcludes.useExcludesAndIgnoreFiles(),E=this.inputPatternIncludes.onlySearchInOpenEditors();if(f.length===0){this.clearSearchResults(!1),this.clearMessage();return}const I={pattern:f,isRegExp:i,isCaseSensitive:l,isWordMatch:h,notebookInfo:{isInNotebookMarkdownInput:r,isInNotebookMarkdownPreview:s,isInNotebookCellInput:o,isInNotebookCellOutput:c}},R=[{pattern:this.inputPatternExcludes.getValue()}],F=this.inputPatternIncludes.getValue(),p=I.isRegExp?1e4:1e3,w={_reason:"searchView",extraFileResources:this.instantiationService.invokeFunction(Mt),maxResults:this.searchConfig.maxResults??void 0,disregardIgnoreFiles:!x||void 0,disregardExcludeSettings:!x||void 0,onlyOpenEditors:E,excludePattern:R,includePattern:F,previewOptions:{matchLines:1,charsPerLine:p},isSmartCase:this.searchConfig.smartCase,expandPatterns:!0},$=this.contextService.getWorkspace().folders,K=P=>{this.searchWidget.searchInput?.showMessage({content:P.message,type:X.ERROR}),this.viewModel.searchResult.clear()};let _;try{_=this.queryBuilder.text(I,$.map(P=>P.uri),w)}catch(P){K(P);return}this.validateQuery(_).then(()=>{this.onQueryTriggered(_,w,u,S,t),e||this.searchWidget.focus(!1,void 0,!0)},K)}validateQuery(e){const t=e.folderQueries.map(i=>this.fileService.exists(i.folder).catch(()=>!1));return Promise.all(t).then(i=>{const r=e.folderQueries.filter((s,o)=>i[o]);if(!e.folderQueries.length||r.length)e.folderQueries=r;else{const s=e.folderQueries[0].folder.fsPath,o=n.localize("searchPathNotFoundError","Search path not found: {0}",s);return Promise.reject(new Error(o))}})}onQueryTriggered(e,t,i,r,s){this.addToSearchHistoryDelayer.trigger(()=>{this.searchWidget.searchInput?.onSearchSubmit(),this.inputPatternExcludes.onSearchSubmit(),this.inputPatternIncludes.onSearchSubmit()}),this.viewModel.cancelSearch(!0),this.viewModel.cancelAISearch(!0),this.currentSearchQ=this.currentSearchQ.then(()=>this.doSearch(e,i,r,s)).then(()=>{},()=>{})}_updateResults(){if(this.state!==T.Idle)try{const e=this.viewModel.searchResult.fileCount(this.aiResultsVisible);this._visibleMatches!==e&&(this._visibleMatches=e,this.refreshAndUpdateCount())}finally{this._refreshResultsScheduler.schedule()}}onSearchComplete(e,t,i,r){if(this.state=T.Idle,e(),this.onSearchResultsChanged(),this.searchConfig.collapseResults!=="alwaysCollapse"&&this.viewModel.searchResult.matches(this.aiResultsVisible).length===1){const c=this.viewModel.searchResult.matches(this.aiResultsVisible)[0];c.count()<50&&this.tree.expand(c)}const o=!this.viewModel.searchResult.isEmpty(this.aiResultsVisible);if(r?.exit!==Kt.NewSearchStarted){if(o)this.viewModel.searchResult.toggleHighlights(this.isVisible()),k.status(n.localize("ariaSearchResultsStatus","Search returned {0} results in {1} files",this.viewModel.searchResult.count(this.aiResultsVisible),this.viewModel.searchResult.fileCount()));else{const c=!!t,h=!!i;let l;r?this.inputPatternIncludes.onlySearchInOpenEditors()?h&&c?l=n.localize("noOpenEditorResultsIncludesExcludes","No results found in open editors matching '{0}' excluding '{1}' - ",i,t):h?l=n.localize("noOpenEditorResultsIncludes","No results found in open editors matching '{0}' - ",i):c?l=n.localize("noOpenEditorResultsExcludes","No results found in open editors excluding '{0}' - ",t):l=n.localize("noOpenEditorResultsFound","No results found in open editors. Review your settings for configured exclusions and check your gitignore files - "):h&&c?l=n.localize("noResultsIncludesExcludes","No results found in '{0}' excluding '{1}' - ",i,t):h?l=n.localize("noResultsIncludes","No results found in '{0}' - ",i):c?l=n.localize("noResultsExcludes","No results found excluding '{0}' - ",t):l=n.localize("noResultsFound","No results found. Review your settings for configured exclusions and check your gitignore files - "):l=ne,k.status(l);const f=this.clearMessage();if(a.append(f,l),r)if(h||c){const u=this.messageDisposables.add(new W(n.localize("rerunSearchInAll.message","Search again in all files"),this.onSearchAgain.bind(this),this.hoverService));a.append(f,u.element)}else{const u=this.messageDisposables.add(new W(n.localize("openSettings.message","Open Settings"),this.onOpenSettings.bind(this),this.hoverService));a.append(f,u.element)}else{const u=this.messageDisposables.add(new W(n.localize("rerunSearch.message","Search again"),()=>this.triggerQueryChange({preserveFocus:!1}),this.hoverService));a.append(f,u.element)}if(r){a.append(f,b("span",void 0," - "));const u=this.messageDisposables.add(new W(n.localize("openSettings.learnMore","Learn More"),this.onLearnMore.bind(this),this.hoverService));a.append(f,u.element)}this.contextService.getWorkbenchState()===H.EMPTY&&this.showSearchWithoutFolderMessage(),this.reLayout()}if(r&&r.limitHit&&r.messages.push({type:_t.Warning,text:n.localize("searchMaxResultsWarning","The result set only contains a subset of all matches. Be more specific in your search to narrow down the results.")}),r&&r.messages)for(const c of r.messages)this.addMessage(c);this.reLayout()}}onSearchError(e,t,i,r,s){return this.state=T.Idle,A.isCancellationError(e)?this.onSearchComplete(t,i,r,s):(t(),this.searchWidget.searchInput?.showMessage({content:e.message,type:X.ERROR}),this.viewModel.searchResult.clear(),Promise.resolve())}doSearch(e,t,i,r){let s;this.progressService.withProgress({location:this.getProgressLocation(),delay:r?300:0},h=>new Promise(l=>s=l)),this.searchWidget.searchInput?.clearMessage(),this.state=T.Searching,this.showEmptyStage();const o=setTimeout(()=>{this.state=T.SlowSearch},2e3);this._visibleMatches=0,this._refreshResultsScheduler.schedule(),this.searchWidget.setReplaceAllActionState(!1),this.tree.setSelection([]),this.tree.setFocus([]),this.viewModel.replaceString=this.searchWidget.getReplaceValue();const c=this.viewModel.search(e);if(this.aiResultsVisible){const h=this.viewModel.aiSearch({...e,contentPattern:e.contentPattern.pattern,type:Ht.aiText});return c.asyncResults.then(()=>h.then(l=>{clearTimeout(o),this.onSearchComplete(s,t,i,l)},l=>{clearTimeout(o),this.onSearchError(l,s,t,i)}))}return c.asyncResults.then(h=>{clearTimeout(o),this.onSearchComplete(s,t,i,h)},h=>{clearTimeout(o),this.onSearchError(h,s,t,i)})}onOpenSettings(e){a.EventHelper.stop(e,!1),this.openSettings("@id:files.exclude,search.exclude,search.useParentIgnoreFiles,search.useGlobalIgnoreFiles,search.useIgnoreFiles")}openSettings(e){const t={query:e};return this.contextService.getWorkbenchState()!==H.EMPTY?this.preferencesService.openWorkspaceSettings(t):this.preferencesService.openUserSettings(t)}onLearnMore(){this.openerService.open(be.parse("https://go.microsoft.com/fwlink/?linkid=853977"))}onSearchAgain(){this.inputPatternExcludes.setValue(""),this.inputPatternIncludes.setValue(""),this.inputPatternIncludes.setOnlySearchInOpenEditors(!1),this.triggerQueryChange({preserveFocus:!1})}onEnableExcludes(){this.toggleQueryDetails(!1,!0),this.searchExcludePattern.setUseExcludesAndIgnoreFiles(!0)}onDisableSearchInOpenEditors(){this.toggleQueryDetails(!1,!0),this.inputPatternIncludes.setOnlySearchInOpenEditors(!1)}updateSearchResultCount(e,t,i=!1){const r=this.viewModel.searchResult.fileCount(this.aiResultsVisible),s=this.viewModel.searchResult.count(this.aiResultsVisible);this.hasSearchResultsKey.set(r>0);const o=this.messagesElement.style.display==="none",c=this.clearMessage(),h=i?"":this.buildResultCountMessage(s,r);if(this.tree.ariaLabel=h+n.localize("forTerm"," - Search: {0}",this.searchResult.query?.contentPattern.pattern??""),a.append(c,h),r>0){if(e){const u=" - "+n.localize("useIgnoresAndExcludesDisabled","exclude settings and ignore files are disabled")+" ",S=this.messageDisposables.add(new W(n.localize("excludes.enable","enable"),this.onEnableExcludes.bind(this),this.hoverService,n.localize("useExcludesAndIgnoreFilesDescription","Use Exclude Settings and Ignore Files")));a.append(c,b("span",void 0,u,"(",S.element,")"))}if(t){const u=" - "+n.localize("onlyOpenEditors","searching only in open files")+" ",S=this.messageDisposables.add(new W(n.localize("openEditors.disable","disable"),this.onDisableSearchInOpenEditors.bind(this),this.hoverService,n.localize("disableOpenEditors","Search in entire workspace")));a.append(c,b("span",void 0,u,"(",S.element,")"))}a.append(c," - ");const l=ft(n.localize("openInEditor.tooltip","Copy current search results to an editor"),this.keybindingService.lookupKeybinding(g.SearchCommandIds.OpenInEditorCommandId)),f=this.messageDisposables.add(new W(n.localize("openInEditor.message","Open in editor"),()=>this.instantiationService.invokeFunction(Pt,this.searchResult,this.searchIncludePattern.getValue(),this.searchExcludePattern.getValue(),this.searchIncludePattern.onlySearchInOpenEditors()),this.hoverService,l));a.append(c,f.element),this.reLayout()}else o||a.hide(this.messagesElement)}addMessage(e){const t=this.messagesElement.firstChild;t&&a.append(t,St(e,this.instantiationService,this.notificationService,this.openerService,this.commandService,this.messageDisposables,()=>this.triggerQueryChange()))}buildResultCountMessage(e,t){return e===1&&t===1?n.localize("search.file.result","{0} result in {1} file",e,t):e===1?n.localize("search.files.result","{0} result in {1} files",e,t):t===1?n.localize("search.file.results","{0} results in {1} file",e,t):n.localize("search.files.results","{0} results in {1} files",e,t)}showSearchWithoutFolderMessage(){this.searchWithoutFolderMessageElement=this.clearMessage();const e=a.append(this.searchWithoutFolderMessageElement,b("p",void 0,n.localize("searchWithoutFolder","You have not opened or specified a folder. Only open files are currently searched - "))),t=this.messageDisposables.add(new W(n.localize("openFolder","Open Folder"),()=>{this.commandService.executeCommand(te.isMacintosh&&te.isNative?st.ID:rt.ID).catch(i=>A.onUnexpectedError(i))},this.hoverService));a.append(e,t.element)}showEmptyStage(e=!1){((this.messagesElement.firstChild?.textContent?.indexOf(ne)??-1)>-1||e||!this.configurationService.getValue().search.searchOnType)&&a.hide(this.messagesElement),a.show(this.resultsElement),this.currentSelectedFileMatch=void 0}shouldOpenInNotebookEditor(e,t){return e instanceof B||t.scheme!==ye.Schemas.untitled&&this.notebookService.getContributedNotebookTypes(t).length>0}onFocus(e,t,i,r){const s=this.configurationService.getValue().search.useReplacePreview,o=e instanceof m?e.parent().resource:e.resource;return s&&this.viewModel.isReplaceActive()&&this.viewModel.replaceString&&!this.shouldOpenInNotebookEditor(e,o)?this.replaceService.openReplacePreview(e,t,i,r):this.open(e,t,i,r,o)}async open(e,t,i,r,s){const o=Qt(e,this.viewModel),c=e instanceof m?e.parent().matches():[],h=s??(e instanceof m?e.parent().resource:e.resource);let l;const f={preserveFocus:t,pinned:r,selection:o,revealIfVisible:!0};try{l=await this.editorService.openEditor({resource:h,options:f},i?Ot:Tt);const u=l?.getControl();e instanceof m&&t&&Y(u)?this.viewModel.searchResult.rangeHighlightDecorations.highlightRange(u.getModel(),e.range()):this.viewModel.searchResult.rangeHighlightDecorations.removeHighlightRange()}catch(u){A.onUnexpectedError(u);return}if(l instanceof ht){const u=e.parent();if(e instanceof m)if(e instanceof B)e.parent().showMatch(e);else{const S=l.getControl();if(S){u.bindNotebookEditorWidget(S),await u.updateMatchesForEditorWidget();const x=c.findIndex(R=>R.id()===e.id()),E=u.matches(),I=x>=E.length?E[E.length-1]:E[x];I instanceof B&&(u.showMatch(I),(!this.tree.getFocus().includes(I)||!this.tree.getSelection().includes(I))&&(this.tree.setSelection([I],N()),this.tree.setFocus([I])))}}}}openEditorWithMultiCursor(e){const t=e instanceof m?e.parent().resource:e.resource;return this.editorService.openEditor({resource:t,options:{preserveFocus:!1,pinned:!0,revealIfVisible:!0}}).then(i=>{if(i){let r=null;if(e instanceof M?r=e:e instanceof m&&(r=e.parent()),r){const s=r.matches().map(c=>new Fe(c.range().startLineNumber,c.range().startColumn,c.range().endLineNumber,c.range().endColumn)),o=Ee(i.getControl());o&&We.get(o)?.selectAllUsingSelections(s)}}this.viewModel.searchResult.rangeHighlightDecorations.removeHighlightRange()},A.onUnexpectedError)}onUntitledDidDispose(e){if(!this.viewModel)return;let t=this.viewModel.searchResult.matches();for(let i=0,r=t.length;i<r;i++)e.toString()===t[i].resource.toString()&&this.viewModel.searchResult.remove(t[i]);t=this.viewModel.searchResult.matches(!0);for(let i=0,r=t.length;i<r;i++)e.toString()===t[i].resource.toString()&&this.viewModel.searchResult.remove(t[i])}onFilesChanged(e){if(!this.viewModel||this.searchConfig.sortOrder!==D.Modified&&!e.gotDeleted())return;const t=this.viewModel.searchResult.matches();if(e.gotDeleted()){const i=t.filter(r=>e.contains(r.resource,ke.DELETED));this.viewModel.searchResult.remove(i)}else{const i=t.filter(r=>e.contains(r.resource));i.length&&this.searchConfig.sortOrder===D.Modified&&this.updateFileStats(i).then(()=>this.refreshTree())}}get searchConfig(){return this.configurationService.getValue("search")}clearHistory(){this.searchWidget.clearHistory(),this.inputPatternExcludes.clearHistory(),this.inputPatternIncludes.clearHistory()}saveState(){if(!this.searchWidget)return;const e=this.inputPatternExcludes?.getValue().trim()??"",t=this.inputPatternIncludes?.getValue().trim()??"",i=this.inputPatternIncludes?.onlySearchInOpenEditors()??!1,r=this.inputPatternExcludes?.useExcludesAndIgnoreFiles()??!0,s=this.viewModel.preserveCase;if(this.searchWidget.searchInput){const c=this.searchWidget.searchInput.getRegex(),h=this.searchWidget.searchInput.getWholeWords(),l=this.searchWidget.searchInput.getCaseSensitive(),f=this.searchWidget.searchInput.getValue(),u=this.searchWidget.getNotebookFilters().codeInput,S=this.searchWidget.getNotebookFilters().codeOutput,x=this.searchWidget.getNotebookFilters().markupInput,E=this.searchWidget.getNotebookFilters().markupPreview;this.viewletState["query.contentPattern"]=f,this.viewletState["query.regex"]=c,this.viewletState["query.wholeWords"]=h,this.viewletState["query.caseSensitive"]=l,this.viewletState["query.isInNotebookMarkdownInput"]=x,this.viewletState["query.isInNotebookMarkdownPreview"]=E,this.viewletState["query.isInNotebookCellInput"]=u,this.viewletState["query.isInNotebookCellOutput"]=S}this.viewletState["query.folderExclusions"]=e,this.viewletState["query.folderIncludes"]=t,this.viewletState["query.useExcludesAndIgnoreFiles"]=r,this.viewletState["query.preserveCase"]=s,this.viewletState["query.onlyOpenEditors"]=i;const o=this.searchAndReplaceWidget.isReplaceShown();this.viewletState["view.showReplace"]=o,this.viewletState["view.treeLayout"]=this.isTreeLayoutViewVisible,this.viewletState["query.replaceText"]=o&&this.searchWidget.getReplaceValue(),this._saveSearchHistoryService(),this.memento.saveMemento(),super.saveState()}_saveSearchHistoryService(){if(this.searchWidget===void 0)return;const e=Object.create(null),t=this.searchWidget.getSearchHistory();t&&t.length&&(e.search=t);const i=this.searchWidget.getReplaceHistory();i&&i.length&&(e.replace=i);const r=this.inputPatternExcludes.getHistory();r&&r.length&&(e.exclude=r);const s=this.inputPatternIncludes.getHistory();s&&s.length&&(e.include=s),this.searchHistoryService.save(e)}async retrieveFileStats(){const e=this.searchResult.matches(this.aiResultsVisible).filter(t=>!t.fileStat).map(t=>t.resolveFileStat(this.fileService));await Promise.all(e)}async updateFileStats(e){const t=e.map(i=>i.resolveFileStat(this.fileService));await Promise.all(t)}removeFileStats(){for(const e of this.searchResult.matches())e.fileStat=void 0;for(const e of this.searchResult.matches(!0))e.fileStat=void 0}dispose(){this.isDisposed=!0,this.saveState(),super.dispose()}};O=J([d(1,Le),d(2,Dt),d(3,Re),d(4,$e),d(5,Ye),d(6,_e),d(7,Ae),d(8,Ke),d(9,Qe),d(10,lt),d(11,Ve),d(12,it),d(13,mt),d(14,se),d(15,gt),d(16,Lt),d(17,At),d(18,tt),d(19,wt),d(20,He),d(21,Pe),d(22,ze),d(23,Je),d(24,je),d(25,Ze),d(26,Ne),d(27,ut),d(28,Ue),d(29,De)],O);class W extends me{element;constructor(y,e,t,i){super(),this.element=b("a.pointer",{tabindex:0},y),this._register(t.setupManagedHover(ie("mouse"),this.element,i)),this.addEventHandlers(e)}addEventHandlers(y){const e=t=>{a.EventHelper.stop(t,!1),y(t)};this._register(a.addDisposableListener(this.element,a.EventType.CLICK,e)),this._register(a.addDisposableListener(this.element,a.EventType.KEY_DOWN,t=>{const i=new z(t);(i.equals(V.Space)||i.equals(V.Enter))&&(e(t),i.preventDefault(),i.stopPropagation())}))}}function Qt(C,y){let e=null;if(C instanceof m&&(e=C),C instanceof M&&C.count()>0&&(e=C.matches()[C.matches().length-1]),e){const t=e.range();if(y.isReplaceActive()&&y.replaceString){const i=e.replaceString;return{startLineNumber:t.startLineNumber,startColumn:t.startColumn,endLineNumber:t.startLineNumber,endColumn:t.startColumn+i.length}}return t}}function Bt(C,y){let e=y;if(xe(e)&&(e.getOriginalEditor().hasTextFocus()?e=e.getOriginalEditor():e=e.getModifiedEditor()),!Y(e)||!e.hasModel())return null;const t=e.getSelection();if(!t)return null;if(t.isEmpty())return C?e.getModel().getWordAtPosition(t.getStartPosition())?.word??null:null;let i="";for(let r=t.startLineNumber;r<=t.endLineNumber;r++){let s=e.getModel().getLineContent(r);r===t.endLineNumber&&(s=s.substring(0,t.endColumn-1)),r===t.startLineNumber&&(s=s.substring(t.startColumn-1)),r!==t.startLineNumber&&(s=`
`+s),i+=s}return i}export{O as SearchView,Nt as SearchViewPosition,Qt as getEditorSelectionFromMatch,Bt as getSelectionTextFromEditor};
