import{onUnexpectedError as U}from"../../../../base/common/errors.js";import{KeyCode as R,KeyMod as C}from"../../../../base/common/keyCodes.js";import{Schemas as K}from"../../../../base/common/network.js";import{dirname as z}from"../../../../base/common/resources.js";import*as p from"../../../../nls.js";import{Action2 as S,MenuId as I,registerAction2 as x}from"../../../../platform/actions/common/actions.js";import{ICommandService as b}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as A}from"../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as g}from"../../../../platform/contextkey/common/contextkey.js";import{IFileService as _}from"../../../../platform/files/common/files.js";import{KeybindingWeight as W}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{IListService as L}from"../../../../platform/list/browser/listService.js";import{IWorkspaceContextService as T}from"../../../../platform/workspace/common/workspace.js";import{ViewContainerLocation as q}from"../../../common/views.js";import{IConfigurationResolverService as D}from"../../../services/configurationResolver/common/configurationResolver.js";import{IEditorGroupsService as B}from"../../../services/editor/common/editorGroupsService.js";import{IEditorService as H}from"../../../services/editor/common/editorService.js";import{IHistoryService as G}from"../../../services/history/common/history.js";import{IPaneCompositePartService as N}from"../../../services/panecomposite/browser/panecomposite.js";import{resolveResourcesForSearchIncludes as Q}from"../../../services/search/common/queryBuilder.js";import{IViewsService as v}from"../../../services/views/common/viewsService.js";import{IExplorerService as j,getMultiSelectedResources as J}from"../../files/browser/files.js";import{ExplorerFolderContext as k,ExplorerRootContext as X,FilesExplorerFocusCondition as Y,VIEWLET_ID as Z}from"../../files/common/files.js";import*as w from"../../searchEditor/browser/constants.js";import*as s from"../common/constants.js";import{category as F,getElementsToOperateOn as $,getSearchView as O,openSearchView as V}from"./searchActionsBase.js";import{FileMatch as P,Match as ee}from"./searchModel.js";x(class extends S{constructor(){super({id:s.SearchCommandIds.RestrictSearchToFolderId,title:p.localize2("restrictResultsToFolder","Restrict Search to Folder"),category:F,keybinding:{weight:W.WorkbenchContrib,when:g.and(s.SearchContext.SearchViewVisibleKey,s.SearchContext.ResourceFolderFocusKey),primary:C.Shift|C.Alt|R.KeyF},menu:[{id:I.SearchContext,group:"search",order:3,when:g.and(s.SearchContext.ResourceFolderFocusKey)}]})}async run(o,r){await M(o,!1,!0,void 0,r)}}),x(class extends S{constructor(){super({id:s.SearchCommandIds.ExpandRecursivelyCommandId,title:p.localize("search.expandRecursively","Expand Recursively"),category:F,menu:[{id:I.SearchContext,when:g.and(s.SearchContext.FolderFocusKey,s.SearchContext.HasSearchResults),group:"search",order:4}]})}run(o){oe(o)}}),x(class extends S{constructor(){super({id:s.SearchCommandIds.ExcludeFolderFromSearchId,title:p.localize2("excludeFolderFromSearch","Exclude Folder from Search"),category:F,menu:[{id:I.SearchContext,group:"search",order:4,when:g.and(s.SearchContext.ResourceFolderFocusKey)}]})}async run(o,r){await M(o,!1,!1,void 0,r)}}),x(class extends S{constructor(){super({id:s.SearchCommandIds.RevealInSideBarForSearchResults,title:p.localize2("revealInSideBar","Reveal in Explorer View"),category:F,menu:[{id:I.SearchContext,when:g.and(s.SearchContext.FileFocusKey,s.SearchContext.HasSearchResults),group:"search_3",order:1}]})}async run(o,r){const n=o.get(N),h=o.get(j),a=o.get(T),f=O(o.get(v));if(!f)return;let i;if(r instanceof P||(r=f.getControl().getFocus()[0]),r instanceof P)i=r;else return;n.openPaneComposite(Z,q.Sidebar,!1).then(t=>{if(!t)return;const u=t.getViewPaneContainer(),l=i.resource;if(l&&a.isInsideWorkspace(l)){const d=u.getExplorerView();d.setExpanded(!0),h.select(l,!0).then(()=>d.focus(),U)}})}}),x(class extends S{constructor(){super({id:s.SearchCommandIds.FindInFilesActionId,title:{...p.localize2("findInFiles","Find in Files"),mnemonicTitle:p.localize({key:"miFindInFiles",comment:["&& denotes a mnemonic"]},"Find &&in Files")},metadata:{description:p.localize("findInFiles.description","Open a workspace search"),args:[{name:p.localize("findInFiles.args","A set of options for the search"),schema:{type:"object",properties:{query:{type:"string"},replace:{type:"string"},preserveCase:{type:"boolean"},triggerSearch:{type:"boolean"},filesToInclude:{type:"string"},filesToExclude:{type:"string"},isRegex:{type:"boolean"},isCaseSensitive:{type:"boolean"},matchWholeWord:{type:"boolean"},useExcludeSettingsAndIgnoreFiles:{type:"boolean"},onlyOpenEditors:{type:"boolean"},showIncludesExcludes:{type:"boolean"}}}}]},category:F,keybinding:{weight:W.WorkbenchContrib,primary:C.CtrlCmd|C.Shift|R.KeyF},menu:[{id:I.MenubarEditMenu,group:"4_find_global",order:1}],f1:!0})}async run(o,r={}){te(o,r)}}),x(class extends S{constructor(){super({id:s.SearchCommandIds.FindInFolderId,title:p.localize2("findInFolder","Find in Folder..."),category:F,keybinding:{weight:W.WorkbenchContrib,when:g.and(Y,k),primary:C.Shift|C.Alt|R.KeyF},menu:[{id:I.ExplorerContext,group:"4_search",order:10,when:g.and(k)}]})}async run(o,r){await M(o,!0,!0,r)}}),x(class extends S{constructor(){super({id:s.SearchCommandIds.FindInWorkspaceId,title:p.localize2("findInWorkspace","Find in Workspace..."),category:F,menu:[{id:I.ExplorerContext,group:"4_search",order:10,when:g.and(X,k.toNegated())}]})}async run(o){const n=o.get(A).getValue().search.mode;if(n==="view")(await V(o.get(v),!0))?.searchInFolders();else return o.get(b).executeCommand(w.OpenEditorCommandId,{location:n==="newEditor"?"new":"reuse",filesToInclude:""})}});function oe(e){const o=e.get(v),r=O(o);if(r){const n=r.getControl(),h=n.getFocus()[0];n.expand(h,!0)}}async function M(e,o,r,n,h){const a=e.get(_),f=e.get(v),i=e.get(T),t=e.get(b),u=e.get(A).getValue().search,l=u.mode;let d;if(o)d=J(n,e.get(L),e.get(H),e.get(B),e.get(j));else{const c=O(f);if(!c)return;d=re(c.getControl(),h,u)}const y=a.resolveAll(d.map(c=>({resource:c}))).then(c=>{const E=[];return c.forEach(m=>{m.success&&m.stat&&E.push(m.stat.isDirectory?m.stat.resource:z(m.stat.resource))}),Q(E,i)});if(l==="view"){const c=await V(f,!0);d&&d.length&&c&&(r?c.searchInFolders(await y):c.searchOutsideOfFolders(await y));return}else return r?t.executeCommand(w.OpenEditorCommandId,{filesToInclude:(await y).join(", "),showIncludesExcludes:!0,location:l==="newEditor"?"new":"reuse"}):t.executeCommand(w.OpenEditorCommandId,{filesToExclude:(await y).join(", "),showIncludesExcludes:!0,location:l==="newEditor"?"new":"reuse"})}function re(e,o,r){return $(e,o,r).map(n=>n instanceof ee?null:n.resource).filter(n=>n!==null)}async function te(e,o={}){const r=e.get(A).getValue().search,n=e.get(v),h=e.get(b),a={};if(Object.keys(o).length!==0){const i=e.get(D),t=e.get(G),u=e.get(T),l=t.getLastActiveWorkspaceRoot(),d=l?.scheme===K.file||l?.scheme===K.vscodeRemote?l:void 0,y=d?u.getWorkspaceFolder(d)??void 0:void 0;for(const c of Object.entries(o)){const E=c[0],m=c[1];m!==void 0&&(a[E]=typeof m=="string"?await i.resolveAsync(y,m):m)}}const f=r.mode;if(f==="view")V(n,!1).then(i=>{if(i){i.searchAndReplaceWidget.toggleReplace(typeof a.replace=="string");let u=!1;typeof a.query!="string"&&(u=i.updateTextFromFindWidgetOrSelection({allowUnselectedWord:typeof a.replace!="string"})),i.setSearchParameters(a),typeof a.showIncludesExcludes=="boolean"&&i.toggleQueryDetails(!1,a.showIncludesExcludes),i.searchAndReplaceWidget.focus(void 0,u,u)}});else{const i=t=>({location:f==="newEditor"?"new":"reuse",query:t.query,filesToInclude:t.filesToInclude,filesToExclude:t.filesToExclude,matchWholeWord:t.matchWholeWord,isCaseSensitive:t.isCaseSensitive,isRegexp:t.isRegex,useExcludeSettingsAndIgnoreFiles:t.useExcludeSettingsAndIgnoreFiles,onlyOpenEditors:t.onlyOpenEditors,showIncludesExcludes:!!(t.filesToExclude||t.filesToExclude||!t.useExcludeSettingsAndIgnoreFiles)});h.executeCommand(w.OpenEditorCommandId,i(a))}}export{te as findInFilesCommand};
