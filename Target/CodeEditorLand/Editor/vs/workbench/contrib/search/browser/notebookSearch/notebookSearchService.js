var x=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var P=(S,t,o,s)=>{for(var i=s>1?void 0:s?E(t,o):t,r=S.length-1,n;r>=0;r--)(n=S[r])&&(i=(s?n(t,o,i):n(i))||i);return s&&i&&x(t,o,i),i},m=(S,t)=>(o,s)=>t(o,s,S);import{CancellationToken as w}from"../../../../../base/common/cancellation.js";import{ResourceSet as g,ResourceMap as C}from"../../../../../base/common/map.js";import{IConfigurationService as T}from"../../../../../platform/configuration/common/configuration.js";import{ILogService as W}from"../../../../../platform/log/common/log.js";import{IUriIdentityService as D}from"../../../../../platform/uriIdentity/common/uriIdentity.js";import{INotebookService as U}from"../../../notebook/common/notebookService.js";import{contentMatchesToTextSearchMatches as A,webviewMatchesToTextSearchMatches as H}from"./searchNotebookHelpers.js";import{QueryType as L,pathIncludedInQuery as Q,ISearchService as B,DEFAULT_MAX_SEARCH_RESULTS as O}from"../../../../services/search/common/search.js";import*as M from"../../../../../base/common/arrays.js";import{isNumber as K}from"../../../../../base/common/types.js";import{IEditorResolverService as _}from"../../../../services/editor/common/editorResolverService.js";import{INotebookEditorService as z}from"../../../notebook/browser/services/notebookEditorService.js";import{QueryBuilder as $}from"../../../../services/search/common/queryBuilder.js";import{IInstantiationService as V}from"../../../../../platform/instantiation/common/instantiation.js";let R=class{constructor(t,o,s,i,r,n,l,u){this.uriIdentityService=t;this.notebookEditorService=o;this.logService=s;this.notebookService=i;this.configurationService=r;this.editorResolverService=n;this.searchService=l;this.queryBuilder=u.createInstance($)}queryBuilder;notebookSearch(t,o,s,i){if(t.type!==L.Text)return{openFilesToScan:new g,completeData:Promise.resolve({messages:[],limitHit:!1,results:[]}),allScannedFiles:Promise.resolve(new g)};const r=this.getLocalNotebookWidgets(),n=r.map(a=>a.viewModel.uri),u=(()=>{const a=Date.now(),d=this.getLocalNotebookResults(t,o??w.None,r,s),b=Date.now(),h=this.configurationService.getValue("search").experimental?.closedNotebookRichContentResults??!1;let c=Promise.resolve(void 0);h&&(c=this.getClosedNotebookResults(t,new g(n,e=>this.uriIdentityService.extUri.getComparisonKey(e)),o??w.None));const v=Promise.all([d,c]);return{completeData:v.then(e=>{const p=e[0],I=e[1],f=e.filter(N=>!!N),k=[...p.results.values(),...I?.results.values()??[]],y=M.coalesce(k);return i&&y.forEach(i),this.logService.trace(`local notebook search time | ${b-a}ms`),{messages:[],limitHit:f.reduce((N,F)=>N||F.limitHit,!1),results:y}}),allScannedFiles:v.then(e=>{const p=e[0],I=e[1],f=M.coalesce([...p.results.keys(),...I?.results.keys()??[]]);return new g(f,k=>this.uriIdentityService.extUri.getComparisonKey(k))})}})();return{openFilesToScan:new g(n),completeData:u.completeData,allScannedFiles:u.allScannedFiles}}async doesFileExist(t,o,s){const i=t.map(async r=>{const n=this.queryBuilder.file(o.map(l=>l.folder),{includePattern:r.startsWith("/")?r:"**/"+r,exists:!0,onlyFileScheme:!0});return this.searchService.fileSearch(n,s).then(l=>!!l.limitHit)});return Promise.any(i)}async getClosedNotebookResults(t,o,s){const i=this.editorResolverService.getAllUserAssociations(),r=new Map,n=this.notebookService.getContributedNotebookTypes();i.forEach(e=>{if(!e.filenamePattern)return;const p={isFromSettings:!0,filenamePatterns:[e.filenamePattern]},I=r.get(e.viewType);I?r.set(e.viewType,I.concat(p)):r.set(e.viewType,[p])});const l=[];n.forEach(e=>{e.selectors.length>0&&l.push((async()=>{const p=e.selectors.map(f=>(f.include||f).toString());if(await this.doesFileExist(p,t.folderQueries,s))return await this.notebookService.canResolve(e.id)?await(await this.notebookService.withNotebookDataProvider(e.id)).serializer.searchInNotebooks(t,s,r):void 0})())});const u=Date.now(),a=M.coalesce(await Promise.all(l)),d=a.flatMap(e=>e.results);let b=a.some(e=>e.limitHit);const h=new C(e=>this.uriIdentityService.extUri.getComparisonKey(e));let c=0;for(const e of d){if(t.maxResults&&c>=t.maxResults){b=!0;break}!o.has(e.resource)&&!h.has(e.resource)&&(h.set(e.resource,e.cellResults.length>0?e:null),c++)}const v=Date.now();return this.logService.trace(`query: ${t.contentPattern.pattern}`),this.logService.trace(`closed notebook search time | ${v-u}ms`),{results:h,limitHit:b}}async getLocalNotebookResults(t,o,s,i){const r=new C(l=>this.uriIdentityService.extUri.getComparisonKey(l));let n=!1;for(const l of s){if(!l.hasModel())continue;const u=(K(t.maxResults)?t.maxResults:O)+1,a=l.viewModel.uri;if(!Q(t,a.fsPath))continue;let d=await l.find(t.contentPattern.pattern,{regex:t.contentPattern.isRegExp,wholeWord:t.contentPattern.isWordMatch,caseSensitive:t.contentPattern.isCaseSensitive,includeMarkupInput:t.contentPattern.notebookInfo?.isInNotebookMarkdownInput??!0,includeMarkupPreview:t.contentPattern.notebookInfo?.isInNotebookMarkdownPreview??!0,includeCodeInput:t.contentPattern.notebookInfo?.isInNotebookCellInput??!0,includeOutput:t.contentPattern.notebookInfo?.isInNotebookCellOutput??!0},o,!1,!0,i);if(d.length){u&&d.length>=u&&(n=!0,d=d.slice(0,u-1));const b=d.map(c=>{const v=A(c.contentMatches,c.cell),e=H(c.webviewMatches);return{cell:c.cell,index:c.index,contentResults:v,webviewResults:e}}),h={resource:a,cellResults:b};r.set(a,h)}else r.set(a,null)}return{results:r,limitHit:n}}getLocalNotebookWidgets(){return this.notebookEditorService.retrieveAllExistingWidgets().map(o=>o.value).filter(o=>!!o&&o.hasModel())}};R=P([m(0,D),m(1,z),m(2,W),m(3,U),m(4,T),m(5,_),m(6,B),m(7,V)],R);export{R as NotebookSearchService};
