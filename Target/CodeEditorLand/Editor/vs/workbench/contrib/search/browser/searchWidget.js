var F=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var y=(l,s,e,t)=>{for(var i=t>1?void 0:t?K(s,e):s,n=l.length-1,r;n>=0;n--)(r=l[n])&&(i=(t?r(s,e,i):r(i))||i);return t&&i&&F(s,e,i),i},c=(l,s)=>(e,t)=>s(e,t,l);import*as d from"../../../../nls.js";import*as a from"../../../../base/browser/dom.js";import{ActionBar as H}from"../../../../base/browser/ui/actionbar/actionbar.js";import{Button as E}from"../../../../base/browser/ui/button/button.js";import{InputBox as N}from"../../../../base/browser/ui/inputbox/inputBox.js";import{Widget as k}from"../../../../base/browser/ui/widget.js";import{Action as V}from"../../../../base/common/actions.js";import{Delayer as O}from"../../../../base/common/async.js";import{Emitter as p}from"../../../../base/common/event.js";import{KeyCode as o,KeyMod as g}from"../../../../base/common/keyCodes.js";import{CONTEXT_FIND_WIDGET_NOT_VISIBLE as P}from"../../../../editor/contrib/find/browser/findModel.js";import{IClipboardService as M}from"../../../../platform/clipboard/common/clipboardService.js";import{IConfigurationService as q}from"../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as W,IContextKeyService as G}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as z,IContextViewService as U}from"../../../../platform/contextview/browser/contextView.js";import{IKeybindingService as X}from"../../../../platform/keybinding/common/keybinding.js";import{KeybindingsRegistry as $,KeybindingWeight as j}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{ThemeIcon as m}from"../../../../base/common/themables.js";import{ContextScopedReplaceInput as J}from"../../../../platform/history/browser/contextScopedHistoryWidget.js";import{appendKeyBindingLabel as I,isSearchViewFocused as Q,getSearchView as Y}from"./searchActionsBase.js";import*as u from"../common/constants.js";import{IAccessibilityService as Z}from"../../../../platform/accessibility/common/accessibility.js";import{isMacintosh as ee}from"../../../../base/common/platform.js";import{Toggle as te}from"../../../../base/browser/ui/toggle/toggle.js";import{IViewsService as ie}from"../../../services/views/common/viewsService.js";import{searchReplaceAllIcon as ne,searchHideReplaceIcon as C,searchShowContextIcon as oe,searchShowReplaceIcon as x}from"./searchIcons.js";import{ToggleSearchEditorContextLinesCommandId as re}from"../../searchEditor/browser/constants.js";import{showHistoryKeybindingHint as R}from"../../../../platform/history/browser/historyWidgetKeybindingHint.js";import{defaultInputBoxStyles as se,defaultToggleStyles as ae}from"../../../../platform/theme/browser/defaultStyles.js";import{NotebookFindFilters as le}from"../../notebook/browser/contrib/find/findFilters.js";import{IInstantiationService as ce}from"../../../../platform/instantiation/common/instantiation.js";import{IEditorService as pe}from"../../../services/editor/common/editorService.js";import{NotebookEditorInput as A}from"../../notebook/common/notebookEditorInput.js";import{GroupModelChangeKind as B}from"../../../common/editor.js";import{SearchFindInput as he}from"./searchFindInput.js";import{getDefaultHoverDelegate as w}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import{MutableDisposable as ue}from"../../../../base/common/lifecycle.js";import{NotebookFindScopeType as de}from"../../notebook/common/notebookCommon.js";const _=26;class f extends V{constructor(e){super(f.ID,"",m.asClassName(ne),!1);this._searchWidget=e}static ID="search.action.replaceAll";set searchWidget(e){this._searchWidget=e}run(){return this._searchWidget?this._searchWidget.triggerReplaceAll():Promise.resolve(null)}}const T=ee?g.WinCtrl:g.CtrlCmd;function D(l,s,e){const t=!!s.match(/\n/);if(e&&(t||e.clientHeight>_)&&e.selectionStart>0){l.stopPropagation();return}}function L(l,s,e){const t=!!s.match(/\n/);if(e&&(t||e.clientHeight>_)&&e.selectionEnd<e.value.length){l.stopPropagation();return}}let h=class extends k{constructor(e,t,i,n,r,v,ge,Ie,fe,ve,Se){super();this.contextViewService=i;this.contextKeyService=n;this.keybindingService=r;this.clipboardServce=v;this.configurationService=ge;this.accessibilityService=Ie;this.contextMenuService=fe;this.instantiationService=ve;this.editorService=Se;this.replaceActive=u.SearchContext.ReplaceActiveKey.bindTo(this.contextKeyService),this.searchInputBoxFocused=u.SearchContext.SearchInputBoxFocusedKey.bindTo(this.contextKeyService),this.replaceInputBoxFocused=u.SearchContext.ReplaceInputBoxFocusedKey.bindTo(this.contextKeyService);const b=t.notebookOptions??{isInNotebookMarkdownInput:!0,isInNotebookMarkdownPreview:!0,isInNotebookCellInput:!0,isInNotebookCellOutput:!0};this._notebookFilters=this._register(new le(b.isInNotebookMarkdownInput,b.isInNotebookMarkdownPreview,b.isInNotebookCellInput,b.isInNotebookCellOutput,{findScopeType:de.None})),this._register(this._notebookFilters.onDidChange(()=>{this.searchInput&&this.searchInput.updateFilterStyles()})),this._register(this.editorService.onDidEditorsChange(S=>{this.searchInput&&S.event.editor instanceof A&&(S.event.kind===B.EDITOR_OPEN||S.event.kind===B.EDITOR_CLOSE)&&(this.searchInput.filterVisible=this._hasNotebookOpen())})),this._replaceHistoryDelayer=new O(500),this._toggleReplaceButtonListener=this._register(new ue),this.render(e,t),this._register(this.configurationService.onDidChangeConfiguration(S=>{S.affectsConfiguration("editor.accessibilitySupport")&&this.updateAccessibilitySupport()})),this._register(this.accessibilityService.onDidChangeScreenReaderOptimized(()=>this.updateAccessibilitySupport())),this.updateAccessibilitySupport()}static INPUT_MAX_HEIGHT=134;static REPLACE_ALL_DISABLED_LABEL=d.localize("search.action.replaceAll.disabled.label","Replace All (Submit Search to Enable)");static REPLACE_ALL_ENABLED_LABEL=e=>{const t=e.lookupKeybinding(f.ID);return I(d.localize("search.action.replaceAll.enabled.label","Replace All"),t)};domNode;searchInput;searchInputFocusTracker;searchInputBoxFocused;replaceContainer;replaceInput;replaceInputFocusTracker;replaceInputBoxFocused;toggleReplaceButton;replaceAllAction;replaceActive;replaceActionBar;_replaceHistoryDelayer;ignoreGlobalFindBufferOnNextFocus=!1;previousGlobalFindBufferValue=null;_onSearchSubmit=this._register(new p);onSearchSubmit=this._onSearchSubmit.event;_onSearchCancel=this._register(new p);onSearchCancel=this._onSearchCancel.event;_onReplaceToggled=this._register(new p);onReplaceToggled=this._onReplaceToggled.event;_onReplaceStateChange=this._register(new p);onReplaceStateChange=this._onReplaceStateChange.event;_onPreserveCaseChange=this._register(new p);onPreserveCaseChange=this._onPreserveCaseChange.event;_onReplaceValueChanged=this._register(new p);onReplaceValueChanged=this._onReplaceValueChanged.event;_onReplaceAll=this._register(new p);onReplaceAll=this._onReplaceAll.event;_onBlur=this._register(new p);onBlur=this._onBlur.event;_onDidHeightChange=this._register(new p);onDidHeightChange=this._onDidHeightChange.event;_onDidToggleContext=new p;onDidToggleContext=this._onDidToggleContext.event;showContextToggle;contextLinesInput;_notebookFilters;_toggleReplaceButtonListener;_hasNotebookOpen(){return this.editorService.editors.some(t=>t instanceof A)}getNotebookFilters(){return this._notebookFilters}focus(e=!0,t=!1,i=!1){this.ignoreGlobalFindBufferOnNextFocus=i,t&&this.isReplaceShown()?this.replaceInput&&(this.replaceInput.focus(),e&&this.replaceInput.select()):this.searchInput&&(this.searchInput.focus(),e&&this.searchInput.select())}setWidth(e){this.searchInput?.inputBox.layout(),this.replaceInput&&(this.replaceInput.width=e-28,this.replaceInput.inputBox.layout())}clear(){this.searchInput?.clear(),this.replaceInput?.setValue(""),this.setReplaceAllActionState(!1)}isReplaceShown(){return this.replaceContainer?!this.replaceContainer.classList.contains("disabled"):!1}isReplaceActive(){return!!this.replaceActive.get()}getReplaceValue(){return this.replaceInput?.getValue()??""}toggleReplace(e){(e===void 0||e!==this.isReplaceShown())&&this.onToggleReplaceButton()}getSearchHistory(){return this.searchInput?.inputBox.getHistory()??[]}getReplaceHistory(){return this.replaceInput?.inputBox.getHistory()??[]}prependSearchHistory(e){this.searchInput?.inputBox.prependHistory(e)}prependReplaceHistory(e){this.replaceInput?.inputBox.prependHistory(e)}clearHistory(){this.searchInput?.inputBox.clearHistory(),this.replaceInput?.inputBox.clearHistory()}showNextSearchTerm(){this.searchInput?.inputBox.showNextValue()}showPreviousSearchTerm(){this.searchInput?.inputBox.showPreviousValue()}showNextReplaceTerm(){this.replaceInput?.inputBox.showNextValue()}showPreviousReplaceTerm(){this.replaceInput?.inputBox.showPreviousValue()}searchInputHasFocus(){return!!this.searchInputBoxFocused.get()}replaceInputHasFocus(){return!!this.replaceInput?.inputBox.hasFocus()}focusReplaceAllAction(){this.replaceActionBar?.focus(!0)}focusRegexAction(){this.searchInput?.focusOnRegex()}set replaceButtonVisibility(e){this.toggleReplaceButton&&(this.toggleReplaceButton.element.style.display=e?"":"none")}render(e,t){this.domNode=a.append(e,a.$(".search-widget")),this.domNode.style.position="relative",t._hideReplaceToggle||this.renderToggleReplaceButton(this.domNode),this.renderSearchInput(this.domNode,t),this.renderReplaceInput(this.domNode,t)}updateAccessibilitySupport(){this.searchInput?.setFocusInputOnOptionClick(!this.accessibilityService.isScreenReaderOptimized())}renderToggleReplaceButton(e){const t={buttonBackground:void 0,buttonBorder:void 0,buttonForeground:void 0,buttonHoverBackground:void 0,buttonSecondaryBackground:void 0,buttonSecondaryForeground:void 0,buttonSecondaryHoverBackground:void 0,buttonSeparator:void 0,title:d.localize("search.replace.toggle.button.title","Toggle Replace"),hoverDelegate:w("element")};this.toggleReplaceButton=this._register(new E(e,t)),this.toggleReplaceButton.element.setAttribute("aria-expanded","false"),this.toggleReplaceButton.element.classList.add("toggle-replace-button"),this.toggleReplaceButton.icon=C,this._toggleReplaceButtonListener.value=this.toggleReplaceButton.onDidClick(()=>this.onToggleReplaceButton())}renderSearchInput(e,t){const i={label:d.localize("label.Search","Search: Type Search Term and press Enter to search"),validation:r=>this.validateSearchInput(r),placeholder:d.localize("search.placeHolder","Search"),appendCaseSensitiveLabel:I("",this.keybindingService.lookupKeybinding(u.SearchCommandIds.ToggleCaseSensitiveCommandId)),appendWholeWordsLabel:I("",this.keybindingService.lookupKeybinding(u.SearchCommandIds.ToggleWholeWordCommandId)),appendRegexLabel:I("",this.keybindingService.lookupKeybinding(u.SearchCommandIds.ToggleRegexCommandId)),history:t.searchHistory,showHistoryHint:()=>R(this.keybindingService),flexibleHeight:!0,flexibleMaxHeight:h.INPUT_MAX_HEIGHT,showCommonFindToggles:!0,inputBoxStyles:t.inputBoxStyles,toggleStyles:t.toggleStyles},n=a.append(e,a.$(".search-container.input-box"));this.searchInput=this._register(new he(n,this.contextViewService,i,this.contextKeyService,this.contextMenuService,this.instantiationService,this._notebookFilters,t.initialAIButtonVisibility??!1,this._hasNotebookOpen())),this._register(this.searchInput.onKeyDown(r=>this.onSearchInputKeyDown(r))),this.searchInput.setValue(t.value||""),this.searchInput.setRegex(!!t.isRegex),this.searchInput.setCaseSensitive(!!t.isCaseSensitive),this.searchInput.setWholeWords(!!t.isWholeWords),this._register(this.searchInput.onCaseSensitiveKeyDown(r=>this.onCaseSensitiveKeyDown(r))),this._register(this.searchInput.onRegexKeyDown(r=>this.onRegexKeyDown(r))),this._register(this.searchInput.inputBox.onDidChange(()=>this.onSearchInputChanged())),this._register(this.searchInput.inputBox.onDidHeightChange(()=>this._onDidHeightChange.fire())),this._register(this.onReplaceValueChanged(()=>{this._replaceHistoryDelayer.trigger(()=>this.replaceInput?.inputBox.addToHistory())})),this.searchInputFocusTracker=this._register(a.trackFocus(this.searchInput.inputBox.inputElement)),this._register(this.searchInputFocusTracker.onDidFocus(async()=>{this.searchInputBoxFocused.set(!0);const r=this.searchConfiguration.globalFindClipboard;if(!this.ignoreGlobalFindBufferOnNextFocus&&r){const v=await this.clipboardServce.readFindText();v&&this.previousGlobalFindBufferValue!==v&&(this.searchInput?.inputBox.addToHistory(),this.searchInput?.setValue(v),this.searchInput?.select()),this.previousGlobalFindBufferValue=v}this.ignoreGlobalFindBufferOnNextFocus=!1})),this._register(this.searchInputFocusTracker.onDidBlur(()=>this.searchInputBoxFocused.set(!1))),this.showContextToggle=new te({isChecked:!1,title:I(d.localize("showContext","Toggle Context Lines"),this.keybindingService.lookupKeybinding(re)),icon:oe,hoverDelegate:w("element"),...ae}),this._register(this.showContextToggle.onChange(()=>this.onContextLinesChanged())),t.showContextToggle&&(this.contextLinesInput=new N(n,this.contextViewService,{type:"number",inputBoxStyles:se}),this.contextLinesInput.element.classList.add("context-lines-input"),this.contextLinesInput.value=""+(this.configurationService.getValue("search").searchEditor.defaultNumberOfContextLines??1),this._register(this.contextLinesInput.onDidChange(r=>{r!=="0"&&(this.showContextToggle.checked=!0),this.onContextLinesChanged()})),a.append(n,this.showContextToggle.domNode))}onContextLinesChanged(){this._onDidToggleContext.fire(),this.contextLinesInput.value.includes("-")&&(this.contextLinesInput.value="0"),this._onDidToggleContext.fire()}setContextLines(e){this.contextLinesInput&&(e===0?this.showContextToggle.checked=!1:(this.showContextToggle.checked=!0,this.contextLinesInput.value=""+e))}renderReplaceInput(e,t){this.replaceContainer=a.append(e,a.$(".replace-container.disabled"));const i=a.append(this.replaceContainer,a.$(".replace-input"));this.replaceInput=this._register(new J(i,this.contextViewService,{label:d.localize("label.Replace","Replace: Type replace term and press Enter to preview"),placeholder:d.localize("search.replace.placeHolder","Replace"),appendPreserveCaseLabel:I("",this.keybindingService.lookupKeybinding(u.SearchCommandIds.TogglePreserveCaseId)),history:t.replaceHistory,showHistoryHint:()=>R(this.keybindingService),flexibleHeight:!0,flexibleMaxHeight:h.INPUT_MAX_HEIGHT,inputBoxStyles:t.inputBoxStyles,toggleStyles:t.toggleStyles},this.contextKeyService,!0)),this._register(this.replaceInput.onDidOptionChange(n=>{n||this.replaceInput&&this._onPreserveCaseChange.fire(this.replaceInput.getPreserveCase())})),this._register(this.replaceInput.onKeyDown(n=>this.onReplaceInputKeyDown(n))),this.replaceInput.setValue(t.replaceValue||""),this._register(this.replaceInput.inputBox.onDidChange(()=>this._onReplaceValueChanged.fire())),this._register(this.replaceInput.inputBox.onDidHeightChange(()=>this._onDidHeightChange.fire())),this.replaceAllAction=new f(this),this.replaceAllAction.label=h.REPLACE_ALL_DISABLED_LABEL,this.replaceActionBar=this._register(new H(this.replaceContainer)),this.replaceActionBar.push([this.replaceAllAction],{icon:!0,label:!1}),this.onkeydown(this.replaceActionBar.domNode,n=>this.onReplaceActionbarKeyDown(n)),this.replaceInputFocusTracker=this._register(a.trackFocus(this.replaceInput.inputBox.inputElement)),this._register(this.replaceInputFocusTracker.onDidFocus(()=>this.replaceInputBoxFocused.set(!0))),this._register(this.replaceInputFocusTracker.onDidBlur(()=>this.replaceInputBoxFocused.set(!1))),this._register(this.replaceInput.onPreserveCaseKeyDown(n=>this.onPreserveCaseKeyDown(n)))}triggerReplaceAll(){return this._onReplaceAll.fire(),Promise.resolve(null)}onToggleReplaceButton(){this.replaceContainer?.classList.toggle("disabled"),this.isReplaceShown()?(this.toggleReplaceButton?.element.classList.remove(...m.asClassNameArray(C)),this.toggleReplaceButton?.element.classList.add(...m.asClassNameArray(x))):(this.toggleReplaceButton?.element.classList.remove(...m.asClassNameArray(x)),this.toggleReplaceButton?.element.classList.add(...m.asClassNameArray(C))),this.toggleReplaceButton?.element.setAttribute("aria-expanded",this.isReplaceShown()?"true":"false"),this.updateReplaceActiveState(),this._onReplaceToggled.fire()}setValue(e){this.searchInput?.setValue(e)}setReplaceAllActionState(e){this.replaceAllAction&&this.replaceAllAction.enabled!==e&&(this.replaceAllAction.enabled=e,this.replaceAllAction.label=e?h.REPLACE_ALL_ENABLED_LABEL(this.keybindingService):h.REPLACE_ALL_DISABLED_LABEL,this.updateReplaceActiveState())}updateReplaceActiveState(){const e=this.isReplaceActive(),t=this.isReplaceShown()&&!!this.replaceAllAction?.enabled;e!==t&&(this.replaceActive.set(t),this._onReplaceStateChange.fire(t),this.replaceInput?.inputBox.layout())}validateSearchInput(e){if(e.length===0||!this.searchInput?.getRegex())return null;try{new RegExp(e,"u")}catch(t){return{content:t.message}}return null}onSearchInputChanged(){if(this.searchInput?.clearMessage(),this.setReplaceAllActionState(!1),this.searchConfiguration.searchOnType){const e=this.searchInput&&this.searchInput.isAIEnabled?5:1;if(this.searchInput?.getRegex())try{const t=new RegExp(this.searchInput.getValue(),"ug"),i=`
								~!@#$%^&*()_+
								\`1234567890-=
								qwertyuiop[]\\
								QWERTYUIOP{}|
								asdfghjkl;'
								ASDFGHJKL:"
								zxcvbnm,./
								ZXCVBNM<>? `.match(t)?.length??0,n=i<50?1:i<100?5:10;this.submitSearch(!0,this.searchConfiguration.searchOnTypeDebouncePeriod*n*e)}catch{}else this.submitSearch(!0,this.searchConfiguration.searchOnTypeDebouncePeriod*e)}}onSearchInputKeyDown(e){if(e.equals(T|o.Enter)&&(this.searchInput?.inputBox.insertAtCursor(`
`),e.preventDefault()),e.equals(o.Enter))this.searchInput?.onSearchSubmit(),this.submitSearch(),e.preventDefault();else if(e.equals(o.Escape))this._onSearchCancel.fire({focus:!0}),e.preventDefault();else if(e.equals(o.Tab))this.isReplaceShown()?this.replaceInput?.focus():this.searchInput?.focusOnCaseSensitive(),e.preventDefault();else if(e.equals(o.UpArrow))D(e,this.searchInput?.getValue()??"",this.searchInput?.domNode.querySelector("textarea")??null);else if(e.equals(o.DownArrow))L(e,this.searchInput?.getValue()??"",this.searchInput?.domNode.querySelector("textarea")??null);else if(e.equals(o.PageUp)){const t=this.searchInput?.inputBox.inputElement;t&&(t.setSelectionRange(0,0),t.focus(),e.preventDefault())}else if(e.equals(o.PageDown)){const t=this.searchInput?.inputBox.inputElement;if(t){const i=t.value.length;t.setSelectionRange(i,i),t.focus(),e.preventDefault()}}}onCaseSensitiveKeyDown(e){e.equals(g.Shift|o.Tab)&&this.isReplaceShown()&&(this.replaceInput?.focus(),e.preventDefault())}onRegexKeyDown(e){e.equals(o.Tab)&&this.isReplaceShown()&&(this.replaceInput?.focusOnPreserve(),e.preventDefault())}onPreserveCaseKeyDown(e){e.equals(o.Tab)?(this.isReplaceActive()?this.focusReplaceAllAction():this._onBlur.fire(),e.preventDefault()):e.equals(g.Shift|o.Tab)&&(this.focusRegexAction(),e.preventDefault())}onReplaceInputKeyDown(e){e.equals(T|o.Enter)&&(this.replaceInput?.inputBox.insertAtCursor(`
`),e.preventDefault()),e.equals(o.Enter)?(this.submitSearch(),e.preventDefault()):e.equals(o.Tab)?(this.searchInput?.focusOnCaseSensitive(),e.preventDefault()):e.equals(g.Shift|o.Tab)?(this.searchInput?.focus(),e.preventDefault()):e.equals(o.UpArrow)?D(e,this.replaceInput?.getValue()??"",this.replaceInput?.domNode.querySelector("textarea")??null):e.equals(o.DownArrow)&&L(e,this.replaceInput?.getValue()??"",this.replaceInput?.domNode.querySelector("textarea")??null)}onReplaceActionbarKeyDown(e){e.equals(g.Shift|o.Tab)&&(this.focusRegexAction(),e.preventDefault())}async submitSearch(e=!1,t=0){if(this.searchInput?.validate(),!this.searchInput?.inputBox.isInputValid())return;const i=this.searchInput.getValue(),n=this.searchConfiguration.globalFindClipboard;i&&n&&await this.clipboardServce.writeFindText(i),this._onSearchSubmit.fire({triggeredOnType:e,delay:t})}getContextLines(){return this.showContextToggle.checked?+this.contextLinesInput.value:0}modifyContextLines(e){const i=+this.contextLinesInput.value+(e?1:-1);this.showContextToggle.checked=i!==0,this.contextLinesInput.value=""+i}toggleContextLines(){this.showContextToggle.checked=!this.showContextToggle.checked,this.onContextLinesChanged()}dispose(){this.setReplaceAllActionState(!1),super.dispose()}get searchConfiguration(){return this.configurationService.getValue("search")}};h=y([c(2,U),c(3,G),c(4,X),c(5,M),c(6,q),c(7,Z),c(8,z),c(9,ce),c(10,pe)],h);function ft(){$.registerCommandAndKeybindingRule({id:f.ID,weight:j.WorkbenchContrib,when:W.and(u.SearchContext.SearchViewVisibleKey,u.SearchContext.ReplaceActiveKey,P),primary:g.Alt|g.CtrlCmd|o.Enter,handler:l=>{const s=l.get(ie);if(Q(s)){const e=Y(s);e&&new f(e.searchAndReplaceWidget).run()}}})}export{h as SearchWidget,ft as registerContributions};
