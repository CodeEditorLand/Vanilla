import"../../../../../vs/base/browser/ui/tree/tree.js";import{equals as j}from"../../../../../vs/base/common/arrays.js";import{KeyCode as m,KeyMod as d}from"../../../../../vs/base/common/keyCodes.js";import*as g from"../../../../../vs/nls.js";import{Action2 as y,MenuId as u,registerAction2 as x}from"../../../../../vs/platform/actions/common/actions.js";import{IConfigurationService as E}from"../../../../../vs/platform/configuration/common/configuration.js";import{ContextKeyExpr as h}from"../../../../../vs/platform/contextkey/common/contextkey.js";import"../../../../../vs/platform/instantiation/common/instantiation.js";import{KeybindingWeight as I}from"../../../../../vs/platform/keybinding/common/keybindingsRegistry.js";import{getSelectionKeyboardEvent as R}from"../../../../../vs/platform/list/browser/listService.js";import{IUriIdentityService as D}from"../../../../../vs/platform/uriIdentity/common/uriIdentity.js";import{IReplaceService as z}from"../../../../../vs/workbench/contrib/search/browser/replace.js";import{category as v,getElementsToOperateOn as V,getSearchView as k,shouldRefocus as N}from"../../../../../vs/workbench/contrib/search/browser/searchActionsBase.js";import{searchRemoveIcon as q,searchReplaceIcon as F}from"../../../../../vs/workbench/contrib/search/browser/searchIcons.js";import{arrayContainsElementOrParent as C,FileMatch as b,FolderMatch as K,Match as S,MatchInNotebook as L,SearchResult as T}from"../../../../../vs/workbench/contrib/search/browser/searchModel.js";import"../../../../../vs/workbench/contrib/search/browser/searchView.js";import*as e from"../../../../../vs/workbench/contrib/search/common/constants.js";import{IEditorService as U}from"../../../../../vs/workbench/services/editor/common/editorService.js";import"../../../../../vs/workbench/services/search/common/search.js";import{IViewsService as P}from"../../../../../vs/workbench/services/views/common/viewsService.js";x(class extends y{constructor(){super({id:e.SearchCommandIds.RemoveActionId,title:g.localize2("RemoveAction.label","Dismiss"),category:v,icon:q,keybinding:{weight:I.WorkbenchContrib,when:h.and(e.SearchContext.SearchViewVisibleKey,e.SearchContext.FileMatchOrMatchFocusKey),primary:m.Delete,mac:{primary:d.CtrlCmd|m.Backspace}},menu:[{id:u.SearchContext,group:"search",order:2},{id:u.SearchActionMenu,group:"inline",order:2}]})}run(t,r){const i=t.get(P),p=t.get(E),l=k(i);if(!l)return;let f=r?.element,c=r?.viewer;c||(c=l.getControl()),f||(f=c.getFocus()[0]??void 0);const a=V(c,f,p.getValue("search"));let o=c.getFocus()[0]??void 0;if(a.length===0)return;(!o||o instanceof T)&&(o=f);let s;const A=N(a,o);o&&A&&(s=W(c,o,a));const M=l.searchResult;M&&M.batchRemove(a),o&&A?(s||(s=O(c,o)),s&&!C(s,a)&&(c.reveal(s),c.setFocus([s],R()),c.setSelection([s],R()))):j(c.getFocus(),c.getSelection())||c.setSelection(c.getFocus()),c.domFocus()}}),x(class extends y{constructor(){super({id:e.SearchCommandIds.ReplaceActionId,title:g.localize2("match.replace.label","Replace"),category:v,keybinding:{weight:I.WorkbenchContrib,when:h.and(e.SearchContext.SearchViewVisibleKey,e.SearchContext.ReplaceActiveKey,e.SearchContext.MatchFocusKey,e.SearchContext.IsEditableItemKey),primary:d.Shift|d.CtrlCmd|m.Digit1},icon:F,menu:[{id:u.SearchContext,when:h.and(e.SearchContext.ReplaceActiveKey,e.SearchContext.MatchFocusKey,e.SearchContext.IsEditableItemKey),group:"search",order:1},{id:u.SearchActionMenu,when:h.and(e.SearchContext.ReplaceActiveKey,e.SearchContext.MatchFocusKey,e.SearchContext.IsEditableItemKey),group:"inline",order:1}]})}async run(t,r){return w(t,r)}}),x(class extends y{constructor(){super({id:e.SearchCommandIds.ReplaceAllInFileActionId,title:g.localize2("file.replaceAll.label","Replace All"),category:v,keybinding:{weight:I.WorkbenchContrib,when:h.and(e.SearchContext.SearchViewVisibleKey,e.SearchContext.ReplaceActiveKey,e.SearchContext.FileFocusKey,e.SearchContext.IsEditableItemKey),primary:d.Shift|d.CtrlCmd|m.Digit1,secondary:[d.CtrlCmd|d.Shift|m.Enter]},icon:F,menu:[{id:u.SearchContext,when:h.and(e.SearchContext.ReplaceActiveKey,e.SearchContext.FileFocusKey,e.SearchContext.IsEditableItemKey),group:"search",order:1},{id:u.SearchActionMenu,when:h.and(e.SearchContext.ReplaceActiveKey,e.SearchContext.FileFocusKey,e.SearchContext.IsEditableItemKey),group:"inline",order:1}]})}async run(t,r){return w(t,r)}}),x(class extends y{constructor(){super({id:e.SearchCommandIds.ReplaceAllInFolderActionId,title:g.localize2("file.replaceAll.label","Replace All"),category:v,keybinding:{weight:I.WorkbenchContrib,when:h.and(e.SearchContext.SearchViewVisibleKey,e.SearchContext.ReplaceActiveKey,e.SearchContext.FolderFocusKey,e.SearchContext.IsEditableItemKey),primary:d.Shift|d.CtrlCmd|m.Digit1,secondary:[d.CtrlCmd|d.Shift|m.Enter]},icon:F,menu:[{id:u.SearchContext,when:h.and(e.SearchContext.ReplaceActiveKey,e.SearchContext.FolderFocusKey,e.SearchContext.IsEditableItemKey),group:"search",order:1},{id:u.SearchActionMenu,when:h.and(e.SearchContext.ReplaceActiveKey,e.SearchContext.FolderFocusKey,e.SearchContext.IsEditableItemKey),group:"inline",order:1}]})}async run(t,r){return w(t,r)}});function w(n,t){const r=n.get(E),i=n.get(P),p=k(i),l=t?.viewer??p?.getControl();if(!l)return;const f=t?.element??l.getFocus()[0],c=V(l,f??void 0,r.getValue("search"));let a=l.getFocus()[0];if((!a||a&&!C(a,c)||a instanceof T)&&(a=f),c.length===0)return;let o;a&&(o=W(l,a,c));const s=p?.searchResult;s&&s.batchReplace(c),a&&(o||(o=O(l,a)),o&&(l.reveal(o),l.setFocus([o],R()),l.setSelection([o],R()),o instanceof S?!r.getValue().search.useReplacePreview||B(n,o)||o instanceof L?p?.open(o,!0):n.get(z).openReplacePreview(o,!0):o instanceof b&&p?.open(o,!0))),l.domFocus()}function B(n,t){if(!(t instanceof S))return!1;const i=n.get(U).activeEditor?.resource;return i?n.get(D).extUri.isEqual(i,t.parent().resource):!1}function G(n,t){return n instanceof S?t instanceof S?0:-1:n instanceof b?t instanceof S?1:t instanceof b?0:-1:t instanceof K?0:1}function W(n,t,r){const i=n.navigate(t);if(t instanceof K)for(;i.next()&&(!(i.current()instanceof K)||C(i.current(),r)););else if(t instanceof b)for(;i.next()&&(!(i.current()instanceof b)||C(i.current(),r));)n.expand(i.current());else for(;i.next()&&(!(i.current()instanceof S)||C(i.current(),r));)n.expand(i.current());return i.current()}function O(n,t){let r=n.lastVisibleElement??null;for(;r;){const i=G(t,r);if(i===-1)n.expand(r),r=n.lastVisibleElement;else if(i===1)r=n.getParentElement(r);else return r}}export{W as getElementToFocusAfterRemoved,O as getLastNodeFromSameType};
