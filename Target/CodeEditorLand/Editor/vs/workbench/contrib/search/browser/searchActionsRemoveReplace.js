import{equals as j}from"../../../../base/common/arrays.js";import{KeyCode as m,KeyMod as h}from"../../../../base/common/keyCodes.js";import*as g from"../../../../nls.js";import{Action2 as y,MenuId as u,registerAction2 as x}from"../../../../platform/actions/common/actions.js";import{IConfigurationService as E}from"../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as d}from"../../../../platform/contextkey/common/contextkey.js";import{KeybindingWeight as v}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{getSelectionKeyboardEvent as I}from"../../../../platform/list/browser/listService.js";import{IUriIdentityService as D}from"../../../../platform/uriIdentity/common/uriIdentity.js";import{IEditorService as z}from"../../../services/editor/common/editorService.js";import{IViewsService as V}from"../../../services/views/common/viewsService.js";import*as e from"../common/constants.js";import{IReplaceService as N}from"./replace.js";import{category as R,getElementsToOperateOn as k,getSearchView as T,shouldRefocus as q}from"./searchActionsBase.js";import{searchRemoveIcon as L,searchReplaceIcon as F}from"./searchIcons.js";import{FileMatch as C,FolderMatch as K,Match as S,MatchInNotebook as U,SearchResult as P,arrayContainsElementOrParent as b}from"./searchModel.js";x(class extends y{constructor(){super({id:e.SearchCommandIds.RemoveActionId,title:g.localize2("RemoveAction.label","Dismiss"),category:R,icon:L,keybinding:{weight:v.WorkbenchContrib,when:d.and(e.SearchContext.SearchViewVisibleKey,e.SearchContext.FileMatchOrMatchFocusKey),primary:m.Delete,mac:{primary:h.CtrlCmd|m.Backspace}},menu:[{id:u.SearchContext,group:"search",order:2},{id:u.SearchActionMenu,group:"inline",order:2}]})}run(t,r){const i=t.get(V),p=t.get(E),s=T(i);if(!s)return;let f=r?.element,c=r?.viewer;c||(c=s.getControl()),f||(f=c.getFocus()[0]??void 0);const a=k(c,f,p.getValue("search"));let o=c.getFocus()[0]??void 0;if(a.length===0)return;(!o||o instanceof P)&&(o=f);let l;const A=q(a,o);o&&A&&(l=W(c,o,a));const M=s.searchResult;M&&M.batchRemove(a),o&&A?(l||(l=O(c,o)),l&&!b(l,a)&&(c.reveal(l),c.setFocus([l],I()),c.setSelection([l],I()))):j(c.getFocus(),c.getSelection())||c.setSelection(c.getFocus()),c.domFocus()}}),x(class extends y{constructor(){super({id:e.SearchCommandIds.ReplaceActionId,title:g.localize2("match.replace.label","Replace"),category:R,keybinding:{weight:v.WorkbenchContrib,when:d.and(e.SearchContext.SearchViewVisibleKey,e.SearchContext.ReplaceActiveKey,e.SearchContext.MatchFocusKey,e.SearchContext.IsEditableItemKey),primary:h.Shift|h.CtrlCmd|m.Digit1},icon:F,menu:[{id:u.SearchContext,when:d.and(e.SearchContext.ReplaceActiveKey,e.SearchContext.MatchFocusKey,e.SearchContext.IsEditableItemKey),group:"search",order:1},{id:u.SearchActionMenu,when:d.and(e.SearchContext.ReplaceActiveKey,e.SearchContext.MatchFocusKey,e.SearchContext.IsEditableItemKey),group:"inline",order:1}]})}async run(t,r){return w(t,r)}}),x(class extends y{constructor(){super({id:e.SearchCommandIds.ReplaceAllInFileActionId,title:g.localize2("file.replaceAll.label","Replace All"),category:R,keybinding:{weight:v.WorkbenchContrib,when:d.and(e.SearchContext.SearchViewVisibleKey,e.SearchContext.ReplaceActiveKey,e.SearchContext.FileFocusKey,e.SearchContext.IsEditableItemKey),primary:h.Shift|h.CtrlCmd|m.Digit1,secondary:[h.CtrlCmd|h.Shift|m.Enter]},icon:F,menu:[{id:u.SearchContext,when:d.and(e.SearchContext.ReplaceActiveKey,e.SearchContext.FileFocusKey,e.SearchContext.IsEditableItemKey),group:"search",order:1},{id:u.SearchActionMenu,when:d.and(e.SearchContext.ReplaceActiveKey,e.SearchContext.FileFocusKey,e.SearchContext.IsEditableItemKey),group:"inline",order:1}]})}async run(t,r){return w(t,r)}}),x(class extends y{constructor(){super({id:e.SearchCommandIds.ReplaceAllInFolderActionId,title:g.localize2("file.replaceAll.label","Replace All"),category:R,keybinding:{weight:v.WorkbenchContrib,when:d.and(e.SearchContext.SearchViewVisibleKey,e.SearchContext.ReplaceActiveKey,e.SearchContext.FolderFocusKey,e.SearchContext.IsEditableItemKey),primary:h.Shift|h.CtrlCmd|m.Digit1,secondary:[h.CtrlCmd|h.Shift|m.Enter]},icon:F,menu:[{id:u.SearchContext,when:d.and(e.SearchContext.ReplaceActiveKey,e.SearchContext.FolderFocusKey,e.SearchContext.IsEditableItemKey),group:"search",order:1},{id:u.SearchActionMenu,when:d.and(e.SearchContext.ReplaceActiveKey,e.SearchContext.FolderFocusKey,e.SearchContext.IsEditableItemKey),group:"inline",order:1}]})}async run(t,r){return w(t,r)}});function w(n,t){const r=n.get(E),i=n.get(V),p=T(i),s=t?.viewer??p?.getControl();if(!s)return;const f=t?.element??s.getFocus()[0],c=k(s,f??void 0,r.getValue("search"));let a=s.getFocus()[0];if((!a||a&&!b(a,c)||a instanceof P)&&(a=f),c.length===0)return;let o;a&&(o=W(s,a,c));const l=p?.searchResult;l&&l.batchReplace(c),a&&(o||(o=O(s,a)),o&&(s.reveal(o),s.setFocus([o],I()),s.setSelection([o],I()),o instanceof S?!r.getValue().search.useReplacePreview||B(n,o)||o instanceof U?p?.open(o,!0):n.get(N).openReplacePreview(o,!0):o instanceof C&&p?.open(o,!0))),s.domFocus()}function B(n,t){if(!(t instanceof S))return!1;const i=n.get(z).activeEditor?.resource;return i?n.get(D).extUri.isEqual(i,t.parent().resource):!1}function G(n,t){return n instanceof S?t instanceof S?0:-1:n instanceof C?t instanceof S?1:t instanceof C?0:-1:t instanceof K?0:1}function W(n,t,r){const i=n.navigate(t);if(t instanceof K)for(;i.next()&&(!(i.current()instanceof K)||b(i.current(),r)););else if(t instanceof C)for(;i.next()&&(!(i.current()instanceof C)||b(i.current(),r));)n.expand(i.current());else for(;i.next()&&(!(i.current()instanceof S)||b(i.current(),r));)n.expand(i.current());return i.current()}function O(n,t){let r=n.lastVisibleElement??null;for(;r;){const i=G(t,r);if(i===-1)n.expand(r),r=n.lastVisibleElement;else if(i===1)r=n.getParentElement(r);else return r}}export{W as getElementToFocusAfterRemoved,O as getLastNodeFromSameType};
