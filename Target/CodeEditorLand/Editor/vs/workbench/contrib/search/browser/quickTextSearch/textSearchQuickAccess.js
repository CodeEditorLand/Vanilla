var F=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var b=(S,l,e,t)=>{for(var r=t>1?void 0:t?O(l,e):l,i=S.length-1,c;i>=0;i--)(c=S[i])&&(r=(t?c(l,e,r):c(r))||r);return t&&r&&F(l,e,r),r},h=(S,l)=>(e,t)=>l(e,t,S);import{Sequencer as x}from"../../../../../base/common/async.js";import{CancellationTokenSource as V}from"../../../../../base/common/cancellation.js";import{Codicon as B}from"../../../../../base/common/codicons.js";import{Event as v}from"../../../../../base/common/event.js";import{DisposableStore as D}from"../../../../../base/common/lifecycle.js";import{ResourceSet as L}from"../../../../../base/common/map.js";import{basenameOrAuthority as W,dirname as U}from"../../../../../base/common/resources.js";import{ThemeIcon as g}from"../../../../../base/common/themables.js";import{localize as d}from"../../../../../nls.js";import{IConfigurationService as q}from"../../../../../platform/configuration/common/configuration.js";import{IInstantiationService as H}from"../../../../../platform/instantiation/common/instantiation.js";import{ILabelService as N}from"../../../../../platform/label/common/label.js";import{getSelectionKeyboardEvent as _}from"../../../../../platform/list/browser/listService.js";import{PickerQuickAccessProvider as K,TriggerAction as A}from"../../../../../platform/quickinput/browser/pickerQuickAccess.js";import{DefaultQuickAccessFilterValue as j}from"../../../../../platform/quickinput/common/quickAccess.js";import{QuickInputButtonLocation as X,QuickInputHideReason as G}from"../../../../../platform/quickinput/common/quickInput.js";import{IWorkspaceContextService as $}from"../../../../../platform/workspace/common/workspace.js";import{PickerEditorState as Y}from"../../../../browser/quickaccess.js";import{ACTIVE_GROUP as z,IEditorService as J,SIDE_GROUP as Z}from"../../../../services/editor/common/editorService.js";import{QueryBuilder as ee}from"../../../../services/search/common/queryBuilder.js";import{VIEW_ID as y}from"../../../../services/search/common/search.js";import{IViewsService as te}from"../../../../services/views/common/viewsService.js";import{getOutOfWorkspaceEditorResources as re}from"../../common/search.js";import{searchActivityBarIcon as ie,searchDetailsIcon as w,searchOpenInFileIcon as oe}from"../searchIcons.js";import{SearchModel as E,SearchModelLocation as k,searchComparer as se}from"../searchModel.js";import{getEditorSelectionFromMatch as ce}from"../searchView.js";const C="%",ne={_reason:"quickAccessSearch",disregardIgnoreFiles:!1,disregardExcludeSettings:!1,onlyOpenEditors:!1,expandPatterns:!0},M=30,ae=10,le=75;let I=class extends K{constructor(e,t,r,i,c,o){super(C,{canAcceptInBackground:!0,shouldSkipTrimPickFilter:!0});this._instantiationService=e;this._contextService=t;this._editorService=r;this._labelService=i;this._viewsService=c;this._configurationService=o;this.queryBuilder=this._instantiationService.createInstance(ee),this.searchModel=this._register(this._instantiationService.createInstance(E)),this.editorViewState=this._register(this._instantiationService.createInstance(Y)),this.searchModel.location=k.QUICK_ACCESS,this.editorSequencer=new x}editorSequencer;queryBuilder;searchModel;currentAsyncSearch=Promise.resolve({results:[],messages:[]});editorViewState;_getTextQueryBuilderOptions(e){return{...ne,extraFileResources:this._instantiationService.invokeFunction(re),maxResults:this.configuration.maxResults??void 0,isSmartCase:this.configuration.smartCase,previewOptions:{matchLines:1,charsPerLine:e}}}dispose(){this.searchModel.dispose(),super.dispose()}provide(e,t,r){const i=new D;C.length<e.value.length&&(e.valueSelection=[C.length,e.value.length]),e.buttons=[{location:X.Inline,iconClass:g.asClassName(B.goToSearch),tooltip:d("goToSearch","See in Search Panel")}],this.editorViewState.reset(),i.add(e.onDidTriggerButton(()=>{this.searchModel.searchResult.count()>0?this.moveToSearchViewlet(void 0):this._viewsService.openView(y,!0),e.hide()}));const c=()=>{const[o]=e.activeItems;if(o?.match){this.editorViewState.set();const s=o.match;this.editorSequencer.queue(async()=>{await this.editorViewState.openTransientEditor({resource:s.parent().resource,options:{preserveFocus:!0,revealIfOpened:!0,ignoreError:!0,selection:s.range()}})})}};return i.add(v.debounce(e.onDidChangeActive,(o,s)=>s,le,!0)(c)),i.add(v.once(e.onWillHide)(({reason:o})=>{o===G.Gesture&&this.editorViewState.restore()})),i.add(v.once(e.onDidHide)(({reason:o})=>{this.searchModel.searchResult.toggleHighlights(!1)})),i.add(super.provide(e,t,r)),i.add(e.onDidAccept(()=>this.searchModel.searchResult.toggleHighlights(!1))),i}get configuration(){const e=this._configurationService.getValue().workbench?.editor,t=this._configurationService.getValue().search;return{openEditorPinned:!e?.enablePreviewFromQuickOpen||!e?.enablePreview,preserveInput:t.quickAccess.preserveInput,maxResults:t.maxResults,smartCase:t.smartCase,sortOrder:t.sortOrder}}get defaultFilterValue(){if(this.configuration.preserveInput)return j.LAST}doSearch(e,t){if(e==="")return;const r=this._contextService.getWorkspace().folders,i={pattern:e};this.searchModel.searchResult.toggleHighlights(!1);const c=i.isRegExp?1e4:1e3,o=this.queryBuilder.text(i,r.map(n=>n.uri),this._getTextQueryBuilderOptions(c)),s=this.searchModel.search(o,void 0,t),a=async()=>{this.currentAsyncSearch=s.asyncResults,await s.asyncResults;const n=new L(s.syncResults.map(p=>p.resource));return this.searchModel.searchResult.matches().filter(p=>!n.has(p.resource))};return{syncResults:this.searchModel.searchResult.matches(),asyncResults:a()}}moveToSearchViewlet(e){this._viewsService.openView(y,!1);const t=this._viewsService.getActiveViewWithId(y);t.replaceSearchModel(this.searchModel,this.currentAsyncSearch),this.searchModel=this._instantiationService.createInstance(E),this.searchModel.location=k.QUICK_ACCESS;const r=t?.getControl();e?(r.setFocus([e],_()),r.setSelection([e],_()),r.reveal(e)):t.searchAndReplaceWidget.focus()}_getPicksFromMatches(e,t,r){e=e.sort((o,s)=>{if(r){if(r===o.resource)return-1;if(r===s.resource)return 1}return se(o,s,this.configuration.sortOrder)});const i=e.length>t?e.slice(0,t):e,c=[];for(let o=0;o<e.length;o++){if(o===t){c.push({type:"separator"}),c.push({label:d("QuickSearchSeeMoreFiles","See More Files"),iconClass:g.asClassName(w),accept:async()=>{this.moveToSearchViewlet(e[t])}});break}const s=i[o],a=W(s.resource),n=this._labelService.getUriLabel(U(s.resource),{relative:!0});c.push({label:a,type:"separator",description:n,buttons:[{iconClass:g.asClassName(oe),tooltip:d("QuickSearchOpenInFile","Open File")}],trigger:async()=>(await this.handleAccept(s,{}),A.CLOSE_PICKER)});const p=s.matches()??[];for(let f=0;f<p.length;f++){const u=p[f];if(f===ae){c.push({label:d("QuickSearchMore","More"),iconClass:g.asClassName(w),accept:async()=>{this.moveToSearchViewlet(u)}});break}const m=u.preview(),P=(m.before+m.inside+m.after).trim().substring(0,999),T=[{start:m.before.length,end:m.before.length+m.inside.length}];c.push({label:`${P}`,highlights:{label:T},buttons:[{iconClass:g.asClassName(ie),tooltip:d("showMore","See in Search Panel")}],ariaLabel:`Match at location ${u.range().startLineNumber}:${u.range().startColumn} - ${P}`,accept:async(Q,R)=>{await this.handleAccept(s,{keyMods:Q,selection:ce(u,this.searchModel),preserveFocus:R.inBackground,forcePinned:R.inBackground})},trigger:()=>(this.moveToSearchViewlet(u),A.CLOSE_PICKER),match:u})}}return c}async handleAccept(e,t){const r={preserveFocus:t.preserveFocus,pinned:t.keyMods?.ctrlCmd||t.forcePinned||this.configuration.openEditorPinned,selection:t.selection},i=t.keyMods?.alt||this.configuration.openEditorPinned&&t.keyMods?.ctrlCmd||t.forceOpenSideBySide?Z:z;await this._editorService.openEditor({resource:e.resource,options:r},i)}_getPicks(e,t,r){const i=this.searchModel;if(e==="")return this.searchModel.searchResult.clear(),[{label:d("enterSearchTerm","Enter a term to search for across your files.")}];const c=t.add(new V);t.add(r.onCancellationRequested(()=>{i.location===k.QUICK_ACCESS&&c.cancel()}));const o=this.doSearch(e,c.token);if(!o)return null;const s=o.syncResults,a=this._getPicksFromMatches(s,M,this._editorService.activeEditor?.resource);return a.length>0&&this.searchModel.searchResult.toggleHighlights(!0),s.length>=M?a:{picks:a,additionalPicks:o.asyncResults.then(n=>n.length+a.length===0?[{label:d("noAnythingResults","No matching results")}]:this._getPicksFromMatches(n,M-s.length)).then(n=>(n.length>0&&this.searchModel.searchResult.toggleHighlights(!0),n))}}};I=b([h(0,H),h(1,$),h(2,J),h(3,N),h(4,te),h(5,q)],I);export{C as TEXT_SEARCH_QUICK_ACCESS_PREFIX,I as TextSearchQuickAccess};
