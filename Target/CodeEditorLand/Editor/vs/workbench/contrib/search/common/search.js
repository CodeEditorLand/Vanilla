import{groupBy as d}from"../../../../base/common/arrays.js";import{CancellationToken as f}from"../../../../base/common/cancellation.js";import{onUnexpectedExternalError as y}from"../../../../base/common/errors.js";import{compare as m}from"../../../../base/common/strings.js";import{isNumber as c}from"../../../../base/common/types.js";import{Range as l}from"../../../../editor/common/core/range.js";import{RawContextKey as b}from"../../../../platform/contextkey/common/contextkey.js";import{IFileService as g}from"../../../../platform/files/common/files.js";import{IWorkspaceContextService as S}from"../../../../platform/workspace/common/workspace.js";import{EditorResourceAccessor as I,SideBySideEditor as k}from"../../../common/editor.js";import{IEditorService as v}from"../../../services/editor/common/editorService.js";var p;(o=>{const r=[];function a(s){let e=s;return e&&r.push(e),{dispose(){if(e){const n=r.indexOf(e);n>=0&&(r.splice(n,1),e=void 0)}}}}o.register=a;function t(){return r.slice(0)}o.all=t})(p||={});class W{constructor(a,t){this.symbol=a;this.provider=t}}async function F(r,a=f.None){const t=[],o=p.all().map(async e=>{try{const n=await e.provideWorkspaceSymbols(r,a);if(!n)return;for(const i of n)t.push(new W(i,e))}catch(n){y(n)}});if(await Promise.all(o),a.isCancellationRequested)return[];function s(e,n){let i=m(e.symbol.name,n.symbol.name);return i===0&&(i=e.symbol.kind-n.symbol.kind),i===0&&(i=m(e.symbol.location.uri.toString(),n.symbol.location.uri.toString())),i===0&&(e.symbol.location.range&&n.symbol.location.range?l.areIntersecting(e.symbol.location.range,n.symbol.location.range)||(i=l.compareRangesUsingStarts(e.symbol.location.range,n.symbol.location.range)):e.provider.resolveWorkspaceSymbol&&!n.provider.resolveWorkspaceSymbol?i=-1:!e.provider.resolveWorkspaceSymbol&&n.provider.resolveWorkspaceSymbol&&(i=1)),i===0&&(i=m(e.symbol.containerName??"",n.symbol.containerName??"")),i}return d(t,s).flatMap(e=>e[0])}function j(r){const a=r.get(v),t=r.get(S),o=r.get(g);return a.editors.map(e=>I.getOriginalUri(e,{supportSideBySide:k.PRIMARY})).filter(e=>!!e&&!t.isInsideWorkspace(e)&&o.hasProvider(e))}const u=/\s?[#:(](?:line )?(\d*)(?:[#:,](\d*))?\)?:?\s*$/;function K(r,a){if(!r||a?.some(s=>{const e=r.indexOf(s);return e===0||e>0&&!u.test(r.substring(e+1))}))return;let t;const o=u.exec(r);if(o){const s=Number.parseInt(o[1]??"",10);if(c(s)){t={startLineNumber:s,startColumn:1,endLineNumber:s,endColumn:1};const e=Number.parseInt(o[2]??"",10);c(e)&&(t={startLineNumber:t.startLineNumber,startColumn:e,endLineNumber:t.endLineNumber,endColumn:e})}else o[1]===""&&(t={startLineNumber:1,startColumn:1,endLineNumber:1,endColumn:1})}if(o&&t)return{filter:r.substr(0,o.index),range:t}}var x=(o=>(o[o.Idle=0]="Idle",o[o.Searching=1]="Searching",o[o.SlowSearch=2]="SlowSearch",o))(x||{});const B=new b("searchState",0);export{B as SearchStateKey,x as SearchUIState,W as WorkspaceSymbolItem,p as WorkspaceSymbolProviderRegistry,K as extractRangeFromFilter,j as getOutOfWorkspaceEditorResources,F as getWorkspaceSymbols};
