import o from"assert";import{Range as t}from"../../../../../editor/common/core/range.js";import{FindMatch as p}from"../../../../../editor/common/model.js";import{QueryType as E}from"../../../../services/search/common/search.js";import"../../../notebook/browser/notebookBrowser.js";import{CellKind as T}from"../../../notebook/common/notebookCommon.js";import{contentMatchesToTextSearchMatches as I,webviewMatchesToTextSearchMatches as L}from"../../browser/notebookSearch/searchNotebookHelpers.js";import{CellFindMatchModel as b}from"../../../notebook/browser/contrib/find/findModel.js";import{CellMatch as v,FileMatch as q,FolderMatch as R,SearchModel as F,textSearchMatchesToNotebookMatches as g}from"../../browser/searchModel.js";import{URI as S}from"../../../../../base/common/uri.js";import{TestInstantiationService as N}from"../../../../../platform/instantiation/test/common/instantiationServiceMock.js";import{createFileUriFromPathFromRoot as k,stubModelService as y,stubNotebookEditorService as B}from"./searchTestCommon.js";import{IModelService as P}from"../../../../../editor/common/services/model.js";import{INotebookEditorService as V}from"../../../notebook/browser/services/notebookEditorService.js";import{ensureNoDisposablesAreLeakedInTestSuite as W}from"../../../../../base/test/common/utils.js";suite("searchNotebookHelpers",()=>{let l,C,f,m,w,h,d,i;const u=W();let x=0;setup(()=>{l=new N,u.add(l);const r=y(l,n=>u.add(n)),M=B(l,n=>u.add(n));l.stub(P,r),l.stub(V,M),m={id:"mdCell",cellKind:T.Markup,textBuffer:{getLineContent(n){return n===1?"# Hello World Test":""}}};const e=[new p(new t(1,15,1,19),["Test"])];w={id:"codeCell",cellKind:T.Code,textBuffer:{getLineContent(n){return n===1?'print("test! testing!!")':n===2?'print("this is a Test")':""}}};const s=[new p(new t(1,8,1,12),["test"]),new p(new t(1,14,1,18),["test"]),new p(new t(2,18,2,22),["Test"])],a=[{index:0,searchPreviewInfo:{line:"test! testing!!",range:{start:1,end:5}}},{index:1,searchPreviewInfo:{line:"test! testing!!",range:{start:7,end:11}}},{index:3,searchPreviewInfo:{line:"this is a Test",range:{start:11,end:15}}}];C=new b(m,0,e,[]),f=new b(w,5,s,a)}),teardown(()=>{l.dispose()}),suite("notebookEditorMatchesToTextSearchResults",()=>{function r(e,s){Array.isArray(e)||(e=[e]),o.strictEqual(e.length,s.length),e.forEach((a,n)=>{const c=s[n];o.deepStrictEqual({startLineNumber:a.startLineNumber,startColumn:a.startColumn,endLineNumber:a.endLineNumber,endColumn:a.endColumn},{startLineNumber:c.startLineNumber,startColumn:c.startColumn,endLineNumber:c.endLineNumber,endColumn:c.endColumn})})}test("convert CellFindMatchModel to ITextSearchMatch and check results",()=>{h=I(C.contentMatches,m),d=I(f.contentMatches,w),i=L(f.webviewMatches),o.strictEqual(h.length,1),o.strictEqual(h[0].previewText,`# Hello World Test
`),r(h[0].rangeLocations.map(e=>e.preview),[new t(0,14,0,18)]),r(h[0].rangeLocations.map(e=>e.source),[new t(0,14,0,18)]),o.strictEqual(d.length,2),o.strictEqual(d[0].previewText,`print("test! testing!!")
`),o.strictEqual(d[1].previewText,`print("this is a Test")
`),r(d[0].rangeLocations.map(e=>e.preview),[new t(0,7,0,11),new t(0,13,0,17)]),r(d[0].rangeLocations.map(e=>e.source),[new t(0,7,0,11),new t(0,13,0,17)]),o.strictEqual(i.length,3),o.strictEqual(i[0].previewText,"test! testing!!"),o.strictEqual(i[1].previewText,"test! testing!!"),o.strictEqual(i[2].previewText,"this is a Test"),r(i[0].rangeLocations.map(e=>e.preview),[new t(0,1,0,5)]),r(i[1].rangeLocations.map(e=>e.preview),[new t(0,7,0,11)]),r(i[2].rangeLocations.map(e=>e.preview),[new t(0,11,0,15)]),r(i[0].rangeLocations.map(e=>e.source),[new t(0,1,0,5)]),r(i[1].rangeLocations.map(e=>e.source),[new t(0,7,0,11)]),r(i[2].rangeLocations.map(e=>e.source),[new t(0,11,0,15)])}),test("convert ITextSearchMatch to MatchInNotebook",()=>{const e=new v(M(),m,0),s=g(h,e),a=new v(M(),w,0),n=g(d,a),c=g(i,a);o.strictEqual(s[0].cell?.id,e.id),r(s[0].range(),[new t(1,15,1,19)]),o.strictEqual(n[0].cell?.id,a.id),o.strictEqual(n[1].cell?.id,a.id),r(n[0].range(),[new t(1,8,1,12)]),r(n[1].range(),[new t(1,14,1,18)]),r(n[2].range(),[new t(2,18,2,22)]),o.strictEqual(c[0].cell?.id,a.id),o.strictEqual(c[1].cell?.id,a.id),o.strictEqual(c[2].cell?.id,a.id),r(c[0].range(),[new t(1,2,1,6)]),r(c[1].range(),[new t(1,8,1,12)]),r(c[2].range(),[new t(1,12,1,16)])});function M(){const e={resource:S.file("somepath"+ ++x),results:[]},s=l.createInstance(F);u.add(s);const a=l.createInstance(R,S.file("somepath"),"",0,{type:E.Text,folderQueries:[{folder:k()}],contentPattern:{pattern:""}},s.searchResult,s.searchResult,null),n=l.createInstance(q,{pattern:""},void 0,void 0,a,e,null,"");return n.createMatches(!1),u.add(a),u.add(n),n}})});
