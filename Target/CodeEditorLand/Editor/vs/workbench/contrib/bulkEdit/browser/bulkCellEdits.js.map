{
  "version": 3,
  "sources": ["../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/contrib/bulkEdit/browser/bulkCellEdits.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { groupBy } from \"../../../../base/common/arrays.js\";\nimport type { CancellationToken } from \"../../../../base/common/cancellation.js\";\nimport { compare } from \"../../../../base/common/strings.js\";\nimport { isObject } from \"../../../../base/common/types.js\";\nimport { URI } from \"../../../../base/common/uri.js\";\nimport { ResourceEdit } from \"../../../../editor/browser/services/bulkEditService.js\";\nimport type { WorkspaceEditMetadata } from \"../../../../editor/common/languages.js\";\nimport type { IProgress } from \"../../../../platform/progress/common/progress.js\";\nimport type {\n\tUndoRedoGroup,\n\tUndoRedoSource,\n} from \"../../../../platform/undoRedo/common/undoRedo.js\";\nimport { IEditorService } from \"../../../services/editor/common/editorService.js\";\nimport { getNotebookEditorFromEditorPane } from \"../../notebook/browser/notebookBrowser.js\";\nimport {\n\tCellUri,\n\ttype ICellPartialMetadataEdit,\n\ttype ICellReplaceEdit,\n\ttype IDocumentMetadataEdit,\n\ttype ISelectionState,\n\ttype IWorkspaceNotebookCellEdit,\n\tSelectionStateType,\n} from \"../../notebook/common/notebookCommon.js\";\nimport { INotebookEditorModelResolverService } from \"../../notebook/common/notebookEditorModelResolverService.js\";\n\nexport class ResourceNotebookCellEdit\n\textends ResourceEdit\n\timplements IWorkspaceNotebookCellEdit\n{\n\tstatic is(candidate: any): candidate is IWorkspaceNotebookCellEdit {\n\t\tif (candidate instanceof ResourceNotebookCellEdit) {\n\t\t\treturn true;\n\t\t}\n\t\treturn (\n\t\t\tURI.isUri((<IWorkspaceNotebookCellEdit>candidate).resource) &&\n\t\t\tisObject((<IWorkspaceNotebookCellEdit>candidate).cellEdit)\n\t\t);\n\t}\n\n\tstatic lift(edit: IWorkspaceNotebookCellEdit): ResourceNotebookCellEdit {\n\t\tif (edit instanceof ResourceNotebookCellEdit) {\n\t\t\treturn edit;\n\t\t}\n\t\treturn new ResourceNotebookCellEdit(\n\t\t\tedit.resource,\n\t\t\tedit.cellEdit,\n\t\t\tedit.notebookVersionId,\n\t\t\tedit.metadata,\n\t\t);\n\t}\n\n\tconstructor(\n\t\treadonly resource: URI,\n\t\treadonly cellEdit:\n\t\t\t| ICellPartialMetadataEdit\n\t\t\t| IDocumentMetadataEdit\n\t\t\t| ICellReplaceEdit,\n\t\treadonly notebookVersionId: number | undefined = undefined,\n\t\tmetadata?: WorkspaceEditMetadata,\n\t) {\n\t\tsuper(metadata);\n\t}\n}\n\nexport class BulkCellEdits {\n\tconstructor(\n\t\tprivate readonly _undoRedoGroup: UndoRedoGroup,\n\t\tundoRedoSource: UndoRedoSource | undefined,\n\t\tprivate readonly _progress: IProgress<void>,\n\t\tprivate readonly _token: CancellationToken,\n\t\tprivate readonly _edits: ResourceNotebookCellEdit[],\n\t\t@IEditorService private readonly _editorService: IEditorService,\n\t\t@INotebookEditorModelResolverService\n\t\tprivate readonly _notebookModelService: INotebookEditorModelResolverService,\n\t) {\n\t\tthis._edits = this._edits.map((e) => {\n\t\t\tif (e.resource.scheme === CellUri.scheme) {\n\t\t\t\tconst uri = CellUri.parse(e.resource)?.notebook;\n\t\t\t\tif (!uri) {\n\t\t\t\t\tthrow new Error(`Invalid notebook URI: ${e.resource}`);\n\t\t\t\t}\n\n\t\t\t\treturn new ResourceNotebookCellEdit(\n\t\t\t\t\turi,\n\t\t\t\t\te.cellEdit,\n\t\t\t\t\te.notebookVersionId,\n\t\t\t\t\te.metadata,\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\treturn e;\n\t\t\t}\n\t\t});\n\t}\n\n\tasync apply(): Promise<readonly URI[]> {\n\t\tconst resources: URI[] = [];\n\t\tconst editsByNotebook = groupBy(this._edits, (a, b) =>\n\t\t\tcompare(a.resource.toString(), b.resource.toString()),\n\t\t);\n\n\t\tfor (const group of editsByNotebook) {\n\t\t\tif (this._token.isCancellationRequested) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tconst [first] = group;\n\t\t\tconst ref = await this._notebookModelService.resolve(\n\t\t\t\tfirst.resource,\n\t\t\t);\n\n\t\t\t// check state\n\t\t\tif (\n\t\t\t\ttypeof first.notebookVersionId === \"number\" &&\n\t\t\t\tref.object.notebook.versionId !== first.notebookVersionId\n\t\t\t) {\n\t\t\t\tref.dispose();\n\t\t\t\tthrow new Error(\n\t\t\t\t\t`Notebook '${first.resource}' has changed in the meantime`,\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t// apply edits\n\t\t\tconst edits = group.map((entry) => entry.cellEdit);\n\t\t\tconst computeUndo = !ref.object.isReadonly();\n\t\t\tconst editor = getNotebookEditorFromEditorPane(\n\t\t\t\tthis._editorService.activeEditorPane,\n\t\t\t);\n\t\t\tconst initialSelectionState: ISelectionState | undefined =\n\t\t\t\teditor?.textModel?.uri.toString() ===\n\t\t\t\tref.object.notebook.uri.toString()\n\t\t\t\t\t? {\n\t\t\t\t\t\t\tkind: SelectionStateType.Index,\n\t\t\t\t\t\t\tfocus: editor.getFocus(),\n\t\t\t\t\t\t\tselections: editor.getSelections(),\n\t\t\t\t\t\t}\n\t\t\t\t\t: undefined;\n\t\t\tref.object.notebook.applyEdits(\n\t\t\t\tedits,\n\t\t\t\ttrue,\n\t\t\t\tinitialSelectionState,\n\t\t\t\t() => undefined,\n\t\t\t\tthis._undoRedoGroup,\n\t\t\t\tcomputeUndo,\n\t\t\t);\n\t\t\tref.dispose();\n\n\t\t\tthis._progress.report(undefined);\n\n\t\t\tresources.push(first.resource);\n\t\t}\n\n\t\treturn resources;\n\t}\n}\n"],
  "mappings": ";;;;;;;;;;;;AAKA,SAAS,eAAe;AAExB,SAAS,eAAe;AACxB,SAAS,gBAAgB;AACzB,SAAS,WAAW;AACpB,SAAS,oBAAoB;AAO7B,SAAS,sBAAsB;AAC/B,SAAS,uCAAuC;AAChD;AAAA,EACC;AAAA,EAMA;AAAA,OACM;AACP,SAAS,2CAA2C;AAE7C,MAAM,iCACJ,aAET;AAAA,EAuBC,YACU,UACA,UAIA,oBAAwC,QACjD,UACC;AACD,UAAM,QAAQ;AARL;AACA;AAIA;AAAA,EAIV;AAAA,EAlED,OAiCA;AAAA;AAAA;AAAA,EACC,OAAO,GAAG,WAAyD;AAClE,QAAI,qBAAqB,0BAA0B;AAClD,aAAO;AAAA,IACR;AACA,WACC,IAAI,MAAmC,UAAW,QAAQ,KAC1D,SAAsC,UAAW,QAAQ;AAAA,EAE3D;AAAA,EAEA,OAAO,KAAK,MAA4D;AACvE,QAAI,gBAAgB,0BAA0B;AAC7C,aAAO;AAAA,IACR;AACA,WAAO,IAAI;AAAA,MACV,KAAK;AAAA,MACL,KAAK;AAAA,MACL,KAAK;AAAA,MACL,KAAK;AAAA,IACN;AAAA,EACD;AAaD;AAEO,IAAM,gBAAN,MAAoB;AAAA,EAC1B,YACkB,gBACjB,gBACiB,WACA,QACA,QACgB,gBAEhB,uBAChB;AARgB;AAEA;AACA;AACA;AACgB;AAEhB;AAEjB,SAAK,SAAS,KAAK,OAAO,IAAI,CAAC,MAAM;AACpC,UAAI,EAAE,SAAS,WAAW,QAAQ,QAAQ;AACzC,cAAM,MAAM,QAAQ,MAAM,EAAE,QAAQ,GAAG;AACvC,YAAI,CAAC,KAAK;AACT,gBAAM,IAAI,MAAM,yBAAyB,EAAE,QAAQ,EAAE;AAAA,QACtD;AAEA,eAAO,IAAI;AAAA,UACV;AAAA,UACA,EAAE;AAAA,UACF,EAAE;AAAA,UACF,EAAE;AAAA,QACH;AAAA,MACD,OAAO;AACN,eAAO;AAAA,MACR;AAAA,IACD,CAAC;AAAA,EACF;AAAA,EAjGD,OAqE2B;AAAA;AAAA;AAAA,EA8B1B,MAAM,QAAiC;AACtC,UAAM,YAAmB,CAAC;AAC1B,UAAM,kBAAkB;AAAA,MAAQ,KAAK;AAAA,MAAQ,CAAC,GAAG,MAChD,QAAQ,EAAE,SAAS,SAAS,GAAG,EAAE,SAAS,SAAS,CAAC;AAAA,IACrD;AAEA,eAAW,SAAS,iBAAiB;AACpC,UAAI,KAAK,OAAO,yBAAyB;AACxC;AAAA,MACD;AACA,YAAM,CAAC,KAAK,IAAI;AAChB,YAAM,MAAM,MAAM,KAAK,sBAAsB;AAAA,QAC5C,MAAM;AAAA,MACP;AAGA,UACC,OAAO,MAAM,sBAAsB,YACnC,IAAI,OAAO,SAAS,cAAc,MAAM,mBACvC;AACD,YAAI,QAAQ;AACZ,cAAM,IAAI;AAAA,UACT,aAAa,MAAM,QAAQ;AAAA,QAC5B;AAAA,MACD;AAGA,YAAM,QAAQ,MAAM,IAAI,CAAC,UAAU,MAAM,QAAQ;AACjD,YAAM,cAAc,CAAC,IAAI,OAAO,WAAW;AAC3C,YAAM,SAAS;AAAA,QACd,KAAK,eAAe;AAAA,MACrB;AACA,YAAM,wBACL,QAAQ,WAAW,IAAI,SAAS,MAChC,IAAI,OAAO,SAAS,IAAI,SAAS,IAC9B;AAAA,QACA,MAAM,mBAAmB;AAAA,QACzB,OAAO,OAAO,SAAS;AAAA,QACvB,YAAY,OAAO,cAAc;AAAA,MAClC,IACC;AACJ,UAAI,OAAO,SAAS;AAAA,QACnB;AAAA,QACA;AAAA,QACA;AAAA,QACA,MAAM;AAAA,QACN,KAAK;AAAA,QACL;AAAA,MACD;AACA,UAAI,QAAQ;AAEZ,WAAK,UAAU,OAAO,MAAS;AAE/B,gBAAU,KAAK,MAAM,QAAQ;AAAA,IAC9B;AAEA,WAAO;AAAA,EACR;AACD;AAxFa,gBAAN;AAAA,EAOJ;AAAA,EACA;AAAA,GARU;",
  "names": []
}
