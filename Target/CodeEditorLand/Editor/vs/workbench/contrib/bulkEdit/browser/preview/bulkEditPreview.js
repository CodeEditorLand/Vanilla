var I=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var y=(a,e,i,r)=>{for(var o=r>1?void 0:r?M(e,i):e,t=a.length-1,s;t>=0;t--)(s=a[t])&&(o=(r?s(e,i,o):s(o))||o);return r&&o&&I(e,i,o),o},l=(a,e)=>(i,r)=>e(i,r,a);import{coalesceInPlace as O}from"../../../../../base/common/arrays.js";import{Codicon as T}from"../../../../../base/common/codicons.js";import{Emitter as b,Event as U}from"../../../../../base/common/event.js";import{DisposableStore as F}from"../../../../../base/common/lifecycle.js";import{ResourceMap as P}from"../../../../../base/common/map.js";import{extUri as k}from"../../../../../base/common/resources.js";import{MicrotaskDelay as B}from"../../../../../base/common/symbols.js";import{URI as v}from"../../../../../base/common/uri.js";import{generateUuid as D}from"../../../../../base/common/uuid.js";import{ResourceFileEdit as E,ResourceTextEdit as _}from"../../../../../editor/browser/services/bulkEditService.js";import{EditOperation as w}from"../../../../../editor/common/core/editOperation.js";import{Range as R}from"../../../../../editor/common/core/range.js";import{ILanguageService as A}from"../../../../../editor/common/languages/language.js";import{createTextBufferFactoryFromSnapshot as L}from"../../../../../editor/common/model/textModel.js";import{IModelService as N}from"../../../../../editor/common/services/model.js";import{ITextModelService as W}from"../../../../../editor/common/services/resolverService.js";import{SnippetParser as q}from"../../../../../editor/contrib/snippet/browser/snippetParser.js";import{localize as j}from"../../../../../nls.js";import{IFileService as z}from"../../../../../platform/files/common/files.js";import{IInstantiationService as C}from"../../../../../platform/instantiation/common/instantiation.js";import{ConflictDetector as K}from"../conflicts.js";class V{_states=new WeakMap;_checkedCount=0;_onDidChange=new b;onDidChange=this._onDidChange.event;dispose(){this._onDidChange.dispose()}get checkedCount(){return this._checkedCount}isChecked(e){return this._states.get(e)??!1}updateChecked(e,i){const r=this._states.get(e);r!==i&&(r===void 0?i&&(this._checkedCount+=1):i?this._checkedCount+=1:this._checkedCount-=1,this._states.set(e,i),this._onDidChange.fire(e))}}class X{constructor(e,i){this.parent=e;this.textEdit=i}}var G=(o=>(o[o.TextEdit=1]="TextEdit",o[o.Create=2]="Create",o[o.Delete=4]="Delete",o[o.Rename=8]="Rename",o))(G||{});class H{constructor(e,i){this.uri=e;this.parent=i}type=0;textEdits=[];originalEdits=new Map;newUri;addEdit(e,i,r){this.type|=i,this.originalEdits.set(e,r),r instanceof _?this.textEdits.push(new X(this,r)):i===8&&(this.newUri=r.newResource)}needsConfirmation(){for(const[,e]of this.originalEdits)if(!this.parent.checked.isChecked(e))return!0;return!1}}class m{constructor(e=m._defaultMetadata){this.metadata=e}static _defaultMetadata=Object.freeze({label:j("default","Other"),icon:T.symbolFile,needsConfirmation:!1});static keyOf(e){return e?.label||"<default>"}operationByResource=new Map;get fileOperations(){return this.operationByResource.values()}}let p=class{constructor(e,i,r){this._bulkEdit=e;this._fileService=i;this.conflicts=r.createInstance(K,e)}static async create(e,i){return await e.get(C).createInstance(p,i)._init()}checked=new V;fileOperations=[];categories=[];conflicts;dispose(){this.checked.dispose(),this.conflicts.dispose()}async _init(){const e=new Map,i=new Map,r=new P;for(let o=0;o<this._bulkEdit.length;o++){const t=this._bulkEdit[o];let s,f;if(this.checked.updateChecked(t,!t.metadata?.needsConfirmation),t instanceof _)f=1,s=t.resource;else if(t instanceof E)if(t.newResource&&t.oldResource){if(f=8,s=t.oldResource,t.options?.overwrite===void 0&&t.options?.ignoreIfExists&&await this._fileService.exists(s))continue;r.set(t.newResource,s)}else if(t.oldResource){if(f=4,s=t.oldResource,t.options?.ignoreIfNotExists&&!await this._fileService.exists(s))continue}else if(t.newResource){if(f=2,s=t.newResource,t.options?.overwrite===void 0&&t.options?.ignoreIfExists&&await this._fileService.exists(s))continue}else continue;else continue;const S=(d,g)=>{let h=k.getComparisonKey(d,!0),c=g.get(h);!c&&r.has(d)&&(d=r.get(d),h=k.getComparisonKey(d,!0),c=g.get(h)),c||(c=new H(d,this),g.set(h,c)),c.addEdit(o,f,t)};S(s,e);const x=m.keyOf(t.metadata);let u=i.get(x);u||(u=new m(t.metadata),i.set(x,u)),S(s,u.operationByResource)}e.forEach(o=>this.fileOperations.push(o)),i.forEach(o=>this.categories.push(o));for(const o of this.fileOperations)if(o.type!==1){let t=!0;for(const s of o.originalEdits.values())s instanceof E&&(t=t&&this.checked.isChecked(s));if(!t)for(const s of o.originalEdits.values())this.checked.updateChecked(s,t)}return this.categories.sort((o,t)=>o.metadata.needsConfirmation===t.metadata.needsConfirmation?o.metadata.label.localeCompare(t.metadata.label):o.metadata.needsConfirmation?-1:1),this}getWorkspaceEdit(){const e=[];let i=!0;for(let r=0;r<this._bulkEdit.length;r++){const o=this._bulkEdit[r];if(this.checked.isChecked(o)){e[r]=o;continue}i=!1}return i?this._bulkEdit:(O(e),e)}async getFileEditOperation(e){const i=await e.options.contents;if(i)return w.replaceMove(R.lift({startLineNumber:0,startColumn:0,endLineNumber:Number.MAX_VALUE,endColumn:0}),i.toString())}async getFileEdits(e){for(const i of this.fileOperations)if(i.uri.toString()===e.toString()){const r=[];let o=!1;for(const t of i.originalEdits.values())t instanceof E?r.push(this.getFileEditOperation(t)):t instanceof _?this.checked.isChecked(t)&&r.push(Promise.resolve(w.replaceMove(R.lift(t.textEdit.range),t.textEdit.insertAsSnippet?q.asInsertText(t.textEdit.text):t.textEdit.text))):this.checked.isChecked(t)||(o=!0);return o?[]:(await Promise.all(r)).filter(t=>t!==void 0).sort((t,s)=>R.compareRangesUsingStarts(t.range,s.range))}return[]}getUriOfEdit(e){for(const i of this.fileOperations)for(const r of i.originalEdits.values())if(r===e)return i.uri;throw new Error("invalid edit")}};p=y([l(1,z),l(2,C)],p);let n=class{constructor(e,i,r,o){this._operations=e;this._languageService=i;this._modelService=r;this._textModelResolverService=o;this._disposables.add(this._textModelResolverService.registerTextModelContentProvider(n.Schema,this)),this._ready=this._init()}static Schema="vscode-bulkeditpreview-editor";static emptyPreview=v.from({scheme:this.Schema,fragment:"empty"});static fromPreviewUri(e){return v.parse(e.query)}_disposables=new F;_ready;_modelPreviewEdits=new Map;_instanceId=D();dispose(){this._disposables.dispose()}asPreviewUri(e){return v.from({scheme:n.Schema,authority:this._instanceId,path:e.path,query:e.toString()})}async _init(){for(const e of this._operations.fileOperations)await this._applyTextEditsToPreviewModel(e.uri);this._disposables.add(U.debounce(this._operations.checked.onDidChange,(e,i)=>i,B)(e=>{const i=this._operations.getUriOfEdit(e);this._applyTextEditsToPreviewModel(i)}))}async _applyTextEditsToPreviewModel(e){const i=await this._getOrCreatePreviewModel(e),r=this._modelPreviewEdits.get(i.id);r&&i.applyEdits(r);const o=await this._operations.getFileEdits(e),t=i.applyEdits(o,!0);this._modelPreviewEdits.set(i.id,t)}async _getOrCreatePreviewModel(e){const i=this.asPreviewUri(e);let r=this._modelService.getModel(i);if(!r){try{const o=await this._textModelResolverService.createModelReference(e),t=o.object.textEditorModel;r=this._modelService.createModel(L(t.createSnapshot()),this._languageService.createById(t.getLanguageId()),i),o.dispose()}catch{r=this._modelService.createModel("",this._languageService.createByFilepathOrFirstLine(i),i)}queueMicrotask(async()=>{this._disposables.add(await this._textModelResolverService.createModelReference(r.uri))})}return r}async provideTextContent(e){return e.toString()===n.emptyPreview.toString()?this._modelService.createModel("",null,e):(await this._ready,this._modelService.getModel(e))}};n=y([l(1,A),l(2,N),l(3,W)],n);export{m as BulkCategory,n as BulkEditPreviewProvider,H as BulkFileOperation,G as BulkFileOperationType,p as BulkFileOperations,X as BulkTextEdit,V as CheckedStates};
