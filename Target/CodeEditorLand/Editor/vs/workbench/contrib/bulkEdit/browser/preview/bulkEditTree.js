var M=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var f=(a,e,t,i)=>{for(var r=i>1?void 0:i?H(e,t):e,s=a.length-1,l;s>=0;s--)(l=a[s])&&(r=(i?l(e,t,r):l(r))||r);return i&&r&&M(e,t,r),r},u=(a,e)=>(t,i)=>e(t,i,a);import"../../../../../base/browser/ui/tree/tree.js";import{ITextModelService as z}from"../../../../../editor/common/services/resolverService.js";import{createMatches as O}from"../../../../../base/common/filters.js";import"../../../../browser/labels.js";import{HighlightedLabel as A}from"../../../../../base/browser/ui/highlightedlabel/highlightedLabel.js";import"../../../../../base/browser/ui/list/list.js";import{Range as B}from"../../../../../editor/common/core/range.js";import*as h from"../../../../../base/browser/dom.js";import"../../../../../editor/common/model.js";import{DisposableStore as S}from"../../../../../base/common/lifecycle.js";import{TextModel as U}from"../../../../../editor/common/model/textModel.js";import{BulkFileOperations as R,BulkFileOperationType as c}from"./bulkEditPreview.js";import{FileKind as K}from"../../../../../platform/files/common/files.js";import{localize as n}from"../../../../../nls.js";import{ILabelService as P}from"../../../../../platform/label/common/label.js";import{IconLabel as V}from"../../../../../base/browser/ui/iconLabel/iconLabel.js";import{basename as j}from"../../../../../base/common/resources.js";import{IThemeService as F}from"../../../../../platform/theme/common/themeService.js";import{ThemeIcon as C}from"../../../../../base/common/themables.js";import{compare as G}from"../../../../../base/common/strings.js";import{URI as w}from"../../../../../base/common/uri.js";import{ResourceFileEdit as I}from"../../../../../editor/browser/services/bulkEditService.js";import{PLAINTEXT_LANGUAGE_ID as J}from"../../../../../editor/common/languages/modesRegistry.js";import{SnippetParser as W}from"../../../../../editor/contrib/snippet/browser/snippetParser.js";import"../../../../../base/browser/ui/aria/aria.js";import{IInstantiationService as $}from"../../../../../platform/instantiation/common/instantiation.js";class d{constructor(e,t){this.parent=e;this.category=t}isChecked(){const e=this.parent;let t=!0;for(const i of this.category.fileOperations)for(const r of i.originalEdits.values())t=t&&e.checked.isChecked(r);return t}setChecked(e){const t=this.parent;for(const i of this.category.fileOperations)for(const r of i.originalEdits.values())t.checked.updateChecked(r,e)}}class p{constructor(e,t){this.parent=e;this.edit=t}isChecked(){const e=this.parent instanceof d?this.parent.parent:this.parent;let t=!0;this.edit.type===c.TextEdit&&(t=!this.edit.textEdits.every(i=>!e.checked.isChecked(i.textEdit)));for(const i of this.edit.originalEdits.values())i instanceof I&&(t=t&&e.checked.isChecked(i));if(this.parent instanceof d&&this.edit.type===c.TextEdit){for(const i of e.categories)for(const r of i.fileOperations)if(r.uri.toString()===this.edit.uri.toString())for(const s of r.originalEdits.values())s instanceof I&&(t=t&&e.checked.isChecked(s))}return t}setChecked(e){const t=this.parent instanceof d?this.parent.parent:this.parent;for(const i of this.edit.originalEdits.values())t.checked.updateChecked(i,e);if(this.parent instanceof d&&this.edit.type!==c.TextEdit){for(const i of t.categories)for(const r of i.fileOperations)if(r.uri.toString()===this.edit.uri.toString())for(const s of r.originalEdits.values())t.checked.updateChecked(s,e)}}isDisabled(){if(this.parent instanceof d&&this.edit.type===c.TextEdit){const e=this.parent.parent;let t=!0;for(const i of e.categories)for(const r of i.fileOperations)if(r.uri.toString()===this.edit.uri.toString())for(const s of r.originalEdits.values())s instanceof I&&(t=t&&e.checked.isChecked(s));return!t}return!1}}class m{constructor(e,t,i,r,s,l,o){this.parent=e;this.idx=t;this.edit=i;this.prefix=r;this.selecting=s;this.inserting=l;this.suffix=o}isChecked(){let e=this.parent.parent;return e instanceof d&&(e=e.parent),e.checked.isChecked(this.edit.textEdit)}setChecked(e){let t=this.parent.parent;if(t instanceof d&&(t=t.parent),t.checked.updateChecked(this.edit.textEdit,e),e)for(const i of this.parent.edit.originalEdits.values())i instanceof I&&t.checked.updateChecked(i,e)}isDisabled(){return this.parent.isDisabled()}}let T=class{constructor(e,t){this._textModelService=e;this._instantiationService=t}groupByFile=!0;hasChildren(e){return e instanceof p?e.edit.textEdits.length>0:!(e instanceof m)}async getChildren(e){if(e instanceof R)return this.groupByFile?e.fileOperations.map(t=>new p(e,t)):e.categories.map(t=>new d(e,t));if(e instanceof d)return Array.from(e.category.fileOperations,t=>new p(e,t));if(e instanceof p&&e.edit.textEdits.length>0){let t,i;try{const s=await this._textModelService.createModelReference(e.edit.uri);t=s.object.textEditorModel,i=s}catch{t=this._instantiationService.createInstance(U,"",J,U.DEFAULT_CREATION_OPTIONS,null),i=t}const r=e.edit.textEdits.map((s,l)=>{const o=t.validateRange(s.textEdit.textEdit.range),b=t.tokenization.getLineTokens(o.startLineNumber);let D=23;for(let g=b.findTokenIndexAtOffset(o.startColumn-1)-1;D<50&&g>=0;g--)D=o.startColumn-b.getStartOffset(g);const _=t.tokenization.getLineTokens(o.endLineNumber);let N=0;for(let g=_.findTokenIndexAtOffset(o.endColumn-1);N<50&&g<_.getCount();g++)N+=_.getEndOffset(g)-_.getStartOffset(g);return new m(e,l,s,t.getValueInRange(new B(o.startLineNumber,o.startColumn-D,o.startLineNumber,o.startColumn)),t.getValueInRange(o),s.textEdit.textEdit.insertAsSnippet?W.asInsertText(s.textEdit.textEdit.text):s.textEdit.textEdit.text,t.getValueInRange(new B(o.endLineNumber,o.endColumn,o.endLineNumber,o.endColumn+N)))});return i.dispose(),r}return[]}};T=f([u(0,z),u(1,$)],T);class Ae{compare(e,t){return e instanceof p&&t instanceof p?X(e.edit,t.edit):e instanceof m&&t instanceof m?B.compareRangesUsingStarts(e.edit.textEdit.textEdit.range,t.edit.textEdit.textEdit.range):0}}function X(a,e){return G(a.uri.toString(),e.uri.toString())}let L=class{constructor(e){this._labelService=e}getWidgetAriaLabel(){return n("bulkEdit","Bulk Edit")}getRole(e){return"checkbox"}getAriaLabel(e){if(e instanceof p){if(e.edit.textEdits.length>0)return e.edit.type&c.Rename&&e.edit.newUri?n("aria.renameAndEdit","Renaming {0} to {1}, also making text edits",this._labelService.getUriLabel(e.edit.uri,{relative:!0}),this._labelService.getUriLabel(e.edit.newUri,{relative:!0})):e.edit.type&c.Create?n("aria.createAndEdit","Creating {0}, also making text edits",this._labelService.getUriLabel(e.edit.uri,{relative:!0})):e.edit.type&c.Delete?n("aria.deleteAndEdit","Deleting {0}, also making text edits",this._labelService.getUriLabel(e.edit.uri,{relative:!0})):n("aria.editOnly","{0}, making text edits",this._labelService.getUriLabel(e.edit.uri,{relative:!0}));if(e.edit.type&c.Rename&&e.edit.newUri)return n("aria.rename","Renaming {0} to {1}",this._labelService.getUriLabel(e.edit.uri,{relative:!0}),this._labelService.getUriLabel(e.edit.newUri,{relative:!0}));if(e.edit.type&c.Create)return n("aria.create","Creating {0}",this._labelService.getUriLabel(e.edit.uri,{relative:!0}));if(e.edit.type&c.Delete)return n("aria.delete","Deleting {0}",this._labelService.getUriLabel(e.edit.uri,{relative:!0}))}if(e instanceof m){if(e.selecting.length>0&&e.inserting.length>0)return n("aria.replace","line {0}, replacing {1} with {2}",e.edit.textEdit.textEdit.range.startLineNumber,e.selecting,e.inserting);if(e.selecting.length>0&&e.inserting.length===0)return n("aria.del","line {0}, removing {1}",e.edit.textEdit.textEdit.range.startLineNumber,e.selecting);if(e.selecting.length===0&&e.inserting.length>0)return n("aria.insert","line {0}, inserting {1}",e.edit.textEdit.textEdit.range.startLineNumber,e.selecting)}return null}};L=f([u(0,P)],L);class Re{getId(e){return e instanceof p?e.edit.uri+(e.parent instanceof d?JSON.stringify(e.parent.category.metadata):""):e instanceof m?e.parent.edit.uri.toString()+e.idx:JSON.stringify(e.category.metadata)}}class q{icon;label;constructor(e){e.classList.add("category"),this.icon=document.createElement("div"),e.appendChild(this.icon),this.label=new V(e)}}let k=class{constructor(e){this._themeService=e}static id="CategoryElementRenderer";templateId=k.id;renderTemplate(e){return new q(e)}renderElement(e,t,i){i.icon.style.setProperty("--background-dark",null),i.icon.style.setProperty("--background-light",null),i.icon.style.color="";const{metadata:r}=e.element.category;if(C.isThemeIcon(r.iconPath)){const s=C.asClassName(r.iconPath);i.icon.className=s?`theme-icon ${s}`:"",i.icon.style.color=r.iconPath.color?this._themeService.getColorTheme().getColor(r.iconPath.color.id)?.toString()??"":""}else w.isUri(r.iconPath)?(i.icon.className="uri-icon",i.icon.style.setProperty("--background-dark",h.asCSSUrl(r.iconPath)),i.icon.style.setProperty("--background-light",h.asCSSUrl(r.iconPath))):r.iconPath&&(i.icon.className="uri-icon",i.icon.style.setProperty("--background-dark",h.asCSSUrl(r.iconPath.dark)),i.icon.style.setProperty("--background-light",h.asCSSUrl(r.iconPath.light)));i.label.setLabel(r.label,r.description,{descriptionMatches:O(e.filterData)})}disposeTemplate(e){e.label.dispose()}};k=f([u(0,F)],k);let E=class{constructor(e,t,i){this._labelService=i;this._checkbox=document.createElement("input"),this._checkbox.className="edit-checkbox",this._checkbox.type="checkbox",this._checkbox.setAttribute("role","checkbox"),e.appendChild(this._checkbox),this._label=t.create(e,{supportHighlights:!0}),this._details=document.createElement("span"),this._details.className="details",e.appendChild(this._details)}_disposables=new S;_localDisposables=new S;_checkbox;_label;_details;dispose(){this._localDisposables.dispose(),this._disposables.dispose(),this._label.dispose()}set(e,t){if(this._localDisposables.clear(),this._checkbox.checked=e.isChecked(),this._checkbox.disabled=e.isDisabled(),this._localDisposables.add(h.addDisposableListener(this._checkbox,"change",()=>{e.setChecked(this._checkbox.checked)})),e.edit.type&c.Rename&&e.edit.newUri)this._label.setResource({resource:e.edit.uri,name:n("rename.label","{0} \u2192 {1}",this._labelService.getUriLabel(e.edit.uri,{relative:!0}),this._labelService.getUriLabel(e.edit.newUri,{relative:!0}))},{fileDecorations:{colors:!0,badges:!1}}),this._details.innerText=n("detail.rename","(renaming)");else{const i={matches:O(t),fileKind:K.FILE,fileDecorations:{colors:!0,badges:!1},extraClasses:[]};e.edit.type&c.Create?this._details.innerText=n("detail.create","(creating)"):e.edit.type&c.Delete?(this._details.innerText=n("detail.del","(deleting)"),i.extraClasses.push("delete")):this._details.innerText="",this._label.setFile(e.edit.uri,i)}}};E=f([u(2,P)],E);let y=class{constructor(e,t){this._resourceLabels=e;this._labelService=t}static id="FileElementRenderer";templateId=y.id;renderTemplate(e){return new E(e,this._resourceLabels,this._labelService)}renderElement(e,t,i){i.set(e.element,e.filterData)}disposeTemplate(e){e.dispose()}};y=f([u(1,P)],y);let v=class{constructor(e,t){this._themeService=t;e.classList.add("textedit"),this._checkbox=document.createElement("input"),this._checkbox.className="edit-checkbox",this._checkbox.type="checkbox",this._checkbox.setAttribute("role","checkbox"),e.appendChild(this._checkbox),this._icon=document.createElement("div"),e.appendChild(this._icon),this._label=this._disposables.add(new A(e))}_disposables=new S;_localDisposables=new S;_checkbox;_icon;_label;dispose(){this._localDisposables.dispose(),this._disposables.dispose()}set(e){this._localDisposables.clear(),this._localDisposables.add(h.addDisposableListener(this._checkbox,"change",b=>{e.setChecked(this._checkbox.checked),b.preventDefault()})),e.parent.isChecked()?(this._checkbox.checked=e.isChecked(),this._checkbox.disabled=e.isDisabled()):(this._checkbox.checked=e.isChecked(),this._checkbox.disabled=e.isDisabled());let t="";t+=e.prefix,t+=e.selecting,t+=e.inserting,t+=e.suffix;const i={start:e.prefix.length,end:e.prefix.length+e.selecting.length,extraClasses:["remove"]},r={start:i.end,end:i.end+e.inserting.length,extraClasses:["insert"]};let s;const{metadata:l}=e.edit.textEdit;l&&l.description?s=n("title","{0} - {1}",l.label,l.description):l&&(s=l.label);const o=l?.iconPath;if(!o)this._icon.style.display="none";else if(this._icon.style.display="block",this._icon.style.setProperty("--background-dark",null),this._icon.style.setProperty("--background-light",null),C.isThemeIcon(o)){const b=C.asClassName(o);this._icon.className=b?`theme-icon ${b}`:"",this._icon.style.color=o.color?this._themeService.getColorTheme().getColor(o.color.id)?.toString()??"":""}else w.isUri(o)?(this._icon.className="uri-icon",this._icon.style.setProperty("--background-dark",h.asCSSUrl(o)),this._icon.style.setProperty("--background-light",h.asCSSUrl(o))):(this._icon.className="uri-icon",this._icon.style.setProperty("--background-dark",h.asCSSUrl(o.dark)),this._icon.style.setProperty("--background-light",h.asCSSUrl(o.light)));this._label.set(t,[i,r],s,!0),this._icon.title=s||""}};v=f([u(1,F)],v);let x=class{constructor(e){this._themeService=e}static id="TextEditElementRenderer";templateId=x.id;renderTemplate(e){return new v(e,this._themeService)}renderElement({element:e},t,i){i.set(e)}disposeTemplate(e){}};x=f([u(0,F)],x);class Ke{getHeight(){return 23}getTemplateId(e){return e instanceof p?y.id:e instanceof m?x.id:k.id}}class Ve{getKeyboardNavigationLabel(e){if(e instanceof p)return j(e.edit.uri);if(e instanceof d)return e.category.metadata.label}}export{L as BulkEditAccessibilityProvider,T as BulkEditDataSource,Ke as BulkEditDelegate,Re as BulkEditIdentityProvider,Ve as BulkEditNaviLabelProvider,Ae as BulkEditSorter,d as CategoryElement,k as CategoryElementRenderer,p as FileElement,y as FileElementRenderer,m as TextEditElement,x as TextEditElementRenderer,X as compareBulkFileOperations};
