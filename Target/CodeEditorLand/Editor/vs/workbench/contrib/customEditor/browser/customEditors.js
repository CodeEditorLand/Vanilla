var g=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var C=(c,a,t,i)=>{for(var e=i>1?void 0:i?b(a,t):a,r=c.length-1,o;r>=0;r--)(o=c[r])&&(e=(i?o(a,t,e):o(e))||e);return i&&e&&g(a,t,e),e},d=(c,a)=>(t,i)=>a(t,i,c);import"./media/customEditor.css";import{coalesce as y}from"../../../../base/common/arrays.js";import{Emitter as _}from"../../../../base/common/event.js";import{Disposable as S,DisposableStore as D,toDisposable as R}from"../../../../base/common/lifecycle.js";import{Schemas as P}from"../../../../base/common/network.js";import{extname as I,isEqual as T}from"../../../../base/common/resources.js";import{assertIsDefined as h}from"../../../../base/common/types.js";import{URI as F}from"../../../../base/common/uri.js";import{RedoCommand as O,UndoCommand as U}from"../../../../editor/browser/editorExtensions.js";import{FileOperation as G,IFileService as x}from"../../../../platform/files/common/files.js";import{IInstantiationService as A}from"../../../../platform/instantiation/common/instantiation.js";import{Registry as w}from"../../../../platform/registry/common/platform.js";import{IStorageService as K}from"../../../../platform/storage/common/storage.js";import{IUriIdentityService as M}from"../../../../platform/uriIdentity/common/uriIdentity.js";import{DEFAULT_EDITOR_ASSOCIATION as N,EditorExtensions as L}from"../../../common/editor.js";import{DiffEditorInput as V}from"../../../common/editor/diffEditorInput.js";import{CONTEXT_ACTIVE_CUSTOM_EDITOR_ID as B,CONTEXT_FOCUSED_CUSTOM_EDITOR_IS_EDITABLE as X,CustomEditorInfoCollection as v}from"../common/customEditor.js";import{CustomEditorModelManager as $}from"../common/customEditorModelManager.js";import{IEditorGroupsService as q}from"../../../services/editor/common/editorGroupsService.js";import{IEditorResolverService as z,RegisteredEditorPriority as Y}from"../../../services/editor/common/editorResolverService.js";import{IEditorService as j}from"../../../services/editor/common/editorService.js";import{ContributedCustomEditors as k}from"../common/contributedCustomEditors.js";import{CustomEditorInput as n}from"./customEditorInput.js";let E=class extends S{constructor(t,i,e,r,o,u,p){super();this.editorService=e;this.editorGroupService=r;this.instantiationService=o;this.uriIdentityService=u;this.editorResolverService=p;this._contributedEditors=this._register(new k(i)),this.editorResolverService.bufferChangeEvents(this.registerContributionPoints.bind(this)),this._register(this._contributedEditors.onChange(()=>{this.editorResolverService.bufferChangeEvents(this.registerContributionPoints.bind(this)),this._onDidChangeEditorTypes.fire()}));const l={contextKey:B,getGroupContextKeyValue:s=>this.getActiveCustomEditorId(s),onDidChange:this.onDidChangeEditorTypes},m={contextKey:X,getGroupContextKeyValue:s=>this.getCustomEditorIsEditable(s),onDidChange:this.onDidChangeEditorTypes};this._register(this.editorGroupService.registerContextKeyProvider(l)),this._register(this.editorGroupService.registerContextKeyProvider(m)),this._register(t.onDidRunOperation(s=>{s.isOperation(G.MOVE)&&this.handleMovedFileInOpenedFileEditors(s.resource,this.uriIdentityService.asCanonicalUri(s.target.resource))}));const f=105;this._register(U.addImplementation(f,"custom-editor",()=>this.withActiveCustomEditor(s=>s.undo()))),this._register(O.addImplementation(f,"custom-editor",()=>this.withActiveCustomEditor(s=>s.redo())))}_serviceBrand;_contributedEditors;_untitledCounter=0;_editorResolverDisposables=this._register(new D);_editorCapabilities=new Map;_models=new $;_onDidChangeEditorTypes=this._register(new _);onDidChangeEditorTypes=this._onDidChangeEditorTypes.event;_fileEditorFactory=w.as(L.EditorFactory).getFileEditorFactory();getEditorTypes(){return[...this._contributedEditors]}withActiveCustomEditor(t){const i=this.editorService.activeEditor;if(i instanceof n){const e=t(i);return e||!0}return!1}registerContributionPoints(){this._editorResolverDisposables.clear();for(const t of this._contributedEditors)for(const i of t.selector)i.filenamePattern&&this._editorResolverDisposables.add(this.editorResolverService.registerEditor(i.filenamePattern,{id:t.id,label:t.displayName,detail:t.providerDisplayName,priority:t.priority},{singlePerResource:()=>!(this.getCustomEditorCapabilities(t.id)?.supportsMultipleEditorsPerDocument??!1)},{createEditorInput:({resource:e},r)=>({editor:n.create(this.instantiationService,e,t.id,r.id)}),createUntitledEditorInput:({resource:e},r)=>({editor:n.create(this.instantiationService,e??F.from({scheme:P.untitled,authority:`Untitled-${this._untitledCounter++}`}),t.id,r.id)}),createDiffEditorInput:(e,r)=>({editor:this.createDiffEditorInput(e,t.id,r)})}))}createDiffEditorInput(t,i,e){const r=n.create(this.instantiationService,h(t.modified.resource),i,e.id,{customClasses:"modified"}),o=n.create(this.instantiationService,h(t.original.resource),i,e.id,{customClasses:"original"});return this.instantiationService.createInstance(V,t.label,t.description,o,r,!0)}get models(){return this._models}getCustomEditor(t){return this._contributedEditors.get(t)}getContributedCustomEditors(t){return new v(this._contributedEditors.getContributedEditors(t))}getUserConfiguredCustomEditors(t){const i=this.editorResolverService.getAssociationsForResource(t);return new v(y(i.map(e=>this._contributedEditors.get(e.viewType))))}getAllCustomEditors(t){return new v([...this.getUserConfiguredCustomEditors(t).allEditors,...this.getContributedCustomEditors(t).allEditors])}registerCustomEditorCapabilities(t,i){if(this._editorCapabilities.has(t))throw new Error(`Capabilities for ${t} already set`);return this._editorCapabilities.set(t,i),R(()=>{this._editorCapabilities.delete(t)})}getCustomEditorCapabilities(t){return this._editorCapabilities.get(t)}getActiveCustomEditorId(t){const i=t.activeEditorPane;return i?.input?.resource&&i?.input instanceof n?i.input.viewType:""}getCustomEditorIsEditable(t){const i=t.activeEditorPane;return i?.input?.resource?i?.input instanceof n:!1}async handleMovedFileInOpenedFileEditors(t,i){if(I(t).toLowerCase()===I(i).toLowerCase())return;const e=this.getAllCustomEditors(i);if(!e.allEditors.some(o=>o.priority!==Y.option))return;const r=new Map;for(const o of this.editorGroupService.groups)for(const u of o.editors)if(this._fileEditorFactory.isFileEditor(u)&&!(u instanceof n)&&T(u.resource,i)){let p=r.get(o.id);p||(p=[],r.set(o.id,p)),p.push(u)}if(r.size)for(const[o,u]of r)this.editorService.replaceEditors(u.map(p=>{let l;if(e.defaultEditor){const m=e.defaultEditor.id;l=n.create(this.instantiationService,i,m,o)}else l={resource:i,options:{override:N.id}};return{editor:p,replacement:l,options:{preserveFocus:!0}}}),o)}};E=C([d(0,x),d(1,K),d(2,j),d(3,q),d(4,A),d(5,M),d(6,z)],E);export{E as CustomEditorService};
