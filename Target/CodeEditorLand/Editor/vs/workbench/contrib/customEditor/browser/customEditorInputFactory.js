var I=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var v=(c,t,i,r)=>{for(var e=r>1?void 0:r?f(t,i):t,o=c.length-1,n;o>=0;o--)(n=c[o])&&(e=(r?n(t,i,e):n(e))||e);return r&&e&&I(t,i,e),e},s=(c,t)=>(i,r)=>t(i,r,c);import{Disposable as W}from"../../../../base/common/lifecycle.js";import{Schemas as S}from"../../../../base/common/network.js";import{isEqual as w}from"../../../../base/common/resources.js";import{URI as a}from"../../../../base/common/uri.js";import{IInstantiationService as y}from"../../../../platform/instantiation/common/instantiation.js";import"../../../common/contributions.js";import"../../../common/editor/editorInput.js";import{CustomEditorInput as p}from"./customEditorInput.js";import{ICustomEditorService as k}from"../common/customEditor.js";import{NotebookEditorInput as g}from"../../notebook/common/notebookEditorInput.js";import{IWebviewService as m,WebviewContentPurpose as C}from"../../webview/browser/webview.js";import{restoreWebviewContentOptions as h,restoreWebviewOptions as E,reviveWebviewExtensionDescription as O,WebviewEditorInputSerializer as x}from"../../webviewPanel/browser/webviewEditorInputSerializer.js";import{IWebviewWorkbenchService as D}from"../../webviewPanel/browser/webviewWorkbenchService.js";import"../../../services/workingCopy/common/workingCopy.js";import{IWorkingCopyBackupService as _}from"../../../services/workingCopy/common/workingCopyBackup.js";import{IWorkingCopyEditorService as z}from"../../../services/workingCopy/common/workingCopyEditorService.js";let d=class extends x{constructor(i,r,e){super(i);this._instantiationService=r;this._webviewService=e}static ID=p.typeId;serialize(i){const r=i.isDirty(),e={...this.toJson(i),editorResource:i.resource.toJSON(),dirty:r,backupId:r?i.backupId:void 0};try{return JSON.stringify(e)}catch{return}}fromJson(i){return{...super.fromJson(i),editorResource:a.from(i.editorResource),dirty:i.dirty}}deserialize(i,r){const e=this.fromJson(JSON.parse(r)),o=l(this._webviewService,e),n=this._instantiationService.createInstance(p,{resource:e.editorResource,viewType:e.viewType},o,{startsDirty:e.dirty,backupId:e.backupId});return typeof e.group=="number"&&n.updateGroup(e.group),n}};d=v([s(0,D),s(1,y),s(2,m)],d);function l(c,t){const i=c.createWebviewOverlay({providedViewType:t.viewType,origin:t.origin,title:void 0,options:{purpose:C.CustomEditor,enableFindWidget:t.webviewOptions.enableFindWidget,retainContextWhenHidden:t.webviewOptions.retainContextWhenHidden},contentOptions:t.contentOptions,extension:t.extension});return i.state=t.state,i}let u=class extends W{constructor(i,r,e,o,n){super();this._instantiationService=i;this._workingCopyBackupService=e;this._webviewService=o;this._register(r.registerHandler(this))}static ID="workbench.contrib.complexCustomWorkingCopyEditorHandler";handles(i){return i.resource.scheme===S.vscodeCustomEditor}isOpen(i,r){if(!this.handles(i))return!1;if(i.resource.authority==="jupyter-notebook-ipynb"&&r instanceof g)try{const e=JSON.parse(i.resource.query),o=a.from(e);return w(o,r.resource)}catch{return!1}if(!(r instanceof p)||i.resource.authority!==r.viewType.replace(/[^a-z0-9\-_]/gi,"-").toLowerCase())return!1;try{const e=JSON.parse(i.resource.query),o=a.from(e);return w(o,r.resource)}catch{return!1}}async createEditor(i){const r=await this._workingCopyBackupService.resolve(i);if(!r?.meta)throw new Error(`No backup found for custom editor: ${i.resource}`);const e=r.meta,o=O(e.extension?.id,e.extension?.location),n=l(this._webviewService,{viewType:e.viewType,origin:e.webview.origin,webviewOptions:E(e.webview.options),contentOptions:h(e.webview.options),state:e.webview.state,extension:o}),b=this._instantiationService.createInstance(p,{resource:a.revive(e.editorResource),viewType:e.viewType},n,{backupId:e.backupId});return b.updateGroup(0),b}};u=v([s(0,y),s(1,z),s(2,_),s(3,m),s(4,k)],u);export{u as ComplexCustomWorkingCopyEditorHandler,d as CustomEditorInputSerializer};
