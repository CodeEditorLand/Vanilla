{
  "version": 3,
  "sources": ["../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/contrib/webviewPanel/browser/webviewEditor.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as DOM from '../../../../base/browser/dom.js';\nimport { CancellationToken } from '../../../../base/common/cancellation.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { DisposableStore, IDisposable, MutableDisposable } from '../../../../base/common/lifecycle.js';\nimport { isWeb } from '../../../../base/common/platform.js';\nimport { generateUuid } from '../../../../base/common/uuid.js';\nimport * as nls from '../../../../nls.js';\nimport { IContextKeyService, IScopedContextKeyService, RawContextKey } from '../../../../platform/contextkey/common/contextkey.js';\nimport { IEditorOptions } from '../../../../platform/editor/common/editor.js';\nimport { IStorageService } from '../../../../platform/storage/common/storage.js';\nimport { ITelemetryService } from '../../../../platform/telemetry/common/telemetry.js';\nimport { IThemeService } from '../../../../platform/theme/common/themeService.js';\nimport { EditorPane } from '../../../browser/parts/editor/editorPane.js';\nimport { IEditorOpenContext } from '../../../common/editor.js';\nimport { EditorInput } from '../../../common/editor/editorInput.js';\nimport { IOverlayWebview } from '../../webview/browser/webview.js';\nimport { WebviewWindowDragMonitor } from '../../webview/browser/webviewWindowDragMonitor.js';\nimport { WebviewInput } from './webviewEditorInput.js';\nimport { IEditorGroup, IEditorGroupsService } from '../../../services/editor/common/editorGroupsService.js';\nimport { IEditorService } from '../../../services/editor/common/editorService.js';\nimport { IHostService } from '../../../services/host/browser/host.js';\nimport { IWorkbenchLayoutService, Parts } from '../../../services/layout/browser/layoutService.js';\n\n/**\n * Tracks the id of the actively focused webview.\n */\nexport const CONTEXT_ACTIVE_WEBVIEW_PANEL_ID = new RawContextKey<string>('activeWebviewPanelId', '', {\n\ttype: 'string',\n\tdescription: nls.localize('context.activeWebviewId', \"The viewType of the currently active webview panel.\"),\n});\n\nexport class WebviewEditor extends EditorPane {\n\n\tpublic static readonly ID = 'WebviewEditor';\n\n\tprivate _element?: HTMLElement;\n\tprivate _dimension?: DOM.Dimension;\n\tprivate _visible = false;\n\tprivate _isDisposed = false;\n\n\tprivate readonly _webviewVisibleDisposables = this._register(new DisposableStore());\n\tprivate readonly _onFocusWindowHandler = this._register(new MutableDisposable());\n\n\tprivate readonly _onDidFocusWebview = this._register(new Emitter<void>());\n\tpublic override get onDidFocus(): Event<any> { return this._onDidFocusWebview.event; }\n\n\tprivate readonly _scopedContextKeyService = this._register(new MutableDisposable<IScopedContextKeyService>());\n\n\tconstructor(\n\t\tgroup: IEditorGroup,\n\t\t@ITelemetryService telemetryService: ITelemetryService,\n\t\t@IThemeService themeService: IThemeService,\n\t\t@IStorageService storageService: IStorageService,\n\t\t@IEditorGroupsService private readonly _editorGroupsService: IEditorGroupsService,\n\t\t@IEditorService private readonly _editorService: IEditorService,\n\t\t@IWorkbenchLayoutService private readonly _workbenchLayoutService: IWorkbenchLayoutService,\n\t\t@IHostService private readonly _hostService: IHostService,\n\t\t@IContextKeyService private readonly _contextKeyService: IContextKeyService,\n\t) {\n\t\tsuper(WebviewEditor.ID, group, telemetryService, themeService, storageService);\n\n\t\tconst part = _editorGroupsService.getPart(group);\n\t\tthis._register(Event.any(part.onDidScroll, part.onDidAddGroup, part.onDidRemoveGroup, part.onDidMoveGroup)(() => {\n\t\t\tif (this.webview && this._visible) {\n\t\t\t\tthis.synchronizeWebviewContainerDimensions(this.webview);\n\t\t\t}\n\t\t}));\n\t}\n\n\tprivate get webview(): IOverlayWebview | undefined {\n\t\treturn this.input instanceof WebviewInput ? this.input.webview : undefined;\n\t}\n\n\toverride get scopedContextKeyService(): IContextKeyService | undefined {\n\t\treturn this._scopedContextKeyService.value;\n\t}\n\n\tprotected createEditor(parent: HTMLElement): void {\n\t\tconst element = document.createElement('div');\n\t\tthis._element = element;\n\t\tthis._element.id = `webview-editor-element-${generateUuid()}`;\n\t\tparent.appendChild(element);\n\n\t\tthis._scopedContextKeyService.value = this._register(this._contextKeyService.createScoped(element));\n\t}\n\n\tpublic override dispose(): void {\n\t\tthis._isDisposed = true;\n\n\t\tthis._element?.remove();\n\t\tthis._element = undefined;\n\n\t\tsuper.dispose();\n\t}\n\n\tpublic override layout(dimension: DOM.Dimension): void {\n\t\tthis._dimension = dimension;\n\t\tif (this.webview && this._visible) {\n\t\t\tthis.synchronizeWebviewContainerDimensions(this.webview, dimension);\n\t\t}\n\t}\n\n\tpublic override focus(): void {\n\t\tsuper.focus();\n\t\tif (!this._onFocusWindowHandler.value && !isWeb) {\n\t\t\t// Make sure we restore focus when switching back to a VS Code window\n\t\t\tthis._onFocusWindowHandler.value = this._hostService.onDidChangeFocus(focused => {\n\t\t\t\tif (focused && this._editorService.activeEditorPane === this && this._workbenchLayoutService.hasFocus(Parts.EDITOR_PART)) {\n\t\t\t\t\tthis.focus();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tthis.webview?.focus();\n\t}\n\n\tprotected override setEditorVisible(visible: boolean): void {\n\t\tthis._visible = visible;\n\t\tif (this.input instanceof WebviewInput && this.webview) {\n\t\t\tif (visible) {\n\t\t\t\tthis.claimWebview(this.input);\n\t\t\t} else {\n\t\t\t\tthis.webview.release(this);\n\t\t\t}\n\t\t}\n\t\tsuper.setEditorVisible(visible);\n\t}\n\n\tpublic override clearInput() {\n\t\tif (this.webview) {\n\t\t\tthis.webview.release(this);\n\t\t\tthis._webviewVisibleDisposables.clear();\n\t\t}\n\n\t\tsuper.clearInput();\n\t}\n\n\tpublic override async setInput(input: EditorInput, options: IEditorOptions, context: IEditorOpenContext, token: CancellationToken): Promise<void> {\n\t\tif (this.input && input.matches(this.input)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst alreadyOwnsWebview = input instanceof WebviewInput && input.webview === this.webview;\n\t\tif (this.webview && !alreadyOwnsWebview) {\n\t\t\tthis.webview.release(this);\n\t\t}\n\n\t\tawait super.setInput(input, options, context, token);\n\t\tawait input.resolve();\n\n\t\tif (token.isCancellationRequested || this._isDisposed) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (input instanceof WebviewInput) {\n\t\t\tinput.updateGroup(this.group.id);\n\n\t\t\tif (!alreadyOwnsWebview) {\n\t\t\t\tthis.claimWebview(input);\n\t\t\t}\n\t\t\tif (this._dimension) {\n\t\t\t\tthis.layout(this._dimension);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate claimWebview(input: WebviewInput): void {\n\t\tinput.claim(this, this.window, this.scopedContextKeyService);\n\n\t\tif (this._element) {\n\t\t\tthis._element.setAttribute('aria-flowto', input.webview.container.id);\n\t\t\tDOM.setParentFlowTo(input.webview.container, this._element);\n\t\t}\n\n\t\tthis._webviewVisibleDisposables.clear();\n\n\t\t// Webviews are not part of the normal editor dom, so we have to register our own drag and drop handler on them.\n\t\tthis._webviewVisibleDisposables.add(this._editorGroupsService.createEditorDropTarget(input.webview.container, {\n\t\t\tcontainsGroup: (group) => this.group.id === group.id\n\t\t}));\n\n\t\tthis._webviewVisibleDisposables.add(new WebviewWindowDragMonitor(this.window, () => this.webview));\n\n\t\tthis.synchronizeWebviewContainerDimensions(input.webview);\n\t\tthis._webviewVisibleDisposables.add(this.trackFocus(input.webview));\n\t}\n\n\tprivate synchronizeWebviewContainerDimensions(webview: IOverlayWebview, dimension?: DOM.Dimension) {\n\t\tif (!this._element?.isConnected) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst rootContainer = this._workbenchLayoutService.getContainer(this.window, Parts.EDITOR_PART);\n\t\twebview.layoutWebviewOverElement(this._element.parentElement!, dimension, rootContainer);\n\t}\n\n\tprivate trackFocus(webview: IOverlayWebview): IDisposable {\n\t\tconst store = new DisposableStore();\n\n\t\t// Track focus in webview content\n\t\tconst webviewContentFocusTracker = DOM.trackFocus(webview.container);\n\t\tstore.add(webviewContentFocusTracker);\n\t\tstore.add(webviewContentFocusTracker.onDidFocus(() => this._onDidFocusWebview.fire()));\n\n\t\t// Track focus in webview element\n\t\tstore.add(webview.onDidFocus(() => this._onDidFocusWebview.fire()));\n\n\t\treturn store;\n\t}\n}\n"],
  "mappings": "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",
  "names": []
}
