var U=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var w=(m,c,e,i)=>{for(var t=i>1?void 0:i?K(c,e):c,o=m.length-1,s;o>=0;o--)(s=m[o])&&(t=(i?s(c,e,t):s(t))||t);return i&&t&&U(c,e,t),t},a=(m,c)=>(e,i)=>c(e,i,m);import{Registry as I}from"../../../../platform/registry/common/platform.js";import{Extensions as A}from"../../../common/contributions.js";import{LifecyclePhase as D,ILifecycleService as j}from"../../../services/lifecycle/common/lifecycle.js";import{ITelemetryService as F}from"../../../../platform/telemetry/common/telemetry.js";import{IWorkspaceContextService as _,WorkbenchState as N}from"../../../../platform/workspace/common/workspace.js";import{IEditorService as z}from"../../../services/editor/common/editorService.js";import{IKeybindingService as H}from"../../../../platform/keybinding/common/keybinding.js";import{IWorkbenchThemeService as B}from"../../../services/themes/common/workbenchThemeService.js";import{IWorkbenchEnvironmentService as J}from"../../../services/environment/common/environmentService.js";import{language as G}from"../../../../base/common/platform.js";import{Disposable as M}from"../../../../base/common/lifecycle.js";import q from"../../../../platform/telemetry/browser/errorTelemetry.js";import{TelemetryTrustedValue as Y}from"../../../../platform/telemetry/common/telemetryUtils.js";import{ConfigurationTarget as p,ConfigurationTargetToString as k,IConfigurationService as X}from"../../../../platform/configuration/common/configuration.js";import{ITextFileService as $}from"../../../services/textfile/common/textfiles.js";import{extname as C,basename as V,isEqual as L,isEqualOrParent as W}from"../../../../base/common/resources.js";import"../../../../base/common/uri.js";import{Event as Q}from"../../../../base/common/event.js";import{Schemas as Z}from"../../../../base/common/network.js";import{getMimeTypes as ee}from"../../../../editor/common/services/languagesAssociations.js";import{hash as te}from"../../../../base/common/hash.js";import{IPaneCompositePartService as ie}from"../../../services/panecomposite/browser/panecomposite.js";import{ViewContainerLocation as E}from"../../../common/views.js";import{IUserDataProfileService as oe}from"../../../services/userDataProfile/common/userDataProfile.js";import{mainWindow as h}from"../../../../base/browser/window.js";import{Extensions as se}from"../../../../platform/configuration/common/configurationRegistry.js";import{isBoolean as R,isNumber as x,isString as P}from"../../../../base/common/types.js";import{LayoutSettings as ne}from"../../../services/layout/browser/layoutService.js";import{AutoRestartConfigurationKey as ae,AutoUpdateConfigurationKey as re}from"../../extensions/common/extensions.js";import{KEYWORD_ACTIVIATION_SETTING_ID as ce}from"../../chat/common/chatService.js";import{IUserDataProfilesService as ue}from"../../../../platform/userDataProfile/common/userDataProfile.js";let u=class extends M{constructor(e,i,t,o,s,r,n,f,g,S){super();this.telemetryService=e;this.contextService=i;this.userDataProfileService=f;const{filesToOpenOrCreate:y,filesToDiff:v,filesToMerge:T}=n,b=g.getActivePaneComposite(E.Sidebar);e.publicLog2("workspaceLoad",{windowSize:{innerHeight:h.innerHeight,innerWidth:h.innerWidth,outerHeight:h.outerHeight,outerWidth:h.outerWidth},emptyWorkbench:i.getWorkbenchState()===N.EMPTY,"workbench.filesToOpenOrCreate":y&&y.length||0,"workbench.filesToDiff":v&&v.length||0,"workbench.filesToMerge":T&&T.length||0,customKeybindingsCount:s.customKeybindingsCount(),theme:r.getColorTheme().id,language:G,pinnedViewlets:g.getPinnedPaneCompositeIds(E.Sidebar),restoredViewlet:b?b.getId():void 0,restoredEditors:o.visibleEditors.length,startupKind:t.startupKind}),this._register(new q(e)),this._register(S.files.onDidResolve(d=>this.onTextFileModelResolved(d))),this._register(S.files.onDidSave(d=>this.onTextFileModelSaved(d))),this._register(t.onDidShutdown(()=>this.dispose()))}static ALLOWLIST_JSON=["package.json","package-lock.json","tsconfig.json","jsconfig.json","bower.json",".eslintrc.json","tslint.json","composer.json"];static ALLOWLIST_WORKSPACE_JSON=["settings.json","extensions.json","tasks.json","launch.json"];onTextFileModelResolved(e){const i=this.getTypeIfSettings(e.model.resource);i?this.telemetryService.publicLog2("settingsRead",{settingsType:i}):this.telemetryService.publicLog2("fileGet",this.getTelemetryData(e.model.resource,e.reason))}onTextFileModelSaved(e){const i=this.getTypeIfSettings(e.model.resource);i?this.telemetryService.publicLog2("settingsWritten",{settingsType:i}):this.telemetryService.publicLog2("filePUT",this.getTelemetryData(e.model.resource,e.reason))}getTypeIfSettings(e){if(C(e)!==".json")return"";if(L(e,this.userDataProfileService.currentProfile.settingsResource))return"global-settings";if(L(e,this.userDataProfileService.currentProfile.keybindingsResource))return"keybindings";if(W(e,this.userDataProfileService.currentProfile.snippetsHome))return"snippets";const i=this.contextService.getWorkspace().folders;for(const t of i)if(W(e,t.toResource(".vscode"))){const o=V(e);if(u.ALLOWLIST_WORKSPACE_JSON.indexOf(o)>-1)return`.vscode/${o}`}return""}getTelemetryData(e,i){let t=C(e);const o=t.indexOf("?");t=o!==-1?t.substr(0,o):t;const s=V(e),r=e.scheme===Z.file?e.fsPath:e.path,n={mimeType:new Y(ee(e).join(", ")),ext:t,path:te(r),reason:i,allowlistedjson:void 0};return t===".json"&&u.ALLOWLIST_JSON.indexOf(s)>-1&&(n.allowlistedjson=s),n}};u=w([a(0,F),a(1,_),a(2,j),a(3,z),a(4,H),a(5,B),a(6,J),a(7,oe),a(8,ie),a(9,$)],u);let l=class extends M{constructor(e,i,t){super();this.configurationService=e;this.userDataProfilesService=i;this.telemetryService=t;const o=Q.debounce(e.onDidChangeConfiguration,(n,f)=>{const g=n?new Set([...n.affectedKeys,...f.affectedKeys]):f.affectedKeys;return{...f,affectedKeys:g}},1e3,!0);this._register(o(n=>{n.source!==p.DEFAULT&&t.publicLog2("updateConfiguration",{configurationSource:k(n.source),configurationKeys:Array.from(n.affectedKeys)})}));const{user:s,workspace:r}=e.keys();for(const n of s)this.reportTelemetry(n,p.USER_LOCAL);for(const n of r)this.reportTelemetry(n,p.WORKSPACE)}configurationRegistry=I.as(se.Configuration);getValueToReport(e,i){const t=this.configurationService.inspect(e),o=i===p.USER_LOCAL?t.user?.value:t.workspace?.value;if(x(o)||R(o))return o.toString();const s=this.configurationRegistry.getConfigurationProperties()[e];if(P(o))return s?.enum?.includes(o)?o:void 0;if(Array.isArray(o)&&o.every(r=>x(r)||R(r)||P(r)&&s?.enum?.includes(r)))return JSON.stringify(o)}reportTelemetry(e,i){const t=k(i);switch(e){case ne.ACTIVITY_BAR_LOCATION:this.telemetryService.publicLog2("workbench.activityBar.location",{settingValue:this.getValueToReport(e,i),source:t});return;case re:this.telemetryService.publicLog2("extensions.autoUpdate",{settingValue:this.getValueToReport(e,i),source:t});return;case"files.autoSave":this.telemetryService.publicLog2("files.autoSave",{settingValue:this.getValueToReport(e,i),source:t});return;case"editor.stickyScroll.enabled":this.telemetryService.publicLog2("editor.stickyScroll.enabled",{settingValue:this.getValueToReport(e,i),source:t});return;case ce:this.telemetryService.publicLog2("accessibility.voice.keywordActivation",{settingValue:this.getValueToReport(e,i),source:t});return;case"window.zoomLevel":this.telemetryService.publicLog2("window.zoomLevel",{settingValue:this.getValueToReport(e,i),source:t});return;case"window.zoomPerWindow":this.telemetryService.publicLog2("window.zoomPerWindow",{settingValue:this.getValueToReport(e,i),source:t});return;case"window.titleBarStyle":this.telemetryService.publicLog2("window.titleBarStyle",{settingValue:this.getValueToReport(e,i),source:t});return;case"window.customTitleBarVisibility":this.telemetryService.publicLog2("window.customTitleBarVisibility",{settingValue:this.getValueToReport(e,i),source:t});return;case"window.nativeTabs":this.telemetryService.publicLog2("window.nativeTabs",{settingValue:this.getValueToReport(e,i),source:t});return;case"extensions.verifySignature":this.telemetryService.publicLog2("extensions.verifySignature",{settingValue:this.getValueToReport(e,i),source:t});return;case"window.systemColorTheme":this.telemetryService.publicLog2("window.systemColorTheme",{settingValue:this.getValueToReport(e,i),source:t});return;case"window.newWindowProfile":{const o=this.getValueToReport(e,i),s=o===null?"null":o===this.userDataProfilesService.defaultProfile.name?"default":"custom";this.telemetryService.publicLog2("window.newWindowProfile",{settingValue:s,source:t});return}case ae:this.telemetryService.publicLog2("extensions.autoRestart",{settingValue:this.getValueToReport(e,i),source:t});return}}};l=w([a(0,X),a(1,ue),a(2,F)],l);const O=I.as(A.Workbench);O.registerWorkbenchContribution(u,D.Restored),O.registerWorkbenchContribution(l,D.Eventually);export{u as TelemetryContribution};
