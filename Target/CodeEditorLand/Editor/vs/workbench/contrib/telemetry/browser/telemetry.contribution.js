var U=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var w=(m,c,e,i)=>{for(var t=i>1?void 0:i?K(c,e):c,o=m.length-1,s;o>=0;o--)(s=m[o])&&(t=(i?s(c,e,t):s(t))||t);return i&&t&&U(c,e,t),t},a=(m,c)=>(e,i)=>c(e,i,m);import{mainWindow as p}from"../../../../../vs/base/browser/window.js";import{Event as A}from"../../../../../vs/base/common/event.js";import{hash as j}from"../../../../../vs/base/common/hash.js";import{Disposable as I}from"../../../../../vs/base/common/lifecycle.js";import{Schemas as _}from"../../../../../vs/base/common/network.js";import{language as N}from"../../../../../vs/base/common/platform.js";import{basename as D,extname as F,isEqual as M,isEqualOrParent as k}from"../../../../../vs/base/common/resources.js";import{isBoolean as C,isNumber as V,isString as L}from"../../../../../vs/base/common/types.js";import"../../../../../vs/base/common/uri.js";import{getMimeTypes as z}from"../../../../../vs/editor/common/services/languagesAssociations.js";import{ConfigurationTarget as h,ConfigurationTargetToString as W,IConfigurationService as H}from"../../../../../vs/platform/configuration/common/configuration.js";import{Extensions as B}from"../../../../../vs/platform/configuration/common/configurationRegistry.js";import{IKeybindingService as J}from"../../../../../vs/platform/keybinding/common/keybinding.js";import{Registry as E}from"../../../../../vs/platform/registry/common/platform.js";import G from"../../../../../vs/platform/telemetry/browser/errorTelemetry.js";import{ITelemetryService as R}from"../../../../../vs/platform/telemetry/common/telemetry.js";import{TelemetryTrustedValue as q}from"../../../../../vs/platform/telemetry/common/telemetryUtils.js";import{IUserDataProfilesService as Y}from"../../../../../vs/platform/userDataProfile/common/userDataProfile.js";import{IWorkspaceContextService as X,WorkbenchState as $}from"../../../../../vs/platform/workspace/common/workspace.js";import{Extensions as Q}from"../../../../../vs/workbench/common/contributions.js";import{ViewContainerLocation as x}from"../../../../../vs/workbench/common/views.js";import{KEYWORD_ACTIVIATION_SETTING_ID as Z}from"../../../../../vs/workbench/contrib/chat/common/chatService.js";import{AutoRestartConfigurationKey as ee,AutoUpdateConfigurationKey as te}from"../../../../../vs/workbench/contrib/extensions/common/extensions.js";import{IEditorService as ie}from"../../../../../vs/workbench/services/editor/common/editorService.js";import{IWorkbenchEnvironmentService as oe}from"../../../../../vs/workbench/services/environment/common/environmentService.js";import{LayoutSettings as se}from"../../../../../vs/workbench/services/layout/browser/layoutService.js";import{ILifecycleService as ne,LifecyclePhase as P}from"../../../../../vs/workbench/services/lifecycle/common/lifecycle.js";import{IPaneCompositePartService as ae}from"../../../../../vs/workbench/services/panecomposite/browser/panecomposite.js";import{ITextFileService as re}from"../../../../../vs/workbench/services/textfile/common/textfiles.js";import{IWorkbenchThemeService as ce}from"../../../../../vs/workbench/services/themes/common/workbenchThemeService.js";import{IUserDataProfileService as ue}from"../../../../../vs/workbench/services/userDataProfile/common/userDataProfile.js";let u=class extends I{constructor(e,i,t,o,s,r,n,f,g,S){super();this.telemetryService=e;this.contextService=i;this.userDataProfileService=f;const{filesToOpenOrCreate:y,filesToDiff:v,filesToMerge:T}=n,b=g.getActivePaneComposite(x.Sidebar);e.publicLog2("workspaceLoad",{windowSize:{innerHeight:p.innerHeight,innerWidth:p.innerWidth,outerHeight:p.outerHeight,outerWidth:p.outerWidth},emptyWorkbench:i.getWorkbenchState()===$.EMPTY,"workbench.filesToOpenOrCreate":y&&y.length||0,"workbench.filesToDiff":v&&v.length||0,"workbench.filesToMerge":T&&T.length||0,customKeybindingsCount:s.customKeybindingsCount(),theme:r.getColorTheme().id,language:N,pinnedViewlets:g.getPinnedPaneCompositeIds(x.Sidebar),restoredViewlet:b?b.getId():void 0,restoredEditors:o.visibleEditors.length,startupKind:t.startupKind}),this._register(new G(e)),this._register(S.files.onDidResolve(d=>this.onTextFileModelResolved(d))),this._register(S.files.onDidSave(d=>this.onTextFileModelSaved(d))),this._register(t.onDidShutdown(()=>this.dispose()))}static ALLOWLIST_JSON=["package.json","package-lock.json","tsconfig.json","jsconfig.json","bower.json",".eslintrc.json","tslint.json","composer.json"];static ALLOWLIST_WORKSPACE_JSON=["settings.json","extensions.json","tasks.json","launch.json"];onTextFileModelResolved(e){const i=this.getTypeIfSettings(e.model.resource);i?this.telemetryService.publicLog2("settingsRead",{settingsType:i}):this.telemetryService.publicLog2("fileGet",this.getTelemetryData(e.model.resource,e.reason))}onTextFileModelSaved(e){const i=this.getTypeIfSettings(e.model.resource);i?this.telemetryService.publicLog2("settingsWritten",{settingsType:i}):this.telemetryService.publicLog2("filePUT",this.getTelemetryData(e.model.resource,e.reason))}getTypeIfSettings(e){if(F(e)!==".json")return"";if(M(e,this.userDataProfileService.currentProfile.settingsResource))return"global-settings";if(M(e,this.userDataProfileService.currentProfile.keybindingsResource))return"keybindings";if(k(e,this.userDataProfileService.currentProfile.snippetsHome))return"snippets";const i=this.contextService.getWorkspace().folders;for(const t of i)if(k(e,t.toResource(".vscode"))){const o=D(e);if(u.ALLOWLIST_WORKSPACE_JSON.indexOf(o)>-1)return`.vscode/${o}`}return""}getTelemetryData(e,i){let t=F(e);const o=t.indexOf("?");t=o!==-1?t.substr(0,o):t;const s=D(e),r=e.scheme===_.file?e.fsPath:e.path,n={mimeType:new q(z(e).join(", ")),ext:t,path:j(r),reason:i,allowlistedjson:void 0};return t===".json"&&u.ALLOWLIST_JSON.indexOf(s)>-1&&(n.allowlistedjson=s),n}};u=w([a(0,R),a(1,X),a(2,ne),a(3,ie),a(4,J),a(5,ce),a(6,oe),a(7,ue),a(8,ae),a(9,re)],u);let l=class extends I{constructor(e,i,t){super();this.configurationService=e;this.userDataProfilesService=i;this.telemetryService=t;const o=A.debounce(e.onDidChangeConfiguration,(n,f)=>{const g=n?new Set([...n.affectedKeys,...f.affectedKeys]):f.affectedKeys;return{...f,affectedKeys:g}},1e3,!0);this._register(o(n=>{n.source!==h.DEFAULT&&t.publicLog2("updateConfiguration",{configurationSource:W(n.source),configurationKeys:Array.from(n.affectedKeys)})}));const{user:s,workspace:r}=e.keys();for(const n of s)this.reportTelemetry(n,h.USER_LOCAL);for(const n of r)this.reportTelemetry(n,h.WORKSPACE)}configurationRegistry=E.as(B.Configuration);getValueToReport(e,i){const t=this.configurationService.inspect(e),o=i===h.USER_LOCAL?t.user?.value:t.workspace?.value;if(V(o)||C(o))return o.toString();const s=this.configurationRegistry.getConfigurationProperties()[e];if(L(o))return s?.enum?.includes(o)?o:void 0;if(Array.isArray(o)&&o.every(r=>V(r)||C(r)||L(r)&&s?.enum?.includes(r)))return JSON.stringify(o)}reportTelemetry(e,i){const t=W(i);switch(e){case se.ACTIVITY_BAR_LOCATION:this.telemetryService.publicLog2("workbench.activityBar.location",{settingValue:this.getValueToReport(e,i),source:t});return;case te:this.telemetryService.publicLog2("extensions.autoUpdate",{settingValue:this.getValueToReport(e,i),source:t});return;case"files.autoSave":this.telemetryService.publicLog2("files.autoSave",{settingValue:this.getValueToReport(e,i),source:t});return;case"editor.stickyScroll.enabled":this.telemetryService.publicLog2("editor.stickyScroll.enabled",{settingValue:this.getValueToReport(e,i),source:t});return;case Z:this.telemetryService.publicLog2("accessibility.voice.keywordActivation",{settingValue:this.getValueToReport(e,i),source:t});return;case"window.zoomLevel":this.telemetryService.publicLog2("window.zoomLevel",{settingValue:this.getValueToReport(e,i),source:t});return;case"window.zoomPerWindow":this.telemetryService.publicLog2("window.zoomPerWindow",{settingValue:this.getValueToReport(e,i),source:t});return;case"window.titleBarStyle":this.telemetryService.publicLog2("window.titleBarStyle",{settingValue:this.getValueToReport(e,i),source:t});return;case"window.customTitleBarVisibility":this.telemetryService.publicLog2("window.customTitleBarVisibility",{settingValue:this.getValueToReport(e,i),source:t});return;case"window.nativeTabs":this.telemetryService.publicLog2("window.nativeTabs",{settingValue:this.getValueToReport(e,i),source:t});return;case"extensions.verifySignature":this.telemetryService.publicLog2("extensions.verifySignature",{settingValue:this.getValueToReport(e,i),source:t});return;case"window.systemColorTheme":this.telemetryService.publicLog2("window.systemColorTheme",{settingValue:this.getValueToReport(e,i),source:t});return;case"window.newWindowProfile":{const o=this.getValueToReport(e,i),s=o===null?"null":o===this.userDataProfilesService.defaultProfile.name?"default":"custom";this.telemetryService.publicLog2("window.newWindowProfile",{settingValue:s,source:t});return}case ee:this.telemetryService.publicLog2("extensions.autoRestart",{settingValue:this.getValueToReport(e,i),source:t});return}}};l=w([a(0,H),a(1,Y),a(2,R)],l);const O=E.as(Q.Workbench);O.registerWorkbenchContribution(u,P.Restored),O.registerWorkbenchContribution(l,P.Eventually);export{u as TelemetryContribution};
