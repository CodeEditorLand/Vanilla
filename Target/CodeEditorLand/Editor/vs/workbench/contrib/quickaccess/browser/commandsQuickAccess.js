var R=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var C=(f,a,t,i)=>{for(var o=i>1?void 0:i?T(a,t):a,r=f.length-1,e;r>=0;r--)(e=f[r])&&(o=(i?e(a,t,o):e(o))||o);return i&&o&&R(a,t,o),o},n=(f,a)=>(t,i)=>a(t,i,f);import{isFirefox as x}from"../../../../base/browser/browser.js";import{raceTimeout as w,timeout as D}from"../../../../base/common/async.js";import"../../../../base/common/cancellation.js";import{Codicon as _}from"../../../../base/common/codicons.js";import{stripIcons as O}from"../../../../base/common/iconLabels.js";import{KeyCode as v,KeyMod as h}from"../../../../base/common/keyCodes.js";import{Language as M}from"../../../../base/common/platform.js";import{ThemeIcon as N}from"../../../../base/common/themables.js";import"../../../../editor/common/editorCommon.js";import{AbstractEditorCommandsQuickAccessProvider as K}from"../../../../editor/contrib/quickAccess/browser/commandsQuickAccess.js";import{localize as u,localize2 as S}from"../../../../nls.js";import{isLocalizedString as Q}from"../../../../platform/action/common/action.js";import{Action2 as y,IMenuService as L,MenuId as F,MenuItemAction as H}from"../../../../platform/actions/common/actions.js";import{ICommandService as G}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as A}from"../../../../platform/configuration/common/configuration.js";import{IDialogService as k}from"../../../../platform/dialogs/common/dialogs.js";import{IInstantiationService as W}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as q}from"../../../../platform/keybinding/common/keybinding.js";import{KeybindingWeight as V}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{IProductService as z}from"../../../../platform/product/common/productService.js";import{CommandsHistory as P}from"../../../../platform/quickinput/browser/commandsQuickAccess.js";import{TriggerAction as B}from"../../../../platform/quickinput/browser/pickerQuickAccess.js";import{DefaultQuickAccessFilterValue as U}from"../../../../platform/quickinput/common/quickAccess.js";import{IQuickInputService as X}from"../../../../platform/quickinput/common/quickInput.js";import{IStorageService as $}from"../../../../platform/storage/common/storage.js";import{ITelemetryService as j}from"../../../../platform/telemetry/common/telemetry.js";import"../../../browser/quickaccess.js";import{CHAT_OPEN_ACTION_ID as J}from"../../chat/browser/actions/chatActions.js";import{ASK_QUICK_QUESTION_ACTION_ID as Y}from"../../chat/browser/actions/chatQuickInputActions.js";import{ChatAgentLocation as Z,IChatAgentService as ee}from"../../chat/common/chatAgents.js";import{IAiRelatedInformationService as te,RelatedInformationType as ie}from"../../../services/aiRelatedInformation/common/aiRelatedInformation.js";import{IEditorGroupsService as oe}from"../../../services/editor/common/editorGroupsService.js";import{IEditorService as ne}from"../../../services/editor/common/editorService.js";import{IExtensionService as re}from"../../../services/extensions/common/extensions.js";import{createKeybindingCommandQuery as ae}from"../../../services/preferences/browser/keybindingsEditorModel.js";import{IPreferencesService as ce}from"../../../services/preferences/common/preferences.js";let l=class extends K{constructor(t,i,o,r,e,c,m,s,d,p,g,I,me,se){super({showAlias:!M.isDefaultVariant(),noResultsPick:()=>({label:u("noCommandResults","No matching commands"),commandId:""})},r,e,c,m,s);this.editorService=t;this.menuService=i;this.extensionService=o;this.configurationService=d;this.editorGroupService=p;this.preferencesService=g;this.productService=I;this.aiRelatedInformationService=me;this.chatAgentService=se;this._register(d.onDidChangeConfiguration(E=>this.updateOptions(E))),this.updateOptions()}static AI_RELATED_INFORMATION_MAX_PICKS=5;static AI_RELATED_INFORMATION_DEBOUNCE=200;extensionRegistrationRace=w(this.extensionService.whenInstalledExtensionsRegistered(),800);useAiRelatedInfo=!1;get activeTextEditorControl(){return this.editorService.activeTextEditorControl}get defaultFilterValue(){if(this.configuration.preserveInput)return U.LAST}get configuration(){const t=this.configurationService.getValue().workbench.commandPalette;return{preserveInput:t.preserveInput,experimental:t.experimental}}updateOptions(t){if(t&&!t.affectsConfiguration("workbench.commandPalette.experimental"))return;const i=this.configuration,o=i.experimental.suggestCommands&&this.productService.commandPaletteSuggestedCommandIds?.length?new Set(this.productService.commandPaletteSuggestedCommandIds):void 0;this.options.suggestedCommandIds=o,this.useAiRelatedInfo=i.experimental.enableNaturalLanguageSearch}async getCommandPicks(t){return await this.extensionRegistrationRace,t.isCancellationRequested?[]:[...this.getCodeEditorCommandPicks(),...this.getGlobalCommandPicks()].map(i=>({...i,buttons:[{iconClass:N.asClassName(_.gear),tooltip:u("configure keybinding","Configure Keybinding")}],trigger:()=>(this.preferencesService.openGlobalKeybindingSettings(!1,{query:ae(i.commandId,i.commandWhen)}),B.CLOSE_PICKER)}))}hasAdditionalCommandPicks(t,i){return!(!this.useAiRelatedInfo||i.isCancellationRequested||t===""||!this.aiRelatedInformationService.isEnabled())}async getAdditionalCommandPicks(t,i,o,r){if(!this.hasAdditionalCommandPicks(o,r))return[];let e;try{await D(l.AI_RELATED_INFORMATION_DEBOUNCE,r),e=await this.getRelatedInformationPicks(t,i,o,r)}catch{return[]}(i.length||e.length)&&e.push({type:"separator"});const c=this.chatAgentService.getDefaultAgent(Z.Panel);return c&&e.push({label:u("askXInChat","Ask {0}: {1}",c.fullName,o),commandId:this.configuration.experimental.askChatLocation==="quickChat"?Y:J,args:[o]}),e}async getRelatedInformationPicks(t,i,o,r){const e=await this.aiRelatedInformationService.getRelatedInformation(o,[ie.CommandInformation],r);e.sort((s,d)=>d.weight-s.weight);const c=new Set(i.map(s=>s.commandId)),m=new Array;for(const s of e){if(m.length===l.AI_RELATED_INFORMATION_MAX_PICKS)break;const d=t.find(p=>p.commandId===s.command&&!c.has(p.commandId));d&&m.push(d)}return m}getGlobalCommandPicks(){const t=[],i=this.editorService.activeEditorPane?.scopedContextKeyService||this.editorGroupService.activeGroup.scopedContextKeyService,r=this.menuService.getMenuActions(F.CommandPalette,i).reduce((e,[,c])=>[...e,...c],[]).filter(e=>e instanceof H&&e.enabled);for(const e of r){let c=(typeof e.item.title=="string"?e.item.title:e.item.title.value)||e.item.id;const m=typeof e.item.category=="string"?e.item.category:e.item.category?.value;m&&(c=u("commandWithCategory","{0}: {1}",m,c));const s=typeof e.item.title!="string"?e.item.title.original:void 0,d=m&&e.item.category&&typeof e.item.category!="string"?e.item.category.original:void 0,p=s&&m?d?`${d}: ${s}`:`${m}: ${s}`:s,g=e.item.metadata?.description,I=g===void 0||Q(g)?g:{value:g,original:g};t.push({commandId:e.item.id,commandWhen:e.item.precondition?.serialize(),commandAlias:p,label:O(c),commandDescription:I})}return t}};l=C([n(0,ne),n(1,L),n(2,re),n(3,W),n(4,q),n(5,G),n(6,j),n(7,k),n(8,A),n(9,oe),n(10,ce),n(11,z),n(12,te),n(13,ee)],l);class b extends y{static ID="workbench.action.showCommands";constructor(){super({id:b.ID,title:S("showTriggerActions","Show All Commands"),keybinding:{weight:V.WorkbenchContrib,when:void 0,primary:x?void 0:h.CtrlCmd|h.Shift|v.KeyP,secondary:[v.F1]},f1:!0})}async run(a){a.get(X).quickAccess.show(l.PREFIX)}}class it extends y{constructor(){super({id:"workbench.action.clearCommandHistory",title:S("clearCommandHistory","Clear Command History"),f1:!0})}async run(a){const t=a.get(A),i=a.get($),o=a.get(k);if(P.getConfiguredCommandHistoryLength(t)>0){const{confirmed:e}=await o.confirm({type:"warning",message:u("confirmClearMessage","Do you want to clear the history of recently used commands?"),detail:u("confirmClearDetail","This action is irreversible!"),primaryButton:u({key:"clearButtonLabel",comment:["&& denotes a mnemonic"]},"&&Clear")});if(!e)return;P.clearHistory(t,i)}}}export{it as ClearCommandHistoryAction,l as CommandsQuickAccessProvider,b as ShowAllCommandsAction};
