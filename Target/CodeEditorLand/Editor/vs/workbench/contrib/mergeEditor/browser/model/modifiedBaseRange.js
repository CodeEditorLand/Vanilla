import{compareBy as S,equals as v,numberComparator as C,tieBreakComparators as D}from"../../../../../base/common/arrays.js";import{BugIndicatingError as B}from"../../../../../base/common/errors.js";import{splitLines as N}from"../../../../../base/common/strings.js";import{Constants as y}from"../../../../../base/common/uint.js";import{Position as l}from"../../../../../editor/common/core/position.js";import{Range as R}from"../../../../../editor/common/core/range.js";import"../../../../../editor/common/model.js";import{LineRangeEdit as w,RangeEdit as T}from"./editing.js";import"./lineRange.js";import{DetailedLineRangeMapping as E,MappingAlignment as k}from"./mapping.js";import{concatArrays as V}from"../utils.js";class x{constructor(e,n,i,u,t,r,s,M){this.baseRange=e;this.baseTextModel=n;this.input1Range=i;this.input1TextModel=u;this.input1Diffs=t;this.input2Range=r;this.input2TextModel=s;this.input2Diffs=M;if(this.input1Diffs.length===0&&this.input2Diffs.length===0)throw new B("must have at least one diff")}static fromDiffs(e,n,i,u,t){return k.compute(e,n).map(s=>new x(s.inputRange,i,s.output1Range,u,s.output1LineMappings,s.output2Range,t,s.output2LineMappings))}input1CombinedDiff=E.join(this.input1Diffs);input2CombinedDiff=E.join(this.input2Diffs);isEqualChange=v(this.input1Diffs,this.input2Diffs,(e,n)=>e.getLineEdit().equals(n.getLineEdit()));getInputRange(e){return e===1?this.input1Range:this.input2Range}getInputCombinedDiff(e){return e===1?this.input1CombinedDiff:this.input2CombinedDiff}getInputDiffs(e){return e===1?this.input1Diffs:this.input2Diffs}get isConflicting(){return this.input1Diffs.length>0&&this.input2Diffs.length>0}get canBeCombined(){return this.smartCombineInputs(1)!==void 0}get isOrderRelevant(){const e=this.smartCombineInputs(1),n=this.smartCombineInputs(2);return!e||!n?!1:!e.equals(n)}getEditForBase(e){const n=[];if(e.includesInput1&&this.input1CombinedDiff&&n.push({diff:this.input1CombinedDiff,inputNumber:1}),e.includesInput2&&this.input2CombinedDiff&&n.push({diff:this.input2CombinedDiff,inputNumber:2}),n.length===0)return{edit:void 0,effectiveState:g.base};if(n.length===1)return{edit:n[0].diff.getLineEdit(),effectiveState:g.base.withInputValue(n[0].inputNumber,!0,!1)};if(e.kind!==3)throw new B;const i=e.smartCombination?this.smartCombineInputs(e.firstInput):this.dumbCombineInputs(e.firstInput);return i?{edit:i,effectiveState:e}:{edit:n[h(e.firstInput)-1].diff.getLineEdit(),effectiveState:g.base.withInputValue(h(e.firstInput),!0,!1)}}smartInput1LineRangeEdit=null;smartInput2LineRangeEdit=null;smartCombineInputs(e){if(e===1&&this.smartInput1LineRangeEdit!==null)return this.smartInput1LineRangeEdit;if(e===2&&this.smartInput2LineRangeEdit!==null)return this.smartInput2LineRangeEdit;const i=V(this.input1Diffs.flatMap(t=>t.rangeMappings.map(r=>({diff:r,input:1}))),this.input2Diffs.flatMap(t=>t.rangeMappings.map(r=>({diff:r,input:2})))).sort(D(S(t=>t.diff.inputRange,R.compareRangesUsingStarts),S(t=>t.input===e?1:2,C))).map(t=>{const r=t.input===1?this.input1TextModel:this.input2TextModel;return new T(t.diff.inputRange,r.getValueInRange(t.diff.outputRange))}),u=q(this.baseRange,i,this.baseTextModel);return e===1?this.smartInput1LineRangeEdit=u:this.smartInput2LineRangeEdit=u,u}dumbInput1LineRangeEdit=null;dumbInput2LineRangeEdit=null;dumbCombineInputs(e){if(e===1&&this.dumbInput1LineRangeEdit!==null)return this.dumbInput1LineRangeEdit;if(e===2&&this.dumbInput2LineRangeEdit!==null)return this.dumbInput2LineRangeEdit;let n=this.input1Range.getLines(this.input1TextModel),i=this.input2Range.getLines(this.input2TextModel);e===2&&([n,i]=[i,n]);const u=new w(this.baseRange,n.concat(i));return e===1?this.dumbInput1LineRangeEdit=u:this.dumbInput2LineRangeEdit=u,u}}function q(a,e,n){let i="";const u=a.startLineNumber>1;let t=u?new l(a.startLineNumber-1,n.getLineMaxColumn(a.startLineNumber-1)):new l(a.startLineNumber,1);for(const c of e){const m=c.range.getStartPosition();if(!t.isBeforeOrEqual(m))return;let L=n.getValueInRange(R.fromPositions(t,m));m.lineNumber>n.getLineCount()&&(L+=`
`),i+=L,i+=c.newText,t=c.range.getEndPosition()}const r=a.endLineNumberExclusive<=n.getLineCount(),s=r?new l(a.endLineNumberExclusive,1):new l(a.endLineNumberExclusive-1,y.MAX_SAFE_SMALL_INTEGER),M=n.getValueInRange(R.fromPositions(t,s));i+=M;const d=N(i);if(u){if(d[0]!=="")return;d.shift()}if(r){if(d[d.length-1]!=="")return;d.pop()}return new w(a,d)}var z=(t=>(t[t.base=0]="base",t[t.input1=1]="input1",t[t.input2=2]="input2",t[t.both=3]="both",t[t.unrecognized=4]="unrecognized",t))(z||{});function h(a){return a===1?2:1}class p{constructor(){}get includesInput1(){return!1}get includesInput2(){return!1}includesInput(e){return e===1?this.includesInput1:this.includesInput2}isInputIncluded(e){return e===1?this.includesInput1:this.includesInput2}toggle(e){return this.withInputValue(e,!this.includesInput(e),!0)}getInput(e){return this.isInputIncluded(e)?1:0}}class I extends p{get kind(){return 0}toString(){return"base"}swap(){return this}withInputValue(e,n,i=!1){return e===1?n?new f:this:n?new o:this}equals(e){return e.kind===0}}class f extends p{get kind(){return 1}get includesInput1(){return!0}toString(){return"1\u2713"}swap(){return new o}withInputValue(e,n,i=!1){return e===1?n?this:new I:n?new b(1,i):new o}equals(e){return e.kind===1}}class o extends p{get kind(){return 2}get includesInput2(){return!0}toString(){return"2\u2713"}swap(){return new f}withInputValue(e,n,i=!1){return e===2?n?this:new I:n?new b(2,i):new o}equals(e){return e.kind===2}}class b extends p{constructor(n,i){super();this.firstInput=n;this.smartCombination=i}get kind(){return 3}get includesInput1(){return!0}get includesInput2(){return!0}toString(){return"2\u2713"}swap(){return new b(h(this.firstInput),this.smartCombination)}withInputValue(n,i,u=!1){return i?this:n===1?new o:new f}equals(n){return n.kind===3&&this.firstInput===n.firstInput&&this.smartCombination===n.smartCombination}getInput(n){return n===this.firstInput?1:2}}class A extends p{get kind(){return 4}toString(){return"unrecognized"}swap(){return this}withInputValue(e,n,i=!1){return n?e===1?new f:new o:this}equals(e){return e.kind===4}}var g;(n=>(n.base=new I,n.unrecognized=new A))(g||={});var K=(u=>(u[u.excluded=0]="excluded",u[u.first=1]="first",u[u.second=2]="second",u[u.unrecognized=3]="unrecognized",u))(K||{});export{p as AbstractModifiedBaseRangeState,K as InputState,x as ModifiedBaseRange,g as ModifiedBaseRangeState,I as ModifiedBaseRangeStateBase,b as ModifiedBaseRangeStateBoth,f as ModifiedBaseRangeStateInput1,o as ModifiedBaseRangeStateInput2,z as ModifiedBaseRangeStateKind,A as ModifiedBaseRangeStateUnrecognized,h as getOtherInputNumber};
