{
  "version": 3,
  "sources": ["../../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/contrib/mergeEditor/browser/model/textModelDiffs.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport {\n\tcompareBy,\n\tnumberComparator,\n} from \"../../../../../base/common/arrays.js\";\nimport { ReentrancyBarrier } from \"../../../../../base/common/controlFlow.js\";\nimport { BugIndicatingError } from \"../../../../../base/common/errors.js\";\nimport {\n\tDisposable,\n\ttoDisposable,\n} from \"../../../../../base/common/lifecycle.js\";\nimport {\n\ttype IObservable,\n\ttype IReader,\n\ttype ITransaction,\n\tautorun,\n\tobservableSignal,\n\tobservableValue,\n\ttransaction,\n} from \"../../../../../base/common/observable.js\";\nimport type { ITextModel } from \"../../../../../editor/common/model.js\";\nimport type { UndoRedoGroup } from \"../../../../../platform/undoRedo/common/undoRedo.js\";\nimport type { IMergeDiffComputer } from \"./diffComputer.js\";\nimport { LineRangeEdit } from \"./editing.js\";\nimport { LineRange } from \"./lineRange.js\";\nimport { DetailedLineRangeMapping } from \"./mapping.js\";\n\nexport class TextModelDiffs extends Disposable {\n\tprivate _recomputeCount = 0;\n\tprivate readonly _state = observableValue<\n\t\tTextModelDiffState,\n\t\tTextModelDiffChangeReason\n\t>(this, TextModelDiffState.initializing);\n\tprivate readonly _diffs = observableValue<\n\t\tDetailedLineRangeMapping[],\n\t\tTextModelDiffChangeReason\n\t>(this, []);\n\n\tprivate readonly _barrier = new ReentrancyBarrier();\n\tprivate _isDisposed = false;\n\n\tpublic get isApplyingChange() {\n\t\treturn this._barrier.isOccupied;\n\t}\n\n\tconstructor(\n\t\tprivate readonly baseTextModel: ITextModel,\n\t\tprivate readonly textModel: ITextModel,\n\t\tprivate readonly diffComputer: IMergeDiffComputer,\n\t) {\n\t\tsuper();\n\n\t\tconst recomputeSignal = observableSignal(\"recompute\");\n\n\t\tthis._register(\n\t\t\tautorun((reader) => {\n\t\t\t\t/** @description Update diff state */\n\t\t\t\trecomputeSignal.read(reader);\n\t\t\t\tthis._recompute(reader);\n\t\t\t}),\n\t\t);\n\n\t\tthis._register(\n\t\t\tbaseTextModel.onDidChangeContent(\n\t\t\t\tthis._barrier.makeExclusiveOrSkip(() => {\n\t\t\t\t\trecomputeSignal.trigger(undefined);\n\t\t\t\t}),\n\t\t\t),\n\t\t);\n\t\tthis._register(\n\t\t\ttextModel.onDidChangeContent(\n\t\t\t\tthis._barrier.makeExclusiveOrSkip(() => {\n\t\t\t\t\trecomputeSignal.trigger(undefined);\n\t\t\t\t}),\n\t\t\t),\n\t\t);\n\t\tthis._register(\n\t\t\ttoDisposable(() => {\n\t\t\t\tthis._isDisposed = true;\n\t\t\t}),\n\t\t);\n\t}\n\n\tpublic get state(): IObservable<\n\t\tTextModelDiffState,\n\t\tTextModelDiffChangeReason\n\t> {\n\t\treturn this._state;\n\t}\n\n\t/**\n\t * Diffs from base to input.\n\t */\n\tpublic get diffs(): IObservable<\n\t\tDetailedLineRangeMapping[],\n\t\tTextModelDiffChangeReason\n\t> {\n\t\treturn this._diffs;\n\t}\n\n\tprivate _isInitializing = true;\n\n\tprivate _recompute(reader: IReader): void {\n\t\tthis._recomputeCount++;\n\t\tconst currentRecomputeIdx = this._recomputeCount;\n\n\t\tif (this._state.get() === TextModelDiffState.initializing) {\n\t\t\tthis._isInitializing = true;\n\t\t}\n\n\t\ttransaction((tx) => {\n\t\t\t/** @description Starting Diff Computation. */\n\t\t\tthis._state.set(\n\t\t\t\tthis._isInitializing\n\t\t\t\t\t? TextModelDiffState.initializing\n\t\t\t\t\t: TextModelDiffState.updating,\n\t\t\t\ttx,\n\t\t\t\tTextModelDiffChangeReason.other,\n\t\t\t);\n\t\t});\n\n\t\tconst result = this.diffComputer.computeDiff(\n\t\t\tthis.baseTextModel,\n\t\t\tthis.textModel,\n\t\t\treader,\n\t\t);\n\n\t\tresult.then((result) => {\n\t\t\tif (this._isDisposed) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (currentRecomputeIdx !== this._recomputeCount) {\n\t\t\t\t// There is a newer recompute call\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\ttransaction((tx) => {\n\t\t\t\t/** @description Completed Diff Computation */\n\t\t\t\tif (result.diffs) {\n\t\t\t\t\tthis._state.set(\n\t\t\t\t\t\tTextModelDiffState.upToDate,\n\t\t\t\t\t\ttx,\n\t\t\t\t\t\tTextModelDiffChangeReason.textChange,\n\t\t\t\t\t);\n\t\t\t\t\tthis._diffs.set(\n\t\t\t\t\t\tresult.diffs,\n\t\t\t\t\t\ttx,\n\t\t\t\t\t\tTextModelDiffChangeReason.textChange,\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\tthis._state.set(\n\t\t\t\t\t\tTextModelDiffState.error,\n\t\t\t\t\t\ttx,\n\t\t\t\t\t\tTextModelDiffChangeReason.textChange,\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tthis._isInitializing = false;\n\t\t\t});\n\t\t});\n\t}\n\n\tprivate ensureUpToDate(): void {\n\t\tif (this.state.get() !== TextModelDiffState.upToDate) {\n\t\t\tthrow new BugIndicatingError(\n\t\t\t\t\"Cannot remove diffs when the model is not up to date\",\n\t\t\t);\n\t\t}\n\t}\n\n\tpublic removeDiffs(\n\t\tdiffToRemoves: DetailedLineRangeMapping[],\n\t\ttransaction: ITransaction | undefined,\n\t\tgroup?: UndoRedoGroup,\n\t): void {\n\t\tthis.ensureUpToDate();\n\n\t\tdiffToRemoves.sort(\n\t\t\tcompareBy((d) => d.inputRange.startLineNumber, numberComparator),\n\t\t);\n\t\tdiffToRemoves.reverse();\n\n\t\tlet diffs = this._diffs.get();\n\n\t\tfor (const diffToRemove of diffToRemoves) {\n\t\t\t// TODO improve performance\n\t\t\tconst len = diffs.length;\n\t\t\tdiffs = diffs.filter((d) => d !== diffToRemove);\n\t\t\tif (len === diffs.length) {\n\t\t\t\tthrow new BugIndicatingError();\n\t\t\t}\n\n\t\t\tthis._barrier.runExclusivelyOrThrow(() => {\n\t\t\t\tconst edits = diffToRemove\n\t\t\t\t\t.getReverseLineEdit()\n\t\t\t\t\t.toEdits(this.textModel.getLineCount());\n\t\t\t\tthis.textModel.pushEditOperations(\n\t\t\t\t\tnull,\n\t\t\t\t\tedits,\n\t\t\t\t\t() => null,\n\t\t\t\t\tgroup,\n\t\t\t\t);\n\t\t\t});\n\n\t\t\tdiffs = diffs.map((d) =>\n\t\t\t\td.outputRange.isAfter(diffToRemove.outputRange)\n\t\t\t\t\t? d.addOutputLineDelta(\n\t\t\t\t\t\t\tdiffToRemove.inputRange.lineCount -\n\t\t\t\t\t\t\t\tdiffToRemove.outputRange.lineCount,\n\t\t\t\t\t\t)\n\t\t\t\t\t: d,\n\t\t\t);\n\t\t}\n\n\t\tthis._diffs.set(diffs, transaction, TextModelDiffChangeReason.other);\n\t}\n\n\t/**\n\t * Edit must be conflict free.\n\t */\n\tpublic applyEditRelativeToOriginal(\n\t\tedit: LineRangeEdit,\n\t\ttransaction: ITransaction | undefined,\n\t\tgroup?: UndoRedoGroup,\n\t): void {\n\t\tthis.ensureUpToDate();\n\n\t\tconst editMapping = new DetailedLineRangeMapping(\n\t\t\tedit.range,\n\t\t\tthis.baseTextModel,\n\t\t\tnew LineRange(edit.range.startLineNumber, edit.newLines.length),\n\t\t\tthis.textModel,\n\t\t);\n\n\t\tlet firstAfter = false;\n\t\tlet delta = 0;\n\t\tconst newDiffs = new Array<DetailedLineRangeMapping>();\n\t\tfor (const diff of this.diffs.get()) {\n\t\t\tif (diff.inputRange.touches(edit.range)) {\n\t\t\t\tthrow new BugIndicatingError(\"Edit must be conflict free.\");\n\t\t\t} else if (diff.inputRange.isAfter(edit.range)) {\n\t\t\t\tif (!firstAfter) {\n\t\t\t\t\tfirstAfter = true;\n\t\t\t\t\tnewDiffs.push(editMapping.addOutputLineDelta(delta));\n\t\t\t\t}\n\n\t\t\t\tnewDiffs.push(\n\t\t\t\t\tdiff.addOutputLineDelta(\n\t\t\t\t\t\tedit.newLines.length - edit.range.lineCount,\n\t\t\t\t\t),\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\tnewDiffs.push(diff);\n\t\t\t}\n\n\t\t\tif (!firstAfter) {\n\t\t\t\tdelta += diff.outputRange.lineCount - diff.inputRange.lineCount;\n\t\t\t}\n\t\t}\n\n\t\tif (!firstAfter) {\n\t\t\tfirstAfter = true;\n\t\t\tnewDiffs.push(editMapping.addOutputLineDelta(delta));\n\t\t}\n\n\t\tthis._barrier.runExclusivelyOrThrow(() => {\n\t\t\tconst edits = new LineRangeEdit(\n\t\t\t\tedit.range.delta(delta),\n\t\t\t\tedit.newLines,\n\t\t\t).toEdits(this.textModel.getLineCount());\n\t\t\tthis.textModel.pushEditOperations(null, edits, () => null, group);\n\t\t});\n\t\tthis._diffs.set(newDiffs, transaction, TextModelDiffChangeReason.other);\n\t}\n\n\tpublic findTouchingDiffs(baseRange: LineRange): DetailedLineRangeMapping[] {\n\t\treturn this.diffs.get().filter((d) => d.inputRange.touches(baseRange));\n\t}\n\n\tprivate getResultLine(\n\t\tlineNumber: number,\n\t\treader?: IReader,\n\t): number | DetailedLineRangeMapping {\n\t\tlet offset = 0;\n\t\tconst diffs = reader ? this.diffs.read(reader) : this.diffs.get();\n\t\tfor (const diff of diffs) {\n\t\t\tif (\n\t\t\t\tdiff.inputRange.contains(lineNumber) ||\n\t\t\t\tdiff.inputRange.endLineNumberExclusive === lineNumber\n\t\t\t) {\n\t\t\t\treturn diff;\n\t\t\t} else if (diff.inputRange.endLineNumberExclusive < lineNumber) {\n\t\t\t\toffset = diff.resultingDeltaFromOriginalToModified;\n\t\t\t} else {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\treturn lineNumber + offset;\n\t}\n\n\tpublic getResultLineRange(\n\t\tbaseRange: LineRange,\n\t\treader?: IReader,\n\t): LineRange {\n\t\tlet start = this.getResultLine(baseRange.startLineNumber, reader);\n\t\tif (typeof start !== \"number\") {\n\t\t\tstart = start.outputRange.startLineNumber;\n\t\t}\n\t\tlet endExclusive = this.getResultLine(\n\t\t\tbaseRange.endLineNumberExclusive,\n\t\t\treader,\n\t\t);\n\t\tif (typeof endExclusive !== \"number\") {\n\t\t\tendExclusive = endExclusive.outputRange.endLineNumberExclusive;\n\t\t}\n\n\t\treturn LineRange.fromLineNumbers(start, endExclusive);\n\t}\n}\n\nexport enum TextModelDiffChangeReason {\n\tother = 0,\n\ttextChange = 1,\n}\n\nexport enum TextModelDiffState {\n\tinitializing = 1,\n\tupToDate = 2,\n\tupdating = 3,\n\terror = 4,\n}\n\nexport interface ITextModelDiffsState {\n\tstate: TextModelDiffState;\n\tdiffs: DetailedLineRangeMapping[];\n}\n"],
  "mappings": "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",
  "names": ["result", "transaction", "TextModelDiffChangeReason", "TextModelDiffState"]
}
