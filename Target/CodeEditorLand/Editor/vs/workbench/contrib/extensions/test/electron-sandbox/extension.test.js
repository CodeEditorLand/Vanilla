import n from"assert";import{ExtensionState as s}from"../../common/extensions.js";import{Extension as o}from"../../browser/extensionsWorkbenchService.js";import"../../../../../platform/extensionManagement/common/extensionManagement.js";import{ExtensionType as c,TargetPlatform as u}from"../../../../../platform/extensions/common/extensions.js";import{URI as p}from"../../../../../base/common/uri.js";import{getGalleryExtensionId as x}from"../../../../../platform/extensionManagement/common/extensionManagementUtil.js";import{generateUuid as E}from"../../../../../base/common/uuid.js";import{TestInstantiationService as y}from"../../../../../platform/instantiation/test/common/instantiationServiceMock.js";import{IProductService as m}from"../../../../../platform/product/common/productService.js";import{ensureNoDisposablesAreLeakedInTestSuite as g}from"../../../../../base/test/common/utils.js";suite("Extension Test",()=>{const I=g();let t;setup(()=>{t=I.add(new y),t.stub(m,{quality:"insiders"})}),test("extension is not outdated when there is no local and gallery",()=>{const e=t.createInstance(o,()=>s.Installed,()=>{},void 0,void 0,void 0,void 0);n.strictEqual(e.outdated,!1)}),test("extension is not outdated when there is local and no gallery",()=>{const e=t.createInstance(o,()=>s.Installed,()=>{},void 0,i(),void 0,void 0);n.strictEqual(e.outdated,!1)}),test("extension is not outdated when there is no local and has gallery",()=>{const e=t.createInstance(o,()=>s.Installed,()=>{},void 0,void 0,a(),void 0);n.strictEqual(e.outdated,!1)}),test("extension is not outdated when local and gallery are on same version",()=>{const e=t.createInstance(o,()=>s.Installed,()=>{},void 0,i(),a(),void 0);n.strictEqual(e.outdated,!1)}),test("extension is outdated when local is older than gallery",()=>{const e=t.createInstance(o,()=>s.Installed,()=>{},void 0,i("somext",{version:"1.0.0"}),a("somext",{version:"1.0.1"}),void 0);n.strictEqual(e.outdated,!0)}),test("extension is outdated when local is built in and older than gallery",()=>{const e=t.createInstance(o,()=>s.Installed,()=>{},void 0,i("somext",{version:"1.0.0"},{type:c.System}),a("somext",{version:"1.0.1"}),void 0);n.strictEqual(e.outdated,!0)}),test("extension is not outdated when local is built in and older than gallery but product quality is stable",()=>{t.stub(m,{quality:"stable"});const e=t.createInstance(o,()=>s.Installed,()=>{},void 0,i("somext",{version:"1.0.0"},{type:c.System}),a("somext",{version:"1.0.1"}),void 0);n.strictEqual(e.outdated,!1)}),test("extension is outdated when local and gallery are on same version but on different target platforms",()=>{const e=t.createInstance(o,()=>s.Installed,()=>{},void 0,i("somext",{},{targetPlatform:u.WIN32_ARM64}),a("somext",{},{targetPlatform:u.WIN32_X64}),void 0);n.strictEqual(e.outdated,!0)}),test("extension is not outdated when local and gallery are on same version and local is on web",()=>{const e=t.createInstance(o,()=>s.Installed,()=>{},void 0,i("somext",{},{targetPlatform:u.WEB}),a("somext"),void 0);n.strictEqual(e.outdated,!1)}),test("extension is not outdated when local and gallery are on same version and gallery is on web",()=>{const e=t.createInstance(o,()=>s.Installed,()=>{},void 0,i("somext"),a("somext",{},{targetPlatform:u.WEB}),void 0);n.strictEqual(e.outdated,!1)}),test("extension is not outdated when local is not pre-release but gallery is pre-release",()=>{const e=t.createInstance(o,()=>s.Installed,()=>{},void 0,i("somext",{version:"1.0.0"}),a("somext",{version:"1.0.1"},{isPreReleaseVersion:!0}),void 0);n.strictEqual(e.outdated,!1)}),test("extension is outdated when local and gallery are pre-releases",()=>{const e=t.createInstance(o,()=>s.Installed,()=>{},void 0,i("somext",{version:"1.0.0"},{preRelease:!0,isPreReleaseVersion:!0}),a("somext",{version:"1.0.1"},{isPreReleaseVersion:!0}),void 0);n.strictEqual(e.outdated,!0)}),test("extension is outdated when local was opted to pre-release but current version is not pre-release",()=>{const e=t.createInstance(o,()=>s.Installed,()=>{},void 0,i("somext",{version:"1.0.0"},{preRelease:!0,isPreReleaseVersion:!1}),a("somext",{version:"1.0.1"},{isPreReleaseVersion:!0}),void 0);n.strictEqual(e.outdated,!0)}),test("extension is outdated when local is pre-release but gallery is not",()=>{const e=t.createInstance(o,()=>s.Installed,()=>{},void 0,i("somext",{version:"1.0.0"},{preRelease:!0,isPreReleaseVersion:!0}),a("somext",{version:"1.0.1"}),void 0);n.strictEqual(e.outdated,!0)}),test("extension is outdated when local was opted pre-release but current version is not and gallery is not",()=>{const e=t.createInstance(o,()=>s.Installed,()=>{},void 0,i("somext",{version:"1.0.0"},{preRelease:!0,isPreReleaseVersion:!1}),a("somext",{version:"1.0.1"}),void 0);n.strictEqual(e.outdated,!0)});function i(e="someext",r={},d={}){return r={name:e,publisher:"pub",version:"1.0.0",...r},d={type:c.User,location:p.file(`pub.${e}`),identifier:{id:x(r.publisher,r.name)},targetPlatform:u.UNDEFINED,...d},Object.create({manifest:r,...d})}function a(e="somext",r={},d={}){const f=d.targetPlatform??u.UNDEFINED,l=Object.create({name:e,publisher:"pub",version:"1.0.0",allTargetPlatforms:[f],properties:{},assets:{},...r});return l.properties={...l.properties,dependencies:[],targetPlatform:f,...d},l.identifier={id:x(l.publisher,l.name),uuid:E()},l}});
