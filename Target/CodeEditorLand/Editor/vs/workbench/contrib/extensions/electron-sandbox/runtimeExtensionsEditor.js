var B=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var T=(f,i,e,n)=>{for(var o=n>1?void 0:n?M(i,e):i,r=f.length-1,s;r>=0;r--)(s=f[r])&&(o=(n?s(i,e,o):s(o))||o);return n&&o&&B(i,e,o),o},t=(f,i)=>(e,n)=>i(e,n,f);import{VSBuffer as q}from"../../../../base/common/buffer.js";import{Codicon as x}from"../../../../base/common/codicons.js";import{Schemas as N}from"../../../../base/common/network.js";import{joinPath as j}from"../../../../base/common/resources.js";import{URI as z}from"../../../../base/common/uri.js";import*as v from"../../../../nls.js";import{Action2 as S,IMenuService as W,MenuId as l}from"../../../../platform/actions/common/actions.js";import{IClipboardService as K}from"../../../../platform/clipboard/common/clipboardService.js";import{ICommandService as G}from"../../../../platform/commands/common/commands.js";import{ContextKeyExpr as E,IContextKeyService as V,RawContextKey as _}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as X}from"../../../../platform/contextview/browser/contextView.js";import{IFileDialogService as J}from"../../../../platform/dialogs/common/dialogs.js";import{IFileService as $}from"../../../../platform/files/common/files.js";import{IHoverService as Q}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as Y,createDecorator as Z}from"../../../../platform/instantiation/common/instantiation.js";import{ILabelService as ee}from"../../../../platform/label/common/label.js";import{INotificationService as oe}from"../../../../platform/notification/common/notification.js";import{Utils as ie}from"../../../../platform/profiling/common/profiling.js";import{IStorageService as te}from"../../../../platform/storage/common/storage.js";import{ITelemetryService as ne}from"../../../../platform/telemetry/common/telemetry.js";import{IThemeService as re}from"../../../../platform/theme/common/themeService.js";import{ActiveEditorContext as P}from"../../../common/contextkeys.js";import{IEditorService as se,SIDE_GROUP as le}from"../../../services/editor/common/editorService.js";import{IWorkbenchEnvironmentService as C}from"../../../services/environment/common/environmentService.js";import{IExtensionFeaturesManagementService as ae}from"../../../services/extensionManagement/common/extensionFeatures.js";import{IExtensionService as ce}from"../../../services/extensions/common/extensions.js";import{AbstractRuntimeExtensionsEditor as fe}from"../browser/abstractRuntimeExtensionsEditor.js";import{IExtensionsWorkbenchService as pe}from"../common/extensions.js";import{ReportExtensionIssueAction as ve}from"../common/reportExtensionIssueAction.js";import{SlowExtensionAction as de}from"./extensionsSlowActions.js";const d=Z("extensionHostProfileService"),c=new _("profileSessionState","none"),m=new _("extensionHostProfileRecorded",!1);var w=(o=>(o[o.None=0]="None",o[o.Starting=1]="Starting",o[o.Running=2]="Running",o[o.Stopping=3]="Stopping",o))(w||{});let a=class extends fe{constructor(e,n,o,r,s,u,p,I,b,D,L,A,R,me,O,F,U){super(e,n,o,r,s,u,p,I,b,D,L,A,R,O,F,U);this._extensionHostProfileService=me;this._profileInfo=this._extensionHostProfileService.lastProfile,this._extensionsHostRecorded=m.bindTo(r),this._profileSessionState=c.bindTo(r),this._register(this._extensionHostProfileService.onDidChangeLastProfile(()=>{this._profileInfo=this._extensionHostProfileService.lastProfile,this._extensionsHostRecorded.set(!!this._profileInfo),this._updateExtensions()})),this._register(this._extensionHostProfileService.onDidChangeState(()=>{const k=this._extensionHostProfileService.state;this._profileSessionState.set(w[k].toLowerCase())}))}_profileInfo;_extensionsHostRecorded;_profileSessionState;_getProfileInfo(){return this._profileInfo}_getUnresponsiveProfile(e){return this._extensionHostProfileService.getUnresponsiveProfile(e)}_createSlowExtensionAction(e){return e.unresponsiveProfile?this._instantiationService.createInstance(de,e.description,e.unresponsiveProfile):null}_createReportExtensionIssueAction(e){return e.marketplaceInfo?this._instantiationService.createInstance(ve,e.description):null}};a=T([t(1,ne),t(2,re),t(3,V),t(4,pe),t(5,ce),t(6,oe),t(7,X),t(8,Y),t(9,te),t(10,ee),t(11,C),t(12,K),t(13,d),t(14,ae),t(15,Q),t(16,W)],a);class h extends S{static ID="workbench.extensions.action.extensionHostProfile";static LABEL=v.localize("extensionHostProfileStart","Start Extension Host Profile");constructor(){super({id:h.ID,title:{value:h.LABEL,original:"Start Extension Host Profile"},precondition:c.isEqualTo("none"),icon:x.circleFilled,menu:[{id:l.EditorTitle,when:E.and(P.isEqualTo(a.ID),c.notEqualsTo("running")),group:"navigation"},{id:l.ExtensionEditorContextMenu,when:c.notEqualsTo("running"),group:"profiling"}]})}run(i){return i.get(d).startProfiling(),Promise.resolve()}}class H extends S{static ID="workbench.extensions.action.stopExtensionHostProfile";static LABEL=v.localize("stopExtensionHostProfileStart","Stop Extension Host Profile");constructor(){super({id:H.ID,title:{value:H.LABEL,original:"Stop Extension Host Profile"},icon:x.debugStop,menu:[{id:l.EditorTitle,when:E.and(P.isEqualTo(a.ID),c.isEqualTo("running")),group:"navigation"},{id:l.ExtensionEditorContextMenu,when:c.isEqualTo("running"),group:"profiling"}]})}run(i){return i.get(d).stopProfiling(),Promise.resolve()}}class y extends S{static LABEL=v.localize("openExtensionHostProfile","Open Extension Host Profile");static ID="workbench.extensions.action.openExtensionHostProfile";constructor(){super({id:y.ID,title:{value:y.LABEL,original:"Open Extension Host Profile"},precondition:m,icon:x.graph,menu:[{id:l.EditorTitle,when:E.and(P.isEqualTo(a.ID)),group:"navigation"},{id:l.ExtensionEditorContextMenu,when:m,group:"profiling"}]})}async run(i){const e=i.get(d),n=i.get(G),o=i.get(se);e.lastProfileSavedTo||await n.executeCommand(g.ID),e.lastProfileSavedTo&&await o.openEditor({resource:e.lastProfileSavedTo,options:{revealIfOpened:!0,override:"jsProfileVisualizer.cpuprofile.table"}},le)}}class g extends S{static LABEL=v.localize("saveExtensionHostProfile","Save Extension Host Profile");static ID="workbench.extensions.action.saveExtensionHostProfile";constructor(){super({id:g.ID,title:{value:g.LABEL,original:"Save Extension Host Profile"},precondition:m,icon:x.saveAll,menu:[{id:l.EditorTitle,when:E.and(P.isEqualTo(a.ID)),group:"navigation"},{id:l.ExtensionEditorContextMenu,when:m,group:"profiling"}]})}run(i){const e=i.get(C),n=i.get(d),o=i.get($),r=i.get(J);return this._asyncRun(e,n,o,r)}async _asyncRun(i,e,n,o){const r=await o.showSaveDialog({title:v.localize("saveprofile.dialogTitle","Save Extension Host Profile"),availableFileSystems:[N.file],defaultUri:j(await o.defaultFilePath(),`CPU-${new Date().toISOString().replace(/[-:]/g,"")}.cpuprofile`),filters:[{name:"CPU Profiles",extensions:["cpuprofile","txt"]}]});if(!r)return;const s=e.lastProfile;let u=s?s.data:{},p=r.fsPath;i.isBuilt&&(u=ie.rewriteAbsolutePaths(u,"piiRemoved"),p=p+".txt");const I=z.file(p);return e.lastProfileSavedTo=I,n.writeFile(I,q.fromString(JSON.stringify(s?s.data:{},null,"	")))}}export{m as CONTEXT_EXTENSION_HOST_PROFILE_RECORDED,c as CONTEXT_PROFILE_SESSION_STATE,d as IExtensionHostProfileService,y as OpenExtensionHostProfileACtion,w as ProfileSessionState,a as RuntimeExtensionsEditor,g as SaveExtensionHostProfileAction,h as StartExtensionHostProfileAction,H as StopExtensionHostProfileAction};
