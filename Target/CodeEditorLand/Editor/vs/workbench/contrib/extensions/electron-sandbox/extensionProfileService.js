var S=Object.defineProperty;var h=Object.getOwnPropertyDescriptor;var d=(l,s,t,e)=>{for(var r=e>1?void 0:e?h(s,t):s,a=l.length-1,p;a>=0;a--)(p=l[a])&&(r=(e?p(s,t,r):p(r))||r);return e&&r&&S(s,t,r),r},o=(l,s)=>(t,e)=>s(t,e,l);import{disposableWindowInterval as v}from"../../../../../vs/base/browser/dom.js";import{mainWindow as m}from"../../../../../vs/base/browser/window.js";import{onUnexpectedError as c}from"../../../../../vs/base/common/errors.js";import{Emitter as u}from"../../../../../vs/base/common/event.js";import{Disposable as g,MutableDisposable as _}from"../../../../../vs/base/common/lifecycle.js";import{randomPort as I}from"../../../../../vs/base/common/ports.js";import*as n from"../../../../../vs/nls.js";import{CommandsRegistry as P}from"../../../../../vs/platform/commands/common/commands.js";import{IDialogService as E}from"../../../../../vs/platform/dialogs/common/dialogs.js";import{ExtensionIdentifierMap as x}from"../../../../../vs/platform/extensions/common/extensions.js";import{IInstantiationService as b}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{INativeHostService as y}from"../../../../../vs/platform/native/common/native.js";import{IProductService as H}from"../../../../../vs/platform/product/common/productService.js";import{RuntimeExtensionsInput as B}from"../../../../../vs/workbench/contrib/extensions/common/runtimeExtensionsInput.js";import{ProfileSessionState as i}from"../../../../../vs/workbench/contrib/extensions/electron-sandbox/runtimeExtensionsEditor.js";import{IEditorService as D}from"../../../../../vs/workbench/services/editor/common/editorService.js";import{ExtensionHostKind as w}from"../../../../../vs/workbench/services/extensions/common/extensionHostKind.js";import{IExtensionService as L}from"../../../../../vs/workbench/services/extensions/common/extensions.js";import{ExtensionHostProfiler as C}from"../../../../../vs/workbench/services/extensions/electron-sandbox/extensionHostProfiler.js";import{IStatusbarService as z,StatusbarAlignment as N}from"../../../../../vs/workbench/services/statusbar/browser/statusbar.js";let f=class extends g{constructor(t,e,r,a,p,R,U){super();this._extensionService=t;this._editorService=e;this._instantiationService=r;this._nativeHostService=a;this._dialogService=p;this._statusbarService=R;this._productService=U;this._profile=null,this._profileSession=null,this._setState(i.None),P.registerCommand("workbench.action.extensionHostProfiler.stop",()=>{this.stopProfiling(),this._editorService.openEditor(B.instance,{pinned:!0})})}_onDidChangeState=this._register(new u);onDidChangeState=this._onDidChangeState.event;_onDidChangeLastProfile=this._register(new u);onDidChangeLastProfile=this._onDidChangeLastProfile.event;_unresponsiveProfiles=new x;_profile;_profileSession;_state=i.None;profilingStatusBarIndicator;profilingStatusBarIndicatorLabelUpdater=this._register(new _);get state(){return this._state}get lastProfile(){return this._profile}_setState(t){this._state!==t&&(this._state=t,this._state===i.Running?this.updateProfilingStatusBarIndicator(!0):this._state===i.Stopping&&this.updateProfilingStatusBarIndicator(!1),this._onDidChangeState.fire(void 0))}updateProfilingStatusBarIndicator(t){if(this.profilingStatusBarIndicatorLabelUpdater.clear(),t){const e={name:n.localize("status.profiler","Extension Profiler"),text:n.localize("profilingExtensionHost","Profiling Extension Host"),showProgress:!0,ariaLabel:n.localize("profilingExtensionHost","Profiling Extension Host"),tooltip:n.localize("selectAndStartDebug","Click to stop profiling."),command:"workbench.action.extensionHostProfiler.stop"},r=Date.now(),a=v(m,()=>{this.profilingStatusBarIndicator?.update({...e,text:n.localize("profilingExtensionHostTime","Profiling Extension Host ({0} sec)",Math.round((new Date().getTime()-r)/1e3))})},1e3);this.profilingStatusBarIndicatorLabelUpdater.value=a,this.profilingStatusBarIndicator?this.profilingStatusBarIndicator.update(e):this.profilingStatusBarIndicator=this._statusbarService.addEntry(e,"status.profiler",N.RIGHT)}else this.profilingStatusBarIndicator&&(this.profilingStatusBarIndicator.dispose(),this.profilingStatusBarIndicator=void 0)}async startProfiling(){if(this._state!==i.None)return null;const t=await this._extensionService.getInspectPorts(w.LocalProcess,!0);return t.length===0?this._dialogService.confirm({type:"info",message:n.localize("restart1","Profile Extensions"),detail:n.localize("restart2","In order to profile extensions a restart is required. Do you want to restart '{0}' now?",this._productService.nameLong),primaryButton:n.localize({key:"restart3",comment:["&& denotes a mnemonic"]},"&&Restart")}).then(e=>{e.confirmed&&this._nativeHostService.relaunch({addArgs:[`--inspect-extensions=${I()}`]})}):(t.length>1&&console.warn("There are multiple extension hosts available for profiling. Picking the first one..."),this._setState(i.Starting),this._instantiationService.createInstance(C,t[0].host,t[0].port).start().then(e=>{this._profileSession=e,this._setState(i.Running)},e=>{c(e),this._setState(i.None)}))}stopProfiling(){this._state!==i.Running||!this._profileSession||(this._setState(i.Stopping),this._profileSession.stop().then(t=>{this._setLastProfile(t),this._setState(i.None)},t=>{c(t),this._setState(i.None)}),this._profileSession=null)}_setLastProfile(t){this._profile=t,this._onDidChangeLastProfile.fire(void 0)}getUnresponsiveProfile(t){return this._unresponsiveProfiles.get(t)}setUnresponsiveProfile(t,e){this._unresponsiveProfiles.set(t,e),this._setLastProfile(e)}};f=d([o(0,L),o(1,D),o(2,b),o(3,y),o(4,E),o(5,z),o(6,H)],f);export{f as ExtensionHostProfileService};
