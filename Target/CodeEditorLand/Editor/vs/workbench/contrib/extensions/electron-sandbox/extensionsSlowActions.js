var E=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var m=(n,i,e,t)=>{for(var r=t>1?void 0:t?D(i,e):i,s=n.length-1,a;s>=0;s--)(a=n[s])&&(r=(t?a(i,e,r):a(r))||r);return t&&r&&E(i,e,r),r},o=(n,i)=>(e,t)=>i(e,t,n);import{IProductService as N}from"../../../../platform/product/common/productService.js";import{Action as I}from"../../../../base/common/actions.js";import"../../../../platform/extensions/common/extensions.js";import{URI as d}from"../../../../base/common/uri.js";import"../../../services/extensions/common/extensions.js";import{IInstantiationService as S}from"../../../../platform/instantiation/common/instantiation.js";import{localize as c}from"../../../../nls.js";import{CancellationToken as O}from"../../../../base/common/cancellation.js";import{IRequestService as k,asText as q}from"../../../../platform/request/common/request.js";import{joinPath as g}from"../../../../base/common/resources.js";import{IDialogService as y}from"../../../../platform/dialogs/common/dialogs.js";import{IOpenerService as x}from"../../../../platform/opener/common/opener.js";import{INativeHostService as H}from"../../../../platform/native/common/native.js";import{INativeWorkbenchEnvironmentService as b}from"../../../services/environment/electron-sandbox/environmentService.js";import{Utils as _}from"../../../../platform/profiling/common/profiling.js";import{IFileService as P}from"../../../../platform/files/common/files.js";import{VSBuffer as $}from"../../../../base/common/buffer.js";import"../../../../base/parts/request/common/request.js";class w{static fromExtension(i){let e;if(i.bugs&&typeof i.bugs.url=="string"){const t=d.parse(i.bugs.url),r=/\/([^/]+)\/([^/]+)\/issues\/?$/.exec(i.bugs.url);r&&(e={base:t.with({path:null,fragment:null,query:null}).toString(!0),owner:r[1],repo:r[2]})}if(!e&&i.repository&&typeof i.repository.url=="string"){const t=d.parse(i.repository.url),r=/\/([^/]+)\/([^/]+)(\.git)?$/.exec(i.repository.url);r&&(e={base:t.with({path:null,fragment:null,query:null}).toString(!0),owner:r[1],repo:r[2]})}return e&&e.base.indexOf("github")===-1&&(e=void 0),e}}let h=class extends I{constructor(e,t,r){super("report.slow",c("cmd.reportOrShow","Performance Issue"),"extension-action report-issue");this.extension=e;this.profile=t;this._instantiationService=r;this.enabled=!!w.fromExtension(e)}async run(){const e=await this._instantiationService.invokeFunction(R,this.extension,this.profile);e&&await e.run()}};h=m([o(2,S)],h);async function R(n,i,e){const t=w.fromExtension(i);if(!t)return;const r=n.get(k),s=n.get(S),a=`https://api.github.com/search/issues?q=is:issue+state:open+in:title+repo:${t.owner}/${t.repo}+%22Extension+causes+high+cpu+load%22`;let p;try{p=await r.request({url:a},O.None)}catch{return}const u=await q(p);if(!u)return;const f=JSON.parse(u);if(!(!f||typeof f.total_count!="number"))return f.total_count===0?s.createInstance(l,i,t,e):s.createInstance(v,i,t,e)}let l=class extends I{constructor(e,t,r,s,a,p,u,f,C){super("report.slow",c("cmd.report","Report Issue"));this.extension=e;this.repoInfo=t;this.profile=r;this._dialogService=s;this._openerService=a;this._productService=p;this._nativeHostService=u;this._environmentService=f;this._fileService=C}async run(){const e=_.rewriteAbsolutePaths(this.profile.data,"pii_removed"),t=g(this._environmentService.tmpDir,`${this.extension.identifier.value}-unresponsive.cpuprofile.txt`);await this._fileService.writeFile(t,$.fromString(JSON.stringify(e,void 0,4)));const r=await this._nativeHostService.getOSProperties(),s=encodeURIComponent("Extension causes high cpu load"),a=`${r.type} ${r.arch} ${r.release}`,p=`:warning: Make sure to **attach** this file from your *home*-directory:
:warning:\`${t}\`

Find more details here: https://github.com/microsoft/vscode/wiki/Explain-extension-causes-high-cpu-load`,u=encodeURIComponent(`- Issue Type: \`Performance\`
- Extension Name: \`${this.extension.name}\`
- Extension Version: \`${this.extension.version}\`
- OS Version: \`${a}\`
- VS Code version: \`${this._productService.version}\`

${p}`),f=`${this.repoInfo.base}/${this.repoInfo.owner}/${this.repoInfo.repo}/issues/new/?body=${u}&title=${s}`;this._openerService.open(d.parse(f)),this._dialogService.info(c("attach.title","Did you attach the CPU-Profile?"),c("attach.msg","This is a reminder to make sure that you have not forgotten to attach '{0}' to the issue you have just created.",t.fsPath))}};l=m([o(3,y),o(4,x),o(5,N),o(6,H),o(7,b),o(8,P)],l);let v=class extends I{constructor(e,t,r,s,a,p,u){super("show.slow",c("cmd.show","Show Issues"));this.extension=e;this.repoInfo=t;this.profile=r;this._dialogService=s;this._openerService=a;this._environmentService=p;this._fileService=u}async run(){const e=_.rewriteAbsolutePaths(this.profile.data,"pii_removed"),t=g(this._environmentService.tmpDir,`${this.extension.identifier.value}-unresponsive.cpuprofile.txt`);await this._fileService.writeFile(t,$.fromString(JSON.stringify(e,void 0,4)));const r=`${this.repoInfo.base}/${this.repoInfo.owner}/${this.repoInfo.repo}/issues?utf8=\u2713&q=is%3Aissue+state%3Aopen+%22Extension+causes+high+cpu+load%22`;this._openerService.open(d.parse(r)),this._dialogService.info(c("attach.title","Did you attach the CPU-Profile?"),c("attach.msg2","This is a reminder to make sure that you have not forgotten to attach '{0}' to an existing performance issue.",t.fsPath))}};v=m([o(3,y),o(4,x),o(5,b),o(6,P)],v);export{h as SlowExtensionAction,R as createSlowExtensionAction};
