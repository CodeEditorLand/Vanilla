var v=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var I=(s,r,t,o)=>{for(var e=o>1?void 0:o?x(r,t):r,n=s.length-1,i;n>=0;n--)(i=s[n])&&(e=(o?i(r,t,e):i(e))||e);return o&&e&&v(r,t,e),e},c=(s,r)=>(t,o)=>r(t,o,s);import{onUnexpectedError as S}from"../../../../base/common/errors.js";import{Event as l}from"../../../../base/common/event.js";import{Disposable as h}from"../../../../base/common/lifecycle.js";import{localize as f}from"../../../../nls.js";import{IExtensionManagementService as E,InstallOperation as y}from"../../../../platform/extensionManagement/common/extensionManagement.js";import{areSameExtensions as m}from"../../../../platform/extensionManagement/common/extensionManagementUtil.js";import{IInstantiationService as u}from"../../../../platform/instantiation/common/instantiation.js";import{INotificationService as g,Severity as k}from"../../../../platform/notification/common/notification.js";import{EnablementState as D,IWorkbenchExtensionEnablementService as d}from"../../../services/extensionManagement/common/extensionManagement.js";import{IExtensionRecommendationsService as O}from"../../../services/extensionRecommendations/common/extensionRecommendations.js";import{ILifecycleService as F}from"../../../services/lifecycle/common/lifecycle.js";let p=class extends h{constructor(t,o,e,n,i){super();this.instantiationService=t;this.extensionEnablementService=o;this.tipsService=e;this.notificationService=i;this._register(n.onDidShutdown(()=>this.dispose())),this._register(t.invokeFunction(K)(a=>{Promise.all(a.map(b=>this.checkForOtherKeymaps(b))).then(void 0,S)}))}checkForOtherKeymaps(t){return this.instantiationService.invokeFunction(C).then(o=>{const e=o.filter(i=>w(this.tipsService,i)),n=e.find(i=>m(i.identifier,t));if(n&&n.globallyEnabled){const i=e.filter(a=>!m(a.identifier,t)&&a.globallyEnabled);if(i.length)return this.promptForDisablingOtherKeymaps(n,i)}})}promptForDisablingOtherKeymaps(t,o){const e=n=>{n&&this.extensionEnablementService.setEnablement(o.map(i=>i.local),D.DisabledGlobally)};this.notificationService.prompt(k.Info,f("disableOtherKeymapsConfirmation","Disable other keymaps ({0}) to avoid conflicts between keybindings?",o.map(n=>`'${n.local.manifest.displayName}'`).join(", ")),[{label:f("yes","Yes"),run:()=>e(!0)},{label:f("no","No"),run:()=>e(!1)}])}};p=I([c(0,u),c(1,d),c(2,O),c(3,F),c(4,g)],p);function K(s){const r=s.get(E),t=s.get(d),o=l.chain(r.onDidInstallExtensions,e=>e.filter(n=>n.some(({operation:i})=>i===y.Install)).map(n=>n.map(({identifier:i})=>i)));return l.debounce(l.any(l.any(o,l.map(r.onDidUninstallExtension,e=>[e.identifier])),l.map(t.onEnablementChanged,e=>e.map(n=>n.identifier))),(e,n)=>{e=e||[];for(const i of n)e.some(a=>!m(a,i))&&e.push(i);return e})}async function C(s){const r=s.get(E),t=s.get(d);return(await r.getInstalled()).map(e=>({identifier:e.identifier,local:e,globallyEnabled:t.isEnabled(e)}))}function w(s,r){const t=r.local.manifest.categories;return t&&t.indexOf("Keymaps")!==-1||s.getKeymapRecommendations().some(o=>m({id:o},r.local.identifier))}export{p as KeymapExtensions,C as getInstalledExtensions};
