var K=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var D=(g,p,e,i)=>{for(var o=i>1?void 0:i?X(p,e):p,n=g.length-1,t;n>=0;n--)(t=g[n])&&(o=(i?t(p,e,o):t(o))||o);return i&&o&&K(p,e,o),o},l=(g,p)=>(e,i)=>p(e,i,g);import"../../../../../vs/base/common/actions.js";import{distinct as P}from"../../../../../vs/base/common/arrays.js";import{createCancelablePromise as A,Promises as k,raceCancellablePromises as q,raceCancellation as B,timeout as W}from"../../../../../vs/base/common/async.js";import{CancellationToken as G}from"../../../../../vs/base/common/cancellation.js";import{isCancellationError as J}from"../../../../../vs/base/common/errors.js";import{Emitter as V,Event as N}from"../../../../../vs/base/common/event.js";import{Disposable as L,DisposableStore as M,isDisposable as Y,MutableDisposable as T,toDisposable as j}from"../../../../../vs/base/common/lifecycle.js";import{isString as w}from"../../../../../vs/base/common/types.js";import"../../../../../vs/base/common/uri.js";import{localize as r}from"../../../../../vs/nls.js";import{IConfigurationService as z}from"../../../../../vs/platform/configuration/common/configuration.js";import"../../../../../vs/platform/extensionManagement/common/extensionManagement.js";import{areSameExtensions as $}from"../../../../../vs/platform/extensionManagement/common/extensionManagementUtil.js";import{RecommendationsNotificationResult as h,RecommendationSource as f,RecommendationSourceToString as R}from"../../../../../vs/platform/extensionRecommendations/common/extensionRecommendations.js";import{IInstantiationService as Q}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{INotificationService as Z,NotificationPriority as ee,Severity as _}from"../../../../../vs/platform/notification/common/notification.js";import{IStorageService as ie,StorageScope as y,StorageTarget as U}from"../../../../../vs/platform/storage/common/storage.js";import{ITelemetryService as ne}from"../../../../../vs/platform/telemetry/common/telemetry.js";import{IUriIdentityService as oe}from"../../../../../vs/platform/uriIdentity/common/uriIdentity.js";import{IUserDataSyncEnablementService as te,SyncResource as se}from"../../../../../vs/platform/userDataSync/common/userDataSync.js";import{SearchExtensionsAction as H}from"../../../../../vs/workbench/contrib/extensions/browser/extensionsActions.js";import{IExtensionsWorkbenchService as ae}from"../../../../../vs/workbench/contrib/extensions/common/extensions.js";import{IWorkbenchEnvironmentService as re}from"../../../../../vs/workbench/services/environment/common/environmentService.js";import{EnablementState as ce,IWorkbenchExtensionEnablementService as me,IWorkbenchExtensionManagementService as le}from"../../../../../vs/workbench/services/extensionManagement/common/extensionManagement.js";import{IExtensionIgnoredRecommendationsService as de}from"../../../../../vs/workbench/services/extensionRecommendations/common/extensionRecommendations.js";const O="extensionsAssistant/importantRecommendationsIgnore",F="extensionsAssistant/workspaceRecommendationsIgnore";class he extends L{constructor(e,i,o,n){super();this.severity=e;this.message=i;this.choices=o;this.notificationService=n}_onDidClose=this._register(new V);onDidClose=this._onDidClose.event;_onDidChangeVisibility=this._register(new V);onDidChangeVisibility=this._onDidChangeVisibility.event;notificationHandle;cancelled=!1;show(){this.notificationHandle||this.updateNotificationHandle(this.notificationService.prompt(this.severity,this.message,this.choices,{sticky:!0,onCancel:()=>this.cancelled=!0}))}hide(){this.notificationHandle&&(this.onDidCloseDisposable.clear(),this.notificationHandle.close(),this.cancelled=!1,this.updateNotificationHandle(this.notificationService.prompt(this.severity,this.message,this.choices,{priority:ee.SILENT,onCancel:()=>this.cancelled=!0})))}isCancelled(){return this.cancelled}onDidCloseDisposable=this._register(new T);onDidChangeVisibilityDisposable=this._register(new T);updateNotificationHandle(e){this.onDidCloseDisposable.clear(),this.onDidChangeVisibilityDisposable.clear(),this.notificationHandle=e,this.onDidCloseDisposable.value=this.notificationHandle.onDidClose(()=>{this.onDidCloseDisposable.dispose(),this.onDidChangeVisibilityDisposable.dispose(),this._onDidClose.fire(),this._onDidClose.dispose(),this._onDidChangeVisibility.dispose()}),this.onDidChangeVisibilityDisposable.value=this.notificationHandle.onDidChangeVisibility(i=>this._onDidChangeVisibility.fire(i))}}let I=class extends L{constructor(e,i,o,n,t,s,a,m,S,c,x,u){super();this.configurationService=e;this.storageService=i;this.notificationService=o;this.telemetryService=n;this.instantiationService=t;this.extensionsWorkbenchService=s;this.extensionManagementService=a;this.extensionEnablementService=m;this.extensionIgnoredRecommendationsService=S;this.userDataSyncEnablementService=c;this.workbenchEnvironmentService=x;this.uriIdentityService=u}get ignoredRecommendations(){return P([...JSON.parse(this.storageService.get(O,y.PROFILE,"[]"))].map(e=>e.toLowerCase()))}recommendedExtensions=[];recommendationSources=[];hideVisibleNotificationPromise;visibleNotification;pendingNotificaitons=[];hasToIgnoreRecommendationNotifications(){const e=this.configurationService.getValue("extensions");return e.ignoreRecommendations||!!e.showRecommendationsOnlyOnDemand}async promptImportantExtensionsInstallNotification(e){const i=[...this.extensionIgnoredRecommendationsService.ignoredRecommendations,...this.ignoredRecommendations],o=e.extensions.filter(n=>!i.includes(n));return o.length?this.promptRecommendationsNotification({...e,extensions:o},{onDidInstallRecommendedExtensions:n=>n.forEach(t=>this.telemetryService.publicLog2("extensionRecommendations:popup",{userReaction:"install",extensionId:t.identifier.id,source:R(e.source)})),onDidShowRecommendedExtensions:n=>n.forEach(t=>this.telemetryService.publicLog2("extensionRecommendations:popup",{userReaction:"show",extensionId:t.identifier.id,source:R(e.source)})),onDidCancelRecommendedExtensions:n=>n.forEach(t=>this.telemetryService.publicLog2("extensionRecommendations:popup",{userReaction:"cancelled",extensionId:t.identifier.id,source:R(e.source)})),onDidNeverShowRecommendedExtensionsAgain:n=>{for(const t of n)this.addToImportantRecommendationsIgnore(t.identifier.id),this.telemetryService.publicLog2("extensionRecommendations:popup",{userReaction:"neverShowAgain",extensionId:t.identifier.id,source:R(e.source)});this.notificationService.prompt(_.Info,r("ignoreExtensionRecommendations","Do you want to ignore all extension recommendations?"),[{label:r("ignoreAll","Yes, Ignore All"),run:()=>this.setIgnoreRecommendationsConfig(!0)},{label:r("no","No"),run:()=>this.setIgnoreRecommendationsConfig(!1)}])}}):h.Ignored}async promptWorkspaceRecommendations(e){if(this.storageService.getBoolean(F,y.WORKSPACE,!1))return;let i=await this.extensionManagementService.getInstalled();i=i.filter(o=>this.extensionEnablementService.getEnablementState(o)!==ce.DisabledByExtensionKind),e=e.filter(o=>i.every(n=>w(o)?!$({id:o},n.identifier):!this.uriIdentityService.extUri.isEqual(o,n.location))),e.length&&await this.promptRecommendationsNotification({extensions:e,source:f.WORKSPACE,name:r({key:"this repository",comment:["this repository means the current repository that is opened"]},"this repository")},{onDidInstallRecommendedExtensions:()=>this.telemetryService.publicLog2("extensionWorkspaceRecommendations:popup",{userReaction:"install"}),onDidShowRecommendedExtensions:()=>this.telemetryService.publicLog2("extensionWorkspaceRecommendations:popup",{userReaction:"show"}),onDidCancelRecommendedExtensions:()=>this.telemetryService.publicLog2("extensionWorkspaceRecommendations:popup",{userReaction:"cancelled"}),onDidNeverShowRecommendedExtensionsAgain:()=>{this.telemetryService.publicLog2("extensionWorkspaceRecommendations:popup",{userReaction:"neverShowAgain"}),this.storageService.store(F,!0,y.WORKSPACE,U.MACHINE)}})}async promptRecommendationsNotification({extensions:e,source:i,name:o,searchValue:n},t){if(this.hasToIgnoreRecommendationNotifications())return h.Ignored;if(i===f.EXE&&this.workbenchEnvironmentService.remoteAuthority)return h.IncompatibleWindow;if(i===f.EXE&&(this.recommendationSources.includes(f.EXE)||this.recommendationSources.length>=2))return h.TooMany;if(this.recommendationSources.push(i),i===f.EXE&&e.every(c=>w(c)&&this.recommendedExtensions.includes(c)))return h.Ignored;const s=await this.getInstallableExtensions(e);if(!s.length)return h.Ignored;this.recommendedExtensions=P([...this.recommendedExtensions,...e.filter(w)]);let a="";if(s.length===1)a=r("extensionFromPublisher","'{0}' extension from {1}",s[0].displayName,s[0].publisherDisplayName);else{const c=[...s.reduce((x,u)=>x.add(u.publisherDisplayName),new Set)];c.length>2?a=r("extensionsFromMultiplePublishers","extensions from {0}, {1} and others",c[0],c[1]):c.length===2?a=r("extensionsFromPublishers","extensions from {0} and {1}",c[0],c[1]):a=r("extensionsFromPublisher","extensions from {0}",c[0])}let m=r("recommended","Do you want to install the recommended {0} for {1}?",a,o);i===f.EXE&&(m=r({key:"exeRecommended",comment:["Placeholder string is the name of the software that is installed."]},"You have {0} installed on your system. Do you want to install the recommended {1} for it?",o,a)),n||(n=i===f.WORKSPACE?"@recommended":s.map(c=>`@id:${c.identifier.id}`).join(" "));const S=i===f.WORKSPACE?r("donotShowAgain","Don't Show Again for this Repository"):s.length>1?r("donotShowAgainExtension","Don't Show Again for these Extensions"):r("donotShowAgainExtensionSingle","Don't Show Again for this Extension");return q([this._registerP(this.showRecommendationsNotification(s,m,n,S,i,t)),this._registerP(this.waitUntilRecommendationsAreInstalled(s))])}showRecommendationsNotification(e,i,o,n,t,{onDidInstallRecommendedExtensions:s,onDidShowRecommendedExtensions:a,onDidCancelRecommendedExtensions:m,onDidNeverShowRecommendedExtensionsAgain:S}){return A(async c=>{let x=!1;const u=[],C=async v=>{this.runAction(this.instantiationService.createInstance(H,o)),s(e);const E=[],b=[];for(const d of e)d.gallery?E.push(d.gallery):d.resourceExtension&&b.push(d);await k.settled([k.settled(e.map(d=>this.extensionsWorkbenchService.open(d,{pinned:!0}))),E.length?this.extensionManagementService.installGalleryExtensions(E.map(d=>({extension:d,options:{isMachineScoped:v}}))):Promise.resolve(),b.length?Promise.allSettled(b.map(d=>this.extensionsWorkbenchService.install(d))):Promise.resolve()])};u.push({label:r("install","Install"),run:()=>C(!1),menu:this.userDataSyncEnablementService.isEnabled()&&this.userDataSyncEnablementService.isResourceEnabled(se.Extensions)?[{label:r("install and do no sync","Install (Do not sync)"),run:()=>C(!0)}]:void 0}),u.push({label:r("show recommendations","Show Recommendations"),run:async()=>{a(e);for(const v of e)this.extensionsWorkbenchService.open(v,{pinned:!0});this.runAction(this.instantiationService.createInstance(H,o))}},{label:n,isSecondary:!0,run:()=>{S(e)}});try{x=await this.doShowRecommendationsNotification(_.Info,i,u,t,c)}catch(v){if(!J(v))throw v}return x?h.Accepted:(m(e),h.Cancelled)})}waitUntilRecommendationsAreInstalled(e){const i=[],o=new M;return A(async n=>(o.add(n.onCancellationRequested(t=>o.dispose())),new Promise((t,s)=>{o.add(this.extensionManagementService.onInstallExtension(a=>{i.push(a.identifier.id.toLowerCase()),e.every(m=>i.includes(m.identifier.id.toLowerCase()))&&t(h.Accepted)}))})))}async doShowRecommendationsNotification(e,i,o,n,t){const s=new M;try{const a=s.add(new he(e,i,o,this.notificationService));if(s.add(N.once(N.filter(a.onDidChangeVisibility,m=>!m))(()=>this.showNextNotification())),this.visibleNotification){const m=this.pendingNotificaitons.length;s.add(t.onCancellationRequested(()=>this.pendingNotificaitons.splice(m,1))),this.pendingNotificaitons.push({recommendationsNotification:a,source:n,token:t}),n!==f.EXE&&n<=this.visibleNotification.source&&this.hideVisibleNotification(3e3)}else this.visibleNotification={recommendationsNotification:a,source:n,from:Date.now()},a.show();return await B(new Promise(m=>s.add(N.once(a.onDidClose)(m))),t),!a.isCancelled()}finally{s.dispose()}}showNextNotification(){const e=this.getNextPendingNotificationIndex(),[i]=e>-1?this.pendingNotificaitons.splice(e,1):[];W(i?500:0).then(()=>{this.unsetVisibileNotification(),i&&(this.visibleNotification={recommendationsNotification:i.recommendationsNotification,source:i.source,from:Date.now()},i.recommendationsNotification.show())})}getNextPendingNotificationIndex(){let e=this.pendingNotificaitons.length-1;if(this.pendingNotificaitons.length)for(let i=0;i<this.pendingNotificaitons.length;i++)this.pendingNotificaitons[i].source<=this.pendingNotificaitons[e].source&&(e=i);return e}hideVisibleNotification(e){if(this.visibleNotification&&!this.hideVisibleNotificationPromise){const i=this.visibleNotification;this.hideVisibleNotificationPromise=W(Math.max(e-(Date.now()-i.from),0)),this.hideVisibleNotificationPromise.then(()=>i.recommendationsNotification.hide())}}unsetVisibileNotification(){this.hideVisibleNotificationPromise?.cancel(),this.hideVisibleNotificationPromise=void 0,this.visibleNotification=void 0}async getInstallableExtensions(e){const i=[];if(e.length){const o=[],n=[];for(const t of e)typeof t=="string"?o.push(t):n.push(t);if(o.length){const t=await this.extensionsWorkbenchService.getExtensions(o.map(s=>({id:s})),{source:"install-recommendations"},G.None);for(const s of t)s.gallery&&await this.extensionManagementService.canInstall(s.gallery)&&i.push(s)}if(n.length){const t=await this.extensionsWorkbenchService.getResourceExtensions(n,!0);for(const s of t)await this.extensionsWorkbenchService.canInstall(s)&&i.push(s)}}return i}async runAction(e){try{await e.run()}finally{Y(e)&&e.dispose()}}addToImportantRecommendationsIgnore(e){const i=[...this.ignoredRecommendations];i.includes(e.toLowerCase())||(i.push(e.toLowerCase()),this.storageService.store(O,JSON.stringify(i),y.PROFILE,U.USER))}setIgnoreRecommendationsConfig(e){this.configurationService.updateValue("extensions.ignoreRecommendations",e)}_registerP(e){return this._register(j(()=>e.cancel())),e}};I=D([l(0,z),l(1,ie),l(2,Z),l(3,ne),l(4,Q),l(5,ae),l(6,le),l(7,me),l(8,de),l(9,te),l(10,re),l(11,oe)],I);export{I as ExtensionRecommendationNotificationService};
