var F=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var A=(y,I,p,v)=>{for(var h=v>1?void 0:v?q(I,p):I,b=y.length-1,e;b>=0;b--)(e=y[b])&&(h=(v?e(I,p,h):e(h))||h);return v&&h&&F(I,p,h),h},d=(y,I)=>(p,v)=>I(p,v,y);import{$ as c,addDisposableListener as N,append as g,clearNode as U}from"../../../../../vs/base/browser/dom.js";import{ActionBar as B}from"../../../../../vs/base/browser/ui/actionbar/actionbar.js";import{getDefaultHoverDelegate as k}from"../../../../../vs/base/browser/ui/hover/hoverDelegateFactory.js";import{renderLabelWithIcons as _}from"../../../../../vs/base/browser/ui/iconLabel/iconLabels.js";import"../../../../../vs/base/browser/ui/list/list.js";import"../../../../../vs/base/browser/ui/list/listWidget.js";import{Action as C,Separator as R}from"../../../../../vs/base/common/actions.js";import{isNonEmptyArray as D}from"../../../../../vs/base/common/arrays.js";import{RunOnceScheduler as G}from"../../../../../vs/base/common/async.js";import{fromNow as O}from"../../../../../vs/base/common/date.js";import{memoize as K}from"../../../../../vs/base/common/decorators.js";import{dispose as P}from"../../../../../vs/base/common/lifecycle.js";import{Schemas as H}from"../../../../../vs/base/common/network.js";import"vs/css!./media/runtimeExtensionsEditor";import*as u from"../../../../../vs/nls.js";import{Categories as V}from"../../../../../vs/platform/action/common/actionCommonCategories.js";import{Action2 as j,MenuId as J}from"../../../../../vs/platform/actions/common/actions.js";import{IClipboardService as Q}from"../../../../../vs/platform/clipboard/common/clipboardService.js";import{ContextKeyExpr as X,IContextKeyService as Y}from"../../../../../vs/platform/contextkey/common/contextkey.js";import{IContextMenuService as Z}from"../../../../../vs/platform/contextview/browser/contextView.js";import{ExtensionIdentifierMap as M}from"../../../../../vs/platform/extensions/common/extensions.js";import{IHoverService as ee}from"../../../../../vs/platform/hover/browser/hover.js";import{IInstantiationService as te}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{ILabelService as ie}from"../../../../../vs/platform/label/common/label.js";import{WorkbenchList as ne}from"../../../../../vs/platform/list/browser/listService.js";import{INotificationService as oe,Severity as se}from"../../../../../vs/platform/notification/common/notification.js";import{Registry as re}from"../../../../../vs/platform/registry/common/platform.js";import{IStorageService as ae}from"../../../../../vs/platform/storage/common/storage.js";import{ITelemetryService as ce}from"../../../../../vs/platform/telemetry/common/telemetry.js";import{editorBackground as le}from"../../../../../vs/platform/theme/common/colorRegistry.js";import{IThemeService as me}from"../../../../../vs/platform/theme/common/themeService.js";import{EditorPane as ue}from"../../../../../vs/workbench/browser/parts/editor/editorPane.js";import{errorIcon as pe,warningIcon as fe}from"../../../../../vs/workbench/contrib/extensions/browser/extensionsIcons.js";import{IExtensionsWorkbenchService as de}from"../../../../../vs/workbench/contrib/extensions/common/extensions.js";import{RuntimeExtensionsInput as ve}from"../../../../../vs/workbench/contrib/extensions/common/runtimeExtensionsInput.js";import"../../../../../vs/workbench/services/editor/common/editorGroupsService.js";import{IEditorService as xe}from"../../../../../vs/workbench/services/editor/common/editorService.js";import{IWorkbenchEnvironmentService as he}from"../../../../../vs/workbench/services/environment/common/environmentService.js";import{Extensions as ge,IExtensionFeaturesManagementService as Ie}from"../../../../../vs/workbench/services/extensionManagement/common/extensionFeatures.js";import{DefaultIconPath as $,EnablementState as z}from"../../../../../vs/workbench/services/extensionManagement/common/extensionManagement.js";import{LocalWebWorkerRunningLocation as W}from"../../../../../vs/workbench/services/extensions/common/extensionRunningLocation.js";import{IExtensionService as be}from"../../../../../vs/workbench/services/extensions/common/extensions.js";let S=class extends ue{constructor(p,v,h,b,e,s,t,l,f,m,i,a,n,o,r){super(S.ID,p,v,h,m);this._extensionsWorkbenchService=e;this._extensionService=s;this._notificationService=t;this._contextMenuService=l;this._instantiationService=f;this._labelService=i;this._environmentService=a;this._clipboardService=n;this._extensionFeaturesManagementService=o;this._hoverService=r;this._list=null,this._elements=null,this._updateSoon=this._register(new G(()=>this._updateExtensions(),200)),this._register(this._extensionService.onDidChangeExtensionsStatus(()=>this._updateSoon.schedule())),this._register(this._extensionFeaturesManagementService.onDidChangeAccessData(()=>this._updateSoon.schedule())),this._updateExtensions()}static ID="workbench.editor.runtimeExtensions";_list;_elements;_updateSoon;async _updateExtensions(){this._elements=await this._resolveExtensions(),this._list?.splice(0,this._list.length,this._elements)}async _resolveExtensions(){await this._extensionService.whenInstalledExtensionsRegistered();const p=this._extensionService.extensions.filter(i=>!!i.main||!!i.browser),v=new M,h=await this._extensionsWorkbenchService.queryLocal();for(const i of h)v.set(i.identifier.id,i);const b=this._extensionService.getExtensionsStatus(),e=new M,s=this._getProfileInfo();if(s){let i=s.startTime;for(let a=0,n=s.deltas.length;a<n;a++){const o=s.ids[a],r=s.deltas[a];let x=e.get(o);x||(x=[],e.set(o,x)),x.push(i),i=i+r,x.push(i)}}let t=[];for(let i=0,a=p.length;i<a;i++){const n=p[i];let o=null;if(s){const r=e.get(n.identifier)||[];let x=0;for(let E=0,T=r.length/2;E<T;E++){const L=r[2*E],w=r[2*E+1];x+=w-L}o={segments:r,totalTime:x}}t[i]={originalIndex:i,description:n,marketplaceInfo:v.get(n.identifier),status:b[n.identifier.value],profileInfo:o||void 0,unresponsiveProfile:this._getUnresponsiveProfile(n.identifier)}}t=t.filter(i=>i.status.activationStarted);const l=i=>i.unresponsiveProfile===s,f=i=>i.profileInfo?.totalTime??0,m=i=>(i.status.activationTimes?.codeLoadingTime??0)+(i.status.activationTimes?.activateCallTime??0);return t=t.sort((i,a)=>l(i)||l(a)?+l(a)-+l(i):f(i)||f(a)?f(a)-f(i):m(i)||m(a)?m(a)-m(i):i.originalIndex-a.originalIndex),t}createEditor(p){p.classList.add("runtime-extensions-editor");const v="runtimeExtensionElementTemplate",h=new class{getHeight(e){return 70}getTemplateId(e){return v}},b={templateId:v,renderTemplate:e=>{const s=g(e,c(".extension")),t=g(s,c(".icon-container")),l=g(t,c("img.icon")),f=g(s,c("div.desc")),m=g(f,c(".header-container")),i=g(m,c(".header")),a=g(i,c("div.name")),n=g(i,c("span.version")),o=g(f,c("div.msg")),r=new B(f);r.onDidRun(({error:w})=>w&&this._notificationService.error(w));const x=g(s,c(".time")),E=g(x,c("div.activation-time")),T=g(x,c("div.profile-time"));return{root:e,element:s,icon:l,name:a,version:n,actionbar:r,activationTime:E,profileTime:T,msgContainer:o,disposables:[r],elementDisposables:[]}},renderElement:(e,s,t)=>{t.elementDisposables=P(t.elementDisposables),t.root.classList.toggle("odd",s%2===1),t.elementDisposables.push(N(t.icon,"error",()=>t.icon.src=e.marketplaceInfo?.iconUrlFallback||$,{once:!0})),t.icon.src=e.marketplaceInfo?.iconUrl||$,t.icon.complete?t.icon.style.visibility="inherit":(t.icon.style.visibility="hidden",t.icon.onload=()=>t.icon.style.visibility="inherit"),t.name.textContent=(e.marketplaceInfo?.displayName||e.description.identifier.value).substr(0,50),t.version.textContent=e.description.version;const l=e.status.activationTimes;if(l){const n=l.codeLoadingTime+l.activateCallTime;t.activationTime.textContent=l.activationReason.startup?`Startup Activation: ${n}ms`:`Activation: ${n}ms`}else t.activationTime.textContent="Activating...";t.actionbar.clear();const f=this._createSlowExtensionAction(e);if(f&&t.actionbar.push(f,{icon:!1,label:!0}),D(e.status.runtimeErrors)){const n=this._createReportExtensionIssueAction(e);n&&t.actionbar.push(n,{icon:!1,label:!0})}let m;if(l){const n=l.activationReason.extensionId.value,o=l.activationReason.activationEvent;if(o==="*")m=u.localize({key:"starActivation",comment:["{0} will be an extension identifier"]},"Activated by {0} on start-up",n);else if(/^workspaceContains:/.test(o)){const r=o.substr(18);r.indexOf("*")>=0||r.indexOf("?")>=0?m=u.localize({key:"workspaceContainsGlobActivation",comment:["{0} will be a glob pattern","{1} will be an extension identifier"]},"Activated by {1} because a file matching {0} exists in your workspace",r,n):m=u.localize({key:"workspaceContainsFileActivation",comment:["{0} will be a file name","{1} will be an extension identifier"]},"Activated by {1} because file {0} exists in your workspace",r,n)}else if(/^workspaceContainsTimeout:/.test(o)){const r=o.substr(25);m=u.localize({key:"workspaceContainsTimeout",comment:["{0} will be a glob pattern","{1} will be an extension identifier"]},"Activated by {1} because searching for {0} took too long",r,n)}else if(o==="onStartupFinished")m=u.localize({key:"startupFinishedActivation",comment:["This refers to an extension. {0} will be an activation event."]},"Activated by {0} after start-up finished",n);else if(/^onLanguage:/.test(o)){const r=o.substr(11);m=u.localize("languageActivation","Activated by {1} because you opened a {0} file",r,n)}else m=u.localize({key:"workspaceGenericActivation",comment:["{0} will be an activation event, like e.g. 'language:typescript', 'debug', etc.","{1} will be an extension identifier"]},"Activated by {1} on {0}",o,n)}else m=u.localize("extensionActivating","Extension is activating...");if(t.elementDisposables.push(this._hoverService.setupManagedHover(k("mouse"),t.activationTime,m)),U(t.msgContainer),this._getUnresponsiveProfile(e.description.identifier)){const n=c("span",void 0,..._(" $(alert) Unresponsive")),o=u.localize("unresponsive.title","Extension has caused the extension host to freeze.");t.elementDisposables.push(this._hoverService.setupManagedHover(k("mouse"),n,o)),t.msgContainer.appendChild(n)}if(D(e.status.runtimeErrors)){const n=c("span",void 0,..._(`$(bug) ${u.localize("errors","{0} uncaught errors",e.status.runtimeErrors.length)}`));t.msgContainer.appendChild(n)}if(e.status.messages&&e.status.messages.length>0){const n=c("span",void 0,..._(`$(alert) ${e.status.messages[0].message}`));t.msgContainer.appendChild(n)}let i=null;if(e.status.runningLocation&&e.status.runningLocation.equals(new W(0)))i="$(globe) web worker";else if(e.description.extensionLocation.scheme===H.vscodeRemote){const n=this._labelService.getHostLabel(H.vscodeRemote,this._environmentService.remoteAuthority);n?i=`$(remote) ${n}`:i=`$(remote) ${e.description.extensionLocation.authority}`}else e.status.runningLocation&&e.status.runningLocation.affinity>0&&(i=e.status.runningLocation instanceof W?`$(globe) web worker ${e.status.runningLocation.affinity+1}`:`$(server-process) local process ${e.status.runningLocation.affinity+1}`);if(i){const n=c("span",void 0,..._(i));t.msgContainer.appendChild(n)}const a=re.as(ge.ExtensionFeaturesRegistry).getExtensionFeatures();for(const n of a){const o=this._extensionFeaturesManagementService.getAccessData(e.description.identifier,n.id);if(o){const r=o?.current?.status;if(r&&(t.msgContainer.appendChild(c("span",void 0,`${n.label}: `)),t.msgContainer.appendChild(c("span",void 0,..._(`$(${r.severity===se.Error?pe.id:fe.id}) ${r.message}`)))),o?.totalCount>0){const x=c("span",void 0,`${u.localize("requests count","{0} Requests: {1} (Overall)",n.label,o.totalCount)}${o.current?u.localize("session requests count",", {0} (Session)",o.current.count):""}`);if(o.current){const E=u.localize("requests count title","Last request was {0}.",O(o.current.lastAccessed,!0,!0));t.elementDisposables.push(this._hoverService.setupManagedHover(k("mouse"),x,E))}t.msgContainer.appendChild(x)}}}e.profileInfo?t.profileTime.textContent=`Profile: ${(e.profileInfo.totalTime/1e3).toFixed(2)}ms`:t.profileTime.textContent=""},disposeTemplate:e=>{e.disposables=P(e.disposables)}};this._list=this._instantiationService.createInstance(ne,"RuntimeExtensions",p,h,[b],{multipleSelectionSupport:!1,setRowLineHeight:!1,horizontalScrolling:!1,overrideStyles:{listBackground:le},accessibilityProvider:new class{getWidgetAriaLabel(){return u.localize("runtimeExtensions","Runtime Extensions")}getAriaLabel(e){return e.description.name}}}),this._list.splice(0,this._list.length,this._elements||void 0),this._list.onContextMenu(e=>{if(!e.element)return;const s=[];s.push(new C("runtimeExtensionsEditor.action.copyId",u.localize("copy id","Copy id ({0})",e.element.description.identifier.value),void 0,!0,()=>{this._clipboardService.writeText(e.element.description.identifier.value)}));const t=this._createReportExtensionIssueAction(e.element);t&&s.push(t),s.push(new R),e.element.marketplaceInfo&&(s.push(new C("runtimeExtensionsEditor.action.disableWorkspace",u.localize("disable workspace","Disable (Workspace)"),void 0,!0,()=>this._extensionsWorkbenchService.setEnablement(e.element.marketplaceInfo,z.DisabledWorkspace))),s.push(new C("runtimeExtensionsEditor.action.disable",u.localize("disable","Disable"),void 0,!0,()=>this._extensionsWorkbenchService.setEnablement(e.element.marketplaceInfo,z.DisabledGlobally)))),s.push(new R);const l=this._createProfileAction();l&&s.push(l);const f=this.saveExtensionHostProfileAction;f&&s.push(f),this._contextMenuService.showContextMenu({getAnchor:()=>e.anchor,getActions:()=>s})})}get saveExtensionHostProfileAction(){return this._createSaveExtensionHostProfileAction()}layout(p){this._list?.layout(p.height)}};A([K],S.prototype,"saveExtensionHostProfileAction",1),S=A([d(1,ce),d(2,me),d(3,Y),d(4,de),d(5,be),d(6,oe),d(7,Z),d(8,te),d(9,ae),d(10,ie),d(11,he),d(12,Q),d(13,Ie),d(14,ee)],S);class yt extends j{constructor(){super({id:"workbench.action.showRuntimeExtensions",title:u.localize2("showRuntimeExtensions","Show Running Extensions"),category:V.Developer,f1:!0,menu:{id:J.ViewContainerTitle,when:X.equals("viewContainer","workbench.view.extensions"),group:"2_enablement",order:3}})}async run(I){await I.get(xe).openEditor(ve.instance,{pinned:!0})}}export{S as AbstractRuntimeExtensionsEditor,yt as ShowRuntimeExtensionsAction};
