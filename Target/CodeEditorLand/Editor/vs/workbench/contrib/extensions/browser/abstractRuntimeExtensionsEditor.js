var q=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var A=(y,I,f,v)=>{for(var x=v>1?void 0:v?N(I,f):I,b=y.length-1,e;b>=0;b--)(e=y[b])&&(x=(v?e(I,f,x):e(x))||x);return v&&x&&q(I,f,x),x},p=(y,I)=>(f,v)=>I(f,v,y);import{$ as c,addDisposableListener as U,append as g,clearNode as B}from"../../../../base/browser/dom.js";import{ActionBar as G}from"../../../../base/browser/ui/actionbar/actionbar.js";import{getDefaultHoverDelegate as C}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import{renderLabelWithIcons as _}from"../../../../base/browser/ui/iconLabel/iconLabels.js";import"../../../../base/browser/ui/list/list.js";import"../../../../base/browser/ui/list/listWidget.js";import{Action as k,Separator as R}from"../../../../base/common/actions.js";import{isNonEmptyArray as D}from"../../../../base/common/arrays.js";import{RunOnceScheduler as O}from"../../../../base/common/async.js";import{fromNow as K}from"../../../../base/common/date.js";import{dispose as M}from"../../../../base/common/lifecycle.js";import{Schemas as P}from"../../../../base/common/network.js";import*as m from"../../../../nls.js";import{Categories as V}from"../../../../platform/action/common/actionCommonCategories.js";import{createAndFillInContextMenuActions as j}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{Action2 as J,IMenuService as Q,MenuId as H}from"../../../../platform/actions/common/actions.js";import{IClipboardService as X}from"../../../../platform/clipboard/common/clipboardService.js";import{ContextKeyExpr as Y,IContextKeyService as Z}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as ee}from"../../../../platform/contextview/browser/contextView.js";import{ExtensionIdentifierMap as $}from"../../../../platform/extensions/common/extensions.js";import{IHoverService as te}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as ie}from"../../../../platform/instantiation/common/instantiation.js";import{ILabelService as ne}from"../../../../platform/label/common/label.js";import{WorkbenchList as oe}from"../../../../platform/list/browser/listService.js";import{INotificationService as se,Severity as re}from"../../../../platform/notification/common/notification.js";import{Registry as ae}from"../../../../platform/registry/common/platform.js";import{IStorageService as ce}from"../../../../platform/storage/common/storage.js";import{ITelemetryService as le}from"../../../../platform/telemetry/common/telemetry.js";import{editorBackground as me}from"../../../../platform/theme/common/colorRegistry.js";import{IThemeService as ue}from"../../../../platform/theme/common/themeService.js";import{EditorPane as pe}from"../../../browser/parts/editor/editorPane.js";import"../../../services/editor/common/editorGroupsService.js";import{IEditorService as fe}from"../../../services/editor/common/editorService.js";import{IWorkbenchEnvironmentService as de}from"../../../services/environment/common/environmentService.js";import{Extensions as ve,IExtensionFeaturesManagementService as xe}from"../../../services/extensionManagement/common/extensionFeatures.js";import{DefaultIconPath as z,EnablementState as W}from"../../../services/extensionManagement/common/extensionManagement.js";import{LocalWebWorkerRunningLocation as F}from"../../../services/extensions/common/extensionRunningLocation.js";import{IExtensionService as he}from"../../../services/extensions/common/extensions.js";import{IExtensionsWorkbenchService as ge}from"../common/extensions.js";import{RuntimeExtensionsInput as Ie}from"../common/runtimeExtensionsInput.js";import{errorIcon as be,warningIcon as Ee}from"./extensionsIcons.js";import"./media/runtimeExtensionsEditor.css";let S=class extends pe{constructor(f,v,x,b,e,s,t,u,h,l,i,a,n,o,r,d){super(S.ID,f,v,x,l);this.contextKeyService=b;this._extensionsWorkbenchService=e;this._extensionService=s;this._notificationService=t;this._contextMenuService=u;this._instantiationService=h;this._labelService=i;this._environmentService=a;this._clipboardService=n;this._extensionFeaturesManagementService=o;this._hoverService=r;this._menuService=d;this._list=null,this._elements=null,this._updateSoon=this._register(new O(()=>this._updateExtensions(),200)),this._register(this._extensionService.onDidChangeExtensionsStatus(()=>this._updateSoon.schedule())),this._register(this._extensionFeaturesManagementService.onDidChangeAccessData(()=>this._updateSoon.schedule())),this._updateExtensions()}static ID="workbench.editor.runtimeExtensions";_list;_elements;_updateSoon;async _updateExtensions(){this._elements=await this._resolveExtensions(),this._list?.splice(0,this._list.length,this._elements)}async _resolveExtensions(){await this._extensionService.whenInstalledExtensionsRegistered();const f=this._extensionService.extensions.filter(i=>!!i.main||!!i.browser),v=new $,x=await this._extensionsWorkbenchService.queryLocal();for(const i of x)v.set(i.identifier.id,i);const b=this._extensionService.getExtensionsStatus(),e=new $,s=this._getProfileInfo();if(s){let i=s.startTime;for(let a=0,n=s.deltas.length;a<n;a++){const o=s.ids[a],r=s.deltas[a];let d=e.get(o);d||(d=[],e.set(o,d)),d.push(i),i=i+r,d.push(i)}}let t=[];for(let i=0,a=f.length;i<a;i++){const n=f[i];let o=null;if(s){const r=e.get(n.identifier)||[];let d=0;for(let E=0,T=r.length/2;E<T;E++){const L=r[2*E],w=r[2*E+1];d+=w-L}o={segments:r,totalTime:d}}t[i]={originalIndex:i,description:n,marketplaceInfo:v.get(n.identifier),status:b[n.identifier.value],profileInfo:o||void 0,unresponsiveProfile:this._getUnresponsiveProfile(n.identifier)}}t=t.filter(i=>i.status.activationStarted);const u=i=>i.unresponsiveProfile===s,h=i=>i.profileInfo?.totalTime??0,l=i=>(i.status.activationTimes?.codeLoadingTime??0)+(i.status.activationTimes?.activateCallTime??0);return t=t.sort((i,a)=>u(i)||u(a)?+u(a)-+u(i):h(i)||h(a)?h(a)-h(i):l(i)||l(a)?l(a)-l(i):i.originalIndex-a.originalIndex),t}createEditor(f){f.classList.add("runtime-extensions-editor");const v="runtimeExtensionElementTemplate",x=new class{getHeight(e){return 70}getTemplateId(e){return v}},b={templateId:v,renderTemplate:e=>{const s=g(e,c(".extension")),t=g(s,c(".icon-container")),u=g(t,c("img.icon")),h=g(s,c("div.desc")),l=g(h,c(".header-container")),i=g(l,c(".header")),a=g(i,c("div.name")),n=g(i,c("span.version")),o=g(h,c("div.msg")),r=new G(h);r.onDidRun(({error:w})=>w&&this._notificationService.error(w));const d=g(s,c(".time")),E=g(d,c("div.activation-time")),T=g(d,c("div.profile-time"));return{root:e,element:s,icon:u,name:a,version:n,actionbar:r,activationTime:E,profileTime:T,msgContainer:o,disposables:[r],elementDisposables:[]}},renderElement:(e,s,t)=>{t.elementDisposables=M(t.elementDisposables),t.root.classList.toggle("odd",s%2===1),t.elementDisposables.push(U(t.icon,"error",()=>t.icon.src=e.marketplaceInfo?.iconUrlFallback||z,{once:!0})),t.icon.src=e.marketplaceInfo?.iconUrl||z,t.icon.complete?t.icon.style.visibility="inherit":(t.icon.style.visibility="hidden",t.icon.onload=()=>t.icon.style.visibility="inherit"),t.name.textContent=(e.marketplaceInfo?.displayName||e.description.identifier.value).substr(0,50),t.version.textContent=e.description.version;const u=e.status.activationTimes;if(u){const n=u.codeLoadingTime+u.activateCallTime;t.activationTime.textContent=u.activationReason.startup?`Startup Activation: ${n}ms`:`Activation: ${n}ms`}else t.activationTime.textContent="Activating...";t.actionbar.clear();const h=this._createSlowExtensionAction(e);if(h&&t.actionbar.push(h,{icon:!1,label:!0}),D(e.status.runtimeErrors)){const n=this._createReportExtensionIssueAction(e);n&&t.actionbar.push(n,{icon:!1,label:!0})}let l;if(u){const n=u.activationReason.extensionId.value,o=u.activationReason.activationEvent;if(o==="*")l=m.localize({key:"starActivation",comment:["{0} will be an extension identifier"]},"Activated by {0} on start-up",n);else if(/^workspaceContains:/.test(o)){const r=o.substr(18);r.indexOf("*")>=0||r.indexOf("?")>=0?l=m.localize({key:"workspaceContainsGlobActivation",comment:["{0} will be a glob pattern","{1} will be an extension identifier"]},"Activated by {1} because a file matching {0} exists in your workspace",r,n):l=m.localize({key:"workspaceContainsFileActivation",comment:["{0} will be a file name","{1} will be an extension identifier"]},"Activated by {1} because file {0} exists in your workspace",r,n)}else if(/^workspaceContainsTimeout:/.test(o)){const r=o.substr(25);l=m.localize({key:"workspaceContainsTimeout",comment:["{0} will be a glob pattern","{1} will be an extension identifier"]},"Activated by {1} because searching for {0} took too long",r,n)}else if(o==="onStartupFinished")l=m.localize({key:"startupFinishedActivation",comment:["This refers to an extension. {0} will be an activation event."]},"Activated by {0} after start-up finished",n);else if(/^onLanguage:/.test(o)){const r=o.substr(11);l=m.localize("languageActivation","Activated by {1} because you opened a {0} file",r,n)}else l=m.localize({key:"workspaceGenericActivation",comment:["{0} will be an activation event, like e.g. 'language:typescript', 'debug', etc.","{1} will be an extension identifier"]},"Activated by {1} on {0}",o,n)}else l=m.localize("extensionActivating","Extension is activating...");if(t.elementDisposables.push(this._hoverService.setupManagedHover(C("mouse"),t.activationTime,l)),B(t.msgContainer),this._getUnresponsiveProfile(e.description.identifier)){const n=c("span",void 0,..._(" $(alert) Unresponsive")),o=m.localize("unresponsive.title","Extension has caused the extension host to freeze.");t.elementDisposables.push(this._hoverService.setupManagedHover(C("mouse"),n,o)),t.msgContainer.appendChild(n)}if(D(e.status.runtimeErrors)){const n=c("span",void 0,..._(`$(bug) ${m.localize("errors","{0} uncaught errors",e.status.runtimeErrors.length)}`));t.msgContainer.appendChild(n)}if(e.status.messages&&e.status.messages.length>0){const n=c("span",void 0,..._(`$(alert) ${e.status.messages[0].message}`));t.msgContainer.appendChild(n)}let i=null;if(e.status.runningLocation&&e.status.runningLocation.equals(new F(0)))i="$(globe) web worker";else if(e.description.extensionLocation.scheme===P.vscodeRemote){const n=this._labelService.getHostLabel(P.vscodeRemote,this._environmentService.remoteAuthority);n?i=`$(remote) ${n}`:i=`$(remote) ${e.description.extensionLocation.authority}`}else e.status.runningLocation&&e.status.runningLocation.affinity>0&&(i=e.status.runningLocation instanceof F?`$(globe) web worker ${e.status.runningLocation.affinity+1}`:`$(server-process) local process ${e.status.runningLocation.affinity+1}`);if(i){const n=c("span",void 0,..._(i));t.msgContainer.appendChild(n)}const a=ae.as(ve.ExtensionFeaturesRegistry).getExtensionFeatures();for(const n of a){const o=this._extensionFeaturesManagementService.getAccessData(e.description.identifier,n.id);if(o){const r=o?.current?.status;if(r&&(t.msgContainer.appendChild(c("span",void 0,`${n.label}: `)),t.msgContainer.appendChild(c("span",void 0,..._(`$(${r.severity===re.Error?be.id:Ee.id}) ${r.message}`)))),o?.totalCount>0){const d=c("span",void 0,`${m.localize("requests count","{0} Requests: {1} (Overall)",n.label,o.totalCount)}${o.current?m.localize("session requests count",", {0} (Session)",o.current.count):""}`);if(o.current){const E=m.localize("requests count title","Last request was {0}.",K(o.current.lastAccessed,!0,!0));t.elementDisposables.push(this._hoverService.setupManagedHover(C("mouse"),d,E))}t.msgContainer.appendChild(d)}}}e.profileInfo?t.profileTime.textContent=`Profile: ${(e.profileInfo.totalTime/1e3).toFixed(2)}ms`:t.profileTime.textContent=""},disposeTemplate:e=>{e.disposables=M(e.disposables)}};this._list=this._instantiationService.createInstance(oe,"RuntimeExtensions",f,x,[b],{multipleSelectionSupport:!1,setRowLineHeight:!1,horizontalScrolling:!1,overrideStyles:{listBackground:me},accessibilityProvider:new class{getWidgetAriaLabel(){return m.localize("runtimeExtensions","Runtime Extensions")}getAriaLabel(e){return e.description.name}}}),this._list.splice(0,this._list.length,this._elements||void 0),this._list.onContextMenu(e=>{if(!e.element)return;const s=[];s.push(new k("runtimeExtensionsEditor.action.copyId",m.localize("copy id","Copy id ({0})",e.element.description.identifier.value),void 0,!0,()=>{this._clipboardService.writeText(e.element.description.identifier.value)}));const t=this._createReportExtensionIssueAction(e.element);t&&s.push(t),s.push(new R),e.element.marketplaceInfo&&(s.push(new k("runtimeExtensionsEditor.action.disableWorkspace",m.localize("disable workspace","Disable (Workspace)"),void 0,!0,()=>this._extensionsWorkbenchService.setEnablement(e.element.marketplaceInfo,W.DisabledWorkspace))),s.push(new k("runtimeExtensionsEditor.action.disable",m.localize("disable","Disable"),void 0,!0,()=>this._extensionsWorkbenchService.setEnablement(e.element.marketplaceInfo,W.DisabledGlobally)))),s.push(new R);const u=this._menuService.getMenuActions(H.ExtensionEditorContextMenu,this.contextKeyService);j(u,{primary:[],secondary:s}),this._contextMenuService.showContextMenu({getAnchor:()=>e.anchor,getActions:()=>s})})}layout(f){this._list?.layout(f.height)}};S=A([p(1,le),p(2,ue),p(3,Z),p(4,ge),p(5,he),p(6,se),p(7,ee),p(8,ie),p(9,ce),p(10,ne),p(11,de),p(12,X),p(13,xe),p(14,te),p(15,Q)],S);class _t extends J{constructor(){super({id:"workbench.action.showRuntimeExtensions",title:m.localize2("showRuntimeExtensions","Show Running Extensions"),category:V.Developer,f1:!0,menu:{id:H.ViewContainerTitle,when:Y.equals("viewContainer","workbench.view.extensions"),group:"2_enablement",order:3}})}async run(I){await I.get(fe).openEditor(Ie.instance,{pinned:!0})}}export{S as AbstractRuntimeExtensionsEditor,_t as ShowRuntimeExtensionsAction};
