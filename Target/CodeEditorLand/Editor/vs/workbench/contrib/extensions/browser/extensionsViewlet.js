var he=Object.defineProperty;var de=Object.getOwnPropertyDescriptor;var C=(w,m,e,t)=>{for(var n=t>1?void 0:t?de(m,e):m,s=w.length-1,d;s>=0;s--)(d=w[s])&&(n=(t?d(m,e,n):d(n))||n);return t&&n&&he(m,e,n),n},o=(w,m)=>(e,t)=>m(e,t,w);import"./media/extensionsViewlet.css";import{$ as g,Dimension as O,DragAndDropObserver as pe,EventType as A,addDisposableListener as _,append as E,clearNode as xe,hide as L,show as ue,trackFocus as me}from"../../../../base/browser/dom.js";import{StandardKeyboardEvent as ve}from"../../../../base/browser/keyboardEvent.js";import{alert as M}from"../../../../base/browser/ui/aria/aria.js";import{Action as ge}from"../../../../base/common/actions.js";import{coalesce as Ee}from"../../../../base/common/arrays.js";import{Delayer as fe,Promises as we,timeout as Se}from"../../../../base/common/async.js";import{createErrorWithActions as ye}from"../../../../base/common/errorMessage.js";import{isCancellationError as be}from"../../../../base/common/errors.js";import{Event as b}from"../../../../base/common/event.js";import{KeyCode as F}from"../../../../base/common/keyCodes.js";import{Disposable as Q,DisposableStore as Ie,MutableDisposable as H}from"../../../../base/common/lifecycle.js";import{extname as Ce}from"../../../../base/common/resources.js";import q from"../../../../base/common/severity.js";import{localize as u,localize2 as a}from"../../../../nls.js";import{createActionViewItem as De}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{MenuWorkbenchToolBar as Ve}from"../../../../platform/actions/browser/toolbar.js";import{Action2 as $,MenuId as ke,registerAction2 as G}from"../../../../platform/actions/common/actions.js";import{ICommandService as Me}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as j}from"../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as i,IContextKeyService as z,RawContextKey as x}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as Ke}from"../../../../platform/contextview/browser/contextView.js";import{extractEditorsAndFilesDropData as Te}from"../../../../platform/dnd/browser/dnd.js";import{IExtensionManagementService as Re}from"../../../../platform/extensionManagement/common/extensionManagement.js";import{areSameExtensions as We}from"../../../../platform/extensionManagement/common/extensionManagementUtil.js";import{EXTENSION_CATEGORIES as Le,ExtensionType as Be}from"../../../../platform/extensions/common/extensions.js";import{SyncDescriptor as l}from"../../../../platform/instantiation/common/descriptors.js";import{IInstantiationService as B}from"../../../../platform/instantiation/common/instantiation.js";import{ILabelService as Ue}from"../../../../platform/label/common/label.js";import{ILogService as Pe}from"../../../../platform/log/common/log.js";import{INotificationService as X,NotificationPriority as Ne}from"../../../../platform/notification/common/notification.js";import{IProgressService as Oe,ProgressLocation as Ae}from"../../../../platform/progress/common/progress.js";import{Registry as _e}from"../../../../platform/registry/common/platform.js";import{SeverityIcon as Fe}from"../../../../platform/severityIcon/browser/severityIcon.js";import{IStorageService as Qe,StorageScope as He,StorageTarget as qe}from"../../../../platform/storage/common/storage.js";import{ITelemetryService as $e}from"../../../../platform/telemetry/common/telemetry.js";import{IThemeService as Ge}from"../../../../platform/theme/common/themeService.js";import{IWorkspaceContextService as je}from"../../../../platform/workspace/common/workspace.js";import{registerNavigableContainer as ze}from"../../../browser/actions/widgetNavigationCommands.js";import{ViewPaneContainer as Xe}from"../../../browser/parts/views/viewPaneContainer.js";import{VirtualWorkspaceContext as Y,WorkbenchStateContext as Ye}from"../../../common/contextkeys.js";import{SIDE_BAR_DRAG_AND_DROP_BACKGROUND as Je}from"../../../common/theme.js";import{Extensions as Ze,IViewDescriptorService as J,ViewContainerLocation as et}from"../../../common/views.js";import{IActivityService as tt,NumberBadge as nt,WarningBadge as it}from"../../../services/activity/common/activity.js";import{IEditorGroupsService as st}from"../../../services/editor/common/editorGroupsService.js";import{IWorkbenchEnvironmentService as ot}from"../../../services/environment/common/environmentService.js";import{IExtensionManagementServerService as Z,IWorkbenchExtensionEnablementService as rt}from"../../../services/extensionManagement/common/extensionManagement.js";import{IExtensionService as at}from"../../../services/extensions/common/extensions.js";import{IHostService as ct}from"../../../services/host/browser/host.js";import{IWorkbenchLayoutService as lt}from"../../../services/layout/browser/layoutService.js";import{IPaneCompositePartService as ht}from"../../../services/panecomposite/browser/panecomposite.js";import{IPreferencesService as dt}from"../../../services/preferences/common/preferences.js";import{SuggestEnabledInput as pt}from"../../codeEditor/browser/suggestEnabledInput/suggestEnabledInput.js";import{Query as ee}from"../common/extensionQuery.js";import{AutoCheckUpdatesConfigurationKey as xt,AutoRestartConfigurationKey as ut,CONTEXT_HAS_GALLERY as te,CloseExtensionDetailsOnViewChangeKey as mt,IExtensionsWorkbenchService as ne,INSTALL_EXTENSION_FROM_VSIX_COMMAND_ID as vt,OUTDATED_EXTENSIONS_VIEW_ID as gt,VIEWLET_ID as D,WORKSPACE_RECOMMENDATIONS_VIEW_ID as Et,extensionsSearchActionsMenu as ft}from"../common/extensions.js";import{ExtensionsInput as wt}from"../common/extensionsInput.js";import{InstallLocalExtensionsInRemoteAction as St,InstallRemoteExtensionsInLocalAction as yt}from"./extensionsActions.js";import{installLocalInRemoteIcon as bt}from"./extensionsIcons.js";import{DefaultPopularExtensionsView as It,DefaultRecommendedExtensionsView as Ct,DeprecatedExtensionsView as Dt,DisabledExtensionsView as Vt,EnabledExtensionsView as kt,ExtensionsListView as c,NONE_CATEGORY as Mt,OutdatedExtensionsView as Kt,RecentlyUpdatedExtensionsView as Tt,RecommendedExtensionsView as Rt,SearchMarketplaceExtensionsView as Wt,ServerInstalledExtensionsView as Lt,StaticQueryExtensionsView as U,UntrustedWorkspacePartiallySupportedExtensionsView as Bt,UntrustedWorkspaceUnsupportedExtensionsView as Ut,VirtualWorkspacePartiallySupportedExtensionsView as Pt,VirtualWorkspaceUnsupportedExtensionsView as Nt,WorkspaceRecommendedExtensionsView as Ot}from"./extensionsViews.js";const I=new x("defaultExtensionViews",!0),At=new x("extensionsSortByValue",""),_t=new x("searchMarketplaceExtensions",!1),Ft=new x("extensionSearchHasText",!1),Qt=new x("installedExtensions",!1),Ht=new x("searchInstalledExtensions",!1),qt=new x("searchRecentlyUpdatedExtensions",!1),P=new x("searchExtensionUpdates",!1),$t=new x("searchOutdatedExtensions",!1),Gt=new x("searchEnabledExtensions",!1),jt=new x("searchDisabledExtensions",!1),zt=new x("hasInstalledExtensions",!0),Xt=new x("builtInExtensions",!1),Yt=new x("searchBuiltInExtensions",!1),V=new x("searchUnsupportedWorkspaceExtensions",!1),ie=new x("searchDeprecatedExtensions",!1),Jt=new x("recommendedExtensions",!1),se=new x("sortByUpdateDate",!1),oe=a({key:"remote",comment:["Remote as in remote machine"]},"Remote");let K=class extends Q{constructor(e,t,n,s){super();this.extensionManagementServerService=e;this.labelService=t;this.contextKeyService=s;this.container=n.getViewContainerById(D),this.registerViews()}container;registerViews(){const e=[];e.push(...this.createDefaultExtensionsViewDescriptors()),e.push(...this.createSearchExtensionsViewDescriptors()),e.push(...this.createRecommendedExtensionsViewDescriptors()),e.push(...this.createBuiltinExtensionsViewDescriptors()),e.push(...this.createUnsupportedWorkspaceExtensionsViewDescriptors()),e.push(...this.createOtherLocalFilteredExtensionsViewDescriptors()),_e.as(Ze.ViewsRegistry).registerViews(e,this.container)}createDefaultExtensionsViewDescriptors(){const e=[],t=[];this.extensionManagementServerService.localExtensionManagementServer&&t.push(this.extensionManagementServerService.localExtensionManagementServer),this.extensionManagementServerService.remoteExtensionManagementServer&&t.push(this.extensionManagementServerService.remoteExtensionManagementServer),this.extensionManagementServerService.webExtensionManagementServer&&t.push(this.extensionManagementServerService.webExtensionManagementServer);const n=(r,v)=>t.length>1?`${v.label} - ${r}`:r;let s=b.None;if(this.extensionManagementServerService.webExtensionManagementServer&&this.extensionManagementServerService.remoteExtensionManagementServer){const r=new Set;r.add("hasInstalledWebExtensions"),s=b.filter(this.contextKeyService.onDidChangeContext,v=>v.affectsSome(r))}const d=b.any(this.labelService.onDidChangeFormatters,s);for(const r of t){const v=()=>n(u("installed","Installed"),r),k=b.map(d,()=>v()),y=t.length>1?`workbench.views.extensions.${r.id}.installed`:"workbench.views.extensions.installed";e.push({id:y,get name(){return{value:v(),original:n("Installed",r)}},weight:100,order:1,when:i.and(I),ctorDescriptor:new l(Lt,[{server:r,flexibleHeight:!0,onDidChangeTitle:k}]),canToggleVisibility:t.length===1}),r===this.extensionManagementServerService.remoteExtensionManagementServer&&this.extensionManagementServerService.localExtensionManagementServer&&this._register(G(class extends ${constructor(){super({id:"workbench.extensions.installLocalExtensions",get title(){return a("select and install local extensions","Install Local Extensions in '{0}'...",r.label)},category:oe,icon:bt,f1:!0,menu:{id:ke.ViewTitle,when:i.equals("view",y),group:"navigation"}})}run(S){return S.get(B).createInstance(St).run()}}))}return this.extensionManagementServerService.localExtensionManagementServer&&this.extensionManagementServerService.remoteExtensionManagementServer&&this._register(G(class extends ${constructor(){super({id:"workbench.extensions.actions.installLocalExtensionsInRemote",title:a("install remote in local","Install Remote Extensions Locally..."),category:oe,f1:!0})}run(v){return v.get(B).createInstance(yt,"workbench.extensions.actions.installLocalExtensionsInRemote").run()}})),e.push({id:"workbench.views.extensions.popular",name:a("popularExtensions","Popular"),ctorDescriptor:new l(It,[{hideBadge:!0}]),when:i.and(I,i.not("hasInstalledExtensions"),te),weight:60,order:2,canToggleVisibility:!1}),e.push({id:"extensions.recommendedList",name:a("recommendedExtensions","Recommended"),ctorDescriptor:new l(Ct,[{flexibleHeight:!0}]),when:i.and(I,se.negate(),i.not("config.extensions.showRecommendationsOnlyOnDemand"),te),weight:40,order:3,canToggleVisibility:!0}),t.length===1&&(e.push({id:"workbench.views.extensions.enabled",name:a("enabledExtensions","Enabled"),ctorDescriptor:new l(kt,[{}]),when:i.and(I,i.has("hasInstalledExtensions")),hideByDefault:!0,weight:40,order:4,canToggleVisibility:!0}),e.push({id:"workbench.views.extensions.disabled",name:a("disabledExtensions","Disabled"),ctorDescriptor:new l(Vt,[{}]),when:i.and(I,i.has("hasInstalledExtensions")),hideByDefault:!0,weight:10,order:5,canToggleVisibility:!0})),e}createSearchExtensionsViewDescriptors(){const e=[];return e.push({id:"workbench.views.extensions.marketplace",name:a("marketPlace","Marketplace"),ctorDescriptor:new l(Wt,[{}]),when:i.and(i.has("searchMarketplaceExtensions"))}),e.push({id:"workbench.views.extensions.searchInstalled",name:a("installed","Installed"),ctorDescriptor:new l(c,[{}]),when:i.or(i.has("searchInstalledExtensions"),i.has("installedExtensions"))}),e.push({id:"workbench.views.extensions.searchRecentlyUpdated",name:a("recently updated","Recently Updated"),ctorDescriptor:new l(Tt,[{}]),when:i.or(P,i.has("searchRecentlyUpdatedExtensions")),order:2}),e.push({id:"workbench.views.extensions.searchEnabled",name:a("enabled","Enabled"),ctorDescriptor:new l(c,[{}]),when:i.and(i.has("searchEnabledExtensions"))}),e.push({id:"workbench.views.extensions.searchDisabled",name:a("disabled","Disabled"),ctorDescriptor:new l(c,[{}]),when:i.and(i.has("searchDisabledExtensions"))}),e.push({id:gt,name:a("availableUpdates","Available Updates"),ctorDescriptor:new l(Kt,[{}]),when:i.or(P,i.has("searchOutdatedExtensions")),order:1}),e.push({id:"workbench.views.extensions.searchBuiltin",name:a("builtin","Builtin"),ctorDescriptor:new l(c,[{}]),when:i.and(i.has("searchBuiltInExtensions"))}),e.push({id:"workbench.views.extensions.searchWorkspaceUnsupported",name:a("workspaceUnsupported","Workspace Unsupported"),ctorDescriptor:new l(c,[{}]),when:i.and(i.has("searchWorkspaceUnsupportedExtensions"))}),e}createRecommendedExtensionsViewDescriptors(){const e=[];return e.push({id:Et,name:a("workspaceRecommendedExtensions","Workspace Recommendations"),ctorDescriptor:new l(Ot,[{}]),when:i.and(i.has("recommendedExtensions"),Ye.notEqualsTo("empty")),order:1}),e.push({id:"workbench.views.extensions.otherRecommendations",name:a("otherRecommendedExtensions","Other Recommendations"),ctorDescriptor:new l(Rt,[{}]),when:i.has("recommendedExtensions"),order:2}),e}createBuiltinExtensionsViewDescriptors(){const e=[],t=["themes","programming languages"],n=Le.filter(d=>!t.includes(d.toLowerCase()));n.push(Mt);const s=`${n.map(d=>`category:"${d}"`).join(" ")} ${t.map(d=>`category:"-${d}"`).join(" ")}`;return e.push({id:"workbench.views.extensions.builtinFeatureExtensions",name:a("builtinFeatureExtensions","Features"),ctorDescriptor:new l(U,[{query:`@builtin ${s}`}]),when:i.has("builtInExtensions")}),e.push({id:"workbench.views.extensions.builtinThemeExtensions",name:a("builtInThemesExtensions","Themes"),ctorDescriptor:new l(U,[{query:"@builtin category:themes"}]),when:i.has("builtInExtensions")}),e.push({id:"workbench.views.extensions.builtinProgrammingLanguageExtensions",name:a("builtinProgrammingLanguageExtensions","Programming Languages"),ctorDescriptor:new l(U,[{query:'@builtin category:"programming languages"'}]),when:i.has("builtInExtensions")}),e}createUnsupportedWorkspaceExtensionsViewDescriptors(){const e=[];return e.push({id:"workbench.views.extensions.untrustedUnsupportedExtensions",name:a("untrustedUnsupportedExtensions","Disabled in Restricted Mode"),ctorDescriptor:new l(Ut,[{}]),when:i.and(V)}),e.push({id:"workbench.views.extensions.untrustedPartiallySupportedExtensions",name:a("untrustedPartiallySupportedExtensions","Limited in Restricted Mode"),ctorDescriptor:new l(Bt,[{}]),when:i.and(V)}),e.push({id:"workbench.views.extensions.virtualUnsupportedExtensions",name:a("virtualUnsupportedExtensions","Disabled in Virtual Workspaces"),ctorDescriptor:new l(Nt,[{}]),when:i.and(Y,V)}),e.push({id:"workbench.views.extensions.virtualPartiallySupportedExtensions",name:a("virtualPartiallySupportedExtensions","Limited in Virtual Workspaces"),ctorDescriptor:new l(Pt,[{}]),when:i.and(Y,V)}),e}createOtherLocalFilteredExtensionsViewDescriptors(){const e=[];return e.push({id:"workbench.views.extensions.deprecatedExtensions",name:a("deprecated","Deprecated"),ctorDescriptor:new l(Dt,[{}]),when:i.and(ie)}),e}};K=C([o(0,Z),o(1,Ue),o(2,J),o(3,z)],K);let T=class extends Xe{constructor(e,t,n,s,d,r,v,k,y,h,S,f,re,p,ae,ce,le,Zt,en){super(D,{mergeViewWithContainerWhenSingleView:!0},s,S,e,ae,t,ce,h,f,re,le);this.progressService=n;this.editorGroupService=d;this.extensionsWorkbenchService=r;this.extensionManagementServerService=v;this.notificationService=k;this.paneCompositeService=y;this.contextKeyService=p;this.preferencesService=Zt;this.commandService=en;this.searchDelayer=new fe(500),this.defaultViewsContextKey=I.bindTo(p),this.sortByContextKey=At.bindTo(p),this.searchMarketplaceExtensionsContextKey=_t.bindTo(p),this.searchHasTextContextKey=Ft.bindTo(p),this.sortByUpdateDateContextKey=se.bindTo(p),this.installedExtensionsContextKey=Qt.bindTo(p),this.searchInstalledExtensionsContextKey=Ht.bindTo(p),this.searchRecentlyUpdatedExtensionsContextKey=qt.bindTo(p),this.searchExtensionUpdatesContextKey=P.bindTo(p),this.searchWorkspaceUnsupportedExtensionsContextKey=V.bindTo(p),this.searchDeprecatedExtensionsContextKey=ie.bindTo(p),this.searchOutdatedExtensionsContextKey=$t.bindTo(p),this.searchEnabledExtensionsContextKey=Gt.bindTo(p),this.searchDisabledExtensionsContextKey=jt.bindTo(p),this.hasInstalledExtensionsContextKey=zt.bindTo(p),this.builtInExtensionsContextKey=Xt.bindTo(p),this.searchBuiltInExtensionsContextKey=Yt.bindTo(p),this.recommendedExtensionsContextKey=Jt.bindTo(p),this._register(this.paneCompositeService.onDidPaneCompositeOpen(N=>{N.viewContainerLocation===et.Sidebar&&this.onViewletOpen(N.composite)},this)),this._register(r.onReset(()=>this.refresh())),this.searchViewletState=this.getMemento(He.WORKSPACE,qe.MACHINE)}defaultViewsContextKey;sortByContextKey;searchMarketplaceExtensionsContextKey;searchHasTextContextKey;sortByUpdateDateContextKey;installedExtensionsContextKey;searchInstalledExtensionsContextKey;searchRecentlyUpdatedExtensionsContextKey;searchExtensionUpdatesContextKey;searchOutdatedExtensionsContextKey;searchEnabledExtensionsContextKey;searchDisabledExtensionsContextKey;hasInstalledExtensionsContextKey;builtInExtensionsContextKey;searchBuiltInExtensionsContextKey;searchWorkspaceUnsupportedExtensionsContextKey;searchDeprecatedExtensionsContextKey;recommendedExtensionsContextKey;searchDelayer;root;header;searchBox;notificationContainer;searchViewletState;get searchValue(){return this.searchBox?.getValue()}create(e){e.classList.add("extensions-viewlet"),this.root=e;const t=E(this.root,g(".overlay")),n=this.getColor(Je)??"";t.style.backgroundColor=n,L(t),this.header=E(this.root,g(".header"));const s=u("searchExtensions","Search Extensions in Marketplace"),d=this.searchViewletState["query.value"]?this.searchViewletState["query.value"]:"",r=E(this.header,g(".extensions-search-container"));this.searchBox=this._register(this.instantiationService.createInstance(pt,`${D}.searchbox`,r,{triggerCharacters:["@"],sortKey:h=>h.indexOf(":")===-1?"a":/ext:/.test(h)||/id:/.test(h)||/tag:/.test(h)?"b":/sort:/.test(h)?"c":"d",provideResults:h=>ee.suggestions(h)},s,"extensions:searchinput",{placeholderText:s,value:d})),this.notificationContainer=E(this.header,g(".notification-container.hidden",{tabindex:"0"})),this.renderNotificaiton(),this._register(this.extensionsWorkbenchService.onDidChangeExtensionsNotification(()=>this.renderNotificaiton())),this.updateInstalledExtensionsContexts(),this.searchBox.getValue()&&this.triggerSearch(),this._register(this.searchBox.onInputDidChange(()=>{this.sortByContextKey.set(ee.parse(this.searchBox?.getValue()??"").sortBy),this.triggerSearch()},this)),this._register(this.searchBox.onShouldFocusResults(()=>this.focusListView(),this));const v=E(r,g(".extensions-search-actions-container"));this._register(this.instantiationService.createInstance(Ve,v,ft,{toolbarOptions:{primaryGroup:()=>!0},actionViewItemProvider:(h,S)=>De(this.instantiationService,h,S)})),this._register(new pe(this.root,{onDragEnter:h=>{this.isSupportedDragElement(h)&&ue(t)},onDragLeave:h=>{this.isSupportedDragElement(h)&&L(t)},onDragOver:h=>{this.isSupportedDragElement(h)&&(h.dataTransfer.dropEffect="copy")},onDrop:async h=>{if(this.isSupportedDragElement(h)){L(t);const S=Ee((await this.instantiationService.invokeFunction(f=>Te(f,h))).map(f=>f.resource&&Ce(f.resource)===".vsix"?f.resource:void 0));if(S.length>0)try{await this.commandService.executeCommand(vt,S)}catch(f){this.notificationService.error(f)}}}})),super.create(E(this.root,g(".extensions")));const k=this._register(me(this.root)),y=()=>this.searchBox?.inputWidget.hasWidgetFocus();this._register(ze({name:"extensionsView",focusNotifiers:[k],focusNextWidget:()=>{y()&&this.focusListView()},focusPreviousWidget:()=>{y()||this.searchBox?.focus()}}))}focus(){super.focus(),this.searchBox?.focus()}_dimension;layout(e){this._dimension=e,this.root&&(this.root.classList.toggle("narrow",e.width<=250),this.root.classList.toggle("mini",e.width<=200)),this.searchBox?.layout(new O(e.width-34-8-24*2,20));const t=41,n=this.header&&this.notificationContainer?.childNodes.length?this.notificationContainer.clientHeight+t+10:t;this.header.style.height=`${n}px`,super.layout(new O(e.width,e.height-n))}getOptimalWidth(){return 400}search(e){this.searchBox&&this.searchBox.getValue()!==e&&this.searchBox.setValue(e)}async refresh(){await this.updateInstalledExtensionsContexts(),this.doSearch(!0),this.configurationService.getValue(xt)&&this.extensionsWorkbenchService.checkForUpdates()}notificationDisposables=this._register(new H);renderNotificaiton(){if(!this.notificationContainer)return;xe(this.notificationContainer),this.notificationDisposables.value=new Ie;const e=this.extensionsWorkbenchService.getExtensionsNotification(),t=e?.extensions.map(n=>`@id:${n.identifier.id}`).join(" ");if(e&&(t===this.searchBox?.getValue()||!this.searchMarketplaceExtensionsContextKey.get())){this.notificationContainer.setAttribute("aria-label",e.message),this.notificationContainer.classList.remove("hidden");const n=E(this.notificationContainer,g(".message-container"));E(n,g("span")).className=Fe.className(e.severity),E(n,g("span.message",void 0,e.message));const s=E(n,g("span.message-text-action",{tabindex:"0",role:"button","aria-label":`${e.message}. ${u("click show","Click to Show")}`},u("show","Show")));this.notificationDisposables.value.add(_(s,A.CLICK,()=>this.search(t??""))),this.notificationDisposables.value.add(_(s,A.KEY_DOWN,d=>{const r=new ve(d);(r.keyCode===F.Enter||r.keyCode===F.Space)&&this.search(t??""),r.stopPropagation()}))}else this.notificationContainer.removeAttribute("aria-label"),this.notificationContainer.classList.add("hidden");this._dimension&&this.layout(this._dimension)}async updateInstalledExtensionsContexts(){const e=await this.extensionsWorkbenchService.queryLocal();this.hasInstalledExtensionsContextKey.set(e.some(t=>!t.isBuiltin))}triggerSearch(){this.searchDelayer.trigger(()=>this.doSearch(),this.searchBox&&this.searchBox.getValue()?500:0).then(void 0,e=>this.onError(e))}normalizedQuery(){return this.searchBox?this.searchBox.getValue().trim().replace(/@category/g,"category").replace(/@tag:/g,"tag:").replace(/@ext:/g,"ext:").replace(/@featured/g,"featured").replace(/@popular/g,this.extensionManagementServerService.webExtensionManagementServer&&!this.extensionManagementServerService.localExtensionManagementServer&&!this.extensionManagementServerService.remoteExtensionManagementServer?"@web":"@popular"):""}saveState(){const e=this.searchBox?this.searchBox.getValue():"";c.isLocalExtensionsQuery(e)?this.searchViewletState["query.value"]=e:this.searchViewletState["query.value"]="",super.saveState()}doSearch(e){const t=this.normalizedQuery();return this.contextKeyService.bufferChangeEvents(()=>{const n=c.isRecommendedExtensionsQuery(t);this.searchHasTextContextKey.set(t.trim()!==""),this.installedExtensionsContextKey.set(c.isInstalledExtensionsQuery(t)),this.searchInstalledExtensionsContextKey.set(c.isSearchInstalledExtensionsQuery(t)),this.searchRecentlyUpdatedExtensionsContextKey.set(c.isSearchRecentlyUpdatedQuery(t)&&!c.isSearchExtensionUpdatesQuery(t)),this.searchOutdatedExtensionsContextKey.set(c.isOutdatedExtensionsQuery(t)&&!c.isSearchExtensionUpdatesQuery(t)),this.searchExtensionUpdatesContextKey.set(c.isSearchExtensionUpdatesQuery(t)),this.searchEnabledExtensionsContextKey.set(c.isEnabledExtensionsQuery(t)),this.searchDisabledExtensionsContextKey.set(c.isDisabledExtensionsQuery(t)),this.searchBuiltInExtensionsContextKey.set(c.isSearchBuiltInExtensionsQuery(t)),this.searchWorkspaceUnsupportedExtensionsContextKey.set(c.isSearchWorkspaceUnsupportedExtensionsQuery(t)),this.searchDeprecatedExtensionsContextKey.set(c.isSearchDeprecatedExtensionsQuery(t)),this.builtInExtensionsContextKey.set(c.isBuiltInExtensionsQuery(t)),this.recommendedExtensionsContextKey.set(n),this.searchMarketplaceExtensionsContextKey.set(!!t&&!c.isLocalExtensionsQuery(t)&&!n),this.sortByUpdateDateContextKey.set(c.isSortUpdateDateQuery(t)),this.defaultViewsContextKey.set(!t||c.isSortInstalledExtensionsQuery(t))}),this.renderNotificaiton(),this.progress(Promise.all(this.panes.map(n=>n.show(this.normalizedQuery(),e).then(s=>this.alertSearchResult(s.length,n.id))))).then(()=>{})}onDidAddViewDescriptors(e){const t=super.onDidAddViewDescriptors(e);return this.progress(Promise.all(t.map(n=>n.show(this.normalizedQuery()).then(s=>this.alertSearchResult(s.length,n.id))))),t}alertSearchResult(e,t){const n=this.viewContainerModel.visibleViewDescriptors.find(s=>s.id===t);switch(e){case 0:break;case 1:n?M(u("extensionFoundInSection","1 extension found in the {0} section.",n.name.value)):M(u("extensionFound","1 extension found."));break;default:n?M(u("extensionsFoundInSection","{0} extensions found in the {1} section.",e,n.name.value)):M(u("extensionsFound","{0} extensions found.",e));break}}getFirstExpandedPane(){for(const e of this.panes)if(e.isExpanded()&&e instanceof c)return e}focusListView(){const e=this.getFirstExpandedPane();e&&e.count()>0&&e.focus()}onViewletOpen(e){if(!(!e||e.getId()===D)&&this.configurationService.getValue(mt)){const t=this.editorGroupService.groups.map(n=>{const s=n.editors.filter(d=>d instanceof wt);return n.closeEditors(s)});Promise.all(t)}}progress(e){return this.progressService.withProgress({location:Ae.Extensions},()=>e)}onError(e){if(be(e))return;const t=e&&e.message||"";if(/ECONNREFUSED/.test(t)){const n=ye(u("suggestProxyError","Marketplace returned 'ECONNREFUSED'. Please check the 'http.proxy' setting."),[new ge("open user settings",u("open user settings","Open User Settings"),void 0,!0,()=>this.preferencesService.openUserSettings())]);this.notificationService.error(n);return}this.notificationService.error(e)}isSupportedDragElement(e){return e.dataTransfer?e.dataTransfer.types.map(n=>n.toLocaleLowerCase()).indexOf("files")!==-1:!1}};T=C([o(0,lt),o(1,$e),o(2,Oe),o(3,B),o(4,st),o(5,ne),o(6,Z),o(7,X),o(8,ht),o(9,Ge),o(10,j),o(11,Qe),o(12,je),o(13,z),o(14,Ke),o(15,at),o(16,J),o(17,dt),o(18,Me)],T);let R=class extends Q{constructor(e,t,n,s){super();this.activityService=e;this.extensionsWorkbenchService=t;this.extensionEnablementService=n;this.configurationService=s;this.onServiceChange(),this._register(b.any(b.debounce(t.onChange,()=>{},100,void 0,void 0,void 0,this._store),t.onDidChangeExtensionsNotification)(this.onServiceChange,this))}badgeHandle=this._register(new H);onServiceChange(){this.badgeHandle.clear();let e;const t=this.extensionsWorkbenchService.getExtensionsNotification();if(t)t.severity===q.Warning&&(e=new it(()=>t.message));else{const n=this.configurationService.getValue(ut)===!0?[]:this.extensionsWorkbenchService.installed.filter(r=>r.runtimeState!==void 0),s=this.extensionsWorkbenchService.outdated.reduce((r,v)=>r+(this.extensionEnablementService.isEnabled(v.local)&&!n.includes(v)?1:0),0),d=s+n.length;if(d>0){let r="";s&&(r+=s===1?u("extensionToUpdate","{0} requires update",s):u("extensionsToUpdate","{0} require update",s)),s>0&&n.length>0&&(r+=", "),n.length&&(r+=n.length===1?u("extensionToReload","{0} requires restart",n.length):u("extensionsToReload","{0} require restart",n.length)),e=new nt(d,()=>r)}}e&&(this.badgeHandle.value=this.activityService.showViewContainerActivity(D,{badge:e}))}};R=C([o(0,tt),o(1,ne),o(2,rt),o(3,j)],R);let W=class{constructor(m,e,t,n,s){this.extensionsManagementService=m;this.hostService=e;this.logService=t;this.notificationService=n;this.environmentService=s;this.environmentService.disableExtensions||this.loopCheckForMaliciousExtensions()}loopCheckForMaliciousExtensions(){this.checkForMaliciousExtensions().then(()=>Se(1e3*60*5)).then(()=>this.loopCheckForMaliciousExtensions())}checkForMaliciousExtensions(){return this.extensionsManagementService.getExtensionsControlManifest().then(m=>this.extensionsManagementService.getInstalled(Be.User).then(e=>{const t=e.filter(n=>m.malicious.some(s=>We(n.identifier,s)));return t.length?we.settled(t.map(n=>this.extensionsManagementService.uninstall(n).then(()=>{this.notificationService.prompt(q.Warning,u("malicious warning","We have uninstalled '{0}' which was reported to be problematic.",n.identifier.id),[{label:u("reloadNow","Reload Now"),run:()=>this.hostService.reload()}],{sticky:!0,priority:Ne.URGENT})}))):Promise.resolve(void 0)}).then(()=>{}),m=>this.logService.error(m))}};W=C([o(0,Re),o(1,ct),o(2,Pe),o(3,X),o(4,ot)],W);export{Xt as BuiltInExtensionsContext,I as DefaultViewsContext,At as ExtensionsSortByContext,T as ExtensionsViewPaneContainer,K as ExtensionsViewletViewsContribution,W as MaliciousExtensionChecker,Jt as RecommendedExtensionsContext,Ft as SearchHasTextContext,_t as SearchMarketplaceExtensionsContext,R as StatusUpdater};
