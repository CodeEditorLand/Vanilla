var re=Object.defineProperty;var oe=Object.getOwnPropertyDescriptor;var b=(g,u,e,t)=>{for(var n=t>1?void 0:t?oe(u,e):u,i=g.length-1,h;i>=0;i--)(h=g[i])&&(n=(t?h(u,e,n):h(n))||n);return t&&n&&re(u,e,n),n},r=(g,u)=>(e,t)=>u(e,t,g);import"./media/extensionsViewlet.css";import{localize as m,localize2 as o}from"../../../../nls.js";import{timeout as ae,Delayer as ce,Promises as le}from"../../../../base/common/async.js";import{isCancellationError as he}from"../../../../base/common/errors.js";import{createErrorWithActions as de}from"../../../../base/common/errorMessage.js";import{Disposable as _,MutableDisposable as pe}from"../../../../base/common/lifecycle.js";import{Event as I}from"../../../../base/common/event.js";import{Action as xe}from"../../../../base/common/actions.js";import{append as C,$ as D,Dimension as N,hide as L,show as ue,DragAndDropObserver as me,trackFocus as ve}from"../../../../base/browser/dom.js";import{ITelemetryService as Ee}from"../../../../platform/telemetry/common/telemetry.js";import{IInstantiationService as U}from"../../../../platform/instantiation/common/instantiation.js";import{IExtensionService as ge}from"../../../services/extensions/common/extensions.js";import{IExtensionsWorkbenchService as F,VIEWLET_ID as V,CloseExtensionDetailsOnViewChangeKey as we,INSTALL_EXTENSION_FROM_VSIX_COMMAND_ID as Se,WORKSPACE_RECOMMENDATIONS_VIEW_ID as fe,AutoCheckUpdatesConfigurationKey as ye,OUTDATED_EXTENSIONS_VIEW_ID as be,CONTEXT_HAS_GALLERY as Q,extensionsSearchActionsMenu as Ie,AutoRestartConfigurationKey as Ce}from"../common/extensions.js";import{InstallLocalExtensionsInRemoteAction as De,InstallRemoteExtensionsInLocalAction as Ve}from"./extensionsActions.js";import{IExtensionManagementService as ke}from"../../../../platform/extensionManagement/common/extensionManagement.js";import{IWorkbenchExtensionEnablementService as Me,IExtensionManagementServerService as H}from"../../../services/extensionManagement/common/extensionManagement.js";import{ExtensionsInput as Ke}from"../common/extensionsInput.js";import{ExtensionsListView as a,EnabledExtensionsView as Re,DisabledExtensionsView as Te,RecommendedExtensionsView as We,WorkspaceRecommendedExtensionsView as Be,ServerInstalledExtensionsView as Le,DefaultRecommendedExtensionsView as Ue,UntrustedWorkspaceUnsupportedExtensionsView as Pe,UntrustedWorkspacePartiallySupportedExtensionsView as Oe,VirtualWorkspaceUnsupportedExtensionsView as Ae,VirtualWorkspacePartiallySupportedExtensionsView as _e,DefaultPopularExtensionsView as Ne,DeprecatedExtensionsView as Fe,SearchMarketplaceExtensionsView as Qe,RecentlyUpdatedExtensionsView as He,OutdatedExtensionsView as qe,StaticQueryExtensionsView as P,NONE_CATEGORY as Ge}from"./extensionsViews.js";import{IProgressService as $e,ProgressLocation as ze}from"../../../../platform/progress/common/progress.js";import{IEditorGroupsService as Xe}from"../../../services/editor/common/editorGroupsService.js";import je from"../../../../base/common/severity.js";import{IActivityService as Ye,NumberBadge as Je}from"../../../services/activity/common/activity.js";import{IThemeService as Ze}from"../../../../platform/theme/common/themeService.js";import{IConfigurationService as q}from"../../../../platform/configuration/common/configuration.js";import{Extensions as et,IViewDescriptorService as G,ViewContainerLocation as tt}from"../../../common/views.js";import{IStorageService as nt,StorageScope as st,StorageTarget as it}from"../../../../platform/storage/common/storage.js";import{IWorkspaceContextService as rt}from"../../../../platform/workspace/common/workspace.js";import{IContextKeyService as $,ContextKeyExpr as s,RawContextKey as p}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as ot}from"../../../../platform/contextview/browser/contextView.js";import{ILogService as at}from"../../../../platform/log/common/log.js";import{INotificationService as z,NotificationPriority as ct}from"../../../../platform/notification/common/notification.js";import{IHostService as lt}from"../../../services/host/browser/host.js";import{IWorkbenchLayoutService as ht}from"../../../services/layout/browser/layoutService.js";import{ViewPaneContainer as dt}from"../../../browser/parts/views/viewPaneContainer.js";import{Query as X}from"../common/extensionQuery.js";import{SuggestEnabledInput as pt}from"../../codeEditor/browser/suggestEnabledInput/suggestEnabledInput.js";import{alert as K}from"../../../../base/browser/ui/aria/aria.js";import{EXTENSION_CATEGORIES as xt,ExtensionType as ut}from"../../../../platform/extensions/common/extensions.js";import{Registry as mt}from"../../../../platform/registry/common/platform.js";import{ILabelService as vt}from"../../../../platform/label/common/label.js";import{SyncDescriptor as l}from"../../../../platform/instantiation/common/descriptors.js";import{IPreferencesService as Et}from"../../../services/preferences/common/preferences.js";import{SIDE_BAR_DRAG_AND_DROP_BACKGROUND as gt}from"../../../common/theme.js";import{IWorkbenchEnvironmentService as wt}from"../../../services/environment/common/environmentService.js";import{VirtualWorkspaceContext as j,WorkbenchStateContext as St}from"../../../common/contextkeys.js";import{ICommandService as ft}from"../../../../platform/commands/common/commands.js";import{installLocalInRemoteIcon as yt}from"./extensionsIcons.js";import{registerAction2 as Y,Action2 as J,MenuId as bt}from"../../../../platform/actions/common/actions.js";import{IPaneCompositePartService as It}from"../../../services/panecomposite/browser/panecomposite.js";import{coalesce as Ct}from"../../../../base/common/arrays.js";import{extractEditorsAndFilesDropData as Dt}from"../../../../platform/dnd/browser/dnd.js";import{extname as Vt}from"../../../../base/common/resources.js";import{areSameExtensions as kt}from"../../../../platform/extensionManagement/common/extensionManagementUtil.js";import{registerNavigableContainer as Mt}from"../../../browser/actions/widgetNavigationCommands.js";import{MenuWorkbenchToolBar as Kt}from"../../../../platform/actions/browser/toolbar.js";import{createActionViewItem as Rt}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";const S=new p("defaultExtensionViews",!0),Tt=new p("extensionsSortByValue",""),Wt=new p("searchMarketplaceExtensions",!1),Bt=new p("extensionSearchHasText",!1),Lt=new p("installedExtensions",!1),Ut=new p("searchInstalledExtensions",!1),Pt=new p("searchRecentlyUpdatedExtensions",!1),O=new p("searchExtensionUpdates",!1),Ot=new p("searchOutdatedExtensions",!1),At=new p("searchEnabledExtensions",!1),_t=new p("searchDisabledExtensions",!1),Nt=new p("hasInstalledExtensions",!0),Ft=new p("builtInExtensions",!1),Qt=new p("searchBuiltInExtensions",!1),k=new p("searchUnsupportedWorkspaceExtensions",!1),Z=new p("searchDeprecatedExtensions",!1),Ht=new p("recommendedExtensions",!1),ee=new p("sortByUpdateDate",!1),te=o({key:"remote",comment:["Remote as in remote machine"]},"Remote");let R=class extends _{constructor(e,t,n,i){super();this.extensionManagementServerService=e;this.labelService=t;this.contextKeyService=i;this.container=n.getViewContainerById(V),this.registerViews()}container;registerViews(){const e=[];e.push(...this.createDefaultExtensionsViewDescriptors()),e.push(...this.createSearchExtensionsViewDescriptors()),e.push(...this.createRecommendedExtensionsViewDescriptors()),e.push(...this.createBuiltinExtensionsViewDescriptors()),e.push(...this.createUnsupportedWorkspaceExtensionsViewDescriptors()),e.push(...this.createOtherLocalFilteredExtensionsViewDescriptors()),mt.as(et.ViewsRegistry).registerViews(e,this.container)}createDefaultExtensionsViewDescriptors(){const e=[],t=[];this.extensionManagementServerService.localExtensionManagementServer&&t.push(this.extensionManagementServerService.localExtensionManagementServer),this.extensionManagementServerService.remoteExtensionManagementServer&&t.push(this.extensionManagementServerService.remoteExtensionManagementServer),this.extensionManagementServerService.webExtensionManagementServer&&t.push(this.extensionManagementServerService.webExtensionManagementServer);const n=(x,v)=>t.length>1?`${v.label} - ${x}`:x;let i=I.None;if(this.extensionManagementServerService.webExtensionManagementServer&&this.extensionManagementServerService.remoteExtensionManagementServer){const x=new Set;x.add("hasInstalledWebExtensions"),i=I.filter(this.contextKeyService.onDidChangeContext,v=>v.affectsSome(x))}const h=I.any(this.labelService.onDidChangeFormatters,i);for(const x of t){const v=()=>n(m("installed","Installed"),x),M=I.map(h,()=>v()),f=t.length>1?`workbench.views.extensions.${x.id}.installed`:"workbench.views.extensions.installed";e.push({id:f,get name(){return{value:v(),original:n("Installed",x)}},weight:100,order:1,when:s.and(S),ctorDescriptor:new l(Le,[{server:x,flexibleHeight:!0,onDidChangeTitle:M}]),canToggleVisibility:t.length===1}),x===this.extensionManagementServerService.remoteExtensionManagementServer&&this.extensionManagementServerService.localExtensionManagementServer&&this._register(Y(class extends J{constructor(){super({id:"workbench.extensions.installLocalExtensions",get title(){return o("select and install local extensions","Install Local Extensions in '{0}'...",x.label)},category:te,icon:yt,f1:!0,menu:{id:bt.ViewTitle,when:s.equals("view",f),group:"navigation"}})}run(c){return c.get(U).createInstance(De).run()}}))}return this.extensionManagementServerService.localExtensionManagementServer&&this.extensionManagementServerService.remoteExtensionManagementServer&&this._register(Y(class extends J{constructor(){super({id:"workbench.extensions.actions.installLocalExtensionsInRemote",title:o("install remote in local","Install Remote Extensions Locally..."),category:te,f1:!0})}run(v){return v.get(U).createInstance(Ve,"workbench.extensions.actions.installLocalExtensionsInRemote").run()}})),e.push({id:"workbench.views.extensions.popular",name:o("popularExtensions","Popular"),ctorDescriptor:new l(Ne,[{hideBadge:!0}]),when:s.and(S,s.not("hasInstalledExtensions"),Q),weight:60,order:2,canToggleVisibility:!1}),e.push({id:"extensions.recommendedList",name:o("recommendedExtensions","Recommended"),ctorDescriptor:new l(Ue,[{flexibleHeight:!0}]),when:s.and(S,ee.negate(),s.not("config.extensions.showRecommendationsOnlyOnDemand"),Q),weight:40,order:3,canToggleVisibility:!0}),t.length===1&&(e.push({id:"workbench.views.extensions.enabled",name:o("enabledExtensions","Enabled"),ctorDescriptor:new l(Re,[{}]),when:s.and(S,s.has("hasInstalledExtensions")),hideByDefault:!0,weight:40,order:4,canToggleVisibility:!0}),e.push({id:"workbench.views.extensions.disabled",name:o("disabledExtensions","Disabled"),ctorDescriptor:new l(Te,[{}]),when:s.and(S,s.has("hasInstalledExtensions")),hideByDefault:!0,weight:10,order:5,canToggleVisibility:!0})),e}createSearchExtensionsViewDescriptors(){const e=[];return e.push({id:"workbench.views.extensions.marketplace",name:o("marketPlace","Marketplace"),ctorDescriptor:new l(Qe,[{}]),when:s.and(s.has("searchMarketplaceExtensions"))}),e.push({id:"workbench.views.extensions.searchInstalled",name:o("installed","Installed"),ctorDescriptor:new l(a,[{}]),when:s.or(s.has("searchInstalledExtensions"),s.has("installedExtensions"))}),e.push({id:"workbench.views.extensions.searchRecentlyUpdated",name:o("recently updated","Recently Updated"),ctorDescriptor:new l(He,[{}]),when:s.or(O,s.has("searchRecentlyUpdatedExtensions")),order:2}),e.push({id:"workbench.views.extensions.searchEnabled",name:o("enabled","Enabled"),ctorDescriptor:new l(a,[{}]),when:s.and(s.has("searchEnabledExtensions"))}),e.push({id:"workbench.views.extensions.searchDisabled",name:o("disabled","Disabled"),ctorDescriptor:new l(a,[{}]),when:s.and(s.has("searchDisabledExtensions"))}),e.push({id:be,name:o("availableUpdates","Available Updates"),ctorDescriptor:new l(qe,[{}]),when:s.or(O,s.has("searchOutdatedExtensions")),order:1}),e.push({id:"workbench.views.extensions.searchBuiltin",name:o("builtin","Builtin"),ctorDescriptor:new l(a,[{}]),when:s.and(s.has("searchBuiltInExtensions"))}),e.push({id:"workbench.views.extensions.searchWorkspaceUnsupported",name:o("workspaceUnsupported","Workspace Unsupported"),ctorDescriptor:new l(a,[{}]),when:s.and(s.has("searchWorkspaceUnsupportedExtensions"))}),e}createRecommendedExtensionsViewDescriptors(){const e=[];return e.push({id:fe,name:o("workspaceRecommendedExtensions","Workspace Recommendations"),ctorDescriptor:new l(Be,[{}]),when:s.and(s.has("recommendedExtensions"),St.notEqualsTo("empty")),order:1}),e.push({id:"workbench.views.extensions.otherRecommendations",name:o("otherRecommendedExtensions","Other Recommendations"),ctorDescriptor:new l(We,[{}]),when:s.has("recommendedExtensions"),order:2}),e}createBuiltinExtensionsViewDescriptors(){const e=[],t=["themes","programming languages"],n=xt.filter(h=>!t.includes(h.toLowerCase()));n.push(Ge);const i=`${n.map(h=>`category:"${h}"`).join(" ")} ${t.map(h=>`category:"-${h}"`).join(" ")}`;return e.push({id:"workbench.views.extensions.builtinFeatureExtensions",name:o("builtinFeatureExtensions","Features"),ctorDescriptor:new l(P,[{query:`@builtin ${i}`}]),when:s.has("builtInExtensions")}),e.push({id:"workbench.views.extensions.builtinThemeExtensions",name:o("builtInThemesExtensions","Themes"),ctorDescriptor:new l(P,[{query:"@builtin category:themes"}]),when:s.has("builtInExtensions")}),e.push({id:"workbench.views.extensions.builtinProgrammingLanguageExtensions",name:o("builtinProgrammingLanguageExtensions","Programming Languages"),ctorDescriptor:new l(P,[{query:'@builtin category:"programming languages"'}]),when:s.has("builtInExtensions")}),e}createUnsupportedWorkspaceExtensionsViewDescriptors(){const e=[];return e.push({id:"workbench.views.extensions.untrustedUnsupportedExtensions",name:o("untrustedUnsupportedExtensions","Disabled in Restricted Mode"),ctorDescriptor:new l(Pe,[{}]),when:s.and(k)}),e.push({id:"workbench.views.extensions.untrustedPartiallySupportedExtensions",name:o("untrustedPartiallySupportedExtensions","Limited in Restricted Mode"),ctorDescriptor:new l(Oe,[{}]),when:s.and(k)}),e.push({id:"workbench.views.extensions.virtualUnsupportedExtensions",name:o("virtualUnsupportedExtensions","Disabled in Virtual Workspaces"),ctorDescriptor:new l(Ae,[{}]),when:s.and(j,k)}),e.push({id:"workbench.views.extensions.virtualPartiallySupportedExtensions",name:o("virtualPartiallySupportedExtensions","Limited in Virtual Workspaces"),ctorDescriptor:new l(_e,[{}]),when:s.and(j,k)}),e}createOtherLocalFilteredExtensionsViewDescriptors(){const e=[];return e.push({id:"workbench.views.extensions.deprecatedExtensions",name:o("deprecated","Deprecated"),ctorDescriptor:new l(Fe,[{}]),when:s.and(Z)}),e}};R=b([r(0,H),r(1,vt),r(2,G),r(3,$)],R);let T=class extends dt{constructor(e,t,n,i,h,x,v,M,f,y,c,w,E,d,ne,se,ie,qt,Gt){super(V,{mergeViewWithContainerWhenSingleView:!0},i,c,e,ne,t,se,y,w,E,ie);this.progressService=n;this.editorGroupService=h;this.extensionsWorkbenchService=x;this.extensionManagementServerService=v;this.notificationService=M;this.paneCompositeService=f;this.contextKeyService=d;this.preferencesService=qt;this.commandService=Gt;this.searchDelayer=new ce(500),this.defaultViewsContextKey=S.bindTo(d),this.sortByContextKey=Tt.bindTo(d),this.searchMarketplaceExtensionsContextKey=Wt.bindTo(d),this.searchHasTextContextKey=Bt.bindTo(d),this.sortByUpdateDateContextKey=ee.bindTo(d),this.installedExtensionsContextKey=Lt.bindTo(d),this.searchInstalledExtensionsContextKey=Ut.bindTo(d),this.searchRecentlyUpdatedExtensionsContextKey=Pt.bindTo(d),this.searchExtensionUpdatesContextKey=O.bindTo(d),this.searchWorkspaceUnsupportedExtensionsContextKey=k.bindTo(d),this.searchDeprecatedExtensionsContextKey=Z.bindTo(d),this.searchOutdatedExtensionsContextKey=Ot.bindTo(d),this.searchEnabledExtensionsContextKey=At.bindTo(d),this.searchDisabledExtensionsContextKey=_t.bindTo(d),this.hasInstalledExtensionsContextKey=Nt.bindTo(d),this.builtInExtensionsContextKey=Ft.bindTo(d),this.searchBuiltInExtensionsContextKey=Qt.bindTo(d),this.recommendedExtensionsContextKey=Ht.bindTo(d),this._register(this.paneCompositeService.onDidPaneCompositeOpen(A=>{A.viewContainerLocation===tt.Sidebar&&this.onViewletOpen(A.composite)},this)),this._register(x.onReset(()=>this.refresh())),this.searchViewletState=this.getMemento(st.WORKSPACE,it.MACHINE)}defaultViewsContextKey;sortByContextKey;searchMarketplaceExtensionsContextKey;searchHasTextContextKey;sortByUpdateDateContextKey;installedExtensionsContextKey;searchInstalledExtensionsContextKey;searchRecentlyUpdatedExtensionsContextKey;searchExtensionUpdatesContextKey;searchOutdatedExtensionsContextKey;searchEnabledExtensionsContextKey;searchDisabledExtensionsContextKey;hasInstalledExtensionsContextKey;builtInExtensionsContextKey;searchBuiltInExtensionsContextKey;searchWorkspaceUnsupportedExtensionsContextKey;searchDeprecatedExtensionsContextKey;recommendedExtensionsContextKey;searchDelayer;root;searchBox;searchViewletState;get searchValue(){return this.searchBox?.getValue()}create(e){e.classList.add("extensions-viewlet"),this.root=e;const t=C(this.root,D(".overlay")),n=this.getColor(gt)??"";t.style.backgroundColor=n,L(t);const i=C(this.root,D(".header")),h=m("searchExtensions","Search Extensions in Marketplace"),x=this.searchViewletState["query.value"]?this.searchViewletState["query.value"]:"",v=C(i,D(".extensions-search-container"));this.searchBox=this._register(this.instantiationService.createInstance(pt,`${V}.searchbox`,v,{triggerCharacters:["@"],sortKey:c=>c.indexOf(":")===-1?"a":/ext:/.test(c)||/id:/.test(c)||/tag:/.test(c)?"b":/sort:/.test(c)?"c":"d",provideResults:c=>X.suggestions(c)},h,"extensions:searchinput",{placeholderText:h,value:x})),this.updateInstalledExtensionsContexts(),this.searchBox.getValue()&&this.triggerSearch(),this._register(this.searchBox.onInputDidChange(()=>{this.sortByContextKey.set(X.parse(this.searchBox?.getValue()??"").sortBy),this.triggerSearch()},this)),this._register(this.searchBox.onShouldFocusResults(()=>this.focusListView(),this));const M=C(v,D(".extensions-search-actions-container"));this._register(this.instantiationService.createInstance(Kt,M,Ie,{toolbarOptions:{primaryGroup:()=>!0},actionViewItemProvider:(c,w)=>Rt(this.instantiationService,c,w)})),this._register(new me(this.root,{onDragEnter:c=>{this.isSupportedDragElement(c)&&ue(t)},onDragLeave:c=>{this.isSupportedDragElement(c)&&L(t)},onDragOver:c=>{this.isSupportedDragElement(c)&&(c.dataTransfer.dropEffect="copy")},onDrop:async c=>{if(this.isSupportedDragElement(c)){L(t);const w=Ct((await this.instantiationService.invokeFunction(E=>Dt(E,c))).map(E=>E.resource&&Vt(E.resource)===".vsix"?E.resource:void 0));if(w.length>0)try{await this.commandService.executeCommand(Se,w)}catch(E){this.notificationService.error(E)}}}})),super.create(C(this.root,D(".extensions")));const f=this._register(ve(this.root)),y=()=>this.searchBox?.inputWidget.hasWidgetFocus();this._register(Mt({name:"extensionsView",focusNotifiers:[f],focusNextWidget:()=>{y()&&this.focusListView()},focusPreviousWidget:()=>{y()||this.searchBox?.focus()}}))}focus(){super.focus(),this.searchBox?.focus()}layout(e){this.root&&(this.root.classList.toggle("narrow",e.width<=250),this.root.classList.toggle("mini",e.width<=200)),this.searchBox?.layout(new N(e.width-34-8-24*2,20)),super.layout(new N(e.width,e.height-41))}getOptimalWidth(){return 400}search(e){this.searchBox&&this.searchBox.getValue()!==e&&this.searchBox.setValue(e)}async refresh(){await this.updateInstalledExtensionsContexts(),this.doSearch(!0),this.configurationService.getValue(ye)&&this.extensionsWorkbenchService.checkForUpdates()}async updateInstalledExtensionsContexts(){const e=await this.extensionsWorkbenchService.queryLocal();this.hasInstalledExtensionsContextKey.set(e.some(t=>!t.isBuiltin))}triggerSearch(){this.searchDelayer.trigger(()=>this.doSearch(),this.searchBox&&this.searchBox.getValue()?500:0).then(void 0,e=>this.onError(e))}normalizedQuery(){return this.searchBox?this.searchBox.getValue().trim().replace(/@category/g,"category").replace(/@tag:/g,"tag:").replace(/@ext:/g,"ext:").replace(/@featured/g,"featured").replace(/@popular/g,this.extensionManagementServerService.webExtensionManagementServer&&!this.extensionManagementServerService.localExtensionManagementServer&&!this.extensionManagementServerService.remoteExtensionManagementServer?"@web":"@popular"):""}saveState(){const e=this.searchBox?this.searchBox.getValue():"";a.isLocalExtensionsQuery(e)?this.searchViewletState["query.value"]=e:this.searchViewletState["query.value"]="",super.saveState()}doSearch(e){const t=this.normalizedQuery();return this.contextKeyService.bufferChangeEvents(()=>{const n=a.isRecommendedExtensionsQuery(t);this.searchHasTextContextKey.set(t.trim()!==""),this.installedExtensionsContextKey.set(a.isInstalledExtensionsQuery(t)),this.searchInstalledExtensionsContextKey.set(a.isSearchInstalledExtensionsQuery(t)),this.searchRecentlyUpdatedExtensionsContextKey.set(a.isSearchRecentlyUpdatedQuery(t)&&!a.isSearchExtensionUpdatesQuery(t)),this.searchOutdatedExtensionsContextKey.set(a.isOutdatedExtensionsQuery(t)&&!a.isSearchExtensionUpdatesQuery(t)),this.searchExtensionUpdatesContextKey.set(a.isSearchExtensionUpdatesQuery(t)),this.searchEnabledExtensionsContextKey.set(a.isEnabledExtensionsQuery(t)),this.searchDisabledExtensionsContextKey.set(a.isDisabledExtensionsQuery(t)),this.searchBuiltInExtensionsContextKey.set(a.isSearchBuiltInExtensionsQuery(t)),this.searchWorkspaceUnsupportedExtensionsContextKey.set(a.isSearchWorkspaceUnsupportedExtensionsQuery(t)),this.searchDeprecatedExtensionsContextKey.set(a.isSearchDeprecatedExtensionsQuery(t)),this.builtInExtensionsContextKey.set(a.isBuiltInExtensionsQuery(t)),this.recommendedExtensionsContextKey.set(n),this.searchMarketplaceExtensionsContextKey.set(!!t&&!a.isLocalExtensionsQuery(t)&&!n),this.sortByUpdateDateContextKey.set(a.isSortUpdateDateQuery(t)),this.defaultViewsContextKey.set(!t||a.isSortInstalledExtensionsQuery(t))}),this.progress(Promise.all(this.panes.map(n=>n.show(this.normalizedQuery(),e).then(i=>this.alertSearchResult(i.length,n.id))))).then(()=>{})}onDidAddViewDescriptors(e){const t=super.onDidAddViewDescriptors(e);return this.progress(Promise.all(t.map(n=>n.show(this.normalizedQuery()).then(i=>this.alertSearchResult(i.length,n.id))))),t}alertSearchResult(e,t){const n=this.viewContainerModel.visibleViewDescriptors.find(i=>i.id===t);switch(e){case 0:break;case 1:n?K(m("extensionFoundInSection","1 extension found in the {0} section.",n.name.value)):K(m("extensionFound","1 extension found."));break;default:n?K(m("extensionsFoundInSection","{0} extensions found in the {1} section.",e,n.name.value)):K(m("extensionsFound","{0} extensions found.",e));break}}getFirstExpandedPane(){for(const e of this.panes)if(e.isExpanded()&&e instanceof a)return e}focusListView(){const e=this.getFirstExpandedPane();e&&e.count()>0&&e.focus()}onViewletOpen(e){if(!(!e||e.getId()===V)&&this.configurationService.getValue(we)){const t=this.editorGroupService.groups.map(n=>{const i=n.editors.filter(h=>h instanceof Ke);return n.closeEditors(i)});Promise.all(t)}}progress(e){return this.progressService.withProgress({location:ze.Extensions},()=>e)}onError(e){if(he(e))return;const t=e&&e.message||"";if(/ECONNREFUSED/.test(t)){const n=de(m("suggestProxyError","Marketplace returned 'ECONNREFUSED'. Please check the 'http.proxy' setting."),[new xe("open user settings",m("open user settings","Open User Settings"),void 0,!0,()=>this.preferencesService.openUserSettings())]);this.notificationService.error(n);return}this.notificationService.error(e)}isSupportedDragElement(e){return e.dataTransfer?e.dataTransfer.types.map(n=>n.toLocaleLowerCase()).indexOf("files")!==-1:!1}};T=b([r(0,ht),r(1,Ee),r(2,$e),r(3,U),r(4,Xe),r(5,F),r(6,H),r(7,z),r(8,It),r(9,Ze),r(10,q),r(11,nt),r(12,rt),r(13,$),r(14,ot),r(15,ge),r(16,G),r(17,Et),r(18,ft)],T);let W=class extends _{constructor(e,t,n,i){super();this.activityService=e;this.extensionsWorkbenchService=t;this.extensionEnablementService=n;this.configurationService=i;this.onServiceChange(),this._register(I.debounce(t.onChange,()=>{},100,void 0,void 0,void 0,this._store)(this.onServiceChange,this))}badgeHandle=this._register(new pe);onServiceChange(){this.badgeHandle.clear();const e=this.configurationService.getValue(Ce)===!0?[]:this.extensionsWorkbenchService.installed.filter(i=>i.runtimeState!==void 0),t=this.extensionsWorkbenchService.outdated.reduce((i,h)=>i+(this.extensionEnablementService.isEnabled(h.local)&&!e.includes(h)?1:0),0),n=t+e.length;if(n>0){let i="";t&&(i+=t===1?m("extensionToUpdate","{0} requires update",t):m("extensionsToUpdate","{0} require update",t)),t>0&&e.length>0&&(i+=", "),e.length&&(i+=e.length===1?m("extensionToReload","{0} requires restart",e.length):m("extensionsToReload","{0} require restart",e.length));const h=new Je(n,()=>i);this.badgeHandle.value=this.activityService.showViewContainerActivity(V,{badge:h})}}};W=b([r(0,Ye),r(1,F),r(2,Me),r(3,q)],W);let B=class{constructor(u,e,t,n,i){this.extensionsManagementService=u;this.hostService=e;this.logService=t;this.notificationService=n;this.environmentService=i;this.environmentService.disableExtensions||this.loopCheckForMaliciousExtensions()}loopCheckForMaliciousExtensions(){this.checkForMaliciousExtensions().then(()=>ae(1e3*60*5)).then(()=>this.loopCheckForMaliciousExtensions())}checkForMaliciousExtensions(){return this.extensionsManagementService.getExtensionsControlManifest().then(u=>this.extensionsManagementService.getInstalled(ut.User).then(e=>{const t=e.filter(n=>u.malicious.some(i=>kt(n.identifier,i)));return t.length?le.settled(t.map(n=>this.extensionsManagementService.uninstall(n).then(()=>{this.notificationService.prompt(je.Warning,m("malicious warning","We have uninstalled '{0}' which was reported to be problematic.",n.identifier.id),[{label:m("reloadNow","Reload Now"),run:()=>this.hostService.reload()}],{sticky:!0,priority:ct.URGENT})}))):Promise.resolve(void 0)}).then(()=>{}),u=>this.logService.error(u))}};B=b([r(0,ke),r(1,lt),r(2,at),r(3,z),r(4,wt)],B);export{Ft as BuiltInExtensionsContext,S as DefaultViewsContext,Tt as ExtensionsSortByContext,T as ExtensionsViewPaneContainer,R as ExtensionsViewletViewsContribution,B as MaliciousExtensionChecker,Ht as RecommendedExtensionsContext,Bt as SearchHasTextContext,Wt as SearchMarketplaceExtensionsContext,W as StatusUpdater};
