var he=Object.defineProperty;var pe=Object.getOwnPropertyDescriptor;var C=(w,v,e,t)=>{for(var n=t>1?void 0:t?pe(v,e):v,s=w.length-1,d;s>=0;s--)(d=w[s])&&(n=(t?d(v,e,n):d(n))||n);return t&&n&&he(v,e,n),n},o=(w,v)=>(e,t)=>v(e,t,w);import"./media/extensionsViewlet.css";import{localize as u,localize2 as a}from"../../../../nls.js";import{timeout as xe,Delayer as ue,Promises as me}from"../../../../base/common/async.js";import{isCancellationError as ve}from"../../../../base/common/errors.js";import{createErrorWithActions as Ee}from"../../../../base/common/errorMessage.js";import"../../../common/contributions.js";import{Disposable as F,DisposableStore as ge,MutableDisposable as Q}from"../../../../base/common/lifecycle.js";import{Event as b}from"../../../../base/common/event.js";import{Action as fe}from"../../../../base/common/actions.js";import{append as E,$ as g,Dimension as H,hide as P,show as we,DragAndDropObserver as Se,trackFocus as ye,addDisposableListener as K,EventType as M,clearNode as be}from"../../../../base/browser/dom.js";import{ITelemetryService as Ie}from"../../../../platform/telemetry/common/telemetry.js";import{IInstantiationService as N}from"../../../../platform/instantiation/common/instantiation.js";import{IExtensionService as Ce}from"../../../services/extensions/common/extensions.js";import{IExtensionsWorkbenchService as q,VIEWLET_ID as D,CloseExtensionDetailsOnViewChangeKey as De,INSTALL_EXTENSION_FROM_VSIX_COMMAND_ID as Ve,WORKSPACE_RECOMMENDATIONS_VIEW_ID as ke,AutoCheckUpdatesConfigurationKey as Ke,OUTDATED_EXTENSIONS_VIEW_ID as Me,CONTEXT_HAS_GALLERY as $,extensionsSearchActionsMenu as Te,AutoRestartConfigurationKey as Re}from"../common/extensions.js";import{InstallLocalExtensionsInRemoteAction as We,InstallRemoteExtensionsInLocalAction as Le}from"./extensionsActions.js";import{IExtensionManagementService as Be}from"../../../../platform/extensionManagement/common/extensionManagement.js";import{IWorkbenchExtensionEnablementService as Ue,IExtensionManagementServerService as G}from"../../../services/extensionManagement/common/extensionManagement.js";import{ExtensionsInput as Pe}from"../common/extensionsInput.js";import{ExtensionsListView as c,EnabledExtensionsView as Ne,DisabledExtensionsView as Oe,RecommendedExtensionsView as Ae,WorkspaceRecommendedExtensionsView as _e,ServerInstalledExtensionsView as Fe,DefaultRecommendedExtensionsView as Qe,UntrustedWorkspaceUnsupportedExtensionsView as He,UntrustedWorkspacePartiallySupportedExtensionsView as qe,VirtualWorkspaceUnsupportedExtensionsView as $e,VirtualWorkspacePartiallySupportedExtensionsView as Ge,DefaultPopularExtensionsView as ze,DeprecatedExtensionsView as je,SearchMarketplaceExtensionsView as Xe,RecentlyUpdatedExtensionsView as Ye,OutdatedExtensionsView as Je,StaticQueryExtensionsView as O,NONE_CATEGORY as Ze}from"./extensionsViews.js";import{IProgressService as et,ProgressLocation as tt}from"../../../../platform/progress/common/progress.js";import{IEditorGroupsService as nt}from"../../../services/editor/common/editorGroupsService.js";import z from"../../../../base/common/severity.js";import{IActivityService as it,NumberBadge as st,WarningBadge as ot}from"../../../services/activity/common/activity.js";import{IThemeService as rt}from"../../../../platform/theme/common/themeService.js";import{IConfigurationService as j}from"../../../../platform/configuration/common/configuration.js";import{Extensions as at,IViewDescriptorService as X,ViewContainerLocation as ct}from"../../../common/views.js";import{IStorageService as lt,StorageScope as dt,StorageTarget as ht}from"../../../../platform/storage/common/storage.js";import{IWorkspaceContextService as pt}from"../../../../platform/workspace/common/workspace.js";import{IContextKeyService as Y,ContextKeyExpr as i,RawContextKey as m}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as xt}from"../../../../platform/contextview/browser/contextView.js";import{ILogService as ut}from"../../../../platform/log/common/log.js";import{INotificationService as J,NotificationPriority as mt}from"../../../../platform/notification/common/notification.js";import{IHostService as vt}from"../../../services/host/browser/host.js";import{IWorkbenchLayoutService as Et}from"../../../services/layout/browser/layoutService.js";import{ViewPaneContainer as gt}from"../../../browser/parts/views/viewPaneContainer.js";import"../../../browser/parts/views/viewPane.js";import{Query as Z}from"../common/extensionQuery.js";import{SuggestEnabledInput as ft}from"../../codeEditor/browser/suggestEnabledInput/suggestEnabledInput.js";import{alert as T}from"../../../../base/browser/ui/aria/aria.js";import{EXTENSION_CATEGORIES as wt,ExtensionType as St}from"../../../../platform/extensions/common/extensions.js";import{Registry as yt}from"../../../../platform/registry/common/platform.js";import{ILabelService as bt}from"../../../../platform/label/common/label.js";import"../../../common/memento.js";import{SyncDescriptor as l}from"../../../../platform/instantiation/common/descriptors.js";import{IPreferencesService as It}from"../../../services/preferences/common/preferences.js";import{SIDE_BAR_DRAG_AND_DROP_BACKGROUND as Ct}from"../../../common/theme.js";import{IWorkbenchEnvironmentService as Dt}from"../../../services/environment/common/environmentService.js";import{VirtualWorkspaceContext as ee,WorkbenchStateContext as Vt}from"../../../common/contextkeys.js";import{ICommandService as kt}from"../../../../platform/commands/common/commands.js";import{installLocalInRemoteIcon as Kt}from"./extensionsIcons.js";import{registerAction2 as te,Action2 as ne,MenuId as Mt}from"../../../../platform/actions/common/actions.js";import"../../../common/panecomposite.js";import{IPaneCompositePartService as Tt}from"../../../services/panecomposite/browser/panecomposite.js";import{coalesce as Rt}from"../../../../base/common/arrays.js";import{extractEditorsAndFilesDropData as Wt}from"../../../../platform/dnd/browser/dnd.js";import{extname as Lt}from"../../../../base/common/resources.js";import{areSameExtensions as Bt}from"../../../../platform/extensionManagement/common/extensionManagementUtil.js";import"../../../../platform/action/common/action.js";import{registerNavigableContainer as Ut}from"../../../browser/actions/widgetNavigationCommands.js";import{MenuWorkbenchToolBar as Pt}from"../../../../platform/actions/browser/toolbar.js";import{createActionViewItem as Nt}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{SeverityIcon as Ot}from"../../../../platform/severityIcon/browser/severityIcon.js";import{StandardKeyboardEvent as ie}from"../../../../base/browser/keyboardEvent.js";import{KeyCode as R}from"../../../../base/common/keyCodes.js";import{ThemeIcon as At}from"../../../../base/common/themables.js";import{Codicon as _t}from"../../../../base/common/codicons.js";const I=new m("defaultExtensionViews",!0),Ft=new m("extensionsSortByValue",""),Qt=new m("searchMarketplaceExtensions",!1),Ht=new m("extensionSearchHasText",!1),qt=new m("installedExtensions",!1),$t=new m("searchInstalledExtensions",!1),Gt=new m("searchRecentlyUpdatedExtensions",!1),A=new m("searchExtensionUpdates",!1),zt=new m("searchOutdatedExtensions",!1),jt=new m("searchEnabledExtensions",!1),Xt=new m("searchDisabledExtensions",!1),Yt=new m("hasInstalledExtensions",!0),Jt=new m("builtInExtensions",!1),Zt=new m("searchBuiltInExtensions",!1),V=new m("searchUnsupportedWorkspaceExtensions",!1),se=new m("searchDeprecatedExtensions",!1),en=new m("recommendedExtensions",!1),oe=new m("sortByUpdateDate",!1),re=a({key:"remote",comment:["Remote as in remote machine"]},"Remote");let W=class extends F{constructor(e,t,n,s){super();this.extensionManagementServerService=e;this.labelService=t;this.contextKeyService=s;this.container=n.getViewContainerById(D),this.registerViews()}container;registerViews(){const e=[];e.push(...this.createDefaultExtensionsViewDescriptors()),e.push(...this.createSearchExtensionsViewDescriptors()),e.push(...this.createRecommendedExtensionsViewDescriptors()),e.push(...this.createBuiltinExtensionsViewDescriptors()),e.push(...this.createUnsupportedWorkspaceExtensionsViewDescriptors()),e.push(...this.createOtherLocalFilteredExtensionsViewDescriptors()),yt.as(at.ViewsRegistry).registerViews(e,this.container)}createDefaultExtensionsViewDescriptors(){const e=[],t=[];this.extensionManagementServerService.localExtensionManagementServer&&t.push(this.extensionManagementServerService.localExtensionManagementServer),this.extensionManagementServerService.remoteExtensionManagementServer&&t.push(this.extensionManagementServerService.remoteExtensionManagementServer),this.extensionManagementServerService.webExtensionManagementServer&&t.push(this.extensionManagementServerService.webExtensionManagementServer);const n=(r,h)=>t.length>1?`${h.label} - ${r}`:r;let s=b.None;if(this.extensionManagementServerService.webExtensionManagementServer&&this.extensionManagementServerService.remoteExtensionManagementServer){const r=new Set;r.add("hasInstalledWebExtensions"),s=b.filter(this.contextKeyService.onDidChangeContext,h=>h.affectsSome(r))}const d=b.any(this.labelService.onDidChangeFormatters,s);for(const r of t){const h=()=>n(u("installed","Installed"),r),k=b.map(d,()=>h()),y=t.length>1?`workbench.views.extensions.${r.id}.installed`:"workbench.views.extensions.installed";e.push({id:y,get name(){return{value:h(),original:n("Installed",r)}},weight:100,order:1,when:i.and(I),ctorDescriptor:new l(Fe,[{server:r,flexibleHeight:!0,onDidChangeTitle:k}]),canToggleVisibility:t.length===1}),r===this.extensionManagementServerService.remoteExtensionManagementServer&&this.extensionManagementServerService.localExtensionManagementServer&&this._register(te(class extends ne{constructor(){super({id:"workbench.extensions.installLocalExtensions",get title(){return a("select and install local extensions","Install Local Extensions in '{0}'...",r.label)},category:re,icon:Kt,f1:!0,menu:{id:Mt.ViewTitle,when:i.equals("view",y),group:"navigation"}})}run(S){return S.get(N).createInstance(We).run()}}))}return this.extensionManagementServerService.localExtensionManagementServer&&this.extensionManagementServerService.remoteExtensionManagementServer&&this._register(te(class extends ne{constructor(){super({id:"workbench.extensions.actions.installLocalExtensionsInRemote",title:a("install remote in local","Install Remote Extensions Locally..."),category:re,f1:!0})}run(h){return h.get(N).createInstance(Le,"workbench.extensions.actions.installLocalExtensionsInRemote").run()}})),e.push({id:"workbench.views.extensions.popular",name:a("popularExtensions","Popular"),ctorDescriptor:new l(ze,[{hideBadge:!0}]),when:i.and(I,i.not("hasInstalledExtensions"),$),weight:60,order:2,canToggleVisibility:!1}),e.push({id:"extensions.recommendedList",name:a("recommendedExtensions","Recommended"),ctorDescriptor:new l(Qe,[{flexibleHeight:!0}]),when:i.and(I,oe.negate(),i.not("config.extensions.showRecommendationsOnlyOnDemand"),$),weight:40,order:3,canToggleVisibility:!0}),t.length===1&&(e.push({id:"workbench.views.extensions.enabled",name:a("enabledExtensions","Enabled"),ctorDescriptor:new l(Ne,[{}]),when:i.and(I,i.has("hasInstalledExtensions")),hideByDefault:!0,weight:40,order:4,canToggleVisibility:!0}),e.push({id:"workbench.views.extensions.disabled",name:a("disabledExtensions","Disabled"),ctorDescriptor:new l(Oe,[{}]),when:i.and(I,i.has("hasInstalledExtensions")),hideByDefault:!0,weight:10,order:5,canToggleVisibility:!0})),e}createSearchExtensionsViewDescriptors(){const e=[];return e.push({id:"workbench.views.extensions.marketplace",name:a("marketPlace","Marketplace"),ctorDescriptor:new l(Xe,[{}]),when:i.and(i.has("searchMarketplaceExtensions"))}),e.push({id:"workbench.views.extensions.searchInstalled",name:a("installed","Installed"),ctorDescriptor:new l(c,[{}]),when:i.or(i.has("searchInstalledExtensions"),i.has("installedExtensions"))}),e.push({id:"workbench.views.extensions.searchRecentlyUpdated",name:a("recently updated","Recently Updated"),ctorDescriptor:new l(Ye,[{}]),when:i.or(A,i.has("searchRecentlyUpdatedExtensions")),order:2}),e.push({id:"workbench.views.extensions.searchEnabled",name:a("enabled","Enabled"),ctorDescriptor:new l(c,[{}]),when:i.and(i.has("searchEnabledExtensions"))}),e.push({id:"workbench.views.extensions.searchDisabled",name:a("disabled","Disabled"),ctorDescriptor:new l(c,[{}]),when:i.and(i.has("searchDisabledExtensions"))}),e.push({id:Me,name:a("availableUpdates","Available Updates"),ctorDescriptor:new l(Je,[{}]),when:i.or(A,i.has("searchOutdatedExtensions")),order:1}),e.push({id:"workbench.views.extensions.searchBuiltin",name:a("builtin","Builtin"),ctorDescriptor:new l(c,[{}]),when:i.and(i.has("searchBuiltInExtensions"))}),e.push({id:"workbench.views.extensions.searchWorkspaceUnsupported",name:a("workspaceUnsupported","Workspace Unsupported"),ctorDescriptor:new l(c,[{}]),when:i.and(i.has("searchWorkspaceUnsupportedExtensions"))}),e}createRecommendedExtensionsViewDescriptors(){const e=[];return e.push({id:ke,name:a("workspaceRecommendedExtensions","Workspace Recommendations"),ctorDescriptor:new l(_e,[{}]),when:i.and(i.has("recommendedExtensions"),Vt.notEqualsTo("empty")),order:1}),e.push({id:"workbench.views.extensions.otherRecommendations",name:a("otherRecommendedExtensions","Other Recommendations"),ctorDescriptor:new l(Ae,[{}]),when:i.has("recommendedExtensions"),order:2}),e}createBuiltinExtensionsViewDescriptors(){const e=[],t=["themes","programming languages"],n=wt.filter(d=>!t.includes(d.toLowerCase()));n.push(Ze);const s=`${n.map(d=>`category:"${d}"`).join(" ")} ${t.map(d=>`category:"-${d}"`).join(" ")}`;return e.push({id:"workbench.views.extensions.builtinFeatureExtensions",name:a("builtinFeatureExtensions","Features"),ctorDescriptor:new l(O,[{query:`@builtin ${s}`}]),when:i.has("builtInExtensions")}),e.push({id:"workbench.views.extensions.builtinThemeExtensions",name:a("builtInThemesExtensions","Themes"),ctorDescriptor:new l(O,[{query:"@builtin category:themes"}]),when:i.has("builtInExtensions")}),e.push({id:"workbench.views.extensions.builtinProgrammingLanguageExtensions",name:a("builtinProgrammingLanguageExtensions","Programming Languages"),ctorDescriptor:new l(O,[{query:'@builtin category:"programming languages"'}]),when:i.has("builtInExtensions")}),e}createUnsupportedWorkspaceExtensionsViewDescriptors(){const e=[];return e.push({id:"workbench.views.extensions.untrustedUnsupportedExtensions",name:a("untrustedUnsupportedExtensions","Disabled in Restricted Mode"),ctorDescriptor:new l(He,[{}]),when:i.and(V)}),e.push({id:"workbench.views.extensions.untrustedPartiallySupportedExtensions",name:a("untrustedPartiallySupportedExtensions","Limited in Restricted Mode"),ctorDescriptor:new l(qe,[{}]),when:i.and(V)}),e.push({id:"workbench.views.extensions.virtualUnsupportedExtensions",name:a("virtualUnsupportedExtensions","Disabled in Virtual Workspaces"),ctorDescriptor:new l($e,[{}]),when:i.and(ee,V)}),e.push({id:"workbench.views.extensions.virtualPartiallySupportedExtensions",name:a("virtualPartiallySupportedExtensions","Limited in Virtual Workspaces"),ctorDescriptor:new l(Ge,[{}]),when:i.and(ee,V)}),e}createOtherLocalFilteredExtensionsViewDescriptors(){const e=[];return e.push({id:"workbench.views.extensions.deprecatedExtensions",name:a("deprecated","Deprecated"),ctorDescriptor:new l(je,[{}]),when:i.and(se)}),e}};W=C([o(0,G),o(1,bt),o(2,X),o(3,Y)],W);let L=class extends gt{constructor(e,t,n,s,d,r,h,k,y,p,S,f,ae,x,ce,le,de,tn,nn){super(D,{mergeViewWithContainerWhenSingleView:!0},s,S,e,ce,t,le,p,f,ae,de);this.progressService=n;this.editorGroupService=d;this.extensionsWorkbenchService=r;this.extensionManagementServerService=h;this.notificationService=k;this.paneCompositeService=y;this.contextKeyService=x;this.preferencesService=tn;this.commandService=nn;this.searchDelayer=new ue(500),this.defaultViewsContextKey=I.bindTo(x),this.sortByContextKey=Ft.bindTo(x),this.searchMarketplaceExtensionsContextKey=Qt.bindTo(x),this.searchHasTextContextKey=Ht.bindTo(x),this.sortByUpdateDateContextKey=oe.bindTo(x),this.installedExtensionsContextKey=qt.bindTo(x),this.searchInstalledExtensionsContextKey=$t.bindTo(x),this.searchRecentlyUpdatedExtensionsContextKey=Gt.bindTo(x),this.searchExtensionUpdatesContextKey=A.bindTo(x),this.searchWorkspaceUnsupportedExtensionsContextKey=V.bindTo(x),this.searchDeprecatedExtensionsContextKey=se.bindTo(x),this.searchOutdatedExtensionsContextKey=zt.bindTo(x),this.searchEnabledExtensionsContextKey=jt.bindTo(x),this.searchDisabledExtensionsContextKey=Xt.bindTo(x),this.hasInstalledExtensionsContextKey=Yt.bindTo(x),this.builtInExtensionsContextKey=Jt.bindTo(x),this.searchBuiltInExtensionsContextKey=Zt.bindTo(x),this.recommendedExtensionsContextKey=en.bindTo(x),this._register(this.paneCompositeService.onDidPaneCompositeOpen(_=>{_.viewContainerLocation===ct.Sidebar&&this.onViewletOpen(_.composite)},this)),this._register(r.onReset(()=>this.refresh())),this.searchViewletState=this.getMemento(dt.WORKSPACE,ht.MACHINE)}defaultViewsContextKey;sortByContextKey;searchMarketplaceExtensionsContextKey;searchHasTextContextKey;sortByUpdateDateContextKey;installedExtensionsContextKey;searchInstalledExtensionsContextKey;searchRecentlyUpdatedExtensionsContextKey;searchExtensionUpdatesContextKey;searchOutdatedExtensionsContextKey;searchEnabledExtensionsContextKey;searchDisabledExtensionsContextKey;hasInstalledExtensionsContextKey;builtInExtensionsContextKey;searchBuiltInExtensionsContextKey;searchWorkspaceUnsupportedExtensionsContextKey;searchDeprecatedExtensionsContextKey;recommendedExtensionsContextKey;searchDelayer;root;header;searchBox;notificationContainer;searchViewletState;get searchValue(){return this.searchBox?.getValue()}create(e){e.classList.add("extensions-viewlet"),this.root=e;const t=E(this.root,g(".overlay")),n=this.getColor(Ct)??"";t.style.backgroundColor=n,P(t),this.header=E(this.root,g(".header"));const s=u("searchExtensions","Search Extensions in Marketplace"),d=this.searchViewletState["query.value"]?this.searchViewletState["query.value"]:"",r=E(this.header,g(".extensions-search-container"));this.searchBox=this._register(this.instantiationService.createInstance(ft,`${D}.searchbox`,r,{triggerCharacters:["@"],sortKey:p=>p.indexOf(":")===-1?"a":/ext:/.test(p)||/id:/.test(p)||/tag:/.test(p)?"b":/sort:/.test(p)?"c":"d",provideResults:p=>Z.suggestions(p)},s,"extensions:searchinput",{placeholderText:s,value:d})),this.notificationContainer=E(this.header,g(".notification-container.hidden",{tabindex:"0"})),this.renderNotificaiton(),this._register(this.extensionsWorkbenchService.onDidChangeExtensionsNotification(()=>this.renderNotificaiton())),this.updateInstalledExtensionsContexts(),this.searchBox.getValue()&&this.triggerSearch(),this._register(this.searchBox.onInputDidChange(()=>{this.sortByContextKey.set(Z.parse(this.searchBox?.getValue()??"").sortBy),this.triggerSearch()},this)),this._register(this.searchBox.onShouldFocusResults(()=>this.focusListView(),this));const h=E(r,g(".extensions-search-actions-container"));this._register(this.instantiationService.createInstance(Pt,h,Te,{toolbarOptions:{primaryGroup:()=>!0},actionViewItemProvider:(p,S)=>Nt(this.instantiationService,p,S)})),this._register(new Se(this.root,{onDragEnter:p=>{this.isSupportedDragElement(p)&&we(t)},onDragLeave:p=>{this.isSupportedDragElement(p)&&P(t)},onDragOver:p=>{this.isSupportedDragElement(p)&&(p.dataTransfer.dropEffect="copy")},onDrop:async p=>{if(this.isSupportedDragElement(p)){P(t);const S=Rt((await this.instantiationService.invokeFunction(f=>Wt(f,p))).map(f=>f.resource&&Lt(f.resource)===".vsix"?f.resource:void 0));if(S.length>0)try{await this.commandService.executeCommand(Ve,S)}catch(f){this.notificationService.error(f)}}}})),super.create(E(this.root,g(".extensions")));const k=this._register(ye(this.root)),y=()=>this.searchBox?.inputWidget.hasWidgetFocus();this._register(Ut({name:"extensionsView",focusNotifiers:[k],focusNextWidget:()=>{y()&&this.focusListView()},focusPreviousWidget:()=>{y()||this.searchBox?.focus()}}))}focus(){super.focus(),this.searchBox?.focus()}_dimension;layout(e){this._dimension=e,this.root&&(this.root.classList.toggle("narrow",e.width<=250),this.root.classList.toggle("mini",e.width<=200)),this.searchBox?.layout(new H(e.width-34-8-24*2,20));const t=41,n=this.header&&this.notificationContainer?.childNodes.length?this.notificationContainer.clientHeight+t+10:t;this.header.style.height=`${n}px`,super.layout(new H(e.width,e.height-n))}getOptimalWidth(){return 400}search(e){this.searchBox&&this.searchBox.getValue()!==e&&this.searchBox.setValue(e)}async refresh(){await this.updateInstalledExtensionsContexts(),this.doSearch(!0),this.configurationService.getValue(Ke)&&this.extensionsWorkbenchService.checkForUpdates()}notificationDisposables=this._register(new Q);renderNotificaiton(){if(!this.notificationContainer)return;be(this.notificationContainer),this.notificationDisposables.value=new ge;const e=this.extensionsWorkbenchService.getExtensionsNotification(),t=e?.extensions.map(n=>`@id:${n.identifier.id}`).join(" ");if(e&&(t===this.searchBox?.getValue()||!this.searchMarketplaceExtensionsContextKey.get())){this.notificationContainer.setAttribute("aria-label",e.message),this.notificationContainer.classList.remove("hidden");const n=E(this.notificationContainer,g(".message-container"));E(n,g("span")).className=Ot.className(e.severity),E(n,g("span.message",void 0,e.message));const s=E(n,g("span.message-text-action",{tabindex:"0",role:"button","aria-label":`${e.message}. ${u("click show","Click to Show")}`},u("show","Show")));this.notificationDisposables.value.add(K(s,M.CLICK,()=>this.search(t??""))),this.notificationDisposables.value.add(K(s,M.KEY_DOWN,r=>{const h=new ie(r);(h.keyCode===R.Enter||h.keyCode===R.Space)&&this.search(t??""),h.stopPropagation()}));const d=E(this.notificationContainer,g(`span.message-action${At.asCSSSelector(_t.close)}`,{tabindex:"0",role:"button","aria-label":u("dismiss","Dismiss"),title:u("dismiss","Dismiss")}));this.notificationDisposables.value.add(K(d,M.CLICK,()=>e.dismiss())),this.notificationDisposables.value.add(K(d,M.KEY_DOWN,r=>{const h=new ie(r);(h.keyCode===R.Enter||h.keyCode===R.Space)&&e.dismiss(),h.stopPropagation()}))}else this.notificationContainer.removeAttribute("aria-label"),this.notificationContainer.classList.add("hidden");this._dimension&&this.layout(this._dimension)}async updateInstalledExtensionsContexts(){const e=await this.extensionsWorkbenchService.queryLocal();this.hasInstalledExtensionsContextKey.set(e.some(t=>!t.isBuiltin))}triggerSearch(){this.searchDelayer.trigger(()=>this.doSearch(),this.searchBox&&this.searchBox.getValue()?500:0).then(void 0,e=>this.onError(e))}normalizedQuery(){return this.searchBox?this.searchBox.getValue().trim().replace(/@category/g,"category").replace(/@tag:/g,"tag:").replace(/@ext:/g,"ext:").replace(/@featured/g,"featured").replace(/@popular/g,this.extensionManagementServerService.webExtensionManagementServer&&!this.extensionManagementServerService.localExtensionManagementServer&&!this.extensionManagementServerService.remoteExtensionManagementServer?"@web":"@popular"):""}saveState(){const e=this.searchBox?this.searchBox.getValue():"";c.isLocalExtensionsQuery(e)?this.searchViewletState["query.value"]=e:this.searchViewletState["query.value"]="",super.saveState()}doSearch(e){const t=this.normalizedQuery();return this.contextKeyService.bufferChangeEvents(()=>{const n=c.isRecommendedExtensionsQuery(t);this.searchHasTextContextKey.set(t.trim()!==""),this.installedExtensionsContextKey.set(c.isInstalledExtensionsQuery(t)),this.searchInstalledExtensionsContextKey.set(c.isSearchInstalledExtensionsQuery(t)),this.searchRecentlyUpdatedExtensionsContextKey.set(c.isSearchRecentlyUpdatedQuery(t)&&!c.isSearchExtensionUpdatesQuery(t)),this.searchOutdatedExtensionsContextKey.set(c.isOutdatedExtensionsQuery(t)&&!c.isSearchExtensionUpdatesQuery(t)),this.searchExtensionUpdatesContextKey.set(c.isSearchExtensionUpdatesQuery(t)),this.searchEnabledExtensionsContextKey.set(c.isEnabledExtensionsQuery(t)),this.searchDisabledExtensionsContextKey.set(c.isDisabledExtensionsQuery(t)),this.searchBuiltInExtensionsContextKey.set(c.isSearchBuiltInExtensionsQuery(t)),this.searchWorkspaceUnsupportedExtensionsContextKey.set(c.isSearchWorkspaceUnsupportedExtensionsQuery(t)),this.searchDeprecatedExtensionsContextKey.set(c.isSearchDeprecatedExtensionsQuery(t)),this.builtInExtensionsContextKey.set(c.isBuiltInExtensionsQuery(t)),this.recommendedExtensionsContextKey.set(n),this.searchMarketplaceExtensionsContextKey.set(!!t&&!c.isLocalExtensionsQuery(t)&&!n),this.sortByUpdateDateContextKey.set(c.isSortUpdateDateQuery(t)),this.defaultViewsContextKey.set(!t||c.isSortInstalledExtensionsQuery(t))}),this.renderNotificaiton(),this.progress(Promise.all(this.panes.map(n=>n.show(this.normalizedQuery(),e).then(s=>this.alertSearchResult(s.length,n.id))))).then(()=>{})}onDidAddViewDescriptors(e){const t=super.onDidAddViewDescriptors(e);return this.progress(Promise.all(t.map(n=>n.show(this.normalizedQuery()).then(s=>this.alertSearchResult(s.length,n.id))))),t}alertSearchResult(e,t){const n=this.viewContainerModel.visibleViewDescriptors.find(s=>s.id===t);switch(e){case 0:break;case 1:n?T(u("extensionFoundInSection","1 extension found in the {0} section.",n.name.value)):T(u("extensionFound","1 extension found."));break;default:n?T(u("extensionsFoundInSection","{0} extensions found in the {1} section.",e,n.name.value)):T(u("extensionsFound","{0} extensions found.",e));break}}getFirstExpandedPane(){for(const e of this.panes)if(e.isExpanded()&&e instanceof c)return e}focusListView(){const e=this.getFirstExpandedPane();e&&e.count()>0&&e.focus()}onViewletOpen(e){if(!(!e||e.getId()===D)&&this.configurationService.getValue(De)){const t=this.editorGroupService.groups.map(n=>{const s=n.editors.filter(d=>d instanceof Pe);return n.closeEditors(s)});Promise.all(t)}}progress(e){return this.progressService.withProgress({location:tt.Extensions},()=>e)}onError(e){if(ve(e))return;const t=e&&e.message||"";if(/ECONNREFUSED/.test(t)){const n=Ee(u("suggestProxyError","Marketplace returned 'ECONNREFUSED'. Please check the 'http.proxy' setting."),[new fe("open user settings",u("open user settings","Open User Settings"),void 0,!0,()=>this.preferencesService.openUserSettings())]);this.notificationService.error(n);return}this.notificationService.error(e)}isSupportedDragElement(e){return e.dataTransfer?e.dataTransfer.types.map(n=>n.toLocaleLowerCase()).indexOf("files")!==-1:!1}};L=C([o(0,Et),o(1,Ie),o(2,et),o(3,N),o(4,nt),o(5,q),o(6,G),o(7,J),o(8,Tt),o(9,rt),o(10,j),o(11,lt),o(12,pt),o(13,Y),o(14,xt),o(15,Ce),o(16,X),o(17,It),o(18,kt)],L);let B=class extends F{constructor(e,t,n,s){super();this.activityService=e;this.extensionsWorkbenchService=t;this.extensionEnablementService=n;this.configurationService=s;this.onServiceChange(),this._register(b.any(b.debounce(t.onChange,()=>{},100,void 0,void 0,void 0,this._store),t.onDidChangeExtensionsNotification)(this.onServiceChange,this))}badgeHandle=this._register(new Q);onServiceChange(){this.badgeHandle.clear();let e;const t=this.extensionsWorkbenchService.getExtensionsNotification();if(t)t.severity===z.Warning&&(e=new ot(()=>t.message));else{const n=this.configurationService.getValue(Re)===!0?[]:this.extensionsWorkbenchService.installed.filter(r=>r.runtimeState!==void 0),s=this.extensionsWorkbenchService.outdated.reduce((r,h)=>r+(this.extensionEnablementService.isEnabled(h.local)&&!n.includes(h)?1:0),0),d=s+n.length;if(d>0){let r="";s&&(r+=s===1?u("extensionToUpdate","{0} requires update",s):u("extensionsToUpdate","{0} require update",s)),s>0&&n.length>0&&(r+=", "),n.length&&(r+=n.length===1?u("extensionToReload","{0} requires restart",n.length):u("extensionsToReload","{0} require restart",n.length)),e=new st(d,()=>r)}}e&&(this.badgeHandle.value=this.activityService.showViewContainerActivity(D,{badge:e}))}};B=C([o(0,it),o(1,q),o(2,Ue),o(3,j)],B);let U=class{constructor(v,e,t,n,s){this.extensionsManagementService=v;this.hostService=e;this.logService=t;this.notificationService=n;this.environmentService=s;this.environmentService.disableExtensions||this.loopCheckForMaliciousExtensions()}loopCheckForMaliciousExtensions(){this.checkForMaliciousExtensions().then(()=>xe(1e3*60*5)).then(()=>this.loopCheckForMaliciousExtensions())}checkForMaliciousExtensions(){return this.extensionsManagementService.getExtensionsControlManifest().then(v=>this.extensionsManagementService.getInstalled(St.User).then(e=>{const t=e.filter(n=>v.malicious.some(s=>Bt(n.identifier,s)));return t.length?me.settled(t.map(n=>this.extensionsManagementService.uninstall(n).then(()=>{this.notificationService.prompt(z.Warning,u("malicious warning","We have uninstalled '{0}' which was reported to be problematic.",n.identifier.id),[{label:u("reloadNow","Reload Now"),run:()=>this.hostService.reload()}],{sticky:!0,priority:mt.URGENT})}))):Promise.resolve(void 0)}).then(()=>{}),v=>this.logService.error(v))}};U=C([o(0,Be),o(1,vt),o(2,ut),o(3,J),o(4,Dt)],U);export{Jt as BuiltInExtensionsContext,I as DefaultViewsContext,Ft as ExtensionsSortByContext,L as ExtensionsViewPaneContainer,W as ExtensionsViewletViewsContribution,U as MaliciousExtensionChecker,en as RecommendedExtensionsContext,Ht as SearchHasTextContext,Qt as SearchMarketplaceExtensionsContext,B as StatusUpdater};
