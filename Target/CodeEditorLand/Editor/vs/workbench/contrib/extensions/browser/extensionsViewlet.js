var he=Object.defineProperty;var de=Object.getOwnPropertyDescriptor;var C=(w,m,e,t)=>{for(var n=t>1?void 0:t?de(m,e):m,s=w.length-1,l;s>=0;s--)(l=w[s])&&(n=(t?l(m,e,n):l(n))||n);return t&&n&&he(m,e,n),n},o=(w,m)=>(e,t)=>m(e,t,w);import"./media/extensionsViewlet.css";import{localize as u,localize2 as a}from"../../../../nls.js";import{timeout as pe,Delayer as xe,Promises as ue}from"../../../../base/common/async.js";import{isCancellationError as me}from"../../../../base/common/errors.js";import{createErrorWithActions as ve}from"../../../../base/common/errorMessage.js";import"../../../common/contributions.js";import{Disposable as O,DisposableStore as Ee,MutableDisposable as A}from"../../../../base/common/lifecycle.js";import{Event as b}from"../../../../base/common/event.js";import{Action as ge}from"../../../../base/common/actions.js";import{append as E,$ as g,Dimension as _,hide as L,show as fe,DragAndDropObserver as we,trackFocus as Se,addDisposableListener as F,EventType as Q,clearNode as ye}from"../../../../base/browser/dom.js";import{ITelemetryService as be}from"../../../../platform/telemetry/common/telemetry.js";import{IInstantiationService as B}from"../../../../platform/instantiation/common/instantiation.js";import{IExtensionService as Ie}from"../../../services/extensions/common/extensions.js";import{IExtensionsWorkbenchService as H,VIEWLET_ID as D,CloseExtensionDetailsOnViewChangeKey as Ce,INSTALL_EXTENSION_FROM_VSIX_COMMAND_ID as De,WORKSPACE_RECOMMENDATIONS_VIEW_ID as Ve,AutoCheckUpdatesConfigurationKey as ke,OUTDATED_EXTENSIONS_VIEW_ID as Me,CONTEXT_HAS_GALLERY as q,extensionsSearchActionsMenu as Ke,AutoRestartConfigurationKey as Te}from"../common/extensions.js";import{InstallLocalExtensionsInRemoteAction as Re,InstallRemoteExtensionsInLocalAction as We}from"./extensionsActions.js";import{IExtensionManagementService as Le}from"../../../../platform/extensionManagement/common/extensionManagement.js";import{IWorkbenchExtensionEnablementService as Be,IExtensionManagementServerService as $}from"../../../services/extensionManagement/common/extensionManagement.js";import{ExtensionsInput as Ue}from"../common/extensionsInput.js";import{ExtensionsListView as c,EnabledExtensionsView as Pe,DisabledExtensionsView as Ne,RecommendedExtensionsView as Oe,WorkspaceRecommendedExtensionsView as Ae,ServerInstalledExtensionsView as _e,DefaultRecommendedExtensionsView as Fe,UntrustedWorkspaceUnsupportedExtensionsView as Qe,UntrustedWorkspacePartiallySupportedExtensionsView as He,VirtualWorkspaceUnsupportedExtensionsView as qe,VirtualWorkspacePartiallySupportedExtensionsView as $e,DefaultPopularExtensionsView as Ge,DeprecatedExtensionsView as ze,SearchMarketplaceExtensionsView as je,RecentlyUpdatedExtensionsView as Xe,OutdatedExtensionsView as Ye,StaticQueryExtensionsView as U,NONE_CATEGORY as Je}from"./extensionsViews.js";import{IProgressService as Ze,ProgressLocation as et}from"../../../../platform/progress/common/progress.js";import{IEditorGroupsService as tt}from"../../../services/editor/common/editorGroupsService.js";import G from"../../../../base/common/severity.js";import{IActivityService as nt,NumberBadge as it,WarningBadge as st}from"../../../services/activity/common/activity.js";import{IThemeService as ot}from"../../../../platform/theme/common/themeService.js";import{IConfigurationService as z}from"../../../../platform/configuration/common/configuration.js";import{Extensions as rt,IViewDescriptorService as j,ViewContainerLocation as at}from"../../../common/views.js";import{IStorageService as ct,StorageScope as lt,StorageTarget as ht}from"../../../../platform/storage/common/storage.js";import{IWorkspaceContextService as dt}from"../../../../platform/workspace/common/workspace.js";import{IContextKeyService as X,ContextKeyExpr as i,RawContextKey as x}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as pt}from"../../../../platform/contextview/browser/contextView.js";import{ILogService as xt}from"../../../../platform/log/common/log.js";import{INotificationService as Y,NotificationPriority as ut}from"../../../../platform/notification/common/notification.js";import{IHostService as mt}from"../../../services/host/browser/host.js";import{IWorkbenchLayoutService as vt}from"../../../services/layout/browser/layoutService.js";import{ViewPaneContainer as Et}from"../../../browser/parts/views/viewPaneContainer.js";import"../../../browser/parts/views/viewPane.js";import{Query as J}from"../common/extensionQuery.js";import{SuggestEnabledInput as gt}from"../../codeEditor/browser/suggestEnabledInput/suggestEnabledInput.js";import{alert as M}from"../../../../base/browser/ui/aria/aria.js";import{EXTENSION_CATEGORIES as ft,ExtensionType as wt}from"../../../../platform/extensions/common/extensions.js";import{Registry as St}from"../../../../platform/registry/common/platform.js";import{ILabelService as yt}from"../../../../platform/label/common/label.js";import"../../../common/memento.js";import{SyncDescriptor as h}from"../../../../platform/instantiation/common/descriptors.js";import{IPreferencesService as bt}from"../../../services/preferences/common/preferences.js";import{SIDE_BAR_DRAG_AND_DROP_BACKGROUND as It}from"../../../common/theme.js";import{IWorkbenchEnvironmentService as Ct}from"../../../services/environment/common/environmentService.js";import{VirtualWorkspaceContext as Z,WorkbenchStateContext as Dt}from"../../../common/contextkeys.js";import{ICommandService as Vt}from"../../../../platform/commands/common/commands.js";import{installLocalInRemoteIcon as kt}from"./extensionsIcons.js";import{registerAction2 as ee,Action2 as te,MenuId as Mt}from"../../../../platform/actions/common/actions.js";import"../../../common/panecomposite.js";import{IPaneCompositePartService as Kt}from"../../../services/panecomposite/browser/panecomposite.js";import{coalesce as Tt}from"../../../../base/common/arrays.js";import{extractEditorsAndFilesDropData as Rt}from"../../../../platform/dnd/browser/dnd.js";import{extname as Wt}from"../../../../base/common/resources.js";import{areSameExtensions as Lt}from"../../../../platform/extensionManagement/common/extensionManagementUtil.js";import"../../../../platform/action/common/action.js";import{registerNavigableContainer as Bt}from"../../../browser/actions/widgetNavigationCommands.js";import{MenuWorkbenchToolBar as Ut}from"../../../../platform/actions/browser/toolbar.js";import{createActionViewItem as Pt}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{SeverityIcon as Nt}from"../../../../platform/severityIcon/browser/severityIcon.js";import{StandardKeyboardEvent as Ot}from"../../../../base/browser/keyboardEvent.js";import{KeyCode as ne}from"../../../../base/common/keyCodes.js";const I=new x("defaultExtensionViews",!0),At=new x("extensionsSortByValue",""),_t=new x("searchMarketplaceExtensions",!1),Ft=new x("extensionSearchHasText",!1),Qt=new x("installedExtensions",!1),Ht=new x("searchInstalledExtensions",!1),qt=new x("searchRecentlyUpdatedExtensions",!1),P=new x("searchExtensionUpdates",!1),$t=new x("searchOutdatedExtensions",!1),Gt=new x("searchEnabledExtensions",!1),zt=new x("searchDisabledExtensions",!1),jt=new x("hasInstalledExtensions",!0),Xt=new x("builtInExtensions",!1),Yt=new x("searchBuiltInExtensions",!1),V=new x("searchUnsupportedWorkspaceExtensions",!1),ie=new x("searchDeprecatedExtensions",!1),Jt=new x("recommendedExtensions",!1),se=new x("sortByUpdateDate",!1),oe=a({key:"remote",comment:["Remote as in remote machine"]},"Remote");let K=class extends O{constructor(e,t,n,s){super();this.extensionManagementServerService=e;this.labelService=t;this.contextKeyService=s;this.container=n.getViewContainerById(D),this.registerViews()}container;registerViews(){const e=[];e.push(...this.createDefaultExtensionsViewDescriptors()),e.push(...this.createSearchExtensionsViewDescriptors()),e.push(...this.createRecommendedExtensionsViewDescriptors()),e.push(...this.createBuiltinExtensionsViewDescriptors()),e.push(...this.createUnsupportedWorkspaceExtensionsViewDescriptors()),e.push(...this.createOtherLocalFilteredExtensionsViewDescriptors()),St.as(rt.ViewsRegistry).registerViews(e,this.container)}createDefaultExtensionsViewDescriptors(){const e=[],t=[];this.extensionManagementServerService.localExtensionManagementServer&&t.push(this.extensionManagementServerService.localExtensionManagementServer),this.extensionManagementServerService.remoteExtensionManagementServer&&t.push(this.extensionManagementServerService.remoteExtensionManagementServer),this.extensionManagementServerService.webExtensionManagementServer&&t.push(this.extensionManagementServerService.webExtensionManagementServer);const n=(r,v)=>t.length>1?`${v.label} - ${r}`:r;let s=b.None;if(this.extensionManagementServerService.webExtensionManagementServer&&this.extensionManagementServerService.remoteExtensionManagementServer){const r=new Set;r.add("hasInstalledWebExtensions"),s=b.filter(this.contextKeyService.onDidChangeContext,v=>v.affectsSome(r))}const l=b.any(this.labelService.onDidChangeFormatters,s);for(const r of t){const v=()=>n(u("installed","Installed"),r),k=b.map(l,()=>v()),y=t.length>1?`workbench.views.extensions.${r.id}.installed`:"workbench.views.extensions.installed";e.push({id:y,get name(){return{value:v(),original:n("Installed",r)}},weight:100,order:1,when:i.and(I),ctorDescriptor:new h(_e,[{server:r,flexibleHeight:!0,onDidChangeTitle:k}]),canToggleVisibility:t.length===1}),r===this.extensionManagementServerService.remoteExtensionManagementServer&&this.extensionManagementServerService.localExtensionManagementServer&&this._register(ee(class extends te{constructor(){super({id:"workbench.extensions.installLocalExtensions",get title(){return a("select and install local extensions","Install Local Extensions in '{0}'...",r.label)},category:oe,icon:kt,f1:!0,menu:{id:Mt.ViewTitle,when:i.equals("view",y),group:"navigation"}})}run(S){return S.get(B).createInstance(Re).run()}}))}return this.extensionManagementServerService.localExtensionManagementServer&&this.extensionManagementServerService.remoteExtensionManagementServer&&this._register(ee(class extends te{constructor(){super({id:"workbench.extensions.actions.installLocalExtensionsInRemote",title:a("install remote in local","Install Remote Extensions Locally..."),category:oe,f1:!0})}run(v){return v.get(B).createInstance(We,"workbench.extensions.actions.installLocalExtensionsInRemote").run()}})),e.push({id:"workbench.views.extensions.popular",name:a("popularExtensions","Popular"),ctorDescriptor:new h(Ge,[{hideBadge:!0}]),when:i.and(I,i.not("hasInstalledExtensions"),q),weight:60,order:2,canToggleVisibility:!1}),e.push({id:"extensions.recommendedList",name:a("recommendedExtensions","Recommended"),ctorDescriptor:new h(Fe,[{flexibleHeight:!0}]),when:i.and(I,se.negate(),i.not("config.extensions.showRecommendationsOnlyOnDemand"),q),weight:40,order:3,canToggleVisibility:!0}),t.length===1&&(e.push({id:"workbench.views.extensions.enabled",name:a("enabledExtensions","Enabled"),ctorDescriptor:new h(Pe,[{}]),when:i.and(I,i.has("hasInstalledExtensions")),hideByDefault:!0,weight:40,order:4,canToggleVisibility:!0}),e.push({id:"workbench.views.extensions.disabled",name:a("disabledExtensions","Disabled"),ctorDescriptor:new h(Ne,[{}]),when:i.and(I,i.has("hasInstalledExtensions")),hideByDefault:!0,weight:10,order:5,canToggleVisibility:!0})),e}createSearchExtensionsViewDescriptors(){const e=[];return e.push({id:"workbench.views.extensions.marketplace",name:a("marketPlace","Marketplace"),ctorDescriptor:new h(je,[{}]),when:i.and(i.has("searchMarketplaceExtensions"))}),e.push({id:"workbench.views.extensions.searchInstalled",name:a("installed","Installed"),ctorDescriptor:new h(c,[{}]),when:i.or(i.has("searchInstalledExtensions"),i.has("installedExtensions"))}),e.push({id:"workbench.views.extensions.searchRecentlyUpdated",name:a("recently updated","Recently Updated"),ctorDescriptor:new h(Xe,[{}]),when:i.or(P,i.has("searchRecentlyUpdatedExtensions")),order:2}),e.push({id:"workbench.views.extensions.searchEnabled",name:a("enabled","Enabled"),ctorDescriptor:new h(c,[{}]),when:i.and(i.has("searchEnabledExtensions"))}),e.push({id:"workbench.views.extensions.searchDisabled",name:a("disabled","Disabled"),ctorDescriptor:new h(c,[{}]),when:i.and(i.has("searchDisabledExtensions"))}),e.push({id:Me,name:a("availableUpdates","Available Updates"),ctorDescriptor:new h(Ye,[{}]),when:i.or(P,i.has("searchOutdatedExtensions")),order:1}),e.push({id:"workbench.views.extensions.searchBuiltin",name:a("builtin","Builtin"),ctorDescriptor:new h(c,[{}]),when:i.and(i.has("searchBuiltInExtensions"))}),e.push({id:"workbench.views.extensions.searchWorkspaceUnsupported",name:a("workspaceUnsupported","Workspace Unsupported"),ctorDescriptor:new h(c,[{}]),when:i.and(i.has("searchWorkspaceUnsupportedExtensions"))}),e}createRecommendedExtensionsViewDescriptors(){const e=[];return e.push({id:Ve,name:a("workspaceRecommendedExtensions","Workspace Recommendations"),ctorDescriptor:new h(Ae,[{}]),when:i.and(i.has("recommendedExtensions"),Dt.notEqualsTo("empty")),order:1}),e.push({id:"workbench.views.extensions.otherRecommendations",name:a("otherRecommendedExtensions","Other Recommendations"),ctorDescriptor:new h(Oe,[{}]),when:i.has("recommendedExtensions"),order:2}),e}createBuiltinExtensionsViewDescriptors(){const e=[],t=["themes","programming languages"],n=ft.filter(l=>!t.includes(l.toLowerCase()));n.push(Je);const s=`${n.map(l=>`category:"${l}"`).join(" ")} ${t.map(l=>`category:"-${l}"`).join(" ")}`;return e.push({id:"workbench.views.extensions.builtinFeatureExtensions",name:a("builtinFeatureExtensions","Features"),ctorDescriptor:new h(U,[{query:`@builtin ${s}`}]),when:i.has("builtInExtensions")}),e.push({id:"workbench.views.extensions.builtinThemeExtensions",name:a("builtInThemesExtensions","Themes"),ctorDescriptor:new h(U,[{query:"@builtin category:themes"}]),when:i.has("builtInExtensions")}),e.push({id:"workbench.views.extensions.builtinProgrammingLanguageExtensions",name:a("builtinProgrammingLanguageExtensions","Programming Languages"),ctorDescriptor:new h(U,[{query:'@builtin category:"programming languages"'}]),when:i.has("builtInExtensions")}),e}createUnsupportedWorkspaceExtensionsViewDescriptors(){const e=[];return e.push({id:"workbench.views.extensions.untrustedUnsupportedExtensions",name:a("untrustedUnsupportedExtensions","Disabled in Restricted Mode"),ctorDescriptor:new h(Qe,[{}]),when:i.and(V)}),e.push({id:"workbench.views.extensions.untrustedPartiallySupportedExtensions",name:a("untrustedPartiallySupportedExtensions","Limited in Restricted Mode"),ctorDescriptor:new h(He,[{}]),when:i.and(V)}),e.push({id:"workbench.views.extensions.virtualUnsupportedExtensions",name:a("virtualUnsupportedExtensions","Disabled in Virtual Workspaces"),ctorDescriptor:new h(qe,[{}]),when:i.and(Z,V)}),e.push({id:"workbench.views.extensions.virtualPartiallySupportedExtensions",name:a("virtualPartiallySupportedExtensions","Limited in Virtual Workspaces"),ctorDescriptor:new h($e,[{}]),when:i.and(Z,V)}),e}createOtherLocalFilteredExtensionsViewDescriptors(){const e=[];return e.push({id:"workbench.views.extensions.deprecatedExtensions",name:a("deprecated","Deprecated"),ctorDescriptor:new h(ze,[{}]),when:i.and(ie)}),e}};K=C([o(0,$),o(1,yt),o(2,j),o(3,X)],K);let T=class extends Et{constructor(e,t,n,s,l,r,v,k,y,d,S,f,re,p,ae,ce,le,Zt,en){super(D,{mergeViewWithContainerWhenSingleView:!0},s,S,e,ae,t,ce,d,f,re,le);this.progressService=n;this.editorGroupService=l;this.extensionsWorkbenchService=r;this.extensionManagementServerService=v;this.notificationService=k;this.paneCompositeService=y;this.contextKeyService=p;this.preferencesService=Zt;this.commandService=en;this.searchDelayer=new xe(500),this.defaultViewsContextKey=I.bindTo(p),this.sortByContextKey=At.bindTo(p),this.searchMarketplaceExtensionsContextKey=_t.bindTo(p),this.searchHasTextContextKey=Ft.bindTo(p),this.sortByUpdateDateContextKey=se.bindTo(p),this.installedExtensionsContextKey=Qt.bindTo(p),this.searchInstalledExtensionsContextKey=Ht.bindTo(p),this.searchRecentlyUpdatedExtensionsContextKey=qt.bindTo(p),this.searchExtensionUpdatesContextKey=P.bindTo(p),this.searchWorkspaceUnsupportedExtensionsContextKey=V.bindTo(p),this.searchDeprecatedExtensionsContextKey=ie.bindTo(p),this.searchOutdatedExtensionsContextKey=$t.bindTo(p),this.searchEnabledExtensionsContextKey=Gt.bindTo(p),this.searchDisabledExtensionsContextKey=zt.bindTo(p),this.hasInstalledExtensionsContextKey=jt.bindTo(p),this.builtInExtensionsContextKey=Xt.bindTo(p),this.searchBuiltInExtensionsContextKey=Yt.bindTo(p),this.recommendedExtensionsContextKey=Jt.bindTo(p),this._register(this.paneCompositeService.onDidPaneCompositeOpen(N=>{N.viewContainerLocation===at.Sidebar&&this.onViewletOpen(N.composite)},this)),this._register(r.onReset(()=>this.refresh())),this.searchViewletState=this.getMemento(lt.WORKSPACE,ht.MACHINE)}defaultViewsContextKey;sortByContextKey;searchMarketplaceExtensionsContextKey;searchHasTextContextKey;sortByUpdateDateContextKey;installedExtensionsContextKey;searchInstalledExtensionsContextKey;searchRecentlyUpdatedExtensionsContextKey;searchExtensionUpdatesContextKey;searchOutdatedExtensionsContextKey;searchEnabledExtensionsContextKey;searchDisabledExtensionsContextKey;hasInstalledExtensionsContextKey;builtInExtensionsContextKey;searchBuiltInExtensionsContextKey;searchWorkspaceUnsupportedExtensionsContextKey;searchDeprecatedExtensionsContextKey;recommendedExtensionsContextKey;searchDelayer;root;header;searchBox;notificationContainer;searchViewletState;get searchValue(){return this.searchBox?.getValue()}create(e){e.classList.add("extensions-viewlet"),this.root=e;const t=E(this.root,g(".overlay")),n=this.getColor(It)??"";t.style.backgroundColor=n,L(t),this.header=E(this.root,g(".header"));const s=u("searchExtensions","Search Extensions in Marketplace"),l=this.searchViewletState["query.value"]?this.searchViewletState["query.value"]:"",r=E(this.header,g(".extensions-search-container"));this.searchBox=this._register(this.instantiationService.createInstance(gt,`${D}.searchbox`,r,{triggerCharacters:["@"],sortKey:d=>d.indexOf(":")===-1?"a":/ext:/.test(d)||/id:/.test(d)||/tag:/.test(d)?"b":/sort:/.test(d)?"c":"d",provideResults:d=>J.suggestions(d)},s,"extensions:searchinput",{placeholderText:s,value:l})),this.notificationContainer=E(this.header,g(".notification-container.hidden",{tabindex:"0"})),this.renderNotificaiton(),this._register(this.extensionsWorkbenchService.onDidChangeExtensionsNotification(()=>this.renderNotificaiton())),this.updateInstalledExtensionsContexts(),this.searchBox.getValue()&&this.triggerSearch(),this._register(this.searchBox.onInputDidChange(()=>{this.sortByContextKey.set(J.parse(this.searchBox?.getValue()??"").sortBy),this.triggerSearch()},this)),this._register(this.searchBox.onShouldFocusResults(()=>this.focusListView(),this));const v=E(r,g(".extensions-search-actions-container"));this._register(this.instantiationService.createInstance(Ut,v,Ke,{toolbarOptions:{primaryGroup:()=>!0},actionViewItemProvider:(d,S)=>Pt(this.instantiationService,d,S)})),this._register(new we(this.root,{onDragEnter:d=>{this.isSupportedDragElement(d)&&fe(t)},onDragLeave:d=>{this.isSupportedDragElement(d)&&L(t)},onDragOver:d=>{this.isSupportedDragElement(d)&&(d.dataTransfer.dropEffect="copy")},onDrop:async d=>{if(this.isSupportedDragElement(d)){L(t);const S=Tt((await this.instantiationService.invokeFunction(f=>Rt(f,d))).map(f=>f.resource&&Wt(f.resource)===".vsix"?f.resource:void 0));if(S.length>0)try{await this.commandService.executeCommand(De,S)}catch(f){this.notificationService.error(f)}}}})),super.create(E(this.root,g(".extensions")));const k=this._register(Se(this.root)),y=()=>this.searchBox?.inputWidget.hasWidgetFocus();this._register(Bt({name:"extensionsView",focusNotifiers:[k],focusNextWidget:()=>{y()&&this.focusListView()},focusPreviousWidget:()=>{y()||this.searchBox?.focus()}}))}focus(){super.focus(),this.searchBox?.focus()}_dimension;layout(e){this._dimension=e,this.root&&(this.root.classList.toggle("narrow",e.width<=250),this.root.classList.toggle("mini",e.width<=200)),this.searchBox?.layout(new _(e.width-34-8-24*2,20));const t=41,n=this.header&&this.notificationContainer?.childNodes.length?this.notificationContainer.clientHeight+t+10:t;this.header.style.height=`${n}px`,super.layout(new _(e.width,e.height-n))}getOptimalWidth(){return 400}search(e){this.searchBox&&this.searchBox.getValue()!==e&&this.searchBox.setValue(e)}async refresh(){await this.updateInstalledExtensionsContexts(),this.doSearch(!0),this.configurationService.getValue(ke)&&this.extensionsWorkbenchService.checkForUpdates()}notificationDisposables=this._register(new A);renderNotificaiton(){if(!this.notificationContainer)return;ye(this.notificationContainer),this.notificationDisposables.value=new Ee;const e=this.extensionsWorkbenchService.getExtensionsNotification();if(e&&!this.searchMarketplaceExtensionsContextKey.get()){this.notificationContainer.setAttribute("aria-label",e.message),this.notificationContainer.classList.remove("hidden");const t=E(this.notificationContainer,g(".message-container"));E(t,g("span")).className=Nt.className(e.severity),E(t,g("span.message",void 0,e.message));const n=E(t,g("span.message-text-action",{tabindex:"0",role:"button","aria-label":`${e.message}. ${u("click show","Click to Show")}`},u("show","Show"))),s=()=>this.search(e.extensions.map(l=>`@id:${l.identifier.id}`).join(" "));this.notificationDisposables.value.add(F(n,Q.CLICK,()=>s())),this.notificationDisposables.value.add(F(n,Q.KEY_DOWN,l=>{const r=new Ot(l);(r.keyCode===ne.Enter||r.keyCode===ne.Space)&&s(),r.stopPropagation()}))}else this.notificationContainer.removeAttribute("aria-label"),this.notificationContainer.classList.add("hidden");this._dimension&&this.layout(this._dimension)}async updateInstalledExtensionsContexts(){const e=await this.extensionsWorkbenchService.queryLocal();this.hasInstalledExtensionsContextKey.set(e.some(t=>!t.isBuiltin))}triggerSearch(){this.searchDelayer.trigger(()=>this.doSearch(),this.searchBox&&this.searchBox.getValue()?500:0).then(void 0,e=>this.onError(e))}normalizedQuery(){return this.searchBox?this.searchBox.getValue().trim().replace(/@category/g,"category").replace(/@tag:/g,"tag:").replace(/@ext:/g,"ext:").replace(/@featured/g,"featured").replace(/@popular/g,this.extensionManagementServerService.webExtensionManagementServer&&!this.extensionManagementServerService.localExtensionManagementServer&&!this.extensionManagementServerService.remoteExtensionManagementServer?"@web":"@popular"):""}saveState(){const e=this.searchBox?this.searchBox.getValue():"";c.isLocalExtensionsQuery(e)?this.searchViewletState["query.value"]=e:this.searchViewletState["query.value"]="",super.saveState()}doSearch(e){const t=this.normalizedQuery();return this.contextKeyService.bufferChangeEvents(()=>{const n=c.isRecommendedExtensionsQuery(t);this.searchHasTextContextKey.set(t.trim()!==""),this.installedExtensionsContextKey.set(c.isInstalledExtensionsQuery(t)),this.searchInstalledExtensionsContextKey.set(c.isSearchInstalledExtensionsQuery(t)),this.searchRecentlyUpdatedExtensionsContextKey.set(c.isSearchRecentlyUpdatedQuery(t)&&!c.isSearchExtensionUpdatesQuery(t)),this.searchOutdatedExtensionsContextKey.set(c.isOutdatedExtensionsQuery(t)&&!c.isSearchExtensionUpdatesQuery(t)),this.searchExtensionUpdatesContextKey.set(c.isSearchExtensionUpdatesQuery(t)),this.searchEnabledExtensionsContextKey.set(c.isEnabledExtensionsQuery(t)),this.searchDisabledExtensionsContextKey.set(c.isDisabledExtensionsQuery(t)),this.searchBuiltInExtensionsContextKey.set(c.isSearchBuiltInExtensionsQuery(t)),this.searchWorkspaceUnsupportedExtensionsContextKey.set(c.isSearchWorkspaceUnsupportedExtensionsQuery(t)),this.searchDeprecatedExtensionsContextKey.set(c.isSearchDeprecatedExtensionsQuery(t)),this.builtInExtensionsContextKey.set(c.isBuiltInExtensionsQuery(t)),this.recommendedExtensionsContextKey.set(n),this.searchMarketplaceExtensionsContextKey.set(!!t&&!c.isLocalExtensionsQuery(t)&&!n),this.sortByUpdateDateContextKey.set(c.isSortUpdateDateQuery(t)),this.defaultViewsContextKey.set(!t||c.isSortInstalledExtensionsQuery(t))}),this.renderNotificaiton(),this.progress(Promise.all(this.panes.map(n=>n.show(this.normalizedQuery(),e).then(s=>this.alertSearchResult(s.length,n.id))))).then(()=>{})}onDidAddViewDescriptors(e){const t=super.onDidAddViewDescriptors(e);return this.progress(Promise.all(t.map(n=>n.show(this.normalizedQuery()).then(s=>this.alertSearchResult(s.length,n.id))))),t}alertSearchResult(e,t){const n=this.viewContainerModel.visibleViewDescriptors.find(s=>s.id===t);switch(e){case 0:break;case 1:n?M(u("extensionFoundInSection","1 extension found in the {0} section.",n.name.value)):M(u("extensionFound","1 extension found."));break;default:n?M(u("extensionsFoundInSection","{0} extensions found in the {1} section.",e,n.name.value)):M(u("extensionsFound","{0} extensions found.",e));break}}getFirstExpandedPane(){for(const e of this.panes)if(e.isExpanded()&&e instanceof c)return e}focusListView(){const e=this.getFirstExpandedPane();e&&e.count()>0&&e.focus()}onViewletOpen(e){if(!(!e||e.getId()===D)&&this.configurationService.getValue(Ce)){const t=this.editorGroupService.groups.map(n=>{const s=n.editors.filter(l=>l instanceof Ue);return n.closeEditors(s)});Promise.all(t)}}progress(e){return this.progressService.withProgress({location:et.Extensions},()=>e)}onError(e){if(me(e))return;const t=e&&e.message||"";if(/ECONNREFUSED/.test(t)){const n=ve(u("suggestProxyError","Marketplace returned 'ECONNREFUSED'. Please check the 'http.proxy' setting."),[new ge("open user settings",u("open user settings","Open User Settings"),void 0,!0,()=>this.preferencesService.openUserSettings())]);this.notificationService.error(n);return}this.notificationService.error(e)}isSupportedDragElement(e){return e.dataTransfer?e.dataTransfer.types.map(n=>n.toLocaleLowerCase()).indexOf("files")!==-1:!1}};T=C([o(0,vt),o(1,be),o(2,Ze),o(3,B),o(4,tt),o(5,H),o(6,$),o(7,Y),o(8,Kt),o(9,ot),o(10,z),o(11,ct),o(12,dt),o(13,X),o(14,pt),o(15,Ie),o(16,j),o(17,bt),o(18,Vt)],T);let R=class extends O{constructor(e,t,n,s){super();this.activityService=e;this.extensionsWorkbenchService=t;this.extensionEnablementService=n;this.configurationService=s;this.onServiceChange(),this._register(b.any(b.debounce(t.onChange,()=>{},100,void 0,void 0,void 0,this._store),t.onDidChangeExtensionsNotification)(this.onServiceChange,this))}badgeHandle=this._register(new A);onServiceChange(){this.badgeHandle.clear();let e;const t=this.extensionsWorkbenchService.getExtensionsNotification();if(t)t.severity===G.Warning&&(e=new st(()=>t.message));else{const n=this.configurationService.getValue(Te)===!0?[]:this.extensionsWorkbenchService.installed.filter(r=>r.runtimeState!==void 0),s=this.extensionsWorkbenchService.outdated.reduce((r,v)=>r+(this.extensionEnablementService.isEnabled(v.local)&&!n.includes(v)?1:0),0),l=s+n.length;if(l>0){let r="";s&&(r+=s===1?u("extensionToUpdate","{0} requires update",s):u("extensionsToUpdate","{0} require update",s)),s>0&&n.length>0&&(r+=", "),n.length&&(r+=n.length===1?u("extensionToReload","{0} requires restart",n.length):u("extensionsToReload","{0} require restart",n.length)),e=new it(l,()=>r)}}e&&(this.badgeHandle.value=this.activityService.showViewContainerActivity(D,{badge:e}))}};R=C([o(0,nt),o(1,H),o(2,Be),o(3,z)],R);let W=class{constructor(m,e,t,n,s){this.extensionsManagementService=m;this.hostService=e;this.logService=t;this.notificationService=n;this.environmentService=s;this.environmentService.disableExtensions||this.loopCheckForMaliciousExtensions()}loopCheckForMaliciousExtensions(){this.checkForMaliciousExtensions().then(()=>pe(1e3*60*5)).then(()=>this.loopCheckForMaliciousExtensions())}checkForMaliciousExtensions(){return this.extensionsManagementService.getExtensionsControlManifest().then(m=>this.extensionsManagementService.getInstalled(wt.User).then(e=>{const t=e.filter(n=>m.malicious.some(s=>Lt(n.identifier,s)));return t.length?ue.settled(t.map(n=>this.extensionsManagementService.uninstall(n).then(()=>{this.notificationService.prompt(G.Warning,u("malicious warning","We have uninstalled '{0}' which was reported to be problematic.",n.identifier.id),[{label:u("reloadNow","Reload Now"),run:()=>this.hostService.reload()}],{sticky:!0,priority:ut.URGENT})}))):Promise.resolve(void 0)}).then(()=>{}),m=>this.logService.error(m))}};W=C([o(0,Le),o(1,mt),o(2,xt),o(3,Y),o(4,Ct)],W);export{Xt as BuiltInExtensionsContext,I as DefaultViewsContext,At as ExtensionsSortByContext,T as ExtensionsViewPaneContainer,K as ExtensionsViewletViewsContribution,W as MaliciousExtensionChecker,Jt as RecommendedExtensionsContext,Ft as SearchHasTextContext,_t as SearchMarketplaceExtensionsContext,R as StatusUpdater};
