var u=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var f=(p,r,o,n)=>{for(var i=n>1?void 0:n?S(r,o):r,a=p.length-1,e;a>=0;a--)(e=p[a])&&(i=(n?e(r,o,i):e(i))||i);return n&&i&&u(r,o,i),i},t=(p,r)=>(o,n)=>r(o,n,p);import{localize as l}from"../../../../nls.js";import{dirname as I,basename as d}from"../../../../base/common/resources.js";import{ITextModelService as y}from"../../../../editor/common/services/resolverService.js";import{IDialogService as _}from"../../../../platform/dialogs/common/dialogs.js";import{INativeWorkbenchEnvironmentService as g}from"../../../services/environment/electron-sandbox/environmentService.js";import{ILifecycleService as b,LifecyclePhase as x}from"../../../services/lifecycle/common/lifecycle.js";import{PerfviewContrib as k}from"../browser/perfviewEditor.js";import{IExtensionService as w}from"../../../services/extensions/common/extensions.js";import{IClipboardService as P}from"../../../../platform/clipboard/common/clipboardService.js";import{URI as h}from"../../../../base/common/uri.js";import{IOpenerService as F}from"../../../../platform/opener/common/opener.js";import{INativeHostService as R}from"../../../../platform/native/common/native.js";import{IProductService as M}from"../../../../platform/product/common/productService.js";import{IFileService as C}from"../../../../platform/files/common/files.js";import{ILabelService as E}from"../../../../platform/label/common/label.js";let m=class{constructor(r,o,n,i,a,e,s,c,v,L,U){this._dialogService=r;this._environmentService=o;this._textModelResolverService=n;this._clipboardService=i;this._openerService=s;this._nativeHostService=c;this._productService=v;this._fileService=L;this._labelService=U;Promise.all([a.when(x.Eventually),e.whenInstalledExtensionsRegistered()]).then(()=>{this._stopProfiling()})}_stopProfiling(){if(!this._environmentService.args["prof-startup-prefix"])return;const r=h.file(this._environmentService.args["prof-startup-prefix"]),o=I(r),n=d(r),i=["--prof-startup"];this._fileService.readFile(r).then(e=>i.push(...e.toString().split("|"))).then(()=>this._fileService.del(r,{recursive:!0})).then(()=>new Promise(e=>{const s=()=>{this._fileService.exists(r).then(c=>{c?e():setTimeout(s,500)})};s()})).then(()=>this._fileService.del(r,{recursive:!0})).then(()=>this._fileService.resolve(o).then(e=>(e.children?e.children.filter(s=>s.resource.path.includes(n)):[]).map(s=>s.resource))).then(e=>{const s=e.reduce((c,v)=>`${c}${this._labelService.getUriLabel(v)}
`,`
`);return this._dialogService.confirm({type:"info",message:l("prof.message","Successfully created profiles."),detail:l("prof.detail",`Please create an issue and manually attach the following files:
{0}`,s),primaryButton:l({key:"prof.restartAndFileIssue",comment:["&& denotes a mnemonic"]},"&&Create Issue and Restart"),cancelButton:l("prof.restart","Restart")}).then(c=>{c.confirmed?Promise.all([this._nativeHostService.showItemInFolder(e[0].fsPath),this._createPerfIssue(e.map(v=>d(v)))]).then(()=>this._dialogService.confirm({type:"info",message:l("prof.thanks","Thanks for helping us."),detail:l("prof.detail.restart","A final restart is required to continue to use '{0}'. Again, thank you for your contribution.",this._productService.nameLong),primaryButton:l({key:"prof.restart.button",comment:["&& denotes a mnemonic"]},"&&Restart")}).then(v=>{v.confirmed&&this._nativeHostService.relaunch({removeArgs:i})})):this._nativeHostService.relaunch({removeArgs:i})})})}async _createPerfIssue(r){const o=this._productService.reportIssueUrl;if(!o)return;const n=k.get(),i=await this._textModelResolverService.createModelReference(n.getInputUri());try{await this._clipboardService.writeText(i.object.textEditorModel.getValue())}finally{i.dispose()}const a=`
1. :warning: We have copied additional data to your clipboard. Make sure to **paste** here. :warning:
1. :warning: Make sure to **attach** these files from your *home*-directory: :warning:
${r.map(c=>`-\`${c}\``).join(`
`)}
`,e=o,s=e.indexOf("?")===-1?"?":"&";this._openerService.open(h.parse(`${e}${s}body=${encodeURIComponent(a)}`))}};m=f([t(0,_),t(1,g),t(2,y),t(3,P),t(4,b),t(5,w),t(6,F),t(7,R),t(8,M),t(9,C),t(10,E)],m);export{m as StartupProfiler};
