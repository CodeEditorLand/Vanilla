var _=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var g=(m,t,e,i)=>{for(var a=i>1?void 0:i?M(t,e):t,r=m.length-1,s;r>=0;r--)(s=m[r])&&(a=(i?s(t,e,a):s(a))||a);return i&&a&&_(t,e,a),a},o=(m,t)=>(e,i)=>t(e,i,m);import{localize as w}from"../../../../nls.js";import{URI as T}from"../../../../base/common/uri.js";import{TextResourceEditorInput as C}from"../../../common/editor/textResourceEditorInput.js";import{ITextModelService as S}from"../../../../editor/common/services/resolverService.js";import"../../../../editor/common/model.js";import{ILifecycleService as x,LifecyclePhase as c,StartupKindToString as R}from"../../../services/lifecycle/common/lifecycle.js";import{ILanguageService as $}from"../../../../editor/common/languages/language.js";import{IInstantiationService as D}from"../../../../platform/instantiation/common/instantiation.js";import{IModelService as W}from"../../../../editor/common/services/model.js";import{ITimerService as E}from"../../../services/timer/browser/timerService.js";import{IExtensionService as L}from"../../../services/extensions/common/extensions.js";import{dispose as B}from"../../../../base/common/lifecycle.js";import{ICodeEditorService as P}from"../../../../editor/browser/services/codeEditorService.js";import{writeTransientState as F}from"../../codeEditor/browser/toggleWordWrap.js";import{LoaderEventType as l,LoaderStats as b,isESM as k}from"../../../../base/common/amd.js";import{IProductService as A}from"../../../../platform/product/common/productService.js";import{ITextFileService as U}from"../../../services/textfile/common/textfiles.js";import{IEditorService as j}from"../../../services/editor/common/editorService.js";import{ByteSize as h,IFileService as q}from"../../../../platform/files/common/files.js";import{ILabelService as N}from"../../../../platform/label/common/label.js";import{isWeb as z}from"../../../../base/common/platform.js";import{IFilesConfigurationService as G}from"../../../services/filesConfiguration/common/filesConfigurationService.js";import{ITerminalService as K}from"../../terminal/browser/terminal.js";import"../../../../base/common/performance.js";import{ITextResourceConfigurationService as O}from"../../../../editor/common/services/textResourceConfiguration.js";import{Registry as I}from"../../../../platform/registry/common/platform.js";import{Extensions as y,getWorkbenchContribution as V}from"../../../common/contributions.js";import{ICustomEditorLabelService as H}from"../../../services/editor/common/customEditorLabelService.js";let p=class{constructor(t,e){this._instaService=t;this._registration=e.registerTextModelContentProvider("perf",t.createInstance(v))}static get(){return V(p.ID)}static ID="workbench.contrib.perfview";_inputUri=T.from({scheme:"perf",path:"Startup Performance"});_registration;dispose(){this._registration.dispose()}getInputUri(){return this._inputUri}getEditorInput(){return this._instaService.createInstance(u)}};p=g([o(0,D),o(1,S)],p);let u=class extends C{static Id="PerfviewInput";get typeId(){return u.Id}constructor(t,e,i,a,r,s,n,d){super(p.get().getInputUri(),w("name","Startup Performance"),void 0,void 0,void 0,t,e,i,a,r,s,n,d)}};u=g([o(0,S),o(1,U),o(2,j),o(3,q),o(4,N),o(5,G),o(6,O),o(7,H)],u);let v=class{constructor(t,e,i,a,r,s,n,d){this._modelService=t;this._languageService=e;this._editorService=i;this._lifecycleService=a;this._timerService=r;this._extensionService=s;this._productService=n;this._terminalService=d}_model;_modelDisposables=[];provideTextContent(t){if(!this._model||this._model.isDisposed()){B(this._modelDisposables);const e=this._languageService.createById("markdown");this._model=this._modelService.getModel(t)||this._modelService.createModel("Loading...",e,t),this._modelDisposables.push(e.onDidChange(i=>{this._model?.setLanguage(i)})),this._modelDisposables.push(this._extensionService.onDidChangeExtensionsStatus(this._updateModel,this)),F(this._model,{wordWrapOverride:"off"},this._editorService)}return this._updateModel(),Promise.resolve(this._model)}_updateModel(){Promise.all([this._timerService.whenReady(),this._lifecycleService.when(c.Eventually),this._extensionService.whenInstalledExtensionsRegistered(),this._terminalService.whenConnected]).then(()=>{if(this._model&&!this._model.isDisposed()){const t=b.get(),e=new Y;this._addSummary(e),e.blank(),this._addSummaryTable(e,t),e.blank(),this._addExtensionsTable(e),e.blank(),this._addPerfMarksTable("Terminal Stats",e,this._timerService.getPerformanceMarks().find(i=>i[0]==="renderer")?.[1].filter(i=>i.name.startsWith("code/terminal/"))),e.blank(),this._addWorkbenchContributionsPerfMarksTable(e),e.blank(),this._addRawPerfMarks(e),k||(e.blank(),this._addLoaderStats(e,t),e.blank(),this._addCachedDataStats(e)),e.blank(),this._addResourceTimingStats(e),this._model.setValue(e.value)}})}_addSummary(t){const e=this._timerService.startupMetrics;t.heading(2,"System Info"),t.li(`${this._productService.nameShort}: ${this._productService.version} (${this._productService.commit||"0000000"})`),t.li(`OS: ${e.platform}(${e.release})`),e.cpus&&t.li(`CPUs: ${e.cpus.model}(${e.cpus.count} x ${e.cpus.speed})`),typeof e.totalmem=="number"&&typeof e.freemem=="number"&&t.li(`Memory(System): ${(e.totalmem/h.GB).toFixed(2)} GB(${(e.freemem/h.GB).toFixed(2)}GB free)`),e.meminfo&&t.li(`Memory(Process): ${(e.meminfo.workingSetSize/h.KB).toFixed(2)} MB working set(${(e.meminfo.privateBytes/h.KB).toFixed(2)}MB private, ${(e.meminfo.sharedBytes/h.KB).toFixed(2)}MB shared)`),t.li(`VM(likelihood): ${e.isVMLikelyhood}%`),t.li(`Initial Startup: ${e.initialStartup}`),t.li(`Has ${e.windowCount-1} other windows`),t.li(`Screen Reader Active: ${e.hasAccessibilitySupport}`),t.li(`Empty Workspace: ${e.emptyWorkbench}`)}_addSummaryTable(t,e){const i=this._timerService.startupMetrics,a=I.as(y.Workbench).timings,r=[];r.push(["start => app.isReady",i.timers.ellapsedAppReady,"[main]",`initial startup: ${i.initialStartup}`]),r.push(["nls:start => nls:end",i.timers.ellapsedNlsGeneration,"[main]",`initial startup: ${i.initialStartup}`]),r.push(["import(main.bundle.js)",i.timers.ellapsedLoadMainBundle,"[main]",`initial startup: ${i.initialStartup}`]),r.push(["start crash reporter",i.timers.ellapsedCrashReporter,"[main]",`initial startup: ${i.initialStartup}`]),r.push(["serve main IPC handle",i.timers.ellapsedMainServer,"[main]",`initial startup: ${i.initialStartup}`]),r.push(["create window",i.timers.ellapsedWindowCreate,"[main]",`initial startup: ${i.initialStartup}, ${i.initialStartup?`state: ${i.timers.ellapsedWindowRestoreState}ms, widget: ${i.timers.ellapsedBrowserWindowCreate}ms, show: ${i.timers.ellapsedWindowMaximize}ms`:""}`]),r.push(["app.isReady => window.loadUrl()",i.timers.ellapsedWindowLoad,"[main]",`initial startup: ${i.initialStartup}`]),r.push(["window.loadUrl() => begin to import(workbench.desktop.main.js)",i.timers.ellapsedWindowLoadToRequire,"[main->renderer]",R(i.windowKind)]),r.push(["import(workbench.desktop.main.js)",i.timers.ellapsedRequire,"[renderer]",`cached data: ${i.didUseCachedData?"YES":"NO"}${e?`, node_modules took ${e.nodeRequireTotal}ms`:""}`]),r.push(["wait for window config",i.timers.ellapsedWaitForWindowConfig,"[renderer]",void 0]),r.push(["init storage (global & workspace)",i.timers.ellapsedStorageInit,"[renderer]",void 0]),r.push(["init workspace service",i.timers.ellapsedWorkspaceServiceInit,"[renderer]",void 0]),z&&(r.push(["init settings and global state from settings sync service",i.timers.ellapsedRequiredUserDataInit,"[renderer]",void 0]),r.push(["init keybindings, snippets & extensions from settings sync service",i.timers.ellapsedOtherUserDataInit,"[renderer]",void 0])),r.push(["register extensions & spawn extension host",i.timers.ellapsedExtensions,"[renderer]",void 0]),r.push(["restore viewlet",i.timers.ellapsedViewletRestore,"[renderer]",i.viewletId]),r.push(["restore panel",i.timers.ellapsedPanelRestore,"[renderer]",i.panelId]),r.push(["restore & resolve visible editors",i.timers.ellapsedEditorRestore,"[renderer]",`${i.editorIds.length}: ${i.editorIds.join(", ")}`]),r.push(["create workbench contributions",i.timers.ellapsedWorkbenchContributions,"[renderer]",`${(a.get(c.Starting)?.length??0)+(a.get(c.Starting)?.length??0)} blocking startup`]),r.push(["overall workbench load",i.timers.ellapsedWorkbench,"[renderer]",void 0]),r.push(["workbench ready",i.ellapsed,"[main->renderer]",void 0]),r.push(["renderer ready",i.timers.ellapsedRenderer,"[renderer]",void 0]),r.push(["shared process connection ready",i.timers.ellapsedSharedProcesConnected,"[renderer->sharedprocess]",void 0]),r.push(["extensions registered",i.timers.ellapsedExtensionsReady,"[renderer]",void 0]),t.heading(2,"Performance Marks"),t.table(["What","Duration","Process","Info"],r)}_addExtensionsTable(t){const e=[],i=[],a=this._extensionService.getExtensionsStatus();for(const s in a){const{activationTimes:n}=a[s];n&&(n.activationReason.startup?e.push([s,n.activationReason.startup,n.codeLoadingTime,n.activateCallTime,n.activateResolvedTime,n.activationReason.activationEvent,n.activationReason.extensionId.value]):i.push([s,n.activationReason.startup,n.codeLoadingTime,n.activateCallTime,n.activateResolvedTime,n.activationReason.activationEvent,n.activationReason.extensionId.value]))}const r=e.concat(i);r.length>0&&(t.heading(2,"Extension Activation Stats"),t.table(["Extension","Eager","Load Code","Call Activate","Finish Activate","Event","By"],r))}_addPerfMarksTable(t,e,i){if(!i)return;const a=[];let r=-1,s=0;for(const{name:n,startTime:d}of i){const f=r!==-1?d-r:0;s+=f,a.push([n,Math.round(d),Math.round(f),Math.round(s)]),r=d}t&&e.heading(2,t),e.table(["Name","Timestamp","Delta","Total"],a)}_addWorkbenchContributionsPerfMarksTable(t){t.heading(2,"Workbench Contributions Blocking Restore");const e=I.as(y.Workbench).timings;t.li(`Total (LifecyclePhase.Starting): ${e.get(c.Starting)?.length} (${e.get(c.Starting)?.reduce((a,r)=>a+r[1],0)}ms)`),t.li(`Total (LifecyclePhase.Ready): ${e.get(c.Ready)?.length} (${e.get(c.Ready)?.reduce((a,r)=>a+r[1],0)}ms)`),t.blank();const i=this._timerService.getPerformanceMarks().find(a=>a[0]==="renderer")?.[1].filter(a=>a.name.startsWith("code/willCreateWorkbenchContribution/1")||a.name.startsWith("code/didCreateWorkbenchContribution/1")||a.name.startsWith("code/willCreateWorkbenchContribution/2")||a.name.startsWith("code/didCreateWorkbenchContribution/2"));this._addPerfMarksTable(void 0,t,i)}_addRawPerfMarks(t){for(const[e,i]of this._timerService.getPerformanceMarks()){t.heading(2,`Raw Perf Marks: ${e}`),t.value+="```\n",t.value+=`Name	Timestamp	Delta	Total
`;let a=-1,r=0;for(const{name:s,startTime:n}of i){const d=a!==-1?n-a:0;r+=d,t.value+=`${s}	${n}	${d}	${r}
`,a=n}t.value+="```\n"}}_addLoaderStats(t,e){t.heading(2,"Loader Stats"),t.heading(3,"Load AMD-module"),t.table(["Module","Duration"],e.amdLoad),t.blank(),t.heading(3,"Load commonjs-module"),t.table(["Module","Duration"],e.nodeRequire),t.blank(),t.heading(3,"Invoke AMD-module factory"),t.table(["Module","Duration"],e.amdInvoke),t.blank(),t.heading(3,"Invoke commonjs-module"),t.table(["Module","Duration"],e.nodeEval)}_addCachedDataStats(t){const e=new Map;if(e.set(l.CachedDataCreated,[]),e.set(l.CachedDataFound,[]),e.set(l.CachedDataMissed,[]),e.set(l.CachedDataRejected,[]),!k&&typeof require.getStats=="function")for(const a of require.getStats())e.has(a.type)&&e.get(a.type).push(a.detail);const i=a=>{if(a){a.sort();for(const r of a)t.li(`${r}`);t.blank()}};t.heading(2,"Node Cached Data Stats"),t.blank(),t.heading(3,"cached data used"),i(e.get(l.CachedDataFound)),t.heading(3,"cached data missed"),i(e.get(l.CachedDataMissed)),t.heading(3,"cached data rejected"),i(e.get(l.CachedDataRejected)),t.heading(3,"cached data created (lazy, might need refreshes)"),i(e.get(l.CachedDataCreated))}_addResourceTimingStats(t){const e=performance.getEntriesByType("resource").map(i=>[i.name,i.duration]);e.length&&(t.heading(2,"Resource Timing Stats"),t.table(["Name","Duration"],e))}};v=g([o(0,W),o(1,$),o(2,P),o(3,x),o(4,E),o(5,L),o(6,A),o(7,K)],v);class Y{value="";heading(t,e){return this.value+=`${"#".repeat(t)} ${e}

`,this}blank(){return this.value+=`
`,this}li(t){return this.value+=`* ${t}
`,this}table(t,e){this.value+=b.toMarkdownTable(t,e)}}export{p as PerfviewContrib,u as PerfviewInput};
