var _=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var g=(u,t,e,i)=>{for(var a=i>1?void 0:i?M(t,e):t,r=u.length-1,s;r>=0;r--)(s=u[r])&&(a=(i?s(t,e,a):s(a))||a);return i&&a&&_(t,e,a),a},o=(u,t)=>(e,i)=>t(e,i,u);import{LoaderEventType as l,LoaderStats as S,isESM as b}from"../../../../base/common/amd.js";import{dispose as w}from"../../../../base/common/lifecycle.js";import{isWeb as T}from"../../../../base/common/platform.js";import{URI as C}from"../../../../base/common/uri.js";import{ICodeEditorService as x}from"../../../../editor/browser/services/codeEditorService.js";import{ILanguageService as R}from"../../../../editor/common/languages/language.js";import{IModelService as $}from"../../../../editor/common/services/model.js";import{ITextModelService as k}from"../../../../editor/common/services/resolverService.js";import{ITextResourceConfigurationService as D}from"../../../../editor/common/services/textResourceConfiguration.js";import{localize as W}from"../../../../nls.js";import{ByteSize as h,IFileService as E}from"../../../../platform/files/common/files.js";import{IInstantiationService as L}from"../../../../platform/instantiation/common/instantiation.js";import{ILabelService as B}from"../../../../platform/label/common/label.js";import{IProductService as P}from"../../../../platform/product/common/productService.js";import{Registry as I}from"../../../../platform/registry/common/platform.js";import{Extensions as y,getWorkbenchContribution as F}from"../../../common/contributions.js";import{TextResourceEditorInput as A}from"../../../common/editor/textResourceEditorInput.js";import{ICustomEditorLabelService as U}from"../../../services/editor/common/customEditorLabelService.js";import{IEditorService as j}from"../../../services/editor/common/editorService.js";import{IExtensionService as q}from"../../../services/extensions/common/extensions.js";import{IFilesConfigurationService as N}from"../../../services/filesConfiguration/common/filesConfigurationService.js";import{ILifecycleService as z,LifecyclePhase as c,StartupKindToString as G}from"../../../services/lifecycle/common/lifecycle.js";import{ITextFileService as K}from"../../../services/textfile/common/textfiles.js";import{ITimerService as O}from"../../../services/timer/browser/timerService.js";import{writeTransientState as V}from"../../codeEditor/browser/toggleWordWrap.js";import{ITerminalService as H}from"../../terminal/browser/terminal.js";let p=class{constructor(t,e){this._instaService=t;this._registration=e.registerTextModelContentProvider("perf",t.createInstance(v))}static get(){return F(p.ID)}static ID="workbench.contrib.perfview";_inputUri=C.from({scheme:"perf",path:"Startup Performance"});_registration;dispose(){this._registration.dispose()}getInputUri(){return this._inputUri}getEditorInput(){return this._instaService.createInstance(m)}};p=g([o(0,L),o(1,k)],p);let m=class extends A{static Id="PerfviewInput";get typeId(){return m.Id}constructor(t,e,i,a,r,s,n,d){super(p.get().getInputUri(),W("name","Startup Performance"),void 0,void 0,void 0,t,e,i,a,r,s,n,d)}};m=g([o(0,k),o(1,K),o(2,j),o(3,E),o(4,B),o(5,N),o(6,D),o(7,U)],m);let v=class{constructor(t,e,i,a,r,s,n,d){this._modelService=t;this._languageService=e;this._editorService=i;this._lifecycleService=a;this._timerService=r;this._extensionService=s;this._productService=n;this._terminalService=d}_model;_modelDisposables=[];provideTextContent(t){if(!this._model||this._model.isDisposed()){w(this._modelDisposables);const e=this._languageService.createById("markdown");this._model=this._modelService.getModel(t)||this._modelService.createModel("Loading...",e,t),this._modelDisposables.push(e.onDidChange(i=>{this._model?.setLanguage(i)})),this._modelDisposables.push(this._extensionService.onDidChangeExtensionsStatus(this._updateModel,this)),V(this._model,{wordWrapOverride:"off"},this._editorService)}return this._updateModel(),Promise.resolve(this._model)}_updateModel(){Promise.all([this._timerService.whenReady(),this._lifecycleService.when(c.Eventually),this._extensionService.whenInstalledExtensionsRegistered(),this._terminalService.whenConnected]).then(()=>{if(this._model&&!this._model.isDisposed()){const t=S.get(),e=new Y;this._addSummary(e),e.blank(),this._addSummaryTable(e,t),e.blank(),this._addExtensionsTable(e),e.blank(),this._addPerfMarksTable("Terminal Stats",e,this._timerService.getPerformanceMarks().find(i=>i[0]==="renderer")?.[1].filter(i=>i.name.startsWith("code/terminal/"))),e.blank(),this._addWorkbenchContributionsPerfMarksTable(e),e.blank(),this._addRawPerfMarks(e),b||(e.blank(),this._addLoaderStats(e,t),e.blank(),this._addCachedDataStats(e)),e.blank(),this._addResourceTimingStats(e),this._model.setValue(e.value)}})}_addSummary(t){const e=this._timerService.startupMetrics;t.heading(2,"System Info"),t.li(`${this._productService.nameShort}: ${this._productService.version} (${this._productService.commit||"0000000"})`),t.li(`OS: ${e.platform}(${e.release})`),e.cpus&&t.li(`CPUs: ${e.cpus.model}(${e.cpus.count} x ${e.cpus.speed})`),typeof e.totalmem=="number"&&typeof e.freemem=="number"&&t.li(`Memory(System): ${(e.totalmem/h.GB).toFixed(2)} GB(${(e.freemem/h.GB).toFixed(2)}GB free)`),e.meminfo&&t.li(`Memory(Process): ${(e.meminfo.workingSetSize/h.KB).toFixed(2)} MB working set(${(e.meminfo.privateBytes/h.KB).toFixed(2)}MB private, ${(e.meminfo.sharedBytes/h.KB).toFixed(2)}MB shared)`),t.li(`VM(likelihood): ${e.isVMLikelyhood}%`),t.li(`Initial Startup: ${e.initialStartup}`),t.li(`Has ${e.windowCount-1} other windows`),t.li(`Screen Reader Active: ${e.hasAccessibilitySupport}`),t.li(`Empty Workspace: ${e.emptyWorkbench}`)}_addSummaryTable(t,e){const i=this._timerService.startupMetrics,a=I.as(y.Workbench).timings,r=[];r.push(["start => app.isReady",i.timers.ellapsedAppReady,"[main]",`initial startup: ${i.initialStartup}`]),r.push(["nls:start => nls:end",i.timers.ellapsedNlsGeneration,"[main]",`initial startup: ${i.initialStartup}`]),r.push(["import(main.bundle.js)",i.timers.ellapsedLoadMainBundle,"[main]",`initial startup: ${i.initialStartup}`]),r.push(["start crash reporter",i.timers.ellapsedCrashReporter,"[main]",`initial startup: ${i.initialStartup}`]),r.push(["serve main IPC handle",i.timers.ellapsedMainServer,"[main]",`initial startup: ${i.initialStartup}`]),r.push(["create window",i.timers.ellapsedWindowCreate,"[main]",`initial startup: ${i.initialStartup}, ${i.initialStartup?`state: ${i.timers.ellapsedWindowRestoreState}ms, widget: ${i.timers.ellapsedBrowserWindowCreate}ms, show: ${i.timers.ellapsedWindowMaximize}ms`:""}`]),r.push(["app.isReady => window.loadUrl()",i.timers.ellapsedWindowLoad,"[main]",`initial startup: ${i.initialStartup}`]),r.push(["window.loadUrl() => begin to import(workbench.desktop.main.js)",i.timers.ellapsedWindowLoadToRequire,"[main->renderer]",G(i.windowKind)]),r.push(["import(workbench.desktop.main.js)",i.timers.ellapsedRequire,"[renderer]",`cached data: ${i.didUseCachedData?"YES":"NO"}${e?`, node_modules took ${e.nodeRequireTotal}ms`:""}`]),r.push(["wait for window config",i.timers.ellapsedWaitForWindowConfig,"[renderer]",void 0]),r.push(["init storage (global & workspace)",i.timers.ellapsedStorageInit,"[renderer]",void 0]),r.push(["init workspace service",i.timers.ellapsedWorkspaceServiceInit,"[renderer]",void 0]),T&&(r.push(["init settings and global state from settings sync service",i.timers.ellapsedRequiredUserDataInit,"[renderer]",void 0]),r.push(["init keybindings, snippets & extensions from settings sync service",i.timers.ellapsedOtherUserDataInit,"[renderer]",void 0])),r.push(["register extensions & spawn extension host",i.timers.ellapsedExtensions,"[renderer]",void 0]),r.push(["restore viewlet",i.timers.ellapsedViewletRestore,"[renderer]",i.viewletId]),r.push(["restore panel",i.timers.ellapsedPanelRestore,"[renderer]",i.panelId]),r.push(["restore & resolve visible editors",i.timers.ellapsedEditorRestore,"[renderer]",`${i.editorIds.length}: ${i.editorIds.join(", ")}`]),r.push(["create workbench contributions",i.timers.ellapsedWorkbenchContributions,"[renderer]",`${(a.get(c.Starting)?.length??0)+(a.get(c.Starting)?.length??0)} blocking startup`]),r.push(["overall workbench load",i.timers.ellapsedWorkbench,"[renderer]",void 0]),r.push(["workbench ready",i.ellapsed,"[main->renderer]",void 0]),r.push(["renderer ready",i.timers.ellapsedRenderer,"[renderer]",void 0]),r.push(["shared process connection ready",i.timers.ellapsedSharedProcesConnected,"[renderer->sharedprocess]",void 0]),r.push(["extensions registered",i.timers.ellapsedExtensionsReady,"[renderer]",void 0]),t.heading(2,"Performance Marks"),t.table(["What","Duration","Process","Info"],r)}_addExtensionsTable(t){const e=[],i=[],a=this._extensionService.getExtensionsStatus();for(const s in a){const{activationTimes:n}=a[s];n&&(n.activationReason.startup?e.push([s,n.activationReason.startup,n.codeLoadingTime,n.activateCallTime,n.activateResolvedTime,n.activationReason.activationEvent,n.activationReason.extensionId.value]):i.push([s,n.activationReason.startup,n.codeLoadingTime,n.activateCallTime,n.activateResolvedTime,n.activationReason.activationEvent,n.activationReason.extensionId.value]))}const r=e.concat(i);r.length>0&&(t.heading(2,"Extension Activation Stats"),t.table(["Extension","Eager","Load Code","Call Activate","Finish Activate","Event","By"],r))}_addPerfMarksTable(t,e,i){if(!i)return;const a=[];let r=-1,s=0;for(const{name:n,startTime:d}of i){const f=r!==-1?d-r:0;s+=f,a.push([n,Math.round(d),Math.round(f),Math.round(s)]),r=d}t&&e.heading(2,t),e.table(["Name","Timestamp","Delta","Total"],a)}_addWorkbenchContributionsPerfMarksTable(t){t.heading(2,"Workbench Contributions Blocking Restore");const e=I.as(y.Workbench).timings;t.li(`Total (LifecyclePhase.Starting): ${e.get(c.Starting)?.length} (${e.get(c.Starting)?.reduce((a,r)=>a+r[1],0)}ms)`),t.li(`Total (LifecyclePhase.Ready): ${e.get(c.Ready)?.length} (${e.get(c.Ready)?.reduce((a,r)=>a+r[1],0)}ms)`),t.blank();const i=this._timerService.getPerformanceMarks().find(a=>a[0]==="renderer")?.[1].filter(a=>a.name.startsWith("code/willCreateWorkbenchContribution/1")||a.name.startsWith("code/didCreateWorkbenchContribution/1")||a.name.startsWith("code/willCreateWorkbenchContribution/2")||a.name.startsWith("code/didCreateWorkbenchContribution/2"));this._addPerfMarksTable(void 0,t,i)}_addRawPerfMarks(t){for(const[e,i]of this._timerService.getPerformanceMarks()){t.heading(2,`Raw Perf Marks: ${e}`),t.value+="```\n",t.value+=`Name	Timestamp	Delta	Total
`;let a=-1,r=0;for(const{name:s,startTime:n}of i){const d=a!==-1?n-a:0;r+=d,t.value+=`${s}	${n}	${d}	${r}
`,a=n}t.value+="```\n"}}_addLoaderStats(t,e){t.heading(2,"Loader Stats"),t.heading(3,"Load AMD-module"),t.table(["Module","Duration"],e.amdLoad),t.blank(),t.heading(3,"Load commonjs-module"),t.table(["Module","Duration"],e.nodeRequire),t.blank(),t.heading(3,"Invoke AMD-module factory"),t.table(["Module","Duration"],e.amdInvoke),t.blank(),t.heading(3,"Invoke commonjs-module"),t.table(["Module","Duration"],e.nodeEval)}_addCachedDataStats(t){const e=new Map;if(e.set(l.CachedDataCreated,[]),e.set(l.CachedDataFound,[]),e.set(l.CachedDataMissed,[]),e.set(l.CachedDataRejected,[]),!b&&typeof require.getStats=="function")for(const a of require.getStats())e.has(a.type)&&e.get(a.type).push(a.detail);const i=a=>{if(a){a.sort();for(const r of a)t.li(`${r}`);t.blank()}};t.heading(2,"Node Cached Data Stats"),t.blank(),t.heading(3,"cached data used"),i(e.get(l.CachedDataFound)),t.heading(3,"cached data missed"),i(e.get(l.CachedDataMissed)),t.heading(3,"cached data rejected"),i(e.get(l.CachedDataRejected)),t.heading(3,"cached data created (lazy, might need refreshes)"),i(e.get(l.CachedDataCreated))}_addResourceTimingStats(t){const e=performance.getEntriesByType("resource").map(i=>[i.name,i.duration]);e.length&&(t.heading(2,"Resource Timing Stats"),t.table(["Name","Duration"],e))}};v=g([o(0,$),o(1,R),o(2,x),o(3,z),o(4,O),o(5,q),o(6,P),o(7,H)],v);class Y{value="";heading(t,e){return this.value+=`${"#".repeat(t)} ${e}

`,this}blank(){return this.value+=`
`,this}li(t){return this.value+=`* ${t}
`,this}table(t,e){this.value+=S.toMarkdownTable(t,e)}}export{p as PerfviewContrib,m as PerfviewInput};
