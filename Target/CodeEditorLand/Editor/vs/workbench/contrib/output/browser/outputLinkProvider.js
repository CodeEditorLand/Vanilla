var h=Object.defineProperty;var u=Object.getOwnPropertyDescriptor;var d=(n,t,e,r)=>{for(var i=r>1?void 0:r?u(t,e):t,c=n.length-1,p;c>=0;c--)(p=n[c])&&(i=(r?p(t,e,i):p(i))||i);return r&&i&&h(t,e,i),i},o=(n,t)=>(e,r)=>t(e,r,n);import{RunOnceScheduler as m}from"../../../../base/common/async.js";import{IModelService as l}from"../../../../editor/common/services/model.js";import{IWorkspaceContextService as k}from"../../../../platform/workspace/common/workspace.js";import{OUTPUT_MODE_ID as S,LOG_MODE_ID as g}from"../../../services/output/common/output.js";import{dispose as W,Disposable as v}from"../../../../base/common/lifecycle.js";import{ILanguageFeaturesService as I}from"../../../../editor/common/services/languageFeatures.js";import{createWebWorker as f}from"../../../../base/browser/defaultWorkerFactory.js";import{WorkerTextModelSyncClient as w}from"../../../../editor/common/services/textModelSync/textModelSync.impl.js";let s=class extends v{constructor(e,r,i){super();this.contextService=e;this.modelService=r;this.languageFeaturesService=i;this.disposeWorkerScheduler=new m(()=>this.disposeWorker(),s.DISPOSE_WORKER_TIME),this.registerListeners(),this.updateLinkProviderWorker()}static DISPOSE_WORKER_TIME=3*60*1e3;worker;disposeWorkerScheduler;linkProviderRegistration;registerListeners(){this._register(this.contextService.onDidChangeWorkspaceFolders(()=>this.updateLinkProviderWorker()))}updateLinkProviderWorker(){this.contextService.getWorkspace().folders.length>0?this.linkProviderRegistration||(this.linkProviderRegistration=this.languageFeaturesService.linkProvider.register([{language:S,scheme:"*"},{language:g,scheme:"*"}],{provideLinks:async r=>{const i=await this.provideLinks(r.uri);return i&&{links:i}}})):(W(this.linkProviderRegistration),this.linkProviderRegistration=void 0),this.disposeWorker(),this.disposeWorkerScheduler.cancel()}getOrCreateWorker(){return this.disposeWorkerScheduler.schedule(),this.worker||(this.worker=new a(this.contextService,this.modelService)),this.worker}async provideLinks(e){return this.getOrCreateWorker().provideLinks(e)}disposeWorker(){this.worker&&(this.worker.dispose(),this.worker=void 0)}};s=d([o(0,k),o(1,l),o(2,I)],s);let a=class extends v{constructor(e,r){super();this.contextService=e;this._workerClient=this._register(f("vs/workbench/contrib/output/common/outputLinkComputer","OutputLinkDetectionWorker")),this._workerTextModelSyncClient=w.create(this._workerClient,r),this._initializeBarrier=this._ensureWorkspaceFolders()}_workerClient;_workerTextModelSyncClient;_initializeBarrier;async _ensureWorkspaceFolders(){await this._workerClient.proxy.$setWorkspaceFolders(this.contextService.getWorkspace().folders.map(e=>e.uri.toString()))}async provideLinks(e){return await this._initializeBarrier,await this._workerTextModelSyncClient.ensureSyncedResources([e]),this._workerClient.proxy.$computeLinks(e.toString())}};a=d([o(0,k),o(1,l)],a);export{s as OutputLinkProvider};
