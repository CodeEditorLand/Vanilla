var h=Object.defineProperty;var u=Object.getOwnPropertyDescriptor;var d=(n,t,e,r)=>{for(var i=r>1?void 0:r?u(t,e):t,c=n.length-1,p;c>=0;c--)(p=n[c])&&(i=(r?p(t,e,i):p(i))||i);return r&&i&&h(t,e,i),i},o=(n,t)=>(e,r)=>t(e,r,n);import{createWebWorker as m}from"../../../../base/browser/defaultWorkerFactory.js";import{RunOnceScheduler as S}from"../../../../base/common/async.js";import{Disposable as l,dispose as g}from"../../../../base/common/lifecycle.js";import"../../../../base/common/uri.js";import"../../../../base/common/worker/simpleWorker.js";import"../../../../editor/common/languages.js";import{ILanguageFeaturesService as W}from"../../../../editor/common/services/languageFeatures.js";import{IModelService as k}from"../../../../editor/common/services/model.js";import{WorkerTextModelSyncClient as I}from"../../../../editor/common/services/textModelSync/textModelSync.impl.js";import{IWorkspaceContextService as v}from"../../../../platform/workspace/common/workspace.js";import{LOG_MODE_ID as f,OUTPUT_MODE_ID as w}from"../../../services/output/common/output.js";import"../common/outputLinkComputer.js";let s=class extends l{constructor(e,r,i){super();this.contextService=e;this.modelService=r;this.languageFeaturesService=i;this.disposeWorkerScheduler=new S(()=>this.disposeWorker(),s.DISPOSE_WORKER_TIME),this.registerListeners(),this.updateLinkProviderWorker()}static DISPOSE_WORKER_TIME=3*60*1e3;worker;disposeWorkerScheduler;linkProviderRegistration;registerListeners(){this._register(this.contextService.onDidChangeWorkspaceFolders(()=>this.updateLinkProviderWorker()))}updateLinkProviderWorker(){this.contextService.getWorkspace().folders.length>0?this.linkProviderRegistration||(this.linkProviderRegistration=this.languageFeaturesService.linkProvider.register([{language:w,scheme:"*"},{language:f,scheme:"*"}],{provideLinks:async r=>{const i=await this.provideLinks(r.uri);return i&&{links:i}}})):(g(this.linkProviderRegistration),this.linkProviderRegistration=void 0),this.disposeWorker(),this.disposeWorkerScheduler.cancel()}getOrCreateWorker(){return this.disposeWorkerScheduler.schedule(),this.worker||(this.worker=new a(this.contextService,this.modelService)),this.worker}async provideLinks(e){return this.getOrCreateWorker().provideLinks(e)}disposeWorker(){this.worker&&(this.worker.dispose(),this.worker=void 0)}};s=d([o(0,v),o(1,k),o(2,W)],s);let a=class extends l{constructor(e,r){super();this.contextService=e;this._workerClient=this._register(m("vs/workbench/contrib/output/common/outputLinkComputer","OutputLinkDetectionWorker")),this._workerTextModelSyncClient=I.create(this._workerClient,r),this._initializeBarrier=this._ensureWorkspaceFolders()}_workerClient;_workerTextModelSyncClient;_initializeBarrier;async _ensureWorkspaceFolders(){await this._workerClient.proxy.$setWorkspaceFolders(this.contextService.getWorkspace().folders.map(e=>e.uri.toString()))}async provideLinks(e){return await this._initializeBarrier,await this._workerTextModelSyncClient.ensureSyncedResources([e]),this._workerClient.proxy.$computeLinks(e.toString())}};a=d([o(0,v),o(1,k)],a);export{s as OutputLinkProvider};
