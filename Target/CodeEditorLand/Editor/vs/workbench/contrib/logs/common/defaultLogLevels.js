var d=Object.defineProperty;var h=Object.getOwnPropertyDescriptor;var c=(l,s,e,t)=>{for(var o=t>1?void 0:t?h(s,e):s,r=l.length-1,i;r>=0;r--)(i=l[r])&&(o=(t?i(s,e,o):i(o))||o);return t&&o&&d(s,e,o),o},g=(l,s)=>(e,t)=>s(e,t,l);import{Emitter as p}from"../../../../base/common/event.js";import{parse as S}from"../../../../base/common/json.js";import{Disposable as D}from"../../../../base/common/lifecycle.js";import{isString as _,isUndefined as v}from"../../../../base/common/types.js";import{EXTENSION_IDENTIFIER_WITH_LOG_REGEX as y}from"../../../../platform/environment/common/environmentService.js";import{FileOperationResult as E,IFileService as w,toFileOperationResult as x}from"../../../../platform/files/common/files.js";import{InstantiationType as A,registerSingleton as F}from"../../../../platform/instantiation/common/extensions.js";import{createDecorator as I}from"../../../../platform/instantiation/common/instantiation.js";import{ILogService as P,ILoggerService as T,LogLevelToString as f,getLogLevel as u,parseLogLevel as a}from"../../../../platform/log/common/log.js";import{IJSONEditingService as C}from"../../../services/configuration/common/jsonEditing.js";import{IWorkbenchEnvironmentService as R}from"../../../services/environment/common/environmentService.js";const O=I("IDefaultLogLevelsService");let L=class extends D{constructor(e,t,o,r,i){super();this.environmentService=e;this.fileService=t;this.jsonEditingService=o;this.logService=r;this.loggerService=i}_serviceBrand;_onDidChangeDefaultLogLevels=this._register(new p);onDidChangeDefaultLogLevels=this._onDidChangeDefaultLogLevels.event;async getDefaultLogLevels(){const e=await this._parseLogLevelsFromArgv();return{default:e?.default??this._getDefaultLogLevelFromEnv(),extensions:e?.extensions??this._getExtensionsDefaultLogLevelsFromEnv()}}async getDefaultLogLevel(e){const t=await this._parseLogLevelsFromArgv()??{};return e?(e=e.toLowerCase(),this._getDefaultLogLevel(t,e)):this._getDefaultLogLevel(t)}async setDefaultLogLevel(e,t){const o=await this._parseLogLevelsFromArgv()??{};if(t){t=t.toLowerCase();const r=this._getDefaultLogLevel(o,t);o.extensions=o.extensions??[];const i=o.extensions.find(([n])=>n===t);i?i[1]=e:o.extensions.push([t,e]),await this._writeLogLevelsToArgv(o);const m=[...this.loggerService.getRegisteredLoggers()].filter(n=>n.extensionId&&n.extensionId.toLowerCase()===t);for(const{resource:n}of m)this.loggerService.getLogLevel(n)===r&&this.loggerService.setLogLevel(n,e)}else{const r=this._getDefaultLogLevel(o);o.default=e,await this._writeLogLevelsToArgv(o),this.loggerService.getLogLevel()===r&&this.loggerService.setLogLevel(e)}this._onDidChangeDefaultLogLevels.fire()}_getDefaultLogLevel(e,t){if(t){const o=e.extensions?.find(([r])=>r===t);if(o)return o[1]}return e.default??u(this.environmentService)}async _writeLogLevelsToArgv(e){const t=[];v(e.default)||t.push(f(e.default));for(const[o,r]of e.extensions??[])t.push(`${o}=${f(r)}`);await this.jsonEditingService.write(this.environmentService.argvResource,[{path:["log-level"],value:t.length?t:void 0}],!0)}async _parseLogLevelsFromArgv(){const e={extensions:[]},t=await this._readLogLevelsFromArgv();for(const o of t){const r=y.exec(o);if(r&&r[1]&&r[2]){const i=a(r[2]);v(i)||e.extensions?.push([r[1].toLowerCase(),i])}else{const i=a(o);v(i)||(e.default=i)}}return!v(e.default)||e.extensions?.length?e:void 0}async migrateLogLevels(){const e=await this._readLogLevelsFromArgv(),t=/^([^.]+\..+):(.+)$/;if(e.some(o=>t.test(o))){const o=await this._parseLogLevelsFromArgv();o&&await this._writeLogLevelsToArgv(o)}}async _readLogLevelsFromArgv(){try{const e=await this.fileService.readFile(this.environmentService.argvResource),t=S(e.value.toString());return _(t["log-level"])?[t["log-level"]]:Array.isArray(t["log-level"])?t["log-level"]:[]}catch(e){x(e)!==E.FILE_NOT_FOUND&&this.logService.error(e)}return[]}_getDefaultLogLevelFromEnv(){return u(this.environmentService)}_getExtensionsDefaultLogLevelsFromEnv(){const e=[];for(const[t,o]of this.environmentService.extensionLogLevel??[]){const r=a(o);v(r)||e.push([t,r])}return e}};L=c([g(0,R),g(1,w),g(2,C),g(3,P),g(4,T)],L),F(O,L,A.Delayed);export{O as IDefaultLogLevelsService};
