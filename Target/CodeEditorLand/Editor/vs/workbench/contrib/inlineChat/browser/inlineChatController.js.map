{
  "version": 3,
  "sources": ["../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/contrib/inlineChat/browser/inlineChatController.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as aria from \"../../../../base/browser/ui/aria/aria.js\";\nimport {\n\tBarrier,\n\tDeferredPromise,\n\tQueue,\n} from \"../../../../base/common/async.js\";\nimport {\n\tCancellationToken,\n\tCancellationTokenSource,\n} from \"../../../../base/common/cancellation.js\";\nimport { toErrorMessage } from \"../../../../base/common/errorMessage.js\";\nimport { onUnexpectedError } from \"../../../../base/common/errors.js\";\nimport { Emitter, Event } from \"../../../../base/common/event.js\";\nimport { Lazy } from \"../../../../base/common/lazy.js\";\nimport {\n\tDisposableStore,\n\tMutableDisposable,\n\ttoDisposable,\n} from \"../../../../base/common/lifecycle.js\";\nimport { MovingAverage } from \"../../../../base/common/numbers.js\";\nimport { isEqual } from \"../../../../base/common/resources.js\";\nimport { StopWatch } from \"../../../../base/common/stopwatch.js\";\nimport { assertType } from \"../../../../base/common/types.js\";\nimport { generateUuid } from \"../../../../base/common/uuid.js\";\nimport {\n\ttype ICodeEditor,\n\tisCodeEditor,\n} from \"../../../../editor/browser/editorBrowser.js\";\nimport {\n\ttype IPosition,\n\tPosition,\n} from \"../../../../editor/common/core/position.js\";\nimport { type IRange, Range } from \"../../../../editor/common/core/range.js\";\nimport {\n\ttype ISelection,\n\tSelection,\n\tSelectionDirection,\n} from \"../../../../editor/common/core/selection.js\";\nimport type { IEditorContribution } from \"../../../../editor/common/editorCommon.js\";\nimport { TextEdit } from \"../../../../editor/common/languages.js\";\nimport type { IValidEditOperation } from \"../../../../editor/common/model.js\";\nimport { IEditorWorkerService } from \"../../../../editor/common/services/editorWorker.js\";\nimport { DefaultModelSHA1Computer } from \"../../../../editor/common/services/modelService.js\";\nimport { InlineCompletionsController } from \"../../../../editor/contrib/inlineCompletions/browser/controller/inlineCompletionsController.js\";\nimport { MessageController } from \"../../../../editor/contrib/message/browser/messageController.js\";\nimport { localize } from \"../../../../nls.js\";\nimport { IConfigurationService } from \"../../../../platform/configuration/common/configuration.js\";\nimport {\n\ttype IContextKey,\n\tIContextKeyService,\n} from \"../../../../platform/contextkey/common/contextkey.js\";\nimport { IDialogService } from \"../../../../platform/dialogs/common/dialogs.js\";\nimport {\n\tIInstantiationService,\n\ttype ServicesAccessor,\n} from \"../../../../platform/instantiation/common/instantiation.js\";\nimport { ILogService } from \"../../../../platform/log/common/log.js\";\nimport {\n\tIEditorService,\n\tSIDE_GROUP,\n} from \"../../../services/editor/common/editorService.js\";\nimport { IViewsService } from \"../../../services/views/common/viewsService.js\";\nimport { showChatView } from \"../../chat/browser/chat.js\";\nimport type { IChatWidgetLocationOptions } from \"../../chat/browser/chatWidget.js\";\nimport { ChatAgentLocation } from \"../../chat/common/chatAgents.js\";\nimport {\n\tCONTEXT_RESPONSE,\n\tCONTEXT_RESPONSE_ERROR,\n} from \"../../chat/common/chatContextKeys.js\";\nimport {\n\ttype ChatModel,\n\tChatRequestRemovalReason,\n\ttype IChatRequestModel,\n\ttype IChatTextEditGroup,\n\ttype IChatTextEditGroupState,\n\ttype IResponse,\n} from \"../../chat/common/chatModel.js\";\nimport { IChatService } from \"../../chat/common/chatService.js\";\nimport { INotebookEditorService } from \"../../notebook/browser/services/notebookEditorService.js\";\nimport {\n\tCTX_INLINE_CHAT_EDITING,\n\tCTX_INLINE_CHAT_REQUEST_IN_PROGRESS,\n\tCTX_INLINE_CHAT_RESPONSE_TYPE,\n\tCTX_INLINE_CHAT_USER_DID_EDIT,\n\tCTX_INLINE_CHAT_VISIBLE,\n\tEditMode,\n\tINLINE_CHAT_ID,\n\tInlineChatConfigKeys,\n\tInlineChatResponseType,\n} from \"../common/inlineChat.js\";\nimport { IInlineChatSavingService } from \"./inlineChatSavingService.js\";\nimport {\n\ttype HunkInformation,\n\tHunkState,\n\tSession,\n\ttype StashedSession,\n} from \"./inlineChatSession.js\";\nimport { IInlineChatSessionService } from \"./inlineChatSessionService.js\";\nimport { InlineChatError } from \"./inlineChatSessionServiceImpl.js\";\nimport {\n\ttype EditModeStrategy,\n\tHunkAction,\n\ttype IEditObserver,\n\tLiveStrategy,\n\tPreviewStrategy,\n\ttype ProgressingEditsOptions,\n} from \"./inlineChatStrategies.js\";\nimport { InlineChatZoneWidget } from \"./inlineChatZoneWidget.js\";\n\nexport enum State {\n\tCREATE_SESSION = \"CREATE_SESSION\",\n\tINIT_UI = \"INIT_UI\",\n\tWAIT_FOR_INPUT = \"WAIT_FOR_INPUT\",\n\tSHOW_REQUEST = \"SHOW_REQUEST\",\n\tPAUSE = \"PAUSE\",\n\tCANCEL = \"CANCEL\",\n\tACCEPT = \"DONE\",\n}\n\nenum Message {\n\tNONE = 0,\n\tACCEPT_SESSION = 1 << 0,\n\tCANCEL_SESSION = 1 << 1,\n\tPAUSE_SESSION = 1 << 2,\n\tCANCEL_REQUEST = 1 << 3,\n\tCANCEL_INPUT = 1 << 4,\n\tACCEPT_INPUT = 1 << 5,\n}\n\nexport abstract class InlineChatRunOptions {\n\tinitialSelection?: ISelection;\n\tinitialRange?: IRange;\n\tmessage?: string;\n\tautoSend?: boolean;\n\texistingSession?: Session;\n\tisUnstashed?: boolean;\n\tposition?: IPosition;\n\twithIntentDetection?: boolean;\n\theadless?: boolean;\n\n\tstatic isInlineChatRunOptions(\n\t\toptions: any,\n\t): options is InlineChatRunOptions {\n\t\tconst {\n\t\t\tinitialSelection,\n\t\t\tinitialRange,\n\t\t\tmessage,\n\t\t\tautoSend,\n\t\t\tposition,\n\t\t\texistingSession,\n\t\t} = <InlineChatRunOptions>options;\n\t\tif (\n\t\t\t(typeof message !== \"undefined\" && typeof message !== \"string\") ||\n\t\t\t(typeof autoSend !== \"undefined\" &&\n\t\t\t\ttypeof autoSend !== \"boolean\") ||\n\t\t\t(typeof initialRange !== \"undefined\" &&\n\t\t\t\t!Range.isIRange(initialRange)) ||\n\t\t\t(typeof initialSelection !== \"undefined\" &&\n\t\t\t\t!Selection.isISelection(initialSelection)) ||\n\t\t\t(typeof position !== \"undefined\" &&\n\t\t\t\t!Position.isIPosition(position)) ||\n\t\t\t(typeof existingSession !== \"undefined\" &&\n\t\t\t\t!(existingSession instanceof Session))\n\t\t) {\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n}\n\nexport class InlineChatController implements IEditorContribution {\n\tstatic get(editor: ICodeEditor) {\n\t\treturn editor.getContribution<InlineChatController>(INLINE_CHAT_ID);\n\t}\n\n\tprivate _isDisposed = false;\n\tprivate readonly _store = new DisposableStore();\n\n\tprivate readonly _ui: Lazy<InlineChatZoneWidget>;\n\n\tprivate readonly _ctxVisible: IContextKey<boolean>;\n\tprivate readonly _ctxEditing: IContextKey<boolean>;\n\tprivate readonly _ctxResponseType: IContextKey<\n\t\tundefined | InlineChatResponseType\n\t>;\n\tprivate readonly _ctxUserDidEdit: IContextKey<boolean>;\n\tprivate readonly _ctxRequestInProgress: IContextKey<boolean>;\n\n\tprivate readonly _ctxResponse: IContextKey<boolean>;\n\n\tprivate readonly _messages = this._store.add(new Emitter<Message>());\n\tprotected readonly _onDidEnterState = this._store.add(new Emitter<State>());\n\treadonly onDidEnterState = this._onDidEnterState.event;\n\n\tprivate readonly _onWillStartSession = this._store.add(new Emitter<void>());\n\treadonly onWillStartSession = this._onWillStartSession.event;\n\n\tget chatWidget() {\n\t\treturn this._ui.value.widget.chatWidget;\n\t}\n\n\tprivate readonly _sessionStore = this._store.add(new DisposableStore());\n\tprivate readonly _stashedSession = this._store.add(\n\t\tnew MutableDisposable<StashedSession>(),\n\t);\n\tprivate _session?: Session;\n\tprivate _strategy?: EditModeStrategy;\n\n\tconstructor(\n\t\tprivate readonly _editor: ICodeEditor,\n\t\t@IInstantiationService\n\t\tprivate readonly _instaService: IInstantiationService,\n\t\t@IInlineChatSessionService\n\t\tprivate readonly _inlineChatSessionService: IInlineChatSessionService,\n\t\t@IInlineChatSavingService\n\t\tprivate readonly _inlineChatSavingService: IInlineChatSavingService,\n\t\t@IEditorWorkerService\n\t\tprivate readonly _editorWorkerService: IEditorWorkerService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@IConfigurationService\n\t\tprivate readonly _configurationService: IConfigurationService,\n\t\t@IDialogService private readonly _dialogService: IDialogService,\n\t\t@IContextKeyService contextKeyService: IContextKeyService,\n\t\t@IChatService private readonly _chatService: IChatService,\n\t\t@IEditorService private readonly _editorService: IEditorService,\n\t\t@INotebookEditorService notebookEditorService: INotebookEditorService,\n\t) {\n\t\tthis._ctxVisible = CTX_INLINE_CHAT_VISIBLE.bindTo(contextKeyService);\n\t\tthis._ctxEditing = CTX_INLINE_CHAT_EDITING.bindTo(contextKeyService);\n\t\tthis._ctxUserDidEdit =\n\t\t\tCTX_INLINE_CHAT_USER_DID_EDIT.bindTo(contextKeyService);\n\t\tthis._ctxResponseType =\n\t\t\tCTX_INLINE_CHAT_RESPONSE_TYPE.bindTo(contextKeyService);\n\t\tthis._ctxRequestInProgress =\n\t\t\tCTX_INLINE_CHAT_REQUEST_IN_PROGRESS.bindTo(contextKeyService);\n\n\t\tthis._ctxResponse = CONTEXT_RESPONSE.bindTo(contextKeyService);\n\t\tCONTEXT_RESPONSE_ERROR.bindTo(contextKeyService);\n\n\t\tthis._ui = new Lazy(() => {\n\t\t\tconst location: IChatWidgetLocationOptions = {\n\t\t\t\tlocation: ChatAgentLocation.Editor,\n\t\t\t\tresolveData: () => {\n\t\t\t\t\tassertType(this._editor.hasModel());\n\t\t\t\t\tassertType(this._session);\n\t\t\t\t\treturn {\n\t\t\t\t\t\ttype: ChatAgentLocation.Editor,\n\t\t\t\t\t\tselection: this._editor.getSelection(),\n\t\t\t\t\t\tdocument: this._session.textModelN.uri,\n\t\t\t\t\t\twholeRange:\n\t\t\t\t\t\t\tthis._session?.wholeRange.trackedInitialRange,\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t};\n\n\t\t\t// inline chat in notebooks\n\t\t\t// check if this editor is part of a notebook editor\n\t\t\t// and iff so, use the notebook location but keep the resolveData\n\t\t\t// talk about editor data\n\t\t\tfor (const notebookEditor of notebookEditorService.listNotebookEditors()) {\n\t\t\t\tfor (const [, codeEditor] of notebookEditor.codeEditors) {\n\t\t\t\t\tif (codeEditor === this._editor) {\n\t\t\t\t\t\tlocation.location = ChatAgentLocation.Notebook;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn this._store.add(\n\t\t\t\t_instaService.createInstance(\n\t\t\t\t\tInlineChatZoneWidget,\n\t\t\t\t\tlocation,\n\t\t\t\t\tthis._editor,\n\t\t\t\t),\n\t\t\t);\n\t\t});\n\n\t\tthis._store.add(\n\t\t\tthis._editor.onDidChangeModel(async (e) => {\n\t\t\t\tif (this._session || !e.newModelUrl) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst existingSession =\n\t\t\t\t\tthis._inlineChatSessionService.getSession(\n\t\t\t\t\t\tthis._editor,\n\t\t\t\t\t\te.newModelUrl,\n\t\t\t\t\t);\n\t\t\t\tif (!existingSession) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis._log(\"session RESUMING after model change\", e);\n\t\t\t\tawait this.run({ existingSession });\n\t\t\t}),\n\t\t);\n\n\t\tthis._store.add(\n\t\t\tthis._inlineChatSessionService.onDidEndSession((e) => {\n\t\t\t\tif (e.session === this._session && e.endedByExternalCause) {\n\t\t\t\t\tthis._log(\"session ENDED by external cause\");\n\t\t\t\t\tthis._session = undefined;\n\t\t\t\t\tthis._strategy?.cancel();\n\t\t\t\t\tthis._resetWidget();\n\t\t\t\t\tthis.cancelSession();\n\t\t\t\t}\n\t\t\t}),\n\t\t);\n\n\t\tthis._store.add(\n\t\t\tthis._inlineChatSessionService.onDidMoveSession(async (e) => {\n\t\t\t\tif (e.editor === this._editor) {\n\t\t\t\t\tthis._log(\"session RESUMING after move\", e);\n\t\t\t\t\tawait this.run({ existingSession: e.session });\n\t\t\t\t}\n\t\t\t}),\n\t\t);\n\n\t\tthis._log(`NEW controller`);\n\t}\n\n\tdispose(): void {\n\t\tif (this._currentRun) {\n\t\t\tthis._messages.fire(\n\t\t\t\tthis._session?.chatModel.hasRequests\n\t\t\t\t\t? Message.PAUSE_SESSION\n\t\t\t\t\t: Message.CANCEL_SESSION,\n\t\t\t);\n\t\t}\n\t\tthis._store.dispose();\n\t\tthis._isDisposed = true;\n\t\tthis._log(\"DISPOSED controller\");\n\t}\n\n\tprivate _log(message: string | Error, ...more: any[]): void {\n\t\tif (message instanceof Error) {\n\t\t\tthis._logService.error(message, ...more);\n\t\t} else {\n\t\t\tthis._logService.trace(\n\t\t\t\t`[IE] (editor:${this._editor.getId()}) ${message}`,\n\t\t\t\t...more,\n\t\t\t);\n\t\t}\n\t}\n\n\tgetMessage(): string | undefined {\n\t\treturn this._ui.value.widget.responseContent;\n\t}\n\n\tgetId(): string {\n\t\treturn INLINE_CHAT_ID;\n\t}\n\n\tprivate _getMode(): EditMode {\n\t\treturn this._configurationService.getValue<EditMode>(\n\t\t\tInlineChatConfigKeys.Mode,\n\t\t);\n\t}\n\n\tgetWidgetPosition(): Position | undefined {\n\t\treturn this._ui.value.position;\n\t}\n\n\tprivate _currentRun?: Promise<void>;\n\n\tasync run(options: InlineChatRunOptions | undefined = {}): Promise<void> {\n\t\ttry {\n\t\t\tthis.finishExistingSession();\n\t\t\tif (this._currentRun) {\n\t\t\t\tawait this._currentRun;\n\t\t\t}\n\t\t\tif (options.initialSelection) {\n\t\t\t\tthis._editor.setSelection(options.initialSelection);\n\t\t\t}\n\t\t\tthis._stashedSession.clear();\n\t\t\tthis._onWillStartSession.fire();\n\t\t\tthis._currentRun = this._nextState(State.CREATE_SESSION, options);\n\t\t\tawait this._currentRun;\n\t\t} catch (error) {\n\t\t\t// this should not happen but when it does make sure to tear down the UI and everything\n\t\t\tthis._log(\"error during run\", error);\n\t\t\tonUnexpectedError(error);\n\t\t\tif (this._session) {\n\t\t\t\tthis._inlineChatSessionService.releaseSession(this._session);\n\t\t\t}\n\t\t\tthis[State.PAUSE]();\n\t\t} finally {\n\t\t\tthis._currentRun = undefined;\n\t\t}\n\t}\n\n\t// ---- state machine\n\n\tprotected async _nextState(\n\t\tstate: State,\n\t\toptions: InlineChatRunOptions,\n\t): Promise<void> {\n\t\tlet nextState: State | void = state;\n\t\twhile (nextState && !this._isDisposed) {\n\t\t\tthis._log(\"setState to \", nextState);\n\t\t\tconst p: State | Promise<State> | Promise<void> =\n\t\t\t\tthis[nextState](options);\n\t\t\tthis._onDidEnterState.fire(nextState);\n\t\t\tnextState = await p;\n\t\t}\n\t}\n\n\tprivate async [State.CREATE_SESSION](\n\t\toptions: InlineChatRunOptions,\n\t): Promise<State.CANCEL | State.INIT_UI> {\n\t\tassertType(this._session === undefined);\n\t\tassertType(this._editor.hasModel());\n\n\t\tlet session: Session | undefined = options.existingSession;\n\n\t\tlet initPosition: Position | undefined;\n\t\tif (options.position) {\n\t\t\tinitPosition = Position.lift(options.position).delta(-1);\n\t\t\tdelete options.position;\n\t\t}\n\n\t\tconst widgetPosition = this._showWidget(\n\t\t\toptions.headless ?? session?.headless,\n\t\t\ttrue,\n\t\t\tinitPosition,\n\t\t);\n\n\t\t// this._updatePlaceholder();\n\t\tlet errorMessage = localize(\n\t\t\t\"create.fail\",\n\t\t\t\"Failed to start editor chat\",\n\t\t);\n\n\t\tif (!session) {\n\t\t\tconst createSessionCts = new CancellationTokenSource();\n\t\t\tconst msgListener = Event.once(this._messages.event)((m) => {\n\t\t\t\tthis._log(\"state=_createSession) message received\", m);\n\t\t\t\tif (m === Message.ACCEPT_INPUT) {\n\t\t\t\t\t// user accepted the input before having a session\n\t\t\t\t\toptions.autoSend = true;\n\t\t\t\t\tthis._ui.value.widget.updateInfo(\n\t\t\t\t\t\tlocalize(\"welcome.2\", \"Getting ready...\"),\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\tcreateSessionCts.cancel();\n\t\t\t\t}\n\t\t\t});\n\n\t\t\ttry {\n\t\t\t\tsession = await this._inlineChatSessionService.createSession(\n\t\t\t\t\tthis._editor,\n\t\t\t\t\t{\n\t\t\t\t\t\teditMode: this._getMode(),\n\t\t\t\t\t\twholeRange: options.initialRange,\n\t\t\t\t\t},\n\t\t\t\t\tcreateSessionCts.token,\n\t\t\t\t);\n\t\t\t} catch (error) {\n\t\t\t\t// Inline chat errors are from the provider and have their error messages shown to the user\n\t\t\t\tif (\n\t\t\t\t\terror instanceof InlineChatError ||\n\t\t\t\t\terror?.name === InlineChatError.code\n\t\t\t\t) {\n\t\t\t\t\terrorMessage = error.message;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tcreateSessionCts.dispose();\n\t\t\tmsgListener.dispose();\n\n\t\t\tif (createSessionCts.token.isCancellationRequested) {\n\t\t\t\tif (session) {\n\t\t\t\t\tthis._inlineChatSessionService.releaseSession(session);\n\t\t\t\t}\n\t\t\t\treturn State.CANCEL;\n\t\t\t}\n\t\t}\n\n\t\tdelete options.initialRange;\n\t\tdelete options.existingSession;\n\n\t\tif (!session) {\n\t\t\tMessageController.get(this._editor)?.showMessage(\n\t\t\t\terrorMessage,\n\t\t\t\twidgetPosition,\n\t\t\t);\n\t\t\tthis._log(\"Failed to start editor chat\");\n\t\t\treturn State.CANCEL;\n\t\t}\n\n\t\tawait session.chatModel.waitForInitialization();\n\n\t\t// create a new strategy\n\t\tswitch (session.editMode) {\n\t\t\tcase EditMode.Preview:\n\t\t\t\tthis._strategy = this._instaService.createInstance(\n\t\t\t\t\tPreviewStrategy,\n\t\t\t\t\tsession,\n\t\t\t\t\tthis._editor,\n\t\t\t\t\tthis._ui.value,\n\t\t\t\t);\n\t\t\t\tbreak;\n\t\t\tcase EditMode.Live:\n\t\t\tdefault:\n\t\t\t\tthis._strategy = this._instaService.createInstance(\n\t\t\t\t\tLiveStrategy,\n\t\t\t\t\tsession,\n\t\t\t\t\tthis._editor,\n\t\t\t\t\tthis._ui.value,\n\t\t\t\t\tsession.headless ||\n\t\t\t\t\t\tthis._configurationService.getValue<boolean>(\n\t\t\t\t\t\t\tInlineChatConfigKeys.ZoneToolbar,\n\t\t\t\t\t\t),\n\t\t\t\t);\n\t\t\t\tbreak;\n\t\t}\n\n\t\tthis._session = session;\n\t\treturn State.INIT_UI;\n\t}\n\n\tprivate async [State.INIT_UI](\n\t\toptions: InlineChatRunOptions,\n\t): Promise<State.WAIT_FOR_INPUT | State.SHOW_REQUEST> {\n\t\tassertType(this._session);\n\t\tassertType(this._strategy);\n\n\t\t// hide/cancel inline completions when invoking IE\n\t\tInlineCompletionsController.get(this._editor)?.hide();\n\n\t\tthis._sessionStore.clear();\n\n\t\tconst wholeRangeDecoration = this._editor.createDecorationsCollection();\n\t\tconst handleWholeRangeChange = () => {\n\t\t\tconst newDecorations =\n\t\t\t\tthis._strategy?.getWholeRangeDecoration() ?? [];\n\t\t\twholeRangeDecoration.set(newDecorations);\n\n\t\t\tthis._ctxEditing.set(\n\t\t\t\t!this._session?.wholeRange.trackedInitialRange.isEmpty(),\n\t\t\t);\n\t\t};\n\t\tthis._sessionStore.add(\n\t\t\ttoDisposable(() => {\n\t\t\t\twholeRangeDecoration.clear();\n\t\t\t\tthis._ctxEditing.reset();\n\t\t\t}),\n\t\t);\n\t\tthis._sessionStore.add(\n\t\t\tthis._session.wholeRange.onDidChange(handleWholeRangeChange),\n\t\t);\n\t\thandleWholeRangeChange();\n\n\t\tthis._ui.value.widget.setChatModel(this._session.chatModel);\n\t\tthis._updatePlaceholder();\n\n\t\tconst isModelEmpty = !this._session.chatModel.hasRequests;\n\t\tthis._ui.value.widget.updateToolbar(true);\n\t\tthis._ui.value.widget.toggleStatus(!isModelEmpty);\n\t\tthis._showWidget(this._session.headless, isModelEmpty);\n\n\t\tthis._sessionStore.add(\n\t\t\tthis._editor.onDidChangeModel((e) => {\n\t\t\t\tconst msg = this._session?.chatModel.hasRequests\n\t\t\t\t\t? Message.PAUSE_SESSION // pause when switching models/tabs and when having a previous exchange\n\t\t\t\t\t: Message.CANCEL_SESSION;\n\t\t\t\tthis._log(\"model changed, pause or cancel session\", msg, e);\n\t\t\t\tthis._messages.fire(msg);\n\t\t\t}),\n\t\t);\n\n\t\tconst altVersionNow = this._editor\n\t\t\t.getModel()\n\t\t\t?.getAlternativeVersionId();\n\n\t\tthis._sessionStore.add(\n\t\t\tthis._editor.onDidChangeModelContent((e) => {\n\t\t\t\tif (!this._session?.hunkData.ignoreTextModelNChanges) {\n\t\t\t\t\tthis._ctxUserDidEdit.set(\n\t\t\t\t\t\taltVersionNow !==\n\t\t\t\t\t\t\tthis._editor.getModel()?.getAlternativeVersionId(),\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tif (\n\t\t\t\t\tthis._session?.hunkData.ignoreTextModelNChanges ||\n\t\t\t\t\tthis._strategy?.hasFocus()\n\t\t\t\t) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst wholeRange = this._session!.wholeRange;\n\t\t\t\tlet shouldFinishSession = false;\n\t\t\t\tif (\n\t\t\t\t\tthis._configurationService.getValue<boolean>(\n\t\t\t\t\t\tInlineChatConfigKeys.FinishOnType,\n\t\t\t\t\t)\n\t\t\t\t) {\n\t\t\t\t\tfor (const { range } of e.changes) {\n\t\t\t\t\t\tshouldFinishSession = !Range.areIntersectingOrTouching(\n\t\t\t\t\t\t\trange,\n\t\t\t\t\t\t\twholeRange.value,\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthis._session!.recordExternalEditOccurred(shouldFinishSession);\n\n\t\t\t\tif (shouldFinishSession) {\n\t\t\t\t\tthis._log(\n\t\t\t\t\t\t\"text changed outside of whole range, FINISH session\",\n\t\t\t\t\t);\n\t\t\t\t\tthis.finishExistingSession();\n\t\t\t\t}\n\t\t\t}),\n\t\t);\n\n\t\tthis._sessionStore.add(\n\t\t\tthis._session.chatModel.onDidChange(async (e) => {\n\t\t\t\tif (e.kind === \"removeRequest\") {\n\t\t\t\t\t// TODO@jrieken there is still some work left for when a request \"in the middle\"\n\t\t\t\t\t// is removed. We will undo all changes till that point but not remove those\n\t\t\t\t\t// later request\n\t\t\t\t\tawait this._session!.undoChangesUntil(e.requestId);\n\t\t\t\t}\n\t\t\t}),\n\t\t);\n\n\t\t// apply edits from completed requests that haven't been applied yet\n\t\tconst editState = this._createChatTextEditGroupState();\n\t\tlet didEdit = false;\n\t\tfor (const request of this._session.chatModel.getRequests()) {\n\t\t\tif (!request.response) {\n\t\t\t\t// done when seeing the first request that is still pending (no response).\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tfor (const part of request.response.response.value) {\n\t\t\t\tif (\n\t\t\t\t\tpart.kind !== \"textEditGroup\" ||\n\t\t\t\t\t!isEqual(part.uri, this._session.textModelN.uri)\n\t\t\t\t) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tif (part.state?.applied) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tfor (const edit of part.edits) {\n\t\t\t\t\tthis._makeChanges(edit, undefined, !didEdit);\n\t\t\t\t\tdidEdit = true;\n\t\t\t\t}\n\t\t\t\tpart.state ??= editState;\n\t\t\t}\n\t\t}\n\t\tif (didEdit) {\n\t\t\tconst diff = await this._editorWorkerService.computeDiff(\n\t\t\t\tthis._session.textModel0.uri,\n\t\t\t\tthis._session.textModelN.uri,\n\t\t\t\t{\n\t\t\t\t\tcomputeMoves: false,\n\t\t\t\t\tmaxComputationTimeMs: Number.MAX_SAFE_INTEGER,\n\t\t\t\t\tignoreTrimWhitespace: false,\n\t\t\t\t},\n\t\t\t\t\"advanced\",\n\t\t\t);\n\t\t\tthis._session.wholeRange.fixup(diff?.changes ?? []);\n\t\t\tawait this._session.hunkData.recompute(editState, diff);\n\n\t\t\tthis._updateCtxResponseType();\n\t\t}\n\t\toptions.position = await this._strategy.renderChanges();\n\n\t\tif (this._session.chatModel.requestInProgress) {\n\t\t\treturn State.SHOW_REQUEST;\n\t\t} else {\n\t\t\treturn State.WAIT_FOR_INPUT;\n\t\t}\n\t}\n\n\tprivate async [State.WAIT_FOR_INPUT](\n\t\toptions: InlineChatRunOptions,\n\t): Promise<\n\t\t| State.ACCEPT\n\t\t| State.CANCEL\n\t\t| State.PAUSE\n\t\t| State.WAIT_FOR_INPUT\n\t\t| State.SHOW_REQUEST\n\t> {\n\t\tassertType(this._session);\n\t\tassertType(this._strategy);\n\n\t\tthis._updatePlaceholder();\n\n\t\tif (options.message) {\n\t\t\tthis.updateInput(options.message);\n\t\t\taria.alert(options.message);\n\t\t\tdelete options.message;\n\t\t\tthis._showWidget(this._session.headless, false);\n\t\t}\n\n\t\tlet message = Message.NONE;\n\t\tlet request: IChatRequestModel | undefined;\n\n\t\tconst barrier = new Barrier();\n\t\tconst store = new DisposableStore();\n\t\tstore.add(\n\t\t\tthis._session.chatModel.onDidChange((e) => {\n\t\t\t\tif (e.kind === \"addRequest\") {\n\t\t\t\t\trequest = e.request;\n\t\t\t\t\tmessage = Message.ACCEPT_INPUT;\n\t\t\t\t\tbarrier.open();\n\t\t\t\t}\n\t\t\t}),\n\t\t);\n\t\tstore.add(this._strategy.onDidAccept(() => this.acceptSession()));\n\t\tstore.add(this._strategy.onDidDiscard(() => this.cancelSession()));\n\t\tstore.add(\n\t\t\tEvent.once(this._messages.event)((m) => {\n\t\t\t\tthis._log(\"state=_waitForInput) message received\", m);\n\t\t\t\tmessage = m;\n\t\t\t\tbarrier.open();\n\t\t\t}),\n\t\t);\n\n\t\tif (options.autoSend) {\n\t\t\tdelete options.autoSend;\n\t\t\tthis._showWidget(this._session.headless, false);\n\t\t\tthis._ui.value.widget.chatWidget.acceptInput();\n\t\t}\n\n\t\tawait barrier.wait();\n\t\tstore.dispose();\n\n\t\tif (message & (Message.CANCEL_INPUT | Message.CANCEL_SESSION)) {\n\t\t\treturn State.CANCEL;\n\t\t}\n\n\t\tif (message & Message.PAUSE_SESSION) {\n\t\t\treturn State.PAUSE;\n\t\t}\n\n\t\tif (message & Message.ACCEPT_SESSION) {\n\t\t\tthis._ui.value.widget.selectAll(false);\n\t\t\treturn State.ACCEPT;\n\t\t}\n\n\t\tif (!request?.message.text) {\n\t\t\treturn State.WAIT_FOR_INPUT;\n\t\t}\n\n\t\treturn State.SHOW_REQUEST;\n\t}\n\n\tprivate async [State.SHOW_REQUEST](\n\t\toptions: InlineChatRunOptions,\n\t): Promise<\n\t\tState.WAIT_FOR_INPUT | State.CANCEL | State.PAUSE | State.ACCEPT\n\t> {\n\t\tassertType(this._session);\n\t\tassertType(this._strategy);\n\t\tassertType(this._session.chatModel.requestInProgress);\n\n\t\tthis._ctxRequestInProgress.set(true);\n\n\t\tconst { chatModel } = this._session;\n\t\tconst request = chatModel.lastRequest;\n\n\t\tassertType(request);\n\t\tassertType(request.response);\n\n\t\tthis._showWidget(this._session.headless, false);\n\t\tthis._ui.value.widget.selectAll(false);\n\t\tthis._ui.value.widget.updateInfo(\"\");\n\t\tthis._ui.value.widget.toggleStatus(true);\n\n\t\tconst { response } = request;\n\t\tconst responsePromise = new DeferredPromise<void>();\n\n\t\tconst store = new DisposableStore();\n\n\t\tconst progressiveEditsCts = store.add(new CancellationTokenSource());\n\t\tconst progressiveEditsAvgDuration = new MovingAverage();\n\t\tconst progressiveEditsClock = StopWatch.create();\n\t\tconst progressiveEditsQueue = new Queue();\n\n\t\tlet next:\n\t\t\t| State.WAIT_FOR_INPUT\n\t\t\t| State.SHOW_REQUEST\n\t\t\t| State.CANCEL\n\t\t\t| State.PAUSE\n\t\t\t| State.ACCEPT = State.WAIT_FOR_INPUT;\n\n\t\tstore.add(\n\t\t\tEvent.once(this._messages.event)((message) => {\n\t\t\t\tthis._log(\"state=_makeRequest) message received\", message);\n\t\t\t\tthis._chatService.cancelCurrentRequestForSession(\n\t\t\t\t\tchatModel.sessionId,\n\t\t\t\t);\n\t\t\t\tif (message & Message.CANCEL_SESSION) {\n\t\t\t\t\tnext = State.CANCEL;\n\t\t\t\t} else if (message & Message.PAUSE_SESSION) {\n\t\t\t\t\tnext = State.PAUSE;\n\t\t\t\t} else if (message & Message.ACCEPT_SESSION) {\n\t\t\t\t\tnext = State.ACCEPT;\n\t\t\t\t}\n\t\t\t}),\n\t\t);\n\n\t\tstore.add(\n\t\t\tchatModel.onDidChange(async (e) => {\n\t\t\t\tif (e.kind === \"removeRequest\" && e.requestId === request.id) {\n\t\t\t\t\tprogressiveEditsCts.cancel();\n\t\t\t\t\tresponsePromise.complete();\n\t\t\t\t\tif (e.reason === ChatRequestRemovalReason.Resend) {\n\t\t\t\t\t\tnext = State.SHOW_REQUEST;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tnext = State.CANCEL;\n\t\t\t\t\t}\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif (e.kind === \"move\") {\n\t\t\t\t\tassertType(this._session);\n\t\t\t\t\tconst log: typeof this._log = (\n\t\t\t\t\t\tmsg: string,\n\t\t\t\t\t\t...args: any[]\n\t\t\t\t\t) =>\n\t\t\t\t\t\tthis._log(\n\t\t\t\t\t\t\t\"state=_showRequest) moving inline chat\",\n\t\t\t\t\t\t\tmsg,\n\t\t\t\t\t\t\t...args,\n\t\t\t\t\t\t);\n\n\t\t\t\t\tlog(\"move was requested\", e.target, e.range);\n\n\t\t\t\t\t// if there's already a tab open for targetUri, show it and move inline chat to that tab\n\t\t\t\t\t// otherwise, open the tab to the side\n\t\t\t\t\tconst initialSelection = Selection.fromRange(\n\t\t\t\t\t\tRange.lift(e.range),\n\t\t\t\t\t\tSelectionDirection.LTR,\n\t\t\t\t\t);\n\t\t\t\t\tconst editorPane = await this._editorService.openEditor(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tresource: e.target,\n\t\t\t\t\t\t\toptions: { selection: initialSelection },\n\t\t\t\t\t\t},\n\t\t\t\t\t\tSIDE_GROUP,\n\t\t\t\t\t);\n\n\t\t\t\t\tif (!editorPane) {\n\t\t\t\t\t\tlog(\"opening editor failed\");\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst newEditor = editorPane.getControl();\n\t\t\t\t\tif (!isCodeEditor(newEditor) || !newEditor.hasModel()) {\n\t\t\t\t\t\tlog(\n\t\t\t\t\t\t\t\"new editor is either missing or not a code editor or does not have a model\",\n\t\t\t\t\t\t);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (\n\t\t\t\t\t\tthis._inlineChatSessionService.getSession(\n\t\t\t\t\t\t\tnewEditor,\n\t\t\t\t\t\t\te.target,\n\t\t\t\t\t\t)\n\t\t\t\t\t) {\n\t\t\t\t\t\tlog(\"new editor ALREADY has a session\");\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst newSession =\n\t\t\t\t\t\tawait this._inlineChatSessionService.createSession(\n\t\t\t\t\t\t\tnewEditor,\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\teditMode: this._getMode(),\n\t\t\t\t\t\t\t\tsession: this._session,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tCancellationToken.None,\n\t\t\t\t\t\t); // TODO@ulugbekna: add proper cancellation?\n\n\t\t\t\t\tInlineChatController.get(newEditor)?.run({\n\t\t\t\t\t\texistingSession: newSession,\n\t\t\t\t\t});\n\n\t\t\t\t\tnext = State.CANCEL;\n\t\t\t\t\tresponsePromise.complete();\n\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}),\n\t\t);\n\n\t\t// cancel the request when the user types\n\t\tstore.add(\n\t\t\tthis._ui.value.widget.chatWidget.inputEditor.onDidChangeModelContent(\n\t\t\t\t() => {\n\t\t\t\t\tthis._chatService.cancelCurrentRequestForSession(\n\t\t\t\t\t\tchatModel.sessionId,\n\t\t\t\t\t);\n\t\t\t\t},\n\t\t\t),\n\t\t);\n\n\t\tlet lastLength = 0;\n\t\tlet isFirstChange = true;\n\n\t\tconst editState = this._createChatTextEditGroupState();\n\t\tlet localEditGroup: IChatTextEditGroup | undefined;\n\n\t\t// apply edits\n\t\tconst handleResponse = () => {\n\t\t\tthis._updateCtxResponseType();\n\n\t\t\tif (!localEditGroup) {\n\t\t\t\tlocalEditGroup = <IChatTextEditGroup | undefined>(\n\t\t\t\t\tresponse.response.value.find(\n\t\t\t\t\t\t(part) =>\n\t\t\t\t\t\t\tpart.kind === \"textEditGroup\" &&\n\t\t\t\t\t\t\tisEqual(part.uri, this._session?.textModelN.uri),\n\t\t\t\t\t)\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tif (localEditGroup) {\n\t\t\t\tlocalEditGroup.state ??= editState;\n\n\t\t\t\tconst edits = localEditGroup.edits;\n\t\t\t\tconst newEdits = edits.slice(lastLength);\n\t\t\t\tif (newEdits.length > 0) {\n\t\t\t\t\tthis._log(\n\t\t\t\t\t\t`${this._session?.textModelN.uri.toString()} received ${newEdits.length} edits`,\n\t\t\t\t\t);\n\n\t\t\t\t\t// NEW changes\n\t\t\t\t\tlastLength = edits.length;\n\t\t\t\t\tprogressiveEditsAvgDuration.update(\n\t\t\t\t\t\tprogressiveEditsClock.elapsed(),\n\t\t\t\t\t);\n\t\t\t\t\tprogressiveEditsClock.reset();\n\n\t\t\t\t\tprogressiveEditsQueue.queue(async () => {\n\t\t\t\t\t\tconst startThen =\n\t\t\t\t\t\t\tthis._session!.wholeRange.value.getStartPosition();\n\n\t\t\t\t\t\t// making changes goes into a queue because otherwise the async-progress time will\n\t\t\t\t\t\t// influence the time it takes to receive the changes and progressive typing will\n\t\t\t\t\t\t// become infinitely fast\n\t\t\t\t\t\tfor (const edits of newEdits) {\n\t\t\t\t\t\t\tawait this._makeChanges(\n\t\t\t\t\t\t\t\tedits,\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tduration: progressiveEditsAvgDuration.value,\n\t\t\t\t\t\t\t\t\ttoken: progressiveEditsCts.token,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tisFirstChange,\n\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\tisFirstChange = false;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// reshow the widget if the start position changed or shows at the wrong position\n\t\t\t\t\t\tconst startNow =\n\t\t\t\t\t\t\tthis._session!.wholeRange.value.getStartPosition();\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t!startNow.equals(startThen) ||\n\t\t\t\t\t\t\t!this._ui.value.position?.equals(startNow)\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tthis._showWidget(\n\t\t\t\t\t\t\t\tthis._session!.headless,\n\t\t\t\t\t\t\t\tfalse,\n\t\t\t\t\t\t\t\tstartNow.delta(-1),\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (response.isCanceled) {\n\t\t\t\tprogressiveEditsCts.cancel();\n\t\t\t\tresponsePromise.complete();\n\t\t\t} else if (response.isComplete) {\n\t\t\t\tresponsePromise.complete();\n\t\t\t}\n\t\t};\n\t\tstore.add(response.onDidChange(handleResponse));\n\t\thandleResponse();\n\n\t\t// (1) we must wait for the request to finish\n\t\t// (2) we must wait for all edits that came in via progress to complete\n\t\tawait responsePromise.p;\n\t\tawait progressiveEditsQueue.whenIdle();\n\n\t\tif (response.result?.errorDetails) {\n\t\t\tawait this._session.undoChangesUntil(response.requestId);\n\t\t}\n\n\t\tstore.dispose();\n\n\t\tconst diff = await this._editorWorkerService.computeDiff(\n\t\t\tthis._session.textModel0.uri,\n\t\t\tthis._session.textModelN.uri,\n\t\t\t{\n\t\t\t\tcomputeMoves: false,\n\t\t\t\tmaxComputationTimeMs: Number.MAX_SAFE_INTEGER,\n\t\t\t\tignoreTrimWhitespace: false,\n\t\t\t},\n\t\t\t\"advanced\",\n\t\t);\n\t\tthis._session.wholeRange.fixup(diff?.changes ?? []);\n\t\tawait this._session.hunkData.recompute(editState, diff);\n\n\t\tthis._ctxRequestInProgress.set(false);\n\n\t\tlet newPosition: Position | undefined;\n\n\t\tif (response.result?.errorDetails) {\n\t\t\t// error -> no message, errors are shown with the request\n\t\t} else if (response.response.value.length === 0) {\n\t\t\t// empty -> show message\n\t\t\tconst status = localize(\n\t\t\t\t\"empty\",\n\t\t\t\t\"No results, please refine your input and try again\",\n\t\t\t);\n\t\t\tthis._ui.value.widget.updateStatus(status, { classes: [\"warn\"] });\n\t\t} else {\n\t\t\t// real response -> no message\n\t\t\tthis._ui.value.widget.updateStatus(\"\");\n\t\t}\n\n\t\tconst position = await this._strategy.renderChanges();\n\t\tif (position) {\n\t\t\t// if the selection doesn't start far off we keep the widget at its current position\n\t\t\t// because it makes reading this nicer\n\t\t\tconst selection = this._editor.getSelection();\n\t\t\tif (selection?.containsPosition(position)) {\n\t\t\t\tif (position.lineNumber - selection.startLineNumber > 8) {\n\t\t\t\t\tnewPosition = position;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tnewPosition = position;\n\t\t\t}\n\t\t}\n\t\tthis._showWidget(this._session.headless, false, newPosition);\n\n\t\treturn next;\n\t}\n\n\tprivate async [State.PAUSE]() {\n\t\tthis._resetWidget();\n\n\t\tthis._strategy?.dispose?.();\n\t\tthis._session = undefined;\n\t}\n\n\tprivate async [State.ACCEPT]() {\n\t\tassertType(this._session);\n\t\tassertType(this._strategy);\n\t\tthis._sessionStore.clear();\n\n\t\ttry {\n\t\t\tawait this._strategy.apply();\n\t\t} catch (err) {\n\t\t\tthis._dialogService.error(\n\t\t\t\tlocalize(\n\t\t\t\t\t\"err.apply\",\n\t\t\t\t\t\"Failed to apply changes.\",\n\t\t\t\t\ttoErrorMessage(err),\n\t\t\t\t),\n\t\t\t);\n\t\t\tthis._log(\"FAILED to apply changes\");\n\t\t\tthis._log(err);\n\t\t}\n\n\t\tthis._inlineChatSessionService.releaseSession(this._session);\n\n\t\tthis._resetWidget();\n\n\t\tthis._strategy?.dispose();\n\t\tthis._strategy = undefined;\n\t\tthis._session = undefined;\n\t}\n\n\tprivate async [State.CANCEL]() {\n\t\tif (this._session) {\n\t\t\t// assertType(this._session);\n\t\t\tassertType(this._strategy);\n\t\t\tthis._sessionStore.clear();\n\n\t\t\t// only stash sessions that were not unstashed, not \"empty\", and not interacted with\n\t\t\tconst shouldStash =\n\t\t\t\t!this._session.isUnstashed &&\n\t\t\t\tthis._session.chatModel.hasRequests &&\n\t\t\t\tthis._session.hunkData.size === this._session.hunkData.pending;\n\t\t\tlet undoCancelEdits: IValidEditOperation[] = [];\n\t\t\ttry {\n\t\t\t\tundoCancelEdits = this._strategy.cancel();\n\t\t\t} catch (err) {\n\t\t\t\tthis._dialogService.error(\n\t\t\t\t\tlocalize(\n\t\t\t\t\t\t\"err.discard\",\n\t\t\t\t\t\t\"Failed to discard changes.\",\n\t\t\t\t\t\ttoErrorMessage(err),\n\t\t\t\t\t),\n\t\t\t\t);\n\t\t\t\tthis._log(\"FAILED to discard changes\");\n\t\t\t\tthis._log(err);\n\t\t\t}\n\n\t\t\tthis._stashedSession.clear();\n\t\t\tif (shouldStash) {\n\t\t\t\tthis._stashedSession.value =\n\t\t\t\t\tthis._inlineChatSessionService.stashSession(\n\t\t\t\t\t\tthis._session,\n\t\t\t\t\t\tthis._editor,\n\t\t\t\t\t\tundoCancelEdits,\n\t\t\t\t\t);\n\t\t\t} else {\n\t\t\t\tthis._inlineChatSessionService.releaseSession(this._session);\n\t\t\t}\n\t\t}\n\n\t\tthis._resetWidget();\n\n\t\tthis._strategy?.dispose();\n\t\tthis._strategy = undefined;\n\t\tthis._session = undefined;\n\t}\n\n\t// ----\n\n\tprivate _showWidget(\n\t\theadless = false,\n\t\tinitialRender = false,\n\t\tposition?: Position,\n\t) {\n\t\tassertType(this._editor.hasModel());\n\t\tthis._ctxVisible.set(true);\n\n\t\tlet widgetPosition: Position;\n\t\tif (position) {\n\t\t\t// explicit position wins\n\t\t\twidgetPosition = position;\n\t\t} else if (this._ui.rawValue?.position) {\n\t\t\t// already showing - special case of line 1\n\t\t\tif (this._ui.rawValue?.position.lineNumber === 1) {\n\t\t\t\twidgetPosition = this._ui.rawValue?.position.delta(-1);\n\t\t\t} else {\n\t\t\t\twidgetPosition = this._ui.rawValue?.position;\n\t\t\t}\n\t\t} else {\n\t\t\t// default to ABOVE the selection\n\t\t\twidgetPosition = this._editor\n\t\t\t\t.getSelection()\n\t\t\t\t.getStartPosition()\n\t\t\t\t.delta(-1);\n\t\t}\n\n\t\tif (\n\t\t\tthis._session &&\n\t\t\t!position &&\n\t\t\t(this._session.hasChangedText ||\n\t\t\t\tthis._session.chatModel.hasRequests)\n\t\t) {\n\t\t\twidgetPosition = this._session.wholeRange.trackedInitialRange\n\t\t\t\t.getStartPosition()\n\t\t\t\t.delta(-1);\n\t\t}\n\n\t\tif (!headless) {\n\t\t\tif (this._ui.rawValue?.position) {\n\t\t\t\tthis._ui.value.updatePositionAndHeight(widgetPosition);\n\t\t\t} else {\n\t\t\t\tthis._ui.value.show(widgetPosition);\n\t\t\t}\n\t\t}\n\n\t\treturn widgetPosition;\n\t}\n\n\tprivate _resetWidget() {\n\t\tthis._sessionStore.clear();\n\t\tthis._ctxVisible.reset();\n\t\tthis._ctxUserDidEdit.reset();\n\n\t\tthis._ui.rawValue?.hide();\n\n\t\t// Return focus to the editor only if the current focus is within the editor widget\n\t\tif (this._editor.hasWidgetFocus()) {\n\t\t\tthis._editor.focus();\n\t\t}\n\t}\n\n\tprivate _updateCtxResponseType(): void {\n\t\tif (!this._session) {\n\t\t\tthis._ctxResponseType.set(InlineChatResponseType.None);\n\t\t\treturn;\n\t\t}\n\n\t\tconst hasLocalEdit = (response: IResponse): boolean => {\n\t\t\treturn response.value.some(\n\t\t\t\t(part) =>\n\t\t\t\t\tpart.kind === \"textEditGroup\" &&\n\t\t\t\t\tisEqual(part.uri, this._session?.textModelN.uri),\n\t\t\t);\n\t\t};\n\n\t\tlet responseType = InlineChatResponseType.None;\n\t\tfor (const request of this._session.chatModel.getRequests()) {\n\t\t\tif (!request.response) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tresponseType = InlineChatResponseType.Messages;\n\t\t\tif (hasLocalEdit(request.response.response)) {\n\t\t\t\tresponseType = InlineChatResponseType.MessagesAndEdits;\n\t\t\t\tbreak; // no need to check further\n\t\t\t}\n\t\t}\n\t\tthis._ctxResponseType.set(responseType);\n\t\tthis._ctxResponse.set(responseType !== InlineChatResponseType.None);\n\t}\n\n\tprivate _createChatTextEditGroupState(): IChatTextEditGroupState {\n\t\tassertType(this._session);\n\n\t\tconst sha1 = new DefaultModelSHA1Computer();\n\t\tconst textModel0Sha1 = sha1.canComputeSHA1(this._session.textModel0)\n\t\t\t? sha1.computeSHA1(this._session.textModel0)\n\t\t\t: generateUuid();\n\n\t\treturn {\n\t\t\tsha1: textModel0Sha1,\n\t\t\tapplied: 0,\n\t\t};\n\t}\n\n\tprivate async _makeChanges(\n\t\tedits: TextEdit[],\n\t\topts: ProgressingEditsOptions | undefined,\n\t\tundoStopBefore: boolean,\n\t) {\n\t\tassertType(this._session);\n\t\tassertType(this._strategy);\n\n\t\tconst moreMinimalEdits =\n\t\t\tawait this._editorWorkerService.computeMoreMinimalEdits(\n\t\t\t\tthis._session.textModelN.uri,\n\t\t\t\tedits,\n\t\t\t);\n\t\tthis._log(\n\t\t\t\"edits from PROVIDER and after making them MORE MINIMAL\",\n\t\t\tthis._session.agent.extensionId,\n\t\t\tedits,\n\t\t\tmoreMinimalEdits,\n\t\t);\n\n\t\tif (moreMinimalEdits?.length === 0) {\n\t\t\t// nothing left to do\n\t\t\treturn;\n\t\t}\n\n\t\tconst actualEdits =\n\t\t\t!opts && moreMinimalEdits ? moreMinimalEdits : edits;\n\t\tconst editOperations = actualEdits.map(TextEdit.asEditOperation);\n\n\t\tconst editsObserver: IEditObserver = {\n\t\t\tstart: () =>\n\t\t\t\t(this._session!.hunkData.ignoreTextModelNChanges = true),\n\t\t\tstop: () =>\n\t\t\t\t(this._session!.hunkData.ignoreTextModelNChanges = false),\n\t\t};\n\n\t\tthis._inlineChatSavingService.markChanged(this._session);\n\t\tif (opts) {\n\t\t\tawait this._strategy.makeProgressiveChanges(\n\t\t\t\teditOperations,\n\t\t\t\teditsObserver,\n\t\t\t\topts,\n\t\t\t\tundoStopBefore,\n\t\t\t);\n\t\t} else {\n\t\t\tawait this._strategy.makeChanges(\n\t\t\t\teditOperations,\n\t\t\t\teditsObserver,\n\t\t\t\tundoStopBefore,\n\t\t\t);\n\t\t}\n\t}\n\n\tprivate _forcedPlaceholder: string | undefined = undefined;\n\n\tprivate _updatePlaceholder(): void {\n\t\tthis._ui.value.widget.placeholder = this._getPlaceholderText();\n\t}\n\n\tprivate _getPlaceholderText(): string {\n\t\treturn (\n\t\t\tthis._forcedPlaceholder ?? this._session?.agent.description ?? \"\"\n\t\t);\n\t}\n\n\t// ---- controller API\n\n\tshowSaveHint(): void {\n\t\tif (!this._session) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst status = localize(\n\t\t\t\"savehint\",\n\t\t\t\"Accept or discard changes to continue saving.\",\n\t\t);\n\t\tthis._ui.value.widget.updateStatus(status, { classes: [\"warn\"] });\n\n\t\tif (this._ui.value.position) {\n\t\t\tthis._editor.revealLineInCenterIfOutsideViewport(\n\t\t\t\tthis._ui.value.position.lineNumber,\n\t\t\t);\n\t\t} else {\n\t\t\tconst hunk = this._session.hunkData\n\t\t\t\t.getInfo()\n\t\t\t\t.find((info) => info.getState() === HunkState.Pending);\n\t\t\tif (hunk) {\n\t\t\t\tthis._editor.revealLineInCenterIfOutsideViewport(\n\t\t\t\t\thunk.getRangesN()[0].startLineNumber,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t}\n\n\tacceptInput() {\n\t\treturn this.chatWidget.acceptInput();\n\t}\n\n\tupdateInput(text: string, selectAll = true): void {\n\t\tthis._ui.value.widget.chatWidget.setInput(text);\n\t\tif (selectAll) {\n\t\t\tconst newSelection = new Selection(\n\t\t\t\t1,\n\t\t\t\t1,\n\t\t\t\tNumber.MAX_SAFE_INTEGER,\n\t\t\t\t1,\n\t\t\t);\n\t\t\tthis._ui.value.widget.chatWidget.inputEditor.setSelection(\n\t\t\t\tnewSelection,\n\t\t\t);\n\t\t}\n\t}\n\n\tcancelCurrentRequest(): void {\n\t\tthis._messages.fire(Message.CANCEL_INPUT | Message.CANCEL_REQUEST);\n\t}\n\n\tarrowOut(up: boolean): void {\n\t\tif (this._ui.value.position && this._editor.hasModel()) {\n\t\t\tconst { column } = this._editor.getPosition();\n\t\t\tconst { lineNumber } = this._ui.value.position;\n\t\t\tconst newLine = up ? lineNumber : lineNumber + 1;\n\t\t\tthis._editor.setPosition({ lineNumber: newLine, column });\n\t\t\tthis._editor.focus();\n\t\t}\n\t}\n\n\tfocus(): void {\n\t\tthis._ui.value.widget.focus();\n\t}\n\n\thasFocus(): boolean {\n\t\treturn this._ui.value.widget.hasFocus();\n\t}\n\n\tasync viewInChat() {\n\t\tif (!this._strategy || !this._session) {\n\t\t\treturn;\n\t\t}\n\n\t\tlet someApplied = false;\n\t\tlet lastEdit: IChatTextEditGroup | undefined;\n\n\t\tconst uri = this._editor.getModel()?.uri;\n\t\tconst requests = this._session.chatModel.getRequests();\n\t\tfor (const request of requests) {\n\t\t\tif (!request.response) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tfor (const part of request.response.response.value) {\n\t\t\t\tif (part.kind === \"textEditGroup\" && isEqual(part.uri, uri)) {\n\t\t\t\t\t// fully or partially applied edits\n\t\t\t\t\tsomeApplied = someApplied || Boolean(part.state?.applied);\n\t\t\t\t\tlastEdit = part;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst doEdits = this._strategy.cancel();\n\n\t\tif (someApplied) {\n\t\t\tassertType(lastEdit);\n\t\t\tlastEdit.edits = [doEdits];\n\t\t\tlastEdit.state!.applied = 0;\n\t\t}\n\n\t\tawait this._instaService.invokeFunction(\n\t\t\tmoveToPanelChat,\n\t\t\tthis._session?.chatModel,\n\t\t);\n\n\t\tthis.cancelSession();\n\t}\n\n\tacceptSession(): void {\n\t\tconst response = this._session?.chatModel\n\t\t\t.getRequests()\n\t\t\t.at(-1)?.response;\n\t\tif (response) {\n\t\t\tthis._chatService.notifyUserAction({\n\t\t\t\tsessionId: response.session.sessionId,\n\t\t\t\trequestId: response.requestId,\n\t\t\t\tagentId: response.agent?.id,\n\t\t\t\tcommand: response.slashCommand?.name,\n\t\t\t\tresult: response.result,\n\t\t\t\taction: {\n\t\t\t\t\tkind: \"inlineChat\",\n\t\t\t\t\taction: \"accepted\",\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\t\tthis._messages.fire(Message.ACCEPT_SESSION);\n\t}\n\n\tacceptHunk(hunkInfo?: HunkInformation) {\n\t\treturn this._strategy?.performHunkAction(hunkInfo, HunkAction.Accept);\n\t}\n\n\tdiscardHunk(hunkInfo?: HunkInformation) {\n\t\treturn this._strategy?.performHunkAction(hunkInfo, HunkAction.Discard);\n\t}\n\n\ttoggleDiff(hunkInfo?: HunkInformation) {\n\t\treturn this._strategy?.performHunkAction(\n\t\t\thunkInfo,\n\t\t\tHunkAction.ToggleDiff,\n\t\t);\n\t}\n\n\tmoveHunk(next: boolean) {\n\t\tthis.focus();\n\t\tthis._strategy?.performHunkAction(\n\t\t\tundefined,\n\t\t\tnext ? HunkAction.MoveNext : HunkAction.MovePrev,\n\t\t);\n\t}\n\n\tasync cancelSession() {\n\t\tconst response = this._session?.chatModel.lastRequest?.response;\n\t\tif (response) {\n\t\t\tthis._chatService.notifyUserAction({\n\t\t\t\tsessionId: response.session.sessionId,\n\t\t\t\trequestId: response.requestId,\n\t\t\t\tagentId: response.agent?.id,\n\t\t\t\tcommand: response.slashCommand?.name,\n\t\t\t\tresult: response.result,\n\t\t\t\taction: {\n\t\t\t\t\tkind: \"inlineChat\",\n\t\t\t\t\taction: \"discarded\",\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\n\t\tthis._messages.fire(Message.CANCEL_SESSION);\n\t}\n\n\tfinishExistingSession(): void {\n\t\tif (this._session) {\n\t\t\tif (this._session.editMode === EditMode.Preview) {\n\t\t\t\tthis._log(\n\t\t\t\t\t\"finishing existing session, using CANCEL\",\n\t\t\t\t\tthis._session.editMode,\n\t\t\t\t);\n\t\t\t\tthis.cancelSession();\n\t\t\t} else {\n\t\t\t\tthis._log(\n\t\t\t\t\t\"finishing existing session, using APPLY\",\n\t\t\t\t\tthis._session.editMode,\n\t\t\t\t);\n\t\t\t\tthis.acceptSession();\n\t\t\t}\n\t\t}\n\t}\n\n\treportIssue() {\n\t\tconst response = this._session?.chatModel.lastRequest?.response;\n\t\tif (response) {\n\t\t\tthis._chatService.notifyUserAction({\n\t\t\t\tsessionId: response.session.sessionId,\n\t\t\t\trequestId: response.requestId,\n\t\t\t\tagentId: response.agent?.id,\n\t\t\t\tcommand: response.slashCommand?.name,\n\t\t\t\tresult: response.result,\n\t\t\t\taction: { kind: \"bug\" },\n\t\t\t});\n\t\t}\n\t}\n\n\tunstashLastSession(): Session | undefined {\n\t\tconst result = this._stashedSession.value?.unstash();\n\t\tif (result) {\n\t\t\tthis._inlineChatSavingService.markChanged(result);\n\t\t}\n\t\treturn result;\n\t}\n\n\tjoinCurrentRun(): Promise<void> | undefined {\n\t\treturn this._currentRun;\n\t}\n\n\tasync reviewEdits(\n\t\tanchor: IRange,\n\t\tstream: AsyncIterable<TextEdit>,\n\t\ttoken: CancellationToken,\n\t) {\n\t\tif (!this._editor.hasModel()) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst session = await this._inlineChatSessionService.createSession(\n\t\t\tthis._editor,\n\t\t\t{ editMode: EditMode.Live, wholeRange: anchor, headless: true },\n\t\t\ttoken,\n\t\t);\n\t\tif (!session) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst request = session.chatModel.addRequest(\n\t\t\t{ text: \"DUMMY\", parts: [] },\n\t\t\t{ variables: [] },\n\t\t\t0,\n\t\t);\n\t\tconst run = this.run({\n\t\t\texistingSession: session,\n\t\t\theadless: true,\n\t\t});\n\n\t\tawait Event.toPromise(\n\t\t\tEvent.filter(\n\t\t\t\tthis._onDidEnterState.event,\n\t\t\t\t(candidate) => candidate === State.SHOW_REQUEST,\n\t\t\t),\n\t\t);\n\n\t\tfor await (const chunk of stream) {\n\t\t\tsession.chatModel.acceptResponseProgress(request, {\n\t\t\t\tkind: \"textEdit\",\n\t\t\t\turi: this._editor.getModel()!.uri,\n\t\t\t\tedits: [chunk],\n\t\t\t});\n\t\t}\n\n\t\tif (token.isCancellationRequested) {\n\t\t\tsession.chatModel.cancelRequest(request);\n\t\t} else {\n\t\t\tsession.chatModel.completeResponse(request);\n\t\t}\n\t\tawait run;\n\t\treturn true;\n\t}\n}\n\nasync function moveToPanelChat(\n\taccessor: ServicesAccessor,\n\tmodel: ChatModel | undefined,\n) {\n\tconst viewsService = accessor.get(IViewsService);\n\tconst chatService = accessor.get(IChatService);\n\n\tconst widget = await showChatView(viewsService);\n\n\tif (widget && widget.viewModel && model) {\n\t\tfor (const request of model.getRequests().slice()) {\n\t\t\tawait chatService.adoptRequest(\n\t\t\t\twidget.viewModel.model.sessionId,\n\t\t\t\trequest,\n\t\t\t);\n\t\t}\n\t\twidget.focusLastMessage();\n\t}\n}\n"],
  "mappings": "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",
  "names": ["State", "Message", "edits"]
}
