{
  "version": 3,
  "sources": ["../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/contrib/inlineChat/browser/utils.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport {\n\tAsyncIterableSource,\n\ttype IntervalTimer,\n} from \"../../../../base/common/async.js\";\nimport type { CancellationToken } from \"../../../../base/common/cancellation.js\";\nimport { EditOperation } from \"../../../../editor/common/core/editOperation.js\";\nimport type { IRange } from \"../../../../editor/common/core/range.js\";\nimport {\n\ttype IIdentifiedSingleEditOperation,\n\ttype ITextModel,\n\ttype IValidEditOperation,\n\tTrackedRangeStickiness,\n} from \"../../../../editor/common/model.js\";\nimport type { IProgress } from \"../../../../platform/progress/common/progress.js\";\nimport { getNWords } from \"../../chat/common/chatWordCounter.js\";\nimport type { IEditObserver } from \"./inlineChatStrategies.js\";\n\n// --- async edit\n\nexport interface AsyncTextEdit {\n\treadonly range: IRange;\n\treadonly newText: AsyncIterable<string>;\n}\n\nexport async function performAsyncTextEdit(\n\tmodel: ITextModel,\n\tedit: AsyncTextEdit,\n\tprogress?: IProgress<IValidEditOperation[]>,\n\tobs?: IEditObserver,\n) {\n\tconst [id] = model.deltaDecorations(\n\t\t[],\n\t\t[\n\t\t\t{\n\t\t\t\trange: edit.range,\n\t\t\t\toptions: {\n\t\t\t\t\tdescription: \"asyncTextEdit\",\n\t\t\t\t\tstickiness:\n\t\t\t\t\t\tTrackedRangeStickiness.AlwaysGrowsWhenTypingAtEdges,\n\t\t\t\t},\n\t\t\t},\n\t\t],\n\t);\n\n\tlet first = true;\n\tfor await (const part of edit.newText) {\n\t\tif (model.isDisposed()) {\n\t\t\tbreak;\n\t\t}\n\n\t\tconst range = model.getDecorationRange(id);\n\t\tif (!range) {\n\t\t\tthrow new Error(\n\t\t\t\t\"FAILED to perform async replace edit because the anchor decoration was removed\",\n\t\t\t);\n\t\t}\n\n\t\tconst edit = first\n\t\t\t? EditOperation.replace(range, part) // first edit needs to override the \"anchor\"\n\t\t\t: EditOperation.insert(range.getEndPosition(), part);\n\t\tobs?.start();\n\t\tmodel.pushEditOperations(null, [edit], (undoEdits) => {\n\t\t\tprogress?.report(undoEdits);\n\t\t\treturn null;\n\t\t});\n\t\tobs?.stop();\n\t\tfirst = false;\n\t}\n}\n\nexport function asProgressiveEdit(\n\tinterval: IntervalTimer,\n\tedit: IIdentifiedSingleEditOperation,\n\twordsPerSec: number,\n\ttoken: CancellationToken,\n): AsyncTextEdit {\n\twordsPerSec = Math.max(30, wordsPerSec);\n\n\tconst stream = new AsyncIterableSource<string>();\n\tlet newText = edit.text ?? \"\";\n\n\tinterval.cancelAndSet(() => {\n\t\tif (token.isCancellationRequested) {\n\t\t\treturn;\n\t\t}\n\t\tconst r = getNWords(newText, 1);\n\t\tstream.emitOne(r.value);\n\t\tnewText = newText.substring(r.value.length);\n\t\tif (r.isFullString) {\n\t\t\tinterval.cancel();\n\t\t\tstream.resolve();\n\t\t\td.dispose();\n\t\t}\n\t}, 1000 / wordsPerSec);\n\n\t// cancel ASAP\n\tconst d = token.onCancellationRequested(() => {\n\t\tinterval.cancel();\n\t\tstream.resolve();\n\t\td.dispose();\n\t});\n\n\treturn {\n\t\trange: edit.range,\n\t\tnewText: stream.asyncIterable,\n\t};\n}\n"],
  "mappings": ";;AAKA;AAAA,EACC;AAAA,OAEM;AAEP,SAAS,qBAAqB;AAE9B;AAAA,EAIC;AAAA,OACM;AAEP,SAAS,iBAAiB;AAU1B,eAAsB,qBACrB,OACA,MACA,UACA,KACC;AACD,QAAM,CAAC,EAAE,IAAI,MAAM;AAAA,IAClB,CAAC;AAAA,IACD;AAAA,MACC;AAAA,QACC,OAAO,KAAK;AAAA,QACZ,SAAS;AAAA,UACR,aAAa;AAAA,UACb,YACC,uBAAuB;AAAA,QACzB;AAAA,MACD;AAAA,IACD;AAAA,EACD;AAEA,MAAI,QAAQ;AACZ,mBAAiB,QAAQ,KAAK,SAAS;AACtC,QAAI,MAAM,WAAW,GAAG;AACvB;AAAA,IACD;AAEA,UAAM,QAAQ,MAAM,mBAAmB,EAAE;AACzC,QAAI,CAAC,OAAO;AACX,YAAM,IAAI;AAAA,QACT;AAAA,MACD;AAAA,IACD;AAEA,UAAMA,QAAO,QACV,cAAc,QAAQ,OAAO,IAAI,IACjC,cAAc,OAAO,MAAM,eAAe,GAAG,IAAI;AACpD,SAAK,MAAM;AACX,UAAM,mBAAmB,MAAM,CAACA,KAAI,GAAG,CAAC,cAAc;AACrD,gBAAU,OAAO,SAAS;AAC1B,aAAO;AAAA,IACR,CAAC;AACD,SAAK,KAAK;AACV,YAAQ;AAAA,EACT;AACD;AA5CsB;AA8Cf,SAAS,kBACf,UACA,MACA,aACA,OACgB;AAChB,gBAAc,KAAK,IAAI,IAAI,WAAW;AAEtC,QAAM,SAAS,IAAI,oBAA4B;AAC/C,MAAI,UAAU,KAAK,QAAQ;AAE3B,WAAS,aAAa,MAAM;AAC3B,QAAI,MAAM,yBAAyB;AAClC;AAAA,IACD;AACA,UAAM,IAAI,UAAU,SAAS,CAAC;AAC9B,WAAO,QAAQ,EAAE,KAAK;AACtB,cAAU,QAAQ,UAAU,EAAE,MAAM,MAAM;AAC1C,QAAI,EAAE,cAAc;AACnB,eAAS,OAAO;AAChB,aAAO,QAAQ;AACf,QAAE,QAAQ;AAAA,IACX;AAAA,EACD,GAAG,MAAO,WAAW;AAGrB,QAAM,IAAI,MAAM,wBAAwB,MAAM;AAC7C,aAAS,OAAO;AAChB,WAAO,QAAQ;AACf,MAAE,QAAQ;AAAA,EACX,CAAC;AAED,SAAO;AAAA,IACN,OAAO,KAAK;AAAA,IACZ,SAAS,OAAO;AAAA,EACjB;AACD;AApCgB;",
  "names": ["edit"]
}
