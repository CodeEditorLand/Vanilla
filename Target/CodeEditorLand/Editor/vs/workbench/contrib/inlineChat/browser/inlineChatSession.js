var y=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var f=(d,e,i,t)=>{for(var o=t>1?void 0:t?N(e,i):e,n=d.length-1,s;n>=0;n--)(s=d[n])&&(o=(t?s(e,i,o):s(o))||o);return t&&o&&y(e,i,o),o},p=(d,e)=>(i,t)=>e(i,t,d);import"../../../../base/common/uri.js";import{Emitter as v,Event as x}from"../../../../base/common/event.js";import{TrackedRangeStickiness as C}from"../../../../editor/common/model.js";import{CTX_INLINE_CHAT_HAS_STASHED_SESSION as T}from"../common/inlineChat.js";import{Range as l}from"../../../../editor/common/core/range.js";import{ModelDecorationOptions as I}from"../../../../editor/common/model/textModel.js";import{EditOperation as _}from"../../../../editor/common/core/editOperation.js";import{DetailedLineRangeMapping as b}from"../../../../editor/common/diff/rangeMapping.js";import{IInlineChatSessionService as k}from"./inlineChatSessionService.js";import"../../../../editor/common/core/lineRange.js";import{IEditorWorkerService as A}from"../../../../editor/common/services/editorWorker.js";import{coalesceInPlace as D}from"../../../../base/common/arrays.js";import{Iterable as L}from"../../../../base/common/iterator.js";import"../../../../editor/common/textModelEvents.js";import{DisposableStore as H}from"../../../../base/common/lifecycle.js";import"../../../../editor/browser/editorBrowser.js";import{IContextKeyService as w}from"../../../../platform/contextkey/common/contextkey.js";import{ILogService as O}from"../../../../platform/log/common/log.js";import"../../chat/common/chatModel.js";import{ExtensionIdentifier as U}from"../../../../platform/extensions/common/extensions.js";import"../../chat/common/chatAgents.js";import"../../../../editor/common/diff/documentDiffProvider.js";class M{constructor(e,i){this._textModel=e;this._decorationIds=e.deltaDecorations([],[{range:i,options:M._options}])}static _options=I.register({description:"inlineChat/session/wholeRange"});_onDidChange=new v;onDidChange=this._onDidChange.event;_decorationIds=[];dispose(){this._onDidChange.dispose(),this._textModel.isDisposed()||this._textModel.deltaDecorations(this._decorationIds,[])}fixup(e){const i=[];for(const{modified:s}of e){const a=s.isEmpty?new l(s.startLineNumber,1,s.startLineNumber,this._textModel.getLineLength(s.startLineNumber)):new l(s.startLineNumber,1,s.endLineNumberExclusive-1,this._textModel.getLineLength(s.endLineNumberExclusive-1));i.push({range:a,options:M._options})}const[t,...o]=this._decorationIds,n=this._textModel.deltaDecorations(o,i);this._decorationIds=[t].concat(n),this._onDidChange.fire(this)}get trackedInitialRange(){const[e]=this._decorationIds;return this._textModel.getDecorationRange(e)??new l(1,1,1,1)}get value(){let e;for(const i of this._decorationIds){const t=this._textModel.getDecorationRange(i);t&&(e?e=l.plusRange(e,t):e=t)}return e}}class be{constructor(e,i,t,o,n,s,a,r,h,g){this.editMode=e;this.headless=i;this.targetUri=t;this.textModel0=o;this.textModelN=n;this.agent=s;this.wholeRange=a;this.hunkData=r;this.chatModel=h;this._teldata={extension:U.toKey(s.extensionId),startTime:this._startTime.toISOString(),endTime:this._startTime.toISOString(),edits:0,finishedByEdit:!1,rounds:"",undos:"",editMode:e,unstashed:0,acceptedHunks:0,discardedHunks:0,responseTypes:""},g&&(this._versionByRequest=new Map(g))}_isUnstashed=!1;_startTime=new Date;_teldata;_versionByRequest=new Map;get isUnstashed(){return this._isUnstashed}markUnstashed(){this._teldata.unstashed+=1,this._isUnstashed=!0}markModelVersion(e){this._versionByRequest.set(e.id,this.textModelN.getAlternativeVersionId())}get versionsByRequest(){return Array.from(this._versionByRequest)}async undoChangesUntil(e){const i=this._versionByRequest.get(e);if(i===void 0)return!1;this.hunkData.ignoreTextModelNChanges=!0;try{for(;i<this.textModelN.getAlternativeVersionId()&&this.textModelN.canUndo();)await this.textModelN.undo()}finally{this.hunkData.ignoreTextModelNChanges=!1}return!0}get hasChangedText(){return!this.textModel0.equalsTextBuffer(this.textModelN.getTextBuffer())}asChangedText(e){if(e.length===0)return;let i=Number.MAX_VALUE,t=Number.MIN_VALUE;for(const o of e)i=Math.min(i,o.modified.startLineNumber),t=Math.max(t,o.modified.endLineNumberExclusive);return this.textModelN.getValueInRange(new l(i,1,t,Number.MAX_VALUE))}recordExternalEditOccurred(e){this._teldata.edits+=1,this._teldata.finishedByEdit=e}asTelemetryData(){for(const e of this.hunkData.getInfo())switch(e.getState()){case 1:this._teldata.acceptedHunks+=1;break;case 2:this._teldata.discardedHunks+=1;break}return this._teldata.endTime=new Date().toISOString(),this._teldata}}let m=class{constructor(e,i,t,o,n,s){this._undoCancelEdits=t;this._sessionService=n;this._logService=s;this._ctxHasStashedSession=T.bindTo(o),this._session=i,this._ctxHasStashedSession.set(!0),this._listener=x.once(x.any(e.onDidChangeCursorSelection,e.onDidChangeModelContent,e.onDidChangeModel,e.onDidBlurEditorWidget))(()=>{this._session=void 0,this._sessionService.releaseSession(i),this._ctxHasStashedSession.reset()})}_listener;_ctxHasStashedSession;_session;dispose(){this._listener.dispose(),this._ctxHasStashedSession.reset(),this._session&&this._sessionService.releaseSession(this._session)}unstash(){if(!this._session)return;this._listener.dispose();const e=this._session;return e.markUnstashed(),e.hunkData.ignoreTextModelNChanges=!0,e.textModelN.pushEditOperations(null,this._undoCancelEdits,()=>null),e.hunkData.ignoreTextModelNChanges=!1,this._session=void 0,this._logService.debug("[IE] Unstashed session"),e}};m=f([p(3,w),p(4,k),p(5,O)],m);function R(d,e){return d.isEmpty?new l(d.startLineNumber,1,d.startLineNumber,Number.MAX_SAFE_INTEGER):new l(d.startLineNumber,1,d.endLineNumberExclusive-1,Number.MAX_SAFE_INTEGER)}let c=class{constructor(e,i,t){this._editorWorkerService=e;this._textModel0=i;this._textModelN=t;this._store.add(t.onDidChangeContent(o=>{this._ignoreChanges||this._mirrorChanges(o)}))}static _HUNK_TRACKED_RANGE=I.register({description:"inline-chat-hunk-tracked-range",stickiness:C.AlwaysGrowsWhenTypingAtEdges});static _HUNK_THRESHOLD=8;_store=new H;_data=new Map;_ignoreChanges=!1;dispose(){this._textModelN.isDisposed()||this._textModelN.changeDecorations(e=>{for(const{textModelNDecorations:i}of this._data.values())i.forEach(e.removeDecoration,e)}),this._textModel0.isDisposed()||this._textModel0.changeDecorations(e=>{for(const{textModel0Decorations:i}of this._data.values())i.forEach(e.removeDecoration,e)}),this._data.clear(),this._store.dispose()}set ignoreTextModelNChanges(e){this._ignoreChanges=e}get ignoreTextModelNChanges(){return this._ignoreChanges}_mirrorChanges(e){const i=[],t=[];for(const n of this._data.values())if(n.state===0)for(let s=1;s<n.textModelNDecorations.length;s++){const a=this._textModelN.getDecorationRange(n.textModelNDecorations[s]),r=this._textModel0.getDecorationRange(n.textModel0Decorations[s]);a&&r&&i.push({rangeN:a,range0:r,markAccepted:()=>n.state=1})}else if(n.state===1)for(let s=1;s<n.textModel0Decorations.length;s++){const a=this._textModel0.getDecorationRange(n.textModel0Decorations[s]);a&&t.push(a)}i.sort((n,s)=>l.compareRangesUsingStarts(n.rangeN,s.rangeN)),t.sort(l.compareRangesUsingStarts);const o=[];for(const n of e.changes){let s=!1,a=0;for(const u of i)if(u.rangeN.getEndPosition().isBefore(l.getStartPosition(n.range)))a+=this._textModelN.getValueLengthInRange(u.rangeN),a-=this._textModel0.getValueLengthInRange(u.range0);else if(l.areIntersectingOrTouching(u.rangeN,n.range)){u.markAccepted(),s=!0;break}else break;if(s)continue;const r=n.rangeOffset-a,h=this._textModel0.getPositionAt(r);let g=0;for(const u of t)u.getEndPosition().isBefore(h)&&(g+=this._textModel0.getValueLengthInRange(u));const E=this._textModel0.getPositionAt(r+g),S=this._textModel0.getPositionAt(r+g+n.rangeLength);o.push(_.replace(l.fromPositions(E,S),n.text))}this._textModel0.pushEditOperations(null,o,()=>null)}async recompute(e,i){i??=await this._editorWorkerService.computeDiff(this._textModel0.uri,this._textModelN.uri,{ignoreTrimWhitespace:!1,maxComputationTimeMs:Number.MAX_SAFE_INTEGER,computeMoves:!1},"advanced");let t=[];if(i&&i.changes.length>0){t=[i.changes[0]];for(let n=1;n<i.changes.length;n++){const s=t[t.length-1],a=i.changes[n];a.modified.startLineNumber-s.modified.endLineNumberExclusive<=c._HUNK_THRESHOLD?t[t.length-1]=new b(s.original.join(a.original),s.modified.join(a.modified),(s.innerChanges??[]).concat(a.innerChanges??[])):t.push(a)}}const o=t.map(n=>new P(n.original,n.modified,n.innerChanges??[]));e.applied=o.length,this._textModelN.changeDecorations(n=>{this._textModel0.changeDecorations(s=>{for(const{textModelNDecorations:a,textModel0Decorations:r}of this._data.values())a.forEach(n.removeDecoration,n),r.forEach(s.removeDecoration,s);this._data.clear();for(const a of o){const r=[],h=[];r.push(n.addDecoration(R(a.modified,this._textModelN),c._HUNK_TRACKED_RANGE)),h.push(s.addDecoration(R(a.original,this._textModel0),c._HUNK_TRACKED_RANGE));for(const g of a.changes)r.push(n.addDecoration(g.modifiedRange,c._HUNK_TRACKED_RANGE)),h.push(s.addDecoration(g.originalRange,c._HUNK_TRACKED_RANGE));this._data.set(a,{editState:e,textModelNDecorations:r,textModel0Decorations:h,state:0})}})})}get size(){return this._data.size}get pending(){return L.reduce(this._data.values(),(e,{state:i})=>e+(i===0?1:0),0)}_discardEdits(e){const i=[],t=e.getRangesN(),o=e.getRanges0();for(let n=1;n<t.length;n++){const s=t[n],a=this._textModel0.getValueInRange(o[n]);i.push(_.replace(s,a))}return i}discardAll(){const e=[];for(const t of this.getInfo())t.getState()===0&&e.push(this._discardEdits(t));const i=[];return this._textModelN.pushEditOperations(null,e.flat(),t=>(i.push(t),null)),i.flat()}getInfo(){const e=[];for(const[i,t]of this._data.entries()){const o={getState:()=>t.state,isInsertion:()=>i.original.isEmpty,getRangesN:()=>{const n=t.textModelNDecorations.map(s=>this._textModelN.getDecorationRange(s));return D(n),n},getRanges0:()=>{const n=t.textModel0Decorations.map(s=>this._textModel0.getDecorationRange(s));return D(n),n},discardChanges:()=>{if(t.state===0){const n=this._discardEdits(o);this._textModelN.pushEditOperations(null,n,()=>null),t.state=2,t.editState.applied>0&&(t.editState.applied-=1)}},acceptChanges:()=>{if(t.state===0){const n=[],s=o.getRangesN(),a=o.getRanges0();for(let r=1;r<a.length;r++){const h=a[r],g=this._textModelN.getValueInRange(s[r]);n.push(_.replace(h,g))}this._textModel0.pushEditOperations(null,n,()=>null),t.state=1}}};e.push(o)}return e}};c=f([p(0,A)],c);class P{constructor(e,i,t){this.original=e;this.modified=i;this.changes=t}}var V=(t=>(t[t.Pending=0]="Pending",t[t.Accepted=1]="Accepted",t[t.Rejected=2]="Rejected",t))(V||{});export{c as HunkData,V as HunkState,be as Session,M as SessionWholeRange,m as StashedSession};
