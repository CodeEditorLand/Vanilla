var E=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var f=(d,e,n,t)=>{for(var o=t>1?void 0:t?N(e,n):e,i=d.length-1,s;i>=0;i--)(s=d[i])&&(o=(t?s(e,n,o):s(o))||o);return t&&o&&E(e,n,o),o},p=(d,e)=>(n,t)=>e(n,t,d);import{coalesceInPlace as x}from"../../../../../vs/base/common/arrays.js";import{Emitter as C,Event as I}from"../../../../../vs/base/common/event.js";import{Iterable as b}from"../../../../../vs/base/common/iterator.js";import{DisposableStore as T}from"../../../../../vs/base/common/lifecycle.js";import"../../../../../vs/base/common/uri.js";import"../../../../../vs/editor/browser/editorBrowser.js";import{EditOperation as _}from"../../../../../vs/editor/common/core/editOperation.js";import"../../../../../vs/editor/common/core/lineRange.js";import{Range as h}from"../../../../../vs/editor/common/core/range.js";import"../../../../../vs/editor/common/diff/documentDiffProvider.js";import{DetailedLineRangeMapping as k}from"../../../../../vs/editor/common/diff/rangeMapping.js";import{TrackedRangeStickiness as L}from"../../../../../vs/editor/common/model.js";import{ModelDecorationOptions as D}from"../../../../../vs/editor/common/model/textModel.js";import{IEditorWorkerService as H}from"../../../../../vs/editor/common/services/editorWorker.js";import"../../../../../vs/editor/common/textModelEvents.js";import{IContextKeyService as w}from"../../../../../vs/platform/contextkey/common/contextkey.js";import{ExtensionIdentifier as A}from"../../../../../vs/platform/extensions/common/extensions.js";import{ILogService as O}from"../../../../../vs/platform/log/common/log.js";import"../../../../../vs/workbench/contrib/chat/common/chatAgents.js";import"../../../../../vs/workbench/contrib/chat/common/chatModel.js";import{CTX_INLINE_CHAT_HAS_STASHED_SESSION as U}from"../../../../../vs/workbench/contrib/inlineChat/common/inlineChat.js";import{IInlineChatSessionService as P}from"./inlineChatSessionService.js";class M{constructor(e,n){this._textModel=e;this._decorationIds=e.deltaDecorations([],[{range:n,options:M._options}])}static _options=D.register({description:"inlineChat/session/wholeRange"});_onDidChange=new C;onDidChange=this._onDidChange.event;_decorationIds=[];dispose(){this._onDidChange.dispose(),this._textModel.isDisposed()||this._textModel.deltaDecorations(this._decorationIds,[])}fixup(e){const n=[];for(const{modified:s}of e){const a=s.isEmpty?new h(s.startLineNumber,1,s.startLineNumber,this._textModel.getLineLength(s.startLineNumber)):new h(s.startLineNumber,1,s.endLineNumberExclusive-1,this._textModel.getLineLength(s.endLineNumberExclusive-1));n.push({range:a,options:M._options})}const[t,...o]=this._decorationIds,i=this._textModel.deltaDecorations(o,n);this._decorationIds=[t].concat(i),this._onDidChange.fire(this)}get trackedInitialRange(){const[e]=this._decorationIds;return this._textModel.getDecorationRange(e)??new h(1,1,1,1)}get value(){let e;for(const n of this._decorationIds){const t=this._textModel.getDecorationRange(n);t&&(e?e=h.plusRange(e,t):e=t)}return e}}class ke{constructor(e,n,t,o,i,s,a,r,l,g){this.editMode=e;this.headless=n;this.targetUri=t;this.textModel0=o;this.textModelN=i;this.agent=s;this.wholeRange=a;this.hunkData=r;this.chatModel=l;this._teldata={extension:A.toKey(s.extensionId),startTime:this._startTime.toISOString(),endTime:this._startTime.toISOString(),edits:0,finishedByEdit:!1,rounds:"",undos:"",editMode:e,unstashed:0,acceptedHunks:0,discardedHunks:0,responseTypes:""},g&&(this._versionByRequest=new Map(g))}_isUnstashed=!1;_startTime=new Date;_teldata;_versionByRequest=new Map;get isUnstashed(){return this._isUnstashed}markUnstashed(){this._teldata.unstashed+=1,this._isUnstashed=!0}markModelVersion(e){this._versionByRequest.set(e.id,this.textModelN.getAlternativeVersionId())}get versionsByRequest(){return Array.from(this._versionByRequest)}async undoChangesUntil(e){const n=this._versionByRequest.get(e);if(n===void 0)return!1;this.hunkData.ignoreTextModelNChanges=!0;try{for(;n<this.textModelN.getAlternativeVersionId()&&this.textModelN.canUndo();)await this.textModelN.undo()}finally{this.hunkData.ignoreTextModelNChanges=!1}return!0}get hasChangedText(){return!this.textModel0.equalsTextBuffer(this.textModelN.getTextBuffer())}asChangedText(e){if(e.length===0)return;let n=Number.MAX_VALUE,t=Number.MIN_VALUE;for(const o of e)n=Math.min(n,o.modified.startLineNumber),t=Math.max(t,o.modified.endLineNumberExclusive);return this.textModelN.getValueInRange(new h(n,1,t,Number.MAX_VALUE))}recordExternalEditOccurred(e){this._teldata.edits+=1,this._teldata.finishedByEdit=e}asTelemetryData(){for(const e of this.hunkData.getInfo())switch(e.getState()){case 1:this._teldata.acceptedHunks+=1;break;case 2:this._teldata.discardedHunks+=1;break}return this._teldata.endTime=new Date().toISOString(),this._teldata}}let m=class{constructor(e,n,t,o,i,s){this._undoCancelEdits=t;this._sessionService=i;this._logService=s;this._ctxHasStashedSession=U.bindTo(o),this._session=n,this._ctxHasStashedSession.set(!0),this._listener=I.once(I.any(e.onDidChangeCursorSelection,e.onDidChangeModelContent,e.onDidChangeModel))(()=>{this._session=void 0,this._sessionService.releaseSession(n),this._ctxHasStashedSession.reset()})}_listener;_ctxHasStashedSession;_session;dispose(){this._listener.dispose(),this._ctxHasStashedSession.reset(),this._session&&this._sessionService.releaseSession(this._session)}unstash(){if(!this._session)return;this._listener.dispose();const e=this._session;return e.markUnstashed(),e.hunkData.ignoreTextModelNChanges=!0,e.textModelN.pushEditOperations(null,this._undoCancelEdits,()=>null),e.hunkData.ignoreTextModelNChanges=!1,this._session=void 0,this._logService.debug("[IE] Unstashed session"),e}};m=f([p(3,w),p(4,P),p(5,O)],m);function R(d,e){return d.isEmpty?new h(d.startLineNumber,1,d.startLineNumber,e.getLineLength(d.startLineNumber)):new h(d.startLineNumber,1,d.endLineNumberExclusive-1,e.getLineLength(d.endLineNumberExclusive-1))}let c=class{constructor(e,n,t){this._editorWorkerService=e;this._textModel0=n;this._textModelN=t;this._store.add(t.onDidChangeContent(o=>{this._ignoreChanges||this._mirrorChanges(o)}))}static _HUNK_TRACKED_RANGE=D.register({description:"inline-chat-hunk-tracked-range",stickiness:L.AlwaysGrowsWhenTypingAtEdges});static _HUNK_THRESHOLD=8;_store=new T;_data=new Map;_ignoreChanges=!1;dispose(){this._textModelN.isDisposed()||this._textModelN.changeDecorations(e=>{for(const{textModelNDecorations:n}of this._data.values())n.forEach(e.removeDecoration,e)}),this._textModel0.isDisposed()||this._textModel0.changeDecorations(e=>{for(const{textModel0Decorations:n}of this._data.values())n.forEach(e.removeDecoration,e)}),this._data.clear(),this._store.dispose()}set ignoreTextModelNChanges(e){this._ignoreChanges=e}get ignoreTextModelNChanges(){return this._ignoreChanges}_mirrorChanges(e){const n=[],t=[];for(const{textModelNDecorations:i,textModel0Decorations:s,state:a}of this._data.values())if(a===0)for(let r=1;r<i.length;r++){const l=this._textModelN.getDecorationRange(i[r]),g=this._textModel0.getDecorationRange(s[r]);l&&g&&n.push({rangeN:l,range0:g})}else if(a===1)for(let r=1;r<s.length;r++){const l=this._textModel0.getDecorationRange(s[r]);l&&t.push(l)}n.sort((i,s)=>h.compareRangesUsingStarts(i.rangeN,s.rangeN)),t.sort(h.compareRangesUsingStarts);const o=[];for(const i of e.changes){let s=!1,a=0;for(const{rangeN:u,range0:v}of n)if(u.getEndPosition().isBefore(h.getStartPosition(i.range)))a+=this._textModelN.getValueLengthInRange(u),a-=this._textModel0.getValueLengthInRange(v);else if(h.areIntersectingOrTouching(u,i.range)){s=!0;break}else break;if(s)continue;const r=i.rangeOffset-a,l=this._textModel0.getPositionAt(r);let g=0;for(const u of t)u.getEndPosition().isBefore(l)&&(g+=this._textModel0.getValueLengthInRange(u));const y=this._textModel0.getPositionAt(r+g),S=this._textModel0.getPositionAt(r+g+i.rangeLength);o.push(_.replace(h.fromPositions(y,S),i.text))}this._textModel0.pushEditOperations(null,o,()=>null)}async recompute(e,n){if(n??=await this._editorWorkerService.computeDiff(this._textModel0.uri,this._textModelN.uri,{ignoreTrimWhitespace:!1,maxComputationTimeMs:Number.MAX_SAFE_INTEGER,computeMoves:!1},"advanced"),!n||n.changes.length===0)return;const t=[n.changes[0]];for(let i=1;i<n.changes.length;i++){const s=t[t.length-1],a=n.changes[i];a.modified.startLineNumber-s.modified.endLineNumberExclusive<=c._HUNK_THRESHOLD?t[t.length-1]=new k(s.original.join(a.original),s.modified.join(a.modified),(s.innerChanges??[]).concat(a.innerChanges??[])):t.push(a)}const o=t.map(i=>new V(i.original,i.modified,i.innerChanges??[]));e.applied=o.length,this._textModelN.changeDecorations(i=>{this._textModel0.changeDecorations(s=>{for(const{textModelNDecorations:a,textModel0Decorations:r}of this._data.values())a.forEach(i.removeDecoration,i),r.forEach(s.removeDecoration,s);this._data.clear();for(const a of o){const r=[],l=[];r.push(i.addDecoration(R(a.modified,this._textModelN),c._HUNK_TRACKED_RANGE)),l.push(s.addDecoration(R(a.original,this._textModel0),c._HUNK_TRACKED_RANGE));for(const g of a.changes)r.push(i.addDecoration(g.modifiedRange,c._HUNK_TRACKED_RANGE)),l.push(s.addDecoration(g.originalRange,c._HUNK_TRACKED_RANGE));this._data.set(a,{editState:e,textModelNDecorations:r,textModel0Decorations:l,state:0})}})})}get size(){return this._data.size}get pending(){return b.reduce(this._data.values(),(e,{state:n})=>e+(n===0?1:0),0)}_discardEdits(e){const n=[],t=e.getRangesN(),o=e.getRanges0();for(let i=1;i<t.length;i++){const s=t[i],a=this._textModel0.getValueInRange(o[i]);n.push(_.replace(s,a))}return n}discardAll(){const e=[];for(const t of this.getInfo())t.getState()===0&&e.push(this._discardEdits(t));const n=[];return this._textModelN.pushEditOperations(null,e.flat(),t=>(n.push(t),null)),n.flat()}getInfo(){const e=[];for(const[n,t]of this._data.entries()){const o={getState:()=>t.state,isInsertion:()=>n.original.isEmpty,getRangesN:()=>{const i=t.textModelNDecorations.map(s=>this._textModelN.getDecorationRange(s));return x(i),i},getRanges0:()=>{const i=t.textModel0Decorations.map(s=>this._textModel0.getDecorationRange(s));return x(i),i},discardChanges:()=>{if(t.state===0){const i=this._discardEdits(o);this._textModelN.pushEditOperations(null,i,()=>null),t.state=2,t.editState.applied>0&&(t.editState.applied-=1)}},acceptChanges:()=>{if(t.state===0){const i=[],s=o.getRangesN(),a=o.getRanges0();for(let r=1;r<a.length;r++){const l=a[r],g=this._textModelN.getValueInRange(s[r]);i.push(_.replace(l,g))}this._textModel0.pushEditOperations(null,i,()=>null),t.state=1}}};e.push(o)}return e}};c=f([p(0,H)],c);class V{constructor(e,n,t){this.original=e;this.modified=n;this.changes=t}}var K=(t=>(t[t.Pending=0]="Pending",t[t.Accepted=1]="Accepted",t[t.Rejected=2]="Rejected",t))(K||{});export{c as HunkData,K as HunkState,ke as Session,M as SessionWholeRange,m as StashedSession};
