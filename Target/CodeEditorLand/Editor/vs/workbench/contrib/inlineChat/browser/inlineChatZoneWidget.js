var S=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var v=(d,o,e,t)=>{for(var i=t>1?void 0:t?b(o,e):o,n=d.length-1,l;n>=0;n--)(l=d[n])&&(i=(t?l(o,e,i):l(i))||i);return t&&i&&S(o,e,i),i},c=(d,o)=>(e,t)=>o(e,t,d);import{addDisposableListener as C,Dimension as w}from"../../../../base/browser/dom.js";import*as E from"../../../../base/browser/ui/aria/aria.js";import{MutableDisposable as T,toDisposable as y}from"../../../../base/common/lifecycle.js";import{assertType as L}from"../../../../base/common/types.js";import{EditorOption as N}from"../../../../editor/common/config/editorOptions.js";import{ZoneWidget as x}from"../../../../editor/contrib/zoneWidget/browser/zoneWidget.js";import{localize as O}from"../../../../nls.js";import{IContextKeyService as A}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as H}from"../../../../platform/instantiation/common/instantiation.js";import{ACTION_REGENERATE_RESPONSE as P,ACTION_REPORT_ISSUE as W,ACTION_TOGGLE_DIFF as R,CTX_INLINE_CHAT_OUTER_CURSOR_POSITION as D,EditMode as M,InlineChatConfigKeys as U,MENU_INLINE_CHAT_WIDGET_SECONDARY as F,MENU_INLINE_CHAT_WIDGET_STATUS as V}from"../common/inlineChat.js";import{EditorBasedInlineChatWidget as K}from"./inlineChatWidget.js";import{isEqual as B}from"../../../../base/common/resources.js";import{StableEditorBottomScrollState as I}from"../../../../editor/browser/stableEditorScroll.js";import{ScrollType as G}from"../../../../editor/common/editorCommon.js";import{IConfigurationService as Z}from"../../../../platform/configuration/common/configuration.js";import{ILogService as z}from"../../../../platform/log/common/log.js";import{MenuId as k}from"../../../../platform/actions/common/actions.js";import{isResponseVM as q}from"../../chat/common/chatViewModel.js";let m=class extends x{constructor(e,t,i,n,l,g){super(t,{showFrame:!1,showArrow:!1,isAccessible:!0,className:"inline-chat-widget",keepEditorSelection:!0,showInHiddenAreas:!0,ordinal:5e4});this._instaService=i;this._logService=n;this._ctxCursorPosition=D.bindTo(l),this._disposables.add(y(()=>{this._ctxCursorPosition.reset()})),this.widget=this._instaService.createInstance(K,e,this.editor,{statusMenuId:{menu:V,options:{buttonConfigProvider:(r,p)=>{const h=p>0;return new Set([P,R,W]).has(r.id)?{isSecondary:h,showIcon:!0,showLabel:!1}:{isSecondary:h}}}},secondaryMenuId:F,chatWidgetViewOptions:{menus:{executeToolbar:k.ChatExecute,telemetrySource:"interactiveEditorWidget-toolbar"},rendererOptions:{renderTextEditsAsSummary:r=>B(r,t.getModel()?.uri)&&g.getValue(U.Mode)===M.Live}}}),this._disposables.add(this.widget);let a;this._disposables.add(this.widget.chatWidget.onWillMaybeChangeHeight(()=>{this.position&&(a=this._createZoneAndScrollRestoreFn(this.position))})),this._disposables.add(this.widget.onDidChangeHeight(()=>{if(this.position){a??=this._createZoneAndScrollRestoreFn(this.position);const r=this._computeHeight();this._relayout(r.linesValue),a(),a=void 0}})),this.create(),this._disposables.add(C(this.domNode,"click",r=>{!this.editor.hasWidgetFocus()&&!this.widget.hasFocus()&&this.editor.focus()},!0));const s=()=>{!this.position||!this.editor.hasModel()?this._ctxCursorPosition.reset():this.position.lineNumber===this.editor.getPosition().lineNumber?this._ctxCursorPosition.set("above"):this.position.lineNumber+1===this.editor.getPosition().lineNumber?this._ctxCursorPosition.set("below"):this._ctxCursorPosition.reset()};this._disposables.add(this.editor.onDidChangeCursorPosition(r=>s())),this._disposables.add(this.editor.onDidFocusEditorText(r=>s())),s()}widget;_scrollUp=this._disposables.add(new X(this.editor));_ctxCursorPosition;_dimension;_fillContainer(e){e.appendChild(this.widget.domNode)}_doLayout(e){const t=this.editor.getLayoutInfo();let i=t.contentWidth-(t.glyphMarginWidth+t.decorationsWidth);i=Math.min(640,i),this._dimension=new w(i,e),this.widget.layout(this._dimension)}_computeHeight(){const e=this.widget.contentHeight,t=this.editor.getLayoutInfo().height,i=Math.min(e,Math.max(this.widget.minHeight,t*.42));return{linesValue:i/this.editor.getOption(N.lineHeight),pixelsValue:i}}_onWidth(e){this._dimension&&this._doLayout(this._dimension.height)}show(e){L(this.container);const t=this.editor.getLayoutInfo(),i=t.glyphMarginWidth+t.decorationsWidth+t.lineNumbersWidth;this.container.style.marginLeft=`${i}px`;const n=this._createZoneAndScrollRestoreFn(e);super.show(e,this._computeHeight().linesValue),this.widget.chatWidget.setVisible(!0),this.widget.focus(),n(),this._scrollUp.enable()}updatePositionAndHeight(e){const t=this._createZoneAndScrollRestoreFn(e);super.updatePositionAndHeight(e,this._computeHeight().linesValue),t()}_createZoneAndScrollRestoreFn(e){const t=I.capture(this.editor),i=e.lineNumber<=1?1:1+e.lineNumber,n=this.editor.getScrollTop(),g=this.editor.getTopForLineNumber(i)-this._computeHeight().pixelsValue;return this.widget.chatWidget.viewModel?.getItems().find(s=>q(s)&&s.response.value.length>0)&&g<n||this._scrollUp.didScrollUpOrDown?this._scrollUp.runIgnored(()=>{t.restore(this.editor)}):this._scrollUp.runIgnored(()=>{t.restore(this.editor);const s=this.editor.getScrollTop(),r=this.editor.getTopForLineNumber(i),p=r-this._computeHeight().pixelsValue,h=this.editor.getLayoutInfo().height,_=this.editor.getBottomForLineNumber(i);let u=p,f=!1;_>=s+h&&(u=_-h,f=!0),(u<s||f)&&(this._logService.trace("[IE] REVEAL zone",{zoneTop:p,lineTop:r,lineBottom:_,scrollTop:s,newScrollTop:u,forceScrollTop:f}),this.editor.setScrollTop(u,G.Immediate))})}revealRange(e,t){}_getWidth(e){return e.width-e.minimap.minimapWidth}hide(){const e=I.capture(this.editor);this._scrollUp.disable(),this._ctxCursorPosition.reset(),this.widget.reset(),this.widget.chatWidget.setVisible(!1),super.hide(),E.status(O("inlineChatClosed","Closed inline chat widget")),e.restore(this.editor)}};m=v([c(2,H),c(3,z),c(4,A),c(5,Z)],m);class X{constructor(o){this._editor=o}_didScrollUpOrDown;_ignoreEvents=!1;_listener=new T;dispose(){this._listener.dispose()}enable(){this._didScrollUpOrDown=void 0,this._listener.value=this._editor.onDidScrollChange(o=>{!o.scrollTopChanged||this._ignoreEvents||(this._listener.clear(),this._didScrollUpOrDown=!0)})}disable(){this._listener.clear(),this._didScrollUpOrDown=void 0}runIgnored(o){return()=>{this._ignoreEvents=!0;try{return o()}finally{this._ignoreEvents=!1}}}get didScrollUpOrDown(){return this._didScrollUpOrDown}}export{m as InlineChatZoneWidget};
