var X=Object.defineProperty;var j=Object.getOwnPropertyDescriptor;var I=(h,e,t,i)=>{for(var s=i>1?void 0:i?j(e,t):e,n=h.length-1,a;n>=0;n--)(a=h[n])&&(s=(i?a(e,t,s):a(s))||s);return i&&s&&X(e,t,s),s},o=(h,e)=>(t,i)=>e(t,i,h);import{getActiveElement as J,getTotalHeight as O,h as c,reset as C,trackFocus as Q}from"../../../../../vs/base/browser/dom.js";import{renderLabelWithIcons as R}from"../../../../../vs/base/browser/ui/iconLabel/iconLabels.js";import{Emitter as V,Event as Y}from"../../../../../vs/base/common/event.js";import{MarkdownString as Z}from"../../../../../vs/base/common/htmlContent.js";import{DisposableStore as D,MutableDisposable as ee}from"../../../../../vs/base/common/lifecycle.js";import{constObservable as M,derived as te,observableValue as k}from"../../../../../vs/base/common/observable.js";import"vs/css!./media/inlineChat";import{getDefaultHoverDelegate as ie}from"../../../../../vs/base/browser/ui/hover/hoverDelegateFactory.js";import{isNonEmptyArray as se,tail as ne}from"../../../../../vs/base/common/arrays.js";import"../../../../../vs/editor/browser/editorBrowser.js";import{AccessibleDiffViewer as oe}from"../../../../../vs/editor/browser/widget/diffEditor/components/accessibleDiffViewer.js";import{EditorOption as ae}from"../../../../../vs/editor/common/config/editorOptions.js";import{LineRange as A}from"../../../../../vs/editor/common/core/lineRange.js";import"../../../../../vs/editor/common/core/position.js";import"../../../../../vs/editor/common/core/range.js";import{Selection as re}from"../../../../../vs/editor/common/core/selection.js";import{DetailedLineRangeMapping as de,RangeMapping as le}from"../../../../../vs/editor/common/diff/rangeMapping.js";import{ScrollType as he}from"../../../../../vs/editor/common/editorCommon.js";import"../../../../../vs/editor/common/model.js";import{ITextModelService as T}from"../../../../../vs/editor/common/services/resolverService.js";import{localize as S}from"../../../../../vs/nls.js";import{IAccessibleViewService as N}from"../../../../../vs/platform/accessibility/browser/accessibleView.js";import{IAccessibilityService as F}from"../../../../../vs/platform/accessibility/common/accessibility.js";import{MenuWorkbenchButtonBar as ce}from"../../../../../vs/platform/actions/browser/buttonbar.js";import{MenuId as B}from"../../../../../vs/platform/actions/common/actions.js";import{IConfigurationService as K}from"../../../../../vs/platform/configuration/common/configuration.js";import{IContextKeyService as y}from"../../../../../vs/platform/contextkey/common/contextkey.js";import{IHoverService as P}from"../../../../../vs/platform/hover/browser/hover.js";import{IInstantiationService as w}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{ServiceCollection as ge}from"../../../../../vs/platform/instantiation/common/serviceCollection.js";import{IKeybindingService as q}from"../../../../../vs/platform/keybinding/common/keybinding.js";import{asCssVariable as ue,asCssVariableName as pe,editorBackground as me,inputBackground as _e}from"../../../../../vs/platform/theme/common/colorRegistry.js";import{AccessibilityVerbositySettingId as L}from"../../../../../vs/workbench/contrib/accessibility/browser/accessibilityConfiguration.js";import{AccessibilityCommandId as fe}from"../../../../../vs/workbench/contrib/accessibility/common/accessibilityCommands.js";import"../../../../../vs/workbench/contrib/chat/browser/chat.js";import{ChatWidget as ve}from"../../../../../vs/workbench/contrib/chat/browser/chatWidget.js";import{ChatAgentLocation as Ie}from"../../../../../vs/workbench/contrib/chat/common/chatAgents.js";import{chatRequestBackground as be}from"../../../../../vs/workbench/contrib/chat/common/chatColors.js";import{ChatModel as Ce}from"../../../../../vs/workbench/contrib/chat/common/chatModel.js";import{IChatService as $}from"../../../../../vs/workbench/contrib/chat/common/chatService.js";import{isResponseVM as W,isWelcomeVM as Me}from"../../../../../vs/workbench/contrib/chat/common/chatViewModel.js";import"../../../../../vs/workbench/contrib/inlineChat/browser/inlineChatSession.js";import{CTX_INLINE_CHAT_FOCUSED as Se,CTX_INLINE_CHAT_RESPONSE_FOCUSED as ye,inlineChatBackground as z,inlineChatForeground as we}from"../../../../../vs/workbench/contrib/inlineChat/common/inlineChat.js";let u=class{constructor(e,t,i,s,n,a,d,p,m,g,_){this._instantiationService=i;this._contextKeyService=s;this._keybindingService=n;this._accessibilityService=a;this._configurationService=d;this._accessibleViewService=p;this._textModelResolverService=m;this._chatService=g;this._hoverService=_;this.scopedContextKeyService=this._store.add(s.createScoped(this._elements.chatWidget));const f=i.createChild(new ge([y,this.scopedContextKeyService]),this._store);this._chatWidget=f.createInstance(ve,e,void 0,{defaultElementHeight:32,renderStyle:"minimal",renderInputOnTop:!1,renderFollowups:!0,supportsFileReferences:d.getValue(`chat.experimental.variables.${e.location}`)===!0,filter:r=>Me(r)?!1:W(r)&&r.isComplete&&!r.errorDetails?!(r.response.value.length>0&&r.response.value.every(E=>E.kind==="textEditGroup"&&t.chatWidgetViewOptions?.rendererOptions?.renderTextEditsAsSummary?.(E.uri))||r.response.value.length===0):!0,...t.chatWidgetViewOptions},{listForeground:we,listBackground:z,inputEditorBackground:_e,resultEditorBackground:me}),this._chatWidget.render(this._elements.chatWidget),this._elements.chatWidget.style.setProperty(pe(be),ue(z)),this._chatWidget.setVisible(!0),this._store.add(this._chatWidget);const v=this._store.add(new D);this._store.add(this._chatWidget.onDidChangeViewModel(()=>{v.clear();const r=this._chatWidget.viewModel;r&&v.add(r.onDidChange(()=>this._onDidChangeHeight.fire())),this._onDidChangeHeight.fire()})),this._store.add(this.chatWidget.onDidChangeContentHeight(()=>{this._onDidChangeHeight.fire()})),this._ctxResponseFocused=ye.bindTo(this._contextKeyService);const x=this._store.add(Q(this.domNode));this._store.add(x.onDidBlur(()=>this._ctxResponseFocused.set(!1))),this._store.add(x.onDidFocus(()=>this._ctxResponseFocused.set(!0))),this._ctxInputEditorFocused=Se.bindTo(s),this._store.add(this._chatWidget.inputEditor.onDidFocusEditorWidget(()=>this._ctxInputEditorFocused.set(!0))),this._store.add(this._chatWidget.inputEditor.onDidBlurEditorWidget(()=>this._ctxInputEditorFocused.set(!1)));const G=t.statusMenuId instanceof B?t.statusMenuId:t.statusMenuId.menu,U=t.statusMenuId instanceof B?void 0:t.statusMenuId.options,H=f.createInstance(ce,this._elements.toolbar2,G,{toolbarOptions:{primaryGroup:"0_main"},telemetrySource:t.chatWidgetViewOptions?.menus?.telemetrySource,menuOptions:{renderShortTitle:!0},...U});this._store.add(H.onDidChange(()=>this._onDidChangeHeight.fire())),this._store.add(H),this._store.add(this._configurationService.onDidChangeConfiguration(r=>{r.affectsConfiguration(L.InlineChat)&&this._updateAriaLabel()})),this._elements.root.tabIndex=0,this._elements.statusLabel.tabIndex=0,this._updateAriaLabel(),this._store.add(this._hoverService.setupManagedHover(ie("element"),this._elements.statusLabel,()=>this._elements.statusLabel.dataset.title)),this._store.add(this._chatService.onDidPerformUserAction(r=>{r.sessionId===this._chatWidget.viewModel?.model.sessionId&&r.action.kind==="vote"&&this.updateStatus("Thank you for your feedback!",{resetAfter:1250})})),this._defaultChatModel=this._store.add(this._instantiationService.createInstance(Ce,void 0,Ie.Editor)),this._defaultChatModel.startInitialize(),this._defaultChatModel.initialize(void 0),this.setChatModel(this._defaultChatModel)}_elements=c("div.inline-chat@root",[c("div.chat-widget@chatWidget"),c("div.accessibleViewer@accessibleViewer"),c("div.status@status",[c("div.label.info.hidden@infoLabel"),c("div.actions.button-style.hidden@toolbar2"),c("div.label.status.hidden@statusLabel")])]);_store=new D;_defaultChatModel;_ctxInputEditorFocused;_ctxResponseFocused;_chatWidget;_onDidChangeHeight=this._store.add(new V);onDidChangeHeight=Y.filter(this._onDidChangeHeight.event,e=>!this._isLayouting);_onDidChangeInput=this._store.add(new V);onDidChangeInput=this._onDidChangeInput.event;_isLayouting=!1;scopedContextKeyService;_updateAriaLabel(){if(this._elements.root.ariaLabel=this._accessibleViewService.getOpenAriaHint(L.InlineChat),this._accessibilityService.isScreenReaderOptimized()){let e=Le;if(this._configurationService.getValue(L.InlineChat)){const t=this._keybindingService.lookupKeybinding(fe.OpenAccessibilityHelp)?.getLabel();e=t?S("inlineChat.accessibilityHelp","Inline Chat Input, Use {0} for Inline Chat Accessibility Help.",t):S("inlineChat.accessibilityHelpNoKb","Inline Chat Input, Run the Inline Chat Accessibility Help command for more information.")}this._chatWidget.inputEditor.updateOptions({ariaLabel:e})}}dispose(){this._store.dispose()}get domNode(){return this._elements.root}get chatWidget(){return this._chatWidget}saveState(){this._chatWidget.saveState()}layout(e){this._isLayouting=!0;try{this._doLayout(e)}finally{this._isLayouting=!1}}_doLayout(e){const t=this._getExtraHeight(),i=O(this._elements.status);this._elements.root.style.height=`${e.height-t}px`,this._elements.root.style.width=`${e.width}px`,this._chatWidget.layout(e.height-i-t,e.width)}get contentHeight(){const e={chatWidgetContentHeight:this._chatWidget.contentHeight,statusHeight:O(this._elements.status),extraHeight:this._getExtraHeight()};return e.chatWidgetContentHeight+e.statusHeight+e.extraHeight}get minHeight(){let e=100;for(const i of this._chatWidget.viewModel?.getItems()??[])if(W(i)&&i.response.value.some(s=>s.kind==="textEditGroup"&&!s.state?.applied)){e=270;break}let t=this.contentHeight;return t-=this._chatWidget.contentHeight,t+=Math.min(this._chatWidget.input.contentHeight+e,this._chatWidget.contentHeight),t}_getExtraHeight(){return 10}get value(){return this._chatWidget.getInput()}set value(e){this._chatWidget.setInput(e)}selectAll(e=!0){let t=1;if(!e){const i=/^(\/\w+)\s*/.exec(this._chatWidget.inputEditor.getModel().getLineContent(1));i&&(t=i[1].length+1)}this._chatWidget.inputEditor.setSelection(new re(1,t,Number.MAX_SAFE_INTEGER,1))}set placeholder(e){this._chatWidget.setInputPlaceholder(e)}toggleStatus(e){this._elements.toolbar2.classList.toggle("hidden",!e),this._elements.status.classList.toggle("hidden",!e),this._elements.infoLabel.classList.toggle("hidden",!e),this._onDidChangeHeight.fire()}updateToolbar(e){this._elements.root.classList.toggle("toolbar",e),this._elements.toolbar2.classList.toggle("hidden",!e),this._elements.status.classList.toggle("actions",e),this._elements.infoLabel.classList.toggle("hidden",e),this._onDidChangeHeight.fire()}async getCodeBlockInfo(e){const{viewModel:t}=this._chatWidget;if(!t)return;const i=t.getItems().filter(n=>W(n));if(!i.length)return;const s=i[i.length-1];return t.codeBlockModelCollection.get(t.sessionId,s,e)?.model}get responseContent(){const e=this._chatWidget.viewModel?.model.getRequests();if(se(e))return ne(e)?.response?.response.toString()}getChatModel(){return this._chatWidget.viewModel?.model??this._defaultChatModel}setChatModel(e){this._chatWidget.setModel(e,{inputValue:void 0})}updateChatMessage(e,t,i){if(!this._chatWidget.viewModel||this._chatWidget.viewModel.model!==this._defaultChatModel)return;const s=this._defaultChatModel;if(!e?.message.value){for(const a of s.getRequests())s.removeRequest(a.id);return}const n=s.addRequest({parts:[],text:""},{variables:[]},0);if(s.acceptResponseProgress(n,{kind:"markdownContent",content:e.message}),!t){s.completeResponse(n);return}return{cancel:()=>s.cancelRequest(n),complete:()=>s.completeResponse(n),appendContent:a=>{s.acceptResponseProgress(n,{kind:"markdownContent",content:new Z(a)})}}}updateInfo(e){this._elements.infoLabel.classList.toggle("hidden",!e);const t=R(e);C(this._elements.infoLabel,...t),this._onDidChangeHeight.fire()}updateStatus(e,t={}){const i=typeof t.resetAfter=="number";if(i&&!this._elements.statusLabel.dataset.state){const n=this._elements.statusLabel.innerText,a=this._elements.statusLabel.dataset.title,d=Array.from(this._elements.statusLabel.classList.values());setTimeout(()=>{this.updateStatus(n,{classes:d,keepMessage:!0,title:a})},t.resetAfter)}const s=R(e);C(this._elements.statusLabel,...s),this._elements.statusLabel.className=`label status ${(t.classes??[]).join(" ")}`,this._elements.statusLabel.classList.toggle("hidden",!e),i?this._elements.statusLabel.dataset.state="temp":delete this._elements.statusLabel.dataset.state,t.title?this._elements.statusLabel.dataset.title=t.title:delete this._elements.statusLabel.dataset.title,this._onDidChangeHeight.fire()}reset(){this._chatWidget.setContext(!0),this._chatWidget.saveState(),this.updateChatMessage(void 0),C(this._elements.statusLabel),this._elements.statusLabel.classList.toggle("hidden",!0),this._elements.toolbar2.classList.add("hidden"),this.updateInfo(""),this.chatWidget.setModel(this._defaultChatModel,{}),this._elements.accessibleViewer.classList.toggle("hidden",!0),this._onDidChangeHeight.fire()}focus(){this._chatWidget.focusInput()}hasFocus(){return this.domNode.contains(J())}};u=I([o(2,w),o(3,y),o(4,q),o(5,F),o(6,K),o(7,N),o(8,T),o(9,$),o(10,P)],u);const Le=S("aria-label","Inline Chat Input");let b=class extends u{constructor(t,i,s,n,a,d,p,m,g,_,f,v){super(t,{...s,chatWidgetViewOptions:{...s.chatWidgetViewOptions,editorOverflowWidgetsDomNode:i.getOverflowWidgetsDomNode()}},d,n,a,p,m,g,_,f,v);this._parentEditor=i}_accessibleViewer=this._store.add(new ee);get contentHeight(){let t=super.contentHeight;return this._accessibleViewer.value&&(t+=this._accessibleViewer.value.height+8),t}_doLayout(t){let i=t.height;this._accessibleViewer.value&&(this._accessibleViewer.value.width=t.width-12,i-=this._accessibleViewer.value.height+8),super._doLayout(t.with(void 0,i)),this._elements.root.style.height=`${t.height-this._getExtraHeight()}px`}reset(){this._accessibleViewer.clear(),super.reset()}showAccessibleHunk(t,i){this._elements.accessibleViewer.classList.remove("hidden"),this._accessibleViewer.clear(),this._accessibleViewer.value=this._instantiationService.createInstance(l,this._elements.accessibleViewer,t,i,new We(this._parentEditor,t,i)),this._onDidChangeHeight.fire()}};b=I([o(3,y),o(4,q),o(5,w),o(6,F),o(7,K),o(8,N),o(9,T),o(10,$),o(11,P)],b);let l=class extends oe{height;set width(e){this._width2.set(e,void 0)}_width2;constructor(e,t,i,s,n){const a=k("width",0),d=k("diff",l._asMapping(i)),p=te(_=>[d.read(_)]),m=Math.min(10,8+d.get().changedLineCount),g=s.getModifiedOptions().get(ae.lineHeight)*m;super(e,M(!0),()=>{},M(!1),a,M(g),p,s,n),this.height=g,this._width2=a,this._store.add(t.textModelN.onDidChangeContent(()=>{d.set(l._asMapping(i),void 0)}))}static _asMapping(e){const t=e.getRanges0(),i=e.getRangesN(),s=A.fromRangeInclusive(t[0]),n=A.fromRangeInclusive(i[0]),a=[];for(let d=1;d<t.length;d++)a.push(new le(t[d],i[d]));return new de(s,n,a)}};l=I([o(4,w)],l);class We{constructor(e,t,i){this._editor=e;this._session=t;this._hunk=i}getOriginalModel(){return this._session.textModel0}getModifiedModel(){return this._session.textModelN}getOriginalOptions(){return this._editor.getOptions()}getModifiedOptions(){return this._editor.getOptions()}originalReveal(e){}modifiedReveal(e){this._editor.revealRangeInCenterIfOutsideViewport(e||this._hunk.getRangesN()[0],he.Smooth)}modifiedSetSelection(e){}modifiedFocus(){this._editor.focus()}getModifiedPosition(){return this._hunk.getRangesN()[0].getStartPosition()}}export{b as EditorBasedInlineChatWidget,u as InlineChatWidget};
