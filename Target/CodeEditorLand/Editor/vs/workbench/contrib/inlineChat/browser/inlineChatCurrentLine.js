var g=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var C=(a,n,o,e)=>{for(var t=e>1?void 0:e?E(n,o):n,i=a.length-1,r;i>=0;i--)(r=a[i])&&(t=(e?r(n,o,t):r(t))||t);return e&&t&&g(n,o,t),t},m=(a,n)=>(o,e)=>n(o,e,a);import{DisposableStore as u,MutableDisposable as I}from"../../../../base/common/lifecycle.js";import"../../../../editor/browser/editorBrowser.js";import{CursorChangeReason as _}from"../../../../editor/common/cursorEvents.js";import"../../../../editor/common/editorCommon.js";import{localize as x,localize2 as L}from"../../../../nls.js";import{ContextKeyExpr as A,IContextKeyService as N,RawContextKey as b}from"../../../../platform/contextkey/common/contextkey.js";import{IChatAgentService as v}from"../../chat/common/chatAgents.js";import{InlineChatController as S,State as y}from"./inlineChatController.js";import{CTX_INLINE_CHAT_HAS_AGENT as w,CTX_INLINE_CHAT_VISIBLE as M}from"../common/inlineChat.js";import{EditorAction2 as O}from"../../../../editor/browser/editorExtensions.js";import{EditOperation as T}from"../../../../editor/common/core/editOperation.js";import{Range as D}from"../../../../editor/common/core/range.js";import{Position as W}from"../../../../editor/common/core/position.js";import{AbstractInlineChatAction as H}from"./inlineChatActions.js";import{EditorContextKeys as K}from"../../../../editor/common/editorContextKeys.js";import"../../../../editor/common/model.js";const P=new b("inlineChatExpansion",!1,x("inlineChatExpansion","Whether the inline chat expansion is enabled when at the end of a just-typed line"));let d=class{static Id="editor.inlineChatExpansion";_store=new u;_editorListener=this._store.add(new I);_ctxInlineChatExpansion;constructor(n,o,e){this._ctxInlineChatExpansion=P.bindTo(o);const t=()=>{n.hasModel()&&e.getAgents().length>0?this._install(n):this._uninstall()};this._store.add(e.onDidChangeAgents(t)),this._store.add(n.onDidChangeModel(t)),t()}dispose(){this._ctxInlineChatExpansion.reset(),this._store.dispose()}_install(n){const o=new u;this._editorListener.value=o;const e=n.getModel(),t=[];o.add(n.onDidChangeCursorPosition(i=>{let r=!1;if(i.reason===_.NotSet){const s=n.getPosition(),c=e.getOffsetAt(s),l=e.getLineLength(s.lineNumber);e.getLineFirstNonWhitespaceColumn(s.lineNumber)!==0&&s.column>l&&t.includes(c)&&(r=!0)}t.length=0,this._ctxInlineChatExpansion.set(r)})),o.add(n.onDidChangeModelContent(i=>{t.length=0;for(const r of i.changes){const s=r.rangeOffset+r.text.length;t.push(s)}queueMicrotask(()=>{t.length>0&&this._ctxInlineChatExpansion.set(!1)})}))}_uninstall(){this._editorListener.clear()}};d=C([m(1,N),m(2,v)],d);class at extends O{constructor(){super({id:"inlineChat.startWithCurrentLine",category:H.category,title:L("startWithCurrentLine","Start in Editor with Current Line"),f1:!0,precondition:A.and(M.negate(),w,K.writable)})}async runEditorCommand(n,o){const e=S.get(o);if(!e||!o.hasModel())return;const t=o.getModel(),i=o.getSelection().positionLineNumber,r=t.getLineContent(i),s=t.getLineFirstNonWhitespaceColumn(i),c=t.getLineMaxColumn(i);let l=[];t.pushEditOperations(null,[T.replace(new D(i,s,i,c),"")],h=>(l=h,null));let p;const f=e.onDidEnterState(h=>p=h);try{await e.run({autoSend:!0,message:r.trim(),position:new W(i,s)})}finally{f.dispose()}p===y.CANCEL&&t.pushEditOperations(null,l,()=>null)}}export{P as CTX_INLINE_CHAT_EXPANSION,d as InlineChatExansionContextKey,at as InlineChatExpandLineAction};
