import{Codicon as E}from"../../../../base/common/codicons.js";import{KeyChord as P,KeyCode as a,KeyMod as C}from"../../../../base/common/keyCodes.js";import{isCodeEditor as M,isDiffEditor as U}from"../../../../editor/browser/editorBrowser.js";import{EditorAction2 as S}from"../../../../editor/browser/editorExtensions.js";import{ICodeEditorService as F}from"../../../../editor/browser/services/codeEditorService.js";import{EmbeddedCodeEditorWidget as q}from"../../../../editor/browser/widget/codeEditor/embeddedCodeEditorWidget.js";import{EmbeddedDiffEditorWidget as X}from"../../../../editor/browser/widget/diffEditor/embeddedDiffEditorWidget.js";import{EditorContextKeys as p}from"../../../../editor/common/editorContextKeys.js";import{localize as g,localize2 as m}from"../../../../nls.js";import{CONTEXT_ACCESSIBILITY_MODE_ENABLED as w}from"../../../../platform/accessibility/common/accessibility.js";import"../../../../platform/actions/common/actions.js";import{CommandsRegistry as D}from"../../../../platform/commands/common/commands.js";import{ContextKeyExpr as n}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as W}from"../../../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as d}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{ILogService as G}from"../../../../platform/log/common/log.js";import{registerIcon as K}from"../../../../platform/theme/common/iconRegistry.js";import{IEditorService as z}from"../../../services/editor/common/editorService.js";import{IPreferencesService as V}from"../../../services/preferences/common/preferences.js";import{CONTEXT_CHAT_INPUT_HAS_TEXT as y,CONTEXT_IN_CHAT_INPUT as B}from"../../chat/common/chatContextKeys.js";import{IChatService as Z}from"../../chat/common/chatService.js";import{ACTION_ACCEPT_CHANGES as k,ACTION_DISCARD_CHANGES as Y,ACTION_REGENERATE_RESPONSE as Q,ACTION_TOGGLE_DIFF as j,ACTION_VIEW_IN_CHAT as J,CTX_INLINE_CHAT_CHANGE_HAS_DIFF as O,CTX_INLINE_CHAT_CHANGE_SHOWS_DIFF as $,CTX_INLINE_CHAT_DOCUMENT_CHANGED as ee,CTX_INLINE_CHAT_EDIT_MODE as A,CTX_INLINE_CHAT_FOCUSED as H,CTX_INLINE_CHAT_HAS_AGENT as R,CTX_INLINE_CHAT_HAS_STASHED_SESSION as oe,CTX_INLINE_CHAT_INNER_CURSOR_FIRST as re,CTX_INLINE_CHAT_INNER_CURSOR_LAST as te,CTX_INLINE_CHAT_OUTER_CURSOR_POSITION as L,CTX_INLINE_CHAT_REQUEST_IN_PROGRESS as N,CTX_INLINE_CHAT_RESPONSE_TYPE as _,CTX_INLINE_CHAT_USER_DID_EDIT as ne,CTX_INLINE_CHAT_VISIBLE as l,EditMode as v,InlineChatResponseType as f,MENU_INLINE_CHAT_WIDGET_STATUS as h,MENU_INLINE_CHAT_ZONE as b}from"../common/inlineChat.js";import{InlineChatController as T,InlineChatRunOptions as ie}from"./inlineChatController.js";import"./inlineChatSession.js";D.registerCommandAlias("interactiveEditor.start","inlineChat.start"),D.registerCommandAlias("interactive.acceptChanges",k);const se=m("run","Start in Editor"),ae=K("start-inline-chat",E.sparkle,g("startInlineChat","Icon which spawns the inline chat from the editor toolbar."));let x;function Me(s){x=s}class Ue extends S{constructor(){super({id:"inlineChat.start",title:se,category:i.category,f1:!0,precondition:n.and(R,p.writable),keybinding:{when:p.focus,weight:d.WorkbenchContrib,primary:C.CtrlCmd|a.KeyI,secondary:[P(C.CtrlCmd|a.KeyK,a.KeyI)]},icon:ae})}runEditorCommand(o,e,...t){const r=T.get(e);if(!r)return;x&&o.get(W).invokeFunction(x,r,this);let I;const u=t[0];u&&ie.isInlineChatRunOptions(u)&&(I=u),T.get(e)?.run({...I})}}class Fe extends S{constructor(){super({id:"inlineChat.unstash",title:m("unstash","Resume Last Dismissed Inline Chat"),category:i.category,precondition:n.and(oe,p.writable),keybinding:{weight:d.WorkbenchContrib,primary:C.CtrlCmd|a.KeyZ}})}async runEditorCommand(o,e,...t){const r=T.get(e);if(r){const I=r.unstashLastSession();I&&r.run({existingSession:I,isUnstashed:!0})}}}class i extends S{static category=m("cat","Inline Chat");constructor(o){super({...o,category:i.category,precondition:n.and(R,o.precondition)})}runEditorCommand(o,e,...t){const r=o.get(z),I=o.get(G);let u=T.get(e);if(!u){const{activeTextEditorControl:c}=r;M(c)?e=c:U(c)&&(e=c.getModifiedEditor()),u=T.get(e)}if(!u){I.warn("[IE] NO controller found for action",this.desc.id,e.getModel()?.uri);return}if(e instanceof q&&(e=e.getParentEditor()),!u){for(const c of o.get(F).listDiffEditors())(c.getOriginalEditor()===e||c.getModifiedEditor()===e)&&c instanceof X&&this.runEditorCommand(o,c.getParentEditor(),...t);return}this.runInlineChatCommand(o,u,e,...t)}}class qe extends i{constructor(){super({id:"inlineChat.arrowOutUp",title:g("arrowUp","Cursor Up"),precondition:n.and(H,re,p.isEmbeddedDiffEditor.negate(),w.negate()),keybinding:{weight:d.EditorCore,primary:C.CtrlCmd|a.UpArrow}})}runInlineChatCommand(o,e,t,...r){e.arrowOut(!0)}}class Xe extends i{constructor(){super({id:"inlineChat.arrowOutDown",title:g("arrowDown","Cursor Down"),precondition:n.and(H,te,p.isEmbeddedDiffEditor.negate(),w.negate()),keybinding:{weight:d.EditorCore,primary:C.CtrlCmd|a.DownArrow}})}runInlineChatCommand(o,e,t,...r){e.arrowOut(!1)}}class We extends S{constructor(){super({id:"inlineChat.focus",title:m("focus","Focus Input"),f1:!0,category:i.category,precondition:n.and(p.editorTextFocus,l,H.negate(),w.negate()),keybinding:[{weight:d.EditorCore+10,when:n.and(L.isEqualTo("above"),p.isEmbeddedDiffEditor.negate()),primary:C.CtrlCmd|a.DownArrow},{weight:d.EditorCore+10,when:n.and(L.isEqualTo("below"),p.isEmbeddedDiffEditor.negate()),primary:C.CtrlCmd|a.UpArrow}]})}runEditorCommand(o,e,...t){T.get(e)?.focus()}}class Ge extends i{constructor(){super({id:"inlineChat.discard",title:g("discard","Discard"),icon:E.discard,precondition:l,keybinding:{weight:d.EditorContrib-1,primary:a.Escape,when:ne.negate()}})}async runInlineChatCommand(o,e,t,...r){await e.cancelSession()}}class Ke extends i{constructor(){super({id:k,title:m("apply1","Accept Changes"),shortTitle:g("apply2","Accept"),icon:E.check,f1:!0,precondition:n.and(l,n.or(ee.toNegated(),A.notEqualsTo(v.Preview))),keybinding:[{weight:d.WorkbenchContrib+10,primary:C.CtrlCmd|a.Enter}],menu:[{id:h,group:"0_main",order:1,when:n.and(y.toNegated(),N.toNegated(),_.isEqualTo(f.MessagesAndEdits))},{id:b,group:"navigation",order:1}]})}async runInlineChatCommand(o,e,t,r){e.acceptHunk(r)}}class ze extends i{constructor(){super({id:Y,title:g("discard","Discard"),icon:E.chromeClose,precondition:l,menu:[{id:h,group:"0_main",order:2,when:n.and(y.toNegated(),N.negate(),_.isEqualTo(f.MessagesAndEdits),A.isEqualTo(v.Live))},{id:b,group:"navigation",order:2}],keybinding:{weight:d.WorkbenchContrib,primary:a.Escape,when:_.isEqualTo(f.MessagesAndEdits)}})}async runInlineChatCommand(o,e,t,r){return e.discardHunk(r)}}class Ve extends i{constructor(){super({id:Q,title:m("chat.rerun.label","Rerun Request"),shortTitle:g("rerun","Rerun"),f1:!1,icon:E.refresh,precondition:l,menu:{id:h,group:"0_main",order:5,when:n.and(y.toNegated(),N.negate(),_.notEqualsTo(f.None))},keybinding:{weight:d.WorkbenchContrib,primary:C.CtrlCmd|a.KeyR}})}async runInlineChatCommand(o,e,t,...r){const I=o.get(Z),c=e.chatWidget.viewModel?.model?.getRequests().at(-1);c&&await I.resendRequest(c,{noCommandDetection:!1,attempt:c.attempt+1,location:e.chatWidget.location})}}class Be extends i{constructor(){super({id:"inlineChat.close",title:g("close","Close"),icon:E.close,precondition:l,keybinding:{weight:d.WorkbenchContrib,primary:a.Escape},menu:[{id:h,group:"0_main",order:1,when:n.and(N.negate(),n.or(_.isEqualTo(f.Messages),A.isEqualTo(v.Preview)))}]})}async runInlineChatCommand(o,e,t,...r){e.cancelSession()}}class Ze extends i{constructor(){super({id:"inlineChat.configure",title:m("configure","Configure Inline Chat"),icon:E.settingsGear,precondition:l,f1:!0,menu:{id:h,group:"zzz",order:5}})}async runInlineChatCommand(o,e,t,...r){o.get(V).openSettings({query:"inlineChat"})}}class Ye extends i{constructor(){super({id:"inlineChat.moveToNextHunk",title:m("moveToNextHunk","Move to Next Change"),precondition:l,f1:!0,keybinding:{weight:d.WorkbenchContrib,primary:a.F7}})}runInlineChatCommand(o,e,t,...r){e.moveHunk(!0)}}class Qe extends i{constructor(){super({id:"inlineChat.moveToPreviousHunk",title:m("moveToPreviousHunk","Move to Previous Change"),f1:!0,precondition:l,keybinding:{weight:d.WorkbenchContrib,primary:C.Shift|a.F7}})}runInlineChatCommand(o,e,t,...r){e.moveHunk(!1)}}class je extends i{constructor(){super({id:J,title:g("viewInChat","View in Chat"),icon:E.commentDiscussion,precondition:l,menu:[{id:h,group:"more",order:1,when:_.notEqualsTo(f.Messages)},{id:h,group:"0_main",order:1,when:n.and(y.toNegated(),_.isEqualTo(f.Messages),N.negate())}],keybinding:{weight:d.WorkbenchContrib,primary:C.CtrlCmd|a.DownArrow,when:B}})}runInlineChatCommand(o,e,t,...r){return e.viewInChat()}}class Je extends i{constructor(){super({id:j,precondition:n.and(l,A.isEqualTo(v.Live),O),title:m("showChanges","Toggle Changes"),icon:E.diffSingle,toggled:{condition:$},menu:[{id:h,group:"zzz",when:n.and(A.isEqualTo(v.Live)),order:1},{id:b,group:"navigation",when:O,order:2}]})}runInlineChatCommand(o,e,t,r){e.toggleDiff(r)}}export{i as AbstractInlineChatAction,Ke as AcceptChanges,Xe as ArrowOutDownAction,qe as ArrowOutUpAction,Be as CloseAction,Ze as ConfigureInlineChatAction,Ge as DiscardAction,ze as DiscardHunkAction,We as FocusInlineChat,se as LOCALIZED_START_INLINE_CHAT_STRING,Ye as MoveToNextHunk,Qe as MoveToPreviousHunk,Ve as RerunAction,ae as START_INLINE_CHAT,Ue as StartSessionAction,Je as ToggleDiffForChange,Fe as UnstashSessionAction,je as ViewInChatAction,Me as setHoldForSpeech};
