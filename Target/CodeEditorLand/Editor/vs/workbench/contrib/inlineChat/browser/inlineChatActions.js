import{Codicon as p}from"../../../../base/common/codicons.js";import{KeyChord as P,KeyCode as a,KeyMod as C}from"../../../../base/common/keyCodes.js";import{isCodeEditor as M,isDiffEditor as U}from"../../../../editor/browser/editorBrowser.js";import{EditorAction2 as S}from"../../../../editor/browser/editorExtensions.js";import{ICodeEditorService as F}from"../../../../editor/browser/services/codeEditorService.js";import{EmbeddedCodeEditorWidget as q}from"../../../../editor/browser/widget/codeEditor/embeddedCodeEditorWidget.js";import{EmbeddedDiffEditorWidget as X}from"../../../../editor/browser/widget/diffEditor/embeddedDiffEditorWidget.js";import{EditorContextKeys as g}from"../../../../editor/common/editorContextKeys.js";import{localize as E,localize2 as u}from"../../../../nls.js";import{CONTEXT_ACCESSIBILITY_MODE_ENABLED as w}from"../../../../platform/accessibility/common/accessibility.js";import{CommandsRegistry as D}from"../../../../platform/commands/common/commands.js";import{ContextKeyExpr as n}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as W}from"../../../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as d}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{ILogService as G}from"../../../../platform/log/common/log.js";import{registerIcon as K}from"../../../../platform/theme/common/iconRegistry.js";import{IEditorService as z}from"../../../services/editor/common/editorService.js";import{IPreferencesService as V}from"../../../services/preferences/common/preferences.js";import{CONTEXT_CHAT_INPUT_HAS_TEXT as v,CONTEXT_IN_CHAT_INPUT as B}from"../../chat/common/chatContextKeys.js";import{IChatService as Z}from"../../chat/common/chatService.js";import{ACTION_ACCEPT_CHANGES as k,ACTION_DISCARD_CHANGES as j,ACTION_REGENERATE_RESPONSE as Y,ACTION_TOGGLE_DIFF as Q,ACTION_VIEW_IN_CHAT as J,CTX_INLINE_CHAT_CHANGE_HAS_DIFF as O,CTX_INLINE_CHAT_CHANGE_SHOWS_DIFF as $,CTX_INLINE_CHAT_DOCUMENT_CHANGED as ee,CTX_INLINE_CHAT_EDIT_MODE as A,CTX_INLINE_CHAT_FOCUSED as H,CTX_INLINE_CHAT_HAS_AGENT as R,CTX_INLINE_CHAT_HAS_STASHED_SESSION as oe,CTX_INLINE_CHAT_INNER_CURSOR_FIRST as re,CTX_INLINE_CHAT_INNER_CURSOR_LAST as te,CTX_INLINE_CHAT_OUTER_CURSOR_POSITION as L,CTX_INLINE_CHAT_REQUEST_IN_PROGRESS as y,CTX_INLINE_CHAT_RESPONSE_TYPE as _,CTX_INLINE_CHAT_USER_DID_EDIT as ne,CTX_INLINE_CHAT_VISIBLE as l,EditMode as N,InlineChatResponseType as f,MENU_INLINE_CHAT_WIDGET_STATUS as h,MENU_INLINE_CHAT_ZONE as b}from"../common/inlineChat.js";import{InlineChatController as T,InlineChatRunOptions as ie}from"./inlineChatController.js";D.registerCommandAlias("interactiveEditor.start","inlineChat.start"),D.registerCommandAlias("interactive.acceptChanges",k);const se=u("run","Start in Editor"),ae=K("start-inline-chat",p.sparkle,E("startInlineChat","Icon which spawns the inline chat from the editor toolbar."));let x;function xe(s){x=s}class De extends S{constructor(){super({id:"inlineChat.start",title:se,category:i.category,f1:!0,precondition:n.and(R,g.writable),keybinding:{when:g.focus,weight:d.WorkbenchContrib,primary:C.CtrlCmd|a.KeyI,secondary:[P(C.CtrlCmd|a.KeyK,a.KeyI)]},icon:ae})}runEditorCommand(o,e,...t){const r=T.get(e);if(!r)return;x&&o.get(W).invokeFunction(x,r,this);let I;const m=t[0];m&&ie.isInlineChatRunOptions(m)&&(I=m),T.get(e)?.run({...I})}}class ke extends S{constructor(){super({id:"inlineChat.unstash",title:u("unstash","Resume Last Dismissed Inline Chat"),category:i.category,precondition:n.and(oe,g.writable),keybinding:{weight:d.WorkbenchContrib,primary:C.CtrlCmd|a.KeyZ}})}async runEditorCommand(o,e,...t){const r=T.get(e);if(r){const I=r.unstashLastSession();I&&r.run({existingSession:I,isUnstashed:!0})}}}class i extends S{static category=u("cat","Inline Chat");constructor(o){super({...o,category:i.category,precondition:n.and(R,o.precondition)})}runEditorCommand(o,e,...t){const r=o.get(z),I=o.get(G);let m=T.get(e);if(!m){const{activeTextEditorControl:c}=r;M(c)?e=c:U(c)&&(e=c.getModifiedEditor()),m=T.get(e)}if(!m){I.warn("[IE] NO controller found for action",this.desc.id,e.getModel()?.uri);return}if(e instanceof q&&(e=e.getParentEditor()),!m){for(const c of o.get(F).listDiffEditors())(c.getOriginalEditor()===e||c.getModifiedEditor()===e)&&c instanceof X&&this.runEditorCommand(o,c.getParentEditor(),...t);return}this.runInlineChatCommand(o,m,e,...t)}}class Oe extends i{constructor(){super({id:"inlineChat.arrowOutUp",title:E("arrowUp","Cursor Up"),precondition:n.and(H,re,g.isEmbeddedDiffEditor.negate(),w.negate()),keybinding:{weight:d.EditorCore,primary:C.CtrlCmd|a.UpArrow}})}runInlineChatCommand(o,e,t,...r){e.arrowOut(!0)}}class Re extends i{constructor(){super({id:"inlineChat.arrowOutDown",title:E("arrowDown","Cursor Down"),precondition:n.and(H,te,g.isEmbeddedDiffEditor.negate(),w.negate()),keybinding:{weight:d.EditorCore,primary:C.CtrlCmd|a.DownArrow}})}runInlineChatCommand(o,e,t,...r){e.arrowOut(!1)}}class Le extends S{constructor(){super({id:"inlineChat.focus",title:u("focus","Focus Input"),f1:!0,category:i.category,precondition:n.and(g.editorTextFocus,l,H.negate(),w.negate()),keybinding:[{weight:d.EditorCore+10,when:n.and(L.isEqualTo("above"),g.isEmbeddedDiffEditor.negate()),primary:C.CtrlCmd|a.DownArrow},{weight:d.EditorCore+10,when:n.and(L.isEqualTo("below"),g.isEmbeddedDiffEditor.negate()),primary:C.CtrlCmd|a.UpArrow}]})}runEditorCommand(o,e,...t){T.get(e)?.focus()}}class Pe extends i{constructor(){super({id:"inlineChat.discard",title:E("discard","Discard"),icon:p.discard,precondition:l,keybinding:{weight:d.EditorContrib-1,primary:a.Escape,when:ne.negate()}})}async runInlineChatCommand(o,e,t,...r){await e.cancelSession()}}class Me extends i{constructor(){super({id:k,title:u("apply1","Accept Changes"),shortTitle:E("apply2","Accept"),icon:p.check,f1:!0,precondition:n.and(l,n.or(ee.toNegated(),A.notEqualsTo(N.Preview))),keybinding:[{weight:d.WorkbenchContrib+10,primary:C.CtrlCmd|a.Enter}],menu:[{id:h,group:"0_main",order:1,when:n.and(v.toNegated(),y.toNegated(),_.isEqualTo(f.MessagesAndEdits))},{id:b,group:"navigation",order:1}]})}async runInlineChatCommand(o,e,t,r){e.acceptHunk(r)}}class Ue extends i{constructor(){super({id:j,title:E("discard","Discard"),icon:p.chromeClose,precondition:l,menu:[{id:h,group:"0_main",order:2,when:n.and(v.toNegated(),y.negate(),_.isEqualTo(f.MessagesAndEdits),A.isEqualTo(N.Live))},{id:b,group:"navigation",order:2}],keybinding:{weight:d.WorkbenchContrib,primary:a.Escape,when:_.isEqualTo(f.MessagesAndEdits)}})}async runInlineChatCommand(o,e,t,r){return e.discardHunk(r)}}class Fe extends i{constructor(){super({id:Y,title:u("chat.rerun.label","Rerun Request"),shortTitle:E("rerun","Rerun"),f1:!1,icon:p.refresh,precondition:l,menu:{id:h,group:"0_main",order:5,when:n.and(v.toNegated(),y.negate(),_.notEqualsTo(f.None))},keybinding:{weight:d.WorkbenchContrib,primary:C.CtrlCmd|a.KeyR}})}async runInlineChatCommand(o,e,t,...r){const I=o.get(Z),c=e.chatWidget.viewModel?.model?.getRequests().at(-1);c&&await I.resendRequest(c,{noCommandDetection:!1,attempt:c.attempt+1,location:e.chatWidget.location})}}class qe extends i{constructor(){super({id:"inlineChat.close",title:E("close","Close"),icon:p.close,precondition:l,keybinding:{weight:d.WorkbenchContrib,primary:a.Escape},menu:[{id:h,group:"0_main",order:1,when:n.and(y.negate(),n.or(_.isEqualTo(f.Messages),A.isEqualTo(N.Preview)))}]})}async runInlineChatCommand(o,e,t,...r){e.cancelSession()}}class Xe extends i{constructor(){super({id:"inlineChat.configure",title:u("configure","Configure Inline Chat"),icon:p.settingsGear,precondition:l,f1:!0,menu:{id:h,group:"zzz",order:5}})}async runInlineChatCommand(o,e,t,...r){o.get(V).openSettings({query:"inlineChat"})}}class We extends i{constructor(){super({id:"inlineChat.moveToNextHunk",title:u("moveToNextHunk","Move to Next Change"),precondition:l,f1:!0,keybinding:{weight:d.WorkbenchContrib,primary:a.F7}})}runInlineChatCommand(o,e,t,...r){e.moveHunk(!0)}}class Ge extends i{constructor(){super({id:"inlineChat.moveToPreviousHunk",title:u("moveToPreviousHunk","Move to Previous Change"),f1:!0,precondition:l,keybinding:{weight:d.WorkbenchContrib,primary:C.Shift|a.F7}})}runInlineChatCommand(o,e,t,...r){e.moveHunk(!1)}}class Ke extends i{constructor(){super({id:J,title:E("viewInChat","View in Chat"),icon:p.commentDiscussion,precondition:l,menu:[{id:h,group:"more",order:1,when:_.notEqualsTo(f.Messages)},{id:h,group:"0_main",order:1,when:n.and(v.toNegated(),_.isEqualTo(f.Messages),y.negate())}],keybinding:{weight:d.WorkbenchContrib,primary:C.CtrlCmd|a.DownArrow,when:B}})}runInlineChatCommand(o,e,t,...r){return e.viewInChat()}}class ze extends i{constructor(){super({id:Q,precondition:n.and(l,A.isEqualTo(N.Live),O),title:u("showChanges","Toggle Changes"),icon:p.diffSingle,toggled:{condition:$},menu:[{id:h,group:"zzz",when:n.and(A.isEqualTo(N.Live)),order:1},{id:b,group:"navigation",when:O,order:2}]})}runInlineChatCommand(o,e,t,r){e.toggleDiff(r)}}export{i as AbstractInlineChatAction,Me as AcceptChanges,Re as ArrowOutDownAction,Oe as ArrowOutUpAction,qe as CloseAction,Xe as ConfigureInlineChatAction,Pe as DiscardAction,Ue as DiscardHunkAction,Le as FocusInlineChat,se as LOCALIZED_START_INLINE_CHAT_STRING,We as MoveToNextHunk,Ge as MoveToPreviousHunk,Fe as RerunAction,ae as START_INLINE_CHAT,De as StartSessionAction,ze as ToggleDiffForChange,ke as UnstashSessionAction,Ke as ViewInChatAction,xe as setHoldForSpeech};
