{
  "version": 3,
  "sources": ["../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/contrib/inlineChat/browser/inlineChatSession.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { coalesceInPlace } from \"../../../../base/common/arrays.js\";\nimport { Emitter, Event } from \"../../../../base/common/event.js\";\nimport { Iterable } from \"../../../../base/common/iterator.js\";\nimport {\n\tDisposableStore,\n\ttype IDisposable,\n} from \"../../../../base/common/lifecycle.js\";\nimport type { URI } from \"../../../../base/common/uri.js\";\nimport type { ICodeEditor } from \"../../../../editor/browser/editorBrowser.js\";\nimport {\n\tEditOperation,\n\ttype ISingleEditOperation,\n} from \"../../../../editor/common/core/editOperation.js\";\nimport type { LineRange } from \"../../../../editor/common/core/lineRange.js\";\nimport { type IRange, Range } from \"../../../../editor/common/core/range.js\";\nimport type { IDocumentDiff } from \"../../../../editor/common/diff/documentDiffProvider.js\";\nimport {\n\tDetailedLineRangeMapping,\n\ttype LineRangeMapping,\n\ttype RangeMapping,\n} from \"../../../../editor/common/diff/rangeMapping.js\";\nimport {\n\ttype IIdentifiedSingleEditOperation,\n\ttype IModelDecorationOptions,\n\ttype IModelDeltaDecoration,\n\ttype ITextModel,\n\ttype IValidEditOperation,\n\tTrackedRangeStickiness,\n} from \"../../../../editor/common/model.js\";\nimport { ModelDecorationOptions } from \"../../../../editor/common/model/textModel.js\";\nimport { IEditorWorkerService } from \"../../../../editor/common/services/editorWorker.js\";\nimport type { IModelContentChangedEvent } from \"../../../../editor/common/textModelEvents.js\";\nimport {\n\ttype IContextKey,\n\tIContextKeyService,\n} from \"../../../../platform/contextkey/common/contextkey.js\";\nimport { ExtensionIdentifier } from \"../../../../platform/extensions/common/extensions.js\";\nimport { ILogService } from \"../../../../platform/log/common/log.js\";\nimport type { IChatAgent } from \"../../chat/common/chatAgents.js\";\nimport type {\n\tChatModel,\n\tIChatRequestModel,\n\tIChatTextEditGroupState,\n} from \"../../chat/common/chatModel.js\";\nimport {\n\tCTX_INLINE_CHAT_HAS_STASHED_SESSION,\n\ttype EditMode,\n} from \"../common/inlineChat.js\";\nimport { IInlineChatSessionService } from \"./inlineChatSessionService.js\";\n\nexport type TelemetryData = {\n\textension: string;\n\trounds: string;\n\tundos: string;\n\tunstashed: number;\n\tedits: number;\n\tfinishedByEdit: boolean;\n\tstartTime: string;\n\tendTime: string;\n\teditMode: string;\n\tacceptedHunks: number;\n\tdiscardedHunks: number;\n\tresponseTypes: string;\n};\n\nexport type TelemetryDataClassification = {\n\towner: \"jrieken\";\n\tcomment: \"Data about an interaction editor session\";\n\textension: {\n\t\tclassification: \"SystemMetaData\";\n\t\tpurpose: \"FeatureInsight\";\n\t\tcomment: \"The extension providing the data\";\n\t};\n\trounds: {\n\t\tclassification: \"SystemMetaData\";\n\t\tpurpose: \"FeatureInsight\";\n\t\tcomment: \"Number of request that were made\";\n\t};\n\tundos: {\n\t\tclassification: \"SystemMetaData\";\n\t\tpurpose: \"FeatureInsight\";\n\t\tcomment: \"Requests that have been undone\";\n\t};\n\tedits: {\n\t\tclassification: \"SystemMetaData\";\n\t\tpurpose: \"FeatureInsight\";\n\t\tcomment: \"Did edits happen while the session was active\";\n\t};\n\tunstashed: {\n\t\tclassification: \"SystemMetaData\";\n\t\tpurpose: \"FeatureInsight\";\n\t\tcomment: \"How often did this session become stashed and resumed\";\n\t};\n\tfinishedByEdit: {\n\t\tclassification: \"SystemMetaData\";\n\t\tpurpose: \"FeatureInsight\";\n\t\tcomment: \"Did edits cause the session to terminate\";\n\t};\n\tstartTime: {\n\t\tclassification: \"SystemMetaData\";\n\t\tpurpose: \"FeatureInsight\";\n\t\tcomment: \"When the session started\";\n\t};\n\tendTime: {\n\t\tclassification: \"SystemMetaData\";\n\t\tpurpose: \"FeatureInsight\";\n\t\tcomment: \"When the session ended\";\n\t};\n\teditMode: {\n\t\tclassification: \"SystemMetaData\";\n\t\tpurpose: \"FeatureInsight\";\n\t\tcomment: \"What edit mode was choosen: live, livePreview, preview\";\n\t};\n\tacceptedHunks: {\n\t\tclassification: \"SystemMetaData\";\n\t\tpurpose: \"FeatureInsight\";\n\t\tcomment: \"Number of accepted hunks\";\n\t};\n\tdiscardedHunks: {\n\t\tclassification: \"SystemMetaData\";\n\t\tpurpose: \"FeatureInsight\";\n\t\tcomment: \"Number of discarded hunks\";\n\t};\n\tresponseTypes: {\n\t\tclassification: \"SystemMetaData\";\n\t\tpurpose: \"FeatureInsight\";\n\t\tcomment: \"Comma separated list of response types like edits, message, mixed\";\n\t};\n};\n\nexport class SessionWholeRange {\n\tprivate static readonly _options: IModelDecorationOptions =\n\t\tModelDecorationOptions.register({\n\t\t\tdescription: \"inlineChat/session/wholeRange\",\n\t\t});\n\n\tprivate readonly _onDidChange = new Emitter<this>();\n\treadonly onDidChange: Event<this> = this._onDidChange.event;\n\n\tprivate _decorationIds: string[] = [];\n\n\tconstructor(\n\t\tprivate readonly _textModel: ITextModel,\n\t\twholeRange: IRange,\n\t) {\n\t\tthis._decorationIds = _textModel.deltaDecorations(\n\t\t\t[],\n\t\t\t[{ range: wholeRange, options: SessionWholeRange._options }],\n\t\t);\n\t}\n\n\tdispose() {\n\t\tthis._onDidChange.dispose();\n\t\tif (!this._textModel.isDisposed()) {\n\t\t\tthis._textModel.deltaDecorations(this._decorationIds, []);\n\t\t}\n\t}\n\n\tfixup(changes: readonly DetailedLineRangeMapping[]): void {\n\t\tconst newDeco: IModelDeltaDecoration[] = [];\n\t\tfor (const { modified } of changes) {\n\t\t\tconst modifiedRange = modified.isEmpty\n\t\t\t\t? new Range(\n\t\t\t\t\t\tmodified.startLineNumber,\n\t\t\t\t\t\t1,\n\t\t\t\t\t\tmodified.startLineNumber,\n\t\t\t\t\t\tthis._textModel.getLineLength(modified.startLineNumber),\n\t\t\t\t\t)\n\t\t\t\t: new Range(\n\t\t\t\t\t\tmodified.startLineNumber,\n\t\t\t\t\t\t1,\n\t\t\t\t\t\tmodified.endLineNumberExclusive - 1,\n\t\t\t\t\t\tthis._textModel.getLineLength(\n\t\t\t\t\t\t\tmodified.endLineNumberExclusive - 1,\n\t\t\t\t\t\t),\n\t\t\t\t\t);\n\n\t\t\tnewDeco.push({\n\t\t\t\trange: modifiedRange,\n\t\t\t\toptions: SessionWholeRange._options,\n\t\t\t});\n\t\t}\n\t\tconst [first, ...rest] = this._decorationIds; // first is the original whole range\n\t\tconst newIds = this._textModel.deltaDecorations(rest, newDeco);\n\t\tthis._decorationIds = [first].concat(newIds);\n\t\tthis._onDidChange.fire(this);\n\t}\n\n\tget trackedInitialRange(): Range {\n\t\tconst [first] = this._decorationIds;\n\t\treturn (\n\t\t\tthis._textModel.getDecorationRange(first) ?? new Range(1, 1, 1, 1)\n\t\t);\n\t}\n\n\tget value(): Range {\n\t\tlet result: Range | undefined;\n\t\tfor (const id of this._decorationIds) {\n\t\t\tconst range = this._textModel.getDecorationRange(id);\n\t\t\tif (range) {\n\t\t\t\tif (result) {\n\t\t\t\t\tresult = Range.plusRange(result, range);\n\t\t\t\t} else {\n\t\t\t\t\tresult = range;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn result!;\n\t}\n}\n\nexport class Session {\n\tprivate _isUnstashed = false;\n\tprivate readonly _startTime = new Date();\n\tprivate readonly _teldata: TelemetryData;\n\n\tprivate readonly _versionByRequest = new Map<string, number>();\n\n\tconstructor(\n\t\treadonly editMode: EditMode,\n\t\treadonly headless: boolean,\n\t\t/**\n\t\t * The URI of the document which is being EditorEdit\n\t\t */\n\t\treadonly targetUri: URI,\n\t\t/**\n\t\t * A copy of the document at the time the session was started\n\t\t */\n\t\treadonly textModel0: ITextModel,\n\t\t/**\n\t\t * The model of the editor\n\t\t */\n\t\treadonly textModelN: ITextModel,\n\t\treadonly agent: IChatAgent,\n\t\treadonly wholeRange: SessionWholeRange,\n\t\treadonly hunkData: HunkData,\n\t\treadonly chatModel: ChatModel,\n\t\tversionsByRequest?: [string, number][], // DEBT? this is needed when a chat model is \"reused\" for a new chat session\n\t) {\n\t\tthis._teldata = {\n\t\t\textension: ExtensionIdentifier.toKey(agent.extensionId),\n\t\t\tstartTime: this._startTime.toISOString(),\n\t\t\tendTime: this._startTime.toISOString(),\n\t\t\tedits: 0,\n\t\t\tfinishedByEdit: false,\n\t\t\trounds: \"\",\n\t\t\tundos: \"\",\n\t\t\teditMode,\n\t\t\tunstashed: 0,\n\t\t\tacceptedHunks: 0,\n\t\t\tdiscardedHunks: 0,\n\t\t\tresponseTypes: \"\",\n\t\t};\n\t\tif (versionsByRequest) {\n\t\t\tthis._versionByRequest = new Map(versionsByRequest);\n\t\t}\n\t}\n\n\tget isUnstashed(): boolean {\n\t\treturn this._isUnstashed;\n\t}\n\n\tmarkUnstashed() {\n\t\tthis._teldata.unstashed! += 1;\n\t\tthis._isUnstashed = true;\n\t}\n\n\tmarkModelVersion(request: IChatRequestModel) {\n\t\tthis._versionByRequest.set(\n\t\t\trequest.id,\n\t\t\tthis.textModelN.getAlternativeVersionId(),\n\t\t);\n\t}\n\n\tget versionsByRequest() {\n\t\treturn Array.from(this._versionByRequest);\n\t}\n\n\tasync undoChangesUntil(requestId: string): Promise<boolean> {\n\t\tconst targetAltVersion = this._versionByRequest.get(requestId);\n\t\tif (targetAltVersion === undefined) {\n\t\t\treturn false;\n\t\t}\n\t\t// undo till this point\n\t\tthis.hunkData.ignoreTextModelNChanges = true;\n\t\ttry {\n\t\t\twhile (\n\t\t\t\ttargetAltVersion < this.textModelN.getAlternativeVersionId() &&\n\t\t\t\tthis.textModelN.canUndo()\n\t\t\t) {\n\t\t\t\tawait this.textModelN.undo();\n\t\t\t}\n\t\t} finally {\n\t\t\tthis.hunkData.ignoreTextModelNChanges = false;\n\t\t}\n\t\treturn true;\n\t}\n\n\tget hasChangedText(): boolean {\n\t\treturn !this.textModel0.equalsTextBuffer(\n\t\t\tthis.textModelN.getTextBuffer(),\n\t\t);\n\t}\n\n\tasChangedText(changes: readonly LineRangeMapping[]): string | undefined {\n\t\tif (changes.length === 0) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tlet startLine = Number.MAX_VALUE;\n\t\tlet endLine = Number.MIN_VALUE;\n\t\tfor (const change of changes) {\n\t\t\tstartLine = Math.min(startLine, change.modified.startLineNumber);\n\t\t\tendLine = Math.max(endLine, change.modified.endLineNumberExclusive);\n\t\t}\n\n\t\treturn this.textModelN.getValueInRange(\n\t\t\tnew Range(startLine, 1, endLine, Number.MAX_VALUE),\n\t\t);\n\t}\n\n\trecordExternalEditOccurred(didFinish: boolean) {\n\t\tthis._teldata.edits += 1;\n\t\tthis._teldata.finishedByEdit = didFinish;\n\t}\n\n\tasTelemetryData(): TelemetryData {\n\t\tfor (const item of this.hunkData.getInfo()) {\n\t\t\tswitch (item.getState()) {\n\t\t\t\tcase HunkState.Accepted:\n\t\t\t\t\tthis._teldata.acceptedHunks += 1;\n\t\t\t\t\tbreak;\n\t\t\t\tcase HunkState.Rejected:\n\t\t\t\t\tthis._teldata.discardedHunks += 1;\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tthis._teldata.endTime = new Date().toISOString();\n\t\treturn this._teldata;\n\t}\n}\n\nexport class StashedSession {\n\tprivate readonly _listener: IDisposable;\n\tprivate readonly _ctxHasStashedSession: IContextKey<boolean>;\n\tprivate _session: Session | undefined;\n\n\tconstructor(\n\t\teditor: ICodeEditor,\n\t\tsession: Session,\n\t\tprivate readonly _undoCancelEdits: IValidEditOperation[],\n\t\t@IContextKeyService contextKeyService: IContextKeyService,\n\t\t@IInlineChatSessionService\n\t\tprivate readonly _sessionService: IInlineChatSessionService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t) {\n\t\tthis._ctxHasStashedSession =\n\t\t\tCTX_INLINE_CHAT_HAS_STASHED_SESSION.bindTo(contextKeyService);\n\n\t\t// keep session for a little bit, only release when user continues to work (type, move cursor, etc.)\n\t\tthis._session = session;\n\t\tthis._ctxHasStashedSession.set(true);\n\t\tthis._listener = Event.once(\n\t\t\tEvent.any(\n\t\t\t\teditor.onDidChangeCursorSelection,\n\t\t\t\teditor.onDidChangeModelContent,\n\t\t\t\teditor.onDidChangeModel,\n\t\t\t\teditor.onDidBlurEditorWidget,\n\t\t\t),\n\t\t)(() => {\n\t\t\tthis._session = undefined;\n\t\t\tthis._sessionService.releaseSession(session);\n\t\t\tthis._ctxHasStashedSession.reset();\n\t\t});\n\t}\n\n\tdispose() {\n\t\tthis._listener.dispose();\n\t\tthis._ctxHasStashedSession.reset();\n\t\tif (this._session) {\n\t\t\tthis._sessionService.releaseSession(this._session);\n\t\t}\n\t}\n\n\tunstash(): Session | undefined {\n\t\tif (!this._session) {\n\t\t\treturn undefined;\n\t\t}\n\t\tthis._listener.dispose();\n\t\tconst result = this._session;\n\t\tresult.markUnstashed();\n\t\tresult.hunkData.ignoreTextModelNChanges = true;\n\t\tresult.textModelN.pushEditOperations(\n\t\t\tnull,\n\t\t\tthis._undoCancelEdits,\n\t\t\t() => null,\n\t\t);\n\t\tresult.hunkData.ignoreTextModelNChanges = false;\n\t\tthis._session = undefined;\n\t\tthis._logService.debug(\"[IE] Unstashed session\");\n\t\treturn result;\n\t}\n}\n\n// ---\n\nfunction lineRangeAsRange(lineRange: LineRange, model: ITextModel): Range {\n\treturn lineRange.isEmpty\n\t\t? new Range(\n\t\t\t\tlineRange.startLineNumber,\n\t\t\t\t1,\n\t\t\t\tlineRange.startLineNumber,\n\t\t\t\tmodel.getLineLength(lineRange.startLineNumber),\n\t\t\t)\n\t\t: new Range(\n\t\t\t\tlineRange.startLineNumber,\n\t\t\t\t1,\n\t\t\t\tlineRange.endLineNumberExclusive - 1,\n\t\t\t\tmodel.getLineLength(lineRange.endLineNumberExclusive - 1),\n\t\t\t);\n}\n\nexport class HunkData {\n\tprivate static readonly _HUNK_TRACKED_RANGE =\n\t\tModelDecorationOptions.register({\n\t\t\tdescription: \"inline-chat-hunk-tracked-range\",\n\t\t\tstickiness: TrackedRangeStickiness.AlwaysGrowsWhenTypingAtEdges,\n\t\t});\n\n\tprivate static readonly _HUNK_THRESHOLD = 8;\n\n\tprivate readonly _store = new DisposableStore();\n\tprivate readonly _data = new Map<RawHunk, RawHunkData>();\n\tprivate _ignoreChanges = false;\n\n\tconstructor(\n\t\t@IEditorWorkerService\n\t\tprivate readonly _editorWorkerService: IEditorWorkerService,\n\t\tprivate readonly _textModel0: ITextModel,\n\t\tprivate readonly _textModelN: ITextModel,\n\t) {\n\t\tthis._store.add(\n\t\t\t_textModelN.onDidChangeContent((e) => {\n\t\t\t\tif (!this._ignoreChanges) {\n\t\t\t\t\tthis._mirrorChanges(e);\n\t\t\t\t}\n\t\t\t}),\n\t\t);\n\t}\n\n\tdispose(): void {\n\t\tif (!this._textModelN.isDisposed()) {\n\t\t\tthis._textModelN.changeDecorations((accessor) => {\n\t\t\t\tfor (const { textModelNDecorations } of this._data.values()) {\n\t\t\t\t\ttextModelNDecorations.forEach(\n\t\t\t\t\t\taccessor.removeDecoration,\n\t\t\t\t\t\taccessor,\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tif (!this._textModel0.isDisposed()) {\n\t\t\tthis._textModel0.changeDecorations((accessor) => {\n\t\t\t\tfor (const { textModel0Decorations } of this._data.values()) {\n\t\t\t\t\ttextModel0Decorations.forEach(\n\t\t\t\t\t\taccessor.removeDecoration,\n\t\t\t\t\t\taccessor,\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tthis._data.clear();\n\t\tthis._store.dispose();\n\t}\n\n\tset ignoreTextModelNChanges(value: boolean) {\n\t\tthis._ignoreChanges = value;\n\t}\n\n\tget ignoreTextModelNChanges(): boolean {\n\t\treturn this._ignoreChanges;\n\t}\n\n\tprivate _mirrorChanges(event: IModelContentChangedEvent) {\n\t\t// mirror textModelN changes to textModel0 execept for those that\n\t\t// overlap with a hunk\n\n\t\ttype HunkRangePair = {\n\t\t\trangeN: Range;\n\t\t\trange0: Range;\n\t\t\tmarkAccepted: () => void;\n\t\t};\n\t\tconst hunkRanges: HunkRangePair[] = [];\n\n\t\tconst ranges0: Range[] = [];\n\n\t\tfor (const entry of this._data.values()) {\n\t\t\tif (entry.state === HunkState.Pending) {\n\t\t\t\t// pending means the hunk's changes aren't \"sync'd\" yet\n\t\t\t\tfor (let i = 1; i < entry.textModelNDecorations.length; i++) {\n\t\t\t\t\tconst rangeN = this._textModelN.getDecorationRange(\n\t\t\t\t\t\tentry.textModelNDecorations[i],\n\t\t\t\t\t);\n\t\t\t\t\tconst range0 = this._textModel0.getDecorationRange(\n\t\t\t\t\t\tentry.textModel0Decorations[i],\n\t\t\t\t\t);\n\t\t\t\t\tif (rangeN && range0) {\n\t\t\t\t\t\thunkRanges.push({\n\t\t\t\t\t\t\trangeN,\n\t\t\t\t\t\t\trange0,\n\t\t\t\t\t\t\tmarkAccepted: () =>\n\t\t\t\t\t\t\t\t(entry.state = HunkState.Accepted),\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else if (entry.state === HunkState.Accepted) {\n\t\t\t\t// accepted means the hunk's changes are also in textModel0\n\t\t\t\tfor (let i = 1; i < entry.textModel0Decorations.length; i++) {\n\t\t\t\t\tconst range = this._textModel0.getDecorationRange(\n\t\t\t\t\t\tentry.textModel0Decorations[i],\n\t\t\t\t\t);\n\t\t\t\t\tif (range) {\n\t\t\t\t\t\tranges0.push(range);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\thunkRanges.sort((a, b) =>\n\t\t\tRange.compareRangesUsingStarts(a.rangeN, b.rangeN),\n\t\t);\n\t\tranges0.sort(Range.compareRangesUsingStarts);\n\n\t\tconst edits: IIdentifiedSingleEditOperation[] = [];\n\n\t\tfor (const change of event.changes) {\n\t\t\tlet isOverlapping = false;\n\n\t\t\tlet pendingChangesLen = 0;\n\n\t\t\tfor (const entry of hunkRanges) {\n\t\t\t\tif (\n\t\t\t\t\tentry.rangeN\n\t\t\t\t\t\t.getEndPosition()\n\t\t\t\t\t\t.isBefore(Range.getStartPosition(change.range))\n\t\t\t\t) {\n\t\t\t\t\t// pending hunk _before_ this change. When projecting into textModel0 we need to\n\t\t\t\t\t// subtract that. Because diffing is relaxed it might include changes that are not\n\t\t\t\t\t// actual insertions/deletions. Therefore we need to take the length of the original\n\t\t\t\t\t// range into account.\n\t\t\t\t\tpendingChangesLen += this._textModelN.getValueLengthInRange(\n\t\t\t\t\t\tentry.rangeN,\n\t\t\t\t\t);\n\t\t\t\t\tpendingChangesLen -= this._textModel0.getValueLengthInRange(\n\t\t\t\t\t\tentry.range0,\n\t\t\t\t\t);\n\t\t\t\t} else if (\n\t\t\t\t\tRange.areIntersectingOrTouching(entry.rangeN, change.range)\n\t\t\t\t) {\n\t\t\t\t\t// an edit overlaps with a (pending) hunk. We take this as a signal\n\t\t\t\t\t// to mark the hunk as accepted and to ignore the edit. The range of the hunk\n\t\t\t\t\t// will be up-to-date because of decorations created for them\n\t\t\t\t\tentry.markAccepted();\n\t\t\t\t\tisOverlapping = true;\n\t\t\t\t\tbreak;\n\t\t\t\t} else {\n\t\t\t\t\t// hunks past this change aren't relevant\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (isOverlapping) {\n\t\t\t\t// hunk overlaps, it grew\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst offset0 = change.rangeOffset - pendingChangesLen;\n\t\t\tconst start0 = this._textModel0.getPositionAt(offset0);\n\n\t\t\tlet acceptedChangesLen = 0;\n\t\t\tfor (const range of ranges0) {\n\t\t\t\tif (range.getEndPosition().isBefore(start0)) {\n\t\t\t\t\t// accepted hunk _before_ this projected change. When projecting into textModel0\n\t\t\t\t\t// we need to add that\n\t\t\t\t\tacceptedChangesLen +=\n\t\t\t\t\t\tthis._textModel0.getValueLengthInRange(range);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst start = this._textModel0.getPositionAt(\n\t\t\t\toffset0 + acceptedChangesLen,\n\t\t\t);\n\t\t\tconst end = this._textModel0.getPositionAt(\n\t\t\t\toffset0 + acceptedChangesLen + change.rangeLength,\n\t\t\t);\n\t\t\tedits.push(\n\t\t\t\tEditOperation.replace(\n\t\t\t\t\tRange.fromPositions(start, end),\n\t\t\t\t\tchange.text,\n\t\t\t\t),\n\t\t\t);\n\t\t}\n\n\t\tthis._textModel0.pushEditOperations(null, edits, () => null);\n\t}\n\n\tasync recompute(\n\t\teditState: IChatTextEditGroupState,\n\t\tdiff?: IDocumentDiff | null,\n\t) {\n\t\tdiff ??= await this._editorWorkerService.computeDiff(\n\t\t\tthis._textModel0.uri,\n\t\t\tthis._textModelN.uri,\n\t\t\t{\n\t\t\t\tignoreTrimWhitespace: false,\n\t\t\t\tmaxComputationTimeMs: Number.MAX_SAFE_INTEGER,\n\t\t\t\tcomputeMoves: false,\n\t\t\t},\n\t\t\t\"advanced\",\n\t\t);\n\n\t\tlet mergedChanges: DetailedLineRangeMapping[] = [];\n\n\t\tif (diff && diff.changes.length > 0) {\n\t\t\t// merge changes neighboring changes\n\t\t\tmergedChanges = [diff.changes[0]];\n\t\t\tfor (let i = 1; i < diff.changes.length; i++) {\n\t\t\t\tconst lastChange = mergedChanges[mergedChanges.length - 1];\n\t\t\t\tconst thisChange = diff.changes[i];\n\t\t\t\tif (\n\t\t\t\t\tthisChange.modified.startLineNumber -\n\t\t\t\t\t\tlastChange.modified.endLineNumberExclusive <=\n\t\t\t\t\tHunkData._HUNK_THRESHOLD\n\t\t\t\t) {\n\t\t\t\t\tmergedChanges[mergedChanges.length - 1] =\n\t\t\t\t\t\tnew DetailedLineRangeMapping(\n\t\t\t\t\t\t\tlastChange.original.join(thisChange.original),\n\t\t\t\t\t\t\tlastChange.modified.join(thisChange.modified),\n\t\t\t\t\t\t\t(lastChange.innerChanges ?? []).concat(\n\t\t\t\t\t\t\t\tthisChange.innerChanges ?? [],\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\tmergedChanges.push(thisChange);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst hunks = mergedChanges.map(\n\t\t\t(change) =>\n\t\t\t\tnew RawHunk(\n\t\t\t\t\tchange.original,\n\t\t\t\t\tchange.modified,\n\t\t\t\t\tchange.innerChanges ?? [],\n\t\t\t\t),\n\t\t);\n\n\t\teditState.applied = hunks.length;\n\n\t\tthis._textModelN.changeDecorations((accessorN) => {\n\t\t\tthis._textModel0.changeDecorations((accessor0) => {\n\t\t\t\t// clean up old decorations\n\t\t\t\tfor (const {\n\t\t\t\t\ttextModelNDecorations,\n\t\t\t\t\ttextModel0Decorations,\n\t\t\t\t} of this._data.values()) {\n\t\t\t\t\ttextModelNDecorations.forEach(\n\t\t\t\t\t\taccessorN.removeDecoration,\n\t\t\t\t\t\taccessorN,\n\t\t\t\t\t);\n\t\t\t\t\ttextModel0Decorations.forEach(\n\t\t\t\t\t\taccessor0.removeDecoration,\n\t\t\t\t\t\taccessor0,\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tthis._data.clear();\n\n\t\t\t\t// add new decorations\n\t\t\t\tfor (const hunk of hunks) {\n\t\t\t\t\tconst textModelNDecorations: string[] = [];\n\t\t\t\t\tconst textModel0Decorations: string[] = [];\n\n\t\t\t\t\ttextModelNDecorations.push(\n\t\t\t\t\t\taccessorN.addDecoration(\n\t\t\t\t\t\t\tlineRangeAsRange(hunk.modified, this._textModelN),\n\t\t\t\t\t\t\tHunkData._HUNK_TRACKED_RANGE,\n\t\t\t\t\t\t),\n\t\t\t\t\t);\n\t\t\t\t\ttextModel0Decorations.push(\n\t\t\t\t\t\taccessor0.addDecoration(\n\t\t\t\t\t\t\tlineRangeAsRange(hunk.original, this._textModel0),\n\t\t\t\t\t\t\tHunkData._HUNK_TRACKED_RANGE,\n\t\t\t\t\t\t),\n\t\t\t\t\t);\n\n\t\t\t\t\tfor (const change of hunk.changes) {\n\t\t\t\t\t\ttextModelNDecorations.push(\n\t\t\t\t\t\t\taccessorN.addDecoration(\n\t\t\t\t\t\t\t\tchange.modifiedRange,\n\t\t\t\t\t\t\t\tHunkData._HUNK_TRACKED_RANGE,\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t);\n\t\t\t\t\t\ttextModel0Decorations.push(\n\t\t\t\t\t\t\taccessor0.addDecoration(\n\t\t\t\t\t\t\t\tchange.originalRange,\n\t\t\t\t\t\t\t\tHunkData._HUNK_TRACKED_RANGE,\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis._data.set(hunk, {\n\t\t\t\t\t\teditState,\n\t\t\t\t\t\ttextModelNDecorations,\n\t\t\t\t\t\ttextModel0Decorations,\n\t\t\t\t\t\tstate: HunkState.Pending,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tget size(): number {\n\t\treturn this._data.size;\n\t}\n\n\tget pending(): number {\n\t\treturn Iterable.reduce(\n\t\t\tthis._data.values(),\n\t\t\t(r, { state }) => r + (state === HunkState.Pending ? 1 : 0),\n\t\t\t0,\n\t\t);\n\t}\n\n\tprivate _discardEdits(item: HunkInformation): ISingleEditOperation[] {\n\t\tconst edits: ISingleEditOperation[] = [];\n\t\tconst rangesN = item.getRangesN();\n\t\tconst ranges0 = item.getRanges0();\n\t\tfor (let i = 1; i < rangesN.length; i++) {\n\t\t\tconst modifiedRange = rangesN[i];\n\n\t\t\tconst originalValue = this._textModel0.getValueInRange(ranges0[i]);\n\t\t\tedits.push(EditOperation.replace(modifiedRange, originalValue));\n\t\t}\n\t\treturn edits;\n\t}\n\n\tdiscardAll() {\n\t\tconst edits: ISingleEditOperation[][] = [];\n\t\tfor (const item of this.getInfo()) {\n\t\t\tif (item.getState() === HunkState.Pending) {\n\t\t\t\tedits.push(this._discardEdits(item));\n\t\t\t}\n\t\t}\n\t\tconst undoEdits: IValidEditOperation[][] = [];\n\t\tthis._textModelN.pushEditOperations(\n\t\t\tnull,\n\t\t\tedits.flat(),\n\t\t\t(_undoEdits) => {\n\t\t\t\tundoEdits.push(_undoEdits);\n\t\t\t\treturn null;\n\t\t\t},\n\t\t);\n\t\treturn undoEdits.flat();\n\t}\n\n\tgetInfo(): HunkInformation[] {\n\t\tconst result: HunkInformation[] = [];\n\n\t\tfor (const [hunk, data] of this._data.entries()) {\n\t\t\tconst item: HunkInformation = {\n\t\t\t\tgetState: () => {\n\t\t\t\t\treturn data.state;\n\t\t\t\t},\n\t\t\t\tisInsertion: () => {\n\t\t\t\t\treturn hunk.original.isEmpty;\n\t\t\t\t},\n\t\t\t\tgetRangesN: () => {\n\t\t\t\t\tconst ranges = data.textModelNDecorations.map((id) =>\n\t\t\t\t\t\tthis._textModelN.getDecorationRange(id),\n\t\t\t\t\t);\n\t\t\t\t\tcoalesceInPlace(ranges);\n\t\t\t\t\treturn ranges;\n\t\t\t\t},\n\t\t\t\tgetRanges0: () => {\n\t\t\t\t\tconst ranges = data.textModel0Decorations.map((id) =>\n\t\t\t\t\t\tthis._textModel0.getDecorationRange(id),\n\t\t\t\t\t);\n\t\t\t\t\tcoalesceInPlace(ranges);\n\t\t\t\t\treturn ranges;\n\t\t\t\t},\n\t\t\t\tdiscardChanges: () => {\n\t\t\t\t\t// DISCARD: replace modified range with original value. The modified range is retrieved from a decoration\n\t\t\t\t\t// which was created above so that typing in the editor keeps discard working.\n\t\t\t\t\tif (data.state === HunkState.Pending) {\n\t\t\t\t\t\tconst edits = this._discardEdits(item);\n\t\t\t\t\t\tthis._textModelN.pushEditOperations(\n\t\t\t\t\t\t\tnull,\n\t\t\t\t\t\t\tedits,\n\t\t\t\t\t\t\t() => null,\n\t\t\t\t\t\t);\n\t\t\t\t\t\tdata.state = HunkState.Rejected;\n\t\t\t\t\t\tif (data.editState.applied > 0) {\n\t\t\t\t\t\t\tdata.editState.applied -= 1;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tacceptChanges: () => {\n\t\t\t\t\t// ACCEPT: replace original range with modified value. The modified value is retrieved from the model via\n\t\t\t\t\t// its decoration and the original range is retrieved from the hunk.\n\t\t\t\t\tif (data.state === HunkState.Pending) {\n\t\t\t\t\t\tconst edits: ISingleEditOperation[] = [];\n\t\t\t\t\t\tconst rangesN = item.getRangesN();\n\t\t\t\t\t\tconst ranges0 = item.getRanges0();\n\t\t\t\t\t\tfor (let i = 1; i < ranges0.length; i++) {\n\t\t\t\t\t\t\tconst originalRange = ranges0[i];\n\t\t\t\t\t\t\tconst modifiedValue =\n\t\t\t\t\t\t\t\tthis._textModelN.getValueInRange(rangesN[i]);\n\t\t\t\t\t\t\tedits.push(\n\t\t\t\t\t\t\t\tEditOperation.replace(\n\t\t\t\t\t\t\t\t\toriginalRange,\n\t\t\t\t\t\t\t\t\tmodifiedValue,\n\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tthis._textModel0.pushEditOperations(\n\t\t\t\t\t\t\tnull,\n\t\t\t\t\t\t\tedits,\n\t\t\t\t\t\t\t() => null,\n\t\t\t\t\t\t);\n\t\t\t\t\t\tdata.state = HunkState.Accepted;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t};\n\t\t\tresult.push(item);\n\t\t}\n\n\t\treturn result;\n\t}\n}\n\nclass RawHunk {\n\tconstructor(\n\t\treadonly original: LineRange,\n\t\treadonly modified: LineRange,\n\t\treadonly changes: RangeMapping[],\n\t) {}\n}\n\ntype RawHunkData = {\n\ttextModelNDecorations: string[];\n\ttextModel0Decorations: string[];\n\tstate: HunkState;\n\teditState: IChatTextEditGroupState;\n};\n\nexport enum HunkState {\n\tPending = 0,\n\tAccepted = 1,\n\tRejected = 2,\n}\n\nexport interface HunkInformation {\n\t/**\n\t * The first element [0] is the whole modified range and subsequent elements are word-level changes\n\t */\n\tgetRangesN(): Range[];\n\n\tgetRanges0(): Range[];\n\n\tisInsertion(): boolean;\n\n\tdiscardChanges(): void;\n\n\t/**\n\t * Accept the hunk. Applies the corresponding edits into textModel0\n\t */\n\tacceptChanges(): void;\n\n\tgetState(): HunkState;\n}\n"],
  "mappings": "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",
  "names": ["HunkState"]
}
