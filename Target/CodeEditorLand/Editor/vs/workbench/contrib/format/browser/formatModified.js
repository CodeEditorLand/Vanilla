import{isNonEmptyArray as m}from"../../../../../vs/base/common/arrays.js";import{CancellationToken as u}from"../../../../../vs/base/common/cancellation.js";import"../../../../../vs/editor/browser/editorBrowser.js";import{EditorAction as l,registerEditorAction as g}from"../../../../../vs/editor/browser/editorExtensions.js";import{Range as p}from"../../../../../vs/editor/common/core/range.js";import{EditorContextKeys as f}from"../../../../../vs/editor/common/editorContextKeys.js";import{shouldSynchronizeModel as v}from"../../../../../vs/editor/common/model.js";import{IEditorWorkerService as S}from"../../../../../vs/editor/common/services/editorWorker.js";import{ITextModelService as E}from"../../../../../vs/editor/common/services/resolverService.js";import{formatDocumentRangesWithSelectedProvider as M,FormattingMode as y}from"../../../../../vs/editor/contrib/format/browser/format.js";import*as I from"../../../../../vs/nls.js";import{ContextKeyExpr as h}from"../../../../../vs/platform/contextkey/common/contextkey.js";import{IInstantiationService as x}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{Progress as A}from"../../../../../vs/platform/progress/common/progress.js";import{getOriginalResource as R}from"../../../../../vs/workbench/contrib/scm/browser/dirtydiffDecorator.js";import{IQuickDiffService as C}from"../../../../../vs/workbench/contrib/scm/common/quickDiff.js";g(class extends l{constructor(){super({id:"editor.action.formatChanges",label:I.localize("formatChanges","Format Modified Lines"),alias:"Format Modified Lines",precondition:h.and(f.writable,f.hasDocumentSelectionFormattingProvider)})}async run(e,r){const o=e.get(x);if(!r.hasModel())return;const t=await o.invokeFunction(D,r.getModel());if(m(t))return o.invokeFunction(M,r,t,y.Explicit,A.None,u.None,!0)}});async function D(i,e){const r=i.get(C),o=i.get(S),t=i.get(E),n=await R(r,e.uri,e.getLanguageId(),v(e));if(!n)return null;const c=[],d=await t.createModelReference(n);try{if(!o.canComputeDirtyDiff(n,e.uri))return;const s=await o.computeDirtyDiff(n,e.uri,!1);if(!m(s))return;for(const a of s)c.push(e.validateRange(new p(a.modifiedStartLineNumber,1,a.modifiedEndLineNumber||a.modifiedStartLineNumber,Number.MAX_SAFE_INTEGER)))}finally{d.dispose()}return c}export{D as getModifiedRanges};
