var Q=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var k=(m,s,t,e)=>{for(var i=e>1?void 0:e?K(s,t):s,r=m.length-1,n;r>=0;r--)(n=m[r])&&(i=(e?n(s,t,i):n(i))||i);return e&&i&&Q(s,t,i),i},u=(m,s)=>(t,e)=>s(t,e,m);import{CancellationToken as F,CancellationTokenSource as V}from"../../../../base/common/cancellation.js";import{Disposable as q,DisposableStore as O,toDisposable as H}from"../../../../base/common/lifecycle.js";import{generateUuid as B}from"../../../../base/common/uuid.js";import{getCodeEditor as j}from"../../../../editor/browser/editorBrowser.js";import{EditorAction as E,registerEditorAction as P}from"../../../../editor/browser/editorExtensions.js";import{editorConfigurationBaseNode as $}from"../../../../editor/common/config/editorConfigurationSchema.js";import{Range as U}from"../../../../editor/common/core/range.js";import{EditorContextKeys as I}from"../../../../editor/common/editorContextKeys.js";import{ILanguageService as C}from"../../../../editor/common/languages/language.js";import{ILanguageFeaturesService as y}from"../../../../editor/common/services/languageFeatures.js";import{FormattingConflicts as G,FormattingKind as _,FormattingMode as L,formatDocumentRangesWithProvider as J,formatDocumentWithProvider as X,getRealAndSyntheticDocumentFormattersOrdered as N}from"../../../../editor/contrib/format/browser/format.js";import*as d from"../../../../nls.js";import{CommandsRegistry as Y}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as T}from"../../../../platform/configuration/common/configuration.js";import{Extensions as Z}from"../../../../platform/configuration/common/configurationRegistry.js";import{ContextKeyExpr as x}from"../../../../platform/contextkey/common/contextkey.js";import{IDialogService as ee}from"../../../../platform/dialogs/common/dialogs.js";import{ExtensionIdentifier as b}from"../../../../platform/extensions/common/extensions.js";import{IInstantiationService as w}from"../../../../platform/instantiation/common/instantiation.js";import{INotificationService as te,NotificationPriority as ie,Severity as D}from"../../../../platform/notification/common/notification.js";import{IQuickInputService as M}from"../../../../platform/quickinput/common/quickInput.js";import{Registry as z}from"../../../../platform/registry/common/platform.js";import{ITelemetryService as R}from"../../../../platform/telemetry/common/telemetry.js";import{Extensions as ne}from"../../../common/contributions.js";import{IEditorService as oe}from"../../../services/editor/common/editorService.js";import{IWorkbenchExtensionEnablementService as re}from"../../../services/extensionManagement/common/extensionManagement.js";import{IExtensionService as ae,toExtension as se}from"../../../services/extensions/common/extensions.js";import{ILanguageStatusService as ce}from"../../../services/languageStatus/common/languageStatusService.js";import{LifecyclePhase as de}from"../../../services/lifecycle/common/lifecycle.js";let a=class extends q{constructor(t,e,i,r,n,o,l,c,g,v){super();this._extensionService=t;this._extensionEnablementService=e;this._configService=i;this._notificationService=r;this._dialogService=n;this._quickInputService=o;this._languageService=l;this._languageFeaturesService=c;this._languageStatusService=g;this._editorService=v;this._store.add(this._extensionService.onDidChangeExtensions(this._updateConfigValues,this)),this._store.add(G.setFormatterSelector((f,p,h,S)=>this._selectFormatter(f,p,h,S))),this._store.add(v.onDidActiveEditorChange(this._updateStatus,this)),this._store.add(c.documentFormattingEditProvider.onDidChange(this._updateStatus,this)),this._store.add(c.documentRangeFormattingEditProvider.onDidChange(this._updateStatus,this)),this._store.add(i.onDidChangeConfiguration(f=>f.affectsConfiguration(a.configName)&&this._updateStatus())),this._updateConfigValues()}static configName="editor.defaultFormatter";static extensionIds=[];static extensionItemLabels=[];static extensionDescriptions=[];_languageStatusStore=this._store.add(new O);async _updateConfigValues(){await this._extensionService.whenInstalledExtensionsRegistered();let t=[...this._extensionService.extensions];t=t.sort((e,i)=>{const r=e.categories?.find(o=>o==="Formatters"||o==="Programming Languages"),n=i.categories?.find(o=>o==="Formatters"||o==="Programming Languages");return r&&!n?-1:!r&&n?1:e.name.localeCompare(i.name)}),a.extensionIds.length=0,a.extensionItemLabels.length=0,a.extensionDescriptions.length=0,a.extensionIds.push(null),a.extensionItemLabels.push(d.localize("null","None")),a.extensionDescriptions.push(d.localize("nullFormatterDescription","None"));for(const e of t)(e.main||e.browser)&&(a.extensionIds.push(e.identifier.value),a.extensionItemLabels.push(e.displayName??""),a.extensionDescriptions.push(e.description??""))}static _maybeQuotes(t){return t.match(/\s/)?`'${t}'`:t}async _analyzeFormatter(t,e,i){const r=this._configService.getValue(a.configName,{resource:i.uri,overrideIdentifier:i.getLanguageId()});if(r){const l=e.find(g=>b.equals(g.extensionId,r));if(l)return l;const c=await this._extensionService.getExtension(r);if(c&&this._extensionEnablementService.isEnabled(se(c))){const g=this._languageService.getLanguageName(i.getLanguageId())||i.getLanguageId();return t===_.File?d.localize("miss.1","Extension '{0}' is configured as formatter but it cannot format '{1}'-files",c.displayName||c.name,g):d.localize("miss.2","Extension '{0}' is configured as formatter but it can only format '{1}'-files as a whole, not selections or parts of it.",c.displayName||c.name,g)}}else if(e.length===1)return e[0];const n=this._languageService.getLanguageName(i.getLanguageId())||i.getLanguageId();return r?d.localize("config.bad","Extension '{0}' is configured as formatter but not available. Select a different default formatter to continue.",r):d.localize("config.needed","There are multiple formatters for '{0}' files. One of them should be configured as default formatter.",a._maybeQuotes(n))}async _selectFormatter(t,e,i,r){const n=await this._analyzeFormatter(r,t,e);if(typeof n!="string")return n;if(i!==L.Silent){const{confirmed:o}=await this._dialogService.confirm({message:d.localize("miss","Configure Default Formatter"),detail:n,primaryButton:d.localize({key:"do.config",comment:["&& denotes a mnemonic"]},"&&Configure...")});if(o)return this._pickAndPersistDefaultFormatter(t,e)}else this._notificationService.prompt(D.Info,n,[{label:d.localize("do.config.notification","Configure..."),run:()=>this._pickAndPersistDefaultFormatter(t,e)}],{priority:ie.SILENT})}async _pickAndPersistDefaultFormatter(t,e){const i=t.map((o,l)=>({index:l,label:o.displayName||(o.extensionId?o.extensionId.value:"?"),description:o.extensionId&&o.extensionId.value})),r=this._languageService.getLanguageName(e.getLanguageId())||e.getLanguageId(),n=await this._quickInputService.pick(i,{placeHolder:d.localize("select","Select a default formatter for '{0}' files",a._maybeQuotes(r))});if(!(!n||!t[n.index].extensionId))return this._configService.updateValue(a.configName,t[n.index].extensionId.value,{resource:e.uri,overrideIdentifier:e.getLanguageId()}),t[n.index]}_updateStatus(){this._languageStatusStore.clear();const t=j(this._editorService.activeTextEditorControl);if(!t||!t.hasModel())return;const e=t.getModel(),i=N(this._languageFeaturesService.documentFormattingEditProvider,this._languageFeaturesService.documentRangeFormattingEditProvider,e);if(i.length===0)return;const r=new V;this._languageStatusStore.add(H(()=>r.dispose(!0))),this._analyzeFormatter(_.File,i,e).then(n=>{if(r.token.isCancellationRequested||typeof n!="string")return;const o={id:`formatter/configure/dfl/${B()}`,title:d.localize("do.config.command","Configure...")};this._languageStatusStore.add(Y.registerCommand(o.id,()=>this._pickAndPersistDefaultFormatter(i,e))),this._languageStatusStore.add(this._languageStatusService.addStatus({id:"formatter.conflict",name:d.localize("summary","Formatter Conflicts"),selector:{language:e.getLanguageId(),pattern:e.uri.fsPath},severity:D.Error,label:d.localize("formatter","Formatting"),detail:n,busy:!1,source:"",command:o,accessibilityInfo:void 0}))})}};a=k([u(0,ae),u(1,re),u(2,T),u(3,te),u(4,ee),u(5,M),u(6,C),u(7,y),u(8,ce),u(9,oe)],a),z.as(ne.Workbench).registerWorkbenchContribution(a,de.Restored),z.as(Z.Configuration).registerConfiguration({...$,properties:{[a.configName]:{description:d.localize("formatter.default","Defines a default formatter which takes precedence over all other formatter settings. Must be the identifier of an extension contributing a formatter."),type:["string","null"],default:null,enum:a.extensionIds,enumItemLabels:a.extensionItemLabels,markdownEnumDescriptions:a.extensionDescriptions}}});function A(m,s,t,e){function i(r){return r.extensionId?b.toKey(r.extensionId):"unknown"}m.publicLog2("formatterpick",{mode:s,extensions:t.map(i),pick:e?i(e):"none"})}async function W(m,s,t){const e=m.get(M),i=m.get(T),r=m.get(C),n={resource:s.uri,overrideIdentifier:s.getLanguageId()},o=i.getValue(a.configName,n);let l;const c=t.map((f,p)=>{const h=b.equals(f.extensionId,o),S={index:p,label:f.displayName||"",description:h?d.localize("def","(default)"):void 0};return h&&(l=S),S}),g={label:d.localize("config","Configure Default Formatter...")},v=await e.pick([...c,{type:"separator"},g],{placeHolder:d.localize("format.placeHolder","Select a formatter"),activeItem:l});if(v)if(v===g){const f=r.getLanguageName(s.getLanguageId())||s.getLanguageId(),p=await e.pick(c,{placeHolder:d.localize("select","Select a default formatter for '{0}' files",a._maybeQuotes(f))});p&&t[p.index].extensionId&&i.updateValue(a.configName,t[p.index].extensionId.value,n);return}else return v.index;else return}P(class extends E{constructor(){super({id:"editor.action.formatDocument.multiple",label:d.localize("formatDocument.label.multiple","Format Document With..."),alias:"Format Document...",precondition:x.and(I.writable,I.hasMultipleDocumentFormattingProvider),contextMenuOpts:{group:"1_modification",order:1.3}})}async run(s,t,e){if(!t.hasModel())return;const i=s.get(w),r=s.get(R),n=s.get(y),o=t.getModel(),l=N(n.documentFormattingEditProvider,n.documentRangeFormattingEditProvider,o),c=await i.invokeFunction(W,o,l);typeof c=="number"&&await i.invokeFunction(X,l[c],t,L.Explicit,F.None),A(r,"document",l,typeof c=="number"&&l[c]||void 0)}}),P(class extends E{constructor(){super({id:"editor.action.formatSelection.multiple",label:d.localize("formatSelection.label.multiple","Format Selection With..."),alias:"Format Code...",precondition:x.and(x.and(I.writable),I.hasMultipleDocumentSelectionFormattingProvider),contextMenuOpts:{when:x.and(I.hasNonEmptySelection),group:"1_modification",order:1.31}})}async run(s,t){if(!t.hasModel())return;const e=s.get(w),i=s.get(y),r=s.get(R),n=t.getModel();let o=t.getSelection();o.isEmpty()&&(o=new U(o.startLineNumber,1,o.startLineNumber,n.getLineMaxColumn(o.startLineNumber)));const l=i.documentRangeFormattingEditProvider.ordered(n),c=await e.invokeFunction(W,n,l);typeof c=="number"&&await e.invokeFunction(J,l[c],t,o,F.None,!0),A(r,"range",l,typeof c=="number"&&l[c]||void 0)}});export{a as DefaultFormatter};
