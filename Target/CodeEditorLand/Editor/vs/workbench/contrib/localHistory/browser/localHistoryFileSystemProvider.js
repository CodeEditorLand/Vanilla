import{VSBuffer as m}from"../../../../base/common/buffer.js";import{Event as c}from"../../../../base/common/event.js";import{Disposable as y}from"../../../../base/common/lifecycle.js";import{isEqual as n}from"../../../../base/common/resources.js";import{URI as s}from"../../../../base/common/uri.js";import{FileSystemProviderCapabilities as l,FileType as R,hasReadWriteCapability as I}from"../../../../platform/files/common/files.js";class t{constructor(i){this.fileService=i}static SCHEMA="vscode-local-history";static toLocalHistoryFileSystem(i){const e={location:i.location.toString(!0),associatedResource:i.associatedResource.toString(!0)};return i.associatedResource.with({scheme:t.SCHEMA,query:JSON.stringify(e)})}static fromLocalHistoryFileSystem(i){const e=JSON.parse(i.query);return{location:s.parse(e.location),associatedResource:s.parse(e.associatedResource)}}static EMPTY_RESOURCE=s.from({scheme:t.SCHEMA,path:"/empty"});static EMPTY={location:t.EMPTY_RESOURCE,associatedResource:t.EMPTY_RESOURCE};get capabilities(){return l.FileReadWrite|l.Readonly}mapSchemeToProvider=new Map;async withProvider(i){const e=i.scheme;let r=this.mapSchemeToProvider.get(e);if(!r){const a=this.fileService.getProvider(e);a?r=Promise.resolve(a):r=new Promise(d=>{const p=this.fileService.onDidChangeFileSystemProviderRegistrations(o=>{o.added&&o.provider&&o.scheme===e&&(p.dispose(),d(o.provider))})}),this.mapSchemeToProvider.set(e,r)}return r}async stat(i){const e=t.fromLocalHistoryFileSystem(i).location;return n(t.EMPTY_RESOURCE,e)?{type:R.File,ctime:0,mtime:0,size:0}:(await this.withProvider(e)).stat(e)}async readFile(i){const e=t.fromLocalHistoryFileSystem(i).location;if(n(t.EMPTY_RESOURCE,e))return m.fromString("").buffer;const r=await this.withProvider(e);if(I(r))return r.readFile(e);throw new Error("Unsupported")}onDidChangeCapabilities=c.None;onDidChangeFile=c.None;async writeFile(i,e,r){}async mkdir(i){}async readdir(i){return[]}async rename(i,e,r){}async delete(i,e){}watch(i,e){return y.None}}export{t as LocalHistoryFileSystemProvider};
