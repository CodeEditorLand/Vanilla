{
  "version": 3,
  "sources": ["../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/contrib/localHistory/browser/localHistoryTimeline.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type { CancellationToken } from \"../../../../base/common/cancellation.js\";\nimport { Emitter } from \"../../../../base/common/event.js\";\nimport { MarkdownString } from \"../../../../base/common/htmlContent.js\";\nimport {\n\tDisposable,\n\tMutableDisposable,\n} from \"../../../../base/common/lifecycle.js\";\nimport { Schemas } from \"../../../../base/common/network.js\";\nimport { URI } from \"../../../../base/common/uri.js\";\nimport { localize } from \"../../../../nls.js\";\nimport { IConfigurationService } from \"../../../../platform/configuration/common/configuration.js\";\nimport { IFileService } from \"../../../../platform/files/common/files.js\";\nimport { getVirtualWorkspaceAuthority } from \"../../../../platform/workspace/common/virtualWorkspace.js\";\nimport { IWorkspaceContextService } from \"../../../../platform/workspace/common/workspace.js\";\nimport { API_OPEN_DIFF_EDITOR_COMMAND_ID } from \"../../../browser/parts/editor/editorCommands.js\";\nimport type { IWorkbenchContribution } from \"../../../common/contributions.js\";\nimport { SaveSourceRegistry } from \"../../../common/editor.js\";\nimport { IWorkbenchEnvironmentService } from \"../../../services/environment/common/environmentService.js\";\nimport { IPathService } from \"../../../services/path/common/pathService.js\";\nimport {\n\ttype IWorkingCopyHistoryEntry,\n\tIWorkingCopyHistoryService,\n} from \"../../../services/workingCopy/common/workingCopyHistory.js\";\nimport {\n\tITimelineService,\n\ttype Timeline,\n\ttype TimelineChangeEvent,\n\ttype TimelineItem,\n\ttype TimelineOptions,\n\ttype TimelineProvider,\n} from \"../../timeline/common/timeline.js\";\nimport {\n\tLOCAL_HISTORY_ICON_ENTRY,\n\tLOCAL_HISTORY_MENU_CONTEXT_VALUE,\n\tgetLocalHistoryDateFormatter,\n} from \"./localHistory.js\";\nimport {\n\tCOMPARE_WITH_FILE_LABEL,\n\ttoDiffEditorArguments,\n} from \"./localHistoryCommands.js\";\nimport { LocalHistoryFileSystemProvider } from \"./localHistoryFileSystemProvider.js\";\n\nexport class LocalHistoryTimeline\n\textends Disposable\n\timplements IWorkbenchContribution, TimelineProvider\n{\n\tstatic readonly ID = \"workbench.contrib.localHistoryTimeline\";\n\n\tprivate static readonly LOCAL_HISTORY_ENABLED_SETTINGS_KEY =\n\t\t\"workbench.localHistory.enabled\";\n\n\treadonly id = \"timeline.localHistory\";\n\n\treadonly label = localize(\"localHistory\", \"Local History\");\n\n\treadonly scheme = \"*\"; // we try to show local history for all schemes if possible\n\n\tprivate readonly _onDidChange = this._register(\n\t\tnew Emitter<TimelineChangeEvent>(),\n\t);\n\treadonly onDidChange = this._onDidChange.event;\n\n\tprivate readonly timelineProviderDisposable = this._register(\n\t\tnew MutableDisposable(),\n\t);\n\n\tconstructor(\n\t\t@ITimelineService private readonly timelineService: ITimelineService,\n\t\t@IWorkingCopyHistoryService private readonly workingCopyHistoryService: IWorkingCopyHistoryService,\n\t\t@IPathService private readonly pathService: IPathService,\n\t\t@IFileService private readonly fileService: IFileService,\n\t\t@IWorkbenchEnvironmentService private readonly environmentService: IWorkbenchEnvironmentService,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService,\n\t\t@IWorkspaceContextService private readonly contextService: IWorkspaceContextService\n\t) {\n\t\tsuper();\n\n\t\tthis.registerComponents();\n\t\tthis.registerListeners();\n\t}\n\n\tprivate registerComponents(): void {\n\t\t// Timeline (if enabled)\n\t\tthis.updateTimelineRegistration();\n\n\t\t// File Service Provider\n\t\tthis._register(\n\t\t\tthis.fileService.registerProvider(\n\t\t\t\tLocalHistoryFileSystemProvider.SCHEMA,\n\t\t\t\tnew LocalHistoryFileSystemProvider(this.fileService),\n\t\t\t),\n\t\t);\n\t}\n\n\tprivate updateTimelineRegistration(): void {\n\t\tif (\n\t\t\tthis.configurationService.getValue<boolean>(\n\t\t\t\tLocalHistoryTimeline.LOCAL_HISTORY_ENABLED_SETTINGS_KEY,\n\t\t\t)\n\t\t) {\n\t\t\tthis.timelineProviderDisposable.value =\n\t\t\t\tthis.timelineService.registerTimelineProvider(this);\n\t\t} else {\n\t\t\tthis.timelineProviderDisposable.clear();\n\t\t}\n\t}\n\n\tprivate registerListeners(): void {\n\t\t// History changes\n\t\tthis._register(\n\t\t\tthis.workingCopyHistoryService.onDidAddEntry((e) =>\n\t\t\t\tthis.onDidChangeWorkingCopyHistoryEntry(e.entry),\n\t\t\t),\n\t\t);\n\t\tthis._register(\n\t\t\tthis.workingCopyHistoryService.onDidChangeEntry((e) =>\n\t\t\t\tthis.onDidChangeWorkingCopyHistoryEntry(e.entry),\n\t\t\t),\n\t\t);\n\t\tthis._register(\n\t\t\tthis.workingCopyHistoryService.onDidReplaceEntry((e) =>\n\t\t\t\tthis.onDidChangeWorkingCopyHistoryEntry(e.entry),\n\t\t\t),\n\t\t);\n\t\tthis._register(\n\t\t\tthis.workingCopyHistoryService.onDidRemoveEntry((e) =>\n\t\t\t\tthis.onDidChangeWorkingCopyHistoryEntry(e.entry),\n\t\t\t),\n\t\t);\n\t\tthis._register(\n\t\t\tthis.workingCopyHistoryService.onDidRemoveEntries(() =>\n\t\t\t\tthis.onDidChangeWorkingCopyHistoryEntry(\n\t\t\t\t\tundefined /* all entries */,\n\t\t\t\t),\n\t\t\t),\n\t\t);\n\t\tthis._register(\n\t\t\tthis.workingCopyHistoryService.onDidMoveEntries(() =>\n\t\t\t\tthis.onDidChangeWorkingCopyHistoryEntry(\n\t\t\t\t\tundefined /* all entries */,\n\t\t\t\t),\n\t\t\t),\n\t\t);\n\n\t\t// Configuration changes\n\t\tthis._register(\n\t\t\tthis.configurationService.onDidChangeConfiguration((e) => {\n\t\t\t\tif (\n\t\t\t\t\te.affectsConfiguration(\n\t\t\t\t\t\tLocalHistoryTimeline.LOCAL_HISTORY_ENABLED_SETTINGS_KEY,\n\t\t\t\t\t)\n\t\t\t\t) {\n\t\t\t\t\tthis.updateTimelineRegistration();\n\t\t\t\t}\n\t\t\t}),\n\t\t);\n\t}\n\n\tprivate onDidChangeWorkingCopyHistoryEntry(\n\t\tentry: IWorkingCopyHistoryEntry | undefined,\n\t): void {\n\t\t// Re-emit as timeline change event\n\t\tthis._onDidChange.fire({\n\t\t\tid: this.id,\n\t\t\turi: entry?.workingCopy.resource,\n\t\t\treset: true, // there is no other way to indicate that items might have been replaced/removed\n\t\t});\n\t}\n\n\tasync provideTimeline(\n\t\turi: URI,\n\t\toptions: TimelineOptions,\n\t\ttoken: CancellationToken,\n\t): Promise<Timeline> {\n\t\tconst items: TimelineItem[] = [];\n\n\t\t// Try to convert the provided `uri` into a form that is likely\n\t\t// for the provider to find entries for so that we can ensure\n\t\t// the timeline is always providing local history entries\n\n\t\tlet resource: URI | undefined;\n\t\tif (uri.scheme === LocalHistoryFileSystemProvider.SCHEMA) {\n\t\t\t// `vscode-local-history`: convert back to the associated resource\n\t\t\tresource =\n\t\t\t\tLocalHistoryFileSystemProvider.fromLocalHistoryFileSystem(\n\t\t\t\t\turi,\n\t\t\t\t).associatedResource;\n\t\t} else if (\n\t\t\turi.scheme === this.pathService.defaultUriScheme ||\n\t\t\turi.scheme === Schemas.vscodeUserData\n\t\t) {\n\t\t\t// default-scheme / settings: keep as is\n\t\t\tresource = uri;\n\t\t} else if (this.fileService.hasProvider(uri)) {\n\t\t\t// anything that is backed by a file system provider:\n\t\t\t// try best to convert the URI back into a form that is\n\t\t\t// likely to match the workspace URIs. That means:\n\t\t\t// - change to the default URI scheme\n\t\t\t// - change to the remote authority or virtual workspace authority\n\t\t\t// - preserve the path\n\t\t\tresource = URI.from({\n\t\t\t\tscheme: this.pathService.defaultUriScheme,\n\t\t\t\tauthority:\n\t\t\t\t\tthis.environmentService.remoteAuthority ??\n\t\t\t\t\tgetVirtualWorkspaceAuthority(\n\t\t\t\t\t\tthis.contextService.getWorkspace(),\n\t\t\t\t\t),\n\t\t\t\tpath: uri.path,\n\t\t\t});\n\t\t}\n\n\t\tif (resource) {\n\t\t\t// Retrieve from working copy history\n\t\t\tconst entries = await this.workingCopyHistoryService.getEntries(\n\t\t\t\tresource,\n\t\t\t\ttoken,\n\t\t\t);\n\n\t\t\t// Convert to timeline items\n\t\t\tfor (const entry of entries) {\n\t\t\t\titems.push(this.toTimelineItem(entry));\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tsource: this.id,\n\t\t\titems,\n\t\t};\n\t}\n\n\tprivate toTimelineItem(entry: IWorkingCopyHistoryEntry): TimelineItem {\n\t\treturn {\n\t\t\thandle: entry.id,\n\t\t\tlabel: SaveSourceRegistry.getSourceLabel(entry.source),\n\t\t\ttooltip: new MarkdownString(\n\t\t\t\t`$(history) ${getLocalHistoryDateFormatter().format(entry.timestamp)}\\n\\n${SaveSourceRegistry.getSourceLabel(entry.source)}${entry.sourceDescription ? ` (${entry.sourceDescription})` : ``}`,\n\t\t\t\t{ supportThemeIcons: true },\n\t\t\t),\n\t\t\tsource: this.id,\n\t\t\ttimestamp: entry.timestamp,\n\t\t\tthemeIcon: LOCAL_HISTORY_ICON_ENTRY,\n\t\t\tcontextValue: LOCAL_HISTORY_MENU_CONTEXT_VALUE,\n\t\t\tcommand: {\n\t\t\t\tid: API_OPEN_DIFF_EDITOR_COMMAND_ID,\n\t\t\t\ttitle: COMPARE_WITH_FILE_LABEL.value,\n\t\t\t\targuments: toDiffEditorArguments(\n\t\t\t\t\tentry,\n\t\t\t\t\tentry.workingCopy.resource,\n\t\t\t\t),\n\t\t\t},\n\t\t};\n\t}\n}\n"],
  "mappings": "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",
  "names": []
}
