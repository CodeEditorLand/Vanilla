var ie=Object.defineProperty;var te=Object.getOwnPropertyDescriptor;var x=(P,y,e,i)=>{for(var t=i>1?void 0:i?te(y,e):y,r=P.length-1,n;r>=0;r--)(n=P[r])&&(t=(i?n(y,e,t):n(t))||t);return i&&t&&ie(y,e,t),t},s=(P,y)=>(e,i)=>y(e,i,P);import{Action as u,Separator as re}from"../../../../base/common/actions.js";import{Emitter as G}from"../../../../base/common/event.js";import{ThemeIcon as w}from"../../../../base/common/themables.js";import{localize as a}from"../../../../nls.js";import{IInstantiationService as k}from"../../../../platform/instantiation/common/instantiation.js";import{ITelemetryService as se}from"../../../../platform/telemetry/common/telemetry.js";import{isUserDataProfile as D,IUserDataProfilesService as N,ProfileResourceType as o,toUserDataProfile as X}from"../../../../platform/userDataProfile/common/userDataProfile.js";import{isProfileURL as oe,IUserDataProfileImportExportService as j,IUserDataProfileManagementService as A,IUserDataProfileService as J}from"../../../services/userDataProfile/common/userDataProfile.js";import{Disposable as ne,DisposableStore as M,toDisposable as O}from"../../../../base/common/lifecycle.js";import{URI as v}from"../../../../base/common/uri.js";import*as Q from"../../../../base/common/arrays.js";import{equals as L}from"../../../../base/common/objects.js";import{EditorModel as ae}from"../../../common/editor/editorModel.js";import{ExtensionsResourceExportTreeItem as Y,ExtensionsResourceImportTreeItem as le}from"../../../services/userDataProfile/browser/extensionsResource.js";import{SettingsResource as fe,SettingsResourceTreeItem as ce}from"../../../services/userDataProfile/browser/settingsResource.js";import{KeybindingsResource as de,KeybindingsResourceTreeItem as he}from"../../../services/userDataProfile/browser/keybindingsResource.js";import{TasksResource as pe,TasksResourceTreeItem as me}from"../../../services/userDataProfile/browser/tasksResource.js";import{SnippetsResource as ue,SnippetsResourceTreeItem as Pe}from"../../../services/userDataProfile/browser/snippetsResource.js";import{Codicon as I}from"../../../../base/common/codicons.js";import{IDialogService as ge}from"../../../../platform/dialogs/common/dialogs.js";import{InMemoryFileSystemProvider as ve}from"../../../../platform/files/common/inMemoryFilesystemProvider.js";import{IFileService as H}from"../../../../platform/files/common/files.js";import{generateUuid as Z}from"../../../../base/common/uuid.js";import{createCancelablePromise as ye,RunOnceScheduler as we}from"../../../../base/common/async.js";import{IHostService as W}from"../../../services/host/browser/host.js";import{CancellationToken as $,CancellationTokenSource as Ie}from"../../../../base/common/cancellation.js";import"../../../common/views.js";import{API_OPEN_EDITOR_COMMAND_ID as Se}from"../../../browser/parts/editor/editorCommands.js";import{SIDE_GROUP as Ce}from"../../../services/editor/common/editorService.js";import{ICommandService as K}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as De}from"../../../../platform/configuration/common/configuration.js";import{CONFIG_NEW_WINDOW_PROFILE as T}from"../../../common/configuration.js";import{ResourceMap as Ee,ResourceSet as Fe}from"../../../../base/common/map.js";import{getErrorMessage as _e}from"../../../../base/common/errors.js";import{isWeb as ee}from"../../../../base/common/platform.js";import{IProductService as be}from"../../../../platform/product/common/productService.js";import{IOpenerService as xe}from"../../../../platform/opener/common/opener.js";import{IWorkspaceContextService as q,WORKSPACE_SUFFIX as Te}from"../../../../platform/workspace/common/workspace.js";import{IUriIdentityService as B}from"../../../../platform/uriIdentity/common/uriIdentity.js";import{isString as Re}from"../../../../base/common/types.js";import{IWorkbenchExtensionManagementService as V}from"../../../services/extensionManagement/common/extensionManagement.js";import{areSameExtensions as Ue}from"../../../../platform/extensionManagement/common/extensionManagementUtil.js";function Ri(P){return P.resourceType!==void 0}function Ui(P){return P.label!==void 0}let _=class extends ne{constructor(e,i,t,r,n,c,d,p,h,f,l,F,R,U){super();this.userDataProfileManagementService=c;this.userDataProfilesService=d;this.commandService=p;this.workspaceContextService=h;this.hostService=f;this.uriIdentityService=l;this.fileService=F;this.extensionManagementService=R;this.instantiationService=U;this._name=e,this._icon=i,this._flags=t,this._workspaces=r,this._active=n,this._register(this.onDidChange(m=>{m.message||this.validate(),this.save()})),this._register(this.extensionManagementService.onProfileAwareDidInstallExtensions(m=>{const g=this.getProfileToWatch();g&&m.some(b=>!b.error&&(b.applicationScoped||this.uriIdentityService.extUri.isEqual(b.profileLocation,g.extensionsResource)))&&this._onDidChange.fire({extensions:!0})})),this._register(this.extensionManagementService.onProfileAwareDidUninstallExtension(m=>{const g=this.getProfileToWatch();g&&!m.error&&(m.applicationScoped||this.uriIdentityService.extUri.isEqual(m.profileLocation,g.extensionsResource))&&this._onDidChange.fire({extensions:!0})})),this._register(this.extensionManagementService.onProfileAwareDidUpdateExtensionMetadata(m=>{const g=this.getProfileToWatch();(g&&m.local.isApplicationScoped||this.uriIdentityService.extUri.isEqual(m.profileLocation,g?.extensionsResource))&&this._onDidChange.fire({extensions:!0})}))}_onDidChange=this._register(new G);onDidChange=this._onDidChange.event;saveScheduler=this._register(new we(()=>this.doSave(),500));_name="";get name(){return this._name}set name(e){e=e.trim(),this._name!==e&&(this._name=e,this._onDidChange.fire({name:!0}))}_icon;get icon(){return this._icon}set icon(e){this._icon!==e&&(this._icon=e,this._onDidChange.fire({icon:!0}))}_workspaces;get workspaces(){return this._workspaces}set workspaces(e){Q.equals(this._workspaces,e,(i,t)=>i.toString()===t.toString())||(this._workspaces=e,this._onDidChange.fire({workspaces:!0}))}_flags;get flags(){return this._flags}set flags(e){L(this._flags,e)||(this._flags=e,this._onDidChange.fire({flags:!0}))}_active=!1;get active(){return this._active}set active(e){this._active!==e&&(this._active=e,this._onDidChange.fire({active:!0}))}_message;get message(){return this._message}set message(e){this._message!==e&&(this._message=e,this._onDidChange.fire({message:!0}))}_disabled=!1;get disabled(){return this._disabled}set disabled(e){this._disabled!==e&&(this._disabled=e,this._onDidChange.fire({disabled:!0}))}getFlag(e){return this.flags?.[e]??!1}setFlag(e,i){const t=this.flags?{...this.flags}:{};i?t[e]=!0:delete t[e],this.flags=t}validate(){if(!this.name){this.message=a("name required","Profile name is required and must be a non-empty value.");return}if(this.shouldValidateName()&&this.name!==this.getInitialName()&&this.userDataProfilesService.profiles.some(e=>e.name===this.name)){this.message=a("profileExists","Profile with name {0} already exists.",this.name);return}if(this.flags&&this.flags.settings&&this.flags.keybindings&&this.flags.tasks&&this.flags.snippets&&this.flags.extensions){this.message=a("invalid configurations","The profile should contain at least one configuration.");return}this.message=void 0}async getChildren(e){if(e===void 0){const i=[o.Settings,o.Keybindings,o.Tasks,o.Snippets,o.Extensions];return Promise.all(i.map(async t=>{const r=t===o.Settings||t===o.Keybindings||t===o.Tasks?await this.getChildrenForResourceType(t):[];return{handle:t,checkbox:void 0,resourceType:t,openAction:r.length?new u("_open",a("open","Open to the Side"),w.asClassName(I.goToFile),!0,()=>r[0]?.openAction?.run()):void 0}}))}return this.getChildrenForResourceType(e)}async getChildrenForResourceType(e){return[]}async getChildrenFromProfile(e,i){e=this.getFlag(i)?this.userDataProfilesService.defaultProfile:e;let t=[];switch(i){case o.Settings:t=await this.instantiationService.createInstance(ce,e).getChildren();break;case o.Keybindings:t=await this.instantiationService.createInstance(he,e).getChildren();break;case o.Snippets:t=await this.instantiationService.createInstance(Pe,e).getChildren()??[];break;case o.Tasks:t=await this.instantiationService.createInstance(me,e).getChildren();break;case o.Extensions:t=await this.instantiationService.createInstance(Y,e).getChildren();break}return t.map(r=>this.toUserDataProfileResourceChildElement(r))}toUserDataProfileResourceChildElement(e,i,t){return{handle:e.handle,checkbox:e.checkbox,label:e.label?.label??"",description:Re(e.description)?e.description:void 0,resource:v.revive(e.resourceUri),icon:e.themeIcon,openAction:new u("_openChild",a("open","Open to the Side"),w.asClassName(I.goToFile),!0,async()=>{e.parent.type===o.Extensions?await this.commandService.executeCommand("extension.open",e.handle,void 0,!0,void 0,!0):e.resourceUri&&await this.commandService.executeCommand(Se,e.resourceUri,[Ce],void 0)}),actions:{primary:i,contextMenu:t}}}getInitialName(){return""}shouldValidateName(){return!0}getCurrentWorkspace(){const e=this.workspaceContextService.getWorkspace();return e.configuration??e.folders[0]?.uri}openWorkspace(e){this.uriIdentityService.extUri.extname(e)===Te?this.hostService.openWindow([{workspaceUri:e}],{forceNewWindow:!0}):this.hostService.openWindow([{folderUri:e}],{forceNewWindow:!0})}save(){this.saveScheduler.schedule()}hasUnsavedChanges(e){return this.name!==e.name||this.icon!==e.icon||!L(this.flags??{},e.useDefaultFlags??{})||!Q.equals(this.workspaces??[],e.workspaces??[],(i,t)=>i.toString()===t.toString())}async saveProfile(e){if(!this.hasUnsavedChanges(e)||(this.validate(),this.message))return;const i=this.flags?this.flags.settings&&this.flags.keybindings&&this.flags.tasks&&this.flags.globalState&&this.flags.extensions?void 0:this.flags:void 0;return await this.userDataProfileManagementService.updateProfile(e,{name:this.name,icon:this.icon,useDefaultFlags:e.useDefaultFlags&&!i?{}:i,workspaces:this.workspaces})}};_=x([s(5,A),s(6,N),s(7,K),s(8,q),s(9,W),s(10,B),s(11,H),s(12,V),s(13,k)],_);let C=class extends _{constructor(e,i,t,r,n,c,d,p,h,f,l,F,R,U){super(e.name,e.icon,e.useDefaultFlags,e.workspaces,r.currentProfile.id===e.id,c,d,p,h,f,l,F,R,U);this._profile=e;this.titleButtons=i;this.actions=t;this.userDataProfileService=r;this.configurationService=n;this._isNewWindowProfile=this.configurationService.getValue(T)===this.profile.name,this._register(n.onDidChangeConfiguration(m=>{m.affectsConfiguration(T)&&(this.isNewWindowProfile=this.configurationService.getValue(T)===this.profile.name)})),this._register(this.userDataProfileService.onDidChangeCurrentProfile(()=>this.active=this.userDataProfileService.currentProfile.id===this.profile.id)),this._register(this.userDataProfilesService.onDidChangeProfiles(({updated:m})=>{const g=m.find(b=>b.id===this.profile.id);g&&(this._profile=g,this.reset(),this._onDidChange.fire({profile:!0}))})),this._register(F.watch(this.profile.snippetsHome)),this._register(F.onDidFilesChange(m=>{m.affects(this.profile.snippetsHome)&&this._onDidChange.fire({snippets:!0})}))}get profile(){return this._profile}getProfileToWatch(){return this.profile}reset(){this.name=this._profile.name,this.icon=this._profile.icon,this.flags=this._profile.useDefaultFlags,this.workspaces=this._profile.workspaces}updateWorkspaces(e,i){const t=new Fe(this.workspaces??[]);for(const r of e)t.add(r);for(const r of i)t.delete(r);this.workspaces=[...t.values()]}async toggleNewWindowProfile(){this._isNewWindowProfile?await this.configurationService.updateValue(T,null):await this.configurationService.updateValue(T,this.profile.name)}_isNewWindowProfile=!1;get isNewWindowProfile(){return this._isNewWindowProfile}set isNewWindowProfile(e){this._isNewWindowProfile!==e&&(this._isNewWindowProfile=e,this._onDidChange.fire({newWindowProfile:!0}))}async toggleCurrentWindowProfile(){this.userDataProfileService.currentProfile.id===this.profile.id?await this.userDataProfileManagementService.switchProfile(this.userDataProfilesService.defaultProfile):await this.userDataProfileManagementService.switchProfile(this.profile)}async doSave(){await this.saveProfile(this.profile)}async getChildrenForResourceType(e){return e===o.Extensions?(await this.instantiationService.createInstance(Y,this.profile).getChildren()).map(t=>this.toUserDataProfileResourceChildElement(t,void 0,[{id:"applyToAllProfiles",label:a("applyToAllProfiles","Apply Extension to all Profiles"),checked:t.applicationScoped,enabled:!0,class:"",tooltip:"",run:async()=>{const n=(await this.extensionManagementService.getInstalled(void 0,this.profile.extensionsResource)).find(c=>Ue(c.identifier,t.identifier));n&&await this.extensionManagementService.toggleAppliationScope(n,this.profile.extensionsResource)}}])):this.getChildrenFromProfile(this.profile,e)}getInitialName(){return this.profile.name}};C=x([s(3,J),s(4,De),s(5,A),s(6,N),s(7,K),s(8,q),s(9,W),s(10,B),s(11,H),s(12,V),s(13,k)],C);const z="userdataprofiletemplatepreview";let E=class extends _{constructor(e,i,t,r,n,c,d,p,h,f,l,F,R,U){super(e,void 0,void 0,void 0,!1,c,d,p,h,f,l,F,R,U);this.titleButtons=t;this.actions=r;this.userDataProfileImportExportService=n;this.defaultName=e,this._copyFrom=i,this._copyFlags=this.getCopyFlagsFrom(i),this.initialize(),this._register(this.fileService.registerProvider(z,this._register(new ve))),this._register(O(()=>{this.previewProfile&&this.userDataProfilesService.removeProfile(this.previewProfile)}))}_copyFromTemplates=new Ee;get copyFromTemplates(){return this._copyFromTemplates}templatePromise;template=null;defaultName;defaultIcon;_copyFrom;get copyFrom(){return this._copyFrom}set copyFrom(e){this._copyFrom!==e&&(this._copyFrom=e,this._onDidChange.fire({copyFrom:!0}),this.flags=void 0,this.copyFlags=this.getCopyFlagsFrom(e),e instanceof v&&(this.templatePromise?.cancel(),this.templatePromise=void 0),this.initialize())}_copyFlags;get copyFlags(){return this._copyFlags}set copyFlags(e){L(this._copyFlags,e)||(this._copyFlags=e,this._onDidChange.fire({copyFlags:!0}))}previewProfileWatchDisposables=this._register(new M);_previewProfile;get previewProfile(){return this._previewProfile}set previewProfile(e){this._previewProfile!==e&&(this._previewProfile=e,this._onDidChange.fire({preview:!0}),this.previewProfileWatchDisposables.clear(),this._previewProfile&&(this.previewProfileWatchDisposables.add(this.fileService.watch(this._previewProfile.snippetsHome)),this.previewProfileWatchDisposables.add(this.fileService.onDidFilesChange(i=>{this._previewProfile&&i.affects(this._previewProfile.snippetsHome)&&this._onDidChange.fire({snippets:!0})}))))}getProfileToWatch(){return this.previewProfile}getCopyFlagsFrom(e){return e?{settings:!0,keybindings:!0,snippets:!0,tasks:!0,extensions:!0}:void 0}async initialize(){this.disabled=!0;try{if(this.copyFrom instanceof v){await this.resolveTemplate(this.copyFrom),this.template&&(this.copyFromTemplates.set(this.copyFrom,this.template.name),this.defaultName===this.name&&(this.name=this.defaultName=this.template.name??""),this.defaultIcon===this.icon&&(this.icon=this.defaultIcon=this.template.icon),this.setCopyFlag(o.Settings,!!this.template.settings),this.setCopyFlag(o.Keybindings,!!this.template.keybindings),this.setCopyFlag(o.Tasks,!!this.template.tasks),this.setCopyFlag(o.Snippets,!!this.template.snippets),this.setCopyFlag(o.Extensions,!!this.template.extensions),this._onDidChange.fire({copyFromInfo:!0}));return}if(D(this.copyFrom)){this.defaultName===this.name&&(this.name=this.defaultName=a("copy from","{0} (Copy)",this.copyFrom.name)),this.defaultIcon===this.icon&&(this.icon=this.defaultIcon=this.copyFrom.icon),this.setCopyFlag(o.Settings,!0),this.setCopyFlag(o.Keybindings,!0),this.setCopyFlag(o.Tasks,!0),this.setCopyFlag(o.Snippets,!0),this.setCopyFlag(o.Extensions,!0),this._onDidChange.fire({copyFromInfo:!0});return}this.defaultName===this.name&&(this.name=this.defaultName=a("untitled","Untitled")),this.defaultIcon===this.icon&&(this.icon=this.defaultIcon=void 0),this.setCopyFlag(o.Settings,!1),this.setCopyFlag(o.Keybindings,!1),this.setCopyFlag(o.Tasks,!1),this.setCopyFlag(o.Snippets,!1),this.setCopyFlag(o.Extensions,!1),this._onDidChange.fire({copyFromInfo:!0})}finally{this.disabled=!1}}async resolveTemplate(e){return this.templatePromise||(this.templatePromise=ye(async i=>{const t=await this.userDataProfileImportExportService.resolveProfileTemplate(e);i.isCancellationRequested||(this.template=t)})),await this.templatePromise,this.template}hasResource(e){if(this.template)switch(e){case o.Settings:return!!this.template.settings;case o.Keybindings:return!!this.template.keybindings;case o.Snippets:return!!this.template.snippets;case o.Tasks:return!!this.template.tasks;case o.Extensions:return!!this.template.extensions}return!0}getCopyFlag(e){return this.copyFlags?.[e]??!1}setCopyFlag(e,i){const t=this.copyFlags?{...this.copyFlags}:{};t[e]=i,this.copyFlags=t}getCopyFromName(){if(D(this.copyFrom))return this.copyFrom.name;if(this.copyFrom instanceof v)return this.copyFromTemplates.get(this.copyFrom)}async getChildrenForResourceType(e){return this.getFlag(e)?this.getChildrenFromProfile(this.userDataProfilesService.defaultProfile,e):this.getCopyFlag(e)?this.previewProfile?this.getChildrenFromProfile(this.previewProfile,e):this.copyFrom instanceof v?(await this.resolveTemplate(this.copyFrom),this.template?this.getChildrenFromProfileTemplate(this.template,e):[]):this.copyFrom?this.getChildrenFromProfile(this.copyFrom,e):[]:[]}async getChildrenFromProfileTemplate(e,i){const t=X(Z(),this.name,v.file("/root").with({scheme:z}),v.file("/cache").with({scheme:z}));switch(i){case o.Settings:return e.settings?(await this.instantiationService.createInstance(fe).apply(e.settings,t),this.getChildrenFromProfile(t,i)):[];case o.Keybindings:return e.keybindings?(await this.instantiationService.createInstance(de).apply(e.keybindings,t),this.getChildrenFromProfile(t,i)):[];case o.Snippets:return e.snippets?(await this.instantiationService.createInstance(ue).apply(e.snippets,t),this.getChildrenFromProfile(t,i)):[];case o.Tasks:return e.tasks?(await this.instantiationService.createInstance(pe).apply(e.tasks,t),this.getChildrenFromProfile(t,i)):[];case o.Extensions:return e.extensions?(await this.instantiationService.createInstance(le,e.extensions).getChildren()).map(n=>this.toUserDataProfileResourceChildElement(n)):[]}return[]}shouldValidateName(){return!this.copyFrom}getInitialName(){return this.previewProfile?.name??""}async doSave(){if(this.previewProfile){const e=await this.saveProfile(this.previewProfile);e&&(this.previewProfile=e)}}};E=x([s(4,j),s(5,A),s(6,N),s(7,K),s(8,q),s(9,W),s(10,B),s(11,H),s(12,V),s(13,k)],E);let S=class extends ae{constructor(e,i,t,r,n,c,d,p,h,f){super();this.userDataProfileService=e;this.userDataProfilesService=i;this.userDataProfileManagementService=t;this.userDataProfileImportExportService=r;this.dialogService=n;this.telemetryService=c;this.hostService=d;this.productService=p;this.openerService=h;this.instantiationService=f;for(const l of i.profiles)l.isTransient||this._profiles.push(this.createProfileElement(l));this._register(O(()=>this._profiles.splice(0,this._profiles.length).map(([,l])=>l.dispose()))),this._register(i.onDidChangeProfiles(l=>this.onDidChangeProfiles(l)))}static INSTANCE;static getInstance(e){return S.INSTANCE||(S.INSTANCE=e.createInstance(S)),S.INSTANCE}_profiles=[];get profiles(){return this._profiles.map(([e])=>e).sort((e,i)=>e instanceof E?1:i instanceof E||e instanceof C&&e.profile.isDefault?-1:i instanceof C&&i.profile.isDefault?1:e.name.localeCompare(i.name))}newProfileElement;_onDidChange=this._register(new G);onDidChange=this._onDidChange.event;templates;onDidChangeProfiles(e){let i=!1;for(const t of e.added)!t.isTransient&&t.name!==this.newProfileElement?.name&&(i=!0,this._profiles.push(this.createProfileElement(t)));for(const t of e.removed){t.id===this.newProfileElement?.previewProfile?.id&&(this.newProfileElement.previewProfile=void 0);const r=this._profiles.findIndex(([n])=>n instanceof C&&n.profile.id===t.id);r!==-1&&(i=!0,this._profiles.splice(r,1).map(([,n])=>n.dispose()))}i&&this._onDidChange.fire(void 0)}getTemplates(){return this.templates||(this.templates=this.userDataProfileManagementService.getBuiltinProfileTemplates()),this.templates}createProfileElement(e){const i=new M,t=i.add(new u("userDataProfile.activate",a("active","Use this Profile for Current Window"),w.asClassName(I.check),!0,()=>this.userDataProfileManagementService.switchProfile(f.profile))),r=i.add(new u("userDataProfile.copyFromProfile",a("copyFromProfile","Duplicate..."),w.asClassName(I.copy),!0,()=>this.createNewProfile(f.profile))),n=i.add(new u("userDataProfile.export",a("export","Export..."),w.asClassName(I.export),!0,()=>this.userDataProfileImportExportService.exportProfile(e))),c=i.add(new u("userDataProfile.delete",a("delete","Delete"),w.asClassName(I.trash),!0,()=>this.removeProfile(f.profile))),d=i.add(new u("userDataProfile.newWindow",a("open new window","Open New Window with this Profile"),w.asClassName(I.emptyWindow),!0,()=>this.openWindow(f.profile))),p=[];p.push(t),p.push(d);const h=[];h.push(r),h.push(n),e.isDefault||(h.push(new re),h.push(c));const f=i.add(this.instantiationService.createInstance(C,e,[[],[]],[p,h]));return t.enabled=this.userDataProfileService.currentProfile.id!==f.profile.id,i.add(this.userDataProfileService.onDidChangeCurrentProfile(()=>t.enabled=this.userDataProfileService.currentProfile.id!==f.profile.id)),[f,i]}async createNewProfile(e){if(this.newProfileElement){if(!(await this.dialogService.confirm({type:"info",message:a("new profile exists","A new profile is already being created. Do you want to discard it and create a new one?"),primaryButton:a("discard","Discard & Create"),cancelButton:a("cancel","Cancel")})).confirmed)return;this.revert()}if(e instanceof v)try{await this.userDataProfileImportExportService.resolveProfileTemplate(e)}catch(i){this.dialogService.error(_e(i));return}if(!this.newProfileElement){const i=new M,t=new Ie;i.add(O(()=>t.dispose(!0)));const r=[],n=[],c=i.add(new u("userDataProfile.create",a("create","Create"),void 0,!0,()=>this.saveNewProfile(!1,t.token)));r.push(c),ee&&e instanceof v&&oe(e)&&r.push(new u("userDataProfile.createInDesktop",a("import in desktop","Create in {0}",this.productService.nameLong),void 0,!0,()=>this.openerService.open(e,{openExternal:!0})));const d=i.add(new u("userDataProfile.cancel",a("cancel","Cancel"),w.asClassName(I.trash),!0,()=>this.discardNewProfile()));n.push(d);const p=i.add(new u("userDataProfile.preview",a("preview","Preview"),w.asClassName(I.openPreview),!0,()=>this.previewNewProfile(t.token)));n.push(p);const h=i.add(new u("userDataProfile.export",a("export","Export..."),w.asClassName(I.export),D(e),()=>this.exportNewProfile(t.token)));this.newProfileElement=i.add(this.instantiationService.createInstance(E,e?"":a("untitled","Untitled"),e,[r,n],[[d],[h]]));const f=()=>{c.enabled&&(this.newProfileElement?.copyFrom&&this.userDataProfilesService.profiles.some(l=>!l.isTransient&&l.name===this.newProfileElement?.name)?c.label=a("replace","Replace"):c.label=a("create","Create"))};f(),i.add(this.newProfileElement.onDidChange(l=>{(l.preview||l.disabled||l.message)&&(c.enabled=!this.newProfileElement?.disabled&&!this.newProfileElement?.message,p.enabled=!this.newProfileElement?.previewProfile&&!this.newProfileElement?.disabled&&!this.newProfileElement?.message),(l.name||l.copyFrom)&&(f(),h.enabled=D(this.newProfileElement?.copyFrom))})),i.add(this.userDataProfilesService.onDidChangeProfiles(l=>{f(),this.newProfileElement?.validate()})),this._profiles.push([this.newProfileElement,i]),this._onDidChange.fire(this.newProfileElement)}return this.newProfileElement}revert(){this.removeNewProfile(),this._onDidChange.fire(void 0)}removeNewProfile(){if(this.newProfileElement){const e=this._profiles.findIndex(([i])=>i===this.newProfileElement);e!==-1&&this._profiles.splice(e,1).map(([,i])=>i.dispose()),this.newProfileElement=void 0}}async previewNewProfile(e){if(!this.newProfileElement||this.newProfileElement.previewProfile)return;const i=await this.saveNewProfile(!0,e);i&&(this.newProfileElement.previewProfile=i,ee?await this.userDataProfileManagementService.switchProfile(i):await this.openWindow(i))}async exportNewProfile(e){if(!this.newProfileElement||!D(this.newProfileElement.copyFrom))return;const i=X(Z(),this.newProfileElement.name,this.newProfileElement.copyFrom.location,this.newProfileElement.copyFrom.cacheHome,{icon:this.newProfileElement.icon,useDefaultFlags:this.newProfileElement.flags},this.userDataProfilesService.defaultProfile);await this.userDataProfileImportExportService.exportProfile(i,this.newProfileElement.copyFlags)}async saveNewProfile(e,i){if(!this.newProfileElement||(this.newProfileElement.validate(),this.newProfileElement.message))return;this.newProfileElement.disabled=!0;let t;try{if(this.newProfileElement.previewProfile)e||(t=await this.userDataProfileManagementService.updateProfile(this.newProfileElement.previewProfile,{transient:!1}));else{const{flags:r,icon:n,name:c,copyFrom:d}=this.newProfileElement,p=r?r.settings&&r.keybindings&&r.tasks&&r.globalState&&r.extensions?void 0:r:void 0,h={source:d instanceof v?"template":D(d)?"profile":d?"external":void 0};if(d instanceof v){const f=await this.newProfileElement.resolveTemplate(d);f&&(this.telemetryService.publicLog2("userDataProfile.createFromTemplate",h),t=await this.userDataProfileImportExportService.createProfileFromTemplate(f,{name:c,useDefaultFlags:p,icon:n,resourceTypeFlags:this.newProfileElement.copyFlags,transient:e},i??$.None))}else D(d)?(this.telemetryService.publicLog2("userDataProfile.createFromProfile",h),t=await this.userDataProfileImportExportService.createFromProfile(d,{name:c,useDefaultFlags:p,icon:n,resourceTypeFlags:this.newProfileElement.copyFlags,transient:e},i??$.None)):(this.telemetryService.publicLog2("userDataProfile.createEmptyProfile",h),t=await this.userDataProfileManagementService.createProfile(c,{useDefaultFlags:p,icon:n,transient:e}))}}finally{this.newProfileElement&&(this.newProfileElement.disabled=!1)}if(i?.isCancellationRequested){if(t)try{await this.userDataProfileManagementService.removeProfile(t)}catch{}return}if(t&&!t.isTransient&&this.newProfileElement){this.removeNewProfile();const r=this._profiles.find(([n])=>n.name===t.name);r?this._onDidChange.fire(r[0]):this.onDidChangeProfiles({added:[t],removed:[],updated:[],all:this.userDataProfilesService.profiles})}return t}async discardNewProfile(){if(this.newProfileElement){if(this.newProfileElement.previewProfile){await this.userDataProfileManagementService.removeProfile(this.newProfileElement.previewProfile);return}this.removeNewProfile(),this._onDidChange.fire(void 0)}}async removeProfile(e){(await this.dialogService.confirm({type:"info",message:a("deleteProfile","Are you sure you want to delete the profile '{0}'?",e.name),primaryButton:a("delete","Delete"),cancelButton:a("cancel","Cancel")})).confirmed&&await this.userDataProfileManagementService.removeProfile(e)}async openWindow(e){await this.hostService.openWindow({forceProfile:e.name})}};S=x([s(0,J),s(1,N),s(2,A),s(3,j),s(4,ge),s(5,se),s(6,W),s(7,be),s(8,xe),s(9,k)],S);export{_ as AbstractUserDataProfileElement,E as NewProfileElement,C as UserDataProfileElement,S as UserDataProfilesEditorModel,Ui as isProfileResourceChildElement,Ri as isProfileResourceTypeElement};
