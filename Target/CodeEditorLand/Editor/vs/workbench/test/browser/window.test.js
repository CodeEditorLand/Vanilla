import t from"assert";import"../../../base/browser/dom.js";import{mainWindow as f}from"../../../base/browser/window.js";import{DisposableStore as W}from"../../../base/common/lifecycle.js";import{runWithFakedTimers as b}from"../../../base/test/common/timeTravelScheduler.js";import{ensureNoDisposablesAreLeakedInTestSuite as h}from"../../../base/test/common/utils.js";import{BaseWindow as q}from"../../browser/window.js";import{TestEnvironmentService as S,TestHostService as v}from"./workbenchTestServices.js";suite("Window",()=>{h();class E extends q{constructor(u,a){super(u,a,new v,S)}enableWindowFocusOnElementFocus(){}}test("multi window aware setTimeout()",async function(){return b({useFakeTimers:!0},async()=>{const r=new W;let u=[];const a={getWindowsCount:()=>u.length,getWindows:()=>u},n=[],s=[];function l(o,i){const w={setTimeout:function(c,p,...T){return n.push(o),f.setTimeout(()=>c(o),i?p*2:p,...T)},clearTimeout:function(c){return s.push(o),f.clearTimeout(c)}};return r.add(new E(w,a)),w}const d=l(1);u=[{window:d,disposables:r}];let e=!1;await new Promise((o,i)=>{d.setTimeout(()=>{e?i(new Error("timeout called twice")):(e=!0,o())},1)}),t.strictEqual(e,!0),t.deepStrictEqual(n,[1]),t.deepStrictEqual(s,[]),e=!1,n.length=0,s.length=0,await new Promise((o,i)=>{d.setTimeout(()=>{e?i(new Error("timeout called twice")):(e=!0,o())},0)}),t.strictEqual(e,!0),t.deepStrictEqual(n,[1]),t.deepStrictEqual(s,[]),e=!1,n.length=0,s.length=0;let m=l(2);const g=l(3);u=[{window:m,disposables:r},{window:d,disposables:r},{window:g,disposables:r}],await new Promise((o,i)=>{d.setTimeout(()=>{e?i(new Error("timeout called twice")):(e=!0,o())},1)}),t.strictEqual(e,!0),t.deepStrictEqual(n,[2,1,3]),t.deepStrictEqual(s,[2,1,3]),e=!1,n.length=0,s.length=0,m=l(2,!0),u=[{window:m,disposables:r},{window:d,disposables:r}],await new Promise((o,i)=>{d.setTimeout(w=>{!e&&w===1?(e=!0,o()):i(e?new Error("timeout called twice"):new Error("timeout called for wrong window"))},1)}),t.strictEqual(e,!0),t.deepStrictEqual(n,[2,1]),t.deepStrictEqual(s,[2,1]),e=!1,n.length=0,s.length=0,r.dispose()})})});
