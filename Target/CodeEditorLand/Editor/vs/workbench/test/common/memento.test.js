import E from"assert";import{DisposableStore as A}from"../../../base/common/lifecycle.js";import{ensureNoDisposablesAreLeakedInTestSuite as C}from"../../../base/test/common/utils.js";import{StorageScope as t,StorageTarget as m}from"../../../platform/storage/common/storage.js";import{Memento as M}from"../../common/memento.js";import{TestStorageService as a}from"./workbenchTestServices.js";suite("Memento",()=>{const I=new A;let n;setup(()=>{n=I.add(new a),M.clear(t.APPLICATION),M.clear(t.PROFILE),M.clear(t.WORKSPACE)}),teardown(()=>{I.clear()}),test("Loading and Saving Memento with Scopes",()=>{const o=new M("memento.test",n);let e=o.getMemento(t.APPLICATION,m.MACHINE);e.foo=[1,2,3];let l=o.getMemento(t.APPLICATION,m.MACHINE);E.deepStrictEqual(l,e),e=o.getMemento(t.PROFILE,m.MACHINE),e.foo=[4,5,6];let r=o.getMemento(t.PROFILE,m.MACHINE);E.deepStrictEqual(r,e),e=o.getMemento(t.WORKSPACE,m.MACHINE),E(e),e.foo="Hello World",o.saveMemento(),e=o.getMemento(t.APPLICATION,m.MACHINE),E.deepStrictEqual(e,{foo:[1,2,3]}),l=o.getMemento(t.APPLICATION,m.MACHINE),E.deepStrictEqual(l,e),e=o.getMemento(t.PROFILE,m.MACHINE),E.deepStrictEqual(e,{foo:[4,5,6]}),r=o.getMemento(t.PROFILE,m.MACHINE),E.deepStrictEqual(r,e),e=o.getMemento(t.WORKSPACE,m.MACHINE),E.deepStrictEqual(e,{foo:"Hello World"}),E.deepStrictEqual(JSON.parse(n.get("memento/memento.test",t.APPLICATION)),{foo:[1,2,3]}),E.deepStrictEqual(JSON.parse(n.get("memento/memento.test",t.PROFILE)),{foo:[4,5,6]}),E.deepStrictEqual(JSON.parse(n.get("memento/memento.test",t.WORKSPACE)),{foo:"Hello World"}),e=o.getMemento(t.APPLICATION,m.MACHINE),delete e.foo,e=o.getMemento(t.PROFILE,m.MACHINE),delete e.foo,e=o.getMemento(t.WORKSPACE,m.MACHINE),delete e.foo,o.saveMemento(),e=o.getMemento(t.APPLICATION,m.MACHINE),E.deepStrictEqual(e,{}),e=o.getMemento(t.PROFILE,m.MACHINE),E.deepStrictEqual(e,{}),e=o.getMemento(t.WORKSPACE,m.MACHINE),E.deepStrictEqual(e,{}),E.strictEqual(n.get("memento/memento.test",t.APPLICATION,null),null),E.strictEqual(n.get("memento/memento.test",t.PROFILE,null),null),E.strictEqual(n.get("memento/memento.test",t.WORKSPACE,null),null)}),test("Save and Load",()=>{const o=new M("memento.test",n);let e=o.getMemento(t.PROFILE,m.MACHINE);e.foo=[1,2,3],e=o.getMemento(t.WORKSPACE,m.MACHINE),E(e),e.foo="Hello World",o.saveMemento(),e=o.getMemento(t.PROFILE,m.MACHINE),E.deepStrictEqual(e,{foo:[1,2,3]});let l=o.getMemento(t.PROFILE,m.MACHINE);E.deepStrictEqual(l,e),e=o.getMemento(t.WORKSPACE,m.MACHINE),E.deepStrictEqual(e,{foo:"Hello World"}),e=o.getMemento(t.PROFILE,m.MACHINE),e.foo=[4,5,6],e=o.getMemento(t.WORKSPACE,m.MACHINE),E(e),e.foo="World Hello",o.saveMemento(),e=o.getMemento(t.PROFILE,m.MACHINE),E.deepStrictEqual(e,{foo:[4,5,6]}),l=o.getMemento(t.PROFILE,m.MACHINE),E.deepStrictEqual(l,e),e=o.getMemento(t.WORKSPACE,m.MACHINE),E.deepStrictEqual(e,{foo:"World Hello"}),e=o.getMemento(t.PROFILE,m.MACHINE),delete e.foo,e=o.getMemento(t.WORKSPACE,m.MACHINE),delete e.foo,o.saveMemento(),e=o.getMemento(t.PROFILE,m.MACHINE),E.deepStrictEqual(e,{}),e=o.getMemento(t.WORKSPACE,m.MACHINE),E.deepStrictEqual(e,{})}),test("Save and Load - 2 Components with same id",()=>{const o=new M("memento.test",n),e=new M("memento.test",n);let l=o.getMemento(t.PROFILE,m.MACHINE);l.foo=[1,2,3],l=e.getMemento(t.PROFILE,m.MACHINE),l.bar=[1,2,3],l=o.getMemento(t.WORKSPACE,m.MACHINE),E(l),l.foo="Hello World",l=e.getMemento(t.WORKSPACE,m.MACHINE),E(l),l.bar="Hello World",o.saveMemento(),e.saveMemento(),l=o.getMemento(t.PROFILE,m.MACHINE),E.deepStrictEqual(l,{foo:[1,2,3],bar:[1,2,3]});let r=o.getMemento(t.PROFILE,m.MACHINE);E.deepStrictEqual(r,l),l=e.getMemento(t.PROFILE,m.MACHINE),E.deepStrictEqual(l,{foo:[1,2,3],bar:[1,2,3]}),r=e.getMemento(t.PROFILE,m.MACHINE),E.deepStrictEqual(r,l),l=o.getMemento(t.WORKSPACE,m.MACHINE),E.deepStrictEqual(l,{foo:"Hello World",bar:"Hello World"}),l=e.getMemento(t.WORKSPACE,m.MACHINE),E.deepStrictEqual(l,{foo:"Hello World",bar:"Hello World"})}),test("Clear Memento",()=>{let o=new M("memento.test",n),e=o.getMemento(t.PROFILE,m.MACHINE);e.foo="Hello World";let l=o.getMemento(t.WORKSPACE,m.MACHINE);l.bar="Hello World",o.saveMemento(),n=I.add(new a),M.clear(t.PROFILE),M.clear(t.WORKSPACE),o=new M("memento.test",n),e=o.getMemento(t.PROFILE,m.MACHINE),l=o.getMemento(t.WORKSPACE,m.MACHINE),E.deepStrictEqual(e,{}),E.deepStrictEqual(l,{})}),C()});
