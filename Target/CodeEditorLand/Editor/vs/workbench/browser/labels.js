var P=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var m=(d,c,i,e)=>{for(var t=e>1?void 0:e?N(c,i):c,o=d.length-1,s;o>=0;o--)(s=d[o])&&(t=(e?s(c,i,t):s(t))||t);return e&&t&&P(c,i,t),t},n=(d,c)=>(i,e)=>c(i,e,d);import{localize as x}from"../../nls.js";import{URI as I}from"../../base/common/uri.js";import{dirname as U,isEqual as w,basenameOrAuthority as W}from"../../base/common/resources.js";import{IconLabel as K}from"../../base/browser/ui/iconLabel/iconLabel.js";import{ILanguageService as v}from"../../editor/common/languages/language.js";import{IWorkspaceContextService as L}from"../../platform/workspace/common/workspace.js";import{IConfigurationService as k}from"../../platform/configuration/common/configuration.js";import{IModelService as C}from"../../editor/common/services/model.js";import{ITextFileService as S}from"../services/textfile/common/textfiles.js";import{IDecorationsService as D}from"../services/decorations/common/decorations.js";import{Schemas as R}from"../../base/common/network.js";import{FileKind as E,FILES_ASSOCIATIONS_CONFIG as A}from"../../platform/files/common/files.js";import{IThemeService as O}from"../../platform/theme/common/themeService.js";import{Event as $,Emitter as T}from"../../base/common/event.js";import{ILabelService as y}from"../../platform/label/common/label.js";import{getIconClasses as V}from"../../editor/common/services/getIconClasses.js";import{Disposable as H,dispose as M,MutableDisposable as B}from"../../base/common/lifecycle.js";import{IInstantiationService as _}from"../../platform/instantiation/common/instantiation.js";import{normalizeDriveLetter as z}from"../../base/common/labels.js";import{INotebookDocumentService as j}from"../services/notebook/common/notebookDocumentService.js";function h(d){if(!(!d||!d.resource))return I.isUri(d.resource)?d.resource:d.resource.primary}const q={onDidChangeVisibility:$.None};let f=class extends H{constructor(i,e,t,o,s,r,u,p,a,l){super();this.instantiationService=e;this.configurationService=t;this.modelService=o;this.workspaceService=s;this.languageService=r;this.decorationsService=u;this.themeService=p;this.labelService=a;this.textFileService=l;this.registerListeners(i)}_onDidChangeDecorations=this._register(new T);onDidChangeDecorations=this._onDidChangeDecorations.event;widgets=[];labels=[];registerListeners(i){this._register(i.onDidChangeVisibility(e=>{this.widgets.forEach(t=>t.notifyVisibilityChanged(e))})),this._register(this.languageService.onDidChange(()=>this.widgets.forEach(e=>e.notifyExtensionsRegistered()))),this._register(this.modelService.onModelLanguageChanged(e=>{e.model.uri&&this.widgets.forEach(t=>t.notifyModelLanguageChanged(e.model))})),this._register(this.modelService.onModelAdded(e=>{e.uri&&this.widgets.forEach(t=>t.notifyModelAdded(e))})),this._register(this.workspaceService.onDidChangeWorkspaceFolders(()=>{this.widgets.forEach(e=>e.notifyWorkspaceFoldersChange())})),this._register(this.decorationsService.onDidChangeDecorations(e=>{let t=!1;this.widgets.forEach(o=>{o.notifyFileDecorationsChanges(e)&&(t=!0)}),t&&this._onDidChangeDecorations.fire()})),this._register(this.themeService.onDidColorThemeChange(()=>this.widgets.forEach(e=>e.notifyThemeChange()))),this._register(this.configurationService.onDidChangeConfiguration(e=>{e.affectsConfiguration(A)&&this.widgets.forEach(t=>t.notifyFileAssociationsChange())})),this._register(this.labelService.onDidChangeFormatters(e=>{this.widgets.forEach(t=>t.notifyFormattersChange(e.scheme))})),this._register(this.textFileService.untitled.onDidChangeLabel(e=>{this.widgets.forEach(t=>t.notifyUntitledLabelChange(e.resource))}))}get(i){return this.labels[i]}create(i,e){const t=this.instantiationService.createInstance(g,i,e),o={element:t.element,onDidRender:t.onDidRender,setLabel:(s,r,u)=>t.setLabel(s,r,u),setResource:(s,r)=>t.setResource(s,r),setFile:(s,r)=>t.setFile(s,r),clear:()=>t.clear(),dispose:()=>this.disposeWidget(t)};return this.labels.push(o),this.widgets.push(t),o}disposeWidget(i){const e=this.widgets.indexOf(i);e>-1&&(this.widgets.splice(e,1),this.labels.splice(e,1)),M(i)}clear(){this.widgets=M(this.widgets),this.labels=[]}dispose(){super.dispose(),this.clear()}};f=m([n(1,_),n(2,k),n(3,C),n(4,L),n(5,v),n(6,D),n(7,O),n(8,y),n(9,S)],f);let b=class extends f{label;get element(){return this.label}constructor(c,i,e,t,o,s,r,u,p,a,l){super(q,e,t,o,s,r,u,p,a,l),this.label=this._register(this.create(c,i))}};b=m([n(2,_),n(3,k),n(4,C),n(5,L),n(6,v),n(7,D),n(8,O),n(9,y),n(10,S)],b);var G=(i=>(i[i.Basic=1]="Basic",i[i.Full=2]="Full",i))(G||{});let g=class extends K{constructor(i,e,t,o,s,r,u,p,a){super(i,e);this.languageService=t;this.modelService=o;this.decorationsService=s;this.labelService=r;this.textFileService=u;this.contextService=p;this.notebookDocumentService=a}_onDidRender=this._register(new T);onDidRender=this._onDidRender.event;label=void 0;decoration=this._register(new B);options=void 0;computedIconClasses=void 0;computedLanguageId=void 0;computedPathLabel=void 0;computedWorkspaceFolderLabel=void 0;needsRedraw=void 0;isHidden=!1;notifyVisibilityChanged(i){i===this.isHidden&&(this.isHidden=!i,i&&this.needsRedraw&&(this.render({updateIcon:this.needsRedraw===2,updateDecoration:this.needsRedraw===2}),this.needsRedraw=void 0))}notifyModelLanguageChanged(i){this.handleModelEvent(i)}notifyModelAdded(i){this.handleModelEvent(i)}handleModelEvent(i){const e=h(this.label);e&&w(i.uri,e)&&this.computedLanguageId!==i.getLanguageId()&&(this.computedLanguageId=i.getLanguageId(),this.render({updateIcon:!0,updateDecoration:!1}))}notifyFileDecorationsChanges(i){if(!this.options)return!1;const e=h(this.label);return e&&this.options.fileDecorations&&i.affectsResource(e)?this.render({updateIcon:!1,updateDecoration:!0}):!1}notifyExtensionsRegistered(){this.render({updateIcon:!0,updateDecoration:!1})}notifyThemeChange(){this.render({updateIcon:!1,updateDecoration:!1})}notifyFileAssociationsChange(){this.render({updateIcon:!0,updateDecoration:!1})}notifyFormattersChange(i){h(this.label)?.scheme===i&&this.render({updateIcon:!1,updateDecoration:!1})}notifyUntitledLabelChange(i){w(i,h(this.label))&&this.render({updateIcon:!1,updateDecoration:!1})}notifyWorkspaceFoldersChange(){if(typeof this.computedWorkspaceFolderLabel=="string"){const i=h(this.label);I.isUri(i)&&this.label?.name===this.computedWorkspaceFolderLabel&&this.setFile(i,this.options)}}setFile(i,e){const t=e?.hideLabel;let o;if(!t){if(e?.fileKind===E.ROOT_FOLDER){const r=this.contextService.getWorkspaceFolder(i);r&&(o=r.name,this.computedWorkspaceFolderLabel=o)}o||(o=z(W(i)))}let s;if(!e?.hidePath){const r=this.labelService.getUriLabel(U(i),{relative:!0});r&&r!=="."&&(s=r)}this.setResource({resource:i,name:o,description:s,range:e?.range},e)}setResource(i,e=Object.create(null)){const t=h(i),o=i?.resource&&!I.isUri(i.resource);if(!e.forceLabel&&!o&&t?.scheme===R.untitled){const a=this.textFileService.untitled.get(t);if(a&&!a.hasAssociatedFilePath){if(typeof i.name=="string"&&(i.name=a.name),typeof i.description=="string"){const F=a.resource.path;i.name!==F?i.description=F:i.description=void 0}const l=a.resource.path;a.name!==l?e.title=`${a.name} \u2022 ${l}`:e.title=l}}if(!e.forceLabel&&!o&&t?.scheme===R.vscodeNotebookCell){const a=this.notebookDocumentService.getNotebook(t),l=a?.getCellIndex(t);a&&l!==void 0&&typeof i.name=="string"&&(e.title=x("notebookCellLabel","{0} \u2022 Cell {1}",i.name,`${l+1}`)),typeof i.name=="string"&&a&&l!==void 0&&typeof i.name=="string"&&(i.name=x("notebookCellLabel","{0} \u2022 Cell {1}",i.name,`${l+1}`))}const s=this.hasResourceChanged(i),r=s||this.hasPathLabelChanged(i),u=this.hasFileKindChanged(e),p=this.hasIconChanged(e);this.label=i,this.options=e,s&&(this.computedLanguageId=void 0),r&&(this.computedPathLabel=void 0),this.render({updateIcon:s||u||p,updateDecoration:s||u})}hasFileKindChanged(i){const e=i?.fileKind,t=this.options?.fileKind;return e!==t}hasResourceChanged(i){const e=h(i),t=h(this.label);return e&&t?e.toString()!==t.toString():!(!e&&!t)}hasPathLabelChanged(i){const e=h(i);return!!e&&this.computedPathLabel!==this.labelService.getUriLabel(e)}hasIconChanged(i){return this.options?.icon!==i?.icon}clear(){this.label=void 0,this.options=void 0,this.computedLanguageId=void 0,this.computedIconClasses=void 0,this.computedPathLabel=void 0,this.setLabel("")}render(i){if(this.isHidden)return this.needsRedraw!==2&&(this.needsRedraw=i.updateIcon||i.updateDecoration?2:1),!1;if(i.updateIcon&&(this.computedIconClasses=void 0),!this.label)return!1;const e={title:"",italic:this.options?.italic,strikethrough:this.options?.strikethrough,matches:this.options?.matches,descriptionMatches:this.options?.descriptionMatches,extraClasses:[],separator:this.options?.separator,domId:this.options?.domId,disabledCommand:this.options?.disabledCommand,labelEscapeNewLines:this.options?.labelEscapeNewLines,descriptionTitle:this.options?.descriptionTitle},t=h(this.label);if(this.options?.title!==void 0&&(e.title=this.options.title),t&&t.scheme!==R.data&&(!this.options?.title||typeof this.options.title!="string"&&!this.options.title.markdownNotSupportedFallback)&&(this.computedPathLabel||(this.computedPathLabel=this.labelService.getUriLabel(t)),!e.title||typeof e.title=="string"?e.title=this.computedPathLabel:e.title.markdownNotSupportedFallback||(e.title.markdownNotSupportedFallback=this.computedPathLabel)),this.options&&!this.options.hideIcon&&(this.computedIconClasses||(this.computedIconClasses=V(this.modelService,this.languageService,t,this.options.fileKind,this.options.icon)),I.isUri(this.options.icon)&&(e.iconPath=this.options.icon),e.extraClasses=this.computedIconClasses.slice(0)),this.options?.extraClasses&&e.extraClasses.push(...this.options.extraClasses),this.options?.fileDecorations&&t){i.updateDecoration&&(this.decoration.value=this.decorationsService.getDecoration(t,this.options.fileKind!==E.FILE));const o=this.decoration.value;if(o){if(o.tooltip){if(typeof e.title=="string")e.title=`${e.title} \u2022 ${o.tooltip}`;else if(typeof e.title?.markdown=="string"){const s=`${e.title.markdown} \u2022 ${o.tooltip}`;e.title={markdown:s,markdownNotSupportedFallback:s}}}o.strikethrough&&(e.strikethrough=!0),this.options.fileDecorations.colors&&e.extraClasses.push(o.labelClassName),this.options.fileDecorations.badges&&(e.extraClasses.push(o.badgeClassName),e.extraClasses.push(o.iconClassName))}}return this.label.range&&(e.suffix=this.label.range.startLineNumber!==this.label.range.endLineNumber?`:${this.label.range.startLineNumber}-${this.label.range.endLineNumber}`:`:${this.label.range.startLineNumber}`),this.setLabel(this.label.name??"",this.label.description,e),this._onDidRender.fire(),!0}dispose(){super.dispose(),this.label=void 0,this.options=void 0,this.computedLanguageId=void 0,this.computedIconClasses=void 0,this.computedPathLabel=void 0,this.computedWorkspaceFolderLabel=void 0}};g=m([n(2,v),n(3,C),n(4,D),n(5,y),n(6,S),n(7,L),n(8,j)],g);export{q as DEFAULT_LABELS_CONTAINER,b as ResourceLabel,f as ResourceLabels};
