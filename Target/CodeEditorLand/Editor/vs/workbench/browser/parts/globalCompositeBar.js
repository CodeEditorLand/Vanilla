var fe=Object.defineProperty;var ye=Object.getOwnPropertyDescriptor;var y=(u,d,e,i)=>{for(var n=i>1?void 0:i?ye(d,e):d,o=u.length-1,r;o>=0;o--)(r=u[o])&&(n=(i?r(d,e,n):r(n))||n);return i&&n&&fe(d,e,n),n},t=(u,d)=>(e,i)=>d(e,i,u);import{$ as ie,addDisposableListener as H,append as ne,clearNode as Ce,EventHelper as W,EventType as $,getWindow as re,hide as be,runWhenWindowIdle as xe,show as Ee}from"../../../base/browser/dom.js";import{StandardKeyboardEvent as Pe}from"../../../base/browser/keyboardEvent.js";import{StandardMouseEvent as Me}from"../../../base/browser/mouseEvent.js";import{EventType as Be}from"../../../base/browser/touch.js";import{ActionBar as Oe,ActionsOrientation as Te}from"../../../base/browser/ui/actionbar/actionbar.js";import"../../../base/browser/ui/actionbar/actionViewItems.js";import{AnchorAlignment as oe,AnchorAxisAlignment as _e}from"../../../base/browser/ui/contextview/contextview.js";import{Action as M,Separator as R,SubmenuAction as Ne,toAction as C}from"../../../base/common/actions.js";import{Codicon as we}from"../../../base/common/codicons.js";import{KeyCode as ce}from"../../../base/common/keyCodes.js";import{Lazy as Le}from"../../../base/common/lazy.js";import{Disposable as De,DisposableStore as se}from"../../../base/common/lifecycle.js";import{ThemeIcon as B}from"../../../base/common/themables.js";import{isString as Ue}from"../../../base/common/types.js";import{localize as l}from"../../../nls.js";import{createAndFillInActionBarActions as He}from"../../../platform/actions/browser/menuEntryActionViewItem.js";import{IMenuService as O,MenuId as ae}from"../../../platform/actions/common/actions.js";import{ICommandService as ue}from"../../../platform/commands/common/commands.js";import{IConfigurationService as x}from"../../../platform/configuration/common/configuration.js";import{IContextKeyService as T}from"../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as _}from"../../../platform/contextview/browser/contextView.js";import{IHoverService as N}from"../../../platform/hover/browser/hover.js";import{IInstantiationService as w}from"../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as L}from"../../../platform/keybinding/common/keybinding.js";import{ILogService as de}from"../../../platform/log/common/log.js";import{IProductService as ve}from"../../../platform/product/common/productService.js";import{ISecretStorageService as le}from"../../../platform/secrets/common/secrets.js";import{IStorageService as X,StorageScope as q,StorageTarget as Re}from"../../../platform/storage/common/storage.js";import{registerIcon as Ke}from"../../../platform/theme/common/iconRegistry.js";import{IThemeService as D}from"../../../platform/theme/common/themeService.js";import{ACCOUNTS_ACTIVITY_ID as j,GLOBAL_ACTIVITY_ID as Z}from"../../common/activity.js";import{ACTIVITY_BAR_BADGE_BACKGROUND as he,ACTIVITY_BAR_BADGE_FOREGROUND as me}from"../../common/theme.js";import{IActivityService as U,NumberBadge as J}from"../../services/activity/common/activity.js";import{getCurrentAuthenticationSessionInfo as Fe}from"../../services/authentication/browser/authenticationService.js";import{IAuthenticationService as pe}from"../../services/authentication/common/authentication.js";import{IWorkbenchEnvironmentService as K}from"../../services/environment/common/environmentService.js";import{IExtensionService as Ve}from"../../services/extensions/common/extensions.js";import{ILifecycleService as ge,LifecyclePhase as ke}from"../../services/lifecycle/common/lifecycle.js";import{IUserDataProfileService as Ae}from"../../services/userDataProfile/common/userDataProfile.js";import{DEFAULT_ICON as Q}from"../../services/userDataProfile/common/userDataProfileIcons.js";import{CompositeBarAction as Ie,CompositeBarActionViewItem as Ye}from"./compositeBarActions.js";let I=class extends De{constructor(e,i,n,o,r,c,s){super();this.contextMenuActionsProvider=e;this.colors=i;this.activityHoverOptions=n;this.instantiationService=r;this.storageService=c;this.extensionService=s;this.element=document.createElement("div");const v=()=>({anchorAlignment:o.getValue("workbench.sideBar.location")==="left"?oe.RIGHT:oe.LEFT,anchorAxisAlignment:_e.HORIZONTAL});this.globalActivityActionBar=this._register(new Oe(this.element,{actionViewItemProvider:(a,h)=>{if(a.id===Z)return this.instantiationService.createInstance(P,this.contextMenuActionsProvider,{...h,colors:this.colors,hoverOptions:this.activityHoverOptions},v);if(a.id===j)return this.instantiationService.createInstance(A,this.contextMenuActionsProvider,{...h,colors:this.colors,hoverOptions:this.activityHoverOptions},v,m=>{m.unshift(C({id:"hideAccounts",label:l("hideAccounts","Hide Accounts"),run:()=>k(c,!1)}),new R)});throw new Error(`No view item for action '${a.id}'`)},orientation:Te.VERTICAL,ariaLabel:l("manage","Manage"),preventLoopNavigation:!0})),this.accountsVisibilityPreference&&this.globalActivityActionBar.push(this.accountAction,{index:I.ACCOUNTS_ACTION_INDEX}),this.globalActivityActionBar.push(this.globalActivityAction),this.registerListeners()}static ACCOUNTS_ACTION_INDEX=0;static ACCOUNTS_ICON=Ke("accounts-view-bar-icon",we.account,l("accountsViewBarIcon","Accounts icon in the view bar."));element;globalActivityAction=this._register(new M(Z));accountAction=this._register(new M(j));globalActivityActionBar;registerListeners(){this.extensionService.whenInstalledExtensionsRegistered().then(()=>{this._store.isDisposed||this._register(this.storageService.onDidChangeValue(q.PROFILE,A.ACCOUNTS_VISIBILITY_PREFERENCE_KEY,this._store)(()=>this.toggleAccountsActivity()))})}create(e){e.appendChild(this.element)}focus(){this.globalActivityActionBar.focus(!0)}size(){return this.globalActivityActionBar.viewItems.length}getContextMenuActions(){return[C({id:"toggleAccountsVisibility",label:l("accounts","Accounts"),checked:this.accountsVisibilityPreference,run:()=>this.accountsVisibilityPreference=!this.accountsVisibilityPreference})]}toggleAccountsActivity(){this.globalActivityActionBar.length()===2&&this.accountsVisibilityPreference||(this.globalActivityActionBar.length()===2?this.globalActivityActionBar.pull(I.ACCOUNTS_ACTION_INDEX):this.globalActivityActionBar.push(this.accountAction,{index:I.ACCOUNTS_ACTION_INDEX}))}get accountsVisibilityPreference(){return G(this.storageService)}set accountsVisibilityPreference(e){k(this.storageService,e)}};I=y([t(3,x),t(4,w),t(5,X),t(6,Ve)],I);let E=class extends Ye{constructor(e,i,n,o,r,c,s,v,a,h,m,g,f){super(i,{draggable:!1,icon:!0,hasPopup:!0,...n},()=>!0,c,s,m,g);this.menuId=e;this.contextMenuActionsProvider=o;this.contextMenuAlignmentOptions=r;this.menuService=v;this.contextMenuService=a;this.contextKeyService=h;this.activityService=f;this.updateItemActivity(),this._register(this.activityService.onDidChangeActivity(p=>{Ue(p)&&p===this.compositeBarActionItem.id&&this.updateItemActivity()}))}updateItemActivity(){const e=this.activityService.getActivity(this.compositeBarActionItem.id);let i=e[0];if(i){const{badge:n,priority:o}=i;n instanceof J&&e.length>1&&(i={badge:this.getCumulativeNumberBadge(e,o??0)})}this.action.activity=i}getCumulativeNumberBadge(e,i){const n=e.filter(c=>c.badge instanceof J&&(c.priority??0)===i),o=n.reduce((c,s)=>c+s.badge.number,0),r=()=>n.reduce((c,s,v)=>(c=c+s.badge.getDescription(),v<n.length-1&&(c=`${c}
`),c),"");return new J(o,r)}render(e){super.render(e),this._register(H(this.container,$.MOUSE_DOWN,async i=>{W.stop(i,!0),i?.button!==2&&this.run()})),this._register(H(this.container,$.CONTEXT_MENU,async i=>{i.stopPropagation();const n=new se,o=await this.resolveContextMenuActions(n),r=new Me(re(this.container),i);this.contextMenuService.showContextMenu({getAnchor:()=>r,getActions:()=>o,onHide:()=>n.dispose()})})),this._register(H(this.container,$.KEY_UP,i=>{const n=new Pe(i);(n.equals(ce.Enter)||n.equals(ce.Space))&&(W.stop(i,!0),this.run())})),this._register(H(this.container,Be.Tap,i=>{W.stop(i,!0),this.run()}))}async resolveContextMenuActions(e){return this.contextMenuActionsProvider()}async run(){const e=new se,i=e.add(this.menuService.createMenu(this.menuId,this.contextKeyService)),n=await this.resolveMainMenuActions(i,e),{anchorAlignment:o,anchorAxisAlignment:r}=this.contextMenuAlignmentOptions()??{anchorAlignment:void 0,anchorAxisAlignment:void 0};this.contextMenuService.showContextMenu({getAnchor:()=>this.label,anchorAlignment:o,anchorAxisAlignment:r,getActions:()=>n,onHide:()=>e.dispose(),menuActionOptions:{renderShortTitle:!0}})}async resolveMainMenuActions(e,i){const n=[];return He(e,{renderShortTitle:!0},{primary:[],secondary:n}),n}};E=y([t(5,D),t(6,N),t(7,O),t(8,_),t(9,T),t(10,x),t(11,L),t(12,U)],E);let A=class extends E{constructor(e,i,n,o,r,c,s,v,a,h,m,g,f,p,S,Y,ee,z,b,ze){const te=b.createInstance(Ie,{id:j,name:l("accounts","Accounts"),classNames:B.asClassNameArray(I.ACCOUNTS_ICON)});super(ae.AccountsContext,te,i,e,n,r,s,a,v,h,p,S,z);this.fillContextMenuActions=o;this.lifecycleService=c;this.authenticationService=m;this.productService=f;this.secretStorageService=Y;this.logService=ee;this.commandService=ze;this._register(te),this.registerListeners(),this.initialize()}static ACCOUNTS_VISIBILITY_PREFERENCE_KEY="workbench.activity.showAccounts";groupedAccounts=new Map;problematicProviders=new Set;initialized=!1;sessionFromEmbedder=new Le(()=>Fe(this.secretStorageService,this.productService));registerListeners(){this._register(this.authenticationService.onDidRegisterAuthenticationProvider(async e=>{await this.addAccountsFromProvider(e.id)})),this._register(this.authenticationService.onDidUnregisterAuthenticationProvider(e=>{this.groupedAccounts.delete(e.id),this.problematicProviders.delete(e.id)})),this._register(this.authenticationService.onDidChangeSessions(async e=>{if(e.event.removed)for(const i of e.event.removed)this.removeAccount(e.providerId,i.account);for(const i of[...e.event.changed??[],...e.event.added??[]])try{await this.addOrUpdateAccount(e.providerId,i.account)}catch(n){this.logService.error(n)}}))}async initialize(){if(await this.lifecycleService.when(ke.Restored),this._store.isDisposed)return;const e=this._register(xe(re(this.element),async()=>{await this.doInitialize(),e.dispose()}))}async doInitialize(){const e=this.authenticationService.getProviderIds(),i=await Promise.allSettled(e.map(n=>this.addAccountsFromProvider(n)));for(const n of i)n.status==="rejected"&&this.logService.error(n.reason);this.initialized=!0}async resolveMainMenuActions(e,i){await super.resolveMainMenuActions(e,i);const n=this.authenticationService.getProviderIds(),o=e.getActions();let r=[];for(const c of n){if(!this.initialized){const a=i.add(new M("noAccountsAvailable",l("loading","Loading..."),void 0,!1));r.push(a);break}const s=this.authenticationService.getProvider(c).label,v=this.groupedAccounts.get(c);if(!v){if(this.problematicProviders.has(c)){const a=i.add(new M("providerUnavailable",l("authProviderUnavailable","{0} is currently unavailable",s),void 0,!1));r.push(a);try{await this.addAccountsFromProvider(c)}catch(h){this.logService.error(h)}}continue}for(const a of v){const m=[C({id:`configureSessions${a.label}`,label:l("manageTrustedExtensions","Manage Trusted Extensions"),enabled:!0,run:()=>this.commandService.executeCommand("_manageTrustedExtensionsForAccount",{providerId:c,accountLabel:a.label})})];a.canSignOut&&m.push(C({id:"signOut",label:l("signOut","Sign Out"),enabled:!0,run:()=>this.commandService.executeCommand("_signOutOfAccount",{providerId:c,accountLabel:a.label})}));const g=new Ne("activitybar.submenu",`${a.label} (${s})`,m);r.push(g)}}if(n.length&&!r.length){const c=i.add(new M("noAccountsAvailable",l("noAccounts","You are not signed in to any accounts"),void 0,!1));r.push(c)}return r.length&&o.length&&r.push(new R),o.forEach((c,s)=>{const v=c[1];r=r.concat(v),s!==o.length-1&&r.push(new R)}),r}async resolveContextMenuActions(e){const i=await super.resolveContextMenuActions(e);return this.fillContextMenuActions(i),i}async addOrUpdateAccount(e,i){let n=this.groupedAccounts.get(e);n||(n=[],this.groupedAccounts.set(e,n));const o=await this.sessionFromEmbedder.value;let r=!0;o&&!o.canSignOut&&(await this.authenticationService.getSessions(e)).some(s=>s.id===o.id&&s.account.id===i.id)&&(r=!1);const c=n.find(s=>s.label===i.label);c?r||(c.canSignOut=r):n.push({...i,canSignOut:r})}removeAccount(e,i){const n=this.groupedAccounts.get(e);if(!n)return;const o=n.findIndex(r=>r.id===i.id);o!==-1&&(n.splice(o,1),n.length===0&&this.groupedAccounts.delete(e))}async addAccountsFromProvider(e){try{const i=await this.authenticationService.getSessions(e);this.problematicProviders.delete(e);for(const n of i)try{await this.addOrUpdateAccount(e,n.account)}catch(o){this.logService.error(o)}}catch(i){this.logService.error(i),this.problematicProviders.add(e)}}};A=y([t(4,D),t(5,ge),t(6,N),t(7,_),t(8,O),t(9,T),t(10,pe),t(11,K),t(12,ve),t(13,x),t(14,L),t(15,le),t(16,de),t(17,U),t(18,w),t(19,ue)],A);let P=class extends E{constructor(e,i,n,o,r,c,s,v,a,h,m,g,f,p){const S=f.createInstance(Ie,{id:Z,name:l("manage","Manage"),classNames:B.asClassNameArray(o.currentProfile.icon?B.fromId(o.currentProfile.icon):Q)});super(ae.GlobalActivity,S,i,e,n,r,c,s,v,a,h,g,p);this.userDataProfileService=o;this._register(S),this._register(this.userDataProfileService.onDidChangeCurrentProfile(Y=>{S.compositeBarActionItem={...S.compositeBarActionItem,classNames:B.asClassNameArray(o.currentProfile.icon?B.fromId(o.currentProfile.icon):Q)}}))}profileBadge;profileBadgeContent;render(e){super.render(e),this.profileBadge=ne(e,ie(".profile-badge")),this.profileBadgeContent=ne(this.profileBadge,ie(".profile-badge-content")),this.updateProfileBadge()}updateProfileBadge(){!this.profileBadge||!this.profileBadgeContent||(Ce(this.profileBadgeContent),be(this.profileBadge),!this.userDataProfileService.currentProfile.isDefault&&(this.userDataProfileService.currentProfile.icon&&this.userDataProfileService.currentProfile.icon!==Q.id||this.action.activity||(Ee(this.profileBadge),this.profileBadgeContent.classList.toggle("profile-text-overlay",!0),this.profileBadgeContent.classList.toggle("profile-icon-overlay",!1),this.profileBadgeContent.textContent=this.userDataProfileService.currentProfile.name.substring(0,2).toUpperCase())))}updateActivity(){super.updateActivity(),this.updateProfileBadge()}computeTitle(){return this.userDataProfileService.currentProfile.isDefault?super.computeTitle():l("manage profile","Manage {0} (Profile)",this.userDataProfileService.currentProfile.name)}};P=y([t(3,Ae),t(4,D),t(5,N),t(6,O),t(7,_),t(8,T),t(9,x),t(10,K),t(11,L),t(12,w),t(13,U)],P);let F=class extends A{constructor(d,e,i,n,o,r,c,s,v,a,h,m,g,f,p,S,Y,ee,z){super(()=>Se(p,!0),{...e,colors:b=>({badgeBackground:b.getColor(he),badgeForeground:b.getColor(me)}),hoverOptions:d,compact:!0},()=>{},b=>b,i,n,o,r,c,s,v,a,h,m,g,f,S,Y,ee,z)}};F=y([t(2,D),t(3,ge),t(4,N),t(5,_),t(6,O),t(7,T),t(8,pe),t(9,K),t(10,ve),t(11,x),t(12,L),t(13,le),t(14,X),t(15,de),t(16,U),t(17,w),t(18,ue)],F);let V=class extends P{constructor(d,e,i,n,o,r,c,s,v,a,h,m,g,f){super(()=>Se(f,!1),{...e,colors:p=>({badgeBackground:p.getColor(he),badgeForeground:p.getColor(me)}),hoverOptions:d,compact:!0},()=>{},i,n,o,r,c,s,v,a,h,m,g)}};V=y([t(2,Ae),t(3,D),t(4,N),t(5,O),t(6,_),t(7,T),t(8,x),t(9,K),t(10,L),t(11,w),t(12,U),t(13,X)],V);function Se(u,d){const e=[];return d&&e.push(C({id:"hideAccounts",label:l("hideAccounts","Hide Accounts"),run:()=>k(u,!1)}),new R),[...e,C({id:"toggle.hideAccounts",label:l("accounts","Accounts"),checked:G(u),run:()=>k(u,!G(u))}),C({id:"toggle.hideManage",label:l("manage","Manage"),checked:!0,enabled:!1,run:()=>{throw new Error('"Manage" can not be hidden')}})]}function G(u){return u.getBoolean(A.ACCOUNTS_VISIBILITY_PREFERENCE_KEY,q.PROFILE,!0)}function k(u,d){u.store(A.ACCOUNTS_VISIBILITY_PREFERENCE_KEY,d,q.PROFILE,Re.USER)}export{A as AccountsActivityActionViewItem,P as GlobalActivityActionViewItem,I as GlobalCompositeBar,F as SimpleAccountActivityActionViewItem,V as SimpleGlobalActivityActionViewItem,G as isAccountsActionVisible};
