var fe=Object.defineProperty;var ye=Object.getOwnPropertyDescriptor;var y=(u,d,e,i)=>{for(var n=i>1?void 0:i?ye(d,e):d,o=u.length-1,r;o>=0;o--)(r=u[o])&&(n=(i?r(d,e,n):r(n))||n);return i&&n&&fe(d,e,n),n},t=(u,d)=>(e,i)=>d(e,i,u);import{localize as l}from"../../../nls.js";import{ActionBar as Ce,ActionsOrientation as be}from"../../../base/browser/ui/actionbar/actionbar.js";import{ACCOUNTS_ACTIVITY_ID as W,GLOBAL_ACTIVITY_ID as $}from"../../common/activity.js";import{IActivityService as M,NumberBadge as X}from"../../services/activity/common/activity.js";import{IInstantiationService as B}from"../../../platform/instantiation/common/instantiation.js";import{DisposableStore as ie,Disposable as xe}from"../../../base/common/lifecycle.js";import{IThemeService as O}from"../../../platform/theme/common/themeService.js";import{IStorageService as q,StorageScope as j,StorageTarget as Ee}from"../../../platform/storage/common/storage.js";import{IExtensionService as Pe}from"../../services/extensions/common/extensions.js";import{CompositeBarActionViewItem as Me,CompositeBarAction as ne}from"./compositeBarActions.js";import{Codicon as Be}from"../../../base/common/codicons.js";import{ThemeIcon as T}from"../../../base/common/themables.js";import{registerIcon as Oe}from"../../../platform/theme/common/iconRegistry.js";import{Action as _,Separator as H,SubmenuAction as Te,toAction as C}from"../../../base/common/actions.js";import{IMenuService as N,MenuId as re}from"../../../platform/actions/common/actions.js";import{addDisposableListener as R,EventType as Z,append as oe,clearNode as _e,hide as Ne,show as we,EventHelper as J,$ as ce,runWhenWindowIdle as Le,getWindow as se}from"../../../base/browser/dom.js";import{StandardKeyboardEvent as De}from"../../../base/browser/keyboardEvent.js";import{StandardMouseEvent as Ue}from"../../../base/browser/mouseEvent.js";import{EventType as He}from"../../../base/browser/touch.js";import{AnchorAlignment as ae,AnchorAxisAlignment as Re}from"../../../base/browser/ui/contextview/contextview.js";import{Lazy as Ke}from"../../../base/common/lazy.js";import{createAndFillInActionBarActions as Fe}from"../../../platform/actions/browser/menuEntryActionViewItem.js";import{IConfigurationService as x}from"../../../platform/configuration/common/configuration.js";import{IContextKeyService as w}from"../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as L}from"../../../platform/contextview/browser/contextView.js";import{IKeybindingService as D}from"../../../platform/keybinding/common/keybinding.js";import{ILogService as ue}from"../../../platform/log/common/log.js";import{IProductService as de}from"../../../platform/product/common/productService.js";import{ISecretStorageService as ve}from"../../../platform/secrets/common/secrets.js";import{getCurrentAuthenticationSessionInfo as Ve}from"../../services/authentication/browser/authenticationService.js";import{IAuthenticationService as le}from"../../services/authentication/common/authentication.js";import{IWorkbenchEnvironmentService as K}from"../../services/environment/common/environmentService.js";import{IHoverService as U}from"../../../platform/hover/browser/hover.js";import{ILifecycleService as he,LifecyclePhase as ke}from"../../services/lifecycle/common/lifecycle.js";import{IUserDataProfileService as me}from"../../services/userDataProfile/common/userDataProfile.js";import{DEFAULT_ICON as Q}from"../../services/userDataProfile/common/userDataProfileIcons.js";import{isString as Ye}from"../../../base/common/types.js";import{KeyCode as pe}from"../../../base/common/keyCodes.js";import{ACTIVITY_BAR_BADGE_BACKGROUND as ge,ACTIVITY_BAR_BADGE_FOREGROUND as Ae}from"../../common/theme.js";import"../../../base/browser/ui/actionbar/actionViewItems.js";import{ICommandService as Ie}from"../../../platform/commands/common/commands.js";let I=class extends xe{constructor(e,i,n,o,r,c,s){super();this.contextMenuActionsProvider=e;this.colors=i;this.activityHoverOptions=n;this.instantiationService=r;this.storageService=c;this.extensionService=s;this.element=document.createElement("div");const v=()=>({anchorAlignment:o.getValue("workbench.sideBar.location")==="left"?ae.RIGHT:ae.LEFT,anchorAxisAlignment:Re.HORIZONTAL});this.globalActivityActionBar=this._register(new Ce(this.element,{actionViewItemProvider:(a,h)=>{if(a.id===$)return this.instantiationService.createInstance(P,this.contextMenuActionsProvider,{...h,colors:this.colors,hoverOptions:this.activityHoverOptions},v);if(a.id===W)return this.instantiationService.createInstance(A,this.contextMenuActionsProvider,{...h,colors:this.colors,hoverOptions:this.activityHoverOptions},v,m=>{m.unshift(C({id:"hideAccounts",label:l("hideAccounts","Hide Accounts"),run:()=>k(c,!1)}),new H)});throw new Error(`No view item for action '${a.id}'`)},orientation:be.VERTICAL,ariaLabel:l("manage","Manage"),preventLoopNavigation:!0})),this.accountsVisibilityPreference&&this.globalActivityActionBar.push(this.accountAction,{index:I.ACCOUNTS_ACTION_INDEX}),this.globalActivityActionBar.push(this.globalActivityAction),this.registerListeners()}static ACCOUNTS_ACTION_INDEX=0;static ACCOUNTS_ICON=Oe("accounts-view-bar-icon",Be.account,l("accountsViewBarIcon","Accounts icon in the view bar."));element;globalActivityAction=this._register(new _($));accountAction=this._register(new _(W));globalActivityActionBar;registerListeners(){this.extensionService.whenInstalledExtensionsRegistered().then(()=>{this._store.isDisposed||this._register(this.storageService.onDidChangeValue(j.PROFILE,A.ACCOUNTS_VISIBILITY_PREFERENCE_KEY,this._store)(()=>this.toggleAccountsActivity()))})}create(e){e.appendChild(this.element)}focus(){this.globalActivityActionBar.focus(!0)}size(){return this.globalActivityActionBar.viewItems.length}getContextMenuActions(){return[C({id:"toggleAccountsVisibility",label:l("accounts","Accounts"),checked:this.accountsVisibilityPreference,run:()=>this.accountsVisibilityPreference=!this.accountsVisibilityPreference})]}toggleAccountsActivity(){this.globalActivityActionBar.length()===2&&this.accountsVisibilityPreference||(this.globalActivityActionBar.length()===2?this.globalActivityActionBar.pull(I.ACCOUNTS_ACTION_INDEX):this.globalActivityActionBar.push(this.accountAction,{index:I.ACCOUNTS_ACTION_INDEX}))}get accountsVisibilityPreference(){return G(this.storageService)}set accountsVisibilityPreference(e){k(this.storageService,e)}};I=y([t(3,x),t(4,B),t(5,q),t(6,Pe)],I);let E=class extends Me{constructor(e,i,n,o,r,c,s,v,a,h,m,g,f){super(i,{draggable:!1,icon:!0,hasPopup:!0,...n},()=>!0,c,s,m,g);this.menuId=e;this.contextMenuActionsProvider=o;this.contextMenuAlignmentOptions=r;this.menuService=v;this.contextMenuService=a;this.contextKeyService=h;this.activityService=f;this.updateItemActivity(),this._register(this.activityService.onDidChangeActivity(p=>{Ye(p)&&p===this.compositeBarActionItem.id&&this.updateItemActivity()}))}updateItemActivity(){const e=this.activityService.getActivity(this.compositeBarActionItem.id);let i=e[0];if(i){const{badge:n,priority:o}=i;n instanceof X&&e.length>1&&(i={badge:this.getCumulativeNumberBadge(e,o??0)})}this.action.activity=i}getCumulativeNumberBadge(e,i){const n=e.filter(c=>c.badge instanceof X&&(c.priority??0)===i),o=n.reduce((c,s)=>c+s.badge.number,0),r=()=>n.reduce((c,s,v)=>(c=c+s.badge.getDescription(),v<n.length-1&&(c=`${c}
`),c),"");return new X(o,r)}render(e){super.render(e),this._register(R(this.container,Z.MOUSE_DOWN,async i=>{J.stop(i,!0),i?.button!==2&&this.run()})),this._register(R(this.container,Z.CONTEXT_MENU,async i=>{i.stopPropagation();const n=new ie,o=await this.resolveContextMenuActions(n),r=new Ue(se(this.container),i);this.contextMenuService.showContextMenu({getAnchor:()=>r,getActions:()=>o,onHide:()=>n.dispose()})})),this._register(R(this.container,Z.KEY_UP,i=>{const n=new De(i);(n.equals(pe.Enter)||n.equals(pe.Space))&&(J.stop(i,!0),this.run())})),this._register(R(this.container,He.Tap,i=>{J.stop(i,!0),this.run()}))}async resolveContextMenuActions(e){return this.contextMenuActionsProvider()}async run(){const e=new ie,i=e.add(this.menuService.createMenu(this.menuId,this.contextKeyService)),n=await this.resolveMainMenuActions(i,e),{anchorAlignment:o,anchorAxisAlignment:r}=this.contextMenuAlignmentOptions()??{anchorAlignment:void 0,anchorAxisAlignment:void 0};this.contextMenuService.showContextMenu({getAnchor:()=>this.label,anchorAlignment:o,anchorAxisAlignment:r,getActions:()=>n,onHide:()=>e.dispose(),menuActionOptions:{renderShortTitle:!0}})}async resolveMainMenuActions(e,i){const n=[];return Fe(e,{renderShortTitle:!0},{primary:[],secondary:n}),n}};E=y([t(5,O),t(6,U),t(7,N),t(8,L),t(9,w),t(10,x),t(11,D),t(12,M)],E);let A=class extends E{constructor(e,i,n,o,r,c,s,v,a,h,m,g,f,p,S,Y,ee,z,b,ze){const te=b.createInstance(ne,{id:W,name:l("accounts","Accounts"),classNames:T.asClassNameArray(I.ACCOUNTS_ICON)});super(re.AccountsContext,te,i,e,n,r,s,a,v,h,p,S,z);this.fillContextMenuActions=o;this.lifecycleService=c;this.authenticationService=m;this.productService=f;this.secretStorageService=Y;this.logService=ee;this.commandService=ze;this._register(te),this.registerListeners(),this.initialize()}static ACCOUNTS_VISIBILITY_PREFERENCE_KEY="workbench.activity.showAccounts";groupedAccounts=new Map;problematicProviders=new Set;initialized=!1;sessionFromEmbedder=new Ke(()=>Ve(this.secretStorageService,this.productService));registerListeners(){this._register(this.authenticationService.onDidRegisterAuthenticationProvider(async e=>{await this.addAccountsFromProvider(e.id)})),this._register(this.authenticationService.onDidUnregisterAuthenticationProvider(e=>{this.groupedAccounts.delete(e.id),this.problematicProviders.delete(e.id)})),this._register(this.authenticationService.onDidChangeSessions(async e=>{if(e.event.removed)for(const i of e.event.removed)this.removeAccount(e.providerId,i.account);for(const i of[...e.event.changed??[],...e.event.added??[]])try{await this.addOrUpdateAccount(e.providerId,i.account)}catch(n){this.logService.error(n)}}))}async initialize(){if(await this.lifecycleService.when(ke.Restored),this._store.isDisposed)return;const e=this._register(Le(se(this.element),async()=>{await this.doInitialize(),e.dispose()}))}async doInitialize(){const e=this.authenticationService.getProviderIds(),i=await Promise.allSettled(e.map(n=>this.addAccountsFromProvider(n)));for(const n of i)n.status==="rejected"&&this.logService.error(n.reason);this.initialized=!0}async resolveMainMenuActions(e,i){await super.resolveMainMenuActions(e,i);const n=this.authenticationService.getProviderIds(),o=e.getActions();let r=[];for(const c of n){if(!this.initialized){const a=i.add(new _("noAccountsAvailable",l("loading","Loading..."),void 0,!1));r.push(a);break}const s=this.authenticationService.getProvider(c).label,v=this.groupedAccounts.get(c);if(!v){if(this.problematicProviders.has(c)){const a=i.add(new _("providerUnavailable",l("authProviderUnavailable","{0} is currently unavailable",s),void 0,!1));r.push(a);try{await this.addAccountsFromProvider(c)}catch(h){this.logService.error(h)}}continue}for(const a of v){const m=[C({id:`configureSessions${a.label}`,label:l("manageTrustedExtensions","Manage Trusted Extensions"),enabled:!0,run:()=>this.commandService.executeCommand("_manageTrustedExtensionsForAccount",{providerId:c,accountLabel:a.label})})];a.canSignOut&&m.push(C({id:"signOut",label:l("signOut","Sign Out"),enabled:!0,run:()=>this.commandService.executeCommand("_signOutOfAccount",{providerId:c,accountLabel:a.label})}));const g=new Te("activitybar.submenu",`${a.label} (${s})`,m);r.push(g)}}if(n.length&&!r.length){const c=i.add(new _("noAccountsAvailable",l("noAccounts","You are not signed in to any accounts"),void 0,!1));r.push(c)}return r.length&&o.length&&r.push(new H),o.forEach((c,s)=>{const v=c[1];r=r.concat(v),s!==o.length-1&&r.push(new H)}),r}async resolveContextMenuActions(e){const i=await super.resolveContextMenuActions(e);return this.fillContextMenuActions(i),i}async addOrUpdateAccount(e,i){let n=this.groupedAccounts.get(e);n||(n=[],this.groupedAccounts.set(e,n));const o=await this.sessionFromEmbedder.value;let r=!0;o&&!o.canSignOut&&(await this.authenticationService.getSessions(e)).some(s=>s.id===o.id&&s.account.id===i.id)&&(r=!1);const c=n.find(s=>s.label===i.label);c?r||(c.canSignOut=r):n.push({...i,canSignOut:r})}removeAccount(e,i){const n=this.groupedAccounts.get(e);if(!n)return;const o=n.findIndex(r=>r.id===i.id);o!==-1&&(n.splice(o,1),n.length===0&&this.groupedAccounts.delete(e))}async addAccountsFromProvider(e){try{const i=await this.authenticationService.getSessions(e);this.problematicProviders.delete(e);for(const n of i)try{await this.addOrUpdateAccount(e,n.account)}catch(o){this.logService.error(o)}}catch(i){this.logService.error(i),this.problematicProviders.add(e)}}};A=y([t(4,O),t(5,he),t(6,U),t(7,L),t(8,N),t(9,w),t(10,le),t(11,K),t(12,de),t(13,x),t(14,D),t(15,ve),t(16,ue),t(17,M),t(18,B),t(19,Ie)],A);let P=class extends E{constructor(e,i,n,o,r,c,s,v,a,h,m,g,f,p){const S=f.createInstance(ne,{id:$,name:l("manage","Manage"),classNames:T.asClassNameArray(o.currentProfile.icon?T.fromId(o.currentProfile.icon):Q)});super(re.GlobalActivity,S,i,e,n,r,c,s,v,a,h,g,p);this.userDataProfileService=o;this._register(S),this._register(this.userDataProfileService.onDidChangeCurrentProfile(Y=>{S.compositeBarActionItem={...S.compositeBarActionItem,classNames:T.asClassNameArray(o.currentProfile.icon?T.fromId(o.currentProfile.icon):Q)}}))}profileBadge;profileBadgeContent;render(e){super.render(e),this.profileBadge=oe(e,ce(".profile-badge")),this.profileBadgeContent=oe(this.profileBadge,ce(".profile-badge-content")),this.updateProfileBadge()}updateProfileBadge(){!this.profileBadge||!this.profileBadgeContent||(_e(this.profileBadgeContent),Ne(this.profileBadge),!this.userDataProfileService.currentProfile.isDefault&&(this.userDataProfileService.currentProfile.icon&&this.userDataProfileService.currentProfile.icon!==Q.id||this.action.activity||(we(this.profileBadge),this.profileBadgeContent.classList.add("profile-text-overlay"),this.profileBadgeContent.textContent=this.userDataProfileService.currentProfile.name.substring(0,2).toUpperCase())))}updateActivity(){super.updateActivity(),this.updateProfileBadge()}computeTitle(){return this.userDataProfileService.currentProfile.isDefault?super.computeTitle():l("manage profile","Manage {0} (Profile)",this.userDataProfileService.currentProfile.name)}};P=y([t(3,me),t(4,O),t(5,U),t(6,N),t(7,L),t(8,w),t(9,x),t(10,K),t(11,D),t(12,B),t(13,M)],P);let F=class extends A{constructor(d,e,i,n,o,r,c,s,v,a,h,m,g,f,p,S,Y,ee,z){super(()=>Se(p,!0),{...e,colors:b=>({badgeBackground:b.getColor(ge),badgeForeground:b.getColor(Ae)}),hoverOptions:d,compact:!0},()=>{},b=>b,i,n,o,r,c,s,v,a,h,m,g,f,S,Y,ee,z)}};F=y([t(2,O),t(3,he),t(4,U),t(5,L),t(6,N),t(7,w),t(8,le),t(9,K),t(10,de),t(11,x),t(12,D),t(13,ve),t(14,q),t(15,ue),t(16,M),t(17,B),t(18,Ie)],F);let V=class extends P{constructor(d,e,i,n,o,r,c,s,v,a,h,m,g,f){super(()=>Se(f,!1),{...e,colors:p=>({badgeBackground:p.getColor(ge),badgeForeground:p.getColor(Ae)}),hoverOptions:d,compact:!0},()=>{},i,n,o,r,c,s,v,a,h,m,g)}};V=y([t(2,me),t(3,O),t(4,U),t(5,N),t(6,L),t(7,w),t(8,x),t(9,K),t(10,D),t(11,B),t(12,M),t(13,q)],V);function Se(u,d){const e=[];return d&&e.push(C({id:"hideAccounts",label:l("hideAccounts","Hide Accounts"),run:()=>k(u,!1)}),new H),[...e,C({id:"toggle.hideAccounts",label:l("accounts","Accounts"),checked:G(u),run:()=>k(u,!G(u))}),C({id:"toggle.hideManage",label:l("manage","Manage"),checked:!0,enabled:!1,run:()=>{throw new Error('"Manage" can not be hidden')}})]}function G(u){return u.getBoolean(A.ACCOUNTS_VISIBILITY_PREFERENCE_KEY,j.PROFILE,!0)}function k(u,d){u.store(A.ACCOUNTS_VISIBILITY_PREFERENCE_KEY,d,j.PROFILE,Ee.USER)}export{A as AccountsActivityActionViewItem,P as GlobalActivityActionViewItem,I as GlobalCompositeBar,F as SimpleAccountActivityActionViewItem,V as SimpleGlobalActivityActionViewItem,G as isAccountsActionVisible};
