var q=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var C=(l,d,e,t)=>{for(var i=t>1?void 0:t?G(d,e):d,o=l.length-1,r;o>=0;o--)(r=l[o])&&(i=(t?r(d,e,i):r(i))||i);return t&&i&&q(d,e,i),i},n=(l,d)=>(e,t)=>d(e,t,l);import{localize as c}from"../../../nls.js";import{Action as T,Separator as K}from"../../../base/common/actions.js";import{$ as x,addDisposableListener as y,append as H,clearNode as J,EventHelper as F,EventType as A,getDomNodePagePosition as Q,hide as R,show as k}from"../../../base/browser/dom.js";import{ICommandService as Z}from"../../../platform/commands/common/commands.js";import{toDisposable as L,DisposableStore as z,MutableDisposable as ee}from"../../../base/common/lifecycle.js";import{IContextMenuService as W}from"../../../platform/contextview/browser/contextView.js";import{IThemeService as M}from"../../../platform/theme/common/themeService.js";import{NumberBadge as X,ProgressBadge as te,IconBadge as ie}from"../../services/activity/common/activity.js";import{IInstantiationService as oe}from"../../../platform/instantiation/common/instantiation.js";import{DelayedDragHandler as re}from"../../../base/browser/dnd.js";import{IKeybindingService as P}from"../../../platform/keybinding/common/keybinding.js";import{Emitter as $,Event as se}from"../../../base/common/event.js";import{CompositeDragAndDropObserver as ne,toggleDropEffect as ae}from"../dnd.js";import"../../../base/common/color.js";import{BaseActionViewItem as de}from"../../../base/browser/ui/actionbar/actionViewItems.js";import{Codicon as ce}from"../../../base/common/codicons.js";import{ThemeIcon as j}from"../../../base/common/themables.js";import{IHoverService as _}from"../../../platform/hover/browser/hover.js";import{RunOnceScheduler as le}from"../../../base/common/async.js";import{IConfigurationService as w}from"../../../platform/configuration/common/configuration.js";import"../../../base/browser/ui/hover/hoverWidget.js";import"../../../base/common/uri.js";import{badgeBackground as he,badgeForeground as pe,contrastBorder as ge}from"../../../platform/theme/common/colorRegistry.js";class O extends T{constructor(e){super(e.id,e.name,e.classNames?.join(" "),!0);this.item=e}_onDidChangeCompositeBarActionItem=this._register(new $);onDidChangeCompositeBarActionItem=this._onDidChangeCompositeBarActionItem.event;_onDidChangeActivity=this._register(new $);onDidChangeActivity=this._onDidChangeActivity.event;_activity;get compositeBarActionItem(){return this.item}set compositeBarActionItem(e){this._label=e.name,this.item=e,this._onDidChangeCompositeBarActionItem.fire(this)}get activity(){return this._activity}set activity(e){this._activity=e,this._onDidChangeActivity.fire(e)}activate(){this.checked||this._setChecked(!0)}deactivate(){this.checked&&this._setChecked(!1)}}let p=class extends de{constructor(e,t,i,o,r,s,a){super(null,e,t);this.badgesEnabled=i;this.themeService=o;this.hoverService=r;this.configurationService=s;this.keybindingService=a;this.options=t,this._register(this.themeService.onDidColorThemeChange(this.onThemeChange,this)),this._register(e.onDidChangeCompositeBarActionItem(()=>this.update())),this._register(se.filter(a.onDidUpdateKeybindings,()=>this.keybindingLabel!==this.computeKeybindingLabel())(()=>this.updateTitle())),this._register(e.onDidChangeActivity(()=>this.updateActivity())),this._register(L(()=>this.showHoverScheduler.cancel()))}static hoverLeaveTime=0;container;label;badge;options;badgeContent;badgeDisposable=this._register(new ee);mouseUpTimeout;keybindingLabel;hoverDisposables=this._register(new z);lastHover;showHoverScheduler=new le(()=>this.showHover(),0);get compositeBarActionItem(){return this._action.compositeBarActionItem}updateStyles(){const e=this.themeService.getColorTheme(),t=this.options.colors(e);if(this.label){if(this.options.icon){const i=this._action.checked?t.activeForegroundColor:t.inactiveForegroundColor;this.compositeBarActionItem.iconUrl?(this.label.style.backgroundColor=i?i.toString():"",this.label.style.color=""):(this.label.style.color=i?i.toString():"",this.label.style.backgroundColor="")}else{const i=this._action.checked?t.activeForegroundColor:t.inactiveForegroundColor,o=this._action.checked?t.activeBorderBottomColor:null;this.label.style.color=i?i.toString():"",this.label.style.borderBottomColor=o?o.toString():""}this.container.style.setProperty("--insert-border-color",t.dragAndDropBorder?t.dragAndDropBorder.toString():"")}if(this.badgeContent){const i=this.getActivity()?.badge.getColors(e),o=i?.badgeForeground??t.badgeForeground??e.getColor(pe),r=i?.badgeBackground??t.badgeBackground??e.getColor(he),s=i?.badgeBorder??e.getColor(ge);this.badgeContent.style.color=o?o.toString():"",this.badgeContent.style.backgroundColor=r?r.toString():"",this.badgeContent.style.borderStyle=s&&!this.options.compact?"solid":"",this.badgeContent.style.borderWidth=s?"1px":"",this.badgeContent.style.borderColor=s?s.toString():""}}render(e){super.render(e),this.container=e,this.options.icon&&this.container.classList.add("icon"),this.options.hasPopup?(this.container.setAttribute("role","button"),this.container.setAttribute("aria-haspopup","true")):this.container.setAttribute("role","tab"),this._register(y(this.container,A.MOUSE_DOWN,()=>{this.container.classList.add("clicked")})),this._register(y(this.container,A.MOUSE_UP,()=>{this.mouseUpTimeout&&clearTimeout(this.mouseUpTimeout),this.mouseUpTimeout=setTimeout(()=>{this.container.classList.remove("clicked")},800)})),this.label=H(e,x("a")),this.badge=H(e,x(".badge")),this.badgeContent=H(this.badge,x(".badge-content")),H(e,x(".active-item-indicator")),R(this.badge),this.update(),this.updateStyles(),this.updateHover()}onThemeChange(e){this.updateStyles()}update(){this.updateLabel(),this.updateActivity(),this.updateTitle(),this.updateStyles()}getActivity(){if(this._action instanceof O)return this._action.activity}updateActivity(){if(!this.badge||!this.badgeContent||!(this._action instanceof O))return;const e=this.getActivity();this.badgeDisposable.value=new z,J(this.badgeContent),R(this.badge);const t=this.badgesEnabled(this.compositeBarActionItem.id);if(e&&t){const{badge:i}=e,o=[];if(this.options.compact&&o.push("compact"),i instanceof te)k(this.badge),o.push("progress-badge");else if(i instanceof X){if(i.number){let r=i.number.toString();if(i.number>999){const s=i.number/1e3,a=Math.floor(s);s>a?r=`${a}K+`:r=`${s}K`}this.options.compact&&r.length>=3&&o.push("compact-content"),this.badgeContent.textContent=r,k(this.badge)}}else if(i instanceof ie){o.push("icon-badge");const r=["icon-overlay",...j.asClassNameArray(i.icon)];this.badgeContent.classList.add(...r),this.badgeDisposable.value.add(L(()=>this.badgeContent?.classList.remove(...r))),k(this.badge)}o.length&&(this.badge.classList.add(...o),this.badgeDisposable.value.add(L(()=>this.badge.classList.remove(...o))))}this.updateTitle(),this.updateStyles()}updateLabel(){this.label.className="action-label",this.compositeBarActionItem.classNames&&this.label.classList.add(...this.compositeBarActionItem.classNames),this.options.icon||(this.label.textContent=this.action.label)}updateTitle(){const e=this.computeTitle();[this.label,this.badge,this.container].forEach(t=>{t&&(t.setAttribute("aria-label",e),t.setAttribute("title",""),t.removeAttribute("title"))})}computeTitle(){this.keybindingLabel=this.computeKeybindingLabel();let e=this.keybindingLabel?c("titleKeybinding","{0} ({1})",this.compositeBarActionItem.name,this.keybindingLabel):this.compositeBarActionItem.name;const t=this.action.activity?.badge;return t?.getDescription()&&(e=c("badgeTitle","{0} - {1}",e,t.getDescription())),e}computeKeybindingLabel(){return(this.compositeBarActionItem.keybindingId?this.keybindingService.lookupKeybinding(this.compositeBarActionItem.keybindingId):null)?.getLabel()}updateHover(){this.hoverDisposables.clear(),this.updateTitle(),this.hoverDisposables.add(y(this.container,A.MOUSE_OVER,()=>{this.showHoverScheduler.isScheduled()||(Date.now()-p.hoverLeaveTime<200?this.showHover(!0):this.showHoverScheduler.schedule(this.configurationService.getValue("workbench.hover.delay")))},!0)),this.hoverDisposables.add(y(this.container,A.MOUSE_LEAVE,e=>{e.target===this.container&&(p.hoverLeaveTime=Date.now(),this.hoverService.hideHover(),this.showHoverScheduler.cancel())},!0)),this.hoverDisposables.add(L(()=>{this.hoverService.hideHover(),this.showHoverScheduler.cancel()}))}showHover(e=!1){if(this.lastHover&&!this.lastHover.isDisposed)return;const t=this.options.hoverOptions.position();this.lastHover=this.hoverService.showHover({target:this.container,content:this.computeTitle(),position:{hoverPosition:t},persistence:{hideOnKeyDown:!0},appearance:{showPointer:!0,compact:!0,skipFadeInAnimation:e}})}dispose(){super.dispose(),this.mouseUpTimeout&&clearTimeout(this.mouseUpTimeout),this.badge.remove()}};p=C([n(3,M),n(4,_),n(5,w),n(6,P)],p);class Ve extends O{constructor(e){super({id:"additionalComposites.action",name:c("additionalViews","Additional Views"),classNames:j.asClassNameArray(ce.more)});this.showMenu=e}async run(){this.showMenu()}}let E=class extends p{constructor(e,t,i,o,r,s,a,h,f,v,u,b){super(e,{icon:!0,colors:s,hasPopup:!0,hoverOptions:a},()=>!0,f,v,u,b);this.getOverflowingComposites=t;this.getActiveCompositeId=i;this.getBadge=o;this.getCompositeOpenAction=r;this.contextMenuService=h}showMenu(){this.contextMenuService.showContextMenu({getAnchor:()=>this.container,getActions:()=>this.getActions(),getCheckedActionsRepresentation:()=>"radio"})}getActions(){return this.getOverflowingComposites().map(e=>{const t=this.getCompositeOpenAction(e.id);t.checked=this.getActiveCompositeId()===t.id;const i=this.getBadge(e.id);let o;return i instanceof X&&(o=i.number),o?t.label=c("numberBadge","{0} ({1})",e.name,o):t.label=e.name||"",t})}};E=C([n(7,W),n(8,M),n(9,_),n(10,w),n(11,P)],E);let I=class extends T{constructor(e){super("activitybar.manage.extension",c("manageExtension","Manage Extension"));this.commandService=e}run(e){return this.commandService.executeCommand("_extensions.manage",e)}};I=C([n(0,Z)],I);let m=class extends p{constructor(e,t,i,o,r,s,a,h,f,v,u,b,B,D){super(t,e,h.areBadgesEnabled.bind(h),b,B,D,v);this.compositeActivityAction=t;this.toggleCompositePinnedAction=i;this.toggleCompositeBadgeAction=o;this.compositeContextMenuActionsProvider=r;this.contextMenuActionsProvider=s;this.dndHandler=a;this.compositeBar=h;this.contextMenuService=f;m.manageExtensionAction||(m.manageExtensionAction=u.createInstance(I))}static manageExtensionAction;render(e){super.render(e),this.updateChecked(),this.updateEnabled(),this._register(y(this.container,A.CONTEXT_MENU,i=>{F.stop(i,!0),this.showContextMenu(e)}));let t;this._register(ne.INSTANCE.registerDraggable(this.container,()=>({type:"composite",id:this.compositeBarActionItem.id}),{onDragOver:i=>{const o=i.dragAndDropData.getData().id!==this.compositeBarActionItem.id&&this.dndHandler.onDragOver(i.dragAndDropData,this.compositeBarActionItem.id,i.eventData);ae(i.eventData.dataTransfer,"move",o),t=this.updateFromDragging(e,o,i.eventData)},onDragLeave:i=>{t=this.updateFromDragging(e,!1,i.eventData)},onDragEnd:i=>{t=this.updateFromDragging(e,!1,i.eventData)},onDrop:i=>{F.stop(i.eventData,!0),this.dndHandler.drop(i.dragAndDropData,this.compositeBarActionItem.id,i.eventData,t),t=this.updateFromDragging(e,!1,i.eventData)},onDragStart:i=>{i.dragAndDropData.getData().id===this.compositeBarActionItem.id&&(i.eventData.dataTransfer&&(i.eventData.dataTransfer.effectAllowed="move"),this.blur())}})),[this.badge,this.label].forEach(i=>this._register(new re(i,()=>{this.action.checked||this.action.run()}))),this.updateStyles()}updateFromDragging(e,t,i){const o=e.getBoundingClientRect(),r=i.clientX,s=i.clientY,a=o.bottom-o.top,h=o.right-o.left,f=s<=o.top+a*.4,v=s>o.bottom-a*.4,u=s<=o.top+a*.5,b=r<=o.left+h*.4,B=r>o.right-h*.4,D=r<=o.left+h*.5,S=e.classList,g={vertical:S.contains("top")?"top":S.contains("bottom")?"bottom":void 0,horizontal:S.contains("left")?"left":S.contains("right")?"right":void 0},U=f||u&&!g.vertical||!v&&g.vertical==="top",Y=v||!u&&!g.vertical||!f&&g.vertical==="bottom",N=b||D&&!g.horizontal||!B&&g.horizontal==="left",V=B||!D&&!g.horizontal||!b&&g.horizontal==="right";if(e.classList.toggle("top",t&&U),e.classList.toggle("bottom",t&&Y),e.classList.toggle("left",t&&N),e.classList.toggle("right",t&&V),!!t)return{verticallyBefore:U,horizontallyBefore:N}}showContextMenu(e){const t=[this.toggleCompositePinnedAction,this.toggleCompositeBadgeAction],i=this.compositeContextMenuActionsProvider(this.compositeBarActionItem.id);i.length&&t.push(...i),this.compositeActivityAction.compositeBarActionItem.extensionId&&(t.push(new K),t.push(m.manageExtensionAction)),this.compositeBar.isPinned(this.compositeBarActionItem.id)?(this.toggleCompositePinnedAction.label=c("hide","Hide '{0}'",this.compositeBarActionItem.name),this.toggleCompositePinnedAction.checked=!1):this.toggleCompositePinnedAction.label=c("keep","Keep '{0}'",this.compositeBarActionItem.name),this.compositeBar.areBadgesEnabled(this.compositeBarActionItem.id)?this.toggleCompositeBadgeAction.label=c("hideBadge","Hide Badge"):this.toggleCompositeBadgeAction.label=c("showBadge","Show Badge");const s=this.contextMenuActionsProvider();s.length&&(t.push(new K),t.push(...s));const a=Q(e),h={x:Math.floor(a.left+a.width/2),y:a.top+a.height};this.contextMenuService.showContextMenu({getAnchor:()=>h,getActions:()=>t,getActionsContext:()=>this.compositeBarActionItem.id})}updateChecked(){this.action.checked?(this.container.classList.add("checked"),this.container.setAttribute("aria-label",this.getTooltip()??this.container.title),this.container.setAttribute("aria-expanded","true"),this.container.setAttribute("aria-selected","true")):(this.container.classList.remove("checked"),this.container.setAttribute("aria-label",this.getTooltip()??this.container.title),this.container.setAttribute("aria-expanded","false"),this.container.setAttribute("aria-selected","false")),this.updateStyles()}updateEnabled(){this.element&&(this.action.enabled?this.element.classList.remove("disabled"):this.element.classList.add("disabled"))}dispose(){super.dispose(),this.label.remove()}};m=C([n(8,W),n(9,P),n(10,oe),n(11,M),n(12,_),n(13,w)],m);class qe extends T{constructor(e,t){super("show.toggleCompositePinned",e?e.name:c("toggle","Toggle View Pinned"));this.activity=e;this.compositeBar=t;this.checked=!!this.activity&&this.compositeBar.isPinned(this.activity.id)}async run(e){const t=this.activity?this.activity.id:e;this.compositeBar.isPinned(t)?this.compositeBar.unpin(t):this.compositeBar.pin(t)}}class Ge extends T{constructor(e,t){super("show.toggleCompositeBadge",e?e.name:c("toggleBadge","Toggle View Badge"));this.compositeBarActionItem=e;this.compositeBar=t;this.checked=!1}async run(e){const t=this.compositeBarActionItem?this.compositeBarActionItem.id:e;this.compositeBar.toggleBadgeEnablement(t)}}export{m as CompositeActionViewItem,O as CompositeBarAction,p as CompositeBarActionViewItem,Ve as CompositeOverflowActivityAction,E as CompositeOverflowActivityActionViewItem,Ge as ToggleCompositeBadgeAction,qe as ToggleCompositePinnedAction};
