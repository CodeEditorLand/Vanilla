var q=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var C=(l,d,e,t)=>{for(var i=t>1?void 0:t?G(d,e):d,o=l.length-1,s;o>=0;o--)(s=l[o])&&(i=(t?s(d,e,i):s(i))||i);return t&&i&&q(d,e,i),i},n=(l,d)=>(e,t)=>d(e,t,l);import{DelayedDragHandler as J}from"../../../base/browser/dnd.js";import{$ as T,EventHelper as K,EventType as y,addDisposableListener as A,append as x,clearNode as Q,getDomNodePagePosition as Z,hide as F,show as k}from"../../../base/browser/dom.js";import{BaseActionViewItem as ee}from"../../../base/browser/ui/actionbar/actionViewItems.js";import{Action as H,Separator as R}from"../../../base/common/actions.js";import{RunOnceScheduler as te}from"../../../base/common/async.js";import{Codicon as ie}from"../../../base/common/codicons.js";import{Emitter as z,Event as oe}from"../../../base/common/event.js";import{DisposableStore as j,MutableDisposable as se,toDisposable as L}from"../../../base/common/lifecycle.js";import{ThemeIcon as W}from"../../../base/common/themables.js";import{localize as c}from"../../../nls.js";import{ICommandService as re}from"../../../platform/commands/common/commands.js";import{IConfigurationService as M}from"../../../platform/configuration/common/configuration.js";import{IContextMenuService as X}from"../../../platform/contextview/browser/contextView.js";import{IHoverService as P}from"../../../platform/hover/browser/hover.js";import{IInstantiationService as ne}from"../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as w}from"../../../platform/keybinding/common/keybinding.js";import{badgeBackground as ae,badgeForeground as de,contrastBorder as ce}from"../../../platform/theme/common/colorRegistry.js";import{IThemeService as _}from"../../../platform/theme/common/themeService.js";import{IconBadge as le,NumberBadge as $,ProgressBadge as he}from"../../services/activity/common/activity.js";import{CompositeDragAndDropObserver as pe,toggleDropEffect as ge}from"../dnd.js";class O extends H{constructor(e){super(e.id,e.name,e.classNames?.join(" "),!0);this.item=e}_onDidChangeCompositeBarActionItem=this._register(new z);onDidChangeCompositeBarActionItem=this._onDidChangeCompositeBarActionItem.event;_onDidChangeActivity=this._register(new z);onDidChangeActivity=this._onDidChangeActivity.event;_activity;get compositeBarActionItem(){return this.item}set compositeBarActionItem(e){this._label=e.name,this.item=e,this._onDidChangeCompositeBarActionItem.fire(this)}get activity(){return this._activity}set activity(e){this._activity=e,this._onDidChangeActivity.fire(e)}activate(){this.checked||this._setChecked(!0)}deactivate(){this.checked&&this._setChecked(!1)}}let p=class extends ee{constructor(e,t,i,o,s,r,a){super(null,e,t);this.badgesEnabled=i;this.themeService=o;this.hoverService=s;this.configurationService=r;this.keybindingService=a;this.options=t,this._register(this.themeService.onDidColorThemeChange(this.onThemeChange,this)),this._register(e.onDidChangeCompositeBarActionItem(()=>this.update())),this._register(oe.filter(a.onDidUpdateKeybindings,()=>this.keybindingLabel!==this.computeKeybindingLabel())(()=>this.updateTitle())),this._register(e.onDidChangeActivity(()=>this.updateActivity())),this._register(L(()=>this.showHoverScheduler.cancel()))}static hoverLeaveTime=0;container;label;badge;options;badgeContent;badgeDisposable=this._register(new se);mouseUpTimeout;keybindingLabel;hoverDisposables=this._register(new j);lastHover;showHoverScheduler=new te(()=>this.showHover(),0);get compositeBarActionItem(){return this._action.compositeBarActionItem}updateStyles(){const e=this.themeService.getColorTheme(),t=this.options.colors(e);if(this.label){if(this.options.icon){const i=this._action.checked?t.activeForegroundColor:t.inactiveForegroundColor;this.compositeBarActionItem.iconUrl?(this.label.style.backgroundColor=i?i.toString():"",this.label.style.color=""):(this.label.style.color=i?i.toString():"",this.label.style.backgroundColor="")}else{const i=this._action.checked?t.activeForegroundColor:t.inactiveForegroundColor,o=this._action.checked?t.activeBorderBottomColor:null;this.label.style.color=i?i.toString():"",this.label.style.borderBottomColor=o?o.toString():""}this.container.style.setProperty("--insert-border-color",t.dragAndDropBorder?t.dragAndDropBorder.toString():"")}if(this.badgeContent){const i=this.getActivity()?.badge.getColors(e),o=i?.badgeForeground??t.badgeForeground??e.getColor(de),s=i?.badgeBackground??t.badgeBackground??e.getColor(ae),r=i?.badgeBorder??e.getColor(ce);this.badgeContent.style.color=o?o.toString():"",this.badgeContent.style.backgroundColor=s?s.toString():"",this.badgeContent.style.borderStyle=r&&!this.options.compact?"solid":"",this.badgeContent.style.borderWidth=r?"1px":"",this.badgeContent.style.borderColor=r?r.toString():""}}render(e){super.render(e),this.container=e,this.options.icon&&this.container.classList.add("icon"),this.options.hasPopup?(this.container.setAttribute("role","button"),this.container.setAttribute("aria-haspopup","true")):this.container.setAttribute("role","tab"),this._register(A(this.container,y.MOUSE_DOWN,()=>{this.container.classList.add("clicked")})),this._register(A(this.container,y.MOUSE_UP,()=>{this.mouseUpTimeout&&clearTimeout(this.mouseUpTimeout),this.mouseUpTimeout=setTimeout(()=>{this.container.classList.remove("clicked")},800)})),this.label=x(e,T("a")),this.badge=x(e,T(".badge")),this.badgeContent=x(this.badge,T(".badge-content")),x(e,T(".active-item-indicator")),F(this.badge),this.update(),this.updateStyles(),this.updateHover()}onThemeChange(e){this.updateStyles()}update(){this.updateLabel(),this.updateActivity(),this.updateTitle(),this.updateStyles()}getActivity(){if(this._action instanceof O)return this._action.activity}updateActivity(){if(!this.badge||!this.badgeContent||!(this._action instanceof O))return;const e=this.getActivity();this.badgeDisposable.value=new j,Q(this.badgeContent),F(this.badge);const t=this.badgesEnabled(this.compositeBarActionItem.id);if(e&&t){const{badge:i}=e,o=[];if(this.options.compact&&o.push("compact"),i instanceof he)k(this.badge),o.push("progress-badge");else if(i instanceof $){if(i.number){let s=i.number.toString();if(i.number>999){const r=i.number/1e3,a=Math.floor(r);r>a?s=`${a}K+`:s=`${r}K`}this.options.compact&&s.length>=3&&o.push("compact-content"),this.badgeContent.textContent=s,k(this.badge)}}else if(i instanceof le){o.push("icon-badge");const s=["icon-overlay",...W.asClassNameArray(i.icon)];this.badgeContent.classList.add(...s),this.badgeDisposable.value.add(L(()=>this.badgeContent?.classList.remove(...s))),k(this.badge)}o.length&&(this.badge.classList.add(...o),this.badgeDisposable.value.add(L(()=>this.badge.classList.remove(...o))))}this.updateTitle(),this.updateStyles()}updateLabel(){this.label.className="action-label",this.compositeBarActionItem.classNames&&this.label.classList.add(...this.compositeBarActionItem.classNames),this.options.icon||(this.label.textContent=this.action.label)}updateTitle(){const e=this.computeTitle();[this.label,this.badge,this.container].forEach(t=>{t&&(t.setAttribute("aria-label",e),t.setAttribute("title",""),t.removeAttribute("title"))})}computeTitle(){this.keybindingLabel=this.computeKeybindingLabel();let e=this.keybindingLabel?c("titleKeybinding","{0} ({1})",this.compositeBarActionItem.name,this.keybindingLabel):this.compositeBarActionItem.name;const t=this.action.activity?.badge;return t?.getDescription()&&(e=c("badgeTitle","{0} - {1}",e,t.getDescription())),e}computeKeybindingLabel(){return(this.compositeBarActionItem.keybindingId?this.keybindingService.lookupKeybinding(this.compositeBarActionItem.keybindingId):null)?.getLabel()}updateHover(){this.hoverDisposables.clear(),this.updateTitle(),this.hoverDisposables.add(A(this.container,y.MOUSE_OVER,()=>{this.showHoverScheduler.isScheduled()||(Date.now()-p.hoverLeaveTime<200?this.showHover(!0):this.showHoverScheduler.schedule(this.configurationService.getValue("workbench.hover.delay")))},!0)),this.hoverDisposables.add(A(this.container,y.MOUSE_LEAVE,e=>{e.target===this.container&&(p.hoverLeaveTime=Date.now(),this.hoverService.hideHover(),this.showHoverScheduler.cancel())},!0)),this.hoverDisposables.add(L(()=>{this.hoverService.hideHover(),this.showHoverScheduler.cancel()}))}showHover(e=!1){if(this.lastHover&&!this.lastHover.isDisposed)return;const t=this.options.hoverOptions.position();this.lastHover=this.hoverService.showHover({target:this.container,content:this.computeTitle(),position:{hoverPosition:t},persistence:{hideOnKeyDown:!0},appearance:{showPointer:!0,compact:!0,skipFadeInAnimation:e}})}dispose(){super.dispose(),this.mouseUpTimeout&&clearTimeout(this.mouseUpTimeout),this.badge.remove()}};p=C([n(3,_),n(4,P),n(5,M),n(6,w)],p);class _e extends O{constructor(e){super({id:"additionalComposites.action",name:c("additionalViews","Additional Views"),classNames:W.asClassNameArray(ie.more)});this.showMenu=e}async run(){this.showMenu()}}let E=class extends p{constructor(e,t,i,o,s,r,a,h,f,v,u,b){super(e,{icon:!0,colors:r,hasPopup:!0,hoverOptions:a},()=>!0,f,v,u,b);this.getOverflowingComposites=t;this.getActiveCompositeId=i;this.getBadge=o;this.getCompositeOpenAction=s;this.contextMenuService=h}showMenu(){this.contextMenuService.showContextMenu({getAnchor:()=>this.container,getActions:()=>this.getActions(),getCheckedActionsRepresentation:()=>"radio"})}getActions(){return this.getOverflowingComposites().map(e=>{const t=this.getCompositeOpenAction(e.id);t.checked=this.getActiveCompositeId()===t.id;const i=this.getBadge(e.id);let o;return i instanceof $&&(o=i.number),o?t.label=c("numberBadge","{0} ({1})",e.name,o):t.label=e.name||"",t})}};E=C([n(7,X),n(8,_),n(9,P),n(10,M),n(11,w)],E);let I=class extends H{constructor(e){super("activitybar.manage.extension",c("manageExtension","Manage Extension"));this.commandService=e}run(e){return this.commandService.executeCommand("_extensions.manage",e)}};I=C([n(0,re)],I);let m=class extends p{constructor(e,t,i,o,s,r,a,h,f,v,u,b,B,D){super(t,e,h.areBadgesEnabled.bind(h),b,B,D,v);this.compositeActivityAction=t;this.toggleCompositePinnedAction=i;this.toggleCompositeBadgeAction=o;this.compositeContextMenuActionsProvider=s;this.contextMenuActionsProvider=r;this.dndHandler=a;this.compositeBar=h;this.contextMenuService=f;m.manageExtensionAction||(m.manageExtensionAction=u.createInstance(I))}static manageExtensionAction;render(e){super.render(e),this.updateChecked(),this.updateEnabled(),this._register(A(this.container,y.CONTEXT_MENU,i=>{K.stop(i,!0),this.showContextMenu(e)}));let t;this._register(pe.INSTANCE.registerDraggable(this.container,()=>({type:"composite",id:this.compositeBarActionItem.id}),{onDragOver:i=>{const o=i.dragAndDropData.getData().id!==this.compositeBarActionItem.id&&this.dndHandler.onDragOver(i.dragAndDropData,this.compositeBarActionItem.id,i.eventData);ge(i.eventData.dataTransfer,"move",o),t=this.updateFromDragging(e,o,i.eventData)},onDragLeave:i=>{t=this.updateFromDragging(e,!1,i.eventData)},onDragEnd:i=>{t=this.updateFromDragging(e,!1,i.eventData)},onDrop:i=>{K.stop(i.eventData,!0),this.dndHandler.drop(i.dragAndDropData,this.compositeBarActionItem.id,i.eventData,t),t=this.updateFromDragging(e,!1,i.eventData)},onDragStart:i=>{i.dragAndDropData.getData().id===this.compositeBarActionItem.id&&(i.eventData.dataTransfer&&(i.eventData.dataTransfer.effectAllowed="move"),this.blur())}})),[this.badge,this.label].forEach(i=>this._register(new J(i,()=>{this.action.checked||this.action.run()}))),this.updateStyles()}updateFromDragging(e,t,i){const o=e.getBoundingClientRect(),s=i.clientX,r=i.clientY,a=o.bottom-o.top,h=o.right-o.left,f=r<=o.top+a*.4,v=r>o.bottom-a*.4,u=r<=o.top+a*.5,b=s<=o.left+h*.4,B=s>o.right-h*.4,D=s<=o.left+h*.5,S=e.classList,g={vertical:S.contains("top")?"top":S.contains("bottom")?"bottom":void 0,horizontal:S.contains("left")?"left":S.contains("right")?"right":void 0},U=f||u&&!g.vertical||!v&&g.vertical==="top",Y=v||!u&&!g.vertical||!f&&g.vertical==="bottom",N=b||D&&!g.horizontal||!B&&g.horizontal==="left",V=B||!D&&!g.horizontal||!b&&g.horizontal==="right";if(e.classList.toggle("top",t&&U),e.classList.toggle("bottom",t&&Y),e.classList.toggle("left",t&&N),e.classList.toggle("right",t&&V),!!t)return{verticallyBefore:U,horizontallyBefore:N}}showContextMenu(e){const t=[this.toggleCompositePinnedAction,this.toggleCompositeBadgeAction],i=this.compositeContextMenuActionsProvider(this.compositeBarActionItem.id);i.length&&t.push(...i),this.compositeActivityAction.compositeBarActionItem.extensionId&&(t.push(new R),t.push(m.manageExtensionAction)),this.compositeBar.isPinned(this.compositeBarActionItem.id)?(this.toggleCompositePinnedAction.label=c("hide","Hide '{0}'",this.compositeBarActionItem.name),this.toggleCompositePinnedAction.checked=!1):this.toggleCompositePinnedAction.label=c("keep","Keep '{0}'",this.compositeBarActionItem.name),this.compositeBar.areBadgesEnabled(this.compositeBarActionItem.id)?this.toggleCompositeBadgeAction.label=c("hideBadge","Hide Badge"):this.toggleCompositeBadgeAction.label=c("showBadge","Show Badge");const r=this.contextMenuActionsProvider();r.length&&(t.push(new R),t.push(...r));const a=Z(e),h={x:Math.floor(a.left+a.width/2),y:a.top+a.height};this.contextMenuService.showContextMenu({getAnchor:()=>h,getActions:()=>t,getActionsContext:()=>this.compositeBarActionItem.id})}updateChecked(){this.action.checked?(this.container.classList.add("checked"),this.container.setAttribute("aria-label",this.getTooltip()??this.container.title),this.container.setAttribute("aria-expanded","true"),this.container.setAttribute("aria-selected","true")):(this.container.classList.remove("checked"),this.container.setAttribute("aria-label",this.getTooltip()??this.container.title),this.container.setAttribute("aria-expanded","false"),this.container.setAttribute("aria-selected","false")),this.updateStyles()}updateEnabled(){this.element&&(this.action.enabled?this.element.classList.remove("disabled"):this.element.classList.add("disabled"))}dispose(){super.dispose(),this.label.remove()}};m=C([n(8,X),n(9,w),n(10,ne),n(11,_),n(12,P),n(13,M)],m);class Oe extends H{constructor(e,t){super("show.toggleCompositePinned",e?e.name:c("toggle","Toggle View Pinned"));this.activity=e;this.compositeBar=t;this.checked=!!this.activity&&this.compositeBar.isPinned(this.activity.id)}async run(e){const t=this.activity?this.activity.id:e;this.compositeBar.isPinned(t)?this.compositeBar.unpin(t):this.compositeBar.pin(t)}}class Ue extends H{constructor(e,t){super("show.toggleCompositeBadge",e?e.name:c("toggleBadge","Toggle View Badge"));this.compositeBarActionItem=e;this.compositeBar=t;this.checked=!1}async run(e){const t=this.compositeBarActionItem?this.compositeBarActionItem.id:e;this.compositeBar.toggleBadgeEnablement(t)}}export{m as CompositeActionViewItem,O as CompositeBarAction,p as CompositeBarActionViewItem,_e as CompositeOverflowActivityAction,E as CompositeOverflowActivityActionViewItem,Ue as ToggleCompositeBadgeAction,Oe as ToggleCompositePinnedAction};
