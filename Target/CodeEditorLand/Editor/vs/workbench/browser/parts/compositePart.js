import"./media/compositepart.css";import{$ as p,Dimension as y,append as m,hide as S,show as A}from"../../../base/browser/dom.js";import{ActionsOrientation as b,prepareActions as C}from"../../../base/browser/ui/actionbar/actionbar.js";import{AnchorAlignment as T}from"../../../base/browser/ui/contextview/contextview.js";import{createInstantHoverDelegate as w,getDefaultHoverDelegate as B}from"../../../base/browser/ui/hover/hoverDelegateFactory.js";import{ProgressBar as L}from"../../../base/browser/ui/progressbar/progressbar.js";import{isCancellationError as D}from"../../../base/common/errors.js";import{Emitter as v}from"../../../base/common/event.js";import{defaultGenerator as P}from"../../../base/common/idGenerator.js";import{DisposableStore as H,MutableDisposable as M,dispose as u}from"../../../base/common/lifecycle.js";import{assertIsDefined as d}from"../../../base/common/types.js";import{localize as h}from"../../../nls.js";import{createActionViewItem as O}from"../../../platform/actions/browser/menuEntryActionViewItem.js";import{WorkbenchToolBar as E}from"../../../platform/actions/browser/toolbar.js";import{ServiceCollection as k}from"../../../platform/instantiation/common/serviceCollection.js";import{IEditorProgressService as x}from"../../../platform/progress/common/progress.js";import{StorageScope as g,StorageTarget as V}from"../../../platform/storage/common/storage.js";import{defaultProgressBarStyles as j}from"../../../platform/theme/browser/defaultStyles.js";import{AbstractProgressScope as R,ScopedProgressIndicator as K}from"../../services/progress/browser/progressIndicator.js";import{Part as _}from"../part.js";class he extends _{constructor(e,t,i,o,s,n,r,a,l,c,F,N,U,G,f,I){super(f,I,a,t,o);this.notificationService=e;this.storageService=t;this.contextMenuService=i;this.keybindingService=s;this.hoverService=n;this.instantiationService=r;this.registry=l;this.activeCompositeSettingsKey=c;this.defaultCompositeId=F;this.nameForTelemetry=N;this.compositeCSSClass=U;this.titleForegroundColor=G;this.lastActiveCompositeId=t.get(c,g.WORKSPACE,this.defaultCompositeId),this.toolbarHoverDelegate=this._register(w())}onDidCompositeOpen=this._register(new v);onDidCompositeClose=this._register(new v);toolBar;titleLabelElement;toolbarHoverDelegate;mapCompositeToCompositeContainer=new Map;mapActionsBindingToComposite=new Map;activeComposite;lastActiveCompositeId;instantiatedCompositeItems=new Map;titleLabel;progressBar;contentAreaSize;actionsListener=this._register(new M);currentCompositeOpenToken;boundarySashes;openComposite(e,t){if(this.activeComposite?.getId()===e)return t&&this.activeComposite.focus(),this.activeComposite;if(this.element)return this.doOpenComposite(e,t)}doOpenComposite(e,t=!1){const i=P.nextId();this.currentCompositeOpenToken=i,this.activeComposite&&this.hideActiveComposite(),this.updateTitle(e);const o=this.createComposite(e,!0);if(!(this.currentCompositeOpenToken!==i||this.activeComposite&&this.activeComposite.getId()!==o.getId()))return this.activeComposite?.getId()===o.getId()?(t&&o.focus(),this.onDidCompositeOpen.fire({composite:o,focus:t}),o):(this.showComposite(o),t&&o.focus(),o&&this.onDidCompositeOpen.fire({composite:o,focus:t}),o)}createComposite(e,t){const i=this.instantiatedCompositeItems.get(e);if(i)return i.composite;const o=this.registry.getComposite(e);if(o){const s=this,n=new K(d(this.progressBar),new class extends R{constructor(){super(o.id,!!t),this._register(s.onDidCompositeOpen.event(c=>this.onScopeOpened(c.composite.getId()))),this._register(s.onDidCompositeClose.event(c=>this.onScopeClosed(c.getId())))}}),r=this._register(this.instantiationService.createChild(new k([x,n]))),a=o.instantiate(r),l=new H;return this.instantiatedCompositeItems.set(e,{composite:a,disposable:l,progress:n}),l.add(a.onTitleAreaUpdate(()=>this.onTitleAreaUpdate(a.getId()),this)),l.add(r),a}throw new Error(`Unable to find composite with id ${e}`)}showComposite(e){this.activeComposite=e;const t=this.activeComposite.getId();t!==this.defaultCompositeId?this.storageService.store(this.activeCompositeSettingsKey,t,g.WORKSPACE,V.MACHINE):this.storageService.remove(this.activeCompositeSettingsKey,g.WORKSPACE),this.lastActiveCompositeId=this.activeComposite.getId();let i=this.mapCompositeToCompositeContainer.get(e.getId());if(i||(i=p(".composite"),i.classList.add(...this.compositeCSSClass.split(" ")),i.id=e.getId(),e.create(i),e.updateStyles(),this.mapCompositeToCompositeContainer.set(e.getId(),i)),!this.activeComposite||e.getId()!==this.activeComposite.getId())return;this.getContentArea()?.appendChild(i),A(i);const s=d(this.toolBar);s.actionRunner=e.getActionRunner();const n=this.registry.getComposite(e.getId());n&&n.name!==e.getTitle()&&this.updateTitle(e.getId(),e.getTitle());let r=this.mapActionsBindingToComposite.get(e.getId());r||(r=this.collectCompositeActions(e),this.mapActionsBindingToComposite.set(e.getId(),r)),r(),this.actionsListener.value=s.actionRunner.onDidRun(a=>{a.error&&!D(a.error)&&this.notificationService.error(a.error)}),e.setVisible(!0),!(!this.activeComposite||e.getId()!==this.activeComposite.getId())&&(this.contentAreaSize&&e.layout(this.contentAreaSize),this.boundarySashes&&e.setBoundarySashes(this.boundarySashes))}onTitleAreaUpdate(e){const t=this.instantiatedCompositeItems.get(e);if(t&&this.updateTitle(e,t.composite.getTitle()),this.activeComposite?.getId()===e){const i=this.collectCompositeActions(this.activeComposite);this.mapActionsBindingToComposite.set(this.activeComposite.getId(),i),i()}else this.mapActionsBindingToComposite.delete(e)}updateTitle(e,t){const i=this.registry.getComposite(e);if(!i||!this.titleLabel)return;t||(t=i.name);const o=this.keybindingService.lookupKeybinding(e);this.titleLabel.updateTitle(e,t,o?.getLabel()??void 0),d(this.toolBar).setAriaLabel(h("ariaCompositeToolbarLabel","{0} actions",t))}collectCompositeActions(e){const t=e?.getMenuIds(),i=e?.getActions().slice(0)||[],o=e?.getSecondaryActions().slice(0)||[],s=d(this.toolBar);return s.context=this.actionsContextProvider(),()=>s.setActions(C(i),C(o),t)}getActiveComposite(){return this.activeComposite}getLastActiveCompositeId(){return this.lastActiveCompositeId}hideActiveComposite(){if(!this.activeComposite)return;const e=this.activeComposite;this.activeComposite=void 0;const t=this.mapCompositeToCompositeContainer.get(e.getId());return e.setVisible(!1),t&&(t.remove(),S(t)),this.progressBar?.stop().hide(),this.toolBar&&this.collectCompositeActions()(),this.onDidCompositeClose.fire(e),e}createTitleArea(e){const t=m(e,p(".composite"));t.classList.add("title"),this.titleLabel=this.createTitleLabel(t);const i=m(t,p(".title-actions"));return this.toolBar=this._register(this.instantiationService.createInstance(E,i,{actionViewItemProvider:(o,s)=>this.actionViewItemProvider(o,s),orientation:b.HORIZONTAL,getKeyBinding:o=>this.keybindingService.lookupKeybinding(o.id),anchorAlignmentProvider:()=>this.getTitleAreaDropDownAnchorAlignment(),toggleMenuTitle:h("viewsAndMoreActions","Views and More Actions..."),telemetrySource:this.nameForTelemetry,hoverDelegate:this.toolbarHoverDelegate})),this.collectCompositeActions()(),t}createTitleLabel(e){const t=m(e,p(".title-label")),i=m(t,p("h2"));this.titleLabelElement=i;const o=this._register(this.hoverService.setupManagedHover(B("mouse"),i,""));return{updateTitle:(s,n,r)=>{(!this.activeComposite||this.activeComposite.getId()===s)&&(i.innerText=n,o.update(r?h("titleTooltip","{0} ({1})",n,r):n))},updateStyles:()=>{i.style.color=this.titleForegroundColor&&this.getColor(this.titleForegroundColor)||""}}}createHeaderArea(){return p(".composite")}createFooterArea(){return p(".composite")}updateStyles(){super.updateStyles(),d(this.titleLabel).updateStyles()}actionViewItemProvider(e,t){return this.activeComposite?this.activeComposite.getActionViewItem(e,t):O(this.instantiationService,e,t)}actionsContextProvider(){return this.activeComposite?this.activeComposite.getActionsContext():null}createContentArea(e){const t=m(e,p(".content"));return this.progressBar=this._register(new L(t,j)),this.progressBar.hide(),t}getProgressIndicator(e){const t=this.instantiatedCompositeItems.get(e);return t?t.progress:void 0}getTitleAreaDropDownAnchorAlignment(){return T.RIGHT}layout(e,t,i,o){super.layout(e,t,i,o),this.contentAreaSize=y.lift(super.layoutContents(e,t).contentSize),this.activeComposite?.layout(this.contentAreaSize)}setBoundarySashes(e){this.boundarySashes=e,this.activeComposite?.setBoundarySashes(e)}removeComposite(e){if(this.activeComposite?.getId()===e)return!1;this.mapCompositeToCompositeContainer.delete(e),this.mapActionsBindingToComposite.delete(e);const t=this.instantiatedCompositeItems.get(e);return t&&(t.composite.dispose(),u(t.disposable),this.instantiatedCompositeItems.delete(e)),!0}dispose(){this.mapCompositeToCompositeContainer.clear(),this.mapActionsBindingToComposite.clear(),this.instantiatedCompositeItems.forEach(e=>{e.composite.dispose(),u(e.disposable)}),this.instantiatedCompositeItems.clear(),super.dispose()}}export{he as CompositePart};
