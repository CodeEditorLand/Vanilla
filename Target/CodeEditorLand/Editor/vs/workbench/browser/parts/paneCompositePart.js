var N=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var B=(c,a,e,t)=>{for(var i=t>1?void 0:t?W(a,e):a,o=c.length-1,r;o>=0;o--)(r=c[o])&&(i=(t?r(a,e,i):r(i))||i);return t&&i&&N(a,e,i),i},s=(c,a)=>(e,t)=>a(e,t,c);import"./media/paneCompositePart.css";import{Event as U}from"../../../base/common/event.js";import{IInstantiationService as G}from"../../../platform/instantiation/common/instantiation.js";import"../../../platform/progress/common/progress.js";import{Extensions as P}from"../panecomposite.js";import"../../common/panecomposite.js";import{IViewDescriptorService as X,ViewContainerLocation as f}from"../../common/views.js";import{DisposableStore as T,MutableDisposable as Y}from"../../../base/common/lifecycle.js";import"../../../base/browser/ui/grid/grid.js";import{IWorkbenchLayoutService as z,Parts as A}from"../../services/layout/browser/layoutService.js";import{CompositePart as Z}from"./compositePart.js";import{PaneCompositeBar as $}from"./paneCompositeBar.js";import{Dimension as j,EventHelper as d,trackFocus as q,$ as b,addDisposableListener as h,EventType as D,prepend as J,getWindow as C}from"../../../base/browser/dom.js";import{Registry as Q}from"../../../platform/registry/common/platform.js";import{INotificationService as ee}from"../../../platform/notification/common/notification.js";import{IStorageService as te}from"../../../platform/storage/common/storage.js";import{IContextMenuService as ie}from"../../../platform/contextview/browser/contextView.js";import{IKeybindingService as oe}from"../../../platform/keybinding/common/keybinding.js";import{IThemeService as re}from"../../../platform/theme/common/themeService.js";import{IContextKeyService as ne}from"../../../platform/contextkey/common/contextkey.js";import{IExtensionService as se}from"../../services/extensions/common/extensions.js";import"../../common/composite.js";import{localize as I}from"../../../nls.js";import{CompositeDragAndDropObserver as w,toggleDropEffect as ae}from"../dnd.js";import{EDITOR_DRAG_AND_DROP_BACKGROUND as pe}from"../../common/theme.js";import"../part.js";import{CompositeMenuActions as me}from"../actions.js";import{IMenuService as de,MenuId as y}from"../../../platform/actions/common/actions.js";import{ActionsOrientation as ce,prepareActions as E}from"../../../base/browser/ui/actionbar/actionbar.js";import{Gesture as S,EventType as M}from"../../../base/browser/touch.js";import{StandardMouseEvent as g}from"../../../base/browser/mouseEvent.js";import{SubmenuAction as le}from"../../../base/common/actions.js";import"../composite.js";import{ViewsSubMenu as he}from"./views/viewPaneContainer.js";import{createAndFillInActionBarActions as Ce}from"../../../platform/actions/browser/menuEntryActionViewItem.js";import{IHoverService as ge}from"../../../platform/hover/browser/hover.js";import{HiddenItemStrategy as ue,WorkbenchToolBar as ve}from"../../../platform/actions/browser/toolbar.js";var Pe=(t=>(t[t.TOP=0]="TOP",t[t.TITLE=1]="TITLE",t[t.BOTTOM=2]="BOTTOM",t))(Pe||{});let m=class extends Z{constructor(e,t,i,o,r,n,p,L,x,O,V,H,_,R,F,k,K,fe,Ae,Ie){let l=f.Sidebar,u=P.Viewlets,v=y.SidebarTitle;e===A.PANEL_PART?(l=f.Panel,u=P.Panels,v=y.PanelTitle):e===A.AUXILIARYBAR_PART&&(l=f.AuxiliaryBar,u=P.Auxiliary,v=y.AuxiliaryBarTitle);super(x,O,V,H,_,R,F,k,Q.as(u),i,K.getDefaultViewContainer(l)?.id||"",n,p,L,e,t);this.partId=e;this.activePaneContextKey=o;this.paneFocusContextKey=r;this.viewDescriptorService=K;this.contextKeyService=fe;this.extensionService=Ae;this.menuService=Ie;this.location=l,this.globalActions=this._register(this.instantiationService.createInstance(me,v,void 0,void 0)),this.registerListeners()}static MIN_COMPOSITE_BAR_WIDTH=50;get snap(){return this.layoutService.isVisible(this.partId)||!!this.paneCompositeBar.value?.getVisiblePaneCompositeIds().length}get onDidPaneCompositeOpen(){return U.map(this.onDidCompositeOpen.event,e=>e.composite)}onDidPaneCompositeClose=this.onDidCompositeClose.event;location;titleContainer;headerFooterCompositeBarContainer;headerFooterCompositeBarDispoables=this._register(new T);paneCompositeBarContainer;paneCompositeBar=this._register(new Y);compositeBarPosition=void 0;emptyPaneMessageElement;globalToolBar;globalActions;blockOpening=!1;contentDimension;registerListeners(){this._register(this.onDidPaneCompositeOpen(e=>this.onDidOpen(e))),this._register(this.onDidPaneCompositeClose(this.onDidClose,this)),this._register(this.globalActions.onDidChange(()=>this.updateGlobalToolbarActions())),this._register(this.registry.onDidDeregister(e=>{const t=this.viewDescriptorService.getViewContainersByLocation(this.location).filter(i=>this.viewDescriptorService.getViewContainerModel(i).activeViewDescriptors.length>0);if(t.length){if(this.getActiveComposite()?.getId()===e.id){const i=this.viewDescriptorService.getDefaultViewContainer(this.location)?.id,o=t.filter(r=>r.id===i)[0]||t[0];this.doOpenPaneComposite(o.id)}}else this.layoutService.setPartHidden(!0,this.partId);this.removeComposite(e.id)})),this._register(this.extensionService.onDidRegisterExtensions(()=>{this.layoutCompositeBar()}))}onDidOpen(e){this.activePaneContextKey.set(e.getId())}onDidClose(e){const t=e.getId();this.activePaneContextKey.get()===t&&this.activePaneContextKey.reset()}showComposite(e){super.showComposite(e),this.layoutCompositeBar(),this.layoutEmptyMessage()}hideActiveComposite(){const e=super.hideActiveComposite();return this.layoutCompositeBar(),this.layoutEmptyMessage(),e}create(e){this.element=e,this.element.classList.add("pane-composite-part"),super.create(e);const t=this.getContentArea();t&&this.createEmptyPaneMessage(t),this.updateCompositeBar();const i=this._register(q(e));this._register(i.onDidFocus(()=>this.paneFocusContextKey.set(!0))),this._register(i.onDidBlur(()=>this.paneFocusContextKey.set(!1)))}createEmptyPaneMessage(e){this.emptyPaneMessageElement=document.createElement("div"),this.emptyPaneMessageElement.classList.add("empty-pane-message-area");const t=document.createElement("div");t.classList.add("empty-pane-message"),t.innerText=I("pane.emptyMessage","Drag a view here to display."),this.emptyPaneMessageElement.appendChild(t),e.appendChild(this.emptyPaneMessageElement),this._register(w.INSTANCE.registerTarget(this.element,{onDragOver:i=>{if(d.stop(i.eventData,!0),this.paneCompositeBar.value){const o=this.paneCompositeBar.value.dndHandler.onDragEnter(i.dragAndDropData,void 0,i.eventData);ae(i.eventData.dataTransfer,"move",o)}},onDragEnter:i=>{if(d.stop(i.eventData,!0),this.paneCompositeBar.value){const o=this.paneCompositeBar.value.dndHandler.onDragEnter(i.dragAndDropData,void 0,i.eventData);this.emptyPaneMessageElement.style.backgroundColor=o&&this.theme.getColor(pe)?.toString()||""}},onDragLeave:i=>{d.stop(i.eventData,!0),this.emptyPaneMessageElement.style.backgroundColor=""},onDragEnd:i=>{d.stop(i.eventData,!0),this.emptyPaneMessageElement.style.backgroundColor=""},onDrop:i=>{if(d.stop(i.eventData,!0),this.emptyPaneMessageElement.style.backgroundColor="",this.paneCompositeBar.value)this.paneCompositeBar.value.dndHandler.drop(i.dragAndDropData,void 0,i.eventData);else{const o=i.dragAndDropData.getData();if(o.type==="composite"){const r=this.viewDescriptorService.getViewContainerById(o.id);this.viewDescriptorService.moveViewContainerToLocation(r,this.location,void 0,"dnd"),this.openPaneComposite(r.id,!0)}else if(o.type==="view"){const r=this.viewDescriptorService.getViewDescriptorById(o.id);if(r&&r.canMoveView){this.viewDescriptorService.moveViewToLocation(r,this.location,"dnd");const n=this.viewDescriptorService.getViewContainerByViewId(r.id);this.openPaneComposite(n.id,!0).then(p=>{p?.openView(r.id,!0)})}}}}}))}createTitleArea(e){const t=super.createTitleArea(e);this._register(h(t,D.CONTEXT_MENU,o=>{this.onTitleAreaContextMenu(new g(C(t),o))})),this._register(S.addTarget(t)),this._register(h(t,M.Contextmenu,o=>{this.onTitleAreaContextMenu(new g(C(t),o))}));const i=t.appendChild(b(".global-actions"));return this.globalToolBar=this._register(this.instantiationService.createInstance(ve,i,{actionViewItemProvider:(o,r)=>this.actionViewItemProvider(o,r),orientation:ce.HORIZONTAL,getKeyBinding:o=>this.keybindingService.lookupKeybinding(o.id),anchorAlignmentProvider:()=>this.getTitleAreaDropDownAnchorAlignment(),toggleMenuTitle:I("moreActions","More Actions..."),hoverDelegate:this.toolbarHoverDelegate,hiddenItemStrategy:ue.NoHide})),this.updateGlobalToolbarActions(),t}createTitleLabel(e){this.titleContainer=e;const t=super.createTitleLabel(e);this.titleLabelElement.draggable=!0;const i=()=>({type:"composite",id:this.getActivePaneComposite().getId()});return this._register(w.INSTANCE.registerDraggable(this.titleLabelElement,i,{})),t}updateCompositeBar(e=!1){const t=this.compositeBarPosition!==void 0,i=this.shouldShowCompositeBar(),o=this.compositeBarPosition,r=i?this.getCompositeBarPosition():void 0;if(!e&&o===r)return;if(t){const p=o===1?this.titleContainer:this.headerFooterCompositeBarContainer;if(!this.paneCompositeBarContainer||!this.paneCompositeBar.value||!p)throw new Error("Composite bar containers should exist when removing the previous composite bar");this.paneCompositeBarContainer.remove(),this.paneCompositeBarContainer=void 0,this.paneCompositeBar.value=void 0,p.classList.remove("has-composite-bar"),o===0?this.removeFooterHeaderArea(!0):o===2&&this.removeFooterHeaderArea(!1)}let n;switch(r){case 0:n=this.createHeaderArea();break;case 1:n=this.titleContainer;break;case 2:n=this.createFooterArea();break}if(i){if(this.paneCompositeBarContainer||this.paneCompositeBar.value||!n)throw new Error("Invalid composite bar state when creating the new composite bar");n.classList.add("has-composite-bar"),this.paneCompositeBarContainer=J(n,b(".composite-bar-container")),this.paneCompositeBar.value=this.createCompositeBar(),this.paneCompositeBar.value.create(this.paneCompositeBarContainer),r===0?this.setHeaderArea(n):r===2&&this.setFooterArea(n)}this.compositeBarPosition=r,e&&this.layoutCompositeBar()}createHeaderArea(){const e=super.createHeaderArea();return this.createHeaderFooterCompositeBarArea(e)}createFooterArea(){const e=super.createFooterArea();return this.createHeaderFooterCompositeBarArea(e)}createHeaderFooterCompositeBarArea(e){if(this.headerFooterCompositeBarContainer)throw new Error("Header or Footer composite bar already exists");return this.headerFooterCompositeBarContainer=e,this.headerFooterCompositeBarDispoables.add(h(e,D.CONTEXT_MENU,t=>{this.onCompositeBarAreaContextMenu(new g(C(e),t))})),this.headerFooterCompositeBarDispoables.add(S.addTarget(e)),this.headerFooterCompositeBarDispoables.add(h(e,M.Contextmenu,t=>{this.onCompositeBarAreaContextMenu(new g(C(e),t))})),e}removeFooterHeaderArea(e){this.headerFooterCompositeBarContainer=void 0,this.headerFooterCompositeBarDispoables.clear(),e?this.removeHeaderArea():this.removeFooterArea()}createCompositeBar(){return this.instantiationService.createInstance($,this.getCompositeBarOptions(),this.partId,this)}onTitleAreaUpdate(e){super.onTitleAreaUpdate(e),this.layoutCompositeBar()}async openPaneComposite(e,t){if(typeof e=="string"&&this.getPaneComposite(e))return this.doOpenPaneComposite(e,t);if(await this.extensionService.whenInstalledExtensionsRegistered(),typeof e=="string"&&this.getPaneComposite(e))return this.doOpenPaneComposite(e,t)}doOpenPaneComposite(e,t){if(!this.blockOpening){if(!this.layoutService.isVisible(this.partId))try{this.blockOpening=!0,this.layoutService.setPartHidden(!1,this.partId)}finally{this.blockOpening=!1}return this.openComposite(e,t)}}getPaneComposite(e){return this.registry.getPaneComposite(e)}getPaneComposites(){return this.registry.getPaneComposites().sort((e,t)=>typeof e.order!="number"?1:typeof t.order!="number"?-1:e.order-t.order)}getPinnedPaneCompositeIds(){return this.paneCompositeBar.value?.getPinnedPaneCompositeIds()??[]}getVisiblePaneCompositeIds(){return this.paneCompositeBar.value?.getVisiblePaneCompositeIds()??[]}getActivePaneComposite(){return this.getActiveComposite()}getLastActivePaneCompositeId(){return this.getLastActiveCompositeId()}hideActivePaneComposite(){this.layoutService.isVisible(this.partId)&&this.layoutService.setPartHidden(!0,this.partId),this.hideActiveComposite()}focusCompositeBar(){this.paneCompositeBar.value?.focus()}layout(e,t,i,o){this.layoutService.isVisible(this.partId)&&(this.contentDimension=new j(e,t),super.layout(this.contentDimension.width,this.contentDimension.height,i,o),this.layoutCompositeBar(),this.layoutEmptyMessage())}layoutCompositeBar(){if(this.contentDimension&&this.dimension&&this.paneCompositeBar.value){const e=this.compositeBarPosition===1?16:8,t=this.partId===A.PANEL_PART?0:1;let i=this.contentDimension.width-e-t;i=Math.max(m.MIN_COMPOSITE_BAR_WIDTH,i-this.getToolbarWidth()),this.paneCompositeBar.value.layout(i,this.dimension.height)}}layoutEmptyMessage(){const e=!this.getActiveComposite();this.emptyPaneMessageElement?.classList.toggle("visible",e),e&&this.titleLabel?.updateTitle("","")}updateGlobalToolbarActions(){const e=this.globalActions.getPrimaryActions(),t=this.globalActions.getSecondaryActions();this.globalToolBar?.setActions(E(e),E(t))}getToolbarWidth(){if(!this.toolBar||this.compositeBarPosition!==1||!this.getActivePaneComposite())return 0;const t=this.toolBar.getItemsWidth()+this.toolBar.getItemsLength()*4,i=this.globalToolBar?this.globalToolBar.getItemsWidth()+this.globalToolBar.getItemsLength()*4:0;return t+i+5}onTitleAreaContextMenu(e){if(this.shouldShowCompositeBar()&&this.getCompositeBarPosition()===1)return this.onCompositeBarContextMenu(e);{const t=this.getActivePaneComposite(),i=t?t.getContextMenuActions():[];i.length&&this.contextMenuService.showContextMenu({getAnchor:()=>e,getActions:()=>i,getActionViewItem:(o,r)=>this.actionViewItemProvider(o,r),actionRunner:t.getActionRunner(),skipTelemetry:!0})}}onCompositeBarAreaContextMenu(e){return this.onCompositeBarContextMenu(e)}onCompositeBarContextMenu(e){if(this.paneCompositeBar.value){const t=[...this.paneCompositeBar.value.getContextMenuActions()];t.length&&this.contextMenuService.showContextMenu({getAnchor:()=>e,getActions:()=>t,skipTelemetry:!0})}}getViewsSubmenuAction(){const e=this.getActivePaneComposite()?.getViewPaneContainer();if(e){const t=new T,i=[],o=t.add(this.contextKeyService.createScoped(this.element));o.createKey("viewContainer",e.viewContainer.id);const r=this.menuService.getMenuActions(he,o,{shouldForwardArgs:!0,renderShortTitle:!0});return Ce(r,{primary:i,secondary:[]},()=>!0),t.dispose(),i.length>1&&i.some(n=>n.enabled)?new le("views",I("views","Views"),i):void 0}}};m=B([s(8,ee),s(9,te),s(10,ie),s(11,z),s(12,oe),s(13,ge),s(14,G),s(15,re),s(16,X),s(17,ne),s(18,se),s(19,de)],m);export{m as AbstractPaneCompositePart,Pe as CompositeBarPosition};
