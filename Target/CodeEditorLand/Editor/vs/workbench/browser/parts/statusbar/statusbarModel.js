import{Disposable as f,DisposableStore as E}from"../../../../base/common/lifecycle.js";import{isStatusbarEntryLocation as y,StatusbarAlignment as d}from"../../../services/statusbar/browser/statusbar.js";import{hide as c,show as p,isAncestorOfActiveElement as b}from"../../../../base/browser/dom.js";import{StorageScope as h,StorageTarget as m}from"../../../../platform/storage/common/storage.js";import{Emitter as g}from"../../../../base/common/event.js";class l extends f{constructor(i){super();this.storageService=i;this.restoreState(),this.registerListeners()}static HIDDEN_ENTRIES_KEY="workbench.statusbar.hidden";_onDidChangeEntryVisibility=this._register(new g);onDidChangeEntryVisibility=this._onDidChangeEntryVisibility.event;_entries=[];get entries(){return this._entries.slice(0)}_lastFocusedEntry;get lastFocusedEntry(){return this._lastFocusedEntry&&!this.isHidden(this._lastFocusedEntry.id)?this._lastFocusedEntry:void 0}hidden=new Set;restoreState(){const i=this.storageService.get(l.HIDDEN_ENTRIES_KEY,h.PROFILE);if(i)try{this.hidden=new Set(JSON.parse(i))}catch{}}registerListeners(){this._register(this.storageService.onDidChangeValue(h.PROFILE,l.HIDDEN_ENTRIES_KEY,this._register(new E))(()=>this.onDidStorageValueChange()))}onDidStorageValueChange(){const i=new Set(this.hidden);this.hidden.clear(),this.restoreState();const t=new Set;for(const e of i)this.hidden.has(e)||t.add(e);for(const e of this.hidden)i.has(e)||t.add(e);if(t.size>0)for(const e of this._entries)t.has(e.id)&&(this.updateVisibility(e.id,!0),t.delete(e.id))}add(i){this._entries.push(i),this.updateVisibility(i,!1),this.sort(),this.markFirstLastVisibleEntry()}remove(i){const t=this._entries.indexOf(i);t>=0&&(this._entries.splice(t,1),this._entries.some(e=>y(e.priority.primary)&&e.priority.primary.id===i.id)&&this.sort(),this.markFirstLastVisibleEntry())}isHidden(i){return this.hidden.has(i)}hide(i){this.hidden.has(i)||(this.hidden.add(i),this.updateVisibility(i,!0),this.saveState())}show(i){this.hidden.has(i)&&(this.hidden.delete(i),this.updateVisibility(i,!0),this.saveState())}findEntry(i){return this._entries.find(t=>t.container===i)}getEntries(i){return this._entries.filter(t=>t.alignment===i)}focusNextEntry(){this.focusEntry(1,0)}focusPreviousEntry(){this.focusEntry(-1,this.entries.length-1)}isEntryFocused(){return!!this.getFocusedEntry()}getFocusedEntry(){return this._entries.find(i=>b(i.container))}focusEntry(i,t){const e=s=>{let o=s,a=o>=0&&o<this._entries.length?this._entries[o]:void 0;for(;a&&this.isHidden(a.id);)o+=i,a=o>=0&&o<this._entries.length?this._entries[o]:void 0;return a},n=this.getFocusedEntry();if(n){const s=e(this._entries.indexOf(n)+i);if(s){this._lastFocusedEntry=s,s.labelContainer.focus();return}}const r=e(t);r&&(this._lastFocusedEntry=r,r.labelContainer.focus())}updateVisibility(i,t){if(typeof i=="string"){const e=i;for(const n of this._entries)n.id===e&&this.updateVisibility(n,t)}else{const e=i,n=this.isHidden(e.id);n?c(e.container):p(e.container),t&&this._onDidChangeEntryVisibility.fire({id:e.id,visible:!n}),this.markFirstLastVisibleEntry()}}saveState(){this.hidden.size>0?this.storageService.store(l.HIDDEN_ENTRIES_KEY,JSON.stringify(Array.from(this.hidden.values())),h.PROFILE,m.USER):this.storageService.remove(l.HIDDEN_ENTRIES_KEY,h.PROFILE)}sort(){const i=new Map,t=new Map;for(let r=0;r<this._entries.length;r++){const s=this._entries[r];if(typeof s.priority.primary=="number")i.set(s,r);else{const o=s.priority.primary.id;let a=t.get(o);if(!a){for(const u of t.values())if(u.has(o)){a=u;break}a||(a=new Map,t.set(o,a))}a.set(s.id,s)}}const e=Array.from(i.keys());e.sort((r,s)=>r.alignment===s.alignment?r.priority.primary!==s.priority.primary?Number(s.priority.primary)-Number(r.priority.primary):r.priority.secondary!==s.priority.secondary?s.priority.secondary-r.priority.secondary:i.get(r)-i.get(s):r.alignment===d.LEFT?-1:s.alignment===d.LEFT?1:0);let n;if(t.size>0){n=[];for(const r of e){const s=t.get(r.id),o=s?Array.from(s.values()):void 0;o&&n.push(...o.filter(a=>y(a.priority.primary)&&a.priority.primary.alignment===d.LEFT)),n.push(r),o&&n.push(...o.filter(a=>y(a.priority.primary)&&a.priority.primary.alignment===d.RIGHT)),t.delete(r.id)}for(const[,r]of t)n.push(...r.values())}else n=e;this._entries=n}markFirstLastVisibleEntry(){this.doMarkFirstLastVisibleStatusbarItem(this.getEntries(d.LEFT)),this.doMarkFirstLastVisibleStatusbarItem(this.getEntries(d.RIGHT))}doMarkFirstLastVisibleStatusbarItem(i){let t,e;for(const n of i)n.container.classList.remove("first-visible-item","last-visible-item"),!this.isHidden(n.id)&&(t||(t=n),e=n);t?.container.classList.add("first-visible-item"),e?.container.classList.add("last-visible-item")}}export{l as StatusbarViewModel};
