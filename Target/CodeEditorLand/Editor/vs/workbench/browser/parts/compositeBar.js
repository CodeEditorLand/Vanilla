var A=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var f=(d,n,e,t)=>{for(var i=t>1?void 0:t?w(n,e):n,o=d.length-1,s;o>=0;o--)(s=d[o])&&(i=(t?s(n,e,i):s(i))||i);return t&&i&&A(n,e,i),i},h=(d,n)=>(e,t)=>n(e,t,d);import{$ as D,addDisposableListener as u,EventHelper as b,EventType as B,getWindow as I,isAncestor as y}from"../../../../vs/base/browser/dom.js";import{StandardMouseEvent as S}from"../../../../vs/base/browser/mouseEvent.js";import{Gesture as O,EventType as E}from"../../../../vs/base/browser/touch.js";import{ActionBar as x,ActionsOrientation as p}from"../../../../vs/base/browser/ui/actionbar/actionbar.js";import{Widget as M}from"../../../../vs/base/browser/ui/widget.js";import{toAction as V}from"../../../../vs/base/common/actions.js";import{Emitter as L}from"../../../../vs/base/common/event.js";import{isUndefinedOrNull as g}from"../../../../vs/base/common/types.js";import{localize as T}from"../../../../vs/nls.js";import{IContextMenuService as z}from"../../../../vs/platform/contextview/browser/contextView.js";import{IInstantiationService as H}from"../../../../vs/platform/instantiation/common/instantiation.js";import"../../../../vs/platform/theme/common/themeService.js";import{CompositeDragAndDropObserver as P,toggleDropEffect as _}from"../../../../vs/workbench/browser/dnd.js";import{CompositeActionViewItem as F,CompositeOverflowActivityAction as C,CompositeOverflowActivityActionViewItem as N}from"../../../../vs/workbench/browser/parts/compositeBarActions.js";import"../../../../vs/workbench/common/composite.js";import"../../../../vs/workbench/common/panecomposite.js";import{IViewDescriptorService as R}from"../../../../vs/workbench/common/views.js";import"../../../../vs/workbench/services/activity/common/activity.js";class be{constructor(n,e,t,i,o,s){this.viewDescriptorService=n;this.targetContainerLocation=e;this.orientation=t;this.openComposite=i;this.moveComposite=o;this.getItems=s}drop(n,e,t,i){const o=n.getData();if(o.type==="composite"){const s=this.viewDescriptorService.getViewContainerById(o.id);this.viewDescriptorService.getViewContainerLocation(s)===this.targetContainerLocation?e&&this.moveComposite(o.id,e,i):this.viewDescriptorService.moveViewContainerToLocation(s,this.targetContainerLocation,this.getTargetIndex(e,i),"dnd")}if(o.type==="view"){const s=this.viewDescriptorService.getViewDescriptorById(o.id);if(s&&s.canMoveView){this.viewDescriptorService.moveViewToLocation(s,this.targetContainerLocation,"dnd");const r=this.viewDescriptorService.getViewContainerByViewId(s.id);e&&this.moveComposite(r.id,e,i),this.openComposite(r.id,!0).then(m=>{m?.openView(s.id,!0)})}}}onDragEnter(n,e,t){return this.canDrop(n,e)}onDragOver(n,e,t){return this.canDrop(n,e)}getTargetIndex(n,e){if(!n)return;const t=this.getItems(),i=this.orientation===p.HORIZONTAL?e?.horizontallyBefore:e?.verticallyBefore;return t.filter(o=>o.visible).findIndex(o=>o.id===n)+(i?0:1)}canDrop(n,e){const t=n.getData();if(t.type==="composite"){const i=this.viewDescriptorService.getViewContainerById(t.id);return this.viewDescriptorService.getViewContainerLocation(i)===this.targetContainerLocation?t.id!==e:!0}else{const i=this.viewDescriptorService.getViewDescriptorById(t.id);return!(!i||!i.canMoveView)}}}let v=class extends M{constructor(e,t,i,o,s){super();this.options=t;this.instantiationService=i;this.contextMenuService=o;this.viewDescriptorService=s;this.model=new G(e,t),this.visibleComposites=[],this.compositeSizeInBar=new Map,this.computeSizes(this.model.visibleItems)}_onDidChange=this._register(new L);onDidChange=this._onDidChange.event;dimension;compositeSwitcherBar;compositeOverflowAction;compositeOverflowActionViewItem;model;visibleComposites;compositeSizeInBar;getCompositeBarItems(){return[...this.model.items]}setCompositeBarItems(e){this.model.setItems(e),this.updateCompositeSwitcher()}getPinnedComposites(){return this.model.pinnedItems}getVisibleComposites(){return this.model.visibleItems}create(e){const t=e.appendChild(D(".composite-bar"));this.compositeSwitcherBar=this._register(new x(t,{actionViewItemProvider:(o,s)=>{if(o instanceof C)return this.compositeOverflowActionViewItem;const r=this.model.findItem(o.id);return r&&this.instantiationService.createInstance(F,{...s,draggable:!0,colors:this.options.colors,icon:this.options.icon,hoverOptions:this.options.activityHoverOptions,compact:this.options.compact},o,r.pinnedAction,r.toggleBadgeAction,m=>this.options.getContextMenuActionsForComposite(m),()=>this.getContextMenuActions(),this.options.dndHandler,this)},orientation:this.options.orientation,ariaLabel:T("activityBarAriaLabel","Active View Switcher"),ariaRole:"tablist",preventLoopNavigation:this.options.preventLoopNavigation,triggerKeys:{keyDown:!0}})),this._register(u(e,B.CONTEXT_MENU,o=>this.showContextMenu(I(e),o))),this._register(O.addTarget(e)),this._register(u(e,E.Contextmenu,o=>this.showContextMenu(I(e),o)));let i;return this._register(P.INSTANCE.registerTarget(e,{onDragOver:o=>{const s=this.getVisibleComposites();if(!s.length||o.eventData.target&&y(o.eventData.target,t)){i=this.updateFromDragging(e,!1,!1,!0);return}const r=this.insertAtFront(t,o.eventData),m=r?s[0]:s[s.length-1],a=this.options.dndHandler.onDragOver(o.dragAndDropData,m.id,o.eventData);_(o.eventData.dataTransfer,"move",a),i=this.updateFromDragging(e,a,r,!0)},onDragLeave:o=>{i=this.updateFromDragging(e,!1,!1,!1)},onDragEnd:o=>{i=this.updateFromDragging(e,!1,!1,!1)},onDrop:o=>{const s=this.getVisibleComposites();if(s.length){const r=this.insertAtFront(t,o.eventData)?s[0]:s[s.length-1];this.options.dndHandler.drop(o.dragAndDropData,r.id,o.eventData,i)}i=this.updateFromDragging(e,!1,!1,!1)}})),t}insertAtFront(e,t){const i=e.getBoundingClientRect(),o=t.clientX,s=t.clientY;switch(this.options.orientation){case p.HORIZONTAL:return o<i.left;case p.VERTICAL:return s<i.top}}updateFromDragging(e,t,i,o){if(e.classList.toggle("dragged-over",o),e.classList.toggle("dragged-over-head",t&&i),e.classList.toggle("dragged-over-tail",t&&!i),!!t)return{verticallyBefore:i,horizontallyBefore:i}}focus(e){this.compositeSwitcherBar?.focus(e)}recomputeSizes(){this.computeSizes(this.model.visibleItems),this.updateCompositeSwitcher()}layout(e){this.dimension=e,!(e.height===0||e.width===0)&&(this.compositeSizeInBar.size===0&&this.computeSizes(this.model.visibleItems),this.updateCompositeSwitcher())}addComposite({id:e,name:t,order:i,requestedIndex:o}){this.model.add(e,t,i,o)&&(this.computeSizes([this.model.findItem(e)]),this.updateCompositeSwitcher())}removeComposite(e){this.isPinned(e)&&this.unpin(e),this.model.remove(e)&&this.updateCompositeSwitcher()}hideComposite(e){this.model.hide(e)&&(this.resetActiveComposite(e),this.updateCompositeSwitcher())}activateComposite(e){const t=this.model.activeItem;this.model.activate(e)&&(this.visibleComposites.indexOf(e)===-1||this.model.activeItem&&!this.model.activeItem.pinned||t&&!t.pinned)&&this.updateCompositeSwitcher()}deactivateComposite(e){const t=this.model.activeItem;this.model.deactivate()&&t&&!t.pinned&&this.updateCompositeSwitcher()}async pin(e,t){this.model.setPinned(e,!0)&&(this.updateCompositeSwitcher(),t&&(await this.options.openComposite(e),this.activateComposite(e)))}unpin(e){this.model.setPinned(e,!1)&&(this.updateCompositeSwitcher(),this.resetActiveComposite(e))}areBadgesEnabled(e){return this.viewDescriptorService.getViewContainerBadgeEnablementState(e)}toggleBadgeEnablement(e){this.viewDescriptorService.setViewContainerBadgeEnablementState(e,!this.areBadgesEnabled(e)),this.updateCompositeSwitcher();const t=this.model.findItem(e);t&&(t.activityAction.activity=t.activityAction.activity)}resetActiveComposite(e){const t=this.options.getDefaultCompositeId();!this.model.activeItem||this.model.activeItem.id!==e||(this.deactivateComposite(e),t&&t!==e&&this.isPinned(t)?this.options.openComposite(t,!0):this.options.openComposite(this.visibleComposites.filter(i=>i!==e)[0]))}isPinned(e){return this.model.findItem(e)?.pinned}move(e,t,i){if(i!==void 0){const o=this.model.items.findIndex(r=>r.id===e);let s=this.model.items.findIndex(r=>r.id===t);o>=0&&s>=0&&(!i&&o>s&&s++,i&&o<s&&s--,s<this.model.items.length&&s>=0&&s!==o&&this.model.move(this.model.items[o].id,this.model.items[s].id)&&setTimeout(()=>this.updateCompositeSwitcher(),0))}else this.model.move(e,t)&&setTimeout(()=>this.updateCompositeSwitcher(),0)}getAction(e){return this.model.findItem(e)?.activityAction}computeSizes(e){const t=this.options.compositeSize;if(t)e.forEach(i=>this.compositeSizeInBar.set(i.id,t));else{const i=this.compositeSwitcherBar;if(i&&this.dimension&&this.dimension.height!==0&&this.dimension.width!==0){const o=i.viewItems.length;i.push(e.map(s=>s.activityAction)),e.map((s,r)=>this.compositeSizeInBar.set(s.id,this.options.orientation===p.VERTICAL?i.getHeight(o+r):i.getWidth(o+r))),e.forEach(()=>i.pull(i.viewItems.length-1))}}}updateCompositeSwitcher(){const e=this.compositeSwitcherBar;if(!e||!this.dimension)return;let t=this.model.visibleItems.filter(a=>a.pinned||this.model.activeItem&&this.model.activeItem.id===a.id).map(a=>a.id),i=t.length;const o=t.length;let s=0;const r=this.options.orientation===p.VERTICAL?this.dimension.height:this.dimension.width;for(let a=0;a<t.length;a++){const c=this.compositeSizeInBar.get(t[a]);if(s+c>r){i=a;break}s+=c}for(o>i&&(t=t.slice(0,i)),this.model.activeItem&&t.every(a=>!!this.model.activeItem&&a!==this.model.activeItem.id)&&(s+=this.compositeSizeInBar.get(this.model.activeItem.id),t.push(this.model.activeItem.id));s>r&&t.length;){const a=t.length>1?t.splice(t.length-2,1)[0]:t.pop();s-=this.compositeSizeInBar.get(a)}for(o>t.length&&(s+=this.options.overflowActionSize);s>r&&t.length;){const a=t.length>1&&t[t.length-1]===this.model.activeItem?.id?t.splice(t.length-2,1)[0]:t.pop();s-=this.compositeSizeInBar.get(a)}o===t.length&&this.compositeOverflowAction&&(e.pull(e.length()-1),this.compositeOverflowAction.dispose(),this.compositeOverflowAction=void 0,this.compositeOverflowActionViewItem?.dispose(),this.compositeOverflowActionViewItem=void 0);const m=[];this.visibleComposites.forEach((a,c)=>{t.includes(a)||m.push(c)}),m.reverse().forEach(a=>{e.pull(a),this.visibleComposites.splice(a,1)}),t.forEach((a,c)=>{const l=this.visibleComposites.indexOf(a);c!==l&&(l!==-1&&(e.pull(l),this.visibleComposites.splice(l,1)),e.push(this.model.findItem(a).activityAction,{label:!0,icon:this.options.icon,index:c}),this.visibleComposites.splice(c,0,a))}),o>t.length&&!this.compositeOverflowAction&&(this.compositeOverflowAction=this._register(this.instantiationService.createInstance(C,()=>{this.compositeOverflowActionViewItem?.showMenu()})),this.compositeOverflowActionViewItem=this._register(this.instantiationService.createInstance(N,this.compositeOverflowAction,()=>this.getOverflowingComposites(),()=>this.model.activeItem?this.model.activeItem.id:void 0,a=>this.model.findItem(a)?.activity[0]?.badge,this.options.getOnCompositeClickAction,this.options.colors,this.options.activityHoverOptions)),e.push(this.compositeOverflowAction,{label:!1,icon:!0})),this._onDidChange.fire()}getOverflowingComposites(){let e=this.model.visibleItems.filter(t=>t.pinned).map(t=>t.id);return this.model.activeItem&&!this.model.activeItem.pinned&&e.push(this.model.activeItem.id),e=e.filter(t=>!this.visibleComposites.includes(t)),this.model.visibleItems.filter(t=>e.includes(t.id)).map(t=>({id:t.id,name:this.getAction(t.id)?.label||t.name}))}showContextMenu(e,t){b.stop(t,!0);const i=new S(e,t);this.contextMenuService.showContextMenu({getAnchor:()=>i,getActions:()=>this.getContextMenuActions(t)})}getContextMenuActions(e){const t=this.model.visibleItems.map(({id:i,name:o,activityAction:s})=>V({id:i,label:this.getAction(i).label||o||i,checked:this.isPinned(i),enabled:s.enabled,run:()=>{this.isPinned(i)?this.unpin(i):this.pin(i,!0)}}));return this.options.fillExtraContextMenuActions(t,e),t}};v=f([h(2,H),h(3,z),h(4,R)],v);class G{_items=[];get items(){return this._items}options;activeItem;constructor(n,e){this.options=e,this.setItems(n)}setItems(n){this._items=[],this._items=n.map(e=>this.createCompositeBarItem(e.id,e.name,e.order,e.pinned,e.visible))}get visibleItems(){return this.items.filter(n=>n.visible)}get pinnedItems(){return this.items.filter(n=>n.visible&&n.pinned)}createCompositeBarItem(n,e,t,i,o){const s=this.options;return{id:n,name:e,pinned:i,order:t,visible:o,activity:[],get activityAction(){return s.getActivityAction(n)},get pinnedAction(){return s.getCompositePinnedAction(n)},get toggleBadgeAction(){return s.getCompositeBadgeAction(n)}}}add(n,e,t,i){const o=this.findItem(n);if(o){let s=!1;return o.name=e,g(t)||(s=o.order!==t,o.order=t),o.visible||(o.visible=!0,s=!0),s}else{const s=this.createCompositeBarItem(n,e,t,!0,!0);if(g(i))if(g(t))this.items.push(s);else{let r=0;for(;r<this.items.length&&typeof this.items[r].order=="number"&&this.items[r].order<t;)r++;this.items.splice(r,0,s)}else{let r=0,m=i;for(;m>0&&r<this.items.length;)this.items[r++].visible&&m--;this.items.splice(r,0,s)}return!0}}remove(n){for(let e=0;e<this.items.length;e++)if(this.items[e].id===n)return this.items.splice(e,1),!0;return!1}hide(n){for(const e of this.items)if(e.id===n)return e.visible?(e.visible=!1,!0):!1;return!1}move(n,e){const t=this.findIndex(n),i=this.findIndex(e);if(t===-1||i===-1)return!1;const o=this.items.splice(t,1)[0];return this.items.splice(i,0,o),o.pinned=!0,!0}setPinned(n,e){for(const t of this.items)if(t.id===n)return t.pinned!==e?(t.pinned=e,!0):!1;return!1}activate(n){if(!this.activeItem||this.activeItem.id!==n){this.activeItem&&this.deactivate();for(const e of this.items)if(e.id===n)return this.activeItem=e,this.activeItem.activityAction.activate(),!0}return!1}deactivate(){return this.activeItem?(this.activeItem.activityAction.deactivate(),this.activeItem=void 0,!0):!1}findItem(n){return this.items.filter(e=>e.id===n)[0]}findIndex(n){for(let e=0;e<this.items.length;e++)if(this.items[e].id===n)return e;return-1}}export{v as CompositeBar,be as CompositeDragAndDrop};
