var D=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var f=(d,i,e,t)=>{for(var o=t>1?void 0:t?A(i,e):i,n=d.length-1,s;n>=0;n--)(s=d[n])&&(o=(t?s(i,e,o):s(o))||o);return t&&o&&D(i,e,o),o},h=(d,i)=>(e,t)=>i(e,t,d);import{localize as w}from"../../../nls.js";import{toAction as B}from"../../../base/common/actions.js";import"../../services/activity/common/activity.js";import{IInstantiationService as b}from"../../../platform/instantiation/common/instantiation.js";import{ActionBar as y,ActionsOrientation as p}from"../../../base/browser/ui/actionbar/actionbar.js";import{CompositeActionViewItem as S,CompositeOverflowActivityAction as u,CompositeOverflowActivityActionViewItem as O}from"./compositeBarActions.js";import{$ as E,addDisposableListener as I,EventType as M,EventHelper as x,isAncestor as L,getWindow as C}from"../../../base/browser/dom.js";import{StandardMouseEvent as V}from"../../../base/browser/mouseEvent.js";import{IContextMenuService as T}from"../../../platform/contextview/browser/contextView.js";import{Widget as z}from"../../../base/browser/ui/widget.js";import{isUndefinedOrNull as g}from"../../../base/common/types.js";import"../../../platform/theme/common/themeService.js";import{Emitter as H}from"../../../base/common/event.js";import{IViewDescriptorService as P}from"../../common/views.js";import"../../common/panecomposite.js";import"../../common/composite.js";import{CompositeDragAndDropObserver as _,toggleDropEffect as F}from"../dnd.js";import{Gesture as N,EventType as R}from"../../../base/browser/touch.js";class ye{constructor(i,e,t,o,n,s){this.viewDescriptorService=i;this.targetContainerLocation=e;this.orientation=t;this.openComposite=o;this.moveComposite=n;this.getItems=s}drop(i,e,t,o){const n=i.getData();if(n.type==="composite"){const s=this.viewDescriptorService.getViewContainerById(n.id);this.viewDescriptorService.getViewContainerLocation(s)===this.targetContainerLocation?e&&this.moveComposite(n.id,e,o):this.viewDescriptorService.moveViewContainerToLocation(s,this.targetContainerLocation,this.getTargetIndex(e,o),"dnd")}if(n.type==="view"){const s=this.viewDescriptorService.getViewDescriptorById(n.id);if(s&&s.canMoveView){this.viewDescriptorService.moveViewToLocation(s,this.targetContainerLocation,"dnd");const r=this.viewDescriptorService.getViewContainerByViewId(s.id);e&&this.moveComposite(r.id,e,o),this.openComposite(r.id,!0).then(m=>{m?.openView(s.id,!0)})}}}onDragEnter(i,e,t){return this.canDrop(i,e)}onDragOver(i,e,t){return this.canDrop(i,e)}getTargetIndex(i,e){if(!i)return;const t=this.getItems(),o=this.orientation===p.HORIZONTAL?e?.horizontallyBefore:e?.verticallyBefore;return t.filter(n=>n.visible).findIndex(n=>n.id===i)+(o?0:1)}canDrop(i,e){const t=i.getData();if(t.type==="composite"){const o=this.viewDescriptorService.getViewContainerById(t.id);return this.viewDescriptorService.getViewContainerLocation(o)===this.targetContainerLocation?t.id!==e:!0}else{const o=this.viewDescriptorService.getViewDescriptorById(t.id);return!(!o||!o.canMoveView)}}}class k{constructor(i,e,t,o,n){this.compositeBarContainer=i;this.actionBarContainer=e;this.compositeBarModel=t;this.dndHandler=o;this.orientation=n}insertDropBefore=void 0;onDragOver(i){const e=this.compositeBarModel.visibleItems;if(!e.length||i.eventData.target&&L(i.eventData.target,this.actionBarContainer)){this.insertDropBefore=this.updateFromDragging(this.compositeBarContainer,!1,!1,!0);return}const t=this.insertAtFront(this.actionBarContainer,i.eventData),o=t?e[0]:e[e.length-1],n=this.dndHandler.onDragOver(i.dragAndDropData,o.id,i.eventData);F(i.eventData.dataTransfer,"move",n),this.insertDropBefore=this.updateFromDragging(this.compositeBarContainer,n,t,!0)}onDragLeave(i){this.insertDropBefore=this.updateFromDragging(this.compositeBarContainer,!1,!1,!1)}onDragEnd(i){this.insertDropBefore=this.updateFromDragging(this.compositeBarContainer,!1,!1,!1)}onDrop(i){const e=this.compositeBarModel.visibleItems;let t;e.length&&(t=this.insertAtFront(this.actionBarContainer,i.eventData)?e[0].id:e[e.length-1].id),this.dndHandler.drop(i.dragAndDropData,t,i.eventData,this.insertDropBefore),this.insertDropBefore=this.updateFromDragging(this.compositeBarContainer,!1,!1,!1)}insertAtFront(i,e){const t=i.getBoundingClientRect(),o=e.clientX,n=e.clientY;switch(this.orientation){case p.HORIZONTAL:return o<t.left;case p.VERTICAL:return n<t.top}}updateFromDragging(i,e,t,o){if(i.classList.toggle("dragged-over",o),i.classList.toggle("dragged-over-head",e&&t),i.classList.toggle("dragged-over-tail",e&&!t),!!e)return{verticallyBefore:t,horizontallyBefore:t}}}let v=class extends z{constructor(e,t,o,n,s){super();this.options=t;this.instantiationService=o;this.contextMenuService=n;this.viewDescriptorService=s;this.model=new G(e,t),this.visibleComposites=[],this.compositeSizeInBar=new Map,this.computeSizes(this.model.visibleItems)}_onDidChange=this._register(new H);onDidChange=this._onDidChange.event;dimension;compositeSwitcherBar;compositeOverflowAction;compositeOverflowActionViewItem;model;visibleComposites;compositeSizeInBar;getCompositeBarItems(){return[...this.model.items]}setCompositeBarItems(e){this.model.setItems(e),this.updateCompositeSwitcher()}getPinnedComposites(){return this.model.pinnedItems}getVisibleComposites(){return this.model.visibleItems}create(e){const t=e.appendChild(E(".composite-bar"));this.compositeSwitcherBar=this._register(new y(t,{actionViewItemProvider:(n,s)=>{if(n instanceof u)return this.compositeOverflowActionViewItem;const r=this.model.findItem(n.id);return r&&this.instantiationService.createInstance(S,{...s,draggable:!0,colors:this.options.colors,icon:this.options.icon,hoverOptions:this.options.activityHoverOptions,compact:this.options.compact},n,r.pinnedAction,r.toggleBadgeAction,m=>this.options.getContextMenuActionsForComposite(m),()=>this.getContextMenuActions(),this.options.dndHandler,this)},orientation:this.options.orientation,ariaLabel:w("activityBarAriaLabel","Active View Switcher"),ariaRole:"tablist",preventLoopNavigation:this.options.preventLoopNavigation,triggerKeys:{keyDown:!0}})),this._register(I(e,M.CONTEXT_MENU,n=>this.showContextMenu(C(e),n))),this._register(N.addTarget(e)),this._register(I(e,R.Contextmenu,n=>this.showContextMenu(C(e),n)));const o=new k(e,t,this.model,this.options.dndHandler,this.options.orientation);return this._register(_.INSTANCE.registerTarget(e,o)),t}focus(e){this.compositeSwitcherBar?.focus(e)}recomputeSizes(){this.computeSizes(this.model.visibleItems),this.updateCompositeSwitcher()}layout(e){this.dimension=e,!(e.height===0||e.width===0)&&(this.compositeSizeInBar.size===0&&this.computeSizes(this.model.visibleItems),this.updateCompositeSwitcher())}addComposite({id:e,name:t,order:o,requestedIndex:n}){this.model.add(e,t,o,n)&&(this.computeSizes([this.model.findItem(e)]),this.updateCompositeSwitcher())}removeComposite(e){this.isPinned(e)&&this.unpin(e),this.model.remove(e)&&this.updateCompositeSwitcher()}hideComposite(e){this.model.hide(e)&&(this.resetActiveComposite(e),this.updateCompositeSwitcher())}activateComposite(e){const t=this.model.activeItem;this.model.activate(e)&&(this.visibleComposites.indexOf(e)===-1||this.model.activeItem&&!this.model.activeItem.pinned||t&&!t.pinned)&&this.updateCompositeSwitcher()}deactivateComposite(e){const t=this.model.activeItem;this.model.deactivate()&&t&&!t.pinned&&this.updateCompositeSwitcher()}async pin(e,t){this.model.setPinned(e,!0)&&(this.updateCompositeSwitcher(),t&&(await this.options.openComposite(e),this.activateComposite(e)))}unpin(e){this.model.setPinned(e,!1)&&(this.updateCompositeSwitcher(),this.resetActiveComposite(e))}areBadgesEnabled(e){return this.viewDescriptorService.getViewContainerBadgeEnablementState(e)}toggleBadgeEnablement(e){this.viewDescriptorService.setViewContainerBadgeEnablementState(e,!this.areBadgesEnabled(e)),this.updateCompositeSwitcher();const t=this.model.findItem(e);t&&(t.activityAction.activity=t.activityAction.activity)}resetActiveComposite(e){const t=this.options.getDefaultCompositeId();!this.model.activeItem||this.model.activeItem.id!==e||(this.deactivateComposite(e),t&&t!==e&&this.isPinned(t)?this.options.openComposite(t,!0):this.options.openComposite(this.visibleComposites.filter(o=>o!==e)[0]))}isPinned(e){return this.model.findItem(e)?.pinned}move(e,t,o){if(o!==void 0){const n=this.model.items.findIndex(r=>r.id===e);let s=this.model.items.findIndex(r=>r.id===t);n>=0&&s>=0&&(!o&&n>s&&s++,o&&n<s&&s--,s<this.model.items.length&&s>=0&&s!==n&&this.model.move(this.model.items[n].id,this.model.items[s].id)&&setTimeout(()=>this.updateCompositeSwitcher(),0))}else this.model.move(e,t)&&setTimeout(()=>this.updateCompositeSwitcher(),0)}getAction(e){return this.model.findItem(e)?.activityAction}computeSizes(e){const t=this.options.compositeSize;if(t)e.forEach(o=>this.compositeSizeInBar.set(o.id,t));else{const o=this.compositeSwitcherBar;if(o&&this.dimension&&this.dimension.height!==0&&this.dimension.width!==0){const n=o.viewItems.length;o.push(e.map(s=>s.activityAction)),e.map((s,r)=>this.compositeSizeInBar.set(s.id,this.options.orientation===p.VERTICAL?o.getHeight(n+r):o.getWidth(n+r))),e.forEach(()=>o.pull(o.viewItems.length-1))}}}updateCompositeSwitcher(){const e=this.compositeSwitcherBar;if(!e||!this.dimension)return;let t=this.model.visibleItems.filter(a=>a.pinned||this.model.activeItem&&this.model.activeItem.id===a.id).map(a=>a.id),o=t.length;const n=t.length;let s=0;const r=this.options.orientation===p.VERTICAL?this.dimension.height:this.dimension.width;for(let a=0;a<t.length;a++){const c=this.compositeSizeInBar.get(t[a]);if(s+c>r){o=a;break}s+=c}for(n>o&&(t=t.slice(0,o)),this.model.activeItem&&t.every(a=>!!this.model.activeItem&&a!==this.model.activeItem.id)&&(s+=this.compositeSizeInBar.get(this.model.activeItem.id),t.push(this.model.activeItem.id));s>r&&t.length;){const a=t.length>1?t.splice(t.length-2,1)[0]:t.pop();s-=this.compositeSizeInBar.get(a)}for(n>t.length&&(s+=this.options.overflowActionSize);s>r&&t.length;){const a=t.length>1&&t[t.length-1]===this.model.activeItem?.id?t.splice(t.length-2,1)[0]:t.pop();s-=this.compositeSizeInBar.get(a)}n===t.length&&this.compositeOverflowAction&&(e.pull(e.length()-1),this.compositeOverflowAction.dispose(),this.compositeOverflowAction=void 0,this.compositeOverflowActionViewItem?.dispose(),this.compositeOverflowActionViewItem=void 0);const m=[];this.visibleComposites.forEach((a,c)=>{t.includes(a)||m.push(c)}),m.reverse().forEach(a=>{e.pull(a),this.visibleComposites.splice(a,1)}),t.forEach((a,c)=>{const l=this.visibleComposites.indexOf(a);c!==l&&(l!==-1&&(e.pull(l),this.visibleComposites.splice(l,1)),e.push(this.model.findItem(a).activityAction,{label:!0,icon:this.options.icon,index:c}),this.visibleComposites.splice(c,0,a))}),n>t.length&&!this.compositeOverflowAction&&(this.compositeOverflowAction=this._register(this.instantiationService.createInstance(u,()=>{this.compositeOverflowActionViewItem?.showMenu()})),this.compositeOverflowActionViewItem=this._register(this.instantiationService.createInstance(O,this.compositeOverflowAction,()=>this.getOverflowingComposites(),()=>this.model.activeItem?this.model.activeItem.id:void 0,a=>this.model.findItem(a)?.activity[0]?.badge,this.options.getOnCompositeClickAction,this.options.colors,this.options.activityHoverOptions)),e.push(this.compositeOverflowAction,{label:!1,icon:!0})),this._onDidChange.fire()}getOverflowingComposites(){let e=this.model.visibleItems.filter(t=>t.pinned).map(t=>t.id);return this.model.activeItem&&!this.model.activeItem.pinned&&e.push(this.model.activeItem.id),e=e.filter(t=>!this.visibleComposites.includes(t)),this.model.visibleItems.filter(t=>e.includes(t.id)).map(t=>({id:t.id,name:this.getAction(t.id)?.label||t.name}))}showContextMenu(e,t){x.stop(t,!0);const o=new V(e,t);this.contextMenuService.showContextMenu({getAnchor:()=>o,getActions:()=>this.getContextMenuActions(t)})}getContextMenuActions(e){const t=this.model.visibleItems.map(({id:o,name:n,activityAction:s})=>B({id:o,label:this.getAction(o).label||n||o,checked:this.isPinned(o),enabled:s.enabled,run:()=>{this.isPinned(o)?this.unpin(o):this.pin(o,!0)}}));return this.options.fillExtraContextMenuActions(t,e),t}};v=f([h(2,b),h(3,T),h(4,P)],v);class G{_items=[];get items(){return this._items}options;activeItem;constructor(i,e){this.options=e,this.setItems(i)}setItems(i){this._items=[],this._items=i.map(e=>this.createCompositeBarItem(e.id,e.name,e.order,e.pinned,e.visible))}get visibleItems(){return this.items.filter(i=>i.visible)}get pinnedItems(){return this.items.filter(i=>i.visible&&i.pinned)}createCompositeBarItem(i,e,t,o,n){const s=this.options;return{id:i,name:e,pinned:o,order:t,visible:n,activity:[],get activityAction(){return s.getActivityAction(i)},get pinnedAction(){return s.getCompositePinnedAction(i)},get toggleBadgeAction(){return s.getCompositeBadgeAction(i)}}}add(i,e,t,o){const n=this.findItem(i);if(n){let s=!1;return n.name=e,g(t)||(s=n.order!==t,n.order=t),n.visible||(n.visible=!0,s=!0),s}else{const s=this.createCompositeBarItem(i,e,t,!0,!0);if(g(o))if(g(t))this.items.push(s);else{let r=0;for(;r<this.items.length&&typeof this.items[r].order=="number"&&this.items[r].order<t;)r++;this.items.splice(r,0,s)}else{let r=0,m=o;for(;m>0&&r<this.items.length;)this.items[r++].visible&&m--;this.items.splice(r,0,s)}return!0}}remove(i){for(let e=0;e<this.items.length;e++)if(this.items[e].id===i)return this.items.splice(e,1),!0;return!1}hide(i){for(const e of this.items)if(e.id===i)return e.visible?(e.visible=!1,!0):!1;return!1}move(i,e){const t=this.findIndex(i),o=this.findIndex(e);if(t===-1||o===-1)return!1;const n=this.items.splice(t,1)[0];return this.items.splice(o,0,n),n.pinned=!0,!0}setPinned(i,e){for(const t of this.items)if(t.id===i)return t.pinned!==e?(t.pinned=e,!0):!1;return!1}activate(i){if(!this.activeItem||this.activeItem.id!==i){this.activeItem&&this.deactivate();for(const e of this.items)if(e.id===i)return this.activeItem=e,this.activeItem.activityAction.activate(),!0}return!1}deactivate(){return this.activeItem?(this.activeItem.activityAction.deactivate(),this.activeItem=void 0,!0):!1}findItem(i){return this.items.filter(e=>e.id===i)[0]}findIndex(i){for(let e=0;e<this.items.length;e++)if(this.items[e].id===i)return e;return-1}}export{v as CompositeBar,ye as CompositeDragAndDrop};
