var J=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var T=(s,e,t,i)=>{for(var r=i>1?void 0:i?X(e,t):e,d=s.length-1,n;d>=0;d--)(n=s[d])&&(r=(i?n(e,t,r):n(r))||r);return i&&r&&J(e,t,r),r},h=(s,e)=>(t,i)=>e(t,i,s);import*as E from"../../../../base/browser/dom.js";import{StandardMouseEvent as ee}from"../../../../base/browser/mouseEvent.js";import{BreadcrumbsItem as R,BreadcrumbsWidget as ie}from"../../../../base/browser/ui/breadcrumbs/breadcrumbsWidget.js";import{tail as te}from"../../../../base/common/arrays.js";import{timeout as re}from"../../../../base/common/async.js";import{KeyCode as a,KeyMod as u}from"../../../../base/common/keyCodes.js";import{combinedDisposable as se,DisposableStore as B,MutableDisposable as oe,toDisposable as F}from"../../../../base/common/lifecycle.js";import{extUri as ne}from"../../../../base/common/resources.js";import{URI as de}from"../../../../base/common/uri.js";import"./media/breadcrumbscontrol.css";import{localize as S,localize2 as L}from"../../../../nls.js";import{Action2 as O,MenuId as P,registerAction2 as W}from"../../../../platform/actions/common/actions.js";import{IConfigurationService as A}from"../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as v,IContextKeyService as ae,RawContextKey as G}from"../../../../platform/contextkey/common/contextkey.js";import{IContextViewService as ce}from"../../../../platform/contextview/browser/contextView.js";import{FileKind as H,IFileService as Y}from"../../../../platform/files/common/files.js";import{IInstantiationService as M}from"../../../../platform/instantiation/common/instantiation.js";import{KeybindingsRegistry as y,KeybindingWeight as f}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{IListService as le,WorkbenchAsyncDataTree as ue,WorkbenchDataTree as me,WorkbenchListFocusContextKey as N}from"../../../../platform/list/browser/listService.js";import{IQuickInputService as be}from"../../../../platform/quickinput/common/quickInput.js";import{DEFAULT_LABELS_CONTAINER as he,ResourceLabels as pe}from"../../labels.js";import{BreadcrumbsConfig as k,IBreadcrumbsService as I}from"./breadcrumbs.js";import{BreadcrumbsModel as ge,FileElement as Q,OutlineElement2 as _e}from"./breadcrumbsModel.js";import{BreadcrumbsFilePicker as fe,BreadcrumbsOutlinePicker as ve}from"./breadcrumbsPicker.js";import{EditorResourceAccessor as Z,SideBySideEditor as j}from"../../../common/editor.js";import{ACTIVE_GROUP as we,IEditorService as $,SIDE_GROUP as U}from"../../../services/editor/common/editorService.js";import{IEditorGroupsService as C}from"../../../services/editor/common/editorGroupsService.js";import"./editor.js";import{PixelRatio as ye}from"../../../../base/browser/pixelRatio.js";import{ILabelService as Ie}from"../../../../platform/label/common/label.js";import{Categories as Se}from"../../../../platform/action/common/actionCommonCategories.js";import"../../../services/outline/browser/outline.js";import{registerIcon as Ce}from"../../../../platform/theme/common/iconRegistry.js";import{Codicon as ke}from"../../../../base/common/codicons.js";import{defaultBreadcrumbsWidgetStyles as Ee}from"../../../../platform/theme/browser/defaultStyles.js";import{Emitter as z}from"../../../../base/common/event.js";import"../../../../base/browser/ui/hover/hoverDelegate.js";import{getDefaultHoverDelegate as Be}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";class V extends R{constructor(t,i,r){super();this.model=t;this.element=i;this.options=r}_disposables=new B;dispose(){this._disposables.dispose()}equals(t){return t instanceof V?this.element.element===t.element.element&&this.options.showFileIcons===t.options.showFileIcons&&this.options.showSymbolIcons===t.options.showSymbolIcons:!1}render(t){const{element:i,outline:r}=this.element;if(i===r){const c=E.$("span",void 0,"\u2026");t.appendChild(c);return}const d=r.config.delegate.getTemplateId(i),n=r.config.renderers.find(c=>c.templateId===d);if(!n){t.innerText="<<NO RENDERER>>";return}const l=n.renderTemplate(t);n.renderElement({element:i,children:[],depth:0,visibleChildrenCount:0,visibleChildIndex:0,collapsible:!1,collapsed:!1,visible:!0,filterData:void 0},0,l,void 0),this._disposables.add(F(()=>{n.disposeTemplate(l)}))}}class x extends R{constructor(t,i,r,d,n){super();this.model=t;this.element=i;this.options=r;this._labels=d;this._hoverDelegate=n}_disposables=new B;dispose(){this._disposables.dispose()}equals(t){return t instanceof x?ne.isEqual(this.element.uri,t.element.uri)&&this.options.showFileIcons===t.options.showFileIcons&&this.options.showSymbolIcons===t.options.showSymbolIcons:!1}render(t){const i=this._labels.create(t,{hoverDelegate:this._hoverDelegate});i.setFile(this.element.uri,{hidePath:!0,hideIcon:this.element.kind===H.FOLDER||!this.options.showFileIcons,fileKind:this.element.kind,fileDecorations:{colors:this.options.showDecorationColors,badges:!1}}),t.classList.add(H[this.element.kind].toLowerCase()),this._disposables.add(i)}}const Pe=Ce("breadcrumb-separator",ke.chevronRight,S("separatorIcon","Icon for the separator in the breadcrumbs."));let o=class{constructor(e,t,i,r,d,n,l,c,g,_,m,p){this._options=t;this._editorGroup=i;this._contextKeyService=r;this._contextViewService=d;this._instantiationService=n;this._quickInputService=l;this._fileService=c;this._editorService=g;this._labelService=_;this.domNode=document.createElement("div"),this.domNode.classList.add("breadcrumbs-control"),E.append(e,this.domNode),this._cfUseQuickPick=k.UseQuickPick.bindTo(m),this._cfShowIcons=k.Icons.bindTo(m),this._cfTitleScrollbarSizing=k.TitleScrollbarSizing.bindTo(m),this._labels=this._instantiationService.createInstance(pe,he);const b=this._cfTitleScrollbarSizing.getValue()??"default",w=t.widgetStyles??Ee;this._widget=new ie(this.domNode,o.SCROLLBAR_SIZES[b],Pe,w),this._widget.onDidSelectItem(this._onSelectEvent,this,this._disposables),this._widget.onDidFocusItem(this._onFocusEvent,this,this._disposables),this._widget.onDidChangeFocus(this._updateCkBreadcrumbsActive,this,this._disposables),this._ckBreadcrumbsPossible=o.CK_BreadcrumbsPossible.bindTo(this._contextKeyService),this._ckBreadcrumbsVisible=o.CK_BreadcrumbsVisible.bindTo(this._contextKeyService),this._ckBreadcrumbsActive=o.CK_BreadcrumbsActive.bindTo(this._contextKeyService),this._hoverDelegate=Be("mouse"),this._disposables.add(p.register(this._editorGroup.id,this._widget)),this.hide()}static HEIGHT=22;static SCROLLBAR_SIZES={default:3,large:8};static Payload_Reveal={};static Payload_RevealAside={};static Payload_Pick={};static CK_BreadcrumbsPossible=new G("breadcrumbsPossible",!1,S("breadcrumbsPossible","Whether the editor can show breadcrumbs"));static CK_BreadcrumbsVisible=new G("breadcrumbsVisible",!1,S("breadcrumbsVisible","Whether breadcrumbs are currently visible"));static CK_BreadcrumbsActive=new G("breadcrumbsActive",!1,S("breadcrumbsActive","Whether breadcrumbs have focus"));_ckBreadcrumbsPossible;_ckBreadcrumbsVisible;_ckBreadcrumbsActive;_cfUseQuickPick;_cfShowIcons;_cfTitleScrollbarSizing;domNode;_widget;_disposables=new B;_breadcrumbsDisposables=new B;_labels;_model=new oe;_breadcrumbsPickerShowing=!1;_breadcrumbsPickerIgnoreOnceItem;_hoverDelegate;_onDidVisibilityChange=this._disposables.add(new z);get onDidVisibilityChange(){return this._onDidVisibilityChange.event}dispose(){this._disposables.dispose(),this._breadcrumbsDisposables.dispose(),this._ckBreadcrumbsPossible.reset(),this._ckBreadcrumbsVisible.reset(),this._ckBreadcrumbsActive.reset(),this._cfUseQuickPick.dispose(),this._cfShowIcons.dispose(),this._widget.dispose(),this._labels.dispose(),this.domNode.remove()}get model(){return this._model.value}layout(e){this._widget.layout(e)}isHidden(){return this.domNode.classList.contains("hidden")}hide(){const e=this.isHidden();this._breadcrumbsDisposables.clear(),this._ckBreadcrumbsVisible.set(!1),this.domNode.classList.toggle("hidden",!0),e||this._onDidVisibilityChange.fire()}show(){const e=this.isHidden();this._ckBreadcrumbsVisible.set(!0),this.domNode.classList.toggle("hidden",!1),e&&this._onDidVisibilityChange.fire()}revealLast(){this._widget.revealLast()}update(){this._breadcrumbsDisposables.clear();const e=Z.getCanonicalUri(this._editorGroup.activeEditor,{supportSideBySide:j.PRIMARY}),t=this.isHidden();if(!e||!this._fileService.hasProvider(e))return this._ckBreadcrumbsPossible.set(!1),t?!1:(this.hide(),!0);const i=Z.getOriginalUri(this._editorGroup.activeEditor,{supportSideBySide:j.PRIMARY});this.show(),this._ckBreadcrumbsPossible.set(!0);const r=this._instantiationService.createInstance(ge,i??e,this._editorGroup.activeEditorPane);this._model.value=r,this.domNode.classList.toggle("backslash-path",this._labelService.getSeparator(e.scheme,e.authority)==="\\");const d=()=>{this.domNode.classList.toggle("relative-path",r.isRelative());const _=this._cfShowIcons.getValue(),m={...this._options,showFileIcons:this._options.showFileIcons&&_,showSymbolIcons:this._options.showSymbolIcons&&_},p=r.getElements().map(b=>b instanceof Q?new x(r,b,m,this._labels,this._hoverDelegate):new V(r,b,m));p.length===0?(this._widget.setEnabled(!1),this._widget.setItems([new class extends R{render(b){b.innerText=S("empty","no elements")}equals(b){return b===this}dispose(){}}])):(this._widget.setEnabled(!0),this._widget.setItems(p),this._widget.reveal(p[p.length-1]))},n=r.onDidUpdate(d),l=this._cfShowIcons.onDidChange(d);d(),this._breadcrumbsDisposables.clear(),this._breadcrumbsDisposables.add(n),this._breadcrumbsDisposables.add(F(()=>this._model.clear())),this._breadcrumbsDisposables.add(l),this._breadcrumbsDisposables.add(F(()=>this._widget.setItems([])));const c=()=>{const _=this._cfTitleScrollbarSizing.getValue()??"default";this._widget.setHorizontalScrollbarSize(o.SCROLLBAR_SIZES[_])};c();const g=this._cfTitleScrollbarSizing.onDidChange(c);return this._breadcrumbsDisposables.add(g),this._breadcrumbsDisposables.add({dispose:()=>{this._breadcrumbsPickerShowing&&this._contextViewService.hideContextView({source:this})}}),t!==this.isHidden()}_onFocusEvent(e){e.item&&this._breadcrumbsPickerShowing&&(this._breadcrumbsPickerIgnoreOnceItem=void 0,this._widget.setSelection(e.item))}_onSelectEvent(e){if(!e.item)return;if(e.item===this._breadcrumbsPickerIgnoreOnceItem){this._breadcrumbsPickerIgnoreOnceItem=void 0,this._widget.setFocused(void 0),this._widget.setSelection(void 0);return}const{element:t}=e.item;this._editorGroup.focus();const i=this._getEditorGroup(e.payload);if(i!==void 0){this._widget.setFocused(void 0),this._widget.setSelection(void 0),this._revealInEditor(e,t,i);return}if(this._cfUseQuickPick.getValue()){this._widget.setFocused(void 0),this._widget.setSelection(void 0),this._quickInputService.quickAccess.show(t instanceof _e?"@":"");return}let r,d;this._contextViewService.showContextView({render:n=>{e.item instanceof x?r=this._instantiationService.createInstance(fe,n,e.item.model.resource):e.item instanceof V&&(r=this._instantiationService.createInstance(ve,n,e.item.model.resource));const l=r.onWillPickElement(()=>this._contextViewService.hideContextView({source:this,didPick:!0})),c=ye.getInstance(E.getWindow(this.domNode)).onDidChange(()=>this._contextViewService.hideContextView({source:this})),g=E.trackFocus(n),_=g.onDidBlur(()=>{this._breadcrumbsPickerIgnoreOnceItem=this._widget.isDOMFocused()?e.item:void 0,this._contextViewService.hideContextView({source:this})});return this._breadcrumbsPickerShowing=!0,this._updateCkBreadcrumbsActive(),se(r,l,c,g,_)},getAnchor:()=>{if(!d){const n=E.getWindow(this.domNode),l=n.innerWidth-8;let c=Math.min(n.innerHeight*.7,300);const g=Math.min(l,Math.max(240,l/4.17)),_=8;let m;const p=E.getDomNodePagePosition(e.node.firstChild),b=p.top+p.height+_;b+c>=n.innerHeight&&(c=n.innerHeight-b-30);let w=p.left;if(w+g>=l&&(w=l-g),e.payload instanceof ee){const K=g-2*_;m=e.payload.posx-w,m>K&&(w=Math.min(l-g,w+m-K),m=K)}else m=p.left+p.width*.3-w;r.show(t,c,g,_,Math.max(0,m)),d={x:w,y:b}}return d},onHide:n=>{n?.didPick||r.restoreViewState(),this._breadcrumbsPickerShowing=!1,this._updateCkBreadcrumbsActive(),n?.source===this&&(this._widget.setFocused(void 0),this._widget.setSelection(void 0)),r.dispose()}})}_updateCkBreadcrumbsActive(){const e=this._widget.isDOMFocused()||this._breadcrumbsPickerShowing;this._ckBreadcrumbsActive.set(e)}async _revealInEditor(e,t,i,r=!1){if(t instanceof Q)if(t.kind===H.FILE)await this._editorService.openEditor({resource:t.uri,options:{pinned:r}},i);else{const d=this._widget.getItems(),n=d.indexOf(e.item);this._widget.setFocused(d[n+1]),this._widget.setSelection(d[n+1],o.Payload_Pick)}else t.outline.reveal(t,{pinned:r},i===U,!1)}_getEditorGroup(e){return e===o.Payload_RevealAside?U:e===o.Payload_Reveal?we:void 0}};o=T([h(3,ae),h(4,ce),h(5,M),h(6,be),h(7,Y),h(8,$),h(9,Ie),h(10,A),h(11,I)],o);let D=class{constructor(e,t,i,r,d,n){this._container=e;this._editorGroup=t;this._options=i;this._instantiationService=d;const l=this._disposables.add(k.IsEnabled.bindTo(r));this._disposables.add(l.onDidChange(()=>{const c=l.getValue();!c&&this._control?(this._controlDisposables.clear(),this._control=void 0,this._onDidEnablementChange.fire()):c&&!this._control&&(this._control=this.createControl(),this._control.update(),this._onDidEnablementChange.fire())})),l.getValue()&&(this._control=this.createControl()),this._disposables.add(n.onDidChangeFileSystemProviderRegistrations(c=>{this._control?.model&&this._control.model.resource.scheme!==c.scheme||this._control?.update()&&this._onDidEnablementChange.fire()}))}_disposables=new B;_controlDisposables=new B;_control;get control(){return this._control}_onDidEnablementChange=this._disposables.add(new z);get onDidEnablementChange(){return this._onDidEnablementChange.event}_onDidVisibilityChange=this._disposables.add(new z);get onDidVisibilityChange(){return this._onDidVisibilityChange.event}createControl(){const e=this._controlDisposables.add(this._instantiationService.createInstance(o,this._container,this._options,this._editorGroup));return this._controlDisposables.add(e.onDidVisibilityChange(()=>this._onDidVisibilityChange.fire())),e}dispose(){this._disposables.dispose(),this._controlDisposables.dispose()}};D=T([h(3,A),h(4,M),h(5,Y)],D),W(class extends O{constructor(){super({id:"breadcrumbs.toggle",title:{...L("cmd.toggle","Toggle Breadcrumbs"),mnemonicTitle:S({key:"miBreadcrumbs",comment:["&& denotes a mnemonic"]},"Toggle &&Breadcrumbs")},category:Se.View,toggled:{condition:v.equals("config.breadcrumbs.enabled",!0),title:S("cmd.toggle2","Toggle Breadcrumbs"),mnemonicTitle:S({key:"miBreadcrumbs2",comment:["&& denotes a mnemonic"]},"Toggle &&Breadcrumbs")},menu:[{id:P.CommandPalette},{id:P.MenubarAppearanceMenu,group:"4_editor",order:2},{id:P.NotebookToolbar,group:"notebookLayout",order:2},{id:P.StickyScrollContext},{id:P.NotebookStickyScrollContext,group:"notebookView",order:2}]})}run(e){const t=e.get(A),i=k.IsEnabled.bindTo(t).getValue();k.IsEnabled.bindTo(t).updateValue(!i)}});function q(s,e){const t=s.get(C),r=s.get(I).getWidget(t.activeGroup.id);if(r){const d=te(r.getItems());r.setFocused(d),e&&r.setSelection(d,o.Payload_Pick)}}W(class extends O{constructor(){super({id:"breadcrumbs.focusAndSelect",title:L("cmd.focusAndSelect","Focus and Select Breadcrumbs"),precondition:o.CK_BreadcrumbsVisible,keybinding:{weight:f.WorkbenchContrib,primary:u.CtrlCmd|u.Shift|a.Period,when:o.CK_BreadcrumbsPossible},f1:!0})}run(e,...t){q(e,!0)}}),W(class extends O{constructor(){super({id:"breadcrumbs.focus",title:L("cmd.focus","Focus Breadcrumbs"),precondition:o.CK_BreadcrumbsVisible,keybinding:{weight:f.WorkbenchContrib,primary:u.CtrlCmd|u.Shift|a.Semicolon,when:o.CK_BreadcrumbsPossible},f1:!0})}run(e,...t){q(e,!1)}}),y.registerCommandAndKeybindingRule({id:"breadcrumbs.toggleToOn",weight:f.WorkbenchContrib,primary:u.CtrlCmd|u.Shift|a.Period,when:v.not("config.breadcrumbs.enabled"),handler:async s=>{const e=s.get(M),t=s.get(A),i=k.IsEnabled.bindTo(t);return i.getValue()||(await i.updateValue(!0),await re(50)),e.invokeFunction(q,!0)}}),y.registerCommandAndKeybindingRule({id:"breadcrumbs.focusNext",weight:f.WorkbenchContrib,primary:a.RightArrow,secondary:[u.CtrlCmd|a.RightArrow],mac:{primary:a.RightArrow,secondary:[u.Alt|a.RightArrow]},when:v.and(o.CK_BreadcrumbsVisible,o.CK_BreadcrumbsActive),handler(s){const e=s.get(C),i=s.get(I).getWidget(e.activeGroup.id);i&&i.focusNext()}}),y.registerCommandAndKeybindingRule({id:"breadcrumbs.focusPrevious",weight:f.WorkbenchContrib,primary:a.LeftArrow,secondary:[u.CtrlCmd|a.LeftArrow],mac:{primary:a.LeftArrow,secondary:[u.Alt|a.LeftArrow]},when:v.and(o.CK_BreadcrumbsVisible,o.CK_BreadcrumbsActive),handler(s){const e=s.get(C),i=s.get(I).getWidget(e.activeGroup.id);i&&i.focusPrev()}}),y.registerCommandAndKeybindingRule({id:"breadcrumbs.focusNextWithPicker",weight:f.WorkbenchContrib+1,primary:u.CtrlCmd|a.RightArrow,mac:{primary:u.Alt|a.RightArrow},when:v.and(o.CK_BreadcrumbsVisible,o.CK_BreadcrumbsActive,N),handler(s){const e=s.get(C),i=s.get(I).getWidget(e.activeGroup.id);i&&i.focusNext()}}),y.registerCommandAndKeybindingRule({id:"breadcrumbs.focusPreviousWithPicker",weight:f.WorkbenchContrib+1,primary:u.CtrlCmd|a.LeftArrow,mac:{primary:u.Alt|a.LeftArrow},when:v.and(o.CK_BreadcrumbsVisible,o.CK_BreadcrumbsActive,N),handler(s){const e=s.get(C),i=s.get(I).getWidget(e.activeGroup.id);i&&i.focusPrev()}}),y.registerCommandAndKeybindingRule({id:"breadcrumbs.selectFocused",weight:f.WorkbenchContrib,primary:a.Enter,secondary:[a.DownArrow],when:v.and(o.CK_BreadcrumbsVisible,o.CK_BreadcrumbsActive),handler(s){const e=s.get(C),i=s.get(I).getWidget(e.activeGroup.id);i&&i.setSelection(i.getFocused(),o.Payload_Pick)}}),y.registerCommandAndKeybindingRule({id:"breadcrumbs.revealFocused",weight:f.WorkbenchContrib,primary:a.Space,secondary:[u.CtrlCmd|a.Enter],when:v.and(o.CK_BreadcrumbsVisible,o.CK_BreadcrumbsActive),handler(s){const e=s.get(C),i=s.get(I).getWidget(e.activeGroup.id);i&&i.setSelection(i.getFocused(),o.Payload_Reveal)}}),y.registerCommandAndKeybindingRule({id:"breadcrumbs.selectEditor",weight:f.WorkbenchContrib+1,primary:a.Escape,when:v.and(o.CK_BreadcrumbsVisible,o.CK_BreadcrumbsActive),handler(s){const e=s.get(C),i=s.get(I).getWidget(e.activeGroup.id);i&&(i.setFocused(void 0),i.setSelection(void 0),e.activeGroup.activeEditorPane?.focus())}}),y.registerCommandAndKeybindingRule({id:"breadcrumbs.revealFocusedFromTreeAside",weight:f.WorkbenchContrib,primary:u.CtrlCmd|a.Enter,when:v.and(o.CK_BreadcrumbsVisible,o.CK_BreadcrumbsActive,N),handler(s){const e=s.get($),i=s.get(le).lastFocusedList;if(!(i instanceof me)&&!(i instanceof ue))return;const r=i.getFocus()[0];if(de.isUri(r?.resource))return e.openEditor({resource:r.resource,options:{pinned:!0}},U);const d=i.getInput();if(d&&typeof d.outlineKind=="string")return d.reveal(r,{pinned:!0,preserveFocus:!1},!0,!1)}});export{o as BreadcrumbsControl,D as BreadcrumbsControlFactory};
