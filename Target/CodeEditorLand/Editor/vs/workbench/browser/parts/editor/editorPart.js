var ie=Object.defineProperty;var te=Object.getOwnPropertyDescriptor;var P=(f,p,e,i)=>{for(var t=i>1?void 0:i?te(p,e):p,r=f.length-1,o;r>=0;r--)(o=f[r])&&(t=(i?o(p,e,t):o(t))||t);return i&&t&&ie(p,e,t),t},h=(f,p)=>(e,i)=>p(e,i,f);import{IThemeService as F}from"../../../../platform/theme/common/themeService.js";import{Part as re}from"../../part.js";import{Dimension as oe,$ as ne,EventHelper as se,addDisposableGenericMouseDownListener as de,getWindow as W,isAncestorOfActiveElement as ae,getActiveElement as ue,isHTMLElement as pe}from"../../../../base/browser/dom.js";import{Event as V,Emitter as l,Relay as b,PauseableEmitter as H}from"../../../../base/common/event.js";import{contrastBorder as he,editorBackground as ce}from"../../../../platform/theme/common/colorRegistry.js";import{GroupDirection as A,GroupsArrangement as m,GroupOrientation as w,MergeGroupMode as ge,GroupsOrder as c,GroupLocation as y}from"../../../services/editor/common/editorGroupsService.js";import{IInstantiationService as B}from"../../../../platform/instantiation/common/instantiation.js";import{orthogonal as le,LayoutPriority as Ge,Direction as C,SerializableGrid as U,Sizing as L,Orientation as S,isGridBranchNode as x,createSerializedGrid as me}from"../../../../base/browser/ui/grid/grid.js";import{GroupModelChangeKind as z}from"../../../common/editor.js";import{EDITOR_GROUP_BORDER as ve,EDITOR_PANE_BACKGROUND as fe}from"../../../common/theme.js";import{distinct as Ee,coalesce as Ie}from"../../../../base/common/arrays.js";import{getEditorPartOptions as k,impactsEditorPartOptions as we}from"./editor.js";import{EditorGroupView as R}from"./editorGroupView.js";import{IConfigurationService as K}from"../../../../platform/configuration/common/configuration.js";import{dispose as ye,toDisposable as Se,DisposableStore as Y}from"../../../../base/common/lifecycle.js";import{IStorageService as X,StorageScope as T,StorageTarget as Z}from"../../../../platform/storage/common/storage.js";import{isSerializedEditorGroupModel as De}from"../../../common/editor/editorGroupModel.js";import{EditorDropTarget as Ve}from"./editorDropTarget.js";import{Color as j}from"../../../../base/common/color.js";import{CenteredViewLayout as _e}from"../../../../base/browser/ui/centered/centeredViewLayout.js";import{onUnexpectedError as Ae}from"../../../../base/common/errors.js";import{Parts as D,IWorkbenchLayoutService as J,Position as v}from"../../../services/layout/browser/layoutService.js";import{assertIsDefined as $,assertType as Ce}from"../../../../base/common/types.js";import{CompositeDragAndDropObserver as q}from"../../dnd.js";import{DeferredPromise as Q,Promises as Re}from"../../../../base/common/async.js";import{findGroup as Te}from"../../../services/editor/common/editorGroupFinder.js";import{SIDE_GROUP as Oe}from"../../../services/editor/common/editorService.js";import"../../../../base/browser/ui/sash/sash.js";import{IHostService as ee}from"../../../services/host/browser/host.js";import{IContextKeyService as M}from"../../../../platform/contextkey/common/contextkey.js";import{ServiceCollection as Pe}from"../../../../platform/instantiation/common/serviceCollection.js";import{EditorPartMaximizedEditorGroupContext as We,EditorPartMultipleEditorGroupsContext as be,IsAuxiliaryEditorPartContext as Le}from"../../../common/contextkeys.js";import{mainWindow as N}from"../../../../base/browser/window.js";class xe{element=ne(".grid-view-container");get minimumWidth(){return this.gridWidget?this.gridWidget.minimumWidth:0}get maximumWidth(){return this.gridWidget?this.gridWidget.maximumWidth:Number.POSITIVE_INFINITY}get minimumHeight(){return this.gridWidget?this.gridWidget.minimumHeight:0}get maximumHeight(){return this.gridWidget?this.gridWidget.maximumHeight:Number.POSITIVE_INFINITY}_onDidChange=new b;onDidChange=this._onDidChange.event;_gridWidget;get gridWidget(){return this._gridWidget}set gridWidget(p){this.element.innerText="",p?(this.element.appendChild(p.element),this._onDidChange.input=p.onDidChange):this._onDidChange.input=V.None,this._gridWidget=p}layout(p,e,i,t){this.gridWidget?.layout(p,e,i,t)}dispose(){this._onDidChange.dispose()}}let g=class extends re{constructor(e,i,t,r,o,s,n,u,d,a,E){super(i,{hasTitle:!1},s,u,d);this.editorPartsView=e;this.groupsLabel=t;this.windowId=r;this.instantiationService=o;this.configurationService=n;this.hostService=a;this.contextKeyService=E;this.registerListeners()}static EDITOR_PART_UI_STATE_STORAGE_KEY="editorpart.state";static EDITOR_PART_CENTERED_VIEW_STORAGE_KEY="editorpart.centeredview";_onDidFocus=this._register(new l);onDidFocus=this._onDidFocus.event;_onDidLayout=this._register(new l);onDidLayout=this._onDidLayout.event;_onDidChangeActiveGroup=this._register(new l);onDidChangeActiveGroup=this._onDidChangeActiveGroup.event;_onDidChangeGroupIndex=this._register(new l);onDidChangeGroupIndex=this._onDidChangeGroupIndex.event;_onDidChangeGroupLabel=this._register(new l);onDidChangeGroupLabel=this._onDidChangeGroupLabel.event;_onDidChangeGroupLocked=this._register(new l);onDidChangeGroupLocked=this._onDidChangeGroupLocked.event;_onDidChangeGroupMaximized=this._register(new l);onDidChangeGroupMaximized=this._onDidChangeGroupMaximized.event;_onDidActivateGroup=this._register(new l);onDidActivateGroup=this._onDidActivateGroup.event;_onDidAddGroup=this._register(new H);onDidAddGroup=this._onDidAddGroup.event;_onDidRemoveGroup=this._register(new H);onDidRemoveGroup=this._onDidRemoveGroup.event;_onDidMoveGroup=this._register(new l);onDidMoveGroup=this._onDidMoveGroup.event;onDidSetGridWidget=this._register(new l);_onDidChangeSizeConstraints=this._register(new b);onDidChangeSizeConstraints=V.any(this.onDidSetGridWidget.event,this._onDidChangeSizeConstraints.event);_onDidScroll=this._register(new b);onDidScroll=V.any(this.onDidSetGridWidget.event,this._onDidScroll.event);_onDidChangeEditorPartOptions=this._register(new l);onDidChangeEditorPartOptions=this._onDidChangeEditorPartOptions.event;_onWillDispose=this._register(new l);onWillDispose=this._onWillDispose.event;workspaceMemento=this.getMemento(T.WORKSPACE,Z.USER);profileMemento=this.getMemento(T.PROFILE,Z.MACHINE);groupViews=new Map;mostRecentActiveGroups=[];container;scopedInstantiationService;centeredLayoutWidget;gridWidget;gridWidgetDisposables=this._register(new Y);gridWidgetView=this._register(new xe);registerListeners(){this._register(this.configurationService.onDidChangeConfiguration(e=>this.onConfigurationUpdated(e))),this._register(this.themeService.onDidFileIconThemeChange(()=>this.handleChangedPartOptions())),this._register(this.onDidChangeMementoValue(T.WORKSPACE,this._store)(e=>this.onDidChangeMementoState(e)))}onConfigurationUpdated(e){we(e)&&this.handleChangedPartOptions()}handleChangedPartOptions(){const e=this._partOptions,i=k(this.configurationService,this.themeService);for(const t of this.enforcedPartOptions)Object.assign(i,t);this._partOptions=i,this._onDidChangeEditorPartOptions.fire({oldPartOptions:e,newPartOptions:i})}enforcedPartOptions=[];_partOptions=k(this.configurationService,this.themeService);get partOptions(){return this._partOptions}enforcePartOptions(e){return this.enforcedPartOptions.push(e),this.handleChangedPartOptions(),Se(()=>{this.enforcedPartOptions.splice(this.enforcedPartOptions.indexOf(e),1),this.handleChangedPartOptions()})}top=0;left=0;_contentDimension;get contentDimension(){return this._contentDimension}_activeGroup;get activeGroup(){return this._activeGroup}sideGroup={openEditor:(e,i)=>{const[t]=this.scopedInstantiationService.invokeFunction(r=>Te(r,{editor:e,options:i},Oe));return t.openEditor(e,i)}};get groups(){return Array.from(this.groupViews.values())}get count(){return this.groupViews.size}get orientation(){return this.gridWidget&&this.gridWidget.orientation===S.VERTICAL?w.VERTICAL:w.HORIZONTAL}_isReady=!1;get isReady(){return this._isReady}whenReadyPromise=new Q;whenReady=this.whenReadyPromise.p;whenRestoredPromise=new Q;whenRestored=this.whenRestoredPromise.p;get hasRestorableState(){return!!this.workspaceMemento[g.EDITOR_PART_UI_STATE_STORAGE_KEY]}_willRestoreState=!1;get willRestoreState(){return this._willRestoreState}getGroups(e=c.CREATION_TIME){switch(e){case c.CREATION_TIME:return this.groups;case c.MOST_RECENTLY_ACTIVE:{const i=Ie(this.mostRecentActiveGroups.map(t=>this.getGroup(t)));return Ee([...i,...this.groups])}case c.GRID_APPEARANCE:{const i=[];return this.gridWidget&&this.fillGridNodes(i,this.gridWidget.getViews()),i}}}fillGridNodes(e,i){x(i)?i.children.forEach(t=>this.fillGridNodes(e,t)):e.push(i.view)}hasGroup(e){return this.groupViews.has(e)}getGroup(e){return this.groupViews.get(e)}findGroup(e,i=this.activeGroup,t){if(typeof e.direction=="number")return this.doFindGroupByDirection(e.direction,i,t);if(typeof e.location=="number")return this.doFindGroupByLocation(e.location,i,t);throw new Error("invalid arguments")}doFindGroupByDirection(e,i,t){const r=this.assertGroupView(i),o=this.gridWidget.getNeighborViews(r,this.toGridViewDirection(e),t);return o.sort((s,n)=>this.mostRecentActiveGroups.indexOf(s.id)-this.mostRecentActiveGroups.indexOf(n.id)),o[0]}doFindGroupByLocation(e,i,t){const r=this.assertGroupView(i),o=this.getGroups(c.GRID_APPEARANCE),s=o.indexOf(r);switch(e){case y.FIRST:return o[0];case y.LAST:return o[o.length-1];case y.NEXT:{let n=o[s+1];return!n&&t&&(n=this.doFindGroupByLocation(y.FIRST,i)),n}case y.PREVIOUS:{let n=o[s-1];return!n&&t&&(n=this.doFindGroupByLocation(y.LAST,i)),n}}}activateGroup(e,i){const t=this.assertGroupView(e);return this.doSetGroupActive(t),i||this.hostService.moveTop(W(this.element)),t}restoreGroup(e){const i=this.assertGroupView(e);return this.doRestoreGroup(i),i}getSize(e){const i=this.assertGroupView(e);return this.gridWidget.getViewSize(i)}setSize(e,i){const t=this.assertGroupView(e);this.gridWidget.resizeView(t,i)}arrangeGroups(e,i=this.activeGroup){if(this.count<2||!this.gridWidget)return;const t=this.assertGroupView(i);switch(e){case m.EVEN:this.gridWidget.distributeViewSizes();break;case m.MAXIMIZE:if(this.groups.length<2)return;this.gridWidget.maximizeView(t),t.focus();break;case m.EXPAND:this.gridWidget.expandView(t);break}}toggleMaximizeGroup(e=this.activeGroup){this.hasMaximizedGroup()?this.unmaximizeGroup():this.arrangeGroups(m.MAXIMIZE,e)}toggleExpandGroup(e=this.activeGroup){this.isGroupExpanded(this.activeGroup)?this.arrangeGroups(m.EVEN):this.arrangeGroups(m.EXPAND,e)}unmaximizeGroup(){this.gridWidget.exitMaximizedView(),this._activeGroup.focus()}hasMaximizedGroup(){return this.gridWidget.hasMaximizedView()}isGroupMaximized(e){return this.gridWidget.isViewMaximized(e)}isGroupExpanded(e){return this.gridWidget.isViewExpanded(e)}setGroupOrientation(e){if(!this.gridWidget)return;const i=e===w.HORIZONTAL?S.HORIZONTAL:S.VERTICAL;this.gridWidget.orientation!==i&&(this.gridWidget.orientation=i)}applyLayout(e){const i=this.shouldRestoreFocus(this.container);let t=0;function r(u){for(const d of u)Array.isArray(d.groups)?r(d.groups):t++}r(e.groups);let o=this.getGroups(c.GRID_APPEARANCE);if(t<o.length){const u=o[t-1];o.forEach((d,a)=>{a>=t&&this.mergeGroup(d,u)}),o=this.getGroups(c.GRID_APPEARANCE)}const s=this.activeGroup,n=me({orientation:this.toGridViewOrientation(e.orientation,this.isTwoDimensionalGrid()?this.gridWidget.orientation:le(this.gridWidget.orientation)),groups:e.groups});this.doApplyGridState(n,s.id,o),i&&this._activeGroup.focus()}getLayout(){const e=this.gridWidget.serialize(),i=e.orientation===S.HORIZONTAL?w.HORIZONTAL:w.VERTICAL,t=this.serializedNodeToGroupLayoutArgument(e.root);return{orientation:i,groups:t.groups}}serializedNodeToGroupLayoutArgument(e){return e.type==="branch"?{size:e.size,groups:e.data.map(i=>this.serializedNodeToGroupLayoutArgument(i))}:{size:e.size}}shouldRestoreFocus(e){return e?ue()===e.ownerDocument.body?!0:ae(e):!1}isTwoDimensionalGrid(){const e=this.gridWidget.getViews();return x(e)?e.children.some(i=>x(i)):!1}addGroup(e,i,t){const r=this.assertGroupView(e);let o;if(r.groupsView===this){const s=this.shouldRestoreFocus(r.element),n=this.groupViews.size>1&&this.isGroupExpanded(r);o=this.doCreateGroupView(t),this.gridWidget.addView(o,this.getSplitSizingStyle(),r,this.toGridViewDirection(i)),this.updateContainer(),this._onDidAddGroup.fire(o),this.notifyGroupIndexChange(),n&&this.arrangeGroups(m.EXPAND,o),s&&r.focus()}else o=r.groupsView.addGroup(r,i,t);return o}getSplitSizingStyle(){switch(this._partOptions.splitSizing){case"distribute":return L.Distribute;case"split":return L.Split;default:return L.Auto}}doCreateGroupView(e,i){let t;e instanceof R?t=R.createCopy(e,this.editorPartsView,this,this.groupsLabel,this.count,this.scopedInstantiationService,i):De(e)?t=R.createFromSerialized(e,this.editorPartsView,this,this.groupsLabel,this.count,this.scopedInstantiationService,i):t=R.createNew(this.editorPartsView,this,this.groupsLabel,this.count,this.scopedInstantiationService,i),this.groupViews.set(t.id,t);const r=new Y;return r.add(t.onDidFocus(()=>{this.doSetGroupActive(t),this._onDidFocus.fire()})),r.add(t.onDidModelChange(o=>{switch(o.kind){case z.GROUP_LOCKED:this._onDidChangeGroupLocked.fire(t);break;case z.GROUP_INDEX:this._onDidChangeGroupIndex.fire(t);break;case z.GROUP_LABEL:this._onDidChangeGroupLabel.fire(t);break}})),r.add(t.onDidActiveEditorChange(()=>{this.updateContainer()})),V.once(t.onWillDispose)(()=>{ye(r),this.groupViews.delete(t.id),this.doUpdateMostRecentActive(t)}),t}doSetGroupActive(e){if(this._activeGroup!==e){const i=this._activeGroup;this._activeGroup=e,this.doUpdateMostRecentActive(e,!0),i&&!i.disposed&&i.setActive(!1),e.setActive(!0),this.doRestoreGroup(e),this._onDidChangeActiveGroup.fire(e)}this._onDidActivateGroup.fire(e)}doRestoreGroup(e){if(this.gridWidget){this.hasMaximizedGroup()&&!this.isGroupMaximized(e)&&this.unmaximizeGroup();try{const i=this.gridWidget.getViewSize(e);(i.width===e.minimumWidth||i.height===e.minimumHeight)&&this.arrangeGroups(m.EXPAND,e)}catch{}}}doUpdateMostRecentActive(e,i){const t=this.mostRecentActiveGroups.indexOf(e.id);t!==-1&&this.mostRecentActiveGroups.splice(t,1),i&&this.mostRecentActiveGroups.unshift(e.id)}toGridViewDirection(e){switch(e){case A.UP:return C.Up;case A.DOWN:return C.Down;case A.LEFT:return C.Left;case A.RIGHT:return C.Right}}toGridViewOrientation(e,i){return typeof e=="number"?e===w.HORIZONTAL?S.HORIZONTAL:S.VERTICAL:i}removeGroup(e,i){const t=this.assertGroupView(e);this.count!==1&&(t.isEmpty?this.doRemoveEmptyGroup(t,i):this.doRemoveGroupWithEditors(t))}doRemoveGroupWithEditors(e){const i=this.getGroups(c.MOST_RECENTLY_ACTIVE);let t;this._activeGroup===e?t=i[1]:t=i[0],this.mergeGroup(e,t)}doRemoveEmptyGroup(e,i){const t=!i&&this.shouldRestoreFocus(this.container);if(this._activeGroup===e){const o=this.getGroups(c.MOST_RECENTLY_ACTIVE)[1];this.doSetGroupActive(o)}this.gridWidget.removeView(e,this.getSplitSizingStyle()),e.dispose(),t&&this._activeGroup.focus(),this.notifyGroupIndexChange(),this.updateContainer(),this._onDidRemoveGroup.fire(e)}moveGroup(e,i,t){const r=this.assertGroupView(e),o=this.assertGroupView(i);if(r.id===o.id)throw new Error("Cannot move group into its own");const s=this.shouldRestoreFocus(r.element);let n;return r.groupsView===o.groupsView?(this.gridWidget.moveView(r,this.getSplitSizingStyle(),o,this.toGridViewDirection(t)),n=r):(n=o.groupsView.addGroup(o,t,r),r.closeAllEditors(),this.removeGroup(r,s)),s&&n.focus(),this._onDidMoveGroup.fire(n),this.notifyGroupIndexChange(),n}copyGroup(e,i,t){const r=this.assertGroupView(e),o=this.assertGroupView(i),s=this.shouldRestoreFocus(r.element),n=this.addGroup(o,t,r);return s&&n.focus(),n}mergeGroup(e,i,t){const r=this.assertGroupView(e),o=this.assertGroupView(i),s=[];let n=t&&typeof t.index=="number"?t.index:o.count;for(const d of r.editors){const a=!r.isActive(d)||this._activeGroup!==r,G={index:r.isSticky(d)?void 0:n,inactive:a,preserveFocus:a};s.push({editor:d,options:G}),n++}let u=!0;return t?.mode===ge.COPY_EDITORS?r.copyEditors(s,o):u=r.moveEditors(s,o),r.isEmpty&&!r.disposed&&this.removeGroup(r,!0),u}mergeAllGroups(e){const i=this.assertGroupView(e);let t=!0;for(const r of this.getGroups(c.MOST_RECENTLY_ACTIVE)){if(r===i)continue;this.mergeGroup(r,i)||(t=!1)}return t}assertGroupView(e){let i;if(typeof e=="number"?i=this.editorPartsView.getGroup(e):i=e,!i)throw new Error("Invalid editor group provided!");return i}createEditorDropTarget(e,i){return Ce(pe(e)),this.scopedInstantiationService.createInstance(Ve,e,i)}get minimumWidth(){return Math.min(this.centeredLayoutWidget.minimumWidth,this.layoutService.getMaximumEditorDimensions(this.layoutService.getContainer(W(this.container))).width)}get maximumWidth(){return this.centeredLayoutWidget.maximumWidth}get minimumHeight(){return Math.min(this.centeredLayoutWidget.minimumHeight,this.layoutService.getMaximumEditorDimensions(this.layoutService.getContainer(W(this.container))).height)}get maximumHeight(){return this.centeredLayoutWidget.maximumHeight}get snap(){return this.layoutService.getPanelAlignment()==="center"}get onDidChange(){return V.any(this.centeredLayoutWidget.onDidChange,this.onDidSetGridWidget.event)}priority=Ge.High;get gridSeparatorBorder(){return this.theme.getColor(ve)||this.theme.getColor(he)||j.transparent}updateStyles(){const e=$(this.container);e.style.backgroundColor=this.getColor(ce)||"";const i={separatorBorder:this.gridSeparatorBorder,background:this.theme.getColor(fe)||j.transparent};this.gridWidget.style(i),this.centeredLayoutWidget.styles(i)}createContentArea(e,i){this.element=e,this.container=document.createElement("div"),this.container.classList.add("content"),this.windowId!==N.vscodeWindowId&&this.container.classList.add("auxiliary"),e.appendChild(this.container);const t=this._register(this.contextKeyService.createScoped(this.container));return this.scopedInstantiationService=this._register(this.instantiationService.createChild(new Pe([M,t]))),this._willRestoreState=!i||i.restorePreviousState,this.doCreateGridControl(),this.centeredLayoutWidget=this._register(new _e(this.container,this.gridWidgetView,this.profileMemento[g.EDITOR_PART_CENTERED_VIEW_STORAGE_KEY],this._partOptions.centeredLayoutFixedWidth)),this._register(this.onDidChangeEditorPartOptions(r=>this.centeredLayoutWidget.setFixedWidth(r.newPartOptions.centeredLayoutFixedWidth??!1))),this.setupDragAndDropSupport(e,this.container),this.handleContextKeys(t),this.whenReadyPromise.complete(),this._isReady=!0,Re.settled(this.groups.map(r=>r.whenRestored)).finally(()=>{this.whenRestoredPromise.complete()}),this.container}handleContextKeys(e){Le.bindTo(e).set(this.windowId!==N.vscodeWindowId);const t=be.bindTo(e),r=We.bindTo(e),o=()=>{this.count>1?t.set(!0):t.reset(),this.hasMaximizedGroup()?r.set(!0):r.reset()};o(),this._register(this.onDidAddGroup(()=>o())),this._register(this.onDidRemoveGroup(()=>o())),this._register(this.onDidChangeGroupMaximized(()=>o()))}setupDragAndDropSupport(e,i){this._register(this.createEditorDropTarget(i,Object.create(null)));const t=document.createElement("div");t.classList.add("drop-block-overlay"),e.appendChild(t),this._register(de(t,()=>t.classList.remove("visible"))),this._register(q.INSTANCE.registerTarget(this.element,{onDragStart:a=>t.classList.add("visible"),onDragEnd:a=>t.classList.remove("visible")}));let r,o,s,n;const u=a=>{!this.layoutService.isVisible(D.PANEL_PART)&&a===this.layoutService.getPanelPosition()?this.layoutService.setPartHidden(!1,D.PANEL_PART):!this.layoutService.isVisible(D.AUXILIARYBAR_PART)&&a===(this.layoutService.getSideBarPosition()===v.RIGHT?v.LEFT:v.RIGHT)&&this.layoutService.setPartHidden(!1,D.AUXILIARYBAR_PART)},d=()=>{r&&(clearTimeout(r),r=void 0),o&&(clearTimeout(o),o=void 0)};this._register(q.INSTANCE.registerTarget(t,{onDragOver:a=>{se.stop(a.eventData,!0),a.eventData.dataTransfer&&(a.eventData.dataTransfer.dropEffect="none");const E=t.getBoundingClientRect();let G,I;const _=100;a.eventData.clientX<E.left+_&&(G=v.LEFT),a.eventData.clientX>E.right-_&&(G=v.RIGHT),a.eventData.clientY>E.bottom-_&&(I=v.BOTTOM),a.eventData.clientY<E.top+_&&(I=v.TOP),r&&G!==s&&(clearTimeout(r),r=void 0),o&&I!==n&&(clearTimeout(o),o=void 0),!r&&G!==void 0&&(s=G,r=setTimeout(()=>u(G),200)),!o&&I!==void 0&&(n=I,o=setTimeout(()=>u(I),200))},onDragLeave:()=>d(),onDragEnd:()=>d(),onDrop:()=>d()}))}centerLayout(e){this.centeredLayoutWidget.activate(e),this._activeGroup.focus()}isLayoutCentered(){return this.centeredLayoutWidget?this.centeredLayoutWidget.isActive():!1}doCreateGridControl(){let e=!1;if(this._willRestoreState&&(e=!this.doCreateGridControlWithPreviousState()),!this.gridWidget||e){const i=this.doCreateGroupView();this.doSetGridWidget(new U(i)),this.doSetGroupActive(i)}this.updateContainer(),this.notifyGroupIndexChange()}doCreateGridControlWithPreviousState(){const e=this.loadState();if(e?.serializedGrid)try{this.mostRecentActiveGroups=e.mostRecentActiveGroups,this.doCreateGridControlWithState(e.serializedGrid,e.activeGroup)}catch(i){return Ae(new Error(`Error restoring editor grid widget: ${i} (with state: ${JSON.stringify(e)})`)),this.disposeGroups(),!1}return!0}doCreateGridControlWithState(e,i,t,r){let o;t?o=t.slice(0):o=[];const s=[],n=U.deserialize(e,{fromJSON:u=>{let d;return o.length>0?d=o.shift():d=this.doCreateGroupView(u,r),s.push(d),d.id===i&&this.doSetGroupActive(d),d}},{styles:{separatorBorder:this.gridSeparatorBorder}});this._activeGroup||this.doSetGroupActive(s[0]),this.mostRecentActiveGroups.some(u=>!this.getGroup(u))&&(this.mostRecentActiveGroups=s.map(u=>u.id)),this.doSetGridWidget(n)}doSetGridWidget(e){let i={};this.gridWidget&&(i=this.gridWidget.boundarySashes,this.gridWidget.dispose()),this.gridWidget=e,this.gridWidget.boundarySashes=i,this.gridWidgetView.gridWidget=e,this._onDidChangeSizeConstraints.input=e.onDidChange,this._onDidScroll.input=e.onDidScroll,this.gridWidgetDisposables.clear(),this.gridWidgetDisposables.add(e.onDidChangeViewMaximized(t=>this._onDidChangeGroupMaximized.fire(t))),this._onDidChangeGroupMaximized.fire(this.hasMaximizedGroup()),this.onDidSetGridWidget.fire(void 0)}updateContainer(){$(this.container).classList.toggle("empty",this.isEmpty)}notifyGroupIndexChange(){this.getGroups(c.GRID_APPEARANCE).forEach((e,i)=>e.notifyIndexChanged(i))}notifyGroupsLabelChange(e){for(const i of this.groups)i.notifyLabelChanged(e)}get isEmpty(){return this.count===1&&this._activeGroup.isEmpty}setBoundarySashes(e){this.gridWidget.boundarySashes=e,this.centeredLayoutWidget.boundarySashes=e}layout(e,i,t,r){this.top=t,this.left=r;const o=super.layoutContents(e,i).contentSize;this.doLayout(oe.lift(o),t,r)}doLayout(e,i=this.top,t=this.left){this._contentDimension=e,this.centeredLayoutWidget.layout(this._contentDimension.width,this._contentDimension.height,i,t),this._onDidLayout.fire(e)}saveState(){if(this.gridWidget&&(this.isEmpty?delete this.workspaceMemento[g.EDITOR_PART_UI_STATE_STORAGE_KEY]:this.workspaceMemento[g.EDITOR_PART_UI_STATE_STORAGE_KEY]=this.createState()),this.centeredLayoutWidget){const e=this.centeredLayoutWidget.state;this.centeredLayoutWidget.isDefault(e)?delete this.profileMemento[g.EDITOR_PART_CENTERED_VIEW_STORAGE_KEY]:this.profileMemento[g.EDITOR_PART_CENTERED_VIEW_STORAGE_KEY]=e}super.saveState()}loadState(){return this.workspaceMemento[g.EDITOR_PART_UI_STATE_STORAGE_KEY]}createState(){return{serializedGrid:this.gridWidget.serialize(),activeGroup:this._activeGroup.id,mostRecentActiveGroups:this.mostRecentActiveGroups}}applyState(e,i){return e==="empty"?this.doApplyEmptyState():this.doApplyState(e,i)}async doApplyState(e,i){const t=await this.doPrepareApplyState();this._onDidAddGroup.pause(),this._onDidRemoveGroup.pause(),this.disposeGroups(),this.mostRecentActiveGroups=e.mostRecentActiveGroups;try{this.doApplyGridState(e.serializedGrid,e.activeGroup,void 0,i)}finally{this._onDidRemoveGroup.resume(),this._onDidAddGroup.resume()}await this.activeGroup.openEditors(t.flatMap(r=>r.editors).filter(r=>this.editorPartsView.groups.every(o=>!o.contains(r))).map(r=>({editor:r,options:{pinned:!0,preserveFocus:!0,inactive:!0}})))}async doApplyEmptyState(){await this.doPrepareApplyState(),this.mergeAllGroups(this.activeGroup)}async doPrepareApplyState(){const e=this.getGroups(c.MOST_RECENTLY_ACTIVE);for(const i of e)await i.closeAllEditors({excludeConfirming:!0});return e}doApplyGridState(e,i,t,r){this.doCreateGridControlWithState(e,i,t,r),this.doLayout(this._contentDimension),this.updateContainer();for(const o of this.getGroups(c.GRID_APPEARANCE))t?.includes(o)||this._onDidAddGroup.fire(o);this.notifyGroupIndexChange()}onDidChangeMementoState(e){if(e.external&&e.scope===T.WORKSPACE){this.reloadMemento(e.scope);const i=this.loadState();i&&this.applyState(i)}}toJSON(){return{type:D.EDITOR_PART}}disposeGroups(){for(const e of this.groups)e.dispose(),this._onDidRemoveGroup.fire(e);this.groupViews.clear(),this.mostRecentActiveGroups=[]}dispose(){this._onWillDispose.fire(),this.disposeGroups(),this.gridWidget?.dispose(),super.dispose()}};g=P([h(4,B),h(5,F),h(6,K),h(7,X),h(8,J),h(9,ee),h(10,M)],g);let O=class extends g{constructor(p,e,i,t,r,o,s,n){super(p,D.EDITOR_PART,"",N.vscodeWindowId,e,i,t,r,o,s,n)}};O=P([h(1,B),h(2,F),h(3,K),h(4,X),h(5,J),h(6,ee),h(7,M)],O);export{g as EditorPart,O as MainEditorPart};
