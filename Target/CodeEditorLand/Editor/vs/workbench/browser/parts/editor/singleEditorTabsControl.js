import"./media/singleeditortabscontrol.css";import{addDisposableListener as s,Dimension as b,DragAndDropObserver as v,EventHelper as n,EventType as d,isAncestor as E,isHTMLElement as m}from"../../../../base/browser/dom.js";import{Gesture as g,EventType as u}from"../../../../base/browser/touch.js";import{Color as f}from"../../../../base/common/color.js";import{toDisposable as C}from"../../../../base/common/lifecycle.js";import{equals as I}from"../../../../base/common/objects.js";import{assertAllDefined as L,assertIsDefined as p}from"../../../../base/common/types.js";import{defaultBreadcrumbsWidgetStyles as T}from"../../../../platform/theme/browser/defaultStyles.js";import{EditorCloseMethod as w,EditorResourceAccessor as A,preventEditorClose as D,SideBySideEditor as y,Verbosity as l}from"../../../common/editor.js";import"../../../common/editor/editorInput.js";import{TAB_ACTIVE_FOREGROUND as M,TAB_UNFOCUSED_ACTIVE_FOREGROUND as O}from"../../../common/theme.js";import{ResourceLabel as S}from"../../labels.js";import{BreadcrumbsControlFactory as _}from"./breadcrumbsControl.js";import{CLOSE_EDITOR_COMMAND_ID as B,UNLOCK_GROUP_COMMAND_ID as V}from"./editorCommands.js";import{EditorTabsControl as H}from"./editorTabsControl.js";import"./editorTitleControl.js";class ot extends H{titleContainer;editorLabel;activeLabel=Object.create(null);breadcrumbsControlFactory;get breadcrumbsControl(){return this.breadcrumbsControlFactory?.control}create(t){super.create(t);const e=this.titleContainer=t;e.draggable=!0,this.registerContainerListeners(e),this._register(g.addTarget(e));const r=document.createElement("div");r.classList.add("label-container"),e.appendChild(r),this.editorLabel=this._register(this.instantiationService.createInstance(S,r,{hoverDelegate:this.getHoverDelegate()})).element,this._register(s(this.editorLabel.element,d.CLICK,i=>this.onTitleLabelClick(i))),this.breadcrumbsControlFactory=this._register(this.instantiationService.createInstance(_,r,this.groupView,{showFileIcons:!1,showSymbolIcons:!0,showDecorationColors:!1,widgetStyles:{...T,breadcrumbsBackground:f.transparent.toString()},showPlaceholder:!1})),this._register(this.breadcrumbsControlFactory.onDidEnablementChange(()=>this.handleBreadcrumbsEnablementChange())),e.classList.toggle("breadcrumbs",!!this.breadcrumbsControl),this._register(C(()=>e.classList.remove("breadcrumbs"))),this.createEditorActionsToolBar(e,["title-actions"])}registerContainerListeners(t){let e,r=!1;this._register(new v(t,{onDragStart:i=>{r=this.onGroupDragStart(i,t)},onDrag:i=>{e=i},onDragEnd:i=>{this.onGroupDragEnd(i,e,t,r)}})),this._register(s(t,d.DBLCLICK,i=>this.onTitleDoubleClick(i))),this._register(s(t,d.AUXCLICK,i=>this.onTitleAuxClick(i))),this._register(s(t,u.Tap,i=>this.onTitleTap(i)));for(const i of[d.CONTEXT_MENU,u.Contextmenu])this._register(s(t,i,o=>{this.tabsModel.activeEditor&&this.onTabContextMenu(this.tabsModel.activeEditor,o,t)}))}onTitleLabelClick(t){n.stop(t,!1),setTimeout(()=>this.quickInputService.quickAccess.show())}onTitleDoubleClick(t){n.stop(t),this.groupView.pinEditor()}onTitleAuxClick(t){t.button===1&&this.tabsModel.activeEditor&&(n.stop(t,!0),D(this.tabsModel,this.tabsModel.activeEditor,w.MOUSE,this.groupsView.partOptions)||this.groupView.closeEditor(this.tabsModel.activeEditor))}onTitleTap(t){const e=t.initialTarget;!m(e)||!this.editorLabel||!E(e,this.editorLabel.element)||setTimeout(()=>this.quickInputService.quickAccess.show(),50)}openEditor(t){return this.doHandleOpenEditor()}openEditors(t){return this.doHandleOpenEditor()}doHandleOpenEditor(){const t=this.ifActiveEditorChanged(()=>this.redraw());return t||this.ifActiveEditorPropertiesChanged(()=>this.redraw()),t}beforeCloseEditor(t){}closeEditor(t){this.ifActiveEditorChanged(()=>this.redraw())}closeEditors(t){this.ifActiveEditorChanged(()=>this.redraw())}moveEditor(t,e,r){this.ifActiveEditorChanged(()=>this.redraw())}pinEditor(t){this.ifEditorIsActive(t,()=>this.redraw())}stickEditor(t){}unstickEditor(t){}setActive(t){this.redraw()}updateEditorSelections(){}updateEditorLabel(t){this.ifEditorIsActive(t,()=>this.redraw())}updateEditorDirty(t){this.ifEditorIsActive(t,()=>{const e=p(this.titleContainer);t.isDirty()&&!t.isSaving()?e.classList.add("dirty"):e.classList.remove("dirty")})}updateOptions(t,e){super.updateOptions(t,e),(t.labelFormat!==e.labelFormat||!I(t.decorations,e.decorations))&&this.redraw()}updateStyles(){this.redraw()}handleBreadcrumbsEnablementChange(){p(this.titleContainer).classList.toggle("breadcrumbs",!!this.breadcrumbsControl),this.redraw()}ifActiveEditorChanged(t){return!this.activeLabel.editor&&this.tabsModel.activeEditor||this.activeLabel.editor&&!this.tabsModel.activeEditor||!this.activeLabel.editor||!this.tabsModel.isActive(this.activeLabel.editor)?(t(),!0):!1}ifActiveEditorPropertiesChanged(t){!this.activeLabel.editor||!this.tabsModel.activeEditor||this.activeLabel.pinned!==this.tabsModel.isPinned(this.tabsModel.activeEditor)&&t()}ifEditorIsActive(t,e){this.tabsModel.isActive(t)&&e()}redraw(){const t=this.tabsModel.activeEditor??void 0,e=this.groupsView.partOptions,r=t?this.tabsModel.isPinned(t):!1,i=this.groupsView.activeGroup===this.groupView;this.activeLabel={editor:t,pinned:r},this.breadcrumbsControl&&(i?(this.breadcrumbsControl.update(),this.breadcrumbsControl.domNode.classList.toggle("preview",!r)):this.breadcrumbsControl.hide());const[o,c]=L(this.titleContainer,this.editorLabel);if(!t)o.classList.remove("dirty"),c.clear(),this.clearEditorActionsToolbar();else{this.updateEditorDirty(t);const{labelFormat:h}=this.groupsView.partOptions;let a;this.breadcrumbsControl&&!this.breadcrumbsControl.isHidden()||h==="default"&&!i?a="":a=t.getDescription(this.getVerbosity(h))||"",c.setResource({resource:A.getOriginalUri(t,{supportSideBySide:y.BOTH}),name:t.getName(),description:a},{title:this.getHoverTitle(t),italic:!r,extraClasses:["single-tab","title-label"].concat(t.getLabelExtraClasses()),fileDecorations:{colors:!!e.decorations?.colors,badges:!!e.decorations?.badges},icon:t.getIcon(),hideIcon:e.showIcons===!1}),i?o.style.color=this.getColor(M)||"":o.style.color=this.getColor(O)||"",this.updateEditorActionsToolbar()}}getVerbosity(t){switch(t){case"short":return l.SHORT;case"long":return l.LONG;default:return l.MEDIUM}}prepareEditorActions(t){return this.groupsView.activeGroup===this.groupView?t:{primary:this.groupsView.partOptions.alwaysShowEditorActions?t.primary:t.primary.filter(r=>r.id===B||r.id===V),secondary:t.secondary}}getHeight(){return this.tabHeight}layout(t){return this.breadcrumbsControl?.layout(void 0),new b(t.container.width,this.getHeight())}}export{ot as SingleEditorTabsControl};
