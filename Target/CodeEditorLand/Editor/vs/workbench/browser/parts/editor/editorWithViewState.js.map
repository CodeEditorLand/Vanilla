{
  "version": 3,
  "sources": ["../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/browser/parts/editor/editorWithViewState.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { URI } from '../../../../base/common/uri.js';\nimport { Event } from '../../../../base/common/event.js';\nimport { IEditorMemento, IEditorCloseEvent, IEditorOpenContext, EditorResourceAccessor, SideBySideEditor } from '../../../common/editor.js';\nimport { EditorPane } from './editorPane.js';\nimport { IStorageService } from '../../../../platform/storage/common/storage.js';\nimport { IInstantiationService } from '../../../../platform/instantiation/common/instantiation.js';\nimport { ITelemetryService } from '../../../../platform/telemetry/common/telemetry.js';\nimport { IThemeService } from '../../../../platform/theme/common/themeService.js';\nimport { ITextResourceConfigurationService } from '../../../../editor/common/services/textResourceConfiguration.js';\nimport { IEditorGroupsService, IEditorGroup } from '../../../services/editor/common/editorGroupsService.js';\nimport { IEditorService } from '../../../services/editor/common/editorService.js';\nimport { IExtUri } from '../../../../base/common/resources.js';\nimport { IDisposable, MutableDisposable } from '../../../../base/common/lifecycle.js';\nimport { EditorInput } from '../../../common/editor/editorInput.js';\n\n/**\n * Base class of editors that want to store and restore view state.\n */\nexport abstract class AbstractEditorWithViewState<T extends object> extends EditorPane {\n\n\tprivate viewState: IEditorMemento<T>;\n\n\tprivate readonly groupListener = this._register(new MutableDisposable());\n\n\tprivate editorViewStateDisposables: Map<EditorInput, IDisposable> | undefined;\n\n\tconstructor(\n\t\tid: string,\n\t\tgroup: IEditorGroup,\n\t\tviewStateStorageKey: string,\n\t\t@ITelemetryService telemetryService: ITelemetryService,\n\t\t@IInstantiationService protected readonly instantiationService: IInstantiationService,\n\t\t@IStorageService storageService: IStorageService,\n\t\t@ITextResourceConfigurationService protected readonly textResourceConfigurationService: ITextResourceConfigurationService,\n\t\t@IThemeService themeService: IThemeService,\n\t\t@IEditorService protected readonly editorService: IEditorService,\n\t\t@IEditorGroupsService protected readonly editorGroupService: IEditorGroupsService\n\t) {\n\t\tsuper(id, group, telemetryService, themeService, storageService);\n\n\t\tthis.viewState = this.getEditorMemento<T>(editorGroupService, textResourceConfigurationService, viewStateStorageKey, 100);\n\t}\n\n\tprotected override setEditorVisible(visible: boolean): void {\n\n\t\t// Listen to close events to trigger `onWillCloseEditorInGroup`\n\t\tthis.groupListener.value = this.group.onWillCloseEditor(e => this.onWillCloseEditor(e));\n\n\t\tsuper.setEditorVisible(visible);\n\t}\n\n\tprivate onWillCloseEditor(e: IEditorCloseEvent): void {\n\t\tconst editor = e.editor;\n\t\tif (editor === this.input) {\n\t\t\t// React to editors closing to preserve or clear view state. This needs to happen\n\t\t\t// in the `onWillCloseEditor` because at that time the editor has not yet\n\t\t\t// been disposed and we can safely persist the view state.\n\t\t\tthis.updateEditorViewState(editor);\n\t\t}\n\t}\n\n\toverride clearInput(): void {\n\n\t\t// Preserve current input view state before clearing\n\t\tthis.updateEditorViewState(this.input);\n\n\t\tsuper.clearInput();\n\t}\n\n\tprotected override saveState(): void {\n\n\t\t// Preserve current input view state before shutting down\n\t\tthis.updateEditorViewState(this.input);\n\n\t\tsuper.saveState();\n\t}\n\n\tprivate updateEditorViewState(input: EditorInput | undefined): void {\n\t\tif (!input || !this.tracksEditorViewState(input)) {\n\t\t\treturn; // ensure we have an input to handle view state for\n\t\t}\n\n\t\tconst resource = this.toEditorViewStateResource(input);\n\t\tif (!resource) {\n\t\t\treturn; // we need a resource\n\t\t}\n\n\t\t// If we are not tracking disposed editor view state\n\t\t// make sure to clear the view state once the editor\n\t\t// is disposed.\n\t\tif (!this.tracksDisposedEditorViewState()) {\n\t\t\tif (!this.editorViewStateDisposables) {\n\t\t\t\tthis.editorViewStateDisposables = new Map<EditorInput, IDisposable>();\n\t\t\t}\n\n\t\t\tif (!this.editorViewStateDisposables.has(input)) {\n\t\t\t\tthis.editorViewStateDisposables.set(input, Event.once(input.onWillDispose)(() => {\n\t\t\t\t\tthis.clearEditorViewState(resource, this.group);\n\t\t\t\t\tthis.editorViewStateDisposables?.delete(input);\n\t\t\t\t}));\n\t\t\t}\n\t\t}\n\n\t\t// Clear the editor view state if:\n\t\t// - the editor view state should not be tracked for disposed editors\n\t\t// - the user configured to not restore view state unless the editor is still opened in the group\n\t\tif (\n\t\t\t(input.isDisposed() && !this.tracksDisposedEditorViewState()) ||\n\t\t\t(!this.shouldRestoreEditorViewState(input) && !this.group.contains(input))\n\t\t) {\n\t\t\tthis.clearEditorViewState(resource, this.group);\n\t\t}\n\n\t\t// Otherwise we save the view state\n\t\telse if (!input.isDisposed()) {\n\t\t\tthis.saveEditorViewState(resource);\n\t\t}\n\t}\n\n\tprivate shouldRestoreEditorViewState(input: EditorInput, context?: IEditorOpenContext): boolean {\n\n\t\t// new editor: check with workbench.editor.restoreViewState setting\n\t\tif (context?.newInGroup) {\n\t\t\treturn this.textResourceConfigurationService.getValue<boolean>(EditorResourceAccessor.getOriginalUri(input, { supportSideBySide: SideBySideEditor.PRIMARY }), 'workbench.editor.restoreViewState') === false ? false : true /* restore by default */;\n\t\t}\n\n\t\t// existing editor: always restore viewstate\n\t\treturn true;\n\t}\n\n\toverride getViewState(): T | undefined {\n\t\tconst input = this.input;\n\t\tif (!input || !this.tracksEditorViewState(input)) {\n\t\t\treturn; // need valid input for view state\n\t\t}\n\n\t\tconst resource = this.toEditorViewStateResource(input);\n\t\tif (!resource) {\n\t\t\treturn; // need a resource for finding view state\n\t\t}\n\n\t\treturn this.computeEditorViewState(resource);\n\t}\n\n\tprivate saveEditorViewState(resource: URI): void {\n\t\tconst editorViewState = this.computeEditorViewState(resource);\n\t\tif (!editorViewState) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.viewState.saveEditorState(this.group, resource, editorViewState);\n\t}\n\n\tprotected loadEditorViewState(input: EditorInput | undefined, context?: IEditorOpenContext): T | undefined {\n\t\tif (!input) {\n\t\t\treturn undefined; // we need valid input\n\t\t}\n\n\t\tif (!this.tracksEditorViewState(input)) {\n\t\t\treturn undefined; // not tracking for input\n\t\t}\n\n\t\tif (!this.shouldRestoreEditorViewState(input, context)) {\n\t\t\treturn undefined; // not enabled for input\n\t\t}\n\n\t\tconst resource = this.toEditorViewStateResource(input);\n\t\tif (!resource) {\n\t\t\treturn; // need a resource for finding view state\n\t\t}\n\n\t\treturn this.viewState.loadEditorState(this.group, resource);\n\t}\n\n\tprotected moveEditorViewState(source: URI, target: URI, comparer: IExtUri): void {\n\t\treturn this.viewState.moveEditorState(source, target, comparer);\n\t}\n\n\tprotected clearEditorViewState(resource: URI, group?: IEditorGroup): void {\n\t\tthis.viewState.clearEditorState(resource, group);\n\t}\n\n\toverride dispose(): void {\n\t\tsuper.dispose();\n\n\t\tif (this.editorViewStateDisposables) {\n\t\t\tfor (const [, disposables] of this.editorViewStateDisposables) {\n\t\t\t\tdisposables.dispose();\n\t\t\t}\n\n\t\t\tthis.editorViewStateDisposables = undefined;\n\t\t}\n\t}\n\n\t//#region Subclasses should/could override based on needs\n\n\t/**\n\t * The actual method to provide for gathering the view state\n\t * object for the control.\n\t *\n\t * @param resource the expected `URI` for the view state. This\n\t * should be used as a way to ensure the view state in the\n\t * editor control is matching the resource expected, for example\n\t * by comparing with the underlying model (this was a fix for\n\t * https://github.com/microsoft/vscode/issues/40114).\n\t */\n\tprotected abstract computeEditorViewState(resource: URI): T | undefined;\n\n\t/**\n\t * Whether view state should be associated with the given input.\n\t * Subclasses need to ensure that the editor input is expected\n\t * for the editor.\n\t */\n\tprotected abstract tracksEditorViewState(input: EditorInput): boolean;\n\n\t/**\n\t * Whether view state should be tracked even when the editor is\n\t * disposed.\n\t *\n\t * Subclasses should override this if the input can be restored\n\t * from the resource at a later point, e.g. if backed by files.\n\t */\n\tprotected tracksDisposedEditorViewState(): boolean {\n\t\treturn false;\n\t}\n\n\t/**\n\t * Asks to return the `URI` to associate with the view state.\n\t */\n\tprotected abstract toEditorViewStateResource(input: EditorInput): URI | undefined;\n\n\t//#endregion\n}\n"],
  "mappings": "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",
  "names": []
}
