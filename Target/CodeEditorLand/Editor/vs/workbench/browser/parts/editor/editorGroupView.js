var lt=Object.defineProperty;var pt=Object.getOwnPropertyDescriptor;var X=(x,f,t,e)=>{for(var i=e>1?void 0:e?pt(f,t):f,o=x.length-1,r;o>=0;o--)(r=x[o])&&(i=(e?r(f,t,i):r(i))||i);return e&&i&&lt(f,t,i),i},c=(x,f)=>(t,e)=>f(t,e,x);import"./media/editorgroupview.css";import{Dimension as q,EventHelper as $,EventType as _,addDisposableListener as b,findParentWithClass as J,getActiveElement as Z,getWindow as tt,isActiveElement as ct,isAncestor as ht,isMouseEvent as ut,trackFocus as Et}from"../../../../base/browser/dom.js";import{StandardMouseEvent as mt}from"../../../../base/browser/mouseEvent.js";import{EventType as et}from"../../../../base/browser/touch.js";import{ActionBar as vt}from"../../../../base/browser/ui/actionbar/actionbar.js";import{ProgressBar as ft}from"../../../../base/browser/ui/progressbar/progressbar.js";import{coalesce as it}from"../../../../base/common/arrays.js";import{DeferredPromise as Ct,Promises as It,RunOnceWorker as yt}from"../../../../base/common/async.js";import{Emitter as m,Relay as gt}from"../../../../base/common/event.js";import{hash as St}from"../../../../base/common/hash.js";import{MutableDisposable as ot,toDisposable as bt}from"../../../../base/common/lifecycle.js";import{Schemas as R}from"../../../../base/common/network.js";import{isLinux as Ot,isMacintosh as wt,isNative as Dt,isWindows as Tt}from"../../../../base/common/platform.js";import{extname as Pt,isEqual as U}from"../../../../base/common/resources.js";import{URI as xt}from"../../../../base/common/uri.js";import{getMimeTypes as At}from"../../../../editor/common/services/languagesAssociations.js";import{localize as C}from"../../../../nls.js";import{createAndFillInActionBarActions as rt}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{IMenuService as _t,MenuId as W}from"../../../../platform/actions/common/actions.js";import{IContextKeyService as st}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as Rt}from"../../../../platform/contextview/browser/contextView.js";import{ConfirmResult as I,IDialogService as Gt,IFileDialogService as Lt}from"../../../../platform/dialogs/common/dialogs.js";import{EditorActivation as w}from"../../../../platform/editor/common/editor.js";import{FileSystemProviderCapabilities as kt,IFileService as Mt}from"../../../../platform/files/common/files.js";import{IInstantiationService as Vt}from"../../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as Ft}from"../../../../platform/instantiation/common/serviceCollection.js";import{IKeybindingService as Bt}from"../../../../platform/keybinding/common/keybinding.js";import{ILogService as Nt}from"../../../../platform/log/common/log.js";import{IEditorProgressService as Ht}from"../../../../platform/progress/common/progress.js";import{ITelemetryService as Ut}from"../../../../platform/telemetry/common/telemetry.js";import{TelemetryTrustedValue as Wt}from"../../../../platform/telemetry/common/telemetryUtils.js";import{defaultProgressBarStyles as Kt}from"../../../../platform/theme/browser/defaultStyles.js";import{contrastBorder as Yt,editorBackground as zt}from"../../../../platform/theme/common/colorRegistry.js";import{IThemeService as jt,Themable as Qt}from"../../../../platform/theme/common/themeService.js";import{IUriIdentityService as Xt}from"../../../../platform/uriIdentity/common/uriIdentity.js";import{ActiveCompareEditorCanSwapContext as qt,ActiveEditorAvailableEditorIdsContext as $t,ActiveEditorCanRevertContext as Jt,ActiveEditorCanSplitInGroupContext as Zt,ActiveEditorCanToggleReadonlyContext as te,ActiveEditorContext as ee,ActiveEditorDirtyContext as ie,ActiveEditorFirstInGroupContext as oe,ActiveEditorGroupLockedContext as re,ActiveEditorLastInGroupContext as se,ActiveEditorPinnedContext as ne,ActiveEditorReadonlyContext as de,ActiveEditorStickyContext as ae,EditorGroupEditorsCountContext as le,MultipleEditorsSelectedInGroupContext as pe,ResourceContextKey as ce,SelectedEditorsInGroupFileOrUntitledResourceContextKey as he,SideBySideEditorActiveContext as ue,TextCompareEditorActiveContext as Ee,TextCompareEditorVisibleContext as me,TwoEditorsSelectedInGroupContext as ve,applyAvailableEditorIds as fe}from"../../../common/contextkeys.js";import{CloseDirection as Ce,DEFAULT_EDITOR_ASSOCIATION as Ie,EditorCloseContext as D,EditorInputCapabilities as T,EditorResourceAccessor as O,EditorsOrder as y,GroupModelChangeKind as l,SaveReason as K,SideBySideEditor as h,TEXT_DIFF_EDITOR_ID as ye}from"../../../common/editor.js";import{DiffEditorInput as ge}from"../../../common/editor/diffEditorInput.js";import{EditorGroupModel as nt,isGroupEditorCloseEvent as Se,isGroupEditorOpenEvent as be,isSerializedEditorGroupModel as Oe}from"../../../common/editor/editorGroupModel.js";import{SideBySideEditorInput as P}from"../../../common/editor/sideBySideEditorInput.js";import{EDITOR_GROUP_EMPTY_BACKGROUND as we,EDITOR_GROUP_HEADER_BORDER as De,EDITOR_GROUP_HEADER_NO_TABS_BACKGROUND as Te,EDITOR_GROUP_HEADER_TABS_BACKGROUND as Pe}from"../../../common/theme.js";import{GroupsOrder as xe}from"../../../services/editor/common/editorGroupsService.js";import{IEditorResolverService as Ae}from"../../../services/editor/common/editorResolverService.js";import{IEditorService as _e}from"../../../services/editor/common/editorService.js";import{AutoSaveMode as dt,IFilesConfigurationService as Re}from"../../../services/filesConfiguration/common/filesConfigurationService.js";import{IHostService as Ge}from"../../../services/host/browser/host.js";import{EditorProgressIndicator as Le}from"../../../services/progress/browser/progressIndicator.js";import{fillActiveEditorViewState as at}from"./editor.js";import{EditorGroupWatermark as ke}from"./editorGroupWatermark.js";import{EditorPane as Me}from"./editorPane.js";import{EditorPanes as Ve}from"./editorPanes.js";import{EditorTitleControl as Fe}from"./editorTitleControl.js";let E=class extends Qt{constructor(t,e,i,o,r,s,n,d,p,v,g,G,L,k,M,Y,z,j,V,F,B,N){super(p);this.editorPartsView=e;this.groupsView=i;this.groupsLabel=o;this._index=r;this.instantiationService=n;this.contextKeyService=d;this.telemetryService=v;this.keybindingService=g;this.menuService=G;this.contextMenuService=L;this.fileDialogService=k;this.editorService=M;this.filesConfigurationService=Y;this.uriIdentityService=z;this.logService=j;this.editorResolverService=V;this.hostService=F;this.dialogService=B;this.fileService=N;t instanceof E?this.model=this._register(t.model.clone()):Oe(t)?this.model=this._register(n.createInstance(nt,t)):this.model=this._register(n.createInstance(nt,void 0)),this.scopedContextKeyService=this._register(this.contextKeyService.createScoped(this.element)),this.element.classList.add(...it(["editor-group-container",this.model.isLocked?"locked":void 0])),this.registerContainerListeners(),this.createContainerToolbar(),this.createContainerContextMenu(),this._register(this.instantiationService.createInstance(ke,this.element)),this.progressBar=this._register(new ft(this.element,Kt)),this.progressBar.hide(),this.scopedInstantiationService=this._register(this.instantiationService.createChild(new Ft([st,this.scopedContextKeyService],[Ht,this._register(new Le(this.progressBar,this))]))),this.resourceContext=this._register(this.scopedInstantiationService.createInstance(ce)),this.handleGroupContextKeys(),this.titleContainer=document.createElement("div"),this.titleContainer.classList.add("title"),this.element.appendChild(this.titleContainer),this.titleControl=this._register(this.scopedInstantiationService.createInstance(Fe,this.titleContainer,this.editorPartsView,this.groupsView,this,this.model)),this.editorContainer=document.createElement("div"),this.editorContainer.classList.add("editor-container"),this.element.appendChild(this.editorContainer),this.editorPane=this._register(this.scopedInstantiationService.createInstance(Ve,this.element,this.editorContainer,this)),this._onDidChange.input=this.editorPane.onDidChangeSizeConstraints,this.doTrackFocus(),this.updateTitleContainer(),this.updateContainer(),this.updateStyles(),(this.restoreEditors(t,s)??Promise.resolve()).finally(()=>{this.whenRestoredPromise.complete()}),this.registerListeners()}static createNew(t,e,i,o,r,s){return r.createInstance(E,null,t,e,i,o,s)}static createFromSerialized(t,e,i,o,r,s,n){return s.createInstance(E,t,e,i,o,r,n)}static createCopy(t,e,i,o,r,s,n){return s.createInstance(E,t,e,i,o,r,n)}scopedContextKeyService;_onDidFocus=this._register(new m);onDidFocus=this._onDidFocus.event;_onWillDispose=this._register(new m);onWillDispose=this._onWillDispose.event;_onDidModelChange=this._register(new m);onDidModelChange=this._onDidModelChange.event;_onDidActiveEditorChange=this._register(new m);onDidActiveEditorChange=this._onDidActiveEditorChange.event;_onDidOpenEditorFail=this._register(new m);onDidOpenEditorFail=this._onDidOpenEditorFail.event;_onWillCloseEditor=this._register(new m);onWillCloseEditor=this._onWillCloseEditor.event;_onDidCloseEditor=this._register(new m);onDidCloseEditor=this._onDidCloseEditor.event;_onWillMoveEditor=this._register(new m);onWillMoveEditor=this._onWillMoveEditor.event;_onWillOpenEditor=this._register(new m);onWillOpenEditor=this._onWillOpenEditor.event;model;active;lastLayout;scopedInstantiationService;resourceContext;titleContainer;titleControl;progressBar;editorContainer;editorPane;disposedEditorsWorker=this._register(new yt(t=>this.handleDisposedEditors(t),0));mapEditorToPendingConfirmation=new Map;containerToolBarMenuDisposable=this._register(new ot);whenRestoredPromise=new Ct;whenRestored=this.whenRestoredPromise.p;handleGroupContextKeys(){const t=this.editorPartsView.bind(ie,this),e=this.editorPartsView.bind(ne,this),i=this.editorPartsView.bind(oe,this),o=this.editorPartsView.bind(se,this),r=this.editorPartsView.bind(ae,this),s=this.editorPartsView.bind(le,this),n=this.editorPartsView.bind(re,this),d=pe.bindTo(this.scopedContextKeyService),p=ve.bindTo(this.scopedContextKeyService),v=he.bindTo(this.scopedContextKeyService),g=this.editorPartsView.bind(ee,this),G=this.editorPartsView.bind(de,this),L=this.editorPartsView.bind(Jt,this),k=this.editorPartsView.bind(te,this),M=this.editorPartsView.bind(qt,this),Y=this.editorPartsView.bind(me,this),z=this.editorPartsView.bind(Ee,this),j=this.editorPartsView.bind($t,this),V=this.editorPartsView.bind(Zt,this),F=this.editorPartsView.bind(ue,this),B=this._register(new ot),N=()=>{B.clear(),this.scopedContextKeyService.bufferChangeEvents(()=>{const a=this.activeEditor,u=this.activeEditorPane;if(this.resourceContext.set(O.getOriginalUri(a,{supportSideBySide:h.PRIMARY})),fe(j,a,this.editorResolverService),a?(V.set(a.hasCapability(T.CanSplitInGroup)),F.set(a.typeId===P.ID),t.set(a.isDirty()&&!a.isSaving()),B.value=a.onDidChangeDirty(()=>{t.set(a.isDirty()&&!a.isSaving())})):(V.set(!1),F.set(!1),t.set(!1)),u){g.set(u.getId()),L.set(!u.input.hasCapability(T.Untitled)),G.set(!!u.input.isReadonly());const S=O.getOriginalUri(u.input,{supportSideBySide:h.PRIMARY}),H=O.getOriginalUri(u.input,{supportSideBySide:h.SECONDARY});M.set(u.input instanceof ge&&!u.input.original.isReadonly()&&!!S&&(this.fileService.hasProvider(S)||S.scheme===R.untitled)&&!!H&&(this.fileService.hasProvider(H)||H.scheme===R.untitled)),k.set(!!S&&this.fileService.hasProvider(S)&&!this.fileService.hasCapability(S,kt.Readonly));const Q=u?.getId()===ye;z.set(Q),Y.set(Q)}else g.reset(),L.reset(),G.reset(),M.reset(),k.reset()})},A=a=>{switch(a.kind){case l.GROUP_LOCKED:n.set(this.isLocked);break;case l.EDITOR_ACTIVE:i.set(this.model.isFirst(this.model.activeEditor)),o.set(this.model.isLast(this.model.activeEditor)),e.set(this.model.activeEditor?this.model.isPinned(this.model.activeEditor):!1),r.set(this.model.activeEditor?this.model.isSticky(this.model.activeEditor):!1);break;case l.EDITOR_CLOSE:e.set(this.model.activeEditor?this.model.isPinned(this.model.activeEditor):!1),r.set(this.model.activeEditor?this.model.isSticky(this.model.activeEditor):!1);case l.EDITOR_OPEN:case l.EDITOR_MOVE:i.set(this.model.isFirst(this.model.activeEditor)),o.set(this.model.isLast(this.model.activeEditor));break;case l.EDITOR_PIN:a.editor&&a.editor===this.model.activeEditor&&e.set(this.model.isPinned(this.model.activeEditor));break;case l.EDITOR_STICKY:a.editor&&a.editor===this.model.activeEditor&&r.set(this.model.isSticky(this.model.activeEditor));break;case l.EDITORS_SELECTION:d.set(this.model.selectedEditors.length>1),p.set(this.model.selectedEditors.length===2),v.set(this.model.selectedEditors.every(u=>u.resource&&(this.fileService.hasProvider(u.resource)||u.resource.scheme===R.untitled)));break}s.set(this.count)};this._register(this.onDidModelChange(a=>A(a))),this._register(this.onDidActiveEditorChange(()=>N())),N(),A({kind:l.EDITOR_ACTIVE}),A({kind:l.GROUP_LOCKED})}registerContainerListeners(){this._register(b(this.element,_.DBLCLICK,t=>{this.isEmpty&&($.stop(t),this.editorService.openEditor({resource:void 0,options:{pinned:!0,override:Ie.id}},this.id))})),this._register(b(this.element,_.AUXCLICK,t=>{this.isEmpty&&t.button===1&&($.stop(t,!0),this.groupsView.removeGroup(this))}))}createContainerToolbar(){const t=document.createElement("div");t.classList.add("editor-group-container-toolbar"),this.element.appendChild(t);const e=this._register(new vt(t,{ariaLabel:C("ariaLabelGroupActions","Empty editor group actions"),highlightToggledItems:!0})),i=this._register(this.menuService.createMenu(W.EmptyEditorGroup,this.scopedContextKeyService)),o=()=>{const r={primary:[],secondary:[]};this.containerToolBarMenuDisposable.value=bt(()=>e.clear()),rt(i,{arg:{groupId:this.id},shouldForwardArgs:!0},r,"navigation");for(const s of[...r.primary,...r.secondary]){const n=this.keybindingService.lookupKeybinding(s.id);e.push(s,{icon:!0,label:!1,keybinding:n?.getLabel()})}};o(),this._register(i.onDidChange(o))}createContainerContextMenu(){this._register(b(this.element,_.CONTEXT_MENU,t=>this.onShowContainerContextMenu(t))),this._register(b(this.element,et.Contextmenu,()=>this.onShowContainerContextMenu()))}onShowContainerContextMenu(t){if(!this.isEmpty)return;let e=this.element;t&&(e=new mt(tt(this.element),t)),this.contextMenuService.showContextMenu({menuId:W.EmptyEditorGroupContext,contextKeyService:this.contextKeyService,getAnchor:()=>e,onHide:()=>{this.focus()}})}doTrackFocus(){const t=this._register(Et(this.element));this._register(t.onDidFocus(()=>{this.isEmpty&&this._onDidFocus.fire()}));const e=i=>{let o;if(ut(i)){if(i.button!==0||wt&&i.ctrlKey)return;o=i.target}else o=i.initialTarget;J(o,"monaco-action-bar",this.titleContainer)||J(o,"monaco-breadcrumb-item",this.titleContainer)||setTimeout(()=>{this.focus()})};this._register(b(this.titleContainer,_.MOUSE_DOWN,i=>e(i))),this._register(b(this.titleContainer,et.Tap,i=>e(i))),this._register(this.editorPane.onDidFocus(()=>{this._onDidFocus.fire()}))}updateContainer(){this.isEmpty?(this.element.classList.add("empty"),this.element.tabIndex=0,this.element.setAttribute("aria-label",C("emptyEditorGroup","{0} (empty)",this.ariaLabel))):(this.element.classList.remove("empty"),this.element.removeAttribute("tabIndex"),this.element.removeAttribute("aria-label")),this.updateStyles()}updateTitleContainer(){this.titleContainer.classList.toggle("tabs",this.groupsView.partOptions.showTabs==="multiple"),this.titleContainer.classList.toggle("show-file-icons",this.groupsView.partOptions.showIcons)}restoreEditors(t,e){if(this.count===0)return;let i;t instanceof E?i=at(t):i=Object.create(null);const o=this.model.activeEditor;if(!o)return;i.pinned=this.model.isPinned(o),i.sticky=this.model.isSticky(o),i.preserveFocus=!0;const r={preserveWindowOrder:!0,skipTitleUpdate:!0},s=Z(),n=this.doShowEditor(o,{active:!0,isNew:!1},i,r).then(()=>{this.groupsView.activeGroup===this&&s&&ct(s)&&!e?.preserveFocus&&this.focus()});return this.titleControl.openEditors(this.editors),n}registerListeners(){this._register(this.model.onDidModelChange(t=>this.onDidGroupModelChange(t))),this._register(this.groupsView.onDidChangeEditorPartOptions(t=>this.onDidChangeEditorPartOptions(t))),this._register(this.groupsView.onDidVisibilityChange(t=>this.onDidVisibilityChange(t))),this._register(this.onDidFocus(()=>this.onDidGainFocus()))}onDidGroupModelChange(t){switch(this._onDidModelChange.fire(t),t.kind){case l.GROUP_LOCKED:this.element.classList.toggle("locked",this.isLocked);break;case l.EDITORS_SELECTION:this.onDidChangeEditorSelection();break}if(t.editor)switch(t.kind){case l.EDITOR_OPEN:be(t)&&this.onDidOpenEditor(t.editor,t.editorIndex);break;case l.EDITOR_CLOSE:Se(t)&&this.handleOnDidCloseEditor(t.editor,t.editorIndex,t.context,t.sticky);break;case l.EDITOR_WILL_DISPOSE:this.onWillDisposeEditor(t.editor);break;case l.EDITOR_DIRTY:this.onDidChangeEditorDirty(t.editor);break;case l.EDITOR_TRANSIENT:this.onDidChangeEditorTransient(t.editor);break;case l.EDITOR_LABEL:this.onDidChangeEditorLabel(t.editor);break}}onDidOpenEditor(t,e){this.telemetryService.publicLog("editorOpened",this.toEditorTelemetryDescriptor(t)),this.updateContainer()}handleOnDidCloseEditor(t,e,i,o){this._onWillCloseEditor.fire({groupId:this.id,editor:t,context:i,index:e,sticky:o});const r=[t];t instanceof P&&r.push(t.primary,t.secondary);for(const s of r)this.canDispose(s)&&s.dispose();this.telemetryService.publicLog("editorClosed",this.toEditorTelemetryDescriptor(t)),this.updateContainer(),this._onDidCloseEditor.fire({groupId:this.id,editor:t,context:i,index:e,sticky:o})}canDispose(t){for(const e of this.editorPartsView.groups)if(e instanceof E&&e.model.contains(t,{strictEquals:!0,supportSideBySide:h.ANY}))return!1;return!0}toResourceTelemetryDescriptor(t){if(!t)return;const e=t?t.scheme===R.file?t.fsPath:t.path:void 0;if(!e)return;let i=Pt(t);const o=i.indexOf("?");return i=o!==-1?i.substr(0,o):i,{mimeType:new Wt(At(t).join(", ")),scheme:t.scheme,ext:i,path:St(e)}}toEditorTelemetryDescriptor(t){const e=t.getTelemetryDescriptor(),i=O.getOriginalUri(t,{supportSideBySide:h.BOTH});return xt.isUri(i)?(e.resource=this.toResourceTelemetryDescriptor(i),e):(i&&(i.primary&&(e.resource=this.toResourceTelemetryDescriptor(i.primary)),i.secondary&&(e.resourceSecondary=this.toResourceTelemetryDescriptor(i.secondary))),e)}onWillDisposeEditor(t){this.disposedEditorsWorker.work(t)}handleDisposedEditors(t){let e;const i=[];for(const o of t){const r=this.model.findEditor(o);if(!r)continue;const s=r[0];s.isDisposed()&&(this.model.isActive(s)?e=s:i.push(s))}for(const o of i)this.doCloseEditor(o,!0);e&&this.doCloseEditor(e,!0)}onDidChangeEditorPartOptions(t){this.updateTitleContainer(),this.titleControl.updateOptions(t.oldPartOptions,t.newPartOptions),(t.oldPartOptions.showTabs!==t.newPartOptions.showTabs||t.oldPartOptions.tabHeight!==t.newPartOptions.tabHeight||t.oldPartOptions.showTabs==="multiple"&&t.oldPartOptions.pinnedTabsOnSeparateRow!==t.newPartOptions.pinnedTabsOnSeparateRow)&&(this.relayout(),this.model.activeEditor&&this.titleControl.openEditors(this.model.getEditors(y.SEQUENTIAL))),this.updateStyles(),t.oldPartOptions.enablePreview&&!t.newPartOptions.enablePreview&&this.model.previewEditor&&this.pinEditor(this.model.previewEditor)}onDidChangeEditorDirty(t){this.pinEditor(t),this.titleControl.updateEditorDirty(t)}onDidChangeEditorTransient(t){!this.model.isTransient(t)&&!this.groupsView.partOptions.enablePreview&&this.pinEditor(t)}onDidChangeEditorLabel(t){this.titleControl.updateEditorLabel(t)}onDidChangeEditorSelection(){this.titleControl.updateEditorSelections()}onDidVisibilityChange(t){this.editorPane.setVisible(t)}onDidGainFocus(){this.activeEditor&&this.model.setTransient(this.activeEditor,!1)}get index(){return this._index}get label(){return this.groupsLabel?C("groupLabelLong","{0}: Group {1}",this.groupsLabel,this._index+1):C("groupLabel","Group {0}",this._index+1)}get ariaLabel(){return this.groupsLabel?C("groupAriaLabelLong","{0}: Editor Group {1}",this.groupsLabel,this._index+1):C("groupAriaLabel","Editor Group {0}",this._index+1)}_disposed=!1;get disposed(){return this._disposed}get isEmpty(){return this.count===0}get titleHeight(){return this.titleControl.getHeight()}notifyIndexChanged(t){this._index!==t&&(this._index=t,this.model.setIndex(t))}notifyLabelChanged(t){this.groupsLabel!==t&&(this.groupsLabel=t,this.model.setLabel(t))}setActive(t){this.active=t,!t&&this.activeEditor&&this.selectedEditors.length>1&&this.setSelection(this.activeEditor,[]),this.element.classList.toggle("active",t),this.element.classList.toggle("inactive",!t),this.titleControl.setActive(t),this.updateStyles(),this.model.setActive(void 0)}get id(){return this.model.id}get windowId(){return this.groupsView.windowId}get editors(){return this.model.getEditors(y.SEQUENTIAL)}get count(){return this.model.count}get stickyCount(){return this.model.stickyCount}get activeEditorPane(){return this.editorPane?this.editorPane.activeEditorPane??void 0:void 0}get activeEditor(){return this.model.activeEditor}get selectedEditors(){return this.model.selectedEditors}get previewEditor(){return this.model.previewEditor}isPinned(t){return this.model.isPinned(t)}isSticky(t){return this.model.isSticky(t)}isSelected(t){return this.model.isSelected(t)}isTransient(t){return this.model.isTransient(t)}isActive(t){return this.model.isActive(t)}async setSelection(t,e){this.isActive(t)?this.model.setSelection(t,e):await this.openEditor(t,{activation:w.ACTIVATE},{inactiveSelection:e})}contains(t,e){return this.model.contains(t,e)}getEditors(t,e){return this.model.getEditors(t,e)}findEditors(t,e){const i=this.uriIdentityService.asCanonicalUri(t);return this.getEditors(y.SEQUENTIAL).filter(o=>{if(o.resource&&U(o.resource,i))return!0;if(e?.supportSideBySide===h.PRIMARY||e?.supportSideBySide===h.ANY){const r=O.getCanonicalUri(o,{supportSideBySide:h.PRIMARY});if(r&&U(r,i))return!0}if(e?.supportSideBySide===h.SECONDARY||e?.supportSideBySide===h.ANY){const r=O.getCanonicalUri(o,{supportSideBySide:h.SECONDARY});if(r&&U(r,i))return!0}return!1})}getEditorByIndex(t){return this.model.getEditorByIndex(t)}getIndexOfEditor(t){return this.model.indexOf(t)}isFirst(t){return this.model.isFirst(t)}isLast(t){return this.model.isLast(t)}focus(){this.activeEditorPane?this.activeEditorPane.focus():this.element.focus(),this._onDidFocus.fire()}pinEditor(t=this.activeEditor||void 0){if(t&&!this.model.isPinned(t)){const e=this.model.pin(t);e&&this.titleControl.pinEditor(e)}}stickEditor(t=this.activeEditor||void 0){this.doStickEditor(t,!0)}unstickEditor(t=this.activeEditor||void 0){this.doStickEditor(t,!1)}doStickEditor(t,e){if(t&&this.model.isSticky(t)!==e){const i=this.getIndexOfEditor(t),o=e?this.model.stick(t):this.model.unstick(t);if(!o)return;const r=this.getIndexOfEditor(o);r!==i&&this.titleControl.moveEditor(o,i,r,!0),e?this.titleControl.stickEditor(o):this.titleControl.unstickEditor(o)}}async openEditor(t,e,i){return this.doOpenEditor(t,e,{...i,supportSideBySide:h.BOTH})}async doOpenEditor(t,e,i){if(!t||t.isDisposed())return;this._onWillOpenEditor.fire({editor:t,groupId:this.id});const o=e?.sticky||!this.groupsView.partOptions.enablePreview&&!e?.transient||t.isDirty()||(e?.pinned??typeof e?.index=="number")||typeof e?.index=="number"&&this.model.isSticky(e.index)||t.hasCapability(T.Scratchpad),r={index:e?e.index:void 0,pinned:o,sticky:e?.sticky||typeof e?.index=="number"&&this.model.isSticky(e.index),transient:!!e?.transient,inactiveSelection:i?.inactiveSelection,active:this.count===0||!e||!e.inactive,supportSideBySide:i?.supportSideBySide};!r.active&&!r.pinned&&this.model.activeEditor&&!this.model.isPinned(this.model.activeEditor)&&(r.active=!0);let s=!1,n=!1;if(e?.activation===w.ACTIVATE?s=!0:e?.activation===w.RESTORE?n=!0:e?.activation===w.PRESERVE?(s=!1,n=!1):r.active&&(s=!e||!e.preserveFocus,n=!s),typeof r.index=="number"){const g=this.model.indexOf(t);g!==-1&&g!==r.index&&this.doMoveEditorInsideGroup(t,r)}const{editor:d,isNew:p}=this.model.openEditor(t,r);p&&this.count===1&&this.editorPartsView.groups.length>1&&d.editorId&&this.groupsView.partOptions.autoLockGroups?.has(d.editorId)&&this.lock(!0);const v=this.doShowEditor(d,{active:!!r.active,isNew:p},e,i);return s?this.groupsView.activateGroup(this):n&&this.groupsView.restoreGroup(this),v}doShowEditor(t,e,i,o){let r;return e.active?r=(async()=>{const{pane:s,changed:n,cancelled:d,error:p}=await this.editorPane.openEditor(t,i,o,{newInGroup:e.isNew});if(!d)return n&&this._onDidActiveEditorChange.fire({editor:t}),p&&this._onDidOpenEditorFail.fire(t),!s&&this.activeEditor===t&&this.doCloseEditor(t,i?.preserveFocus,{fromError:!0}),s})():r=Promise.resolve(void 0),o?.skipTitleUpdate||this.titleControl.openEditor(t,o),r}async openEditors(t){const e=it(t).filter(({editor:n})=>!n.isDisposed()),i=e.at(0);if(!i)return;const o={supportSideBySide:h.BOTH};await this.doOpenEditor(i.editor,i.options,o);const r=e.slice(1),s=this.getIndexOfEditor(i.editor)+1;return await It.settled(r.map(({editor:n,options:d},p)=>this.doOpenEditor(n,{...d,inactive:!0,pinned:!0,index:s+p},{...o,skipTitleUpdate:!0}))),this.titleControl.openEditors(r.map(({editor:n})=>n)),this.editorPane.activeEditorPane??void 0}moveEditors(t,e){const i={skipTitleUpdate:this!==e};let o=!1;const r=new Set;for(const{editor:s,options:n}of t)this.moveEditor(s,e,n,i)?r.add(s):o=!0;return i.skipTitleUpdate&&(e.titleControl.openEditors(Array.from(r)),this.titleControl.closeEditors(Array.from(r))),!o}moveEditor(t,e,i,o){return this===e?(this.doMoveEditorInsideGroup(t,i),!0):this.doMoveOrCopyEditorAcrossGroups(t,e,i,{...o,keepCopy:!1})}doMoveEditorInsideGroup(t,e){const i=e?e.index:void 0;if(typeof i!="number")return;const o=this.model.indexOf(t),r=this.model.getEditorByIndex(o);if(r){if(o!==i){const s=this.model.stickyCount;this.model.moveEditor(r,i),this.model.pin(r),this.titleControl.moveEditor(r,o,i,s!==this.model.stickyCount),this.titleControl.pinEditor(r)}e?.sticky&&this.stickEditor(r)}}doMoveOrCopyEditorAcrossGroups(t,e,i,o){const r=o?.keepCopy;if(!r||t.hasCapability(T.Singleton)){const n=t.canMove(this.id,e.id);if(typeof n=="string")return this.dialogService.error(n,C("moveErrorDetails","Try saving or reverting the editor first and then try again.")),!1}const s=at(this,t,{...i,pinned:!0,sticky:i?.sticky??(!r&&this.model.isSticky(t))});return r||this._onWillMoveEditor.fire({groupId:this.id,editor:t,target:e.id}),e.doOpenEditor(r?t.copy():t,s,o),r||this.doCloseEditor(t,!0,{...o,context:D.MOVE}),!0}copyEditors(t,e){const i={skipTitleUpdate:this!==e};for(const{editor:o,options:r}of t)this.copyEditor(o,e,r,i);if(i.skipTitleUpdate){const o=t.map(({editor:r})=>r);e.titleControl.openEditors(o)}}copyEditor(t,e,i,o){this===e?this.doMoveEditorInsideGroup(t,i):this.doMoveOrCopyEditorAcrossGroups(t,e,i,{...o,keepCopy:!0})}async closeEditor(t=this.activeEditor||void 0,e){return this.doCloseEditorWithConfirmationHandling(t,e)}async doCloseEditorWithConfirmationHandling(t=this.activeEditor||void 0,e,i){return!t||await this.handleCloseConfirmation([t])?!1:(this.doCloseEditor(t,e?.preserveFocus,i),!0)}doCloseEditor(t,e=this.groupsView.activeGroup!==this,i){i?.skipTitleUpdate||this.titleControl.beforeCloseEditor(t),this.model.isActive(t)?this.doCloseActiveEditor(e,i):this.doCloseInactiveEditor(t,i),i?.skipTitleUpdate||this.titleControl.closeEditor(t)}doCloseActiveEditor(t=this.groupsView.activeGroup!==this,e){const i=this.activeEditor,o=!t&&this.shouldRestoreFocus(this.element),r=this.groupsView.partOptions.closeEmptyGroups;if(r&&this.active&&this.count===1){const d=this.groupsView.getGroups(xe.MOST_RECENTLY_ACTIVE)[1];d&&(o?d.focus():this.groupsView.activateGroup(d,!0))}i&&this.model.closeEditor(i,e?.context);const s=this.model.activeEditor;if(s){let n;t&&this.groupsView.activeGroup!==this&&(n=w.PRESERVE);const d={preserveFocus:t,activation:n,ignoreError:e?.fromError},p={preserveWindowOrder:!0};this.doOpenEditor(s,d,p)}else i&&this.editorPane.closeEditor(i),o&&!r&&this.focus(),this._onDidActiveEditorChange.fire({editor:void 0}),r&&this.groupsView.removeGroup(this,t)}shouldRestoreFocus(t){const e=Z();return e===t.ownerDocument.body?!0:ht(e,t)}doCloseInactiveEditor(t,e){this.model.closeEditor(t,e?.context)}async handleCloseConfirmation(t){if(!t.length)return!1;const e=t.shift();let i=this.mapEditorToPendingConfirmation.get(e);i||(i=this.doHandleCloseConfirmation(e),this.mapEditorToPendingConfirmation.set(e,i));let o;try{o=await i}finally{this.mapEditorToPendingConfirmation.delete(e)}return o||this.handleCloseConfirmation(t)}async doHandleCloseConfirmation(t,e){if(!this.shouldConfirmClose(t)||t instanceof P&&this.model.contains(t.primary)||this.editorPartsView.groups.some(s=>{if(s===this)return!1;const n=s;return!!(n.contains(t,{supportSideBySide:h.BOTH})||t instanceof P&&n.contains(t.primary))}))return!1;let i=I.CANCEL,o=K.EXPLICIT,r=!1;if(!t.hasCapability(T.Untitled)&&!e?.skipAutoSave&&!t.closeHandler&&(this.filesConfigurationService.getAutoSaveMode(t).mode===dt.ON_FOCUS_CHANGE?(r=!0,i=I.SAVE,o=K.FOCUS_CHANGE):Dt&&(Tt||Ot)&&this.filesConfigurationService.getAutoSaveMode(t).mode===dt.ON_WINDOW_CHANGE&&(r=!0,i=I.SAVE,o=K.WINDOW_CHANGE)),!r)if((!this.activeEditor||!this.activeEditor.matches(t))&&await this.doOpenEditor(t),await this.hostService.focus(tt(this.element)),typeof t.closeHandler?.confirm=="function")i=await t.closeHandler.confirm([{editor:t,groupId:this.id}]);else{let s;t instanceof P?s=t.primary.getName():s=t.getName(),i=await this.fileDialogService.showSaveConfirm([s])}if(!t.closeHandler&&!this.shouldConfirmClose(t))return i===I.CANCEL;switch(i){case I.SAVE:return!await t.save(this.id,{reason:o})&&r?this.doHandleCloseConfirmation(t,{skipAutoSave:!0}):t.isDirty();case I.DONT_SAVE:try{return await t.revert(this.id),t.isDirty()}catch(s){return this.logService.error(s),await t.revert(this.id,{soft:!0}),t.isDirty()}case I.CANCEL:return!0}}shouldConfirmClose(t){return t.closeHandler?t.closeHandler.showConfirm():t.isDirty()&&!t.isSaving()}async closeEditors(t,e){if(this.isEmpty)return!0;const i=this.doGetEditorsToClose(t);return await this.handleCloseConfirmation(i.slice(0))?!1:(this.doCloseEditors(i,e),!0)}doGetEditorsToClose(t){if(Array.isArray(t))return t;const e=t,i=typeof e.direction=="number";let o=this.model.getEditors(i?y.SEQUENTIAL:y.MOST_RECENTLY_ACTIVE,e);return e.savedOnly?o=o.filter(r=>!r.isDirty()||r.isSaving()):i&&e.except?o=e.direction===Ce.LEFT?o.slice(0,this.model.indexOf(e.except,o)):o.slice(this.model.indexOf(e.except,o)+1):e.except&&(o=o.filter(r=>e.except&&!r.matches(e.except))),o}doCloseEditors(t,e){let i=!1;for(const o of t)this.isActive(o)?i=!0:this.doCloseInactiveEditor(o);i&&this.doCloseActiveEditor(e?.preserveFocus),t.length&&this.titleControl.closeEditors(t)}async closeAllEditors(t){if(this.isEmpty)return this.groupsView.partOptions.closeEmptyGroups&&this.groupsView.removeGroup(this),!0;let e=this.model.getEditors(y.MOST_RECENTLY_ACTIVE,t);return t?.excludeConfirming&&(e=e.filter(o=>!this.shouldConfirmClose(o))),await this.handleCloseConfirmation(e)?!1:(this.doCloseAllEditors(t),!0)}doCloseAllEditors(t){let e=this.model.getEditors(y.SEQUENTIAL,t);t?.excludeConfirming&&(e=e.filter(o=>!this.shouldConfirmClose(o)));const i=[];for(const o of e)this.isActive(o)||this.doCloseInactiveEditor(o),i.push(o);this.activeEditor&&i.includes(this.activeEditor)&&this.doCloseActiveEditor(),i.length&&this.titleControl.closeEditors(i)}async replaceEditors(t){let e;const i=[];for(let{editor:o,replacement:r,forceReplaceDirty:s,options:n}of t){const d=this.getIndexOfEditor(o);if(d>=0){const p=this.isActive(o);n?n.index=d:n={index:d},n.inactive=!p,n.pinned=n.pinned??!0;const v={editor:o,replacement:r,forceReplaceDirty:s,options:n};p?e=v:i.push(v)}}for(const{editor:o,replacement:r,forceReplaceDirty:s,options:n}of i)if(await this.doOpenEditor(r,n),!o.matches(r)){let d=!1;if(s?(this.doCloseEditor(o,!0,{context:D.REPLACE}),d=!0):d=await this.doCloseEditorWithConfirmationHandling(o,{preserveFocus:!0},{context:D.REPLACE}),!d)return}if(e){const o=this.doOpenEditor(e.replacement,e.options);e.editor.matches(e.replacement)||(e.forceReplaceDirty?this.doCloseEditor(e.editor,!0,{context:D.REPLACE}):await this.doCloseEditorWithConfirmationHandling(e.editor,{preserveFocus:!0},{context:D.REPLACE})),await o}}get isLocked(){return this.model.isLocked}lock(t){this.model.lock(t)}createEditorActions(t){const e=[],i=[];let o;const r=this.activeEditorPane;if(r instanceof Me){const s=r.scopedContextKeyService??this.scopedContextKeyService,n=t.add(this.menuService.createMenu(W.EditorTitle,s,{emitEventsForSubmenuChanges:!0,eventDebounceDelay:0}));o=n.onDidChange;const d=(p,v)=>v==="navigation"&&p.actions.length<=1;rt(n,{arg:this.resourceContext.get(),shouldForwardArgs:!0},{primary:e,secondary:i},"navigation",d)}else{const s=t.add(new m);o=s.event,t.add(this.onDidActiveEditorChange(()=>s.fire()))}return{actions:{primary:e,secondary:i},onDidChange:o}}updateStyles(){const t=this.isEmpty;t?this.element.style.backgroundColor=this.getColor(we)||"":this.element.style.backgroundColor="";const e=this.getColor(De)||this.getColor(Yt);!t&&e?(this.titleContainer.classList.add("title-border-bottom"),this.titleContainer.style.setProperty("--title-border-bottom-color",e)):(this.titleContainer.classList.remove("title-border-bottom"),this.titleContainer.style.removeProperty("--title-border-bottom-color"));const{showTabs:i}=this.groupsView.partOptions;this.titleContainer.style.backgroundColor=this.getColor(i==="multiple"?Pe:Te)||"",this.editorContainer.style.backgroundColor=this.getColor(zt)||""}element=document.createElement("div");get minimumWidth(){return this.editorPane.minimumWidth}get minimumHeight(){return this.editorPane.minimumHeight}get maximumWidth(){return this.editorPane.maximumWidth}get maximumHeight(){return this.editorPane.maximumHeight}get proportionalLayout(){return this.lastLayout?!(this.lastLayout.width===this.minimumWidth||this.lastLayout.height===this.minimumHeight):!0}_onDidChange=this._register(new gt);onDidChange=this._onDidChange.event;layout(t,e,i,o){this.lastLayout={width:t,height:e,top:i,left:o},this.element.classList.toggle("max-height-478px",e<=478);const r=this.titleControl.layout({container:new q(t,e),available:new q(t,e-this.editorPane.minimumHeight)});this.progressBar.getContainer().style.top=`${Math.max(this.titleHeight.offset-2,0)}px`;const s=Math.max(0,e-r.height);this.editorContainer.style.height=`${s}px`,this.editorPane.layout({width:t,height:s,top:i+r.height,left:o})}relayout(){if(this.lastLayout){const{width:t,height:e,top:i,left:o}=this.lastLayout;this.layout(t,e,i,o)}}setBoundarySashes(t){this.editorPane.setBoundarySashes(t)}toJSON(){return this.model.serialize()}dispose(){this._disposed=!0,this._onWillDispose.fire(),super.dispose()}};E=X([c(6,Vt),c(7,st),c(8,jt),c(9,Ut),c(10,Bt),c(11,_t),c(12,Rt),c(13,Lt),c(14,_e),c(15,Re),c(16,Xt),c(17,Nt),c(18,Ae),c(19,Ge),c(20,Gt),c(21,Mt)],E);export{E as EditorGroupView};
