var lt=Object.defineProperty;var ct=Object.getOwnPropertyDescriptor;var X=(x,f,t,e)=>{for(var i=e>1?void 0:e?ct(f,t):f,o=x.length-1,r;o>=0;o--)(r=x[o])&&(i=(e?r(f,t,i):r(i))||i);return e&&i&&lt(f,t,i),i},p=(x,f)=>(t,e)=>f(t,e,x);import"./media/editorgroupview.css";import{EditorGroupModel as q,isGroupEditorCloseEvent as pt,isGroupEditorOpenEvent as ht,isSerializedEditorGroupModel as ut}from"../../../common/editor/editorGroupModel.js";import{CloseDirection as Et,SaveReason as U,EditorsOrder as C,EditorResourceAccessor as b,EditorInputCapabilities as w,DEFAULT_EDITOR_ASSOCIATION as mt,SideBySideEditor as h,EditorCloseContext as D,GroupModelChangeKind as l,TEXT_DIFF_EDITOR_ID as vt}from"../../../common/editor.js";import{ActiveEditorGroupLockedContext as ft,ActiveEditorDirtyContext as Ct,EditorGroupEditorsCountContext as It,ActiveEditorStickyContext as gt,ActiveEditorPinnedContext as yt,ActiveEditorLastInGroupContext as St,ActiveEditorFirstInGroupContext as bt,ResourceContextKey as Ot,applyAvailableEditorIds as wt,ActiveEditorAvailableEditorIdsContext as Dt,ActiveEditorCanSplitInGroupContext as Tt,SideBySideEditorActiveContext as Pt,TextCompareEditorVisibleContext as xt,TextCompareEditorActiveContext as At,ActiveEditorContext as _t,ActiveEditorReadonlyContext as Rt,ActiveEditorCanRevertContext as Gt,ActiveEditorCanToggleReadonlyContext as Lt,ActiveCompareEditorCanSwapContext as kt,MultipleEditorsSelectedInGroupContext as Mt,TwoEditorsSelectedInGroupContext as Vt,SelectedEditorsInGroupFileOrUntitledResourceContextKey as Ft}from"../../../common/contextkeys.js";import"../../../common/editor/editorInput.js";import{SideBySideEditorInput as T}from"../../../common/editor/sideBySideEditorInput.js";import{Emitter as m,Relay as Bt}from"../../../../base/common/event.js";import{IInstantiationService as Nt}from"../../../../platform/instantiation/common/instantiation.js";import{Dimension as $,trackFocus as Ht,addDisposableListener as O,EventType as _,EventHelper as J,findParentWithClass as Z,isAncestor as Ut,isMouseEvent as Wt,isActiveElement as Kt,getWindow as tt,getActiveElement as et}from"../../../../base/browser/dom.js";import{ServiceCollection as Yt}from"../../../../platform/instantiation/common/serviceCollection.js";import{IContextKeyService as it}from"../../../../platform/contextkey/common/contextkey.js";import{ProgressBar as zt}from"../../../../base/browser/ui/progressbar/progressbar.js";import{IThemeService as Qt,Themable as jt}from"../../../../platform/theme/common/themeService.js";import{editorBackground as Xt,contrastBorder as qt}from"../../../../platform/theme/common/colorRegistry.js";import{EDITOR_GROUP_HEADER_TABS_BACKGROUND as $t,EDITOR_GROUP_HEADER_NO_TABS_BACKGROUND as Jt,EDITOR_GROUP_EMPTY_BACKGROUND as Zt,EDITOR_GROUP_HEADER_BORDER as te}from"../../../common/theme.js";import{GroupsOrder as ee}from"../../../services/editor/common/editorGroupsService.js";import{EditorPanes as ie}from"./editorPanes.js";import{IEditorProgressService as oe}from"../../../../platform/progress/common/progress.js";import{EditorProgressIndicator as re}from"../../../services/progress/browser/progressIndicator.js";import{localize as I}from"../../../../nls.js";import{coalesce as ot}from"../../../../base/common/arrays.js";import{MutableDisposable as rt,toDisposable as se}from"../../../../base/common/lifecycle.js";import{ITelemetryService as ne}from"../../../../platform/telemetry/common/telemetry.js";import{DeferredPromise as de,Promises as ae,RunOnceWorker as le}from"../../../../base/common/async.js";import{EventType as st}from"../../../../base/browser/touch.js";import{fillActiveEditorViewState as nt}from"./editor.js";import{ActionBar as ce}from"../../../../base/browser/ui/actionbar/actionbar.js";import{IKeybindingService as pe}from"../../../../platform/keybinding/common/keybinding.js";import"../../../../base/common/actions.js";import{IMenuService as he,MenuId as W}from"../../../../platform/actions/common/actions.js";import{StandardMouseEvent as ue}from"../../../../base/browser/mouseEvent.js";import{createAndFillInActionBarActions as dt}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{IContextMenuService as Ee}from"../../../../platform/contextview/browser/contextView.js";import{IEditorService as me}from"../../../services/editor/common/editorService.js";import{hash as ve}from"../../../../base/common/hash.js";import{getMimeTypes as fe}from"../../../../editor/common/services/languagesAssociations.js";import{extname as Ce,isEqual as K}from"../../../../base/common/resources.js";import{Schemas as R}from"../../../../base/common/network.js";import{EditorActivation as P}from"../../../../platform/editor/common/editor.js";import{IFileDialogService as Ie,ConfirmResult as g,IDialogService as ge}from"../../../../platform/dialogs/common/dialogs.js";import{IFilesConfigurationService as ye,AutoSaveMode as at}from"../../../services/filesConfiguration/common/filesConfigurationService.js";import{URI as Se}from"../../../../base/common/uri.js";import{IUriIdentityService as be}from"../../../../platform/uriIdentity/common/uriIdentity.js";import{isLinux as Oe,isMacintosh as we,isNative as De,isWindows as Te}from"../../../../base/common/platform.js";import{ILogService as Pe}from"../../../../platform/log/common/log.js";import{TelemetryTrustedValue as xe}from"../../../../platform/telemetry/common/telemetryUtils.js";import{defaultProgressBarStyles as Ae}from"../../../../platform/theme/browser/defaultStyles.js";import"../../../../base/browser/ui/sash/sash.js";import{EditorGroupWatermark as _e}from"./editorGroupWatermark.js";import{EditorTitleControl as Re}from"./editorTitleControl.js";import{EditorPane as Ge}from"./editorPane.js";import{IEditorResolverService as Le}from"../../../services/editor/common/editorResolverService.js";import{IHostService as ke}from"../../../services/host/browser/host.js";import{DiffEditorInput as Me}from"../../../common/editor/diffEditorInput.js";import{FileSystemProviderCapabilities as Ve,IFileService as Fe}from"../../../../platform/files/common/files.js";let E=class extends jt{constructor(t,e,i,o,r,s,n,d,c,v,y,G,L,k,M,Y,z,Q,V,F,B,N){super(c);this.editorPartsView=e;this.groupsView=i;this.groupsLabel=o;this._index=r;this.instantiationService=n;this.contextKeyService=d;this.telemetryService=v;this.keybindingService=y;this.menuService=G;this.contextMenuService=L;this.fileDialogService=k;this.editorService=M;this.filesConfigurationService=Y;this.uriIdentityService=z;this.logService=Q;this.editorResolverService=V;this.hostService=F;this.dialogService=B;this.fileService=N;t instanceof E?this.model=this._register(t.model.clone()):ut(t)?this.model=this._register(n.createInstance(q,t)):this.model=this._register(n.createInstance(q,void 0)),this.scopedContextKeyService=this._register(this.contextKeyService.createScoped(this.element)),this.element.classList.add(...ot(["editor-group-container",this.model.isLocked?"locked":void 0])),this.registerContainerListeners(),this.createContainerToolbar(),this.createContainerContextMenu(),this._register(this.instantiationService.createInstance(_e,this.element)),this.progressBar=this._register(new zt(this.element,Ae)),this.progressBar.hide(),this.scopedInstantiationService=this._register(this.instantiationService.createChild(new Yt([it,this.scopedContextKeyService],[oe,this._register(new re(this.progressBar,this))]))),this.resourceContext=this._register(this.scopedInstantiationService.createInstance(Ot)),this.handleGroupContextKeys(),this.titleContainer=document.createElement("div"),this.titleContainer.classList.add("title"),this.element.appendChild(this.titleContainer),this.titleControl=this._register(this.scopedInstantiationService.createInstance(Re,this.titleContainer,this.editorPartsView,this.groupsView,this,this.model)),this.editorContainer=document.createElement("div"),this.editorContainer.classList.add("editor-container"),this.element.appendChild(this.editorContainer),this.editorPane=this._register(this.scopedInstantiationService.createInstance(ie,this.element,this.editorContainer,this)),this._onDidChange.input=this.editorPane.onDidChangeSizeConstraints,this.doTrackFocus(),this.updateTitleContainer(),this.updateContainer(),this.updateStyles(),(this.restoreEditors(t,s)??Promise.resolve()).finally(()=>{this.whenRestoredPromise.complete()}),this.registerListeners()}static createNew(t,e,i,o,r,s){return r.createInstance(E,null,t,e,i,o,s)}static createFromSerialized(t,e,i,o,r,s,n){return s.createInstance(E,t,e,i,o,r,n)}static createCopy(t,e,i,o,r,s,n){return s.createInstance(E,t,e,i,o,r,n)}scopedContextKeyService;_onDidFocus=this._register(new m);onDidFocus=this._onDidFocus.event;_onWillDispose=this._register(new m);onWillDispose=this._onWillDispose.event;_onDidModelChange=this._register(new m);onDidModelChange=this._onDidModelChange.event;_onDidActiveEditorChange=this._register(new m);onDidActiveEditorChange=this._onDidActiveEditorChange.event;_onDidOpenEditorFail=this._register(new m);onDidOpenEditorFail=this._onDidOpenEditorFail.event;_onWillCloseEditor=this._register(new m);onWillCloseEditor=this._onWillCloseEditor.event;_onDidCloseEditor=this._register(new m);onDidCloseEditor=this._onDidCloseEditor.event;_onWillMoveEditor=this._register(new m);onWillMoveEditor=this._onWillMoveEditor.event;_onWillOpenEditor=this._register(new m);onWillOpenEditor=this._onWillOpenEditor.event;model;active;lastLayout;scopedInstantiationService;resourceContext;titleContainer;titleControl;progressBar;editorContainer;editorPane;disposedEditorsWorker=this._register(new le(t=>this.handleDisposedEditors(t),0));mapEditorToPendingConfirmation=new Map;containerToolBarMenuDisposable=this._register(new rt);whenRestoredPromise=new de;whenRestored=this.whenRestoredPromise.p;handleGroupContextKeys(){const t=this.editorPartsView.bind(Ct,this),e=this.editorPartsView.bind(yt,this),i=this.editorPartsView.bind(bt,this),o=this.editorPartsView.bind(St,this),r=this.editorPartsView.bind(gt,this),s=this.editorPartsView.bind(It,this),n=this.editorPartsView.bind(ft,this),d=Mt.bindTo(this.scopedContextKeyService),c=Vt.bindTo(this.scopedContextKeyService),v=Ft.bindTo(this.scopedContextKeyService),y=this.editorPartsView.bind(_t,this),G=this.editorPartsView.bind(Rt,this),L=this.editorPartsView.bind(Gt,this),k=this.editorPartsView.bind(Lt,this),M=this.editorPartsView.bind(kt,this),Y=this.editorPartsView.bind(xt,this),z=this.editorPartsView.bind(At,this),Q=this.editorPartsView.bind(Dt,this),V=this.editorPartsView.bind(Tt,this),F=this.editorPartsView.bind(Pt,this),B=this._register(new rt),N=()=>{B.clear(),this.scopedContextKeyService.bufferChangeEvents(()=>{const a=this.activeEditor,u=this.activeEditorPane;if(this.resourceContext.set(b.getOriginalUri(a,{supportSideBySide:h.PRIMARY})),wt(Q,a,this.editorResolverService),a?(V.set(a.hasCapability(w.CanSplitInGroup)),F.set(a.typeId===T.ID),t.set(a.isDirty()&&!a.isSaving()),B.value=a.onDidChangeDirty(()=>{t.set(a.isDirty()&&!a.isSaving())})):(V.set(!1),F.set(!1),t.set(!1)),u){y.set(u.getId()),L.set(!u.input.hasCapability(w.Untitled)),G.set(!!u.input.isReadonly());const S=b.getOriginalUri(u.input,{supportSideBySide:h.PRIMARY}),H=b.getOriginalUri(u.input,{supportSideBySide:h.SECONDARY});M.set(u.input instanceof Me&&!u.input.original.isReadonly()&&!!S&&(this.fileService.hasProvider(S)||S.scheme===R.untitled)&&!!H&&(this.fileService.hasProvider(H)||H.scheme===R.untitled)),k.set(!!S&&this.fileService.hasProvider(S)&&!this.fileService.hasCapability(S,Ve.Readonly));const j=u?.getId()===vt;z.set(j),Y.set(j)}else y.reset(),L.reset(),G.reset(),M.reset(),k.reset()})},A=a=>{switch(a.kind){case l.GROUP_LOCKED:n.set(this.isLocked);break;case l.EDITOR_ACTIVE:i.set(this.model.isFirst(this.model.activeEditor)),o.set(this.model.isLast(this.model.activeEditor)),e.set(this.model.activeEditor?this.model.isPinned(this.model.activeEditor):!1),r.set(this.model.activeEditor?this.model.isSticky(this.model.activeEditor):!1);break;case l.EDITOR_CLOSE:e.set(this.model.activeEditor?this.model.isPinned(this.model.activeEditor):!1),r.set(this.model.activeEditor?this.model.isSticky(this.model.activeEditor):!1);case l.EDITOR_OPEN:case l.EDITOR_MOVE:i.set(this.model.isFirst(this.model.activeEditor)),o.set(this.model.isLast(this.model.activeEditor));break;case l.EDITOR_PIN:a.editor&&a.editor===this.model.activeEditor&&e.set(this.model.isPinned(this.model.activeEditor));break;case l.EDITOR_STICKY:a.editor&&a.editor===this.model.activeEditor&&r.set(this.model.isSticky(this.model.activeEditor));break;case l.EDITORS_SELECTION:d.set(this.model.selectedEditors.length>1),c.set(this.model.selectedEditors.length===2),v.set(this.model.selectedEditors.every(u=>u.resource&&(this.fileService.hasProvider(u.resource)||u.resource.scheme===R.untitled)));break}s.set(this.count)};this._register(this.onDidModelChange(a=>A(a))),this._register(this.onDidActiveEditorChange(()=>N())),N(),A({kind:l.EDITOR_ACTIVE}),A({kind:l.GROUP_LOCKED})}registerContainerListeners(){this._register(O(this.element,_.DBLCLICK,t=>{this.isEmpty&&(J.stop(t),this.editorService.openEditor({resource:void 0,options:{pinned:!0,override:mt.id}},this.id))})),this._register(O(this.element,_.AUXCLICK,t=>{this.isEmpty&&t.button===1&&(J.stop(t,!0),this.groupsView.removeGroup(this))}))}createContainerToolbar(){const t=document.createElement("div");t.classList.add("editor-group-container-toolbar"),this.element.appendChild(t);const e=this._register(new ce(t,{ariaLabel:I("ariaLabelGroupActions","Empty editor group actions"),highlightToggledItems:!0})),i=this._register(this.menuService.createMenu(W.EmptyEditorGroup,this.scopedContextKeyService)),o=()=>{const r={primary:[],secondary:[]};this.containerToolBarMenuDisposable.value=se(()=>e.clear()),dt(i,{arg:{groupId:this.id},shouldForwardArgs:!0},r,"navigation");for(const s of[...r.primary,...r.secondary]){const n=this.keybindingService.lookupKeybinding(s.id);e.push(s,{icon:!0,label:!1,keybinding:n?.getLabel()})}};o(),this._register(i.onDidChange(o))}createContainerContextMenu(){this._register(O(this.element,_.CONTEXT_MENU,t=>this.onShowContainerContextMenu(t))),this._register(O(this.element,st.Contextmenu,()=>this.onShowContainerContextMenu()))}onShowContainerContextMenu(t){if(!this.isEmpty)return;let e=this.element;t&&(e=new ue(tt(this.element),t)),this.contextMenuService.showContextMenu({menuId:W.EmptyEditorGroupContext,contextKeyService:this.contextKeyService,getAnchor:()=>e,onHide:()=>{this.focus()}})}doTrackFocus(){const t=this._register(Ht(this.element));this._register(t.onDidFocus(()=>{this.isEmpty&&this._onDidFocus.fire()}));const e=i=>{let o;if(Wt(i)){if(i.button!==0||we&&i.ctrlKey)return;o=i.target}else o=i.initialTarget;Z(o,"monaco-action-bar",this.titleContainer)||Z(o,"monaco-breadcrumb-item",this.titleContainer)||setTimeout(()=>{this.focus()})};this._register(O(this.titleContainer,_.MOUSE_DOWN,i=>e(i))),this._register(O(this.titleContainer,st.Tap,i=>e(i))),this._register(this.editorPane.onDidFocus(()=>{this._onDidFocus.fire()}))}updateContainer(){this.isEmpty?(this.element.classList.add("empty"),this.element.tabIndex=0,this.element.setAttribute("aria-label",I("emptyEditorGroup","{0} (empty)",this.ariaLabel))):(this.element.classList.remove("empty"),this.element.removeAttribute("tabIndex"),this.element.removeAttribute("aria-label")),this.updateStyles()}updateTitleContainer(){this.titleContainer.classList.toggle("tabs",this.groupsView.partOptions.showTabs==="multiple"),this.titleContainer.classList.toggle("show-file-icons",this.groupsView.partOptions.showIcons)}restoreEditors(t,e){if(this.count===0)return;let i;t instanceof E?i=nt(t):i=Object.create(null);const o=this.model.activeEditor;if(!o)return;i.pinned=this.model.isPinned(o),i.sticky=this.model.isSticky(o),i.preserveFocus=!0;const r={preserveWindowOrder:!0,skipTitleUpdate:!0},s=et(),n=this.doShowEditor(o,{active:!0,isNew:!1},i,r).then(()=>{this.groupsView.activeGroup===this&&s&&Kt(s)&&!e?.preserveFocus&&this.focus()});return this.titleControl.openEditors(this.editors),n}registerListeners(){this._register(this.model.onDidModelChange(t=>this.onDidGroupModelChange(t))),this._register(this.groupsView.onDidChangeEditorPartOptions(t=>this.onDidChangeEditorPartOptions(t))),this._register(this.groupsView.onDidVisibilityChange(t=>this.onDidVisibilityChange(t))),this._register(this.onDidFocus(()=>this.onDidGainFocus()))}onDidGroupModelChange(t){switch(this._onDidModelChange.fire(t),t.kind){case l.GROUP_LOCKED:this.element.classList.toggle("locked",this.isLocked);break;case l.EDITORS_SELECTION:this.onDidChangeEditorSelection();break}if(t.editor)switch(t.kind){case l.EDITOR_OPEN:ht(t)&&this.onDidOpenEditor(t.editor,t.editorIndex);break;case l.EDITOR_CLOSE:pt(t)&&this.handleOnDidCloseEditor(t.editor,t.editorIndex,t.context,t.sticky);break;case l.EDITOR_WILL_DISPOSE:this.onWillDisposeEditor(t.editor);break;case l.EDITOR_DIRTY:this.onDidChangeEditorDirty(t.editor);break;case l.EDITOR_TRANSIENT:this.onDidChangeEditorTransient(t.editor);break;case l.EDITOR_LABEL:this.onDidChangeEditorLabel(t.editor);break}}onDidOpenEditor(t,e){this.telemetryService.publicLog("editorOpened",this.toEditorTelemetryDescriptor(t)),this.updateContainer()}handleOnDidCloseEditor(t,e,i,o){this._onWillCloseEditor.fire({groupId:this.id,editor:t,context:i,index:e,sticky:o});const r=[t];t instanceof T&&r.push(t.primary,t.secondary);for(const s of r)this.canDispose(s)&&s.dispose();this.telemetryService.publicLog("editorClosed",this.toEditorTelemetryDescriptor(t)),this.updateContainer(),this._onDidCloseEditor.fire({groupId:this.id,editor:t,context:i,index:e,sticky:o})}canDispose(t){for(const e of this.editorPartsView.groups)if(e instanceof E&&e.model.contains(t,{strictEquals:!0,supportSideBySide:h.ANY}))return!1;return!0}toResourceTelemetryDescriptor(t){if(!t)return;const e=t?t.scheme===R.file?t.fsPath:t.path:void 0;if(!e)return;let i=Ce(t);const o=i.indexOf("?");return i=o!==-1?i.substr(0,o):i,{mimeType:new xe(fe(t).join(", ")),scheme:t.scheme,ext:i,path:ve(e)}}toEditorTelemetryDescriptor(t){const e=t.getTelemetryDescriptor(),i=b.getOriginalUri(t,{supportSideBySide:h.BOTH});return Se.isUri(i)?(e.resource=this.toResourceTelemetryDescriptor(i),e):(i&&(i.primary&&(e.resource=this.toResourceTelemetryDescriptor(i.primary)),i.secondary&&(e.resourceSecondary=this.toResourceTelemetryDescriptor(i.secondary))),e)}onWillDisposeEditor(t){this.disposedEditorsWorker.work(t)}handleDisposedEditors(t){let e;const i=[];for(const o of t){const r=this.model.findEditor(o);if(!r)continue;const s=r[0];s.isDisposed()&&(this.model.isActive(s)?e=s:i.push(s))}for(const o of i)this.doCloseEditor(o,!0);e&&this.doCloseEditor(e,!0)}onDidChangeEditorPartOptions(t){this.updateTitleContainer(),this.titleControl.updateOptions(t.oldPartOptions,t.newPartOptions),(t.oldPartOptions.showTabs!==t.newPartOptions.showTabs||t.oldPartOptions.tabHeight!==t.newPartOptions.tabHeight||t.oldPartOptions.showTabs==="multiple"&&t.oldPartOptions.pinnedTabsOnSeparateRow!==t.newPartOptions.pinnedTabsOnSeparateRow)&&(this.relayout(),this.model.activeEditor&&this.titleControl.openEditors(this.model.getEditors(C.SEQUENTIAL))),this.updateStyles(),t.oldPartOptions.enablePreview&&!t.newPartOptions.enablePreview&&this.model.previewEditor&&this.pinEditor(this.model.previewEditor)}onDidChangeEditorDirty(t){this.pinEditor(t),this.titleControl.updateEditorDirty(t)}onDidChangeEditorTransient(t){!this.model.isTransient(t)&&!this.groupsView.partOptions.enablePreview&&this.pinEditor(t)}onDidChangeEditorLabel(t){this.titleControl.updateEditorLabel(t)}onDidChangeEditorSelection(){this.titleControl.updateEditorSelections()}onDidVisibilityChange(t){this.editorPane.setVisible(t)}onDidGainFocus(){this.activeEditor&&this.model.setTransient(this.activeEditor,!1)}get index(){return this._index}get label(){return this.groupsLabel?I("groupLabelLong","{0}: Group {1}",this.groupsLabel,this._index+1):I("groupLabel","Group {0}",this._index+1)}get ariaLabel(){return this.groupsLabel?I("groupAriaLabelLong","{0}: Editor Group {1}",this.groupsLabel,this._index+1):I("groupAriaLabel","Editor Group {0}",this._index+1)}_disposed=!1;get disposed(){return this._disposed}get isEmpty(){return this.count===0}get titleHeight(){return this.titleControl.getHeight()}notifyIndexChanged(t){this._index!==t&&(this._index=t,this.model.setIndex(t))}notifyLabelChanged(t){this.groupsLabel!==t&&(this.groupsLabel=t,this.model.setLabel(t))}setActive(t){this.active=t,!t&&this.activeEditor&&this.selectedEditors.length>1&&this.setSelection(this.activeEditor,[]),this.element.classList.toggle("active",t),this.element.classList.toggle("inactive",!t),this.titleControl.setActive(t),this.updateStyles(),this.model.setActive(void 0)}get id(){return this.model.id}get windowId(){return this.groupsView.windowId}get editors(){return this.model.getEditors(C.SEQUENTIAL)}get count(){return this.model.count}get stickyCount(){return this.model.stickyCount}get activeEditorPane(){return this.editorPane?this.editorPane.activeEditorPane??void 0:void 0}get activeEditor(){return this.model.activeEditor}get selectedEditors(){return this.model.selectedEditors}get previewEditor(){return this.model.previewEditor}isPinned(t){return this.model.isPinned(t)}isSticky(t){return this.model.isSticky(t)}isSelected(t){return this.model.isSelected(t)}isTransient(t){return this.model.isTransient(t)}isActive(t){return this.model.isActive(t)}async setSelection(t,e){this.isActive(t)?this.model.setSelection(t,e):await this.openEditor(t,{activation:P.ACTIVATE},{inactiveSelection:e})}contains(t,e){return this.model.contains(t,e)}getEditors(t,e){return this.model.getEditors(t,e)}findEditors(t,e){const i=this.uriIdentityService.asCanonicalUri(t);return this.getEditors(C.SEQUENTIAL).filter(o=>{if(o.resource&&K(o.resource,i))return!0;if(e?.supportSideBySide===h.PRIMARY||e?.supportSideBySide===h.ANY){const r=b.getCanonicalUri(o,{supportSideBySide:h.PRIMARY});if(r&&K(r,i))return!0}if(e?.supportSideBySide===h.SECONDARY||e?.supportSideBySide===h.ANY){const r=b.getCanonicalUri(o,{supportSideBySide:h.SECONDARY});if(r&&K(r,i))return!0}return!1})}getEditorByIndex(t){return this.model.getEditorByIndex(t)}getIndexOfEditor(t){return this.model.indexOf(t)}isFirst(t){return this.model.isFirst(t)}isLast(t){return this.model.isLast(t)}focus(){this.activeEditorPane?this.activeEditorPane.focus():this.element.focus(),this._onDidFocus.fire()}pinEditor(t=this.activeEditor||void 0){if(t&&!this.model.isPinned(t)){const e=this.model.pin(t);e&&this.titleControl.pinEditor(e)}}stickEditor(t=this.activeEditor||void 0){this.doStickEditor(t,!0)}unstickEditor(t=this.activeEditor||void 0){this.doStickEditor(t,!1)}doStickEditor(t,e){if(t&&this.model.isSticky(t)!==e){const i=this.getIndexOfEditor(t),o=e?this.model.stick(t):this.model.unstick(t);if(!o)return;const r=this.getIndexOfEditor(o);r!==i&&this.titleControl.moveEditor(o,i,r,!0),e?this.titleControl.stickEditor(o):this.titleControl.unstickEditor(o)}}async openEditor(t,e,i){return this.doOpenEditor(t,e,{...i,supportSideBySide:h.BOTH})}async doOpenEditor(t,e,i){if(!t||t.isDisposed())return;this._onWillOpenEditor.fire({editor:t,groupId:this.id});const o=e?.sticky||!this.groupsView.partOptions.enablePreview&&!e?.transient||t.isDirty()||(e?.pinned??typeof e?.index=="number")||typeof e?.index=="number"&&this.model.isSticky(e.index)||t.hasCapability(w.Scratchpad),r={index:e?e.index:void 0,pinned:o,sticky:e?.sticky||typeof e?.index=="number"&&this.model.isSticky(e.index),transient:!!e?.transient,inactiveSelection:i?.inactiveSelection,active:this.count===0||!e||!e.inactive,supportSideBySide:i?.supportSideBySide};!r.active&&!r.pinned&&this.model.activeEditor&&!this.model.isPinned(this.model.activeEditor)&&(r.active=!0);let s=!1,n=!1;if(e?.activation===P.ACTIVATE?s=!0:e?.activation===P.RESTORE?n=!0:e?.activation===P.PRESERVE?(s=!1,n=!1):r.active&&(s=!e||!e.preserveFocus,n=!s),typeof r.index=="number"){const y=this.model.indexOf(t);y!==-1&&y!==r.index&&this.doMoveEditorInsideGroup(t,r)}const{editor:d,isNew:c}=this.model.openEditor(t,r);c&&this.count===1&&this.editorPartsView.groups.length>1&&d.editorId&&this.groupsView.partOptions.autoLockGroups?.has(d.editorId)&&this.lock(!0);const v=this.doShowEditor(d,{active:!!r.active,isNew:c},e,i);return s?this.groupsView.activateGroup(this):n&&this.groupsView.restoreGroup(this),v}doShowEditor(t,e,i,o){let r;return e.active?r=(async()=>{const{pane:s,changed:n,cancelled:d,error:c}=await this.editorPane.openEditor(t,i,o,{newInGroup:e.isNew});if(!d)return n&&this._onDidActiveEditorChange.fire({editor:t}),c&&this._onDidOpenEditorFail.fire(t),!s&&this.activeEditor===t&&this.doCloseEditor(t,i?.preserveFocus,{fromError:!0}),s})():r=Promise.resolve(void 0),o?.skipTitleUpdate||this.titleControl.openEditor(t,o),r}async openEditors(t){const e=ot(t).filter(({editor:n})=>!n.isDisposed()),i=e.at(0);if(!i)return;const o={supportSideBySide:h.BOTH};await this.doOpenEditor(i.editor,i.options,o);const r=e.slice(1),s=this.getIndexOfEditor(i.editor)+1;return await ae.settled(r.map(({editor:n,options:d},c)=>this.doOpenEditor(n,{...d,inactive:!0,pinned:!0,index:s+c},{...o,skipTitleUpdate:!0}))),this.titleControl.openEditors(r.map(({editor:n})=>n)),this.editorPane.activeEditorPane??void 0}moveEditors(t,e){const i={skipTitleUpdate:this!==e};let o=!1;const r=new Set;for(const{editor:s,options:n}of t)this.moveEditor(s,e,n,i)?r.add(s):o=!0;return i.skipTitleUpdate&&(e.titleControl.openEditors(Array.from(r)),this.titleControl.closeEditors(Array.from(r))),!o}moveEditor(t,e,i,o){return this===e?(this.doMoveEditorInsideGroup(t,i),!0):this.doMoveOrCopyEditorAcrossGroups(t,e,i,{...o,keepCopy:!1})}doMoveEditorInsideGroup(t,e){const i=e?e.index:void 0;if(typeof i!="number")return;const o=this.model.indexOf(t),r=this.model.getEditorByIndex(o);if(r){if(o!==i){const s=this.model.stickyCount;this.model.moveEditor(r,i),this.model.pin(r),this.titleControl.moveEditor(r,o,i,s!==this.model.stickyCount),this.titleControl.pinEditor(r)}e?.sticky&&this.stickEditor(r)}}doMoveOrCopyEditorAcrossGroups(t,e,i,o){const r=o?.keepCopy;if(!r||t.hasCapability(w.Singleton)){const n=t.canMove(this.id,e.id);if(typeof n=="string")return this.dialogService.error(n,I("moveErrorDetails","Try saving or reverting the editor first and then try again.")),!1}const s=nt(this,t,{...i,pinned:!0,sticky:i?.sticky??(!r&&this.model.isSticky(t))});return r||this._onWillMoveEditor.fire({groupId:this.id,editor:t,target:e.id}),e.doOpenEditor(r?t.copy():t,s,o),r||this.doCloseEditor(t,!0,{...o,context:D.MOVE}),!0}copyEditors(t,e){const i={skipTitleUpdate:this!==e};for(const{editor:o,options:r}of t)this.copyEditor(o,e,r,i);if(i.skipTitleUpdate){const o=t.map(({editor:r})=>r);e.titleControl.openEditors(o)}}copyEditor(t,e,i,o){this===e?this.doMoveEditorInsideGroup(t,i):this.doMoveOrCopyEditorAcrossGroups(t,e,i,{...o,keepCopy:!0})}async closeEditor(t=this.activeEditor||void 0,e){return this.doCloseEditorWithConfirmationHandling(t,e)}async doCloseEditorWithConfirmationHandling(t=this.activeEditor||void 0,e,i){return!t||await this.handleCloseConfirmation([t])?!1:(this.doCloseEditor(t,e?.preserveFocus,i),!0)}doCloseEditor(t,e=this.groupsView.activeGroup!==this,i){i?.skipTitleUpdate||this.titleControl.beforeCloseEditor(t),this.model.isActive(t)?this.doCloseActiveEditor(e,i):this.doCloseInactiveEditor(t,i),i?.skipTitleUpdate||this.titleControl.closeEditor(t)}doCloseActiveEditor(t=this.groupsView.activeGroup!==this,e){const i=this.activeEditor,o=!t&&this.shouldRestoreFocus(this.element),r=this.groupsView.partOptions.closeEmptyGroups;if(r&&this.active&&this.count===1){const d=this.groupsView.getGroups(ee.MOST_RECENTLY_ACTIVE)[1];d&&(o?d.focus():this.groupsView.activateGroup(d,!0))}i&&this.model.closeEditor(i,e?.context);const s=this.model.activeEditor;if(s){let n;t&&this.groupsView.activeGroup!==this&&(n=P.PRESERVE);const d={preserveFocus:t,activation:n,ignoreError:e?.fromError},c={preserveWindowOrder:!0};this.doOpenEditor(s,d,c)}else i&&this.editorPane.closeEditor(i),o&&!r&&this.focus(),this._onDidActiveEditorChange.fire({editor:void 0}),r&&this.groupsView.removeGroup(this,t)}shouldRestoreFocus(t){const e=et();return e===t.ownerDocument.body?!0:Ut(e,t)}doCloseInactiveEditor(t,e){this.model.closeEditor(t,e?.context)}async handleCloseConfirmation(t){if(!t.length)return!1;const e=t.shift();let i=this.mapEditorToPendingConfirmation.get(e);i||(i=this.doHandleCloseConfirmation(e),this.mapEditorToPendingConfirmation.set(e,i));let o;try{o=await i}finally{this.mapEditorToPendingConfirmation.delete(e)}return o||this.handleCloseConfirmation(t)}async doHandleCloseConfirmation(t,e){if(!this.shouldConfirmClose(t)||t instanceof T&&this.model.contains(t.primary)||this.editorPartsView.groups.some(s=>{if(s===this)return!1;const n=s;return!!(n.contains(t,{supportSideBySide:h.BOTH})||t instanceof T&&n.contains(t.primary))}))return!1;let i=g.CANCEL,o=U.EXPLICIT,r=!1;if(!t.hasCapability(w.Untitled)&&!e?.skipAutoSave&&!t.closeHandler&&(this.filesConfigurationService.getAutoSaveMode(t).mode===at.ON_FOCUS_CHANGE?(r=!0,i=g.SAVE,o=U.FOCUS_CHANGE):De&&(Te||Oe)&&this.filesConfigurationService.getAutoSaveMode(t).mode===at.ON_WINDOW_CHANGE&&(r=!0,i=g.SAVE,o=U.WINDOW_CHANGE)),!r)if((!this.activeEditor||!this.activeEditor.matches(t))&&await this.doOpenEditor(t),await this.hostService.focus(tt(this.element)),typeof t.closeHandler?.confirm=="function")i=await t.closeHandler.confirm([{editor:t,groupId:this.id}]);else{let s;t instanceof T?s=t.primary.getName():s=t.getName(),i=await this.fileDialogService.showSaveConfirm([s])}if(!t.closeHandler&&!this.shouldConfirmClose(t))return i===g.CANCEL;switch(i){case g.SAVE:return!await t.save(this.id,{reason:o})&&r?this.doHandleCloseConfirmation(t,{skipAutoSave:!0}):t.isDirty();case g.DONT_SAVE:try{return await t.revert(this.id),t.isDirty()}catch(s){return this.logService.error(s),await t.revert(this.id,{soft:!0}),t.isDirty()}case g.CANCEL:return!0}}shouldConfirmClose(t){return t.closeHandler?t.closeHandler.showConfirm():t.isDirty()&&!t.isSaving()}async closeEditors(t,e){if(this.isEmpty)return!0;const i=this.doGetEditorsToClose(t);return await this.handleCloseConfirmation(i.slice(0))?!1:(this.doCloseEditors(i,e),!0)}doGetEditorsToClose(t){if(Array.isArray(t))return t;const e=t,i=typeof e.direction=="number";let o=this.model.getEditors(i?C.SEQUENTIAL:C.MOST_RECENTLY_ACTIVE,e);return e.savedOnly?o=o.filter(r=>!r.isDirty()||r.isSaving()):i&&e.except?o=e.direction===Et.LEFT?o.slice(0,this.model.indexOf(e.except,o)):o.slice(this.model.indexOf(e.except,o)+1):e.except&&(o=o.filter(r=>e.except&&!r.matches(e.except))),o}doCloseEditors(t,e){let i=!1;for(const o of t)this.isActive(o)?i=!0:this.doCloseInactiveEditor(o);i&&this.doCloseActiveEditor(e?.preserveFocus),t.length&&this.titleControl.closeEditors(t)}async closeAllEditors(t){if(this.isEmpty)return this.groupsView.partOptions.closeEmptyGroups&&this.groupsView.removeGroup(this),!0;let e=this.model.getEditors(C.MOST_RECENTLY_ACTIVE,t);return t?.excludeConfirming&&(e=e.filter(o=>!this.shouldConfirmClose(o))),await this.handleCloseConfirmation(e)?!1:(this.doCloseAllEditors(t),!0)}doCloseAllEditors(t){let e=this.model.getEditors(C.SEQUENTIAL,t);t?.excludeConfirming&&(e=e.filter(o=>!this.shouldConfirmClose(o)));const i=[];for(const o of e)this.isActive(o)||this.doCloseInactiveEditor(o),i.push(o);this.activeEditor&&i.includes(this.activeEditor)&&this.doCloseActiveEditor(),i.length&&this.titleControl.closeEditors(i)}async replaceEditors(t){let e;const i=[];for(let{editor:o,replacement:r,forceReplaceDirty:s,options:n}of t){const d=this.getIndexOfEditor(o);if(d>=0){const c=this.isActive(o);n?n.index=d:n={index:d},n.inactive=!c,n.pinned=n.pinned??!0;const v={editor:o,replacement:r,forceReplaceDirty:s,options:n};c?e=v:i.push(v)}}for(const{editor:o,replacement:r,forceReplaceDirty:s,options:n}of i)if(await this.doOpenEditor(r,n),!o.matches(r)){let d=!1;if(s?(this.doCloseEditor(o,!0,{context:D.REPLACE}),d=!0):d=await this.doCloseEditorWithConfirmationHandling(o,{preserveFocus:!0},{context:D.REPLACE}),!d)return}if(e){const o=this.doOpenEditor(e.replacement,e.options);e.editor.matches(e.replacement)||(e.forceReplaceDirty?this.doCloseEditor(e.editor,!0,{context:D.REPLACE}):await this.doCloseEditorWithConfirmationHandling(e.editor,{preserveFocus:!0},{context:D.REPLACE})),await o}}get isLocked(){return this.model.isLocked}lock(t){this.model.lock(t)}createEditorActions(t){const e=[],i=[];let o;const r=this.activeEditorPane;if(r instanceof Ge){const s=r.scopedContextKeyService??this.scopedContextKeyService,n=t.add(this.menuService.createMenu(W.EditorTitle,s,{emitEventsForSubmenuChanges:!0,eventDebounceDelay:0}));o=n.onDidChange;const d=(c,v)=>v==="navigation"&&c.actions.length<=1;dt(n,{arg:this.resourceContext.get(),shouldForwardArgs:!0},{primary:e,secondary:i},"navigation",d)}else{const s=t.add(new m);o=s.event,t.add(this.onDidActiveEditorChange(()=>s.fire()))}return{actions:{primary:e,secondary:i},onDidChange:o}}updateStyles(){const t=this.isEmpty;t?this.element.style.backgroundColor=this.getColor(Zt)||"":this.element.style.backgroundColor="";const e=this.getColor(te)||this.getColor(qt);!t&&e?(this.titleContainer.classList.add("title-border-bottom"),this.titleContainer.style.setProperty("--title-border-bottom-color",e)):(this.titleContainer.classList.remove("title-border-bottom"),this.titleContainer.style.removeProperty("--title-border-bottom-color"));const{showTabs:i}=this.groupsView.partOptions;this.titleContainer.style.backgroundColor=this.getColor(i==="multiple"?$t:Jt)||"",this.editorContainer.style.backgroundColor=this.getColor(Xt)||""}element=document.createElement("div");get minimumWidth(){return this.editorPane.minimumWidth}get minimumHeight(){return this.editorPane.minimumHeight}get maximumWidth(){return this.editorPane.maximumWidth}get maximumHeight(){return this.editorPane.maximumHeight}get proportionalLayout(){return this.lastLayout?!(this.lastLayout.width===this.minimumWidth||this.lastLayout.height===this.minimumHeight):!0}_onDidChange=this._register(new Bt);onDidChange=this._onDidChange.event;layout(t,e,i,o){this.lastLayout={width:t,height:e,top:i,left:o},this.element.classList.toggle("max-height-478px",e<=478);const r=this.titleControl.layout({container:new $(t,e),available:new $(t,e-this.editorPane.minimumHeight)});this.progressBar.getContainer().style.top=`${Math.max(this.titleHeight.offset-2,0)}px`;const s=Math.max(0,e-r.height);this.editorContainer.style.height=`${s}px`,this.editorPane.layout({width:t,height:s,top:i+r.height,left:o})}relayout(){if(this.lastLayout){const{width:t,height:e,top:i,left:o}=this.lastLayout;this.layout(t,e,i,o)}}setBoundarySashes(t){this.editorPane.setBoundarySashes(t)}toJSON(){return this.model.serialize()}dispose(){this._disposed=!0,this._onWillDispose.fire(),super.dispose()}};E=X([p(6,Nt),p(7,it),p(8,Qt),p(9,ne),p(10,pe),p(11,he),p(12,Ee),p(13,Ie),p(14,me),p(15,ye),p(16,be),p(17,Pe),p(18,Le),p(19,ke),p(20,ge),p(21,Fe)],E);export{E as EditorGroupView};
