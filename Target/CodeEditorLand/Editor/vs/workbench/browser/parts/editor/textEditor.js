var S=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var g=(u,i,e,t)=>{for(var o=t>1?void 0:t?v(i,e):i,r=u.length-1,a;r>=0;r--)(a=u[r])&&(o=(t?a(i,e,o):a(o))||o);return t&&o&&S(i,e,o),o},n=(u,i)=>(e,t)=>i(e,t,u);import{localize as b}from"../../../../nls.js";import{distinct as R,deepClone as O}from"../../../../base/common/objects.js";import{Emitter as C,Event as T}from"../../../../base/common/event.js";import{isObject as P,assertIsDefined as y}from"../../../../base/common/types.js";import{MutableDisposable as L}from"../../../../base/common/lifecycle.js";import{EditorPaneSelectionCompareResult as c,EditorPaneSelectionChangeReason as l}from"../../../common/editor.js";import{computeEditorAriaLabel as D}from"../../editor.js";import{AbstractEditorWithViewState as x}from"./editorWithViewState.js";import{IStorageService as M}from"../../../../platform/storage/common/storage.js";import{IInstantiationService as A}from"../../../../platform/instantiation/common/instantiation.js";import{ITelemetryService as _}from"../../../../platform/telemetry/common/telemetry.js";import{IThemeService as w}from"../../../../platform/theme/common/themeService.js";import{ITextResourceConfigurationService as N}from"../../../../editor/common/services/textResourceConfiguration.js";import{IEditorGroupsService as V}from"../../../services/editor/common/editorGroupsService.js";import{IEditorService as F}from"../../../services/editor/common/editorService.js";import{TextEditorSelectionRevealType as G,TextEditorSelectionSource as h}from"../../../../platform/editor/common/editor.js";import{IFileService as H}from"../../../../platform/files/common/files.js";let d=class extends x{constructor(e,t,o,r,a,f,E,m,I,W){super(e,t,d.VIEW_STATE_PREFERENCE_KEY,o,r,a,f,E,m,I);this.fileService=W;this._register(this.textResourceConfigurationService.onDidChangeConfiguration(s=>this.handleConfigurationChangeEvent(s))),this._register(T.any(this.editorGroupService.onDidAddGroup,this.editorGroupService.onDidRemoveGroup)(()=>{const s=this.computeAriaLabel();this.editorContainer?.setAttribute("aria-label",s),this.updateEditorControlOptions({ariaLabel:s})})),this._register(this.fileService.onDidChangeFileSystemProviderCapabilities(s=>this.onDidChangeFileSystemProvider(s.scheme))),this._register(this.fileService.onDidChangeFileSystemProviderRegistrations(s=>this.onDidChangeFileSystemProvider(s.scheme)))}static VIEW_STATE_PREFERENCE_KEY="textEditorViewState";_onDidChangeSelection=this._register(new C);onDidChangeSelection=this._onDidChangeSelection.event;_onDidChangeScroll=this._register(new C);onDidChangeScroll=this._onDidChangeScroll.event;editorContainer;hasPendingConfigurationChange;lastAppliedEditorOptions;inputListener=this._register(new L);handleConfigurationChangeEvent(e){const t=this.getActiveResource();this.shouldHandleConfigurationChangeEvent(e,t)&&(this.isVisible()?this.updateEditorConfiguration(t):this.hasPendingConfigurationChange=!0)}shouldHandleConfigurationChangeEvent(e,t){return e.affectsConfiguration(t,"editor")||e.affectsConfiguration(t,"problems.visibility")}consumePendingConfigurationChangeEvent(){this.hasPendingConfigurationChange&&(this.updateEditorConfiguration(),this.hasPendingConfigurationChange=!1)}computeConfiguration(e){const t=P(e.editor)?O(e.editor):Object.create(null);return Object.assign(t,this.getConfigurationOverrides(e)),t.ariaLabel=this.computeAriaLabel(),t}computeAriaLabel(){return this.input?D(this.input,void 0,this.group,this.editorGroupService.count):b("editor","Editor")}onDidChangeFileSystemProvider(e){this.input&&this.getActiveResource()?.scheme===e&&this.updateReadonly(this.input)}onDidChangeInputCapabilities(e){this.input===e&&this.updateReadonly(e)}updateReadonly(e){this.updateEditorControlOptions({...this.getReadonlyConfiguration(e.isReadonly())})}getReadonlyConfiguration(e){return{readOnly:!!e,readOnlyMessage:typeof e!="boolean"?e:void 0}}getConfigurationOverrides(e){return{overviewRulerLanes:3,lineNumbersMinChars:3,fixedOverflowWidgets:!0,...this.getReadonlyConfiguration(this.input?.isReadonly()),renderValidationDecorations:e.problems?.visibility!==!1?"on":"off"}}createEditor(e){this.editorContainer=e,this.createEditorControl(e,this.computeConfiguration(this.textResourceConfigurationService.getValue(this.getActiveResource()))),this.registerCodeEditorListeners()}registerCodeEditorListeners(){const e=this.getMainControl();e&&(this._register(e.onDidChangeModelLanguage(()=>this.updateEditorConfiguration())),this._register(e.onDidChangeModel(()=>this.updateEditorConfiguration())),this._register(e.onDidChangeCursorPosition(t=>this._onDidChangeSelection.fire({reason:this.toEditorPaneSelectionChangeReason(t)}))),this._register(e.onDidChangeModelContent(()=>this._onDidChangeSelection.fire({reason:l.EDIT}))),this._register(e.onDidScrollChange(()=>this._onDidChangeScroll.fire())))}toEditorPaneSelectionChangeReason(e){switch(e.source){case h.PROGRAMMATIC:return l.PROGRAMMATIC;case h.NAVIGATION:return l.NAVIGATION;case h.JUMP:return l.JUMP;default:return l.USER}}getSelection(){const e=this.getMainControl();if(e){const t=e.getSelection();if(t)return new p(t)}}async setInput(e,t,o,r){await super.setInput(e,t,o,r),this.inputListener.value=e.onDidChangeCapabilities(()=>this.onDidChangeInputCapabilities(e)),this.updateEditorConfiguration(),y(this.editorContainer).setAttribute("aria-label",this.computeAriaLabel())}clearInput(){this.inputListener.clear(),super.clearInput()}getScrollPosition(){const e=this.getMainControl();if(!e)throw new Error("Control has not yet been initialized");return{scrollTop:e.getScrollTop()-e.getTopForLineNumber(1),scrollLeft:e.getScrollLeft()}}setScrollPosition(e){const t=this.getMainControl();if(!t)throw new Error("Control has not yet been initialized");t.setScrollTop(e.scrollTop),e.scrollLeft&&t.setScrollLeft(e.scrollLeft)}setEditorVisible(e){e&&this.consumePendingConfigurationChangeEvent(),super.setEditorVisible(e)}toEditorViewStateResource(e){return e.resource}updateEditorConfiguration(e=this.getActiveResource()){let t;if(e&&(t=this.textResourceConfigurationService.getValue(e)),!t)return;const o=this.computeConfiguration(t);let r=o;this.lastAppliedEditorOptions&&(r=R(this.lastAppliedEditorOptions,r)),Object.keys(r).length>0&&(this.lastAppliedEditorOptions=o,this.updateEditorControlOptions(r))}getActiveResource(){const e=this.getMainControl();if(e){const t=e.getModel();if(t)return t.uri}if(this.input)return this.input.resource}dispose(){this.lastAppliedEditorOptions=void 0,super.dispose()}};d=g([n(2,_),n(3,A),n(4,M),n(5,N),n(6,w),n(7,F),n(8,V),n(9,H)],d);class p{constructor(i){this.textSelection=i}static TEXT_EDITOR_SELECTION_THRESHOLD=10;compare(i){if(!(i instanceof p))return c.DIFFERENT;const e=Math.min(this.textSelection.selectionStartLineNumber,this.textSelection.positionLineNumber),t=Math.min(i.textSelection.selectionStartLineNumber,i.textSelection.positionLineNumber);return e===t?c.IDENTICAL:Math.abs(e-t)<p.TEXT_EDITOR_SELECTION_THRESHOLD?c.SIMILAR:c.DIFFERENT}restore(i){return{...i,selection:this.textSelection,selectionRevealType:G.CenterIfOutsideViewport}}log(){return`line: ${this.textSelection.startLineNumber}-${this.textSelection.endLineNumber}, col:  ${this.textSelection.startColumn}-${this.textSelection.endColumn}`}}export{d as AbstractTextEditor,p as TextEditorPaneSelection};
