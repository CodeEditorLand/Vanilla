var C=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var h=(c,s,e,i)=>{for(var t=i>1?void 0:i?w(s,e):s,o=c.length-1,r;o>=0;o--)(r=c[o])&&(t=(i?r(s,e,t):r(t))||t);return i&&t&&C(s,e,t),t},d=(c,s)=>(e,i)=>s(e,i,c);import{multibyteAwareBtoa as I}from"../../../../base/browser/dom.js";import{deepClone as D}from"../../../../base/common/objects.js";import{isEqual as T}from"../../../../base/common/resources.js";import{StopWatch as b}from"../../../../base/common/stopwatch.js";import{assertIsDefined as g,isObject as F}from"../../../../base/common/types.js";import{URI as O}from"../../../../base/common/uri.js";import{DiffEditorWidget as v}from"../../../../editor/browser/widget/diffEditor/diffEditorWidget.js";import{ScrollType as y}from"../../../../editor/common/editorCommon.js";import{ITextResourceConfigurationService as R}from"../../../../editor/common/services/textResourceConfiguration.js";import{localize as m}from"../../../../nls.js";import{IContextKeyService as x}from"../../../../platform/contextkey/common/contextkey.js";import{EditorActivation as V}from"../../../../platform/editor/common/editor.js";import{ByteSize as M,FileOperationResult as L,IFileService as B,TooLargeFileOperationError as W}from"../../../../platform/files/common/files.js";import{IInstantiationService as A}from"../../../../platform/instantiation/common/instantiation.js";import{Registry as _}from"../../../../platform/registry/common/platform.js";import{IStorageService as U}from"../../../../platform/storage/common/storage.js";import{ITelemetryService as P}from"../../../../platform/telemetry/common/telemetry.js";import{IThemeService as j}from"../../../../platform/theme/common/themeService.js";import{EditorExtensions as z,TEXT_DIFF_EDITOR_ID as G,createTooLargeFileError as H,isEditorInput as k,isTextEditorViewState as K}from"../../../common/editor.js";import{DiffEditorInput as p}from"../../../common/editor/diffEditorInput.js";import{applyTextEditorOptions as S}from"../../../common/editor/editorOptions.js";import{TextDiffEditorModel as N}from"../../../common/editor/textDiffEditorModel.js";import{IEditorGroupsService as q}from"../../../services/editor/common/editorGroupsService.js";import{IEditorService as $}from"../../../services/editor/common/editorService.js";import{IPreferencesService as X}from"../../../services/preferences/common/preferences.js";import{TextFileOperationResult as Y}from"../../../services/textfile/common/textfiles.js";import{AbstractTextEditor as J}from"./textEditor.js";let f=class extends J{constructor(e,i,t,o,r,n,a,l,u,E){super(f.ID,e,i,t,o,r,a,n,l,u);this.preferencesService=E}static ID=G;diffEditorControl=void 0;inputLifecycleStopWatch=void 0;get scopedContextKeyService(){if(!this.diffEditorControl)return;const e=this.diffEditorControl.getOriginalEditor(),i=this.diffEditorControl.getModifiedEditor();return(e.hasTextFocus()?e:i).invokeWithinContext(t=>t.get(x))}getTitle(){return this.input?this.input.getName():m("textDiffEditor","Text Diff Editor")}createEditorControl(e,i){this.diffEditorControl=this._register(this.instantiationService.createInstance(v,e,i,{}))}updateEditorControlOptions(e){this.diffEditorControl?.updateOptions(e)}getMainControl(){return this.diffEditorControl?.getModifiedEditor()}_previousViewModel=null;async setInput(e,i,t,o){this._previousViewModel&&(this._previousViewModel.dispose(),this._previousViewModel=null),this.inputLifecycleStopWatch=void 0,await super.setInput(e,i,t,o);try{const r=await e.resolve();if(o.isCancellationRequested)return;if(!(r instanceof N)){this.openAsBinary(e,i);return}const n=g(this.diffEditorControl),a=r,l=a.textDiffEditorModel?n.createViewModel(a.textDiffEditorModel):null;this._previousViewModel=l,await l?.waitForDiff(),n.setModel(l);let u=!1;K(i?.viewState)||(u=this.restoreTextDiffEditorViewState(e,i,t,n));let E=!1;i&&(E=S(i,n,y.Immediate)),!E&&!u&&n.revealFirstDiff(),n.updateOptions({...this.getReadonlyConfiguration(a.modifiedModel?.isReadonly()),originalEditable:!a.originalModel?.isReadonly()}),n.handleInitialized(),this.inputLifecycleStopWatch=new b(!1)}catch(r){await this.handleSetInputError(r,e,i)}}async handleSetInputError(e,i,t){if(this.isFileBinaryError(e))return this.openAsBinary(i,t);if(e.fileOperationResult===L.FILE_TOO_LARGE){let o;throw e instanceof W?o=m("fileTooLargeForHeapErrorWithSize","At least one file is not displayed in the text compare editor because it is very large ({0}).",M.formatSize(e.size)):o=m("fileTooLargeForHeapErrorWithoutSize","At least one file is not displayed in the text compare editor because it is very large."),H(this.group,i,t,o,this.preferencesService)}throw e}restoreTextDiffEditorViewState(e,i,t,o){const r=this.loadEditorViewState(e,t);return r?(i?.selection&&r.modified&&(r.modified.cursorState=[]),o.restoreViewState(r),i?.revealIfVisible&&o.revealFirstDiff(),!0):!1}openAsBinary(e,i){const t=e.original,o=e.modified,r=this.instantiationService.createInstance(p,e.getName(),e.getDescription(),t,o,!0),n=_.as(z.EditorFactory).getFileEditorFactory();n.isFileEditor(t)&&t.setForceOpenAsBinary(),n.isFileEditor(o)&&o.setForceOpenAsBinary(),this.group.replaceEditors([{editor:e,replacement:r,options:{...i,activation:V.PRESERVE,pinned:this.group.isPinned(e),sticky:this.group.isSticky(e)}}])}setOptions(e){super.setOptions(e),e&&S(e,g(this.diffEditorControl),y.Smooth)}shouldHandleConfigurationChangeEvent(e,i){return super.shouldHandleConfigurationChangeEvent(e,i)?!0:e.affectsConfiguration(i,"diffEditor")||e.affectsConfiguration(i,"accessibility.verbosity.diffEditor")}computeConfiguration(e){const i=super.computeConfiguration(e);if(F(e.diffEditor)){const o=D(e.diffEditor);o.diffCodeLens=o.codeLens,delete o.codeLens,o.diffWordWrap=o.wordWrap,delete o.wordWrap,Object.assign(i,o)}const t=e.accessibility?.verbosity?.diffEditor??!1;return i.accessibilityVerbose=t,i}getConfigurationOverrides(e){return{...super.getConfigurationOverrides(e),...this.getReadonlyConfiguration(this.input?.isReadonly()),originalEditable:this.input instanceof p&&!this.input.original.isReadonly(),lineDecorationsWidth:"2ch"}}updateReadonly(e){e instanceof p?this.diffEditorControl?.updateOptions({...this.getReadonlyConfiguration(e.isReadonly()),originalEditable:!e.original.isReadonly()}):super.updateReadonly(e)}isFileBinaryError(e){return Array.isArray(e)?e.some(t=>this.isFileBinaryError(t)):e.textFileOperationResult===Y.FILE_IS_BINARY}clearInput(){this._previousViewModel&&(this._previousViewModel.dispose(),this._previousViewModel=null),super.clearInput();const e=this.inputLifecycleStopWatch?.elapsed();this.inputLifecycleStopWatch=void 0,typeof e=="number"&&this.logInputLifecycleTelemetry(e,this.getControl()?.getModel()?.modified?.getLanguageId()),this.diffEditorControl?.setModel(null)}logInputLifecycleTelemetry(e,i){let t=!1;this.diffEditorControl instanceof v&&(t=this.diffEditorControl.collapseUnchangedRegions),this.telemetryService.publicLog2("diffEditor.editorVisibleTime",{editorVisibleTimeMs:e,languageId:i??"",collapseUnchangedRegions:t})}getControl(){return this.diffEditorControl}focus(){super.focus(),this.diffEditorControl?.focus()}hasFocus(){return this.diffEditorControl?.hasTextFocus()||super.hasFocus()}setEditorVisible(e){super.setEditorVisible(e),e?this.diffEditorControl?.onVisible():this.diffEditorControl?.onHide()}layout(e){this.diffEditorControl?.layout(e)}setBoundarySashes(e){this.diffEditorControl?.setBoundarySashes(e)}tracksEditorViewState(e){return e instanceof p}computeEditorViewState(e){if(!this.diffEditorControl)return;const i=this.diffEditorControl.getModel();if(!i||!i.modified||!i.original)return;const t=this.toEditorViewStateResource(i);if(t&&T(t,e))return this.diffEditorControl.saveViewState()??void 0}toEditorViewStateResource(e){let i,t;if(e instanceof p?(i=e.original.resource,t=e.modified.resource):k(e)||(i=e.original.uri,t=e.modified.uri),!(!i||!t))return O.from({scheme:"diff",path:`${I(i.toString())}${I(t.toString())}`})}};f=h([d(1,P),d(2,A),d(3,U),d(4,R),d(5,$),d(6,j),d(7,q),d(8,B),d(9,X)],f);export{f as TextDiffEditor};
