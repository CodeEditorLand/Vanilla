var C=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var m=(u,s,e,i)=>{for(var t=i>1?void 0:i?w(s,e):s,o=u.length-1,r;o>=0;o--)(r=u[o])&&(t=(i?r(s,e,t):r(t))||t);return i&&t&&C(s,e,t),t},d=(u,s)=>(e,i)=>s(e,i,u);import{multibyteAwareBtoa as I}from"../../../../../vs/base/browser/dom.js";import"../../../../../vs/base/browser/ui/sash/sash.js";import"../../../../../vs/base/common/cancellation.js";import{deepClone as D}from"../../../../../vs/base/common/objects.js";import{isEqual as T}from"../../../../../vs/base/common/resources.js";import{StopWatch as F}from"../../../../../vs/base/common/stopwatch.js";import{assertIsDefined as g,isObject as b}from"../../../../../vs/base/common/types.js";import{URI as R}from"../../../../../vs/base/common/uri.js";import"../../../../../vs/editor/browser/editorBrowser.js";import{DiffEditorWidget as v}from"../../../../../vs/editor/browser/widget/diffEditor/diffEditorWidget.js";import"../../../../../vs/editor/common/config/editorOptions.js";import{ScrollType as y}from"../../../../../vs/editor/common/editorCommon.js";import{ITextResourceConfigurationService as O}from"../../../../../vs/editor/common/services/textResourceConfiguration.js";import{localize as h}from"../../../../../vs/nls.js";import{IContextKeyService as x}from"../../../../../vs/platform/contextkey/common/contextkey.js";import{EditorActivation as V}from"../../../../../vs/platform/editor/common/editor.js";import{ByteSize as M,FileOperationResult as L,IFileService as B,TooLargeFileOperationError as W}from"../../../../../vs/platform/files/common/files.js";import{IInstantiationService as A}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{Registry as _}from"../../../../../vs/platform/registry/common/platform.js";import{IStorageService as U}from"../../../../../vs/platform/storage/common/storage.js";import{ITelemetryService as P}from"../../../../../vs/platform/telemetry/common/telemetry.js";import{IThemeService as z}from"../../../../../vs/platform/theme/common/themeService.js";import{AbstractTextEditor as G}from"../../../../../vs/workbench/browser/parts/editor/textEditor.js";import{createTooLargeFileError as H,EditorExtensions as k,isEditorInput as K,isTextEditorViewState as N,TEXT_DIFF_EDITOR_ID as j}from"../../../../../vs/workbench/common/editor.js";import{DiffEditorInput as c}from"../../../../../vs/workbench/common/editor/diffEditorInput.js";import"../../../../../vs/workbench/common/editor/editorInput.js";import{applyTextEditorOptions as S}from"../../../../../vs/workbench/common/editor/editorOptions.js";import{TextDiffEditorModel as q}from"../../../../../vs/workbench/common/editor/textDiffEditorModel.js";import{IEditorGroupsService as $}from"../../../../../vs/workbench/services/editor/common/editorGroupsService.js";import{IEditorService as X}from"../../../../../vs/workbench/services/editor/common/editorService.js";import{IPreferencesService as Y}from"../../../../../vs/workbench/services/preferences/common/preferences.js";import{TextFileOperationResult as J}from"../../../../../vs/workbench/services/textfile/common/textfiles.js";let a=class extends G{constructor(e,i,t,o,r,n,f,l,p,E){super(a.ID,e,i,t,o,r,f,n,l,p);this.preferencesService=E}static ID=j;diffEditorControl=void 0;inputLifecycleStopWatch=void 0;get scopedContextKeyService(){if(!this.diffEditorControl)return;const e=this.diffEditorControl.getOriginalEditor(),i=this.diffEditorControl.getModifiedEditor();return(e.hasTextFocus()?e:i).invokeWithinContext(t=>t.get(x))}getTitle(){return this.input?this.input.getName():h("textDiffEditor","Text Diff Editor")}createEditorControl(e,i){this.diffEditorControl=this._register(this.instantiationService.createInstance(v,e,i,{}))}updateEditorControlOptions(e){this.diffEditorControl?.updateOptions(e)}getMainControl(){return this.diffEditorControl?.getModifiedEditor()}_previousViewModel=null;async setInput(e,i,t,o){this._previousViewModel&&(this._previousViewModel.dispose(),this._previousViewModel=null),this.inputLifecycleStopWatch=void 0,await super.setInput(e,i,t,o);try{const r=await e.resolve();if(o.isCancellationRequested)return;if(!(r instanceof q)){this.openAsBinary(e,i);return}const n=g(this.diffEditorControl),f=r,l=f.textDiffEditorModel?n.createViewModel(f.textDiffEditorModel):null;this._previousViewModel=l,await l?.waitForDiff(),n.setModel(l);let p=!1;N(i?.viewState)||(p=this.restoreTextDiffEditorViewState(e,i,t,n));let E=!1;i&&(E=S(i,n,y.Immediate)),!E&&!p&&n.revealFirstDiff(),n.updateOptions({...this.getReadonlyConfiguration(f.modifiedModel?.isReadonly()),originalEditable:!f.originalModel?.isReadonly()}),n.handleInitialized(),this.inputLifecycleStopWatch=new F(!1)}catch(r){await this.handleSetInputError(r,e,i)}}async handleSetInputError(e,i,t){if(this.isFileBinaryError(e))return this.openAsBinary(i,t);if(e.fileOperationResult===L.FILE_TOO_LARGE){let o;throw e instanceof W?o=h("fileTooLargeForHeapErrorWithSize","At least one file is not displayed in the text compare editor because it is very large ({0}).",M.formatSize(e.size)):o=h("fileTooLargeForHeapErrorWithoutSize","At least one file is not displayed in the text compare editor because it is very large."),H(this.group,i,t,o,this.preferencesService)}throw e}restoreTextDiffEditorViewState(e,i,t,o){const r=this.loadEditorViewState(e,t);return r?(i?.selection&&r.modified&&(r.modified.cursorState=[]),o.restoreViewState(r),i?.revealIfVisible&&o.revealFirstDiff(),!0):!1}openAsBinary(e,i){const t=e.original,o=e.modified,r=this.instantiationService.createInstance(c,e.getName(),e.getDescription(),t,o,!0),n=_.as(k.EditorFactory).getFileEditorFactory();n.isFileEditor(t)&&t.setForceOpenAsBinary(),n.isFileEditor(o)&&o.setForceOpenAsBinary(),this.group.replaceEditors([{editor:e,replacement:r,options:{...i,activation:V.PRESERVE,pinned:this.group.isPinned(e),sticky:this.group.isSticky(e)}}])}setOptions(e){super.setOptions(e),e&&S(e,g(this.diffEditorControl),y.Smooth)}shouldHandleConfigurationChangeEvent(e,i){return super.shouldHandleConfigurationChangeEvent(e,i)?!0:e.affectsConfiguration(i,"diffEditor")||e.affectsConfiguration(i,"accessibility.verbosity.diffEditor")}computeConfiguration(e){const i=super.computeConfiguration(e);if(b(e.diffEditor)){const o=D(e.diffEditor);o.diffCodeLens=o.codeLens,delete o.codeLens,o.diffWordWrap=o.wordWrap,delete o.wordWrap,Object.assign(i,o)}const t=e.accessibility?.verbosity?.diffEditor??!1;return i.accessibilityVerbose=t,i}getConfigurationOverrides(e){return{...super.getConfigurationOverrides(e),...this.getReadonlyConfiguration(this.input?.isReadonly()),originalEditable:this.input instanceof c&&!this.input.original.isReadonly(),lineDecorationsWidth:"2ch"}}updateReadonly(e){e instanceof c?this.diffEditorControl?.updateOptions({...this.getReadonlyConfiguration(e.isReadonly()),originalEditable:!e.original.isReadonly()}):super.updateReadonly(e)}isFileBinaryError(e){return Array.isArray(e)?e.some(t=>this.isFileBinaryError(t)):e.textFileOperationResult===J.FILE_IS_BINARY}clearInput(){this._previousViewModel&&(this._previousViewModel.dispose(),this._previousViewModel=null),super.clearInput();const e=this.inputLifecycleStopWatch?.elapsed();this.inputLifecycleStopWatch=void 0,typeof e=="number"&&this.logInputLifecycleTelemetry(e,this.getControl()?.getModel()?.modified?.getLanguageId()),this.diffEditorControl?.setModel(null)}logInputLifecycleTelemetry(e,i){let t=!1;this.diffEditorControl instanceof v&&(t=this.diffEditorControl.collapseUnchangedRegions),this.telemetryService.publicLog2("diffEditor.editorVisibleTime",{editorVisibleTimeMs:e,languageId:i??"",collapseUnchangedRegions:t})}getControl(){return this.diffEditorControl}focus(){super.focus(),this.diffEditorControl?.focus()}hasFocus(){return this.diffEditorControl?.hasTextFocus()||super.hasFocus()}setEditorVisible(e){super.setEditorVisible(e),e?this.diffEditorControl?.onVisible():this.diffEditorControl?.onHide()}layout(e){this.diffEditorControl?.layout(e)}setBoundarySashes(e){this.diffEditorControl?.setBoundarySashes(e)}tracksEditorViewState(e){return e instanceof c}computeEditorViewState(e){if(!this.diffEditorControl)return;const i=this.diffEditorControl.getModel();if(!i||!i.modified||!i.original)return;const t=this.toEditorViewStateResource(i);if(t&&T(t,e))return this.diffEditorControl.saveViewState()??void 0}toEditorViewStateResource(e){let i,t;if(e instanceof c?(i=e.original.resource,t=e.modified.resource):K(e)||(i=e.original.uri,t=e.modified.uri),!(!i||!t))return R.from({scheme:"diff",path:`${I(i.toString())}${I(t.toString())}`})}};a=m([d(1,P),d(2,A),d(3,U),d(4,O),d(5,X),d(6,z),d(7,$),d(8,B),d(9,Y)],a);export{a as TextDiffEditor};
