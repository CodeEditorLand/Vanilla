var C=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var v=(l,d,e,t)=>{for(var i=t>1?void 0:t?R(d,e):d,r=l.length-1,o;r>=0;r--)(o=l[r])&&(i=(t?o(d,e,i):o(i))||i);return t&&i&&C(d,e,i),i},s=(l,d)=>(e,t)=>d(e,t,l);import{Dimension as m,getActiveElement as f,getWindowById as T,hide as A,isAncestor as k,isEditableElement as W,show as H}from"../../../../base/browser/dom.js";import"../../../../base/browser/ui/sash/sash.js";import"../../../../base/common/actions.js";import{toErrorMessage as P}from"../../../../base/common/errorMessage.js";import{isCancellationError as V}from"../../../../base/common/errors.js";import{Emitter as I}from"../../../../base/common/event.js";import{Disposable as B,DisposableStore as L}from"../../../../base/common/lifecycle.js";import g from"../../../../base/common/severity.js";import{assertIsDefined as S}from"../../../../base/common/types.js";import{localize as y}from"../../../../nls.js";import{IDialogService as x}from"../../../../platform/dialogs/common/dialogs.js";import{EditorOpenSource as M}from"../../../../platform/editor/common/editor.js";import{IInstantiationService as F}from"../../../../platform/instantiation/common/instantiation.js";import{ILogService as N}from"../../../../platform/log/common/log.js";import{IEditorProgressService as z,LongRunningOperation as G}from"../../../../platform/progress/common/progress.js";import{Registry as U}from"../../../../platform/registry/common/platform.js";import{IWorkspaceTrustManagementService as q}from"../../../../platform/workspace/common/workspaceTrust.js";import{EditorExtensions as j,EditorInputCapabilities as D,isEditorOpenError as O}from"../../../common/editor.js";import"../../../common/editor/editorInput.js";import{IHostService as K}from"../../../services/host/browser/host.js";import{IWorkbenchLayoutService as X}from"../../../services/layout/browser/layoutService.js";import"../../editor.js";import{DEFAULT_EDITOR_MAX_DIMENSIONS as b,DEFAULT_EDITOR_MIN_DIMENSIONS as w}from"./editor.js";import"./editorPane.js";import{ErrorPlaceholderEditor as J,WorkspaceTrustRequiredPlaceholderEditor as Q}from"./editorPlaceholder.js";let E=class extends B{constructor(e,t,i,r,o,n,a,c,u,h){super();this.editorGroupParent=e;this.editorPanesParent=t;this.groupView=i;this.layoutService=r;this.instantiationService=o;this.editorProgressService=n;this.workspaceTrustService=a;this.logService=c;this.dialogService=u;this.hostService=h;this.registerListeners()}_onDidFocus=this._register(new I);onDidFocus=this._onDidFocus.event;_onDidChangeSizeConstraints=this._register(new I);onDidChangeSizeConstraints=this._onDidChangeSizeConstraints.event;get minimumWidth(){return this._activeEditorPane?.minimumWidth??w.width}get minimumHeight(){return this._activeEditorPane?.minimumHeight??w.height}get maximumWidth(){return this._activeEditorPane?.maximumWidth??b.width}get maximumHeight(){return this._activeEditorPane?.maximumHeight??b.height}_activeEditorPane=null;get activeEditorPane(){return this._activeEditorPane}editorPanes=[];activeEditorPaneDisposables=this._register(new L);pagePosition;boundarySashes;editorOperation=this._register(new G(this.editorProgressService));editorPanesRegistry=U.as(j.EditorPane);registerListeners(){this._register(this.workspaceTrustService.onDidChangeTrust(()=>this.onDidChangeWorkspaceTrust()))}onDidChangeWorkspaceTrust(){const e=this._activeEditorPane?.input,t=this._activeEditorPane?.options;e?.hasCapability(D.RequiresTrust)&&this.groupView.openEditor(e,t)}async openEditor(e,t,i,r=Object.create(null)){try{return await this.doOpenEditor(this.getEditorPaneDescriptor(e),e,t,i,r)}catch(o){return t?.ignoreError?{error:o}:this.doShowError(o,e,t,i,r)}}async doShowError(e,t,i,r,o){this.logService.error(e);let n=!1;if(i?.source===M.USER&&(!O(e)||e.allowDialog)&&(n=await this.doShowErrorDialog(e,t)),n)return{error:e};const a={...i};return V(e)||(a.error=e),{...await this.doOpenEditor(J.DESCRIPTOR,t,a,r,o),error:e}}async doShowErrorDialog(e,t){let i=g.Error,r,o=P(e),n;O(e)&&(n=e.actions,i=e.forceSeverity??g.Error,e.forceMessage&&(r=e.message,o=void 0)),r||(r=y("editorOpenErrorDialog","Unable to open '{0}'",t.getName()));const a=[];if(n&&n.length>0)for(const p of n)a.push({label:p.label,run:()=>p});else a.push({label:y({key:"ok",comment:["&& denotes a mnemonic"]},"&&OK"),run:()=>{}});let c;a.length===1&&(c={run:()=>{u=!0}});let u=!1;const{result:h}=await this.dialogService.prompt({type:i,message:r,detail:o,buttons:a,cancelButton:c});if(h){const p=h.run();p instanceof Promise&&p.catch(_=>this.dialogService.error(P(_))),u=!0}return u}async doOpenEditor(e,t,i,r,o=Object.create(null)){const n=this.doShowEditorPane(e),a=f(),{changed:c,cancelled:u}=await this.doSetInput(n,t,i,o);return u||((!i||!i.preserveFocus)&&this.shouldRestoreFocus(a)?n.focus():r?.preserveWindowOrder||this.hostService.moveTop(T(this.groupView.windowId,!0).window)),{pane:n,changed:c,cancelled:u}}shouldRestoreFocus(e){if(!this.layoutService.isRestored()||!e)return!0;const t=f();return!!(!t||t===e.ownerDocument.body||e===t||!W(t)||k(t,this.editorGroupParent))}getEditorPaneDescriptor(e){return e.hasCapability(D.RequiresTrust)&&!this.workspaceTrustService.isWorkspaceTrusted()?Q.DESCRIPTOR:S(this.editorPanesRegistry.getEditorPane(e))}doShowEditorPane(e){if(this._activeEditorPane&&e.describes(this._activeEditorPane))return this._activeEditorPane;this.doHideActiveEditorPane();const t=this.doCreateEditorPane(e);this.doSetActiveEditorPane(t);const i=S(t.getContainer());return this.editorPanesParent.appendChild(i),H(i),t.setVisible(!0),this.pagePosition&&t.layout(new m(this.pagePosition.width,this.pagePosition.height),{top:this.pagePosition.top,left:this.pagePosition.left}),this.boundarySashes&&t.setBoundarySashes(this.boundarySashes),t}doCreateEditorPane(e){const t=this.doInstantiateEditorPane(e);if(!t.getContainer()){const i=document.createElement("div");i.classList.add("editor-instance"),this.editorPanesParent.appendChild(i),t.create(i)}return t}doInstantiateEditorPane(e){const t=this.editorPanes.find(r=>e.describes(r));if(t)return t;const i=this._register(e.instantiate(this.instantiationService,this.groupView));return this.editorPanes.push(i),i}doSetActiveEditorPane(e){this._activeEditorPane=e,this.activeEditorPaneDisposables.clear(),e&&(this.activeEditorPaneDisposables.add(e.onDidChangeSizeConstraints(t=>this._onDidChangeSizeConstraints.fire(t))),this.activeEditorPaneDisposables.add(e.onDidFocus(()=>this._onDidFocus.fire()))),this._onDidChangeSizeConstraints.fire(void 0)}async doSetInput(e,t,i,r){const o=e.input?.matches(t);if(o&&!i?.forceReload)return e.setOptions(i),{changed:!1,cancelled:!1};const n=this.editorOperation.start(this.layoutService.isRestored()?800:3200);let a=!1;try{e.clearInput(),await e.setInput(t,i,r,n.token),n.isCurrent()||(a=!0)}catch(c){if(!n.isCurrent())a=!0;else throw c}finally{n.stop()}return{changed:!o,cancelled:a}}doHideActiveEditorPane(){if(!this._activeEditorPane)return;this.editorOperation.stop(),this.safeRun(()=>this._activeEditorPane?.clearInput()),this.safeRun(()=>this._activeEditorPane?.setVisible(!1));const e=this._activeEditorPane.getContainer();e&&(e.remove(),A(e)),this.doSetActiveEditorPane(null)}closeEditor(e){this._activeEditorPane?.input&&e.matches(this._activeEditorPane.input)&&this.doHideActiveEditorPane()}setVisible(e){this.safeRun(()=>this._activeEditorPane?.setVisible(e))}layout(e){this.pagePosition=e,this.safeRun(()=>this._activeEditorPane?.layout(new m(e.width,e.height),e))}setBoundarySashes(e){this.boundarySashes=e,this.safeRun(()=>this._activeEditorPane?.setBoundarySashes(e))}safeRun(e){try{e()}catch(t){this.logService.error(t)}}};E=v([s(3,X),s(4,F),s(5,z),s(6,q),s(7,N),s(8,x),s(9,K)],E);export{E as EditorPanes};
