var C=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var v=(p,d,e,t)=>{for(var i=t>1?void 0:t?R(d,e):d,r=p.length-1,o;r>=0;r--)(o=p[r])&&(i=(t?o(d,e,i):o(i))||i);return t&&i&&C(d,e,i),i},s=(p,d)=>(e,t)=>d(e,t,p);import{Dimension as m,getActiveElement as f,getWindowById as T,hide as A,isAncestor as k,show as W}from"../../../../../vs/base/browser/dom.js";import"../../../../../vs/base/browser/ui/sash/sash.js";import"../../../../../vs/base/common/actions.js";import{toErrorMessage as P}from"../../../../../vs/base/common/errorMessage.js";import{isCancellationError as H}from"../../../../../vs/base/common/errors.js";import{Emitter as g}from"../../../../../vs/base/common/event.js";import{Disposable as V,DisposableStore as B}from"../../../../../vs/base/common/lifecycle.js";import I from"../../../../../vs/base/common/severity.js";import{assertIsDefined as S}from"../../../../../vs/base/common/types.js";import{localize as y}from"../../../../../vs/nls.js";import{IDialogService as L}from"../../../../../vs/platform/dialogs/common/dialogs.js";import{EditorOpenSource as N}from"../../../../../vs/platform/editor/common/editor.js";import{IInstantiationService as x}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{ILogService as M}from"../../../../../vs/platform/log/common/log.js";import{IEditorProgressService as F,LongRunningOperation as z}from"../../../../../vs/platform/progress/common/progress.js";import{Registry as U}from"../../../../../vs/platform/registry/common/platform.js";import{IWorkspaceTrustManagementService as G}from"../../../../../vs/platform/workspace/common/workspaceTrust.js";import"../../../../../vs/workbench/browser/editor.js";import{DEFAULT_EDITOR_MAX_DIMENSIONS as D,DEFAULT_EDITOR_MIN_DIMENSIONS as O}from"../../../../../vs/workbench/browser/parts/editor/editor.js";import"../../../../../vs/workbench/browser/parts/editor/editorPane.js";import{ErrorPlaceholderEditor as q,WorkspaceTrustRequiredPlaceholderEditor as j}from"../../../../../vs/workbench/browser/parts/editor/editorPlaceholder.js";import{EditorExtensions as X,EditorInputCapabilities as w,isEditorOpenError as b}from"../../../../../vs/workbench/common/editor.js";import"../../../../../vs/workbench/common/editor/editorInput.js";import{IHostService as K}from"../../../../../vs/workbench/services/host/browser/host.js";import{IWorkbenchLayoutService as J}from"../../../../../vs/workbench/services/layout/browser/layoutService.js";let E=class extends V{constructor(e,t,i,r,o,n,a,c,u,h){super();this.editorGroupParent=e;this.editorPanesParent=t;this.groupView=i;this.layoutService=r;this.instantiationService=o;this.editorProgressService=n;this.workspaceTrustService=a;this.logService=c;this.dialogService=u;this.hostService=h;this.registerListeners()}_onDidFocus=this._register(new g);onDidFocus=this._onDidFocus.event;_onDidChangeSizeConstraints=this._register(new g);onDidChangeSizeConstraints=this._onDidChangeSizeConstraints.event;get minimumWidth(){return this._activeEditorPane?.minimumWidth??O.width}get minimumHeight(){return this._activeEditorPane?.minimumHeight??O.height}get maximumWidth(){return this._activeEditorPane?.maximumWidth??D.width}get maximumHeight(){return this._activeEditorPane?.maximumHeight??D.height}_activeEditorPane=null;get activeEditorPane(){return this._activeEditorPane}editorPanes=[];activeEditorPaneDisposables=this._register(new B);pagePosition;boundarySashes;editorOperation=this._register(new z(this.editorProgressService));editorPanesRegistry=U.as(X.EditorPane);registerListeners(){this._register(this.workspaceTrustService.onDidChangeTrust(()=>this.onDidChangeWorkspaceTrust()))}onDidChangeWorkspaceTrust(){const e=this._activeEditorPane?.input,t=this._activeEditorPane?.options;e?.hasCapability(w.RequiresTrust)&&this.groupView.openEditor(e,t)}async openEditor(e,t,i,r=Object.create(null)){try{return await this.doOpenEditor(this.getEditorPaneDescriptor(e),e,t,i,r)}catch(o){return t?.ignoreError?{error:o}:this.doShowError(o,e,t,i,r)}}async doShowError(e,t,i,r,o){this.logService.error(e);let n=!1;if(i?.source===N.USER&&(!b(e)||e.allowDialog)&&(n=await this.doShowErrorDialog(e,t)),n)return{error:e};const a={...i};return H(e)||(a.error=e),{...await this.doOpenEditor(q.DESCRIPTOR,t,a,r,o),error:e}}async doShowErrorDialog(e,t){let i=I.Error,r,o=P(e),n;b(e)&&(n=e.actions,i=e.forceSeverity??I.Error,e.forceMessage&&(r=e.message,o=void 0)),r||(r=y("editorOpenErrorDialog","Unable to open '{0}'",t.getName()));const a=[];if(n&&n.length>0)for(const l of n)a.push({label:l.label,run:()=>l});else a.push({label:y({key:"ok",comment:["&& denotes a mnemonic"]},"&&OK"),run:()=>{}});let c;a.length===1&&(c={run:()=>{u=!0}});let u=!1;const{result:h}=await this.dialogService.prompt({type:i,message:r,detail:o,buttons:a,cancelButton:c});if(h){const l=h.run();l instanceof Promise&&l.catch(_=>this.dialogService.error(P(_))),u=!0}return u}async doOpenEditor(e,t,i,r,o=Object.create(null)){const n=this.doShowEditorPane(e),a=f(),{changed:c,cancelled:u}=await this.doSetInput(n,t,i,o);return u||((!i||!i.preserveFocus)&&this.shouldRestoreFocus(a)?n.focus():r?.preserveWindowOrder||this.hostService.moveTop(T(this.groupView.windowId,!0).window)),{pane:n,changed:c,cancelled:u}}shouldRestoreFocus(e){if(!this.layoutService.isRestored()||!e)return!0;const t=f();return!!(!t||t===e.ownerDocument.body||e===t||t.tagName!=="INPUT"&&t.tagName!=="TEXTAREA"||k(t,this.editorGroupParent))}getEditorPaneDescriptor(e){return e.hasCapability(w.RequiresTrust)&&!this.workspaceTrustService.isWorkspaceTrusted()?j.DESCRIPTOR:S(this.editorPanesRegistry.getEditorPane(e))}doShowEditorPane(e){if(this._activeEditorPane&&e.describes(this._activeEditorPane))return this._activeEditorPane;this.doHideActiveEditorPane();const t=this.doCreateEditorPane(e);this.doSetActiveEditorPane(t);const i=S(t.getContainer());return this.editorPanesParent.appendChild(i),W(i),t.setVisible(!0),this.pagePosition&&t.layout(new m(this.pagePosition.width,this.pagePosition.height),{top:this.pagePosition.top,left:this.pagePosition.left}),this.boundarySashes&&t.setBoundarySashes(this.boundarySashes),t}doCreateEditorPane(e){const t=this.doInstantiateEditorPane(e);if(!t.getContainer()){const i=document.createElement("div");i.classList.add("editor-instance"),this.editorPanesParent.appendChild(i),t.create(i)}return t}doInstantiateEditorPane(e){const t=this.editorPanes.find(r=>e.describes(r));if(t)return t;const i=this._register(e.instantiate(this.instantiationService,this.groupView));return this.editorPanes.push(i),i}doSetActiveEditorPane(e){this._activeEditorPane=e,this.activeEditorPaneDisposables.clear(),e&&(this.activeEditorPaneDisposables.add(e.onDidChangeSizeConstraints(t=>this._onDidChangeSizeConstraints.fire(t))),this.activeEditorPaneDisposables.add(e.onDidFocus(()=>this._onDidFocus.fire()))),this._onDidChangeSizeConstraints.fire(void 0)}async doSetInput(e,t,i,r){const o=e.input?.matches(t);if(o&&!i?.forceReload)return e.setOptions(i),{changed:!1,cancelled:!1};const n=this.editorOperation.start(this.layoutService.isRestored()?800:3200);let a=!1;try{e.clearInput(),await e.setInput(t,i,r,n.token),n.isCurrent()||(a=!0)}catch(c){if(!n.isCurrent())a=!0;else throw c}finally{n.stop()}return{changed:!o,cancelled:a}}doHideActiveEditorPane(){if(!this._activeEditorPane)return;this.editorOperation.stop(),this.safeRun(()=>this._activeEditorPane?.clearInput()),this.safeRun(()=>this._activeEditorPane?.setVisible(!1));const e=this._activeEditorPane.getContainer();e&&(e.remove(),A(e)),this.doSetActiveEditorPane(null)}closeEditor(e){this._activeEditorPane?.input&&e.matches(this._activeEditorPane.input)&&this.doHideActiveEditorPane()}setVisible(e){this.safeRun(()=>this._activeEditorPane?.setVisible(e))}layout(e){this.pagePosition=e,this.safeRun(()=>this._activeEditorPane?.layout(new m(e.width,e.height),e))}setBoundarySashes(e){this.boundarySashes=e,this.safeRun(()=>this._activeEditorPane?.setBoundarySashes(e))}safeRun(e){try{e()}catch(t){this.logService.error(t)}}};E=v([s(3,J),s(4,x),s(5,F),s(6,G),s(7,M),s(8,L),s(9,K)],E);export{E as EditorPanes};
