var C=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var m=(c,p,e,t)=>{for(var i=t>1?void 0:t?R(p,e):p,r=c.length-1,o;r>=0;r--)(o=c[r])&&(i=(t?o(p,e,i):o(i))||i);return t&&i&&C(p,e,i),i},d=(c,p)=>(e,t)=>p(e,t,c);import{Dimension as v,getActiveElement as P,getWindowById as T,hide as A,isAncestor as k,isEditableElement as W,show as H}from"../../../../base/browser/dom.js";import{toErrorMessage as f}from"../../../../base/common/errorMessage.js";import{isCancellationError as V}from"../../../../base/common/errors.js";import{Emitter as I}from"../../../../base/common/event.js";import{Disposable as B,DisposableStore as L}from"../../../../base/common/lifecycle.js";import g from"../../../../base/common/severity.js";import{assertIsDefined as y}from"../../../../base/common/types.js";import{localize as S}from"../../../../nls.js";import{IDialogService as M}from"../../../../platform/dialogs/common/dialogs.js";import{EditorOpenSource as x}from"../../../../platform/editor/common/editor.js";import{IInstantiationService as F}from"../../../../platform/instantiation/common/instantiation.js";import{ILogService as N}from"../../../../platform/log/common/log.js";import{IEditorProgressService as j,LongRunningOperation as z}from"../../../../platform/progress/common/progress.js";import{Registry as G}from"../../../../platform/registry/common/platform.js";import{IWorkspaceTrustManagementService as U}from"../../../../platform/workspace/common/workspaceTrust.js";import{EditorExtensions as q,EditorInputCapabilities as D,isEditorOpenError as b}from"../../../common/editor.js";import{IHostService as K}from"../../../services/host/browser/host.js";import{IWorkbenchLayoutService as X}from"../../../services/layout/browser/layoutService.js";import{DEFAULT_EDITOR_MAX_DIMENSIONS as w,DEFAULT_EDITOR_MIN_DIMENSIONS as O}from"./editor.js";import{ErrorPlaceholderEditor as J,WorkspaceTrustRequiredPlaceholderEditor as Q}from"./editorPlaceholder.js";let E=class extends B{constructor(e,t,i,r,o,n,a,s,u,l){super();this.editorGroupParent=e;this.editorPanesParent=t;this.groupView=i;this.layoutService=r;this.instantiationService=o;this.editorProgressService=n;this.workspaceTrustService=a;this.logService=s;this.dialogService=u;this.hostService=l;this.registerListeners()}_onDidFocus=this._register(new I);onDidFocus=this._onDidFocus.event;_onDidChangeSizeConstraints=this._register(new I);onDidChangeSizeConstraints=this._onDidChangeSizeConstraints.event;get minimumWidth(){return this._activeEditorPane?.minimumWidth??O.width}get minimumHeight(){return this._activeEditorPane?.minimumHeight??O.height}get maximumWidth(){return this._activeEditorPane?.maximumWidth??w.width}get maximumHeight(){return this._activeEditorPane?.maximumHeight??w.height}_activeEditorPane=null;get activeEditorPane(){return this._activeEditorPane}editorPanes=[];mapEditorPaneToPendingSetInput=new Map;activeEditorPaneDisposables=this._register(new L);pagePosition;boundarySashes;editorOperation=this._register(new z(this.editorProgressService));editorPanesRegistry=G.as(q.EditorPane);registerListeners(){this._register(this.workspaceTrustService.onDidChangeTrust(()=>this.onDidChangeWorkspaceTrust()))}onDidChangeWorkspaceTrust(){const e=this._activeEditorPane?.input,t=this._activeEditorPane?.options;e?.hasCapability(D.RequiresTrust)&&this.groupView.openEditor(e,t)}async openEditor(e,t,i,r=Object.create(null)){try{return await this.doOpenEditor(this.getEditorPaneDescriptor(e),e,t,i,r)}catch(o){return t?.ignoreError?{error:o}:this.doShowError(o,e,t,i,r)}}async doShowError(e,t,i,r,o){this.logService.error(e);let n=!1;if(i?.source===x.USER&&(!b(e)||e.allowDialog)&&(n=await this.doShowErrorDialog(e,t)),n)return{error:e};const a={...i};return V(e)||(a.error=e),{...await this.doOpenEditor(J.DESCRIPTOR,t,a,r,o),error:e}}async doShowErrorDialog(e,t){let i=g.Error,r,o=f(e),n;b(e)&&(n=e.actions,i=e.forceSeverity??g.Error,e.forceMessage&&(r=e.message,o=void 0)),r||(r=S("editorOpenErrorDialog","Unable to open '{0}'",t.getName()));const a=[];if(n&&n.length>0)for(const h of n)a.push({label:h.label,run:()=>h});else a.push({label:S({key:"ok",comment:["&& denotes a mnemonic"]},"&&OK"),run:()=>{}});let s;a.length===1&&(s={run:()=>{u=!0}});let u=!1;const{result:l}=await this.dialogService.prompt({type:i,message:r,detail:o,buttons:a,cancelButton:s});if(l){const h=l.run();h instanceof Promise&&h.catch(_=>this.dialogService.error(f(_))),u=!0}return u}async doOpenEditor(e,t,i,r,o=Object.create(null)){const n=this.doShowEditorPane(e),a=P(),{changed:s,cancelled:u}=await this.doSetInput(n,t,i,o);return u||((!i||!i.preserveFocus)&&this.shouldRestoreFocus(a)?n.focus():r?.preserveWindowOrder||this.hostService.moveTop(T(this.groupView.windowId,!0).window)),{pane:n,changed:s,cancelled:u}}shouldRestoreFocus(e){if(!this.layoutService.isRestored()||!e)return!0;const t=P();return!!(!t||t===e.ownerDocument.body||e===t||!W(t)||k(t,this.editorGroupParent))}getEditorPaneDescriptor(e){return e.hasCapability(D.RequiresTrust)&&!this.workspaceTrustService.isWorkspaceTrusted()?Q.DESCRIPTOR:y(this.editorPanesRegistry.getEditorPane(e))}doShowEditorPane(e){if(this._activeEditorPane&&e.describes(this._activeEditorPane))return this._activeEditorPane;this.doHideActiveEditorPane();const t=this.doCreateEditorPane(e);this.doSetActiveEditorPane(t);const i=y(t.getContainer());return this.editorPanesParent.appendChild(i),H(i),t.setVisible(!0),this.pagePosition&&t.layout(new v(this.pagePosition.width,this.pagePosition.height),{top:this.pagePosition.top,left:this.pagePosition.left}),this.boundarySashes&&t.setBoundarySashes(this.boundarySashes),t}doCreateEditorPane(e){const t=this.doInstantiateEditorPane(e);if(!t.getContainer()){const i=document.createElement("div");i.classList.add("editor-instance"),this.editorPanesParent.appendChild(i),t.create(i)}return t}doInstantiateEditorPane(e){const t=this.editorPanes.find(r=>e.describes(r));if(t)return t;const i=this._register(e.instantiate(this.instantiationService,this.groupView));return this.editorPanes.push(i),i}doSetActiveEditorPane(e){this._activeEditorPane=e,this.activeEditorPaneDisposables.clear(),e&&(this.activeEditorPaneDisposables.add(e.onDidChangeSizeConstraints(t=>this._onDidChangeSizeConstraints.fire(t))),this.activeEditorPaneDisposables.add(e.onDidFocus(()=>this._onDidFocus.fire()))),this._onDidChangeSizeConstraints.fire(void 0)}async doSetInput(e,t,i,r){let o=e.input?.matches(t);if(o&&!i?.forceReload)return this.mapEditorPaneToPendingSetInput.has(e)&&await this.mapEditorPaneToPendingSetInput.get(e),o=e.input?.matches(t),o&&e.setOptions(i),{changed:!1,cancelled:!o};const n=this.editorOperation.start(this.layoutService.isRestored()?800:3200);let a=!1;try{e.clearInput();const s=e.setInput(t,i,r,n.token);this.mapEditorPaneToPendingSetInput.set(e,s),await s,n.isCurrent()||(a=!0)}catch(s){if(n.isCurrent())throw s;a=!0}finally{n.isCurrent()&&this.mapEditorPaneToPendingSetInput.delete(e),n.stop()}return{changed:!o,cancelled:a}}doHideActiveEditorPane(){if(!this._activeEditorPane)return;this.editorOperation.stop(),this.safeRun(()=>this._activeEditorPane?.clearInput()),this.safeRun(()=>this._activeEditorPane?.setVisible(!1)),this.mapEditorPaneToPendingSetInput.delete(this._activeEditorPane);const e=this._activeEditorPane.getContainer();e&&(e.remove(),A(e)),this.doSetActiveEditorPane(null)}closeEditor(e){this._activeEditorPane?.input&&e.matches(this._activeEditorPane.input)&&this.doHideActiveEditorPane()}setVisible(e){this.safeRun(()=>this._activeEditorPane?.setVisible(e))}layout(e){this.pagePosition=e,this.safeRun(()=>this._activeEditorPane?.layout(new v(e.width,e.height),e))}setBoundarySashes(e){this.boundarySashes=e,this.safeRun(()=>this._activeEditorPane?.setBoundarySashes(e))}safeRun(e){try{e()}catch(t){this.logService.error(t)}}};E=m([d(3,X),d(4,F),d(5,j),d(6,U),d(7,N),d(8,M),d(9,K)],E);export{E as EditorPanes};
