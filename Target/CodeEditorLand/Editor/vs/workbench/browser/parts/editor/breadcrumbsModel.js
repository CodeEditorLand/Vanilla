var m=Object.defineProperty;var g=Object.getOwnPropertyDescriptor;var d=(o,i,e,t)=>{for(var n=t>1?void 0:t?g(i,e):i,s=o.length-1,r;s>=0;s--)(r=o[s])&&(n=(t?r(i,e,n):r(n))||n);return t&&n&&m(i,e,n),n},a=(o,i)=>(e,t)=>i(e,t,o);import{CancellationTokenSource as b}from"../../../../base/common/cancellation.js";import{onUnexpectedError as v}from"../../../../base/common/errors.js";import{Emitter as I}from"../../../../base/common/event.js";import{DisposableStore as f,MutableDisposable as D,toDisposable as y}from"../../../../base/common/lifecycle.js";import{Schemas as p,matchesSomeScheme as F}from"../../../../base/common/network.js";import{dirname as E,isEqual as O}from"../../../../base/common/resources.js";import{IConfigurationService as S}from"../../../../platform/configuration/common/configuration.js";import{FileKind as h}from"../../../../platform/files/common/files.js";import{IWorkspaceContextService as P,WorkbenchState as k}from"../../../../platform/workspace/common/workspace.js";import{BreadcrumbsConfig as c}from"./breadcrumbs.js";import{IOutlineService as C,OutlineTarget as U}from"../../../services/outline/browser/outline.js";class u{constructor(i,e){this.uri=i;this.kind=e}}class _{constructor(i,e){this.element=i;this.outline=e}}let l=class{constructor(i,e,t,n,s){this.resource=i;this._workspaceService=n;this._outlineService=s;this._cfgFilePath=c.FilePath.bindTo(t),this._cfgSymbolPath=c.SymbolPath.bindTo(t),this._disposables.add(this._cfgFilePath.onDidChange(r=>this._onDidUpdate.fire(this))),this._disposables.add(this._cfgSymbolPath.onDidChange(r=>this._onDidUpdate.fire(this))),this._workspaceService.onDidChangeWorkspaceFolders(this._onDidChangeWorkspaceFolders,this,this._disposables),this._fileInfo=this._initFilePathInfo(i),e&&(this._bindToEditor(e),this._disposables.add(s.onDidChange(()=>this._bindToEditor(e))),this._disposables.add(e.onDidChangeControl(()=>this._bindToEditor(e)))),this._onDidUpdate.fire(this)}_disposables=new f;_fileInfo;_cfgFilePath;_cfgSymbolPath;_currentOutline=new D;_outlineDisposables=new f;_onDidUpdate=new I;onDidUpdate=this._onDidUpdate.event;dispose(){this._disposables.dispose(),this._cfgFilePath.dispose(),this._cfgSymbolPath.dispose(),this._currentOutline.dispose(),this._outlineDisposables.dispose(),this._onDidUpdate.dispose()}isRelative(){return!!this._fileInfo.folder}getElements(){let i=[];if(this._cfgFilePath.getValue()==="on"?i=i.concat(this._fileInfo.path):this._cfgFilePath.getValue()==="last"&&this._fileInfo.path.length>0&&(i=i.concat(this._fileInfo.path.slice(-1))),this._cfgSymbolPath.getValue()==="off"||!this._currentOutline.value)return i;const e=this._currentOutline.value.config.breadcrumbsDataSource.getBreadcrumbElements();for(let t=this._cfgSymbolPath.getValue()==="last"&&e.length>0?e.length-1:0;t<e.length;t++)i.push(new _(e[t],this._currentOutline.value));return e.length===0&&!this._currentOutline.value.isEmpty&&i.push(new _(this._currentOutline.value,this._currentOutline.value)),i}_initFilePathInfo(i){if(F(i,p.untitled,p.data))return{folder:void 0,path:[]};const e={folder:this._workspaceService.getWorkspaceFolder(i)??void 0,path:[]};let t=i;for(;t&&t.path!=="/"&&!(e.folder&&O(e.folder.uri,t));){e.path.unshift(new u(t,e.path.length===0?h.FILE:h.FOLDER));const n=t.path.length;if(t=E(t),t.path.length===n)break}return e.folder&&this._workspaceService.getWorkbenchState()===k.WORKSPACE&&e.path.unshift(new u(e.folder.uri,h.ROOT_FOLDER)),e}_onDidChangeWorkspaceFolders(){this._fileInfo=this._initFilePathInfo(this.resource),this._onDidUpdate.fire(this)}_bindToEditor(i){const e=new b;this._currentOutline.clear(),this._outlineDisposables.clear(),this._outlineDisposables.add(y(()=>e.dispose(!0))),this._outlineService.createOutline(i,U.Breadcrumbs,e.token).then(t=>{e.token.isCancellationRequested&&(t?.dispose(),t=void 0),this._currentOutline.value=t,this._onDidUpdate.fire(this),t&&this._outlineDisposables.add(t.onDidChange(()=>this._onDidUpdate.fire(this)))}).catch(t=>{this._onDidUpdate.fire(this),v(t)})}};l=d([a(2,S),a(3,P),a(4,C)],l);export{l as BreadcrumbsModel,u as FileElement,_ as OutlineElement2};
