var O=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var T=(h,l,i,t)=>{for(var o=t>1?void 0:t?w(l,i):l,e=h.length-1,s;e>=0;e--)(s=h[e])&&(o=(t?s(l,i,o):s(o))||o);return t&&o&&O(l,i,o),o},c=(h,l)=>(i,t)=>l(i,t,h);import"./media/notificationsToasts.css";import{localize as m}from"../../../../nls.js";import{NotificationChangeType as v,NotificationViewItemContentChangeKind as I}from"../../../common/notifications.js";import{dispose as y,toDisposable as b,DisposableStore as M}from"../../../../base/common/lifecycle.js";import{addDisposableListener as u,EventType as N,Dimension as S,scheduleAtNextAnimationFrame as A,isAncestorOfActiveElement as C,getWindow as _}from"../../../../base/browser/dom.js";import{IInstantiationService as x}from"../../../../platform/instantiation/common/instantiation.js";import{NotificationsList as R}from"./notificationsList.js";import{Event as H,Emitter as k}from"../../../../base/common/event.js";import{IWorkbenchLayoutService as F,Parts as D}from"../../../services/layout/browser/layoutService.js";import{NOTIFICATIONS_TOAST_BORDER as B,NOTIFICATIONS_BACKGROUND as P}from"../../../common/theme.js";import{IThemeService as G,Themable as U}from"../../../../platform/theme/common/themeService.js";import{widgetShadow as W}from"../../../../platform/theme/common/colorRegistry.js";import{IEditorGroupsService as K}from"../../../services/editor/common/editorGroupsService.js";import"./notificationsCommands.js";import{IContextKeyService as X}from"../../../../platform/contextkey/common/contextkey.js";import{Severity as p,NotificationsFilter as E,NotificationPriority as g}from"../../../../platform/notification/common/notification.js";import{ScrollbarVisibility as z}from"../../../../base/common/scrollable.js";import{ILifecycleService as $,LifecyclePhase as j}from"../../../services/lifecycle/common/lifecycle.js";import{IHostService as q}from"../../../services/host/browser/host.js";import{IntervalCounter as J}from"../../../../base/common/async.js";import{assertIsDefined as Q}from"../../../../base/common/types.js";import{NotificationsToastsVisibleContext as Y}from"../../../common/contextkeys.js";import{mainWindow as V}from"../../../../base/browser/window.js";var Z=(t=>(t[t.HIDDEN_OR_VISIBLE=0]="HIDDEN_OR_VISIBLE",t[t.HIDDEN=1]="HIDDEN",t[t.VISIBLE=2]="VISIBLE",t))(Z||{});let r=class extends U{constructor(i,t,o,e,s,n,a,f,d){super(s);this.container=i;this.model=t;this.instantiationService=o;this.layoutService=e;this.editorGroupService=n;this.contextKeyService=a;this.lifecycleService=f;this.hostService=d;this.registerListeners()}static MAX_WIDTH=450;static MAX_NOTIFICATIONS=3;static PURGE_TIMEOUT={[p.Info]:15e3,[p.Warning]:18e3,[p.Error]:2e4};static SPAM_PROTECTION={interval:800,limit:this.MAX_NOTIFICATIONS};_onDidChangeVisibility=this._register(new k);onDidChangeVisibility=this._onDidChangeVisibility.event;_isVisible=!1;get isVisible(){return!!this._isVisible}notificationsToastsContainer;workbenchDimensions;isNotificationsCenterVisible;mapNotificationToToast=new Map;mapNotificationToDisposable=new Map;notificationsToastsVisibleContextKey=Y.bindTo(this.contextKeyService);addedToastsIntervalCounter=new J(r.SPAM_PROTECTION.interval);registerListeners(){this._register(this.layoutService.onDidLayoutMainContainer(i=>this.layout(S.lift(i)))),this.lifecycleService.when(j.Restored).then(()=>{this.model.notifications.forEach(i=>this.addToast(i)),this._register(this.model.onDidChangeNotification(i=>this.onDidChangeNotification(i)))}),this._register(this.model.onDidChangeFilter(({global:i,sources:t})=>{if(i===E.ERROR)this.hide();else if(t)for(const[o]of this.mapNotificationToToast)typeof o.sourceId=="string"&&t.get(o.sourceId)===E.ERROR&&o.severity!==p.Error&&o.priority!==g.URGENT&&this.removeToast(o)}))}onDidChangeNotification(i){switch(i.kind){case v.ADD:return this.addToast(i.item);case v.REMOVE:return this.removeToast(i.item)}}addToast(i){if(this.isNotificationsCenterVisible||i.priority===g.SILENT||this.addedToastsIntervalCounter.increment()>r.SPAM_PROTECTION.limit)return;const t=new M;this.mapNotificationToDisposable.set(i,t),t.add(A(_(this.container),()=>this.doAddToast(i,t)))}doAddToast(i,t){let o=this.notificationsToastsContainer;o||(o=this.notificationsToastsContainer=document.createElement("div"),o.classList.add("notifications-toasts"),this.container.appendChild(o)),o.classList.add("visible");const e=document.createElement("div");e.classList.add("notification-toast-container");const s=o.firstChild;s?o.insertBefore(e,s):o.appendChild(e);const n=document.createElement("div");n.classList.add("notification-toast"),e.appendChild(n);const a=this.instantiationService.createInstance(R,n,{verticalScrollMode:z.Hidden,widgetAriaLabel:i.source?m("notificationWithSourceAriaLabel","{0}, source: {1}, notification",i.message.raw,i.source):m("notificationAriaLabel","{0}, notification",i.message.raw)});t.add(a);const f={item:i,list:a,container:e,toast:n};this.mapNotificationToToast.set(i,f),t.add(b(()=>this.updateToastVisibility(f,!1))),a.show();const d=this.computeMaxDimensions();this.layoutLists(d.width),a.updateNotificationsList(0,0,[i]),this.layoutContainer(d.height),t.add(i.onDidChangeExpansion(()=>{a.updateNotificationsList(0,1,[i])})),t.add(i.onDidChangeContent(L=>{switch(L.kind){case I.ACTIONS:a.updateNotificationsList(0,1,[i]);break;case I.MESSAGE:i.expanded&&a.updateNotificationHeight(i);break}})),H.once(i.onDidClose)(()=>{this.removeToast(i)}),this.purgeNotification(i,e,a,t),this.updateStyles(),this.notificationsToastsVisibleContextKey.set(!0),n.classList.add("notification-fade-in"),t.add(u(n,"transitionend",()=>{n.classList.remove("notification-fade-in"),n.classList.add("notification-fade-in-done")})),i.updateVisibility(!0),this._isVisible||(this._isVisible=!0,this._onDidChangeVisibility.fire())}purgeNotification(i,t,o,e){let s=!1;e.add(u(t,N.MOUSE_OVER,()=>s=!0)),e.add(u(t,N.MOUSE_OUT,()=>s=!1));let n,a;const f=()=>{n=setTimeout(()=>{this.hostService.hasFocus?i.sticky||o.hasFocus()||s?f():this.removeToast(i):a||(a=this.hostService.onDidChangeFocus(d=>{d&&f()}),e.add(a))},r.PURGE_TIMEOUT[i.severity])};f(),e.add(b(()=>clearTimeout(n)))}removeToast(i){let t=!1;const o=this.mapNotificationToToast.get(i);o&&(C(o.container)&&(t=!(this.focusNext()||this.focusPrevious())),this.mapNotificationToToast.delete(i));const e=this.mapNotificationToDisposable.get(i);e&&(y(e),this.mapNotificationToDisposable.delete(i)),this.mapNotificationToToast.size>0?this.layout(this.workbenchDimensions):(this.doHide(),t&&this.editorGroupService.activeGroup.focus())}removeToasts(){this.mapNotificationToToast.clear(),this.mapNotificationToDisposable.forEach(i=>y(i)),this.mapNotificationToDisposable.clear(),this.doHide()}doHide(){this.notificationsToastsContainer?.classList.remove("visible"),this.notificationsToastsVisibleContextKey.set(!1),this._isVisible&&(this._isVisible=!1,this._onDidChangeVisibility.fire())}hide(){const i=this.notificationsToastsContainer?C(this.notificationsToastsContainer):!1;this.removeToasts(),i&&this.editorGroupService.activeGroup.focus()}focus(){const i=this.getToasts(2);return i.length>0?(i[0].list.focusFirst(),!0):!1}focusNext(){const i=this.getToasts(2);for(let t=0;t<i.length;t++)if(i[t].list.hasFocus()){const e=i[t+1];if(e)return e.list.focusFirst(),!0;break}return!1}focusPrevious(){const i=this.getToasts(2);for(let t=0;t<i.length;t++)if(i[t].list.hasFocus()){const e=i[t-1];if(e)return e.list.focusFirst(),!0;break}return!1}focusFirst(){const i=this.getToasts(2)[0];return i?(i.list.focusFirst(),!0):!1}focusLast(){const i=this.getToasts(2);return i.length>0?(i[i.length-1].list.focusFirst(),!0):!1}update(i){this.isNotificationsCenterVisible!==i&&(this.isNotificationsCenterVisible=i,this.isNotificationsCenterVisible&&this.removeToasts())}updateStyles(){this.mapNotificationToToast.forEach(({toast:i})=>{const t=this.getColor(P);i.style.background=t||"";const o=this.getColor(W);i.style.boxShadow=o?`0 0 8px 2px ${o}`:"";const e=this.getColor(B);i.style.border=e?`1px solid ${e}`:""})}getToasts(i){const t=[];return this.mapNotificationToToast.forEach(o=>{switch(i){case 0:t.push(o);break;case 1:this.isToastInDOM(o)||t.push(o);break;case 2:this.isToastInDOM(o)&&t.push(o);break}}),t.reverse()}layout(i){this.workbenchDimensions=i;const t=this.computeMaxDimensions();t.height&&this.layoutContainer(t.height),this.layoutLists(t.width)}computeMaxDimensions(){const i=r.MAX_WIDTH;let t=i,o;return this.workbenchDimensions&&(t=this.workbenchDimensions.width,t-=2*8,o=this.workbenchDimensions.height,this.layoutService.isVisible(D.STATUSBAR_PART,V)&&(o-=22),this.layoutService.isVisible(D.TITLEBAR_PART,V)&&(o-=22),o-=2*12),o=typeof o=="number"?Math.round(o*.618):0,new S(Math.min(i,t),o)}layoutLists(i){this.mapNotificationToToast.forEach(({list:t})=>t.layout(i))}layoutContainer(i){let t=0;for(const o of this.getToasts(0)){o.container.style.opacity="0",this.updateToastVisibility(o,!0),i-=o.container.offsetHeight;let e=!1;t===r.MAX_NOTIFICATIONS?e=!1:i>=0&&(e=!0),this.updateToastVisibility(o,e),o.container.style.opacity="",e&&t++}}updateToastVisibility(i,t){if(this.isToastInDOM(i)===t)return;const o=Q(this.notificationsToastsContainer);t?o.appendChild(i.container):i.container.remove(),i.item.updateVisibility(t)}isToastInDOM(i){return!!i.container.parentElement}};r=T([c(2,x),c(3,F),c(4,G),c(5,K),c(6,X),c(7,$),c(8,q)],r);export{r as NotificationsToasts};
