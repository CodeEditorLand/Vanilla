var j=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var S=(f,o,e,t)=>{for(var i=t>1?void 0:t?q(o,e):o,s=f.length-1,n;s>=0;s--)(n=f[s])&&(i=(t?n(o,e,i):n(i))||i);return t&&i&&j(o,e,i),i},l=(f,o)=>(e,t)=>o(e,t,f);import{$ as Y,EventHelper as b,EventType as E,addDisposableListener as R,clearNode as A,isEventLike as $}from"../../../../base/browser/dom.js";import{DomEmitter as C}from"../../../../base/browser/event.js";import{StandardKeyboardEvent as z}from"../../../../base/browser/keyboardEvent.js";import{Gesture as X,EventType as J}from"../../../../base/browser/touch.js";import{ActionBar as Q}from"../../../../base/browser/ui/actionbar/actionbar.js";import{ButtonBar as Z}from"../../../../base/browser/ui/button/button.js";import{DropdownMenuActionViewItem as _}from"../../../../base/browser/ui/dropdown/dropdownActionViewItem.js";import{getDefaultHoverDelegate as O}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import{ProgressBar as ee}from"../../../../base/browser/ui/progressbar/progressbar.js";import{ActionRunner as te,Separator as ie,toAction as oe}from"../../../../base/common/actions.js";import{isNonEmptyArray as y}from"../../../../base/common/arrays.js";import{Codicon as H}from"../../../../base/common/codicons.js";import{Event as k}from"../../../../base/common/event.js";import{KeyCode as V}from"../../../../base/common/keyCodes.js";import{Disposable as se,DisposableStore as P,dispose as ne}from"../../../../base/common/lifecycle.js";import{ThemeIcon as B}from"../../../../base/common/themables.js";import{URI as re}from"../../../../base/common/uri.js";import{localize as h}from"../../../../nls.js";import{IContextMenuService as W}from"../../../../platform/contextview/browser/contextView.js";import{IHoverService as ae}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as G}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as ce}from"../../../../platform/keybinding/common/keybinding.js";import{INotificationService as le,NotificationsFilter as D,Severity as I,isNotificationSource as pe}from"../../../../platform/notification/common/notification.js";import{IOpenerService as de}from"../../../../platform/opener/common/opener.js";import{defaultButtonStyles as me,defaultProgressBarStyles as ue}from"../../../../platform/theme/browser/defaultStyles.js";import{ChoiceAction as K,NotificationViewItem as fe,NotificationViewItemContentChangeKind as L}from"../../../common/notifications.js";import{ClearNotificationAction as N,CollapseNotificationAction as M,ConfigureNotificationAction as w,ExpandNotificationAction as T}from"./notificationsActions.js";class m{static ROW_HEIGHT=42;static LINE_HEIGHT=22;offsetHelper;constructor(o){this.offsetHelper=this.createOffsetHelper(o)}createOffsetHelper(o){const e=document.createElement("div");return e.classList.add("notification-offset-helper"),o.appendChild(e),e}getHeight(o){if(!o.expanded)return m.ROW_HEIGHT;let e=m.ROW_HEIGHT;const t=this.computePreferredHeight(o);if(m.LINE_HEIGHT<t){const s=t-m.LINE_HEIGHT;e+=s}return(o.source||y(o.actions&&o.actions.primary))&&(e+=m.ROW_HEIGHT),e===m.ROW_HEIGHT&&o.collapse(!0),e}computePreferredHeight(o){let e=0;o.hasProgress||e++,o.canCollapse&&e++,y(o.actions&&o.actions.secondary)&&e++,this.offsetHelper.style.width=`${450-(40+e*30-Math.max(e-1,0)*4)}px`;const t=F.render(o.message);this.offsetHelper.appendChild(t);const i=Math.max(this.offsetHelper.offsetHeight,this.offsetHelper.scrollHeight);return A(this.offsetHelper),i}getTemplateId(o){if(o instanceof fe)return u.TEMPLATE_ID;throw new Error("unknown element type: "+o)}}class F{static render(o,e){const t=document.createElement("span");for(const i of o.linkedText.nodes)if(typeof i=="string")t.appendChild(document.createTextNode(i));else{let s=i.title;!s&&i.href.startsWith("command:")?s=h("executeCommand","Click to execute command '{0}'",i.href.substr(8)):s||(s=i.href);const n=Y("a",{href:i.href,title:s,tabIndex:0},i.label);if(e){const r=d=>{$(d)&&b.stop(d,!0),e.callback(i.href)},a=e.toDispose.add(new C(n,E.CLICK)).event,p=e.toDispose.add(new C(n,E.KEY_DOWN)).event,v=k.chain(p,d=>d.filter(U=>{const x=new z(U);return x.equals(V.Space)||x.equals(V.Enter)}));e.toDispose.add(X.addTarget(n));const g=e.toDispose.add(new C(n,J.Tap)).event;k.any(a,g,v)(r,null,e.toDispose)}t.appendChild(n)}return t}}let u=class{constructor(o,e,t,i){this.actionRunner=o;this.contextMenuService=e;this.instantiationService=t;this.notificationService=i}static TEMPLATE_ID="notification";get templateId(){return u.TEMPLATE_ID}renderTemplate(o){const e=Object.create(null);e.toDispose=new P,e.container=document.createElement("div"),e.container.classList.add("notification-list-item"),e.mainRow=document.createElement("div"),e.mainRow.classList.add("notification-list-item-main-row"),e.icon=document.createElement("div"),e.icon.classList.add("notification-list-item-icon","codicon"),e.message=document.createElement("div"),e.message.classList.add("notification-list-item-message");const t=this,i=document.createElement("div");return i.classList.add("notification-list-item-toolbar-container"),e.toolbar=new Q(i,{ariaLabel:h("notificationActions","Notification Actions"),actionViewItemProvider:(s,n)=>{if(s instanceof w)return e.toDispose.add(new _(s,{getActions(){const r=[],a={id:s.notification.sourceId,label:s.notification.source};if(pe(a)){const p=t.notificationService.getFilter(a)===D.ERROR;r.push(oe({id:a.id,label:p?h("turnOnNotifications","Turn On All Notifications from '{0}'",a.label):h("turnOffNotifications","Turn Off Info and Warning Notifications from '{0}'",a.label),run:()=>t.notificationService.setFilter({...a,filter:p?D.OFF:D.ERROR})})),s.notification.actions?.secondary?.length&&r.push(new ie)}return Array.isArray(s.notification.actions?.secondary)&&r.push(...s.notification.actions.secondary),r}},this.contextMenuService,{...n,actionRunner:this.actionRunner,classNames:s.class}))},actionRunner:this.actionRunner}),e.toDispose.add(e.toolbar),e.detailsRow=document.createElement("div"),e.detailsRow.classList.add("notification-list-item-details-row"),e.source=document.createElement("div"),e.source.classList.add("notification-list-item-source"),e.buttonsContainer=document.createElement("div"),e.buttonsContainer.classList.add("notification-list-item-buttons-container"),o.appendChild(e.container),e.container.appendChild(e.detailsRow),e.detailsRow.appendChild(e.source),e.detailsRow.appendChild(e.buttonsContainer),e.container.appendChild(e.mainRow),e.mainRow.appendChild(e.icon),e.mainRow.appendChild(e.message),e.mainRow.appendChild(i),e.progress=new ee(o,ue),e.toDispose.add(e.progress),e.renderer=this.instantiationService.createInstance(c,e,this.actionRunner),e.toDispose.add(e.renderer),e}renderElement(o,e,t){t.renderer.setInput(o)}disposeTemplate(o){ne(o.toDispose)}};u=S([l(1,W),l(2,G),l(3,le)],u);let c=class extends se{constructor(e,t,i,s,n,r,a){super();this.template=e;this.actionRunner=t;this.openerService=i;this.instantiationService=s;this.keybindingService=n;this.contextMenuService=r;this.hoverService=a;c.closeNotificationAction||(c.closeNotificationAction=s.createInstance(N,N.ID,N.LABEL),c.expandNotificationAction=s.createInstance(T,T.ID,T.LABEL),c.collapseNotificationAction=s.createInstance(M,M.ID,M.LABEL))}static closeNotificationAction;static expandNotificationAction;static collapseNotificationAction;static SEVERITIES=[I.Info,I.Warning,I.Error];inputDisposables=this._register(new P);setInput(e){this.inputDisposables.clear(),this.render(e)}render(e){this.template.container.classList.toggle("expanded",e.expanded),this.inputDisposables.add(R(this.template.container,E.MOUSE_UP,n=>{n.button===1&&b.stop(n,!0)})),this.inputDisposables.add(R(this.template.container,E.AUXCLICK,n=>{!e.hasProgress&&n.button===1&&(b.stop(n,!0),e.close())})),this.renderSeverity(e);const t=this.inputDisposables.add(this.hoverService.setupManagedHover(O("mouse"),this.template.message,"")),i=this.renderMessage(e,t);this.renderSecondaryActions(e,i);const s=this.inputDisposables.add(this.hoverService.setupManagedHover(O("mouse"),this.template.source,""));this.renderSource(e,s),this.renderButtons(e),this.renderProgress(e),this.inputDisposables.add(e.onDidChangeContent(n=>{switch(n.kind){case L.SEVERITY:this.renderSeverity(e);break;case L.PROGRESS:this.renderProgress(e);break;case L.MESSAGE:this.renderMessage(e,t);break}}))}renderSeverity(e){c.SEVERITIES.forEach(t=>{e.severity!==t&&this.template.icon.classList.remove(...B.asClassNameArray(this.toSeverityIcon(t)))}),this.template.icon.classList.add(...B.asClassNameArray(this.toSeverityIcon(e.severity)))}renderMessage(e,t){A(this.template.message),this.template.message.appendChild(F.render(e.message,{callback:s=>this.openerService.open(re.parse(s),{allowCommands:!0}),toDispose:this.inputDisposables}));const i=e.canCollapse&&!e.expanded&&this.template.message.scrollWidth>this.template.message.clientWidth;return t.update(i?this.template.message.textContent+"":""),i}renderSecondaryActions(e,t){const i=[];if(y(e.actions?.secondary)){const n=this.instantiationService.createInstance(w,w.ID,w.LABEL,e);i.push(n),this.inputDisposables.add(n)}let s=!1;e.canCollapse&&(e.expanded||e.source||t)&&(s=!0),s&&i.push(e.expanded?c.collapseNotificationAction:c.expandNotificationAction),e.hasProgress||i.push(c.closeNotificationAction),this.template.toolbar.clear(),this.template.toolbar.context=e,i.forEach(n=>this.template.toolbar.push(n,{icon:!0,label:!1,keybinding:this.getKeybindingLabel(n)}))}renderSource(e,t){e.expanded&&e.source?(this.template.source.textContent=h("notificationSource","Source: {0}",e.source),t.update(e.source)):(this.template.source.textContent="",t.update(""))}renderButtons(e){A(this.template.buttonsContainer);const t=e.actions?e.actions.primary:void 0;if(e.expanded&&y(t)){const i=this,s=new class extends te{async runAction(r){i.actionRunner.run(r,e),(!(r instanceof K)||!r.keepOpen)&&e.close()}},n=this.inputDisposables.add(new Z(this.template.buttonsContainer));for(let r=0;r<t.length;r++){const a=t[r],p={title:!0,secondary:r>0,...me},v=a instanceof K?a.menu:void 0,g=this.inputDisposables.add(v?n.addButtonWithDropdown({...p,contextMenuProvider:this.contextMenuService,actions:v,actionRunner:s}):n.addButton(p));g.label=a.label,this.inputDisposables.add(g.onDidClick(d=>{d&&b.stop(d,!0),s.run(a)}))}}}renderProgress(e){if(!e.hasProgress){this.template.progress.stop().hide();return}const t=e.progress.state;t.infinite?this.template.progress.infinite().show():typeof t.total=="number"||typeof t.worked=="number"?(typeof t.total=="number"&&!this.template.progress.hasTotal()&&this.template.progress.total(t.total),typeof t.worked=="number"&&this.template.progress.setWorked(t.worked).show()):this.template.progress.done().hide()}toSeverityIcon(e){switch(e){case I.Warning:return H.warning;case I.Error:return H.error}return H.info}getKeybindingLabel(e){const t=this.keybindingService.lookupKeybinding(e.id);return t?t.getLabel():null}};c=S([l(2,de),l(3,G),l(4,ce),l(5,W),l(6,ae)],c);export{u as NotificationRenderer,c as NotificationTemplateRenderer,m as NotificationsListDelegate};
