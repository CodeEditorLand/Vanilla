var j=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var S=(f,o,e,t)=>{for(var i=t>1?void 0:t?q(o,e):o,s=f.length-1,n;s>=0;s--)(n=f[s])&&(i=(t?n(o,e,i):n(i))||i);return t&&i&&j(o,e,i),i},l=(f,o)=>(e,t)=>o(e,t,f);import{clearNode as A,addDisposableListener as R,EventType as b,EventHelper as E,$ as Y,isEventLike as $}from"../../../../base/browser/dom.js";import{IOpenerService as z}from"../../../../platform/opener/common/opener.js";import{URI as X}from"../../../../base/common/uri.js";import{localize as h}from"../../../../nls.js";import{ButtonBar as J}from"../../../../base/browser/ui/button/button.js";import{ActionBar as Q}from"../../../../base/browser/ui/actionbar/actionbar.js";import{ActionRunner as Z,Separator as _,toAction as ee}from"../../../../base/common/actions.js";import{IInstantiationService as O}from"../../../../platform/instantiation/common/instantiation.js";import{dispose as te,DisposableStore as k,Disposable as ie}from"../../../../base/common/lifecycle.js";import{IContextMenuService as V}from"../../../../platform/contextview/browser/contextView.js";import{NotificationViewItem as oe,NotificationViewItemContentChangeKind as C,ChoiceAction as P}from"../../../common/notifications.js";import{ClearNotificationAction as H,ExpandNotificationAction as D,CollapseNotificationAction as L,ConfigureNotificationAction as w}from"./notificationsActions.js";import{IKeybindingService as se}from"../../../../platform/keybinding/common/keybinding.js";import{ProgressBar as ne}from"../../../../base/browser/ui/progressbar/progressbar.js";import{INotificationService as re,NotificationsFilter as N,Severity as I,isNotificationSource as ae}from"../../../../platform/notification/common/notification.js";import{isNonEmptyArray as y}from"../../../../base/common/arrays.js";import{Codicon as M}from"../../../../base/common/codicons.js";import{ThemeIcon as B}from"../../../../base/common/themables.js";import{DropdownMenuActionViewItem as ce}from"../../../../base/browser/ui/dropdown/dropdownActionViewItem.js";import{DomEmitter as T}from"../../../../base/browser/event.js";import{Gesture as le,EventType as pe}from"../../../../base/browser/touch.js";import{Event as W}from"../../../../base/common/event.js";import{defaultButtonStyles as de,defaultProgressBarStyles as me}from"../../../../platform/theme/browser/defaultStyles.js";import{KeyCode as G}from"../../../../base/common/keyCodes.js";import{StandardKeyboardEvent as ue}from"../../../../base/browser/keyboardEvent.js";import{getDefaultHoverDelegate as K}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import{IHoverService as fe}from"../../../../platform/hover/browser/hover.js";class m{static ROW_HEIGHT=42;static LINE_HEIGHT=22;offsetHelper;constructor(o){this.offsetHelper=this.createOffsetHelper(o)}createOffsetHelper(o){const e=document.createElement("div");return e.classList.add("notification-offset-helper"),o.appendChild(e),e}getHeight(o){if(!o.expanded)return m.ROW_HEIGHT;let e=m.ROW_HEIGHT;const t=this.computePreferredHeight(o);if(m.LINE_HEIGHT<t){const s=t-m.LINE_HEIGHT;e+=s}return(o.source||y(o.actions&&o.actions.primary))&&(e+=m.ROW_HEIGHT),e===m.ROW_HEIGHT&&o.collapse(!0),e}computePreferredHeight(o){let e=0;o.hasProgress||e++,o.canCollapse&&e++,y(o.actions&&o.actions.secondary)&&e++,this.offsetHelper.style.width=`${450-(10+30+e*30-Math.max(e-1,0)*4)}px`;const t=F.render(o.message);this.offsetHelper.appendChild(t);const i=Math.max(this.offsetHelper.offsetHeight,this.offsetHelper.scrollHeight);return A(this.offsetHelper),i}getTemplateId(o){if(o instanceof oe)return u.TEMPLATE_ID;throw new Error("unknown element type: "+o)}}class F{static render(o,e){const t=document.createElement("span");for(const i of o.linkedText.nodes)if(typeof i=="string")t.appendChild(document.createTextNode(i));else{let s=i.title;!s&&i.href.startsWith("command:")?s=h("executeCommand","Click to execute command '{0}'",i.href.substr(8)):s||(s=i.href);const n=Y("a",{href:i.href,title:s,tabIndex:0},i.label);if(e){const r=d=>{$(d)&&E.stop(d,!0),e.callback(i.href)},a=e.toDispose.add(new T(n,b.CLICK)).event,p=e.toDispose.add(new T(n,b.KEY_DOWN)).event,v=W.chain(p,d=>d.filter(U=>{const x=new ue(U);return x.equals(G.Space)||x.equals(G.Enter)}));e.toDispose.add(le.addTarget(n));const g=e.toDispose.add(new T(n,pe.Tap)).event;W.any(a,g,v)(r,null,e.toDispose)}t.appendChild(n)}return t}}let u=class{constructor(o,e,t,i){this.actionRunner=o;this.contextMenuService=e;this.instantiationService=t;this.notificationService=i}static TEMPLATE_ID="notification";get templateId(){return u.TEMPLATE_ID}renderTemplate(o){const e=Object.create(null);e.toDispose=new k,e.container=document.createElement("div"),e.container.classList.add("notification-list-item"),e.mainRow=document.createElement("div"),e.mainRow.classList.add("notification-list-item-main-row"),e.icon=document.createElement("div"),e.icon.classList.add("notification-list-item-icon","codicon"),e.message=document.createElement("div"),e.message.classList.add("notification-list-item-message");const t=this,i=document.createElement("div");return i.classList.add("notification-list-item-toolbar-container"),e.toolbar=new Q(i,{ariaLabel:h("notificationActions","Notification Actions"),actionViewItemProvider:(s,n)=>{if(s instanceof w)return e.toDispose.add(new ce(s,{getActions(){const r=[],a={id:s.notification.sourceId,label:s.notification.source};if(ae(a)){const p=t.notificationService.getFilter(a)===N.ERROR;r.push(ee({id:a.id,label:p?h("turnOnNotifications","Turn On All Notifications from '{0}'",a.label):h("turnOffNotifications","Turn Off Info and Warning Notifications from '{0}'",a.label),run:()=>t.notificationService.setFilter({...a,filter:p?N.OFF:N.ERROR})})),s.notification.actions?.secondary?.length&&r.push(new _)}return Array.isArray(s.notification.actions?.secondary)&&r.push(...s.notification.actions.secondary),r}},this.contextMenuService,{...n,actionRunner:this.actionRunner,classNames:s.class}))},actionRunner:this.actionRunner}),e.toDispose.add(e.toolbar),e.detailsRow=document.createElement("div"),e.detailsRow.classList.add("notification-list-item-details-row"),e.source=document.createElement("div"),e.source.classList.add("notification-list-item-source"),e.buttonsContainer=document.createElement("div"),e.buttonsContainer.classList.add("notification-list-item-buttons-container"),o.appendChild(e.container),e.container.appendChild(e.detailsRow),e.detailsRow.appendChild(e.source),e.detailsRow.appendChild(e.buttonsContainer),e.container.appendChild(e.mainRow),e.mainRow.appendChild(e.icon),e.mainRow.appendChild(e.message),e.mainRow.appendChild(i),e.progress=new ne(o,me),e.toDispose.add(e.progress),e.renderer=this.instantiationService.createInstance(c,e,this.actionRunner),e.toDispose.add(e.renderer),e}renderElement(o,e,t){t.renderer.setInput(o)}disposeTemplate(o){te(o.toDispose)}};u=S([l(1,V),l(2,O),l(3,re)],u);let c=class extends ie{constructor(e,t,i,s,n,r,a){super();this.template=e;this.actionRunner=t;this.openerService=i;this.instantiationService=s;this.keybindingService=n;this.contextMenuService=r;this.hoverService=a;c.closeNotificationAction||(c.closeNotificationAction=s.createInstance(H,H.ID,H.LABEL),c.expandNotificationAction=s.createInstance(D,D.ID,D.LABEL),c.collapseNotificationAction=s.createInstance(L,L.ID,L.LABEL))}static closeNotificationAction;static expandNotificationAction;static collapseNotificationAction;static SEVERITIES=[I.Info,I.Warning,I.Error];inputDisposables=this._register(new k);setInput(e){this.inputDisposables.clear(),this.render(e)}render(e){this.template.container.classList.toggle("expanded",e.expanded),this.inputDisposables.add(R(this.template.container,b.MOUSE_UP,n=>{n.button===1&&E.stop(n,!0)})),this.inputDisposables.add(R(this.template.container,b.AUXCLICK,n=>{!e.hasProgress&&n.button===1&&(E.stop(n,!0),e.close())})),this.renderSeverity(e);const t=this.inputDisposables.add(this.hoverService.setupManagedHover(K("mouse"),this.template.message,"")),i=this.renderMessage(e,t);this.renderSecondaryActions(e,i);const s=this.inputDisposables.add(this.hoverService.setupManagedHover(K("mouse"),this.template.source,""));this.renderSource(e,s),this.renderButtons(e),this.renderProgress(e),this.inputDisposables.add(e.onDidChangeContent(n=>{switch(n.kind){case C.SEVERITY:this.renderSeverity(e);break;case C.PROGRESS:this.renderProgress(e);break;case C.MESSAGE:this.renderMessage(e,t);break}}))}renderSeverity(e){c.SEVERITIES.forEach(t=>{e.severity!==t&&this.template.icon.classList.remove(...B.asClassNameArray(this.toSeverityIcon(t)))}),this.template.icon.classList.add(...B.asClassNameArray(this.toSeverityIcon(e.severity)))}renderMessage(e,t){A(this.template.message),this.template.message.appendChild(F.render(e.message,{callback:s=>this.openerService.open(X.parse(s),{allowCommands:!0}),toDispose:this.inputDisposables}));const i=e.canCollapse&&!e.expanded&&this.template.message.scrollWidth>this.template.message.clientWidth;return t.update(i?this.template.message.textContent+"":""),i}renderSecondaryActions(e,t){const i=[];if(y(e.actions?.secondary)){const n=this.instantiationService.createInstance(w,w.ID,w.LABEL,e);i.push(n),this.inputDisposables.add(n)}let s=!1;e.canCollapse&&(e.expanded||e.source||t)&&(s=!0),s&&i.push(e.expanded?c.collapseNotificationAction:c.expandNotificationAction),e.hasProgress||i.push(c.closeNotificationAction),this.template.toolbar.clear(),this.template.toolbar.context=e,i.forEach(n=>this.template.toolbar.push(n,{icon:!0,label:!1,keybinding:this.getKeybindingLabel(n)}))}renderSource(e,t){e.expanded&&e.source?(this.template.source.textContent=h("notificationSource","Source: {0}",e.source),t.update(e.source)):(this.template.source.textContent="",t.update(""))}renderButtons(e){A(this.template.buttonsContainer);const t=e.actions?e.actions.primary:void 0;if(e.expanded&&y(t)){const i=this,s=new class extends Z{async runAction(r){i.actionRunner.run(r,e),(!(r instanceof P)||!r.keepOpen)&&e.close()}},n=this.inputDisposables.add(new J(this.template.buttonsContainer));for(let r=0;r<t.length;r++){const a=t[r],p={title:!0,secondary:r>0,...de},v=a instanceof P?a.menu:void 0,g=this.inputDisposables.add(v?n.addButtonWithDropdown({...p,contextMenuProvider:this.contextMenuService,actions:v,actionRunner:s}):n.addButton(p));g.label=a.label,this.inputDisposables.add(g.onDidClick(d=>{d&&E.stop(d,!0),s.run(a)}))}}}renderProgress(e){if(!e.hasProgress){this.template.progress.stop().hide();return}const t=e.progress.state;t.infinite?this.template.progress.infinite().show():typeof t.total=="number"||typeof t.worked=="number"?(typeof t.total=="number"&&!this.template.progress.hasTotal()&&this.template.progress.total(t.total),typeof t.worked=="number"&&this.template.progress.setWorked(t.worked).show()):this.template.progress.done().hide()}toSeverityIcon(e){switch(e){case I.Warning:return M.warning;case I.Error:return M.error}return M.info}getKeybindingLabel(e){const t=this.keybindingService.lookupKeybinding(e.id);return t?t.getLabel():null}};c=S([l(2,z),l(3,O),l(4,se),l(5,V),l(6,fe)],c);export{u as NotificationRenderer,c as NotificationTemplateRenderer,m as NotificationsListDelegate};
