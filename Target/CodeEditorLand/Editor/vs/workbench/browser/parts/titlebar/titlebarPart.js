var he=Object.defineProperty;var ue=Object.getOwnPropertyDescriptor;var T=(h,s,t,e)=>{for(var i=e>1?void 0:e?ue(s,t):s,n=h.length-1,r;n>=0;n--)(r=h[n])&&(i=(e?r(s,t,i):r(i))||i);return e&&i&&he(s,t,i),i},o=(h,s)=>(t,e)=>s(t,e,h);import"./media/titlebarpart.css";import{getWCOTitlebarAreaRect as me,getZoomFactor as B,isWCOEnabled as $}from"../../../../base/browser/browser.js";import{$ as a,Dimension as q,EventHelper as J,EventType as X,addDisposableListener as Q,append as c,getActiveDocument as pe,getWindow as u,getWindowId as ve,isAncestor as be,isHTMLElement as ge,prepend as ee,reset as fe}from"../../../../base/browser/dom.js";import{StandardMouseEvent as Ie}from"../../../../base/browser/mouseEvent.js";import{ActionsOrientation as ye,prepareActions as te}from"../../../../base/browser/ui/actionbar/actionbar.js";import{AnchorAlignment as Te}from"../../../../base/browser/ui/contextview/contextview.js";import{createInstantHoverDelegate as Ce}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import{HoverPosition as ie}from"../../../../base/browser/ui/hover/hoverWidget.js";import{mainWindow as Ae}from"../../../../base/browser/window.js";import{ActionRunner as Se}from"../../../../base/common/actions.js";import{Codicon as Ee}from"../../../../base/common/codicons.js";import{Color as Me}from"../../../../base/common/color.js";import{Emitter as oe,Event as re}from"../../../../base/common/event.js";import{DisposableStore as m}from"../../../../base/common/lifecycle.js";import{isLinux as Be,isMacintosh as l,isNative as R,isWeb as d,isWindows as we,platformLocale as Le}from"../../../../base/common/platform.js";import{ThemeIcon as De}from"../../../../base/common/themables.js";import{localize as _e,localize2 as xe}from"../../../../nls.js";import{Categories as Ve}from"../../../../platform/action/common/actionCommonCategories.js";import{createActionViewItem as Oe,createAndFillInActionBarActions as Pe}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{WorkbenchToolBar as Re}from"../../../../platform/actions/browser/toolbar.js";import{Action2 as Ne,IMenuService as N,MenuId as C,registerAction2 as He}from"../../../../platform/actions/common/actions.js";import{CommandsRegistry as We}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as H}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as W}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as G}from"../../../../platform/contextview/browser/contextView.js";import{IInstantiationService as w}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as K}from"../../../../platform/keybinding/common/keybinding.js";import{IStorageService as L,StorageScope as Ge}from"../../../../platform/storage/common/storage.js";import{getIconRegistry as Ke}from"../../../../platform/theme/common/iconRegistry.js";import{IThemeService as D}from"../../../../platform/theme/common/themeService.js";import{DEFAULT_CUSTOM_TITLEBAR_HEIGHT as ke,getMenuBarVisibility as Fe,getTitleBarStyle as Ue,hasCustomTitlebar as _,hasNativeTitlebar as x}from"../../../../platform/window/common/window.js";import{ACCOUNTS_ACTIVITY_ID as ne,GLOBAL_ACTIVITY_ID as se}from"../../../common/activity.js";import{TITLE_BAR_ACTIVE_BACKGROUND as Ye,TITLE_BAR_ACTIVE_FOREGROUND as Ze,TITLE_BAR_BORDER as je,TITLE_BAR_INACTIVE_BACKGROUND as ze,TITLE_BAR_INACTIVE_FOREGROUND as $e,WORKBENCH_BACKGROUND as qe}from"../../../common/theme.js";import{IEditorGroupsService as k}from"../../../services/editor/common/editorGroupsService.js";import{IEditorService as F}from"../../../services/editor/common/editorService.js";import{IBrowserWorkbenchEnvironmentService as U}from"../../../services/environment/browser/environmentService.js";import{IHostService as Y}from"../../../services/host/browser/host.js";import{ActivityBarPosition as ae,EditorActionsLocation as le,EditorTabsMode as Je,IWorkbenchLayoutService as Z,LayoutSettings as v,Parts as ce}from"../../../services/layout/browser/layoutService.js";import{MultiWindowParts as Xe,Part as Qe}from"../../part.js";import{EDITOR_CORE_NAVIGATION_COMMANDS as et}from"../editor/editorCommands.js";import{EditorPane as tt}from"../editor/editorPane.js";import{EditorCommandsContextActionRunner as it}from"../editor/editorTabsControl.js";import{AccountsActivityActionViewItem as ot,SimpleAccountActivityActionViewItem as rt,SimpleGlobalActivityActionViewItem as nt,isAccountsActionVisible as st}from"../globalCompositeBar.js";import{CommandCenterControl as at}from"./commandCenterControl.js";import{CustomMenubarControl as lt}from"./menubarControl.js";import{ACCOUNTS_ACTIVITY_TILE_ACTION as ct,GLOBAL_ACTIVITY_TITLE_ACTION as dt}from"./titlebarActions.js";import{WindowTitle as ht}from"./windowTitle.js";let V=class extends Xe{constructor(t,e,i){super("workbench.titleService",i,e);this.instantiationService=t;this._register(this.registerPart(this.mainPart)),this.registerActions(),this.registerAPICommands()}mainPart=this._register(this.createMainTitlebarPart());createMainTitlebarPart(){return this.instantiationService.createInstance(A)}registerActions(){const t=this;this._register(He(class extends Ne{constructor(){super({id:"workbench.action.focusTitleBar",title:xe("focusTitleBar","Focus Title Bar"),category:Ve.View,f1:!0})}run(){t.getPartByDocument(pe()).focus()}}))}registerAPICommands(){this._register(We.registerCommand({id:"registerWindowTitleVariable",handler:(t,e,i)=>{this.registerVariables([{name:e,contextKey:i}])},metadata:{description:"Registers a new title variable",args:[{name:"name",schema:{type:"string"},description:"The name of the variable to register"},{name:"contextKey",schema:{type:"string"},description:"The context key to use for the value of the variable"}]}}))}createAuxiliaryTitlebarPart(t,e){const i=document.createElement("div");i.classList.add("part","titlebar"),i.setAttribute("role","none"),i.style.position="relative",t.insertBefore(i,t.firstChild);const n=new m,r=this.doCreateAuxiliaryTitlebarPart(i,e);return n.add(this.registerPart(r)),n.add(re.runAndSubscribe(r.onDidChange,()=>i.style.height=`${r.height}px`)),r.create(i),this.properties&&r.updateProperties(this.properties),this.variables.size&&r.registerVariables(Array.from(this.variables.values())),re.once(r.onWillDispose)(()=>n.dispose()),r}doCreateAuxiliaryTitlebarPart(t,e){return this.instantiationService.createInstance(p,t,e,this.mainPart)}onMenubarVisibilityChange=this.mainPart.onMenubarVisibilityChange;properties=void 0;updateProperties(t){this.properties=t;for(const e of this.parts)e.updateProperties(t)}variables=new Map;registerVariables(t){const e=[];for(const i of t)this.variables.has(i.name)||(this.variables.set(i.name,i),e.push(i));for(const i of this.parts)i.registerVariables(e)}};V=T([o(0,w),o(1,L),o(2,D)],V);let b=class extends Qe{constructor(t,e,i,n,r,S,g,f,I,y,E,M,O,P,j,z){super(t,{hasTitle:!1},f,I,y);this.contextMenuService=n;this.configurationService=r;this.environmentService=S;this.instantiationService=g;this.storageService=I;this.contextKeyService=E;this.hostService=M;this.editorGroupService=O;this.menuService=j;this.keybindingService=z;this.isAuxiliary=i!=="main",this.editorService=P.createScoped(i,this._store),this.editorGroupsContainer=i==="main"?O.mainPart:i,this.windowTitle=this._register(g.createInstance(ht,e,i)),this.hoverDelegate=this._register(Ce()),this.registerListeners(ve(e))}minimumWidth=0;maximumWidth=Number.POSITIVE_INFINITY;get minimumHeight(){const t=d&&$();let e=this.isCommandCenterVisible||t?ke:30;return t&&(e=Math.max(e,me(u(this.element))?.height??0)),e/(this.preventZoom?B(u(this.element)):1)}get maximumHeight(){return this.minimumHeight}_onMenubarVisibilityChange=this._register(new oe);onMenubarVisibilityChange=this._onMenubarVisibilityChange.event;_onWillDispose=this._register(new oe);onWillDispose=this._onWillDispose.event;rootContainer;windowControlsContainer;dragRegion;title;leftContent;centerContent;rightContent;customMenubar;appIcon;appIconBadge;menubar;lastLayoutDimensions;actionToolBar;actionToolBarDisposable=this._register(new m);editorActionsChangeDisposable=this._register(new m);actionToolBarElement;layoutToolbarMenu;editorToolbarMenuDisposables=this._register(new m);layoutToolbarMenuDisposables=this._register(new m);activityToolbarDisposables=this._register(new m);hoverDelegate;titleDisposables=this._register(new m);titleBarStyle=Ue(this.configurationService);isInactive=!1;isAuxiliary;windowTitle;editorService;editorGroupsContainer;registerListeners(t){this._register(this.hostService.onDidChangeFocus(e=>e?this.onFocus():this.onBlur())),this._register(this.hostService.onDidChangeActiveWindow(e=>e===t?this.onFocus():this.onBlur())),this._register(this.configurationService.onDidChangeConfiguration(e=>this.onConfigurationChanged(e))),this._register(this.editorGroupService.onDidChangeEditorPartOptions(e=>this.onEditorPartConfigurationChange(e)))}onBlur(){this.isInactive=!0,this.updateStyles()}onFocus(){this.isInactive=!1,this.updateStyles()}onEditorPartConfigurationChange({oldPartOptions:t,newPartOptions:e}){(t.editorActionsLocation!==e.editorActionsLocation||t.showTabs!==e.showTabs)&&_(this.configurationService,this.titleBarStyle)&&this.actionToolBar&&(this.createActionToolBar(),this.createActionToolBarMenus({editorActions:!0}),this._onDidChange.fire(void 0))}onConfigurationChanged(t){if(!this.isAuxiliary&&!x(this.configurationService,this.titleBarStyle)&&(!l||d)&&t.affectsConfiguration("window.menuBarVisibility")&&(this.currentMenubarVisibility==="compact"?this.uninstallMenubar():this.installMenubar()),_(this.configurationService,this.titleBarStyle)&&this.actionToolBar){const e=t.affectsConfiguration(v.LAYOUT_ACTIONS),i=t.affectsConfiguration(v.ACTIVITY_BAR_LOCATION);(e||i)&&(this.createActionToolBarMenus({layoutActions:e,activityActions:i}),this._onDidChange.fire(void 0))}t.affectsConfiguration(v.COMMAND_CENTER)&&(this.createTitle(),this._onDidChange.fire(void 0))}installMenubar(){this.menubar||(this.customMenubar=this._register(this.instantiationService.createInstance(lt)),this.menubar=c(this.leftContent,a("div.menubar")),this.menubar.setAttribute("role","menubar"),this._register(this.customMenubar.onVisibilityChange(t=>this.onMenubarVisibilityChanged(t))),this.customMenubar.create(this.menubar))}uninstallMenubar(){this.customMenubar?.dispose(),this.customMenubar=void 0,this.menubar?.remove(),this.menubar=void 0,this.onMenubarVisibilityChanged(!1)}onMenubarVisibilityChanged(t){(d||we||Be)&&(this.lastLayoutDimensions&&this.layout(this.lastLayoutDimensions.width,this.lastLayoutDimensions.height),this._onMenubarVisibilityChange.fire(t))}updateProperties(t){this.windowTitle.updateProperties(t)}registerVariables(t){this.windowTitle.registerVariables(t)}createContentArea(t){if(this.element=t,this.rootContainer=c(t,a(".titlebar-container")),this.leftContent=c(this.rootContainer,a(".titlebar-left")),this.centerContent=c(this.rootContainer,a(".titlebar-center")),this.rightContent=c(this.rootContainer,a(".titlebar-right")),!l&&!d&&!x(this.configurationService,this.titleBarStyle)&&(this.appIcon=ee(this.leftContent,a("a.window-appicon")),!this.isAuxiliary&&d)){const e=this.environmentService.options?.homeIndicator;if(e){const i=Ke().getIcon(e.icon)?{id:e.icon}:Ee.code;this.appIcon.setAttribute("href",e.href),this.appIcon.classList.add(...De.asClassNameArray(i)),this.appIconBadge=document.createElement("div"),this.appIconBadge.classList.add("home-bar-icon-badge"),this.appIcon.appendChild(this.appIconBadge)}}if(this.dragRegion=ee(this.rootContainer,a("div.titlebar-drag-region")),!this.isAuxiliary&&!x(this.configurationService,this.titleBarStyle)&&(!l||d)&&this.currentMenubarVisibility!=="compact"&&this.installMenubar(),this.title=c(this.centerContent,a("div.window-title")),this.createTitle(),_(this.configurationService,this.titleBarStyle)&&(this.actionToolBarElement=c(this.rightContent,a("div.action-toolbar-container")),this.createActionToolBar(),this.createActionToolBarMenus()),!x(this.configurationService,this.titleBarStyle)){let e=l?"left":"right";l&&R&&new Intl.Locale(Le)?.textInfo?.direction==="rtl"&&(e="right"),l&&R&&e==="left"||(this.windowControlsContainer=c(e==="left"?this.leftContent:this.rightContent,a("div.window-controls-container")),d&&c(e==="left"?this.rightContent:this.leftContent,a("div.window-controls-container")),$()&&this.windowControlsContainer.classList.add("wco-enabled"))}return this._register(Q(this.rootContainer,X.CONTEXT_MENU,e=>{J.stop(e);let i;l&&ge(e.target)&&be(e.target,this.title)?i=C.TitleBarTitleContext:i=C.TitleBarContext,this.onContextMenu(e,i)})),l&&this._register(Q(this.title,X.MOUSE_DOWN,e=>{e.metaKey&&(J.stop(e,!0),this.onContextMenu(e,C.TitleBarTitleContext))},!0)),this.updateStyles(),this.element}createTitle(){if(this.titleDisposables.clear(),this.isCommandCenterVisible){const t=this.instantiationService.createInstance(at,this.windowTitle,this.hoverDelegate);fe(this.title,t.element),this.titleDisposables.add(t)}else this.title.innerText=this.windowTitle.value,this.titleDisposables.add(this.windowTitle.onDidChange(()=>{this.title.innerText=this.windowTitle.value}))}actionViewItemProvider(t,e){if(!this.isAuxiliary){if(t.id===se)return this.instantiationService.createInstance(nt,{position:()=>ie.BELOW},e);if(t.id===ne)return this.instantiationService.createInstance(rt,{position:()=>ie.BELOW},e)}const i=this.editorGroupsContainer.activeGroup?.activeEditorPane;if(i&&i instanceof tt){const n=i.getActionViewItem(t,e);if(n)return n}return Oe(this.instantiationService,t,{...e,menuAsChild:!1})}getKeybinding(t){const e=this.editorGroupsContainer.activeGroup?.activeEditorPane?.scopedContextKeyService??this.contextKeyService;return this.keybindingService.lookupKeybinding(t.id,e)}createActionToolBar(){this.actionToolBarDisposable.clear(),this.actionToolBar=this.actionToolBarDisposable.add(this.instantiationService.createInstance(Re,this.actionToolBarElement,{contextMenu:C.TitleBarContext,orientation:ye.HORIZONTAL,ariaLabel:_e("ariaLabelTitleActions","Title actions"),getKeyBinding:t=>this.getKeybinding(t),overflowBehavior:{maxItems:9,exempted:[ne,se,...et]},anchorAlignmentProvider:()=>Te.RIGHT,telemetrySource:"titlePart",highlightToggledItems:this.editorActionsEnabled,actionViewItemProvider:(t,e)=>this.actionViewItemProvider(t,e),hoverDelegate:this.hoverDelegate})),this.editorActionsEnabled&&this.actionToolBarDisposable.add(this.editorGroupsContainer.onDidChangeActiveGroup(()=>this.createActionToolBarMenus({editorActions:!0})))}createActionToolBarMenus(t=!0){t===!0&&(t={editorActions:!0,layoutActions:!0,activityActions:!0});const e=()=>{const i={primary:[],secondary:[]};if(this.editorActionsEnabled){this.editorActionsChangeDisposable.clear();const n=this.editorGroupsContainer.activeGroup;if(n){const r=n.createEditorActions(this.editorActionsChangeDisposable);i.primary.push(...r.actions.primary),i.secondary.push(...r.actions.secondary),this.editorActionsChangeDisposable.add(r.onDidChange(()=>e()))}}this.layoutToolbarMenu&&Pe(this.layoutToolbarMenu,{},i,()=>!this.editorActionsEnabled),this.activityActionsEnabled&&(st(this.storageService)&&i.primary.push(ct),i.primary.push(dt)),this.actionToolBar.setActions(te(i.primary),te(i.secondary))};if(t.editorActions)if(this.editorToolbarMenuDisposables.clear(),this.editorActionsEnabled&&this.editorService.activeEditor!==void 0){const i={groupId:this.editorGroupsContainer.activeGroup.id};this.actionToolBar.actionRunner=new it(i),this.actionToolBar.context=i,this.editorToolbarMenuDisposables.add(this.actionToolBar.actionRunner)}else this.actionToolBar.actionRunner=new Se,this.actionToolBar.context=void 0,this.editorToolbarMenuDisposables.add(this.actionToolBar.actionRunner);t.layoutActions&&(this.layoutToolbarMenuDisposables.clear(),this.layoutControlEnabled?(this.layoutToolbarMenu=this.menuService.createMenu(C.LayoutControlMenu,this.contextKeyService),this.layoutToolbarMenuDisposables.add(this.layoutToolbarMenu),this.layoutToolbarMenuDisposables.add(this.layoutToolbarMenu.onDidChange(()=>e()))):this.layoutToolbarMenu=void 0),t.activityActions&&(this.activityToolbarDisposables.clear(),this.activityActionsEnabled&&this.activityToolbarDisposables.add(this.storageService.onDidChangeValue(Ge.PROFILE,ot.ACCOUNTS_VISIBILITY_PREFERENCE_KEY,this._store)(()=>e()))),e()}updateStyles(){if(super.updateStyles(),this.element){this.isInactive?this.element.classList.add("inactive"):this.element.classList.remove("inactive");const t=this.getColor(this.isInactive?ze:Ye,(n,r)=>n.isOpaque()?n:n.makeOpaque(qe(r)))||"";this.element.style.backgroundColor=t,this.appIconBadge&&(this.appIconBadge.style.backgroundColor=t),t&&Me.fromHex(t).isLighter()?this.element.classList.add("light"):this.element.classList.remove("light");const e=this.getColor(this.isInactive?$e:Ze);this.element.style.color=e||"";const i=this.getColor(je);this.element.style.borderBottom=i?`1px solid ${i}`:""}}onContextMenu(t,e){const i=new Ie(u(this.element),t);this.contextMenuService.showContextMenu({getAnchor:()=>i,menuId:e,contextKeyService:this.contextKeyService,domForShadowRoot:l&&R?i.target:void 0})}get currentMenubarVisibility(){return this.isAuxiliary?"hidden":Fe(this.configurationService)}get layoutControlEnabled(){return!this.isAuxiliary&&this.configurationService.getValue(v.LAYOUT_ACTIONS)!==!1}get isCommandCenterVisible(){return this.configurationService.getValue(v.COMMAND_CENTER)!==!1}get editorActionsEnabled(){return this.editorGroupService.partOptions.editorActionsLocation===le.TITLEBAR||this.editorGroupService.partOptions.editorActionsLocation===le.DEFAULT&&this.editorGroupService.partOptions.showTabs===Je.NONE}get activityActionsEnabled(){const t=this.configurationService.getValue(v.ACTIVITY_BAR_LOCATION);return!this.isAuxiliary&&(t===ae.TOP||t===ae.BOTTOM)}get hasZoomableElements(){const t=!(this.currentMenubarVisibility==="hidden"||this.currentMenubarVisibility==="compact"||!d&&l),e=this.isCommandCenterVisible,i=this.layoutControlEnabled||this.editorActionsEnabled||this.activityActionsEnabled;return t||e||i}get preventZoom(){return B(u(this.element))<1||!this.hasZoomableElements}layout(t,e){this.updateLayout(new q(t,e)),super.layoutContents(t,e)}updateLayout(t){if(this.lastLayoutDimensions=t,_(this.configurationService,this.titleBarStyle)){const e=B(u(this.element));if(this.element.style.setProperty("--zoom-factor",e.toString()),this.rootContainer.classList.toggle("counter-zoom",this.preventZoom),this.customMenubar){const i=new q(0,t.height);this.customMenubar.layout(i)}}}focus(){this.customMenubar?this.customMenubar.toggleFocus():this.element.querySelector('[tabindex]:not([tabindex="-1"])').focus()}toJSON(){return{type:ce.TITLEBAR_PART}}dispose(){this._onWillDispose.fire(),super.dispose()}};b=T([o(3,G),o(4,H),o(5,U),o(6,w),o(7,D),o(8,L),o(9,Z),o(10,W),o(11,Y),o(12,k),o(13,F),o(14,N),o(15,K)],b);let A=class extends b{constructor(s,t,e,i,n,r,S,g,f,I,y,E,M){super(ce.TITLEBAR_PART,Ae,"main",s,t,e,i,n,r,S,g,f,I,y,E,M)}};A=T([o(0,G),o(1,H),o(2,U),o(3,w),o(4,D),o(5,L),o(6,Z),o(7,W),o(8,Y),o(9,k),o(10,F),o(11,N),o(12,K)],A);let p=class extends b{constructor(t,e,i,n,r,S,g,f,I,y,E,M,O,P,j,z){const de=p.COUNTER++;super(`workbench.parts.auxiliaryTitle.${de}`,u(t),e,n,r,S,g,f,I,y,E,M,O,P,j,z);this.container=t;this.mainTitlebar=i}static COUNTER=1;get height(){return this.minimumHeight}get preventZoom(){return B(u(this.element))<1||!this.mainTitlebar.hasZoomableElements}};p=T([o(3,G),o(4,H),o(5,U),o(6,w),o(7,D),o(8,L),o(9,Z),o(10,W),o(11,Y),o(12,k),o(13,F),o(14,N),o(15,K)],p);export{p as AuxiliaryBrowserTitlebarPart,V as BrowserTitleService,b as BrowserTitlebarPart,A as MainBrowserTitlebarPart};
