var H=Object.defineProperty;var J=Object.getOwnPropertyDescriptor;var A=(d,r,e,a)=>{for(var o=a>1?void 0:a?J(r,e):r,t=d.length-1,s;t>=0;t--)(s=d[t])&&(o=(a?s(r,e,o):s(o))||o);return a&&o&&H(r,e,o),o},c=(d,r)=>(e,a)=>r(e,a,d);import{BroadcastDataChannel as q}from"../../base/browser/broadcast.js";import{DataTransfers as E}from"../../base/browser/dnd.js";import{DragAndDropObserver as W,EventType as U,addDisposableListener as F,onDidRegisterWindow as z}from"../../base/browser/dom.js";import{mainWindow as K}from"../../base/browser/window.js";import{coalesce as S}from"../../base/common/arrays.js";import{UriList as T}from"../../base/common/dataTransfer.js";import{Emitter as k,Event as X}from"../../base/common/event.js";import{Disposable as V,DisposableStore as M,markAsSingleton as Q}from"../../base/common/lifecycle.js";import{stringify as Y}from"../../base/common/marshalling.js";import{Mimes as b}from"../../base/common/mime.js";import{FileAccess as Z,Schemas as O}from"../../base/common/network.js";import{isWindows as $}from"../../base/common/platform.js";import{basename as N,isEqual as ee}from"../../base/common/resources.js";import{URI as x}from"../../base/common/uri.js";import{CodeDataTransfers as re,Extensions as te,LocalSelectionTransfer as ae,createDraggedEditorInputFromRawResourcesData as oe,extractEditorsAndFilesDropData as ie}from"../../platform/dnd/browser/dnd.js";import{IFileService as G}from"../../platform/files/common/files.js";import{IInstantiationService as _}from"../../platform/instantiation/common/instantiation.js";import{ILabelService as ne}from"../../platform/label/common/label.js";import{extractSelection as se}from"../../platform/opener/common/opener.js";import{Registry as de}from"../../platform/registry/common/platform.js";import{IWorkspaceContextService as ge,hasWorkspaceFileExtension as pe,isTemporaryWorkspace as De}from"../../platform/workspace/common/workspace.js";import{IWorkspacesService as ce}from"../../platform/workspaces/common/workspaces.js";import{EditorResourceAccessor as fe,isEditorIdentifier as j,isResourceDiffEditorInput as ve,isResourceMergeEditorInput as ue,isResourceSideBySideEditorInput as le}from"../common/editor.js";import{IEditorService as P}from"../services/editor/common/editorService.js";import{IHostService as me}from"../services/host/browser/host.js";import{ITextFileService as he}from"../services/textfile/common/textfiles.js";import{IWorkspaceEditingService as Ie}from"../services/workspaces/common/workspaceEditing.js";class Ye{constructor(r){this.identifier=r}}class Ze{constructor(r){this.identifier=r}}async function $e(d){const r=[],e=b.uriList.toLowerCase();if(d.has(e))try{const a=await d.get(e)?.asString(),o=JSON.stringify(T.parse(a??""));r.push(...oe(o))}catch{}return r}let y=class{constructor(r,e,a,o,t,s,D,u){this.options=r;this.fileService=e;this.workspacesService=a;this.editorService=o;this.workspaceEditingService=t;this.hostService=s;this.contextService=D;this.instantiationService=u}async handleDrop(r,e,a,o,t){const s=await this.instantiationService.invokeFunction(g=>ie(g,r));if(!s.length)return;if(await this.hostService.focus(e),this.options.allowWorkspaceOpen){const g=S(s.filter(f=>f.allowWorkspaceOpen&&f.resource?.scheme===O.file).map(f=>f.resource));if(g.length>0&&await this.handleWorkspaceDrop(g))return}const D=S(s.filter(g=>g.isExternal&&g.resource?.scheme===O.file).map(g=>g.resource));D.length&&this.workspacesService.addRecentlyOpened(D.map(g=>({fileUri:g})));const u=a?.();await this.editorService.openEditors(s.map(g=>({...g,resource:g.resource,options:{...g.options,...t,pinned:!0}})),u,{validateTrust:!0}),o?.(u)}async handleWorkspaceDrop(r){const e=[],a=[];return await Promise.all(r.map(async o=>{if(pe(o)){e.push({workspaceUri:o});return}try{const t=await this.fileService.stat(o);t.isDirectory&&(e.push({folderUri:t.resource}),a.push({uri:t.resource}))}catch{}})),e.length===0?!1:(e.length>a.length||a.length===1?await this.hostService.openWindow(e):De(this.contextService.getWorkspace())?await this.workspaceEditingService.addFolders(a):await this.workspaceEditingService.createAndEnterWorkspace(a),!0)}};y=A([c(1,G),c(2,ce),c(3,P),c(4,Ie),c(5,me),c(6,ge),c(7,_)],y);function Ee(d,r,e,a){if(r.length===0||!e.dataTransfer)return;const o=d.get(he),t=d.get(P),s=d.get(G),D=d.get(ne),u=S(r.map(i=>x.isUri(i)?{resource:i}:j(i)?x.isUri(i.editor.resource)?{resource:i.editor.resource}:void 0:i)),g=u.filter(({resource:i})=>s.hasProvider(i));if(!a?.disableStandardTransfer){const i=$?`\r
`:`
`;e.dataTransfer.setData(E.TEXT,g.map(({resource:p})=>D.getUriLabel(p,{noPrefix:!0})).join(i));const n=g.find(({isDirectory:p})=>!p);if(n){const p=Z.uriToFileUri(n.resource);p.scheme===O.file&&e.dataTransfer.setData(E.DOWNLOAD_URL,[b.binary,N(n.resource),p.toString()].join(":"))}}const f=g.filter(({isDirectory:i})=>!i);f.length&&e.dataTransfer.setData(E.RESOURCES,JSON.stringify(f.map(({resource:i})=>i.toString())));const B=de.as(te.DragAndDropContribution).getAll();for(const i of B)i.setData(u,e);const I=[];for(const i of r){let n;if(j(i)){const p=i.editor.toUntyped({preserveViewState:i.groupId});p&&(n={...p,resource:fe.getCanonicalUri(p)})}else if(x.isUri(i)){const{selection:p,uri:v}=se(i);n={resource:v,options:p?{selection:p}:void 0}}else i.isDirectory||(n={resource:i.resource});if(n){{const p=n.resource;if(p){const v=o.files.get(p);v&&(typeof n.languageId!="string"&&(n.languageId=v.getLanguageId()),typeof n.encoding!="string"&&(n.encoding=v.getEncoding()),typeof n.contents!="string"&&v.isDirty()&&!v.textEditorModel.isTooLargeForHeapOperation()&&(n.contents=v.textEditorModel.getValue())),n.options?.viewState||(n.options={...n.options,viewState:(()=>{for(const C of t.visibleEditorPanes)if(ee(C.input.resource,p)){const L=C.getViewState();if(L)return L}})()})}}I.push(n)}}if(I.length){e.dataTransfer.setData(re.EDITORS,Y(I));const i=[];for(const n of I)n.resource?i.push(n.resource):ve(n)?n.modified.resource&&i.push(n.modified.resource):le(n)?n.primary.resource&&i.push(n.primary.resource):ue(n)&&i.push(n.result.resource);a?.disableStandardTransfer||e.dataTransfer.setData(b.uriList,T.create(i.slice(0,1))),e.dataTransfer.setData(E.INTERNAL_URI_LIST,T.create(i))}}class Se{constructor(r,e){this.type=r;this.id=e}update(r){}getData(){return{type:this.type,id:this.id}}}class m{constructor(r){this.compositeId=r}get id(){return this.compositeId}}class h{constructor(r){this.viewId=r}get id(){return this.viewId}}class l extends V{static instance;static get INSTANCE(){return l.instance||(l.instance=new l,Q(l.instance)),l.instance}transferData=ae.getInstance();onDragStart=this._register(new k);onDragEnd=this._register(new k);constructor(){super(),this._register(this.onDragEnd.event(r=>{const e=r.dragAndDropData.getData().id,a=r.dragAndDropData.getData().type;this.readDragData(a)?.getData().id===e&&this.transferData.clearData(a==="view"?h.prototype:m.prototype)}))}readDragData(r){if(this.transferData.hasData(r==="view"?h.prototype:m.prototype)){const e=this.transferData.getData(r==="view"?h.prototype:m.prototype);if(e&&e[0])return new Se(r,e[0].id)}}writeDragData(r,e){this.transferData.setData([e==="view"?new h(r):new m(r)],e==="view"?h.prototype:m.prototype)}registerTarget(r,e){const a=new M;return a.add(new W(r,{onDragEnter:o=>{if(o.preventDefault(),e.onDragEnter){const t=this.readDragData("composite")||this.readDragData("view");t&&e.onDragEnter({eventData:o,dragAndDropData:t})}},onDragLeave:o=>{const t=this.readDragData("composite")||this.readDragData("view");e.onDragLeave&&t&&e.onDragLeave({eventData:o,dragAndDropData:t})},onDrop:o=>{if(e.onDrop){const t=this.readDragData("composite")||this.readDragData("view");if(!t)return;e.onDrop({eventData:o,dragAndDropData:t}),this.onDragEnd.fire({eventData:o,dragAndDropData:t})}},onDragOver:o=>{if(o.preventDefault(),e.onDragOver){const t=this.readDragData("composite")||this.readDragData("view");if(!t)return;e.onDragOver({eventData:o,dragAndDropData:t})}}})),e.onDragStart&&this.onDragStart.event(o=>{e.onDragStart(o)},this,a),e.onDragEnd&&this.onDragEnd.event(o=>{e.onDragEnd(o)},this,a),this._register(a)}registerDraggable(r,e,a){r.draggable=!0;const o=new M;return o.add(new W(r,{onDragStart:t=>{const{id:s,type:D}=e();this.writeDragData(s,D),t.dataTransfer?.setDragImage(r,0,0),this.onDragStart.fire({eventData:t,dragAndDropData:this.readDragData(D)})},onDragEnd:t=>{const{type:s}=e(),D=this.readDragData(s);D&&this.onDragEnd.fire({eventData:t,dragAndDropData:D})},onDragEnter:t=>{if(a.onDragEnter){const s=this.readDragData("composite")||this.readDragData("view");if(!s)return;s&&a.onDragEnter({eventData:t,dragAndDropData:s})}},onDragLeave:t=>{const s=this.readDragData("composite")||this.readDragData("view");s&&a.onDragLeave?.({eventData:t,dragAndDropData:s})},onDrop:t=>{if(a.onDrop){const s=this.readDragData("composite")||this.readDragData("view");if(!s)return;a.onDrop({eventData:t,dragAndDropData:s}),this.onDragEnd.fire({eventData:t,dragAndDropData:s})}},onDragOver:t=>{if(a.onDragOver){const s=this.readDragData("composite")||this.readDragData("view");if(!s)return;a.onDragOver({eventData:t,dragAndDropData:s})}}})),a.onDragStart&&this.onDragStart.event(t=>{a.onDragStart(t)},this,o),a.onDragEnd&&this.onDragEnd.event(t=>{a.onDragEnd(t)},this,o),this._register(o)}}function er(d,r,e){d&&(d.dropEffect=e?r:"none")}let w=class{constructor(r,e){this.toResource=r;this.instantiationService=e}getDragURI(r){const e=this.toResource(r);return e?e.toString():null}getDragLabel(r){const e=S(r.map(this.toResource));return e.length===1?N(e[0]):e.length>1?String(e.length):void 0}onDragStart(r,e){const a=[];for(const o of r.elements){const t=this.toResource(o);t&&a.push(t)}a.length&&this.instantiationService.invokeFunction(o=>Ee(o,a,e))}onDragOver(r,e,a,o,t){return!1}drop(r,e,a,o,t){}dispose(){}};w=A([c(1,_)],w);class R extends V{static CHANNEL_NAME="monaco-workbench-global-dragged-over";broadcaster=this._register(new q(R.CHANNEL_NAME));constructor(){super(),this.registerListeners()}registerListeners(){this._register(X.runAndSubscribe(z,({window:r,disposables:e})=>{e.add(F(r,U.DRAG_OVER,()=>this.markDraggedOver(!1),!0)),e.add(F(r,U.DRAG_LEAVE,()=>this.clearDraggedOver(!1),!0))},{window:K,disposables:this._store})),this._register(this.broadcaster.onDidReceiveData(r=>{r===!0?this.markDraggedOver(!0):this.clearDraggedOver(!0)}))}draggedOver=!1;get isDraggedOver(){return this.draggedOver}markDraggedOver(r){this.draggedOver!==!0&&(this.draggedOver=!0,r||this.broadcaster.postData(!0))}clearDraggedOver(r){this.draggedOver!==!1&&(this.draggedOver=!1,r||this.broadcaster.postData(!1))}}const ye=new R;function rr(){return ye.isDraggedOver}export{Se as CompositeDragAndDropData,l as CompositeDragAndDropObserver,m as DraggedCompositeIdentifier,Ze as DraggedEditorGroupIdentifier,Ye as DraggedEditorIdentifier,h as DraggedViewIdentifier,w as ResourceListDnDHandler,y as ResourcesDropHandler,$e as extractTreeDropData,Ee as fillEditorsDragData,rr as isWindowDraggedOver,er as toggleDropEffect};
