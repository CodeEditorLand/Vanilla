var V=Object.defineProperty;var j=Object.getOwnPropertyDescriptor;var g=(d,m,e,t)=>{for(var o=t>1?void 0:t?j(m,e):m,i=d.length-1,r;i>=0;i--)(r=d[i])&&(o=(t?r(m,e,o):r(o))||o);return t&&o&&V(m,e,o),o},a=(d,m)=>(e,t)=>m(e,t,d);import{isSafari as Y,setFullscreen as z}from"../../base/browser/browser.js";import{addDisposableListener as f,EventHelper as k,EventType as p,getActiveWindow as G,getWindow as K,getWindowById as X,getWindows as L,getWindowsCount as x,windowOpenNoOpener as P,windowOpenPopup as A,windowOpenWithSuccess as Z}from"../../base/browser/dom.js";import{DomEmitter as C}from"../../base/browser/event.js";import{requestHidDevice as $,requestSerialPort as J,requestUsbDevice as ee}from"../../base/browser/deviceAccess.js";import{timeout as te}from"../../base/common/async.js";import{Event as y}from"../../base/common/event.js";import{Disposable as oe,dispose as M,toDisposable as ie}from"../../base/common/lifecycle.js";import{matchesScheme as E,Schemas as I}from"../../base/common/network.js";import{isIOS as U,isMacintosh as F}from"../../base/common/platform.js";import D from"../../base/common/severity.js";import{URI as W}from"../../base/common/uri.js";import{localize as n}from"../../nls.js";import{CommandsRegistry as T}from"../../platform/commands/common/commands.js";import{IDialogService as H}from"../../platform/dialogs/common/dialogs.js";import{IInstantiationService as re}from"../../platform/instantiation/common/instantiation.js";import{ILabelService as ne}from"../../platform/label/common/label.js";import{IOpenerService as se}from"../../platform/opener/common/opener.js";import{IProductService as ae}from"../../platform/product/common/productService.js";import{IBrowserWorkbenchEnvironmentService as ce}from"../services/environment/browser/environmentService.js";import{IWorkbenchLayoutService as le}from"../services/layout/browser/layoutService.js";import{ILifecycleService as ue,ShutdownReason as _}from"../services/lifecycle/common/lifecycle.js";import{IHostService as N}from"../services/host/browser/host.js";import{registerWindowDriver as me}from"../services/driver/browser/driver.js";import{isAuxiliaryWindow as pe,mainWindow as u}from"../../base/browser/window.js";import{createSingleCallFunction as de}from"../../base/common/functional.js";import{IConfigurationService as ve}from"../../platform/configuration/common/configuration.js";import{IWorkbenchEnvironmentService as Se}from"../services/environment/common/environmentService.js";let c=class extends oe{constructor(e,t={getWindowsCount:x,getWindows:L},o,i){super();this.hostService=o;this.environmentService=i;this.enableWindowFocusOnElementFocus(e),this.enableMultiWindowAwareTimeout(e,t),this.registerFullScreenListeners(e.vscodeWindowId)}static TIMEOUT_HANDLES=Number.MIN_SAFE_INTEGER;static TIMEOUT_DISPOSABLES=new Map;enableWindowFocusOnElementFocus(e){const t=e.HTMLElement.prototype.focus,o=this;e.HTMLElement.prototype.focus=function(i){o.onElementFocus(K(this)),t.apply(this,[i])}}onElementFocus(e){const t=G();t!==e&&t.document.hasFocus()&&(e.focus(),!this.environmentService.extensionTestsLocationURI&&!e.document.hasFocus()&&this.hostService.focus(e))}enableMultiWindowAwareTimeout(e,t={getWindowsCount:x,getWindows:L}){const o=e.setTimeout;Object.defineProperty(e,"vscodeOriginalSetTimeout",{get:()=>o});const i=e.clearTimeout;Object.defineProperty(e,"vscodeOriginalClearTimeout",{get:()=>i}),e.setTimeout=function(r,s=0,...l){if(t.getWindowsCount()===1||typeof r=="string"||s===0)return o.apply(this,[r,s,...l]);const v=new Set,S=c.TIMEOUT_HANDLES++;c.TIMEOUT_DISPOSABLES.set(S,v);const q=de(r,()=>{M(v),c.TIMEOUT_DISPOSABLES.delete(S)});for(const{window:h,disposables:B}of t.getWindows()){if(pe(h)&&h.document.visibilityState==="hidden")continue;let O=!1;const R=h.vscodeOriginalSetTimeout.apply(this,[(...Q)=>{O||q(...Q)},s,...l]),b=ie(()=>{O=!0,h.vscodeOriginalClearTimeout(R),v.delete(b)});B.add(b),v.add(b)}return S},e.clearTimeout=function(r){const s=typeof r=="number"?c.TIMEOUT_DISPOSABLES.get(r):void 0;s?(M(s),c.TIMEOUT_DISPOSABLES.delete(r)):i.apply(this,[r])}}registerFullScreenListeners(e){this._register(this.hostService.onDidChangeFullScreen(({windowId:t,fullscreen:o})=>{if(t===e){const i=X(e);i&&z(o,i.window)}}))}static async confirmOnShutdown(e,t){const o=e.get(H),i=e.get(ve),r=t===_.QUIT?F?n("quitMessageMac","Are you sure you want to quit?"):n("quitMessage","Are you sure you want to exit?"):n("closeWindowMessage","Are you sure you want to close the window?"),s=t===_.QUIT?F?n({key:"quitButtonLabel",comment:["&& denotes a mnemonic"]},"&&Quit"):n({key:"exitButtonLabel",comment:["&& denotes a mnemonic"]},"&&Exit"):n({key:"closeWindowButtonLabel",comment:["&& denotes a mnemonic"]},"&&Close Window"),l=await o.confirm({message:r,primaryButton:s,checkbox:{label:n("doNotAskAgain","Do not ask me again")}});return l.confirmed&&l.checkboxChecked&&await i.updateValue("window.confirmBeforeClose","never"),l.confirmed}};c=g([a(2,N),a(3,Se)],c);let w=class extends c{constructor(e,t,o,i,r,s,l,v,S){super(u,void 0,S,s);this.openerService=e;this.lifecycleService=t;this.dialogService=o;this.labelService=i;this.productService=r;this.browserEnvironmentService=s;this.layoutService=l;this.instantiationService=v;this.registerListeners(),this.create()}registerListeners(){this._register(this.lifecycleService.onWillShutdown(()=>this.onWillShutdown()));const e=U&&u.visualViewport?u.visualViewport:u;this._register(f(e,p.RESIZE,()=>{this.layoutService.layout(),U&&u.scrollTo(0,0)})),this._register(f(this.layoutService.mainContainer,p.WHEEL,t=>t.preventDefault(),{passive:!1})),this._register(f(this.layoutService.mainContainer,p.CONTEXT_MENU,t=>k.stop(t,!0))),this._register(f(this.layoutService.mainContainer,p.DROP,t=>k.stop(t,!0)))}onWillShutdown(){y.toPromise(y.any(y.once(new C(u.document.body,p.KEY_DOWN,!0).event),y.once(new C(u.document.body,p.MOUSE_DOWN,!0).event))).then(async()=>{await te(3e3),await this.dialogService.prompt({type:D.Error,message:n("shutdownError","An unexpected error occurred that requires a reload of this page."),detail:n("shutdownErrorDetail","The workbench was unexpectedly disposed while running."),buttons:[{label:n({key:"reload",comment:["&& denotes a mnemonic"]},"&&Reload"),run:()=>u.location.reload()}]})})}create(){this.setupOpenHandlers(),this.registerLabelFormatters(),this.registerCommands(),this.setupDriver()}setupDriver(){this.environmentService.enableSmokeTestDriver&&me(this.instantiationService)}setupOpenHandlers(){this.openerService.setDefaultExternalOpener({openExternal:async e=>{let t=!1;if(this.browserEnvironmentService.options?.openerAllowedExternalUrlPrefixes){for(const o of this.browserEnvironmentService.options.openerAllowedExternalUrlPrefixes)if(e.startsWith(o)){t=!0;break}}if(E(e,I.http)||E(e,I.https))Y?Z(e,!t)||await this.dialogService.prompt({type:D.Warning,message:n("unableToOpenExternal","The browser interrupted the opening of a new tab or window. Press 'Open' to open it anyway."),detail:e,buttons:[{label:n({key:"open",comment:["&& denotes a mnemonic"]},"&&Open"),run:()=>t?A(e):P(e)},{label:n({key:"learnMore",comment:["&& denotes a mnemonic"]},"&&Learn More"),run:()=>this.openerService.open(W.parse("https://aka.ms/allow-vscode-popup"))}],cancelButton:!0}):t?A(e):P(e);else{const o=()=>{this.lifecycleService.withExpectedShutdown({disableShutdownHandling:!0},()=>u.location.href=e)};o();const i=async()=>{const{downloadUrl:r}=this.productService;let s;const l=[{label:n({key:"openExternalDialogButtonRetry.v2",comment:["&& denotes a mnemonic"]},"&&Try Again"),run:()=>o()}];r!==void 0?(s=n("openExternalDialogDetail.v2",`We launched {0} on your computer.

If {1} did not launch, try again or install it below.`,this.productService.nameLong,this.productService.nameLong),l.push({label:n({key:"openExternalDialogButtonInstall.v3",comment:["&& denotes a mnemonic"]},"&&Install"),run:async()=>{await this.openerService.open(W.parse(r)),i()}})):s=n("openExternalDialogDetailNoInstall",`We launched {0} on your computer.

If {1} did not launch, try again below.`,this.productService.nameLong,this.productService.nameLong),await this.hostService.withExpectedShutdown(()=>this.dialogService.prompt({type:D.Info,message:n("openExternalDialogTitle","All done. You can close this tab now."),detail:s,buttons:l,cancelButton:!0}))};E(e,this.productService.urlProtocol)&&await i()}return!0}})}registerLabelFormatters(){this._register(this.labelService.registerFormatter({scheme:I.vscodeUserData,priority:!0,formatting:{label:"(Settings) ${path}",separator:"/"}}))}registerCommands(){T.registerCommand("workbench.experimental.requestUsbDevice",async(e,t)=>ee(t)),T.registerCommand("workbench.experimental.requestSerialPort",async(e,t)=>J(t)),T.registerCommand("workbench.experimental.requestHidDevice",async(e,t)=>$(t))}};w=g([a(0,se),a(1,ue),a(2,H),a(3,ne),a(4,ae),a(5,ce),a(6,le),a(7,re),a(8,N)],w);export{c as BaseWindow,w as BrowserWindow};
