import{isFullscreen as $,isWCOEnabled as pe,onDidChangeFullscreen as fe}from"../../base/browser/browser.js";import{EventType as ve,addDisposableListener as J,computeScreenAwareSize as q,getActiveDocument as Te,getActiveElement as Ee,getActiveWindow as U,getClientArea as Z,getWindow as B,getWindowId as Y,getWindows as Pe,isActiveDocument as Re,isAncestorUsingFlowTo as we,position as ye,size as Ve}from"../../base/browser/dom.js";import{Direction as P,Orientation as De,SerializableGrid as _e,Sizing as C}from"../../base/browser/ui/grid/grid.js";import{mainWindow as g}from"../../base/browser/window.js";import{coalesce as K}from"../../base/common/arrays.js";import{DeferredPromise as Q,Promises as ee}from"../../base/common/async.js";import{Emitter as w}from"../../base/common/event.js";import{Disposable as ie,DisposableMap as be,DisposableStore as te,toDisposable as ae}from"../../base/common/lifecycle.js";import{mark as R}from"../../base/common/performance.js";import{isIOS as re,isLinux as Be,isMacintosh as Ce,isWeb as L,isWindows as se}from"../../base/common/platform.js";import{assertIsDefined as H}from"../../base/common/types.js";import{URI as Le}from"../../base/common/uri.js";import{isCodeEditor as Ne}from"../../editor/browser/editorBrowser.js";import{IConfigurationService as Me}from"../../platform/configuration/common/configuration.js";import{IFileService as Oe}from"../../platform/files/common/files.js";import{ILogService as ze}from"../../platform/log/common/log.js";import{INotificationService as He,NotificationsFilter as N}from"../../platform/notification/common/notification.js";import{IStorageService as We,StorageScope as I,StorageTarget as p}from"../../platform/storage/common/storage.js";import{ITelemetryService as xe}from"../../platform/telemetry/common/telemetry.js";import{IThemeService as Ge}from"../../platform/theme/common/themeService.js";import{CustomTitleBarVisibility as ne,TitleBarSetting as W,getMenuBarVisibility as oe,hasCustomTitlebar as ke,hasNativeTitlebar as X,useWindowControlsOverlay as Fe}from"../../platform/window/common/window.js";import{IWorkspaceContextService as Ue,WorkbenchState as le,isTemporaryWorkspace as Ze}from"../../platform/workspace/common/workspace.js";import{EditorInputCapabilities as Ye,isResourceEditorInput as x,pathsToEditors as j}from"../common/editor.js";import{DiffEditorInput as Ke}from"../common/editor/diffEditorInput.js";import{WINDOW_ACTIVE_BORDER as Xe,WINDOW_INACTIVE_BORDER as je}from"../common/theme.js";import{IViewDescriptorService as $e,ViewContainerLocation as c}from"../common/views.js";import{IAuxiliaryWindowService as Je}from"../services/auxiliaryWindow/browser/auxiliaryWindowService.js";import{IBannerService as qe}from"../services/banner/browser/bannerService.js";import{GroupsOrder as Qe,IEditorGroupsService as ei}from"../services/editor/common/editorGroupsService.js";import{IEditorService as ii}from"../services/editor/common/editorService.js";import{IBrowserWorkbenchEnvironmentService as ti}from"../services/environment/browser/environmentService.js";import{IExtensionService as ai}from"../services/extensions/common/extensions.js";import{IHostService as ri}from"../services/host/browser/host.js";import{ActivityBarPosition as M,EditorActionsLocation as si,LayoutSettings as y,PanelOpensMaximizedOptions as de,Parts as r,Position as A,ZenModeSettings as T,isHorizontal as f,panelOpensMaximizedFromString as ni,positionFromString as G,positionToString as O,shouldShowCustomTitleBar as V}from"../services/layout/browser/layoutService.js";import{ILifecycleService as oi,StartupKind as he}from"../services/lifecycle/common/lifecycle.js";import{IPaneCompositePartService as li}from"../services/panecomposite/browser/panecomposite.js";import{IStatusbarService as di}from"../services/statusbar/browser/statusbar.js";import{ITitleService as hi}from"../services/title/browser/titleService.js";import{IWorkingCopyBackupService as ui}from"../services/workingCopy/common/workingCopyBackup.js";import{Part as ci}from"./part.js";import{AuxiliaryBarPart as Si}from"./parts/auxiliarybar/auxiliaryBarPart.js";import{PanelPart as Ii}from"./parts/panel/panelPart.js";import{SidebarPart as ue}from"./parts/sidebar/sidebarPart.js";var gi=(d=>(d.SIDEBAR_HIDDEN="nosidebar",d.MAIN_EDITOR_AREA_HIDDEN="nomaineditorarea",d.PANEL_HIDDEN="nopanel",d.AUXILIARYBAR_HIDDEN="noauxiliarybar",d.STATUSBAR_HIDDEN="nostatusbar",d.FULLSCREEN="fullscreen",d.MAXIMIZED="maximized",d.WINDOW_BORDER="border",d))(gi||{});const Ai=[y.ACTIVITY_BAR_LOCATION,y.COMMAND_CENTER,y.EDITOR_ACTIONS_LOCATION,y.LAYOUT_ACTIONS,"window.menuBarVisibility",W.TITLE_BAR_STYLE,W.CUSTOM_TITLE_BAR_VISIBILITY];class lt extends ie{constructor(e){super();this.parent=e}_onDidChangeZenMode=this._register(new w);onDidChangeZenMode=this._onDidChangeZenMode.event;_onDidChangeMainEditorCenteredLayout=this._register(new w);onDidChangeMainEditorCenteredLayout=this._onDidChangeMainEditorCenteredLayout.event;_onDidChangePanelAlignment=this._register(new w);onDidChangePanelAlignment=this._onDidChangePanelAlignment.event;_onDidChangeWindowMaximized=this._register(new w);onDidChangeWindowMaximized=this._onDidChangeWindowMaximized.event;_onDidChangePanelPosition=this._register(new w);onDidChangePanelPosition=this._onDidChangePanelPosition.event;_onDidChangePartVisibility=this._register(new w);onDidChangePartVisibility=this._onDidChangePartVisibility.event;_onDidChangeNotificationsVisibility=this._register(new w);onDidChangeNotificationsVisibility=this._onDidChangeNotificationsVisibility.event;_onDidLayoutMainContainer=this._register(new w);onDidLayoutMainContainer=this._onDidLayoutMainContainer.event;_onDidLayoutActiveContainer=this._register(new w);onDidLayoutActiveContainer=this._onDidLayoutActiveContainer.event;_onDidLayoutContainer=this._register(new w);onDidLayoutContainer=this._onDidLayoutContainer.event;_onDidAddContainer=this._register(new w);onDidAddContainer=this._onDidAddContainer.event;_onDidChangeActiveContainer=this._register(new w);onDidChangeActiveContainer=this._onDidChangeActiveContainer.event;mainContainer=document.createElement("div");get activeContainer(){return this.getContainerFromDocument(Te())}get containers(){const e=[];for(const{window:i}of Pe())e.push(this.getContainerFromDocument(i.document));return e}getContainerFromDocument(e){return e===this.mainContainer.ownerDocument?this.mainContainer:e.body.getElementsByClassName("monaco-workbench")[0]}containerStylesLoaded=new Map;whenContainerStylesLoaded(e){return this.containerStylesLoaded.get(e.vscodeWindowId)}_mainContainerDimension;get mainContainerDimension(){return this._mainContainerDimension}get activeContainerDimension(){return this.getContainerDimension(this.activeContainer)}getContainerDimension(e){return e===this.mainContainer?this.mainContainerDimension:Z(e)}get mainContainerOffset(){return this.computeContainerOffset(g)}get activeContainerOffset(){return this.computeContainerOffset(B(this.activeContainer))}computeContainerOffset(e){let i=0,t=0;this.isVisible(r.BANNER_PART)&&(i=this.getPart(r.BANNER_PART).maximumHeight,t=i);const n=this.isVisible(r.TITLEBAR_PART,e);return n&&(i+=this.getPart(r.TITLEBAR_PART).maximumHeight,t=i),n&&this.configurationService.getValue(y.COMMAND_CENTER)!==!1&&(t=6),{top:i,quickPickTop:t}}parts=new Map;initialized=!1;workbenchGrid;titleBarPartView;bannerPartView;activityBarPartView;sideBarPartView;panelPartView;auxiliaryBarPartView;editorPartView;statusBarPartView;environmentService;extensionService;configurationService;storageService;hostService;editorService;mainPartEditorService;editorGroupService;paneCompositeService;titleService;viewDescriptorService;contextService;workingCopyBackupService;notificationService;themeService;statusBarService;logService;telemetryService;auxiliaryWindowService;state;stateModel;disposed=!1;initLayout(e){this.environmentService=e.get(ti),this.configurationService=e.get(Me),this.hostService=e.get(ri),this.contextService=e.get(Ue),this.storageService=e.get(We),this.workingCopyBackupService=e.get(ui),this.themeService=e.get(Ge),this.extensionService=e.get(ai),this.logService=e.get(ze),this.telemetryService=e.get(xe),this.auxiliaryWindowService=e.get(Je),this.editorService=e.get(ii),this.mainPartEditorService=this.editorService.createScoped("main",this._store),this.editorGroupService=e.get(ei),this.paneCompositeService=e.get(li),this.viewDescriptorService=e.get($e),this.titleService=e.get(hi),this.notificationService=e.get(He),this.statusBarService=e.get(di),e.get(qe),this.registerLayoutListeners(),this.initLayoutState(e.get(oi),e.get(Oe))}registerLayoutListeners(){const e=()=>{this.isVisible(r.EDITOR_PART,g)||this.toggleMaximizedPanel()};this.editorGroupService.whenRestored.then(()=>{this._register(this.mainPartEditorService.onDidVisibleEditorsChange(e)),this._register(this.editorGroupService.mainPart.onDidActivateGroup(e)),this._register(this.mainPartEditorService.onDidActiveEditorChange(()=>this.centerMainEditorLayout(this.stateModel.getRuntimeValue(a.MAIN_EDITOR_CENTERED))))}),this._register(this.configurationService.onDidChangeConfiguration(t=>{if([...Ai,"workbench.sideBar.location","workbench.statusBar.visible"].some(n=>t.affectsConfiguration(n))){const n=t.affectsConfiguration(y.EDITOR_ACTIONS_LOCATION)&&this.configurationService.getValue(y.EDITOR_ACTIONS_LOCATION)===si.TITLEBAR;let o=!1;if(t.affectsConfiguration(y.ACTIVITY_BAR_LOCATION)){const s=this.configurationService.getValue(y.ACTIVITY_BAR_LOCATION);o=s===M.TOP||s===M.BOTTOM}(o||n)&&this.configurationService.getValue(W.CUSTOM_TITLE_BAR_VISIBILITY)===ne.NEVER&&this.configurationService.updateValue(W.CUSTOM_TITLE_BAR_VISIBILITY,ne.AUTO),this.doUpdateLayoutConfiguration()}})),this._register(fe(t=>this.onFullscreenChanged(t))),this._register(this.editorGroupService.mainPart.onDidAddGroup(()=>this.centerMainEditorLayout(this.stateModel.getRuntimeValue(a.MAIN_EDITOR_CENTERED)))),this._register(this.editorGroupService.mainPart.onDidRemoveGroup(()=>this.centerMainEditorLayout(this.stateModel.getRuntimeValue(a.MAIN_EDITOR_CENTERED)))),this._register(this.editorGroupService.mainPart.onDidChangeGroupMaximized(()=>this.centerMainEditorLayout(this.stateModel.getRuntimeValue(a.MAIN_EDITOR_CENTERED)))),this._register(J(this.mainContainer,ve.SCROLL,()=>this.mainContainer.scrollTop=0)),(se||Be||L)&&!X(this.configurationService)&&this._register(this.titleService.onMenubarVisibilityChange(t=>this.onMenubarToggled(t))),this._register(this.themeService.onDidColorThemeChange(()=>this.updateWindowsBorder())),this._register(this.hostService.onDidChangeFocus(t=>this.onWindowFocusChanged(t))),this._register(this.hostService.onDidChangeActiveWindow(()=>this.onActiveWindowChanged())),L&&typeof navigator.windowControlsOverlay=="object"&&this._register(J(navigator.windowControlsOverlay,"geometrychange",()=>this.onDidChangeWCO())),this._register(this.auxiliaryWindowService.onDidOpenAuxiliaryWindow(({window:t,disposables:n})=>{const o=t.window.vscodeWindowId;this.containerStylesLoaded.set(o,t.whenStylesHaveLoaded),t.whenStylesHaveLoaded.then(()=>this.containerStylesLoaded.delete(o)),n.add(ae(()=>this.containerStylesLoaded.delete(o)));const s=n.add(new te);this._onDidAddContainer.fire({container:t.container,disposables:s}),n.add(t.onDidLayout(d=>this.handleContainerDidLayout(t.container,d)))}))}onMenubarToggled(e){if(e!==this.state.runtime.menuBar.toggled){this.state.runtime.menuBar.toggled=e;const i=oe(this.configurationService);L&&i==="toggle"?this.workbenchGrid.setViewVisible(this.titleBarPartView,V(this.configurationService,g,this.state.runtime.menuBar.toggled,this.isZenModeActive())):this.state.runtime.mainWindowFullscreen&&(i==="toggle"||i==="classic")&&this.workbenchGrid.setViewVisible(this.titleBarPartView,V(this.configurationService,g,this.state.runtime.menuBar.toggled,this.isZenModeActive())),this.handleContainerDidLayout(this.mainContainer,this._mainContainerDimension)}}handleContainerDidLayout(e,i){e===this.mainContainer&&this._onDidLayoutMainContainer.fire(i),Re(e)&&this._onDidLayoutActiveContainer.fire(i),this._onDidLayoutContainer.fire({container:e,dimension:i})}onFullscreenChanged(e){e===g.vscodeWindowId&&(this.state.runtime.mainWindowFullscreen=$(g),this.state.runtime.mainWindowFullscreen?this.mainContainer.classList.add("fullscreen"):(this.mainContainer.classList.remove("fullscreen"),this.stateModel.getRuntimeValue(a.ZEN_MODE_EXIT_INFO).transitionedToFullScreen&&this.isZenModeActive()&&this.toggleZenMode()),this.workbenchGrid.edgeSnapping=this.state.runtime.mainWindowFullscreen,ke(this.configurationService)&&(this.workbenchGrid.setViewVisible(this.titleBarPartView,V(this.configurationService,g,this.state.runtime.menuBar.toggled,this.isZenModeActive())),this.updateWindowsBorder(!0)))}onActiveWindowChanged(){const e=this.getActiveContainerId();this.state.runtime.activeContainerId!==e&&(this.state.runtime.activeContainerId=e,this.updateWindowsBorder(),this._onDidChangeActiveContainer.fire())}onWindowFocusChanged(e){this.state.runtime.hasFocus!==e&&(this.state.runtime.hasFocus=e,this.updateWindowsBorder())}getActiveContainerId(){const e=this.activeContainer;return B(e).vscodeWindowId}doUpdateLayoutConfiguration(e){this.updateCustomTitleBarVisibility(),this.updateMenubarVisibility(!!e),this.editorGroupService.whenRestored.then(()=>{this.centerMainEditorLayout(this.stateModel.getRuntimeValue(a.MAIN_EDITOR_CENTERED),e)})}setSideBarPosition(e){const i=this.getPart(r.ACTIVITYBAR_PART),t=this.getPart(r.SIDEBAR_PART),n=this.getPart(r.AUXILIARYBAR_PART),o=e===A.LEFT?"left":"right",s=e===A.RIGHT?"left":"right",d=this.getPanelAlignment(),h=this.getPanelPosition();this.stateModel.setRuntimeValue(a.SIDEBAR_POSITON,e);const l=H(i.getContainer()),u=H(t.getContainer()),S=H(n.getContainer());l.classList.remove(s),u.classList.remove(s),l.classList.add(o),u.classList.add(o),S.classList.remove(o),S.classList.add(s),i.updateStyles(),t.updateStyles(),n.updateStyles(),this.adjustPartPositions(e,d,h)}updateWindowsBorder(e=!1){if(L||se||Fe(this.configurationService)||X(this.configurationService))return;const i=this.themeService.getColorTheme(),t=i.getColor(Xe),n=i.getColor(je),o=this.hasMainWindowBorder();for(const s of this.containers){const d=s===this.mainContainer,h=this.activeContainer===s,l=Y(B(s));let u=!1;if(!this.state.runtime.mainWindowFullscreen&&!this.state.runtime.maximized.has(l)&&(t||n)){u=!0;const S=h&&this.state.runtime.hasFocus?t:n??t;s.style.setProperty("--window-border-color",S?.toString()??"transparent")}d&&(this.state.runtime.mainWindowBorder=u),s.classList.toggle("border",u)}!e&&o!==this.hasMainWindowBorder()&&this.layout()}initLayoutState(e,i){this.stateModel=new z(this.storageService,this.configurationService,this.contextService,this.parent),this.stateModel.load(),this.stateModel.getRuntimeValue(a.PANEL_HIDDEN)&&this.stateModel.getRuntimeValue(a.EDITOR_HIDDEN)&&this.stateModel.setRuntimeValue(a.EDITOR_HIDDEN,!1),this._register(this.stateModel.onDidChangeState(l=>{l.key===a.ACTIVITYBAR_HIDDEN&&this.setActivityBarHidden(l.value),l.key===a.STATUSBAR_HIDDEN&&this.setStatusBarHidden(l.value),l.key===a.SIDEBAR_POSITON&&this.setSideBarPosition(l.value),l.key===a.PANEL_POSITION&&this.setPanelPosition(l.value),l.key===a.PANEL_ALIGNMENT&&this.setPanelAlignment(l.value),this.doUpdateLayoutConfiguration()}));const t=this.getInitialEditorsState();t&&this.logService.trace("Initial editor state",t);const n={layout:{editors:t?.layout},editor:{restoreEditors:this.shouldRestoreEditors(this.contextService,t),editorsToOpen:this.resolveEditorsToOpen(i,t)},views:{defaults:this.getDefaultLayoutViews(this.environmentService,this.storageService),containerToRestore:{}}},o={activeContainerId:this.getActiveContainerId(),mainWindowFullscreen:$(g),hasFocus:this.hostService.hasFocus,maximized:new Set,mainWindowBorder:!1,menuBar:{toggled:!1},zenMode:{transitionDisposables:new be}};this.state={initialization:n,runtime:o};const s=e.startupKind===he.NewWindow,d=this.configurationService.getValue(y.ACTIVITY_BAR_LOCATION)!==M.DEFAULT;if(this.isVisible(r.SIDEBAR_PART)){let l;!this.environmentService.isBuilt||e.startupKind===he.ReloadedWindow||this.environmentService.isExtensionDevelopment&&!this.environmentService.extensionTestsLocationURI?l=this.storageService.get(ue.activeViewletSettingsKey,I.WORKSPACE,this.viewDescriptorService.getDefaultViewContainer(c.Sidebar)?.id):l=this.viewDescriptorService.getDefaultViewContainer(c.Sidebar)?.id,l?this.state.initialization.views.containerToRestore.sideBar=l:this.stateModel.setRuntimeValue(a.SIDEBAR_HIDDEN,!0)}else if(s&&d){const l=this.storageService.get(ue.activeViewletSettingsKey,I.WORKSPACE,this.viewDescriptorService.getDefaultViewContainer(c.Sidebar)?.id);l&&(this.state.initialization.views.containerToRestore.sideBar=l,this.stateModel.setRuntimeValue(a.SIDEBAR_HIDDEN,!1))}if(this.isVisible(r.PANEL_PART)){const l=this.storageService.get(Ii.activePanelSettingsKey,I.WORKSPACE,this.viewDescriptorService.getDefaultViewContainer(c.Panel)?.id);l?this.state.initialization.views.containerToRestore.panel=l:this.stateModel.setRuntimeValue(a.PANEL_HIDDEN,!0)}const h=this.isVisible(r.AUXILIARYBAR_PART);if(h||s&&d){const l=this.storageService.get(Si.activePanelSettingsKey,I.WORKSPACE,this.viewDescriptorService.getDefaultViewContainer(c.AuxiliaryBar)?.id);l&&(this.state.initialization.views.containerToRestore.auxiliaryBar=l),h!==!!l&&this.stateModel.setRuntimeValue(a.AUXILIARYBAR_HIDDEN,!h)}this.updateWindowsBorder(!0)}getDefaultLayoutViews(e,i){const t=e.options?.defaultLayout;if(!t||!t.force&&!i.isNew(I.WORKSPACE))return;const{views:n}=t;if(n?.length)return n.map(o=>o.id)}shouldRestoreEditors(e,i){return Ze(e.getWorkspace())?!1:!!(this.configurationService.getValue("window.restoreWindows")==="preserve")||i===void 0}willRestoreEditors(){return this.state.initialization.editor.restoreEditors}async resolveEditorsToOpen(e,i){if(i){const t=K(await j(i.filesToMerge,e,this.logService));if(t.length===4&&x(t[0])&&x(t[1])&&x(t[2])&&x(t[3]))return[{editor:{input1:{resource:t[0].resource},input2:{resource:t[1].resource},base:{resource:t[2].resource},result:{resource:t[3].resource},options:{pinned:!0}}}];const n=K(await j(i.filesToDiff,e,this.logService));if(n.length===2)return[{editor:{original:{resource:n[0].resource},modified:{resource:n[1].resource},options:{pinned:!0}}}];const o=[],s=await j(i.filesToOpenOrCreate,e,this.logService);for(let d=0;d<s.length;d++){const h=s[d];h&&o.push({editor:h,viewColumn:i.filesToOpenOrCreate?.[d].viewColumn})}return o}else if(this.contextService.getWorkbenchState()===le.EMPTY&&this.configurationService.getValue("workbench.startupEditor")==="newUntitledFile")return this.editorGroupService.hasRestorableState?[]:await this.workingCopyBackupService.hasBackups()?[]:[{editor:{resource:void 0}}];return[]}_openedDefaultEditors=!1;get openedDefaultEditors(){return this._openedDefaultEditors}getInitialEditorsState(){const e=this.environmentService.options?.defaultLayout;if((e?.editors?.length||e?.layout?.editors)&&(e.force||this.storageService.isNew(I.WORKSPACE)))return this._openedDefaultEditors=!0,{layout:e.layout?.editors,filesToOpenOrCreate:e?.editors?.map(o=>({viewColumn:o.viewColumn,fileUri:Le.revive(o.uri),openOnlyIfExists:o.openOnlyIfExists,options:o.options}))};const{filesToOpenOrCreate:i,filesToDiff:t,filesToMerge:n}=this.environmentService;if(i||t||n)return{filesToOpenOrCreate:i,filesToDiff:t,filesToMerge:n}}whenReadyPromise=new Q;whenReady=this.whenReadyPromise.p;whenRestoredPromise=new Q;whenRestored=this.whenRestoredPromise.p;restored=!1;isRestored(){return this.restored}restoreParts(){const e=[],i=[];e.push((async()=>{R("code/willRestoreEditors"),await this.editorGroupService.whenReady,R("code/restoreEditors/editorGroupsReady"),this.state.initialization.layout?.editors&&this.editorGroupService.mainPart.applyLayout(this.state.initialization.layout.editors);const s=await this.state.initialization.editor.editorsToOpen;R("code/restoreEditors/editorsToOpenResolved");let d;if(s.length){const h=this.editorGroupService.mainPart.getGroups(Qe.GRID_APPEARANCE),l=new Map;for(const u of s){const S=h[(u.viewColumn??1)-1];let m=l.get(S.id);m||(m=new Set,l.set(S.id,m)),m.add(u.editor)}d=Promise.all(Array.from(l).map(async([u,S])=>{try{await this.editorService.openEditors(Array.from(S),u,{validateTrust:!0})}catch(m){this.logService.error(m)}}))}i.push(Promise.all([d?.finally(()=>R("code/restoreEditors/editorsOpened")),this.editorGroupService.whenRestored.finally(()=>R("code/restoreEditors/editorGroupsRestored"))]).finally(()=>{R("code/didRestoreEditors")}))})());const t=(async()=>{if(this.state.initialization.views.defaults?.length){R("code/willOpenDefaultViews");const s=[],d=u=>{const S=this.viewDescriptorService.getViewLocationById(u.id);if(S!==null){const m=this.viewDescriptorService.getViewContainerByViewId(u.id);if(m){u.order>=(s?.[S]?.order??0)&&(s[S]={id:m.id,order:u.order});const E=this.viewDescriptorService.getViewContainerModel(m);return E.setCollapsed(u.id,!1),E.setVisible(u.id,!0),!0}}return!1},h=[...this.state.initialization.views.defaults].reverse().map((u,S)=>({id:u,order:S}));let l=h.length;for(;l;)l--,d(h[l])&&h.splice(l,1);if(h.length){await this.extensionService.whenInstalledExtensionsRegistered();let u=h.length;for(;u;)u--,d(h[u])&&h.splice(u,1)}s[c.Sidebar]&&(this.state.initialization.views.containerToRestore.sideBar=s[c.Sidebar].id),s[c.Panel]&&(this.state.initialization.views.containerToRestore.panel=s[c.Panel].id),s[c.AuxiliaryBar]&&(this.state.initialization.views.containerToRestore.auxiliaryBar=s[c.AuxiliaryBar].id),R("code/didOpenDefaultViews")}})();e.push(t),e.push((async()=>{if(await t,!this.state.initialization.views.containerToRestore.sideBar)return;R("code/willRestoreViewlet"),await this.paneCompositeService.openPaneComposite(this.state.initialization.views.containerToRestore.sideBar,c.Sidebar)||await this.paneCompositeService.openPaneComposite(this.viewDescriptorService.getDefaultViewContainer(c.Sidebar)?.id,c.Sidebar),R("code/didRestoreViewlet")})()),e.push((async()=>{if(await t,!this.state.initialization.views.containerToRestore.panel)return;R("code/willRestorePanel"),await this.paneCompositeService.openPaneComposite(this.state.initialization.views.containerToRestore.panel,c.Panel)||await this.paneCompositeService.openPaneComposite(this.viewDescriptorService.getDefaultViewContainer(c.Panel)?.id,c.Panel),R("code/didRestorePanel")})()),e.push((async()=>{if(await t,!this.state.initialization.views.containerToRestore.auxiliaryBar)return;R("code/willRestoreAuxiliaryBar"),await this.paneCompositeService.openPaneComposite(this.state.initialization.views.containerToRestore.auxiliaryBar,c.AuxiliaryBar)||await this.paneCompositeService.openPaneComposite(this.viewDescriptorService.getDefaultViewContainer(c.AuxiliaryBar)?.id,c.AuxiliaryBar),R("code/didRestoreAuxiliaryBar")})());const n=this.isZenModeActive(),o=ce(this.configurationService).restore;n&&(this.setZenModeActive(!o),this.toggleZenMode(!1,!0)),this.stateModel.getRuntimeValue(a.MAIN_EDITOR_CENTERED)&&this.centerMainEditorLayout(!0,!0),ee.settled(e).finally(()=>{this.whenReadyPromise.complete(),ee.settled(i).finally(()=>{this.restored=!0,this.whenRestoredPromise.complete()})})}registerPart(e){const i=e.getId();return this.parts.set(i,e),ae(()=>this.parts.delete(i))}getPart(e){const i=this.parts.get(e);if(!i)throw new Error(`Unknown part ${e}`);return i}registerNotifications(e){this._register(e.onDidChangeNotificationsVisibility(i=>this._onDidChangeNotificationsVisibility.fire(i)))}hasFocus(e){const i=this.getContainer(U(),e);if(!i)return!1;const t=Ee();return t?we(t,i):!1}focusPart(e,i=g){const t=this.getContainer(i,e)??this.mainContainer;switch(e){case r.EDITOR_PART:this.editorGroupService.getPart(t).activeGroup.focus();break;case r.PANEL_PART:{this.paneCompositeService.getActivePaneComposite(c.Panel)?.focus();break}case r.SIDEBAR_PART:{this.paneCompositeService.getActivePaneComposite(c.Sidebar)?.focus();break}case r.AUXILIARYBAR_PART:{this.paneCompositeService.getActivePaneComposite(c.AuxiliaryBar)?.focus();break}case r.ACTIVITYBAR_PART:this.getPart(r.SIDEBAR_PART).focusActivityBar();break;case r.STATUSBAR_PART:this.statusBarService.getPart(t).focus();break;default:t?.focus()}}getContainer(e,i){if(typeof i>"u")return this.getContainerFromDocument(e.document);if(e===g)return this.getPart(i).getContainer();let t;if(i===r.EDITOR_PART?t=this.editorGroupService.getPart(this.getContainerFromDocument(e.document)):i===r.STATUSBAR_PART?t=this.statusBarService.getPart(this.getContainerFromDocument(e.document)):i===r.TITLEBAR_PART&&(t=this.titleService.getPart(this.getContainerFromDocument(e.document))),t instanceof ci)return t.getContainer()}isVisible(e,i=g){if(i!==g&&e===r.EDITOR_PART)return!0;if(this.initialized)switch(e){case r.TITLEBAR_PART:return this.workbenchGrid.isViewVisible(this.titleBarPartView);case r.SIDEBAR_PART:return!this.stateModel.getRuntimeValue(a.SIDEBAR_HIDDEN);case r.PANEL_PART:return!this.stateModel.getRuntimeValue(a.PANEL_HIDDEN);case r.AUXILIARYBAR_PART:return!this.stateModel.getRuntimeValue(a.AUXILIARYBAR_HIDDEN);case r.STATUSBAR_PART:return!this.stateModel.getRuntimeValue(a.STATUSBAR_HIDDEN);case r.ACTIVITYBAR_PART:return!this.stateModel.getRuntimeValue(a.ACTIVITYBAR_HIDDEN);case r.EDITOR_PART:return!this.stateModel.getRuntimeValue(a.EDITOR_HIDDEN);case r.BANNER_PART:return this.workbenchGrid.isViewVisible(this.bannerPartView);default:return!1}switch(e){case r.TITLEBAR_PART:return V(this.configurationService,g,this.state.runtime.menuBar.toggled,this.isZenModeActive());case r.SIDEBAR_PART:return!this.stateModel.getRuntimeValue(a.SIDEBAR_HIDDEN);case r.PANEL_PART:return!this.stateModel.getRuntimeValue(a.PANEL_HIDDEN);case r.AUXILIARYBAR_PART:return!this.stateModel.getRuntimeValue(a.AUXILIARYBAR_HIDDEN);case r.STATUSBAR_PART:return!this.stateModel.getRuntimeValue(a.STATUSBAR_HIDDEN);case r.ACTIVITYBAR_PART:return!this.stateModel.getRuntimeValue(a.ACTIVITYBAR_HIDDEN);case r.EDITOR_PART:return!this.stateModel.getRuntimeValue(a.EDITOR_HIDDEN);default:return!1}}shouldShowBannerFirst(){return L&&!pe()}focus(){this.focusPart(r.EDITOR_PART,B(this.activeContainer))}focusPanelOrEditor(){const e=this.paneCompositeService.getActivePaneComposite(c.Panel);(this.hasFocus(r.PANEL_PART)||!this.isVisible(r.EDITOR_PART))&&e?e.focus():this.focus()}getMaximumEditorDimensions(e){const i=B(e),t=this.getContainerDimension(e);if(e===this.mainContainer){const n=f(this.getPanelPosition()),o=(this.isVisible(r.ACTIVITYBAR_PART)?this.activityBarPartView.minimumWidth:0)+(this.isVisible(r.SIDEBAR_PART)?this.sideBarPartView.minimumWidth:0)+(this.isVisible(r.PANEL_PART)&&!n?this.panelPartView.minimumWidth:0)+(this.isVisible(r.AUXILIARYBAR_PART)?this.auxiliaryBarPartView.minimumWidth:0),s=(this.isVisible(r.TITLEBAR_PART,i)?this.titleBarPartView.minimumHeight:0)+(this.isVisible(r.STATUSBAR_PART,i)?this.statusBarPartView.minimumHeight:0)+(this.isVisible(r.PANEL_PART)&&n?this.panelPartView.minimumHeight:0),d=t.width-o,h=t.height-s;return{width:d,height:h}}else{const n=(this.isVisible(r.TITLEBAR_PART,i)?this.titleBarPartView.minimumHeight:0)+(this.isVisible(r.STATUSBAR_PART,i)?this.statusBarPartView.minimumHeight:0);return{width:t.width,height:t.height-n}}}isZenModeActive(){return this.stateModel.getRuntimeValue(a.ZEN_MODE_ACTIVE)}setZenModeActive(e){this.stateModel.setRuntimeValue(a.ZEN_MODE_ACTIVE,e)}toggleZenMode(e,i=!1){this.setZenModeActive(!this.isZenModeActive()),this.state.runtime.zenMode.transitionDisposables.clearAndDisposeAll();const t=d=>{for(const h of this.mainPartEditorService.visibleTextEditorControls){if(!d&&Ne(h)&&h.hasModel()){const l=h.getModel();d=this.configurationService.getValue("editor.lineNumbers",{resource:l.uri,overrideIdentifier:l.getLanguageId()})}d||(d=this.configurationService.getValue("editor.lineNumbers")),h.updateOptions({lineNumbers:d})}};let n=!1;const o=ce(this.configurationService),s=this.stateModel.getRuntimeValue(a.ZEN_MODE_EXIT_INFO);this.isZenModeActive()?(n=!this.state.runtime.mainWindowFullscreen&&o.fullScreen&&!re,i||(s.transitionedToFullScreen=n,s.transitionedToCenteredEditorLayout=!this.isMainEditorLayoutCentered()&&o.centerLayout,s.handleNotificationsDoNotDisturbMode=this.notificationService.getFilter()===N.OFF,s.wasVisible.sideBar=this.isVisible(r.SIDEBAR_PART),s.wasVisible.panel=this.isVisible(r.PANEL_PART),s.wasVisible.auxiliaryBar=this.isVisible(r.AUXILIARYBAR_PART),this.stateModel.setRuntimeValue(a.ZEN_MODE_EXIT_INFO,s)),this.setPanelHidden(!0,!0),this.setAuxiliaryBarHidden(!0,!0),this.setSideBarHidden(!0,!0),o.hideActivityBar&&this.setActivityBarHidden(!0,!0),o.hideStatusBar&&this.setStatusBarHidden(!0,!0),o.hideLineNumbers&&(t("off"),this.state.runtime.zenMode.transitionDisposables.set(T.HIDE_LINENUMBERS,this.mainPartEditorService.onDidVisibleEditorsChange(()=>t("off")))),o.showTabs!==this.editorGroupService.partOptions.showTabs&&this.state.runtime.zenMode.transitionDisposables.set(T.SHOW_TABS,this.editorGroupService.mainPart.enforcePartOptions({showTabs:o.showTabs})),o.silentNotifications&&s.handleNotificationsDoNotDisturbMode&&this.notificationService.setFilter(N.ERROR),o.centerLayout&&this.centerMainEditorLayout(!0,!0),this.state.runtime.zenMode.transitionDisposables.set("configurationChange",this.configurationService.onDidChangeConfiguration(d=>{if(d.affectsConfiguration(T.HIDE_ACTIVITYBAR)){const h=this.configurationService.getValue(T.HIDE_ACTIVITYBAR);this.setActivityBarHidden(h,!0)}if(d.affectsConfiguration(T.HIDE_STATUSBAR)){const h=this.configurationService.getValue(T.HIDE_STATUSBAR);this.setStatusBarHidden(h,!0)}if(d.affectsConfiguration(T.CENTER_LAYOUT)){const h=this.configurationService.getValue(T.CENTER_LAYOUT);this.centerMainEditorLayout(h,!0)}if(d.affectsConfiguration(T.SHOW_TABS)){const h=this.configurationService.getValue(T.SHOW_TABS)??"multiple";this.state.runtime.zenMode.transitionDisposables.set(T.SHOW_TABS,this.editorGroupService.mainPart.enforcePartOptions({showTabs:h}))}if(d.affectsConfiguration(T.SILENT_NOTIFICATIONS)){const h=!!this.configurationService.getValue(T.SILENT_NOTIFICATIONS);s.handleNotificationsDoNotDisturbMode&&this.notificationService.setFilter(h?N.ERROR:N.OFF)}if(d.affectsConfiguration(T.HIDE_LINENUMBERS)){const h=this.configurationService.getValue(T.HIDE_LINENUMBERS)?"off":void 0;t(h),this.state.runtime.zenMode.transitionDisposables.set(T.HIDE_LINENUMBERS,this.mainPartEditorService.onDidVisibleEditorsChange(()=>t(h)))}}))):(s.wasVisible.panel&&this.setPanelHidden(!1,!0),s.wasVisible.auxiliaryBar&&this.setAuxiliaryBarHidden(!1,!0),s.wasVisible.sideBar&&this.setSideBarHidden(!1,!0),this.stateModel.getRuntimeValue(a.ACTIVITYBAR_HIDDEN,!0)||this.setActivityBarHidden(!1,!0),this.stateModel.getRuntimeValue(a.STATUSBAR_HIDDEN,!0)||this.setStatusBarHidden(!1,!0),s.transitionedToCenteredEditorLayout&&this.centerMainEditorLayout(!1,!0),s.handleNotificationsDoNotDisturbMode&&this.notificationService.setFilter(N.OFF),t(),this.focus(),n=s.transitionedToFullScreen&&this.state.runtime.mainWindowFullscreen),e||this.layout(),n&&this.hostService.toggleFullScreen(g),this._onDidChangeZenMode.fire(this.isZenModeActive())}setStatusBarHidden(e,i){this.stateModel.setRuntimeValue(a.STATUSBAR_HIDDEN,e),e?this.mainContainer.classList.add("nostatusbar"):this.mainContainer.classList.remove("nostatusbar"),this.workbenchGrid.setViewVisible(this.statusBarPartView,!e)}createWorkbenchLayout(){const e=this.getPart(r.TITLEBAR_PART),i=this.getPart(r.BANNER_PART),t=this.getPart(r.EDITOR_PART),n=this.getPart(r.ACTIVITYBAR_PART),o=this.getPart(r.PANEL_PART),s=this.getPart(r.AUXILIARYBAR_PART),d=this.getPart(r.SIDEBAR_PART),h=this.getPart(r.STATUSBAR_PART);this.titleBarPartView=e,this.bannerPartView=i,this.sideBarPartView=d,this.activityBarPartView=n,this.editorPartView=t,this.panelPartView=o,this.auxiliaryBarPartView=s,this.statusBarPartView=h;const l={[r.ACTIVITYBAR_PART]:this.activityBarPartView,[r.BANNER_PART]:this.bannerPartView,[r.TITLEBAR_PART]:this.titleBarPartView,[r.EDITOR_PART]:this.editorPartView,[r.PANEL_PART]:this.panelPartView,[r.SIDEBAR_PART]:this.sideBarPartView,[r.STATUSBAR_PART]:this.statusBarPartView,[r.AUXILIARYBAR_PART]:this.auxiliaryBarPartView},u=({type:m})=>l[m],S=_e.deserialize(this.createGridDescriptor(),{fromJSON:u},{proportionalLayout:!1});this.mainContainer.prepend(S.element),this.mainContainer.setAttribute("role","application"),this.workbenchGrid=S,this.workbenchGrid.edgeSnapping=this.state.runtime.mainWindowFullscreen;for(const m of[e,t,n,o,d,h,s,i])this._register(m.onDidVisibilityChange(E=>{m===d?this.setSideBarHidden(!E,!0):m===o?this.setPanelHidden(!E,!0):m===s?this.setAuxiliaryBarHidden(!E,!0):m===t&&this.setEditorHidden(!E,!0),this._onDidChangePartVisibility.fire(),this.handleContainerDidLayout(this.mainContainer,this._mainContainerDimension)}));this._register(this.storageService.onWillSaveState(m=>{const E=this.stateModel.getRuntimeValue(a.SIDEBAR_HIDDEN)?this.workbenchGrid.getViewCachedVisibleSize(this.sideBarPartView):this.workbenchGrid.getViewSize(this.sideBarPartView).width;this.stateModel.setInitializationValue(a.SIDEBAR_SIZE,E);const D=this.stateModel.getRuntimeValue(a.PANEL_HIDDEN)?this.workbenchGrid.getViewCachedVisibleSize(this.panelPartView):f(this.stateModel.getRuntimeValue(a.PANEL_POSITION))?this.workbenchGrid.getViewSize(this.panelPartView).height:this.workbenchGrid.getViewSize(this.panelPartView).width;this.stateModel.setInitializationValue(a.PANEL_SIZE,D);const _=this.stateModel.getRuntimeValue(a.AUXILIARYBAR_HIDDEN)?this.workbenchGrid.getViewCachedVisibleSize(this.auxiliaryBarPartView):this.workbenchGrid.getViewSize(this.auxiliaryBarPartView).width;this.stateModel.setInitializationValue(a.AUXILIARYBAR_SIZE,_),this.stateModel.save(!0,!0)}))}layout(){this.disposed||(this._mainContainerDimension=Z(this.state.runtime.mainWindowFullscreen?g.document.body:this.parent),this.logService.trace(`Layout#layout, height: ${this._mainContainerDimension.height}, width: ${this._mainContainerDimension.width}`),ye(this.mainContainer,0,0,0,0,"relative"),Ve(this.mainContainer,this._mainContainerDimension.width,this._mainContainerDimension.height),this.workbenchGrid.layout(this._mainContainerDimension.width,this._mainContainerDimension.height),this.initialized=!0,this.handleContainerDidLayout(this.mainContainer,this._mainContainerDimension))}isMainEditorLayoutCentered(){return this.stateModel.getRuntimeValue(a.MAIN_EDITOR_CENTERED)}centerMainEditorLayout(e,i){this.stateModel.setRuntimeValue(a.MAIN_EDITOR_CENTERED,e);const t=this.mainPartEditorService.activeEditor;let n=!1;t instanceof Ke?n=this.configurationService.getValue("diffEditor.renderSideBySide"):t?.hasCapability(Ye.MultipleEditors)&&(n=!0),this.configurationService.getValue("workbench.editor.centeredLayoutAutoResize")&&(this.editorGroupService.mainPart.groups.length>1&&!this.editorGroupService.mainPart.hasMaximizedGroup()||n)&&(e=!1),this.editorGroupService.mainPart.isLayoutCentered()!==e&&(this.editorGroupService.mainPart.centerLayout(e),i||this.layout()),this._onDidChangeMainEditorCenteredLayout.fire(this.stateModel.getRuntimeValue(a.MAIN_EDITOR_CENTERED))}resizePart(e,i,t){const n=Math.sign(i)*q(U(),Math.abs(i)),o=Math.sign(t)*q(U(),Math.abs(t));let s;switch(e){case r.SIDEBAR_PART:s=this.workbenchGrid.getViewSize(this.sideBarPartView),this.workbenchGrid.resizeView(this.sideBarPartView,{width:s.width+n,height:s.height});break;case r.PANEL_PART:s=this.workbenchGrid.getViewSize(this.panelPartView),this.workbenchGrid.resizeView(this.panelPartView,{width:s.width+(f(this.getPanelPosition())?0:n),height:s.height+(f(this.getPanelPosition())?o:0)});break;case r.AUXILIARYBAR_PART:s=this.workbenchGrid.getViewSize(this.auxiliaryBarPartView),this.workbenchGrid.resizeView(this.auxiliaryBarPartView,{width:s.width+n,height:s.height});break;case r.EDITOR_PART:if(s=this.workbenchGrid.getViewSize(this.editorPartView),this.editorGroupService.mainPart.count===1)this.workbenchGrid.resizeView(this.editorPartView,{width:s.width+n,height:s.height+o});else{const d=this.editorGroupService.mainPart.activeGroup,{width:h,height:l}=this.editorGroupService.mainPart.getSize(d);this.editorGroupService.mainPart.setSize(d,{width:h+n,height:l+o});const{width:u,height:S}=this.editorGroupService.mainPart.getSize(d);(o&&l===S||n&&h===u)&&this.workbenchGrid.resizeView(this.editorPartView,{width:s.width+(n&&h===u?n:0),height:s.height+(o&&l===S?o:0)})}break;default:return}}setActivityBarHidden(e,i){this.stateModel.setRuntimeValue(a.ACTIVITYBAR_HIDDEN,e),this.workbenchGrid.setViewVisible(this.activityBarPartView,!e)}setBannerHidden(e){this.workbenchGrid.setViewVisible(this.bannerPartView,!e)}setEditorHidden(e,i){this.stateModel.setRuntimeValue(a.EDITOR_HIDDEN,e),e?this.mainContainer.classList.add("nomaineditorarea"):this.mainContainer.classList.remove("nomaineditorarea"),this.workbenchGrid.setViewVisible(this.editorPartView,!e),e&&!this.isVisible(r.PANEL_PART)&&this.setPanelHidden(!1,!0)}getLayoutClasses(){return K([this.isVisible(r.SIDEBAR_PART)?void 0:"nosidebar",this.isVisible(r.EDITOR_PART,g)?void 0:"nomaineditorarea",this.isVisible(r.PANEL_PART)?void 0:"nopanel",this.isVisible(r.AUXILIARYBAR_PART)?void 0:"noauxiliarybar",this.isVisible(r.STATUSBAR_PART)?void 0:"nostatusbar",this.state.runtime.mainWindowFullscreen?"fullscreen":void 0])}setSideBarHidden(e,i){if(this.stateModel.setRuntimeValue(a.SIDEBAR_HIDDEN,e),e?this.mainContainer.classList.add("nosidebar"):this.mainContainer.classList.remove("nosidebar"),e&&this.paneCompositeService.getActivePaneComposite(c.Sidebar))this.paneCompositeService.hideActivePaneComposite(c.Sidebar),this.focusPanelOrEditor();else if(!e&&!this.paneCompositeService.getActivePaneComposite(c.Sidebar)){const t=this.paneCompositeService.getLastActivePaneCompositeId(c.Sidebar);t&&(this.paneCompositeService.openPaneComposite(t,c.Sidebar,!0)||this.paneCompositeService.openPaneComposite(this.viewDescriptorService.getDefaultViewContainer(c.Sidebar)?.id,c.Sidebar,!0))}this.workbenchGrid.setViewVisible(this.sideBarPartView,!e)}hasViews(e){const i=this.viewDescriptorService.getViewContainerById(e);if(!i)return!1;const t=this.viewDescriptorService.getViewContainerModel(i);return t?t.activeViewDescriptors.length>=1:!1}adjustPartPositions(e,i,t){const n=!f(t),o=n||!(i==="center"||e===A.LEFT&&i==="right"||e===A.RIGHT&&i==="left"),s=n||!(i==="center"||e===A.RIGHT&&i==="right"||e===A.LEFT&&i==="left"),d=this.isVisible(r.PANEL_PART)?this.workbenchGrid.getViewSize(this.panelPartView).width:C.Invisible(this.workbenchGrid.getViewCachedVisibleSize(this.panelPartView)??this.panelPartView.minimumWidth),h=this.isVisible(r.PANEL_PART)?this.workbenchGrid.getViewSize(this.panelPartView).height:C.Invisible(this.workbenchGrid.getViewCachedVisibleSize(this.panelPartView)??this.panelPartView.minimumHeight),l=this.isVisible(r.SIDEBAR_PART)?this.workbenchGrid.getViewSize(this.sideBarPartView).width:C.Invisible(this.workbenchGrid.getViewCachedVisibleSize(this.sideBarPartView)??this.sideBarPartView.minimumWidth),u=this.isVisible(r.AUXILIARYBAR_PART)?this.workbenchGrid.getViewSize(this.auxiliaryBarPartView).width:C.Invisible(this.workbenchGrid.getViewCachedVisibleSize(this.auxiliaryBarPartView)??this.auxiliaryBarPartView.minimumWidth);e===A.LEFT?(this.workbenchGrid.moveViewTo(this.activityBarPartView,[2,0]),this.workbenchGrid.moveView(this.sideBarPartView,l,o?this.editorPartView:this.activityBarPartView,o?P.Left:P.Right),s?this.workbenchGrid.moveView(this.auxiliaryBarPartView,u,this.editorPartView,P.Right):this.workbenchGrid.moveViewTo(this.auxiliaryBarPartView,[2,-1])):(this.workbenchGrid.moveViewTo(this.activityBarPartView,[2,-1]),this.workbenchGrid.moveView(this.sideBarPartView,l,o?this.editorPartView:this.activityBarPartView,o?P.Right:P.Left),s?this.workbenchGrid.moveView(this.auxiliaryBarPartView,u,this.editorPartView,P.Left):this.workbenchGrid.moveViewTo(this.auxiliaryBarPartView,[2,0])),n&&(this.workbenchGrid.moveView(this.panelPartView,d,this.editorPartView,t===A.LEFT?P.Left:P.Right),this.workbenchGrid.resizeView(this.panelPartView,{height:h,width:d})),this.isVisible(r.SIDEBAR_PART)&&this.workbenchGrid.resizeView(this.sideBarPartView,{height:this.workbenchGrid.getViewSize(this.sideBarPartView).height,width:l}),this.isVisible(r.AUXILIARYBAR_PART)&&this.workbenchGrid.resizeView(this.auxiliaryBarPartView,{height:this.workbenchGrid.getViewSize(this.auxiliaryBarPartView).height,width:u})}setPanelAlignment(e,i){f(this.getPanelPosition())||this.setPanelPosition(A.BOTTOM),e!=="center"&&this.isPanelMaximized()&&this.toggleMaximizedPanel(),this.stateModel.setRuntimeValue(a.PANEL_ALIGNMENT,e),this.adjustPartPositions(this.getSideBarPosition(),e,this.getPanelPosition()),this._onDidChangePanelAlignment.fire(e)}setPanelHidden(e,i){if(!this.workbenchGrid)return;const t=!this.isVisible(r.PANEL_PART);this.stateModel.setRuntimeValue(a.PANEL_HIDDEN,e);const n=this.isPanelMaximized(),o=this.panelOpensMaximized();e?this.mainContainer.classList.add("nopanel"):this.mainContainer.classList.remove("nopanel");let s=!1;if(e&&this.paneCompositeService.getActivePaneComposite(c.Panel))this.paneCompositeService.hideActivePaneComposite(c.Panel),s=!re;else if(!e&&!this.paneCompositeService.getActivePaneComposite(c.Panel)){let d=this.paneCompositeService.getLastActivePaneCompositeId(c.Panel);if((!d||!this.hasViews(d))&&(d=this.viewDescriptorService.getViewContainersByLocation(c.Panel).find(h=>this.hasViews(h.id))?.id),d){const h=!i;this.paneCompositeService.openPaneComposite(d,c.Panel,h)}}e&&n&&this.toggleMaximizedPanel(),t!==e&&(this.workbenchGrid.setViewVisible(this.panelPartView,!e),e?this.stateModel.setRuntimeValue(a.PANEL_WAS_LAST_MAXIMIZED,n):!i&&n!==o&&this.toggleMaximizedPanel(),s&&this.editorGroupService.mainPart.activeGroup.focus())}toggleMaximizedPanel(){const e=this.workbenchGrid.getViewSize(this.panelPartView),i=this.getPanelPosition(),t=this.isPanelMaximized();t?(this.setEditorHidden(!1),this.workbenchGrid.resizeView(this.panelPartView,{width:f(i)?e.width:this.stateModel.getRuntimeValue(a.PANEL_LAST_NON_MAXIMIZED_WIDTH),height:f(i)?this.stateModel.getRuntimeValue(a.PANEL_LAST_NON_MAXIMIZED_HEIGHT):e.height})):(this.isVisible(r.PANEL_PART)&&(f(i)?this.stateModel.setRuntimeValue(a.PANEL_LAST_NON_MAXIMIZED_HEIGHT,e.height):this.stateModel.setRuntimeValue(a.PANEL_LAST_NON_MAXIMIZED_WIDTH,e.width)),this.setEditorHidden(!0)),this.stateModel.setRuntimeValue(a.PANEL_WAS_LAST_MAXIMIZED,!t)}panelOpensMaximized(){if(this.getPanelAlignment()!=="center"&&f(this.getPanelPosition()))return!1;const e=ni(this.configurationService.getValue("workbench.panel.opensMaximized")),i=this.stateModel.getRuntimeValue(a.PANEL_WAS_LAST_MAXIMIZED);return e===de.ALWAYS||e===de.REMEMBER_LAST&&i}setAuxiliaryBarHidden(e,i){if(this.stateModel.setRuntimeValue(a.AUXILIARYBAR_HIDDEN,e),e?this.mainContainer.classList.add("noauxiliarybar"):this.mainContainer.classList.remove("noauxiliarybar"),e&&this.paneCompositeService.getActivePaneComposite(c.AuxiliaryBar))this.paneCompositeService.hideActivePaneComposite(c.AuxiliaryBar),this.focusPanelOrEditor();else if(!e&&!this.paneCompositeService.getActivePaneComposite(c.AuxiliaryBar)){let t=this.paneCompositeService.getLastActivePaneCompositeId(c.AuxiliaryBar);if((!t||!this.hasViews(t))&&(t=this.viewDescriptorService.getViewContainersByLocation(c.AuxiliaryBar).find(n=>this.hasViews(n.id))?.id),t){const n=!i;this.paneCompositeService.openPaneComposite(t,c.AuxiliaryBar,n)}}this.workbenchGrid.setViewVisible(this.auxiliaryBarPartView,!e)}setPartHidden(e,i,t=g){switch(i){case r.ACTIVITYBAR_PART:return this.setActivityBarHidden(e);case r.SIDEBAR_PART:return this.setSideBarHidden(e);case r.EDITOR_PART:return this.setEditorHidden(e);case r.BANNER_PART:return this.setBannerHidden(e);case r.AUXILIARYBAR_PART:return this.setAuxiliaryBarHidden(e);case r.PANEL_PART:return this.setPanelHidden(e)}}hasMainWindowBorder(){return this.state.runtime.mainWindowBorder}getMainWindowBorderRadius(){return this.state.runtime.mainWindowBorder&&Ce?"5px":void 0}isPanelMaximized(){return(this.getPanelAlignment()==="center"||!f(this.getPanelPosition()))&&!this.isVisible(r.EDITOR_PART,g)}getSideBarPosition(){return this.stateModel.getRuntimeValue(a.SIDEBAR_POSITON)}getPanelAlignment(){return this.stateModel.getRuntimeValue(a.PANEL_ALIGNMENT)}updateMenubarVisibility(e){const i=V(this.configurationService,g,this.state.runtime.menuBar.toggled,this.isZenModeActive());!e&&this.workbenchGrid&&i!==this.isVisible(r.TITLEBAR_PART,g)&&this.workbenchGrid.setViewVisible(this.titleBarPartView,i)}updateCustomTitleBarVisibility(){const e=V(this.configurationService,g,this.state.runtime.menuBar.toggled,this.isZenModeActive()),i=this.isVisible(r.TITLEBAR_PART);e!==i&&this.workbenchGrid.setViewVisible(this.titleBarPartView,e)}toggleMenuBar(){let e=oe(this.configurationService);typeof e!="string"&&(e="classic");let i;e==="visible"||e==="classic"?i=X(this.configurationService)?"toggle":"compact":i="classic",this.configurationService.updateValue("window.menuBarVisibility",i)}getPanelPosition(){return this.stateModel.getRuntimeValue(a.PANEL_POSITION)}setPanelPosition(e){this.isVisible(r.PANEL_PART)||this.setPanelHidden(!1);const i=this.getPart(r.PANEL_PART),t=O(this.getPanelPosition()),n=O(e),o=H(i.getContainer());o.classList.remove(t),o.classList.add(n),i.updateStyles();const s=this.workbenchGrid.getViewSize(this.panelPartView),d=this.workbenchGrid.getViewSize(this.sideBarPartView),h=this.workbenchGrid.getViewSize(this.auxiliaryBarPartView);let l=!this.isVisible(r.EDITOR_PART,g);n!==t&&!l&&(f(e)?this.stateModel.setRuntimeValue(a.PANEL_LAST_NON_MAXIMIZED_WIDTH,s.width):f(G(t))&&this.stateModel.setRuntimeValue(a.PANEL_LAST_NON_MAXIMIZED_HEIGHT,s.height)),f(e)&&this.getPanelAlignment()!=="center"&&l&&(this.toggleMaximizedPanel(),l=!1),this.stateModel.setRuntimeValue(a.PANEL_POSITION,e);const u=this.isVisible(r.SIDEBAR_PART),S=this.isVisible(r.AUXILIARYBAR_PART);e===A.BOTTOM?this.workbenchGrid.moveView(this.panelPartView,l?s.height:this.stateModel.getRuntimeValue(a.PANEL_LAST_NON_MAXIMIZED_HEIGHT),this.editorPartView,P.Down):e===A.TOP?this.workbenchGrid.moveView(this.panelPartView,l?s.height:this.stateModel.getRuntimeValue(a.PANEL_LAST_NON_MAXIMIZED_HEIGHT),this.editorPartView,P.Up):e===A.RIGHT?this.workbenchGrid.moveView(this.panelPartView,l?s.width:this.stateModel.getRuntimeValue(a.PANEL_LAST_NON_MAXIMIZED_WIDTH),this.editorPartView,P.Right):this.workbenchGrid.moveView(this.panelPartView,l?s.width:this.stateModel.getRuntimeValue(a.PANEL_LAST_NON_MAXIMIZED_WIDTH),this.editorPartView,P.Left),this.workbenchGrid.resizeView(this.sideBarPartView,d),u||this.setSideBarHidden(!0),this.workbenchGrid.resizeView(this.auxiliaryBarPartView,h),S||this.setAuxiliaryBarHidden(!0),f(e)&&this.adjustPartPositions(this.getSideBarPosition(),this.getPanelAlignment(),e),this._onDidChangePanelPosition.fire(n)}isWindowMaximized(e){return this.state.runtime.maximized.has(Y(e))}updateWindowMaximizedState(e,i){this.mainContainer.classList.toggle("maximized",i);const t=Y(e);i!==this.state.runtime.maximized.has(t)&&(i?this.state.runtime.maximized.add(t):this.state.runtime.maximized.delete(t),this.updateWindowsBorder(),this._onDidChangeWindowMaximized.fire({windowId:t,maximized:i}))}getVisibleNeighborPart(e,i){if(!this.workbenchGrid||!this.isVisible(e,g))return;const t=this.workbenchGrid.getNeighborViews(this.getPart(e),i,!1);if(t)for(const n of t){const o=[r.ACTIVITYBAR_PART,r.EDITOR_PART,r.PANEL_PART,r.AUXILIARYBAR_PART,r.SIDEBAR_PART,r.STATUSBAR_PART,r.TITLEBAR_PART].find(s=>this.getPart(s)===n&&this.isVisible(s,g));if(o!==void 0)return o}}onDidChangeWCO(){const e=this.workbenchGrid.getNeighborViews(this.titleBarPartView,P.Up,!1).length>0,i=this.shouldShowBannerFirst();e!==i&&this.workbenchGrid.moveView(this.bannerPartView,C.Distribute,this.titleBarPartView,i?P.Up:P.Down),this.workbenchGrid.setViewVisible(this.titleBarPartView,V(this.configurationService,g,this.state.runtime.menuBar.toggled,this.isZenModeActive()))}arrangeEditorNodes(e,i,t){if(!e.sideBar&&!e.auxiliaryBar)return e.editor.size=i,e.editor;const n=[e.editor];return e.editor.size=t,e.sideBar&&(this.stateModel.getRuntimeValue(a.SIDEBAR_POSITON)===A.LEFT?n.splice(0,0,e.sideBar):n.push(e.sideBar),e.editor.size-=this.stateModel.getRuntimeValue(a.SIDEBAR_HIDDEN)?0:e.sideBar.size),e.auxiliaryBar&&(this.stateModel.getRuntimeValue(a.SIDEBAR_POSITON)===A.RIGHT?n.splice(0,0,e.auxiliaryBar):n.push(e.auxiliaryBar),e.editor.size-=this.stateModel.getRuntimeValue(a.AUXILIARYBAR_HIDDEN)?0:e.auxiliaryBar.size),{type:"branch",data:n,size:i}}arrangeMiddleSectionNodes(e,i,t){const n=this.stateModel.getRuntimeValue(a.ACTIVITYBAR_HIDDEN)?0:e.activityBar.size,o=this.stateModel.getRuntimeValue(a.SIDEBAR_HIDDEN)?0:e.sideBar.size,s=this.stateModel.getRuntimeValue(a.AUXILIARYBAR_HIDDEN)?0:e.auxiliaryBar.size,d=this.stateModel.getInitializationValue(a.PANEL_SIZE)?0:e.panel.size,h=this.stateModel.getRuntimeValue(a.PANEL_POSITION),l=this.stateModel.getRuntimeValue(a.SIDEBAR_POSITON),u=[];if(f(h)){const S=this.stateModel.getRuntimeValue(a.PANEL_ALIGNMENT),m=!(S==="center"||l===A.LEFT&&S==="right"||l===A.RIGHT&&S==="left"),E=!(S==="center"||l===A.RIGHT&&S==="right"||l===A.LEFT&&S==="left"),D=i-n-(m?0:o)-(E?0:s),_=this.arrangeEditorNodes({editor:e.editor,sideBar:m?e.sideBar:void 0,auxiliaryBar:E?e.auxiliaryBar:void 0},t-d,D);u.push({type:"branch",data:h===A.BOTTOM?[_,e.panel]:[e.panel,_],size:D}),m||(l===A.LEFT?u.splice(0,0,e.sideBar):u.push(e.sideBar)),E||(l===A.RIGHT?u.splice(0,0,e.auxiliaryBar):u.push(e.auxiliaryBar)),l===A.LEFT?u.splice(0,0,e.activityBar):u.push(e.activityBar)}else u.push(e.editor),e.editor.size=i-n-o-d-s,h===A.RIGHT?u.push(e.panel):u.splice(0,0,e.panel),l===A.LEFT?(u.push(e.auxiliaryBar),u.splice(0,0,e.sideBar),u.splice(0,0,e.activityBar)):(u.splice(0,0,e.auxiliaryBar),u.push(e.sideBar),u.push(e.activityBar));return u}createGridDescriptor(){const{width:e,height:i}=this.stateModel.getInitializationValue(a.GRID_SIZE),t=this.stateModel.getInitializationValue(a.SIDEBAR_SIZE),n=this.stateModel.getInitializationValue(a.AUXILIARYBAR_SIZE),o=this.stateModel.getInitializationValue(a.PANEL_SIZE),s=this.titleBarPartView.minimumHeight,d=this.bannerPartView.minimumHeight,h=this.statusBarPartView.minimumHeight,l=this.activityBarPartView.minimumWidth,u=i-s-h,S=[{type:"leaf",data:{type:r.TITLEBAR_PART},size:s,visible:this.isVisible(r.TITLEBAR_PART,g)},{type:"leaf",data:{type:r.BANNER_PART},size:d,visible:!1}],m={type:"leaf",data:{type:r.ACTIVITYBAR_PART},size:l,visible:!this.stateModel.getRuntimeValue(a.ACTIVITYBAR_HIDDEN)},E={type:"leaf",data:{type:r.SIDEBAR_PART},size:t,visible:!this.stateModel.getRuntimeValue(a.SIDEBAR_HIDDEN)},D={type:"leaf",data:{type:r.AUXILIARYBAR_PART},size:n,visible:this.isVisible(r.AUXILIARYBAR_PART)},_={type:"leaf",data:{type:r.EDITOR_PART},size:0,visible:!this.stateModel.getRuntimeValue(a.EDITOR_HIDDEN)},Ie={type:"leaf",data:{type:r.PANEL_PART},size:o,visible:!this.stateModel.getRuntimeValue(a.PANEL_HIDDEN)},ge=this.arrangeMiddleSectionNodes({activityBar:m,auxiliaryBar:D,editor:_,panel:Ie,sideBar:E},e,u),Ae={root:{type:"branch",size:e,data:[...this.shouldShowBannerFirst()?S.reverse():S,{type:"branch",data:ge,size:u},{type:"leaf",data:{type:r.STATUSBAR_PART},size:h,visible:!this.stateModel.getRuntimeValue(a.STATUSBAR_HIDDEN)}]},orientation:De.VERTICAL,width:e,height:i},me={activityBarVisible:!this.stateModel.getRuntimeValue(a.ACTIVITYBAR_HIDDEN),sideBarVisible:!this.stateModel.getRuntimeValue(a.SIDEBAR_HIDDEN),auxiliaryBarVisible:!this.stateModel.getRuntimeValue(a.AUXILIARYBAR_HIDDEN),panelVisible:!this.stateModel.getRuntimeValue(a.PANEL_HIDDEN),statusbarVisible:!this.stateModel.getRuntimeValue(a.STATUSBAR_HIDDEN),sideBarPosition:O(this.stateModel.getRuntimeValue(a.SIDEBAR_POSITON)),panelPosition:O(this.stateModel.getRuntimeValue(a.PANEL_POSITION))};return this.telemetryService.publicLog2("startupLayout",me),Ae}dispose(){super.dispose(),this.disposed=!0}}function ce(b){return b.getValue("zenMode")}class Se{constructor(F,e,i,t){this.name=F;this.scope=e;this.target=i;this.defaultValue=t}}class v extends Se{constructor(e,i,t,n,o){super(e,i,t,n);this.zenModeIgnore=o}runtime=!0}class k extends Se{runtime=!1}const a={MAIN_EDITOR_CENTERED:new v("editor.centered",I.WORKSPACE,p.MACHINE,!1),ZEN_MODE_ACTIVE:new v("zenMode.active",I.WORKSPACE,p.MACHINE,!1),ZEN_MODE_EXIT_INFO:new v("zenMode.exitInfo",I.WORKSPACE,p.MACHINE,{transitionedToCenteredEditorLayout:!1,transitionedToFullScreen:!1,handleNotificationsDoNotDisturbMode:!1,wasVisible:{auxiliaryBar:!1,panel:!1,sideBar:!1}}),GRID_SIZE:new k("grid.size",I.PROFILE,p.MACHINE,{width:800,height:600}),SIDEBAR_SIZE:new k("sideBar.size",I.PROFILE,p.MACHINE,200),AUXILIARYBAR_SIZE:new k("auxiliaryBar.size",I.PROFILE,p.MACHINE,200),PANEL_SIZE:new k("panel.size",I.PROFILE,p.MACHINE,300),PANEL_LAST_NON_MAXIMIZED_HEIGHT:new v("panel.lastNonMaximizedHeight",I.PROFILE,p.MACHINE,300),PANEL_LAST_NON_MAXIMIZED_WIDTH:new v("panel.lastNonMaximizedWidth",I.PROFILE,p.MACHINE,300),PANEL_WAS_LAST_MAXIMIZED:new v("panel.wasLastMaximized",I.WORKSPACE,p.MACHINE,!1),SIDEBAR_POSITON:new v("sideBar.position",I.WORKSPACE,p.MACHINE,A.LEFT),PANEL_POSITION:new v("panel.position",I.WORKSPACE,p.MACHINE,A.BOTTOM),PANEL_ALIGNMENT:new v("panel.alignment",I.PROFILE,p.USER,"center"),ACTIVITYBAR_HIDDEN:new v("activityBar.hidden",I.WORKSPACE,p.MACHINE,!1,!0),SIDEBAR_HIDDEN:new v("sideBar.hidden",I.WORKSPACE,p.MACHINE,!1),EDITOR_HIDDEN:new v("editor.hidden",I.WORKSPACE,p.MACHINE,!1),PANEL_HIDDEN:new v("panel.hidden",I.WORKSPACE,p.MACHINE,!0),AUXILIARYBAR_HIDDEN:new v("auxiliaryBar.hidden",I.WORKSPACE,p.MACHINE,!0),STATUSBAR_HIDDEN:new v("statusBar.hidden",I.WORKSPACE,p.MACHINE,!1,!0)};var mi=(t=>(t.PANEL_POSITION="workbench.panel.defaultLocation",t.PANEL_OPENS_MAXIMIZED="workbench.panel.opensMaximized",t.ZEN_MODE_CONFIG="zenMode",t.EDITOR_CENTERED_LAYOUT_AUTO_RESIZE="workbench.editor.centeredLayoutAutoResize",t))(mi||{}),pi=(e=>(e.STATUSBAR_VISIBLE="workbench.statusBar.visible",e.SIDEBAR_POSITION="workbench.sideBar.location",e))(pi||{});class z extends ie{constructor(e,i,t,n){super();this.storageService=e;this.configurationService=i;this.contextService=t;this.container=n;this._register(this.configurationService.onDidChangeConfiguration(o=>this.updateStateFromLegacySettings(o)))}static STORAGE_PREFIX="workbench.";_onDidChangeState=this._register(new w);onDidChangeState=this._onDidChangeState.event;stateCache=new Map;updateStateFromLegacySettings(e){e.affectsConfiguration(y.ACTIVITY_BAR_LOCATION)&&this.setRuntimeValueAndFire(a.ACTIVITYBAR_HIDDEN,this.isActivityBarHidden()),e.affectsConfiguration("workbench.statusBar.visible")&&this.setRuntimeValueAndFire(a.STATUSBAR_HIDDEN,!this.configurationService.getValue("workbench.statusBar.visible")),e.affectsConfiguration("workbench.sideBar.location")&&this.setRuntimeValueAndFire(a.SIDEBAR_POSITON,G(this.configurationService.getValue("workbench.sideBar.location")??"left"))}updateLegacySettingsFromState(e,i){const t=this.getRuntimeValue(a.ZEN_MODE_ACTIVE);e.zenModeIgnore&&t||(e===a.ACTIVITYBAR_HIDDEN?this.configurationService.updateValue(y.ACTIVITY_BAR_LOCATION,i?M.HIDDEN:void 0):e===a.STATUSBAR_HIDDEN?this.configurationService.updateValue("workbench.statusBar.visible",!i):e===a.SIDEBAR_POSITON&&this.configurationService.updateValue("workbench.sideBar.location",O(i)))}load(){let e;for(e in a){const t=a[e],n=this.loadKeyFromStorage(t);n!==void 0&&this.stateCache.set(t.name,n)}this.stateCache.set(a.ACTIVITYBAR_HIDDEN.name,this.isActivityBarHidden()),this.stateCache.set(a.STATUSBAR_HIDDEN.name,!this.configurationService.getValue("workbench.statusBar.visible")),this.stateCache.set(a.SIDEBAR_POSITON.name,G(this.configurationService.getValue("workbench.sideBar.location")??"left"));const i=Z(this.container);a.PANEL_POSITION.defaultValue=G(this.configurationService.getValue("workbench.panel.defaultLocation")??"bottom"),a.GRID_SIZE.defaultValue={height:i.height,width:i.width},a.SIDEBAR_SIZE.defaultValue=Math.min(300,i.width/4),a.AUXILIARYBAR_SIZE.defaultValue=Math.min(300,i.width/4),a.PANEL_SIZE.defaultValue=this.stateCache.get(a.PANEL_POSITION.name)??f(a.PANEL_POSITION.defaultValue)?i.height/3:i.width/4,a.SIDEBAR_HIDDEN.defaultValue=this.contextService.getWorkbenchState()===le.EMPTY;for(e in a){const t=a[e];this.stateCache.get(t.name)===void 0&&this.stateCache.set(t.name,t.defaultValue)}this._register(this.storageService.onDidChangeValue(I.PROFILE,void 0,this._register(new te))(t=>{let n;for(n in a){const o=a[n];if(o instanceof v&&o.scope===I.PROFILE&&o.target===p.USER&&`${z.STORAGE_PREFIX}${o.name}`===t.key){const s=this.loadKeyFromStorage(o)??o.defaultValue;this.stateCache.get(o.name)!==s&&(this.stateCache.set(o.name,s),this._onDidChangeState.fire({key:o,value:s}))}}}))}save(e,i){let t;const n=this.getRuntimeValue(a.ZEN_MODE_ACTIVE);for(t in a){const o=a[t];if(e&&o.scope===I.WORKSPACE||i&&o.scope===I.PROFILE){if(n&&o instanceof v&&o.zenModeIgnore)continue;this.saveKeyToStorage(o)}}}getInitializationValue(e){return this.stateCache.get(e.name)}setInitializationValue(e,i){this.stateCache.set(e.name,i)}getRuntimeValue(e,i){if(i)switch(e){case a.ACTIVITYBAR_HIDDEN:this.stateCache.set(e.name,this.isActivityBarHidden());break;case a.STATUSBAR_HIDDEN:this.stateCache.set(e.name,!this.configurationService.getValue("workbench.statusBar.visible"));break;case a.SIDEBAR_POSITON:this.stateCache.set(e.name,this.configurationService.getValue("workbench.sideBar.location")??"left");break}return this.stateCache.get(e.name)}setRuntimeValue(e,i){this.stateCache.set(e.name,i);const t=this.getRuntimeValue(a.ZEN_MODE_ACTIVE);e.scope===I.PROFILE&&(!t||!e.zenModeIgnore)&&(this.saveKeyToStorage(e),this.updateLegacySettingsFromState(e,i))}isActivityBarHidden(){const e=this.configurationService.getValue("workbench.activityBar.visible");return e!==void 0?!e:this.configurationService.getValue(y.ACTIVITY_BAR_LOCATION)!==M.DEFAULT}setRuntimeValueAndFire(e,i){this.stateCache.get(e.name)!==i&&(this.setRuntimeValue(e,i),this._onDidChangeState.fire({key:e,value:i}))}saveKeyToStorage(e){const i=this.stateCache.get(e.name);this.storageService.store(`${z.STORAGE_PREFIX}${e.name}`,typeof i=="object"?JSON.stringify(i):i,e.scope,e.target)}loadKeyFromStorage(e){let i=this.storageService.get(`${z.STORAGE_PREFIX}${e.name}`,e.scope);if(i!==void 0)switch(typeof e.defaultValue){case"boolean":i=i==="true";break;case"number":i=Number.parseInt(i);break;case"object":i=JSON.parse(i);break}return i}}export{lt as Layout,Ai as TITLE_BAR_SETTINGS};
