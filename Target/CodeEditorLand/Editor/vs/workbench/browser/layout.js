import{isFullscreen as j,isWCOEnabled as Ae,onDidChangeFullscreen as me}from"../../../vs/base/browser/browser.js";import{addDisposableListener as J,computeScreenAwareSize as q,EventType as pe,getActiveDocument as fe,getActiveElement as ve,getActiveWindow as U,getClientArea as Z,getWindow as B,getWindowId as Y,getWindows as Te,isActiveDocument as Pe,isAncestorUsingFlowTo as Ee,position as Re,size as we}from"../../../vs/base/browser/dom.js";import{Direction as E,Orientation as ye,SerializableGrid as Ve,Sizing as C}from"../../../vs/base/browser/ui/grid/grid.js";import{mainWindow as g}from"../../../vs/base/browser/window.js";import{coalesce as K}from"../../../vs/base/common/arrays.js";import{DeferredPromise as Q,Promises as ee}from"../../../vs/base/common/async.js";import{Emitter as w}from"../../../vs/base/common/event.js";import{Disposable as ie,DisposableMap as De,DisposableStore as te,toDisposable as ae}from"../../../vs/base/common/lifecycle.js";import{mark as R}from"vs/base/common/performance";import{isIOS as re,isLinux as _e,isMacintosh as be,isWeb as L,isWindows as se}from"../../../vs/base/common/platform.js";import{assertIsDefined as z}from"../../../vs/base/common/types.js";import{URI as Be}from"../../../vs/base/common/uri.js";import{isCodeEditor as Ce}from"../../../vs/editor/browser/editorBrowser.js";import"../../../vs/editor/common/config/editorOptions.js";import{IConfigurationService as Le}from"../../../vs/platform/configuration/common/configuration.js";import{IFileService as Ne}from"../../../vs/platform/files/common/files.js";import"../../../vs/platform/instantiation/common/instantiation.js";import{ILogService as Me}from"../../../vs/platform/log/common/log.js";import{INotificationService as Oe,NotificationsFilter as N}from"../../../vs/platform/notification/common/notification.js";import{IStorageService as ze,StorageScope as I,StorageTarget as p}from"../../../vs/platform/storage/common/storage.js";import{ITelemetryService as He}from"../../../vs/platform/telemetry/common/telemetry.js";import{IThemeService as We}from"../../../vs/platform/theme/common/themeService.js";import{CustomTitleBarVisibility as ne,getMenuBarVisibility as oe,hasCustomTitlebar as xe,hasNativeTitlebar as X,TitleBarSetting as H,useWindowControlsOverlay as Ge}from"../../../vs/platform/window/common/window.js";import{isTemporaryWorkspace as ke,IWorkspaceContextService as Fe,WorkbenchState as le}from"../../../vs/platform/workspace/common/workspace.js";import{Part as Ue}from"../../../vs/workbench/browser/part.js";import{AuxiliaryBarPart as Ze}from"../../../vs/workbench/browser/parts/auxiliarybar/auxiliaryBarPart.js";import{PanelPart as Ye}from"../../../vs/workbench/browser/parts/panel/panelPart.js";import{SidebarPart as Ke}from"../../../vs/workbench/browser/parts/sidebar/sidebarPart.js";import{EditorInputCapabilities as Xe,isResourceEditorInput as W,pathsToEditors as $}from"../../../vs/workbench/common/editor.js";import{DiffEditorInput as $e}from"../../../vs/workbench/common/editor/diffEditorInput.js";import{WINDOW_ACTIVE_BORDER as je,WINDOW_INACTIVE_BORDER as Je}from"../../../vs/workbench/common/theme.js";import{IViewDescriptorService as qe,ViewContainerLocation as c}from"../../../vs/workbench/common/views.js";import{IAuxiliaryWindowService as Qe}from"../../../vs/workbench/services/auxiliaryWindow/browser/auxiliaryWindowService.js";import{IBannerService as ei}from"../../../vs/workbench/services/banner/browser/bannerService.js";import{GroupsOrder as ii,IEditorGroupsService as ti}from"../../../vs/workbench/services/editor/common/editorGroupsService.js";import{IEditorService as ai}from"../../../vs/workbench/services/editor/common/editorService.js";import{IBrowserWorkbenchEnvironmentService as ri}from"../../../vs/workbench/services/environment/browser/environmentService.js";import{IExtensionService as si}from"../../../vs/workbench/services/extensions/common/extensions.js";import{IHostService as ni}from"../../../vs/workbench/services/host/browser/host.js";import{ActivityBarPosition as x,EditorActionsLocation as oi,isHorizontal as f,LayoutSettings as y,panelOpensMaximizedFromString as li,PanelOpensMaximizedOptions as de,Parts as s,Position as A,positionFromString as G,positionToString as M,shouldShowCustomTitleBar as V,ZenModeSettings as T}from"../../../vs/workbench/services/layout/browser/layoutService.js";import{ILifecycleService as di,StartupKind as hi}from"../../../vs/workbench/services/lifecycle/common/lifecycle.js";import{IPaneCompositePartService as ui}from"../../../vs/workbench/services/panecomposite/browser/panecomposite.js";import{IStatusbarService as ci}from"../../../vs/workbench/services/statusbar/browser/statusbar.js";import{ITitleService as Si}from"../../../vs/workbench/services/title/browser/titleService.js";import{IWorkingCopyBackupService as Ii}from"../../../vs/workbench/services/workingCopy/common/workingCopyBackup.js";var gi=(l=>(l.SIDEBAR_HIDDEN="nosidebar",l.MAIN_EDITOR_AREA_HIDDEN="nomaineditorarea",l.PANEL_HIDDEN="nopanel",l.AUXILIARYBAR_HIDDEN="noauxiliarybar",l.STATUSBAR_HIDDEN="nostatusbar",l.FULLSCREEN="fullscreen",l.MAXIMIZED="maximized",l.WINDOW_BORDER="border",l))(gi||{});const Ai=[y.ACTIVITY_BAR_LOCATION,y.COMMAND_CENTER,y.EDITOR_ACTIONS_LOCATION,y.LAYOUT_ACTIONS,"window.menuBarVisibility",H.TITLE_BAR_STYLE,H.CUSTOM_TITLE_BAR_VISIBILITY];class Bt extends ie{constructor(e){super();this.parent=e}_onDidChangeZenMode=this._register(new w);onDidChangeZenMode=this._onDidChangeZenMode.event;_onDidChangeMainEditorCenteredLayout=this._register(new w);onDidChangeMainEditorCenteredLayout=this._onDidChangeMainEditorCenteredLayout.event;_onDidChangePanelAlignment=this._register(new w);onDidChangePanelAlignment=this._onDidChangePanelAlignment.event;_onDidChangeWindowMaximized=this._register(new w);onDidChangeWindowMaximized=this._onDidChangeWindowMaximized.event;_onDidChangePanelPosition=this._register(new w);onDidChangePanelPosition=this._onDidChangePanelPosition.event;_onDidChangePartVisibility=this._register(new w);onDidChangePartVisibility=this._onDidChangePartVisibility.event;_onDidChangeNotificationsVisibility=this._register(new w);onDidChangeNotificationsVisibility=this._onDidChangeNotificationsVisibility.event;_onDidLayoutMainContainer=this._register(new w);onDidLayoutMainContainer=this._onDidLayoutMainContainer.event;_onDidLayoutActiveContainer=this._register(new w);onDidLayoutActiveContainer=this._onDidLayoutActiveContainer.event;_onDidLayoutContainer=this._register(new w);onDidLayoutContainer=this._onDidLayoutContainer.event;_onDidAddContainer=this._register(new w);onDidAddContainer=this._onDidAddContainer.event;_onDidChangeActiveContainer=this._register(new w);onDidChangeActiveContainer=this._onDidChangeActiveContainer.event;mainContainer=document.createElement("div");get activeContainer(){return this.getContainerFromDocument(fe())}get containers(){const e=[];for(const{window:i}of Te())e.push(this.getContainerFromDocument(i.document));return e}getContainerFromDocument(e){return e===this.mainContainer.ownerDocument?this.mainContainer:e.body.getElementsByClassName("monaco-workbench")[0]}containerStylesLoaded=new Map;whenContainerStylesLoaded(e){return this.containerStylesLoaded.get(e.vscodeWindowId)}_mainContainerDimension;get mainContainerDimension(){return this._mainContainerDimension}get activeContainerDimension(){return this.getContainerDimension(this.activeContainer)}getContainerDimension(e){return e===this.mainContainer?this.mainContainerDimension:Z(e)}get mainContainerOffset(){return this.computeContainerOffset(g)}get activeContainerOffset(){return this.computeContainerOffset(B(this.activeContainer))}computeContainerOffset(e){let i=0,t=0;this.isVisible(s.BANNER_PART)&&(i=this.getPart(s.BANNER_PART).maximumHeight,t=i);const n=this.isVisible(s.TITLEBAR_PART,e);return n&&(i+=this.getPart(s.TITLEBAR_PART).maximumHeight,t=i),n&&this.configurationService.getValue(y.COMMAND_CENTER)!==!1&&(t=6),{top:i,quickPickTop:t}}parts=new Map;initialized=!1;workbenchGrid;titleBarPartView;bannerPartView;activityBarPartView;sideBarPartView;panelPartView;auxiliaryBarPartView;editorPartView;statusBarPartView;environmentService;extensionService;configurationService;storageService;hostService;editorService;mainPartEditorService;editorGroupService;paneCompositeService;titleService;viewDescriptorService;contextService;workingCopyBackupService;notificationService;themeService;statusBarService;logService;telemetryService;auxiliaryWindowService;state;stateModel;disposed=!1;initLayout(e){this.environmentService=e.get(ri),this.configurationService=e.get(Le),this.hostService=e.get(ni),this.contextService=e.get(Fe),this.storageService=e.get(ze),this.workingCopyBackupService=e.get(Ii),this.themeService=e.get(We),this.extensionService=e.get(si),this.logService=e.get(Me),this.telemetryService=e.get(He),this.auxiliaryWindowService=e.get(Qe),this.editorService=e.get(ai),this.mainPartEditorService=this.editorService.createScoped("main",this._store),this.editorGroupService=e.get(ti),this.paneCompositeService=e.get(ui),this.viewDescriptorService=e.get(qe),this.titleService=e.get(Si),this.notificationService=e.get(Oe),this.statusBarService=e.get(ci),e.get(ei),this.registerLayoutListeners(),this.initLayoutState(e.get(di),e.get(Ne))}registerLayoutListeners(){const e=()=>{this.isVisible(s.EDITOR_PART,g)||this.toggleMaximizedPanel()};this.editorGroupService.whenRestored.then(()=>{this._register(this.mainPartEditorService.onDidVisibleEditorsChange(e)),this._register(this.editorGroupService.mainPart.onDidActivateGroup(e)),this._register(this.mainPartEditorService.onDidActiveEditorChange(()=>this.centerMainEditorLayout(this.stateModel.getRuntimeValue(a.MAIN_EDITOR_CENTERED))))}),this._register(this.configurationService.onDidChangeConfiguration(t=>{if([...Ai,"workbench.sideBar.location","workbench.statusBar.visible"].some(n=>t.affectsConfiguration(n))){const n=t.affectsConfiguration(y.EDITOR_ACTIONS_LOCATION)&&this.configurationService.getValue(y.EDITOR_ACTIONS_LOCATION)===oi.TITLEBAR;let o=!1;if(t.affectsConfiguration(y.ACTIVITY_BAR_LOCATION)){const r=this.configurationService.getValue(y.ACTIVITY_BAR_LOCATION);o=r===x.TOP||r===x.BOTTOM}(o||n)&&this.configurationService.getValue(H.CUSTOM_TITLE_BAR_VISIBILITY)===ne.NEVER&&this.configurationService.updateValue(H.CUSTOM_TITLE_BAR_VISIBILITY,ne.AUTO),this.doUpdateLayoutConfiguration()}})),this._register(me(t=>this.onFullscreenChanged(t))),this._register(this.editorGroupService.mainPart.onDidAddGroup(()=>this.centerMainEditorLayout(this.stateModel.getRuntimeValue(a.MAIN_EDITOR_CENTERED)))),this._register(this.editorGroupService.mainPart.onDidRemoveGroup(()=>this.centerMainEditorLayout(this.stateModel.getRuntimeValue(a.MAIN_EDITOR_CENTERED)))),this._register(this.editorGroupService.mainPart.onDidChangeGroupMaximized(()=>this.centerMainEditorLayout(this.stateModel.getRuntimeValue(a.MAIN_EDITOR_CENTERED)))),this._register(J(this.mainContainer,pe.SCROLL,()=>this.mainContainer.scrollTop=0)),(se||_e||L)&&!X(this.configurationService)&&this._register(this.titleService.onMenubarVisibilityChange(t=>this.onMenubarToggled(t))),this._register(this.themeService.onDidColorThemeChange(()=>this.updateWindowsBorder())),this._register(this.hostService.onDidChangeFocus(t=>this.onWindowFocusChanged(t))),this._register(this.hostService.onDidChangeActiveWindow(()=>this.onActiveWindowChanged())),L&&typeof navigator.windowControlsOverlay=="object"&&this._register(J(navigator.windowControlsOverlay,"geometrychange",()=>this.onDidChangeWCO())),this._register(this.auxiliaryWindowService.onDidOpenAuxiliaryWindow(({window:t,disposables:n})=>{const o=t.window.vscodeWindowId;this.containerStylesLoaded.set(o,t.whenStylesHaveLoaded),t.whenStylesHaveLoaded.then(()=>this.containerStylesLoaded.delete(o)),n.add(ae(()=>this.containerStylesLoaded.delete(o)));const r=n.add(new te);this._onDidAddContainer.fire({container:t.container,disposables:r}),n.add(t.onDidLayout(l=>this.handleContainerDidLayout(t.container,l)))}))}onMenubarToggled(e){if(e!==this.state.runtime.menuBar.toggled){this.state.runtime.menuBar.toggled=e;const i=oe(this.configurationService);L&&i==="toggle"?this.workbenchGrid.setViewVisible(this.titleBarPartView,V(this.configurationService,g,this.state.runtime.menuBar.toggled,this.isZenModeActive())):this.state.runtime.mainWindowFullscreen&&(i==="toggle"||i==="classic")&&this.workbenchGrid.setViewVisible(this.titleBarPartView,V(this.configurationService,g,this.state.runtime.menuBar.toggled,this.isZenModeActive())),this.handleContainerDidLayout(this.mainContainer,this._mainContainerDimension)}}handleContainerDidLayout(e,i){e===this.mainContainer&&this._onDidLayoutMainContainer.fire(i),Pe(e)&&this._onDidLayoutActiveContainer.fire(i),this._onDidLayoutContainer.fire({container:e,dimension:i})}onFullscreenChanged(e){e===g.vscodeWindowId&&(this.state.runtime.mainWindowFullscreen=j(g),this.state.runtime.mainWindowFullscreen?this.mainContainer.classList.add("fullscreen"):(this.mainContainer.classList.remove("fullscreen"),this.stateModel.getRuntimeValue(a.ZEN_MODE_EXIT_INFO).transitionedToFullScreen&&this.isZenModeActive()&&this.toggleZenMode()),this.workbenchGrid.edgeSnapping=this.state.runtime.mainWindowFullscreen,xe(this.configurationService)&&(this.workbenchGrid.setViewVisible(this.titleBarPartView,V(this.configurationService,g,this.state.runtime.menuBar.toggled,this.isZenModeActive())),this.updateWindowsBorder(!0)))}onActiveWindowChanged(){const e=this.getActiveContainerId();this.state.runtime.activeContainerId!==e&&(this.state.runtime.activeContainerId=e,this.updateWindowsBorder(),this._onDidChangeActiveContainer.fire())}onWindowFocusChanged(e){this.state.runtime.hasFocus!==e&&(this.state.runtime.hasFocus=e,this.updateWindowsBorder())}getActiveContainerId(){const e=this.activeContainer;return B(e).vscodeWindowId}doUpdateLayoutConfiguration(e){this.updateCustomTitleBarVisibility(),this.updateMenubarVisibility(!!e),this.editorGroupService.whenRestored.then(()=>{this.centerMainEditorLayout(this.stateModel.getRuntimeValue(a.MAIN_EDITOR_CENTERED),e)})}setSideBarPosition(e){const i=this.getPart(s.ACTIVITYBAR_PART),t=this.getPart(s.SIDEBAR_PART),n=this.getPart(s.AUXILIARYBAR_PART),o=e===A.LEFT?"left":"right",r=e===A.RIGHT?"left":"right",l=this.getPanelAlignment(),d=this.getPanelPosition();this.stateModel.setRuntimeValue(a.SIDEBAR_POSITON,e);const u=z(i.getContainer()),h=z(t.getContainer()),S=z(n.getContainer());u.classList.remove(r),h.classList.remove(r),u.classList.add(o),h.classList.add(o),S.classList.remove(o),S.classList.add(r),i.updateStyles(),t.updateStyles(),n.updateStyles(),this.adjustPartPositions(e,l,d)}updateWindowsBorder(e=!1){if(L||se||Ge(this.configurationService)||X(this.configurationService))return;const i=this.themeService.getColorTheme(),t=i.getColor(je),n=i.getColor(Je),o=this.hasMainWindowBorder();for(const r of this.containers){const l=r===this.mainContainer,d=this.activeContainer===r,u=Y(B(r));let h=!1;if(!this.state.runtime.mainWindowFullscreen&&!this.state.runtime.maximized.has(u)&&(t||n)){h=!0;const S=d&&this.state.runtime.hasFocus?t:n??t;r.style.setProperty("--window-border-color",S?.toString()??"transparent")}l&&(this.state.runtime.mainWindowBorder=h),r.classList.toggle("border",h)}!e&&o!==this.hasMainWindowBorder()&&this.layout()}initLayoutState(e,i){this.stateModel=new O(this.storageService,this.configurationService,this.contextService,this.parent),this.stateModel.load(),this.stateModel.getRuntimeValue(a.PANEL_HIDDEN)&&this.stateModel.getRuntimeValue(a.EDITOR_HIDDEN)&&this.stateModel.setRuntimeValue(a.EDITOR_HIDDEN,!1),this._register(this.stateModel.onDidChangeState(r=>{r.key===a.ACTIVITYBAR_HIDDEN&&this.setActivityBarHidden(r.value),r.key===a.STATUSBAR_HIDDEN&&this.setStatusBarHidden(r.value),r.key===a.SIDEBAR_POSITON&&this.setSideBarPosition(r.value),r.key===a.PANEL_POSITION&&this.setPanelPosition(r.value),r.key===a.PANEL_ALIGNMENT&&this.setPanelAlignment(r.value),this.doUpdateLayoutConfiguration()}));const t=this.getInitialEditorsState();t&&this.logService.trace("Initial editor state",t);const n={layout:{editors:t?.layout},editor:{restoreEditors:this.shouldRestoreEditors(this.contextService,t),editorsToOpen:this.resolveEditorsToOpen(i,t)},views:{defaults:this.getDefaultLayoutViews(this.environmentService,this.storageService),containerToRestore:{}}},o={activeContainerId:this.getActiveContainerId(),mainWindowFullscreen:j(g),hasFocus:this.hostService.hasFocus,maximized:new Set,mainWindowBorder:!1,menuBar:{toggled:!1},zenMode:{transitionDisposables:new De}};if(this.state={initialization:n,runtime:o},this.isVisible(s.SIDEBAR_PART)){let r;!this.environmentService.isBuilt||e.startupKind===hi.ReloadedWindow||this.environmentService.isExtensionDevelopment&&!this.environmentService.extensionTestsLocationURI?r=this.storageService.get(Ke.activeViewletSettingsKey,I.WORKSPACE,this.viewDescriptorService.getDefaultViewContainer(c.Sidebar)?.id):r=this.viewDescriptorService.getDefaultViewContainer(c.Sidebar)?.id,r?this.state.initialization.views.containerToRestore.sideBar=r:this.stateModel.setRuntimeValue(a.SIDEBAR_HIDDEN,!0)}if(this.isVisible(s.PANEL_PART)){const r=this.storageService.get(Ye.activePanelSettingsKey,I.WORKSPACE,this.viewDescriptorService.getDefaultViewContainer(c.Panel)?.id);r?this.state.initialization.views.containerToRestore.panel=r:this.stateModel.setRuntimeValue(a.PANEL_HIDDEN,!0)}if(this.isVisible(s.AUXILIARYBAR_PART)){const r=this.storageService.get(Ze.activePanelSettingsKey,I.WORKSPACE,this.viewDescriptorService.getDefaultViewContainer(c.AuxiliaryBar)?.id);r?this.state.initialization.views.containerToRestore.auxiliaryBar=r:this.stateModel.setRuntimeValue(a.AUXILIARYBAR_HIDDEN,!0)}this.updateWindowsBorder(!0)}getDefaultLayoutViews(e,i){const t=e.options?.defaultLayout;if(!t||!t.force&&!i.isNew(I.WORKSPACE))return;const{views:n}=t;if(n?.length)return n.map(o=>o.id)}shouldRestoreEditors(e,i){return ke(e.getWorkspace())?!1:!!(this.configurationService.getValue("window.restoreWindows")==="preserve")||i===void 0}willRestoreEditors(){return this.state.initialization.editor.restoreEditors}async resolveEditorsToOpen(e,i){if(i){const t=K(await $(i.filesToMerge,e,this.logService));if(t.length===4&&W(t[0])&&W(t[1])&&W(t[2])&&W(t[3]))return[{editor:{input1:{resource:t[0].resource},input2:{resource:t[1].resource},base:{resource:t[2].resource},result:{resource:t[3].resource},options:{pinned:!0}}}];const n=K(await $(i.filesToDiff,e,this.logService));if(n.length===2)return[{editor:{original:{resource:n[0].resource},modified:{resource:n[1].resource},options:{pinned:!0}}}];const o=[],r=await $(i.filesToOpenOrCreate,e,this.logService);for(let l=0;l<r.length;l++){const d=r[l];d&&o.push({editor:d,viewColumn:i.filesToOpenOrCreate?.[l].viewColumn})}return o}else if(this.contextService.getWorkbenchState()===le.EMPTY&&this.configurationService.getValue("workbench.startupEditor")==="newUntitledFile")return this.editorGroupService.hasRestorableState?[]:await this.workingCopyBackupService.hasBackups()?[]:[{editor:{resource:void 0}}];return[]}_openedDefaultEditors=!1;get openedDefaultEditors(){return this._openedDefaultEditors}getInitialEditorsState(){const e=this.environmentService.options?.defaultLayout;if((e?.editors?.length||e?.layout?.editors)&&(e.force||this.storageService.isNew(I.WORKSPACE)))return this._openedDefaultEditors=!0,{layout:e.layout?.editors,filesToOpenOrCreate:e?.editors?.map(o=>({viewColumn:o.viewColumn,fileUri:Be.revive(o.uri),openOnlyIfExists:o.openOnlyIfExists,options:o.options}))};const{filesToOpenOrCreate:i,filesToDiff:t,filesToMerge:n}=this.environmentService;if(i||t||n)return{filesToOpenOrCreate:i,filesToDiff:t,filesToMerge:n}}whenReadyPromise=new Q;whenReady=this.whenReadyPromise.p;whenRestoredPromise=new Q;whenRestored=this.whenRestoredPromise.p;restored=!1;isRestored(){return this.restored}restoreParts(){const e=[],i=[];e.push((async()=>{R("code/willRestoreEditors"),await this.editorGroupService.whenReady,R("code/restoreEditors/editorGroupsReady"),this.state.initialization.layout?.editors&&this.editorGroupService.mainPart.applyLayout(this.state.initialization.layout.editors);const r=await this.state.initialization.editor.editorsToOpen;R("code/restoreEditors/editorsToOpenResolved");let l;if(r.length){const d=this.editorGroupService.mainPart.getGroups(ii.GRID_APPEARANCE),u=new Map;for(const h of r){const S=d[(h.viewColumn??1)-1];let m=u.get(S.id);m||(m=new Set,u.set(S.id,m)),m.add(h.editor)}l=Promise.all(Array.from(u).map(async([h,S])=>{try{await this.editorService.openEditors(Array.from(S),h,{validateTrust:!0})}catch(m){this.logService.error(m)}}))}i.push(Promise.all([l?.finally(()=>R("code/restoreEditors/editorsOpened")),this.editorGroupService.whenRestored.finally(()=>R("code/restoreEditors/editorGroupsRestored"))]).finally(()=>{R("code/didRestoreEditors")}))})());const t=(async()=>{if(this.state.initialization.views.defaults?.length){R("code/willOpenDefaultViews");const r=[],l=h=>{const S=this.viewDescriptorService.getViewLocationById(h.id);if(S!==null){const m=this.viewDescriptorService.getViewContainerByViewId(h.id);if(m){h.order>=(r?.[S]?.order??0)&&(r[S]={id:m.id,order:h.order});const P=this.viewDescriptorService.getViewContainerModel(m);return P.setCollapsed(h.id,!1),P.setVisible(h.id,!0),!0}}return!1},d=[...this.state.initialization.views.defaults].reverse().map((h,S)=>({id:h,order:S}));let u=d.length;for(;u;)u--,l(d[u])&&d.splice(u,1);if(d.length){await this.extensionService.whenInstalledExtensionsRegistered();let h=d.length;for(;h;)h--,l(d[h])&&d.splice(h,1)}r[c.Sidebar]&&(this.state.initialization.views.containerToRestore.sideBar=r[c.Sidebar].id),r[c.Panel]&&(this.state.initialization.views.containerToRestore.panel=r[c.Panel].id),r[c.AuxiliaryBar]&&(this.state.initialization.views.containerToRestore.auxiliaryBar=r[c.AuxiliaryBar].id),R("code/didOpenDefaultViews")}})();e.push(t),e.push((async()=>{if(await t,!this.state.initialization.views.containerToRestore.sideBar)return;R("code/willRestoreViewlet"),await this.paneCompositeService.openPaneComposite(this.state.initialization.views.containerToRestore.sideBar,c.Sidebar)||await this.paneCompositeService.openPaneComposite(this.viewDescriptorService.getDefaultViewContainer(c.Sidebar)?.id,c.Sidebar),R("code/didRestoreViewlet")})()),e.push((async()=>{if(await t,!this.state.initialization.views.containerToRestore.panel)return;R("code/willRestorePanel"),await this.paneCompositeService.openPaneComposite(this.state.initialization.views.containerToRestore.panel,c.Panel)||await this.paneCompositeService.openPaneComposite(this.viewDescriptorService.getDefaultViewContainer(c.Panel)?.id,c.Panel),R("code/didRestorePanel")})()),e.push((async()=>{if(await t,!this.state.initialization.views.containerToRestore.auxiliaryBar)return;R("code/willRestoreAuxiliaryBar"),await this.paneCompositeService.openPaneComposite(this.state.initialization.views.containerToRestore.auxiliaryBar,c.AuxiliaryBar)||await this.paneCompositeService.openPaneComposite(this.viewDescriptorService.getDefaultViewContainer(c.AuxiliaryBar)?.id,c.AuxiliaryBar),R("code/didRestoreAuxiliaryBar")})());const n=this.isZenModeActive(),o=he(this.configurationService).restore;n&&(this.setZenModeActive(!o),this.toggleZenMode(!1,!0)),this.stateModel.getRuntimeValue(a.MAIN_EDITOR_CENTERED)&&this.centerMainEditorLayout(!0,!0),ee.settled(e).finally(()=>{this.whenReadyPromise.complete(),ee.settled(i).finally(()=>{this.restored=!0,this.whenRestoredPromise.complete()})})}registerPart(e){const i=e.getId();return this.parts.set(i,e),ae(()=>this.parts.delete(i))}getPart(e){const i=this.parts.get(e);if(!i)throw new Error(`Unknown part ${e}`);return i}registerNotifications(e){this._register(e.onDidChangeNotificationsVisibility(i=>this._onDidChangeNotificationsVisibility.fire(i)))}hasFocus(e){const i=this.getContainer(U(),e);if(!i)return!1;const t=ve();return t?Ee(t,i):!1}focusPart(e,i=g){const t=this.getContainer(i,e)??this.mainContainer;switch(e){case s.EDITOR_PART:this.editorGroupService.getPart(t).activeGroup.focus();break;case s.PANEL_PART:{this.paneCompositeService.getActivePaneComposite(c.Panel)?.focus();break}case s.SIDEBAR_PART:{this.paneCompositeService.getActivePaneComposite(c.Sidebar)?.focus();break}case s.AUXILIARYBAR_PART:{this.paneCompositeService.getActivePaneComposite(c.AuxiliaryBar)?.focus();break}case s.ACTIVITYBAR_PART:this.getPart(s.SIDEBAR_PART).focusActivityBar();break;case s.STATUSBAR_PART:this.statusBarService.getPart(t).focus();break;default:t?.focus()}}getContainer(e,i){if(typeof i>"u")return this.getContainerFromDocument(e.document);if(e===g)return this.getPart(i).getContainer();let t;if(i===s.EDITOR_PART?t=this.editorGroupService.getPart(this.getContainerFromDocument(e.document)):i===s.STATUSBAR_PART?t=this.statusBarService.getPart(this.getContainerFromDocument(e.document)):i===s.TITLEBAR_PART&&(t=this.titleService.getPart(this.getContainerFromDocument(e.document))),t instanceof Ue)return t.getContainer()}isVisible(e,i=g){if(i!==g&&e===s.EDITOR_PART)return!0;if(this.initialized)switch(e){case s.TITLEBAR_PART:return this.workbenchGrid.isViewVisible(this.titleBarPartView);case s.SIDEBAR_PART:return!this.stateModel.getRuntimeValue(a.SIDEBAR_HIDDEN);case s.PANEL_PART:return!this.stateModel.getRuntimeValue(a.PANEL_HIDDEN);case s.AUXILIARYBAR_PART:return!this.stateModel.getRuntimeValue(a.AUXILIARYBAR_HIDDEN);case s.STATUSBAR_PART:return!this.stateModel.getRuntimeValue(a.STATUSBAR_HIDDEN);case s.ACTIVITYBAR_PART:return!this.stateModel.getRuntimeValue(a.ACTIVITYBAR_HIDDEN);case s.EDITOR_PART:return!this.stateModel.getRuntimeValue(a.EDITOR_HIDDEN);case s.BANNER_PART:return this.workbenchGrid.isViewVisible(this.bannerPartView);default:return!1}switch(e){case s.TITLEBAR_PART:return V(this.configurationService,g,this.state.runtime.menuBar.toggled,this.isZenModeActive());case s.SIDEBAR_PART:return!this.stateModel.getRuntimeValue(a.SIDEBAR_HIDDEN);case s.PANEL_PART:return!this.stateModel.getRuntimeValue(a.PANEL_HIDDEN);case s.AUXILIARYBAR_PART:return!this.stateModel.getRuntimeValue(a.AUXILIARYBAR_HIDDEN);case s.STATUSBAR_PART:return!this.stateModel.getRuntimeValue(a.STATUSBAR_HIDDEN);case s.ACTIVITYBAR_PART:return!this.stateModel.getRuntimeValue(a.ACTIVITYBAR_HIDDEN);case s.EDITOR_PART:return!this.stateModel.getRuntimeValue(a.EDITOR_HIDDEN);default:return!1}}shouldShowBannerFirst(){return L&&!Ae()}focus(){this.focusPart(s.EDITOR_PART,B(this.activeContainer))}focusPanelOrEditor(){const e=this.paneCompositeService.getActivePaneComposite(c.Panel);(this.hasFocus(s.PANEL_PART)||!this.isVisible(s.EDITOR_PART))&&e?e.focus():this.focus()}getMaximumEditorDimensions(e){const i=B(e),t=this.getContainerDimension(e);if(e===this.mainContainer){const n=f(this.getPanelPosition()),o=(this.isVisible(s.ACTIVITYBAR_PART)?this.activityBarPartView.minimumWidth:0)+(this.isVisible(s.SIDEBAR_PART)?this.sideBarPartView.minimumWidth:0)+(this.isVisible(s.PANEL_PART)&&!n?this.panelPartView.minimumWidth:0)+(this.isVisible(s.AUXILIARYBAR_PART)?this.auxiliaryBarPartView.minimumWidth:0),r=(this.isVisible(s.TITLEBAR_PART,i)?this.titleBarPartView.minimumHeight:0)+(this.isVisible(s.STATUSBAR_PART,i)?this.statusBarPartView.minimumHeight:0)+(this.isVisible(s.PANEL_PART)&&n?this.panelPartView.minimumHeight:0),l=t.width-o,d=t.height-r;return{width:l,height:d}}else{const n=(this.isVisible(s.TITLEBAR_PART,i)?this.titleBarPartView.minimumHeight:0)+(this.isVisible(s.STATUSBAR_PART,i)?this.statusBarPartView.minimumHeight:0);return{width:t.width,height:t.height-n}}}isZenModeActive(){return this.stateModel.getRuntimeValue(a.ZEN_MODE_ACTIVE)}setZenModeActive(e){this.stateModel.setRuntimeValue(a.ZEN_MODE_ACTIVE,e)}toggleZenMode(e,i=!1){this.setZenModeActive(!this.isZenModeActive()),this.state.runtime.zenMode.transitionDisposables.clearAndDisposeAll();const t=l=>{for(const d of this.mainPartEditorService.visibleTextEditorControls){if(!l&&Ce(d)&&d.hasModel()){const u=d.getModel();l=this.configurationService.getValue("editor.lineNumbers",{resource:u.uri,overrideIdentifier:u.getLanguageId()})}l||(l=this.configurationService.getValue("editor.lineNumbers")),d.updateOptions({lineNumbers:l})}};let n=!1;const o=he(this.configurationService),r=this.stateModel.getRuntimeValue(a.ZEN_MODE_EXIT_INFO);this.isZenModeActive()?(n=!this.state.runtime.mainWindowFullscreen&&o.fullScreen&&!re,i||(r.transitionedToFullScreen=n,r.transitionedToCenteredEditorLayout=!this.isMainEditorLayoutCentered()&&o.centerLayout,r.handleNotificationsDoNotDisturbMode=this.notificationService.getFilter()===N.OFF,r.wasVisible.sideBar=this.isVisible(s.SIDEBAR_PART),r.wasVisible.panel=this.isVisible(s.PANEL_PART),r.wasVisible.auxiliaryBar=this.isVisible(s.AUXILIARYBAR_PART),this.stateModel.setRuntimeValue(a.ZEN_MODE_EXIT_INFO,r)),this.setPanelHidden(!0,!0),this.setAuxiliaryBarHidden(!0,!0),this.setSideBarHidden(!0,!0),o.hideActivityBar&&this.setActivityBarHidden(!0,!0),o.hideStatusBar&&this.setStatusBarHidden(!0,!0),o.hideLineNumbers&&(t("off"),this.state.runtime.zenMode.transitionDisposables.set(T.HIDE_LINENUMBERS,this.mainPartEditorService.onDidVisibleEditorsChange(()=>t("off")))),o.showTabs!==this.editorGroupService.partOptions.showTabs&&this.state.runtime.zenMode.transitionDisposables.set(T.SHOW_TABS,this.editorGroupService.mainPart.enforcePartOptions({showTabs:o.showTabs})),o.silentNotifications&&r.handleNotificationsDoNotDisturbMode&&this.notificationService.setFilter(N.ERROR),o.centerLayout&&this.centerMainEditorLayout(!0,!0),this.state.runtime.zenMode.transitionDisposables.set("configurationChange",this.configurationService.onDidChangeConfiguration(l=>{if(l.affectsConfiguration(T.HIDE_ACTIVITYBAR)){const d=this.configurationService.getValue(T.HIDE_ACTIVITYBAR);this.setActivityBarHidden(d,!0)}if(l.affectsConfiguration(T.HIDE_STATUSBAR)){const d=this.configurationService.getValue(T.HIDE_STATUSBAR);this.setStatusBarHidden(d,!0)}if(l.affectsConfiguration(T.CENTER_LAYOUT)){const d=this.configurationService.getValue(T.CENTER_LAYOUT);this.centerMainEditorLayout(d,!0)}if(l.affectsConfiguration(T.SHOW_TABS)){const d=this.configurationService.getValue(T.SHOW_TABS)??"multiple";this.state.runtime.zenMode.transitionDisposables.set(T.SHOW_TABS,this.editorGroupService.mainPart.enforcePartOptions({showTabs:d}))}if(l.affectsConfiguration(T.SILENT_NOTIFICATIONS)){const d=!!this.configurationService.getValue(T.SILENT_NOTIFICATIONS);r.handleNotificationsDoNotDisturbMode&&this.notificationService.setFilter(d?N.ERROR:N.OFF)}if(l.affectsConfiguration(T.HIDE_LINENUMBERS)){const d=this.configurationService.getValue(T.HIDE_LINENUMBERS)?"off":void 0;t(d),this.state.runtime.zenMode.transitionDisposables.set(T.HIDE_LINENUMBERS,this.mainPartEditorService.onDidVisibleEditorsChange(()=>t(d)))}}))):(r.wasVisible.panel&&this.setPanelHidden(!1,!0),r.wasVisible.auxiliaryBar&&this.setAuxiliaryBarHidden(!1,!0),r.wasVisible.sideBar&&this.setSideBarHidden(!1,!0),this.stateModel.getRuntimeValue(a.ACTIVITYBAR_HIDDEN,!0)||this.setActivityBarHidden(!1,!0),this.stateModel.getRuntimeValue(a.STATUSBAR_HIDDEN,!0)||this.setStatusBarHidden(!1,!0),r.transitionedToCenteredEditorLayout&&this.centerMainEditorLayout(!1,!0),r.handleNotificationsDoNotDisturbMode&&this.notificationService.setFilter(N.OFF),t(),this.focus(),n=r.transitionedToFullScreen&&this.state.runtime.mainWindowFullscreen),e||this.layout(),n&&this.hostService.toggleFullScreen(g),this._onDidChangeZenMode.fire(this.isZenModeActive())}setStatusBarHidden(e,i){this.stateModel.setRuntimeValue(a.STATUSBAR_HIDDEN,e),e?this.mainContainer.classList.add("nostatusbar"):this.mainContainer.classList.remove("nostatusbar"),this.workbenchGrid.setViewVisible(this.statusBarPartView,!e)}createWorkbenchLayout(){const e=this.getPart(s.TITLEBAR_PART),i=this.getPart(s.BANNER_PART),t=this.getPart(s.EDITOR_PART),n=this.getPart(s.ACTIVITYBAR_PART),o=this.getPart(s.PANEL_PART),r=this.getPart(s.AUXILIARYBAR_PART),l=this.getPart(s.SIDEBAR_PART),d=this.getPart(s.STATUSBAR_PART);this.titleBarPartView=e,this.bannerPartView=i,this.sideBarPartView=l,this.activityBarPartView=n,this.editorPartView=t,this.panelPartView=o,this.auxiliaryBarPartView=r,this.statusBarPartView=d;const u={[s.ACTIVITYBAR_PART]:this.activityBarPartView,[s.BANNER_PART]:this.bannerPartView,[s.TITLEBAR_PART]:this.titleBarPartView,[s.EDITOR_PART]:this.editorPartView,[s.PANEL_PART]:this.panelPartView,[s.SIDEBAR_PART]:this.sideBarPartView,[s.STATUSBAR_PART]:this.statusBarPartView,[s.AUXILIARYBAR_PART]:this.auxiliaryBarPartView},h=({type:m})=>u[m],S=Ve.deserialize(this.createGridDescriptor(),{fromJSON:h},{proportionalLayout:!1});this.mainContainer.prepend(S.element),this.mainContainer.setAttribute("role","application"),this.workbenchGrid=S,this.workbenchGrid.edgeSnapping=this.state.runtime.mainWindowFullscreen;for(const m of[e,t,n,o,l,d,r,i])this._register(m.onDidVisibilityChange(P=>{m===l?this.setSideBarHidden(!P,!0):m===o?this.setPanelHidden(!P,!0):m===r?this.setAuxiliaryBarHidden(!P,!0):m===t&&this.setEditorHidden(!P,!0),this._onDidChangePartVisibility.fire(),this.handleContainerDidLayout(this.mainContainer,this._mainContainerDimension)}));this._register(this.storageService.onWillSaveState(m=>{const P=this.stateModel.getRuntimeValue(a.SIDEBAR_HIDDEN)?this.workbenchGrid.getViewCachedVisibleSize(this.sideBarPartView):this.workbenchGrid.getViewSize(this.sideBarPartView).width;this.stateModel.setInitializationValue(a.SIDEBAR_SIZE,P);const D=this.stateModel.getRuntimeValue(a.PANEL_HIDDEN)?this.workbenchGrid.getViewCachedVisibleSize(this.panelPartView):f(this.stateModel.getRuntimeValue(a.PANEL_POSITION))?this.workbenchGrid.getViewSize(this.panelPartView).height:this.workbenchGrid.getViewSize(this.panelPartView).width;this.stateModel.setInitializationValue(a.PANEL_SIZE,D);const _=this.stateModel.getRuntimeValue(a.AUXILIARYBAR_HIDDEN)?this.workbenchGrid.getViewCachedVisibleSize(this.auxiliaryBarPartView):this.workbenchGrid.getViewSize(this.auxiliaryBarPartView).width;this.stateModel.setInitializationValue(a.AUXILIARYBAR_SIZE,_),this.stateModel.save(!0,!0)}))}layout(){this.disposed||(this._mainContainerDimension=Z(this.state.runtime.mainWindowFullscreen?g.document.body:this.parent),this.logService.trace(`Layout#layout, height: ${this._mainContainerDimension.height}, width: ${this._mainContainerDimension.width}`),Re(this.mainContainer,0,0,0,0,"relative"),we(this.mainContainer,this._mainContainerDimension.width,this._mainContainerDimension.height),this.workbenchGrid.layout(this._mainContainerDimension.width,this._mainContainerDimension.height),this.initialized=!0,this.handleContainerDidLayout(this.mainContainer,this._mainContainerDimension))}isMainEditorLayoutCentered(){return this.stateModel.getRuntimeValue(a.MAIN_EDITOR_CENTERED)}centerMainEditorLayout(e,i){this.stateModel.setRuntimeValue(a.MAIN_EDITOR_CENTERED,e);const t=this.mainPartEditorService.activeEditor;let n=!1;t instanceof $e?n=this.configurationService.getValue("diffEditor.renderSideBySide"):t?.hasCapability(Xe.MultipleEditors)&&(n=!0),this.configurationService.getValue("workbench.editor.centeredLayoutAutoResize")&&(this.editorGroupService.mainPart.groups.length>1&&!this.editorGroupService.mainPart.hasMaximizedGroup()||n)&&(e=!1),this.editorGroupService.mainPart.isLayoutCentered()!==e&&(this.editorGroupService.mainPart.centerLayout(e),i||this.layout()),this._onDidChangeMainEditorCenteredLayout.fire(this.stateModel.getRuntimeValue(a.MAIN_EDITOR_CENTERED))}resizePart(e,i,t){const n=Math.sign(i)*q(U(),Math.abs(i)),o=Math.sign(t)*q(U(),Math.abs(t));let r;switch(e){case s.SIDEBAR_PART:r=this.workbenchGrid.getViewSize(this.sideBarPartView),this.workbenchGrid.resizeView(this.sideBarPartView,{width:r.width+n,height:r.height});break;case s.PANEL_PART:r=this.workbenchGrid.getViewSize(this.panelPartView),this.workbenchGrid.resizeView(this.panelPartView,{width:r.width+(f(this.getPanelPosition())?0:n),height:r.height+(f(this.getPanelPosition())?o:0)});break;case s.AUXILIARYBAR_PART:r=this.workbenchGrid.getViewSize(this.auxiliaryBarPartView),this.workbenchGrid.resizeView(this.auxiliaryBarPartView,{width:r.width+n,height:r.height});break;case s.EDITOR_PART:if(r=this.workbenchGrid.getViewSize(this.editorPartView),this.editorGroupService.mainPart.count===1)this.workbenchGrid.resizeView(this.editorPartView,{width:r.width+n,height:r.height+o});else{const l=this.editorGroupService.mainPart.activeGroup,{width:d,height:u}=this.editorGroupService.mainPart.getSize(l);this.editorGroupService.mainPart.setSize(l,{width:d+n,height:u+o});const{width:h,height:S}=this.editorGroupService.mainPart.getSize(l);(o&&u===S||n&&d===h)&&this.workbenchGrid.resizeView(this.editorPartView,{width:r.width+(n&&d===h?n:0),height:r.height+(o&&u===S?o:0)})}break;default:return}}setActivityBarHidden(e,i){this.stateModel.setRuntimeValue(a.ACTIVITYBAR_HIDDEN,e),this.workbenchGrid.setViewVisible(this.activityBarPartView,!e)}setBannerHidden(e){this.workbenchGrid.setViewVisible(this.bannerPartView,!e)}setEditorHidden(e,i){this.stateModel.setRuntimeValue(a.EDITOR_HIDDEN,e),e?this.mainContainer.classList.add("nomaineditorarea"):this.mainContainer.classList.remove("nomaineditorarea"),this.workbenchGrid.setViewVisible(this.editorPartView,!e),e&&!this.isVisible(s.PANEL_PART)&&this.setPanelHidden(!1,!0)}getLayoutClasses(){return K([this.isVisible(s.SIDEBAR_PART)?void 0:"nosidebar",this.isVisible(s.EDITOR_PART,g)?void 0:"nomaineditorarea",this.isVisible(s.PANEL_PART)?void 0:"nopanel",this.isVisible(s.AUXILIARYBAR_PART)?void 0:"noauxiliarybar",this.isVisible(s.STATUSBAR_PART)?void 0:"nostatusbar",this.state.runtime.mainWindowFullscreen?"fullscreen":void 0])}setSideBarHidden(e,i){if(this.stateModel.setRuntimeValue(a.SIDEBAR_HIDDEN,e),e?this.mainContainer.classList.add("nosidebar"):this.mainContainer.classList.remove("nosidebar"),e&&this.paneCompositeService.getActivePaneComposite(c.Sidebar))this.paneCompositeService.hideActivePaneComposite(c.Sidebar),this.focusPanelOrEditor();else if(!e&&!this.paneCompositeService.getActivePaneComposite(c.Sidebar)){const t=this.paneCompositeService.getLastActivePaneCompositeId(c.Sidebar);t&&(this.paneCompositeService.openPaneComposite(t,c.Sidebar,!0)||this.paneCompositeService.openPaneComposite(this.viewDescriptorService.getDefaultViewContainer(c.Sidebar)?.id,c.Sidebar,!0))}this.workbenchGrid.setViewVisible(this.sideBarPartView,!e)}hasViews(e){const i=this.viewDescriptorService.getViewContainerById(e);if(!i)return!1;const t=this.viewDescriptorService.getViewContainerModel(i);return t?t.activeViewDescriptors.length>=1:!1}adjustPartPositions(e,i,t){const n=!f(t),o=n||!(i==="center"||e===A.LEFT&&i==="right"||e===A.RIGHT&&i==="left"),r=n||!(i==="center"||e===A.RIGHT&&i==="right"||e===A.LEFT&&i==="left"),l=this.isVisible(s.PANEL_PART)?this.workbenchGrid.getViewSize(this.panelPartView).width:C.Invisible(this.workbenchGrid.getViewCachedVisibleSize(this.panelPartView)??this.panelPartView.minimumWidth),d=this.isVisible(s.PANEL_PART)?this.workbenchGrid.getViewSize(this.panelPartView).height:C.Invisible(this.workbenchGrid.getViewCachedVisibleSize(this.panelPartView)??this.panelPartView.minimumHeight),u=this.isVisible(s.SIDEBAR_PART)?this.workbenchGrid.getViewSize(this.sideBarPartView).width:C.Invisible(this.workbenchGrid.getViewCachedVisibleSize(this.sideBarPartView)??this.sideBarPartView.minimumWidth),h=this.isVisible(s.AUXILIARYBAR_PART)?this.workbenchGrid.getViewSize(this.auxiliaryBarPartView).width:C.Invisible(this.workbenchGrid.getViewCachedVisibleSize(this.auxiliaryBarPartView)??this.auxiliaryBarPartView.minimumWidth);e===A.LEFT?(this.workbenchGrid.moveViewTo(this.activityBarPartView,[2,0]),this.workbenchGrid.moveView(this.sideBarPartView,u,o?this.editorPartView:this.activityBarPartView,o?E.Left:E.Right),r?this.workbenchGrid.moveView(this.auxiliaryBarPartView,h,this.editorPartView,E.Right):this.workbenchGrid.moveViewTo(this.auxiliaryBarPartView,[2,-1])):(this.workbenchGrid.moveViewTo(this.activityBarPartView,[2,-1]),this.workbenchGrid.moveView(this.sideBarPartView,u,o?this.editorPartView:this.activityBarPartView,o?E.Right:E.Left),r?this.workbenchGrid.moveView(this.auxiliaryBarPartView,h,this.editorPartView,E.Left):this.workbenchGrid.moveViewTo(this.auxiliaryBarPartView,[2,0])),n&&(this.workbenchGrid.moveView(this.panelPartView,l,this.editorPartView,t===A.LEFT?E.Left:E.Right),this.workbenchGrid.resizeView(this.panelPartView,{height:d,width:l})),this.isVisible(s.SIDEBAR_PART)&&this.workbenchGrid.resizeView(this.sideBarPartView,{height:this.workbenchGrid.getViewSize(this.sideBarPartView).height,width:u}),this.isVisible(s.AUXILIARYBAR_PART)&&this.workbenchGrid.resizeView(this.auxiliaryBarPartView,{height:this.workbenchGrid.getViewSize(this.auxiliaryBarPartView).height,width:h})}setPanelAlignment(e,i){f(this.getPanelPosition())||this.setPanelPosition(A.BOTTOM),e!=="center"&&this.isPanelMaximized()&&this.toggleMaximizedPanel(),this.stateModel.setRuntimeValue(a.PANEL_ALIGNMENT,e),this.adjustPartPositions(this.getSideBarPosition(),e,this.getPanelPosition()),this._onDidChangePanelAlignment.fire(e)}setPanelHidden(e,i){if(!this.workbenchGrid)return;const t=!this.isVisible(s.PANEL_PART);this.stateModel.setRuntimeValue(a.PANEL_HIDDEN,e);const n=this.isPanelMaximized(),o=this.panelOpensMaximized();e?this.mainContainer.classList.add("nopanel"):this.mainContainer.classList.remove("nopanel");let r=!1;if(e&&this.paneCompositeService.getActivePaneComposite(c.Panel))this.paneCompositeService.hideActivePaneComposite(c.Panel),r=!re;else if(!e&&!this.paneCompositeService.getActivePaneComposite(c.Panel)){let l=this.paneCompositeService.getLastActivePaneCompositeId(c.Panel);if((!l||!this.hasViews(l))&&(l=this.viewDescriptorService.getViewContainersByLocation(c.Panel).find(d=>this.hasViews(d.id))?.id),l){const d=!i;this.paneCompositeService.openPaneComposite(l,c.Panel,d)}}e&&n&&this.toggleMaximizedPanel(),t!==e&&(this.workbenchGrid.setViewVisible(this.panelPartView,!e),e?this.stateModel.setRuntimeValue(a.PANEL_WAS_LAST_MAXIMIZED,n):!i&&n!==o&&this.toggleMaximizedPanel(),r&&this.editorGroupService.mainPart.activeGroup.focus())}toggleMaximizedPanel(){const e=this.workbenchGrid.getViewSize(this.panelPartView),i=this.getPanelPosition(),t=this.isPanelMaximized();t?(this.setEditorHidden(!1),this.workbenchGrid.resizeView(this.panelPartView,{width:f(i)?e.width:this.stateModel.getRuntimeValue(a.PANEL_LAST_NON_MAXIMIZED_WIDTH),height:f(i)?this.stateModel.getRuntimeValue(a.PANEL_LAST_NON_MAXIMIZED_HEIGHT):e.height})):(this.isVisible(s.PANEL_PART)&&(f(i)?this.stateModel.setRuntimeValue(a.PANEL_LAST_NON_MAXIMIZED_HEIGHT,e.height):this.stateModel.setRuntimeValue(a.PANEL_LAST_NON_MAXIMIZED_WIDTH,e.width)),this.setEditorHidden(!0)),this.stateModel.setRuntimeValue(a.PANEL_WAS_LAST_MAXIMIZED,!t)}panelOpensMaximized(){if(this.getPanelAlignment()!=="center"&&f(this.getPanelPosition()))return!1;const e=li(this.configurationService.getValue("workbench.panel.opensMaximized")),i=this.stateModel.getRuntimeValue(a.PANEL_WAS_LAST_MAXIMIZED);return e===de.ALWAYS||e===de.REMEMBER_LAST&&i}setAuxiliaryBarHidden(e,i){if(this.stateModel.setRuntimeValue(a.AUXILIARYBAR_HIDDEN,e),e?this.mainContainer.classList.add("noauxiliarybar"):this.mainContainer.classList.remove("noauxiliarybar"),e&&this.paneCompositeService.getActivePaneComposite(c.AuxiliaryBar))this.paneCompositeService.hideActivePaneComposite(c.AuxiliaryBar),this.focusPanelOrEditor();else if(!e&&!this.paneCompositeService.getActivePaneComposite(c.AuxiliaryBar)){let t=this.paneCompositeService.getLastActivePaneCompositeId(c.AuxiliaryBar);if((!t||!this.hasViews(t))&&(t=this.viewDescriptorService.getViewContainersByLocation(c.AuxiliaryBar).find(n=>this.hasViews(n.id))?.id),t){const n=!i;this.paneCompositeService.openPaneComposite(t,c.AuxiliaryBar,n)}}this.workbenchGrid.setViewVisible(this.auxiliaryBarPartView,!e)}setPartHidden(e,i,t=g){switch(i){case s.ACTIVITYBAR_PART:return this.setActivityBarHidden(e);case s.SIDEBAR_PART:return this.setSideBarHidden(e);case s.EDITOR_PART:return this.setEditorHidden(e);case s.BANNER_PART:return this.setBannerHidden(e);case s.AUXILIARYBAR_PART:return this.setAuxiliaryBarHidden(e);case s.PANEL_PART:return this.setPanelHidden(e)}}hasMainWindowBorder(){return this.state.runtime.mainWindowBorder}getMainWindowBorderRadius(){return this.state.runtime.mainWindowBorder&&be?"5px":void 0}isPanelMaximized(){return(this.getPanelAlignment()==="center"||!f(this.getPanelPosition()))&&!this.isVisible(s.EDITOR_PART,g)}getSideBarPosition(){return this.stateModel.getRuntimeValue(a.SIDEBAR_POSITON)}getPanelAlignment(){return this.stateModel.getRuntimeValue(a.PANEL_ALIGNMENT)}updateMenubarVisibility(e){const i=V(this.configurationService,g,this.state.runtime.menuBar.toggled,this.isZenModeActive());!e&&this.workbenchGrid&&i!==this.isVisible(s.TITLEBAR_PART,g)&&this.workbenchGrid.setViewVisible(this.titleBarPartView,i)}updateCustomTitleBarVisibility(){const e=V(this.configurationService,g,this.state.runtime.menuBar.toggled,this.isZenModeActive()),i=this.isVisible(s.TITLEBAR_PART);e!==i&&this.workbenchGrid.setViewVisible(this.titleBarPartView,e)}toggleMenuBar(){let e=oe(this.configurationService);typeof e!="string"&&(e="classic");let i;e==="visible"||e==="classic"?i=X(this.configurationService)?"toggle":"compact":i="classic",this.configurationService.updateValue("window.menuBarVisibility",i)}getPanelPosition(){return this.stateModel.getRuntimeValue(a.PANEL_POSITION)}setPanelPosition(e){this.isVisible(s.PANEL_PART)||this.setPanelHidden(!1);const i=this.getPart(s.PANEL_PART),t=M(this.getPanelPosition()),n=M(e),o=z(i.getContainer());o.classList.remove(t),o.classList.add(n),i.updateStyles();const r=this.workbenchGrid.getViewSize(this.panelPartView),l=this.workbenchGrid.getViewSize(this.sideBarPartView),d=this.workbenchGrid.getViewSize(this.auxiliaryBarPartView);let u=!this.isVisible(s.EDITOR_PART,g);n!==t&&!u&&(f(e)?this.stateModel.setRuntimeValue(a.PANEL_LAST_NON_MAXIMIZED_WIDTH,r.width):f(G(t))&&this.stateModel.setRuntimeValue(a.PANEL_LAST_NON_MAXIMIZED_HEIGHT,r.height)),f(e)&&this.getPanelAlignment()!=="center"&&u&&(this.toggleMaximizedPanel(),u=!1),this.stateModel.setRuntimeValue(a.PANEL_POSITION,e);const h=this.isVisible(s.SIDEBAR_PART),S=this.isVisible(s.AUXILIARYBAR_PART);e===A.BOTTOM?this.workbenchGrid.moveView(this.panelPartView,u?r.height:this.stateModel.getRuntimeValue(a.PANEL_LAST_NON_MAXIMIZED_HEIGHT),this.editorPartView,E.Down):e===A.TOP?this.workbenchGrid.moveView(this.panelPartView,u?r.height:this.stateModel.getRuntimeValue(a.PANEL_LAST_NON_MAXIMIZED_HEIGHT),this.editorPartView,E.Up):e===A.RIGHT?this.workbenchGrid.moveView(this.panelPartView,u?r.width:this.stateModel.getRuntimeValue(a.PANEL_LAST_NON_MAXIMIZED_WIDTH),this.editorPartView,E.Right):this.workbenchGrid.moveView(this.panelPartView,u?r.width:this.stateModel.getRuntimeValue(a.PANEL_LAST_NON_MAXIMIZED_WIDTH),this.editorPartView,E.Left),this.workbenchGrid.resizeView(this.sideBarPartView,l),h||this.setSideBarHidden(!0),this.workbenchGrid.resizeView(this.auxiliaryBarPartView,d),S||this.setAuxiliaryBarHidden(!0),f(e)&&this.adjustPartPositions(this.getSideBarPosition(),this.getPanelAlignment(),e),this._onDidChangePanelPosition.fire(n)}isWindowMaximized(e){return this.state.runtime.maximized.has(Y(e))}updateWindowMaximizedState(e,i){this.mainContainer.classList.toggle("maximized",i);const t=Y(e);i!==this.state.runtime.maximized.has(t)&&(i?this.state.runtime.maximized.add(t):this.state.runtime.maximized.delete(t),this.updateWindowsBorder(),this._onDidChangeWindowMaximized.fire({windowId:t,maximized:i}))}getVisibleNeighborPart(e,i){if(!this.workbenchGrid||!this.isVisible(e,g))return;const t=this.workbenchGrid.getNeighborViews(this.getPart(e),i,!1);if(t)for(const n of t){const o=[s.ACTIVITYBAR_PART,s.EDITOR_PART,s.PANEL_PART,s.AUXILIARYBAR_PART,s.SIDEBAR_PART,s.STATUSBAR_PART,s.TITLEBAR_PART].find(r=>this.getPart(r)===n&&this.isVisible(r,g));if(o!==void 0)return o}}onDidChangeWCO(){const e=this.workbenchGrid.getNeighborViews(this.titleBarPartView,E.Up,!1).length>0,i=this.shouldShowBannerFirst();e!==i&&this.workbenchGrid.moveView(this.bannerPartView,C.Distribute,this.titleBarPartView,i?E.Up:E.Down),this.workbenchGrid.setViewVisible(this.titleBarPartView,V(this.configurationService,g,this.state.runtime.menuBar.toggled,this.isZenModeActive()))}arrangeEditorNodes(e,i,t){if(!e.sideBar&&!e.auxiliaryBar)return e.editor.size=i,e.editor;const n=[e.editor];return e.editor.size=t,e.sideBar&&(this.stateModel.getRuntimeValue(a.SIDEBAR_POSITON)===A.LEFT?n.splice(0,0,e.sideBar):n.push(e.sideBar),e.editor.size-=this.stateModel.getRuntimeValue(a.SIDEBAR_HIDDEN)?0:e.sideBar.size),e.auxiliaryBar&&(this.stateModel.getRuntimeValue(a.SIDEBAR_POSITON)===A.RIGHT?n.splice(0,0,e.auxiliaryBar):n.push(e.auxiliaryBar),e.editor.size-=this.stateModel.getRuntimeValue(a.AUXILIARYBAR_HIDDEN)?0:e.auxiliaryBar.size),{type:"branch",data:n,size:i}}arrangeMiddleSectionNodes(e,i,t){const n=this.stateModel.getRuntimeValue(a.ACTIVITYBAR_HIDDEN)?0:e.activityBar.size,o=this.stateModel.getRuntimeValue(a.SIDEBAR_HIDDEN)?0:e.sideBar.size,r=this.stateModel.getRuntimeValue(a.AUXILIARYBAR_HIDDEN)?0:e.auxiliaryBar.size,l=this.stateModel.getInitializationValue(a.PANEL_SIZE)?0:e.panel.size,d=this.stateModel.getRuntimeValue(a.PANEL_POSITION),u=this.stateModel.getRuntimeValue(a.SIDEBAR_POSITON),h=[];if(!f(d))h.push(e.editor),e.editor.size=i-n-o-l-r,d===A.RIGHT?h.push(e.panel):h.splice(0,0,e.panel),u===A.LEFT?(h.push(e.auxiliaryBar),h.splice(0,0,e.sideBar),h.splice(0,0,e.activityBar)):(h.splice(0,0,e.auxiliaryBar),h.push(e.sideBar),h.push(e.activityBar));else{const S=this.stateModel.getRuntimeValue(a.PANEL_ALIGNMENT),m=!(S==="center"||u===A.LEFT&&S==="right"||u===A.RIGHT&&S==="left"),P=!(S==="center"||u===A.RIGHT&&S==="right"||u===A.LEFT&&S==="left"),D=i-n-(m?0:o)-(P?0:r),_=this.arrangeEditorNodes({editor:e.editor,sideBar:m?e.sideBar:void 0,auxiliaryBar:P?e.auxiliaryBar:void 0},t-l,D);h.push({type:"branch",data:d===A.BOTTOM?[_,e.panel]:[e.panel,_],size:D}),m||(u===A.LEFT?h.splice(0,0,e.sideBar):h.push(e.sideBar)),P||(u===A.RIGHT?h.splice(0,0,e.auxiliaryBar):h.push(e.auxiliaryBar)),u===A.LEFT?h.splice(0,0,e.activityBar):h.push(e.activityBar)}return h}createGridDescriptor(){const{width:e,height:i}=this.stateModel.getInitializationValue(a.GRID_SIZE),t=this.stateModel.getInitializationValue(a.SIDEBAR_SIZE),n=this.stateModel.getInitializationValue(a.AUXILIARYBAR_SIZE),o=this.stateModel.getInitializationValue(a.PANEL_SIZE),r=this.titleBarPartView.minimumHeight,l=this.bannerPartView.minimumHeight,d=this.statusBarPartView.minimumHeight,u=this.activityBarPartView.minimumWidth,h=i-r-d,S=[{type:"leaf",data:{type:s.TITLEBAR_PART},size:r,visible:this.isVisible(s.TITLEBAR_PART,g)},{type:"leaf",data:{type:s.BANNER_PART},size:l,visible:!1}],m={type:"leaf",data:{type:s.ACTIVITYBAR_PART},size:u,visible:!this.stateModel.getRuntimeValue(a.ACTIVITYBAR_HIDDEN)},P={type:"leaf",data:{type:s.SIDEBAR_PART},size:t,visible:!this.stateModel.getRuntimeValue(a.SIDEBAR_HIDDEN)},D={type:"leaf",data:{type:s.AUXILIARYBAR_PART},size:n,visible:this.isVisible(s.AUXILIARYBAR_PART)},_={type:"leaf",data:{type:s.EDITOR_PART},size:0,visible:!this.stateModel.getRuntimeValue(a.EDITOR_HIDDEN)},ce={type:"leaf",data:{type:s.PANEL_PART},size:o,visible:!this.stateModel.getRuntimeValue(a.PANEL_HIDDEN)},Se=this.arrangeMiddleSectionNodes({activityBar:m,auxiliaryBar:D,editor:_,panel:ce,sideBar:P},e,h),Ie={root:{type:"branch",size:e,data:[...this.shouldShowBannerFirst()?S.reverse():S,{type:"branch",data:Se,size:h},{type:"leaf",data:{type:s.STATUSBAR_PART},size:d,visible:!this.stateModel.getRuntimeValue(a.STATUSBAR_HIDDEN)}]},orientation:ye.VERTICAL,width:e,height:i},ge={activityBarVisible:!this.stateModel.getRuntimeValue(a.ACTIVITYBAR_HIDDEN),sideBarVisible:!this.stateModel.getRuntimeValue(a.SIDEBAR_HIDDEN),auxiliaryBarVisible:!this.stateModel.getRuntimeValue(a.AUXILIARYBAR_HIDDEN),panelVisible:!this.stateModel.getRuntimeValue(a.PANEL_HIDDEN),statusbarVisible:!this.stateModel.getRuntimeValue(a.STATUSBAR_HIDDEN),sideBarPosition:M(this.stateModel.getRuntimeValue(a.SIDEBAR_POSITON)),panelPosition:M(this.stateModel.getRuntimeValue(a.PANEL_POSITION))};return this.telemetryService.publicLog2("startupLayout",ge),Ie}dispose(){super.dispose(),this.disposed=!0}}function he(b){return b.getValue("zenMode")}class ue{constructor(F,e,i,t){this.name=F;this.scope=e;this.target=i;this.defaultValue=t}}class v extends ue{constructor(e,i,t,n,o){super(e,i,t,n);this.zenModeIgnore=o}runtime=!0}class k extends ue{runtime=!1}const a={MAIN_EDITOR_CENTERED:new v("editor.centered",I.WORKSPACE,p.MACHINE,!1),ZEN_MODE_ACTIVE:new v("zenMode.active",I.WORKSPACE,p.MACHINE,!1),ZEN_MODE_EXIT_INFO:new v("zenMode.exitInfo",I.WORKSPACE,p.MACHINE,{transitionedToCenteredEditorLayout:!1,transitionedToFullScreen:!1,handleNotificationsDoNotDisturbMode:!1,wasVisible:{auxiliaryBar:!1,panel:!1,sideBar:!1}}),GRID_SIZE:new k("grid.size",I.PROFILE,p.MACHINE,{width:800,height:600}),SIDEBAR_SIZE:new k("sideBar.size",I.PROFILE,p.MACHINE,200),AUXILIARYBAR_SIZE:new k("auxiliaryBar.size",I.PROFILE,p.MACHINE,200),PANEL_SIZE:new k("panel.size",I.PROFILE,p.MACHINE,300),PANEL_LAST_NON_MAXIMIZED_HEIGHT:new v("panel.lastNonMaximizedHeight",I.PROFILE,p.MACHINE,300),PANEL_LAST_NON_MAXIMIZED_WIDTH:new v("panel.lastNonMaximizedWidth",I.PROFILE,p.MACHINE,300),PANEL_WAS_LAST_MAXIMIZED:new v("panel.wasLastMaximized",I.WORKSPACE,p.MACHINE,!1),SIDEBAR_POSITON:new v("sideBar.position",I.WORKSPACE,p.MACHINE,A.LEFT),PANEL_POSITION:new v("panel.position",I.WORKSPACE,p.MACHINE,A.BOTTOM),PANEL_ALIGNMENT:new v("panel.alignment",I.PROFILE,p.USER,"center"),ACTIVITYBAR_HIDDEN:new v("activityBar.hidden",I.WORKSPACE,p.MACHINE,!1,!0),SIDEBAR_HIDDEN:new v("sideBar.hidden",I.WORKSPACE,p.MACHINE,!1),EDITOR_HIDDEN:new v("editor.hidden",I.WORKSPACE,p.MACHINE,!1),PANEL_HIDDEN:new v("panel.hidden",I.WORKSPACE,p.MACHINE,!0),AUXILIARYBAR_HIDDEN:new v("auxiliaryBar.hidden",I.WORKSPACE,p.MACHINE,!0),STATUSBAR_HIDDEN:new v("statusBar.hidden",I.WORKSPACE,p.MACHINE,!1,!0)};var mi=(t=>(t.PANEL_POSITION="workbench.panel.defaultLocation",t.PANEL_OPENS_MAXIMIZED="workbench.panel.opensMaximized",t.ZEN_MODE_CONFIG="zenMode",t.EDITOR_CENTERED_LAYOUT_AUTO_RESIZE="workbench.editor.centeredLayoutAutoResize",t))(mi||{}),pi=(e=>(e.STATUSBAR_VISIBLE="workbench.statusBar.visible",e.SIDEBAR_POSITION="workbench.sideBar.location",e))(pi||{});class O extends ie{constructor(e,i,t,n){super();this.storageService=e;this.configurationService=i;this.contextService=t;this.container=n;this._register(this.configurationService.onDidChangeConfiguration(o=>this.updateStateFromLegacySettings(o)))}static STORAGE_PREFIX="workbench.";_onDidChangeState=this._register(new w);onDidChangeState=this._onDidChangeState.event;stateCache=new Map;updateStateFromLegacySettings(e){e.affectsConfiguration(y.ACTIVITY_BAR_LOCATION)&&this.setRuntimeValueAndFire(a.ACTIVITYBAR_HIDDEN,this.isActivityBarHidden()),e.affectsConfiguration("workbench.statusBar.visible")&&this.setRuntimeValueAndFire(a.STATUSBAR_HIDDEN,!this.configurationService.getValue("workbench.statusBar.visible")),e.affectsConfiguration("workbench.sideBar.location")&&this.setRuntimeValueAndFire(a.SIDEBAR_POSITON,G(this.configurationService.getValue("workbench.sideBar.location")??"left"))}updateLegacySettingsFromState(e,i){const t=this.getRuntimeValue(a.ZEN_MODE_ACTIVE);e.zenModeIgnore&&t||(e===a.ACTIVITYBAR_HIDDEN?this.configurationService.updateValue(y.ACTIVITY_BAR_LOCATION,i?x.HIDDEN:void 0):e===a.STATUSBAR_HIDDEN?this.configurationService.updateValue("workbench.statusBar.visible",!i):e===a.SIDEBAR_POSITON&&this.configurationService.updateValue("workbench.sideBar.location",M(i)))}load(){let e;for(e in a){const t=a[e],n=this.loadKeyFromStorage(t);n!==void 0&&this.stateCache.set(t.name,n)}this.stateCache.set(a.ACTIVITYBAR_HIDDEN.name,this.isActivityBarHidden()),this.stateCache.set(a.STATUSBAR_HIDDEN.name,!this.configurationService.getValue("workbench.statusBar.visible")),this.stateCache.set(a.SIDEBAR_POSITON.name,G(this.configurationService.getValue("workbench.sideBar.location")??"left"));const i=Z(this.container);a.PANEL_POSITION.defaultValue=G(this.configurationService.getValue("workbench.panel.defaultLocation")??"bottom"),a.GRID_SIZE.defaultValue={height:i.height,width:i.width},a.SIDEBAR_SIZE.defaultValue=Math.min(300,i.width/4),a.AUXILIARYBAR_SIZE.defaultValue=Math.min(300,i.width/4),a.PANEL_SIZE.defaultValue=this.stateCache.get(a.PANEL_POSITION.name)??f(a.PANEL_POSITION.defaultValue)?i.height/3:i.width/4,a.SIDEBAR_HIDDEN.defaultValue=this.contextService.getWorkbenchState()===le.EMPTY;for(e in a){const t=a[e];this.stateCache.get(t.name)===void 0&&this.stateCache.set(t.name,t.defaultValue)}this._register(this.storageService.onDidChangeValue(I.PROFILE,void 0,this._register(new te))(t=>{let n;for(n in a){const o=a[n];if(o instanceof v&&o.scope===I.PROFILE&&o.target===p.USER&&`${O.STORAGE_PREFIX}${o.name}`===t.key){const r=this.loadKeyFromStorage(o)??o.defaultValue;this.stateCache.get(o.name)!==r&&(this.stateCache.set(o.name,r),this._onDidChangeState.fire({key:o,value:r}))}}}))}save(e,i){let t;const n=this.getRuntimeValue(a.ZEN_MODE_ACTIVE);for(t in a){const o=a[t];if(e&&o.scope===I.WORKSPACE||i&&o.scope===I.PROFILE){if(n&&o instanceof v&&o.zenModeIgnore)continue;this.saveKeyToStorage(o)}}}getInitializationValue(e){return this.stateCache.get(e.name)}setInitializationValue(e,i){this.stateCache.set(e.name,i)}getRuntimeValue(e,i){if(i)switch(e){case a.ACTIVITYBAR_HIDDEN:this.stateCache.set(e.name,this.isActivityBarHidden());break;case a.STATUSBAR_HIDDEN:this.stateCache.set(e.name,!this.configurationService.getValue("workbench.statusBar.visible"));break;case a.SIDEBAR_POSITON:this.stateCache.set(e.name,this.configurationService.getValue("workbench.sideBar.location")??"left");break}return this.stateCache.get(e.name)}setRuntimeValue(e,i){this.stateCache.set(e.name,i);const t=this.getRuntimeValue(a.ZEN_MODE_ACTIVE);e.scope===I.PROFILE&&(!t||!e.zenModeIgnore)&&(this.saveKeyToStorage(e),this.updateLegacySettingsFromState(e,i))}isActivityBarHidden(){const e=this.configurationService.getValue("workbench.activityBar.visible");return e!==void 0?!e:this.configurationService.getValue(y.ACTIVITY_BAR_LOCATION)!==x.DEFAULT}setRuntimeValueAndFire(e,i){this.stateCache.get(e.name)!==i&&(this.setRuntimeValue(e,i),this._onDidChangeState.fire({key:e,value:i}))}saveKeyToStorage(e){const i=this.stateCache.get(e.name);this.storageService.store(`${O.STORAGE_PREFIX}${e.name}`,typeof i=="object"?JSON.stringify(i):i,e.scope,e.target)}loadKeyFromStorage(e){let i=this.storageService.get(`${O.STORAGE_PREFIX}${e.name}`,e.scope);if(i!==void 0)switch(typeof e.defaultValue){case"boolean":i=i==="true";break;case"number":i=parseInt(i);break;case"object":i=JSON.parse(i);break}return i}}export{Bt as Layout,Ai as TITLE_BAR_SETTINGS};
