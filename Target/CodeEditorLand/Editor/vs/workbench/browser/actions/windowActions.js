import{localize as t,localize2 as u}from"../../../nls.js";import"../../../platform/window/common/window.js";import{IDialogService as q}from"../../../platform/dialogs/common/dialogs.js";import{MenuRegistry as H,MenuId as k,Action2 as w,registerAction2 as f}from"../../../platform/actions/common/actions.js";import{KeyChord as ae,KeyCode as n,KeyMod as r}from"../../../base/common/keyCodes.js";import{IsMainWindowFullscreenContext as le}from"../../common/contextkeys.js";import{IsMacNativeContext as de,IsDevelopmentContext as pe,IsWebContext as me,IsIOSContext as ue}from"../../../platform/contextkey/common/contextkeys.js";import{Categories as C}from"../../../platform/action/common/actionCommonCategories.js";import{KeybindingsRegistry as _,KeybindingWeight as h}from"../../../platform/keybinding/common/keybindingsRegistry.js";import{IQuickInputService as ke}from"../../../platform/quickinput/common/quickInput.js";import{IWorkspaceContextService as fe}from"../../../platform/workspace/common/workspace.js";import{ILabelService as ye,Verbosity as V}from"../../../platform/label/common/label.js";import{IKeybindingService as ge}from"../../../platform/keybinding/common/keybinding.js";import{IModelService as we}from"../../../editor/common/services/model.js";import{ILanguageService as he}from"../../../editor/common/languages/language.js";import{isRecentFolder as M,isRecentWorkspace as z,IWorkspacesService as ve}from"../../../platform/workspaces/common/workspaces.js";import"../../../base/common/uri.js";import{getIconClasses as K}from"../../../editor/common/services/getIconClasses.js";import{FileKind as N}from"../../../platform/files/common/files.js";import{splitRecentLabel as be}from"../../../base/common/labels.js";import{isMacintosh as Ie,isWeb as G,isWindows as Ce}from"../../../base/common/platform.js";import{ContextKeyExpr as Q}from"../../../platform/contextkey/common/contextkey.js";import{inQuickPickContext as Re,getQuickNavigateHandler as j}from"../quickaccess.js";import{IHostService as S}from"../../services/host/browser/host.js";import{ResourceMap as F}from"../../../base/common/map.js";import{Codicon as J}from"../../../base/common/codicons.js";import{ThemeIcon as X}from"../../../base/common/themables.js";import{CommandsRegistry as We}from"../../../platform/commands/common/commands.js";import{IConfigurationService as Se}from"../../../platform/configuration/common/configuration.js";import"../../../platform/instantiation/common/instantiation.js";import{isFolderBackupInfo as Y,isWorkspaceBackupInfo as Fe}from"../../../platform/backup/common/backup.js";import{getActiveElement as Oe,getActiveWindow as Pe,isHTMLElement as Ae}from"../../../base/browser/dom.js";const Z="inRecentFilesPicker";class $ extends w{removeFromRecentlyOpened={iconClass:X.asClassName(J.removeClose),tooltip:t("remove","Remove from Recently Opened")};dirtyRecentlyOpenedFolder={iconClass:"dirty-workspace "+X.asClassName(J.closeDirty),tooltip:t("dirtyRecentlyOpenedFolder","Folder With Unsaved Files"),alwaysVisible:!0};dirtyRecentlyOpenedWorkspace={...this.dirtyRecentlyOpenedFolder,tooltip:t("dirtyRecentlyOpenedWorkspace","Workspace With Unsaved Files")};constructor(o){super(o)}async run(o){const c=o.get(ve),y=o.get(ke),s=o.get(fe),m=o.get(ye),g=o.get(ge),a=o.get(we),l=o.get(he),i=o.get(S),v=o.get(q),d=await c.getRecentlyOpened(),R=await c.getDirtyWorkspaces();let O=!1;const L=new F,U=new F;for(const e of R)Y(e)?L.set(e.folderUri,!0):(U.set(e.workspace.configPath,e.workspace),O=!0);const B=new F,T=new F;for(const e of d.workspaces)M(e)?B.set(e.folderUri,!0):(T.set(e.workspace.configPath,e.workspace),O=!0);const b=[];for(const e of d.workspaces){const I=M(e)?L.has(e.folderUri):U.has(e.workspace.configPath);b.push(this.toQuickPick(a,l,m,e,I))}for(const e of R)Y(e)&&!B.has(e.folderUri)?b.push(this.toQuickPick(a,l,m,e,!0)):Fe(e)&&!T.has(e.workspace.configPath)&&b.push(this.toQuickPick(a,l,m,e,!0));const E=d.files.map(e=>this.toQuickPick(a,l,m,e,!1)),W=d.workspaces[0],re=W&&s.isCurrentWorkspace(z(W)?W.workspace:W.folderUri);let P;const ie={type:"separator",label:O?t("workspacesAndFolders","folders & workspaces"):t("folders","folders")},ne={type:"separator",label:t("files","files")},ce=[ie,...b,ne,...E],A=await y.pick(ce,{contextKey:Z,activeItem:[...b,...E][re?1:0],placeHolder:Ie?t("openRecentPlaceholderMac","Select to open (hold Cmd-key to force new window or Option-key for same window)"):t("openRecentPlaceholder","Select to open (hold Ctrl-key to force new window or Alt-key for same window)"),matchOnDescription:!0,onKeyMods:e=>P=e,quickNavigate:this.isQuickNavigate()?{keybindings:g.lookupKeybindings(this.desc.id)}:void 0,hideInput:this.isQuickNavigate(),onDidTriggerItemButton:async e=>{if(e.button===this.removeFromRecentlyOpened)await c.removeRecentlyOpened([e.item.resource]),e.removeItem();else if(e.button===this.dirtyRecentlyOpenedFolder||e.button===this.dirtyRecentlyOpenedWorkspace){const I=e.button===this.dirtyRecentlyOpenedWorkspace,{confirmed:se}=await v.confirm({title:I?t("dirtyWorkspace","Workspace with Unsaved Files"):t("dirtyFolder","Folder with Unsaved Files"),message:I?t("dirtyWorkspaceConfirm","Do you want to open the workspace to review the unsaved files?"):t("dirtyFolderConfirm","Do you want to open the folder to review the unsaved files?"),detail:I?t("dirtyWorkspaceConfirmDetail","Workspaces with unsaved files cannot be removed until all unsaved files have been saved or reverted."):t("dirtyFolderConfirmDetail","Folders with unsaved files cannot be removed until all unsaved files have been saved or reverted.")});se&&(i.openWindow([e.item.openable],{remoteAuthority:e.item.remoteAuthority||null}),y.cancel())}}});if(A)return i.openWindow([A.openable],{forceNewWindow:P?.ctrlCmd,forceReuseWindow:P?.alt,remoteAuthority:A.remoteAuthority||null})}toQuickPick(o,c,y,s,m){let g,a,l,i,v=!1;M(s)?(i=s.folderUri,a=K(o,c,i,N.FOLDER),g={folderUri:i},l=s.label||y.getWorkspaceLabel(i,{verbose:V.LONG})):z(s)?(i=s.workspace.configPath,a=K(o,c,i,N.ROOT_FOLDER),g={workspaceUri:i},l=s.label||y.getWorkspaceLabel(s.workspace,{verbose:V.LONG}),v=!0):(i=s.fileUri,a=K(o,c,i,N.FILE),g={fileUri:i},l=s.label||y.getUriLabel(i));const{name:d,parentPath:R}=be(l);return{iconClasses:a,label:d,ariaLabel:m?v?t("recentDirtyWorkspaceAriaLabel","{0}, workspace with unsaved changes",d):t("recentDirtyFolderAriaLabel","{0}, folder with unsaved changes",d):d,description:R,buttons:m?[v?this.dirtyRecentlyOpenedWorkspace:this.dirtyRecentlyOpenedFolder]:[this.removeFromRecentlyOpened],openable:g,resource:i,remoteAuthority:s.remoteAuthority}}}class D extends ${static ID="workbench.action.openRecent";constructor(){super({id:D.ID,title:{...u("openRecent","Open Recent..."),mnemonicTitle:t({key:"miMore",comment:["&& denotes a mnemonic"]},"&&More...")},category:C.File,f1:!0,keybinding:{weight:h.WorkbenchContrib,primary:r.CtrlCmd|n.KeyR,mac:{primary:r.WinCtrl|n.KeyR}},menu:{id:k.MenubarRecentMenu,group:"y_more",order:1}})}isQuickNavigate(){return!1}}class Me extends ${constructor(){super({id:"workbench.action.quickOpenRecent",title:u("quickOpenRecent","Quick Open Recent..."),category:C.File,f1:!1})}isQuickNavigate(){return!0}}class Ke extends w{constructor(){super({id:"workbench.action.toggleFullScreen",title:{...u("toggleFullScreen","Toggle Full Screen"),mnemonicTitle:t({key:"miToggleFullScreen",comment:["&& denotes a mnemonic"]},"&&Full Screen")},category:C.View,f1:!0,keybinding:{weight:h.WorkbenchContrib,primary:n.F11,mac:{primary:r.CtrlCmd|r.WinCtrl|n.KeyF}},precondition:ue.toNegated(),toggled:le,menu:[{id:k.MenubarAppearanceMenu,group:"1_toggle_view",order:1}]})}run(o){return o.get(S).toggleFullScreen(Pe())}}class x extends w{static ID="workbench.action.reloadWindow";constructor(){super({id:x.ID,title:u("reloadWindow","Reload Window"),category:C.Developer,f1:!0,keybinding:{weight:h.WorkbenchContrib+50,when:pe,primary:r.CtrlCmd|n.KeyR}})}async run(o){return o.get(S).reload()}}class Ne extends w{constructor(){super({id:"workbench.action.showAboutDialog",title:{...u("about","About"),mnemonicTitle:t({key:"miAbout",comment:["&& denotes a mnemonic"]},"&&About")},category:C.Help,f1:!0,menu:{id:k.MenubarHelpMenu,group:"z_about",order:1,when:de.toNegated()}})}run(o){return o.get(q).about()}}class Qe extends w{constructor(){super({id:"workbench.action.newWindow",title:{...u("newWindow","New Window"),mnemonicTitle:t({key:"miNewWindow",comment:["&& denotes a mnemonic"]},"New &&Window")},f1:!0,keybinding:{weight:h.WorkbenchContrib,primary:G?Ce?ae(r.CtrlCmd|n.KeyK,r.Shift|n.KeyN):r.CtrlCmd|r.Alt|r.Shift|n.KeyN:r.CtrlCmd|r.Shift|n.KeyN,secondary:G?[r.CtrlCmd|r.Shift|n.KeyN]:void 0},menu:{id:k.MenubarFileMenu,group:"1_new",order:3}})}run(o){return o.get(S).openWindow({remoteAuthority:null})}}class De extends w{constructor(){super({id:"workbench.action.blur",title:u("blur","Remove keyboard focus from focused element")})}run(){const o=Oe();Ae(o)&&o.blur()}}f(Qe),f(Ke),f(Me),f(D),f(x),f(Ne),f(De);const ee=Q.and(Re,Q.has(Z)),oe="workbench.action.quickOpenNavigateNextInRecentFilesPicker";_.registerCommandAndKeybindingRule({id:oe,weight:h.WorkbenchContrib+50,handler:j(oe,!0),when:ee,primary:r.CtrlCmd|n.KeyR,mac:{primary:r.WinCtrl|n.KeyR}});const te="workbench.action.quickOpenNavigatePreviousInRecentFilesPicker";_.registerCommandAndKeybindingRule({id:te,weight:h.WorkbenchContrib+50,handler:j(te,!1),when:ee,primary:r.CtrlCmd|r.Shift|n.KeyR,mac:{primary:r.WinCtrl|r.Shift|n.KeyR}}),We.registerCommand("workbench.action.toggleConfirmBeforeClose",p=>{const o=p.get(Se),c=o.inspect("window.confirmBeforeClose").userValue;return o.updateValue("window.confirmBeforeClose",c==="never"?"keyboardOnly":"never")}),H.appendMenuItem(k.MenubarFileMenu,{group:"z_ConfirmClose",command:{id:"workbench.action.toggleConfirmBeforeClose",title:t("miConfirmClose","Confirm Before Close"),toggled:Q.notEquals("config.window.confirmBeforeClose","never")},order:1,when:me}),H.appendMenuItem(k.MenubarFileMenu,{title:t({key:"miOpenRecent",comment:["&& denotes a mnemonic"]},"Open &&Recent"),submenu:k.MenubarRecentMenu,group:"2_open",order:4});export{D as OpenRecentAction,x as ReloadWindowAction,Z as inRecentFilesPickerContextKey};
