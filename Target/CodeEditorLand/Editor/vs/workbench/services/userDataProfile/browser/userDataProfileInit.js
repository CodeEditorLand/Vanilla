var p=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var m=(n,e,i,t)=>{for(var r=t>1?void 0:t?v(e,i):e,a=n.length-1,l;a>=0;a--)(l=n[a])&&(r=(t?l(e,i,r):l(r))||r);return t&&r&&p(e,i,r),r},s=(n,e)=>(i,t)=>e(i,t,n);import{Barrier as f,Promises as h}from"../../../../../vs/base/common/async.js";import{CancellationToken as S}from"../../../../../vs/base/common/cancellation.js";import{isString as I}from"../../../../../vs/base/common/types.js";import{URI as u}from"../../../../../vs/base/common/uri.js";import{IFileService as d}from"../../../../../vs/platform/files/common/files.js";import"../../../../../vs/platform/instantiation/common/instantiation.js";import{ILogService as P}from"../../../../../vs/platform/log/common/log.js";import{asJson as z,IRequestService as g}from"../../../../../vs/platform/request/common/request.js";import{IStorageService as y,StorageScope as T}from"../../../../../vs/platform/storage/common/storage.js";import{IUriIdentityService as w}from"../../../../../vs/platform/uriIdentity/common/uriIdentity.js";import{ProfileResourceType as o}from"../../../../../vs/platform/userDataProfile/common/userDataProfile.js";import{IBrowserWorkbenchEnvironmentService as D}from"../../../../../vs/workbench/services/environment/browser/environmentService.js";import"../../../../../vs/workbench/services/userData/browser/userDataInit.js";import{ExtensionsResourceInitializer as R}from"../../../../../vs/workbench/services/userDataProfile/browser/extensionsResource.js";import{GlobalStateResourceInitializer as U}from"../../../../../vs/workbench/services/userDataProfile/browser/globalStateResource.js";import{KeybindingsResourceInitializer as E}from"../../../../../vs/workbench/services/userDataProfile/browser/keybindingsResource.js";import{SettingsResourceInitializer as x}from"../../../../../vs/workbench/services/userDataProfile/browser/settingsResource.js";import{SnippetsResourceInitializer as b}from"../../../../../vs/workbench/services/userDataProfile/browser/snippetsResource.js";import{TasksResourceInitializer as k}from"../../../../../vs/workbench/services/userDataProfile/browser/tasksResource.js";import{IUserDataProfileService as q}from"../../../../../vs/workbench/services/userDataProfile/common/userDataProfile.js";let c=class{constructor(e,i,t,r,a,l,F){this.environmentService=e;this.fileService=i;this.userDataProfileService=t;this.storageService=r;this.logService=a;this.uriIdentityService=l;this.requestService=F}_serviceBrand;initialized=[];initializationFinished=new f;async whenInitializationFinished(){await this.initializationFinished.wait()}async requiresInitialization(){return!(!this.environmentService.options?.profile?.contents||!this.storageService.isNew(T.PROFILE))}async initializeRequiredResources(){this.logService.trace("UserDataProfileInitializer#initializeRequiredResources");const e=[],i=await this.getProfileTemplate();i?.settings&&e.push(this.initialize(new x(this.userDataProfileService,this.fileService,this.logService),i.settings,o.Settings)),i?.globalState&&e.push(this.initialize(new U(this.storageService),i.globalState,o.GlobalState)),await Promise.all(e)}async initializeOtherResources(e){try{this.logService.trace("UserDataProfileInitializer#initializeOtherResources");const i=[],t=await this.getProfileTemplate();t?.keybindings&&i.push(this.initialize(new E(this.userDataProfileService,this.fileService,this.logService),t.keybindings,o.Keybindings)),t?.tasks&&i.push(this.initialize(new k(this.userDataProfileService,this.fileService,this.logService),t.tasks,o.Tasks)),t?.snippets&&i.push(this.initialize(new b(this.userDataProfileService,this.fileService,this.uriIdentityService),t.snippets,o.Snippets)),i.push(this.initializeInstalledExtensions(e)),await h.settled(i)}finally{this.initializationFinished.open()}}initializeInstalledExtensionsPromise;async initializeInstalledExtensions(e){if(!this.initializeInstalledExtensionsPromise){const i=await this.getProfileTemplate();i?.extensions?this.initializeInstalledExtensionsPromise=this.initialize(e.createInstance(R),i.extensions,o.Extensions):this.initializeInstalledExtensionsPromise=Promise.resolve()}return this.initializeInstalledExtensionsPromise}profileTemplatePromise;getProfileTemplate(){return this.profileTemplatePromise||(this.profileTemplatePromise=this.doGetProfileTemplate()),this.profileTemplatePromise}async doGetProfileTemplate(){if(!this.environmentService.options?.profile?.contents)return null;if(I(this.environmentService.options.profile.contents))try{return JSON.parse(this.environmentService.options.profile.contents)}catch(e){return this.logService.error(e),null}try{const e=u.revive(this.environmentService.options.profile.contents).toString(!0),i=await this.requestService.request({type:"GET",url:e},S.None);if(i.res.statusCode===200)return await z(i);this.logService.warn(`UserDataProfileInitializer: Failed to get profile from URL: ${e}. Status code: ${i.res.statusCode}.`)}catch(e){this.logService.error(e)}return null}async initialize(e,i,t){try{if(this.initialized.includes(t)){this.logService.info(`UserDataProfileInitializer: ${t} initialized already.`);return}this.initialized.push(t),this.logService.trace(`UserDataProfileInitializer: Initializing ${t}`),await e.initialize(i),this.logService.info(`UserDataProfileInitializer: Initialized ${t}`)}catch(r){this.logService.info(`UserDataProfileInitializer: Error while initializing ${t}`),this.logService.error(r)}}};c=m([s(0,D),s(1,d),s(2,q),s(3,y),s(4,P),s(5,w),s(6,g)],c);export{c as UserDataProfileInitializer};
