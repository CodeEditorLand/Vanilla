var U=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var D=(m,i,e,t)=>{for(var n=t>1?void 0:t?z(i,e):i,s=m.length-1,r;s>=0;s--)(r=m[s])&&(n=(t?r(i,e,n):r(n))||n);return t&&n&&U(i,e,n),n},C=(m,i)=>(e,t)=>i(e,t,m);import{localize as h}from"../../../../nls.js";import{distinct as R,coalesce as G}from"../../../../base/common/arrays.js";import*as c from"../../../../base/common/strings.js";import{Language as X}from"../../../../base/common/platform.js";import{or as x,matchesContiguousSubString as w,matchesPrefix as k,matchesCamelCase as B,matchesWords as g}from"../../../../base/common/filters.js";import"../../../../base/common/keybindings.js";import{AriaLabelProvider as F,UserSettingsLabelProvider as Y,UILabelProvider as $}from"../../../../base/common/keybindingLabels.js";import{MenuRegistry as j}from"../../../../platform/actions/common/actions.js";import{EditorModel as H}from"../../../common/editor/editorModel.js";import{IKeybindingService as Q}from"../../../../platform/keybinding/common/keybinding.js";import{ResolvedKeybindingItem as q}from"../../../../platform/keybinding/common/resolvedKeybindingItem.js";import{getAllUnboundCommands as J}from"../../keybinding/browser/unboundCommands.js";import"../common/preferences.js";import"../../../../platform/action/common/action.js";import{isEmptyObject as Z,isString as p}from"../../../../base/common/types.js";import{IExtensionService as V}from"../../extensions/common/extensions.js";import{ExtensionIdentifier as ee,ExtensionIdentifierMap as te}from"../../../../platform/extensions/common/extensions.js";import{ContextKeyExpr as ie}from"../../../../platform/contextkey/common/contextkey.js";const S="keybinding.entry.template",W=h("default","System"),N=h("extension","Extension"),_=h("user","User");function Te(m,i){const e=i?` +when:${i}`:"";return`@command:${m}${e}`}const ne=x(k,g,w),re=/@command:\s*([^\+]+)/i,se=/\+when:\s*(.+)/i,O=/@source:\s*(user|default|system|extension)/i,T=/@ext:\s*((".+")|([^\s]+))/i,ae=/@keybinding:\s*((\".+\")|(\S+))/i;let f=class extends H{constructor(e,t,n){super();this.keybindingsService=t;this.extensionService=n;this._keybindingItems=[],this._keybindingItemsSortedByPrecedence=[],this.modifierLabels={ui:$.modifierLabels[e],aria:F.modifierLabels[e],user:Y.modifierLabels[e]}}_keybindingItems;_keybindingItemsSortedByPrecedence;modifierLabels;fetch(e,t=!1){let n=t?this._keybindingItemsSortedByPrecedence:this._keybindingItems;const s=re.exec(e);if(s&&s[1]){const r=s[1].trim();let a=n.filter(l=>l.command===r);if(a.length){const l=se.exec(e);if(l&&l[1]){const d=l[1].trim();a=this.filterByWhen(a,r,d)}}return a.map(l=>({id:f.getId(l),keybindingItem:l,templateId:S}))}if(O.test(e))n=this.filterBySource(n,e),e=e.replace(O,"");else{const r=T.exec(e);if(r&&(r[2]||r[3])){const a=r[2]?r[2].substring(1,r[2].length-1):r[3];n=this.filterByExtension(n,a),e=e.replace(T,"")}else{const a=ae.exec(e);a&&(a[2]||a[3])&&(e=a[2]||`"${a[3]}"`)}}return e=e.trim(),e?this.filterByText(n,e):n.map(r=>({id:f.getId(r),keybindingItem:r,templateId:S}))}filterBySource(e,t){return/@source:\s*default/i.test(t)||/@source:\s*system/i.test(t)?e.filter(n=>n.source===W):/@source:\s*user/i.test(t)?e.filter(n=>n.source===_):/@source:\s*extension/i.test(t)?e.filter(n=>!p(n.source)||n.source===N):e}filterByExtension(e,t){return t=t.toLowerCase().trim(),e.filter(n=>!p(n.source)&&(ee.equals(n.source.identifier,t)||n.source.displayName?.toLowerCase()===t.toLowerCase()))}filterByText(e,t){const n=t.charAt(0)==='"',s=t.charAt(t.length-1)==='"',r=n&&s;n&&(t=t.substring(1)),s&&(t=t.substring(0,t.length-1)),t=t.trim();const a=[],l=t.split(" "),d=this.splitKeybindingWords(l);for(const u of e){const o=new oe(this.modifierLabels,u,t,l,d,r);(o.commandIdMatches||o.commandLabelMatches||o.commandDefaultLabelMatches||o.sourceMatches||o.whenMatches||o.keybindingMatches||o.extensionIdMatches||o.extensionLabelMatches)&&a.push({id:f.getId(u),templateId:S,commandLabelMatches:o.commandLabelMatches||void 0,commandDefaultLabelMatches:o.commandDefaultLabelMatches||void 0,keybindingItem:u,keybindingMatches:o.keybindingMatches||void 0,commandIdMatches:o.commandIdMatches||void 0,sourceMatches:o.sourceMatches||void 0,whenMatches:o.whenMatches||void 0,extensionIdMatches:o.extensionIdMatches||void 0,extensionLabelMatches:o.extensionLabelMatches||void 0})}return a}filterByWhen(e,t,n){if(e.length===0)return[];const s=e.filter(d=>d.when===n);if(s.length)return s;const r=e[0].commandLabel,a=new q(void 0,t,null,ie.deserialize(n),!1,null,!1),l=new Map([[t,r]]);return[f.toKeybindingEntry(t,a,l,this.getExtensionsMapping())]}splitKeybindingWords(e){const t=[];for(const n of e)t.push(...G(n.split("+")));return t}async resolve(e=new Map){const t=this.getExtensionsMapping();this._keybindingItemsSortedByPrecedence=[];const n=new Map;for(const r of this.keybindingsService.getKeybindings())r.command&&(this._keybindingItemsSortedByPrecedence.push(f.toKeybindingEntry(r.command,r,e,t)),n.set(r.command,!0));const s=this.keybindingsService.getDefaultKeybindings().map(r=>r.command);for(const r of J(n)){const a=new q(void 0,r,null,void 0,s.indexOf(r)===-1,null,!1);this._keybindingItemsSortedByPrecedence.push(f.toKeybindingEntry(r,a,e,t))}return this._keybindingItemsSortedByPrecedence=R(this._keybindingItemsSortedByPrecedence,r=>f.getId(r)),this._keybindingItems=this._keybindingItemsSortedByPrecedence.slice(0).sort((r,a)=>f.compareKeybindingData(r,a)),super.resolve()}static getId(e){return e.command+(e?.keybinding?.getAriaLabel()??"")+e.when+(p(e.source)?e.source:e.source.identifier.value)}getExtensionsMapping(){const e=new te;for(const t of this.extensionService.extensions)e.set(t.identifier,t);return e}static compareKeybindingData(e,t){return e.keybinding&&!t.keybinding?-1:t.keybinding&&!e.keybinding?1:e.commandLabel&&!t.commandLabel?-1:t.commandLabel&&!e.commandLabel?1:e.commandLabel&&t.commandLabel&&e.commandLabel!==t.commandLabel?e.commandLabel.localeCompare(t.commandLabel):e.command===t.command?e.keybindingItem.isDefault?1:-1:e.command.localeCompare(t.command)}static toKeybindingEntry(e,t,n,s){const r=j.getCommand(e),a=n.get(e);let l=_;if(t.isDefault){const d=t.extensionId??(t.resolvedKeybinding?void 0:r?.source?.id);l=d?s.get(d)??N:W}return{keybinding:t.resolvedKeybinding,keybindingItem:t,command:e,commandLabel:f.getCommandLabel(r,a),commandDefaultLabel:f.getCommandDefaultLabel(r),when:t.when?t.when.serialize():"",source:l}}static getCommandDefaultLabel(e){if(!X.isDefaultVariant()&&e&&e.title&&e.title.original){const t=e.category?e.category.original:void 0,n=e.title.original;return t?h("cat.title","{0}: {1}",t,n):n}return null}static getCommandLabel(e,t){if(e){const n=e.category?typeof e.category=="string"?e.category:e.category.value:void 0,s=typeof e.title=="string"?e.title:e.title.value;return n?h("cat.title","{0}: {1}",n,s):s}return t||""}};f=D([C(1,Q),C(2,V)],f);class oe{constructor(i,e,t,n,s,r){this.modifierLabels=i;r||(this.commandIdMatches=this.matches(t,e.command,x(g,B),n),this.commandLabelMatches=e.commandLabel?this.matches(t,e.commandLabel,(a,l)=>g(a,e.commandLabel,!0),n):null,this.commandDefaultLabelMatches=e.commandDefaultLabel?this.matches(t,e.commandDefaultLabel,(a,l)=>g(a,e.commandDefaultLabel,!0),n):null,this.whenMatches=e.when?this.matches(null,e.when,x(g,B),n):null,p(e.source)?this.sourceMatches=this.matches(t,e.source,(a,l)=>g(a,e.source,!0),n):this.extensionLabelMatches=e.source.displayName?this.matches(t,e.source.displayName,(a,l)=>g(a,e.commandLabel,!0),n):null),this.keybindingMatches=e.keybinding?this.matchesKeybinding(e.keybinding,t,s,r):null}commandIdMatches=null;commandLabelMatches=null;commandDefaultLabelMatches=null;sourceMatches=null;whenMatches=null;keybindingMatches=null;extensionIdMatches=null;extensionLabelMatches=null;matches(i,e,t,n){let s=i?ne(i,e):null;return s||(s=this.matchesWords(n,e,t)),s&&(s=this.filterAndSort(s)),s}matchesWords(i,e,t){let n=[];for(const s of i){const r=t(s,e);if(r)n=[...n||[],...r];else{n=null;break}}return n}filterAndSort(i){return R(i,e=>e.start+"."+e.end).filter(e=>!i.some(t=>!(t.start===e.start&&t.end===e.end)&&t.start<=e.start&&t.end>=e.end)).sort((e,t)=>e.start-t.start)}matchesKeybinding(i,e,t,n){const[s,r]=i.getChords(),a=i.getUserSettingsLabel(),l=i.getAriaLabel(),d=i.getLabel();if(a&&c.compareIgnoreCase(e,a)===0||l&&c.compareIgnoreCase(e,l)===0||d&&c.compareIgnoreCase(e,d)===0)return{firstPart:this.createCompleteMatch(s),chordPart:this.createCompleteMatch(r)};const u={};let o={};const M=[],E=[];let I=[],b=!0;for(let y=0;y<t.length;y++){const K=t[y];let L=!1,v=!1;b=b&&!u.keyCode;let P=!o.keyCode;if(b&&(L=this.matchPart(s,u,K,n),u.keyCode)){for(const A of I)E.indexOf(A)===-1&&M.splice(M.indexOf(A),1);o={},I=[],P=!1}P&&(v=this.matchPart(r,o,K,n)),L&&E.push(y),v&&I.push(y),(L||v)&&M.push(y),b=b&&this.isModifier(K)}return M.length!==t.length||n&&(!this.isCompleteMatch(s,u)||!Z(o)&&!this.isCompleteMatch(r,o))?null:this.hasAnyMatch(u)||this.hasAnyMatch(o)?{firstPart:u,chordPart:o}:null}matchPart(i,e,t,n){let s=!1;return this.matchesMetaModifier(i,t)&&(s=!0,e.metaKey=!0),this.matchesCtrlModifier(i,t)&&(s=!0,e.ctrlKey=!0),this.matchesShiftModifier(i,t)&&(s=!0,e.shiftKey=!0),this.matchesAltModifier(i,t)&&(s=!0,e.altKey=!0),this.matchesKeyCode(i,t,n)&&(e.keyCode=!0,s=!0),s}matchesKeyCode(i,e,t){if(!i)return!1;const n=i.keyAriaLabel||"";if(t||n.length===1||e.length===1){if(c.compareIgnoreCase(n,e)===0)return!0}else if(w(e,n))return!0;return!1}matchesMetaModifier(i,e){return!i||!i.metaKey?!1:this.wordMatchesMetaModifier(e)}matchesCtrlModifier(i,e){return!i||!i.ctrlKey?!1:this.wordMatchesCtrlModifier(e)}matchesShiftModifier(i,e){return!i||!i.shiftKey?!1:this.wordMatchesShiftModifier(e)}matchesAltModifier(i,e){return!i||!i.altKey?!1:this.wordMatchesAltModifier(e)}hasAnyMatch(i){return!!i.altKey||!!i.ctrlKey||!!i.metaKey||!!i.shiftKey||!!i.keyCode}isCompleteMatch(i,e){return i?!(!e.keyCode||i.metaKey&&!e.metaKey||i.altKey&&!e.altKey||i.ctrlKey&&!e.ctrlKey||i.shiftKey&&!e.shiftKey):!0}createCompleteMatch(i){const e={};return i&&(e.keyCode=!0,i.metaKey&&(e.metaKey=!0),i.altKey&&(e.altKey=!0),i.ctrlKey&&(e.ctrlKey=!0),i.shiftKey&&(e.shiftKey=!0)),e}isModifier(i){return!!(this.wordMatchesAltModifier(i)||this.wordMatchesCtrlModifier(i)||this.wordMatchesMetaModifier(i)||this.wordMatchesShiftModifier(i))}wordMatchesAltModifier(i){return!!(c.equalsIgnoreCase(this.modifierLabels.ui.altKey,i)||c.equalsIgnoreCase(this.modifierLabels.aria.altKey,i)||c.equalsIgnoreCase(this.modifierLabels.user.altKey,i)||c.equalsIgnoreCase(h("option","option"),i))}wordMatchesCtrlModifier(i){return!!(c.equalsIgnoreCase(this.modifierLabels.ui.ctrlKey,i)||c.equalsIgnoreCase(this.modifierLabels.aria.ctrlKey,i)||c.equalsIgnoreCase(this.modifierLabels.user.ctrlKey,i))}wordMatchesMetaModifier(i){return!!(c.equalsIgnoreCase(this.modifierLabels.ui.metaKey,i)||c.equalsIgnoreCase(this.modifierLabels.aria.metaKey,i)||c.equalsIgnoreCase(this.modifierLabels.user.metaKey,i)||c.equalsIgnoreCase(h("meta","meta"),i))}wordMatchesShiftModifier(i){return!!(c.equalsIgnoreCase(this.modifierLabels.ui.shiftKey,i)||c.equalsIgnoreCase(this.modifierLabels.aria.shiftKey,i)||c.equalsIgnoreCase(this.modifierLabels.user.shiftKey,i))}}export{S as KEYBINDING_ENTRY_TEMPLATE_ID,f as KeybindingsEditorModel,Te as createKeybindingCommandQuery};
