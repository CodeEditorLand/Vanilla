import{URI as c}from"../../../../../../base/common/uri.js";import"../../../../../../editor/common/encodedTokenAttributes.js";import"../../../../../../editor/common/model/mirrorTextModel.js";import{TMGrammarFactory as d}from"../../../common/TMGrammarFactory.js";import"../../../common/TMScopeRegistry.js";import{TextMateWorkerTokenizer as u}from"./textMateWorkerTokenizer.js";import{importAMDNodeModule as l}from"../../../../../../amdX.js";import"../../../../../../base/common/worker/simpleWorker.js";import{TextMateWorkerHost as p}from"./textMateWorkerHost.js";function O(s){return new T(s)}class T{_requestHandlerBrand;_host;_models=new Map;_grammarCache=[];_grammarFactory=Promise.resolve(null);constructor(e){this._host=p.getChannel(e)}async $init(e){const a=e.grammarDefinitions.map(r=>({location:c.revive(r.location),language:r.language,scopeName:r.scopeName,embeddedLanguages:r.embeddedLanguages,tokenTypes:r.tokenTypes,injectTo:r.injectTo,balancedBracketSelectors:r.balancedBracketSelectors,unbalancedBracketSelectors:r.unbalancedBracketSelectors,sourceExtensionId:r.sourceExtensionId}));this._grammarFactory=this._loadTMGrammarFactory(a,e.onigurumaWASMUri)}async _loadTMGrammarFactory(e,a){const r=await l("vscode-textmate","release/main.js"),n=await l("vscode-oniguruma","release/main.js"),i=await(await fetch(a)).arrayBuffer();await n.loadWASM(i);const m=Promise.resolve({createOnigScanner:t=>n.createOnigScanner(t),createOnigString:t=>n.createOnigString(t)});return new d({logTrace:t=>{},logError:(t,g)=>console.error(t,g),readFile:t=>this._host.$readFile(t)},e,r,m)}$acceptNewModel(e){const a=c.revive(e.uri),r=this;this._models.set(e.controllerId,new u(a,e.lines,e.EOL,e.versionId,{async getOrCreateGrammar(n,o){const i=await r._grammarFactory;return i?(r._grammarCache[o]||(r._grammarCache[o]=i.createGrammar(n,o)),r._grammarCache[o]):Promise.resolve(null)},setTokensAndStates(n,o,i){r._host.$setTokensAndStates(e.controllerId,n,o,i)},reportTokenizationTime(n,o,i,m,t){r._host.$reportTokenizationTime(n,o,i,m,t)}},e.languageId,e.encodedLanguageId,e.maxTokenizationLineLength))}$acceptModelChanged(e,a){this._models.get(e).onEvents(a)}$retokenize(e,a,r){this._models.get(e).retokenize(a,r)}$acceptModelLanguageChanged(e,a,r){this._models.get(e).onLanguageId(a,r)}$acceptRemovedModel(e){const a=this._models.get(e);a&&(a.dispose(),this._models.delete(e))}async $acceptTheme(e,a){(await this._grammarFactory)?.setTheme(e,a)}$acceptMaxTokenizationLineLength(e,a){this._models.get(e).acceptMaxTokenizationLineLength(a)}}export{T as TextMateTokenizationWorker,O as create};
