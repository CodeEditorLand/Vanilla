var S=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var P=(o,s,e,i)=>{for(var t=i>1?void 0:i?I(s,e):s,n=o.length-1,r;n>=0;n--)(r=o[n])&&(t=(i?r(s,e,t):r(t))||t);return i&&t&&S(s,e,t),t},c=(o,s)=>(e,i)=>s(e,i,o);import{Emitter as d,Event as _}from"../../../../base/common/event.js";import{Disposable as D,DisposableMap as y,DisposableStore as A,isDisposable as b,toDisposable as w}from"../../../../base/common/lifecycle.js";import{isFalsyOrWhitespace as m}from"../../../../base/common/strings.js";import{isString as v}from"../../../../base/common/types.js";import{localize as u}from"../../../../nls.js";import{InstantiationType as E,registerSingleton as C}from"../../../../platform/instantiation/common/extensions.js";import"../../../../platform/product/common/productService.js";import"../../../../platform/secrets/common/secrets.js";import{IAuthenticationAccessService as x}from"./authenticationAccessService.js";import{IAuthenticationService as R}from"../common/authentication.js";import{IBrowserWorkbenchEnvironmentService as N}from"../../environment/browser/environmentService.js";import{ActivationKind as p,IExtensionService as T}from"../../extensions/common/extensions.js";function $(o){return`onAuthenticationRequest:${o}`}async function te(o,s){const e=await o.get(`${s.urlProtocol}.loginAccount`);if(e)try{const i=JSON.parse(e);if(i&&v(i.id)&&v(i.accessToken)&&v(i.providerId))return i}catch{}}let a=class extends D{constructor(e,i,t){super();this._extensionService=e;this._environmentService=t;this._register(i.onDidChangeExtensionSessionAccess(n=>{this._onDidChangeSessions.fire({providerId:n.providerId,label:n.accountName,event:{added:[],changed:[],removed:[]}})})),this._registerEnvContributedAuthenticationProviders()}_onDidRegisterAuthenticationProvider=this._register(new d);onDidRegisterAuthenticationProvider=this._onDidRegisterAuthenticationProvider.event;_onDidUnregisterAuthenticationProvider=this._register(new d);onDidUnregisterAuthenticationProvider=this._onDidUnregisterAuthenticationProvider.event;_onDidChangeSessions=this._register(new d);onDidChangeSessions=this._onDidChangeSessions.event;_onDidChangeDeclaredProviders=this._register(new d);onDidChangeDeclaredProviders=this._onDidChangeDeclaredProviders.event;_authenticationProviders=new Map;_authenticationProviderDisposables=this._register(new y);_declaredProviders=[];get declaredProviders(){return this._declaredProviders}_registerEnvContributedAuthenticationProviders(){if(this._environmentService.options?.authenticationProviders?.length)for(const e of this._environmentService.options.authenticationProviders)this.registerAuthenticationProvider(e.id,e)}registerDeclaredAuthenticationProvider(e){if(m(e.id))throw new Error(u("authentication.missingId","An authentication contribution must specify an id."));if(m(e.label))throw new Error(u("authentication.missingLabel","An authentication contribution must specify a label."));if(this.declaredProviders.some(i=>i.id===e.id))throw new Error(u("authentication.idConflict","This authentication id '{0}' has already been registered",e.id));this._declaredProviders.push(e),this._onDidChangeDeclaredProviders.fire()}unregisterDeclaredAuthenticationProvider(e){const i=this.declaredProviders.findIndex(t=>t.id===e);i>-1&&this.declaredProviders.splice(i,1),this._onDidChangeDeclaredProviders.fire()}isAuthenticationProviderRegistered(e){return this._authenticationProviders.has(e)}registerAuthenticationProvider(e,i){this._authenticationProviders.set(e,i);const t=new A;t.add(i.onDidChangeSessions(n=>this._onDidChangeSessions.fire({providerId:e,label:i.label,event:n}))),b(i)&&t.add(i),this._authenticationProviderDisposables.set(e,t),this._onDidRegisterAuthenticationProvider.fire({id:e,label:i.label})}unregisterAuthenticationProvider(e){const i=this._authenticationProviders.get(e);i&&(this._authenticationProviders.delete(e),this._onDidUnregisterAuthenticationProvider.fire({id:e,label:i.label})),this._authenticationProviderDisposables.deleteAndDispose(e)}getProviderIds(){const e=[];return this._authenticationProviders.forEach(i=>{e.push(i.id)}),e}getProvider(e){if(this._authenticationProviders.has(e))return this._authenticationProviders.get(e);throw new Error(`No authentication provider '${e}' is currently registered.`)}async getAccounts(e){const i=await this.getSessions(e),t=new Array,n=new Set;for(const r of i)n.has(r.account.label)||(n.add(r.account.label),t.push(r.account));return t}async getSessions(e,i,t,n=!1){const r=this._authenticationProviders.get(e)||await this.tryActivateProvider(e,n);if(r)return await r.getSessions(i,{account:t});throw new Error(`No authentication provider '${e}' is currently registered.`)}async createSession(e,i,t){const n=this._authenticationProviders.get(e)||await this.tryActivateProvider(e,!!t?.activateImmediate);if(n)return await n.createSession(i,{account:t?.account});throw new Error(`No authentication provider '${e}' is currently registered.`)}async removeSession(e,i){const t=this._authenticationProviders.get(e);if(t)return t.removeSession(i);throw new Error(`No authentication provider '${e}' is currently registered.`)}async tryActivateProvider(e,i){await this._extensionService.activateByEvent($(e),i?p.Immediate:p.Normal);let t=this._authenticationProviders.get(e);if(t)return t;const n=new A,r=new Promise((l,g)=>{n.add(_.once(this.onDidRegisterAuthenticationProvider)(h=>{if(h.id===e)if(t=this._authenticationProviders.get(e),t)l(t);else throw new Error(`No authentication provider '${e}' is currently registered.`)}))}),f=new Promise((l,g)=>{const h=setTimeout(()=>{g("Timed out waiting for authentication provider to register")},5e3);n.add(w(()=>clearTimeout(h)))});return Promise.race([r,f]).finally(()=>n.dispose())}};a=P([c(0,T),c(1,x),c(2,N)],a),C(R,a,E.Delayed);export{a as AuthenticationService,$ as getAuthenticationProviderActivationEvent,te as getCurrentAuthenticationSessionInfo};
