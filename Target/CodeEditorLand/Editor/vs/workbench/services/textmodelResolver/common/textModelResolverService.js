var M=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var v=(d,s,e,o)=>{for(var r=o>1?void 0:o?I(s,e):s,t=d.length-1,i;t>=0;t--)(i=d[t])&&(r=(o?i(s,e,r):i(r))||r);return o&&r&&M(s,e,r),r},n=(d,s)=>(e,o)=>s(e,o,d);import{AsyncReferenceCollection as S,Disposable as x,ReferenceCollection as T,toDisposable as R}from"../../../../../vs/base/common/lifecycle.js";import{Schemas as l}from"../../../../../vs/base/common/network.js";import{URI as f}from"../../../../../vs/base/common/uri.js";import"../../../../../vs/editor/common/model.js";import{IModelService as p}from"../../../../../vs/editor/common/services/model.js";import{ModelUndoRedoParticipant as C}from"../../../../../vs/editor/common/services/modelUndoRedoParticipant.js";import{isResolvedTextEditorModel as g,ITextModelService as y}from"../../../../../vs/editor/common/services/resolverService.js";import{IFileService as m}from"../../../../../vs/platform/files/common/files.js";import{InstantiationType as E,registerSingleton as w}from"../../../../../vs/platform/instantiation/common/extensions.js";import{IInstantiationService as h}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{IUndoRedoService as P}from"../../../../../vs/platform/undoRedo/common/undoRedo.js";import{IUriIdentityService as b}from"../../../../../vs/platform/uriIdentity/common/uriIdentity.js";import{TextResourceEditorModel as u}from"../../../../../vs/workbench/common/editor/textResourceEditorModel.js";import{TextFileEditorModel as F}from"../../../../../vs/workbench/services/textfile/common/textFileEditorModel.js";import{ITextFileService as D,TextFileResolveReason as U}from"../../../../../vs/workbench/services/textfile/common/textfiles.js";import{UntitledTextEditorModel as _}from"../../../../../vs/workbench/services/untitled/common/untitledTextEditorModel.js";let c=class extends T{constructor(e,o,r,t){super();this.instantiationService=e;this.textFileService=o;this.fileService=r;this.modelService=t}providers=new Map;modelsToDispose=new Set;createReferencedObject(e){return this.doCreateReferencedObject(e)}async doCreateReferencedObject(e,o){this.modelsToDispose.delete(e);const r=f.parse(e);if(r.scheme===l.inMemory){if(!this.modelService.getModel(r))throw new Error(`Unable to resolve inMemory resource ${e}`);const i=this.instantiationService.createInstance(u,r);if(this.ensureResolvedModel(i,e))return i}if(r.scheme===l.untitled){const t=await this.textFileService.untitled.resolve({untitledResource:r});if(this.ensureResolvedModel(t,e))return t}if(this.fileService.hasProvider(r)){const t=await this.textFileService.files.resolve(r,{reason:U.REFERENCE});if(this.ensureResolvedModel(t,e))return t}if(this.providers.has(r.scheme)){await this.resolveTextModelContent(e);const t=this.instantiationService.createInstance(u,r);if(this.ensureResolvedModel(t,e))return t}if(!o)return await this.fileService.activateProvider(r.scheme),this.doCreateReferencedObject(e,!0);throw new Error(`Unable to resolve resource ${e}`)}ensureResolvedModel(e,o){if(g(e))return!0;throw new Error(`Unable to resolve resource ${o}`)}destroyReferencedObject(e,o){f.parse(e).scheme!==l.inMemory&&(this.modelsToDispose.add(e),(async()=>{try{const t=await o;if(!this.modelsToDispose.has(e)||(t instanceof F?await this.textFileService.files.canDispose(t):t instanceof _&&await this.textFileService.untitled.canDispose(t),!this.modelsToDispose.has(e)))return;t.dispose()}catch{}finally{this.modelsToDispose.delete(e)}})())}registerTextModelContentProvider(e,o){let r=this.providers.get(e);return r||(r=[],this.providers.set(e,r)),r.unshift(o),R(()=>{const t=this.providers.get(e);if(!t)return;const i=t.indexOf(o);i!==-1&&(t.splice(i,1),t.length===0&&this.providers.delete(e))})}hasTextModelContentProvider(e){return this.providers.get(e)!==void 0}async resolveTextModelContent(e){const o=f.parse(e),r=this.providers.get(o.scheme)||[];for(const t of r){const i=await t.provideTextContent(o);if(i)return i}throw new Error(`Unable to resolve text model content for resource ${e}`)}};c=v([n(0,h),n(1,D),n(2,m),n(3,p)],c);let a=class extends x{constructor(e,o,r,t,i){super();this.instantiationService=e;this.fileService=o;this.undoRedoService=r;this.modelService=t;this.uriIdentityService=i;this._register(new C(this.modelService,this,this.undoRedoService))}_resourceModelCollection=void 0;get resourceModelCollection(){return this._resourceModelCollection||(this._resourceModelCollection=this.instantiationService.createInstance(c)),this._resourceModelCollection}_asyncModelCollection=void 0;get asyncModelCollection(){return this._asyncModelCollection||(this._asyncModelCollection=new S(this.resourceModelCollection)),this._asyncModelCollection}async createModelReference(e){return e=this.uriIdentityService.asCanonicalUri(e),await this.asyncModelCollection.acquire(e.toString())}registerTextModelContentProvider(e,o){return this.resourceModelCollection.registerTextModelContentProvider(e,o)}canHandleResource(e){return this.fileService.hasProvider(e)||e.scheme===l.untitled||e.scheme===l.inMemory?!0:this.resourceModelCollection.hasTextModelContentProvider(e.scheme)}};a=v([n(0,h),n(1,m),n(2,P),n(3,p),n(4,b)],a),w(y,a,E.Delayed);export{a as TextModelResolverService};
