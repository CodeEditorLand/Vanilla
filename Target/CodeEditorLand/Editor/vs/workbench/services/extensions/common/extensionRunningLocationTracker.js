var k=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var R=(m,n,t,i)=>{for(var o=i>1?void 0:i?K(n,t):n,f=m.length-1,r;f>=0;f--)(r=m[f])&&(o=(i?r(n,t,o):r(o))||o);return i&&o&&k(n,t,o),o},I=(m,n)=>(t,i)=>n(t,i,m);import{Schemas as P}from"../../../../../vs/base/common/network.js";import{IConfigurationService as S}from"../../../../../vs/platform/configuration/common/configuration.js";import"../../../../../vs/platform/environment/common/environment.js";import{ExtensionIdentifierMap as y}from"../../../../../vs/platform/extensions/common/extensions.js";import{ILogService as w}from"../../../../../vs/platform/log/common/log.js";import{IWorkbenchEnvironmentService as M}from"../../../../../vs/workbench/services/environment/common/environmentService.js";import"../../../../../vs/workbench/services/extensions/common/extensionDescriptionRegistry.js";import{determineExtensionHostKinds as H,ExtensionHostKind as p,ExtensionRunningPreference as C}from"../../../../../vs/workbench/services/extensions/common/extensionHostKind.js";import"../../../../../vs/workbench/services/extensions/common/extensionHostManagers.js";import{IExtensionManifestPropertiesService as B}from"../../../../../vs/workbench/services/extensions/common/extensionManifestPropertiesService.js";import{LocalProcessRunningLocation as D,LocalWebWorkerRunningLocation as W,RemoteRunningLocation as A}from"../../../../../vs/workbench/services/extensions/common/extensionRunningLocation.js";let h=class{constructor(n,t,i,o,f,r){this._registry=n;this._extensionHostKindPicker=t;this._environmentService=i;this._configurationService=o;this._logService=f;this._extensionManifestPropertiesService=r}_runningLocation=new y;_maxLocalProcessAffinity=0;_maxLocalWebWorkerAffinity=0;get maxLocalProcessAffinity(){return this._maxLocalProcessAffinity}get maxLocalWebWorkerAffinity(){return this._maxLocalWebWorkerAffinity}set(n,t){this._runningLocation.set(n,t)}readExtensionKinds(n){return n.isUnderDevelopment&&this._environmentService.extensionDevelopmentKind?this._environmentService.extensionDevelopmentKind:this._extensionManifestPropertiesService.getExtensionKind(n)}getRunningLocation(n){return this._runningLocation.get(n)||null}filterByRunningLocation(n,t){return _(n,this._runningLocation,i=>t.equals(i))}filterByExtensionHostKind(n,t){return _(n,this._runningLocation,i=>i.kind===t)}filterByExtensionHostManager(n,t){return _(n,this._runningLocation,i=>t.representsRunningLocation(i))}_computeAffinity(n,t,i){const o=new y;for(const s of n)(s.main||s.browser)&&o.set(s.identifier,s);for(const s of this._registry.getAllExtensionDescriptions())if(s.main||s.browser){const a=this._runningLocation.get(s.identifier);a&&a.kind===t&&o.set(s.identifier,s)}const f=new y;let r=0;for(const[s,a]of o)f.set(a.identifier,++r);const l=(s,a)=>{for(const[u,e]of f)e===s&&f.set(u,a)};for(const[s,a]of o){if(!a.extensionDependencies)continue;const u=f.get(a.identifier);for(const e of a.extensionDependencies){const c=f.get(e);c&&c!==u&&l(c,u)}}const d=new Map;let x=0;for(const[s,a]of o){const u=this._runningLocation.get(a.identifier);if(u){const e=f.get(a.identifier);d.set(e,u.affinity),x=Math.max(x,u.affinity)}}if(!this._environmentService.isExtensionDevelopment){const s=this._configurationService.getValue("extensions.experimental.affinity")||{},a=Object.keys(s),u=new Map;for(const e of a){const c=s[e];if(typeof c!="number"||c<=0||Math.floor(c)!==c){this._logService.info(`Ignoring configured affinity for '${e}' because the value is not a positive integer.`);continue}const E=f.get(e);if(!E)continue;const g=d.get(E);if(g){u.set(c,g);continue}const b=u.get(c);if(b){d.set(E,b);continue}if(!i){this._logService.info(`Ignoring configured affinity for '${e}' because extension host(s) are already running. Reload window.`);continue}const v=++x;u.set(c,v),d.set(E,v)}}const L=new y;for(const s of n){const a=f.get(s.identifier)||0,u=d.get(a)||0;L.set(s.identifier,u)}if(x>0&&i)for(let s=1;s<=x;s++){const a=[];for(const u of n)L.get(u.identifier)===s&&a.push(u.identifier);this._logService.info(`Placing extension(s) ${a.map(u=>u.value).join(", ")} on a separate extension host.`)}return{affinities:L,maxAffinity:x}}computeRunningLocation(n,t,i){return this._doComputeRunningLocation(this._runningLocation,n,t,i).runningLocation}_doComputeRunningLocation(n,t,i,o){t=t.filter(e=>!n.has(e.identifier)),i=i.filter(e=>!n.has(e.identifier));const f=H(t,i,e=>this.readExtensionKinds(e),(e,c,E,g,b)=>this._extensionHostKindPicker.pickExtensionHostKind(e,c,E,g,b)),r=new y;for(const e of t)r.set(e.identifier,e);for(const e of i)r.set(e.identifier,e);const l=new y,d=[],x=[];for(const[e,c]of f){let E=null;if(c===p.LocalProcess){const g=r.get(e);g&&d.push(g)}else if(c===p.LocalWebWorker){const g=r.get(e);g&&x.push(g)}else c===p.Remote&&(E=new A);l.set(e,E)}const{affinities:L,maxAffinity:s}=this._computeAffinity(d,p.LocalProcess,o);for(const e of d){const c=L.get(e.identifier)||0;l.set(e.identifier,new D(c))}const{affinities:a,maxAffinity:u}=this._computeAffinity(x,p.LocalWebWorker,o);for(const e of x){const c=a.get(e.identifier)||0;l.set(e.identifier,new W(c))}for(const[e,c]of n)c&&l.set(e,c);return{runningLocation:l,maxLocalProcessAffinity:s,maxLocalWebWorkerAffinity:u}}initializeRunningLocation(n,t){const{runningLocation:i,maxLocalProcessAffinity:o,maxLocalWebWorkerAffinity:f}=this._doComputeRunningLocation(this._runningLocation,n,t,!0);this._runningLocation=i,this._maxLocalProcessAffinity=o,this._maxLocalWebWorkerAffinity=f}deltaExtensions(n,t){const i=new y;for(const o of t){const f=o;i.set(f,this._runningLocation.get(f)||null),this._runningLocation.delete(f)}return this._updateRunningLocationForAddedExtensions(n),i}_updateRunningLocationForAddedExtensions(n){const t=[],i=[];for(const r of n){const l=this.readExtensionKinds(r),d=r.extensionLocation.scheme===P.vscodeRemote,x=this._extensionHostKindPicker.pickExtensionHostKind(r.identifier,l,!d,d,C.None);let L=null;x===p.LocalProcess?t.push(r):x===p.LocalWebWorker?i.push(r):x===p.Remote&&(L=new A),this._runningLocation.set(r.identifier,L)}const{affinities:o}=this._computeAffinity(t,p.LocalProcess,!1);for(const r of t){const l=o.get(r.identifier)||0;this._runningLocation.set(r.identifier,new D(l))}const{affinities:f}=this._computeAffinity(i,p.LocalWebWorker,!1);for(const r of i){const l=f.get(r.identifier)||0;this._runningLocation.set(r.identifier,new W(l))}}};h=R([I(2,M),I(3,S),I(4,w),I(5,B)],h);function _(m,n,t){return m.filter(i=>{const o=n.get(i.identifier);return o&&t(o)})}function on(m,n,t){return m.filter(i=>{const o=n.get(i);return o&&t(o)})}export{h as ExtensionRunningLocationTracker,_ as filterExtensionDescriptions,on as filterExtensionIdentifiers};
