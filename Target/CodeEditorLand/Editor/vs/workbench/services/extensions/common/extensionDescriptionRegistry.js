import{promiseWithResolvers as h}from"../../../../../vs/base/common/async.js";import{Emitter as g}from"../../../../../vs/base/common/event.js";import{Disposable as v,toDisposable as f}from"../../../../../vs/base/common/lifecycle.js";import*as u from"../../../../../vs/base/common/path.js";import{ExtensionIdentifier as x,ExtensionIdentifierMap as E,ExtensionIdentifierSet as I}from"../../../../../vs/platform/extensions/common/extensions.js";class _{constructor(i,e){this.versionId=i;this.removedDueToLooping=e}}class d{constructor(i,e){this._activationEventsReader=i;this._extensionDescriptions=e,this._initialize()}static isHostExtension(i,e,t){if(e.getExtensionDescription(i))return!1;const s=t.getExtensionDescription(i);return s?!!((s.main||s.browser)&&s.api==="none"):!1}_onDidChange=new g;onDidChange=this._onDidChange.event;_versionId=0;_extensionDescriptions;_extensionsMap;_extensionsArr;_activationMap;_initialize(){this._extensionDescriptions.sort(L),this._extensionsMap=new E,this._extensionsArr=[],this._activationMap=new Map;for(const i of this._extensionDescriptions){if(this._extensionsMap.has(i.identifier)){console.error("Extension `"+i.identifier.value+"` is already registered");continue}this._extensionsMap.set(i.identifier,i),this._extensionsArr.push(i);const e=this._activationEventsReader.readActivationEvents(i);for(const t of e)this._activationMap.has(t)||this._activationMap.set(t,[]),this._activationMap.get(t).push(i)}}set(i){return this._extensionDescriptions=i,this._initialize(),this._versionId++,this._onDidChange.fire(void 0),{versionId:this._versionId}}deltaExtensions(i,e){this._extensionDescriptions=D(this._extensionDescriptions,e),this._extensionDescriptions=this._extensionDescriptions.concat(i);const t=d._findLoopingExtensions(this._extensionDescriptions);return this._extensionDescriptions=D(this._extensionDescriptions,t.map(s=>s.identifier)),this._initialize(),this._versionId++,this._onDidChange.fire(void 0),new _(this._versionId,t)}static _findLoopingExtensions(i){const e=new class{_arcs=new Map;_nodesSet=new Set;_nodesArr=[];addNode(n){this._nodesSet.has(n)||(this._nodesSet.add(n),this._nodesArr.push(n))}addArc(n,r){this.addNode(n),this.addNode(r),this._arcs.has(n)?this._arcs.get(n).push(r):this._arcs.set(n,[r])}getArcs(n){return this._arcs.has(n)?this._arcs.get(n):[]}hasOnlyGoodArcs(n,r){const l=e.getArcs(n);for(let p=0;p<l.length;p++)if(!r.has(l[p]))return!1;return!0}getNodes(){return this._nodesArr}},t=new E;for(const n of i)if(t.set(n.identifier,n),n.extensionDependencies)for(const r of n.extensionDependencies)e.addArc(x.toKey(n.identifier),x.toKey(r));const s=new Set;e.getNodes().filter(n=>e.getArcs(n).length===0).forEach(n=>s.add(n));const c=e.getNodes().filter(n=>!s.has(n));let a;do{a=!1;for(let n=0;n<c.length;n++){const r=c[n];e.hasOnlyGoodArcs(r,s)&&(c.splice(n,1),n--,s.add(r),a=!0)}}while(a);return c.map(n=>t.get(n))}containsActivationEvent(i){return this._activationMap.has(i)}containsExtension(i){return this._extensionsMap.has(i)}getExtensionDescriptionsForActivationEvent(i){const e=this._activationMap.get(i);return e?e.slice(0):[]}getAllExtensionDescriptions(){return this._extensionsArr.slice(0)}getSnapshot(){return new b(this._versionId,this.getAllExtensionDescriptions())}getExtensionDescription(i){const e=this._extensionsMap.get(i);return e||void 0}getExtensionDescriptionByUUID(i){for(const e of this._extensionsArr)if(e.uuid===i)return e}getExtensionDescriptionByIdOrUUID(i,e){return this.getExtensionDescription(i)??(e?this.getExtensionDescriptionByUUID(e):void 0)}}class b{constructor(i,e){this.versionId=i;this.extensions=e}}class C{_actual;_lock=new A;constructor(i){this._actual=new d(i,[])}async acquireLock(i){const e=await this._lock.acquire(i);return new m(this,e)}deltaExtensions(i,e,t){if(!i.isAcquiredFor(this))throw new Error("Lock is not held");return this._actual.deltaExtensions(e,t)}containsActivationEvent(i){return this._actual.containsActivationEvent(i)}containsExtension(i){return this._actual.containsExtension(i)}getExtensionDescriptionsForActivationEvent(i){return this._actual.getExtensionDescriptionsForActivationEvent(i)}getAllExtensionDescriptions(){return this._actual.getAllExtensionDescriptions()}getSnapshot(){return this._actual.getSnapshot()}getExtensionDescription(i){return this._actual.getExtensionDescription(i)}getExtensionDescriptionByUUID(i){return this._actual.getExtensionDescriptionByUUID(i)}getExtensionDescriptionByIdOrUUID(i,e){return this._actual.getExtensionDescriptionByIdOrUUID(i,e)}}class m extends v{constructor(e,t){super();this._registry=e;this._register(t)}_isDisposed=!1;isAcquiredFor(e){return!this._isDisposed&&this._registry===e}}class y{constructor(i){this.name=i;const e=h();this.promise=e.promise,this._resolve=e.resolve}promise;_resolve;resolve(i){this._resolve(i)}}class A{_pendingCustomers=[];_isLocked=!1;async acquire(i){const e=new y(i);return this._pendingCustomers.push(e),this._advance(),e.promise}_advance(){if(this._isLocked||this._pendingCustomers.length===0)return;const i=this._pendingCustomers.shift();this._isLocked=!0;let e=!0;const t=setTimeout(()=>{e&&console.warn(`The customer named ${i.name} has been holding on to the lock for 30s. This might be a problem.`)},30*1e3),s=()=>{e&&(clearTimeout(t),e=!1,this._isLocked=!1,this._advance())};i.resolve(f(s))}}var R=(t=>(t[t.Builtin=0]="Builtin",t[t.User=1]="User",t[t.Dev=2]="Dev",t))(R||{});function L(o,i){const e=o.isBuiltin?0:o.isUnderDevelopment?2:1,t=i.isBuiltin?0:i.isUnderDevelopment?2:1;if(e!==t)return e-t;const s=u.posix.basename(o.extensionLocation.path),c=u.posix.basename(i.extensionLocation.path);return s<c?-1:s>c?1:0}function D(o,i){const e=new I(i);return o.filter(t=>!e.has(t.identifier))}export{_ as DeltaExtensionsResult,d as ExtensionDescriptionRegistry,m as ExtensionDescriptionRegistryLock,b as ExtensionDescriptionRegistrySnapshot,C as LockableExtensionDescriptionRegistry};
