{
  "version": 3,
  "sources": ["../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/services/extensions/worker/polyfillNestedWorker.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { NewWorkerMessage, TerminateWorkerMessage } from '../common/polyfillNestedWorker.protocol.js';\n\ndeclare function postMessage(data: any, transferables?: Transferable[]): void;\n\ndeclare type MessageEventHandler = ((ev: MessageEvent<any>) => any) | null;\n\nconst _bootstrapFnSource = (function _bootstrapFn(workerUrl: string) {\n\n\tconst listener: EventListener = (event: Event): void => {\n\t\t// uninstall handler\n\t\tglobalThis.removeEventListener('message', listener);\n\n\t\t// get data\n\t\tconst port = <MessagePort>(<MessageEvent>event).data;\n\n\t\t// postMessage\n\t\t// onmessage\n\t\tObject.defineProperties(globalThis, {\n\t\t\t'postMessage': {\n\t\t\t\tvalue(data: any, transferOrOptions?: any) {\n\t\t\t\t\tport.postMessage(data, transferOrOptions);\n\t\t\t\t}\n\t\t\t},\n\t\t\t'onmessage': {\n\t\t\t\tget() {\n\t\t\t\t\treturn port.onmessage;\n\t\t\t\t},\n\t\t\t\tset(value: MessageEventHandler) {\n\t\t\t\t\tport.onmessage = value;\n\t\t\t\t}\n\t\t\t}\n\t\t\t// todo onerror\n\t\t});\n\n\t\tport.addEventListener('message', msg => {\n\t\t\tglobalThis.dispatchEvent(new MessageEvent('message', { data: msg.data, ports: msg.ports ? [...msg.ports] : undefined }));\n\t\t});\n\n\t\tport.start();\n\n\t\t// fake recursively nested worker\n\t\tglobalThis.Worker = <any>class { constructor() { throw new TypeError('Nested workers from within nested worker are NOT supported.'); } };\n\n\t\t// load module\n\t\timportScripts(workerUrl);\n\t};\n\n\tglobalThis.addEventListener('message', listener);\n}).toString();\n\n\nexport class NestedWorker extends EventTarget implements Worker {\n\n\tonmessage: ((this: Worker, ev: MessageEvent<any>) => any) | null = null;\n\tonmessageerror: ((this: Worker, ev: MessageEvent<any>) => any) | null = null;\n\tonerror: ((this: AbstractWorker, ev: ErrorEvent) => any) | null = null;\n\n\treadonly terminate: () => void;\n\treadonly postMessage: (message: any, options?: any) => void;\n\n\tconstructor(nativePostMessage: typeof postMessage, stringOrUrl: string | URL, options?: WorkerOptions) {\n\t\tsuper();\n\n\t\t// create bootstrap script\n\t\tconst bootstrap = `((${_bootstrapFnSource})('${stringOrUrl}'))`;\n\t\tconst blob = new Blob([bootstrap], { type: 'application/javascript' });\n\t\tconst blobUrl = URL.createObjectURL(blob);\n\n\t\tconst channel = new MessageChannel();\n\t\tconst id = blobUrl; // works because blob url is unique, needs ID pool otherwise\n\n\t\tconst msg: NewWorkerMessage = {\n\t\t\ttype: '_newWorker',\n\t\t\tid,\n\t\t\tport: channel.port2,\n\t\t\turl: blobUrl,\n\t\t\toptions,\n\t\t};\n\t\tnativePostMessage(msg, [channel.port2]);\n\n\t\t// worker-impl: functions\n\t\tthis.postMessage = channel.port1.postMessage.bind(channel.port1);\n\t\tthis.terminate = () => {\n\t\t\tconst msg: TerminateWorkerMessage = {\n\t\t\t\ttype: '_terminateWorker',\n\t\t\t\tid\n\t\t\t};\n\t\t\tnativePostMessage(msg);\n\t\t\tURL.revokeObjectURL(blobUrl);\n\n\t\t\tchannel.port1.close();\n\t\t\tchannel.port2.close();\n\t\t};\n\n\t\t// worker-impl: events\n\t\tObject.defineProperties(this, {\n\t\t\t'onmessage': {\n\t\t\t\tget() {\n\t\t\t\t\treturn channel.port1.onmessage;\n\t\t\t\t},\n\t\t\t\tset(value: MessageEventHandler) {\n\t\t\t\t\tchannel.port1.onmessage = value;\n\t\t\t\t}\n\t\t\t},\n\t\t\t'onmessageerror': {\n\t\t\t\tget() {\n\t\t\t\t\treturn channel.port1.onmessageerror;\n\t\t\t\t},\n\t\t\t\tset(value: MessageEventHandler) {\n\t\t\t\t\tchannel.port1.onmessageerror = value;\n\t\t\t\t}\n\t\t\t},\n\t\t\t// todo onerror\n\t\t});\n\n\t\tchannel.port1.addEventListener('messageerror', evt => {\n\t\t\tconst msgEvent = new MessageEvent('messageerror', { data: evt.data });\n\t\t\tthis.dispatchEvent(msgEvent);\n\t\t});\n\n\t\tchannel.port1.addEventListener('message', evt => {\n\t\t\tconst msgEvent = new MessageEvent('message', { data: evt.data });\n\t\t\tthis.dispatchEvent(msgEvent);\n\t\t});\n\n\t\tchannel.port1.start();\n\t}\n}\n"],
  "mappings": "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",
  "names": ["msg"]
}
