var y=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var x=(f,i,s,n)=>{for(var r=n>1?void 0:n?T(i,s):i,l=f.length-1,c;l>=0;l--)(c=f[l])&&(r=(n?c(i,s,r):c(r))||r);return n&&r&&y(i,s,r),r},g=(f,i)=>(s,n)=>i(s,n,f);import{createSingleCallFunction as b}from"../../../../base/common/functional.js";import{Schemas as _}from"../../../../base/common/network.js";import{TernarySearchTree as w}from"../../../../base/common/ternarySearchTree.js";import{URI as v}from"../../../../base/common/uri.js";import{IV8InspectProfilingService as D}from"../../../../platform/profiling/common/profiling.js";import{IExtensionService as V}from"../common/extensions.js";let u=class{constructor(i,s,n,r){this._host=i;this._port=s;this._extensionService=n;this._profilingService=r}async start(){const i=await this._profilingService.startProfiling({host:this._host,port:this._port});return{stop:b(async()=>{const s=await this._profilingService.stopProfiling(i);await this._extensionService.whenInstalledExtensionsRegistered();const n=this._extensionService.extensions;return this._distill(s,n)})}}_distill(i,s){const n=w.forUris();for(const e of s)e.extensionLocation.scheme===_.file&&n.set(v.file(e.extensionLocation.fsPath),e);const r=i.nodes,l=new Map,c=new Map;for(const e of r)l.set(e.id,e);function h(e,t){if(t){if(t==="self"&&e.callFrame.url){let o;try{o=n.findSubstr(v.parse(e.callFrame.url))}catch{}o&&(t=o.identifier.value)}}else switch(e.callFrame.functionName){case"(root)":break;case"(program)":t="program";break;case"(garbage collector)":t="gc";break;default:t="self";break}if(c.set(e.id,t),e.children)for(const o of e.children){const I=l.get(o);I&&h(I,t)}}h(r[0],null);const S=i.samples||[],P=i.timeDeltas||[],d=[],m=[];let p=0,a;for(let e=0;e<S.length;e++){const t=S[e],o=c.get(t);o!==a&&(a&&(m.push(a),d.push(p)),a=o??void 0,p=0),p+=P[e]}return a&&(m.push(a),d.push(p)),{startTime:i.startTime,endTime:i.endTime,deltas:d,ids:m,data:i,getAggregatedTimes:()=>{const e=new Map;for(let t=0;t<m.length;t++){const o=m[t];e.set(o,(e.get(o)||0)+d[t])}return e}}}};u=x([g(2,V),g(3,D)],u);export{u as ExtensionHostProfiler};
