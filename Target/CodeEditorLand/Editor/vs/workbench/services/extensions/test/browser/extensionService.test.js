var Q=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var E=(u,a,l,i)=>{for(var r=i>1?void 0:i?V(a,l):a,s=u.length-1,p;s>=0;s--)(p=u[s])&&(r=(i?p(a,l,r):p(r))||r);return i&&r&&Q(a,l,r),r},c=(u,a)=>(l,i)=>a(l,i,u);import e from"assert";import{Event as S}from"../../../../../base/common/event.js";import{DisposableStore as X}from"../../../../../base/common/lifecycle.js";import{mock as f}from"../../../../../base/test/common/mock.js";import{ensureNoDisposablesAreLeakedInTestSuite as w}from"../../../../../base/test/common/utils.js";import{IConfigurationService as R}from"../../../../../platform/configuration/common/configuration.js";import{TestConfigurationService as Y}from"../../../../../platform/configuration/test/common/testConfigurationService.js";import{TestDialogService as Z}from"../../../../../platform/dialogs/test/common/testDialogService.js";import{IEnvironmentService as ee}from"../../../../../platform/environment/common/environment.js";import"../../../../../platform/extensions/common/extensions.js";import{IFileService as L}from"../../../../../platform/files/common/files.js";import{IInstantiationService as oe}from"../../../../../platform/instantiation/common/instantiation.js";import{createServices as ne}from"../../../../../platform/instantiation/test/common/instantiationServiceMock.js";import{ILogService as v,NullLogService as g}from"../../../../../platform/log/common/log.js";import{INotificationService as b}from"../../../../../platform/notification/common/notification.js";import{TestNotificationService as te}from"../../../../../platform/notification/test/common/testNotificationService.js";import ie from"../../../../../platform/product/common/product.js";import{IProductService as x}from"../../../../../platform/product/common/productService.js";import{RemoteAuthorityResolverService as re}from"../../../../../platform/remote/browser/remoteAuthorityResolverService.js";import{IRemoteAuthorityResolverService as N}from"../../../../../platform/remote/common/remoteAuthorityResolver.js";import{IRemoteExtensionsScannerService as q}from"../../../../../platform/remote/common/remoteExtensionsScanner.js";import{ITelemetryService as I}from"../../../../../platform/telemetry/common/telemetry.js";import{NullTelemetryService as ce}from"../../../../../platform/telemetry/common/telemetryUtils.js";import{IUriIdentityService as ae}from"../../../../../platform/uriIdentity/common/uriIdentity.js";import{UriIdentityService as se}from"../../../../../platform/uriIdentity/common/uriIdentityService.js";import{IUserDataProfilesService as ue,UserDataProfilesService as le}from"../../../../../platform/userDataProfile/common/userDataProfile.js";import{IWorkspaceContextService as W}from"../../../../../platform/workspace/common/workspace.js";import{IWorkspaceTrustEnablementService as pe}from"../../../../../platform/workspace/common/workspaceTrust.js";import{IWorkbenchEnvironmentService as de}from"../../../environment/common/environmentService.js";import{IWebExtensionsScannerService as me,IWorkbenchExtensionEnablementService as h,IWorkbenchExtensionManagementService as H}from"../../../extensionManagement/common/extensionManagement.js";import{BrowserExtensionHostKindPicker as o}from"../../browser/extensionService.js";import{AbstractExtensionService as ke}from"../../common/abstractExtensionService.js";import{ExtensionHostKind as t,ExtensionRunningPreference as n}from"../../common/extensionHostKind.js";import"../../common/extensionHostManagers.js";import{ExtensionManifestPropertiesService as Ee,IExtensionManifestPropertiesService as y}from"../../common/extensionManifestPropertiesService.js";import"../../common/extensionRunningLocation.js";import"../../common/extensionRunningLocationTracker.js";import{IExtensionService as P}from"../../common/extensions.js";import{ExtensionsProposedApi as Se}from"../../common/extensionsProposedApi.js";import{ILifecycleService as T}from"../../../lifecycle/common/lifecycle.js";import{IRemoteAgentService as M}from"../../../remote/common/remoteAgentService.js";import{IUserDataProfileService as fe}from"../../../userDataProfile/common/userDataProfile.js";import{WorkspaceTrustEnablementService as we}from"../../../workspaces/common/workspaceTrust.js";import{TestEnvironmentService as Re,TestFileService as Le,TestLifecycleService as ve,TestRemoteAgentService as ge,TestRemoteExtensionsScannerService as be,TestUserDataProfileService as xe,TestWebExtensionsScannerService as Ne,TestWorkbenchExtensionEnablementService as qe,TestWorkbenchExtensionManagementService as Ie}from"../../../../test/browser/workbenchTestServices.js";import{TestContextService as We}from"../../../../test/common/workbenchTestServices.js";suite("BrowserExtensionService",()=>{w(),test("pickRunningLocation",()=>{e.deepStrictEqual(o.pickRunningLocation([],!1,!1,n.None),null),e.deepStrictEqual(o.pickRunningLocation([],!1,!0,n.None),null),e.deepStrictEqual(o.pickRunningLocation([],!0,!1,n.None),null),e.deepStrictEqual(o.pickRunningLocation([],!0,!0,n.None),null),e.deepStrictEqual(o.pickRunningLocation(["ui"],!1,!1,n.None),null),e.deepStrictEqual(o.pickRunningLocation(["ui"],!1,!0,n.None),t.Remote),e.deepStrictEqual(o.pickRunningLocation(["ui"],!0,!1,n.None),null),e.deepStrictEqual(o.pickRunningLocation(["ui"],!0,!0,n.None),t.Remote),e.deepStrictEqual(o.pickRunningLocation(["workspace"],!1,!1,n.None),null),e.deepStrictEqual(o.pickRunningLocation(["workspace"],!1,!0,n.None),t.Remote),e.deepStrictEqual(o.pickRunningLocation(["workspace"],!0,!1,n.None),null),e.deepStrictEqual(o.pickRunningLocation(["workspace"],!0,!0,n.None),t.Remote),e.deepStrictEqual(o.pickRunningLocation(["web"],!1,!1,n.None),null),e.deepStrictEqual(o.pickRunningLocation(["web"],!1,!0,n.None),t.LocalWebWorker),e.deepStrictEqual(o.pickRunningLocation(["web"],!0,!1,n.None),t.LocalWebWorker),e.deepStrictEqual(o.pickRunningLocation(["web"],!0,!0,n.None),t.LocalWebWorker),e.deepStrictEqual(o.pickRunningLocation(["ui","workspace"],!1,!1,n.None),null),e.deepStrictEqual(o.pickRunningLocation(["ui","workspace"],!1,!0,n.None),t.Remote),e.deepStrictEqual(o.pickRunningLocation(["ui","workspace"],!0,!1,n.None),null),e.deepStrictEqual(o.pickRunningLocation(["ui","workspace"],!0,!0,n.None),t.Remote),e.deepStrictEqual(o.pickRunningLocation(["workspace","ui"],!1,!1,n.None),null),e.deepStrictEqual(o.pickRunningLocation(["workspace","ui"],!1,!0,n.None),t.Remote),e.deepStrictEqual(o.pickRunningLocation(["workspace","ui"],!0,!1,n.None),null),e.deepStrictEqual(o.pickRunningLocation(["workspace","ui"],!0,!0,n.None),t.Remote),e.deepStrictEqual(o.pickRunningLocation(["web","workspace"],!1,!1,n.None),null),e.deepStrictEqual(o.pickRunningLocation(["web","workspace"],!1,!0,n.None),t.LocalWebWorker),e.deepStrictEqual(o.pickRunningLocation(["web","workspace"],!0,!1,n.None),t.LocalWebWorker),e.deepStrictEqual(o.pickRunningLocation(["web","workspace"],!0,!0,n.None),t.LocalWebWorker),e.deepStrictEqual(o.pickRunningLocation(["workspace","web"],!1,!1,n.None),null),e.deepStrictEqual(o.pickRunningLocation(["workspace","web"],!1,!0,n.None),t.Remote),e.deepStrictEqual(o.pickRunningLocation(["workspace","web"],!0,!1,n.None),t.LocalWebWorker),e.deepStrictEqual(o.pickRunningLocation(["workspace","web"],!0,!0,n.None),t.Remote),e.deepStrictEqual(o.pickRunningLocation(["ui","web"],!1,!1,n.None),null),e.deepStrictEqual(o.pickRunningLocation(["ui","web"],!1,!0,n.None),t.LocalWebWorker),e.deepStrictEqual(o.pickRunningLocation(["ui","web"],!0,!1,n.None),t.LocalWebWorker),e.deepStrictEqual(o.pickRunningLocation(["ui","web"],!0,!0,n.None),t.LocalWebWorker),e.deepStrictEqual(o.pickRunningLocation(["web","ui"],!1,!1,n.None),null),e.deepStrictEqual(o.pickRunningLocation(["web","ui"],!1,!0,n.None),t.LocalWebWorker),e.deepStrictEqual(o.pickRunningLocation(["web","ui"],!0,!1,n.None),t.LocalWebWorker),e.deepStrictEqual(o.pickRunningLocation(["web","ui"],!0,!0,n.None),t.LocalWebWorker),e.deepStrictEqual(o.pickRunningLocation(["ui","web","workspace"],!1,!1,n.None),null),e.deepStrictEqual(o.pickRunningLocation(["ui","web","workspace"],!1,!0,n.None),t.LocalWebWorker),e.deepStrictEqual(o.pickRunningLocation(["ui","web","workspace"],!0,!1,n.None),t.LocalWebWorker),e.deepStrictEqual(o.pickRunningLocation(["ui","web","workspace"],!0,!0,n.None),t.LocalWebWorker),e.deepStrictEqual(o.pickRunningLocation(["ui","workspace","web"],!1,!1,n.None),null),e.deepStrictEqual(o.pickRunningLocation(["ui","workspace","web"],!1,!0,n.None),t.Remote),e.deepStrictEqual(o.pickRunningLocation(["ui","workspace","web"],!0,!1,n.None),t.LocalWebWorker),e.deepStrictEqual(o.pickRunningLocation(["ui","workspace","web"],!0,!0,n.None),t.Remote),e.deepStrictEqual(o.pickRunningLocation(["web","ui","workspace"],!1,!1,n.None),null),e.deepStrictEqual(o.pickRunningLocation(["web","ui","workspace"],!1,!0,n.None),t.LocalWebWorker),e.deepStrictEqual(o.pickRunningLocation(["web","ui","workspace"],!0,!1,n.None),t.LocalWebWorker),e.deepStrictEqual(o.pickRunningLocation(["web","ui","workspace"],!0,!0,n.None),t.LocalWebWorker),e.deepStrictEqual(o.pickRunningLocation(["web","workspace","ui"],!1,!1,n.None),null),e.deepStrictEqual(o.pickRunningLocation(["web","workspace","ui"],!1,!0,n.None),t.LocalWebWorker),e.deepStrictEqual(o.pickRunningLocation(["web","workspace","ui"],!0,!1,n.None),t.LocalWebWorker),e.deepStrictEqual(o.pickRunningLocation(["web","workspace","ui"],!0,!0,n.None),t.LocalWebWorker),e.deepStrictEqual(o.pickRunningLocation(["workspace","ui","web"],!1,!1,n.None),null),e.deepStrictEqual(o.pickRunningLocation(["workspace","ui","web"],!1,!0,n.None),t.Remote),e.deepStrictEqual(o.pickRunningLocation(["workspace","ui","web"],!0,!1,n.None),t.LocalWebWorker),e.deepStrictEqual(o.pickRunningLocation(["workspace","ui","web"],!0,!0,n.None),t.Remote),e.deepStrictEqual(o.pickRunningLocation(["workspace","web","ui"],!1,!1,n.None),null),e.deepStrictEqual(o.pickRunningLocation(["workspace","web","ui"],!1,!0,n.None),t.Remote),e.deepStrictEqual(o.pickRunningLocation(["workspace","web","ui"],!0,!1,n.None),t.LocalWebWorker),e.deepStrictEqual(o.pickRunningLocation(["workspace","web","ui"],!0,!0,n.None),t.Remote)})}),suite("ExtensionService",()=>{let u=class extends ke{constructor(s,p,d,m,k,A,D,_,C,K,F,U,B,$,j,z){const G=s.createInstance(Se),J=new class{createExtensionHost(he,O,He){return new class extends f(){runningLocation=O}}};super(G,J,null,s,p,d,m,k,A,D,_,C,K,F,U,B,$,j,z,new Z)}_extHostId=0;order=[];_pickExtensionHostKind(s,p,d,m,k){throw new Error("Method not implemented.")}_doCreateExtensionHostManager(s,p){const d=this.order,m=++this._extHostId;return d.push(`create ${m}`),new class extends f(){onDidExit=S.None;onDidChangeResponsiveState=S.None;disconnect(){return Promise.resolve()}dispose(){d.push(`dispose ${m}`)}representsRunningLocation(k){return s.runningLocation.equals(k)}}}_resolveExtensions(){throw new Error("Method not implemented.")}_scanSingleExtension(s){throw new Error("Method not implemented.")}_onExtensionHostExit(s){throw new Error("Method not implemented.")}_resolveAuthority(s){throw new Error("Method not implemented.")}};u=E([c(0,oe),c(1,b),c(2,de),c(3,I),c(4,h),c(5,L),c(6,x),c(7,H),c(8,W),c(9,R),c(10,y),c(11,v),c(12,M),c(13,q),c(14,T),c(15,N)],u);let a,l,i;setup(()=>{a=new X;const r={_serviceBrand:void 0,...ie};a.add(l=ne(a,[[P,u],[T,ve],[H,Ie],[b,te],[M,ge],[v,g],[me,Ne],[y,Ee],[R,Y],[W,We],[x,r],[L,Le],[h,qe],[I,ce],[ee,Re],[pe,we],[ue,le],[fe,xe],[ae,se],[q,be],[N,new re(!1,void 0,void 0,void 0,r,new g)]])),i=l.get(P)}),teardown(async()=>{a.dispose()}),w(),test("issue #152204: Remote extension host not disposed after closing vscode client",async()=>{await i.startExtensionHosts(),await i.stopExtensionHosts("foo"),e.deepStrictEqual(i.order,["create 1","create 2","create 3","dispose 3","dispose 2","dispose 1"])}),test("Extension host disposed when awaited",async()=>{await i.startExtensionHosts(),await i.stopExtensionHosts("foo"),e.deepStrictEqual(i.order,["create 1","create 2","create 3","dispose 3","dispose 2","dispose 1"])}),test("Extension host not disposed when vetoed (sync)",async()=>{await i.startExtensionHosts(),a.add(i.onWillStop(r=>r.veto(!0,"test 1"))),a.add(i.onWillStop(r=>r.veto(!1,"test 2"))),await i.stopExtensionHosts("foo"),e.deepStrictEqual(i.order,["create 1","create 2","create 3"])}),test("Extension host not disposed when vetoed (async)",async()=>{await i.startExtensionHosts(),a.add(i.onWillStop(r=>r.veto(!1,"test 1"))),a.add(i.onWillStop(r=>r.veto(Promise.resolve(!0),"test 2"))),a.add(i.onWillStop(r=>r.veto(Promise.resolve(!1),"test 3"))),await i.stopExtensionHosts("foo"),e.deepStrictEqual(i.order,["create 1","create 2","create 3"])})});
