var E=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var u=(s,n,e,t)=>{for(var i=t>1?void 0:t?p(n,e):n,o=s.length-1,l;o>=0;o--)(l=s[o])&&(i=(t?l(n,e,i):l(i))||i);return t&&i&&E(n,e,i),i},c=(s,n)=>(e,t)=>n(e,t,s);import{URI as g}from"../../../../base/common/uri.js";import{createDecorator as h,IInstantiationService as T}from"../../../../platform/instantiation/common/instantiation.js";import{UntitledTextEditorModel as U}from"./untitledTextEditorModel.js";import"../../../../platform/files/common/files.js";import{IConfigurationService as x}from"../../../../platform/configuration/common/configuration.js";import{Event as I,Emitter as d}from"../../../../base/common/event.js";import{ResourceMap as D}from"../../../../base/common/map.js";import{Schemas as a}from"../../../../base/common/network.js";import{Disposable as f,DisposableStore as R}from"../../../../base/common/lifecycle.js";import{InstantiationType as M,registerSingleton as v}from"../../../../platform/instantiation/common/extensions.js";const y=h("untitledTextEditorService");let r=class extends f{constructor(e,t){super();this.instantiationService=e;this.configurationService=t}static UNTITLED_WITHOUT_ASSOCIATED_RESOURCE_REGEX=/Untitled-\d+/;_onDidChangeDirty=this._register(new d);onDidChangeDirty=this._onDidChangeDirty.event;_onDidChangeEncoding=this._register(new d);onDidChangeEncoding=this._onDidChangeEncoding.event;_onDidCreate=this._register(new d);onDidCreate=this._onDidCreate.event;_onWillDispose=this._register(new d);onWillDispose=this._onWillDispose.event;_onDidChangeLabel=this._register(new d);onDidChangeLabel=this._onDidChangeLabel.event;mapResourceToModel=new D;get(e){return this.mapResourceToModel.get(e)}getValue(e){return this.get(e)?.textEditorModel?.getValue()}async resolve(e){const t=this.doCreateOrGet(e);return await t.resolve(),t}create(e){return this.doCreateOrGet(e)}doCreateOrGet(e=Object.create(null)){const t=this.massageOptions(e);return t.untitledResource&&this.mapResourceToModel.has(t.untitledResource)?this.mapResourceToModel.get(t.untitledResource):this.doCreate(t)}massageOptions(e){const t=Object.create(null);if(e.associatedResource?(t.untitledResource=g.from({scheme:a.untitled,authority:e.associatedResource.authority,fragment:e.associatedResource.fragment,path:e.associatedResource.path,query:e.associatedResource.query}),t.associatedResource=e.associatedResource):e.untitledResource?.scheme===a.untitled&&(t.untitledResource=e.untitledResource),e.languageId)t.languageId=e.languageId;else if(!t.associatedResource){const i=this.configurationService.getValue();i.files?.defaultLanguage&&(t.languageId=i.files.defaultLanguage)}return t.encoding=e.encoding,t.initialValue=e.initialValue,t}doCreate(e){let t=e.untitledResource;if(!t){let o=1;do t=g.from({scheme:a.untitled,path:`Untitled-${o}`}),o++;while(this.mapResourceToModel.has(t))}const i=this._register(this.instantiationService.createInstance(U,t,!!e.associatedResource,e.initialValue,e.languageId,e.encoding));return this.registerModel(i),i}registerModel(e){const t=new R;t.add(e.onDidChangeDirty(()=>this._onDidChangeDirty.fire(e))),t.add(e.onDidChangeName(()=>this._onDidChangeLabel.fire(e))),t.add(e.onDidChangeEncoding(()=>this._onDidChangeEncoding.fire(e))),t.add(e.onWillDispose(()=>this._onWillDispose.fire(e))),I.once(e.onWillDispose)(()=>{this.mapResourceToModel.delete(e.resource),t.dispose()}),this.mapResourceToModel.set(e.resource,e),this._onDidCreate.fire(e),e.isDirty()&&this._onDidChangeDirty.fire(e)}isUntitledWithAssociatedResource(e){return e.scheme===a.untitled&&e.path.length>1&&!r.UNTITLED_WITHOUT_ASSOCIATED_RESOURCE_REGEX.test(e.path)}canDispose(e){return e.isDisposed()?!0:this.doCanDispose(e)}async doCanDispose(e){return e.isDirty()?(await I.toPromise(e.onDidChangeDirty),this.canDispose(e)):!0}};r=u([c(0,T),c(1,x)],r),v(y,r,M.Delayed);export{y as IUntitledTextEditorService,r as UntitledTextEditorService};
