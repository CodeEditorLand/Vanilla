var I=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var u=(s,n,e,t)=>{for(var i=t>1?void 0:t?E(n,e):n,r=s.length-1,l;r>=0;r--)(l=s[r])&&(i=(t?l(n,e,i):l(i))||i);return t&&i&&I(n,e,i),i},c=(s,n)=>(e,t)=>n(e,t,s);import{Emitter as d,Event as g}from"../../../../base/common/event.js";import{Disposable as h,DisposableStore as T}from"../../../../base/common/lifecycle.js";import{ResourceMap as U}from"../../../../base/common/map.js";import{Schemas as a}from"../../../../base/common/network.js";import{URI as p}from"../../../../base/common/uri.js";import{IConfigurationService as x}from"../../../../platform/configuration/common/configuration.js";import{InstantiationType as f,registerSingleton as D}from"../../../../platform/instantiation/common/extensions.js";import{IInstantiationService as R,createDecorator as y}from"../../../../platform/instantiation/common/instantiation.js";import{UntitledTextEditorModel as M}from"./untitledTextEditorModel.js";const m=y("untitledTextEditorService");let o=class extends h{constructor(e,t){super();this.instantiationService=e;this.configurationService=t}static UNTITLED_WITHOUT_ASSOCIATED_RESOURCE_REGEX=/Untitled-\d+/;_onDidChangeDirty=this._register(new d);onDidChangeDirty=this._onDidChangeDirty.event;_onDidChangeEncoding=this._register(new d);onDidChangeEncoding=this._onDidChangeEncoding.event;_onDidCreate=this._register(new d);onDidCreate=this._onDidCreate.event;_onWillDispose=this._register(new d);onWillDispose=this._onWillDispose.event;_onDidChangeLabel=this._register(new d);onDidChangeLabel=this._onDidChangeLabel.event;mapResourceToModel=new U;get(e){return this.mapResourceToModel.get(e)}getValue(e){return this.get(e)?.textEditorModel?.getValue()}async resolve(e){const t=this.doCreateOrGet(e);return await t.resolve(),t}create(e){return this.doCreateOrGet(e)}doCreateOrGet(e=Object.create(null)){const t=this.massageOptions(e);return t.untitledResource&&this.mapResourceToModel.has(t.untitledResource)?this.mapResourceToModel.get(t.untitledResource):this.doCreate(t)}massageOptions(e){const t=Object.create(null);if(e.associatedResource?(t.untitledResource=p.from({scheme:a.untitled,authority:e.associatedResource.authority,fragment:e.associatedResource.fragment,path:e.associatedResource.path,query:e.associatedResource.query}),t.associatedResource=e.associatedResource):e.untitledResource?.scheme===a.untitled&&(t.untitledResource=e.untitledResource),e.languageId)t.languageId=e.languageId;else if(!t.associatedResource){const i=this.configurationService.getValue();i.files?.defaultLanguage&&(t.languageId=i.files.defaultLanguage)}return t.encoding=e.encoding,t.initialValue=e.initialValue,t}doCreate(e){let t=e.untitledResource;if(!t){let r=1;do t=p.from({scheme:a.untitled,path:`Untitled-${r}`}),r++;while(this.mapResourceToModel.has(t))}const i=this._register(this.instantiationService.createInstance(M,t,!!e.associatedResource,e.initialValue,e.languageId,e.encoding));return this.registerModel(i),i}registerModel(e){const t=new T;t.add(e.onDidChangeDirty(()=>this._onDidChangeDirty.fire(e))),t.add(e.onDidChangeName(()=>this._onDidChangeLabel.fire(e))),t.add(e.onDidChangeEncoding(()=>this._onDidChangeEncoding.fire(e))),t.add(e.onWillDispose(()=>this._onWillDispose.fire(e))),g.once(e.onWillDispose)(()=>{this.mapResourceToModel.delete(e.resource),t.dispose()}),this.mapResourceToModel.set(e.resource,e),this._onDidCreate.fire(e),e.isDirty()&&this._onDidChangeDirty.fire(e)}isUntitledWithAssociatedResource(e){return e.scheme===a.untitled&&e.path.length>1&&!o.UNTITLED_WITHOUT_ASSOCIATED_RESOURCE_REGEX.test(e.path)}canDispose(e){return e.isDisposed()?!0:this.doCanDispose(e)}async doCanDispose(e){return e.isDirty()?(await g.toPromise(e.onDidChangeDirty),this.canDispose(e)):!0}};o=u([c(0,R),c(1,x)],o),D(m,o,f.Delayed);export{m as IUntitledTextEditorService,o as UntitledTextEditorService};
