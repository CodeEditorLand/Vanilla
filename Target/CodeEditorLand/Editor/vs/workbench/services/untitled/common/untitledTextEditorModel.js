var C=Object.defineProperty;var m=Object.getOwnPropertyDescriptor;var l=(g,a,e,t)=>{for(var i=t>1?void 0:t?m(a,e):a,n=g.length-1,s;n>=0;n--)(s=g[n])&&(i=(t?s(a,e,i):s(i))||i);return t&&i&&C(a,e,i),i},r=(g,a)=>(e,t)=>a(e,t,g);import"../../../common/editor.js";import{BaseTextEditorModel as y}from"../../../common/editor/textEditorModel.js";import"../../../../base/common/uri.js";import{ILanguageService as I}from"../../../../editor/common/languages/language.js";import{IModelService as E}from"../../../../editor/common/services/model.js";import{Emitter as d}from"../../../../base/common/event.js";import{IWorkingCopyBackupService as S}from"../../workingCopy/common/workingCopyBackup.js";import{ITextResourceConfigurationService as D}from"../../../../editor/common/services/textResourceConfiguration.js";import"../../../../editor/common/model.js";import{createTextBufferFactory as L,createTextBufferFactoryFromStream as _}from"../../../../editor/common/model/textModel.js";import"../../../../editor/common/services/resolverService.js";import{IWorkingCopyService as F}from"../../workingCopy/common/workingCopyService.js";import{WorkingCopyCapabilities as b,NO_TYPE_ID as M}from"../../workingCopy/common/workingCopy.js";import{ITextFileService as T}from"../../textfile/common/textfiles.js";import"../../../../editor/common/textModelEvents.js";import{assertIsDefined as N}from"../../../../base/common/types.js";import{ILabelService as A}from"../../../../platform/label/common/label.js";import{ensureValidWordDefinition as x}from"../../../../editor/common/core/wordHelper.js";import{IEditorService as R}from"../../editor/common/editorService.js";import"../../../../base/common/cancellation.js";import{getCharContainingOffset as k}from"../../../../base/common/strings.js";import{UTF8 as h}from"../../textfile/common/encoding.js";import{bufferToReadable as V,bufferToStream as W,VSBuffer as u}from"../../../../base/common/buffer.js";import{ILanguageDetectionService as w}from"../../languageDetection/common/languageDetectionWorkerService.js";import{IAccessibilityService as B}from"../../../../platform/accessibility/common/accessibility.js";let o=class extends y{constructor(e,t,i,n,s,c,f,P,G,O,H,X,U,v,p){super(f,c,v,p);this.resource=e;this.hasAssociatedFilePath=t;this.initialValue=i;this.preferredLanguageId=n;this.preferredEncoding=s;this.workingCopyBackupService=P;this.textResourceConfigurationService=G;this.workingCopyService=O;this.textFileService=H;this.labelService=X;this.editorService=U;this._register(this.workingCopyService.registerWorkingCopy(this)),n&&this.setLanguageId(n),this.onConfigurationChange(void 0,!1),this.registerListeners()}static FIRST_LINE_NAME_MAX_LENGTH=40;static FIRST_LINE_NAME_CANDIDATE_MAX_LENGTH=this.FIRST_LINE_NAME_MAX_LENGTH*10;static ACTIVE_EDITOR_LANGUAGE_ID="${activeEditorLanguage}";_onDidChangeContent=this._register(new d);onDidChangeContent=this._onDidChangeContent.event;_onDidChangeName=this._register(new d);onDidChangeName=this._onDidChangeName.event;_onDidChangeDirty=this._register(new d);onDidChangeDirty=this._onDidChangeDirty.event;_onDidChangeEncoding=this._register(new d);onDidChangeEncoding=this._onDidChangeEncoding.event;_onDidSave=this._register(new d);onDidSave=this._onDidSave.event;_onDidRevert=this._register(new d);onDidRevert=this._onDidRevert.event;typeId=M;capabilities=b.Untitled;configuredLabelFormat="content";cachedModelFirstLineWords=void 0;get name(){return this.configuredLabelFormat==="content"&&!this.hasAssociatedFilePath&&this.cachedModelFirstLineWords?this.cachedModelFirstLineWords:this.labelService.getUriBasenameLabel(this.resource)}registerListeners(){this._register(this.textResourceConfigurationService.onDidChangeConfiguration(e=>this.onConfigurationChange(e,!0)))}onConfigurationChange(e,t){if(!e||e.affectsConfiguration(this.resource,"files.encoding")){const i=this.textResourceConfigurationService.getValue(this.resource,"files.encoding");this.configuredEncoding!==i&&typeof i=="string"&&(this.configuredEncoding=i,t&&!this.preferredEncoding&&this._onDidChangeEncoding.fire())}if(!e||e.affectsConfiguration(this.resource,"workbench.editor.untitled.labelFormat")){const i=this.textResourceConfigurationService.getValue(this.resource,"workbench.editor.untitled.labelFormat");this.configuredLabelFormat!==i&&(i==="content"||i==="name")&&(this.configuredLabelFormat=i,t&&this._onDidChangeName.fire())}}setLanguageId(e,t){const i=e===o.ACTIVE_EDITOR_LANGUAGE_ID?this.editorService.activeTextEditorLanguageId:e;this.preferredLanguageId=i,i&&super.setLanguageId(i,t)}getLanguageId(){return this.textEditorModel?this.textEditorModel.getLanguageId():this.preferredLanguageId}configuredEncoding;getEncoding(){return this.preferredEncoding||this.configuredEncoding}async setEncoding(e){const t=this.getEncoding();this.preferredEncoding=e,t!==this.preferredEncoding&&this._onDidChangeEncoding.fire()}dirty=this.hasAssociatedFilePath||!!this.initialValue;isDirty(){return this.dirty}isModified(){return this.isDirty()}setDirty(e){this.dirty!==e&&(this.dirty=e,this._onDidChangeDirty.fire())}async save(e){const t=await this.textFileService.save(this.resource,e);return t&&this._onDidSave.fire({reason:e?.reason,source:e?.source}),!!t}async revert(){this.ignoreDirtyOnModelContentChange=!0;try{this.updateTextEditorModel(L(""))}finally{this.ignoreDirtyOnModelContentChange=!1}this.setDirty(!1),this._onDidRevert.fire()}async backup(e){let t;return this.isResolved()?t=await this.textFileService.getEncodedReadable(this.resource,this.createSnapshot()??void 0,{encoding:h}):typeof this.initialValue=="string"&&(t=V(u.fromString(this.initialValue))),{content:t}}ignoreDirtyOnModelContentChange=!1;async resolve(){let e=!1,t=!1;if(this.textEditorModel)this.updateTextEditorModel(void 0,this.preferredLanguageId);else{let n;const s=await this.workingCopyBackupService.resolve(this);s?(n=s.value,t=!0):n=W(u.fromString(this.initialValue||""));const c=await _(await this.textFileService.getDecodedStream(this.resource,n,{encoding:h}));this.createTextEditorModel(c,this.resource,this.preferredLanguageId),e=!0}const i=N(this.textEditorModel);return this.installModelListeners(i),e&&((t||this.initialValue)&&this.updateNameFromFirstLine(i),this.setDirty(this.hasAssociatedFilePath||!!t||!!this.initialValue),(t||this.initialValue)&&this._onDidChangeContent.fire()),super.resolve()}installModelListeners(e){this._register(e.onDidChangeContent(t=>this.onModelContentChanged(e,t))),this._register(e.onDidChangeLanguage(()=>this.onConfigurationChange(void 0,!0))),super.installModelListeners(e)}onModelContentChanged(e,t){this.ignoreDirtyOnModelContentChange||(!this.hasAssociatedFilePath&&e.getLineCount()===1&&e.getLineLength(1)===0?this.setDirty(!1):this.setDirty(!0)),t.changes.some(i=>(i.range.startLineNumber===1||i.range.endLineNumber===1)&&i.range.startColumn<=o.FIRST_LINE_NAME_CANDIDATE_MAX_LENGTH)&&this.updateNameFromFirstLine(e),this._onDidChangeContent.fire(),this.autoDetectLanguage()}updateNameFromFirstLine(e){if(this.hasAssociatedFilePath)return;let t,i=e.getValueInRange({startLineNumber:1,endLineNumber:1,startColumn:1,endColumn:o.FIRST_LINE_NAME_CANDIDATE_MAX_LENGTH+1}).trim().replace(/\s+/g," ").replace(/\u202E/g,"");i=i.substr(0,k(i,o.FIRST_LINE_NAME_MAX_LENGTH)[0]),i&&x().exec(i)&&(t=i),t!==this.cachedModelFirstLineWords&&(this.cachedModelFirstLineWords=t,this._onDidChangeName.fire())}isReadonly(){return!1}};o=l([r(5,I),r(6,E),r(7,S),r(8,D),r(9,F),r(10,T),r(11,A),r(12,R),r(13,w),r(14,B)],o);export{o as UntitledTextEditorModel};
