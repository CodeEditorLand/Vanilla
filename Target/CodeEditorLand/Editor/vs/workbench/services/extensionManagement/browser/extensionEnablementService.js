var L=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var I=(p,b,e,n)=>{for(var t=n>1?void 0:n?O(b,e):b,i=p.length-1,s;i>=0;i--)(s=p[i])&&(t=(n?s(b,e,t):s(t))||t);return n&&t&&L(b,e,t),t},c=(p,b)=>(e,n)=>b(e,n,p);import{localize as d}from"../../../../nls.js";import{Event as _,Emitter as W}from"../../../../base/common/event.js";import{Disposable as D,toDisposable as M}from"../../../../base/common/lifecycle.js";import{IExtensionManagementService as z,IGlobalExtensionEnablementService as F,ENABLED_EXTENSIONS_STORAGE_PATH as C,DISABLED_EXTENSIONS_STORAGE_PATH as w,InstallOperation as K}from"../../../../platform/extensionManagement/common/extensionManagement.js";import{IWorkbenchExtensionEnablementService as V,EnablementState as a,IExtensionManagementServerService as T,IWorkbenchExtensionManagementService as q,ExtensionInstallLocation as v}from"../common/extensionManagement.js";import{areSameExtensions as E,BetterMergeId as H,getExtensionDependencies as B}from"../../../../platform/extensionManagement/common/extensionManagementUtil.js";import{IWorkspaceContextService as X,WorkbenchState as Y}from"../../../../platform/workspace/common/workspace.js";import{IStorageService as j,StorageScope as P}from"../../../../platform/storage/common/storage.js";import{IWorkbenchEnvironmentService as J}from"../../environment/common/environmentService.js";import{isAuthenticationProviderExtension as R,isLanguagePackExtension as Q,isResolverExtension as Z}from"../../../../platform/extensions/common/extensions.js";import{IConfigurationService as $}from"../../../../platform/configuration/common/configuration.js";import{InstantiationType as ee,registerSingleton as ne}from"../../../../platform/instantiation/common/extensions.js";import{StorageManager as te}from"../../../../platform/extensionManagement/common/extensionEnablementService.js";import{webWorkerExtHostConfig as ie}from"../../extensions/common/extensions.js";import{IUserDataSyncAccountService as se}from"../../../../platform/userDataSync/common/userDataSyncAccount.js";import{IUserDataSyncEnablementService as ae}from"../../../../platform/userDataSync/common/userDataSync.js";import{ILifecycleService as re,LifecyclePhase as oe}from"../../lifecycle/common/lifecycle.js";import{INotificationService as le,NotificationPriority as ce,Severity as Ee}from"../../../../platform/notification/common/notification.js";import{IHostService as de}from"../../host/browser/host.js";import{IExtensionBisectService as be}from"./extensionBisect.js";import{IWorkspaceTrustManagementService as he,IWorkspaceTrustRequestService as me}from"../../../../platform/workspace/common/workspaceTrust.js";import{IExtensionManifestPropertiesService as fe}from"../../extensions/common/extensionManifestPropertiesService.js";import{isVirtualWorkspace as pe}from"../../../../platform/workspace/common/virtualWorkspace.js";import{ILogService as ve}from"../../../../platform/log/common/log.js";import{IInstantiationService as xe}from"../../../../platform/instantiation/common/instantiation.js";const y="IWorkbenchExtensionEnablementService";let x=class extends D{constructor(e,n,t,i,s,l,o,r,g,h,m,A,ue,ge,Se,Ie,N){super();this.globalExtensionEnablementService=n;this.contextService=t;this.environmentService=i;this.configurationService=l;this.extensionManagementServerService=o;this.userDataSyncEnablementService=r;this.userDataSyncAccountService=g;this.lifecycleService=h;this.notificationService=m;this.extensionBisectService=ue;this.workspaceTrustManagementService=ge;this.workspaceTrustRequestService=Se;this.extensionManifestPropertiesService=Ie;this.storageManager=this._register(new te(e));const G=this._register(_.filter(s.onDidUninstallExtension,f=>!f.error)(({identifier:f})=>this._reset(f)));let k=!1;this._register(M(()=>k=!0)),this.extensionsManager=this._register(N.createInstance(u)),this.extensionsManager.whenInitialized().then(()=>{k||(this._register(this.extensionsManager.onDidChangeExtensions(({added:f,removed:S,isProfileSwitch:U})=>this._onDidChangeExtensions(f,S,U))),G.dispose())}),this._register(this.globalExtensionEnablementService.onDidChangeEnablement(({extensions:f,source:S})=>this._onDidChangeGloballyDisabledExtensions(f,S))),this.allUserExtensionsDisabled&&this.lifecycleService.when(oe.Eventually).then(()=>{this.notificationService.prompt(Ee.Info,d("extensionsDisabled","All installed extensions are temporarily disabled."),[{label:d("Reload","Reload and Enable Extensions"),run:()=>A.reload({disableExtensions:!1})}],{sticky:!0,priority:ce.URGENT})})}_onEnablementChanged=new W;onEnablementChanged=this._onEnablementChanged.event;extensionsManager;storageManager;get hasWorkspace(){return this.contextService.getWorkbenchState()!==Y.EMPTY}get allUserExtensionsDisabled(){return this.environmentService.disableExtensions===!0}getEnablementState(e){return this._computeEnablementState(e,this.extensionsManager.extensions,this.getWorkspaceType())}getEnablementStates(e,n={}){const t=new Map,i={...this.getWorkspaceType(),...n};return e.map(s=>this._computeEnablementState(s,e,i,t))}getDependenciesEnablementStates(e){return B(this.extensionsManager.extensions,e).map(n=>[n,this.getEnablementState(n)])}canChangeEnablement(e){try{return this.throwErrorIfCannotChangeEnablement(e),!0}catch{return!1}}canChangeWorkspaceEnablement(e){if(!this.canChangeEnablement(e))return!1;try{return this.throwErrorIfCannotChangeWorkspaceEnablement(e),!0}catch{return!1}}throwErrorIfCannotChangeEnablement(e,n){if(Q(e.manifest))throw new Error(d("cannot disable language pack extension","Cannot change enablement of {0} extension because it contributes language packs.",e.manifest.displayName||e.identifier.id));if(this.userDataSyncEnablementService.isEnabled()&&this.userDataSyncAccountService.account&&R(e.manifest)&&e.manifest.contributes.authentication.some(t=>t.id===this.userDataSyncAccountService.account.authenticationProviderId))throw new Error(d("cannot disable auth extension","Cannot change enablement {0} extension because Settings Sync depends on it.",e.manifest.displayName||e.identifier.id));if(this._isEnabledInEnv(e))throw new Error(d("cannot change enablement environment","Cannot change enablement of {0} extension because it is enabled in environment",e.manifest.displayName||e.identifier.id));this.throwErrorIfEnablementStateCannotBeChanged(e,this.getEnablementState(e),n)}throwErrorIfEnablementStateCannotBeChanged(e,n,t){switch(n){case a.DisabledByEnvironment:throw new Error(d("cannot change disablement environment","Cannot change enablement of {0} extension because it is disabled in environment",e.manifest.displayName||e.identifier.id));case a.DisabledByVirtualWorkspace:throw new Error(d("cannot change enablement virtual workspace","Cannot change enablement of {0} extension because it does not support virtual workspaces",e.manifest.displayName||e.identifier.id));case a.DisabledByExtensionKind:throw new Error(d("cannot change enablement extension kind","Cannot change enablement of {0} extension because of its extension kind",e.manifest.displayName||e.identifier.id));case a.DisabledByExtensionDependency:if(t)break;for(const i of B(this.extensionsManager.extensions,e))if(!this.isEnabled(i))try{this.throwErrorIfCannotChangeEnablement(i,!0)}catch{throw new Error(d("cannot change enablement dependency","Cannot enable '{0}' extension because it depends on '{1}' extension that cannot be enabled",e.manifest.displayName||e.identifier.id,i.manifest.displayName||i.identifier.id))}}}throwErrorIfCannotChangeWorkspaceEnablement(e){if(!this.hasWorkspace)throw new Error(d("noWorkspace","No workspace."));if(R(e.manifest))throw new Error(d("cannot disable auth extension in workspace","Cannot change enablement of {0} extension in workspace because it contributes authentication providers",e.manifest.displayName||e.identifier.id))}async setEnablement(e,n){await this.extensionsManager.whenInitialized(),(n===a.EnabledGlobally||n===a.EnabledWorkspace)&&e.push(...this.getExtensionsToEnableRecursively(e,this.extensionsManager.extensions,n,{dependencies:!0,pack:!0}));const t=n===a.DisabledWorkspace||n===a.EnabledWorkspace;for(const l of e)t?this.throwErrorIfCannotChangeWorkspaceEnablement(l):this.throwErrorIfCannotChangeEnablement(l);const i=[];for(const l of e){const o=this.getEnablementState(l);if(o===a.DisabledByTrustRequirement||o===a.DisabledByExtensionDependency&&this.getDependenciesEnablementStates(l).every(([,r])=>this.isEnabledEnablementState(r)||r===a.DisabledByTrustRequirement)){const r=await this.workspaceTrustRequestService.requestWorkspaceTrust();i.push(r??!1)}else i.push(await this._setUserEnablementState(l,n))}const s=e.filter((l,o)=>i[o]);return s.length&&this._onEnablementChanged.fire(s),i}getExtensionsToEnableRecursively(e,n,t,i,s=[]){if(!i.dependencies&&!i.pack)return[];const l=e.filter(r=>s.indexOf(r)===-1);if(!l.length)return[];for(const r of l)s.push(r);const o=[];for(const r of n){if(s.some(h=>E(h.identifier,r.identifier)))continue;const g=this.getEnablementState(r);if(!this.isEnabledEnablementState(g)&&g!==a.DisabledByExtensionKind&&e.some(h=>i.dependencies&&h.manifest.extensionDependencies?.some(m=>E({id:m},r.identifier))||i.pack&&h.manifest.extensionPack?.some(m=>E({id:m},r.identifier)))){const h=o.findIndex(m=>E(m.identifier,r.identifier));if(h===-1)o.push(r);else try{this.throwErrorIfEnablementStateCannotBeChanged(r,g,!0),o.splice(h,1,r)}catch{}}}return o.length&&o.push(...this.getExtensionsToEnableRecursively(o,n,t,i,s)),o}_setUserEnablementState(e,n){if(this._getUserEnablementState(e.identifier)===n)return Promise.resolve(!1);switch(n){case a.EnabledGlobally:this._enableExtension(e.identifier);break;case a.DisabledGlobally:this._disableExtension(e.identifier);break;case a.EnabledWorkspace:this._enableExtensionInWorkspace(e.identifier);break;case a.DisabledWorkspace:this._disableExtensionInWorkspace(e.identifier);break}return Promise.resolve(!0)}isEnabled(e){const n=this.getEnablementState(e);return this.isEnabledEnablementState(n)}isEnabledEnablementState(e){return e===a.EnabledByEnvironment||e===a.EnabledWorkspace||e===a.EnabledGlobally}isDisabledGlobally(e){return this._isDisabledGlobally(e.identifier)}_computeEnablementState(e,n,t,i){i=i??new Map;let s=i.get(e);return s!==void 0||(s=this._getUserEnablementState(e.identifier),this.extensionBisectService.isDisabledByBisect(e)?s=a.DisabledByEnvironment:this._isDisabledInEnv(e)?s=a.DisabledByEnvironment:this._isDisabledByVirtualWorkspace(e,t)?s=a.DisabledByVirtualWorkspace:this.isEnabledEnablementState(s)&&this._isDisabledByWorkspaceTrust(e,t)?s=a.DisabledByTrustRequirement:this._isDisabledByExtensionKind(e)?s=a.DisabledByExtensionKind:this.isEnabledEnablementState(s)&&this._isDisabledByExtensionDependency(e,n,t,i)?s=a.DisabledByExtensionDependency:!this.isEnabledEnablementState(s)&&this._isEnabledInEnv(e)&&(s=a.EnabledByEnvironment),i.set(e,s)),s}_isDisabledInEnv(e){if(this.allUserExtensionsDisabled)return!e.isBuiltin&&!Z(e.manifest,this.environmentService.remoteAuthority);const n=this.environmentService.disableExtensions;return Array.isArray(n)?n.some(t=>E({id:t},e.identifier)):!!E({id:H.value},e.identifier)}_isEnabledInEnv(e){const n=this.environmentService.enableExtensions;return Array.isArray(n)?n.some(t=>E({id:t},e.identifier)):!1}_isDisabledByVirtualWorkspace(e,n){return!(!n.virtual||this.extensionManifestPropertiesService.getExtensionVirtualWorkspaceSupportType(e.manifest)!==!1||this.extensionManagementServerService.getExtensionManagementServer(e)===this.extensionManagementServerService.webExtensionManagementServer&&this.extensionManifestPropertiesService.canExecuteOnWeb(e.manifest))}_isDisabledByExtensionKind(e){if(this.extensionManagementServerService.remoteExtensionManagementServer||this.extensionManagementServerService.webExtensionManagementServer){const n=this.extensionManagementServerService.getExtensionInstallLocation(e);for(const t of this.extensionManifestPropertiesService.getExtensionKind(e.manifest)){if(t==="ui"&&n===v.Local||t==="workspace"&&n===v.Remote)return!1;if(t==="web"){if(this.extensionManagementServerService.webExtensionManagementServer){if(n===v.Web||n===v.Remote)return!1}else if(n===v.Local){const i=this.configurationService.getValue(ie);if(i===!0||i==="auto")return!1}}}return!0}return!1}_isDisabledByWorkspaceTrust(e,n){return n.trusted?!1:this.contextService.isInsideWorkspace(e.location)?!0:this.extensionManifestPropertiesService.getExtensionUntrustedWorkspaceSupportType(e.manifest)===!1}_isDisabledByExtensionDependency(e,n,t,i){const s=e.manifest.extensionDependencies?n.filter(o=>e.manifest.extensionDependencies.some(r=>E(o.identifier,{id:r})&&this.extensionManagementServerService.getExtensionManagementServer(o)===this.extensionManagementServerService.getExtensionManagementServer(e))):[];if(!s.length)return!1;const l=i.has(e);l||i.set(e,a.EnabledGlobally);try{for(const o of s){const r=this._computeEnablementState(o,n,t,i);if(!this.isEnabledEnablementState(r)&&r!==a.DisabledByExtensionKind)return!0}}finally{l||i.delete(e)}return!1}_getUserEnablementState(e){if(this.hasWorkspace){if(this._getWorkspaceEnabledExtensions().filter(n=>E(n,e))[0])return a.EnabledWorkspace;if(this._getWorkspaceDisabledExtensions().filter(n=>E(n,e))[0])return a.DisabledWorkspace}return this._isDisabledGlobally(e)?a.DisabledGlobally:a.EnabledGlobally}_isDisabledGlobally(e){return this.globalExtensionEnablementService.getDisabledExtensions().some(n=>E(n,e))}_enableExtension(e){return this._removeFromWorkspaceDisabledExtensions(e),this._removeFromWorkspaceEnabledExtensions(e),this.globalExtensionEnablementService.enableExtension(e,y)}_disableExtension(e){return this._removeFromWorkspaceDisabledExtensions(e),this._removeFromWorkspaceEnabledExtensions(e),this.globalExtensionEnablementService.disableExtension(e,y)}_enableExtensionInWorkspace(e){this._removeFromWorkspaceDisabledExtensions(e),this._addToWorkspaceEnabledExtensions(e)}_disableExtensionInWorkspace(e){this._addToWorkspaceDisabledExtensions(e),this._removeFromWorkspaceEnabledExtensions(e)}_addToWorkspaceDisabledExtensions(e){if(!this.hasWorkspace)return Promise.resolve(!1);const n=this._getWorkspaceDisabledExtensions();return n.every(t=>!E(t,e))?(n.push(e),this._setDisabledExtensions(n),Promise.resolve(!0)):Promise.resolve(!1)}async _removeFromWorkspaceDisabledExtensions(e){if(!this.hasWorkspace)return!1;const n=this._getWorkspaceDisabledExtensions();for(let t=0;t<n.length;t++){const i=n[t];if(E(i,e))return n.splice(t,1),this._setDisabledExtensions(n),!0}return!1}_addToWorkspaceEnabledExtensions(e){if(!this.hasWorkspace)return!1;const n=this._getWorkspaceEnabledExtensions();return n.every(t=>!E(t,e))?(n.push(e),this._setEnabledExtensions(n),!0):!1}_removeFromWorkspaceEnabledExtensions(e){if(!this.hasWorkspace)return!1;const n=this._getWorkspaceEnabledExtensions();for(let t=0;t<n.length;t++){const i=n[t];if(E(i,e))return n.splice(t,1),this._setEnabledExtensions(n),!0}return!1}_getWorkspaceEnabledExtensions(){return this._getExtensions(C)}_setEnabledExtensions(e){this._setExtensions(C,e)}_getWorkspaceDisabledExtensions(){return this._getExtensions(w)}_setDisabledExtensions(e){this._setExtensions(w,e)}_getExtensions(e){return this.hasWorkspace?this.storageManager.get(e,P.WORKSPACE):[]}_setExtensions(e,n){this.storageManager.set(e,n,P.WORKSPACE)}async _onDidChangeGloballyDisabledExtensions(e,n){if(n!==y){await this.extensionsManager.whenInitialized();const t=this.extensionsManager.extensions.filter(i=>e.some(s=>E(s,i.identifier)));this._onEnablementChanged.fire(t)}}_onDidChangeExtensions(e,n,t){const i=e.filter(s=>!this.isEnabledEnablementState(this.getEnablementState(s)));i.length&&this._onEnablementChanged.fire(i),t||n.forEach(({identifier:s})=>this._reset(s))}async updateExtensionsEnablementsWhenWorkspaceTrustChanges(){await this.extensionsManager.whenInitialized();const e=l=>{const o=new Map;return this.extensionsManager.extensions.map(r=>[r,this._computeEnablementState(r,this.extensionsManager.extensions,l,o)])},n=this.getWorkspaceType(),t=e({...n,trusted:!0}),i=e({...n,trusted:!1}),s=t.filter(([,l],o)=>l!==i[o][1]).map(([l])=>l);s.length&&this._onEnablementChanged.fire(s)}getWorkspaceType(){return{trusted:this.workspaceTrustManagementService.isWorkspaceTrusted(),virtual:pe(this.contextService.getWorkspace())}}_reset(e){this._removeFromWorkspaceDisabledExtensions(e),this._removeFromWorkspaceEnabledExtensions(e),this.globalExtensionEnablementService.enableExtension(e)}};x=I([c(0,j),c(1,F),c(2,X),c(3,J),c(4,z),c(5,$),c(6,T),c(7,ae),c(8,se),c(9,re),c(10,le),c(11,de),c(12,be),c(13,he),c(14,me),c(15,fe),c(16,xe)],x);let u=class extends D{constructor(e,n,t){super();this.extensionManagementService=e;this.extensionManagementServerService=n;this.logService=t;this._register(M(()=>this.disposed=!0)),this.initializePromise=this.initialize()}_extensions=[];get extensions(){return this._extensions}_onDidChangeExtensions=this._register(new W);onDidChangeExtensions=this._onDidChangeExtensions.event;initializePromise;disposed=!1;whenInitialized(){return this.initializePromise}async initialize(){try{if(this._extensions=[...await this.extensionManagementService.getInstalled(),...await this.extensionManagementService.getInstalledWorkspaceExtensions(!0)],this.disposed)return;this._onDidChangeExtensions.fire({added:this.extensions,removed:[],isProfileSwitch:!1})}catch(e){this.logService.error(e)}this._register(this.extensionManagementService.onDidInstallExtensions(e=>this.updateExtensions(e.reduce((n,{local:t,operation:i})=>(t&&i!==K.Migrate&&n.push(t),n),[]),[],void 0,!1))),this._register(_.filter(this.extensionManagementService.onDidUninstallExtension,e=>!e.error)(e=>this.updateExtensions([],[e.identifier],e.server,!1))),this._register(this.extensionManagementService.onDidChangeProfile(({added:e,removed:n,server:t})=>{this.updateExtensions(e,n.map(({identifier:i})=>i),t,!0)}))}updateExtensions(e,n,t,i){e.length&&this._extensions.push(...e);const s=[];for(const l of n){const o=this._extensions.findIndex(r=>E(r.identifier,l)&&this.extensionManagementServerService.getExtensionManagementServer(r)===t);o!==-1&&s.push(...this._extensions.splice(o,1))}(e.length||s.length)&&this._onDidChangeExtensions.fire({added:e,removed:s,isProfileSwitch:i})}};u=I([c(0,q),c(1,T),c(2,ve)],u),ne(V,x,ee.Delayed);export{x as ExtensionEnablementService};
