var Q=Object.defineProperty;var Z=Object.getOwnPropertyDescriptor;var T=(f,p,e,n)=>{for(var t=n>1?void 0:n?Z(p,e):p,i=f.length-1,r;i>=0;i--)(r=f[i])&&(t=(n?r(p,e,t):r(t))||t);return n&&t&&Q(p,e,t),t},o=(f,p)=>(e,n)=>p(e,n,f);import{coalesce as ee}from"../../../../../vs/base/common/arrays.js";import{Promises as C}from"../../../../../vs/base/common/async.js";import{CancellationToken as _}from"../../../../../vs/base/common/cancellation.js";import{CancellationError as N,getErrorMessage as O}from"../../../../../vs/base/common/errors.js";import{Emitter as M,Event as w,EventMultiplexer as I}from"../../../../../vs/base/common/event.js";import{Disposable as K,DisposableStore as ne}from"../../../../../vs/base/common/lifecycle.js";import{Schemas as y}from"../../../../../vs/base/common/network.js";import F from"../../../../../vs/base/common/severity.js";import{isString as te,isUndefined as ie}from"../../../../../vs/base/common/types.js";import{URI as re}from"../../../../../vs/base/common/uri.js";import{localize as c}from"../../../../../vs/nls.js";import{ICommandService as se}from"../../../../../vs/platform/commands/common/commands.js";import{IConfigurationService as ae}from"../../../../../vs/platform/configuration/common/configuration.js";import{IDialogService as oe}from"../../../../../vs/platform/dialogs/common/dialogs.js";import{IDownloadService as le}from"../../../../../vs/platform/download/common/download.js";import{EXTENSION_INSTALL_SOURCE_CONTEXT as ce,ExtensionInstallSource as ve,ExtensionManagementError as Se,ExtensionManagementErrorCode as z,IExtensionGalleryService as me,InstallOperation as G}from"../../../../../vs/platform/extensionManagement/common/extensionManagement.js";import{areSameExtensions as k,computeTargetPlatform as xe}from"../../../../../vs/platform/extensionManagement/common/extensionManagementUtil.js";import{IExtensionsScannerService as j}from"../../../../../vs/platform/extensionManagement/common/extensionsScannerService.js";import{ExtensionType as $,getWorkspaceSupportTypeMessage as de,isLanguagePackExtension as U}from"../../../../../vs/platform/extensions/common/extensions.js";import{IFileService as X}from"../../../../../vs/platform/files/common/files.js";import{IInstantiationService as he}from"../../../../../vs/platform/instantiation/common/instantiation.js";import{ILogService as q}from"../../../../../vs/platform/log/common/log.js";import{IProductService as pe}from"../../../../../vs/platform/product/common/productService.js";import{IStorageService as Ee,StorageScope as A,StorageTarget as Y}from"../../../../../vs/platform/storage/common/storage.js";import{ITelemetryService as J}from"../../../../../vs/platform/telemetry/common/telemetry.js";import{IUriIdentityService as ge}from"../../../../../vs/platform/uriIdentity/common/uriIdentity.js";import{IUserDataSyncEnablementService as fe,SyncResource as ue}from"../../../../../vs/platform/userDataSync/common/userDataSync.js";import{IWorkspaceContextService as Ie,WorkbenchState as H}from"../../../../../vs/platform/workspace/common/workspace.js";import{IWorkspaceTrustRequestService as Me}from"../../../../../vs/platform/workspace/common/workspaceTrust.js";import{IExtensionManagementServerService as we}from"../../../../../vs/workbench/services/extensionManagement/common/extensionManagement.js";import{IExtensionManifestPropertiesService as ye}from"../../../../../vs/workbench/services/extensions/common/extensionManifestPropertiesService.js";import{IUserDataProfileService as Pe}from"../../../../../vs/workbench/services/userDataProfile/common/userDataProfile.js";function ke(f){return f.type==="gallery"}let b=class extends K{constructor(e,n,t,i,r,s,l,a,v,S,m,d,P,E,g){super();this.extensionManagementServerService=e;this.extensionGalleryService=n;this.userDataProfileService=t;this.configurationService=i;this.productService=r;this.downloadService=s;this.userDataSyncEnablementService=l;this.dialogService=a;this.workspaceTrustRequestService=v;this.extensionManifestPropertiesService=S;this.fileService=m;this.logService=d;this.instantiationService=P;this.extensionsScannerService=E;this.telemetryService=g;this.workspaceExtensionManagementService=this._register(this.instantiationService.createInstance(h)),this.onDidEnableExtensions=this.workspaceExtensionManagementService.onDidChangeInvalidExtensions,this.extensionManagementServerService.localExtensionManagementServer&&this.servers.push(this.extensionManagementServerService.localExtensionManagementServer),this.extensionManagementServerService.remoteExtensionManagementServer&&this.servers.push(this.extensionManagementServerService.remoteExtensionManagementServer),this.extensionManagementServerService.webExtensionManagementServer&&this.servers.push(this.extensionManagementServerService.webExtensionManagementServer);const R=this._register(new I);this._register(R.add(this._onInstallExtension.event)),this.onInstallExtension=R.event;const W=this._register(new I);this._register(W.add(this._onDidInstallExtensions.event)),this.onDidInstallExtensions=W.event;const D=this._register(new I);this._register(D.add(this._onUninstallExtension.event)),this.onUninstallExtension=D.event;const L=this._register(new I);this._register(L.add(this._onDidUninstallExtension.event)),this.onDidUninstallExtension=L.event;const V=this._register(new I);this.onDidUpdateExtensionMetadata=V.event;const B=this._register(new I);this.onDidChangeProfile=B.event;for(const x of this.servers)this._register(R.add(w.map(x.extensionManagementService.onInstallExtension,u=>({...u,server:x})))),this._register(W.add(x.extensionManagementService.onDidInstallExtensions)),this._register(D.add(w.map(x.extensionManagementService.onUninstallExtension,u=>({...u,server:x})))),this._register(L.add(w.map(x.extensionManagementService.onDidUninstallExtension,u=>({...u,server:x})))),this._register(V.add(x.extensionManagementService.onDidUpdateExtensionMetadata)),this._register(B.add(w.map(x.extensionManagementService.onDidChangeProfile,u=>({...u,server:x}))))}_onInstallExtension=this._register(new M);onInstallExtension;_onDidInstallExtensions=this._register(new M);onDidInstallExtensions;_onUninstallExtension=this._register(new M);onUninstallExtension;_onDidUninstallExtension=this._register(new M);onDidUninstallExtension;onDidUpdateExtensionMetadata;onDidChangeProfile;onDidEnableExtensions;servers=[];workspaceExtensionManagementService;async getInstalled(e,n,t){const i=[];return await Promise.all(this.servers.map(async r=>{const s=await r.extensionManagementService.getInstalled(e,n,t);if(r===this.getWorkspaceExtensionsServer()){const l=await this.getInstalledWorkspaceExtensions(!0);s.push(...l)}i.push(...s)})),i}uninstall(e,n){return this.uninstallExtensions([{extension:e,options:n}])}async uninstallExtensions(e){const n=[],t=new Map,i=(a,v,S)=>{let m=t.get(a);m||t.set(a,m=[]),m.push({extension:v,options:S})};for(const{extension:a,options:v}of e){if(a.isWorkspaceScoped){n.push(a);continue}const S=this.getServer(a);if(!S)throw new Error(`Invalid location ${a.location.toString()}`);if(i(S,a,v),this.servers.length>1&&U(a.manifest)){const m=this.servers.filter(d=>d!==S);for(const d of m){const E=(await d.extensionManagementService.getInstalled()).find(g=>!g.isBuiltin&&k(g.identifier,a.identifier));E&&i(d,E,v)}}}const r=[];for(const a of n)r.push(this.uninstallExtensionFromWorkspace(a));for(const[a,v]of t.entries())r.push(this.uninstallInServer(a,v));const l=(await Promise.allSettled(r)).filter(a=>a.status==="rejected").map(a=>a.reason);if(l.length)throw new Error(l.map(a=>a.message).join(`
`))}async uninstallInServer(e,n){if(e===this.extensionManagementServerService.localExtensionManagementServer&&this.extensionManagementServerService.remoteExtensionManagementServer)for(const{extension:t}of n){const r=(await this.extensionManagementServerService.remoteExtensionManagementServer.extensionManagementService.getInstalled($.User)).filter(s=>!this.extensionManifestPropertiesService.prefersExecuteOnUI(s.manifest)&&s.manifest.extensionDependencies&&s.manifest.extensionDependencies.some(l=>k({id:l},t.identifier)));if(r.length)throw new Error(this.getDependentsErrorMessage(t,r))}return e.extensionManagementService.uninstallExtensions(n)}getDependentsErrorMessage(e,n){return n.length===1?c("singleDependentError","Cannot uninstall extension '{0}'. Extension '{1}' depends on this.",e.manifest.displayName||e.manifest.name,n[0].manifest.displayName||n[0].manifest.name):n.length===2?c("twoDependentsError","Cannot uninstall extension '{0}'. Extensions '{1}' and '{2}' depend on this.",e.manifest.displayName||e.manifest.name,n[0].manifest.displayName||n[0].manifest.name,n[1].manifest.displayName||n[1].manifest.name):c("multipleDependentsError","Cannot uninstall extension '{0}'. Extensions '{1}', '{2}' and others depend on this.",e.manifest.displayName||e.manifest.name,n[0].manifest.displayName||n[0].manifest.name,n[1].manifest.displayName||n[1].manifest.name)}async reinstallFromGallery(e){const n=this.getServer(e);return n?(await this.checkForWorkspaceTrust(e.manifest,!1),n.extensionManagementService.reinstallFromGallery(e)):Promise.reject(`Invalid location ${e.location.toString()}`)}updateMetadata(e,n){const t=this.getServer(e);return t?t.extensionManagementService.updateMetadata(e,n,this.userDataProfileService.currentProfile.extensionsResource):Promise.reject(`Invalid location ${e.location.toString()}`)}async resetPinnedStateForAllUserExtensions(e){await Promise.allSettled(this.servers.map(n=>n.extensionManagementService.resetPinnedStateForAllUserExtensions(e)))}zip(e){const n=this.getServer(e);return n?n.extensionManagementService.zip(e):Promise.reject(`Invalid location ${e.location.toString()}`)}download(e,n,t){if(this.extensionManagementServerService.localExtensionManagementServer)return this.extensionManagementServerService.localExtensionManagementServer.extensionManagementService.download(e,n,t);throw new Error("Cannot download extension")}async install(e,n){const t=await this.getManifest(e);return this.installVSIX(e,t,n)}async installVSIX(e,n,t){const i=this.getServersToInstall(n);if(i?.length){await this.checkForWorkspaceTrust(n,!1);const[r]=await C.settled(i.map(s=>this.installVSIXInServer(e,s,t)));return r}return Promise.reject("No Servers to Install")}getServersToInstall(e){if(this.extensionManagementServerService.localExtensionManagementServer&&this.extensionManagementServerService.remoteExtensionManagementServer)return U(e)?[this.extensionManagementServerService.localExtensionManagementServer,this.extensionManagementServerService.remoteExtensionManagementServer]:this.extensionManifestPropertiesService.prefersExecuteOnUI(e)?[this.extensionManagementServerService.localExtensionManagementServer]:[this.extensionManagementServerService.remoteExtensionManagementServer];if(this.extensionManagementServerService.localExtensionManagementServer)return[this.extensionManagementServerService.localExtensionManagementServer];if(this.extensionManagementServerService.remoteExtensionManagementServer)return[this.extensionManagementServerService.remoteExtensionManagementServer]}async installFromLocation(e){if(e.scheme===y.file){if(this.extensionManagementServerService.localExtensionManagementServer)return this.extensionManagementServerService.localExtensionManagementServer.extensionManagementService.installFromLocation(e,this.userDataProfileService.currentProfile.extensionsResource);throw new Error("Local extension management server is not found")}if(e.scheme===y.vscodeRemote){if(this.extensionManagementServerService.remoteExtensionManagementServer)return this.extensionManagementServerService.remoteExtensionManagementServer.extensionManagementService.installFromLocation(e,this.userDataProfileService.currentProfile.extensionsResource);throw new Error("Remote extension management server is not found")}if(!this.extensionManagementServerService.webExtensionManagementServer)throw new Error("Web extension management server is not found");return this.extensionManagementServerService.webExtensionManagementServer.extensionManagementService.installFromLocation(e,this.userDataProfileService.currentProfile.extensionsResource)}installVSIXInServer(e,n,t){return n.extensionManagementService.install(e,t)}getManifest(e){return e.scheme===y.file&&this.extensionManagementServerService.localExtensionManagementServer?this.extensionManagementServerService.localExtensionManagementServer.extensionManagementService.getManifest(e):e.scheme===y.file&&this.extensionManagementServerService.remoteExtensionManagementServer?this.extensionManagementServerService.remoteExtensionManagementServer.extensionManagementService.getManifest(e):e.scheme===y.vscodeRemote&&this.extensionManagementServerService.remoteExtensionManagementServer?this.extensionManagementServerService.remoteExtensionManagementServer.extensionManagementService.getManifest(e):Promise.reject("No Servers")}async canInstall(e){return ke(e)?this.canInstallGalleryExtension(e):this.canInstallResourceExtension(e)}async canInstallGalleryExtension(e){if(this.extensionManagementServerService.localExtensionManagementServer&&await this.extensionManagementServerService.localExtensionManagementServer.extensionManagementService.canInstall(e))return!0;const n=await this.extensionGalleryService.getManifest(e,_.None);return n?!!(this.extensionManagementServerService.remoteExtensionManagementServer&&await this.extensionManagementServerService.remoteExtensionManagementServer.extensionManagementService.canInstall(e)&&this.extensionManifestPropertiesService.canExecuteOnWorkspace(n)||this.extensionManagementServerService.webExtensionManagementServer&&await this.extensionManagementServerService.webExtensionManagementServer.extensionManagementService.canInstall(e)&&this.extensionManifestPropertiesService.canExecuteOnWeb(n)):!1}canInstallResourceExtension(e){return!!(this.extensionManagementServerService.localExtensionManagementServer||this.extensionManagementServerService.remoteExtensionManagementServer&&this.extensionManifestPropertiesService.canExecuteOnWorkspace(e.manifest)||this.extensionManagementServerService.webExtensionManagementServer&&this.extensionManifestPropertiesService.canExecuteOnWeb(e.manifest))}async updateFromGallery(e,n,t){const i=this.getServer(n);if(!i)return Promise.reject(`Invalid location ${n.location.toString()}`);const r=[];return U(n.manifest)?r.push(...this.servers.filter(s=>s!==this.extensionManagementServerService.webExtensionManagementServer)):r.push(i),t={...t||{},isApplicationScoped:n.isApplicationScoped},C.settled(r.map(s=>s.extensionManagementService.installFromGallery(e,t))).then(([s])=>s)}async installGalleryExtensions(e){const n=new Map,t=new Map;return await Promise.all(e.map(async({extension:i,options:r})=>{try{const s=await this.validateAndGetExtensionManagementServersToInstall(i,r);!r.isMachineScoped&&this.isExtensionsSyncEnabled()&&this.extensionManagementServerService.localExtensionManagementServer&&!s.includes(this.extensionManagementServerService.localExtensionManagementServer)&&await this.extensionManagementServerService.localExtensionManagementServer.extensionManagementService.canInstall(i)&&s.push(this.extensionManagementServerService.localExtensionManagementServer);for(const l of s){let a=t.get(l);a||t.set(l,a=[]),a.push({extension:i,options:r})}}catch(s){n.set(i.identifier.id.toLowerCase(),{identifier:i.identifier,source:i,error:s,operation:G.Install,profileLocation:r.profileLocation??this.userDataProfileService.currentProfile.extensionsResource})}})),await Promise.all([...t.entries()].map(async([i,r])=>{const s=await i.extensionManagementService.installGalleryExtensions(r);for(const l of s)n.set(l.identifier.id.toLowerCase(),l)})),[...n.values()]}async installFromGallery(e,n){const t=await this.validateAndGetExtensionManagementServersToInstall(e,n);if(!n||ie(n.isMachineScoped)){const i=await this.hasToFlagExtensionsMachineScoped([e]);n={...n||{},isMachineScoped:i}}return!n.isMachineScoped&&this.isExtensionsSyncEnabled()&&this.extensionManagementServerService.localExtensionManagementServer&&!t.includes(this.extensionManagementServerService.localExtensionManagementServer)&&await this.extensionManagementServerService.localExtensionManagementServer.extensionManagementService.canInstall(e)&&t.push(this.extensionManagementServerService.localExtensionManagementServer),C.settled(t.map(i=>i.extensionManagementService.installFromGallery(e,n))).then(([i])=>i)}async getExtensions(e){const n=await this.extensionsScannerService.scanMultipleExtensions(e,$.User,{includeInvalid:!0}),t=[];return await Promise.all(n.map(async i=>{const r=await this.workspaceExtensionManagementService.toLocalWorkspaceExtension(i);r&&t.push({type:"resource",identifier:r.identifier,location:r.location,manifest:r.manifest,changelogUri:r.changelogUrl,readmeUri:r.readmeUrl})})),t}getInstalledWorkspaceExtensionLocations(){return this.workspaceExtensionManagementService.getInstalledWorkspaceExtensionsLocations()}async getInstalledWorkspaceExtensions(e){return this.workspaceExtensionManagementService.getInstalled(e)}async installResourceExtension(e,n){if(!this.canInstallResourceExtension(e))throw new Error("This extension cannot be installed in the current workspace.");if(!n.isWorkspaceScoped)return this.installFromLocation(e.location);this.logService.info(`Installing the extension ${e.identifier.id} from ${e.location.toString()} in workspace`);const t=this.getWorkspaceExtensionsServer();this._onInstallExtension.fire({identifier:e.identifier,source:e.location,server:t,applicationScoped:!1,profileLocation:this.userDataProfileService.currentProfile.extensionsResource,workspaceScoped:!0});try{await this.checkForWorkspaceTrust(e.manifest,!0);const i=await this.workspaceExtensionManagementService.install(e);return this.logService.info(`Successfully installed the extension ${i.identifier.id} from ${e.location.toString()} in the workspace`),this._onDidInstallExtensions.fire([{identifier:i.identifier,source:e.location,operation:G.Install,applicationScoped:!1,profileLocation:this.userDataProfileService.currentProfile.extensionsResource,local:i,workspaceScoped:!0}]),i}catch(i){throw this.logService.error(`Failed to install the extension ${e.identifier.id} from ${e.location.toString()} in the workspace`,O(i)),this._onDidInstallExtensions.fire([{identifier:e.identifier,source:e.location,operation:G.Install,applicationScoped:!1,profileLocation:this.userDataProfileService.currentProfile.extensionsResource,error:i,workspaceScoped:!0}]),i}}async uninstallExtensionFromWorkspace(e){if(!e.isWorkspaceScoped)throw new Error("The extension is not a workspace extension");this.logService.info(`Uninstalling the workspace extension ${e.identifier.id} from ${e.location.toString()}`);const n=this.getWorkspaceExtensionsServer();this._onUninstallExtension.fire({identifier:e.identifier,server:n,applicationScoped:!1,workspaceScoped:!0,profileLocation:this.userDataProfileService.currentProfile.extensionsResource});try{await this.workspaceExtensionManagementService.uninstall(e),this.logService.info(`Successfully uninstalled the workspace extension ${e.identifier.id} from ${e.location.toString()}`),this.telemetryService.publicLog2("workspaceextension:uninstall"),this._onDidUninstallExtension.fire({identifier:e.identifier,server:n,applicationScoped:!1,workspaceScoped:!0,profileLocation:this.userDataProfileService.currentProfile.extensionsResource})}catch(t){throw this.logService.error(`Failed to uninstall the workspace extension ${e.identifier.id} from ${e.location.toString()}`,O(t)),this._onDidUninstallExtension.fire({identifier:e.identifier,server:n,error:t,applicationScoped:!1,workspaceScoped:!0,profileLocation:this.userDataProfileService.currentProfile.extensionsResource}),t}}async validateAndGetExtensionManagementServersToInstall(e,n){const t=await this.extensionGalleryService.getManifest(e,_.None);if(!t)return Promise.reject(c("Manifest is not found","Installing Extension {0} failed: Manifest is not found.",e.displayName||e.name));const i=[];if(U(t))i.push(...this.servers.filter(r=>r!==this.extensionManagementServerService.webExtensionManagementServer));else{const r=this.getExtensionManagementServerToInstall(t);r&&i.push(r)}if(!i.length){const r=new Error(c("cannot be installed","Cannot install the '{0}' extension because it is not available in this setup.",e.displayName||e.name));throw r.name=z.Unsupported,r}return n?.context?.[ce]!==ve.SETTINGS_SYNC&&await this.checkForWorkspaceTrust(t,!1),n?.donotIncludePackAndDependencies||await this.checkInstallingExtensionOnWeb(e,t),i}getExtensionManagementServerToInstall(e){if(this.servers.length===1&&this.extensionManagementServerService.localExtensionManagementServer)return this.extensionManagementServerService.localExtensionManagementServer;const n=this.extensionManifestPropertiesService.getExtensionKind(e);for(const t of n){if(t==="ui"&&this.extensionManagementServerService.localExtensionManagementServer)return this.extensionManagementServerService.localExtensionManagementServer;if(t==="workspace"&&this.extensionManagementServerService.remoteExtensionManagementServer)return this.extensionManagementServerService.remoteExtensionManagementServer;if(t==="web"&&this.extensionManagementServerService.webExtensionManagementServer)return this.extensionManagementServerService.webExtensionManagementServer}return this.extensionManagementServerService.localExtensionManagementServer}isExtensionsSyncEnabled(){return this.userDataSyncEnablementService.isEnabled()&&this.userDataSyncEnablementService.isResourceEnabled(ue.Extensions)}async hasToFlagExtensionsMachineScoped(e){if(this.isExtensionsSyncEnabled()){const{result:n}=await this.dialogService.prompt({type:F.Info,message:e.length===1?c("install extension","Install Extension"):c("install extensions","Install Extensions"),detail:e.length===1?c("install single extension","Would you like to install and synchronize '{0}' extension across your devices?",e[0].displayName):c("install multiple extensions","Would you like to install and synchronize extensions across your devices?"),buttons:[{label:c({key:"install",comment:["&& denotes a mnemonic"]},"&&Install"),run:()=>!1},{label:c({key:"install and do no sync",comment:["&& denotes a mnemonic"]},"Install (Do &&not sync)"),run:()=>!0}],cancelButton:{run:()=>{throw new N}}});return n}return!1}getExtensionsControlManifest(){return this.extensionManagementServerService.localExtensionManagementServer?this.extensionManagementServerService.localExtensionManagementServer.extensionManagementService.getExtensionsControlManifest():this.extensionManagementServerService.remoteExtensionManagementServer?this.extensionManagementServerService.remoteExtensionManagementServer.extensionManagementService.getExtensionsControlManifest():this.extensionManagementServerService.webExtensionManagementServer?this.extensionManagementServerService.webExtensionManagementServer.extensionManagementService.getExtensionsControlManifest():Promise.resolve({malicious:[],deprecated:{},search:[]})}getServer(e){return e.isWorkspaceScoped?this.getWorkspaceExtensionsServer():this.extensionManagementServerService.getExtensionManagementServer(e)}getWorkspaceExtensionsServer(){if(this.extensionManagementServerService.remoteExtensionManagementServer)return this.extensionManagementServerService.remoteExtensionManagementServer;if(this.extensionManagementServerService.localExtensionManagementServer)return this.extensionManagementServerService.localExtensionManagementServer;if(this.extensionManagementServerService.webExtensionManagementServer)return this.extensionManagementServerService.webExtensionManagementServer;throw new Error("No extension server found")}async checkForWorkspaceTrust(e,n){if(n||this.extensionManifestPropertiesService.getExtensionUntrustedWorkspaceSupportType(e)===!1){const t=[];if(t.push({label:c("extensionInstallWorkspaceTrustButton","Trust Workspace & Install"),type:"ContinueWithTrust"}),n||t.push({label:c("extensionInstallWorkspaceTrustContinueButton","Install"),type:"ContinueWithoutTrust"}),t.push({label:c("extensionInstallWorkspaceTrustManageButton","Learn More"),type:"Manage"}),await this.workspaceTrustRequestService.requestWorkspaceTrust({message:c("extensionInstallWorkspaceTrustMessage","Enabling this extension requires a trusted workspace."),buttons:t})===void 0)throw new N}}async checkInstallingExtensionOnWeb(e,n){if(this.servers.length!==1||this.servers[0]!==this.extensionManagementServerService.webExtensionManagementServer)return;const t=[];if(n.extensionPack?.length){const E=await this.extensionGalleryService.getExtensions(n.extensionPack.map(g=>({id:g})),_.None);for(const g of E)await this.servers[0].extensionManagementService.canInstall(g)||t.push(g);if(t.length&&t.length===E.length)throw new Se("Not supported in Web",z.Unsupported)}const i=c("VS Code for Web","{0} for the Web",this.productService.nameLong),r=this.extensionManifestPropertiesService.getExtensionVirtualWorkspaceSupportType(n),s=de(n.capabilities?.virtualWorkspaces),l=r==="limited"||!!s;if(!t.length&&!l)return;const a=c("limited support","'{0}' has limited functionality in {1}.",e.displayName||e.identifier.id,i);let v,S=[],m;const d={label:c({key:"install anyways",comment:["&& denotes a mnemonic"]},"&&Install Anyway"),run:()=>{}},P={label:c({key:"showExtensions",comment:["&& denotes a mnemonic"]},"&&Show Extensions"),run:()=>this.instantiationService.invokeFunction(E=>E.get(se).executeCommand("extension.open",e.identifier.id,"extensionPack"))};t.length&&l?(v=a,m=`${s?`${s}
`:""}${c("non web extensions detail","Contains extensions which are not supported.")}`,S=[d,P]):l?(v=a,m=s||void 0,S=[d]):(v=c("non web extensions","'{0}' contains extensions which are not supported in {1}.",e.displayName||e.identifier.id,i),S=[d,P]),await this.dialogService.prompt({type:F.Info,message:v,detail:m,buttons:S,cancelButton:{run:()=>{throw new N}}})}_targetPlatformPromise;getTargetPlatform(){return this._targetPlatformPromise||(this._targetPlatformPromise=xe(this.fileService,this.logService)),this._targetPlatformPromise}async cleanUp(){await Promise.allSettled(this.servers.map(e=>e.extensionManagementService.cleanUp()))}toggleAppliationScope(e,n){const t=this.getServer(e);if(t)return t.extensionManagementService.toggleAppliationScope(e,n);throw new Error("Not Supported")}copyExtensions(e,n){if(this.extensionManagementServerService.remoteExtensionManagementServer)throw new Error("Not Supported");return this.extensionManagementServerService.localExtensionManagementServer?this.extensionManagementServerService.localExtensionManagementServer.extensionManagementService.copyExtensions(e,n):this.extensionManagementServerService.webExtensionManagementServer?this.extensionManagementServerService.webExtensionManagementServer.extensionManagementService.copyExtensions(e,n):Promise.resolve()}registerParticipant(){throw new Error("Not Supported")}installExtensionsFromProfile(e,n,t){throw new Error("Not Supported")}};b=T([o(0,we),o(1,me),o(2,Pe),o(3,ae),o(4,pe),o(5,le),o(6,fe),o(7,oe),o(8,Me),o(9,ye),o(10,X),o(11,q),o(12,he),o(13,j),o(14,J)],b);let h=class extends K{constructor(e,n,t,i,r,s,l){super();this.fileService=e;this.logService=n;this.workspaceService=t;this.extensionsScannerService=i;this.storageService=r;this.uriIdentityService=s;this.telemetryService=l;this._register(w.debounce(this.fileService.onDidFilesChange,(a,v)=>((a=a??[]).push(v),a),1e3)(a=>{const v=this.extensions.filter(S=>!S.isValid&&a.some(m=>m.affects(S.location)));v.length&&this.checkExtensionsValidity(v)})),this.initializePromise=this.initialize()}static WORKSPACE_EXTENSIONS_KEY="workspaceExtensions.locations";_onDidChangeInvalidExtensions=this._register(new M);onDidChangeInvalidExtensions=this._onDidChangeInvalidExtensions.event;extensions=[];initializePromise;invalidExtensionWatchers=this._register(new ne);async initialize(){const e=this.getInstalledWorkspaceExtensionsLocations();e.length&&(await Promise.allSettled(e.map(async n=>{if(!this.workspaceService.isInsideWorkspace(n)){this.logService.info(`Removing the workspace extension ${n.toString()} as it is not inside the workspace`);return}if(!await this.fileService.exists(n)){this.logService.info(`Removing the workspace extension ${n.toString()} as it does not exist`);return}try{const t=await this.scanWorkspaceExtension(n);t?this.extensions.push(t):this.logService.info(`Skipping workspace extension ${n.toString()} as it does not exist`)}catch(t){this.logService.error("Skipping the workspace extension",n.toString(),t)}})),this.saveWorkspaceExtensions())}watchInvalidExtensions(){this.invalidExtensionWatchers.clear();for(const e of this.extensions)e.isValid||this.invalidExtensionWatchers.add(this.fileService.watch(e.location))}async checkExtensionsValidity(e){const n=[];await Promise.all(e.map(async i=>{const r=await this.scanWorkspaceExtension(i.location);r?.isValid&&n.push(r)}));let t=!1;for(const i of n){const r=this.extensions.findIndex(s=>this.uriIdentityService.extUri.isEqual(s.location,i.location));r!==-1&&(t=!0,this.extensions.splice(r,1,i))}t&&(this.saveWorkspaceExtensions(),this._onDidChangeInvalidExtensions.fire(n))}async getInstalled(e){return await this.initializePromise,this.extensions.filter(n=>e||n.isValid)}async install(e){await this.initializePromise;const n=await this.scanWorkspaceExtension(e.location);if(!n)throw new Error("Cannot install the extension as it does not exist.");const t=this.extensions.findIndex(i=>k(i.identifier,e.identifier));return t===-1?this.extensions.push(n):this.extensions.splice(t,1,n),this.saveWorkspaceExtensions(),this.telemetryService.publicLog2("workspaceextension:install"),n}async uninstall(e){await this.initializePromise;const n=this.extensions.findIndex(t=>k(t.identifier,e.identifier));n!==-1&&(this.extensions.splice(n,1),this.saveWorkspaceExtensions()),this.telemetryService.publicLog2("workspaceextension:uninstall")}getInstalledWorkspaceExtensionsLocations(){const e=[];try{const n=JSON.parse(this.storageService.get(h.WORKSPACE_EXTENSIONS_KEY,A.WORKSPACE,"[]"));if(Array.isArray(e))for(const t of n)te(t)?this.workspaceService.getWorkbenchState()===H.FOLDER?e.push(this.workspaceService.getWorkspace().folders[0].toResource(t)):this.logService.warn(`Invalid value for 'extensions' in workspace storage: ${t}`):e.push(re.revive(t));else this.logService.warn(`Invalid value for 'extensions' in workspace storage: ${e}`)}catch(n){this.logService.warn(`Error parsing workspace extensions locations: ${O(n)}`)}return e}saveWorkspaceExtensions(){const e=this.extensions.map(n=>n.location);this.workspaceService.getWorkbenchState()===H.FOLDER?this.storageService.store(h.WORKSPACE_EXTENSIONS_KEY,JSON.stringify(ee(e.map(n=>this.uriIdentityService.extUri.relativePath(this.workspaceService.getWorkspace().folders[0].uri,n)))),A.WORKSPACE,Y.MACHINE):this.storageService.store(h.WORKSPACE_EXTENSIONS_KEY,JSON.stringify(e),A.WORKSPACE,Y.MACHINE),this.watchInvalidExtensions()}async scanWorkspaceExtension(e){const n=await this.extensionsScannerService.scanExistingExtension(e,$.User,{includeInvalid:!0});return n?this.toLocalWorkspaceExtension(n):null}async toLocalWorkspaceExtension(e){const n=await this.fileService.resolve(e.location);let t,i;n.children&&(t=n.children.find(({name:l})=>/^readme(\.txt|\.md|)$/i.test(l))?.resource,i=n.children.find(({name:l})=>/^changelog(\.txt|\.md|)$/i.test(l))?.resource);const r=[...e.validations];let s=e.isValid;return e.manifest.main&&(await this.fileService.exists(this.uriIdentityService.extUri.joinPath(e.location,e.manifest.main))||(s=!1,r.push([F.Error,c("main.notFound","Cannot activate, becase {0} not found",e.manifest.main)]))),{identifier:e.identifier,type:e.type,isBuiltin:e.isBuiltin||!!e.metadata?.isBuiltin,location:e.location,manifest:e.manifest,targetPlatform:e.targetPlatform,validations:r,isValid:s,readmeUrl:t,changelogUrl:i,publisherDisplayName:e.metadata?.publisherDisplayName,publisherId:e.metadata?.publisherId||null,isApplicationScoped:!!e.metadata?.isApplicationScoped,isMachineScoped:!!e.metadata?.isMachineScoped,isPreReleaseVersion:!!e.metadata?.isPreReleaseVersion,hasPreReleaseVersion:!!e.metadata?.hasPreReleaseVersion,preRelease:!!e.metadata?.preRelease,installedTimestamp:e.metadata?.installedTimestamp,updated:!!e.metadata?.updated,pinned:!!e.metadata?.pinned,isWorkspaceScoped:!0,source:"resource"}}};h=T([o(0,X),o(1,q),o(2,Ie),o(3,j),o(4,Ee),o(5,ge),o(6,J)],h);export{b as ExtensionManagementService};
