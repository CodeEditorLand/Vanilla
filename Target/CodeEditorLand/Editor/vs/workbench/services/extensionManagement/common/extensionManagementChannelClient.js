import{delta as f}from"../../../../base/common/arrays.js";import{Emitter as d}from"../../../../base/common/event.js";import{compare as p}from"../../../../base/common/strings.js";import{ExtensionManagementChannelClient as m}from"../../../../platform/extensionManagement/common/extensionManagementIpc.js";import{ExtensionIdentifier as a,ExtensionType as c}from"../../../../platform/extensions/common/extensions.js";class y extends m{constructor(t,e,i){super(t);this.userDataProfileService=e;this.uriIdentityService=i;this._register(e.onDidChangeCurrentProfile(o=>{this.uriIdentityService.extUri.isEqual(o.previous.extensionsResource,o.profile.extensionsResource)||o.join(this.whenProfileChanged(o))}))}_onDidChangeProfile=this._register(new d);onDidChangeProfile=this._onDidChangeProfile.event;async fireEvent(t,e){if(Array.isArray(e)){const i=t,o=e,r=[];for(const n of o){const s=this.filterEvent(n.profileLocation,n.applicationScoped??n.local?.isApplicationScoped??!1);(s instanceof Promise?await s:s)&&r.push(n)}r.length&&i.fire(r)}else{const i=t,o=e,r=this.filterEvent(o.profileLocation,o.applicationScoped??o.local?.isApplicationScoped??!1);(r instanceof Promise?await r:r)&&i.fire(o)}}async install(t,e){return e={...e,profileLocation:await this.getProfileLocation(e?.profileLocation)},super.install(t,e)}async installFromLocation(t,e){return super.installFromLocation(t,await this.getProfileLocation(e))}async installFromGallery(t,e){return e={...e,profileLocation:await this.getProfileLocation(e?.profileLocation)},super.installFromGallery(t,e)}async installGalleryExtensions(t){const e=[];for(const i of t)e.push({...i,options:{...i.options,profileLocation:await this.getProfileLocation(i.options?.profileLocation)}});return super.installGalleryExtensions(e)}async uninstall(t,e){return e={...e,profileLocation:await this.getProfileLocation(e?.profileLocation)},super.uninstall(t,e)}async uninstallExtensions(t){const e=[];for(const{extension:i,options:o}of t)e.push({extension:i,options:{...o,profileLocation:await this.getProfileLocation(o?.profileLocation)}});return super.uninstallExtensions(e)}async getInstalled(t=null,e,i){return super.getInstalled(t,await this.getProfileLocation(e),i)}async updateMetadata(t,e,i){return super.updateMetadata(t,e,await this.getProfileLocation(i))}async toggleAppliationScope(t,e){return super.toggleAppliationScope(t,await this.getProfileLocation(e))}async copyExtensions(t,e){return super.copyExtensions(await this.getProfileLocation(t),await this.getProfileLocation(e))}async whenProfileChanged(t){const e=await this.getProfileLocation(t.previous.extensionsResource),i=await this.getProfileLocation(t.profile.extensionsResource);if(this.uriIdentityService.extUri.isEqual(e,i))return;const o=await this.switchExtensionsProfile(e,i);this._onDidChangeProfile.fire(o)}async switchExtensionsProfile(t,e,i){const o=await this.getInstalled(c.User,t),r=await this.getInstalled(c.User,e);if(i?.length){const n=[];for(const s of o)i.some(l=>a.equals(s.identifier.id,l))&&!r.some(l=>a.equals(l.identifier.id,s.identifier.id))&&n.push(s.identifier);n.length&&await this.installExtensionsFromProfile(n,t,e)}return f(o,r,(n,s)=>p(`${a.toKey(n.identifier.id)}@${n.manifest.version}`,`${a.toKey(s.identifier.id)}@${s.manifest.version}`))}async getProfileLocation(t){return t??this.userDataProfileService.currentProfile.extensionsResource}}export{y as ProfileAwareExtensionManagementChannelClient};
