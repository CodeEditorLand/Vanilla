{
  "version": 3,
  "sources": ["../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/services/auxiliaryWindow/browser/auxiliaryWindowService.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { getZoomLevel } from '../../../../base/browser/browser.js';\nimport { Dimension, EventHelper, EventType, ModifierKeyEmitter, addDisposableListener, cloneGlobalStylesheets, copyAttributes, createLinkElement, createMetaElement, getActiveWindow, getClientArea, getWindowId, isGlobalStylesheet, isHTMLElement, position, registerWindow, sharedMutationObserver, trackAttributes } from '../../../../base/browser/dom.js';\nimport { CodeWindow, ensureCodeWindow, mainWindow } from '../../../../base/browser/window.js';\nimport { coalesce } from '../../../../base/common/arrays.js';\nimport { Barrier } from '../../../../base/common/async.js';\nimport { onUnexpectedError } from '../../../../base/common/errors.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { Disposable, DisposableStore, IDisposable, toDisposable } from '../../../../base/common/lifecycle.js';\nimport { mark } from '../../../../base/common/performance.js';\nimport { isFirefox, isWeb } from '../../../../base/common/platform.js';\nimport Severity from '../../../../base/common/severity.js';\nimport { localize } from '../../../../nls.js';\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nimport { IDialogService } from '../../../../platform/dialogs/common/dialogs.js';\nimport { InstantiationType, registerSingleton } from '../../../../platform/instantiation/common/extensions.js';\nimport { createDecorator } from '../../../../platform/instantiation/common/instantiation.js';\nimport { ITelemetryService } from '../../../../platform/telemetry/common/telemetry.js';\nimport { IRectangle, WindowMinimumSize } from '../../../../platform/window/common/window.js';\nimport { BaseWindow } from '../../../browser/window.js';\nimport { IWorkbenchEnvironmentService } from '../../environment/common/environmentService.js';\nimport { IHostService } from '../../host/browser/host.js';\nimport { IWorkbenchLayoutService } from '../../layout/browser/layoutService.js';\n\nexport const IAuxiliaryWindowService = createDecorator<IAuxiliaryWindowService>('auxiliaryWindowService');\n\nexport interface IAuxiliaryWindowOpenEvent {\n\treadonly window: IAuxiliaryWindow;\n\treadonly disposables: DisposableStore;\n}\n\nexport enum AuxiliaryWindowMode {\n\tMaximized,\n\tNormal,\n\tFullscreen\n}\n\nexport interface IAuxiliaryWindowOpenOptions {\n\treadonly bounds?: Partial<IRectangle>;\n\n\treadonly mode?: AuxiliaryWindowMode;\n\treadonly zoomLevel?: number;\n\n\treadonly nativeTitlebar?: boolean;\n\treadonly disableFullscreen?: boolean;\n}\n\nexport interface IAuxiliaryWindowService {\n\n\treadonly _serviceBrand: undefined;\n\n\treadonly onDidOpenAuxiliaryWindow: Event<IAuxiliaryWindowOpenEvent>;\n\n\topen(options?: IAuxiliaryWindowOpenOptions): Promise<IAuxiliaryWindow>;\n\n\tgetWindow(windowId: number): IAuxiliaryWindow | undefined;\n}\n\nexport interface BeforeAuxiliaryWindowUnloadEvent {\n\tveto(reason: string | undefined): void;\n}\n\nexport interface IAuxiliaryWindow extends IDisposable {\n\n\treadonly onWillLayout: Event<Dimension>;\n\treadonly onDidLayout: Event<Dimension>;\n\n\treadonly onBeforeUnload: Event<BeforeAuxiliaryWindowUnloadEvent>;\n\treadonly onUnload: Event<void>;\n\n\treadonly whenStylesHaveLoaded: Promise<void>;\n\n\treadonly window: CodeWindow;\n\treadonly container: HTMLElement;\n\n\tlayout(): void;\n\n\tcreateState(): IAuxiliaryWindowOpenOptions;\n}\n\nexport class AuxiliaryWindow extends BaseWindow implements IAuxiliaryWindow {\n\n\tprivate readonly _onWillLayout = this._register(new Emitter<Dimension>());\n\treadonly onWillLayout = this._onWillLayout.event;\n\n\tprivate readonly _onDidLayout = this._register(new Emitter<Dimension>());\n\treadonly onDidLayout = this._onDidLayout.event;\n\n\tprivate readonly _onBeforeUnload = this._register(new Emitter<BeforeAuxiliaryWindowUnloadEvent>());\n\treadonly onBeforeUnload = this._onBeforeUnload.event;\n\n\tprivate readonly _onUnload = this._register(new Emitter<void>());\n\treadonly onUnload = this._onUnload.event;\n\n\tprivate readonly _onWillDispose = this._register(new Emitter<void>());\n\treadonly onWillDispose = this._onWillDispose.event;\n\n\treadonly whenStylesHaveLoaded: Promise<void>;\n\n\tconstructor(\n\t\treadonly window: CodeWindow,\n\t\treadonly container: HTMLElement,\n\t\tstylesHaveLoaded: Barrier,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService,\n\t\t@IHostService hostService: IHostService,\n\t\t@IWorkbenchEnvironmentService environmentService: IWorkbenchEnvironmentService\n\t) {\n\t\tsuper(window, undefined, hostService, environmentService);\n\n\t\tthis.whenStylesHaveLoaded = stylesHaveLoaded.wait().then(() => undefined);\n\n\t\tthis.registerListeners();\n\t}\n\n\tprivate registerListeners(): void {\n\t\tthis._register(addDisposableListener(this.window, EventType.BEFORE_UNLOAD, (e: BeforeUnloadEvent) => this.handleBeforeUnload(e)));\n\t\tthis._register(addDisposableListener(this.window, EventType.UNLOAD, () => this.handleUnload()));\n\n\t\tthis._register(addDisposableListener(this.window, 'unhandledrejection', e => {\n\t\t\tonUnexpectedError(e.reason);\n\t\t\te.preventDefault();\n\t\t}));\n\n\t\tthis._register(addDisposableListener(this.window, EventType.RESIZE, () => this.layout()));\n\n\t\tthis._register(addDisposableListener(this.container, EventType.SCROLL, () => this.container.scrollTop = 0)); \t\t\t\t\t\t// Prevent container from scrolling (#55456)\n\n\t\tif (isWeb) {\n\t\t\tthis._register(addDisposableListener(this.container, EventType.DROP, e => EventHelper.stop(e, true))); \t\t\t\t\t\t\t// Prevent default navigation on drop\n\t\t\tthis._register(addDisposableListener(this.container, EventType.WHEEL, e => e.preventDefault(), { passive: false })); \t\t\t// Prevent the back/forward gestures in macOS\n\t\t\tthis._register(addDisposableListener(this.container, EventType.CONTEXT_MENU, e => EventHelper.stop(e, true))); \t\t\t\t\t// Prevent native context menus in web\n\t\t} else {\n\t\t\tthis._register(addDisposableListener(this.window.document.body, EventType.DRAG_OVER, (e: DragEvent) => EventHelper.stop(e)));\t// Prevent drag feedback on <body>\n\t\t\tthis._register(addDisposableListener(this.window.document.body, EventType.DROP, (e: DragEvent) => EventHelper.stop(e)));\t\t// Prevent default navigation on drop\n\t\t}\n\t}\n\n\tprivate handleBeforeUnload(e: BeforeUnloadEvent): void {\n\n\t\t// Check for veto from a listening component\n\t\tlet veto: string | undefined;\n\t\tthis._onBeforeUnload.fire({\n\t\t\tveto(reason) {\n\t\t\t\tif (reason) {\n\t\t\t\t\tveto = reason;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\tif (veto) {\n\t\t\tthis.handleVetoBeforeClose(e, veto);\n\n\t\t\treturn;\n\t\t}\n\n\t\t// Check for confirm before close setting\n\t\tconst confirmBeforeCloseSetting = this.configurationService.getValue<'always' | 'never' | 'keyboardOnly'>('window.confirmBeforeClose');\n\t\tconst confirmBeforeClose = confirmBeforeCloseSetting === 'always' || (confirmBeforeCloseSetting === 'keyboardOnly' && ModifierKeyEmitter.getInstance().isModifierPressed);\n\t\tif (confirmBeforeClose) {\n\t\t\tthis.confirmBeforeClose(e);\n\t\t}\n\t}\n\n\tprotected handleVetoBeforeClose(e: BeforeUnloadEvent, reason: string): void {\n\t\tthis.preventUnload(e);\n\t}\n\n\tprotected preventUnload(e: BeforeUnloadEvent): void {\n\t\te.preventDefault();\n\t\te.returnValue = localize('lifecycleVeto', \"Changes that you made may not be saved. Please check press 'Cancel' and try again.\");\n\t}\n\n\tprotected confirmBeforeClose(e: BeforeUnloadEvent): void {\n\t\tthis.preventUnload(e);\n\t}\n\n\tprivate handleUnload(): void {\n\n\t\t// Event\n\t\tthis._onUnload.fire();\n\t}\n\n\tlayout(): void {\n\n\t\t// Split layout up into two events so that downstream components\n\t\t// have a chance to participate in the beginning or end of the\n\t\t// layout phase.\n\t\t// This helps to build the auxiliary window in another component\n\t\t// in the `onWillLayout` phase and then let other compoments\n\t\t// react when the overall layout has finished in `onDidLayout`.\n\n\t\tconst dimension = getClientArea(this.window.document.body, this.container);\n\t\tthis._onWillLayout.fire(dimension);\n\t\tthis._onDidLayout.fire(dimension);\n\t}\n\n\tcreateState(): IAuxiliaryWindowOpenOptions {\n\t\treturn {\n\t\t\tbounds: {\n\t\t\t\tx: this.window.screenX,\n\t\t\t\ty: this.window.screenY,\n\t\t\t\twidth: this.window.outerWidth,\n\t\t\t\theight: this.window.outerHeight\n\t\t\t},\n\t\t\tzoomLevel: getZoomLevel(this.window)\n\t\t};\n\t}\n\n\toverride dispose(): void {\n\t\tif (this._store.isDisposed) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._onWillDispose.fire();\n\n\t\tsuper.dispose();\n\t}\n}\n\nexport class BrowserAuxiliaryWindowService extends Disposable implements IAuxiliaryWindowService {\n\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate static readonly DEFAULT_SIZE = { width: 800, height: 600 };\n\n\tprivate static WINDOW_IDS = getWindowId(mainWindow) + 1; // start from the main window ID + 1\n\n\tprivate readonly _onDidOpenAuxiliaryWindow = this._register(new Emitter<IAuxiliaryWindowOpenEvent>());\n\treadonly onDidOpenAuxiliaryWindow = this._onDidOpenAuxiliaryWindow.event;\n\n\tprivate readonly windows = new Map<number, IAuxiliaryWindow>();\n\n\tconstructor(\n\t\t@IWorkbenchLayoutService private readonly layoutService: IWorkbenchLayoutService,\n\t\t@IDialogService protected readonly dialogService: IDialogService,\n\t\t@IConfigurationService protected readonly configurationService: IConfigurationService,\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t\t@IHostService protected readonly hostService: IHostService,\n\t\t@IWorkbenchEnvironmentService protected readonly environmentService: IWorkbenchEnvironmentService\n\t) {\n\t\tsuper();\n\t}\n\n\tasync open(options?: IAuxiliaryWindowOpenOptions): Promise<IAuxiliaryWindow> {\n\t\tmark('code/auxiliaryWindow/willOpen');\n\n\t\tconst targetWindow = await this.openWindow(options);\n\t\tif (!targetWindow) {\n\t\t\tthrow new Error(localize('unableToOpenWindowError', \"Unable to open a new window.\"));\n\t\t}\n\n\t\t// Add a `vscodeWindowId` property to identify auxiliary windows\n\t\tconst resolvedWindowId = await this.resolveWindowId(targetWindow);\n\t\tensureCodeWindow(targetWindow, resolvedWindowId);\n\n\t\tconst containerDisposables = new DisposableStore();\n\t\tconst { container, stylesLoaded } = this.createContainer(targetWindow, containerDisposables, options);\n\n\t\tconst auxiliaryWindow = this.createAuxiliaryWindow(targetWindow, container, stylesLoaded);\n\n\t\tconst registryDisposables = new DisposableStore();\n\t\tthis.windows.set(targetWindow.vscodeWindowId, auxiliaryWindow);\n\t\tregistryDisposables.add(toDisposable(() => this.windows.delete(targetWindow.vscodeWindowId)));\n\n\t\tconst eventDisposables = new DisposableStore();\n\n\t\tEvent.once(auxiliaryWindow.onWillDispose)(() => {\n\t\t\ttargetWindow.close();\n\n\t\t\tcontainerDisposables.dispose();\n\t\t\tregistryDisposables.dispose();\n\t\t\teventDisposables.dispose();\n\t\t});\n\n\t\tregistryDisposables.add(registerWindow(targetWindow));\n\t\tthis._onDidOpenAuxiliaryWindow.fire({ window: auxiliaryWindow, disposables: eventDisposables });\n\n\t\tmark('code/auxiliaryWindow/didOpen');\n\n\t\ttype AuxiliaryWindowClassification = {\n\t\t\towner: 'bpasero';\n\t\t\tcomment: 'An event that fires when an auxiliary window is opened';\n\t\t\tbounds: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Has window bounds provided.' };\n\t\t};\n\t\ttype AuxiliaryWindowOpenEvent = {\n\t\t\tbounds: boolean;\n\t\t};\n\t\tthis.telemetryService.publicLog2<AuxiliaryWindowOpenEvent, AuxiliaryWindowClassification>('auxiliaryWindowOpen', { bounds: !!options?.bounds });\n\n\t\treturn auxiliaryWindow;\n\t}\n\n\tprotected createAuxiliaryWindow(targetWindow: CodeWindow, container: HTMLElement, stylesLoaded: Barrier): AuxiliaryWindow {\n\t\treturn new AuxiliaryWindow(targetWindow, container, stylesLoaded, this.configurationService, this.hostService, this.environmentService);\n\t}\n\n\tprivate async openWindow(options?: IAuxiliaryWindowOpenOptions): Promise<Window | undefined> {\n\t\tconst activeWindow = getActiveWindow();\n\t\tconst activeWindowBounds = {\n\t\t\tx: activeWindow.screenX,\n\t\t\ty: activeWindow.screenY,\n\t\t\twidth: activeWindow.outerWidth,\n\t\t\theight: activeWindow.outerHeight\n\t\t};\n\n\t\tconst width = Math.max(options?.bounds?.width ?? BrowserAuxiliaryWindowService.DEFAULT_SIZE.width, WindowMinimumSize.WIDTH);\n\t\tconst height = Math.max(options?.bounds?.height ?? BrowserAuxiliaryWindowService.DEFAULT_SIZE.height, WindowMinimumSize.HEIGHT);\n\n\t\tlet newWindowBounds: IRectangle = {\n\t\t\tx: options?.bounds?.x ?? Math.max(activeWindowBounds.x + activeWindowBounds.width / 2 - width / 2, 0),\n\t\t\ty: options?.bounds?.y ?? Math.max(activeWindowBounds.y + activeWindowBounds.height / 2 - height / 2, 0),\n\t\t\twidth,\n\t\t\theight\n\t\t};\n\n\t\tif (!options?.bounds && newWindowBounds.x === activeWindowBounds.x && newWindowBounds.y === activeWindowBounds.y) {\n\t\t\t// Offset the new window a bit so that it does not overlap\n\t\t\t// with the active window, unless bounds are provided\n\t\t\tnewWindowBounds = {\n\t\t\t\t...newWindowBounds,\n\t\t\t\tx: newWindowBounds.x + 30,\n\t\t\t\ty: newWindowBounds.y + 30\n\t\t\t};\n\t\t}\n\n\t\tconst features = coalesce([\n\t\t\t'popup=yes',\n\t\t\t`left=${newWindowBounds.x}`,\n\t\t\t`top=${newWindowBounds.y}`,\n\t\t\t`width=${newWindowBounds.width}`,\n\t\t\t`height=${newWindowBounds.height}`,\n\n\t\t\t// non-standard properties\n\t\t\toptions?.nativeTitlebar ? 'window-native-titlebar=yes' : undefined,\n\t\t\toptions?.disableFullscreen ? 'window-disable-fullscreen=yes' : undefined,\n\t\t\toptions?.mode === AuxiliaryWindowMode.Maximized ? 'window-maximized=yes' : undefined,\n\t\t\toptions?.mode === AuxiliaryWindowMode.Fullscreen ? 'window-fullscreen=yes' : undefined\n\t\t]);\n\n\t\tconst auxiliaryWindow = mainWindow.open(isFirefox ? '' /* FF immediately fires an unload event if using about:blank */ : 'about:blank', undefined, features.join(','));\n\t\tif (!auxiliaryWindow && isWeb) {\n\t\t\treturn (await this.dialogService.prompt({\n\t\t\t\ttype: Severity.Warning,\n\t\t\t\tmessage: localize('unableToOpenWindow', \"The browser interrupted the opening of a new window. Press 'Retry' to try again.\"),\n\t\t\t\tdetail: localize('unableToOpenWindowDetail', \"To avoid this problem in the future, please ensure to allow popups for this website.\"),\n\t\t\t\tbuttons: [\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: localize({ key: 'retry', comment: ['&& denotes a mnemonic'] }, \"&&Retry\"),\n\t\t\t\t\t\trun: () => this.openWindow(options)\n\t\t\t\t\t}\n\t\t\t\t],\n\t\t\t\tcancelButton: true\n\t\t\t})).result;\n\t\t}\n\n\t\treturn auxiliaryWindow?.window;\n\t}\n\n\tprotected async resolveWindowId(auxiliaryWindow: Window): Promise<number> {\n\t\treturn BrowserAuxiliaryWindowService.WINDOW_IDS++;\n\t}\n\n\tprotected createContainer(auxiliaryWindow: CodeWindow, disposables: DisposableStore, options?: IAuxiliaryWindowOpenOptions): { stylesLoaded: Barrier; container: HTMLElement } {\n\t\tauxiliaryWindow.document.createElement = function () {\n\t\t\t// Disallow `createElement` because it would create\n\t\t\t// HTML Elements in the \"wrong\" context and break\n\t\t\t// code that does \"instanceof HTMLElement\" etc.\n\t\t\tthrow new Error('Not allowed to create elements in child window JavaScript context. Always use the main window so that \"xyz instanceof HTMLElement\" continues to work.');\n\t\t};\n\n\t\tthis.applyMeta(auxiliaryWindow);\n\t\tconst { stylesLoaded } = this.applyCSS(auxiliaryWindow, disposables);\n\t\tconst container = this.applyHTML(auxiliaryWindow, disposables);\n\n\t\treturn { stylesLoaded, container };\n\t}\n\n\tprivate applyMeta(auxiliaryWindow: CodeWindow): void {\n\t\tfor (const metaTag of ['meta[charset=\"utf-8\"]', 'meta[http-equiv=\"Content-Security-Policy\"]', 'meta[name=\"viewport\"]', 'meta[name=\"theme-color\"]']) {\n\t\t\tconst metaElement = mainWindow.document.querySelector(metaTag);\n\t\t\tif (metaElement) {\n\t\t\t\tconst clonedMetaElement = createMetaElement(auxiliaryWindow.document.head);\n\t\t\t\tcopyAttributes(metaElement, clonedMetaElement);\n\n\t\t\t\tif (metaTag === 'meta[http-equiv=\"Content-Security-Policy\"]') {\n\t\t\t\t\tconst content = clonedMetaElement.getAttribute('content');\n\t\t\t\t\tif (content) {\n\t\t\t\t\t\tclonedMetaElement.setAttribute('content', content.replace(/(script-src[^\\;]*)/, `script-src 'none'`));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst originalIconLinkTag = mainWindow.document.querySelector('link[rel=\"icon\"]');\n\t\tif (originalIconLinkTag) {\n\t\t\tconst icon = createLinkElement(auxiliaryWindow.document.head);\n\t\t\tcopyAttributes(originalIconLinkTag, icon);\n\t\t}\n\t}\n\n\tprivate applyCSS(auxiliaryWindow: CodeWindow, disposables: DisposableStore) {\n\t\tmark('code/auxiliaryWindow/willApplyCSS');\n\n\t\tconst mapOriginalToClone = new Map<Node /* original */, Node /* clone */>();\n\n\t\tconst stylesLoaded = new Barrier();\n\t\tstylesLoaded.wait().then(() => mark('code/auxiliaryWindow/didLoadCSSStyles'));\n\n\t\tconst pendingLinksDisposables = disposables.add(new DisposableStore());\n\n\t\tlet pendingLinksToSettle = 0;\n\t\tfunction onLinkSettled() {\n\t\t\tif (--pendingLinksToSettle === 0) {\n\t\t\t\tpendingLinksDisposables.dispose();\n\t\t\t\tstylesLoaded.open();\n\t\t\t}\n\t\t}\n\n\t\tfunction cloneNode(originalNode: Element): void {\n\t\t\tif (isGlobalStylesheet(originalNode)) {\n\t\t\t\treturn; // global stylesheets are handled by `cloneGlobalStylesheets` below\n\t\t\t}\n\n\t\t\tconst clonedNode = auxiliaryWindow.document.head.appendChild(originalNode.cloneNode(true));\n\t\t\tif (originalNode.tagName.toLowerCase() === 'link') {\n\t\t\t\tpendingLinksToSettle++;\n\n\t\t\t\tpendingLinksDisposables.add(addDisposableListener(clonedNode, 'load', onLinkSettled));\n\t\t\t\tpendingLinksDisposables.add(addDisposableListener(clonedNode, 'error', onLinkSettled));\n\t\t\t}\n\n\t\t\tmapOriginalToClone.set(originalNode, clonedNode);\n\t\t}\n\n\t\t// Clone all style elements and stylesheet links from the window to the child window\n\t\t// and keep track of <link> elements to settle to signal that styles have loaded\n\t\t// Increment pending links right from the beginning to ensure we only settle when\n\t\t// all style related nodes have been cloned.\n\t\tpendingLinksToSettle++;\n\t\ttry {\n\t\t\tfor (const originalNode of mainWindow.document.head.querySelectorAll('link[rel=\"stylesheet\"], style')) {\n\t\t\t\tcloneNode(originalNode);\n\t\t\t}\n\t\t} finally {\n\t\t\tonLinkSettled();\n\t\t}\n\n\t\t// Global stylesheets in <head> are cloned in a special way because the mutation\n\t\t// observer is not firing for changes done via `style.sheet` API. Only text changes\n\t\t// can be observed.\n\t\tdisposables.add(cloneGlobalStylesheets(auxiliaryWindow));\n\n\t\t// Listen to new stylesheets as they are being added or removed in the main window\n\t\t// and apply to child window (including changes to existing stylesheets elements)\n\t\tdisposables.add(sharedMutationObserver.observe(mainWindow.document.head, disposables, { childList: true, subtree: true })(mutations => {\n\t\t\tfor (const mutation of mutations) {\n\t\t\t\tif (\n\t\t\t\t\tmutation.type !== 'childList' ||\t\t\t\t\t\t// only interested in added/removed nodes\n\t\t\t\t\tmutation.target.nodeName.toLowerCase() === 'title' || \t// skip over title changes that happen frequently\n\t\t\t\t\tmutation.target.nodeName.toLowerCase() === 'script' || \t// block <script> changes that are unsupported anyway\n\t\t\t\t\tmutation.target.nodeName.toLowerCase() === 'meta'\t\t// do not observe <meta> elements for now\n\t\t\t\t) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tfor (const node of mutation.addedNodes) {\n\n\t\t\t\t\t// <style>/<link> element was added\n\t\t\t\t\tif (isHTMLElement(node) && (node.tagName.toLowerCase() === 'style' || node.tagName.toLowerCase() === 'link')) {\n\t\t\t\t\t\tcloneNode(node);\n\t\t\t\t\t}\n\n\t\t\t\t\t// text-node was changed, try to apply to our clones\n\t\t\t\t\telse if (node.nodeType === Node.TEXT_NODE && node.parentNode) {\n\t\t\t\t\t\tconst clonedNode = mapOriginalToClone.get(node.parentNode);\n\t\t\t\t\t\tif (clonedNode) {\n\t\t\t\t\t\t\tclonedNode.textContent = node.textContent;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tfor (const node of mutation.removedNodes) {\n\t\t\t\t\tconst clonedNode = mapOriginalToClone.get(node);\n\t\t\t\t\tif (clonedNode) {\n\t\t\t\t\t\tclonedNode.parentNode?.removeChild(clonedNode);\n\t\t\t\t\t\tmapOriginalToClone.delete(node);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\n\t\tmark('code/auxiliaryWindow/didApplyCSS');\n\n\t\treturn { stylesLoaded };\n\t}\n\n\tprivate applyHTML(auxiliaryWindow: CodeWindow, disposables: DisposableStore): HTMLElement {\n\t\tmark('code/auxiliaryWindow/willApplyHTML');\n\n\t\t// Create workbench container and apply classes\n\t\tconst container = document.createElement('div');\n\t\tcontainer.setAttribute('role', 'application');\n\t\tposition(container, 0, 0, 0, 0, 'relative');\n\t\tcontainer.style.display = 'flex';\n\t\tcontainer.style.height = '100%';\n\t\tcontainer.style.flexDirection = 'column';\n\t\tauxiliaryWindow.document.body.append(container);\n\n\t\t// Track attributes\n\t\tdisposables.add(trackAttributes(mainWindow.document.documentElement, auxiliaryWindow.document.documentElement));\n\t\tdisposables.add(trackAttributes(mainWindow.document.body, auxiliaryWindow.document.body));\n\t\tdisposables.add(trackAttributes(this.layoutService.mainContainer, container, ['class'])); // only class attribute\n\n\t\tmark('code/auxiliaryWindow/didApplyHTML');\n\n\t\treturn container;\n\t}\n\n\tgetWindow(windowId: number): IAuxiliaryWindow | undefined {\n\t\treturn this.windows.get(windowId);\n\t}\n}\n\nregisterSingleton(IAuxiliaryWindowService, BrowserAuxiliaryWindowService, InstantiationType.Delayed);\n"],
  "mappings": "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",
  "names": ["AuxiliaryWindowMode"]
}
