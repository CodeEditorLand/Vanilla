var U=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var I=(g,m,e,o)=>{for(var n=o>1?void 0:o?B(m,e):m,r=g.length-1,t;r>=0;r--)(t=g[r])&&(n=(o?t(m,e,n):t(n))||n);return o&&n&&U(m,e,n),n},p=(g,m)=>(e,o)=>m(e,o,g);import{getZoomLevel as M}from"../../../../base/browser/browser.js";import{EventHelper as x,EventType as y,ModifierKeyEmitter as N,addDisposableListener as d,cloneGlobalStylesheets as H,copyAttributes as L,createLinkElement as k,createMetaElement as P,getActiveWindow as R,getClientArea as F,getWindowId as z,isGlobalStylesheet as V,isHTMLElement as q,position as Z,registerWindow as G,sharedMutationObserver as X,trackAttributes as D}from"../../../../base/browser/dom.js";import{ensureCodeWindow as $,mainWindow as h}from"../../../../base/browser/window.js";import{coalesce as j}from"../../../../base/common/arrays.js";import{Barrier as Y}from"../../../../base/common/async.js";import{onUnexpectedError as J}from"../../../../base/common/errors.js";import{Emitter as W,Event as K}from"../../../../base/common/event.js";import{Disposable as Q,DisposableStore as E,toDisposable as ee}from"../../../../base/common/lifecycle.js";import{mark as v}from"../../../../base/common/performance.js";import{isFirefox as oe,isWeb as C}from"../../../../base/common/platform.js";import ne from"../../../../base/common/severity.js";import{localize as b}from"../../../../nls.js";import{IConfigurationService as A}from"../../../../platform/configuration/common/configuration.js";import{IDialogService as te}from"../../../../platform/dialogs/common/dialogs.js";import{InstantiationType as ie,registerSingleton as re}from"../../../../platform/instantiation/common/extensions.js";import{createDecorator as de}from"../../../../platform/instantiation/common/instantiation.js";import{ITelemetryService as ae}from"../../../../platform/telemetry/common/telemetry.js";import{WindowMinimumSize as O}from"../../../../platform/window/common/window.js";import{BaseWindow as se}from"../../../browser/window.js";import{IWorkbenchEnvironmentService as _}from"../../environment/common/environmentService.js";import{IHostService as T}from"../../host/browser/host.js";import{IWorkbenchLayoutService as le}from"../../layout/browser/layoutService.js";const ce=de("auxiliaryWindowService");var pe=(o=>(o[o.Maximized=0]="Maximized",o[o.Normal=1]="Normal",o[o.Fullscreen=2]="Fullscreen",o))(pe||{});let S=class extends se{constructor(e,o,n,r,t,i){super(e,void 0,t,i);this.window=e;this.container=o;this.configurationService=r;this.whenStylesHaveLoaded=n.wait().then(()=>{}),this.registerListeners()}_onWillLayout=this._register(new W);onWillLayout=this._onWillLayout.event;_onDidLayout=this._register(new W);onDidLayout=this._onDidLayout.event;_onBeforeUnload=this._register(new W);onBeforeUnload=this._onBeforeUnload.event;_onUnload=this._register(new W);onUnload=this._onUnload.event;_onWillDispose=this._register(new W);onWillDispose=this._onWillDispose.event;whenStylesHaveLoaded;registerListeners(){this._register(d(this.window,y.BEFORE_UNLOAD,e=>this.handleBeforeUnload(e))),this._register(d(this.window,y.UNLOAD,()=>this.handleUnload())),this._register(d(this.window,"unhandledrejection",e=>{J(e.reason),e.preventDefault()})),this._register(d(this.window,y.RESIZE,()=>this.layout())),this._register(d(this.container,y.SCROLL,()=>this.container.scrollTop=0)),C?(this._register(d(this.container,y.DROP,e=>x.stop(e,!0))),this._register(d(this.container,y.WHEEL,e=>e.preventDefault(),{passive:!1})),this._register(d(this.container,y.CONTEXT_MENU,e=>x.stop(e,!0)))):(this._register(d(this.window.document.body,y.DRAG_OVER,e=>x.stop(e))),this._register(d(this.window.document.body,y.DROP,e=>x.stop(e))))}handleBeforeUnload(e){let o;if(this._onBeforeUnload.fire({veto(t){t&&(o=t)}}),o){this.handleVetoBeforeClose(e,o);return}const n=this.configurationService.getValue("window.confirmBeforeClose");(n==="always"||n==="keyboardOnly"&&N.getInstance().isModifierPressed)&&this.confirmBeforeClose(e)}handleVetoBeforeClose(e,o){this.preventUnload(e)}preventUnload(e){e.preventDefault(),e.returnValue=b("lifecycleVeto","Changes that you made may not be saved. Please check press 'Cancel' and try again.")}confirmBeforeClose(e){this.preventUnload(e)}handleUnload(){this._onUnload.fire()}layout(){const e=F(this.window.document.body,this.container);this._onWillLayout.fire(e),this._onDidLayout.fire(e)}createState(){return{bounds:{x:this.window.screenX,y:this.window.screenY,width:this.window.outerWidth,height:this.window.outerHeight},zoomLevel:M(this.window)}}dispose(){this._store.isDisposed||(this._onWillDispose.fire(),super.dispose())}};S=I([p(3,A),p(4,T),p(5,_)],S);let w=class extends Q{constructor(e,o,n,r,t,i){super();this.layoutService=e;this.dialogService=o;this.configurationService=n;this.telemetryService=r;this.hostService=t;this.environmentService=i}static DEFAULT_SIZE={width:800,height:600};static WINDOW_IDS=z(h)+1;_onDidOpenAuxiliaryWindow=this._register(new W);onDidOpenAuxiliaryWindow=this._onDidOpenAuxiliaryWindow.event;windows=new Map;async open(e){v("code/auxiliaryWindow/willOpen");const o=await this.openWindow(e);if(!o)throw new Error(b("unableToOpenWindowError","Unable to open a new window."));const n=await this.resolveWindowId(o);$(o,n);const r=new E,{container:t,stylesLoaded:i}=this.createContainer(o,r,e),l=this.createAuxiliaryWindow(o,t,i),u=new E;this.windows.set(o.vscodeWindowId,l),u.add(ee(()=>this.windows.delete(o.vscodeWindowId)));const a=new E;return K.once(l.onWillDispose)(()=>{o.close(),r.dispose(),u.dispose(),a.dispose()}),u.add(G(o)),this._onDidOpenAuxiliaryWindow.fire({window:l,disposables:a}),v("code/auxiliaryWindow/didOpen"),this.telemetryService.publicLog2("auxiliaryWindowOpen",{bounds:!!e?.bounds}),l}createAuxiliaryWindow(e,o,n){return new S(e,o,n,this.configurationService,this.hostService,this.environmentService)}async openWindow(e){const o=R(),n={x:o.screenX,y:o.screenY,width:o.outerWidth,height:o.outerHeight},r=Math.max(e?.bounds?.width??w.DEFAULT_SIZE.width,O.WIDTH),t=Math.max(e?.bounds?.height??w.DEFAULT_SIZE.height,O.HEIGHT);let i={x:e?.bounds?.x??Math.max(n.x+n.width/2-r/2,0),y:e?.bounds?.y??Math.max(n.y+n.height/2-t/2,0),width:r,height:t};!e?.bounds&&i.x===n.x&&i.y===n.y&&(i={...i,x:i.x+30,y:i.y+30});const l=j(["popup=yes",`left=${i.x}`,`top=${i.y}`,`width=${i.width}`,`height=${i.height}`,e?.nativeTitlebar?"window-native-titlebar=yes":void 0,e?.disableFullscreen?"window-disable-fullscreen=yes":void 0,e?.mode===0?"window-maximized=yes":void 0,e?.mode===2?"window-fullscreen=yes":void 0]),u=h.open(oe?"":"about:blank",void 0,l.join(","));return!u&&C?(await this.dialogService.prompt({type:ne.Warning,message:b("unableToOpenWindow","The browser interrupted the opening of a new window. Press 'Retry' to try again."),detail:b("unableToOpenWindowDetail","To avoid this problem in the future, please ensure to allow popups for this website."),buttons:[{label:b({key:"retry",comment:["&& denotes a mnemonic"]},"&&Retry"),run:()=>this.openWindow(e)}],cancelButton:!0})).result:u?.window}async resolveWindowId(e){return w.WINDOW_IDS++}createContainer(e,o,n){e.document.createElement=function(){throw new Error('Not allowed to create elements in child window JavaScript context. Always use the main window so that "xyz instanceof HTMLElement" continues to work.')},this.applyMeta(e);const{stylesLoaded:r}=this.applyCSS(e,o),t=this.applyHTML(e,o);return{stylesLoaded:r,container:t}}applyMeta(e){for(const n of['meta[charset="utf-8"]','meta[http-equiv="Content-Security-Policy"]','meta[name="viewport"]','meta[name="theme-color"]']){const r=h.document.querySelector(n);if(r){const t=P(e.document.head);if(L(r,t),n==='meta[http-equiv="Content-Security-Policy"]'){const i=t.getAttribute("content");i&&t.setAttribute("content",i.replace(/(script-src[^\;]*)/,"script-src 'none'"))}}}const o=h.document.querySelector('link[rel="icon"]');if(o){const n=k(e.document.head);L(o,n)}}applyCSS(e,o){v("code/auxiliaryWindow/willApplyCSS");const n=new Map,r=new Y;r.wait().then(()=>v("code/auxiliaryWindow/didLoadCSSStyles"));const t=o.add(new E);let i=0;function l(){--i===0&&(t.dispose(),r.open())}function u(a){if(V(a))return;const c=e.document.head.appendChild(a.cloneNode(!0));a.tagName.toLowerCase()==="link"&&(i++,t.add(d(c,"load",l)),t.add(d(c,"error",l))),n.set(a,c)}i++;try{for(const a of h.document.head.querySelectorAll('link[rel="stylesheet"], style'))u(a)}finally{l()}return o.add(H(e)),o.add(X.observe(h.document.head,o,{childList:!0,subtree:!0})(a=>{for(const c of a)if(!(c.type!=="childList"||c.target.nodeName.toLowerCase()==="title"||c.target.nodeName.toLowerCase()==="script"||c.target.nodeName.toLowerCase()==="meta")){for(const s of c.addedNodes)if(q(s)&&(s.tagName.toLowerCase()==="style"||s.tagName.toLowerCase()==="link"))u(s);else if(s.nodeType===Node.TEXT_NODE&&s.parentNode){const f=n.get(s.parentNode);f&&(f.textContent=s.textContent)}for(const s of c.removedNodes){const f=n.get(s);f&&(f.parentNode?.removeChild(f),n.delete(s))}}})),v("code/auxiliaryWindow/didApplyCSS"),{stylesLoaded:r}}applyHTML(e,o){v("code/auxiliaryWindow/willApplyHTML");const n=document.createElement("div");return n.setAttribute("role","application"),Z(n,0,0,0,0,"relative"),n.style.display="flex",n.style.height="100%",n.style.flexDirection="column",e.document.body.append(n),o.add(D(h.document.documentElement,e.document.documentElement)),o.add(D(h.document.body,e.document.body)),o.add(D(this.layoutService.mainContainer,n,["class"])),v("code/auxiliaryWindow/didApplyHTML"),n}getWindow(e){return this.windows.get(e)}};w=I([p(0,le),p(1,te),p(2,A),p(3,ae),p(4,T),p(5,_)],w),re(ce,w,ie.Delayed);export{S as AuxiliaryWindow,pe as AuxiliaryWindowMode,w as BrowserAuxiliaryWindowService,ce as IAuxiliaryWindowService};
