var b=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var N=(f,l,e,i)=>{for(var t=i>1?void 0:i?D(l,e):l,o=f.length-1,r;o>=0;o--)(r=f[o])&&(t=(i?r(l,e,t):r(t))||t);return i&&t&&b(l,e,t),t},A=(f,l)=>(e,i)=>l(e,i,f);import{Action as _}from"../../../../base/common/actions.js";import{Emitter as v,Event as E}from"../../../../base/common/event.js";import{Disposable as C,DisposableStore as T}from"../../../../base/common/lifecycle.js";import{localize as w}from"../../../../nls.js";import{InstantiationType as P,registerSingleton as L}from"../../../../platform/instantiation/common/extensions.js";import{INotificationService as M,NeverShowAgainScope as I,NoOpNotification as O,NotificationsFilter as s,Severity as m,isNotificationSource as k}from"../../../../platform/notification/common/notification.js";import{IStorageService as G,StorageScope as c,StorageTarget as g}from"../../../../platform/storage/common/storage.js";import{ChoiceAction as K,NotificationChangeType as u,NotificationsModel as B}from"../../../common/notifications.js";let n=class extends C{constructor(e){super();this.storageService=e;this.updateFilters(),this.registerListeners()}model=this._register(new B);_onDidAddNotification=this._register(new v);onDidAddNotification=this._onDidAddNotification.event;_onDidRemoveNotification=this._register(new v);onDidRemoveNotification=this._onDidRemoveNotification.event;registerListeners(){this._register(this.model.onDidChangeNotification(e=>{switch(e.kind){case u.ADD:case u.REMOVE:{const i=typeof e.item.sourceId=="string"&&typeof e.item.source=="string"?{id:e.item.sourceId,label:e.item.source}:e.item.source,t={message:e.item.message.original,severity:e.item.severity,source:i,priority:e.item.priority};e.kind===u.ADD&&(k(i)&&(this.mapSourceToFilter.has(i.id)?this.updateSourceFilter(i):this.setFilter({...i,filter:s.OFF})),this._onDidAddNotification.fire(t)),e.kind===u.REMOVE&&this._onDidRemoveNotification.fire(t);break}}}))}static GLOBAL_FILTER_SETTINGS_KEY="notifications.doNotDisturbMode";static PER_SOURCE_FILTER_SETTINGS_KEY="notifications.perSourceDoNotDisturbMode";_onDidChangeFilter=this._register(new v);onDidChangeFilter=this._onDidChangeFilter.event;globalFilterEnabled=this.storageService.getBoolean(n.GLOBAL_FILTER_SETTINGS_KEY,c.APPLICATION,!1);mapSourceToFilter=(()=>{const e=new Map;for(const i of this.storageService.getObject(n.PER_SOURCE_FILTER_SETTINGS_KEY,c.APPLICATION,[]))e.set(i.id,i);return e})();setFilter(e){if(typeof e=="number"){if(this.globalFilterEnabled===(e===s.ERROR))return;this.globalFilterEnabled=e===s.ERROR,this.storageService.store(n.GLOBAL_FILTER_SETTINGS_KEY,this.globalFilterEnabled,c.APPLICATION,g.MACHINE),this.updateFilters(),this._onDidChangeFilter.fire()}else{const i=this.mapSourceToFilter.get(e.id);if(i?.filter===e.filter&&i.label===e.label)return;this.mapSourceToFilter.set(e.id,{id:e.id,label:e.label,filter:e.filter}),this.saveSourceFilters(),this.updateFilters()}}getFilter(e){return e?this.mapSourceToFilter.get(e.id)?.filter??s.OFF:this.globalFilterEnabled?s.ERROR:s.OFF}updateSourceFilter(e){const i=this.mapSourceToFilter.get(e.id);i&&i.label!==e.label&&(this.mapSourceToFilter.set(e.id,{id:e.id,label:e.label,filter:i.filter}),this.saveSourceFilters())}saveSourceFilters(){this.storageService.store(n.PER_SOURCE_FILTER_SETTINGS_KEY,JSON.stringify([...this.mapSourceToFilter.values()]),c.APPLICATION,g.MACHINE)}getFilters(){return[...this.mapSourceToFilter.values()]}updateFilters(){this.model.setFilter({global:this.globalFilterEnabled?s.ERROR:s.OFF,sources:new Map([...this.mapSourceToFilter.values()].map(e=>[e.id,e.filter]))})}removeFilter(e){this.mapSourceToFilter.delete(e)&&(this.saveSourceFilters(),this.updateFilters())}info(e){if(Array.isArray(e)){for(const i of e)this.info(i);return}this.model.addNotification({severity:m.Info,message:e})}warn(e){if(Array.isArray(e)){for(const i of e)this.warn(i);return}this.model.addNotification({severity:m.Warning,message:e})}error(e){if(Array.isArray(e)){for(const i of e)this.error(i);return}this.model.addNotification({severity:m.Error,message:e})}notify(e){const i=new T;if(e.neverShowAgain){const o=this.toStorageScope(e.neverShowAgain),r=e.neverShowAgain.id;if(this.storageService.getBoolean(r,o))return new O;const S=i.add(new _("workbench.notification.neverShowAgain",w("neverShowAgain","Don't Show Again"),void 0,!0,async()=>{t.close(),this.storageService.store(r,!0,o,g.USER)})),a={primary:e.actions?.primary||[],secondary:e.actions?.secondary||[]};e.neverShowAgain.isSecondary?a.secondary=[...a.secondary,S]:a.primary=[S,...a.primary],e.actions=a}const t=this.model.addNotification(e);return E.once(t.onDidClose)(()=>i.dispose()),t}toStorageScope(e){switch(e.scope){case I.APPLICATION:return c.APPLICATION;case I.PROFILE:return c.PROFILE;case I.WORKSPACE:return c.WORKSPACE;default:return c.APPLICATION}}prompt(e,i,t,o){const r=new T;if(o?.neverShowAgain){const p=this.toStorageScope(o.neverShowAgain),h=o.neverShowAgain.id;if(this.storageService.getBoolean(h,p))return new O;const d={label:w("neverShowAgain","Don't Show Again"),run:()=>this.storageService.store(h,!0,p,g.USER),isSecondary:o.neverShowAgain.isSecondary};o.neverShowAgain.isSecondary?t=[...t,d]:t=[d,...t]}let S=!1;const a=[],F=[];t.forEach((p,h)=>{const d=new K(`workbench.dialog.choice.${h}`,p);p.isSecondary?F.push(d):a.push(d),r.add(d.onDidRun(()=>{S=!0,p.keepOpen||y.close()})),r.add(d)});const R={primary:a,secondary:F},y=this.notify({severity:e,message:i,actions:R,sticky:o?.sticky,priority:o?.priority});return E.once(y.onDidClose)(()=>{r.dispose(),o&&typeof o.onCancel=="function"&&!S&&o.onCancel()}),y}status(e,i){return this.model.showStatusMessage(e,i)}};n=N([A(0,G)],n),L(M,n,P.Delayed);export{n as NotificationService};
