var b=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var y=(h,l,i,e)=>{for(var t=e>1?void 0:e?D(l,i):l,o=h.length-1,r;o>=0;o--)(r=h[o])&&(t=(e?r(l,i,t):r(t))||t);return e&&t&&b(l,i,t),t},A=(h,l)=>(i,e)=>l(i,e,h);import{localize as E}from"../../../../nls.js";import{INotificationService as _,Severity as I,NoOpNotification as T,NeverShowAgainScope as m,NotificationsFilter as s,isNotificationSource as C}from"../../../../platform/notification/common/notification.js";import{NotificationsModel as P,ChoiceAction as L,NotificationChangeType as p}from"../../../common/notifications.js";import{Disposable as M,DisposableStore as w}from"../../../../base/common/lifecycle.js";import{Emitter as F,Event as O}from"../../../../base/common/event.js";import{InstantiationType as k,registerSingleton as G}from"../../../../platform/instantiation/common/extensions.js";import{Action as K}from"../../../../base/common/actions.js";import{IStorageService as B,StorageScope as c,StorageTarget as u}from"../../../../platform/storage/common/storage.js";let n=class extends M{constructor(i){super();this.storageService=i;this.updateFilters(),this.registerListeners()}model=this._register(new P);_onDidAddNotification=this._register(new F);onDidAddNotification=this._onDidAddNotification.event;_onDidRemoveNotification=this._register(new F);onDidRemoveNotification=this._onDidRemoveNotification.event;registerListeners(){this._register(this.model.onDidChangeNotification(i=>{switch(i.kind){case p.ADD:case p.REMOVE:{const e=typeof i.item.sourceId=="string"&&typeof i.item.source=="string"?{id:i.item.sourceId,label:i.item.source}:i.item.source,t={message:i.item.message.original,severity:i.item.severity,source:e,priority:i.item.priority};i.kind===p.ADD&&(C(e)&&(this.mapSourceToFilter.has(e.id)?this.updateSourceFilter(e):this.setFilter({...e,filter:s.OFF})),this._onDidAddNotification.fire(t)),i.kind===p.REMOVE&&this._onDidRemoveNotification.fire(t);break}}}))}static GLOBAL_FILTER_SETTINGS_KEY="notifications.doNotDisturbMode";static PER_SOURCE_FILTER_SETTINGS_KEY="notifications.perSourceDoNotDisturbMode";_onDidChangeFilter=this._register(new F);onDidChangeFilter=this._onDidChangeFilter.event;globalFilterEnabled=this.storageService.getBoolean(n.GLOBAL_FILTER_SETTINGS_KEY,c.APPLICATION,!1);mapSourceToFilter=(()=>{const i=new Map;for(const e of this.storageService.getObject(n.PER_SOURCE_FILTER_SETTINGS_KEY,c.APPLICATION,[]))i.set(e.id,e);return i})();setFilter(i){if(typeof i=="number"){if(this.globalFilterEnabled===(i===s.ERROR))return;this.globalFilterEnabled=i===s.ERROR,this.storageService.store(n.GLOBAL_FILTER_SETTINGS_KEY,this.globalFilterEnabled,c.APPLICATION,u.MACHINE),this.updateFilters(),this._onDidChangeFilter.fire()}else{const e=this.mapSourceToFilter.get(i.id);if(e?.filter===i.filter&&e.label===i.label)return;this.mapSourceToFilter.set(i.id,{id:i.id,label:i.label,filter:i.filter}),this.saveSourceFilters(),this.updateFilters()}}getFilter(i){return i?this.mapSourceToFilter.get(i.id)?.filter??s.OFF:this.globalFilterEnabled?s.ERROR:s.OFF}updateSourceFilter(i){const e=this.mapSourceToFilter.get(i.id);e&&e.label!==i.label&&(this.mapSourceToFilter.set(i.id,{id:i.id,label:i.label,filter:e.filter}),this.saveSourceFilters())}saveSourceFilters(){this.storageService.store(n.PER_SOURCE_FILTER_SETTINGS_KEY,JSON.stringify([...this.mapSourceToFilter.values()]),c.APPLICATION,u.MACHINE)}getFilters(){return[...this.mapSourceToFilter.values()]}updateFilters(){this.model.setFilter({global:this.globalFilterEnabled?s.ERROR:s.OFF,sources:new Map([...this.mapSourceToFilter.values()].map(i=>[i.id,i.filter]))})}removeFilter(i){this.mapSourceToFilter.delete(i)&&(this.saveSourceFilters(),this.updateFilters())}info(i){if(Array.isArray(i)){for(const e of i)this.info(e);return}this.model.addNotification({severity:I.Info,message:i})}warn(i){if(Array.isArray(i)){for(const e of i)this.warn(e);return}this.model.addNotification({severity:I.Warning,message:i})}error(i){if(Array.isArray(i)){for(const e of i)this.error(e);return}this.model.addNotification({severity:I.Error,message:i})}notify(i){const e=new w;if(i.neverShowAgain){const o=this.toStorageScope(i.neverShowAgain),r=i.neverShowAgain.id;if(this.storageService.getBoolean(r,o))return new T;const f=e.add(new K("workbench.notification.neverShowAgain",E("neverShowAgain","Don't Show Again"),void 0,!0,async()=>{t.close(),this.storageService.store(r,!0,o,u.USER)})),a={primary:i.actions?.primary||[],secondary:i.actions?.secondary||[]};i.neverShowAgain.isSecondary?a.secondary=[...a.secondary,f]:a.primary=[f,...a.primary],i.actions=a}const t=this.model.addNotification(i);return O.once(t.onDidClose)(()=>e.dispose()),t}toStorageScope(i){switch(i.scope){case m.APPLICATION:return c.APPLICATION;case m.PROFILE:return c.PROFILE;case m.WORKSPACE:return c.WORKSPACE;default:return c.APPLICATION}}prompt(i,e,t,o){const r=new w;if(o?.neverShowAgain){const S=this.toStorageScope(o.neverShowAgain),g=o.neverShowAgain.id;if(this.storageService.getBoolean(g,S))return new T;const d={label:E("neverShowAgain","Don't Show Again"),run:()=>this.storageService.store(g,!0,S,u.USER),isSecondary:o.neverShowAgain.isSecondary};o.neverShowAgain.isSecondary?t=[...t,d]:t=[d,...t]}let f=!1;const a=[],N=[];t.forEach((S,g)=>{const d=new L(`workbench.dialog.choice.${g}`,S);S.isSecondary?N.push(d):a.push(d),r.add(d.onDidRun(()=>{f=!0,S.keepOpen||v.close()})),r.add(d)});const R={primary:a,secondary:N},v=this.notify({severity:i,message:e,actions:R,sticky:o?.sticky,priority:o?.priority});return O.once(v.onDidClose)(()=>{r.dispose(),o&&typeof o.onCancel=="function"&&!f&&o.onCancel()}),v}status(i,e){return this.model.showStatusMessage(i,e)}};n=y([A(0,B)],n),G(_,n,k.Delayed);export{n as NotificationService};
