var b=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var y=(h,l,i,e)=>{for(var t=e>1?void 0:e?D(l,i):l,o=h.length-1,r;o>=0;o--)(r=h[o])&&(t=(e?r(l,i,t):r(t))||t);return e&&t&&b(l,i,t),t},A=(h,l)=>(i,e)=>l(i,e,h);import{Action as _}from"../../../../../vs/base/common/actions.js";import{Emitter as I,Event as E}from"../../../../../vs/base/common/event.js";import{Disposable as C,DisposableStore as T}from"../../../../../vs/base/common/lifecycle.js";import{localize as w}from"../../../../../vs/nls.js";import{InstantiationType as P,registerSingleton as L}from"../../../../../vs/platform/instantiation/common/extensions.js";import{INotificationService as M,isNotificationSource as k,NeverShowAgainScope as m,NoOpNotification as O,NotificationsFilter as s,Severity as F}from"../../../../../vs/platform/notification/common/notification.js";import{IStorageService as G,StorageScope as c,StorageTarget as p}from"../../../../../vs/platform/storage/common/storage.js";import{ChoiceAction as K,NotificationChangeType as u,NotificationsModel as B}from"../../../../../vs/workbench/common/notifications.js";let n=class extends C{constructor(i){super();this.storageService=i;this.updateFilters(),this.registerListeners()}model=this._register(new B);_onDidAddNotification=this._register(new I);onDidAddNotification=this._onDidAddNotification.event;_onDidRemoveNotification=this._register(new I);onDidRemoveNotification=this._onDidRemoveNotification.event;registerListeners(){this._register(this.model.onDidChangeNotification(i=>{switch(i.kind){case u.ADD:case u.REMOVE:{const e=typeof i.item.sourceId=="string"&&typeof i.item.source=="string"?{id:i.item.sourceId,label:i.item.source}:i.item.source,t={message:i.item.message.original,severity:i.item.severity,source:e,priority:i.item.priority};i.kind===u.ADD&&(k(e)&&(this.mapSourceToFilter.has(e.id)?this.updateSourceFilter(e):this.setFilter({...e,filter:s.OFF})),this._onDidAddNotification.fire(t)),i.kind===u.REMOVE&&this._onDidRemoveNotification.fire(t);break}}}))}static GLOBAL_FILTER_SETTINGS_KEY="notifications.doNotDisturbMode";static PER_SOURCE_FILTER_SETTINGS_KEY="notifications.perSourceDoNotDisturbMode";_onDidChangeFilter=this._register(new I);onDidChangeFilter=this._onDidChangeFilter.event;globalFilterEnabled=this.storageService.getBoolean(n.GLOBAL_FILTER_SETTINGS_KEY,c.APPLICATION,!1);mapSourceToFilter=(()=>{const i=new Map;for(const e of this.storageService.getObject(n.PER_SOURCE_FILTER_SETTINGS_KEY,c.APPLICATION,[]))i.set(e.id,e);return i})();setFilter(i){if(typeof i=="number"){if(this.globalFilterEnabled===(i===s.ERROR))return;this.globalFilterEnabled=i===s.ERROR,this.storageService.store(n.GLOBAL_FILTER_SETTINGS_KEY,this.globalFilterEnabled,c.APPLICATION,p.MACHINE),this.updateFilters(),this._onDidChangeFilter.fire()}else{const e=this.mapSourceToFilter.get(i.id);if(e?.filter===i.filter&&e.label===i.label)return;this.mapSourceToFilter.set(i.id,{id:i.id,label:i.label,filter:i.filter}),this.saveSourceFilters(),this.updateFilters()}}getFilter(i){return i?this.mapSourceToFilter.get(i.id)?.filter??s.OFF:this.globalFilterEnabled?s.ERROR:s.OFF}updateSourceFilter(i){const e=this.mapSourceToFilter.get(i.id);e&&e.label!==i.label&&(this.mapSourceToFilter.set(i.id,{id:i.id,label:i.label,filter:e.filter}),this.saveSourceFilters())}saveSourceFilters(){this.storageService.store(n.PER_SOURCE_FILTER_SETTINGS_KEY,JSON.stringify([...this.mapSourceToFilter.values()]),c.APPLICATION,p.MACHINE)}getFilters(){return[...this.mapSourceToFilter.values()]}updateFilters(){this.model.setFilter({global:this.globalFilterEnabled?s.ERROR:s.OFF,sources:new Map([...this.mapSourceToFilter.values()].map(i=>[i.id,i.filter]))})}removeFilter(i){this.mapSourceToFilter.delete(i)&&(this.saveSourceFilters(),this.updateFilters())}info(i){if(Array.isArray(i)){for(const e of i)this.info(e);return}this.model.addNotification({severity:F.Info,message:i})}warn(i){if(Array.isArray(i)){for(const e of i)this.warn(e);return}this.model.addNotification({severity:F.Warning,message:i})}error(i){if(Array.isArray(i)){for(const e of i)this.error(e);return}this.model.addNotification({severity:F.Error,message:i})}notify(i){const e=new T;if(i.neverShowAgain){const o=this.toStorageScope(i.neverShowAgain),r=i.neverShowAgain.id;if(this.storageService.getBoolean(r,o))return new O;const f=e.add(new _("workbench.notification.neverShowAgain",w("neverShowAgain","Don't Show Again"),void 0,!0,async()=>{t.close(),this.storageService.store(r,!0,o,p.USER)})),a={primary:i.actions?.primary||[],secondary:i.actions?.secondary||[]};i.neverShowAgain.isSecondary?a.secondary=[...a.secondary,f]:a.primary=[f,...a.primary],i.actions=a}const t=this.model.addNotification(i);return E.once(t.onDidClose)(()=>e.dispose()),t}toStorageScope(i){switch(i.scope){case m.APPLICATION:return c.APPLICATION;case m.PROFILE:return c.PROFILE;case m.WORKSPACE:return c.WORKSPACE;default:return c.APPLICATION}}prompt(i,e,t,o){const r=new T;if(o?.neverShowAgain){const S=this.toStorageScope(o.neverShowAgain),g=o.neverShowAgain.id;if(this.storageService.getBoolean(g,S))return new O;const d={label:w("neverShowAgain","Don't Show Again"),run:()=>this.storageService.store(g,!0,S,p.USER),isSecondary:o.neverShowAgain.isSecondary};o.neverShowAgain.isSecondary?t=[...t,d]:t=[d,...t]}let f=!1;const a=[],N=[];t.forEach((S,g)=>{const d=new K(`workbench.dialog.choice.${g}`,S);S.isSecondary?N.push(d):a.push(d),r.add(d.onDidRun(()=>{f=!0,S.keepOpen||v.close()})),r.add(d)});const R={primary:a,secondary:N},v=this.notify({severity:i,message:e,actions:R,sticky:o?.sticky,priority:o?.priority});return E.once(v.onDidClose)(()=>{r.dispose(),o&&typeof o.onCancel=="function"&&!f&&o.onCancel()}),v}status(i,e){return this.model.showStatusMessage(i,e)}};n=y([A(0,G)],n),L(M,n,P.Delayed);export{n as NotificationService};
