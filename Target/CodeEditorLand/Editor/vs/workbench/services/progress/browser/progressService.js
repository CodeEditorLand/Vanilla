var K=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var x=(h,w,e,o)=>{for(var s=o>1?void 0:o?$(w,e):w,r=h.length-1,t;r>=0;r--)(t=h[r])&&(s=(o?t(w,e,s):t(s))||s);return o&&s&&K(w,e,s),s},m=(h,w)=>(e,o)=>w(e,o,h);import"./media/progressService.css";import{EventHelper as U}from"../../../../base/browser/dom.js";import{Dialog as j}from"../../../../base/browser/ui/dialog/dialog.js";import{Action as O}from"../../../../base/common/actions.js";import{DeferredPromise as q,RunOnceScheduler as z,timeout as V}from"../../../../base/common/async.js";import{Emitter as L,Event as E}from"../../../../base/common/event.js";import{stripIcons as G}from"../../../../base/common/iconLabels.js";import{Disposable as _,DisposableStore as B,dispose as R,toDisposable as J}from"../../../../base/common/lifecycle.js";import{parseLinkedText as T}from"../../../../base/common/linkedText.js";import{localize as y}from"../../../../nls.js";import{InstantiationType as Q,registerSingleton as X}from"../../../../platform/instantiation/common/extensions.js";import{IKeybindingService as Y}from"../../../../platform/keybinding/common/keybinding.js";import{ResultKind as Z}from"../../../../platform/keybinding/common/keybindingResolver.js";import{ILayoutService as ee}from"../../../../platform/layout/browser/layoutService.js";import{INotificationService as re,NotificationPriority as I,NotificationsFilter as H,Severity as ie,isNotificationSource as te}from"../../../../platform/notification/common/notification.js";import{IProgressService as se,Progress as oe,ProgressLocation as P}from"../../../../platform/progress/common/progress.js";import{defaultButtonStyles as ne,defaultCheckboxStyles as ae,defaultDialogStyles as ce,defaultInputBoxStyles as de}from"../../../../platform/theme/browser/defaultStyles.js";import{IViewDescriptorService as le,ViewContainerLocation as k}from"../../../common/views.js";import{IActivityService as pe,ProgressBadge as ge}from"../../activity/common/activity.js";import{IPaneCompositePartService as ue}from"../../panecomposite/browser/panecomposite.js";import{IStatusbarService as me,StatusbarAlignment as fe}from"../../statusbar/browser/statusbar.js";import{IUserActivityService as ye}from"../../userActivity/common/userActivityService.js";import{IViewsService as Pe}from"../../views/common/viewsService.js";let b=class extends _{constructor(e,o,s,r,t,a,i,c,d){super();this.activityService=e;this.paneCompositeService=o;this.viewDescriptorService=s;this.viewsService=r;this.notificationService=t;this.statusbarService=a;this.layoutService=i;this.keybindingService=c;this.userActivityService=d}async withProgress(e,o,s){const{location:r}=e,t=async i=>{const c=this.userActivityService.markActive({whenHeldFor:15e3});try{return await o(i)}finally{c.dispose()}},a=i=>{const c=this.viewDescriptorService.getViewContainerById(i);if(c){const d=this.viewDescriptorService.getViewContainerLocation(c);if(d!==null)return this.withPaneCompositeProgress(i,d,t,{...e,location:i})}if(this.viewDescriptorService.getViewDescriptorById(i)!==null)return this.withViewProgress(i,t,{...e,location:i});throw new Error(`Bad progress location: ${i}`)};if(typeof r=="string")return a(r);switch(r){case P.Notification:{let i=e.priority;return i!==I.URGENT&&(this.notificationService.getFilter()===H.ERROR?i=I.SILENT:te(e.source)&&this.notificationService.getFilter(e.source)===H.ERROR&&(i=I.SILENT)),this.withNotificationProgress({...e,location:r,priority:i},t,s)}case P.Window:{const i=e.type;return e.command?this.withWindowProgress({...e,location:r,type:i},t):this.withNotificationProgress({delay:150,...e,priority:I.SILENT,location:P.Notification,type:i},t,s)}case P.Explorer:return this.withPaneCompositeProgress("workbench.view.explorer",k.Sidebar,t,{...e,location:r});case P.Scm:return a("workbench.scm");case P.Extensions:return this.withPaneCompositeProgress("workbench.view.extensions",k.Sidebar,t,{...e,location:r});case P.Dialog:return this.withDialogProgress(e,t,s);default:throw new Error(`Bad progress location: ${r}`)}}windowProgressStack=[];windowProgressStatusEntry=void 0;withWindowProgress(e,o){const s=[e,new oe(()=>this.updateWindowProgress())],r=o(s[1]);let t=setTimeout(()=>{t=void 0,this.windowProgressStack.unshift(s),this.updateWindowProgress(),Promise.all([V(150),r]).finally(()=>{const a=this.windowProgressStack.indexOf(s);this.windowProgressStack.splice(a,1),this.updateWindowProgress()})},150);return r.finally(()=>clearTimeout(t))}updateWindowProgress(e=0){if(e<this.windowProgressStack.length){const[o,s]=this.windowProgressStack[e],r=o.title,t=s.value&&s.value.message,a=o.command;let i,c;const d=o.source&&typeof o.source!="string"?o.source.label:o.source;if(r&&t)i=y("progress.text2","{0}: {1}",r,t),c=d?y("progress.title3","[{0}] {1}: {2}",d,r,t):i;else if(r)i=r,c=d?y("progress.title2","[{0}]: {1}",d,r):i;else if(t)i=t,c=d?y("progress.title2","[{0}]: {1}",d,t):i;else{this.updateWindowProgress(e+1);return}const l={name:y("status.progress","Progress Message"),text:i,showProgress:o.type||!0,ariaLabel:i,tooltip:c,command:a};this.windowProgressStatusEntry?this.windowProgressStatusEntry.update(l):this.windowProgressStatusEntry=this.statusbarService.addEntry(l,"status.progress",fe.LEFT)}else this.windowProgressStatusEntry?.dispose(),this.windowProgressStatusEntry=void 0}withNotificationProgress(e,o,s){const r=new class extends _{_onDidReport=this._register(new L);onDidReport=this._onDidReport.event;_onWillDispose=this._register(new L);onWillDispose=this._onWillDispose.event;_step=void 0;get step(){return this._step}_done=!1;get done(){return this._done}promise;constructor(){super(),this.promise=o(this),this.promise.finally(()=>{this.dispose()})}report(n){this._step=n,this._onDidReport.fire(n)}cancel(n){s?.(n),this.dispose()}dispose(){this._done=!0,this._onWillDispose.fire(),super.dispose()}},t=()=>{const n=new q;return this.withWindowProgress({location:P.Window,title:e.title?T(e.title).toString():void 0,command:"notifications.showList",type:e.type},p=>{function g(f){f.message&&p.report({message:T(f.message).toString()})}r.step&&g(r.step);const u=r.onDidReport(f=>g(f));return n.p.finally(()=>u.dispose()),E.once(r.onWillDispose)(()=>n.complete()),n.p}),J(()=>n.complete())},a=(n,p,g)=>{const u=new B,f=e.primaryActions?Array.from(e.primaryActions):[],M=e.secondaryActions?Array.from(e.secondaryActions):[];if(e.buttons&&e.buttons.forEach((v,F)=>{const N=new class extends O{constructor(){super(`progress.button.${v}`,v,void 0,!0)}async run(){r.cancel(F)}};u.add(N),f.push(N)}),e.cancellable){const v=new class extends O{constructor(){super("progress.cancel",y("cancel","Cancel"),void 0,!0)}async run(){r.cancel()}};u.add(v),f.push(v)}const C=this.notificationService.notify({severity:ie.Info,message:G(n),source:e.source,actions:{primary:f,secondary:M},progress:typeof g=="number"&&g>=0?{total:100,worked:g}:{infinite:!0},priority:p});let A;const W=v=>{R(A),!v&&!r.done&&(A=t())};return u.add(C.onDidChangeVisibility(W)),p===I.SILENT&&W(!1),E.once(C.onDidClose)(()=>u.dispose()),C},i=(n,p)=>{typeof p=="number"&&p>=0?(n.progress.total(100),n.progress.worked(p)):n.progress.infinite()};let c,d,l;const S=n=>{n?.message&&e.title?l=`${e.title}: ${n.message}`:l=e.title||n?.message,!c&&l&&(typeof e.delay=="number"&&e.delay>0?typeof d!="number"&&(d=setTimeout(()=>c=a(l,e.priority,n?.increment),e.delay)):c=a(l,e.priority,n?.increment)),c&&(l&&c.updateMessage(l),typeof n?.increment=="number"&&i(c,n.increment))};S(r.step);const D=r.onDidReport(n=>S(n));return E.once(r.onWillDispose)(()=>D.dispose()),(async()=>{try{typeof e.delay=="number"&&e.delay>0?await r.promise:await Promise.all([V(800),r.promise])}finally{clearTimeout(d),c?.close()}})(),r.promise}withPaneCompositeProgress(e,o,s,r){const t=this.paneCompositeService.getProgressIndicator(e,o),a=t?this.withCompositeProgress(t,s,r):s({report:()=>{}});return o===k.Sidebar&&this.showOnActivityBar(e,r,a),a}withViewProgress(e,o,s){const r=this.viewsService.getViewProgressIndicator(e),t=r?this.withCompositeProgress(r,o,s):o({report:()=>{}});if(this.viewDescriptorService.getViewLocationById(e)!==k.Sidebar)return t;const i=this.viewDescriptorService.getViewContainerByViewId(e)?.id;return i===void 0||this.showOnActivityBar(i,s,t),t}showOnActivityBar(e,o,s){let r,t=setTimeout(()=>{t=void 0;const a=this.activityService.showViewContainerActivity(e,{badge:new ge(()=>""),priority:100}),i=Date.now(),c=300;r={dispose(){const d=Date.now()-i;d<c?setTimeout(()=>a.dispose(),c-d):a.dispose()}}},o.delay||300);s.finally(()=>{clearTimeout(t),R(r)})}withCompositeProgress(e,o,s){let r;function t(i){let c,d;return typeof i<"u"&&(typeof i=="number"?c=i:typeof i.increment=="number"&&(c=i.total??100,d=i.increment)),typeof c=="number"?(r||(r=e.show(c,s.delay),a.catch(()=>{}).finally(()=>r?.done())),typeof d=="number"&&r.worked(d)):(r?.done(),e.showWhile(a,s.delay)),r}const a=o({report:i=>{t(i)}});return t(s.total),a}withDialogProgress(e,o,s){const r=new B,t=["workbench.action.quit","workbench.action.reloadWindow","copy","cut","editor.action.clipboardCopyAction","editor.action.clipboardCutAction"];let a;const i=n=>{const p=e.buttons||[];return e.sticky||p.push(e.cancellable?y("cancel","Cancel"):y("dismiss","Dismiss")),a=new j(this.layoutService.activeContainer,n,p,{type:"pending",detail:e.detail,cancelId:p.length-1,disableCloseAction:e.sticky,disableDefaultAction:e.sticky,keyEventProcessor:g=>{const u=this.keybindingService.softDispatch(g,this.layoutService.activeContainer);u.kind===Z.KbFound&&u.commandId&&(t.includes(u.commandId)||U.stop(g,!0))},buttonStyles:ne,checkboxStyles:ae,inputBoxStyles:de,dialogStyles:ce}),r.add(a),a.show().then(g=>{s?.(g.button),R(a)}),a};let c=e.delay??0,d;const l=r.add(new z(()=>{c=0,d&&!a?a=i(d):d&&a.updateMessage(d)},0)),S=n=>{d=n,l.isScheduled()||l.schedule(c)},D=o({report:n=>{S(n.message)}});return D.finally(()=>{R(r)}),e.title&&S(e.title),D}};b=x([m(0,pe),m(1,ue),m(2,le),m(3,Pe),m(4,re),m(5,me),m(6,ee),m(7,Y),m(8,ye)],b),X(se,b,Q.Delayed);export{b as ProgressService};
