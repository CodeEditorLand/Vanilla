import t from"assert";import{DecorationsService as v}from"../../browser/decorationsService.js";import"../../common/decorations.js";import{URI as c}from"../../../../../base/common/uri.js";import{Event as d,Emitter as g}from"../../../../../base/common/event.js";import*as b from"../../../../../base/common/resources.js";import"../../../../../base/common/cancellation.js";import{mock as w}from"../../../../../base/test/common/mock.js";import"../../../../../platform/uriIdentity/common/uriIdentity.js";import{TestThemeService as E}from"../../../../../platform/theme/test/common/testThemeService.js";import{runWithFakedTimers as m}from"../../../../../base/test/common/timeTravelScheduler.js";import{ensureNoDisposablesAreLeakedInTestSuite as I}from"../../../../../base/test/common/utils.js";suite("DecorationsService",function(){let e;setup(function(){e=new v(new class extends w(){extUri=b.extUri},new E)}),teardown(function(){e.dispose()});const f=I();test("Async provider, async/evented result",function(){return m({},async function(){const o=c.parse("foo:bar");let r=0;const i=e.registerDecorationsProvider(new class{label="Test";onDidChange=d.None;provideDecorations(a){return r+=1,new Promise(s=>{setTimeout(()=>s({color:"someBlue",tooltip:"T",strikethrough:!0}))})}});t.strictEqual(e.getDecoration(o,!1),void 0),t.strictEqual(r,1);const n=await d.toPromise(e.onDidChangeDecorations);t.strictEqual(n.affectsResource(o),!0),t.deepStrictEqual(e.getDecoration(o,!1).tooltip,"T"),t.deepStrictEqual(e.getDecoration(o,!1).strikethrough,!0),t.strictEqual(r,1),i.dispose()})}),test("Sync provider, sync result",function(){const o=c.parse("foo:bar");let r=0;const i=e.registerDecorationsProvider(new class{label="Test";onDidChange=d.None;provideDecorations(n){return r+=1,{color:"someBlue",tooltip:"Z"}}});t.deepStrictEqual(e.getDecoration(o,!1).tooltip,"Z"),t.deepStrictEqual(e.getDecoration(o,!1).strikethrough,!1),t.strictEqual(r,1),i.dispose()}),test("Clear decorations on provider dispose",async function(){return m({},async function(){const o=c.parse("foo:bar");let r=0;const i=e.registerDecorationsProvider(new class{label="Test";onDidChange=d.None;provideDecorations(s){return r+=1,{color:"someBlue",tooltip:"J"}}});t.deepStrictEqual(e.getDecoration(o,!1).tooltip,"J"),t.strictEqual(r,1);let n=!1;const a=new Promise(s=>{const l=e.onDidChangeDecorations(u=>{t.strictEqual(u.affectsResource(o),!0),t.deepStrictEqual(e.getDecoration(o,!1),void 0),t.strictEqual(r,1),n=!0,l.dispose(),s()})});i.dispose(),await a,t.strictEqual(n,!0)})}),test("No default bubbling",function(){let o=e.registerDecorationsProvider({label:"Test",onDidChange:d.None,provideDecorations(n){return n.path.match(/\.txt/)?{tooltip:".txt",weight:17}:void 0}});const r=c.parse("file:///some/path/some/file.txt");let i=e.getDecoration(r,!1);t.strictEqual(i.tooltip,".txt"),i=e.getDecoration(r.with({path:"some/path/"}),!0),t.strictEqual(i,void 0),o.dispose(),o=e.registerDecorationsProvider({label:"Test",onDidChange:d.None,provideDecorations(n){return n.path.match(/\.txt/)?{tooltip:".txt.bubble",weight:71,bubble:!0}:void 0}}),i=e.getDecoration(r,!1),t.strictEqual(i.tooltip,".txt.bubble"),i=e.getDecoration(r.with({path:"some/path/"}),!0),t.strictEqual(typeof i.tooltip,"string"),o.dispose()}),test("Decorations not showing up for second root folder #48502",async function(){let o=0,r=0;const i=new class{_onDidChange=new g;onDidChange=this._onDidChange.event;label="foo";provideDecorations(u,D){return f.add(D.onCancellationRequested(()=>{o+=1})),new Promise(p=>{r+=1,setTimeout(()=>{p({letter:"foo"})},10)})}},n=e.registerDecorationsProvider(i),a=c.parse("foo://bar"),s=e.getDecoration(a,!1);i._onDidChange.fire([a]);const l=e.getDecoration(a,!1);t.strictEqual(o,1),t.strictEqual(r,2),s?.dispose(),l?.dispose(),n.dispose()}),test("Decorations not bubbling... #48745",function(){const o=e.registerDecorationsProvider({label:"Test",onDidChange:d.None,provideDecorations(a){return a.path.match(/hello$/)?{tooltip:"FOO",weight:17,bubble:!0}:new Promise(s=>{})}}),r=e.getDecoration(c.parse("a:b/"),!0);t.ok(!r);const i=e.getDecoration(c.parse("a:b/c.hello"),!1);t.ok(i.tooltip);const n=e.getDecoration(c.parse("a:b/"),!0);t.ok(n),o.dispose()}),test("Folder decorations don't go away when file with problems is deleted #61919 (part1)",function(){const o=new g;let r=!1;const i=e.registerDecorationsProvider({label:"Test",onDidChange:o.event,provideDecorations(l){if(!r&&l.path.match(/file.ts$/))return{tooltip:"FOO",weight:17,bubble:!0}}}),n=c.parse("foo:/folder/file.ts"),a=c.parse("foo:/folder/");let s=e.getDecoration(n,!0);t.strictEqual(s.tooltip,"FOO"),s=e.getDecoration(a,!0),t.ok(s.tooltip),r=!0,o.fire([n]),s=e.getDecoration(n,!0),t.strictEqual(s,void 0),s=e.getDecoration(a,!0),t.strictEqual(s,void 0),i.dispose()}),test("Folder decorations don't go away when file with problems is deleted #61919 (part2)",function(){return m({},async function(){const o=new g;let r=!1;const i=e.registerDecorationsProvider({label:"Test",onDidChange:o.event,provideDecorations(l){if(!r&&l.path.match(/file.ts$/))return{tooltip:"FOO",weight:17,bubble:!0}}}),n=c.parse("foo:/folder/file.ts"),a=c.parse("foo:/folder/");let s=e.getDecoration(n,!0);return t.strictEqual(s.tooltip,"FOO"),s=e.getDecoration(a,!0),t.ok(s.tooltip),new Promise((l,u)=>{const D=e.onDidChangeDecorations(p=>{D.dispose();try{t.ok(p.affectsResource(n)),t.ok(p.affectsResource(a)),l(),i.dispose()}catch(h){u(h),i.dispose()}});r=!0,o.fire([n])})})}),test("FileDecorationProvider intermittently fails #133210",async function(){const o=[];f.add(e.registerDecorationsProvider(new class{label="Provider-1";onDidChange=d.None;provideDecorations(){o.push(this.label)}})),f.add(e.registerDecorationsProvider(new class{label="Provider-2";onDidChange=d.None;provideDecorations(){o.push(this.label)}})),e.getDecoration(c.parse("test://me/path"),!1),t.deepStrictEqual(o,["Provider-2","Provider-1"])})});
