var m=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var R=(p,d,e,i)=>{for(var o=i>1?void 0:i?I(d,e):d,t=p.length-1,r;t>=0;t--)(r=p[t])&&(o=(i?r(d,e,o):r(o))||o);return i&&o&&m(d,e,o),o},v=(p,d)=>(e,i)=>d(e,i,p);import{localize as C}from"../../../../nls.js";import{toErrorMessage as T}from"../../../../base/common/errorMessage.js";import{Event as F,Emitter as n}from"../../../../base/common/event.js";import{URI as M}from"../../../../base/common/uri.js";import{TextFileEditorModel as E}from"./textFileEditorModel.js";import{dispose as h,Disposable as S,DisposableStore as P}from"../../../../base/common/lifecycle.js";import"./textfiles.js";import{IInstantiationService as _}from"../../../../platform/instantiation/common/instantiation.js";import{ResourceMap as c}from"../../../../base/common/map.js";import{IFileService as x,FileOperation as l,FileChangeType as y}from"../../../../platform/files/common/files.js";import{Promises as w,ResourceQueue as k}from"../../../../base/common/async.js";import{onUnexpectedError as f}from"../../../../base/common/errors.js";import{TextFileSaveParticipant as U}from"./textFileSaveParticipant.js";import"../../../../base/common/cancellation.js";import{INotificationService as L}from"../../../../platform/notification/common/notification.js";import{IWorkingCopyFileService as O}from"../../workingCopy/common/workingCopyFileService.js";import"../../../../editor/common/model.js";import{extname as W,joinPath as b}from"../../../../base/common/resources.js";import{createTextBufferFactoryFromSnapshot as q}from"../../../../editor/common/model/textModel.js";import{PLAINTEXT_EXTENSION as A,PLAINTEXT_LANGUAGE_ID as D}from"../../../../editor/common/languages/modesRegistry.js";import{IUriIdentityService as N}from"../../../../platform/uriIdentity/common/uriIdentity.js";import"../../../../platform/progress/common/progress.js";let g=class extends S{constructor(e,i,o,t,r){super();this.instantiationService=e;this.fileService=i;this.notificationService=o;this.workingCopyFileService=t;this.uriIdentityService=r;this.registerListeners()}_onDidCreate=this._register(new n({leakWarningThreshold:500}));onDidCreate=this._onDidCreate.event;_onDidResolve=this._register(new n);onDidResolve=this._onDidResolve.event;_onDidRemove=this._register(new n);onDidRemove=this._onDidRemove.event;_onDidChangeDirty=this._register(new n);onDidChangeDirty=this._onDidChangeDirty.event;_onDidChangeReadonly=this._register(new n);onDidChangeReadonly=this._onDidChangeReadonly.event;_onDidChangeOrphaned=this._register(new n);onDidChangeOrphaned=this._onDidChangeOrphaned.event;_onDidSaveError=this._register(new n);onDidSaveError=this._onDidSaveError.event;_onDidSave=this._register(new n);onDidSave=this._onDidSave.event;_onDidRevert=this._register(new n);onDidRevert=this._onDidRevert.event;_onDidChangeEncoding=this._register(new n);onDidChangeEncoding=this._onDidChangeEncoding.event;mapResourceToModel=new c;mapResourceToModelListeners=new c;mapResourceToDisposeListener=new c;mapResourceToPendingModelResolvers=new c;modelResolveQueue=this._register(new k);saveErrorHandler=(()=>{const e=this.notificationService;return{onSaveError(i,o){e.error(C({key:"genericSaveError",comment:["{0} is the resource that failed to save and {1} the error message"]},"Failed to save '{0}': {1}",o.name,T(i,!1)))}}})();get models(){return[...this.mapResourceToModel.values()]}registerListeners(){this._register(this.fileService.onDidFilesChange(e=>this.onDidFilesChange(e))),this._register(this.fileService.onDidChangeFileSystemProviderCapabilities(e=>this.onDidChangeFileSystemProviderCapabilities(e))),this._register(this.fileService.onDidChangeFileSystemProviderRegistrations(e=>this.onDidChangeFileSystemProviderRegistrations(e))),this._register(this.workingCopyFileService.onWillRunWorkingCopyFileOperation(e=>this.onWillRunWorkingCopyFileOperation(e))),this._register(this.workingCopyFileService.onDidFailWorkingCopyFileOperation(e=>this.onDidFailWorkingCopyFileOperation(e))),this._register(this.workingCopyFileService.onDidRunWorkingCopyFileOperation(e=>this.onDidRunWorkingCopyFileOperation(e)))}onDidFilesChange(e){for(const i of this.models)i.isDirty()||e.contains(i.resource,y.UPDATED,y.ADDED)&&this.queueModelReload(i)}onDidChangeFileSystemProviderCapabilities(e){this.queueModelReloads(e.scheme)}onDidChangeFileSystemProviderRegistrations(e){e.added&&this.queueModelReloads(e.scheme)}queueModelReloads(e){for(const i of this.models)i.isDirty()||e===i.resource.scheme&&this.queueModelReload(i)}queueModelReload(e){this.modelResolveQueue.queueSize(e.resource)<=1&&this.modelResolveQueue.queueFor(e.resource,async()=>{try{await this.reload(e)}catch(o){f(o)}})}mapCorrelationIdToModelsToRestore=new Map;onWillRunWorkingCopyFileOperation(e){if(e.operation===l.MOVE||e.operation===l.COPY){const i=[];for(const{source:o,target:t}of e.files)if(o){if(this.uriIdentityService.extUri.isEqual(o,t))continue;const r=[];for(const s of this.models)this.uriIdentityService.extUri.isEqualOrParent(s.resource,o)&&r.push(s);for(const s of r){const a=s.resource;let u;this.uriIdentityService.extUri.isEqual(a,o)?u=t:u=b(t,a.path.substr(o.path.length+1)),i.push({source:a,target:u,languageId:s.getLanguageId(),encoding:s.getEncoding(),snapshot:s.isDirty()?s.createSnapshot():void 0})}}this.mapCorrelationIdToModelsToRestore.set(e.correlationId,i)}}onDidFailWorkingCopyFileOperation(e){if(e.operation===l.MOVE||e.operation===l.COPY){const i=this.mapCorrelationIdToModelsToRestore.get(e.correlationId);i&&(this.mapCorrelationIdToModelsToRestore.delete(e.correlationId),i.forEach(o=>{o.snapshot&&this.get(o.source)?.setDirty(!0)}))}}onDidRunWorkingCopyFileOperation(e){switch(e.operation){case l.CREATE:e.waitUntil((async()=>{for(const{target:i}of e.files){const o=this.get(i);o&&!o.isDisposed()&&await o.revert()}})());break;case l.MOVE:case l.COPY:e.waitUntil((async()=>{const i=this.mapCorrelationIdToModelsToRestore.get(e.correlationId);i&&(this.mapCorrelationIdToModelsToRestore.delete(e.correlationId),await w.settled(i.map(async o=>{const t=this.uriIdentityService.asCanonicalUri(o.target),r=await this.resolve(t,{reload:{async:!1},contents:o.snapshot?q(o.snapshot):void 0,encoding:o.encoding});o.languageId&&o.languageId!==D&&r.getLanguageId()===D&&W(t)!==A&&r.updateTextEditorModel(void 0,o.languageId)})))})());break}}get(e){return this.mapResourceToModel.get(e)}has(e){return this.mapResourceToModel.has(e)}async reload(e){await this.joinPendingResolves(e.resource),!(e.isDirty()||e.isDisposed()||!this.has(e.resource))&&await this.doResolve(e,{reload:{async:!1}})}async resolve(e,i){const o=this.joinPendingResolves(e);return o&&await o,this.doResolve(e,i)}async doResolve(e,i){let o,t;M.isUri(e)?(t=e,o=this.get(t)):(t=e.resource,o=e);let r,s=!1;if(o)i?.contents?r=o.resolve(i):i?.reload?i.reload.async?(r=Promise.resolve(),(async()=>{try{await o.resolve(i)}catch(a){f(a)}})()):r=o.resolve(i):r=Promise.resolve();else{s=!0;const a=o=this.instantiationService.createInstance(E,t,i?i.encoding:void 0,i?i.languageId:void 0);r=o.resolve(i),this.registerModel(a)}this.mapResourceToPendingModelResolvers.set(t,r),this.add(t,o),s&&(this._onDidCreate.fire(o),o.isDirty()&&this._onDidChangeDirty.fire(o));try{await r}catch(a){throw s&&o.dispose(),a}finally{this.mapResourceToPendingModelResolvers.delete(t)}return i?.languageId&&o.setLanguageId(i.languageId),s&&o.isDirty()&&this._onDidChangeDirty.fire(o),o}joinPendingResolves(e){if(this.mapResourceToPendingModelResolvers.get(e))return this.doJoinPendingResolves(e)}async doJoinPendingResolves(e){let i;for(;this.mapResourceToPendingModelResolvers.has(e);){const o=this.mapResourceToPendingModelResolvers.get(e);if(o===i)return;i=o;try{await o}catch{}}}registerModel(e){const i=new P;i.add(e.onDidResolve(o=>this._onDidResolve.fire({model:e,reason:o}))),i.add(e.onDidChangeDirty(()=>this._onDidChangeDirty.fire(e))),i.add(e.onDidChangeReadonly(()=>this._onDidChangeReadonly.fire(e))),i.add(e.onDidChangeOrphaned(()=>this._onDidChangeOrphaned.fire(e))),i.add(e.onDidSaveError(()=>this._onDidSaveError.fire(e))),i.add(e.onDidSave(o=>this._onDidSave.fire({model:e,...o}))),i.add(e.onDidRevert(()=>this._onDidRevert.fire(e))),i.add(e.onDidChangeEncoding(()=>this._onDidChangeEncoding.fire(e))),this.mapResourceToModelListeners.set(e.resource,i)}add(e,i){if(this.mapResourceToModel.get(e)===i)return;this.mapResourceToDisposeListener.get(e)?.dispose(),this.mapResourceToModel.set(e,i),this.mapResourceToDisposeListener.set(e,i.onWillDispose(()=>this.remove(e)))}remove(e){const i=this.mapResourceToModel.delete(e),o=this.mapResourceToDisposeListener.get(e);o&&(h(o),this.mapResourceToDisposeListener.delete(e));const t=this.mapResourceToModelListeners.get(e);t&&(h(t),this.mapResourceToModelListeners.delete(e)),i&&this._onDidRemove.fire(e)}saveParticipants=this._register(this.instantiationService.createInstance(U));addSaveParticipant(e){return this.saveParticipants.addSaveParticipant(e)}runSaveParticipants(e,i,o,t){return this.saveParticipants.participate(e,i,o,t)}canDispose(e){return e.isDisposed()||!this.mapResourceToPendingModelResolvers.has(e.resource)&&!e.isDirty()?!0:this.doCanDispose(e)}async doCanDispose(e){const i=this.joinPendingResolves(e.resource);return i?(await i,this.canDispose(e)):e.isDirty()?(await F.toPromise(e.onDidChangeDirty),this.canDispose(e)):!0}dispose(){super.dispose(),this.mapResourceToModel.clear(),this.mapResourceToPendingModelResolvers.clear(),h(this.mapResourceToDisposeListener.values()),this.mapResourceToDisposeListener.clear(),h(this.mapResourceToModelListeners.values()),this.mapResourceToModelListeners.clear()}};g=R([v(0,_),v(1,x),v(2,L),v(3,O),v(4,N)],g);export{g as TextFileEditorModelManager};
