var d=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var v=(a,r,n,t)=>{for(var e=t>1?void 0:t?C(r,n):r,o=a.length-1,i;o>=0;o--)(i=a[o])&&(e=(t?i(r,n,e):i(e))||e);return t&&e&&d(r,n,e),e},s=(a,r)=>(n,t)=>r(n,t,a);import{Emitter as u}from"../../../../../vs/base/common/event.js";import{Disposable as g}from"../../../../../vs/base/common/lifecycle.js";import{getDelayedChannel as y}from"../../../../../vs/base/parts/ipc/common/ipc.js";import"../../../../../vs/base/parts/ipc/common/ipc.net.js";import"../../../../../vs/platform/diagnostics/common/diagnostics.js";import{ILogService as _}from"../../../../../vs/platform/log/common/log.js";import{IProductService as f}from"../../../../../vs/platform/product/common/productService.js";import{connectRemoteAgentManagement as p}from"../../../../../vs/platform/remote/common/remoteAgentConnection.js";import"../../../../../vs/platform/remote/common/remoteAgentEnvironment.js";import{IRemoteAuthorityResolverService as I}from"../../../../../vs/platform/remote/common/remoteAuthorityResolver.js";import{IRemoteSocketFactoryService as S}from"../../../../../vs/platform/remote/common/remoteSocketFactoryService.js";import{ISignService as R}from"../../../../../vs/platform/sign/common/sign.js";import"../../../../../vs/platform/telemetry/common/telemetry.js";import{IWorkbenchEnvironmentService as P}from"../../../../../vs/workbench/services/environment/common/environmentService.js";import{RemoteExtensionEnvironmentChannelClient as c}from"../../../../../vs/workbench/services/remote/common/remoteAgentEnvironmentChannel.js";import"../../../../../vs/workbench/services/remote/common/remoteAgentService.js";import{IUserDataProfileService as A}from"../../../../../vs/workbench/services/userDataProfile/common/userDataProfile.js";let l=class extends g{constructor(n,t,e,o,i,m,h){super();this.remoteSocketFactoryService=n;this.userDataProfileService=t;this._environmentService=e;this._remoteAuthorityResolverService=i;this._environmentService.remoteAuthority?this._connection=this._register(new T(this._environmentService.remoteAuthority,o.commit,o.quality,this.remoteSocketFactoryService,this._remoteAuthorityResolverService,m,h)):this._connection=null,this._environment=null}_connection;_environment;getConnection(){return this._connection}getEnvironment(){return this.getRawEnvironment().then(void 0,()=>null)}getRawEnvironment(){return this._environment||(this._environment=this._withChannel(async(n,t)=>{const e=await c.getEnvironmentData(n,t.remoteAuthority,this.userDataProfileService.currentProfile.isDefault?void 0:this.userDataProfileService.currentProfile.id);return this._remoteAuthorityResolverService._setAuthorityConnectionToken(t.remoteAuthority,e.connectionToken),e},null)),this._environment}getExtensionHostExitInfo(n){return this._withChannel((t,e)=>c.getExtensionHostExitInfo(t,e.remoteAuthority,n),null)}getDiagnosticInfo(n){return this._withChannel(t=>c.getDiagnosticInfo(t,n),void 0)}updateTelemetryLevel(n){return this._withTelemetryChannel(t=>c.updateTelemetryLevel(t,n),void 0)}logTelemetry(n,t){return this._withTelemetryChannel(e=>c.logTelemetry(e,n,t),void 0)}flushTelemetry(){return this._withTelemetryChannel(n=>c.flushTelemetry(n),void 0)}getRoundTripTime(){return this._withTelemetryChannel(async n=>{const t=Date.now();return await c.ping(n),Date.now()-t},void 0)}async endConnection(){this._connection&&(await this._connection.end(),this._connection.dispose())}_withChannel(n,t){const e=this.getConnection();return e?e.withChannel("remoteextensionsenvironment",o=>n(o,e)):Promise.resolve(t)}_withTelemetryChannel(n,t){const e=this.getConnection();return e?e.withChannel("telemetry",o=>n(o,e)):Promise.resolve(t)}};l=v([s(0,S),s(1,A),s(2,P),s(3,f),s(4,I),s(5,R),s(6,_)],l);class T extends g{constructor(n,t,e,o,i,m,h){super();this._commit=t;this._quality=e;this._remoteSocketFactoryService=o;this._remoteAuthorityResolverService=i;this._signService=m;this._logService=h;this.remoteAuthority=n,this._connection=null}_onReconnecting=this._register(new u);onReconnecting=this._onReconnecting.event;_onDidStateChange=this._register(new u);onDidStateChange=this._onDidStateChange.event;remoteAuthority;_connection;_initialConnectionMs;end=()=>Promise.resolve();getChannel(n){return y(this._getOrCreateConnection().then(t=>t.getChannel(n)))}withChannel(n,t){const e=this.getChannel(n);return t(e)}registerChannel(n,t){this._getOrCreateConnection().then(e=>e.registerChannel(n,t))}async getInitialConnectionTimeMs(){try{await this._getOrCreateConnection()}catch{}return this._initialConnectionMs}_getOrCreateConnection(){return this._connection||(this._connection=this._createConnection()),this._connection}async _createConnection(){let n=!0;const t={commit:this._commit,quality:this._quality,addressProvider:{getAddress:async()=>{n?n=!1:this._onReconnecting.fire(void 0);const{authority:i}=await this._remoteAuthorityResolverService.resolveAuthority(this.remoteAuthority);return{connectTo:i.connectTo,connectionToken:i.connectionToken}}},remoteSocketFactoryService:this._remoteSocketFactoryService,signService:this._signService,logService:this._logService,ipcLogger:null};let e;const o=Date.now();try{e=this._register(await p(t,this.remoteAuthority,"renderer"))}finally{this._initialConnectionMs=Date.now()-o}return e.protocol.onDidDispose(()=>{e.dispose()}),this.end=()=>(e.protocol.sendDisconnect(),e.protocol.drain()),this._register(e.onDidStateChange(i=>this._onDidStateChange.fire(i))),e.client}}export{l as AbstractRemoteAgentService};
