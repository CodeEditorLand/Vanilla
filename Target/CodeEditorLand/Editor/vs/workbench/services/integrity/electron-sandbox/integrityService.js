var S=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var m=(c,e,r,i)=>{for(var t=i>1?void 0:i?f(e,r):e,s=c.length-1,n;s>=0;s--)(n=c[s])&&(t=(i?n(e,r,t):n(t))||t);return i&&t&&S(e,r,t),t},o=(c,e)=>(r,i)=>e(r,i,c);import{FileAccess as d}from"../../../../base/common/network.js";import p from"../../../../base/common/severity.js";import{URI as g}from"../../../../base/common/uri.js";import{localize as u}from"../../../../nls.js";import{IChecksumService as y}from"../../../../platform/checksum/common/checksumService.js";import{InstantiationType as P,registerSingleton as I}from"../../../../platform/instantiation/common/extensions.js";import{ILogService as k}from"../../../../platform/log/common/log.js";import{INotificationService as _,NotificationPriority as v}from"../../../../platform/notification/common/notification.js";import{IOpenerService as w}from"../../../../platform/opener/common/opener.js";import{IProductService as C}from"../../../../platform/product/common/productService.js";import{IStorageService as N,StorageScope as h,StorageTarget as A}from"../../../../platform/storage/common/storage.js";import{ILifecycleService as R,LifecyclePhase as T}from"../../lifecycle/common/lifecycle.js";import{IIntegrityService as D}from"../common/integrity.js";class l{constructor(e){this.storageService=e;this.value=this._read()}static KEY="integrityService";value;_read(){const e=this.storageService.get(l.KEY,h.APPLICATION);if(!e)return null;try{return JSON.parse(e)}catch{return null}}get(){return this.value}set(e){this.value=e,this.storageService.store(l.KEY,JSON.stringify(this.value),h.APPLICATION,A.MACHINE)}}let a=class{constructor(e,r,i,t,s,n,U){this.notificationService=e;this.storageService=r;this.lifecycleService=i;this.openerService=t;this.productService=s;this.checksumService=n;this.logService=U;this._compute()}_storage=new l(this.storageService);_isPurePromise=this._isPure();isPure(){return this._isPurePromise}async _compute(){const{isPure:e}=await this.isPure();if(e)return;this.logService.warn(`

----------------------------------------------
***	Installation has been modified on disk ***
----------------------------------------------

`);const r=this._storage.get();r?.dontShowPrompt&&r.commit===this.productService.commit||this._showNotification()}async _isPure(){const e=this.productService.checksums||{};await this.lifecycleService.when(T.Eventually);const r=await Promise.all(Object.keys(e).map(t=>this._resolve(t,e[t])));let i=!0;for(let t=0,s=r.length;t<s;t++)if(!r[t].isPure){i=!1;break}return{isPure:i,proof:r}}async _resolve(e,r){const i=d.asFileUri(e);try{const t=await this.checksumService.checksum(i);return a._createChecksumPair(i,t,r)}catch{return a._createChecksumPair(i,"",r)}}static _createChecksumPair(e,r,i){return{uri:e,actual:r,expected:i,isPure:r===i}}_showNotification(){const e=this.productService.checksumFailMoreInfoUrl,r=u("integrity.prompt","Your {0} installation appears to be corrupt. Please reinstall.",this.productService.nameShort);e?this.notificationService.prompt(p.Warning,r,[{label:u("integrity.moreInformation","More Information"),run:()=>this.openerService.open(g.parse(e))},{label:u("integrity.dontShowAgain","Don't Show Again"),isSecondary:!0,run:()=>this._storage.set({dontShowPrompt:!0,commit:this.productService.commit})}],{sticky:!0,priority:v.URGENT}):this.notificationService.notify({severity:p.Warning,message:r,sticky:!0,priority:v.URGENT})}};a=m([o(0,_),o(1,N),o(2,R),o(3,w),o(4,C),o(5,y),o(6,k)],a),I(D,a,P.Delayed);export{a as IntegrityService};
