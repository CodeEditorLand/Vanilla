var u=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var m=(a,s,i,r)=>{for(var t=r>1?void 0:r?F(s,i):s,c=a.length-1,d;c>=0;c--)(d=a[c])&&(t=(r?d(s,i,t):d(t))||t);return r&&t&&u(s,i,t),t},I=(a,s)=>(i,r)=>s(i,r,a);import{VSBuffer as g}from"../../../../base/common/buffer.js";import"../../../../base/common/cancellation.js";import{isEqualOrParent as W,joinPath as v,relativePath as w}from"../../../../base/common/resources.js";import{URI as S}from"../../../../base/common/uri.js";import{InstantiationType as h,registerSingleton as C}from"../../../../platform/instantiation/common/extensions.js";import{createDecorator as U}from"../../../../platform/instantiation/common/instantiation.js";import"../../../../platform/userDataSync/common/userDataSync.js";import{EditSessionIdentityMatch as P,IEditSessionIdentityService as x}from"../../../../platform/workspace/common/editSessions.js";import{IWorkspaceContextService as T}from"../../../../platform/workspace/common/workspace.js";const E=U("IWorkspaceIdentityService");let l=class{constructor(s,i){this.workspaceContextService=s;this.editSessionIdentityService=i}async getWorkspaceStateFolders(s){const i=[];for(const r of this.workspaceContextService.getWorkspace().folders){const t=await this.editSessionIdentityService.getEditSessionIdentifier(r,s);t&&i.push({resourceUri:r.uri.toString(),workspaceFolderIdentity:t})}return i}async matches(s,i){const r={},t={};for(const e of s)t[e.workspaceFolderIdentity]=e.resourceUri;const c=new Map;for(const e of this.workspaceContextService.getWorkspace().folders){const n=await this.editSessionIdentityService.getEditSessionIdentifier(e,i);n&&c.set(e,n)}for(const[e,n]of c.entries()){const o=t[n];if(o){r[o]=e.uri.toString();continue}let p=!1;for(const[f,y]of Object.entries(t))if(await this.editSessionIdentityService.provideEditSessionIdentityMatch(e,n,f,i)===P.Complete){r[y]=e.uri.toString(),p=!0;break}if(!p)return!1}const d=e=>{for(const n of Object.keys(r)){const o=S.parse(n);if(W(o,e)){const p=r[n],f=w(o,e);if(f)return v(S.parse(p),f)}}return e},k=(e,n=0)=>{if(!e||n>200||e instanceof g||e instanceof Uint8Array)return e;if(S.isUri(e))return d(e);if(Array.isArray(e))for(let o=0;o<e.length;++o)e[o]=k(e[o],n+1);else for(const o in e)Object.hasOwnProperty.call(e,o)&&(e[o]=k(e[o],n+1));return e};return k}};l=m([I(0,T),I(1,x)],l),C(E,l,h.Delayed);export{E as IWorkspaceIdentityService,l as WorkspaceIdentityService};
