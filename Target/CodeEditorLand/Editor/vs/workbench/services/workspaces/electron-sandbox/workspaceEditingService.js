var C=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var d=(p,s,i,r)=>{for(var t=r>1?void 0:r?D(s,i):s,o=p.length-1,n;o>=0;o--)(n=p[o])&&(t=(r?n(s,i,t):n(t))||t);return r&&t&&C(s,i,t),t},e=(p,s)=>(i,r)=>s(i,r,p);import{localize as a}from"../../../../nls.js";import{IWorkspaceEditingService as P}from"../common/workspaceEditing.js";import{URI as E}from"../../../../base/common/uri.js";import{hasWorkspaceFileExtension as H,isUntitledWorkspace as B,isWorkspaceIdentifier as L,IWorkspaceContextService as O}from"../../../../platform/workspace/common/workspace.js";import{IJSONEditingService as A}from"../../configuration/common/jsonEditing.js";import{IWorkspacesService as N}from"../../../../platform/workspaces/common/workspaces.js";import"../../configuration/browser/configurationService.js";import{IStorageService as R}from"../../../../platform/storage/common/storage.js";import{IExtensionService as T}from"../../extensions/common/extensions.js";import{IWorkingCopyBackupService as F}from"../../workingCopy/common/workingCopyBackup.js";import{ICommandService as M}from"../../../../platform/commands/common/commands.js";import{basename as V}from"../../../../base/common/resources.js";import{INotificationService as z,Severity as J}from"../../../../platform/notification/common/notification.js";import{IFileService as q}from"../../../../platform/files/common/files.js";import{INativeWorkbenchEnvironmentService as G}from"../../environment/electron-sandbox/environmentService.js";import{ILifecycleService as _,ShutdownReason as m}from"../../lifecycle/common/lifecycle.js";import{IFileDialogService as j,IDialogService as K}from"../../../../platform/dialogs/common/dialogs.js";import{InstantiationType as Q,registerSingleton as X}from"../../../../platform/instantiation/common/extensions.js";import{ILabelService as Y,Verbosity as Z}from"../../../../platform/label/common/label.js";import{ITextFileService as $}from"../../textfile/common/textfiles.js";import{IHostService as ee}from"../../host/browser/host.js";import{AbstractWorkspaceEditingService as ie}from"../browser/abstractWorkspaceEditingService.js";import{INativeHostService as re}from"../../../../platform/native/common/native.js";import{isMacintosh as te}from"../../../../base/common/platform.js";import{WorkingCopyBackupService as oe}from"../../workingCopy/common/workingCopyBackupService.js";import{IUriIdentityService as ae}from"../../../../platform/uriIdentity/common/uriIdentity.js";import{IWorkspaceTrustManagementService as se}from"../../../../platform/workspace/common/workspaceTrust.js";import{IWorkbenchConfigurationService as ne}from"../../configuration/common/configuration.js";import{IUserDataProfilesService as ce}from"../../../../platform/userDataProfile/common/userDataProfile.js";import{IUserDataProfileService as pe}from"../../userDataProfile/common/userDataProfile.js";import{ConfigurationTarget as ve}from"../../../../platform/configuration/common/configuration.js";let l=class extends ie{constructor(i,r,t,o,n,S,f,c,v,k,u,h,w,I,g,le,me,W,y,b,U,x){super(i,r,o,c,v,k,u,h,w,I,g,W,y,b,U,x);this.nativeHostService=t;this.storageService=n;this.extensionService=S;this.workingCopyBackupService=f;this.lifecycleService=le;this.labelService=me;this.registerListeners()}registerListeners(){this._register(this.lifecycleService.onBeforeShutdown(i=>{const r=this.saveUntitledBeforeShutdown(i.reason);i.veto(r,"veto.untitledWorkspace")}))}async saveUntitledBeforeShutdown(i){if(i!==m.LOAD&&i!==m.CLOSE)return!1;const r=this.getCurrentWorkspaceIdentifier();if(!r||!B(r.configPath,this.environmentService))return!1;const t=await this.nativeHostService.getWindowCount();if(i===m.CLOSE&&!te&&t===1)return!1;if(!(this.configurationService.getValue("window.confirmSaveUntitledWorkspace")!==!1))return await this.workspacesService.deleteUntitledWorkspace(r),!1;let n=!1;const{result:S,checkboxChecked:f}=await this.dialogService.prompt({type:J.Warning,message:a("saveWorkspaceMessage","Do you want to save your workspace configuration as a file?"),detail:a("saveWorkspaceDetail","Save your workspace if you plan to open it again."),buttons:[{label:a({key:"save",comment:["&& denotes a mnemonic"]},"&&Save"),run:async()=>{const c=await this.pickNewWorkspacePath();if(!c||!H(c))return!0;try{await this.saveWorkspaceAs(r,c);const v=await this.workspacesService.getWorkspaceIdentifier(c);await this.workspacesService.addRecentlyOpened([{label:this.labelService.getWorkspaceLabel(v,{verbose:Z.LONG}),workspace:v,remoteAuthority:this.environmentService.remoteAuthority}]),await this.workspacesService.deleteUntitledWorkspace(r)}catch{}return!1}},{label:a({key:"doNotSave",comment:["&& denotes a mnemonic"]},"Do&&n't Save"),run:async()=>(await this.workspacesService.deleteUntitledWorkspace(r),!1)}],cancelButton:{run:()=>(n=!0,!0)},checkbox:{label:a("doNotAskAgain","Always discard untitled workspaces without asking")}});return!n&&f&&await this.configurationService.updateValue("window.confirmSaveUntitledWorkspace",!1,ve.USER),S}async isValidTargetWorkspacePath(i){return(await this.nativeHostService.getWindows({includeAuxiliaryWindows:!1})).some(t=>L(t.workspace)&&this.uriIdentityService.extUri.isEqual(t.workspace.configPath,i))?(await this.dialogService.info(a("workspaceOpenedMessage","Unable to save workspace '{0}'",V(i)),a("workspaceOpenedDetail","The workspace is already opened in another window. Please close that window first and then try again.")),!1):!0}async enterWorkspace(i){if(!await this.extensionService.stopExtensionHosts(a("restartExtensionHost.reason","Opening a multi-root workspace.")))return;const t=await this.doEnterWorkspace(i);if(t&&(await this.storageService.switch(t.workspace,!0),this.workingCopyBackupService instanceof oe)){const o=t.backupPath?E.file(t.backupPath).with({scheme:this.environmentService.userRoamingDataHome.scheme}):void 0;this.workingCopyBackupService.reinitialize(o)}this.environmentService.remoteAuthority?this.hostService.reload():this.extensionService.startExtensionHosts()}};l=d([e(0,A),e(1,O),e(2,re),e(3,ne),e(4,R),e(5,T),e(6,F),e(7,z),e(8,M),e(9,q),e(10,$),e(11,N),e(12,G),e(13,j),e(14,K),e(15,_),e(16,Y),e(17,ee),e(18,ae),e(19,se),e(20,ce),e(21,pe)],l),X(P,l,Q.Delayed);export{l as NativeWorkspaceEditingService};
