var y=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var h=(v,c,e,r)=>{for(var i=r>1?void 0:r?P(c,e):c,t=v.length-1,a;t>=0;t--)(a=v[t])&&(i=(r?a(c,e,i):a(i))||i);return r&&i&&y(c,e,i),i},s=(v,c)=>(e,r)=>c(e,r,v);import"../common/workspaceEditing.js";import"../../../../base/common/uri.js";import{localize as u}from"../../../../nls.js";import{hasWorkspaceFileExtension as F,isSavedWorkspace as E,isUntitledWorkspace as W,isWorkspaceIdentifier as C,IWorkspaceContextService as D,toWorkspaceIdentifier as b,WorkbenchState as p,WORKSPACE_EXTENSION as k,WORKSPACE_FILTER as R}from"../../../../platform/workspace/common/workspace.js";import{IJSONEditingService as U,JSONEditingErrorCode as x}from"../../configuration/common/jsonEditing.js";import{IWorkspacesService as T,rewriteWorkspaceFileForNewLocation as g}from"../../../../platform/workspaces/common/workspaces.js";import"../../configuration/browser/configurationService.js";import{ConfigurationScope as A,Extensions as O}from"../../../../platform/configuration/common/configurationRegistry.js";import{Registry as N}from"../../../../platform/registry/common/platform.js";import{ICommandService as L}from"../../../../platform/commands/common/commands.js";import{distinct as M}from"../../../../base/common/arrays.js";import{basename as I,isEqual as J,isEqualAuthority as K,joinPath as V,removeTrailingPathSeparator as w}from"../../../../base/common/resources.js";import{INotificationService as _,Severity as $}from"../../../../platform/notification/common/notification.js";import{IFileService as q}from"../../../../platform/files/common/files.js";import{IWorkbenchEnvironmentService as j}from"../../environment/common/environmentService.js";import{IFileDialogService as z,IDialogService as B}from"../../../../platform/dialogs/common/dialogs.js";import{mnemonicButtonLabel as H}from"../../../../base/common/labels.js";import{ITextFileService as X}from"../../textfile/common/textfiles.js";import{IHostService as Y}from"../../host/browser/host.js";import{Schemas as m}from"../../../../base/common/network.js";import{SaveReason as G}from"../../../common/editor.js";import{IUriIdentityService as Q}from"../../../../platform/uriIdentity/common/uriIdentity.js";import{IWorkspaceTrustManagementService as Z}from"../../../../platform/workspace/common/workspaceTrust.js";import{IWorkbenchConfigurationService as ee}from"../../configuration/common/configuration.js";import{IUserDataProfilesService as re}from"../../../../platform/userDataProfile/common/userDataProfile.js";import{IUserDataProfileService as ie}from"../../userDataProfile/common/userDataProfile.js";import{Disposable as te}from"../../../../base/common/lifecycle.js";let S=class extends te{constructor(e,r,i,t,a,o,n,l,f,d,oe,ae,se,ne,ce,pe){super();this.jsonEditingService=e;this.contextService=r;this.configurationService=i;this.notificationService=t;this.commandService=a;this.fileService=o;this.textFileService=n;this.workspacesService=l;this.environmentService=f;this.fileDialogService=d;this.dialogService=oe;this.hostService=ae;this.uriIdentityService=se;this.workspaceTrustManagementService=ne;this.userDataProfilesService=ce;this.userDataProfileService=pe}async pickNewWorkspacePath(){const e=[m.file];this.environmentService.remoteAuthority&&e.unshift(m.vscodeRemote);let r=await this.fileDialogService.showSaveDialog({saveLabel:H(u("save","Save")),title:u("saveWorkspace","Save Workspace"),filters:R,defaultUri:V(await this.fileDialogService.defaultWorkspacePath(),this.getNewWorkspaceName()),availableFileSystems:e});if(r)return F(r)||(r=r.with({path:`${r.path}.${k}`})),r}getNewWorkspaceName(){const e=this.getCurrentWorkspaceIdentifier()?.configPath;if(e&&E(e,this.environmentService))return I(e);const r=this.contextService.getWorkspace().folders.at(0);return r?`${I(r.uri)}.${k}`:`workspace.${k}`}async updateFolders(e,r,i,t){const a=this.contextService.getWorkspace().folders;let o=[];typeof r=="number"&&(o=a.slice(e,e+r).map(d=>d.uri));let n=[];Array.isArray(i)&&(n=i.map(d=>({uri:w(d.uri),name:d.name})));const l=o.length>0,f=n.length>0;if(!(!f&&!l))return f&&!l?this.doAddFolders(n,e,t):l&&!f?this.removeFolders(o):this.includesSingleFolderWorkspace(o)?this.createAndEnterWorkspace(n):this.contextService.getWorkbenchState()!==p.WORKSPACE?this.doAddFolders(n,e,t):this.doUpdateFolders(n,o,e,t)}async doUpdateFolders(e,r,i,t=!1){try{await this.contextService.updateFolders(e,r,i)}catch(a){if(t)throw a;this.handleWorkspaceConfigurationEditingError(a)}}addFolders(e,r=!1){const i=e.map(t=>({uri:w(t.uri),name:t.name}));return this.doAddFolders(i,void 0,r)}async doAddFolders(e,r,i=!1){const t=this.contextService.getWorkbenchState(),a=this.environmentService.remoteAuthority;if(a&&(e=e.filter(o=>o.uri.scheme!==m.file&&(o.uri.scheme!==m.vscodeRemote||K(o.uri.authority,a)))),t!==p.WORKSPACE){let o=this.contextService.getWorkspace().folders.map(n=>({uri:n.uri}));return o.splice(typeof r=="number"?r:o.length,0,...e),o=M(o,n=>this.uriIdentityService.extUri.getComparisonKey(n.uri)),t===p.EMPTY&&o.length===0||t===p.FOLDER&&o.length===1?void 0:this.createAndEnterWorkspace(o)}try{await this.contextService.addFolders(e,r)}catch(o){if(i)throw o;this.handleWorkspaceConfigurationEditingError(o)}}async removeFolders(e,r=!1){if(this.includesSingleFolderWorkspace(e))return this.createAndEnterWorkspace([]);try{await this.contextService.removeFolders(e)}catch(i){if(r)throw i;this.handleWorkspaceConfigurationEditingError(i)}}includesSingleFolderWorkspace(e){if(this.contextService.getWorkbenchState()===p.FOLDER){const r=this.contextService.getWorkspace().folders[0];return e.some(i=>this.uriIdentityService.extUri.isEqual(i,r.uri))}return!1}async createAndEnterWorkspace(e,r){if(r&&!await this.isValidTargetWorkspacePath(r))return;const i=this.environmentService.remoteAuthority,t=await this.workspacesService.createUntitledWorkspace(e,i);if(r)try{await this.saveWorkspaceAs(t,r)}finally{await this.workspacesService.deleteUntitledWorkspace(t)}else r=t.configPath,this.userDataProfileService.currentProfile.isDefault||await this.userDataProfilesService.setProfileForWorkspace(t,this.userDataProfileService.currentProfile);return this.enterWorkspace(r)}async saveAndEnterWorkspace(e){const r=this.getCurrentWorkspaceIdentifier();if(r){if(J(r.configPath,e))return this.saveWorkspace(r);if(await this.isValidTargetWorkspacePath(e))return await this.saveWorkspaceAs(r,e),this.enterWorkspace(e)}}async isValidTargetWorkspacePath(e){return!0}async saveWorkspaceAs(e,r){const i=e.configPath;if(!W(r,this.environmentService)&&!this.userDataProfileService.currentProfile.isDefault){const l=await this.workspacesService.getWorkspaceIdentifier(r);await this.userDataProfilesService.setProfileForWorkspace(l,this.userDataProfileService.currentProfile)}if(this.uriIdentityService.extUri.isEqual(i,r))return;const a=W(i,this.environmentService),o=await this.fileService.readFile(i),n=g(o.value.toString(),i,a,r,this.uriIdentityService.extUri);await this.textFileService.create([{resource:r,value:n,options:{overwrite:!0}}]),await this.trustWorkspaceConfiguration(r)}async saveWorkspace(e){const r=e.configPath,i=this.textFileService.files.get(r);if(i){await i.save({force:!0,reason:G.EXPLICIT});return}if(await this.fileService.exists(r))return;const o=g(JSON.stringify({folders:[]},null,"	"),r,!1,r,this.uriIdentityService.extUri);await this.textFileService.create([{resource:r,value:o}])}handleWorkspaceConfigurationEditingError(e){switch(e.code){case x.ERROR_INVALID_FILE:this.onInvalidWorkspaceConfigurationFileError();break;default:this.notificationService.error(e.message)}}onInvalidWorkspaceConfigurationFileError(){const e=u("errorInvalidTaskConfiguration","Unable to write into workspace configuration file. Please open the file to correct errors/warnings in it and try again.");this.askToOpenWorkspaceConfigurationFile(e)}askToOpenWorkspaceConfigurationFile(e){this.notificationService.prompt($.Error,e,[{label:u("openWorkspaceConfigurationFile","Open Workspace Configuration"),run:()=>this.commandService.executeCommand("workbench.action.openWorkspaceConfigFile")}])}async doEnterWorkspace(e){if(this.environmentService.extensionTestsLocationURI)throw new Error("Entering a new workspace is not possible in tests.");const r=await this.workspacesService.getWorkspaceIdentifier(e);return this.contextService.getWorkbenchState()===p.FOLDER&&await this.migrateWorkspaceSettings(r),await this.configurationService.initialize(r),this.workspacesService.enterWorkspace(e)}migrateWorkspaceSettings(e){return this.doCopyWorkspaceSettings(e,r=>r.scope===A.WINDOW)}copyWorkspaceSettings(e){return this.doCopyWorkspaceSettings(e)}doCopyWorkspaceSettings(e,r){const i=N.as(O.Configuration).getConfigurationProperties(),t={};for(const a of this.configurationService.keys().workspace)if(i[a]){if(r&&!r(i[a]))continue;t[a]=this.configurationService.inspect(a).workspaceValue}return this.jsonEditingService.write(e.configPath,[{path:["settings"],value:t}],!0)}async trustWorkspaceConfiguration(e){this.contextService.getWorkbenchState()!==p.EMPTY&&this.workspaceTrustManagementService.isWorkspaceTrusted()&&await this.workspaceTrustManagementService.setUrisTrust([e],!0)}getCurrentWorkspaceIdentifier(){const e=b(this.contextService.getWorkspace());if(C(e))return e}};S=h([s(0,U),s(1,D),s(2,ee),s(3,_),s(4,L),s(5,q),s(6,X),s(7,T),s(8,j),s(9,z),s(10,B),s(11,Y),s(12,Q),s(13,Z),s(14,re),s(15,ie)],S);export{S as AbstractWorkspaceEditingService};
