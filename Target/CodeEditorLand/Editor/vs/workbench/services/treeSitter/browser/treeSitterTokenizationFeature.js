var R=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var T=(l,c,t,r)=>{for(var e=r>1?void 0:r?M(c,t):c,o=l.length-1,i;o>=0;o--)(i=l[o])&&(e=(r?i(c,t,e):i(e))||e);return r&&e&&R(c,t,e),e},g=(l,c)=>(t,r)=>c(t,r,l);import{Emitter as q,Event as O}from"../../../../base/common/event.js";import{Disposable as b,DisposableMap as z,DisposableStore as w}from"../../../../base/common/lifecycle.js";import{FileAccess as Q}from"../../../../base/common/network.js";import{LazyTokenizationSupport as F,TreeSitterTokenizationRegistry as D}from"../../../../editor/common/languages.js";import"../../../../editor/common/model.js";import{EDITOR_EXPERIMENTAL_PREFER_TREESITTER as E,ITreeSitterParserService as U}from"../../../../editor/common/services/treeSitterParserService.js";import"../../../../editor/common/textModelEvents.js";import{ColumnRange as S}from"../../../../editor/contrib/inlineCompletions/browser/utils.js";import{IConfigurationService as N}from"../../../../platform/configuration/common/configuration.js";import{IFileService as B}from"../../../../platform/files/common/files.js";import{InstantiationType as G,registerSingleton as V}from"../../../../platform/instantiation/common/extensions.js";import{createDecorator as W,IInstantiationService as X}from"../../../../platform/instantiation/common/instantiation.js";import{IThemeService as $}from"../../../../platform/theme/common/themeService.js";import{findMetadata as j}from"../../themes/common/colorThemeData.js";import{ILanguageService as H}from"../../../../editor/common/languages/language.js";const J=["typescript"],K=W("treeSitterTokenizationFeature");let f=class extends b{constructor(t,r,e,o){super();this._languageService=t;this._configurationService=r;this._instantiationService=e;this._fileService=o;this._handleGrammarsExtPoint(),this._register(this._configurationService.onDidChangeConfiguration(i=>{i.affectsConfiguration(E)&&this._handleGrammarsExtPoint()}))}_serviceBrand;_tokenizersRegistrations=new z;_getSetting(){return this._configurationService.getValue(E)||[]}_handleGrammarsExtPoint(){const t=this._getSetting();for(const e of t)if(J.includes(e)&&!this._tokenizersRegistrations.has(e)){const o=new F(()=>this._createTokenizationSupport(e)),i=new w;i.add(o),i.add(D.registerFactory(e,o)),this._tokenizersRegistrations.set(e,i),D.getOrCreate(e)}const r=[...this._tokenizersRegistrations.keys()].filter(e=>!t.includes(e));for(const e of r)this._tokenizersRegistrations.deleteAndDispose(e)}async _fetchQueries(t){const r=`vs/editor/common/languages/highlights/${t}.scm`;return(await this._fileService.readFile(Q.asFileUri(r))).value.toString()}async _createTokenizationSupport(t){const r=await this._fetchQueries(t);return this._instantiationService.createInstance(h,r,t,this._languageService.languageIdCodec)}};f=T([g(0,H),g(1,N),g(2,X),g(3,B)],f);let h=class extends b{constructor(t,r,e,o,i){super();this._queries=t;this._languageId=r;this._languageIdCodec=e;this._treeSitterService=o;this._themeService=i;this._register(O.runAndSubscribe(this._themeService.onDidColorThemeChange,()=>this.reset())),this._register(this._treeSitterService.onDidUpdateTree(s=>{const n=s.textModel.getLineCount();this._onDidChangeTokens.fire({textModel:s.textModel,changes:{semanticTokensApplied:!1,ranges:s.ranges.map(d=>({fromLineNumber:d.startLineNumber,toLineNumber:d.endLineNumber<n?d.endLineNumber:n}))}})}))}_query;_onDidChangeTokens=new q;onDidChangeTokens=this._onDidChangeTokens.event;_colorThemeData;_languageAddedListener;_getTree(t){return this._treeSitterService.getParseResult(t)}_ensureQuery(){if(!this._query){const t=this._treeSitterService.getOrInitLanguage(this._languageId);if(!t){this._languageAddedListener||(this._languageAddedListener=this._register(O.onceIf(this._treeSitterService.onDidAddLanguage,r=>r.id===this._languageId)(r=>{this._query=r.language.query(this._queries)})));return}this._query=t.query(this._queries)}return this._query}reset(){this._colorThemeData=this._themeService.getColorTheme()}captureAtPosition(t,r,e){const o=this._getTree(e);return this._captureAtRange(t,new S(r,r),o?.tree)}captureAtPositionTree(t,r,e){return this._captureAtRange(t,new S(r,r),e)}_captureAtRange(t,r,e){const o=this._ensureQuery();return!e||!o?[]:o.captures(e.rootNode,{startPosition:{row:t-1,column:r.startColumn-1},endPosition:{row:t-1,column:r.endColumnExclusive}})}tokenizeEncoded(t,r){const e=r.getLineMaxColumn(t),o=this._getTree(r),i=this._captureAtRange(t,new S(1,e),o?.tree);if(i.length===0)return;const s=Array(i.length);s.fill({endOffset:0,scopes:[]});let n=0;const d=r.getOffsetAt({lineNumber:t,column:1}),m=()=>{s.push({endOffset:0,scopes:[]})},L=this._languageIdCodec.encodeLanguageId(this._languageId);for(let u=0;u<i.length;u++){const a=i[u],y=a.node.endIndex<d+e?a.node.endIndex:d+e,k=a.node.startIndex<d?d:a.node.startIndex,v=y-d;let p;const C=y-k;u>0?p=s[n-1].endOffset:p=k-d-1;const I=v-C;p>=0&&p<I&&(s[n]={endOffset:I,scopes:[]},n++,m());const P=()=>{s[n]={endOffset:v,scopes:[a.name]},n++};if(p>=v){const A=n>=2?s[n-2].endOffset:0,x=s[n-1].endOffset;A+C===x?s[n-1].scopes.push(a.name):(s[n-1].endOffset=I,P(),m(),s[n].endOffset=x,s[n].scopes=s[n-2].scopes,n++)}else P()}i[i.length-1].node.endPosition.column+1<e&&(m(),s[n].endOffset=e-1,n++);const _=new Uint32Array(n*2);for(let u=0;u<n;u++){const a=s[u];if(a.endOffset===0&&a.scopes.length===0)break;_[u*2]=a.endOffset,_[u*2+1]=j(this._colorThemeData,a.scopes,L)}return _}dispose(){super.dispose(),this._query?.delete(),this._query=void 0}};h=T([g(3,U),g(4,$)],h),V(K,f,G.Eager);export{K as ITreeSitterTokenizationFeature};
