var g=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var p=(a,e,o,i)=>{for(var n=i>1?void 0:i?v(e,o):e,t=a.length-1,r;t>=0;t--)(r=a[t])&&(n=(i?r(e,o,n):r(n))||n);return i&&n&&g(e,o,n),n},l=(a,e)=>(o,i)=>e(o,i,a);import{addDisposableListener as f,EventType as u}from"../../../../../vs/base/browser/dom.js";import{mainWindow as s}from"../../../../../vs/base/browser/window.js";import{firstOrDefault as m}from"../../../../../vs/base/common/arrays.js";import{CancellationToken as S}from"../../../../../vs/base/common/cancellation.js";import"../../../../../vs/base/common/lifecycle.js";import{localize as U}from"../../../../../vs/nls.js";import{InstantiationType as w,registerSingleton as b}from"../../../../../vs/platform/instantiation/common/extensions.js";import{ILogService as y}from"../../../../../vs/platform/log/common/log.js";import{IStorageService as E,WillSaveStateReason as h}from"../../../../../vs/platform/storage/common/storage.js";import{ILifecycleService as L,ShutdownReason as c,StartupKind as B}from"../../../../../vs/workbench/services/lifecycle/common/lifecycle.js";import{AbstractLifecycleService as D}from"../../../../../vs/workbench/services/lifecycle/common/lifecycleService.js";let d=class extends D{beforeUnloadListener=void 0;unloadListener=void 0;ignoreBeforeUnload=!1;didUnload=!1;constructor(e,o){super(e,o),this.registerListeners()}registerListeners(){this.beforeUnloadListener=f(s,u.BEFORE_UNLOAD,e=>this.onBeforeUnload(e)),this.unloadListener=f(s,u.PAGE_HIDE,()=>this.onUnload())}onBeforeUnload(e){this.ignoreBeforeUnload?(this.logService.info("[lifecycle] onBeforeUnload triggered but ignored once"),this.ignoreBeforeUnload=!1):(this.logService.info("[lifecycle] onBeforeUnload triggered and handled with veto support"),this.doShutdown(()=>this.vetoBeforeUnload(e)))}vetoBeforeUnload(e){e.preventDefault(),e.returnValue=U("lifecycleVeto","Changes that you made may not be saved. Please check press 'Cancel' and try again.")}withExpectedShutdown(e,o){if(typeof e=="number")return this.shutdownReason=e,this.storageService.flush(h.SHUTDOWN);this.ignoreBeforeUnload=!0;try{o?.()}finally{this.ignoreBeforeUnload=!1}}async shutdown(){this.logService.info("[lifecycle] shutdown triggered"),this.beforeUnloadListener?.dispose(),this.unloadListener?.dispose(),await this.storageService.flush(h.SHUTDOWN),this.doShutdown()}doShutdown(e){const o=this.logService;this.storageService.flush(h.SHUTDOWN);let i=!1;function n(t,r){typeof e=="function"&&(t instanceof Promise&&(o.error(`[lifecycle] Long running operations before shutdown are unsupported in the web (id: ${r})`),i=!0),t===!0&&(o.info(`[lifecycle]: Unload was prevented (id: ${r})`),i=!0))}return this._onBeforeShutdown.fire({reason:c.QUIT,veto(t,r){n(t,r)},finalVeto(t,r){n(t(),r)}}),i&&typeof e=="function"?e():this.onUnload()}onUnload(){if(this.didUnload)return;this.didUnload=!0,this._register(f(s,u.PAGE_SHOW,o=>this.onLoadAfterUnload(o)));const e=this.logService;this._onWillShutdown.fire({reason:c.QUIT,joiners:()=>[],token:S.None,join(o,i){e.error(`[lifecycle] Long running operations during shutdown are unsupported in the web (id: ${i.id})`)},force:()=>{}}),this._onDidShutdown.fire()}onLoadAfterUnload(e){e.persisted&&this.withExpectedShutdown({disableShutdownHandling:!0},()=>s.location.reload())}doResolveStartupKind(){let e=super.doResolveStartupKind();return typeof e!="number"&&m(performance.getEntriesByType("navigation"))?.type==="reload"&&(e=B.ReloadedWindow),e}};d=p([l(0,y),l(1,E)],d),b(L,d,w.Eager);export{d as BrowserLifecycleService};
