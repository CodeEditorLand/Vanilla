{
  "version": 3,
  "sources": ["../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/services/lifecycle/electron-sandbox/lifecycleService.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport {\n\tPromises,\n\tdisposableTimeout,\n\traceCancellation,\n} from \"../../../../base/common/async.js\";\nimport { CancellationTokenSource } from \"../../../../base/common/cancellation.js\";\nimport { toErrorMessage } from \"../../../../base/common/errorMessage.js\";\nimport { ipcRenderer } from \"../../../../base/parts/sandbox/electron-sandbox/globals.js\";\nimport {\n\tInstantiationType,\n\tregisterSingleton,\n} from \"../../../../platform/instantiation/common/extensions.js\";\nimport { handleVetos } from \"../../../../platform/lifecycle/common/lifecycle.js\";\nimport { ILogService } from \"../../../../platform/log/common/log.js\";\nimport { INativeHostService } from \"../../../../platform/native/common/native.js\";\nimport { IStorageService } from \"../../../../platform/storage/common/storage.js\";\nimport {\n\tILifecycleService,\n\ttype IWillShutdownEventJoiner,\n\ttype ShutdownReason,\n\tWillShutdownJoinerOrder,\n} from \"../common/lifecycle.js\";\nimport { AbstractLifecycleService } from \"../common/lifecycleService.js\";\n\nexport class NativeLifecycleService extends AbstractLifecycleService {\n\tprivate static readonly BEFORE_SHUTDOWN_WARNING_DELAY = 5000;\n\tprivate static readonly WILL_SHUTDOWN_WARNING_DELAY = 800;\n\n\tconstructor(\n\t\t@INativeHostService\n\t\tprivate readonly nativeHostService: INativeHostService,\n\t\t@IStorageService storageService: IStorageService,\n\t\t@ILogService logService: ILogService,\n\t) {\n\t\tsuper(logService, storageService);\n\n\t\tthis.registerListeners();\n\t}\n\n\tprivate registerListeners(): void {\n\t\tconst windowId = this.nativeHostService.windowId;\n\n\t\t// Main side indicates that window is about to unload, check for vetos\n\t\tipcRenderer.on(\n\t\t\t\"vscode:onBeforeUnload\",\n\t\t\tasync (\n\t\t\t\tevent: unknown,\n\t\t\t\treply: {\n\t\t\t\t\tokChannel: string;\n\t\t\t\t\tcancelChannel: string;\n\t\t\t\t\treason: ShutdownReason;\n\t\t\t\t},\n\t\t\t) => {\n\t\t\t\tthis.logService.trace(\n\t\t\t\t\t`[lifecycle] onBeforeUnload (reason: ${reply.reason})`,\n\t\t\t\t);\n\n\t\t\t\t// trigger onBeforeShutdown events and veto collecting\n\t\t\t\tconst veto = await this.handleBeforeShutdown(reply.reason);\n\n\t\t\t\t// veto: cancel unload\n\t\t\t\tif (veto) {\n\t\t\t\t\tthis.logService.trace(\n\t\t\t\t\t\t\"[lifecycle] onBeforeUnload prevented via veto\",\n\t\t\t\t\t);\n\n\t\t\t\t\t// Indicate as event\n\t\t\t\t\tthis._onShutdownVeto.fire();\n\n\t\t\t\t\tipcRenderer.send(reply.cancelChannel, windowId);\n\t\t\t\t}\n\n\t\t\t\t// no veto: allow unload\n\t\t\t\telse {\n\t\t\t\t\tthis.logService.trace(\n\t\t\t\t\t\t\"[lifecycle] onBeforeUnload continues without veto\",\n\t\t\t\t\t);\n\n\t\t\t\t\tthis.shutdownReason = reply.reason;\n\t\t\t\t\tipcRenderer.send(reply.okChannel, windowId);\n\t\t\t\t}\n\t\t\t},\n\t\t);\n\n\t\t// Main side indicates that we will indeed shutdown\n\t\tipcRenderer.on(\n\t\t\t\"vscode:onWillUnload\",\n\t\t\tasync (\n\t\t\t\tevent: unknown,\n\t\t\t\treply: { replyChannel: string; reason: ShutdownReason },\n\t\t\t) => {\n\t\t\t\tthis.logService.trace(\n\t\t\t\t\t`[lifecycle] onWillUnload (reason: ${reply.reason})`,\n\t\t\t\t);\n\n\t\t\t\t// trigger onWillShutdown events and joining\n\t\t\t\tawait this.handleWillShutdown(reply.reason);\n\n\t\t\t\t// trigger onDidShutdown event now that we know we will quit\n\t\t\t\tthis._onDidShutdown.fire();\n\n\t\t\t\t// acknowledge to main side\n\t\t\t\tipcRenderer.send(reply.replyChannel, windowId);\n\t\t\t},\n\t\t);\n\t}\n\n\tprotected async handleBeforeShutdown(\n\t\treason: ShutdownReason,\n\t): Promise<boolean> {\n\t\tconst logService = this.logService;\n\n\t\tconst vetos: (boolean | Promise<boolean>)[] = [];\n\t\tconst pendingVetos = new Set<string>();\n\n\t\tlet finalVeto: (() => boolean | Promise<boolean>) | undefined;\n\t\tlet finalVetoId: string | undefined;\n\n\t\t// before-shutdown event with veto support\n\t\tthis._onBeforeShutdown.fire({\n\t\t\treason,\n\t\t\tveto(value, id) {\n\t\t\t\tvetos.push(value);\n\n\t\t\t\t// Log any veto instantly\n\t\t\t\tif (value === true) {\n\t\t\t\t\tlogService.info(\n\t\t\t\t\t\t`[lifecycle]: Shutdown was prevented (id: ${id})`,\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\t// Track promise completion\n\t\t\t\telse if (value instanceof Promise) {\n\t\t\t\t\tpendingVetos.add(id);\n\t\t\t\t\tvalue\n\t\t\t\t\t\t.then((veto) => {\n\t\t\t\t\t\t\tif (veto === true) {\n\t\t\t\t\t\t\t\tlogService.info(\n\t\t\t\t\t\t\t\t\t`[lifecycle]: Shutdown was prevented (id: ${id})`,\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.finally(() => pendingVetos.delete(id));\n\t\t\t\t}\n\t\t\t},\n\t\t\tfinalVeto(value, id) {\n\t\t\t\tif (finalVeto) {\n\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t`[lifecycle]: Final veto is already defined (id: ${id})`,\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\tfinalVeto = value;\n\t\t\t\t\tfinalVetoId = id;\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\n\t\tconst longRunningBeforeShutdownWarning = disposableTimeout(() => {\n\t\t\tlogService.warn(\n\t\t\t\t`[lifecycle] onBeforeShutdown is taking a long time, pending operations: ${Array.from(pendingVetos).join(\", \")}`,\n\t\t\t);\n\t\t}, NativeLifecycleService.BEFORE_SHUTDOWN_WARNING_DELAY);\n\n\t\ttry {\n\t\t\t// First: run list of vetos in parallel\n\t\t\tlet veto = await handleVetos(vetos, (error) =>\n\t\t\t\tthis.handleBeforeShutdownError(error, reason),\n\t\t\t);\n\t\t\tif (veto) {\n\t\t\t\treturn veto;\n\t\t\t}\n\n\t\t\t// Second: run the final veto if defined\n\t\t\tif (finalVeto) {\n\t\t\t\ttry {\n\t\t\t\t\tpendingVetos.add(finalVetoId as unknown as string);\n\t\t\t\t\tveto = await (finalVeto as () => Promise<boolean>)();\n\t\t\t\t\tif (veto) {\n\t\t\t\t\t\tlogService.info(\n\t\t\t\t\t\t\t`[lifecycle]: Shutdown was prevented by final veto (id: ${finalVetoId})`,\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t} catch (error) {\n\t\t\t\t\tveto = true; // treat error as veto\n\n\t\t\t\t\tthis.handleBeforeShutdownError(error, reason);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn veto;\n\t\t} finally {\n\t\t\tlongRunningBeforeShutdownWarning.dispose();\n\t\t}\n\t}\n\n\tprivate handleBeforeShutdownError(\n\t\terror: Error,\n\t\treason: ShutdownReason,\n\t): void {\n\t\tthis.logService.error(\n\t\t\t`[lifecycle]: Error during before-shutdown phase (error: ${toErrorMessage(error)})`,\n\t\t);\n\n\t\tthis._onBeforeShutdownError.fire({ reason, error });\n\t}\n\n\tprotected async handleWillShutdown(reason: ShutdownReason): Promise<void> {\n\t\tconst joiners: Promise<void>[] = [];\n\t\tconst lastJoiners: (() => Promise<void>)[] = [];\n\t\tconst pendingJoiners = new Set<IWillShutdownEventJoiner>();\n\t\tconst cts = new CancellationTokenSource();\n\t\tthis._onWillShutdown.fire({\n\t\t\treason,\n\t\t\ttoken: cts.token,\n\t\t\tjoiners: () => Array.from(pendingJoiners.values()),\n\t\t\tjoin(promiseOrPromiseFn, joiner) {\n\t\t\t\tpendingJoiners.add(joiner);\n\n\t\t\t\tif (joiner.order === WillShutdownJoinerOrder.Last) {\n\t\t\t\t\tconst promiseFn =\n\t\t\t\t\t\ttypeof promiseOrPromiseFn === \"function\"\n\t\t\t\t\t\t\t? promiseOrPromiseFn\n\t\t\t\t\t\t\t: () => promiseOrPromiseFn;\n\t\t\t\t\tlastJoiners.push(() =>\n\t\t\t\t\t\tpromiseFn().finally(() =>\n\t\t\t\t\t\t\tpendingJoiners.delete(joiner),\n\t\t\t\t\t\t),\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\tconst promise =\n\t\t\t\t\t\ttypeof promiseOrPromiseFn === \"function\"\n\t\t\t\t\t\t\t? promiseOrPromiseFn()\n\t\t\t\t\t\t\t: promiseOrPromiseFn;\n\t\t\t\t\tpromise.finally(() => pendingJoiners.delete(joiner));\n\t\t\t\t\tjoiners.push(promise);\n\t\t\t\t}\n\t\t\t},\n\t\t\tforce: () => {\n\t\t\t\tcts.dispose(true);\n\t\t\t},\n\t\t});\n\n\t\tconst longRunningWillShutdownWarning = disposableTimeout(() => {\n\t\t\tthis.logService.warn(\n\t\t\t\t`[lifecycle] onWillShutdown is taking a long time, pending operations: ${Array.from(\n\t\t\t\t\tpendingJoiners,\n\t\t\t\t)\n\t\t\t\t\t.map((joiner) => joiner.id)\n\t\t\t\t\t.join(\", \")}`,\n\t\t\t);\n\t\t}, NativeLifecycleService.WILL_SHUTDOWN_WARNING_DELAY);\n\n\t\ttry {\n\t\t\tawait raceCancellation(Promises.settled(joiners), cts.token);\n\t\t} catch (error) {\n\t\t\tthis.logService.error(\n\t\t\t\t`[lifecycle]: Error during will-shutdown phase in default joiners (error: ${toErrorMessage(error)})`,\n\t\t\t);\n\t\t}\n\n\t\ttry {\n\t\t\tawait raceCancellation(\n\t\t\t\tPromises.settled(lastJoiners.map((lastJoiner) => lastJoiner())),\n\t\t\t\tcts.token,\n\t\t\t);\n\t\t} catch (error) {\n\t\t\tthis.logService.error(\n\t\t\t\t`[lifecycle]: Error during will-shutdown phase in last joiners (error: ${toErrorMessage(error)})`,\n\t\t\t);\n\t\t}\n\n\t\tlongRunningWillShutdownWarning.dispose();\n\t}\n\n\tshutdown(): Promise<void> {\n\t\treturn this.nativeHostService.closeWindow();\n\t}\n}\n\nregisterSingleton(\n\tILifecycleService,\n\tNativeLifecycleService,\n\tInstantiationType.Eager,\n);\n"],
  "mappings": "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",
  "names": []
}
