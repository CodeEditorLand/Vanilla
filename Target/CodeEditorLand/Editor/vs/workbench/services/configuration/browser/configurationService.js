var ce=Object.defineProperty;var ge=Object.getOwnPropertyDescriptor;var L=(m,h,e,i)=>{for(var t=i>1?void 0:i?ge(h,e):h,r=m.length-1,n;r>=0;r--)(n=m[r])&&(t=(i?n(h,e,t):n(t))||t);return i&&t&&ce(h,e,t),t},I=(m,h)=>(e,i)=>h(e,i,m);import{URI as Q}from"../../../../base/common/uri.js";import{Event as ue,Emitter as y}from"../../../../base/common/event.js";import{ResourceMap as W}from"../../../../base/common/map.js";import{equals as K}from"../../../../base/common/objects.js";import{Disposable as M,DisposableStore as de}from"../../../../base/common/lifecycle.js";import{Queue as le,Barrier as $,Promises as Y,Delayer as fe}from"../../../../base/common/async.js";import{Extensions as pe}from"../../../../platform/jsonschemas/common/jsonContributionRegistry.js";import{IWorkspaceContextService as he,Workspace as Ce,WorkbenchState as C,toWorkspaceFolder as me,isWorkspaceFolder as Se,isSingleFolderWorkspaceIdentifier as G,isWorkspaceIdentifier as X}from"../../../../platform/workspace/common/workspace.js";import{ConfigurationModel as k,ConfigurationChangeEvent as ke,mergeChanges as Z}from"../../../../platform/configuration/common/configurationModels.js";import{ConfigurationTarget as c,isConfigurationOverrides as J,ConfigurationTargetToString as ve,isConfigurationUpdateOverrides as Ie,IConfigurationService as we}from"../../../../platform/configuration/common/configuration.js";import{NullPolicyConfiguration as We,PolicyConfiguration as Ee}from"../../../../platform/configuration/common/configurations.js";import{Configuration as ee}from"../common/configurationModels.js";import{FOLDER_CONFIG_FOLDER_NAME as ye,defaultSettingsSchemaId as Pe,userSettingsSchemaId as Re,workspaceSettingsSchemaId as Fe,folderSettingsSchemaId as Ue,machineSettingsSchemaId as _e,LOCAL_MACHINE_SCOPES as be,PROFILE_SCOPES as De,LOCAL_MACHINE_PROFILE_SCOPES as Oe,profileSettingsSchemaId as Ae,APPLY_ALL_PROFILES_SETTING as w}from"../common/configuration.js";import{Registry as P}from"../../../../platform/registry/common/platform.js";import{Extensions as N,allSettings as v,windowSettings as b,resourceSettings as R,applicationSettings as Te,machineSettings as ie,machineOverridableSettings as D,ConfigurationScope as O,keyFromOverrideIdentifiers as Le,OVERRIDE_PROPERTY_PATTERN as Me,resourceLanguageSettingsSchemaId as Ne,configurationDefaultsSchemaId as xe}from"../../../../platform/configuration/common/configurationRegistry.js";import{isStoredWorkspaceFolder as Ve,getStoredWorkspaceFolder as ze,toWorkspaceFolders as j}from"../../../../platform/workspaces/common/workspaces.js";import"../../../../platform/instantiation/common/instantiation.js";import{ConfigurationEditing as Ke,EditableConfigurationTarget as p}from"../common/configurationEditing.js";import{WorkspaceConfiguration as Je,FolderConfiguration as je,RemoteUserConfiguration as Be,UserConfiguration as qe,DefaultConfiguration as He,ApplicationConfiguration as Qe}from"./configuration.js";import"../../../../base/common/jsonSchema.js";import{mark as F}from"../../../../base/common/performance.js";import"../../remote/common/remoteAgentService.js";import"../../../../platform/files/common/files.js";import{IWorkbenchEnvironmentService as $e}from"../../environment/common/environmentService.js";import{WorkbenchPhase as Ye,Extensions as Ge,registerWorkbenchContribution2 as Xe}from"../../../common/contributions.js";import{ILifecycleService as Ze,LifecyclePhase as B}from"../../lifecycle/common/lifecycle.js";import"../../../../platform/log/common/log.js";import{toErrorMessage as ei}from"../../../../base/common/errorMessage.js";import"../../../../platform/uriIdentity/common/uriIdentity.js";import{IWorkspaceTrustManagementService as ii}from"../../../../platform/workspace/common/workspaceTrust.js";import{delta as U,distinct as te,equals as ti}from"../../../../base/common/arrays.js";import"../../../../base/common/collections.js";import{IExtensionService as re}from"../../extensions/common/extensions.js";import{IWorkbenchAssignmentService as ri}from"../../assignment/common/assignmentService.js";import{isUndefined as oi}from"../../../../base/common/types.js";import{localize as oe}from"../../../../nls.js";import"../../userDataProfile/common/userDataProfile.js";import{NullPolicyService as ni}from"../../../../platform/policy/common/policy.js";import"../../../../platform/userDataProfile/common/userDataProfile.js";import{IJSONEditingService as ai}from"../common/jsonEditing.js";import"../../environment/browser/environmentService.js";import{workbenchConfigurationNodeBase as si}from"../../../common/configuration.js";import{mainWindow as ci}from"../../../../base/browser/window.js";import{runWhenWindowIdle as gi}from"../../../../base/browser/dom.js";function ne(m,h){return m.isDefault||m.useDefaultFlags?.settings?h?be:void 0:h?Oe:De}class q extends Ce{initialized=!1}class Kt extends M{constructor({remoteAuthority:e,configurationCache:i},t,r,n,o,s,g,a,l){super();this.userDataProfileService=r;this.userDataProfilesService=n;this.fileService=o;this.remoteAgentService=s;this.uriIdentityService=g;this.logService=a;if(this.configurationRegistry=P.as(N.Configuration),this.initRemoteUserConfigurationBarrier=new $,this.completeWorkspaceBarrier=new $,this.defaultConfiguration=this._register(new He(i,t,a)),this.policyConfiguration=l instanceof ni?new We:this._register(new Ee(this.defaultConfiguration,l,a)),this.configurationCache=i,this._configuration=new ee(this.defaultConfiguration.configurationModel,this.policyConfiguration.configurationModel,k.createEmptyModel(a),k.createEmptyModel(a),k.createEmptyModel(a),k.createEmptyModel(a),new W,k.createEmptyModel(a),new W,this.workspace,a),this.applicationConfigurationDisposables=this._register(new de),this.createApplicationConfiguration(),this.localUserConfiguration=this._register(new qe(r.currentProfile.settingsResource,r.currentProfile.tasksResource,{scopes:ne(r.currentProfile,!!e)},o,g,a)),this.cachedFolderConfigs=new W,this._register(this.localUserConfiguration.onDidChangeConfiguration(u=>this.onLocalUserConfigurationChanged(u))),e){const u=this.remoteUserConfiguration=this._register(new Be(e,i,o,g,s,a));this._register(u.onDidInitialize(S=>{this._register(u.onDidChangeConfiguration(E=>this.onRemoteUserConfigurationChanged(E))),this.onRemoteUserConfigurationChanged(S),this.initRemoteUserConfigurationBarrier.open()}))}else this.initRemoteUserConfigurationBarrier.open();this.workspaceConfiguration=this._register(new Je(i,o,g,a)),this._register(this.workspaceConfiguration.onDidUpdateConfiguration(u=>{this.onWorkspaceConfigurationChanged(u).then(()=>{this.workspace.initialized=this.workspaceConfiguration.initialized,this.checkAndMarkWorkspaceComplete(u)})})),this._register(this.defaultConfiguration.onDidChangeConfiguration(({properties:u,defaults:S})=>this.onDefaultConfigurationChanged(S,u))),this._register(this.policyConfiguration.onDidChangeConfiguration(u=>this.onPolicyConfigurationChanged(u))),this._register(r.onDidChangeCurrentProfile(u=>this.onUserDataProfileChanged(u))),this.workspaceEditingQueue=new le}_serviceBrand;workspace;initRemoteUserConfigurationBarrier;completeWorkspaceBarrier;configurationCache;_configuration;initialized=!1;defaultConfiguration;policyConfiguration;applicationConfiguration=null;applicationConfigurationDisposables;localUserConfiguration;remoteUserConfiguration=null;workspaceConfiguration;cachedFolderConfigs;workspaceEditingQueue;_onDidChangeConfiguration=this._register(new y);onDidChangeConfiguration=this._onDidChangeConfiguration.event;_onWillChangeWorkspaceFolders=this._register(new y);onWillChangeWorkspaceFolders=this._onWillChangeWorkspaceFolders.event;_onDidChangeWorkspaceFolders=this._register(new y);onDidChangeWorkspaceFolders=this._onDidChangeWorkspaceFolders.event;_onDidChangeWorkspaceName=this._register(new y);onDidChangeWorkspaceName=this._onDidChangeWorkspaceName.event;_onDidChangeWorkbenchState=this._register(new y);onDidChangeWorkbenchState=this._onDidChangeWorkbenchState.event;isWorkspaceTrusted=!0;_restrictedSettings={default:[]};get restrictedSettings(){return this._restrictedSettings}_onDidChangeRestrictedSettings=this._register(new y);onDidChangeRestrictedSettings=this._onDidChangeRestrictedSettings.event;configurationRegistry;instantiationService;configurationEditing;createApplicationConfiguration(){this.applicationConfigurationDisposables.clear(),this.userDataProfileService.currentProfile.isDefault||this.userDataProfileService.currentProfile.useDefaultFlags?.settings?this.applicationConfiguration=null:(this.applicationConfiguration=this.applicationConfigurationDisposables.add(this._register(new Qe(this.userDataProfilesService,this.fileService,this.uriIdentityService,this.logService))),this.applicationConfigurationDisposables.add(this.applicationConfiguration.onDidChangeConfiguration(e=>this.onApplicationConfigurationChanged(e))))}async getCompleteWorkspace(){return await this.completeWorkspaceBarrier.wait(),this.getWorkspace()}getWorkspace(){return this.workspace}getWorkbenchState(){return this.workspace.configuration?C.WORKSPACE:this.workspace.folders.length===1?C.FOLDER:C.EMPTY}getWorkspaceFolder(e){return this.workspace.getFolder(e)}addFolders(e,i){return this.updateFolders(e,[],i)}removeFolders(e){return this.updateFolders([],e)}async updateFolders(e,i,t){return this.workspaceEditingQueue.queue(()=>this.doUpdateFolders(e,i,t))}isInsideWorkspace(e){return!!this.getWorkspaceFolder(e)}isCurrentWorkspace(e){switch(this.getWorkbenchState()){case C.FOLDER:{let i;return Q.isUri(e)?i=e:G(e)&&(i=e.uri),Q.isUri(i)&&this.uriIdentityService.extUri.isEqual(i,this.workspace.folders[0].uri)}case C.WORKSPACE:return X(e)&&this.workspace.id===e.id}return!1}async doUpdateFolders(e,i,t){if(this.getWorkbenchState()!==C.WORKSPACE||e.length+i.length===0)return Promise.resolve(void 0);let r=!1,n=this.getWorkspace().folders,o=n.map(s=>s.raw).filter((s,g)=>Ve(s)?!this.contains(i,n[g].uri):!0);if(r=n.length!==o.length,e.length){const s=this.getWorkspace().configuration,g=this.uriIdentityService.extUri.dirname(s);n=j(o,s,this.uriIdentityService.extUri);const a=n.map(u=>u.uri),l=[];for(const u of e){const S=u.uri;if(!this.contains(a,S)){try{if(!(await this.fileService.stat(S)).isDirectory)continue}catch{}l.push(ze(S,!1,u.name,g,this.uriIdentityService.extUri))}}l.length>0&&(r=!0,typeof t=="number"&&t>=0&&t<o.length?(o=o.slice(0),o.splice(t,0,...l)):o=[...o,...l])}return r?this.setFolders(o):Promise.resolve(void 0)}async setFolders(e){if(!this.instantiationService)throw new Error("Cannot update workspace folders because workspace service is not yet ready to accept writes.");return await this.instantiationService.invokeFunction(i=>this.workspaceConfiguration.setFolders(e,i.get(ai))),this.onWorkspaceConfigurationChanged(!1)}contains(e,i){return e.some(t=>this.uriIdentityService.extUri.isEqual(t,i))}getConfigurationData(){return this._configuration.toData()}getValue(e,i){const t=typeof e=="string"?e:void 0,r=J(e)?e:J(i)?i:void 0;return this._configuration.getValue(t,r)}async updateValue(e,i,t,r,n){const o=Ie(t)?t:J(t)?{resource:t.resource,overrideIdentifiers:t.overrideIdentifier?[t.overrideIdentifier]:void 0}:void 0,s=o?r:t,g=s?[s]:[];if(o?.overrideIdentifiers&&(o.overrideIdentifiers=te(o.overrideIdentifiers),o.overrideIdentifiers=o.overrideIdentifiers.length?o.overrideIdentifiers:void 0),!g.length){if(o?.overrideIdentifiers&&o.overrideIdentifiers.length>1)throw new Error("Configuration Target is required while updating the value for multiple override identifiers");const a=this.inspect(e,{resource:o?.resource,overrideIdentifier:o?.overrideIdentifiers?o.overrideIdentifiers[0]:void 0});g.push(...this.deriveConfigurationTargets(e,i,a)),K(i,a.defaultValue)&&g.length===1&&(g[0]===c.USER||g[0]===c.USER_LOCAL)&&(i=void 0)}await Y.settled(g.map(a=>this.writeConfigurationValue(e,i,a,o,n)))}async reloadConfiguration(e){if(e===void 0){this.reloadDefaultConfiguration();const i=await this.reloadApplicationConfiguration(!0),{local:t,remote:r}=await this.reloadUserConfiguration();await this.reloadWorkspaceConfiguration(),await this.loadConfiguration(i,t,r,!0);return}if(Se(e)){await this.reloadWorkspaceFolderConfiguration(e);return}switch(e){case c.DEFAULT:this.reloadDefaultConfiguration();return;case c.USER:{const{local:i,remote:t}=await this.reloadUserConfiguration();await this.loadConfiguration(this._configuration.applicationConfiguration,i,t,!0);return}case c.USER_LOCAL:await this.reloadLocalUserConfiguration();return;case c.USER_REMOTE:await this.reloadRemoteUserConfiguration();return;case c.WORKSPACE:case c.WORKSPACE_FOLDER:await this.reloadWorkspaceConfiguration();return}}hasCachedConfigurationDefaultsOverrides(){return this.defaultConfiguration.hasCachedConfigurationDefaultsOverrides()}inspect(e,i){return this._configuration.inspect(e,i)}keys(){return this._configuration.keys()}async whenRemoteConfigurationLoaded(){await this.initRemoteUserConfigurationBarrier.wait()}async initialize(e){F("code/willInitWorkspaceService");const i=this.initialized;this.initialized=!1;const t=await this.createWorkspace(e);await this.updateWorkspaceAndInitializeConfiguration(t,i),this.checkAndMarkWorkspaceComplete(!1),F("code/didInitWorkspaceService")}updateWorkspaceTrust(e){if(this.isWorkspaceTrusted!==e){this.isWorkspaceTrusted=e;const i=this._configuration.toData(),t=[];for(const n of this.workspace.folders){const o=this.cachedFolderConfigs.get(n.uri);let s;o&&(s=o.updateWorkspaceTrust(this.isWorkspaceTrusted),this._configuration.updateFolderConfiguration(n.uri,s)),t.push(s)}this.getWorkbenchState()===C.FOLDER?t[0]&&this._configuration.updateWorkspaceConfiguration(t[0]):this._configuration.updateWorkspaceConfiguration(this.workspaceConfiguration.updateWorkspaceTrust(this.isWorkspaceTrusted)),this.updateRestrictedSettings();let r=[];this.restrictedSettings.userLocal&&r.push(...this.restrictedSettings.userLocal),this.restrictedSettings.userRemote&&r.push(...this.restrictedSettings.userRemote),this.restrictedSettings.workspace&&r.push(...this.restrictedSettings.workspace),this.restrictedSettings.workspaceFolder?.forEach(n=>r.push(...n)),r=te(r),r.length&&this.triggerConfigurationChange({keys:r,overrides:[]},{data:i,workspace:this.workspace},c.WORKSPACE)}}acquireInstantiationService(e){this.instantiationService=e}isSettingAppliedForAllProfiles(e){if(this.configurationRegistry.getConfigurationProperties()[e]?.scope===O.APPLICATION)return!0;const i=this.getValue(w)??[];return Array.isArray(i)&&i.includes(e)}async createWorkspace(e){return X(e)?this.createMultiFolderWorkspace(e):G(e)?this.createSingleFolderWorkspace(e):this.createEmptyWorkspace(e)}async createMultiFolderWorkspace(e){await this.workspaceConfiguration.initialize({id:e.id,configPath:e.configPath},this.isWorkspaceTrusted);const i=e.configPath,t=j(this.workspaceConfiguration.getFolders(),i,this.uriIdentityService.extUri),r=e.id,n=new q(r,t,this.workspaceConfiguration.isTransient(),i,o=>this.uriIdentityService.extUri.ignorePathCasing(o));return n.initialized=this.workspaceConfiguration.initialized,n}createSingleFolderWorkspace(e){const i=new q(e.id,[me(e.uri)],!1,null,t=>this.uriIdentityService.extUri.ignorePathCasing(t));return i.initialized=!0,i}createEmptyWorkspace(e){const i=new q(e.id,[],!1,null,t=>this.uriIdentityService.extUri.ignorePathCasing(t));return i.initialized=!0,Promise.resolve(i)}checkAndMarkWorkspaceComplete(e){!this.completeWorkspaceBarrier.isOpen()&&this.workspace.initialized&&(this.completeWorkspaceBarrier.open(),this.validateWorkspaceFoldersAndReload(e))}async updateWorkspaceAndInitializeConfiguration(e,i){const t=!!this.workspace;let r,n,o=[];if(t?(r=this.getWorkbenchState(),n=this.workspace.configuration?this.workspace.configuration.fsPath:void 0,o=this.workspace.folders,this.workspace.update(e)):this.workspace=e,await this.initializeConfiguration(i),t){const s=this.getWorkbenchState();r&&s!==r&&this._onDidChangeWorkbenchState.fire(s);const g=this.workspace.configuration?this.workspace.configuration.fsPath:void 0;(n&&g!==n||s!==r)&&this._onDidChangeWorkspaceName.fire();const a=this.compareFolders(o,this.workspace.folders);a&&(a.added.length||a.removed.length||a.changed.length)&&(await this.handleWillChangeWorkspaceFolders(a,!1),this._onDidChangeWorkspaceFolders.fire(a))}this.localUserConfiguration.hasTasksLoaded||this._register(gi(ci,()=>this.reloadLocalUserConfiguration(!1,this._configuration.localUserConfiguration)))}compareFolders(e,i){const t={added:[],removed:[],changed:[]};t.added=i.filter(r=>!e.some(n=>r.uri.toString()===n.uri.toString()));for(let r=0;r<e.length;r++){const n=e[r];let o=0;for(o=0;o<i.length&&n.uri.toString()!==i[o].uri.toString();o++);o<i.length?(r!==o||n.name!==i[o].name)&&t.changed.push(n):t.removed.push(n)}return t}async initializeConfiguration(e){await this.defaultConfiguration.initialize();const i=this.policyConfiguration.initialize(),t=this.applicationConfiguration?this.applicationConfiguration.initialize():Promise.resolve(k.createEmptyModel(this.logService)),r=async()=>{F("code/willInitUserConfiguration");const g=await Promise.all([this.localUserConfiguration.initialize(),this.remoteUserConfiguration?this.remoteUserConfiguration.initialize():Promise.resolve(k.createEmptyModel(this.logService))]);if(this.applicationConfiguration){const a=await t;g[0]=this.localUserConfiguration.reparse({exclude:a.getValue(w)})}return F("code/didInitUserConfiguration"),g},[,n,[o,s]]=await Promise.all([i,t,r()]);F("code/willInitWorkspaceConfiguration"),await this.loadConfiguration(n,o,s,e),F("code/didInitWorkspaceConfiguration")}reloadDefaultConfiguration(){this.onDefaultConfigurationChanged(this.defaultConfiguration.reload())}async reloadApplicationConfiguration(e){if(!this.applicationConfiguration)return k.createEmptyModel(this.logService);const i=await this.applicationConfiguration.loadConfiguration();return e||this.onApplicationConfigurationChanged(i),i}async reloadUserConfiguration(){const[e,i]=await Promise.all([this.reloadLocalUserConfiguration(!0),this.reloadRemoteUserConfiguration(!0)]);return{local:e,remote:i}}async reloadLocalUserConfiguration(e,i){const t=await this.localUserConfiguration.reload(i);return e||this.onLocalUserConfigurationChanged(t),t}async reloadRemoteUserConfiguration(e){if(this.remoteUserConfiguration){const i=await this.remoteUserConfiguration.reload();return e||this.onRemoteUserConfigurationChanged(i),i}return k.createEmptyModel(this.logService)}async reloadWorkspaceConfiguration(){const e=this.getWorkbenchState();if(e===C.FOLDER)return this.onWorkspaceFolderConfigurationChanged(this.workspace.folders[0]);if(e===C.WORKSPACE)return this.workspaceConfiguration.reload().then(()=>this.onWorkspaceConfigurationChanged(!1))}reloadWorkspaceFolderConfiguration(e){return this.onWorkspaceFolderConfigurationChanged(e)}async loadConfiguration(e,i,t,r){this.cachedFolderConfigs=new W;const n=this.workspace.folders,o=await this.loadFolderConfigurations(n),s=this.getWorkspaceConfigurationModel(o),g=new W;o.forEach((l,u)=>g.set(n[u].uri,l));const a=this._configuration;if(this._configuration=new ee(this.defaultConfiguration.configurationModel,this.policyConfiguration.configurationModel,e,i,t,s,g,k.createEmptyModel(this.logService),new W,this.workspace,this.logService),this.initialized=!0,r){const l=this._configuration.compare(a);this.triggerConfigurationChange(l,{data:a.toData(),workspace:this.workspace},c.WORKSPACE)}this.updateRestrictedSettings()}getWorkspaceConfigurationModel(e){switch(this.getWorkbenchState()){case C.FOLDER:return e[0];case C.WORKSPACE:return this.workspaceConfiguration.getConfiguration();default:return k.createEmptyModel(this.logService)}}onUserDataProfileChanged(e){e.join((async()=>{const i=[];i.push(this.localUserConfiguration.reset(e.profile.settingsResource,e.profile.tasksResource,{scopes:ne(e.profile,!!this.remoteUserConfiguration)})),(e.previous.isDefault!==e.profile.isDefault||!!e.previous.useDefaultFlags?.settings!=!!e.profile.useDefaultFlags?.settings)&&(this.createApplicationConfiguration(),this.applicationConfiguration&&i.push(this.reloadApplicationConfiguration(!0)));let[t,r]=await Promise.all(i);r=r??this._configuration.applicationConfiguration,this.applicationConfiguration&&(t=this.localUserConfiguration.reparse({exclude:r.getValue(w)})),await this.loadConfiguration(r,t,this._configuration.remoteUserConfiguration,!0)})())}onDefaultConfigurationChanged(e,i){if(this.workspace){const t=this._configuration.toData(),r=this._configuration.compareAndUpdateDefaultConfiguration(e,i);if(this.applicationConfiguration&&this._configuration.updateApplicationConfiguration(this.applicationConfiguration.reparse()),this.remoteUserConfiguration&&(this._configuration.updateLocalUserConfiguration(this.localUserConfiguration.reparse()),this._configuration.updateRemoteUserConfiguration(this.remoteUserConfiguration.reparse())),this.getWorkbenchState()===C.FOLDER){const n=this.cachedFolderConfigs.get(this.workspace.folders[0].uri);n&&(this._configuration.updateWorkspaceConfiguration(n.reparse()),this._configuration.updateFolderConfiguration(this.workspace.folders[0].uri,n.reparse()))}else{this._configuration.updateWorkspaceConfiguration(this.workspaceConfiguration.reparseWorkspaceSettings());for(const n of this.workspace.folders){const o=this.cachedFolderConfigs.get(n.uri);o&&this._configuration.updateFolderConfiguration(n.uri,o.reparse())}}this.triggerConfigurationChange(r,{data:t,workspace:this.workspace},c.DEFAULT),this.updateRestrictedSettings()}}onPolicyConfigurationChanged(e){const i={data:this._configuration.toData(),workspace:this.workspace},t=this._configuration.compareAndUpdatePolicyConfiguration(e);this.triggerConfigurationChange(t,i,c.DEFAULT)}onApplicationConfigurationChanged(e){const i={data:this._configuration.toData(),workspace:this.workspace},t=this._configuration.applicationConfiguration.getValue(w)??[],r=this._configuration.compareAndUpdateApplicationConfiguration(e),n=this.getValue(w)??[],o=this.configurationRegistry.getConfigurationProperties(),s=[];for(const g of r.keys)if(o[g]?.scope===O.APPLICATION){if(s.push(g),g===w){for(const a of t)n.includes(a)||s.push(a);for(const a of n)t.includes(a)||s.push(a)}}else n.includes(g)&&s.push(g);r.keys=s,r.keys.includes(w)&&this._configuration.updateLocalUserConfiguration(this.localUserConfiguration.reparse({exclude:n})),this.triggerConfigurationChange(r,i,c.USER)}onLocalUserConfigurationChanged(e){const i={data:this._configuration.toData(),workspace:this.workspace},t=this._configuration.compareAndUpdateLocalUserConfiguration(e);this.triggerConfigurationChange(t,i,c.USER)}onRemoteUserConfigurationChanged(e){const i={data:this._configuration.toData(),workspace:this.workspace},t=this._configuration.compareAndUpdateRemoteUserConfiguration(e);this.triggerConfigurationChange(t,i,c.USER)}async onWorkspaceConfigurationChanged(e){if(this.workspace&&this.workspace.configuration){let i=j(this.workspaceConfiguration.getFolders(),this.workspace.configuration,this.uriIdentityService.extUri);if(this.workspace.initialized){const{added:t,removed:r,changed:n}=this.compareFolders(this.workspace.folders,i);t.length||r.length||n.length?i=await this.toValidWorkspaceFolders(i):i=this.workspace.folders}await this.updateWorkspaceConfiguration(i,this.workspaceConfiguration.getConfiguration(),e)}}updateRestrictedSettings(){const e=[],i=this.configurationRegistry.getConfigurationProperties(),t=Object.keys(i).filter(d=>i[d].restricted).sort((d,f)=>d.localeCompare(f)),r=U(t,this._restrictedSettings.default,(d,f)=>d.localeCompare(f));e.push(...r.added,...r.removed);const n=(this.applicationConfiguration?.getRestrictedSettings()||[]).sort((d,f)=>d.localeCompare(f)),o=U(n,this._restrictedSettings.application||[],(d,f)=>d.localeCompare(f));e.push(...o.added,...o.removed);const s=this.localUserConfiguration.getRestrictedSettings().sort((d,f)=>d.localeCompare(f)),g=U(s,this._restrictedSettings.userLocal||[],(d,f)=>d.localeCompare(f));e.push(...g.added,...g.removed);const a=(this.remoteUserConfiguration?.getRestrictedSettings()||[]).sort((d,f)=>d.localeCompare(f)),l=U(a,this._restrictedSettings.userRemote||[],(d,f)=>d.localeCompare(f));e.push(...l.added,...l.removed);const u=new W;for(const d of this.workspace.folders){const x=(this.cachedFolderConfigs.get(d.uri)?.getRestrictedSettings()||[]).sort((V,z)=>V.localeCompare(z));x.length&&u.set(d.uri,x);const se=this._restrictedSettings.workspaceFolder?.get(d.uri)||[],H=U(x,se,(V,z)=>V.localeCompare(z));e.push(...H.added,...H.removed)}const S=this.getWorkbenchState()===C.WORKSPACE?this.workspaceConfiguration.getRestrictedSettings().sort((d,f)=>d.localeCompare(f)):this.workspace.folders[0]?u.get(this.workspace.folders[0].uri)||[]:[],E=U(S,this._restrictedSettings.workspace||[],(d,f)=>d.localeCompare(f));e.push(...E.added,...E.removed),e.length&&(this._restrictedSettings={default:t,application:n.length?n:void 0,userLocal:s.length?s:void 0,userRemote:a.length?a:void 0,workspace:S.length?S:void 0,workspaceFolder:u.size?u:void 0},this._onDidChangeRestrictedSettings.fire(this.restrictedSettings))}async updateWorkspaceConfiguration(e,i,t){const r={data:this._configuration.toData(),workspace:this.workspace},n=this._configuration.compareAndUpdateWorkspaceConfiguration(i),o=this.compareFolders(this.workspace.folders,e);if(o.added.length||o.removed.length||o.changed.length){this.workspace.folders=e;const s=await this.onFoldersChanged();await this.handleWillChangeWorkspaceFolders(o,t),this.triggerConfigurationChange(s,r,c.WORKSPACE_FOLDER),this._onDidChangeWorkspaceFolders.fire(o)}else this.triggerConfigurationChange(n,r,c.WORKSPACE);this.updateRestrictedSettings()}async handleWillChangeWorkspaceFolders(e,i){const t=[];this._onWillChangeWorkspaceFolders.fire({join(r){t.push(r)},changes:e,fromCache:i});try{await Y.settled(t)}catch{}}async onWorkspaceFolderConfigurationChanged(e){const[i]=await this.loadFolderConfigurations([e]),t={data:this._configuration.toData(),workspace:this.workspace},r=this._configuration.compareAndUpdateFolderConfiguration(e.uri,i);if(this.getWorkbenchState()===C.FOLDER){const n=this._configuration.compareAndUpdateWorkspaceConfiguration(i);this.triggerConfigurationChange(Z(r,n),t,c.WORKSPACE)}else this.triggerConfigurationChange(r,t,c.WORKSPACE_FOLDER);this.updateRestrictedSettings()}async onFoldersChanged(){const e=[];for(const t of this.cachedFolderConfigs.keys())this.workspace.folders.filter(r=>r.uri.toString()===t.toString())[0]||(this.cachedFolderConfigs.get(t).dispose(),this.cachedFolderConfigs.delete(t),e.push(this._configuration.compareAndDeleteFolderConfiguration(t)));const i=this.workspace.folders.filter(t=>!this.cachedFolderConfigs.has(t.uri));return i.length&&(await this.loadFolderConfigurations(i)).forEach((r,n)=>{e.push(this._configuration.compareAndUpdateFolderConfiguration(i[n].uri,r))}),Z(...e)}loadFolderConfigurations(e){return Promise.all([...e.map(i=>{let t=this.cachedFolderConfigs.get(i.uri);return t||(t=new je(!this.initialized,i,ye,this.getWorkbenchState(),this.isWorkspaceTrusted,this.fileService,this.uriIdentityService,this.logService,this.configurationCache),this._register(t.onDidChange(()=>this.onWorkspaceFolderConfigurationChanged(i))),this.cachedFolderConfigs.set(i.uri,this._register(t))),t.loadConfiguration()})])}async validateWorkspaceFoldersAndReload(e){const i=await this.toValidWorkspaceFolders(this.workspace.folders),{removed:t}=this.compareFolders(this.workspace.folders,i);t.length&&await this.updateWorkspaceConfiguration(i,this.workspaceConfiguration.getConfiguration(),e)}async toValidWorkspaceFolders(e){const i=[];for(const t of e){try{if(!(await this.fileService.stat(t.uri)).isDirectory)continue}catch(r){this.logService.warn(`Ignoring the error while validating workspace folder ${t.uri.toString()} - ${ei(r)}`)}i.push(t)}return i}async writeConfigurationValue(e,i,t,r,n){if(!this.instantiationService)throw new Error("Cannot write configuration because the configuration service is not yet ready to accept writes.");if(t===c.DEFAULT)throw new Error("Invalid configuration target");if(t===c.MEMORY){const s={data:this._configuration.toData(),workspace:this.workspace};this._configuration.updateValue(e,i,r),this.triggerConfigurationChange({keys:r?.overrideIdentifiers?.length?[Le(r.overrideIdentifiers),e]:[e],overrides:r?.overrideIdentifiers?.length?r.overrideIdentifiers.map(g=>[g,[e]]):[]},s,t);return}const o=this.toEditableConfigurationTarget(t,e);if(!o)throw new Error("Invalid configuration target");if(o===p.USER_REMOTE&&!this.remoteUserConfiguration)throw new Error("Invalid configuration target");if(r?.overrideIdentifiers?.length&&r.overrideIdentifiers.length>1){const s=this.getConfigurationModelForEditableConfigurationTarget(o,r.resource);if(s){const g=r.overrideIdentifiers.sort(),a=s.overrides.find(l=>ti([...l.identifiers].sort(),g));a&&(r.overrideIdentifiers=a.identifiers)}}switch(this.configurationEditing=this.configurationEditing??this.createConfigurationEditingService(this.instantiationService),await(await this.configurationEditing).writeConfiguration(o,{key:e,value:i},{scopes:r,...n}),o){case p.USER_LOCAL:this.applicationConfiguration&&this.isSettingAppliedForAllProfiles(e)?await this.reloadApplicationConfiguration():await this.reloadLocalUserConfiguration();return;case p.USER_REMOTE:return this.reloadRemoteUserConfiguration().then(()=>{});case p.WORKSPACE:return this.reloadWorkspaceConfiguration();case p.WORKSPACE_FOLDER:{const s=r&&r.resource?this.workspace.getFolder(r.resource):null;if(s)return this.reloadWorkspaceFolderConfiguration(s)}}}async createConfigurationEditingService(e){const i=(await this.remoteAgentService.getEnvironment())?.settingsPath??null;return e.createInstance(Ke,i)}getConfigurationModelForEditableConfigurationTarget(e,i){switch(e){case p.USER_LOCAL:return this._configuration.localUserConfiguration;case p.USER_REMOTE:return this._configuration.remoteUserConfiguration;case p.WORKSPACE:return this._configuration.workspaceConfiguration;case p.WORKSPACE_FOLDER:return i?this._configuration.folderConfigurations.get(i):void 0}}getConfigurationModel(e,i){switch(e){case c.USER_LOCAL:return this._configuration.localUserConfiguration;case c.USER_REMOTE:return this._configuration.remoteUserConfiguration;case c.WORKSPACE:return this._configuration.workspaceConfiguration;case c.WORKSPACE_FOLDER:return i?this._configuration.folderConfigurations.get(i):void 0;default:return}}deriveConfigurationTargets(e,i,t){if(K(i,t.value))return[];const r=[];return t.workspaceFolderValue!==void 0&&r.push(c.WORKSPACE_FOLDER),t.workspaceValue!==void 0&&r.push(c.WORKSPACE),t.userRemoteValue!==void 0&&r.push(c.USER_REMOTE),t.userLocalValue!==void 0&&r.push(c.USER_LOCAL),t.applicationValue!==void 0&&r.push(c.APPLICATION),i===void 0?r:[r[0]||c.USER]}triggerConfigurationChange(e,i,t){if(e.keys.length){t!==c.DEFAULT&&this.logService.debug(`Configuration keys changed in ${ve(t)} target`,...e.keys);const r=new ke(e,i,this._configuration,this.workspace,this.logService);r.source=t,this._onDidChangeConfiguration.fire(r)}}toEditableConfigurationTarget(e,i){if(e===c.APPLICATION)return p.USER_LOCAL;if(e===c.USER){if(this.remoteUserConfiguration){const t=this.configurationRegistry.getConfigurationProperties()[i]?.scope;if(t===O.MACHINE||t===O.MACHINE_OVERRIDABLE)return p.USER_REMOTE;if(this.inspect(i).userRemoteValue!==void 0)return p.USER_REMOTE}return p.USER_LOCAL}return e===c.USER_LOCAL?p.USER_LOCAL:e===c.USER_REMOTE?p.USER_REMOTE:e===c.WORKSPACE?p.WORKSPACE:e===c.WORKSPACE_FOLDER?p.WORKSPACE_FOLDER:null}}let A=class extends M{constructor(e,i,t,r,n){super();this.workspaceContextService=e;this.environmentService=i;this.workspaceTrustManagementService=t;r.whenInstalledExtensionsRegistered().then(()=>{this.registerConfigurationSchemas();const o=P.as(N.Configuration),s=this._register(new fe(50));this._register(ue.any(o.onDidUpdateConfiguration,o.onDidSchemaChange,t.onDidChangeTrust)(()=>s.trigger(()=>this.registerConfigurationSchemas(),n.phase===B.Eventually?void 0:2500)))})}registerConfigurationSchemas(){const e={properties:v.properties,patternProperties:v.patternProperties,additionalProperties:!0,allowTrailingCommas:!0,allowComments:!0},i=this.environmentService.remoteAuthority?{properties:Object.assign({},Te.properties,b.properties,R.properties),patternProperties:v.patternProperties,additionalProperties:!0,allowTrailingCommas:!0,allowComments:!0}:e,t={properties:Object.assign({},ie.properties,D.properties,b.properties,R.properties),patternProperties:v.patternProperties,additionalProperties:!0,allowTrailingCommas:!0,allowComments:!0},r={properties:Object.assign({},ie.properties,D.properties,b.properties,R.properties),patternProperties:v.patternProperties,additionalProperties:!0,allowTrailingCommas:!0,allowComments:!0},n={properties:Object.assign({},this.checkAndFilterPropertiesRequiringTrust(D.properties),this.checkAndFilterPropertiesRequiringTrust(b.properties),this.checkAndFilterPropertiesRequiringTrust(R.properties)),patternProperties:v.patternProperties,additionalProperties:!0,allowTrailingCommas:!0,allowComments:!0},o={properties:Object.keys(v.properties).reduce((a,l)=>(a[l]=Object.assign({deprecationMessage:void 0},v.properties[l]),a),{}),patternProperties:Object.keys(v.patternProperties).reduce((a,l)=>(a[l]=Object.assign({deprecationMessage:void 0},v.patternProperties[l]),a),{}),additionalProperties:!0,allowTrailingCommas:!0,allowComments:!0},s=C.WORKSPACE===this.workspaceContextService.getWorkbenchState()?{properties:Object.assign({},this.checkAndFilterPropertiesRequiringTrust(D.properties),this.checkAndFilterPropertiesRequiringTrust(R.properties)),patternProperties:v.patternProperties,additionalProperties:!0,allowTrailingCommas:!0,allowComments:!0}:n,g={type:"object",description:oe("configurationDefaults.description","Contribute defaults for configurations"),properties:Object.assign({},this.filterDefaultOverridableProperties(D.properties),this.filterDefaultOverridableProperties(b.properties),this.filterDefaultOverridableProperties(R.properties)),patternProperties:{[Me]:{type:"object",default:{},$ref:Ne}},additionalProperties:!1};this.registerSchemas({defaultSettingsSchema:o,userSettingsSchema:i,profileSettingsSchema:t,machineSettingsSchema:r,workspaceSettingsSchema:n,folderSettingsSchema:s,configDefaultsSchema:g})}registerSchemas(e){const i=P.as(pe.JSONContribution);i.registerSchema(Pe,e.defaultSettingsSchema),i.registerSchema(Re,e.userSettingsSchema),i.registerSchema(Ae,e.profileSettingsSchema),i.registerSchema(_e,e.machineSettingsSchema),i.registerSchema(Fe,e.workspaceSettingsSchema),i.registerSchema(Ue,e.folderSettingsSchema),i.registerSchema(xe,e.configDefaultsSchema)}checkAndFilterPropertiesRequiringTrust(e){if(this.workspaceTrustManagementService.isWorkspaceTrusted())return e;const i={};return Object.entries(e).forEach(([t,r])=>{r.restricted||(i[t]=r)}),i}filterDefaultOverridableProperties(e){const i={};return Object.entries(e).forEach(([t,r])=>{r.disallowConfigurationDefault||(i[t]=r)}),i}};A=L([I(0,he),I(1,$e),I(2,ii),I(3,re),I(4,Ze)],A);let T=class extends M{constructor(h,e){super(),h.hasCachedConfigurationDefaultsOverrides()&&e.whenInstalledExtensionsRegistered().then(()=>h.reloadConfiguration(c.DEFAULT))}};T=L([I(0,we),I(1,re)],T);let _=class extends M{constructor(e){super();this.workbenchAssignmentService=e;this.processExperimentalSettings(Object.keys(this.configurationRegistry.getConfigurationProperties())),this._register(this.configurationRegistry.onDidUpdateConfiguration(({properties:i})=>this.processExperimentalSettings(i)))}static ID="workbench.contrib.updateExperimentalSettingsDefaults";processedExperimentalSettings=new Set;configurationRegistry=P.as(N.Configuration);async processExperimentalSettings(e){const i={},t=this.configurationRegistry.getConfigurationProperties();for(const r of e){const n=t[r];if(n?.tags?.includes("experimental")&&!this.processedExperimentalSettings.has(r)){this.processedExperimentalSettings.add(r);try{const o=await this.workbenchAssignmentService.getTreatment(`config.${r}`);!oi(o)&&!K(o,n.default)&&(i[r]=o)}catch{}}}Object.keys(i).length&&this.configurationRegistry.registerDefaultConfigurations([{overrides:i}])}};_=L([I(0,ri)],_);const ae=P.as(Ge.Workbench);ae.registerWorkbenchContribution(A,B.Restored),ae.registerWorkbenchContribution(T,B.Eventually),Xe(_.ID,_,Ye.BlockRestore);const ui=P.as(N.Configuration);ui.registerConfiguration({...si,properties:{[w]:{type:"array",description:oe("setting description","Configure settings to be applied for all profiles."),default:[],scope:O.APPLICATION,additionalProperties:!0,uniqueItems:!0}}});export{Kt as WorkspaceService};
