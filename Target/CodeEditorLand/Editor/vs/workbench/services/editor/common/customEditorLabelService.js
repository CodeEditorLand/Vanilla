var u=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var g=(l,o,t,e)=>{for(var n=e>1?void 0:e?v(o,t):o,r=l.length-1,i;r>=0;r--)(i=l[r])&&(n=(e?i(o,t,n):i(n))||n);return e&&n&&u(o,t,n),n},h=(l,o)=>(t,e)=>o(t,e,l);import{Emitter as E}from"../../../../base/common/event.js";import{parse as I}from"../../../../base/common/glob.js";import{Disposable as b}from"../../../../base/common/lifecycle.js";import{MRUCache as P}from"../../../../base/common/map.js";import{dirname as x,isAbsolute as N,parse as D}from"../../../../base/common/path.js";import{relativePath as y,dirname as C}from"../../../../base/common/resources.js";import"../../../../base/common/uri.js";import{IConfigurationService as T}from"../../../../platform/configuration/common/configuration.js";import{InstantiationType as S,registerSingleton as _}from"../../../../platform/instantiation/common/extensions.js";import{createDecorator as L}from"../../../../platform/instantiation/common/instantiation.js";import{IWorkspaceContextService as R}from"../../../../platform/workspace/common/workspace.js";let a=class extends b{constructor(t,e){super();this.configurationService=t;this.workspaceContextService=e;this.storeEnablementState(),this.storeCustomPatterns(),this.registerListeners()}_serviceBrand;static SETTING_ID_PATTERNS="workbench.editor.customLabels.patterns";static SETTING_ID_ENABLED="workbench.editor.customLabels.enabled";_onDidChange=this._register(new E);onDidChange=this._onDidChange.event;patterns=[];enabled=!0;cache=new P(1e3);registerListeners(){this._register(this.configurationService.onDidChangeConfiguration(t=>{if(t.affectsConfiguration(a.SETTING_ID_ENABLED)){const e=this.enabled;this.storeEnablementState(),e!==this.enabled&&this.patterns.length>0&&this._onDidChange.fire()}else t.affectsConfiguration(a.SETTING_ID_PATTERNS)&&(this.cache.clear(),this.storeCustomPatterns(),this._onDidChange.fire())}))}storeEnablementState(){this.enabled=this.configurationService.getValue(a.SETTING_ID_ENABLED)}_templateRegexValidation=/[a-zA-Z0-9]/;storeCustomPatterns(){this.patterns=[];const t=this.configurationService.getValue(a.SETTING_ID_PATTERNS);for(const e in t){const n=t[e];if(!this._templateRegexValidation.test(n))continue;const r=N(e),i=I(e);this.patterns.push({pattern:e,template:n,isAbsolutePath:r,parsedPattern:i})}this.patterns.sort((e,n)=>this.patternWeight(n.pattern)-this.patternWeight(e.pattern))}patternWeight(t){let e=0;for(const n of t.split("/"))n==="**"?e+=1:n==="*"?e+=10:n.includes("*")||n.includes("?")?e+=50:n!==""&&(e+=100);return e}getName(t){if(!this.enabled||this.patterns.length===0)return;const e=t.toString(),n=this.cache.get(e);if(n!==void 0)return n??void 0;const r=this.applyPatterns(t);return this.cache.set(e,r??null),r}applyPatterns(t){const e=this.workspaceContextService.getWorkspaceFolder(t);let n;for(const r of this.patterns){let i;if(e&&!r.isAbsolutePath?(n||(n=y(C(e.uri),t)??t.path),i=n):i=t.path,r.parsedPattern(i))return this.applyTemplate(r.template,t,i)}}_parsedTemplateExpression=/\$\{(dirname|filename|extname|extname\((?<extnameN>[-+]?\d+)\)|dirname\((?<dirnameN>[-+]?\d+)\))\}/g;_filenameCaptureExpression=/(?<filename>^\.*[^.]*)/;applyTemplate(t,e,n){let r;return t.replace(this._parsedTemplateExpression,(i,p,...m)=>{r=r??D(e.path);const{dirnameN:f="0",extnameN:c="0"}=m.pop();if(p==="filename"){const{filename:s}=this._filenameCaptureExpression.exec(r.base)?.groups??{};if(s)return s}else if(p==="extname"){const s=this.getExtnames(r.base);if(s)return s}else if(p.startsWith("extname")){const s=parseInt(c),d=this.getNthExtname(r.base,s);if(d)return d}else if(p.startsWith("dirname")){const s=parseInt(f),d=this.getNthDirname(x(n),s);if(d)return d}return i})}removeLeadingDot(t){let e=t;for(;e.startsWith(".");)e=e.slice(1);return e}getNthDirname(t,e){t=t.startsWith("/")?t.slice(1):t;const n=t.split("/");return this.getNthFragment(n,e)}getExtnames(t){return this.removeLeadingDot(t).split(".").slice(1).join(".")}getNthExtname(t,e){const n=this.removeLeadingDot(t).split(".");return n.shift(),this.getNthFragment(n,e)}getNthFragment(t,e){const n=t.length;let r;e<0?r=Math.abs(e)-1:r=n-e-1;const i=t[r];if(!(i===void 0||i===""))return i}};a=g([h(0,T),h(1,R)],a);const A=L("ICustomEditorLabelService");_(A,a,S.Delayed);export{a as CustomEditorLabelService,A as ICustomEditorLabelService};
