var B=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var N=(O,m,e,n)=>{for(var t=n>1?void 0:n?x(m,e):m,o=O.length-1,i;o>=0;o--)(i=O[o])&&(t=(n?i(m,e,t):i(t))||t);return n&&t&&B(m,e,t),t},I=(O,m)=>(e,n)=>m(e,n,O);import{distinct as U,insert as L}from"../../../../base/common/arrays.js";import{PauseableEmitter as W}from"../../../../base/common/event.js";import*as Q from"../../../../base/common/glob.js";import{Disposable as V,DisposableStore as H,toDisposable as Y}from"../../../../base/common/lifecycle.js";import{Schemas as A}from"../../../../base/common/network.js";import{basename as $,extname as S,isEqual as q}from"../../../../base/common/resources.js";import{URI as D}from"../../../../base/common/uri.js";import{localize as h}from"../../../../nls.js";import{IConfigurationService as J}from"../../../../platform/configuration/common/configuration.js";import{EditorActivation as K,EditorResolution as F}from"../../../../platform/editor/common/editor.js";import{InstantiationType as X,registerSingleton as z}from"../../../../platform/instantiation/common/extensions.js";import{IInstantiationService as Z}from"../../../../platform/instantiation/common/instantiation.js";import{ILogService as tt}from"../../../../platform/log/common/log.js";import{INotificationService as et,Severity as it}from"../../../../platform/notification/common/notification.js";import{IQuickInputService as ot}from"../../../../platform/quickinput/common/quickInput.js";import{IStorageService as rt,StorageScope as R,StorageTarget as T}from"../../../../platform/storage/common/storage.js";import{ITelemetryService as nt}from"../../../../platform/telemetry/common/telemetry.js";import{DEFAULT_EDITOR_ASSOCIATION as y,EditorResourceAccessor as b,SideBySideEditor as k,isEditorInputWithOptions as st,isEditorInputWithOptionsAndGroup as _,isResourceDiffEditorInput as M,isResourceMergeEditorInput as dt,isResourceMultiDiffEditorInput as at,isResourceSideBySideEditorInput as j,isUntitledResourceEditorInput as ct}from"../../../common/editor.js";import{SideBySideEditorInput as ut}from"../../../common/editor/sideBySideEditorInput.js";import{IExtensionService as pt}from"../../extensions/common/extensions.js";import{findGroup as ft}from"../common/editorGroupFinder.js";import{IEditorGroupsService as lt}from"../common/editorGroupsService.js";import{IEditorResolverService as gt,RegisteredEditorPriority as E,ResolvedStatus as l,editorsAssociationsSettingId as G,globMatchesResource as C,priorityToRank as v}from"../common/editorResolverService.js";let f=class extends V{constructor(e,n,t,o,i,r,d,u,s){super();this.editorGroupService=e;this.instantiationService=n;this.configurationService=t;this.quickInputService=o;this.notificationService=i;this.telemetryService=r;this.storageService=d;this.extensionService=u;this.logService=s;this.cache=new Set(JSON.parse(this.storageService.get(f.cacheStorageID,R.PROFILE,JSON.stringify([])))),this.storageService.remove(f.cacheStorageID,R.PROFILE),this._register(this.storageService.onWillSaveState(()=>{this.cacheEditors()})),this._register(this.extensionService.onDidRegisterExtensions(()=>{this.cache=void 0}))}_serviceBrand;_onDidChangeEditorRegistrations=this._register(new W);onDidChangeEditorRegistrations=this._onDidChangeEditorRegistrations.event;static configureDefaultID="promptOpenWith.configureDefault";static cacheStorageID="editorOverrideService.cache";static conflictingDefaultsStorageID="editorOverrideService.conflictingDefaults";_editors=new Map;_flattenedEditors=new Map;_shouldReFlattenEditors=!0;cache;resolveUntypedInputAndGroup(e,n){const t=e,o=this.instantiationService.invokeFunction(ft,t,n);if(o instanceof Promise)return o.then(([i,r])=>[t,i,r]);{const[i,r]=o;return[t,i,r]}}async resolveEditor(e,n){if(this._flattenedEditors=this._flattenEditorsMap(),j(e))return this.doResolveSideBySideEditor(e,n);let t;const o=this.resolveUntypedInputAndGroup(e,n);if(o instanceof Promise?t=await o:t=o,!t)return l.NONE;const[i,r,d]=t;d&&(i.options={...i.options,activation:d});let u=b.getCanonicalUri(i,{supportSideBySide:k.PRIMARY});if(this.cache&&u&&this.resourceMatchesCache(u)&&await this.extensionService.whenInstalledExtensionsRegistered(),u===void 0)u=D.from({scheme:A.untitled});else if(u.scheme===void 0||u===null)return l.NONE;if(i.options?.override===F.PICK){const c=await this.doPickEditor(i);if(!c)return l.ABORT;i.options=c}let{editor:s,conflictingDefault:p}=this.getEditor(u,i.options?.override);if(!s&&(i.options?.override||st(e)))return l.NONE;if(!s){const c=this.getEditor(u,y.id);if(s=c?.editor,p=c?.conflictingDefault,!s)return l.NONE}if(M(i)&&i.options?.override===void 0){let c=b.getCanonicalUri(i,{supportSideBySide:k.SECONDARY});c||(c=D.from({scheme:A.untitled}));const{editor:g}=this.getEditor(c,void 0);if(!g||s.editorInfo.id!==g.editorInfo.id){const{editor:P,conflictingDefault:w}=this.getEditor(u,y.id);s=P,p=w}if(!s)return l.NONE}if(i.options={override:s.editorInfo.id,...i.options},s.editorFactoryObject.createDiffEditorInput===void 0&&M(i))return l.NONE;const a=await this.doResolveEditor(i,r,s);return p&&a&&await this.doHandleConflictingDefaults(u,s.editorInfo.label,i,a.editor,r),a?(this.sendEditorResolutionTelemetry(a.editor),a.editor.editorId!==s.editorInfo.id&&this.logService.warn(`Editor ID Mismatch: ${a.editor.editorId} !== ${s.editorInfo.id}. This will cause bugs. Please ensure editorInput.editorId matches the registered id`),{...a,group:r}):l.ABORT}async doResolveSideBySideEditor(e,n){const t=await this.resolveEditor(e.primary,n);if(!_(t))return l.NONE;const o=await this.resolveEditor(e.secondary,t.group??n);return _(o)?{group:t.group??o.group,editor:this.instantiationService.createInstance(ut,e.label,e.description,o.editor,t.editor),options:e.options}:l.NONE}bufferChangeEvents(e){this._onDidChangeEditorRegistrations.pause();try{e()}finally{this._onDidChangeEditorRegistrations.resume()}}registerEditor(e,n,t,o){let i=this._editors.get(e);i===void 0&&(i=new Map,this._editors.set(e,i));let r=i.get(n.id);r===void 0&&(r=[]);const d=L(r,{globPattern:e,editorInfo:n,options:t,editorFactoryObject:o});return i.set(n.id,r),this._shouldReFlattenEditors=!0,this._onDidChangeEditorRegistrations.fire(),Y(()=>{d(),r&&r.length===0&&i?.delete(n.id),this._shouldReFlattenEditors=!0,this._onDidChangeEditorRegistrations.fire()})}getAssociationsForResource(e){let t=this.getAllUserAssociations().filter(i=>i.filenamePattern&&C(i.filenamePattern,e));t=t.sort((i,r)=>(r.filenamePattern?.length??0)-(i.filenamePattern?.length??0));const o=this._registeredEditors;return t.filter(i=>o.find(r=>r.editorInfo.id===i.viewType))}getAllUserAssociations(){const e=this.configurationService.inspect(G)||{},n=e.defaultValue??{},t=e.workspaceValue??{},o=e.userValue??{},i={...t};for(const[d,u]of Object.entries({...n,...o}))i[d]===void 0&&(i[d]=u);const r=[];for(const[d,u]of Object.entries(i)){const s={filenamePattern:d,viewType:u};r.push(s)}return r}_flattenEditorsMap(){if(!this._shouldReFlattenEditors)return this._flattenedEditors;this._shouldReFlattenEditors=!1;const e=new Map;for(const[n,t]of this._editors){const o=[];for(const i of t.values()){let r;for(const d of i)r||(r={editorInfo:d.editorInfo,globPattern:d.globPattern,options:{},editorFactoryObject:{}}),r.options={...r.options,...d.options},r.editorFactoryObject={...r.editorFactoryObject,...d.editorFactoryObject};r&&o.push(r)}e.set(n,o)}return e}get _registeredEditors(){return Array.from(this._flattenedEditors.values()).flat()}updateUserAssociations(e,n){const t={viewType:n,filenamePattern:e},o=this.getAllUserAssociations(),i=Object.create(null);for(const r of[...o,t])r.filenamePattern&&(i[r.filenamePattern]=r.viewType);this.configurationService.updateValue(G,i)}findMatchingEditors(e){const n=this.getAssociationsForResource(e),t=[];for(const[o,i]of this._flattenedEditors)for(const r of i)(n.find(u=>u.viewType===r.editorInfo.id)&&r.editorInfo.priority!==E.exclusive||C(o,e))&&t.push(r);return t.sort((o,i)=>v(i.editorInfo.priority)===v(o.editorInfo.priority)&&typeof i.globPattern=="string"&&typeof o.globPattern=="string"?i.globPattern.length-o.globPattern.length:v(i.editorInfo.priority)-v(o.editorInfo.priority))}getEditors(e){if(this._flattenedEditors=this._flattenEditorsMap(),D.isUri(e)){const n=this.findMatchingEditors(e);return n.find(t=>t.editorInfo.priority===E.exclusive)?[]:n.map(t=>t.editorInfo)}return U(this._registeredEditors.map(n=>n.editorInfo),n=>n.id)}getEditor(e,n){const t=(p,a)=>p.find(c=>c.options&&c.options.canSupportResource!==void 0?c.editorInfo.id===a&&c.options.canSupportResource(e):c.editorInfo.id===a);if(n&&n!==F.EXCLUSIVE_ONLY){const p=this._registeredEditors;return{editor:t(p,n),conflictingDefault:!1}}const o=this.findMatchingEditors(e),i=this.getAssociationsForResource(e),r=n===F.EXCLUSIVE_ONLY?E.exclusive:E.builtin;let d=o.filter(p=>v(p.editorInfo.priority)>=v(r)&&p.editorInfo.id!==y.id);if(d.length===0)return{editor:i[0]&&r!==E.exclusive?t(o,i[0].viewType):void 0,conflictingDefault:!1};const u=d[0].editorInfo.priority===E.exclusive?d[0].editorInfo.id:i[0]?.viewType||d[0].editorInfo.id;let s=!1;return d=d.filter(p=>p.editorInfo.priority!==E.exclusive),i.length===0&&d.length>1&&(s=!0),{editor:t(o,u),conflictingDefault:s}}async doResolveEditor(e,n,t){let o=e.options;const i=b.getCanonicalUri(e,{supportSideBySide:k.PRIMARY});if(o&&typeof o.activation>"u"&&(o={...o,activation:o.preserveFocus?K.RESTORE:void 0}),dt(e)){if(!t.editorFactoryObject.createMergeEditorInput)return;const s=await t.editorFactoryObject.createMergeEditorInput(e,n);return{editor:s.editor,options:s.options??o}}if(M(e)){if(!t.editorFactoryObject.createDiffEditorInput)return;const s=await t.editorFactoryObject.createDiffEditorInput(e,n);return{editor:s.editor,options:s.options??o}}if(at(e)){if(!t.editorFactoryObject.createMultiDiffEditorInput)return;const s=await t.editorFactoryObject.createMultiDiffEditorInput(e,n);return{editor:s.editor,options:s.options??o}}if(j(e))throw new Error("Untyped side by side editor input not supported here.");if(ct(e)){if(!t.editorFactoryObject.createUntitledEditorInput)return;const s=await t.editorFactoryObject.createUntitledEditorInput(e,n);return{editor:s.editor,options:s.options??o}}if(i===void 0)throw new Error("Undefined resource on non untitled editor input.");if(typeof t.options?.singlePerResource=="function"?t.options.singlePerResource():t.options?.singlePerResource){const s=this.findExistingEditorsForResource(i,t.editorInfo.id);if(s.length){const p=await this.moveExistingEditorForResource(s,n);return p?{editor:p,options:o}:void 0}}if(!t.editorFactoryObject.createEditorInput)return;const d=await t.editorFactoryObject.createEditorInput(e,n);return o=d.options??o,{editor:d.editor,options:o}}async moveExistingEditorForResource(e,n){const t=e[0];for(const{editor:o,group:i}of e)if(o!==t.editor&&!await i.closeEditor(o))return;if(!(n.id!==t.group.id&&!t.group.moveEditor(t.editor,n)))return t.editor}findExistingEditorsForResource(e,n){const t=[],o=U([...this.editorGroupService.groups]);for(const i of o)for(const r of i.editors)q(r.resource,e)&&r.editorId===n&&t.push({editor:r,group:i});return t}async doHandleConflictingDefaults(e,n,t,o,i){const r=this.findMatchingEditors(e),d=JSON.parse(this.storageService.get(f.conflictingDefaultsStorageID,R.PROFILE,"{}")),u=`*${S(e)}`,s=()=>{d[u]=[],r.forEach(c=>d[u].push(c.editorInfo.id)),this.storageService.store(f.conflictingDefaultsStorageID,JSON.stringify(d),R.PROFILE,T.MACHINE)};if(d[u]&&d[u].find(c=>c===o.editorId))return;const a=this.notificationService.prompt(it.Warning,h("editorResolver.conflictingDefaults","There are multiple default editors available for the resource."),[{label:h("editorResolver.configureDefault","Configure Default"),run:async()=>{const c=await this.doPickEditor(t,!0);if(!c)return;t.options=c;const g=await this.resolveEditor(t,i);g===l.ABORT||g===l.NONE||i.replaceEditors([{editor:o,replacement:g.editor,options:g.options??c}])}},{label:h("editorResolver.keepDefault","Keep {0}",n),run:s}]).onDidClose(()=>{s(),a.dispose()})}mapEditorsToQuickPickEntry(e,n){const t=this.editorGroupService.activeGroup.findEditors(e).at(0);let o=e.scheme===A.untitled?this._registeredEditors.filter(a=>a.editorInfo.priority!==E.exclusive):this.findMatchingEditors(e);o=U(o,a=>a.editorInfo.id);const i=this.getAssociationsForResource(e)[0]?.viewType;o=o.sort((a,c)=>a.editorInfo.id===y.id?-1:c.editorInfo.id===y.id?1:v(c.editorInfo.priority)-v(a.editorInfo.priority));const r=[],d=h("promptOpenWith.currentlyActive","Active"),u=h("promptOpenWith.currentDefault","Default"),s=h("promptOpenWith.currentDefaultAndActive","Active and Default");let p=i;if(!p&&o.length>2&&o[1]?.editorInfo.priority!==E.option&&(p=o[1]?.editorInfo.id),p||(p=y.id),o.forEach(a=>{const c=t?.editorId??y.id,g=t?a.editorInfo.id===c:!1,P=a.editorInfo.id===p,w={id:a.editorInfo.id,label:a.editorInfo.label,description:g&&P?s:g?d:P?u:void 0,detail:a.editorInfo.detail??a.editorInfo.priority};r.push(w)}),!n&&S(e)!==""){const a={type:"separator"};r.push(a);const c={id:f.configureDefaultID,label:h("promptOpenWith.configureDefault","Configure default editor for '{0}'...",`*${S(e)}`)};r.push(c)}return r}async doPickEditor(e,n){let t=b.getOriginalUri(e,{supportSideBySide:k.PRIMARY});t===void 0&&(t=D.from({scheme:A.untitled}));const o=this.mapEditorsToQuickPickEntry(t,n),i=new H,r=i.add(this.quickInputService.createQuickPick({useSeparators:!0})),d=n?h("promptOpenWith.updateDefaultPlaceHolder","Select new default editor for '{0}'",`*${S(t)}`):h("promptOpenWith.placeHolder","Select editor for '{0}'",$(t));r.placeholder=d,r.canAcceptInBackground=!0,r.items=o;const u=r.items.find(p=>p.type==="item");u&&(r.selectedItems=[u]);const s=await new Promise(p=>{i.add(r.onDidAccept(a=>{let c;r.selectedItems.length===1&&(c={item:r.selectedItems[0],keyMods:r.keyMods,openInBackground:a.inBackground}),t&&n&&c?.item.id&&this.updateUserAssociations(`*${S(t)}`,c.item.id),p(c)})),i.add(r.onDidHide(()=>{i.dispose(),p(void 0)})),i.add(r.onDidTriggerItemButton(a=>{p({item:a.item,openInBackground:!1}),t&&a.item&&a.item.id&&this.updateUserAssociations(`*${S(t)}`,a.item.id)})),r.show()});if(r.dispose(),s)return s.item.id===f.configureDefaultID?this.doPickEditor(e,!0):{...e.options,override:s.item.id,preserveFocus:s.openInBackground||e.options?.preserveFocus}}sendEditorResolutionTelemetry(e){e.editorId&&this.telemetryService.publicLog2("override.viewType",{viewType:e.editorId})}cacheEditors(){const e=new Set;for(const[t,o]of this._flattenedEditors)o.find(r=>r.editorInfo.priority!==E.option&&r.editorInfo.id!==y.id)&&(Q.isRelativePattern(t)?e.add(`${t.pattern}`):e.add(t));const n=this.getAllUserAssociations();for(const t of n)t.filenamePattern&&e.add(t.filenamePattern);this.storageService.store(f.cacheStorageID,JSON.stringify(Array.from(e)),R.PROFILE,T.MACHINE)}resourceMatchesCache(e){if(!this.cache)return!1;for(const n of this.cache)if(C(n,e))return!0;return!1}};f=N([I(0,lt),I(1,Z),I(2,J),I(3,ot),I(4,et),I(5,nt),I(6,rt),I(7,pt),I(8,tt)],f),z(gt,f,X.Eager);export{f as EditorResolverService};
