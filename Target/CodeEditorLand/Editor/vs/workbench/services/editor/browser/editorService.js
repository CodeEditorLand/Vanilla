var B=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var _=(C,E,e,i)=>{for(var t=i>1?void 0:i?q(E,e):E,r=C.length-1,o;r>=0;r--)(o=C[r])&&(t=(i?o(E,e,t):o(t))||t);return i&&t&&B(E,e,t),t},c=(C,E)=>(e,i)=>E(e,i,C);import{IInstantiationService as L}from"../../../../platform/instantiation/common/instantiation.js";import"../../../../platform/editor/common/editor.js";import{SideBySideEditor as v,isEditorInputWithOptions as O,SaveReason as N,EditorsOrder as h,EditorResourceAccessor as G,EditorInputCapabilities as g,isResourceDiffEditorInput as Y,isResourceEditorInput as H,isEditorInput as m,isEditorInputWithOptionsAndGroup as R,isResourceMergeEditorInput as Q}from"../../../common/editor.js";import{EditorInput as j}from"../../../common/editor/editorInput.js";import{SideBySideEditorInput as X}from"../../../common/editor/sideBySideEditorInput.js";import{ResourceMap as z,ResourceSet as x}from"../../../../base/common/map.js";import{IFileService as J,FileOperation as P,FileChangesEvent as K,FileChangeType as Z}from"../../../../platform/files/common/files.js";import{Event as $,Emitter as f}from"../../../../base/common/event.js";import{URI as u}from"../../../../base/common/uri.js";import{joinPath as ee}from"../../../../base/common/resources.js";import{DiffEditorInput as ie}from"../../../common/editor/diffEditorInput.js";import{SideBySideEditor as te}from"../../../browser/parts/editor/sideBySideEditor.js";import{IEditorGroupsService as re,GroupsOrder as D,isEditorReplacement as F}from"../common/editorGroupsService.js";import{IEditorService as oe,isPreferredGroup as ne}from"../common/editorService.js";import{IConfigurationService as se}from"../../../../platform/configuration/common/configuration.js";import{Disposable as de,dispose as A,DisposableStore as ae}from"../../../../base/common/lifecycle.js";import{coalesce as y,distinct as pe}from"../../../../base/common/arrays.js";import{isCodeEditor as U,isDiffEditor as b,isCompositeEditor as ue}from"../../../../editor/browser/editorBrowser.js";import"../../../browser/parts/editor/editor.js";import{registerSingleton as ce}from"../../../../platform/instantiation/common/extensions.js";import{isUndefined as k}from"../../../../base/common/types.js";import{EditorsObserver as Ee}from"../../../browser/parts/editor/editorsObserver.js";import{Promises as w,timeout as le}from"../../../../base/common/async.js";import{IWorkspaceContextService as fe}from"../../../../platform/workspace/common/workspace.js";import{indexOfPath as Ie}from"../../../../base/common/extpath.js";import{IUriIdentityService as ve}from"../../../../platform/uriIdentity/common/uriIdentity.js";import{IEditorResolverService as he,ResolvedStatus as T}from"../common/editorResolverService.js";import{IWorkspaceTrustRequestService as ge,WorkspaceTrustUriResponse as W}from"../../../../platform/workspace/common/workspaceTrust.js";import{IHostService as me}from"../../host/browser/host.js";import{findGroup as M}from"../common/editorGroupFinder.js";import{ITextEditorService as ye}from"../../textfile/common/textEditorService.js";import{SyncDescriptor as Ce}from"../../../../platform/instantiation/common/descriptors.js";let I=class extends de{constructor(e,i,t,r,o,n,s,d,a,p,l){super();this.editorGroupService=i;this.instantiationService=t;this.fileService=r;this.configurationService=o;this.contextService=n;this.uriIdentityService=s;this.editorResolverService=d;this.workspaceTrustRequestService=a;this.hostService=p;this.textEditorService=l;this.editorGroupsContainer=e??i,this.editorsObserver=this._register(this.instantiationService.createInstance(Ee,this.editorGroupsContainer)),this.onConfigurationUpdated(),this.registerListeners()}_onDidActiveEditorChange=this._register(new f);onDidActiveEditorChange=this._onDidActiveEditorChange.event;_onDidVisibleEditorsChange=this._register(new f);onDidVisibleEditorsChange=this._onDidVisibleEditorsChange.event;_onDidEditorsChange=this._register(new f);onDidEditorsChange=this._onDidEditorsChange.event;_onWillOpenEditor=this._register(new f);onWillOpenEditor=this._onWillOpenEditor.event;_onDidCloseEditor=this._register(new f);onDidCloseEditor=this._onDidCloseEditor.event;_onDidOpenEditorFail=this._register(new f);onDidOpenEditorFail=this._onDidOpenEditorFail.event;_onDidMostRecentlyActiveEditorsChange=this._register(new f);onDidMostRecentlyActiveEditorsChange=this._onDidMostRecentlyActiveEditorsChange.event;editorGroupsContainer;createScoped(e,i){return i.add(new I(e==="main"?this.editorGroupService.mainPart:e,this.editorGroupService,this.instantiationService,this.fileService,this.configurationService,this.contextService,this.uriIdentityService,this.editorResolverService,this.workspaceTrustRequestService,this.hostService,this.textEditorService))}registerListeners(){this.editorGroupsContainer===this.editorGroupService.mainPart||this.editorGroupsContainer===this.editorGroupService?this.editorGroupService.whenReady.then(()=>this.onEditorGroupsReady()):this.onEditorGroupsReady(),this._register(this.editorGroupsContainer.onDidChangeActiveGroup(e=>this.handleActiveEditorChange(e))),this._register(this.editorGroupsContainer.onDidAddGroup(e=>this.registerGroupListeners(e))),this._register(this.editorsObserver.onDidMostRecentlyActiveEditorsChange(()=>this._onDidMostRecentlyActiveEditorsChange.fire())),this._register(this.onDidVisibleEditorsChange(()=>this.handleVisibleEditorsChange())),this._register(this.fileService.onDidRunOperation(e=>this.onDidRunFileOperation(e))),this._register(this.fileService.onDidFilesChange(e=>this.onDidFilesChange(e))),this._register(this.configurationService.onDidChangeConfiguration(e=>this.onConfigurationUpdated(e)))}lastActiveEditor=void 0;onEditorGroupsReady(){for(const e of this.editorGroupsContainer.groups)this.registerGroupListeners(e);this.activeEditor&&(this.doHandleActiveEditorChangeEvent(),this._onDidVisibleEditorsChange.fire())}handleActiveEditorChange(e){e===this.editorGroupsContainer.activeGroup&&(!this.lastActiveEditor&&!e.activeEditor||this.doHandleActiveEditorChangeEvent())}doHandleActiveEditorChangeEvent(){const e=this.editorGroupsContainer.activeGroup;this.lastActiveEditor=e.activeEditor??void 0,this._onDidActiveEditorChange.fire()}registerGroupListeners(e){const i=new ae;i.add(e.onDidModelChange(t=>{this._onDidEditorsChange.fire({groupId:e.id,event:t})})),i.add(e.onDidActiveEditorChange(()=>{this.handleActiveEditorChange(e),this._onDidVisibleEditorsChange.fire()})),i.add(e.onWillOpenEditor(t=>{this._onWillOpenEditor.fire(t)})),i.add(e.onDidCloseEditor(t=>{this._onDidCloseEditor.fire(t)})),i.add(e.onDidOpenEditorFail(t=>{this._onDidOpenEditorFail.fire({editor:t,groupId:e.id})})),$.once(e.onWillDispose)(()=>{A(i)})}activeOutOfWorkspaceWatchers=new z;handleVisibleEditorsChange(){const e=new x;for(const i of this.visibleEditors){const t=pe(y([G.getCanonicalUri(i,{supportSideBySide:v.PRIMARY}),G.getCanonicalUri(i,{supportSideBySide:v.SECONDARY})]),r=>r.toString());for(const r of t)this.fileService.hasProvider(r)&&!this.contextService.isInsideWorkspace(r)&&e.add(r)}for(const i of this.activeOutOfWorkspaceWatchers.keys())e.has(i)||(A(this.activeOutOfWorkspaceWatchers.get(i)),this.activeOutOfWorkspaceWatchers.delete(i));for(const i of e.keys())if(!this.activeOutOfWorkspaceWatchers.get(i)){const t=this.fileService.watch(i);this.activeOutOfWorkspaceWatchers.set(i,t)}}async onDidRunFileOperation(e){e.isOperation(P.MOVE)&&this.handleMovedFile(e.resource,e.target.resource),(e.isOperation(P.DELETE)||e.isOperation(P.MOVE))&&this.handleDeletedFile(e.resource,!1,e.target?e.target.resource:void 0)}onDidFilesChange(e){e.gotDeleted()&&this.handleDeletedFile(e,!0)}async handleMovedFile(e,i){for(const t of this.editorGroupsContainer.groups){const r=[];for(const o of t.editors){const n=o.resource;if(!n||!this.uriIdentityService.extUri.isEqualOrParent(n,e))continue;let s;if(this.uriIdentityService.extUri.isEqual(e,n))s=i;else{const p=Ie(n.path,e.path,this.uriIdentityService.extUri.ignorePathCasing(n));s=ee(i,n.path.substr(p+e.path.length+1))}const d=await o.rename(t.id,s);if(!d)return;const a={preserveFocus:!0,pinned:t.isPinned(o),sticky:t.isSticky(o),index:t.getIndexOfEditor(o),inactive:!t.isActive(o)};m(d.editor)?r.push({editor:o,replacement:d.editor,options:{...d.options,...a}}):r.push({editor:o,replacement:{...d.editor,options:{...d.editor.options,...a}}})}r.length&&this.replaceEditors(r,t)}}closeOnFileDelete=!1;onConfigurationUpdated(e){if(e&&!e.affectsConfiguration("workbench.editor.closeOnFileDelete"))return;const i=this.configurationService.getValue();typeof i.workbench?.editor?.closeOnFileDelete=="boolean"?this.closeOnFileDelete=i.workbench.editor.closeOnFileDelete:this.closeOnFileDelete=!1}handleDeletedFile(e,i,t){for(const r of this.getAllNonDirtyEditors({includeUntitled:!1,supportSideBySide:!0}))(async()=>{const o=r.resource;if(o&&(this.closeOnFileDelete||!i)){if(t&&this.uriIdentityService.extUri.isEqualOrParent(o,t))return;let n=!1;if(e instanceof K?n=e.contains(o,Z.DELETED):n=this.uriIdentityService.extUri.isEqualOrParent(o,e),!n)return;let s=!1;i&&this.fileService.hasProvider(o)&&(await le(100),s=await this.fileService.exists(o)),!s&&!r.isDisposed()&&r.dispose()}})()}getAllNonDirtyEditors(e){const i=[];function t(r){r.hasCapability(g.Untitled)&&!e.includeUntitled||r.isDirty()||i.push(r)}for(const r of this.editors)e.supportSideBySide&&r instanceof X?(t(r.primary),t(r.secondary)):t(r);return i}editorsObserver;get activeEditorPane(){return this.editorGroupsContainer.activeGroup?.activeEditorPane}get activeTextEditorControl(){const e=this.activeEditorPane;if(e){const i=e.getControl();if(U(i)||b(i))return i;if(ue(i)&&U(i.activeCodeEditor))return i.activeCodeEditor}}get activeTextEditorLanguageId(){let e;const i=this.activeTextEditorControl;return b(i)?e=i.getModifiedEditor():e=i,e?.getModel()?.getLanguageId()}get count(){return this.editorsObserver.count}get editors(){return this.getEditors(h.SEQUENTIAL).map(({editor:e})=>e)}getEditors(e,i){switch(e){case h.MOST_RECENTLY_ACTIVE:return i?.excludeSticky?this.editorsObserver.editors.filter(({groupId:t,editor:r})=>!this.editorGroupsContainer.getGroup(t)?.isSticky(r)):this.editorsObserver.editors;case h.SEQUENTIAL:{const t=[];for(const r of this.editorGroupsContainer.getGroups(D.GRID_APPEARANCE))t.push(...r.getEditors(h.SEQUENTIAL,i).map(o=>({editor:o,groupId:r.id})));return t}}}get activeEditor(){const e=this.editorGroupsContainer.activeGroup;return e?e.activeEditor??void 0:void 0}get visibleEditorPanes(){return y(this.editorGroupsContainer.groups.map(e=>e.activeEditorPane))}get visibleTextEditorControls(){const e=[];for(const i of this.visibleEditorPanes){const t=[];i instanceof te?(t.push(i.getPrimaryEditorPane()?.getControl()),t.push(i.getSecondaryEditorPane()?.getControl())):t.push(i.getControl());for(const r of t)(U(r)||b(r))&&e.push(r)}return e}get visibleEditors(){return y(this.editorGroupsContainer.groups.map(e=>e.activeEditor))}async openEditor(e,i,t){let r,o=m(e)?i:e.options,n;if(ne(i)&&(t=i),!m(e)){const s=await this.editorResolverService.resolveEditor(e,t);if(s===T.ABORT)return;R(s)&&(r=s.editor,o=s.options,n=s.group)}if(r||(r=m(e)?e:await this.textEditorService.resolveTextEditor(e)),!n){let s;const d=this.instantiationService.invokeFunction(M,{editor:r,options:o},t);d instanceof Promise?[n,s]=await d:[n,s]=d,s&&(o={...o,activation:s})}return n.openEditor(r,o)}async openEditors(e,i,t){if(t?.validateTrust&&!await this.handleWorkspaceTrust(e))return[];const r=new Map;for(const n of e){let s,d;if(!O(n)){const p=await this.editorResolverService.resolveEditor(n,i);if(p===T.ABORT)continue;R(p)&&(s=p,d=p.group)}if(s||(s=O(n)?n:{editor:await this.textEditorService.resolveTextEditor(n),options:n.options}),!d){const p=this.instantiationService.invokeFunction(M,s,i);p instanceof Promise?[d]=await p:[d]=p}let a=r.get(d);a||(a=[],r.set(d,a)),a.push(s)}const o=[];for(const[n,s]of r)o.push(n.openEditors(s));return y(await w.settled(o))}async handleWorkspaceTrust(e){const{resources:i,diffMode:t,mergeMode:r}=this.extractEditorResources(e);switch(await this.workspaceTrustRequestService.requestOpenFilesTrust(i)){case W.Open:return!0;case W.OpenInNewWindow:return await this.hostService.openWindow(i.map(n=>({fileUri:n})),{forceNewWindow:!0,diffMode:t,mergeMode:r}),!1;case W.Cancel:return!1}}extractEditorResources(e){const i=new x;let t=!1,r=!1;for(const o of e)if(O(o)){const n=G.getOriginalUri(o.editor,{supportSideBySide:v.BOTH});u.isUri(n)?i.add(n):n&&(n.primary&&i.add(n.primary),n.secondary&&i.add(n.secondary),t=o.editor instanceof ie)}else Q(o)&&(u.isUri(o.input1)&&i.add(o.input1.resource),u.isUri(o.input2)&&i.add(o.input2.resource),u.isUri(o.base)&&i.add(o.base.resource),u.isUri(o.result)&&i.add(o.result.resource),r=!0),Y(o)?(u.isUri(o.original.resource)&&i.add(o.original.resource),u.isUri(o.modified.resource)&&i.add(o.modified.resource),t=!0):H(o)&&i.add(o.resource);return{resources:Array.from(i.keys()),diffMode:t,mergeMode:r}}isOpened(e){return this.editorsObserver.hasEditor({resource:this.uriIdentityService.asCanonicalUri(e.resource),typeId:e.typeId,editorId:e.editorId})}isVisible(e){for(const i of this.editorGroupsContainer.groups)if(i.activeEditor?.matches(e))return!0;return!1}async closeEditor({editor:e,groupId:i},t){await this.editorGroupsContainer.getGroup(i)?.closeEditor(e,t)}async closeEditors(e,i){const t=new Map;for(const{editor:r,groupId:o}of e){const n=this.editorGroupsContainer.getGroup(o);if(!n)continue;let s=t.get(n);s||(s=[],t.set(n,s)),s.push(r)}for(const[r,o]of t)await r.closeEditors(o,i)}findEditors(e,i,t){const r=u.isUri(e)?e:e.resource,o=u.isUri(e)?void 0:e.typeId;if(i?.supportSideBySide!==v.ANY&&i?.supportSideBySide!==v.SECONDARY&&!this.editorsObserver.hasEditors(r))return u.isUri(e)||k(t)?[]:void 0;if(k(t)){const n=[];for(const s of this.editorGroupsContainer.getGroups(D.MOST_RECENTLY_ACTIVE)){const d=[];if(u.isUri(e))d.push(...this.findEditors(e,i,s));else{const a=this.findEditors(e,i,s);a&&d.push(a)}n.push(...d.map(a=>({editor:a,groupId:s.id})))}return n}else{const n=typeof t=="number"?this.editorGroupsContainer.getGroup(t):t;if(u.isUri(e))return n?n.findEditors(r,i):[];{if(!n)return;const s=n.findEditors(r,i);for(const d of s)if(d.typeId===o)return d;return}}}async replaceEditors(e,i){const t=typeof i=="number"?this.editorGroupsContainer.getGroup(i):i,r=[];for(const o of e){let n;if(!m(o.replacement)){const s=await this.editorResolverService.resolveEditor(o.replacement,t);if(s===T.ABORT)continue;R(s)&&(n={editor:o.editor,replacement:s.editor,options:s.options,forceReplaceDirty:o.forceReplaceDirty})}n||(n={editor:o.editor,replacement:F(o)?o.replacement:await this.textEditorService.resolveTextEditor(o.replacement),options:F(o)?o.options:o.replacement.options,forceReplaceDirty:o.forceReplaceDirty}),r.push(n)}return t?.replaceEditors(r)}async save(e,i){Array.isArray(e)||(e=[e]);const t=this.getUniqueEditors(e),r=[],o=[];if(i?.saveAs)o.push(...t);else for(const{groupId:s,editor:d}of t)d.hasCapability(g.Untitled)?o.push({groupId:s,editor:d}):r.push({groupId:s,editor:d});const n=await w.settled(r.map(({groupId:s,editor:d})=>(i?.reason===N.EXPLICIT&&this.editorGroupsContainer.getGroup(s)?.pinEditor(d),d.save(s,i))));for(const{groupId:s,editor:d}of o){if(d.isDisposed())continue;const p={pinned:!0,viewState:(await this.openEditor(d,s))?.getViewState()},l=i?.saveAs?await d.saveAs(s,i):await d.save(s,i);if(n.push(l),!l)break;if(!d.matches(l)){const V=d.hasCapability(g.Untitled)?this.editorGroupsContainer.groups.map(S=>S.id):[s];for(const S of V)l instanceof j?await this.replaceEditors([{editor:d,replacement:l,options:p}],S):await this.replaceEditors([{editor:d,replacement:{...l,options:p}}],S)}}return{success:n.every(s=>!!s),editors:y(n)}}saveAll(e){return this.save(this.getAllModifiedEditors(e),e)}async revert(e,i){Array.isArray(e)||(e=[e]);const t=this.getUniqueEditors(e);return await w.settled(t.map(async({groupId:r,editor:o})=>(this.editorGroupsContainer.getGroup(r)?.pinEditor(o),o.revert(r,i)))),!t.some(({editor:r})=>r.isDirty())}async revertAll(e){return this.revert(this.getAllModifiedEditors(e),e)}getAllModifiedEditors(e){const i=[];for(const t of this.editorGroupsContainer.getGroups(D.MOST_RECENTLY_ACTIVE))for(const r of t.getEditors(h.MOST_RECENTLY_ACTIVE))r.isModified()&&((typeof e?.includeUntitled=="boolean"||!e?.includeUntitled?.includeScratchpad)&&r.hasCapability(g.Scratchpad)||!e?.includeUntitled&&r.hasCapability(g.Untitled)||e?.excludeSticky&&t.isSticky(r)||i.push({groupId:t.id,editor:r}));return i}getUniqueEditors(e){const i=[];for(const{editor:t,groupId:r}of e)i.some(o=>o.editor.matches(t))||i.push({editor:t,groupId:r});return i}dispose(){super.dispose(),this.activeOutOfWorkspaceWatchers.forEach(e=>A(e)),this.activeOutOfWorkspaceWatchers.clear()}};I=_([c(1,re),c(2,L),c(3,J),c(4,se),c(5,fe),c(6,ve),c(7,he),c(8,ge),c(9,me),c(10,ye)],I),ce(oe,new Ce(I,[void 0],!1));export{I as EditorService};
