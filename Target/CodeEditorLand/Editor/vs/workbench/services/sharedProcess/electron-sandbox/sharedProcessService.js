var P=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var c=(t,o,e,r)=>{for(var n=r>1?void 0:r?p(o,e):o,s=t.length-1,a;s>=0;s--)(a=t[s])&&(n=(r?a(o,e,n):a(n))||n);return r&&n&&P(o,e,n),n},d=(t,o)=>(e,r)=>o(e,r,t);import{Barrier as w,timeout as S}from"../../../../base/common/async.js";import{Disposable as g}from"../../../../base/common/lifecycle.js";import{mark as h}from"../../../../base/common/performance.js";import{getDelayedChannel as v}from"../../../../base/parts/ipc/common/ipc.js";import{Client as f}from"../../../../base/parts/ipc/common/ipc.mp.js";import{acquirePort as l}from"../../../../base/parts/ipc/electron-sandbox/ipc.mp.js";import"../../../../platform/ipc/electron-sandbox/services.js";import{ILogService as u}from"../../../../platform/log/common/log.js";import{SharedProcessChannelConnection as m,SharedProcessRawConnection as C}from"../../../../platform/sharedProcess/common/sharedProcess.js";let i=class extends g{constructor(e,r){super();this.windowId=e;this.logService=r;this.withSharedProcessConnection=this.connect()}withSharedProcessConnection;restoredBarrier=new w;async connect(){this.logService.trace("Renderer->SharedProcess#connect"),await Promise.race([this.restoredBarrier.wait(),S(2e3)]),h("code/willConnectSharedProcess"),this.logService.trace("Renderer->SharedProcess#connect: before acquirePort");const e=await l(m.request,m.response);return h("code/didConnectSharedProcess"),this.logService.trace("Renderer->SharedProcess#connect: connection established"),this._register(new f(e,`window:${this.windowId}`))}notifyRestored(){this.restoredBarrier.isOpen()||this.restoredBarrier.open()}getChannel(e){return v(this.withSharedProcessConnection.then(r=>r.getChannel(e)))}registerChannel(e,r){this.withSharedProcessConnection.then(n=>n.registerChannel(e,r))}async createRawConnection(){await this.withSharedProcessConnection,this.logService.trace("Renderer->SharedProcess#createRawConnection: before acquirePort");const e=await l(C.request,C.response);return this.logService.trace("Renderer->SharedProcess#createRawConnection: connection established"),e}};i=c([d(1,u)],i);export{i as SharedProcessService};
