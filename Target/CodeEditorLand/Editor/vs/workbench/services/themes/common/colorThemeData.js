import{basename as $}from"../../../../base/common/path.js";import*as _ from"../../../../base/common/json.js";import{Color as k}from"../../../../base/common/color.js";import{ExtensionData as H,VS_LIGHT_THEME as Y,VS_HC_THEME as q,THEME_SCOPE_CLOSE_PAREN as X,THEME_SCOPE_OPEN_PAREN as Z,themeScopeRegex as Q,THEME_SCOPE_WILDCARD as E,VS_HC_LIGHT_THEME as ee}from"./workbenchThemeService.js";import{convertSettings as O}from"./themeCompatibility.js";import*as C from"../../../../nls.js";import*as S from"../../../../base/common/types.js";import*as M from"../../../../base/common/resources.js";import{Extensions as te,editorBackground as w,editorForeground as z,DEFAULT_COLOR_CONFIG_VALUE as D}from"../../../../platform/theme/common/colorRegistry.js";import{getThemeTypeSelector as oe}from"../../../../platform/theme/common/themeService.js";import{Registry as ne}from"../../../../platform/registry/common/platform.js";import{getParseErrorMessage as ie}from"../../../../base/common/jsonErrorMessages.js";import"../../../../base/common/uri.js";import{parse as re}from"./plistParser.js";import{TokenStyle as P,SemanticTokenRule as L,getTokenClassificationRegistry as se,parseClassifierString as j}from"../../../../platform/theme/common/tokenClassificationRegistry.js";import{createMatchers as F}from"./textMateScopeMatcher.js";import"../../../../platform/extensionResourceLoader/common/extensionResourceLoader.js";import{CharCode as g}from"../../../../base/common/charCode.js";import{StorageScope as U,StorageTarget as ae}from"../../../../platform/storage/common/storage.js";import"./themeConfiguration.js";import{ColorScheme as v}from"../../../../platform/theme/common/theme.js";import{FontStyle as y,MetadataConsts as p}from"../../../../editor/common/encodedTokenAttributes.js";import{toStandardTokenType as le}from"../../../../editor/common/languages/supports/tokenization.js";import{findMatchingThemeRule as ce}from"../../textMate/common/TMHelper.js";const ue=ne.as(te.ColorContribution),A=se(),G={comments:["comment","punctuation.definition.comment"],strings:["string","meta.embedded.assembly"],keywords:["keyword - keyword.operator","keyword.control","storage","storage.type"],numbers:["constant.numeric"],types:["entity.name.type","entity.name.class","support.type","support.class"],functions:["entity.name.function","support.function"],variables:["variable","entity.name.variable"]};class b{static STORAGE_KEY="colorThemeData";id;label;settingsId;description;isLoaded;location;watch;extensionData;themeSemanticHighlighting;customSemanticHighlighting;customSemanticHighlightingDeprecated;themeTokenColors=[];customTokenColors=[];colorMap={};customColorMap={};semanticTokenRules=[];customSemanticTokenRules=[];themeTokenScopeMatchers;customTokenScopeMatchers;textMateThemingRules=void 0;tokenColorIndex=void 0;constructor(e,t,o){this.id=e,this.label=t,this.settingsId=o,this.isLoaded=!1}get semanticHighlighting(){return this.customSemanticHighlighting!==void 0?this.customSemanticHighlighting:this.customSemanticHighlightingDeprecated!==void 0?this.customSemanticHighlightingDeprecated:!!this.themeSemanticHighlighting}get tokenColors(){if(!this.textMateThemingRules){let a=function(s){s.scope&&s.settings&&(s.scope==="token.info-token"&&(i=!0),t.push({scope:s.scope,settings:{foreground:I(s.settings.foreground),background:I(s.settings.background),fontStyle:s.settings.fontStyle}}))};var e=a;const t=[],o=this.getColor(z)||this.getDefault(z),n=this.getColor(w)||this.getDefault(w);t.push({settings:{foreground:I(o),background:I(n)}});let i=!1;this.themeTokenColors.forEach(a),this.customTokenColors.forEach(a),i||de[this.type].forEach(a),this.textMateThemingRules=t}return this.textMateThemingRules}getColor(e,t){const o=this.customColorMap[e];if(o instanceof k)return o;if(o===void 0){const n=this.colorMap[e];if(n!==void 0)return n}if(t!==!1)return this.getDefault(e)}getTokenStyle(e,t,o,n=!0,i={}){const a={foreground:void 0,bold:void 0,underline:void 0,strikethrough:void 0,italic:void 0},s={foreground:-1,bold:-1,underline:-1,strikethrough:-1,italic:-1};function l(u,f,h){f.foreground&&s.foreground<=u&&(s.foreground=u,a.foreground=f.foreground,i.foreground=h);for(const T of["bold","underline","strikethrough","italic"]){const m=T,R=f[m];R!==void 0&&s[m]<=u&&(s[m]=u,a[m]=R,i[m]=h)}}function c(u){const f=u.selector.match(e,t,o);f>=0&&l(f,u.style,u)}this.semanticTokenRules.forEach(c),this.customSemanticTokenRules.forEach(c);let d=!1;for(const u in s){const f=u;s[f]===-1?d=!0:s[f]=Number.MAX_VALUE}if(d)for(const u of A.getTokenStylingDefaultRules()){const f=u.selector.match(e,t,o);if(f>=0){let h;if(u.defaults.scopesToProbe&&(h=this.resolveScopes(u.defaults.scopesToProbe),h&&l(f,h,u.defaults.scopesToProbe)),!h&&n!==!1){const T=u.defaults[this.type];h=this.resolveTokenStyleValue(T),h&&l(f,h,T)}}}return P.fromData(a)}resolveTokenStyleValue(e){if(e!==void 0){if(typeof e=="string"){const{type:t,modifiers:o,language:n}=j(e,"");return this.getTokenStyle(t,o,n)}else if(typeof e=="object")return e}}getTokenColorIndex(){if(!this.tokenColorIndex){const e=new me;this.tokenColors.forEach(t=>{e.add(t.settings.foreground),e.add(t.settings.background)}),this.semanticTokenRules.forEach(t=>e.add(t.style.foreground)),A.getTokenStylingDefaultRules().forEach(t=>{const o=t.defaults[this.type];o&&typeof o=="object"&&e.add(o.foreground)}),this.customSemanticTokenRules.forEach(t=>e.add(t.style.foreground)),this.tokenColorIndex=e}return this.tokenColorIndex}get tokenColorMap(){return this.getTokenColorIndex().asArray()}getTokenStyleMetadata(e,t,o,n=!0,i={}){const{type:a,language:s}=j(e,o),l=this.getTokenStyle(a,t,s,n,i);if(l)return{foreground:this.getTokenColorIndex().get(l.foreground),bold:l.bold,underline:l.underline,strikethrough:l.strikethrough,italic:l.italic}}getTokenStylingRuleScope(e){if(this.customSemanticTokenRules.indexOf(e)!==-1)return"setting";if(this.semanticTokenRules.indexOf(e)!==-1)return"theme"}getDefault(e){return ue.resolveDefaultColor(e,this)}resolveScopes(e,t){this.themeTokenScopeMatchers||(this.themeTokenScopeMatchers=this.themeTokenColors.map(J)),this.customTokenScopeMatchers||(this.customTokenScopeMatchers=this.customTokenColors.map(J));for(const n of e){let u=function(f,h){for(let T=0;T<f.length;T++){const m=f[T](n);if(m>=0){const R=h[T],x=h[T].settings;m>=s&&x.foreground&&(i=x.foreground,s=m,d=R),m>=l&&S.isString(x.fontStyle)&&(a=x.fontStyle,l=m,c=R)}}};var o=u;let i,a,s=-1,l=-1,c,d;if(u(this.themeTokenScopeMatchers,this.themeTokenColors),u(this.customTokenScopeMatchers,this.customTokenColors),i!==void 0||a!==void 0)return t&&(t.foreground=d,t.bold=t.italic=t.underline=t.strikethrough=c,t.scope=n),P.fromSettings(i,a)}}defines(e){const t=this.customColorMap[e];return t instanceof k?!0:t===void 0&&this.colorMap.hasOwnProperty(e)}setCustomizations(e){this.setCustomColors(e.colorCustomizations),this.setCustomTokenColors(e.tokenColorCustomizations),this.setCustomSemanticTokenColors(e.semanticTokenColorCustomizations)}setCustomColors(e){this.customColorMap={},this.overwriteCustomColors(e);const t=this.getThemeSpecificColors(e);S.isObject(t)&&this.overwriteCustomColors(t),this.tokenColorIndex=void 0,this.textMateThemingRules=void 0,this.customTokenScopeMatchers=void 0}overwriteCustomColors(e){for(const t in e){const o=e[t];o===D?this.customColorMap[t]=D:typeof o=="string"&&(this.customColorMap[t]=k.fromHex(o))}}setCustomTokenColors(e){this.customTokenColors=[],this.customSemanticHighlightingDeprecated=void 0,this.addCustomTokenColors(e);const t=this.getThemeSpecificColors(e);S.isObject(t)&&this.addCustomTokenColors(t),this.tokenColorIndex=void 0,this.textMateThemingRules=void 0,this.customTokenScopeMatchers=void 0}setCustomSemanticTokenColors(e){if(this.customSemanticTokenRules=[],this.customSemanticHighlighting=void 0,e){this.customSemanticHighlighting=e.enabled,e.rules&&this.readSemanticTokenRules(e.rules);const t=this.getThemeSpecificColors(e);S.isObject(t)&&(t.enabled!==void 0&&(this.customSemanticHighlighting=t.enabled),t.rules&&this.readSemanticTokenRules(t.rules))}this.tokenColorIndex=void 0,this.textMateThemingRules=void 0}isThemeScope(e){return e.charAt(0)===Z&&e.charAt(e.length-1)===X}isThemeScopeMatch(e){const t=e.charAt(0),o=e.charAt(e.length-1),n=e.slice(0,-1),i=e.slice(1,-1),a=e.slice(1);return e===this.settingsId||this.settingsId.includes(i)&&t===E&&o===E||this.settingsId.startsWith(n)&&o===E||this.settingsId.endsWith(a)&&t===E}getThemeSpecificColors(e){let t;for(const o in e){const n=e[o];if(this.isThemeScope(o)&&n instanceof Object&&!Array.isArray(n)){const i=o.match(Q)||[];for(const a of i){const s=a.substring(1,a.length-1);if(this.isThemeScopeMatch(s)){t||(t={});const l=n;for(const c in l){const d=t[c],u=l[c];Array.isArray(d)&&Array.isArray(u)?t[c]=d.concat(u):u&&(t[c]=u)}}}}}return t}readSemanticTokenRules(e){for(const t in e)if(!this.isThemeScope(t))try{const o=W(t,e[t]);o&&this.customSemanticTokenRules.push(o)}catch{}}addCustomTokenColors(e){for(const t in G){const o=t,n=e[o];if(n){const i=typeof n=="string"?{foreground:n}:n,a=G[o];for(const s of a)this.customTokenColors.push({scope:s,settings:i})}}if(Array.isArray(e.textMateRules))for(const t of e.textMateRules)t.scope&&t.settings&&this.customTokenColors.push(t);e.semanticHighlighting!==void 0&&(this.customSemanticHighlightingDeprecated=e.semanticHighlighting)}ensureLoaded(e){return this.isLoaded?Promise.resolve(void 0):this.load(e)}reload(e){return this.load(e)}load(e){if(!this.location)return Promise.resolve(void 0);this.themeTokenColors=[],this.clearCaches();const t={colors:{},textMateRules:[],semanticTokenRules:[],semanticHighlighting:!1};return N(e,this.location,t).then(o=>{this.isLoaded=!0,this.semanticTokenRules=t.semanticTokenRules,this.colorMap=t.colors,this.themeTokenColors=t.textMateRules,this.themeSemanticHighlighting=t.semanticHighlighting})}clearCaches(){this.tokenColorIndex=void 0,this.textMateThemingRules=void 0,this.themeTokenScopeMatchers=void 0,this.customTokenScopeMatchers=void 0}toStorage(e){const t={};for(const n in this.colorMap)t[n]=k.Format.CSS.formatHexA(this.colorMap[n],!0);const o=JSON.stringify({id:this.id,label:this.label,settingsId:this.settingsId,themeTokenColors:this.themeTokenColors.map(n=>({settings:n.settings,scope:n.scope})),semanticTokenRules:this.semanticTokenRules.map(L.toJSONObject),extensionData:H.toJSONObject(this.extensionData),themeSemanticHighlighting:this.themeSemanticHighlighting,colorMap:t,watch:this.watch});e.store(b.STORAGE_KEY,o,U.PROFILE,ae.USER)}get baseTheme(){return this.classNames[0]}get classNames(){return this.id.split(" ")}get type(){switch(this.baseTheme){case Y:return v.LIGHT;case q:return v.HIGH_CONTRAST_DARK;case ee:return v.HIGH_CONTRAST_LIGHT;default:return v.DARK}}static createUnloadedThemeForThemeType(e,t){return b.createUnloadedTheme(oe(e),t)}static createUnloadedTheme(e,t){const o=new b(e,"","__"+e);if(o.isLoaded=!1,o.themeTokenColors=[],o.watch=!1,t)for(const n in t)o.colorMap[n]=k.fromHex(t[n]);return o}static createLoadedEmptyTheme(e,t){const o=new b(e,"",t);return o.isLoaded=!0,o.themeTokenColors=[],o.watch=!1,o}static fromStorageData(e){const t=e.get(b.STORAGE_KEY,U.PROFILE);if(t)try{const o=JSON.parse(t),n=new b("","","");for(const i in o)switch(i){case"colorMap":{const a=o[i];for(const s in a)n.colorMap[s]=k.fromHex(a[s]);break}case"themeTokenColors":case"id":case"label":case"settingsId":case"watch":case"themeSemanticHighlighting":n[i]=o[i];break;case"semanticTokenRules":{const a=o[i];if(Array.isArray(a))for(const s of a){const l=L.fromJSONObject(A,s);l&&n.semanticTokenRules.push(l)}break}case"location":break;case"extensionData":n.extensionData=H.fromJSONObject(o.extensionData);break}return!n.id||!n.settingsId?void 0:n}catch{return}}static fromExtensionTheme(e,t,o){const n=e.uiTheme||"vs-dark",i=fe(o.extensionId,e.path),a=`${n} ${i}`,s=e.label||$(e.path),l=e.id||s,c=new b(a,s,l);return c.description=e.description,c.watch=e._watch===!0,c.location=t,c.extensionData=o,c.isLoaded=!1,c}}function fe(r,e){e.startsWith("./")&&(e=e.substr(2));let t=`${r}-${e}`;return t=t.replace(/[^_a-zA-Z0-9-]/g,"-"),t.charAt(0).match(/[0-9-]/)&&(t="_"+t),t}async function N(r,e,t){if(M.extname(e)===".json"){const o=await r.readExtensionResource(e),n=[],i=_.parse(o,n);if(n.length>0)return Promise.reject(new Error(C.localize("error.cannotparsejson","Problems parsing JSON theme file: {0}",n.map(c=>ie(c.error)).join(", "))));if(_.getNodeType(i)!=="object")return Promise.reject(new Error(C.localize("error.invalidformat","Invalid format for JSON theme file: Object expected.")));if(i.include&&await N(r,M.joinPath(M.dirname(e),i.include),t),Array.isArray(i.settings))return O(i.settings,t),null;t.semanticHighlighting=t.semanticHighlighting||i.semanticHighlighting;const a=i.colors;if(a){if(typeof a!="object")return Promise.reject(new Error(C.localize({key:"error.invalidformat.colors",comment:["{0} will be replaced by a path. Values in quotes should not be translated."]},"Problem parsing color theme file: {0}. Property 'colors' is not of type 'object'.",e.toString())));for(const c in a){const d=a[c];d===D?delete t.colors[c]:typeof d=="string"&&(t.colors[c]=k.fromHex(a[c]))}}const s=i.tokenColors;if(s)if(Array.isArray(s))t.textMateRules.push(...s);else if(typeof s=="string")await K(r,M.joinPath(M.dirname(e),s),t);else return Promise.reject(new Error(C.localize({key:"error.invalidformat.tokenColors",comment:["{0} will be replaced by a path. Values in quotes should not be translated."]},"Problem parsing color theme file: {0}. Property 'tokenColors' should be either an array specifying colors or a path to a TextMate theme file",e.toString())));const l=i.semanticTokenColors;if(l&&typeof l=="object")for(const c in l)try{const d=W(c,l[c]);d&&t.semanticTokenRules.push(d)}catch{return Promise.reject(new Error(C.localize({key:"error.invalidformat.semanticTokenColors",comment:["{0} will be replaced by a path. Values in quotes should not be translated."]},"Problem parsing color theme file: {0}. Property 'semanticTokenColors' contains a invalid selector",e.toString())))}}else return K(r,e,t)}function K(r,e,t){return r.readExtensionResource(e).then(o=>{try{const i=re(o).settings;return Array.isArray(i)?(O(i,t),Promise.resolve(null)):Promise.reject(new Error(C.localize("error.plist.invalidformat","Problem parsing tmTheme file: {0}. 'settings' is not array.")))}catch(n){return Promise.reject(new Error(C.localize("error.cannotparse","Problems parsing tmTheme file: {0}",n.message)))}},o=>Promise.reject(new Error(C.localize("error.cannotload","Problems loading tmTheme file {0}: {1}",e.toString(),o.message))))}const de={light:[{scope:"token.info-token",settings:{foreground:"#316bcd"}},{scope:"token.warn-token",settings:{foreground:"#cd9731"}},{scope:"token.error-token",settings:{foreground:"#cd3131"}},{scope:"token.debug-token",settings:{foreground:"#800080"}}],dark:[{scope:"token.info-token",settings:{foreground:"#6796e6"}},{scope:"token.warn-token",settings:{foreground:"#cd9731"}},{scope:"token.error-token",settings:{foreground:"#f44747"}},{scope:"token.debug-token",settings:{foreground:"#b267e6"}}],hcLight:[{scope:"token.info-token",settings:{foreground:"#316bcd"}},{scope:"token.warn-token",settings:{foreground:"#cd9731"}},{scope:"token.error-token",settings:{foreground:"#cd3131"}},{scope:"token.debug-token",settings:{foreground:"#800080"}}],hcDark:[{scope:"token.info-token",settings:{foreground:"#6796e6"}},{scope:"token.warn-token",settings:{foreground:"#008000"}},{scope:"token.error-token",settings:{foreground:"#FF0000"}},{scope:"token.debug-token",settings:{foreground:"#b267e6"}}]},V=r=>-1;function B(r,e){function t(i,a){for(let s=a-1;s>=0;s--)if(he(i,r[s]))return s;return-1}if(e.length<r.length)return-1;let o=e.length-1,n=t(e[o--],r.length);if(n>=0){const i=(n+1)*65536+r[n].length;for(;o>=0;)if(n=t(e[o--],n),n===-1)return-1;return i}return-1}function he(r,e){if(!r)return!1;if(r===e)return!0;const t=e.length;return r.length>t&&r.substr(0,t)===e&&r[t]==="."}function J(r){const e=r.scope;if(!e||!r.settings)return V;const t=[];if(Array.isArray(e))for(const o of e)F(o,B,t);else F(e,B,t);return t.length===0?V:o=>{let n=t[0].matcher(o);for(let i=1;i<t.length;i++)n=Math.max(n,t[i].matcher(o));return n}}function W(r,e){const t=A.parseTokenSelector(r);let o;if(typeof e=="string"?o=P.fromSettings(e,void 0):ge(e)&&(o=P.fromSettings(e.foreground,e.fontStyle,e.bold,e.underline,e.strikethrough,e.italic)),o)return{selector:t,style:o}}function ge(r){return r&&(S.isString(r.foreground)||S.isString(r.fontStyle)||S.isBoolean(r.italic)||S.isBoolean(r.underline)||S.isBoolean(r.strikethrough)||S.isBoolean(r.bold))}function st(r,e,t){let o=0;o|=t<<p.LANGUAGEID_OFFSET;const n=ce(r,e);let i;if(n||(i=r.resolveScopes(e.map(l=>[l]).reverse())),!n&&!i)return o;const a=le(e[e.length-1]);if(o|=a<<p.TOKEN_TYPE_OFFSET,n?.settings.fontStyle==="italic")o|=y.Italic|p.ITALIC_MASK;else if(n?.settings.fontStyle!=="bold")o|=y.Bold|p.BOLD_MASK;else if(typeof i?.underline<"u")o|=y.Underline|p.UNDERLINE_MASK;else if(typeof i?.strikethrough<"u")o|=y.Strikethrough|p.STRIKETHROUGH_MASK;else{if(typeof i?.italic<"u"){const l=i?.italic?y.Italic:0;o|=l|p.ITALIC_MASK}if(typeof i?.bold<"u"){const l=i?.bold?y.Bold:0;o|=l|p.BOLD_MASK}if(typeof i?.underline<"u"){const l=i?.underline?y.Underline:0;o|=l|p.UNDERLINE_MASK}if(typeof i?.strikethrough<"u"){const l=i?.strikethrough?y.Strikethrough:0;o|=l|p.STRIKETHROUGH_MASK}}const s=n?n.settings.foreground:i?.foreground;if(s){const c=r.getTokenColorIndex().get(s)<<p.FOREGROUND_OFFSET;o|=c}return o}class me{_lastColorId;_id2color;_color2id;constructor(){this._lastColorId=0,this._id2color=[],this._color2id=Object.create(null)}add(e){if(e=I(e),e===void 0)return 0;let t=this._color2id[e];return t||(t=++this._lastColorId,this._color2id[e]=t,this._id2color[t]=e,t)}get(e){if(e=I(e),e===void 0)return 0;const t=this._color2id[e];return t||0}asArray(){return this._id2color.slice(0)}}function I(r){if(!r)return;typeof r!="string"&&(r=k.Format.CSS.formatHexA(r,!0));const e=r.length;if(r.charCodeAt(0)!==g.Hash||e!==4&&e!==5&&e!==7&&e!==9)return;const t=[g.Hash];for(let o=1;o<e;o++){const n=pe(r.charCodeAt(o));if(!n)return;t.push(n),(e===4||e===5)&&t.push(n)}return t.length===9&&t[7]===g.F&&t[8]===g.F&&(t.length=7),String.fromCharCode(...t)}function pe(r){return r>=g.Digit0&&r<=g.Digit9||r>=g.A&&r<=g.F?r:r>=g.a&&r<=g.f?r-g.a+g.A:0}export{b as ColorThemeData,st as findMetadata};
