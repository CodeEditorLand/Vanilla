import{isThenable as I}from"../../../../base/common/async.js";import{CancellationTokenSource as y}from"../../../../base/common/cancellation.js";import{toErrorMessage as P}from"../../../../base/common/errorMessage.js";import{Schemas as g}from"../../../../base/common/network.js";import*as R from"../../../../base/common/path.js";import*as x from"../../../../base/common/resources.js";import{TernarySearchTree as b}from"../../../../base/common/ternarySearchTree.js";import{URI as F}from"../../../../base/common/uri.js";import{DEFAULT_MAX_SEARCH_RESULTS as C,hasSiblingPromiseFn as w,excludeToGlobPattern as M,QueryGlobTester as N,QueryType as _,resolvePatternsForProvider as S,DEFAULT_TEXT_SEARCH_PREVIEW_OPTIONS as E}from"./search.js";import{TextSearchMatchNew as p}from"./searchExtTypes.js";class ue{constructor(e,t,a){this.queryProviderPair=e;this.fileUtils=t;this.processType=a}collector=null;isLimitHit=!1;resultCount=0;get query(){return this.queryProviderPair.query}search(e,t){const a=this.query.folderQueries||[],o=new y(t);return new Promise((c,l)=>{this.collector=new Q(e);let T=!1;const h=(r,i)=>{if(!T&&!this.isLimitHit){const n=this.resultSize(r);r instanceof p&&typeof this.query.maxResults=="number"&&this.resultCount+n>this.query.maxResults&&(this.isLimitHit=!0,T=!0,o.cancel(),r=this.trimResultToSize(r,this.query.maxResults-this.resultCount));const u=this.resultSize(r);this.resultCount+=u;const d=r instanceof p;(u>0||!d)&&this.collector.add(r,i)}};this.doSearch(a,h,o.token).then(r=>{o.dispose(),this.collector.flush(),c({limitHit:this.isLimitHit||r?.limitHit,messages:this.getMessagesFromResults(r),stats:{type:this.processType}})},r=>{o.dispose();const i=P(r);l(new Error(i))})})}getMessagesFromResults(e){return e?.message?Array.isArray(e.message)?e.message:[e.message]:[]}resultSize(e){return e instanceof p?Array.isArray(e.ranges)?e.ranges.length:1:0}trimResultToSize(e,t){return new p(e.uri,e.ranges.slice(0,t),e.previewText)}async doSearch(e,t,a){const o=b.forUris(()=>!0);e.forEach((i,n)=>{const u=new N(this.query,i);o.set(i.folder,{queryTester:u,folder:i.folder,folderIdx:n})});const c=[],l={report:i=>{if(i.uri===void 0)throw Error("Text search result URI is undefined. Please check provider implementation.");const n=o.findSubstr(i.uri),u=n.folder.scheme===g.file?w(()=>this.fileUtils.readdir(x.dirname(i.uri))):void 0,d=x.relativePath(n.folder,i.uri);if(d){const f=n.queryTester.includedInQuery(d,R.basename(d),u);I(f)?c.push(f.then(v=>{v&&t(i,n.folderIdx)})):f&&t(i,n.folderIdx)}}},h={folderOptions:e.map(i=>this.getSearchOptionsForFolder(i)),maxFileSize:this.query.maxFileSize,maxResults:this.query.maxResults??C,previewOptions:this.query.previewOptions??E,surroundingContext:this.query.surroundingContext??0};"usePCRE2"in this.query&&(h.usePCRE2=this.query.usePCRE2);let r;return this.queryProviderPair.query.type===_.aiText?r=await this.queryProviderPair.provider.provideAITextSearchResults(this.queryProviderPair.query.contentPattern,h,l,a):r=await this.queryProviderPair.provider.provideTextSearchResults(U(this.queryProviderPair.query.contentPattern),h,l,a),c.length&&await Promise.all(c),r}getSearchOptionsForFolder(e){const t=S(this.query.includePattern,e.includePattern);let a=e.excludePattern?.map(l=>({folder:l.folder,patterns:S(this.query.excludePattern,l.pattern)}));(!a||a.length===0)&&(a=[{folder:void 0,patterns:S(this.query.excludePattern,void 0)}]);const o=M(a);return{folder:F.from(e.folder),excludes:o,includes:t,useIgnoreFiles:{local:!e.disregardIgnoreFiles,parent:!e.disregardParentIgnoreFiles,global:!e.disregardGlobalIgnoreFiles},followSymlinks:!e.ignoreSymlinks,encoding:(e.fileEncoding&&this.fileUtils.toCanonicalName(e.fileEncoding))??""}}}function U(s){return{isCaseSensitive:s.isCaseSensitive||!1,isRegExp:s.isRegExp||!1,isWordMatch:s.isWordMatch||!1,isMultiline:s.isMultiline||!1,pattern:s.pattern}}class Q{constructor(e){this._onResult=e;this._batchedCollector=new m(512,t=>this.sendItems(t))}_batchedCollector;_currentFolderIdx=-1;_currentUri;_currentFileMatch=null;add(e,t){this._currentFileMatch&&(this._currentFolderIdx!==t||!x.isEqual(this._currentUri,e.uri))&&(this.pushToCollector(),this._currentFileMatch=null),this._currentFileMatch||(this._currentFolderIdx=t,this._currentFileMatch={resource:e.uri,results:[]}),this._currentFileMatch.results.push(A(e))}pushToCollector(){const e=this._currentFileMatch&&this._currentFileMatch.results?this._currentFileMatch.results.length:0;this._batchedCollector.addItem(this._currentFileMatch,e)}flush(){this.pushToCollector(),this._batchedCollector.flush()}sendItems(e){this._onResult(e)}}function A(s){return s instanceof p?{previewText:s.previewText,rangeLocations:s.ranges.map(e=>({preview:{startLineNumber:e.previewRange.start.line,startColumn:e.previewRange.start.character,endLineNumber:e.previewRange.end.line,endColumn:e.previewRange.end.character},source:{startLineNumber:e.sourceRange.start.line,startColumn:e.sourceRange.start.character,endLineNumber:e.sourceRange.end.line,endColumn:e.sourceRange.end.character}}))}:{text:s.text,lineNumber:s.lineNumber}}class m{constructor(e,t){this.maxBatchSize=e;this.cb=t}static TIMEOUT=4e3;static START_BATCH_AFTER_COUNT=50;totalNumberCompleted=0;batch=[];batchSize=0;timeoutHandle;addItem(e,t){e&&this.addItemToBatch(e,t)}addItems(e,t){e&&this.addItemsToBatch(e,t)}addItemToBatch(e,t){this.batch.push(e),this.batchSize+=t,this.onUpdate()}addItemsToBatch(e,t){this.batch=this.batch.concat(e),this.batchSize+=t,this.onUpdate()}onUpdate(){this.totalNumberCompleted<m.START_BATCH_AFTER_COUNT?this.flush():this.batchSize>=this.maxBatchSize?this.flush():this.timeoutHandle||(this.timeoutHandle=setTimeout(()=>{this.flush()},m.TIMEOUT))}flush(){this.batchSize&&(this.totalNumberCompleted+=this.batchSize,this.cb(this.batch),this.batch=[],this.batchSize=0,this.timeoutHandle&&(clearTimeout(this.timeoutHandle),this.timeoutHandle=0))}}export{m as BatchedCollector,ue as TextSearchManager,Q as TextSearchResultsCollector};
