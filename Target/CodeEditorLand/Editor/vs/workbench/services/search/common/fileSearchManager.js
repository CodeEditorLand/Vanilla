import*as u from"../../../../base/common/path.js";import{CancellationTokenSource as S}from"../../../../base/common/cancellation.js";import{toErrorMessage as g}from"../../../../base/common/errorMessage.js";import*as v from"../../../../base/common/glob.js";import*as y from"../../../../base/common/resources.js";import{StopWatch as P}from"../../../../base/common/stopwatch.js";import{QueryGlobTester as T,resolvePatternsForProvider as I,hasSiblingFn as C,excludeToGlobPattern as E,DEFAULT_MAX_SEARCH_RESULTS as x}from"./search.js";import{TernarySearchTree as k}from"../../../../base/common/ternarySearchTree.js";import{OldFileSearchProviderConverter as M}from"./searchExtConversionTypes.js";class R{constructor(e,t,r){this.config=e;this.provider=t;this.sessionLifecycle=r;this.filePattern=e.filePattern,this.includePattern=e.includePattern&&v.parse(e.includePattern),this.maxResults=e.maxResults||void 0,this.exists=e.exists,this.activeCancellationTokens=new Set,this.globalExcludePattern=e.excludePattern&&v.parse(e.excludePattern)}filePattern;includePattern;maxResults;exists;isLimitHit=!1;resultCount=0;isCanceled=!1;activeCancellationTokens;globalExcludePattern;cancel(){this.isCanceled=!0,this.activeCancellationTokens.forEach(e=>e.cancel()),this.activeCancellationTokens=new Set}search(e){const t=this.config.folderQueries||[];return new Promise((r,l)=>{const o=i=>{this.resultCount++,e(i)};if(this.isCanceled)return r({limitHit:this.isLimitHit});this.config.extraFileResources&&this.config.extraFileResources.forEach(i=>{const s=i.toString(),n=u.basename(s);this.globalExcludePattern&&this.globalExcludePattern(s,n)||this.matchFile(o,{base:i,basename:n})}),this.doSearch(t,o).then(i=>{r({limitHit:this.isLimitHit,stats:i||void 0})},i=>{l(new Error(g(i)))})})}async doSearch(e,t){const r=new S,l=e.map(a=>this.getSearchOptionsForFolder(a)),o=this.provider instanceof M?this.sessionLifecycle?.tokenSource.token:this.sessionLifecycle?.obj,i={folderOptions:l,maxResults:this.config.maxResults??x,session:o},s=k.forUris();e.forEach(a=>{const c=new T(this.config,a),f=!c.hasSiblingExcludeClauses();s.set(a.folder,{queryTester:c,noSiblingsClauses:f,folder:a.folder,tree:this.initDirectoryTree()})});let n;try{this.activeCancellationTokens.add(r),n=P.create();const a=await this.provider.provideFileSearchResults(this.config.filePattern||"",i,r.token),c=n.elapsed(),f=P.create();return this.isCanceled&&!this.isLimitHit||(a&&a.forEach(h=>{const d=s.findSubstr(h),m=u.posix.relative(d.folder.path,h.path);if(d.noSiblingsClauses){const p=u.basename(h.path);this.matchFile(t,{base:d.folder,relativePath:m,basename:p});return}this.addDirectoryEntries(d.tree,d.folder,m,t)}),this.isCanceled&&!this.isLimitHit)?null:(s.forEach(h=>{this.matchDirectoryTree(h.tree,h.queryTester,t)}),{providerTime:c,postProcessTime:f.elapsed()})}finally{r.dispose(),this.activeCancellationTokens.delete(r)}}getSearchOptionsForFolder(e){const t=I(this.config.includePattern,e.includePattern);let r=e.excludePattern?.map(o=>({folder:o.folder,patterns:I(this.config.excludePattern,o.pattern)}));r?.length||(r=[{folder:void 0,patterns:I(this.config.excludePattern,void 0)}]);const l=E(r);return{folder:e.folder,excludes:l,includes:t,useIgnoreFiles:{local:!e.disregardIgnoreFiles,parent:!e.disregardParentIgnoreFiles,global:!e.disregardGlobalIgnoreFiles},followSymlinks:!e.ignoreSymlinks}}initDirectoryTree(){const e={rootEntries:[],pathToEntries:Object.create(null)};return e.pathToEntries["."]=e.rootEntries,e}addDirectoryEntries({pathToEntries:e},t,r,l){if(r===this.filePattern){const i=u.basename(this.filePattern);this.matchFile(l,{base:t,relativePath:this.filePattern,basename:i})}function o(i){const s=u.basename(i),n=u.dirname(i);let a=e[n];a||(a=e[n]=[],o(n)),a.push({base:t,relativePath:i,basename:s})}o(r)}matchDirectoryTree({rootEntries:e,pathToEntries:t},r,l){const o=this,i=this.filePattern;function s(n){const a=C(()=>n.map(c=>c.basename));for(let c=0,f=n.length;c<f;c++){const h=n[c],{relativePath:d,basename:m}=h;if(r.matchesExcludesSync(d,m,i!==m?a:void 0))continue;const p=t[d];if(p)s(p);else{if(d===i)continue;o.matchFile(l,h)}if(o.isLimitHit)break}}s(e)}matchFile(e,t){(!this.includePattern||t.relativePath&&this.includePattern(t.relativePath,t.basename))&&((this.exists||this.maxResults&&this.resultCount>=this.maxResults)&&(this.isLimitHit=!0,this.cancel()),this.isLimitHit||e(t))}}class w{_obj;tokenSource;constructor(){this._obj=new Object,this.tokenSource=new S}get obj(){if(this._obj)return this._obj;throw new Error("Session object has been dereferenced.")}cancel(){this.tokenSource.cancel(),this._obj=void 0}}class b{static BATCH_SIZE=512;sessions=new Map;fileSearch(e,t,r,l){const o=this.getSessionTokenSource(e.cacheKey),i=new R(e,t,o);let s=0;const n=a=>{s+=a.length,r(a.map(c=>this.rawMatchToSearchItem(c)))};return this.doSearch(i,b.BATCH_SIZE,n,l).then(a=>({limitHit:a.limitHit,stats:a.stats?{fromCache:!1,type:"fileSearchProvider",resultCount:s,detailStats:a.stats}:void 0,messages:[]}))}clearCache(e){this.sessions.get(e)?.cancel(),this.sessions.delete(e)}getSessionTokenSource(e){if(e)return this.sessions.has(e)||this.sessions.set(e,new w),this.sessions.get(e)}rawMatchToSearchItem(e){return e.relativePath?{resource:y.joinPath(e.base,e.relativePath)}:{resource:e.base}}doSearch(e,t,r,l){const o=l.onCancellationRequested(()=>{e.cancel()}),i=n=>{n&&(s.push(n),t>0&&s.length>=t&&(r(s),s=[]))};let s=[];return e.search(i).then(n=>(s.length&&r(s),o.dispose(),n),n=>(s.length&&r(s),o.dispose(),Promise.reject(n)))}}export{b as FileSearchManager};
