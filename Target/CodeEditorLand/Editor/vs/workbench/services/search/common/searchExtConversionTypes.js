import{asArray as c,coalesce as l}from"../../../../base/common/arrays.js";import"../../../../base/common/cancellation.js";import"../../../../base/common/uri.js";import"../../../../platform/progress/common/progress.js";import{DEFAULT_TEXT_SEARCH_PREVIEW_OPTIONS as u}from"./search.js";import{TextSearchContextNew as g,TextSearchMatchNew as d}from"./searchExtTypes.js";function T(e){return"uri"in e&&"ranges"in e&&"preview"in e}function v(e){return e.folderOptions.map(r=>({folder:r.folder,excludes:r.excludes.map(i=>typeof i=="string"?i:i.pattern),includes:r.includes,useGlobalIgnoreFiles:r.useIgnoreFiles.global,useIgnoreFiles:r.useIgnoreFiles.local,useParentIgnoreFiles:r.useIgnoreFiles.parent,followSymlinks:r.followSymlinks,maxResults:e.maxResults,session:e.session}))}class V{constructor(r){this.provider=r}provideFileSearchResults(r,i,s){return(async()=>{const n=v(i);return Promise.all(n.map(h=>this.provider.provideFileSearchResults({pattern:r},h,s)))})().then(n=>l(n).flat())}}function x(e){return e.folderOptions.map(r=>({folder:r.folder,excludes:r.excludes.map(i=>typeof i=="string"?i:i.pattern),includes:r.includes,useGlobalIgnoreFiles:r.useIgnoreFiles.global,useIgnoreFiles:r.useIgnoreFiles.local,useParentIgnoreFiles:r.useIgnoreFiles.parent,followSymlinks:r.followSymlinks,maxResults:e.maxResults,previewOptions:R(e.previewOptions),maxFileSize:e.maxFileSize,encoding:r.encoding,afterContext:e.surroundingContext,beforeContext:e.surroundingContext}))}function R(e){return{matchLines:e?.matchLines??u.matchLines,charsPerLine:e?.charsPerLine??u.charsPerLine}}function p(e){if(T(e)){const r=c(e.ranges).map((i,s)=>{const n=c(e.preview.matches)[s];return{sourceRange:i,previewRange:n}});return new d(e.uri,r,e.preview.text)}else return new g(e.uri,e.text,e.lineNumber)}class _{constructor(r){this.provider=r}provideTextSearchResults(r,i,s,o){const n=t=>{m(t)&&s.report(p(t))};return(async()=>l(await Promise.all(x(i).map(t=>this.provider.provideTextSearchResults(r,t,{report:a=>n(a)},o)))).reduce((t,a)=>({limitHit:t.limitHit||a.limitHit}),{limitHit:!1}))().then(t=>({limitHit:t.limitHit,message:l(c(t.message))}))}}class q{constructor(r){this.provider=r;this.name=this.provider.name}name;provideAITextSearchResults(r,i,s,o){const n=t=>{m(t)&&s.report(p(t))};return(async()=>l(await Promise.all(x(i).map(t=>this.provider.provideAITextSearchResults(r,t,{report:a=>n(a)},o)))).reduce((t,a)=>({limitHit:t.limitHit||a.limitHit}),{limitHit:!1}))().then(t=>({limitHit:t.limitHit,message:l(c(t.message))}))}}function m(e){if(P(e)){if(Array.isArray(e.ranges)){if(!Array.isArray(e.preview.matches)||e.preview.matches.length!==e.ranges.length)return!1}else if(Array.isArray(e.preview.matches))return!1}return!0}function P(e){return!!e.preview}export{q as OldAITextSearchProviderConverter,V as OldFileSearchProviderConverter,_ as OldTextSearchProviderConverter,P as extensionResultIsMatch,R as newToOldPreviewOptions,p as oldToNewTextSearchResult};
