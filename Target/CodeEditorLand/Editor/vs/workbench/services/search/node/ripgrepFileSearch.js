import*as d from"child_process";import{rgPath as I}from"@vscode/ripgrep";import*as x from"../../../../../vs/base/common/extpath.js";import"../../../../../vs/base/common/glob.js";import{normalizeNFD as u}from"../../../../../vs/base/common/normalization.js";import*as c from"../../../../../vs/base/common/path.js";import{isMacintosh as f}from"../../../../../vs/base/common/platform.js";import*as b from"../../../../../vs/base/common/strings.js";import"../../../../../vs/workbench/services/search/common/search.js";import{anchorGlob as p}from"../../../../../vs/workbench/services/search/node/ripgrepSearchUtils.js";const h=I.replace(/\bnode_modules\.asar\b/,"node_modules.asar.unpacked");function q(r,o,l,t,n){const s=E(r,o,l,t,n),i=o.folder.fsPath;return{cmd:d.spawn(h,s.args,{cwd:i}),rgDiskPath:h,siblingClauses:s.siblingClauses,rgArgs:s,cwd:i}}function E(r,o,l,t,n){const s=["--files","--hidden","--case-sensitive","--no-require-git"];F([o],l,!1).forEach(g=>{const e=p(g);if(s.push("-g",e),f){const a=u(e);a!==e&&s.push("-g",a)}});const i=C([o],t,void 0,!1);return i.globArgs.forEach(g=>{const e=`!${p(g)}`;if(s.push("-g",e),f){const a=u(e);a!==e&&s.push("-g",a)}}),o.disregardIgnoreFiles!==!1?s.push("--no-ignore"):o.disregardParentIgnoreFiles!==!1&&s.push("--no-ignore-parent"),o.ignoreSymlinks||s.push("--follow"),r.exists&&s.push("--quiet"),n&&s.push("--threads",`${n}`),s.push("--no-config"),o.disregardGlobalIgnoreFiles&&s.push("--no-ignore-global"),{args:s,siblingClauses:i.siblingClauses}}function C(r,o,l,t=!0){const n=[];let s={};return r.forEach(i=>{const g=Object.assign({},i.excludePattern||{},o||{}),e=m(g,t?i.folder.fsPath:void 0,l);n.push(...e.globArgs),e.siblingClauses&&(s=Object.assign(s,e.siblingClauses))}),{globArgs:n,siblingClauses:s}}function F(r,o,l=!0){const t=[];return r.forEach(n=>{const s=Object.assign({},o||{},n.includePattern||{}),i=m(s,l?n.folder.fsPath:void 0);t.push(...i.globArgs)}),t}function m(r,o,l){const t=[],n={};return Object.keys(r).forEach(s=>{if(l&&l.has(s)||!s)return;const i=r[s];s=R(o?A(o,s):s),s.startsWith("\\\\")?s="\\\\"+s.substr(2).replace(/\\/g,"/"):s=s.replace(/\\/g,"/"),typeof i=="boolean"&&i?(s.startsWith("\\\\")&&(s+="**"),t.push(G(s))):i&&i.when&&(n[s]=i)}),{globArgs:t,siblingClauses:n}}function A(r,o){return c.isAbsolute(o)?o:c.join(r,o)}function R(r){return r=b.rtrim(r,"\\"),b.rtrim(r,"/")}function G(r){return x.getRoot(r).toLowerCase()==="c:/"?r.replace(/^c:[/\\]/i,"/"):r}export{G as fixDriveC,A as getAbsoluteGlob,q as spawnRipgrepCmd};
