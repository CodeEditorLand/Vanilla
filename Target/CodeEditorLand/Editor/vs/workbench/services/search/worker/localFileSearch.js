import*as w from"../../../../base/common/glob.js";import{URI as H}from"../../../../base/common/uri.js";import{LocalFileSearchSimpleWorkerHost as L}from"../common/localFileSearchWorkerTypes.js";import*as A from"../../../../base/common/path.js";import{CancellationTokenSource as O}from"../../../../base/common/cancellation.js";import{getFileResults as $}from"../common/getFileResults.js";import{IgnoreFile as j}from"../common/ignoreFile.js";import{createRegExp as G}from"../../../../base/common/strings.js";import{Promises as _}from"../../../../base/common/async.js";import{ExtUri as U}from"../../../../base/common/resources.js";import{revive as z}from"../../../../base/common/marshalling.js";const E=!1,J=+new Date,N={},P=async(e,t)=>{if(!E)return t();const n=Date.now(),s=(N[e]??0)+1;console.info(e,s,"starting",Math.round((n-J)*10)/1e4),N[e]=s;const l=await t(),a=Date.now();return console.info(e,s,"took",a-n),l};function ve(e){return new K(e)}class K{_requestHandlerBrand;host;cancellationTokens=new Map;constructor(t){this.host=L.getChannel(t)}$cancelQuery(t){this.cancellationTokens.get(t)?.cancel()}registerCancellationToken(t){const n=new O;return this.cancellationTokens.set(t,n),n}async $listDirectory(t,n,s,l,a){const m=W(s),x=new U(()=>l),c=this.registerCancellationToken(a),f=[];let g=!1,p=0;const h=n.maxResults||512,y=n.filePattern?u=>n.filePattern.split("").every(I=>u.includes(I)):u=>!0;return await P("listDirectory",()=>this.walkFolderQuery(t,M(n),m,x,u=>{if(y(u.name))return p++,h&&p>h&&(g=!0,c.cancel()),f.push(u.path)},c.token)),{results:f,limitHit:g}}async $searchDirectory(t,n,s,l,a){const m=W(s),x=new U(()=>l);return P("searchInFiles",async()=>{const c=this.registerCancellationToken(a),f=[],g=V(n.contentPattern),p=[];let h=0,y=0;const u=!1,I=async k=>{if(c.token.isCancellationRequested)return;h++;const r=await k.resolve();if(c.token.isCancellationRequested)return;const i=new Uint8Array(r),o=$(i,g,{surroundingContext:n.surroundingContext??0,previewOptions:n.previewOptions,remainingResultQuota:n.maxResults?n.maxResults-y:1e4});if(o.length){y+=o.length,n.maxResults&&y>n.maxResults&&c.cancel();const d={resource:H.joinPath(m.folder,k.path),results:o};this.host.$sendTextSearchMatch(d,a),f.push(d)}};return await P("walkFolderToResolve",()=>this.walkFolderQuery(t,M(n),m,x,async k=>p.push(I(k)),c.token)),await P("resolveOngoingProcesses",()=>Promise.all(p)),E&&console.log("Searched in",h,"files"),{results:f,limitHit:u}})}async walkFolderQuery(t,n,s,l,a,m){const x=s.excludePattern?.map(r=>w.parse(r.pattern??{},{trimForExclusions:!0})),c=(r,i,o)=>x?.some(d=>d(r,i,o)),f=(r,i,o)=>(r=r.slice(1),!!(c(r,i,o)||X(n,r))),g=(r,i,o)=>(r=r.slice(1),!(c(r,i,o)||!Y(n,r,l))),p=(r,i)=>({type:"file",name:r.name,path:i,resolve:()=>r.getFile().then(d=>d.arrayBuffer())}),h=r=>r.kind==="directory",y=r=>r.kind==="file",u=async(r,i,o)=>{if(!s.disregardIgnoreFiles){const Q=await Promise.all([r.getFileHandle(".gitignore").catch(F=>{}),r.getFileHandle(".ignore").catch(F=>{})]);await Promise.all(Q.map(async F=>{if(!F)return;const R=new TextDecoder("utf8").decode(new Uint8Array(await(await F.getFile()).arrayBuffer()));o=new j(R,i,o)}))}const d=_.withAsyncBody(async Q=>{const F=[],R=[],b=[],D=new Set;for await(const S of r.entries())b.push(S),D.add(S[0]);for(const[S,v]of b){if(m.isCancellationRequested)break;const C=i+S;if(o&&!o.isPathIncludedInTraversal(C,v.kind==="directory"))continue;const T=B=>D.has(B);h(v)&&!f(C,S,T)?R.push(u(v,C+"/",o)):y(v)&&g(C,S,T)&&F.push(p(v,C))}Q([...await Promise.all(R),...F])});return{type:"dir",name:r.name,entries:d}},I=async(r,i)=>{m.isCancellationRequested||await Promise.all((await r.entries).sort((o,d)=>-(o.type==="dir"?0:1)+(d.type==="dir"?0:1)).map(async o=>o.type==="dir"?I(o,i):i(o)))},k=await P("process",()=>u(t,"/"));await P("resolve",()=>I(k,a))}}function V(e){return G(e.pattern,!!e.isRegExp,{wholeWord:e.isWordMatch,global:!0,matchCase:e.isCaseSensitive,multiline:!0,unicode:!0})}function W(e){return z(e)}function M(e){return{...e,extraFileResources:e.extraFileResources?.map(t=>H.revive(t)),folderQueries:e.folderQueries.map(t=>W(t))}}function X(e,t){return!!(e.excludePattern&&w.match(e.excludePattern,t))}function Y(e,t,n){return e.excludePattern&&w.match(e.excludePattern,t)?!1:e.includePattern||e.usingSearchPaths?e.includePattern&&w.match(e.includePattern,t)?!0:e.usingSearchPaths?!!e.folderQueries&&e.folderQueries.some(s=>{const l=s.folder,a=H.file(t);if(n.isEqualOrParent(a,l)){const m=A.relative(l.path,a.path);return!s.includePattern||!!w.match(s.includePattern,m)}else return!1}):!1:!0}export{K as LocalFileSearchSimpleWorker,ve as create};
