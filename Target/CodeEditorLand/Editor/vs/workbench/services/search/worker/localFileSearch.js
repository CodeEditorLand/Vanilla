import*as w from"../../../../base/common/glob.js";import{URI as R}from"../../../../base/common/uri.js";import"../../../../base/common/worker/simpleWorker.js";import{LocalFileSearchSimpleWorkerHost as A}from"../common/localFileSearchWorkerTypes.js";import"../common/search.js";import*as O from"../../../../base/common/path.js";import{CancellationTokenSource as $}from"../../../../base/common/cancellation.js";import{getFileResults as j}from"../common/getFileResults.js";import{IgnoreFile as G}from"../common/ignoreFile.js";import{createRegExp as _}from"../../../../base/common/strings.js";import{Promises as z}from"../../../../base/common/async.js";import{ExtUri as U}from"../../../../base/common/resources.js";import{revive as E}from"../../../../base/common/marshalling.js";const N=!1,ve=+new Date,M={},P=async(e,t)=>{if(!N)return t();const n=Date.now(),s=(M[e]??0)+1;M[e]=s;const a=await t(),l=Date.now();return a};function xe(e){return new J(e)}class J{_requestHandlerBrand;host;cancellationTokens=new Map;constructor(t){this.host=A.getChannel(t)}$cancelQuery(t){this.cancellationTokens.get(t)?.cancel()}registerCancellationToken(t){const n=new $;return this.cancellationTokens.set(t,n),n}async $listDirectory(t,n,s,a,l){const m=b(s),v=new U(()=>a),c=this.registerCancellationToken(l),f=[];let g=!1,p=0;const y=n.maxResults||512,h=n.filePattern?u=>n.filePattern.split("").every(I=>u.includes(I)):u=>!0;return await P("listDirectory",()=>this.walkFolderQuery(t,B(n),m,v,u=>{if(h(u.name))return p++,y&&p>y&&(g=!0,c.cancel()),f.push(u.path)},c.token)),{results:f,limitHit:g}}async $searchDirectory(t,n,s,a,l){const m=b(s),v=new U(()=>a);return P("searchInFiles",async()=>{const c=this.registerCancellationToken(l),f=[],g=K(n.contentPattern),p=[];let y=0,h=0;const u=!1,I=async k=>{if(c.token.isCancellationRequested)return;y++;const r=await k.resolve();if(c.token.isCancellationRequested)return;const i=new Uint8Array(r),o=j(i,g,{surroundingContext:n.surroundingContext??0,previewOptions:n.previewOptions,remainingResultQuota:n.maxResults?n.maxResults-h:1e4});if(o.length){h+=o.length,n.maxResults&&h>n.maxResults&&c.cancel();const d={resource:R.joinPath(m.folder,k.path),results:o};this.host.$sendTextSearchMatch(d,l),f.push(d)}};return await P("walkFolderToResolve",()=>this.walkFolderQuery(t,B(n),m,v,async k=>p.push(I(k)),c.token)),await P("resolveOngoingProcesses",()=>Promise.all(p)),{results:f,limitHit:u}})}async walkFolderQuery(t,n,s,a,l,m){const v=s.excludePattern?.map(r=>w.parse(r.pattern??{},{trimForExclusions:!0})),c=(r,i,o)=>v?.some(d=>d(r,i,o)),f=(r,i,o)=>(r=r.slice(1),!!(c(r,i,o)||V(n,r))),g=(r,i,o)=>(r=r.slice(1),!(c(r,i,o)||!X(n,r,a))),p=(r,i)=>({type:"file",name:r.name,path:i,resolve:()=>r.getFile().then(d=>d.arrayBuffer())}),y=r=>r.kind==="directory",h=r=>r.kind==="file",u=async(r,i,o)=>{if(!s.disregardIgnoreFiles){const H=await Promise.all([r.getFileHandle(".gitignore").catch(F=>{}),r.getFileHandle(".ignore").catch(F=>{})]);await Promise.all(H.map(async F=>{if(!F)return;const Q=new TextDecoder("utf8").decode(new Uint8Array(await(await F.getFile()).arrayBuffer()));o=new G(Q,i,o)}))}const d=z.withAsyncBody(async H=>{const F=[],Q=[],W=[],D=new Set;for await(const S of r.entries())W.push(S),D.add(S[0]);for(const[S,x]of W){if(m.isCancellationRequested)break;const C=i+S;if(o&&!o.isPathIncludedInTraversal(C,x.kind==="directory"))continue;const T=L=>D.has(L);y(x)&&!f(C,S,T)?Q.push(u(x,C+"/",o)):h(x)&&g(C,S,T)&&F.push(p(x,C))}H([...await Promise.all(Q),...F])});return{type:"dir",name:r.name,entries:d}},I=async(r,i)=>{m.isCancellationRequested||await Promise.all((await r.entries).sort((o,d)=>-(o.type==="dir"?0:1)+(d.type==="dir"?0:1)).map(async o=>o.type==="dir"?I(o,i):i(o)))},k=await P("process",()=>u(t,"/"));await P("resolve",()=>I(k,l))}}function K(e){return _(e.pattern,!!e.isRegExp,{wholeWord:e.isWordMatch,global:!0,matchCase:e.isCaseSensitive,multiline:!0,unicode:!0})}function b(e){return E({...E(e),excludePattern:e.excludePattern?.map(t=>({folder:R.revive(t.folder),pattern:t.pattern})),folder:R.revive(e.folder)})}function B(e){return{...e,extraFileResources:e.extraFileResources?.map(t=>R.revive(t)),folderQueries:e.folderQueries.map(t=>b(t))}}function V(e,t){return!!(e.excludePattern&&w.match(e.excludePattern,t))}function X(e,t,n){return e.excludePattern&&w.match(e.excludePattern,t)?!1:e.includePattern||e.usingSearchPaths?e.includePattern&&w.match(e.includePattern,t)?!0:e.usingSearchPaths?!!e.folderQueries&&e.folderQueries.some(s=>{const a=s.folder,l=R.file(t);if(n.isEqualOrParent(l,a)){const m=O.relative(a.path,l.path);return!s.includePattern||!!w.match(s.includePattern,m)}else return!1}):!1:!0}export{J as LocalFileSearchSimpleWorker,xe as create};
