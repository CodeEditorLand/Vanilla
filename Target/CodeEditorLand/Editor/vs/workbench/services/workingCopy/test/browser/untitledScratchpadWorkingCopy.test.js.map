{
  "version": 3,
  "sources": ["../../../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/services/workingCopy/test/browser/untitledScratchpadWorkingCopy.test.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { VSBufferReadableStream, VSBuffer, streamToBuffer, bufferToStream, readableToBuffer, VSBufferReadable } from '../../../../../base/common/buffer.js';\nimport { CancellationToken } from '../../../../../base/common/cancellation.js';\nimport { DisposableStore } from '../../../../../base/common/lifecycle.js';\nimport { Schemas } from '../../../../../base/common/network.js';\nimport { basename } from '../../../../../base/common/resources.js';\nimport { consumeReadable, consumeStream, isReadable, isReadableStream } from '../../../../../base/common/stream.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../base/test/common/utils.js';\nimport { IInstantiationService } from '../../../../../platform/instantiation/common/instantiation.js';\nimport { IUntitledFileWorkingCopyModelFactory, UntitledFileWorkingCopy } from '../../common/untitledFileWorkingCopy.js';\nimport { TestUntitledFileWorkingCopyModel } from './untitledFileWorkingCopy.test.js';\nimport { TestServiceAccessor, workbenchInstantiationService } from '../../../../test/browser/workbenchTestServices.js';\n\nexport class TestUntitledFileWorkingCopyModelFactory implements IUntitledFileWorkingCopyModelFactory<TestUntitledFileWorkingCopyModel> {\n\n\tasync createModel(resource: URI, contents: VSBufferReadableStream, token: CancellationToken): Promise<TestUntitledFileWorkingCopyModel> {\n\t\treturn new TestUntitledFileWorkingCopyModel(resource, (await streamToBuffer(contents)).toString());\n\t}\n}\n\nsuite('UntitledScratchpadWorkingCopy', () => {\n\n\tconst factory = new TestUntitledFileWorkingCopyModelFactory();\n\n\tconst disposables = new DisposableStore();\n\tconst resource = URI.from({ scheme: Schemas.untitled, path: 'Untitled-1' });\n\tlet instantiationService: IInstantiationService;\n\tlet accessor: TestServiceAccessor;\n\tlet workingCopy: UntitledFileWorkingCopy<TestUntitledFileWorkingCopyModel>;\n\n\tfunction createWorkingCopy(uri: URI = resource, hasAssociatedFilePath = false, initialValue = '') {\n\t\treturn disposables.add(new UntitledFileWorkingCopy<TestUntitledFileWorkingCopyModel>(\n\t\t\t'testUntitledWorkingCopyType',\n\t\t\turi,\n\t\t\tbasename(uri),\n\t\t\thasAssociatedFilePath,\n\t\t\ttrue,\n\t\t\tinitialValue.length > 0 ? { value: bufferToStream(VSBuffer.fromString(initialValue)) } : undefined,\n\t\t\tfactory,\n\t\t\tasync workingCopy => { await workingCopy.revert(); return true; },\n\t\t\taccessor.workingCopyService,\n\t\t\taccessor.workingCopyBackupService,\n\t\t\taccessor.logService\n\t\t));\n\t}\n\n\tsetup(() => {\n\t\tinstantiationService = workbenchInstantiationService(undefined, disposables);\n\t\taccessor = instantiationService.createInstance(TestServiceAccessor);\n\n\t\tworkingCopy = disposables.add(createWorkingCopy());\n\t});\n\n\tteardown(() => {\n\t\tdisposables.clear();\n\t});\n\n\ttest('registers with working copy service', async () => {\n\t\tassert.strictEqual(accessor.workingCopyService.workingCopies.length, 1);\n\n\t\tworkingCopy.dispose();\n\n\t\tassert.strictEqual(accessor.workingCopyService.workingCopies.length, 0);\n\t});\n\n\ttest('modified - not dirty', async () => {\n\t\tassert.strictEqual(workingCopy.isDirty(), false);\n\n\t\tlet changeDirtyCounter = 0;\n\t\tdisposables.add(workingCopy.onDidChangeDirty(() => {\n\t\t\tchangeDirtyCounter++;\n\t\t}));\n\n\t\tlet contentChangeCounter = 0;\n\t\tdisposables.add(workingCopy.onDidChangeContent(() => {\n\t\t\tcontentChangeCounter++;\n\t\t}));\n\n\t\tawait workingCopy.resolve();\n\t\tassert.strictEqual(workingCopy.isResolved(), true);\n\n\t\t// Modified from: Model content change\n\t\tworkingCopy.model?.updateContents('hello modified');\n\t\tassert.strictEqual(contentChangeCounter, 1);\n\n\t\tassert.strictEqual(workingCopy.isDirty(), false);\n\t\tassert.strictEqual(workingCopy.isModified(), true);\n\t\tassert.strictEqual(changeDirtyCounter, 0);\n\n\t\tawait workingCopy.save();\n\n\t\tassert.strictEqual(workingCopy.isDirty(), false);\n\t\tassert.strictEqual(changeDirtyCounter, 0);\n\t});\n\n\ttest('modified - cleared when content event signals isEmpty', async () => {\n\t\tassert.strictEqual(workingCopy.isModified(), false);\n\n\t\tawait workingCopy.resolve();\n\n\t\tworkingCopy.model?.updateContents('hello modified');\n\n\t\tassert.strictEqual(workingCopy.isModified(), true);\n\n\t\tworkingCopy.model?.fireContentChangeEvent({ isInitial: true });\n\n\t\tassert.strictEqual(workingCopy.isModified(), false);\n\t});\n\n\ttest('modified - not cleared when content event signals isEmpty when associated resource', async () => {\n\t\tworkingCopy.dispose();\n\t\tworkingCopy = createWorkingCopy(resource, true);\n\n\t\tawait workingCopy.resolve();\n\n\t\tworkingCopy.model?.updateContents('hello modified');\n\t\tassert.strictEqual(workingCopy.isModified(), true);\n\n\t\tworkingCopy.model?.fireContentChangeEvent({ isInitial: true });\n\n\t\tassert.strictEqual(workingCopy.isModified(), true);\n\t});\n\n\ttest('revert', async () => {\n\t\tlet revertCounter = 0;\n\t\tdisposables.add(workingCopy.onDidRevert(() => {\n\t\t\trevertCounter++;\n\t\t}));\n\n\t\tlet disposeCounter = 0;\n\t\tdisposables.add(workingCopy.onWillDispose(() => {\n\t\t\tdisposeCounter++;\n\t\t}));\n\n\t\tawait workingCopy.resolve();\n\n\t\tworkingCopy.model?.updateContents('hello modified');\n\t\tassert.strictEqual(workingCopy.isModified(), true);\n\n\t\tawait workingCopy.revert();\n\n\t\tassert.strictEqual(revertCounter, 1);\n\t\tassert.strictEqual(disposeCounter, 1);\n\t\tassert.strictEqual(workingCopy.isModified(), false);\n\t});\n\n\ttest('dispose', async () => {\n\t\tlet disposeCounter = 0;\n\t\tdisposables.add(workingCopy.onWillDispose(() => {\n\t\t\tdisposeCounter++;\n\t\t}));\n\n\t\tawait workingCopy.resolve();\n\t\tworkingCopy.dispose();\n\n\t\tassert.strictEqual(disposeCounter, 1);\n\t});\n\n\ttest('backup', async () => {\n\t\tassert.strictEqual((await workingCopy.backup(CancellationToken.None)).content, undefined);\n\n\t\tawait workingCopy.resolve();\n\n\t\tworkingCopy.model?.updateContents('Hello Backup');\n\t\tconst backup = await workingCopy.backup(CancellationToken.None);\n\n\t\tlet backupContents: string | undefined = undefined;\n\t\tif (isReadableStream(backup.content)) {\n\t\t\tbackupContents = (await consumeStream(backup.content, chunks => VSBuffer.concat(chunks))).toString();\n\t\t} else if (backup.content) {\n\t\t\tbackupContents = consumeReadable(backup.content, chunks => VSBuffer.concat(chunks)).toString();\n\t\t}\n\n\t\tassert.strictEqual(backupContents, 'Hello Backup');\n\t});\n\n\ttest('resolve - without contents', async () => {\n\t\tassert.strictEqual(workingCopy.isResolved(), false);\n\t\tassert.strictEqual(workingCopy.hasAssociatedFilePath, false);\n\t\tassert.strictEqual(workingCopy.model, undefined);\n\n\t\tawait workingCopy.resolve();\n\n\t\tassert.strictEqual(workingCopy.isResolved(), true);\n\t\tassert.ok(workingCopy.model);\n\t});\n\n\ttest('resolve - with initial contents', async () => {\n\t\tworkingCopy.dispose();\n\n\t\tworkingCopy = createWorkingCopy(resource, false, 'Hello Initial');\n\n\t\tlet contentChangeCounter = 0;\n\t\tdisposables.add(workingCopy.onDidChangeContent(() => {\n\t\t\tcontentChangeCounter++;\n\t\t}));\n\n\t\tassert.strictEqual(workingCopy.isModified(), true);\n\n\t\tawait workingCopy.resolve();\n\n\t\tassert.strictEqual(workingCopy.isModified(), true);\n\t\tassert.strictEqual(workingCopy.model?.contents, 'Hello Initial');\n\t\tassert.strictEqual(contentChangeCounter, 1);\n\n\t\tworkingCopy.model.updateContents('Changed contents');\n\n\t\tawait workingCopy.resolve(); // second resolve should be ignored\n\t\tassert.strictEqual(workingCopy.model?.contents, 'Changed contents');\n\t});\n\n\ttest('backup - with initial contents uses those even if unresolved', async () => {\n\t\tworkingCopy.dispose();\n\n\t\tworkingCopy = createWorkingCopy(resource, false, 'Hello Initial');\n\n\t\tassert.strictEqual(workingCopy.isModified(), true);\n\n\t\tconst backup = (await workingCopy.backup(CancellationToken.None)).content;\n\t\tif (isReadableStream(backup)) {\n\t\t\tconst value = await streamToBuffer(backup as VSBufferReadableStream);\n\t\t\tassert.strictEqual(value.toString(), 'Hello Initial');\n\t\t} else if (isReadable(backup)) {\n\t\t\tconst value = readableToBuffer(backup as VSBufferReadable);\n\t\t\tassert.strictEqual(value.toString(), 'Hello Initial');\n\t\t} else {\n\t\t\tassert.fail('Missing untitled backup');\n\t\t}\n\t});\n\n\n\ttest('resolve - with associated resource', async () => {\n\t\tworkingCopy.dispose();\n\t\tworkingCopy = createWorkingCopy(resource, true);\n\n\t\tawait workingCopy.resolve();\n\n\t\tassert.strictEqual(workingCopy.isModified(), true);\n\t\tassert.strictEqual(workingCopy.hasAssociatedFilePath, true);\n\t});\n\n\ttest('resolve - with backup', async () => {\n\t\tawait workingCopy.resolve();\n\t\tworkingCopy.model?.updateContents('Hello Backup');\n\n\t\tconst backup = await workingCopy.backup(CancellationToken.None);\n\t\tawait accessor.workingCopyBackupService.backup(workingCopy, backup.content, undefined, backup.meta);\n\n\t\tassert.strictEqual(accessor.workingCopyBackupService.hasBackupSync(workingCopy), true);\n\n\t\tworkingCopy.dispose();\n\n\t\tworkingCopy = createWorkingCopy();\n\n\t\tlet contentChangeCounter = 0;\n\t\tdisposables.add(workingCopy.onDidChangeContent(() => {\n\t\t\tcontentChangeCounter++;\n\t\t}));\n\n\t\tawait workingCopy.resolve();\n\n\t\tassert.strictEqual(workingCopy.isModified(), true);\n\t\tassert.strictEqual(workingCopy.model?.contents, 'Hello Backup');\n\t\tassert.strictEqual(contentChangeCounter, 1);\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n});\n"],
  "mappings": "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",
  "names": ["workingCopy"]
}
