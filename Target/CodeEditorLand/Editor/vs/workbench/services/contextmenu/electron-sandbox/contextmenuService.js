var D=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var v=(d,a,t,e)=>{for(var i=e>1?void 0:e?E(a,t):a,s=d.length-1,n;s>=0;s--)(n=d[s])&&(i=(e?n(a,t,i):n(i))||i);return e&&i&&D(a,t,i),i},m=(d,a)=>(t,e)=>a(t,e,d);import{getZoomFactor as k}from"../../../../../vs/base/browser/browser.js";import"../../../../../vs/base/browser/contextmenu.js";import*as l from"../../../../../vs/base/browser/dom.js";import{AnchorAlignment as I,AnchorAxisAlignment as H,isAnchor as K}from"../../../../../vs/base/browser/ui/contextview/contextview.js";import{ActionRunner as T,Separator as L,SubmenuAction as _}from"../../../../../vs/base/common/actions.js";import{coalesce as F}from"../../../../../vs/base/common/arrays.js";import{Emitter as M}from"../../../../../vs/base/common/event.js";import{createSingleCallFunction as R}from"../../../../../vs/base/common/functional.js";import{stripIcons as C}from"../../../../../vs/base/common/iconLabels.js";import{unmnemonicLabel as g}from"../../../../../vs/base/common/labels.js";import{Disposable as W}from"../../../../../vs/base/common/lifecycle.js";import{isMacintosh as x,isWindows as N}from"../../../../../vs/base/common/platform.js";import"../../../../../vs/base/parts/contextmenu/common/contextmenu.js";import{popup as B}from"../../../../../vs/base/parts/contextmenu/electron-sandbox/contextmenu.js";import{IMenuService as S}from"../../../../../vs/platform/actions/common/actions.js";import{IConfigurationService as P}from"../../../../../vs/platform/configuration/common/configuration.js";import{IContextKeyService as b}from"../../../../../vs/platform/contextkey/common/contextkey.js";import{ContextMenuMenuDelegate as Z,ContextMenuService as $}from"../../../../../vs/platform/contextview/browser/contextMenuService.js";import{IContextMenuService as O,IContextViewService as V}from"../../../../../vs/platform/contextview/browser/contextView.js";import{InstantiationType as z,registerSingleton as j}from"../../../../../vs/platform/instantiation/common/extensions.js";import{IKeybindingService as A}from"../../../../../vs/platform/keybinding/common/keybinding.js";import{INotificationService as w}from"../../../../../vs/platform/notification/common/notification.js";import{ITelemetryService as y}from"../../../../../vs/platform/telemetry/common/telemetry.js";import{hasNativeTitlebar as q}from"../../../../../vs/platform/window/common/window.js";let f=class{impl;get onDidShowContextMenu(){return this.impl.onDidShowContextMenu}get onDidHideContextMenu(){return this.impl.onDidHideContextMenu}constructor(a,t,e,i,s,n,o){!x&&!q(i)?this.impl=new $(t,a,s,e,n,o):this.impl=new p(a,t,e,n,o)}dispose(){this.impl.dispose()}showContextMenu(a){this.impl.showContextMenu(a)}};f=v([m(0,w),m(1,y),m(2,A),m(3,P),m(4,V),m(5,S),m(6,b)],f);let p=class extends W{constructor(t,e,i,s,n){super();this.notificationService=t;this.telemetryService=e;this.keybindingService=i;this.menuService=s;this.contextKeyService=n}_onDidShowContextMenu=this._store.add(new M);onDidShowContextMenu=this._onDidShowContextMenu.event;_onDidHideContextMenu=this._store.add(new M);onDidHideContextMenu=this._onDidHideContextMenu.event;showContextMenu(t){t=Z.transform(t,this.menuService,this.contextKeyService);const e=t.getActions();if(e.length){const i=R(()=>{t.onHide?.(!1),l.ModifierKeyEmitter.getInstance().resetKeyStatus(),this._onDidHideContextMenu.fire()}),s=this.createMenu(t,e,i),n=t.getAnchor();let o,r,u=k(l.isHTMLElement(n)?l.getWindow(n):l.getActiveWindow());if(l.isHTMLElement(n)){const c=l.getDomNodePagePosition(n);u*=l.getDomNodeZoomLevel(n),t.anchorAxisAlignment===H.HORIZONTAL?(t.anchorAlignment===I.LEFT?(o=c.left,r=c.top):(o=c.left+c.width,r=c.top),x||l.getWindow(n).screen.height-r<e.length*(N?45:32)&&(r+=c.height)):t.anchorAlignment===I.LEFT?(o=c.left,r=c.top+c.height):(o=c.left+c.width,r=c.top+c.height),x&&(r+=4/u)}else K(n)&&(o=n.x,r=n.y);typeof o=="number"&&(o=Math.floor(o*u)),typeof r=="number"&&(r=Math.floor(r*u)),B(s,{x:o,y:r,positioningItem:t.autoSelectFirstItem?0:void 0},()=>i()),this._onDidShowContextMenu.fire()}}createMenu(t,e,i,s=new Set){const n=t.actionRunner||new T;return F(e.map(o=>this.createMenuItem(t,o,n,i,s)))}createMenuItem(t,e,i,s,n){if(e instanceof L)return{type:"separator"};if(e instanceof _){if(n.has(e.id)){console.warn(`Found submenu cycle: ${e.id}`);return}return{label:g(C(e.label)).trim(),submenu:this.createMenu(t,e.actions,s,new Set([...n,e.id]))}}else{let o;e.checked&&(typeof t.getCheckedActionsRepresentation=="function"?o=t.getCheckedActionsRepresentation(e):o="checkbox");const r={label:g(C(e.label)).trim(),checked:!!e.checked,type:o,enabled:!!e.enabled,click:c=>{s(),this.runAction(i,e,t,c)}},u=t.getKeyBinding?t.getKeyBinding(e):this.keybindingService.lookupKeybinding(e.id);if(u){const c=u.getElectronAccelerator();if(c)r.accelerator=c;else{const h=u.getLabel();h&&(r.label=`${r.label} [${h}]`)}}return r}}async runAction(t,e,i,s){i.skipTelemetry||this.telemetryService.publicLog2("workbenchActionExecuted",{id:e.id,from:"contextMenu"});const n=i.getActionsContext?i.getActionsContext(s):void 0,o=t.run(e,n);try{await o}catch(r){this.notificationService.error(r)}}};p=v([m(0,w),m(1,y),m(2,A),m(3,S),m(4,b)],p),j(O,f,z.Delayed);export{f as ContextMenuService};
