var le=Object.defineProperty;var ue=Object.getOwnPropertyDescriptor;var x=(I,m,i,e)=>{for(var t=e>1?void 0:e?ue(m,i):m,o=I.length-1,r;o>=0;o--)(r=I[o])&&(t=(e?r(m,i,t):r(t))||t);return e&&t&&le(m,i,t),t},a=(I,m)=>(i,e)=>m(i,e,I);import"./media/window.css";import{localize as n}from"../../nls.js";import{URI as h}from"../../base/common/uri.js";import{onUnexpectedError as ve}from"../../base/common/errors.js";import{equals as he}from"../../base/common/objects.js";import{EventType as W,EventHelper as G,addDisposableListener as M,ModifierKeyEmitter as pe,getActiveElement as me,hasWindow as V,getWindow as fe,getWindowById as F,getWindows as Se}from"../../base/browser/dom.js";import{Action as b,Separator as ge}from"../../base/common/actions.js";import{IFileService as we}from"../../platform/files/common/files.js";import{EditorResourceAccessor as q,SideBySideEditor as K,pathsToEditors as ye,isResourceEditorInput as f}from"../common/editor.js";import{IEditorService as Q}from"../services/editor/common/editorService.js";import{ITelemetryService as Ie}from"../../platform/telemetry/common/telemetry.js";import{WindowMinimumSize as $,hasNativeTitlebar as j}from"../../platform/window/common/window.js";import{ITitleService as be}from"../services/title/browser/titleService.js";import{IWorkbenchThemeService as Ee}from"../services/themes/common/workbenchThemeService.js";import{ApplyZoomTarget as Ce,applyZoom as Ae}from"../../platform/window/electron-sandbox/window.js";import{setFullscreen as Y,getZoomLevel as L,onDidChangeZoomLevel as Re,getZoomFactor as We}from"../../base/browser/browser.js";import{ICommandService as J,CommandsRegistry as Le}from"../../platform/commands/common/commands.js";import{ipcRenderer as c,process as ke}from"../../base/parts/sandbox/electron-sandbox/globals.js";import{IWorkspaceEditingService as Te}from"../services/workspaces/common/workspaceEditing.js";import{IMenuService as De,MenuId as X,MenuItemAction as Pe,MenuRegistry as xe}from"../../platform/actions/common/actions.js";import{createAndFillInActionBarActions as Me}from"../../platform/actions/browser/menuEntryActionViewItem.js";import{RunOnceScheduler as O}from"../../base/common/async.js";import{Disposable as Fe,DisposableStore as E,MutableDisposable as Oe,toDisposable as ee}from"../../base/common/lifecycle.js";import{LifecyclePhase as U,ILifecycleService as Ue,ShutdownReason as u}from"../services/lifecycle/common/lifecycle.js";import{IIntegrityService as Be}from"../services/integrity/common/integrity.js";import{isWindows as ie,isMacintosh as S,isCI as He}from"../../base/common/platform.js";import{IProductService as Ze}from"../../platform/product/common/productService.js";import{INotificationService as ze,NeverShowAgainScope as Ne,NotificationPriority as k,Severity as g}from"../../platform/notification/common/notification.js";import{IKeybindingService as te}from"../../platform/keybinding/common/keybinding.js";import{INativeWorkbenchEnvironmentService as _e}from"../services/environment/electron-sandbox/environmentService.js";import{IAccessibilityService as Ge,AccessibilitySupport as oe}from"../../platform/accessibility/common/accessibility.js";import{WorkbenchState as Ve,IWorkspaceContextService as qe}from"../../platform/workspace/common/workspace.js";import{coalesce as B}from"../../base/common/arrays.js";import{ConfigurationTarget as Ke,IConfigurationService as Qe}from"../../platform/configuration/common/configuration.js";import{IStorageService as $e,StorageScope as H,StorageTarget as je}from"../../platform/storage/common/storage.js";import{assertIsDefined as Ye}from"../../base/common/types.js";import{IOpenerService as Je}from"../../platform/opener/common/opener.js";import{Schemas as re}from"../../base/common/network.js";import{INativeHostService as Xe}from"../../platform/native/common/native.js";import{posix as Z}from"../../base/common/path.js";import{ITunnelService as ei,extractLocalHostUriMetaDataForPortMapping as ii,extractQueryLocalHostUriMetaDataForPortMapping as ti}from"../../platform/tunnel/common/tunnel.js";import{IWorkbenchLayoutService as oi,Parts as ri,positionFromString as ni,Position as ne}from"../services/layout/browser/layoutService.js";import{IWorkingCopyService as si}from"../services/workingCopy/common/workingCopyService.js";import{WorkingCopyCapabilities as ai}from"../services/workingCopy/common/workingCopy.js";import{IFilesConfigurationService as di}from"../services/filesConfiguration/common/filesConfigurationService.js";import{Event as v}from"../../base/common/event.js";import{IRemoteAuthorityResolverService as ci}from"../../platform/remote/common/remoteAuthorityResolver.js";import{IEditorGroupsService as li}from"../services/editor/common/editorGroupsService.js";import{IDialogService as ui}from"../../platform/dialogs/common/dialogs.js";import{ILogService as vi}from"../../platform/log/common/log.js";import{IInstantiationService as hi}from"../../platform/instantiation/common/instantiation.js";import{whenEditorClosed as pi}from"../browser/editor.js";import{ISharedProcessService as mi}from"../../platform/ipc/electron-sandbox/services.js";import{IProgressService as fi,ProgressLocation as z}from"../../platform/progress/common/progress.js";import{toErrorMessage as Si}from"../../base/common/errorMessage.js";import{ILabelService as gi}from"../../platform/label/common/label.js";import{dirname as w}from"../../base/common/resources.js";import{IBannerService as wi}from"../services/banner/browser/bannerService.js";import{Codicon as T}from"../../base/common/codicons.js";import{IUriIdentityService as yi}from"../../platform/uriIdentity/common/uriIdentity.js";import{IPreferencesService as Ii}from"../services/preferences/common/preferences.js";import{IUtilityProcessWorkerWorkbenchService as bi}from"../services/utilityProcess/electron-sandbox/utilityProcessWorkerWorkbenchService.js";import{registerWindowDriver as Ei}from"../services/driver/electron-sandbox/driver.js";import{mainWindow as p}from"../../base/browser/window.js";import{BaseWindow as Ci}from"../browser/window.js";import{IHostService as Ai}from"../services/host/browser/host.js";import{IStatusbarService as Ri,ShowTooltipCommand as Wi,StatusbarAlignment as Li}from"../services/statusbar/browser/statusbar.js";import{ActionBar as se}from"../../base/browser/ui/actionbar/actionbar.js";import{ThemeIcon as N}from"../../base/common/themables.js";import{getWorkbenchContribution as ki}from"../common/contributions.js";import{DynamicWorkbenchSecurityConfiguration as Ti}from"../common/configuration.js";import{nativeHoverDelegate as ae}from"../../platform/hover/browser/hover.js";import{isESM as Di}from"../../base/common/amd.js";let y=class extends Ci{constructor(i,e,t,o,r,s,d,l,_,A,R,D,P,Pi,de,xi,Mi,Fi,Oi,Ui,Bi,Hi,Zi,zi,Ni,_i,Gi,Vi,qi,Ki,Qi,$i,ji,Yi,Ji,Xi,ce){super(p,void 0,ce,de);this.editorService=i;this.editorGroupService=e;this.configurationService=t;this.titleService=o;this.themeService=r;this.notificationService=s;this.commandService=d;this.keybindingService=l;this.telemetryService=_;this.workspaceEditingService=A;this.fileService=R;this.menuService=D;this.lifecycleService=P;this.integrityService=Pi;this.nativeEnvironmentService=de;this.accessibilityService=xi;this.contextService=Mi;this.openerService=Fi;this.nativeHostService=Oi;this.tunnelService=Ui;this.layoutService=Bi;this.workingCopyService=Hi;this.filesConfigurationService=Zi;this.productService=zi;this.remoteAuthorityResolverService=Ni;this.dialogService=_i;this.storageService=Gi;this.logService=Vi;this.instantiationService=qi;this.sharedProcessService=Ki;this.progressService=Qi;this.labelService=$i;this.bannerService=ji;this.uriIdentityService=Yi;this.preferencesService=Ji;this.utilityProcessWorkerWorkbenchService=Xi;this.registerListeners(),this.create()}customTitleContextMenuDisposable=this._register(new E);addFoldersScheduler=this._register(new O(()=>this.doAddFolders(),100));pendingFoldersToAdd=[];isDocumentedEdited=!1;registerListeners(){this._register(M(p,W.RESIZE,()=>this.layoutService.layout())),this._register(this.editorService.onDidActiveEditorChange(()=>this.updateTouchbarMenu()));for(const e of[W.DRAG_OVER,W.DROP])this._register(M(p.document.body,e,t=>{G.stop(t)}));c.on("vscode:runAction",async(e,t)=>{const o=t.args||[];if(t.from==="touchbar"){const r=this.editorService.activeEditor;if(r){const s=q.getOriginalUri(r,{supportSideBySide:K.PRIMARY});s&&o.push(s)}}else o.push({from:t.from});try{await this.commandService.executeCommand(t.id,...o),this.telemetryService.publicLog2("workbenchActionExecuted",{id:t.id,from:t.from})}catch(r){this.notificationService.error(r)}}),c.on("vscode:runKeybinding",(e,t)=>{const o=me();o&&this.keybindingService.dispatchByUserSettingsLabel(t.userSettingsLabel,o)}),c.on("vscode:reportError",(e,t)=>{t&&ve(JSON.parse(t))}),c.on("vscode:reportSharedProcessCrash",(e,t)=>{this.notificationService.prompt(g.Error,n("sharedProcessCrash","A shared background process terminated unexpectedly. Please restart the application to recover."),[{label:n("restart","Restart"),run:()=>this.nativeHostService.relaunch()}],{priority:k.URGENT})}),c.on("vscode:openFiles",(e,t)=>{this.onOpenFiles(t)}),c.on("vscode:addFolders",(e,t)=>{this.onAddFoldersRequest(t)}),c.on("vscode:showInfoMessage",(e,t)=>{this.notificationService.info(t)}),c.on("vscode:showResolveShellEnvError",(e,t)=>{this.notificationService.prompt(g.Error,t,[{label:n("restart","Restart"),run:()=>this.nativeHostService.relaunch()},{label:n("configure","Configure"),run:()=>this.preferencesService.openUserSettings({query:"application.shellEnvironmentResolutionTimeout"})},{label:n("learnMore","Learn More"),run:()=>this.openerService.open("https://go.microsoft.com/fwlink/?linkid=2149667")}])}),c.on("vscode:showCredentialsError",(e,t)=>{this.notificationService.prompt(g.Error,n("keychainWriteError","Writing login information to the keychain failed with error '{0}'.",t),[{label:n("troubleshooting","Troubleshooting Guide"),run:()=>this.openerService.open("https://go.microsoft.com/fwlink/?linkid=2190713")}])}),c.on("vscode:showTranslatedBuildWarning",()=>{this.notificationService.prompt(g.Warning,n("runningTranslated","You are running an emulated version of {0}. For better performance download the native arm64 version of {0} build for your machine.",this.productService.nameLong),[{label:n("downloadArmBuild","Download"),run:()=>{const e=this.productService.quality,t="https://code.visualstudio.com/docs/?dv=osx",o="https://code.visualstudio.com/docs/?dv=osx&build=insiders";this.openerService.open(e==="stable"?t:o)}}],{priority:k.URGENT})}),c.on("vscode:showArgvParseWarning",(e,t)=>{this.notificationService.prompt(g.Warning,n("showArgvParseWarning","The runtime arguments file 'argv.json' contains errors. Please correct them and restart."),[{label:n("showArgvParseWarningAction","Open File"),run:()=>this.editorService.openEditor({resource:this.nativeEnvironmentService.argvResource})}],{priority:k.URGENT})}),c.on("vscode:enterFullScreen",()=>Y(!0,p)),c.on("vscode:leaveFullScreen",()=>Y(!1,p)),c.on("vscode:openProxyAuthenticationDialog",async(e,t)=>{const o="window.rememberProxyCredentials",r=this.storageService.getBoolean(o,H.APPLICATION),s=await this.dialogService.input({type:"warning",message:n("proxyAuthRequired","Proxy Authentication Required"),primaryButton:n({key:"loginButton",comment:["&& denotes a mnemonic"]},"&&Log In"),inputs:[{placeholder:n("username","Username"),value:t.username},{placeholder:n("password","Password"),type:"password",value:t.password}],detail:n("proxyDetail","The proxy {0} requires a username and password.",`${t.authInfo.host}:${t.authInfo.port}`),checkbox:{label:n("rememberCredentials","Remember my credentials"),checked:r}});if(!s.confirmed||!s.values)c.send(t.replyChannel);else{s.checkboxChecked?this.storageService.store(o,!0,H.APPLICATION,je.MACHINE):this.storageService.remove(o,H.APPLICATION);const[d,l]=s.values;c.send(t.replyChannel,{username:d,password:l,remember:!!s.checkboxChecked})}}),c.on("vscode:accessibilitySupportChanged",(e,t)=>{this.accessibilityService.setAccessibilitySupport(t?oe.Enabled:oe.Disabled)}),c.on("vscode:configureAllowedUNCHost",async(e,t)=>{if(!ie)return;const o=new Set,r=this.configurationService.getValue("security.allowedUNCHosts")??[];if(Array.isArray(r))for(const s of r)typeof s=="string"&&o.add(s);o.has(t)||(o.add(t),await ki(Ti.ID).ready,this.configurationService.updateValue("security.allowedUNCHosts",[...o.values()],Ke.USER))}),c.on("vscode:disablePromptForProtocolHandling",(e,t)=>{const o=t==="local"?"security.promptForLocalFileProtocolHandling":"security.promptForRemoteFileProtocolHandling";this.configurationService.updateValue(o,!1)}),this._register(this.configurationService.onDidChangeConfiguration(e=>{e.affectsConfiguration("window.zoomLevel")||e.affectsConfiguration("window.zoomPerWindow")&&this.configurationService.getValue("window.zoomPerWindow")===!1?this.onDidChangeConfiguredWindowZoomLevel():(e.affectsConfiguration("keyboard.touchbar.enabled")||e.affectsConfiguration("keyboard.touchbar.ignored"))&&this.updateTouchbarMenu()})),this._register(Re(e=>this.handleOnDidChangeZoomLevel(e)));for(const e of this.editorGroupService.parts)this.createWindowZoomStatusEntry(e);this._register(this.editorGroupService.onDidCreateAuxiliaryEditorPart(e=>this.createWindowZoomStatusEntry(e))),this._register(v.debounce(this.editorService.onDidVisibleEditorsChange,()=>{},0,void 0,void 0,void 0,this._store)(()=>this.maybeCloseWindow()));const i=this.nativeEnvironmentService.filesToWait;if(i&&this.trackClosedWaitFiles(i.waitMarkerFileUri,B(i.paths.map(e=>e.fileUri))),S){for(const e of this.editorGroupService.parts)this.handleRepresentedFilename(e);this._register(this.editorGroupService.onDidCreateAuxiliaryEditorPart(e=>this.handleRepresentedFilename(e)))}S&&!j(this.configurationService)&&this._register(v.runAndSubscribe(this.layoutService.onDidAddContainer,({container:e,disposables:t})=>{const o=fe(e),r=o.vscodeWindowId,s=Ye(this.layoutService.getContainer(o,ri.TITLEBAR_PART));t.add(M(s,W.DBLCLICK,d=>{G.stop(d),this.nativeHostService.handleTitleDoubleClick({targetWindowId:r})}))},{container:this.layoutService.mainContainer,disposables:this._store})),this._register(this.workingCopyService.onDidChangeDirty(e=>{const t=e.isDirty();t&&!(e.capabilities&ai.Untitled)&&this.filesConfigurationService.hasShortAutoSaveDelay(e.resource)||this.updateDocumentEdited(t?!0:void 0)})),this.updateDocumentEdited(void 0),this._register(v.any(v.map(v.filter(this.nativeHostService.onDidMaximizeWindow,e=>!!V(e)),e=>({maximized:!0,windowId:e})),v.map(v.filter(this.nativeHostService.onDidUnmaximizeWindow,e=>!!V(e)),e=>({maximized:!1,windowId:e})))(e=>this.layoutService.updateWindowMaximizedState(F(e.windowId).window,e.maximized))),this.layoutService.updateWindowMaximizedState(p,this.nativeEnvironmentService.window.maximized??!1),this._register(this.layoutService.onDidChangePanelPosition(e=>this.onDidChangePanelPosition(ni(e)))),this.onDidChangePanelPosition(this.layoutService.getPanelPosition()),this._register(this.lifecycleService.onBeforeShutdown(e=>this.onBeforeShutdown(e))),this._register(this.lifecycleService.onBeforeShutdownError(e=>this.onBeforeShutdownError(e))),this._register(this.lifecycleService.onWillShutdown(e=>this.onWillShutdown(e)))}handleRepresentedFilename(i){const e=new E;v.once(i.onWillDispose)(()=>e.dispose());const t=this.editorGroupService.getScopedInstantiationService(i).invokeFunction(o=>o.get(Q));e.add(t.onDidActiveEditorChange(()=>this.updateRepresentedFilename(t,i.windowId)))}updateRepresentedFilename(i,e){const t=q.getOriginalUri(i.activeEditor,{supportSideBySide:K.PRIMARY,filterByScheme:re.file});this.nativeHostService.setRepresentedFilename(t?.fsPath??"",{targetWindowId:e}),e===p.vscodeWindowId&&this.provideCustomTitleContextMenu(t?.fsPath)}onBeforeShutdown({veto:i,reason:e}){if(e===u.CLOSE){const t=this.configurationService.getValue("window.confirmBeforeClose"),o=t==="always"||t==="keyboardOnly"&&pe.getInstance().isModifierPressed;if(o)return i((async()=>{let r=e;e===u.CLOSE&&!S&&await this.nativeHostService.getWindowCount()===1&&(r=u.QUIT);let s=!0;return o&&(s=await this.instantiationService.invokeFunction(d=>y.confirmOnShutdown(d,r))),s&&this.progressOnBeforeShutdown(e),!s})(),"veto.confirmBeforeClose")}this.progressOnBeforeShutdown(e)}progressOnBeforeShutdown(i){this.progressService.withProgress({location:z.Window,delay:800,title:this.toShutdownLabel(i,!1)},()=>v.toPromise(v.any(this.lifecycleService.onWillShutdown,this.lifecycleService.onShutdownVeto,this.dialogService.onWillShowDialog)))}onBeforeShutdownError({error:i,reason:e}){this.dialogService.error(this.toShutdownLabel(e,!0),n("shutdownErrorDetail","Error: {0}",Si(i)))}onWillShutdown({reason:i,force:e,joiners:t}){const o=new O(()=>{const r=t();this.progressService.withProgress({location:z.Dialog,buttons:[this.toForceShutdownLabel(i)],cancellable:!1,sticky:!0,title:this.toShutdownLabel(i,!1),detail:r.length>0?n("willShutdownDetail",`The following operations are still running: 
{0}`,r.map(s=>`- ${s.label}`).join(`
`)):void 0},()=>v.toPromise(this.lifecycleService.onDidShutdown),()=>{e()})},1200);o.schedule(),v.once(this.lifecycleService.onDidShutdown)(()=>o.dispose())}toShutdownLabel(i,e){if(e)switch(i){case u.CLOSE:return n("shutdownErrorClose","An unexpected error prevented the window to close");case u.QUIT:return n("shutdownErrorQuit","An unexpected error prevented the application to quit");case u.RELOAD:return n("shutdownErrorReload","An unexpected error prevented the window to reload");case u.LOAD:return n("shutdownErrorLoad","An unexpected error prevented to change the workspace")}switch(i){case u.CLOSE:return n("shutdownTitleClose","Closing the window is taking a bit longer...");case u.QUIT:return n("shutdownTitleQuit","Quitting the application is taking a bit longer...");case u.RELOAD:return n("shutdownTitleReload","Reloading the window is taking a bit longer...");case u.LOAD:return n("shutdownTitleLoad","Changing the workspace is taking a bit longer...")}}toForceShutdownLabel(i){switch(i){case u.CLOSE:return n("shutdownForceClose","Close Anyway");case u.QUIT:return n("shutdownForceQuit","Quit Anyway");case u.RELOAD:return n("shutdownForceReload","Reload Anyway");case u.LOAD:return n("shutdownForceLoad","Change Anyway")}}updateDocumentEdited(i){let e;typeof i=="boolean"?e=i:e=this.workingCopyService.hasDirty,(!this.isDocumentedEdited&&e||this.isDocumentedEdited&&!e)&&(this.isDocumentedEdited=e,this.nativeHostService.setDocumentEdited(e))}getWindowMinimumWidth(i=this.layoutService.getPanelPosition()){return i===ne.LEFT||i===ne.RIGHT?$.WIDTH_WITH_VERTICAL_PANEL:$.WIDTH}onDidChangePanelPosition(i){const e=this.getWindowMinimumWidth(i);this.nativeHostService.setMinimumSize(e,void 0)}maybeCloseWindow(){if(this.configurationService.getValue("window.closeWhenEmpty")||this.nativeEnvironmentService.args.wait)for(const e of this.editorGroupService.parts)e.groups.some(t=>!t.isEmpty)||e===this.editorGroupService.mainPart&&(this.contextService.getWorkbenchState()!==Ve.EMPTY||this.environmentService.isExtensionDevelopment||this.editorService.visibleEditors.length>0)||(e===this.editorGroupService.mainPart?this.nativeHostService.closeWindow():e.removeGroup(e.activeGroup))}provideCustomTitleContextMenu(i){if(this.customTitleContextMenuDisposable.clear(),!i||j(this.configurationService))return;const e=i.split(Z.sep);for(let t=e.length;t>0;t--){const o=t===e.length;let r=t;o||r++;const s=h.file(e.slice(0,r).join(Z.sep));let d;o?d=this.labelService.getUriBasenameLabel(s):d=this.labelService.getUriBasenameLabel(w(s));const l=`workbench.action.revealPathInFinder${t}`;this.customTitleContextMenuDisposable.add(Le.registerCommand(l,()=>this.nativeHostService.showItemInFolder(s.fsPath))),this.customTitleContextMenuDisposable.add(xe.appendMenuItem(X.TitleBarTitleContext,{command:{id:l,title:d||Z.sep},order:-t,group:"1_file"}))}}create(){this.setupOpenHandlers(),this.lifecycleService.when(U.Ready).then(()=>this.nativeHostService.notifyReady()),this.lifecycleService.when(U.Restored).then(()=>{this.sharedProcessService.notifyRestored(),this.utilityProcessWorkerWorkbenchService.notifyRestored()}),this.handleWarnings(),this.updateTouchbarMenu(),this.environmentService.enableSmokeTestDriver&&this.setupDriver()}async handleWarnings(){if(!Di&&typeof require.hasDependencyCycle=="function"&&require.hasDependencyCycle()&&(He?(this.logService.error("Error: There is a dependency cycle in the AMD modules that needs to be resolved!"),this.nativeHostService.exit(37)):(this.dialogService.error(n("loaderCycle","There is a dependency cycle in the AMD modules that needs to be resolved!")),this.nativeHostService.openDevTools())),await this.lifecycleService.when(U.Restored),(async()=>{const e=await this.nativeHostService.isAdmin(),{isPure:t}=await this.integrityService.isPure();this.titleService.updateProperties({isPure:t,isAdmin:e}),e&&!ie&&this.notificationService.warn(n("runningAsRoot","It is not recommended to run {0} as root user.",this.productService.nameShort))})(),this.environmentService.isBuilt){let e;S?e=w(w(w(h.file(this.nativeEnvironmentService.appRoot)))):e=w(w(h.file(this.nativeEnvironmentService.appRoot)));for(const t of this.contextService.getWorkspace().folders)if(this.uriIdentityService.extUri.isEqualOrParent(t.uri,e)){this.bannerService.show({id:"appRootWarning.banner",message:n("appRootWarning.banner","Files you store within the installation folder ('{0}') may be OVERWRITTEN or DELETED IRREVERSIBLY without warning at update time.",this.labelService.getUriLabel(e)),icon:T.warning});break}}if(S){const e=this.nativeEnvironmentService.os.release.split(".")[0],t=new Map([["17","macOS High Sierra"],["18","macOS Mojave"]]);if(t.has(e)){const o=n("macoseolmessage","{0} on {1} will soon stop receiving updates. Consider upgrading your macOS version.",this.productService.nameLong,t.get(e));this.notificationService.prompt(g.Warning,o,[{label:n("learnMore","Learn More"),run:()=>this.openerService.open(h.parse("https://aka.ms/vscode-faq-old-macOS"))}],{neverShowAgain:{id:"macoseol",isSecondary:!0,scope:Ne.APPLICATION},priority:k.URGENT,sticky:!0})}}const i=ke.shellEnv();this.progressService.withProgress({title:n("resolveShellEnvironment","Resolving shell environment..."),location:z.Window,delay:1600,buttons:[n("learnMore","Learn More")]},()=>i,()=>this.openerService.open("https://go.microsoft.com/fwlink/?linkid=2149667"))}setupDriver(){const i=this;let e=!1;Ei(this.instantiationService,{async exitApplication(){if(e){i.logService.info("[driver] not handling exitApplication() due to pending quit() call");return}return i.logService.info("[driver] handling exitApplication()"),e=!0,i.nativeHostService.quit()}})}async openTunnel(i,e){const t=this.environmentService.remoteAuthority,o=t?{getAddress:async()=>(await this.remoteAuthorityResolverService.resolveAuthority(t)).authority}:void 0,r=await this.tunnelService.getExistingTunnel(i,e);return!r||typeof r=="string"?this.tunnelService.openTunnel(o,i,e):r}async resolveExternalUri(i,e){let t;if(e?.allowTunneling){const o=ii(i),r=ti(i);if(r&&(t=await this.openTunnel(r.address,r.port),t&&typeof t!="string")){if(t.tunnelRemotePort!==r.port)t.dispose(),t=void 0;else if(!o){const s=t;return{resolved:i,dispose:()=>s.dispose()}}}if(o){const s=await this.openTunnel(o.address,o.port);if(s&&typeof s!="string"){const d=h.parse(s.localAddress);return{resolved:d.scheme.startsWith(i.scheme)?d:i.with({authority:s.localAddress}),dispose(){s.dispose(),t&&typeof t!="string"&&t.dispose()}}}}}if(!e?.openExternal&&await this.fileService.canHandleResource(i))return{resolved:h.from({scheme:this.productService.urlProtocol,path:"workspace",query:i.toString()}),dispose(){}}}setupOpenHandlers(){this.openerService.setDefaultExternalOpener({openExternal:async i=>{if(!await this.nativeHostService.openExternal(i,this.configurationService.getValue("workbench.externalBrowser"))){const t=h.parse(i);t.scheme===re.file&&await this.nativeHostService.showItemInFolder(t.fsPath)}return!0}}),this.openerService.registerExternalUriResolver({resolveExternalUri:async(i,e)=>this.resolveExternalUri(i,e)})}touchBarMenu;touchBarDisposables=this._register(new E);lastInstalledTouchedBar;updateTouchbarMenu(){if(!S)return;this.touchBarDisposables.clear(),this.touchBarMenu=void 0;const i=this.touchBarDisposables.add(new O(()=>this.doUpdateTouchbarMenu(i),300));i.schedule()}doUpdateTouchbarMenu(i){if(!this.touchBarMenu){const l=this.editorService.activeEditorPane?.scopedContextKeyService||this.editorGroupService.activeGroup.scopedContextKeyService;this.touchBarMenu=this.menuService.createMenu(X.TouchBarContext,l),this.touchBarDisposables.add(this.touchBarMenu),this.touchBarDisposables.add(this.touchBarMenu.onDidChange(()=>i.schedule()))}const e=[],t=this.configurationService.getValue("keyboard.touchbar.enabled")===!1,o=this.configurationService.getValue("keyboard.touchbar.ignored"),r=Array.isArray(o)?o:[];Me(this.touchBarMenu,void 0,e);const s=[];let d=[];if(!t){for(const l of e)if(l instanceof Pe){if(r.indexOf(l.item.id)>=0)continue;d.push(l.item)}else l instanceof ge&&(d.length&&s.push(d),d=[]);d.length&&s.push(d)}he(this.lastInstalledTouchedBar,s)||(this.lastInstalledTouchedBar=s,this.nativeHostService.updateTouchBar(s))}onAddFoldersRequest(i){this.pendingFoldersToAdd.push(...i.foldersToAdd.map(e=>h.revive(e))),this.addFoldersScheduler.isScheduled()||this.addFoldersScheduler.schedule()}doAddFolders(){const i=[];for(const e of this.pendingFoldersToAdd)i.push({uri:e});this.pendingFoldersToAdd=[],this.workspaceEditingService.addFolders(i)}async onOpenFiles(i){const e=!!(i.filesToDiff&&i.filesToDiff.length===2),t=!!(i.filesToMerge&&i.filesToMerge.length===4),o=B(await ye(t?i.filesToMerge:e?i.filesToDiff:i.filesToOpenOrCreate,this.fileService,this.logService));if(o.length){const r=await this.openResources(o,e,t);if(i.filesToWait)return r.length?this.trackClosedWaitFiles(h.revive(i.filesToWait.waitMarkerFileUri),B(i.filesToWait.paths.map(s=>h.revive(s.fileUri)))):this.fileService.del(h.revive(i.filesToWait.waitMarkerFileUri))}}async trackClosedWaitFiles(i,e){await this.instantiationService.invokeFunction(t=>pi(t,e)),await this.fileService.del(i)}async openResources(i,e,t){const o=[];if(t&&f(i[0])&&f(i[1])&&f(i[2])&&f(i[3])){const r={input1:{resource:i[0].resource},input2:{resource:i[1].resource},base:{resource:i[2].resource},result:{resource:i[3].resource},options:{pinned:!0}};o.push(r)}else if(e&&f(i[0])&&f(i[1])){const r={original:{resource:i[0].resource},modified:{resource:i[1].resource},options:{pinned:!0}};o.push(r)}else o.push(...i);return this.editorService.openEditors(o,void 0,{validateTrust:!0})}mapWindowIdToZoomStatusEntry=new Map;configuredWindowZoomLevel=this.resolveConfiguredWindowZoomLevel();resolveConfiguredWindowZoomLevel(){const i=this.configurationService.getValue("window.zoomLevel");return typeof i=="number"?i:0}handleOnDidChangeZoomLevel(i){if(this.updateWindowZoomStatusEntry(i),i===p.vscodeWindowId){const e=L(p);let t;this.configuredWindowZoomLevel!==e&&(t=e),c.invoke("vscode:notifyZoomLevel",t)}}createWindowZoomStatusEntry(i){const e=new E;v.once(i.onWillDispose)(()=>e.dispose());const t=this.editorGroupService.getScopedInstantiationService(i);this.mapWindowIdToZoomStatusEntry.set(i.windowId,e.add(t.createInstance(C))),e.add(ee(()=>this.mapWindowIdToZoomStatusEntry.delete(i.windowId))),this.updateWindowZoomStatusEntry(i.windowId)}updateWindowZoomStatusEntry(i){const e=F(i),t=this.mapWindowIdToZoomStatusEntry.get(i);if(t&&e){const o=L(e.window);let r;o<this.configuredWindowZoomLevel?r="$(zoom-out)":o>this.configuredWindowZoomLevel&&(r="$(zoom-in)"),t.updateZoomEntry(r??!1,i)}}onDidChangeConfiguredWindowZoomLevel(){this.configuredWindowZoomLevel=this.resolveConfiguredWindowZoomLevel();let i=!1;for(const{window:e}of Se())if(L(e)!==this.configuredWindowZoomLevel){i=!0;break}i&&Ae(this.configuredWindowZoomLevel,Ce.ALL_WINDOWS);for(const[e]of this.mapWindowIdToZoomStatusEntry)this.updateWindowZoomStatusEntry(e)}dispose(){super.dispose();for(const[,i]of this.mapWindowIdToZoomStatusEntry)i.dispose()}};y=x([a(0,Q),a(1,li),a(2,Qe),a(3,be),a(4,Ee),a(5,ze),a(6,J),a(7,te),a(8,Ie),a(9,Te),a(10,we),a(11,De),a(12,Ue),a(13,Be),a(14,_e),a(15,Ge),a(16,qe),a(17,Je),a(18,Xe),a(19,ei),a(20,oi),a(21,si),a(22,di),a(23,Ze),a(24,ci),a(25,ui),a(26,$e),a(27,vi),a(28,hi),a(29,mi),a(30,fi),a(31,gi),a(32,wi),a(33,yi),a(34,Ii),a(35,bi),a(36,Ai)],y);let C=class extends Fe{constructor(i,e,t){super();this.statusbarService=i;this.commandService=e;this.keybindingService=t}disposable=this._register(new Oe);zoomLevelLabel=void 0;updateZoomEntry(i,e){typeof i=="string"?(this.disposable.value||this.createZoomEntry(i),this.updateZoomLevelLabel(e)):this.disposable.clear()}createZoomEntry(i){const e=new E;this.disposable.value=e;const t=document.createElement("div");t.classList.add("zoom-status");const o=document.createElement("div");o.classList.add("zoom-status-left"),t.appendChild(o);const r=e.add(new b("workbench.action.zoomOut",n("zoomOut","Zoom Out"),N.asClassName(T.remove),!0,()=>this.commandService.executeCommand(r.id))),s=e.add(new b("workbench.action.zoomIn",n("zoomIn","Zoom In"),N.asClassName(T.plus),!0,()=>this.commandService.executeCommand(s.id))),d=e.add(new b("workbench.action.zoomReset",n("zoomReset","Reset"),void 0,!0,()=>this.commandService.executeCommand(d.id)));d.tooltip=n("zoomResetLabel","{0} ({1})",d.label,this.keybindingService.lookupKeybinding(d.id)?.getLabel());const l=e.add(new b("workbench.action.openSettings",n("zoomSettings","Settings"),N.asClassName(T.settingsGear),!0,()=>this.commandService.executeCommand(l.id,"window.zoom"))),_=e.add(new b("zoomLabel",void 0,void 0,!1));this.zoomLevelLabel=_,e.add(ee(()=>this.zoomLevelLabel=void 0));const A=e.add(new se(o,{hoverDelegate:ae}));A.push(r,{icon:!0,label:!1,keybinding:this.keybindingService.lookupKeybinding(r.id)?.getLabel()}),A.push(this.zoomLevelLabel,{icon:!1,label:!0}),A.push(s,{icon:!0,label:!1,keybinding:this.keybindingService.lookupKeybinding(s.id)?.getLabel()});const R=document.createElement("div");R.classList.add("zoom-status-right"),t.appendChild(R);const D=e.add(new se(R,{hoverDelegate:ae}));D.push(d,{icon:!1,label:!0}),D.push(l,{icon:!0,label:!1,keybinding:this.keybindingService.lookupKeybinding(l.id)?.getLabel()});const P=n("status.windowZoom","Window Zoom");e.add(this.statusbarService.addEntry({name:P,text:i,tooltip:t,ariaLabel:P,command:Wi,kind:"prominent"},"status.windowZoom",Li.RIGHT,102))}updateZoomLevelLabel(i){if(this.zoomLevelLabel){const e=F(i,!0).window,t=Math.round(We(e)*100),o=L(e);this.zoomLevelLabel.label=`${o}`,this.zoomLevelLabel.tooltip=n("zoomNumber","Zoom Level: {0} ({1}%)",o,t)}}};C=x([a(0,Ri),a(1,J),a(2,te)],C);export{y as NativeWindow};
