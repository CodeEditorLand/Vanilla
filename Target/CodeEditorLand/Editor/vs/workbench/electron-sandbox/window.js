var le=Object.defineProperty;var ue=Object.getOwnPropertyDescriptor;var x=(I,m,i,e)=>{for(var t=e>1?void 0:e?ue(m,i):m,o=I.length-1,r;o>=0;o--)(r=I[o])&&(t=(e?r(m,i,t):r(t))||t);return e&&t&&le(m,i,t),t},a=(I,m)=>(i,e)=>m(i,e,I);import"vs/css!./media/window";import{getZoomFactor as ve,getZoomLevel as W,onDidChangeZoomLevel as he,setFullscreen as G}from"../../../vs/base/browser/browser.js";import{addDisposableListener as M,EventHelper as V,EventType as L,getActiveElement as pe,getWindow as me,getWindowById as F,getWindows as fe,hasWindow as q,ModifierKeyEmitter as Se}from"../../../vs/base/browser/dom.js";import{ActionBar as K}from"../../../vs/base/browser/ui/actionbar/actionbar.js";import{mainWindow as p}from"../../../vs/base/browser/window.js";import{Action as b,Separator as ge}from"../../../vs/base/common/actions.js";import{isESM as we}from"../../../vs/base/common/amd.js";import{coalesce as O}from"../../../vs/base/common/arrays.js";import{RunOnceScheduler as U}from"../../../vs/base/common/async.js";import{Codicon as k}from"../../../vs/base/common/codicons.js";import{toErrorMessage as ye}from"../../../vs/base/common/errorMessage.js";import{onUnexpectedError as Ie}from"../../../vs/base/common/errors.js";import{Event as v}from"../../../vs/base/common/event.js";import{Disposable as be,DisposableStore as E,MutableDisposable as Ee,toDisposable as Q}from"../../../vs/base/common/lifecycle.js";import{Schemas as $}from"../../../vs/base/common/network.js";import{equals as Ce}from"../../../vs/base/common/objects.js";import{posix as B}from"../../../vs/base/common/path.js";import{isCI as Re,isMacintosh as f,isWindows as j}from"../../../vs/base/common/platform.js";import{dirname as S}from"../../../vs/base/common/resources.js";import{ThemeIcon as H}from"../../../vs/base/common/themables.js";import{assertIsDefined as Ae}from"../../../vs/base/common/types.js";import{URI as h}from"../../../vs/base/common/uri.js";import"../../../vs/base/parts/sandbox/electron-sandbox/electronTypes.js";import{ipcRenderer as c,process as We}from"../../../vs/base/parts/sandbox/electron-sandbox/globals.js";import{localize as n}from"../../../vs/nls.js";import{AccessibilitySupport as Y,IAccessibilityService as Le}from"../../../vs/platform/accessibility/common/accessibility.js";import"../../../vs/platform/action/common/action.js";import{createAndFillInActionBarActions as ke}from"../../../vs/platform/actions/browser/menuEntryActionViewItem.js";import{IMenuService as Te,MenuId as J,MenuItemAction as De,MenuRegistry as Pe}from"../../../vs/platform/actions/common/actions.js";import{CommandsRegistry as xe,ICommandService as X}from"../../../vs/platform/commands/common/commands.js";import{ConfigurationTarget as Me,IConfigurationService as Fe}from"../../../vs/platform/configuration/common/configuration.js";import{IDialogService as Oe}from"../../../vs/platform/dialogs/common/dialogs.js";import"../../../vs/platform/editor/common/editor.js";import{IFileService as Ue}from"../../../vs/platform/files/common/files.js";import{nativeHoverDelegate as ee}from"../../../vs/platform/hover/browser/hover.js";import{IInstantiationService as Be}from"../../../vs/platform/instantiation/common/instantiation.js";import{ISharedProcessService as He}from"../../../vs/platform/ipc/electron-sandbox/services.js";import{IKeybindingService as ie}from"../../../vs/platform/keybinding/common/keybinding.js";import{ILabelService as Ze}from"../../../vs/platform/label/common/label.js";import{ILogService as ze}from"../../../vs/platform/log/common/log.js";import{INativeHostService as Ne}from"../../../vs/platform/native/common/native.js";import{INotificationService as _e,NeverShowAgainScope as Ge,NotificationPriority as T,Severity as g}from"../../../vs/platform/notification/common/notification.js";import{IOpenerService as Ve}from"../../../vs/platform/opener/common/opener.js";import{IProductService as qe}from"../../../vs/platform/product/common/productService.js";import{IProgressService as Ke,ProgressLocation as Z}from"../../../vs/platform/progress/common/progress.js";import"../../../vs/platform/remote/common/remoteAgentConnection.js";import{IRemoteAuthorityResolverService as Qe}from"../../../vs/platform/remote/common/remoteAuthorityResolver.js";import{IStorageService as $e,StorageScope as z,StorageTarget as je}from"../../../vs/platform/storage/common/storage.js";import{ITelemetryService as Ye}from"../../../vs/platform/telemetry/common/telemetry.js";import{extractLocalHostUriMetaDataForPortMapping as Je,extractQueryLocalHostUriMetaDataForPortMapping as Xe,ITunnelService as ei}from"../../../vs/platform/tunnel/common/tunnel.js";import{IUriIdentityService as ii}from"../../../vs/platform/uriIdentity/common/uriIdentity.js";import{hasNativeTitlebar as te,WindowMinimumSize as oe}from"../../../vs/platform/window/common/window.js";import{applyZoom as ti,ApplyZoomTarget as oi}from"../../../vs/platform/window/electron-sandbox/window.js";import{IWorkspaceContextService as ri,WorkbenchState as ni}from"../../../vs/platform/workspace/common/workspace.js";import"../../../vs/platform/workspaces/common/workspaces.js";import{whenEditorClosed as si}from"../../../vs/workbench/browser/editor.js";import{BaseWindow as ai}from"../../../vs/workbench/browser/window.js";import{DynamicWorkbenchSecurityConfiguration as di}from"../../../vs/workbench/common/configuration.js";import{getWorkbenchContribution as ci}from"../../../vs/workbench/common/contributions.js";import{EditorResourceAccessor as re,isResourceEditorInput as w,pathsToEditors as li,SideBySideEditor as ne}from"../../../vs/workbench/common/editor.js";import{IBannerService as ui}from"../../../vs/workbench/services/banner/browser/bannerService.js";import{registerWindowDriver as vi}from"../../../vs/workbench/services/driver/electron-sandbox/driver.js";import{IEditorGroupsService as hi}from"../../../vs/workbench/services/editor/common/editorGroupsService.js";import{IEditorService as se}from"../../../vs/workbench/services/editor/common/editorService.js";import{INativeWorkbenchEnvironmentService as pi}from"../../../vs/workbench/services/environment/electron-sandbox/environmentService.js";import{IFilesConfigurationService as mi}from"../../../vs/workbench/services/filesConfiguration/common/filesConfigurationService.js";import{IHostService as fi}from"../../../vs/workbench/services/host/browser/host.js";import{IIntegrityService as Si}from"../../../vs/workbench/services/integrity/common/integrity.js";import{IWorkbenchLayoutService as gi,Parts as wi,Position as ae,positionFromString as yi}from"../../../vs/workbench/services/layout/browser/layoutService.js";import{ILifecycleService as Ii,LifecyclePhase as N,ShutdownReason as u}from"../../../vs/workbench/services/lifecycle/common/lifecycle.js";import{IPreferencesService as bi}from"../../../vs/workbench/services/preferences/common/preferences.js";import{IStatusbarService as Ei,ShowTooltipCommand as Ci,StatusbarAlignment as Ri}from"../../../vs/workbench/services/statusbar/browser/statusbar.js";import{IWorkbenchThemeService as Ai}from"../../../vs/workbench/services/themes/common/workbenchThemeService.js";import{ITitleService as Wi}from"../../../vs/workbench/services/title/browser/titleService.js";import{IUtilityProcessWorkerWorkbenchService as Li}from"../../../vs/workbench/services/utilityProcess/electron-sandbox/utilityProcessWorkerWorkbenchService.js";import{WorkingCopyCapabilities as ki}from"../../../vs/workbench/services/workingCopy/common/workingCopy.js";import{IWorkingCopyService as Ti}from"../../../vs/workbench/services/workingCopy/common/workingCopyService.js";import{IWorkspaceEditingService as Di}from"../../../vs/workbench/services/workspaces/common/workspaceEditing.js";let y=class extends ai{constructor(i,e,t,o,r,s,d,l,_,R,A,D,P,Pi,de,xi,Mi,Fi,Oi,Ui,Bi,Hi,Zi,zi,Ni,_i,Gi,Vi,qi,Ki,Qi,$i,ji,Yi,Ji,Xi,ce){super(p,void 0,ce,de);this.editorService=i;this.editorGroupService=e;this.configurationService=t;this.titleService=o;this.themeService=r;this.notificationService=s;this.commandService=d;this.keybindingService=l;this.telemetryService=_;this.workspaceEditingService=R;this.fileService=A;this.menuService=D;this.lifecycleService=P;this.integrityService=Pi;this.nativeEnvironmentService=de;this.accessibilityService=xi;this.contextService=Mi;this.openerService=Fi;this.nativeHostService=Oi;this.tunnelService=Ui;this.layoutService=Bi;this.workingCopyService=Hi;this.filesConfigurationService=Zi;this.productService=zi;this.remoteAuthorityResolverService=Ni;this.dialogService=_i;this.storageService=Gi;this.logService=Vi;this.instantiationService=qi;this.sharedProcessService=Ki;this.progressService=Qi;this.labelService=$i;this.bannerService=ji;this.uriIdentityService=Yi;this.preferencesService=Ji;this.utilityProcessWorkerWorkbenchService=Xi;this.registerListeners(),this.create()}customTitleContextMenuDisposable=this._register(new E);addFoldersScheduler=this._register(new U(()=>this.doAddFolders(),100));pendingFoldersToAdd=[];isDocumentedEdited=!1;registerListeners(){this._register(M(p,L.RESIZE,()=>this.layoutService.layout())),this._register(this.editorService.onDidActiveEditorChange(()=>this.updateTouchbarMenu()));for(const e of[L.DRAG_OVER,L.DROP])this._register(M(p.document.body,e,t=>{V.stop(t)}));c.on("vscode:runAction",async(e,t)=>{const o=t.args||[];if(t.from==="touchbar"){const r=this.editorService.activeEditor;if(r){const s=re.getOriginalUri(r,{supportSideBySide:ne.PRIMARY});s&&o.push(s)}}else o.push({from:t.from});try{await this.commandService.executeCommand(t.id,...o),this.telemetryService.publicLog2("workbenchActionExecuted",{id:t.id,from:t.from})}catch(r){this.notificationService.error(r)}}),c.on("vscode:runKeybinding",(e,t)=>{const o=pe();o&&this.keybindingService.dispatchByUserSettingsLabel(t.userSettingsLabel,o)}),c.on("vscode:reportError",(e,t)=>{t&&Ie(JSON.parse(t))}),c.on("vscode:reportSharedProcessCrash",(e,t)=>{this.notificationService.prompt(g.Error,n("sharedProcessCrash","A shared background process terminated unexpectedly. Please restart the application to recover."),[{label:n("restart","Restart"),run:()=>this.nativeHostService.relaunch()}],{priority:T.URGENT})}),c.on("vscode:openFiles",(e,t)=>{this.onOpenFiles(t)}),c.on("vscode:addFolders",(e,t)=>{this.onAddFoldersRequest(t)}),c.on("vscode:showInfoMessage",(e,t)=>{this.notificationService.info(t)}),c.on("vscode:showResolveShellEnvError",(e,t)=>{this.notificationService.prompt(g.Error,t,[{label:n("restart","Restart"),run:()=>this.nativeHostService.relaunch()},{label:n("configure","Configure"),run:()=>this.preferencesService.openUserSettings({query:"application.shellEnvironmentResolutionTimeout"})},{label:n("learnMore","Learn More"),run:()=>this.openerService.open("https://go.microsoft.com/fwlink/?linkid=2149667")}])}),c.on("vscode:showCredentialsError",(e,t)=>{this.notificationService.prompt(g.Error,n("keychainWriteError","Writing login information to the keychain failed with error '{0}'.",t),[{label:n("troubleshooting","Troubleshooting Guide"),run:()=>this.openerService.open("https://go.microsoft.com/fwlink/?linkid=2190713")}])}),c.on("vscode:showTranslatedBuildWarning",()=>{this.notificationService.prompt(g.Warning,n("runningTranslated","You are running an emulated version of {0}. For better performance download the native arm64 version of {0} build for your machine.",this.productService.nameLong),[{label:n("downloadArmBuild","Download"),run:()=>{const e=this.productService.quality;this.openerService.open(e==="stable"?"https://code.visualstudio.com/docs/?dv=osx":"https://code.visualstudio.com/docs/?dv=osx&build=insiders")}}],{priority:T.URGENT})}),c.on("vscode:showArgvParseWarning",(e,t)=>{this.notificationService.prompt(g.Warning,n("showArgvParseWarning","The runtime arguments file 'argv.json' contains errors. Please correct them and restart."),[{label:n("showArgvParseWarningAction","Open File"),run:()=>this.editorService.openEditor({resource:this.nativeEnvironmentService.argvResource})}],{priority:T.URGENT})}),c.on("vscode:enterFullScreen",()=>G(!0,p)),c.on("vscode:leaveFullScreen",()=>G(!1,p)),c.on("vscode:openProxyAuthenticationDialog",async(e,t)=>{const o="window.rememberProxyCredentials",r=this.storageService.getBoolean(o,z.APPLICATION),s=await this.dialogService.input({type:"warning",message:n("proxyAuthRequired","Proxy Authentication Required"),primaryButton:n({key:"loginButton",comment:["&& denotes a mnemonic"]},"&&Log In"),inputs:[{placeholder:n("username","Username"),value:t.username},{placeholder:n("password","Password"),type:"password",value:t.password}],detail:n("proxyDetail","The proxy {0} requires a username and password.",`${t.authInfo.host}:${t.authInfo.port}`),checkbox:{label:n("rememberCredentials","Remember my credentials"),checked:r}});if(!s.confirmed||!s.values)c.send(t.replyChannel);else{s.checkboxChecked?this.storageService.store(o,!0,z.APPLICATION,je.MACHINE):this.storageService.remove(o,z.APPLICATION);const[d,l]=s.values;c.send(t.replyChannel,{username:d,password:l,remember:!!s.checkboxChecked})}}),c.on("vscode:accessibilitySupportChanged",(e,t)=>{this.accessibilityService.setAccessibilitySupport(t?Y.Enabled:Y.Disabled)}),c.on("vscode:configureAllowedUNCHost",async(e,t)=>{if(!j)return;const o=new Set,r=this.configurationService.getValue("security.allowedUNCHosts")??[];if(Array.isArray(r))for(const s of r)typeof s=="string"&&o.add(s);o.has(t)||(o.add(t),await ci(di.ID).ready,this.configurationService.updateValue("security.allowedUNCHosts",[...o.values()],Me.USER))}),c.on("vscode:disablePromptForProtocolHandling",(e,t)=>{const o=t==="local"?"security.promptForLocalFileProtocolHandling":"security.promptForRemoteFileProtocolHandling";this.configurationService.updateValue(o,!1)}),this._register(this.configurationService.onDidChangeConfiguration(e=>{e.affectsConfiguration("window.zoomLevel")||e.affectsConfiguration("window.zoomPerWindow")&&this.configurationService.getValue("window.zoomPerWindow")===!1?this.onDidChangeConfiguredWindowZoomLevel():(e.affectsConfiguration("keyboard.touchbar.enabled")||e.affectsConfiguration("keyboard.touchbar.ignored"))&&this.updateTouchbarMenu()})),this._register(he(e=>this.handleOnDidChangeZoomLevel(e)));for(const e of this.editorGroupService.parts)this.createWindowZoomStatusEntry(e);this._register(this.editorGroupService.onDidCreateAuxiliaryEditorPart(e=>this.createWindowZoomStatusEntry(e))),this._register(v.debounce(this.editorService.onDidVisibleEditorsChange,()=>{},0,void 0,void 0,void 0,this._store)(()=>this.maybeCloseWindow()));const i=this.nativeEnvironmentService.filesToWait;if(i&&this.trackClosedWaitFiles(i.waitMarkerFileUri,O(i.paths.map(e=>e.fileUri))),f){for(const e of this.editorGroupService.parts)this.handleRepresentedFilename(e);this._register(this.editorGroupService.onDidCreateAuxiliaryEditorPart(e=>this.handleRepresentedFilename(e)))}f&&!te(this.configurationService)&&this._register(v.runAndSubscribe(this.layoutService.onDidAddContainer,({container:e,disposables:t})=>{const o=me(e),r=o.vscodeWindowId,s=Ae(this.layoutService.getContainer(o,wi.TITLEBAR_PART));t.add(M(s,L.DBLCLICK,d=>{V.stop(d),this.nativeHostService.handleTitleDoubleClick({targetWindowId:r})}))},{container:this.layoutService.mainContainer,disposables:this._store})),this._register(this.workingCopyService.onDidChangeDirty(e=>{const t=e.isDirty();t&&!(e.capabilities&ki.Untitled)&&this.filesConfigurationService.hasShortAutoSaveDelay(e.resource)||this.updateDocumentEdited(t?!0:void 0)})),this.updateDocumentEdited(void 0),this._register(v.any(v.map(v.filter(this.nativeHostService.onDidMaximizeWindow,e=>!!q(e)),e=>({maximized:!0,windowId:e})),v.map(v.filter(this.nativeHostService.onDidUnmaximizeWindow,e=>!!q(e)),e=>({maximized:!1,windowId:e})))(e=>this.layoutService.updateWindowMaximizedState(F(e.windowId).window,e.maximized))),this.layoutService.updateWindowMaximizedState(p,this.nativeEnvironmentService.window.maximized??!1),this._register(this.layoutService.onDidChangePanelPosition(e=>this.onDidChangePanelPosition(yi(e)))),this.onDidChangePanelPosition(this.layoutService.getPanelPosition()),this._register(this.lifecycleService.onBeforeShutdown(e=>this.onBeforeShutdown(e))),this._register(this.lifecycleService.onBeforeShutdownError(e=>this.onBeforeShutdownError(e))),this._register(this.lifecycleService.onWillShutdown(e=>this.onWillShutdown(e)))}handleRepresentedFilename(i){const e=new E;v.once(i.onWillDispose)(()=>e.dispose());const t=this.editorGroupService.getScopedInstantiationService(i).invokeFunction(o=>o.get(se));e.add(t.onDidActiveEditorChange(()=>this.updateRepresentedFilename(t,i.windowId)))}updateRepresentedFilename(i,e){const t=re.getOriginalUri(i.activeEditor,{supportSideBySide:ne.PRIMARY,filterByScheme:$.file});this.nativeHostService.setRepresentedFilename(t?.fsPath??"",{targetWindowId:e}),e===p.vscodeWindowId&&this.provideCustomTitleContextMenu(t?.fsPath)}onBeforeShutdown({veto:i,reason:e}){if(e===u.CLOSE){const t=this.configurationService.getValue("window.confirmBeforeClose"),o=t==="always"||t==="keyboardOnly"&&Se.getInstance().isModifierPressed;if(o)return i((async()=>{let r=e;e===u.CLOSE&&!f&&await this.nativeHostService.getWindowCount()===1&&(r=u.QUIT);let s=!0;return o&&(s=await this.instantiationService.invokeFunction(d=>y.confirmOnShutdown(d,r))),s&&this.progressOnBeforeShutdown(e),!s})(),"veto.confirmBeforeClose")}this.progressOnBeforeShutdown(e)}progressOnBeforeShutdown(i){this.progressService.withProgress({location:Z.Window,delay:800,title:this.toShutdownLabel(i,!1)},()=>v.toPromise(v.any(this.lifecycleService.onWillShutdown,this.lifecycleService.onShutdownVeto,this.dialogService.onWillShowDialog)))}onBeforeShutdownError({error:i,reason:e}){this.dialogService.error(this.toShutdownLabel(e,!0),n("shutdownErrorDetail","Error: {0}",ye(i)))}onWillShutdown({reason:i,force:e,joiners:t}){const o=new U(()=>{const r=t();this.progressService.withProgress({location:Z.Dialog,buttons:[this.toForceShutdownLabel(i)],cancellable:!1,sticky:!0,title:this.toShutdownLabel(i,!1),detail:r.length>0?n("willShutdownDetail",`The following operations are still running: 
{0}`,r.map(s=>`- ${s.label}`).join(`
`)):void 0},()=>v.toPromise(this.lifecycleService.onDidShutdown),()=>{e()})},1200);o.schedule(),v.once(this.lifecycleService.onDidShutdown)(()=>o.dispose())}toShutdownLabel(i,e){if(e)switch(i){case u.CLOSE:return n("shutdownErrorClose","An unexpected error prevented the window to close");case u.QUIT:return n("shutdownErrorQuit","An unexpected error prevented the application to quit");case u.RELOAD:return n("shutdownErrorReload","An unexpected error prevented the window to reload");case u.LOAD:return n("shutdownErrorLoad","An unexpected error prevented to change the workspace")}switch(i){case u.CLOSE:return n("shutdownTitleClose","Closing the window is taking a bit longer...");case u.QUIT:return n("shutdownTitleQuit","Quitting the application is taking a bit longer...");case u.RELOAD:return n("shutdownTitleReload","Reloading the window is taking a bit longer...");case u.LOAD:return n("shutdownTitleLoad","Changing the workspace is taking a bit longer...")}}toForceShutdownLabel(i){switch(i){case u.CLOSE:return n("shutdownForceClose","Close Anyway");case u.QUIT:return n("shutdownForceQuit","Quit Anyway");case u.RELOAD:return n("shutdownForceReload","Reload Anyway");case u.LOAD:return n("shutdownForceLoad","Change Anyway")}}updateDocumentEdited(i){let e;typeof i=="boolean"?e=i:e=this.workingCopyService.hasDirty,(!this.isDocumentedEdited&&e||this.isDocumentedEdited&&!e)&&(this.isDocumentedEdited=e,this.nativeHostService.setDocumentEdited(e))}getWindowMinimumWidth(i=this.layoutService.getPanelPosition()){return i===ae.LEFT||i===ae.RIGHT?oe.WIDTH_WITH_VERTICAL_PANEL:oe.WIDTH}onDidChangePanelPosition(i){const e=this.getWindowMinimumWidth(i);this.nativeHostService.setMinimumSize(e,void 0)}maybeCloseWindow(){if(this.configurationService.getValue("window.closeWhenEmpty")||this.nativeEnvironmentService.args.wait)for(const e of this.editorGroupService.parts)e.groups.some(t=>!t.isEmpty)||e===this.editorGroupService.mainPart&&(this.contextService.getWorkbenchState()!==ni.EMPTY||this.environmentService.isExtensionDevelopment||this.editorService.visibleEditors.length>0)||(e===this.editorGroupService.mainPart?this.nativeHostService.closeWindow():e.removeGroup(e.activeGroup))}provideCustomTitleContextMenu(i){if(this.customTitleContextMenuDisposable.clear(),!i||te(this.configurationService))return;const e=i.split(B.sep);for(let t=e.length;t>0;t--){const o=t===e.length;let r=t;o||r++;const s=h.file(e.slice(0,r).join(B.sep));let d;o?d=this.labelService.getUriBasenameLabel(s):d=this.labelService.getUriBasenameLabel(S(s));const l=`workbench.action.revealPathInFinder${t}`;this.customTitleContextMenuDisposable.add(xe.registerCommand(l,()=>this.nativeHostService.showItemInFolder(s.fsPath))),this.customTitleContextMenuDisposable.add(Pe.appendMenuItem(J.TitleBarTitleContext,{command:{id:l,title:d||B.sep},order:-t,group:"1_file"}))}}create(){this.setupOpenHandlers(),this.lifecycleService.when(N.Ready).then(()=>this.nativeHostService.notifyReady()),this.lifecycleService.when(N.Restored).then(()=>{this.sharedProcessService.notifyRestored(),this.utilityProcessWorkerWorkbenchService.notifyRestored()}),this.handleWarnings(),this.updateTouchbarMenu(),this.environmentService.enableSmokeTestDriver&&this.setupDriver()}async handleWarnings(){if(!we&&typeof require.hasDependencyCycle=="function"&&require.hasDependencyCycle()&&(Re?(this.logService.error("Error: There is a dependency cycle in the AMD modules that needs to be resolved!"),this.nativeHostService.exit(37)):(this.dialogService.error(n("loaderCycle","There is a dependency cycle in the AMD modules that needs to be resolved!")),this.nativeHostService.openDevTools())),await this.lifecycleService.when(N.Restored),(async()=>{const e=await this.nativeHostService.isAdmin(),{isPure:t}=await this.integrityService.isPure();this.titleService.updateProperties({isPure:t,isAdmin:e}),e&&!j&&this.notificationService.warn(n("runningAsRoot","It is not recommended to run {0} as root user.",this.productService.nameShort))})(),this.environmentService.isBuilt){let e;f?e=S(S(S(h.file(this.nativeEnvironmentService.appRoot)))):e=S(S(h.file(this.nativeEnvironmentService.appRoot)));for(const t of this.contextService.getWorkspace().folders)if(this.uriIdentityService.extUri.isEqualOrParent(t.uri,e)){this.bannerService.show({id:"appRootWarning.banner",message:n("appRootWarning.banner","Files you store within the installation folder ('{0}') may be OVERWRITTEN or DELETED IRREVERSIBLY without warning at update time.",this.labelService.getUriLabel(e)),icon:k.warning});break}}if(f){const e=this.nativeEnvironmentService.os.release.split(".")[0],t=new Map([["17","macOS High Sierra"],["18","macOS Mojave"]]);if(t.has(e)){const o=n("macoseolmessage","{0} on {1} will soon stop receiving updates. Consider upgrading your macOS version.",this.productService.nameLong,t.get(e));this.notificationService.prompt(g.Warning,o,[{label:n("learnMore","Learn More"),run:()=>this.openerService.open(h.parse("https://aka.ms/vscode-faq-old-macOS"))}],{neverShowAgain:{id:"macoseol",isSecondary:!0,scope:Ge.APPLICATION},priority:T.URGENT,sticky:!0})}}const i=We.shellEnv();this.progressService.withProgress({title:n("resolveShellEnvironment","Resolving shell environment..."),location:Z.Window,delay:1600,buttons:[n("learnMore","Learn More")]},()=>i,()=>this.openerService.open("https://go.microsoft.com/fwlink/?linkid=2149667"))}setupDriver(){const i=this;let e=!1;vi(this.instantiationService,{async exitApplication(){if(e){i.logService.info("[driver] not handling exitApplication() due to pending quit() call");return}return i.logService.info("[driver] handling exitApplication()"),e=!0,i.nativeHostService.quit()}})}async openTunnel(i,e){const t=this.environmentService.remoteAuthority,o=t?{getAddress:async()=>(await this.remoteAuthorityResolverService.resolveAuthority(t)).authority}:void 0,r=await this.tunnelService.getExistingTunnel(i,e);return!r||typeof r=="string"?this.tunnelService.openTunnel(o,i,e):r}async resolveExternalUri(i,e){let t;if(e?.allowTunneling){const o=Je(i),r=Xe(i);if(r&&(t=await this.openTunnel(r.address,r.port),t&&typeof t!="string")){if(t.tunnelRemotePort!==r.port)t.dispose(),t=void 0;else if(!o){const s=t;return{resolved:i,dispose:()=>s.dispose()}}}if(o){const s=await this.openTunnel(o.address,o.port);if(s&&typeof s!="string"){const d=h.parse(s.localAddress);return{resolved:d.scheme.startsWith(i.scheme)?d:i.with({authority:s.localAddress}),dispose(){s.dispose(),t&&typeof t!="string"&&t.dispose()}}}}}if(!e?.openExternal&&await this.fileService.canHandleResource(i))return{resolved:h.from({scheme:this.productService.urlProtocol,path:"workspace",query:i.toString()}),dispose(){}}}setupOpenHandlers(){this.openerService.setDefaultExternalOpener({openExternal:async i=>{if(!await this.nativeHostService.openExternal(i,this.configurationService.getValue("workbench.externalBrowser"))){const t=h.parse(i);t.scheme===$.file&&await this.nativeHostService.showItemInFolder(t.fsPath)}return!0}}),this.openerService.registerExternalUriResolver({resolveExternalUri:async(i,e)=>this.resolveExternalUri(i,e)})}touchBarMenu;touchBarDisposables=this._register(new E);lastInstalledTouchedBar;updateTouchbarMenu(){if(!f)return;this.touchBarDisposables.clear(),this.touchBarMenu=void 0;const i=this.touchBarDisposables.add(new U(()=>this.doUpdateTouchbarMenu(i),300));i.schedule()}doUpdateTouchbarMenu(i){if(!this.touchBarMenu){const l=this.editorService.activeEditorPane?.scopedContextKeyService||this.editorGroupService.activeGroup.scopedContextKeyService;this.touchBarMenu=this.menuService.createMenu(J.TouchBarContext,l),this.touchBarDisposables.add(this.touchBarMenu),this.touchBarDisposables.add(this.touchBarMenu.onDidChange(()=>i.schedule()))}const e=[],t=this.configurationService.getValue("keyboard.touchbar.enabled")===!1,o=this.configurationService.getValue("keyboard.touchbar.ignored"),r=Array.isArray(o)?o:[];ke(this.touchBarMenu,void 0,e);const s=[];let d=[];if(!t){for(const l of e)if(l instanceof De){if(r.indexOf(l.item.id)>=0)continue;d.push(l.item)}else l instanceof ge&&(d.length&&s.push(d),d=[]);d.length&&s.push(d)}Ce(this.lastInstalledTouchedBar,s)||(this.lastInstalledTouchedBar=s,this.nativeHostService.updateTouchBar(s))}onAddFoldersRequest(i){this.pendingFoldersToAdd.push(...i.foldersToAdd.map(e=>h.revive(e))),this.addFoldersScheduler.isScheduled()||this.addFoldersScheduler.schedule()}doAddFolders(){const i=[];for(const e of this.pendingFoldersToAdd)i.push({uri:e});this.pendingFoldersToAdd=[],this.workspaceEditingService.addFolders(i)}async onOpenFiles(i){const e=!!(i.filesToDiff&&i.filesToDiff.length===2),t=!!(i.filesToMerge&&i.filesToMerge.length===4),o=O(await li(t?i.filesToMerge:e?i.filesToDiff:i.filesToOpenOrCreate,this.fileService,this.logService));if(o.length){const r=await this.openResources(o,e,t);if(i.filesToWait)return r.length?this.trackClosedWaitFiles(h.revive(i.filesToWait.waitMarkerFileUri),O(i.filesToWait.paths.map(s=>h.revive(s.fileUri)))):this.fileService.del(h.revive(i.filesToWait.waitMarkerFileUri))}}async trackClosedWaitFiles(i,e){await this.instantiationService.invokeFunction(t=>si(t,e)),await this.fileService.del(i)}async openResources(i,e,t){const o=[];if(t&&w(i[0])&&w(i[1])&&w(i[2])&&w(i[3])){const r={input1:{resource:i[0].resource},input2:{resource:i[1].resource},base:{resource:i[2].resource},result:{resource:i[3].resource},options:{pinned:!0}};o.push(r)}else if(e&&w(i[0])&&w(i[1])){const r={original:{resource:i[0].resource},modified:{resource:i[1].resource},options:{pinned:!0}};o.push(r)}else o.push(...i);return this.editorService.openEditors(o,void 0,{validateTrust:!0})}mapWindowIdToZoomStatusEntry=new Map;configuredWindowZoomLevel=this.resolveConfiguredWindowZoomLevel();resolveConfiguredWindowZoomLevel(){const i=this.configurationService.getValue("window.zoomLevel");return typeof i=="number"?i:0}handleOnDidChangeZoomLevel(i){if(this.updateWindowZoomStatusEntry(i),i===p.vscodeWindowId){const e=W(p);let t;this.configuredWindowZoomLevel!==e&&(t=e),c.invoke("vscode:notifyZoomLevel",t)}}createWindowZoomStatusEntry(i){const e=new E;v.once(i.onWillDispose)(()=>e.dispose());const t=this.editorGroupService.getScopedInstantiationService(i);this.mapWindowIdToZoomStatusEntry.set(i.windowId,e.add(t.createInstance(C))),e.add(Q(()=>this.mapWindowIdToZoomStatusEntry.delete(i.windowId))),this.updateWindowZoomStatusEntry(i.windowId)}updateWindowZoomStatusEntry(i){const e=F(i),t=this.mapWindowIdToZoomStatusEntry.get(i);if(t&&e){const o=W(e.window);let r;o<this.configuredWindowZoomLevel?r="$(zoom-out)":o>this.configuredWindowZoomLevel&&(r="$(zoom-in)"),t.updateZoomEntry(r??!1,i)}}onDidChangeConfiguredWindowZoomLevel(){this.configuredWindowZoomLevel=this.resolveConfiguredWindowZoomLevel();let i=!1;for(const{window:e}of fe())if(W(e)!==this.configuredWindowZoomLevel){i=!0;break}i&&ti(this.configuredWindowZoomLevel,oi.ALL_WINDOWS);for(const[e]of this.mapWindowIdToZoomStatusEntry)this.updateWindowZoomStatusEntry(e)}dispose(){super.dispose();for(const[,i]of this.mapWindowIdToZoomStatusEntry)i.dispose()}};y=x([a(0,se),a(1,hi),a(2,Fe),a(3,Wi),a(4,Ai),a(5,_e),a(6,X),a(7,ie),a(8,Ye),a(9,Di),a(10,Ue),a(11,Te),a(12,Ii),a(13,Si),a(14,pi),a(15,Le),a(16,ri),a(17,Ve),a(18,Ne),a(19,ei),a(20,gi),a(21,Ti),a(22,mi),a(23,qe),a(24,Qe),a(25,Oe),a(26,$e),a(27,ze),a(28,Be),a(29,He),a(30,Ke),a(31,Ze),a(32,ui),a(33,ii),a(34,bi),a(35,Li),a(36,fi)],y);let C=class extends be{constructor(i,e,t){super();this.statusbarService=i;this.commandService=e;this.keybindingService=t}disposable=this._register(new Ee);zoomLevelLabel=void 0;updateZoomEntry(i,e){typeof i=="string"?(this.disposable.value||this.createZoomEntry(i),this.updateZoomLevelLabel(e)):this.disposable.clear()}createZoomEntry(i){const e=new E;this.disposable.value=e;const t=document.createElement("div");t.classList.add("zoom-status");const o=document.createElement("div");o.classList.add("zoom-status-left"),t.appendChild(o);const r=e.add(new b("workbench.action.zoomOut",n("zoomOut","Zoom Out"),H.asClassName(k.remove),!0,()=>this.commandService.executeCommand(r.id))),s=e.add(new b("workbench.action.zoomIn",n("zoomIn","Zoom In"),H.asClassName(k.plus),!0,()=>this.commandService.executeCommand(s.id))),d=e.add(new b("workbench.action.zoomReset",n("zoomReset","Reset"),void 0,!0,()=>this.commandService.executeCommand(d.id)));d.tooltip=n("zoomResetLabel","{0} ({1})",d.label,this.keybindingService.lookupKeybinding(d.id)?.getLabel());const l=e.add(new b("workbench.action.openSettings",n("zoomSettings","Settings"),H.asClassName(k.settingsGear),!0,()=>this.commandService.executeCommand(l.id,"window.zoom"))),_=e.add(new b("zoomLabel",void 0,void 0,!1));this.zoomLevelLabel=_,e.add(Q(()=>this.zoomLevelLabel=void 0));const R=e.add(new K(o,{hoverDelegate:ee}));R.push(r,{icon:!0,label:!1,keybinding:this.keybindingService.lookupKeybinding(r.id)?.getLabel()}),R.push(this.zoomLevelLabel,{icon:!1,label:!0}),R.push(s,{icon:!0,label:!1,keybinding:this.keybindingService.lookupKeybinding(s.id)?.getLabel()});const A=document.createElement("div");A.classList.add("zoom-status-right"),t.appendChild(A);const D=e.add(new K(A,{hoverDelegate:ee}));D.push(d,{icon:!1,label:!0}),D.push(l,{icon:!0,label:!1,keybinding:this.keybindingService.lookupKeybinding(l.id)?.getLabel()});const P=n("status.windowZoom","Window Zoom");e.add(this.statusbarService.addEntry({name:P,text:i,tooltip:t,ariaLabel:P,command:Ci,kind:"prominent"},"status.windowZoom",Ri.RIGHT,102))}updateZoomLevelLabel(i){if(this.zoomLevelLabel){const e=F(i,!0).window,t=Math.round(ve(e)*100),o=W(e);this.zoomLevelLabel.label=`${o}`,this.zoomLevelLabel.tooltip=n("zoomNumber","Zoom Level: {0} ({1}%)",o,t)}}};C=x([a(0,Ei),a(1,X),a(2,ie)],C);export{y as NativeWindow};
