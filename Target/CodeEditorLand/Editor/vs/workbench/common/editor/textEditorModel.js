var h=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var g=(d,s,e,t)=>{for(var i=t>1?void 0:t?p(s,e):s,o=d.length-1,r;o>=0;o--)(r=d[o])&&(i=(t?r(s,e,i):r(i))||i);return t&&i&&h(s,e,i),i},a=(d,s)=>(e,t)=>s(e,t,d);import{ThrottledDelayer as I}from"../../../base/common/async.js";import{MutableDisposable as L}from"../../../base/common/lifecycle.js";import{ILanguageService as x}from"../../../editor/common/languages/language.js";import{PLAINTEXT_LANGUAGE_ID as l}from"../../../editor/common/languages/modesRegistry.js";import{ModelConstants as u}from"../../../editor/common/model.js";import{IModelService as E}from"../../../editor/common/services/model.js";import{localize as v}from"../../../nls.js";import{IAccessibilityService as m}from"../../../platform/accessibility/common/accessibility.js";import{ILanguageDetectionService as M,LanguageDetectionLanguageEventSource as c}from"../../services/languageDetection/common/languageDetectionWorkerService.js";import{EditorModel as T}from"./editorModel.js";let n=class extends T{constructor(e,t,i,o,r){super();this.modelService=e;this.languageService=t;this.languageDetectionService=i;this.accessibilityService=o;r&&this.handleExistingModel(r)}static AUTO_DETECT_LANGUAGE_THROTTLE_DELAY=600;textEditorModelHandle=void 0;createdEditorModel;modelDisposeListener=this._register(new L);autoDetectLanguageThrottler=this._register(new I(n.AUTO_DETECT_LANGUAGE_THROTTLE_DELAY));handleExistingModel(e){const t=this.modelService.getModel(e);if(!t)throw new Error(`Document with resource ${e.toString(!0)} does not exist`);this.textEditorModelHandle=e,this.registerModelDisposeListener(t)}registerModelDisposeListener(e){this.modelDisposeListener.value=e.onWillDispose(()=>{this.textEditorModelHandle=void 0,this.dispose()})}get textEditorModel(){return this.textEditorModelHandle?this.modelService.getModel(this.textEditorModelHandle):null}isReadonly(){return!0}_hasLanguageSetExplicitly=!1;get hasLanguageSetExplicitly(){return this._hasLanguageSetExplicitly}setLanguageId(e,t){this._hasLanguageSetExplicitly=!0,this.setLanguageIdInternal(e,t)}setLanguageIdInternal(e,t){this.isResolved()&&(!e||e===this.textEditorModel.getLanguageId()||this.textEditorModel.setLanguage(this.languageService.createById(e),t))}installModelListeners(e){const t=this._register(e.onDidChangeLanguage(i=>{i.source!==c&&(this._hasLanguageSetExplicitly=!0,t.dispose())}))}getLanguageId(){return this.textEditorModel?.getLanguageId()}autoDetectLanguage(){return this.autoDetectLanguageThrottler.trigger(()=>this.doAutoDetectLanguage())}async doAutoDetectLanguage(){if(this.hasLanguageSetExplicitly||!this.textEditorModelHandle||!this.languageDetectionService.isEnabledForLanguage(this.getLanguageId()??l))return;const e=await this.languageDetectionService.detectLanguage(this.textEditorModelHandle),t=this.getLanguageId();if(e&&e!==t&&!this.isDisposed()){this.setLanguageIdInternal(e,c);const i=this.languageService.getLanguageName(e);this.accessibilityService.alert(v("languageAutoDetected","Language {0} was automatically detected and set as the language mode.",i??e))}}createTextEditorModel(e,t,i){const o=this.getFirstLineText(e),r=this.getOrCreateLanguage(t,this.languageService,i,o);return this.doCreateTextEditorModel(e,r,t)}doCreateTextEditorModel(e,t,i){let o=i&&this.modelService.getModel(i);return o?this.updateTextEditorModel(e,t.languageId):(o=this.modelService.createModel(e,t,i),this.createdEditorModel=!0,this.registerModelDisposeListener(o)),this.textEditorModelHandle=o.uri,o}getFirstLineText(e){const t=e;return typeof t.getFirstLineText=="function"?t.getFirstLineText(u.FIRST_LINE_DETECTION_LENGTH_LIMIT):e.getLineContent(1).substr(0,u.FIRST_LINE_DETECTION_LENGTH_LIMIT)}getOrCreateLanguage(e,t,i,o){return!i||i===l?t.createByFilepathOrFirstLine(e??null,o):t.createById(i)}updateTextEditorModel(e,t){this.isResolved()&&(e&&this.modelService.updateModel(this.textEditorModel,e),t&&t!==l&&this.textEditorModel.getLanguageId()!==t&&this.textEditorModel.setLanguage(this.languageService.createById(t)))}createSnapshot(){return this.textEditorModel?this.textEditorModel.createSnapshot(!0):null}isResolved(){return!!this.textEditorModelHandle}dispose(){this.modelDisposeListener.dispose(),this.textEditorModelHandle&&this.createdEditorModel&&this.modelService.destroyModel(this.textEditorModelHandle),this.textEditorModelHandle=void 0,this.createdEditorModel=!1,super.dispose()}};n=g([a(0,E),a(1,x),a(2,M),a(3,m)],n);export{n as BaseTextEditorModel};
