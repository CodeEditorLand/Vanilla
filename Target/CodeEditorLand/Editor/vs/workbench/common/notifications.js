import{NoOpNotification as N,Severity as h,NotificationsFilter as u,NotificationPriority as g,isNotificationSource as C}from"../../platform/notification/common/notification.js";import{toErrorMessage as p,isErrorWithActions as D}from"../../base/common/errorMessage.js";import{Event as _,Emitter as o}from"../../base/common/event.js";import{Disposable as l,toDisposable as b}from"../../base/common/lifecycle.js";import{isCancellationError as I}from"../../base/common/errors.js";import{Action as E}from"../../base/common/actions.js";import{equals as M}from"../../base/common/arrays.js";import{parseLinkedText as w}from"../../base/common/linkedText.js";import{mapsStrictEqualIgnoreOrder as S}from"../../base/common/map.js";var x=(s=>(s[s.ADD=0]="ADD",s[s.CHANGE=1]="CHANGE",s[s.EXPAND_COLLAPSE=2]="EXPAND_COLLAPSE",s[s.REMOVE=3]="REMOVE",s))(x||{}),A=(e=>(e[e.ADD=0]="ADD",e[e.REMOVE=1]="REMOVE",e))(A||{});class V extends l{constructor(e,i){super();this.item=e;this.onClose=i;this.registerListeners()}_onDidClose=this._register(new o);onDidClose=this._onDidClose.event;_onDidChangeVisibility=this._register(new o);onDidChangeVisibility=this._onDidChangeVisibility.event;registerListeners(){this._register(this.item.onDidChangeVisibility(e=>this._onDidChangeVisibility.fire(e))),_.once(this.item.onDidClose)(()=>{this._onDidClose.fire(),this.dispose()})}get progress(){return this.item.progress}updateSeverity(e){this.item.updateSeverity(e)}updateMessage(e){this.item.updateMessage(e)}updateActions(e){this.item.updateActions(e)}close(){this.onClose(this.item),this.dispose()}}class m extends l{static NO_OP_NOTIFICATION=new N;_onDidChangeNotification=this._register(new o);onDidChangeNotification=this._onDidChangeNotification.event;_onDidChangeStatusMessage=this._register(new o);onDidChangeStatusMessage=this._onDidChangeStatusMessage.event;_onDidChangeFilter=this._register(new o);onDidChangeFilter=this._onDidChangeFilter.event;_notifications=[];get notifications(){return this._notifications}_statusMessage;get statusMessage(){return this._statusMessage}filter={global:u.OFF,sources:new Map};setFilter(t){let e=!1;typeof t.global=="number"&&(e=this.filter.global!==t.global,this.filter.global=t.global);let i=!1;t.sources&&(i=!S(this.filter.sources,t.sources),this.filter.sources=t.sources),(e||i)&&this._onDidChangeFilter.fire({global:e?t.global:void 0,sources:i?t.sources:void 0})}addNotification(t){const e=this.createViewItem(t);return e?(this.findNotification(e)?.close(),this._notifications.splice(0,0,e),this._onDidChangeNotification.fire({item:e,index:0,kind:0}),new V(e,s=>this.onClose(s))):m.NO_OP_NOTIFICATION}onClose(t){const e=this.findNotification(t);e&&e!==t?e.close():t.close()}findNotification(t){return this._notifications.find(e=>e.equals(t))}createViewItem(t){const e=a.create(t,this.filter);if(!e)return;const i=(n,d)=>{const f=this._notifications.indexOf(e);f>=0&&this._onDidChangeNotification.fire({item:e,index:f,kind:n,detail:d})},s=e.onDidChangeExpansion(()=>i(2)),r=e.onDidChangeContent(n=>i(1,n.kind));return _.once(e.onDidClose)(()=>{s.dispose(),r.dispose();const n=this._notifications.indexOf(e);n>=0&&(this._notifications.splice(n,1),this._onDidChangeNotification.fire({item:e,index:n,kind:3}))}),e}showStatusMessage(t,e){const i=O.create(t,e);return i?(this._statusMessage=i,this._onDidChangeStatusMessage.fire({kind:0,item:i}),b(()=>{this._statusMessage===i&&(this._statusMessage=void 0,this._onDidChangeStatusMessage.fire({kind:1,item:i}))})):l.None}}function te(c){return c instanceof a}var P=(s=>(s[s.SEVERITY=0]="SEVERITY",s[s.MESSAGE=1]="MESSAGE",s[s.ACTIONS=2]="ACTIONS",s[s.PROGRESS=3]="PROGRESS",s))(P||{});class k extends l{_state;_onDidChange=this._register(new o);onDidChange=this._onDidChange.event;constructor(){super(),this._state=Object.create(null)}get state(){return this._state}infinite(){this._state.infinite||(this._state.infinite=!0,this._state.total=void 0,this._state.worked=void 0,this._state.done=void 0,this._onDidChange.fire())}done(){this._state.done||(this._state.done=!0,this._state.infinite=void 0,this._state.total=void 0,this._state.worked=void 0,this._onDidChange.fire())}total(t){this._state.total!==t&&(this._state.total=t,this._state.infinite=void 0,this._state.done=void 0,this._onDidChange.fire())}worked(t){typeof this._state.worked=="number"?this._state.worked+=t:this._state.worked=t,this._state.infinite=void 0,this._state.done=void 0,this._onDidChange.fire()}}class a extends l{constructor(e,i,s,r,n,d,f,v){super();this.id=e;this._severity=i;this._sticky=s;this._priority=r;this._message=n;this._source=d;f&&this.setProgress(f),this.setActions(v)}static MAX_MESSAGE_LENGTH=1e3;_expanded;_visible=!1;_actions;_progress;_onDidChangeExpansion=this._register(new o);onDidChangeExpansion=this._onDidChangeExpansion.event;_onDidClose=this._register(new o);onDidClose=this._onDidClose.event;_onDidChangeContent=this._register(new o);onDidChangeContent=this._onDidChangeContent.event;_onDidChangeVisibility=this._register(new o);onDidChangeVisibility=this._onDidChangeVisibility.event;static create(e,i){if(!e||!e.message||I(e.message))return;let s;typeof e.severity=="number"?s=e.severity:s=h.Info;const r=a.parseNotificationMessage(e.message);if(!r)return;let n;e.actions?n=e.actions:D(e.message)&&(n={primary:e.message.actions});let d=e.priority??g.DEFAULT;return d===g.DEFAULT&&s!==h.Error&&(i.global===u.ERROR?d=g.SILENT:C(e.source)&&i.sources.get(e.source.id)===u.ERROR&&(d=g.SILENT)),new a(e.id,s,e.sticky,d,r,e.source,e.progress,n)}static parseNotificationMessage(e){let i;if(e instanceof Error?i=p(e,!1):typeof e=="string"&&(i=e),!i)return;const s=i;i.length>a.MAX_MESSAGE_LENGTH&&(i=`${i.substr(0,a.MAX_MESSAGE_LENGTH)}...`),i=i.replace(/(\r\n|\n|\r)/gm," ").trim();const r=w(i);return{raw:s,linkedText:r,original:e}}setProgress(e){e.infinite?this.progress.infinite():e.total&&(this.progress.total(e.total),e.worked&&this.progress.worked(e.worked))}setActions(e={primary:[],secondary:[]}){this._actions={primary:Array.isArray(e.primary)?e.primary:[],secondary:Array.isArray(e.secondary)?e.secondary:[]},this._expanded=e.primary&&e.primary.length>0}get canCollapse(){return!this.hasActions}get expanded(){return!!this._expanded}get severity(){return this._severity}get sticky(){if(this._sticky)return!0;const e=this.hasActions;return!!(e&&this._severity===h.Error||!e&&this._expanded||this._progress&&!this._progress.state.done)}get priority(){return this._priority}get hasActions(){return!this._actions||!this._actions.primary?!1:this._actions.primary.length>0}get hasProgress(){return!!this._progress}get progress(){return this._progress||(this._progress=this._register(new k),this._register(this._progress.onDidChange(()=>this._onDidChangeContent.fire({kind:3})))),this._progress}get message(){return this._message}get source(){return typeof this._source=="string"?this._source:this._source?this._source.label:void 0}get sourceId(){return this._source&&typeof this._source!="string"&&"id"in this._source?this._source.id:void 0}get actions(){return this._actions}get visible(){return this._visible}updateSeverity(e){e!==this._severity&&(this._severity=e,this._onDidChangeContent.fire({kind:0}))}updateMessage(e){const i=a.parseNotificationMessage(e);!i||i.raw===this._message.raw||(this._message=i,this._onDidChangeContent.fire({kind:1}))}updateActions(e){this.setActions(e),this._onDidChangeContent.fire({kind:2})}updateVisibility(e){this._visible!==e&&(this._visible=e,this._onDidChangeVisibility.fire(e))}expand(){this._expanded||!this.canCollapse||(this._expanded=!0,this._onDidChangeExpansion.fire())}collapse(e){!this._expanded||!this.canCollapse||(this._expanded=!1,e||this._onDidChangeExpansion.fire())}toggle(){this._expanded?this.collapse():this.expand()}close(){this._onDidClose.fire(),this.dispose()}equals(e){if(this.hasProgress||e.hasProgress)return!1;if(typeof this.id=="string"||typeof e.id=="string")return this.id===e.id;if(typeof this._source=="object"){if(this._source.label!==e.source||this._source.id!==e.sourceId)return!1}else if(this._source!==e.source)return!1;if(this._message.raw!==e.message.raw)return!1;const i=this._actions&&this._actions.primary||[],s=e.actions&&e.actions.primary||[];return M(i,s,(r,n)=>r.id+r.label===n.id+n.label)}}class y extends E{_onDidRun=this._register(new o);onDidRun=this._onDidRun.event;_keepOpen;_menu;constructor(t,e){super(t,e.label,void 0,!0,async()=>{e.run(),this._onDidRun.fire()}),this._keepOpen=!!e.keepOpen,this._menu=!e.isSecondary&&e.menu?e.menu.map((i,s)=>new y(`${t}.${s}`,i)):void 0}get menu(){return this._menu}get keepOpen(){return this._keepOpen}}class O{static create(t,e){if(!t||I(t))return;let i;if(t instanceof Error?i=p(t,!1):typeof t=="string"&&(i=t),!!i)return{message:i,options:e}}}export{y as ChoiceAction,x as NotificationChangeType,V as NotificationHandle,a as NotificationViewItem,P as NotificationViewItemContentChangeKind,k as NotificationViewItemProgress,m as NotificationsModel,A as StatusMessageChangeType,te as isNotificationViewItem};
