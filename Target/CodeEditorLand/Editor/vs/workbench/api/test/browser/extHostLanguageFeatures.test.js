import t from"assert";import{TestInstantiationService as _}from"../../../../platform/instantiation/test/common/instantiationServiceMock.js";import{setUnexpectedErrorHandler as M,errorHandler as $}from"../../../../base/common/errors.js";import{URI as y}from"../../../../base/common/uri.js";import*as n from"../../common/extHostTypes.js";import{createTextModel as B}from"../../../../editor/test/common/testTextModel.js";import{Position as v,Position as G}from"../../../../editor/common/core/position.js";import{Range as k}from"../../../../editor/common/core/range.js";import{TestRPCProtocol as J}from"../common/testRPCProtocol.js";import{IMarkerService as X}from"../../../../platform/markers/common/markers.js";import{MarkerService as Y}from"../../../../platform/markers/common/markerService.js";import{ExtHostLanguageFeatures as Z}from"../../common/extHostLanguageFeatures.js";import{MainThreadLanguageFeatures as ee}from"../../browser/mainThreadLanguageFeatures.js";import{ExtHostCommands as te}from"../../common/extHostCommands.js";import{MainThreadCommands as ne}from"../../browser/mainThreadCommands.js";import{ExtHostDocuments as re}from"../../common/extHostDocuments.js";import{ExtHostDocumentsAndEditors as ie}from"../../common/extHostDocumentsAndEditors.js";import*as g from"../../../../editor/common/languages.js";import{getCodeLensModel as T}from"../../../../editor/contrib/codelens/browser/codelens.js";import{getDefinitionsAtPosition as R,getImplementationsAtPosition as oe,getTypeDefinitionsAtPosition as se,getDeclarationsAtPosition as ae,getReferencesAtPosition as x}from"../../../../editor/contrib/gotoSymbol/browser/goToSymbol.js";import{getHoversPromise as D}from"../../../../editor/contrib/hover/browser/getHover.js";import{getOccurrencesAtPosition as b}from"../../../../editor/contrib/wordHighlighter/browser/wordHighlighter.js";import{getCodeActions as L}from"../../../../editor/contrib/codeAction/browser/codeAction.js";import{getWorkspaceSymbols as U}from"../../../contrib/search/common/search.js";import{rename as f}from"../../../../editor/contrib/rename/browser/rename.js";import{provideSignatureHelp as z}from"../../../../editor/contrib/parameterHints/browser/provideSignatureHelp.js";import{provideSuggestionItems as S,CompletionOptions as C}from"../../../../editor/contrib/suggest/browser/suggest.js";import{getDocumentFormattingEditsUntilResult as F,getDocumentRangeFormattingEditsUntilResult as A,getOnTypeFormattingEdits as de}from"../../../../editor/contrib/format/browser/format.js";import{getLinks as Q}from"../../../../editor/contrib/links/browser/getLinks.js";import{MainContext as j,ExtHostContext as q}from"../../common/extHost.protocol.js";import{ExtHostDiagnostics as ce}from"../../common/extHostDiagnostics.js";import"../../../../platform/instantiation/common/instantiation.js";import{NullLogService as N}from"../../../../platform/log/common/log.js";import{EndOfLineSequence as le}from"../../../../editor/common/model.js";import{getColors as me}from"../../../../editor/contrib/colorPicker/browser/color.js";import{CancellationToken as m}from"../../../../base/common/cancellation.js";import{nullExtensionDescription as s}from"../../../services/extensions/common/extensions.js";import{provideSelectionRanges as ue}from"../../../../editor/contrib/smartSelect/browser/smartSelect.js";import{mock as h}from"../../../../base/test/common/mock.js";import"../../../../editor/common/services/editorWorker.js";import{DisposableStore as ve}from"../../../../base/common/lifecycle.js";import{NullApiDeprecationService as ge}from"../../common/extHostApiDeprecationService.js";import{Progress as I}from"../../../../platform/progress/common/progress.js";import"../../common/extHostFileSystemInfo.js";import{URITransformerService as pe}from"../../common/extHostUriTransformerService.js";import{OutlineModel as W}from"../../../../editor/contrib/documentSymbols/browser/outlineModel.js";import{ILanguageFeaturesService as we}from"../../../../editor/common/services/languageFeatures.js";import{LanguageFeaturesService as ye}from"../../../../editor/common/services/languageFeaturesService.js";import{CodeActionTriggerSource as H}from"../../../../editor/contrib/codeAction/common/types.js";import{IUriIdentityService as Pe}from"../../../../platform/uriIdentity/common/uriIdentity.js";import"../../common/extHostTelemetry.js";import{ensureNoDisposablesAreLeakedInTestSuite as Ee}from"../../../../base/test/common/utils.js";suite("ExtHostLanguageFeatures",function(){const d={scheme:"far"};let a,o,K;const i=new ve;let c,l,O,E;setup(()=>{a=B(["This is the first line","This is the second line","This is the third line"].join(`
`),void 0,void 0,y.parse("far://testing/file.a")),c=new J,l=new ye;let e;E=new _,E.stub(X,Y),E.set(we,l),E.set(Pe,new class extends h(){asCanonicalUri(V){return V}}),e=E,O=$.getUnexpectedErrorHandler(),M(()=>{});const r=new ie(c,new N);r.$acceptDocumentsAndEditorsDelta({addedDocuments:[{isDirty:!1,versionId:a.getVersionId(),languageId:a.getLanguageId(),uri:a.uri,lines:a.getValue().split(a.getEOL()),EOL:a.getEOL()}]});const u=new re(c,r);c.set(q.ExtHostDocuments,u);const p=new te(c,new N,new class extends h(){onExtensionError(){return!0}});c.set(q.ExtHostCommands,p),c.set(j.MainThreadCommands,i.add(e.createInstance(ne,c)));const w=new ce(c,new N,new class extends h(){},r);c.set(q.ExtHostDiagnostics,w),o=new Z(c,new pe(null),u,p,w,new N,ge,new class extends h(){onExtensionError(){return!0}}),c.set(q.ExtHostLanguageFeatures,o),K=c.set(j.MainThreadLanguageFeatures,i.add(e.createInstance(ee,c)))}),teardown(()=>(i.clear(),M(O),a.dispose(),K.dispose(),E.dispose(),c.sync())),Ee(),test("DocumentSymbols, register/deregister",async()=>{t.strictEqual(l.documentSymbolProvider.all(a).length,0);const e=o.registerDocumentSymbolProvider(s,d,new class{provideDocumentSymbols(){return[]}});return await c.sync(),t.strictEqual(l.documentSymbolProvider.all(a).length,1),e.dispose(),c.sync()}),test("DocumentSymbols, evil provider",async()=>{i.add(o.registerDocumentSymbolProvider(s,d,new class{provideDocumentSymbols(){throw new Error("evil document symbol provider")}})),i.add(o.registerDocumentSymbolProvider(s,d,new class{provideDocumentSymbols(){return[new n.SymbolInformation("test",n.SymbolKind.Field,new n.Range(0,0,0,0))]}})),await c.sync();const e=(await W.create(l.documentSymbolProvider,a,m.None)).asListOfDocumentSymbols();t.strictEqual(e.length,1)}),test("DocumentSymbols, data conversion",async()=>{i.add(o.registerDocumentSymbolProvider(s,d,new class{provideDocumentSymbols(){return[new n.SymbolInformation("test",n.SymbolKind.Field,new n.Range(0,0,0,0))]}})),await c.sync();const e=(await W.create(l.documentSymbolProvider,a,m.None)).asListOfDocumentSymbols();t.strictEqual(e.length,1);const r=e[0];t.strictEqual(r.name,"test"),t.deepStrictEqual(r.range,{startLineNumber:1,startColumn:1,endLineNumber:1,endColumn:1})}),test("Quick Outline uses a not ideal sorting, #138502",async function(){const e=[{name:"containers",range:{startLineNumber:1,startColumn:1,endLineNumber:4,endColumn:26}},{name:"container 0",range:{startLineNumber:2,startColumn:5,endLineNumber:5,endColumn:1}},{name:"name",range:{startLineNumber:2,startColumn:5,endLineNumber:2,endColumn:16}},{name:"ports",range:{startLineNumber:3,startColumn:5,endLineNumber:5,endColumn:1}},{name:"ports 0",range:{startLineNumber:4,startColumn:9,endLineNumber:4,endColumn:26}},{name:"containerPort",range:{startLineNumber:4,startColumn:9,endLineNumber:4,endColumn:26}}];i.add(o.registerDocumentSymbolProvider(s,d,{provideDocumentSymbols:(u,p)=>e.map(w=>new n.SymbolInformation(w.name,n.SymbolKind.Object,new n.Range(w.range.startLineNumber-1,w.range.startColumn-1,w.range.endLineNumber-1,w.range.endColumn-1)))})),await c.sync();const r=(await W.create(l.documentSymbolProvider,a,m.None)).asListOfDocumentSymbols();t.strictEqual(r.length,6),t.deepStrictEqual(r.map(u=>u.name),["containers","container 0","name","ports","ports 0","containerPort"])}),test("CodeLens, evil provider",async()=>{i.add(o.registerCodeLensProvider(s,d,new class{provideCodeLenses(){throw new Error("evil")}})),i.add(o.registerCodeLensProvider(s,d,new class{provideCodeLenses(){return[new n.CodeLens(new n.Range(0,0,0,0))]}})),await c.sync();const e=await T(l.codeLensProvider,a,m.None);t.strictEqual(e.lenses.length,1),e.dispose()}),test("CodeLens, do not resolve a resolved lens",async()=>{i.add(o.registerCodeLensProvider(s,d,new class{provideCodeLenses(){return[new n.CodeLens(new n.Range(0,0,0,0),{command:"id",title:"Title"})]}resolveCodeLens(){t.ok(!1,"do not resolve")}})),await c.sync();const e=await T(l.codeLensProvider,a,m.None);t.strictEqual(e.lenses.length,1);const[r]=e.lenses,u=await Promise.resolve(r.provider.resolveCodeLens(a,r.symbol,m.None));t.strictEqual(u.command.id,"id"),t.strictEqual(u.command.title,"Title"),e.dispose()}),test("CodeLens, missing command",async()=>{i.add(o.registerCodeLensProvider(s,d,new class{provideCodeLenses(){return[new n.CodeLens(new n.Range(0,0,0,0))]}})),await c.sync();const e=await T(l.codeLensProvider,a,m.None);t.strictEqual(e.lenses.length,1);const[r]=e.lenses,u=await Promise.resolve(r.provider.resolveCodeLens(a,r.symbol,m.None));t.strictEqual(u,void 0),e.dispose()}),test("Definition, data conversion",async()=>{i.add(o.registerDefinitionProvider(s,d,new class{provideDefinition(){return[new n.Location(a.uri,new n.Range(1,2,3,4))]}})),await c.sync();const e=await R(l.definitionProvider,a,new v(1,1),!1,m.None);t.strictEqual(e.length,1);const[r]=e;t.deepStrictEqual(r.range,{startLineNumber:2,startColumn:3,endLineNumber:4,endColumn:5}),t.strictEqual(r.uri.toString(),a.uri.toString())}),test("Definition, one or many",async()=>{i.add(o.registerDefinitionProvider(s,d,new class{provideDefinition(){return[new n.Location(a.uri,new n.Range(1,1,1,1))]}})),i.add(o.registerDefinitionProvider(s,d,new class{provideDefinition(){return new n.Location(a.uri,new n.Range(2,1,1,1))}})),await c.sync();const e=await R(l.definitionProvider,a,new v(1,1),!1,m.None);t.strictEqual(e.length,2)}),test("Definition, registration order",async()=>{i.add(o.registerDefinitionProvider(s,d,new class{provideDefinition(){return[new n.Location(y.parse("far://first"),new n.Range(2,3,4,5))]}})),i.add(o.registerDefinitionProvider(s,d,new class{provideDefinition(){return new n.Location(y.parse("far://second"),new n.Range(1,2,3,4))}})),await c.sync();const e=await R(l.definitionProvider,a,new v(1,1),!1,m.None);t.strictEqual(e.length,2),t.strictEqual(e[0].uri.authority,"second"),t.strictEqual(e[1].uri.authority,"first")}),test("Definition, evil provider",async()=>{i.add(o.registerDefinitionProvider(s,d,new class{provideDefinition(){throw new Error("evil provider")}})),i.add(o.registerDefinitionProvider(s,d,new class{provideDefinition(){return new n.Location(a.uri,new n.Range(1,1,1,1))}})),await c.sync();const e=await R(l.definitionProvider,a,new v(1,1),!1,m.None);t.strictEqual(e.length,1)}),test("Declaration, data conversion",async()=>{i.add(o.registerDeclarationProvider(s,d,new class{provideDeclaration(){return[new n.Location(a.uri,new n.Range(1,2,3,4))]}})),await c.sync();const e=await ae(l.declarationProvider,a,new v(1,1),!1,m.None);t.strictEqual(e.length,1);const[r]=e;t.deepStrictEqual(r.range,{startLineNumber:2,startColumn:3,endLineNumber:4,endColumn:5}),t.strictEqual(r.uri.toString(),a.uri.toString())}),test("Implementation, data conversion",async()=>{i.add(o.registerImplementationProvider(s,d,new class{provideImplementation(){return[new n.Location(a.uri,new n.Range(1,2,3,4))]}})),await c.sync();const e=await oe(l.implementationProvider,a,new v(1,1),!1,m.None);t.strictEqual(e.length,1);const[r]=e;t.deepStrictEqual(r.range,{startLineNumber:2,startColumn:3,endLineNumber:4,endColumn:5}),t.strictEqual(r.uri.toString(),a.uri.toString())}),test("Type Definition, data conversion",async()=>{i.add(o.registerTypeDefinitionProvider(s,d,new class{provideTypeDefinition(){return[new n.Location(a.uri,new n.Range(1,2,3,4))]}})),await c.sync();const e=await se(l.typeDefinitionProvider,a,new v(1,1),!1,m.None);t.strictEqual(e.length,1);const[r]=e;t.deepStrictEqual(r.range,{startLineNumber:2,startColumn:3,endLineNumber:4,endColumn:5}),t.strictEqual(r.uri.toString(),a.uri.toString())}),test("HoverProvider, word range at pos",async()=>{i.add(o.registerHoverProvider(s,d,new class{provideHover(){return new n.Hover("Hello")}})),await c.sync();const e=await D(l.hoverProvider,a,new v(1,1),m.None);t.strictEqual(e.length,1);const[r]=e;t.deepStrictEqual(r.range,{startLineNumber:1,startColumn:1,endLineNumber:1,endColumn:5})}),test("HoverProvider, given range",async()=>{i.add(o.registerHoverProvider(s,d,new class{provideHover(){return new n.Hover("Hello",new n.Range(3,0,8,7))}})),await c.sync();const e=await D(l.hoverProvider,a,new v(1,1),m.None);t.strictEqual(e.length,1);const[r]=e;t.deepStrictEqual(r.range,{startLineNumber:4,startColumn:1,endLineNumber:9,endColumn:8})}),test("HoverProvider, registration order",async()=>{i.add(o.registerHoverProvider(s,d,new class{provideHover(){return new n.Hover("registered first")}})),i.add(o.registerHoverProvider(s,d,new class{provideHover(){return new n.Hover("registered second")}})),await c.sync();const e=await D(l.hoverProvider,a,new v(1,1),m.None);t.strictEqual(e.length,2);const[r,u]=e;t.strictEqual(r.contents[0].value,"registered second"),t.strictEqual(u.contents[0].value,"registered first")}),test("HoverProvider, evil provider",async()=>{i.add(o.registerHoverProvider(s,d,new class{provideHover(){throw new Error("evil")}})),i.add(o.registerHoverProvider(s,d,new class{provideHover(){return new n.Hover("Hello")}})),await c.sync();const e=await D(l.hoverProvider,a,new v(1,1),m.None);t.strictEqual(e.length,1)}),test("Occurrences, data conversion",async()=>{i.add(o.registerDocumentHighlightProvider(s,d,new class{provideDocumentHighlights(){return[new n.DocumentHighlight(new n.Range(0,0,0,4))]}})),await c.sync();const e=await b(l.documentHighlightProvider,a,new v(1,2),m.None);t.strictEqual(e.size,1);const[r]=Array.from(e.values())[0];t.deepStrictEqual(r.range,{startLineNumber:1,startColumn:1,endLineNumber:1,endColumn:5}),t.strictEqual(r.kind,g.DocumentHighlightKind.Text)}),test("Occurrences, order 1/2",async()=>{i.add(o.registerDocumentHighlightProvider(s,d,new class{provideDocumentHighlights(){}})),i.add(o.registerDocumentHighlightProvider(s,"*",new class{provideDocumentHighlights(){return[new n.DocumentHighlight(new n.Range(0,0,0,4))]}})),await c.sync();const e=await b(l.documentHighlightProvider,a,new v(1,2),m.None);t.strictEqual(e.size,1);const[r]=Array.from(e.values())[0];t.deepStrictEqual(r.range,{startLineNumber:1,startColumn:1,endLineNumber:1,endColumn:5}),t.strictEqual(r.kind,g.DocumentHighlightKind.Text)}),test("Occurrences, order 2/2",async()=>{i.add(o.registerDocumentHighlightProvider(s,d,new class{provideDocumentHighlights(){return[new n.DocumentHighlight(new n.Range(0,0,0,2))]}})),i.add(o.registerDocumentHighlightProvider(s,"*",new class{provideDocumentHighlights(){return[new n.DocumentHighlight(new n.Range(0,0,0,4))]}})),await c.sync();const e=await b(l.documentHighlightProvider,a,new v(1,2),m.None);t.strictEqual(e.size,1);const[r]=Array.from(e.values())[0];t.deepStrictEqual(r.range,{startLineNumber:1,startColumn:1,endLineNumber:1,endColumn:3}),t.strictEqual(r.kind,g.DocumentHighlightKind.Text)}),test("Occurrences, evil provider",async()=>{i.add(o.registerDocumentHighlightProvider(s,d,new class{provideDocumentHighlights(){throw new Error("evil")}})),i.add(o.registerDocumentHighlightProvider(s,d,new class{provideDocumentHighlights(){return[new n.DocumentHighlight(new n.Range(0,0,0,4))]}})),await c.sync();const e=await b(l.documentHighlightProvider,a,new v(1,2),m.None);t.strictEqual(e.size,1)}),test("References, registration order",async()=>{i.add(o.registerReferenceProvider(s,d,new class{provideReferences(){return[new n.Location(y.parse("far://register/first"),new n.Range(0,0,0,0))]}})),i.add(o.registerReferenceProvider(s,d,new class{provideReferences(){return[new n.Location(y.parse("far://register/second"),new n.Range(0,0,0,0))]}})),await c.sync();const e=await x(l.referenceProvider,a,new v(1,2),!1,!1,m.None);t.strictEqual(e.length,2);const[r,u]=e;t.strictEqual(r.uri.path,"/second"),t.strictEqual(u.uri.path,"/first")}),test("References, data conversion",async()=>{i.add(o.registerReferenceProvider(s,d,new class{provideReferences(){return[new n.Location(a.uri,new n.Position(0,0))]}})),await c.sync();const e=await x(l.referenceProvider,a,new v(1,2),!1,!1,m.None);t.strictEqual(e.length,1);const[r]=e;t.deepStrictEqual(r.range,{startLineNumber:1,startColumn:1,endLineNumber:1,endColumn:1}),t.strictEqual(r.uri.toString(),a.uri.toString())}),test("References, evil provider",async()=>{i.add(o.registerReferenceProvider(s,d,new class{provideReferences(){throw new Error("evil")}})),i.add(o.registerReferenceProvider(s,d,new class{provideReferences(){return[new n.Location(a.uri,new n.Range(0,0,0,0))]}})),await c.sync();const e=await x(l.referenceProvider,a,new v(1,2),!1,!1,m.None);t.strictEqual(e.length,1)}),test("Quick Fix, command data conversion",async()=>{i.add(o.registerCodeActionProvider(s,d,{provideCodeActions(){return[{command:"test1",title:"Testing1"},{command:"test2",title:"Testing2"}]}})),await c.sync();const e=await L(l.codeActionProvider,a,a.getFullModelRange(),{type:g.CodeActionTriggerType.Invoke,triggerAction:H.QuickFix},I.None,m.None),{validActions:r}=e;t.strictEqual(r.length,2);const[u,p]=r;t.strictEqual(u.action.title,"Testing1"),t.strictEqual(u.action.command.id,"test1"),t.strictEqual(p.action.title,"Testing2"),t.strictEqual(p.action.command.id,"test2"),e.dispose()}),test("Quick Fix, code action data conversion",async()=>{i.add(o.registerCodeActionProvider(s,d,{provideCodeActions(){return[{title:"Testing1",command:{title:"Testing1Command",command:"test1"},kind:n.CodeActionKind.Empty.append("test.scope")}]}})),await c.sync();const e=await L(l.codeActionProvider,a,a.getFullModelRange(),{type:g.CodeActionTriggerType.Invoke,triggerAction:H.Default},I.None,m.None),{validActions:r}=e;t.strictEqual(r.length,1);const[u]=r;t.strictEqual(u.action.title,"Testing1"),t.strictEqual(u.action.command.title,"Testing1Command"),t.strictEqual(u.action.command.id,"test1"),t.strictEqual(u.action.kind,"test.scope"),e.dispose()}),test("Cannot read property 'id' of undefined, #29469",async()=>{i.add(o.registerCodeActionProvider(s,d,new class{provideCodeActions(){return[void 0,null,{command:"test",title:"Testing"}]}})),await c.sync();const e=await L(l.codeActionProvider,a,a.getFullModelRange(),{type:g.CodeActionTriggerType.Invoke,triggerAction:H.Default},I.None,m.None),{validActions:r}=e;t.strictEqual(r.length,1),e.dispose()}),test("Quick Fix, evil provider",async()=>{i.add(o.registerCodeActionProvider(s,d,new class{provideCodeActions(){throw new Error("evil")}})),i.add(o.registerCodeActionProvider(s,d,new class{provideCodeActions(){return[{command:"test",title:"Testing"}]}})),await c.sync();const e=await L(l.codeActionProvider,a,a.getFullModelRange(),{type:g.CodeActionTriggerType.Invoke,triggerAction:H.QuickFix},I.None,m.None),{validActions:r}=e;t.strictEqual(r.length,1),e.dispose()}),test("Navigate types, evil provider",async()=>{i.add(o.registerWorkspaceSymbolProvider(s,new class{provideWorkspaceSymbols(){throw new Error("evil")}})),i.add(o.registerWorkspaceSymbolProvider(s,new class{provideWorkspaceSymbols(){return[new n.SymbolInformation("testing",n.SymbolKind.Array,new n.Range(0,0,1,1))]}})),await c.sync();const e=await U("");t.strictEqual(e.length,1);const[r]=e;t.strictEqual(r.symbol.name,"testing")}),test("Navigate types, de-duplicate results",async()=>{const e=y.from({scheme:"foo",path:"/some/path"});i.add(o.registerWorkspaceSymbolProvider(s,new class{provideWorkspaceSymbols(){return[new n.SymbolInformation("ONE",n.SymbolKind.Array,void 0,new n.Location(e,new n.Range(0,0,1,1)))]}})),i.add(o.registerWorkspaceSymbolProvider(s,new class{provideWorkspaceSymbols(){return[new n.SymbolInformation("ONE",n.SymbolKind.Array,void 0,new n.Location(e,new n.Range(0,0,1,1)))]}})),i.add(o.registerWorkspaceSymbolProvider(s,new class{provideWorkspaceSymbols(){return[new n.SymbolInformation("ONE",n.SymbolKind.Array,void 0,new n.Location(e,void 0))]}resolveWorkspaceSymbol(u){return u}})),i.add(o.registerWorkspaceSymbolProvider(s,new class{provideWorkspaceSymbols(){return[new n.SymbolInformation("ONE",n.SymbolKind.Struct,void 0,new n.Location(e,new n.Range(0,0,1,1)))]}})),await c.sync();const r=await U("");t.strictEqual(r.length,3)}),test("Rename, evil provider 0/2",async()=>{i.add(o.registerRenameProvider(s,d,new class{provideRenameEdits(){throw new class{}}})),await c.sync();try{throw await f(l.renameProvider,a,new v(1,1),"newName"),Error()}catch{}}),test("Rename, evil provider 1/2",async()=>{i.add(o.registerRenameProvider(s,d,new class{provideRenameEdits(){throw Error("evil")}})),await c.sync();const e=await f(l.renameProvider,a,new v(1,1),"newName");t.strictEqual(e.rejectReason,"evil")}),test("Rename, evil provider 2/2",async()=>{i.add(o.registerRenameProvider(s,"*",new class{provideRenameEdits(){throw Error("evil")}})),i.add(o.registerRenameProvider(s,d,new class{provideRenameEdits(){const r=new n.WorkspaceEdit;return r.replace(a.uri,new n.Range(0,0,0,0),"testing"),r}})),await c.sync();const e=await f(l.renameProvider,a,new v(1,1),"newName");t.strictEqual(e.edits.length,1)}),test("Rename, ordering",async()=>{i.add(o.registerRenameProvider(s,"*",new class{provideRenameEdits(){const r=new n.WorkspaceEdit;return r.replace(a.uri,new n.Range(0,0,0,0),"testing"),r.replace(a.uri,new n.Range(1,0,1,0),"testing"),r}})),i.add(o.registerRenameProvider(s,d,new class{provideRenameEdits(){}})),await c.sync();const e=await f(l.renameProvider,a,new v(1,1),"newName");t.strictEqual(e.edits.length,2)}),test("Multiple RenameProviders don't respect all possible PrepareRename handlers 1/2, #98352",async function(){const e=[!1,!1,!1,!1];i.add(o.registerRenameProvider(s,d,new class{prepareRename(r,u){return e[0]=!0,r.getWordRangeAtPosition(u)}provideRenameEdits(){e[1]=!0}})),i.add(o.registerRenameProvider(s,d,new class{prepareRename(r,u){return e[2]=!0,Promise.reject("Cannot rename this symbol2.")}provideRenameEdits(){e[3]=!0}})),await c.sync(),await f(l.renameProvider,a,new v(1,1),"newName"),t.deepStrictEqual(e,[!0,!0,!0,!1])}),test("Multiple RenameProviders don't respect all possible PrepareRename handlers 2/2, #98352",async function(){const e=[!1,!1,!1];i.add(o.registerRenameProvider(s,d,new class{prepareRename(r,u){return e[0]=!0,r.getWordRangeAtPosition(u)}provideRenameEdits(){e[1]=!0}})),i.add(o.registerRenameProvider(s,d,new class{provideRenameEdits(r,u,p){return e[2]=!0,new n.WorkspaceEdit}})),await c.sync(),await f(l.renameProvider,a,new v(1,1),"newName"),t.deepStrictEqual(e,[!1,!1,!0])}),test("Parameter Hints, order",async()=>{i.add(o.registerSignatureHelpProvider(s,d,new class{provideSignatureHelp(){}},[])),i.add(o.registerSignatureHelpProvider(s,d,new class{provideSignatureHelp(){return{signatures:[],activeParameter:0,activeSignature:0}}},[])),await c.sync();const e=await z(l.signatureHelpProvider,a,new v(1,1),{triggerKind:g.SignatureHelpTriggerKind.Invoke,isRetrigger:!1},m.None);t.ok(e)}),test("Parameter Hints, evil provider",async()=>{i.add(o.registerSignatureHelpProvider(s,d,new class{provideSignatureHelp(){throw new Error("evil")}},[])),await c.sync();const e=await z(l.signatureHelpProvider,a,new v(1,1),{triggerKind:g.SignatureHelpTriggerKind.Invoke,isRetrigger:!1},m.None);t.strictEqual(e,void 0)}),test("Suggest, order 1/3",async()=>{i.add(o.registerCompletionItemProvider(s,"*",new class{provideCompletionItems(){return[new n.CompletionItem("testing1")]}},[])),i.add(o.registerCompletionItemProvider(s,d,new class{provideCompletionItems(){return[new n.CompletionItem("testing2")]}},[])),await c.sync();const e=await S(l.completionProvider,a,new v(1,1),new C(void 0,new Set().add(g.CompletionItemKind.Snippet)));t.strictEqual(e.items.length,1),t.strictEqual(e.items[0].completion.insertText,"testing2"),e.disposable.dispose()}),test("Suggest, order 2/3",async()=>{i.add(o.registerCompletionItemProvider(s,"*",new class{provideCompletionItems(){return[new n.CompletionItem("weak-selector")]}},[])),i.add(o.registerCompletionItemProvider(s,d,new class{provideCompletionItems(){return[]}},[])),await c.sync();const e=await S(l.completionProvider,a,new v(1,1),new C(void 0,new Set().add(g.CompletionItemKind.Snippet)));t.strictEqual(e.items.length,1),t.strictEqual(e.items[0].completion.insertText,"weak-selector"),e.disposable.dispose()}),test("Suggest, order 3/3",async()=>{i.add(o.registerCompletionItemProvider(s,d,new class{provideCompletionItems(){return[new n.CompletionItem("strong-1")]}},[])),i.add(o.registerCompletionItemProvider(s,d,new class{provideCompletionItems(){return[new n.CompletionItem("strong-2")]}},[])),await c.sync();const e=await S(l.completionProvider,a,new v(1,1),new C(void 0,new Set().add(g.CompletionItemKind.Snippet)));t.strictEqual(e.items.length,2),t.strictEqual(e.items[0].completion.insertText,"strong-1"),t.strictEqual(e.items[1].completion.insertText,"strong-2"),e.disposable.dispose()}),test("Suggest, evil provider",async()=>{i.add(o.registerCompletionItemProvider(s,d,new class{provideCompletionItems(){throw new Error("evil")}},[])),i.add(o.registerCompletionItemProvider(s,d,new class{provideCompletionItems(){return[new n.CompletionItem("testing")]}},[])),await c.sync();const e=await S(l.completionProvider,a,new v(1,1),new C(void 0,new Set().add(g.CompletionItemKind.Snippet)));t.strictEqual(e.items[0].container.incomplete,!1),e.disposable.dispose()}),test("Suggest, CompletionList",async()=>{i.add(o.registerCompletionItemProvider(s,d,new class{provideCompletionItems(){return new n.CompletionList([new n.CompletionItem("hello")],!0)}},[])),await c.sync(),await S(l.completionProvider,a,new v(1,1),new C(void 0,new Set().add(g.CompletionItemKind.Snippet))).then(e=>{t.strictEqual(e.items[0].container.incomplete,!0),e.disposable.dispose()})});const P=new class extends h(){computeMoreMinimalEdits(e,r){return Promise.resolve(r??void 0)}};test("Format Doc, data conversion",async()=>{i.add(o.registerDocumentFormattingEditProvider(s,d,new class{provideDocumentFormattingEdits(){return[new n.TextEdit(new n.Range(0,0,0,0),"testing"),n.TextEdit.setEndOfLine(n.EndOfLine.LF)]}})),await c.sync();const e=await F(P,l,a,{insertSpaces:!0,tabSize:4},m.None);t.strictEqual(e.length,2);const[r,u]=e;t.strictEqual(r.text,"testing"),t.deepStrictEqual(r.range,{startLineNumber:1,startColumn:1,endLineNumber:1,endColumn:1}),t.strictEqual(u.eol,le.LF),t.strictEqual(u.text,""),t.deepStrictEqual(u.range,{startLineNumber:1,startColumn:1,endLineNumber:1,endColumn:1})}),test("Format Doc, evil provider",async()=>(i.add(o.registerDocumentFormattingEditProvider(s,d,new class{provideDocumentFormattingEdits(){throw new Error("evil")}})),await c.sync(),F(P,l,a,{insertSpaces:!0,tabSize:4},m.None))),test("Format Doc, order",async()=>{i.add(o.registerDocumentFormattingEditProvider(s,d,new class{provideDocumentFormattingEdits(){}})),i.add(o.registerDocumentFormattingEditProvider(s,d,new class{provideDocumentFormattingEdits(){return[new n.TextEdit(new n.Range(0,0,0,0),"testing")]}})),i.add(o.registerDocumentFormattingEditProvider(s,d,new class{provideDocumentFormattingEdits(){}})),await c.sync();const e=await F(P,l,a,{insertSpaces:!0,tabSize:4},m.None);t.strictEqual(e.length,1);const[r]=e;t.strictEqual(r.text,"testing"),t.deepStrictEqual(r.range,{startLineNumber:1,startColumn:1,endLineNumber:1,endColumn:1})}),test("Format Range, data conversion",async()=>{i.add(o.registerDocumentRangeFormattingEditProvider(s,d,new class{provideDocumentRangeFormattingEdits(){return[new n.TextEdit(new n.Range(0,0,0,0),"testing")]}})),await c.sync();const e=await A(P,l,a,new k(1,1,1,1),{insertSpaces:!0,tabSize:4},m.None);t.strictEqual(e.length,1);const[r]=e;t.strictEqual(r.text,"testing"),t.deepStrictEqual(r.range,{startLineNumber:1,startColumn:1,endLineNumber:1,endColumn:1})}),test("Format Range, + format_doc",async()=>{i.add(o.registerDocumentRangeFormattingEditProvider(s,d,new class{provideDocumentRangeFormattingEdits(){return[new n.TextEdit(new n.Range(0,0,0,0),"range")]}})),i.add(o.registerDocumentRangeFormattingEditProvider(s,d,new class{provideDocumentRangeFormattingEdits(){return[new n.TextEdit(new n.Range(2,3,4,5),"range2")]}})),i.add(o.registerDocumentFormattingEditProvider(s,d,new class{provideDocumentFormattingEdits(){return[new n.TextEdit(new n.Range(0,0,1,1),"doc")]}})),await c.sync();const e=await A(P,l,a,new k(1,1,1,1),{insertSpaces:!0,tabSize:4},m.None);t.strictEqual(e.length,1);const[r]=e;t.strictEqual(r.text,"range2"),t.strictEqual(r.range.startLineNumber,3),t.strictEqual(r.range.startColumn,4),t.strictEqual(r.range.endLineNumber,5),t.strictEqual(r.range.endColumn,6)}),test("Format Range, evil provider",async()=>(i.add(o.registerDocumentRangeFormattingEditProvider(s,d,new class{provideDocumentRangeFormattingEdits(){throw new Error("evil")}})),await c.sync(),A(P,l,a,new k(1,1,1,1),{insertSpaces:!0,tabSize:4},m.None))),test("Format on Type, data conversion",async()=>{i.add(o.registerOnTypeFormattingEditProvider(s,d,new class{provideOnTypeFormattingEdits(){return[new n.TextEdit(new n.Range(0,0,0,0),arguments[2])]}},[";"])),await c.sync();const e=await de(P,l,a,new v(1,1),";",{insertSpaces:!0,tabSize:2},m.None);t.strictEqual(e.length,1);const[r]=e;t.strictEqual(r.text,";"),t.deepStrictEqual(r.range,{startLineNumber:1,startColumn:1,endLineNumber:1,endColumn:1})}),test("Links, data conversion",async()=>{i.add(o.registerDocumentLinkProvider(s,d,new class{provideDocumentLinks(){const u=new n.DocumentLink(new n.Range(0,0,1,1),y.parse("foo:bar#3"));return u.tooltip="tooltip",[u]}})),await c.sync();const{links:e}=i.add(await Q(l.linkProvider,a,m.None));t.strictEqual(e.length,1);const[r]=e;t.strictEqual(r.url?.toString(),"foo:bar#3"),t.deepStrictEqual(r.range,{startLineNumber:1,startColumn:1,endLineNumber:2,endColumn:2}),t.strictEqual(r.tooltip,"tooltip")}),test("Links, evil provider",async()=>{i.add(o.registerDocumentLinkProvider(s,d,new class{provideDocumentLinks(){return[new n.DocumentLink(new n.Range(0,0,1,1),y.parse("foo:bar#3"))]}})),i.add(o.registerDocumentLinkProvider(s,d,new class{provideDocumentLinks(){throw new Error}})),await c.sync();const{links:e}=i.add(await Q(l.linkProvider,a,m.None));t.strictEqual(e.length,1);const[r]=e;t.strictEqual(r.url?.toString(),"foo:bar#3"),t.deepStrictEqual(r.range,{startLineNumber:1,startColumn:1,endLineNumber:2,endColumn:2})}),test("Document colors, data conversion",async()=>{i.add(o.registerColorProvider(s,d,new class{provideDocumentColors(){return[new n.ColorInformation(new n.Range(0,0,0,20),new n.Color(.1,.2,.3,.4))]}provideColorPresentations(u,p){return[]}})),await c.sync();const e=await me(l.colorProvider,a,m.None);t.strictEqual(e.length,1);const[r]=e;t.deepStrictEqual(r.colorInfo.color,{red:.1,green:.2,blue:.3,alpha:.4}),t.deepStrictEqual(r.colorInfo.range,{startLineNumber:1,startColumn:1,endLineNumber:1,endColumn:21})}),test("Selection Ranges, data conversion",async()=>{i.add(o.registerSelectionRangeProvider(s,d,new class{provideSelectionRanges(){return[new n.SelectionRange(new n.Range(0,10,0,18),new n.SelectionRange(new n.Range(0,2,0,20)))]}})),await c.sync(),ue(l.selectionRangeProvider,a,[new G(1,17)],{selectLeadingAndTrailingWhitespace:!0,selectSubwords:!0},m.None).then(e=>{t.strictEqual(e.length,1),t.ok(e[0].length>=2)})}),test("Selection Ranges, bad data",async()=>{try{const e=new n.SelectionRange(new n.Range(0,10,0,18),new n.SelectionRange(new n.Range(0,11,0,18)));t.ok(!1,String(e))}catch{t.ok(!0)}})});
