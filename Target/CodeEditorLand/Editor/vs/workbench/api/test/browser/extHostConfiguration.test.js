import e from"assert";import{URI as g}from"../../../../base/common/uri.js";import{ExtHostWorkspace as V}from"../../common/extHostWorkspace.js";import{ExtHostConfigProvider as E}from"../../common/extHostConfiguration.js";import"../../common/extHost.protocol.js";import{ConfigurationModel as s,ConfigurationModelParser as y}from"../../../../platform/configuration/common/configurationModels.js";import{TestRPCProtocol as h}from"../common/testRPCProtocol.js";import{mock as p}from"../../../../base/test/common/mock.js";import{WorkspaceFolder as W}from"../../../../platform/workspace/common/workspace.js";import{ConfigurationTarget as S}from"../../../../platform/configuration/common/configuration.js";import{NullLogService as n}from"../../../../platform/log/common/log.js";import"../../common/extHostInitDataService.js";import"../../common/extHostFileSystemInfo.js";import{FileSystemProviderCapabilities as x}from"../../../../platform/files/common/files.js";import{isLinux as v}from"../../../../base/common/platform.js";import"../../common/extHostUriTransformerService.js";import{ensureNoDisposablesAreLeakedInTestSuite as O}from"../../../../base/test/common/utils.js";suite("ExtHostConfiguration",function(){class C extends p(){lastArgs;$updateConfigurationOption(t,a,f){return this.lastArgs=[t,a,f],Promise.resolve(void 0)}}function w(){return new V(new h,new class extends p(){},new class extends p(){getCapabilities(){return v?x.PathCaseSensitive:void 0}},new n,new class extends p(){})}function c(o=Object.create(null),t){return t||(t=new class extends p(){}),new E(t,w(),k(o),new n)}function k(o){return{defaults:new s(o,[],[],void 0,new n),policy:s.createEmptyModel(new n),application:s.createEmptyModel(new n),user:new s(o,[],[],void 0,new n),workspace:s.createEmptyModel(new n),folders:[],configurationScopes:[]}}const m=O();test("getConfiguration fails regression test 1.7.1 -> 1.8 #15552",function(){const o=c({search:{exclude:{"**/node_modules":!0}}});e.strictEqual(o.getConfiguration("search.exclude")["**/node_modules"],!0),e.strictEqual(o.getConfiguration("search.exclude").get("**/node_modules"),!0),e.strictEqual(o.getConfiguration("search").get("exclude")["**/node_modules"],!0),e.strictEqual(o.getConfiguration("search.exclude").has("**/node_modules"),!0),e.strictEqual(o.getConfiguration("search").has("exclude.**/node_modules"),!0)}),test("has/get",()=>{const t=c({farboo:{config0:!0,nested:{config1:42,config2:"Das Pferd frisst kein Reis."},config4:""}}).getConfiguration("farboo");e.ok(t.has("config0")),e.strictEqual(t.get("config0"),!0),e.strictEqual(t.get("config4"),""),e.strictEqual(t.config0,!0),e.strictEqual(t.config4,""),e.ok(t.has("nested.config1")),e.strictEqual(t.get("nested.config1"),42),e.ok(t.has("nested.config2")),e.strictEqual(t.get("nested.config2"),"Das Pferd frisst kein Reis."),e.ok(t.has("nested")),e.deepStrictEqual(t.get("nested"),{config1:42,config2:"Das Pferd frisst kein Reis."})}),test("can modify the returned configuration",function(){const o=c({farboo:{config0:!0,nested:{config1:42,config2:"Das Pferd frisst kein Reis."},config4:""},workbench:{colorCustomizations:{"statusBar.foreground":"somevalue"}}});let t=o.getConfiguration(),a=t.get("farboo");a.nested.config1=41,e.strictEqual(41,a.nested.config1),a.farboo1="newValue",e.strictEqual("newValue",a.farboo1),t=o.getConfiguration(),a=t.get("farboo"),e.strictEqual(a.nested.config1,42),e.strictEqual(a.farboo1,void 0),t=o.getConfiguration(),a=t.get("farboo"),e.strictEqual(a.config0,!0),a.config0=!1,e.strictEqual(a.config0,!1),t=o.getConfiguration(),a=t.get("farboo"),e.strictEqual(a.config0,!0),t=o.getConfiguration(),a=t.inspect("farboo"),a.value="effectiveValue",e.strictEqual("effectiveValue",a.value),t=o.getConfiguration("workbench"),a=t.get("colorCustomizations"),a["statusBar.foreground"]=void 0,e.strictEqual(a["statusBar.foreground"],void 0),t=o.getConfiguration("workbench"),a=t.get("colorCustomizations"),e.strictEqual(a["statusBar.foreground"],"somevalue")}),test("Stringify returned configuration",function(){const o=c({farboo:{config0:!0,nested:{config1:42,config2:"Das Pferd frisst kein Reis."},config4:""},workbench:{colorCustomizations:{"statusBar.foreground":"somevalue"},emptyobjectkey:{}}}),t=o.getConfiguration();let a=t.get("farboo");e.deepStrictEqual(JSON.stringify({config0:!0,nested:{config1:42,config2:"Das Pferd frisst kein Reis."},config4:""}),JSON.stringify(a)),e.deepStrictEqual(void 0,JSON.stringify(t.get("unknownkey"))),a=t.get("farboo"),a.config0=!1,e.deepStrictEqual(JSON.stringify({config0:!1,nested:{config1:42,config2:"Das Pferd frisst kein Reis."},config4:""}),JSON.stringify(a)),a=t.get("workbench").colorCustomizations,a["statusBar.background"]="anothervalue",e.deepStrictEqual(JSON.stringify({"statusBar.foreground":"somevalue","statusBar.background":"anothervalue"}),JSON.stringify(a)),a=t.get("workbench"),a.unknownkey="somevalue",e.deepStrictEqual(JSON.stringify({colorCustomizations:{"statusBar.foreground":"somevalue"},emptyobjectkey:{},unknownkey:"somevalue"}),JSON.stringify(a)),a=o.getConfiguration("workbench").get("emptyobjectkey"),a={...a||{},"statusBar.background":"#0ff","statusBar.foreground":"#ff0"},e.deepStrictEqual(JSON.stringify({"statusBar.background":"#0ff","statusBar.foreground":"#ff0"}),JSON.stringify(a)),a=o.getConfiguration("workbench").get("unknownkey"),a={...a||{},"statusBar.background":"#0ff","statusBar.foreground":"#ff0"},e.deepStrictEqual(JSON.stringify({"statusBar.background":"#0ff","statusBar.foreground":"#ff0"}),JSON.stringify(a))}),test("cannot modify returned configuration",function(){const t=c({farboo:{config0:!0,nested:{config1:42,config2:"Das Pferd frisst kein Reis."},config4:""}}).getConfiguration();try{t.get=null,e.fail("This should be readonly")}catch{}try{t.farboo.config0=!1,e.fail("This should be readonly")}catch{}try{t.farboo.farboo1="hello",e.fail("This should be readonly")}catch{}}),test("inspect in no workspace context",function(){const o=new E(new class extends p(){},w(),{defaults:new s({editor:{wordWrap:"off"}},["editor.wordWrap"],[],void 0,new n),policy:s.createEmptyModel(new n),application:s.createEmptyModel(new n),user:new s({editor:{wordWrap:"on"}},["editor.wordWrap"],[],void 0,new n),workspace:new s({},[],[],void 0,new n),folders:[],configurationScopes:[]},new n);let t=o.getConfiguration().inspect("editor.wordWrap");e.strictEqual(t.defaultValue,"off"),e.strictEqual(t.globalValue,"on"),e.strictEqual(t.workspaceValue,void 0),e.strictEqual(t.workspaceFolderValue,void 0),t=o.getConfiguration("editor").inspect("wordWrap"),e.strictEqual(t.defaultValue,"off"),e.strictEqual(t.globalValue,"on"),e.strictEqual(t.workspaceValue,void 0),e.strictEqual(t.workspaceFolderValue,void 0)}),test("inspect in single root context",function(){const o=g.file("foo"),t=[],a=new s({editor:{wordWrap:"bounded"}},["editor.wordWrap"],[],void 0,new n);t.push([o,a]);const f=w();f.$initializeWorkspace({id:"foo",folders:[b(g.file("foo"),0)],name:"foo"},!0);const l=new E(new class extends p(){},f,{defaults:new s({editor:{wordWrap:"off"}},["editor.wordWrap"],[],void 0,new n),policy:s.createEmptyModel(new n),application:s.createEmptyModel(new n),user:new s({editor:{wordWrap:"on"}},["editor.wordWrap"],[],void 0,new n),workspace:a,folders:t,configurationScopes:[]},new n);let i=l.getConfiguration().inspect("editor.wordWrap");e.strictEqual(i.defaultValue,"off"),e.strictEqual(i.globalValue,"on"),e.strictEqual(i.workspaceValue,"bounded"),e.strictEqual(i.workspaceFolderValue,void 0),i=l.getConfiguration("editor").inspect("wordWrap"),e.strictEqual(i.defaultValue,"off"),e.strictEqual(i.globalValue,"on"),e.strictEqual(i.workspaceValue,"bounded"),e.strictEqual(i.workspaceFolderValue,void 0);let u=l.getConfiguration(void 0,o).inspect("editor.wordWrap");e.strictEqual(u.defaultValue,"off"),e.strictEqual(u.globalValue,"on"),e.strictEqual(u.workspaceValue,"bounded"),e.strictEqual(u.workspaceFolderValue,"bounded"),u=l.getConfiguration("editor",o).inspect("wordWrap"),e.strictEqual(u.defaultValue,"off"),e.strictEqual(u.globalValue,"on"),e.strictEqual(u.workspaceValue,"bounded"),e.strictEqual(u.workspaceFolderValue,"bounded")}),test("inspect in multi root context",function(){const o=new s({editor:{wordWrap:"bounded"}},["editor.wordWrap"],[],void 0,new n),t=g.file("foo1"),a=g.file("foo2"),f=g.file("foo3"),l=[];l.push([t,new s({editor:{wordWrap:"off",lineNumbers:"relative"}},["editor.wordWrap"],[],void 0,new n)]),l.push([a,new s({editor:{wordWrap:"on"}},["editor.wordWrap"],[],void 0,new n)]),l.push([f,new s({},[],[],void 0,new n)]);const i=w();i.$initializeWorkspace({id:"foo",folders:[b(t,0),b(a,1)],name:"foo"},!0);const u=new E(new class extends p(){},i,{defaults:new s({editor:{wordWrap:"off",lineNumbers:"on"}},["editor.wordWrap"],[],void 0,new n),policy:s.createEmptyModel(new n),application:s.createEmptyModel(new n),user:new s({editor:{wordWrap:"on"}},["editor.wordWrap"],[],void 0,new n),workspace:o,folders:l,configurationScopes:[]},new n);let d=u.getConfiguration().inspect("editor.wordWrap");e.strictEqual(d.defaultValue,"off"),e.strictEqual(d.globalValue,"on"),e.strictEqual(d.workspaceValue,"bounded"),e.strictEqual(d.workspaceFolderValue,void 0),d=u.getConfiguration("editor").inspect("wordWrap"),e.strictEqual(d.defaultValue,"off"),e.strictEqual(d.globalValue,"on"),e.strictEqual(d.workspaceValue,"bounded"),e.strictEqual(d.workspaceFolderValue,void 0),d=u.getConfiguration("editor").inspect("lineNumbers"),e.strictEqual(d.defaultValue,"on"),e.strictEqual(d.globalValue,void 0),e.strictEqual(d.workspaceValue,void 0),e.strictEqual(d.workspaceFolderValue,void 0);let r=u.getConfiguration(void 0,t).inspect("editor.wordWrap");e.strictEqual(r.defaultValue,"off"),e.strictEqual(r.globalValue,"on"),e.strictEqual(r.workspaceValue,"bounded"),e.strictEqual(r.workspaceFolderValue,"off"),r=u.getConfiguration("editor",t).inspect("wordWrap"),e.strictEqual(r.defaultValue,"off"),e.strictEqual(r.globalValue,"on"),e.strictEqual(r.workspaceValue,"bounded"),e.strictEqual(r.workspaceFolderValue,"off"),r=u.getConfiguration("editor",t).inspect("lineNumbers"),e.strictEqual(r.defaultValue,"on"),e.strictEqual(r.globalValue,void 0),e.strictEqual(r.workspaceValue,void 0),e.strictEqual(r.workspaceFolderValue,"relative"),r=u.getConfiguration(void 0,a).inspect("editor.wordWrap"),e.strictEqual(r.defaultValue,"off"),e.strictEqual(r.globalValue,"on"),e.strictEqual(r.workspaceValue,"bounded"),e.strictEqual(r.workspaceFolderValue,"on"),r=u.getConfiguration("editor",a).inspect("wordWrap"),e.strictEqual(r.defaultValue,"off"),e.strictEqual(r.globalValue,"on"),e.strictEqual(r.workspaceValue,"bounded"),e.strictEqual(r.workspaceFolderValue,"on"),r=u.getConfiguration(void 0,f).inspect("editor.wordWrap"),e.strictEqual(r.defaultValue,"off"),e.strictEqual(r.globalValue,"on"),e.strictEqual(r.workspaceValue,"bounded"),e.ok(Object.keys(r).indexOf("workspaceFolderValue")!==-1),e.strictEqual(r.workspaceFolderValue,void 0),r=u.getConfiguration("editor",f).inspect("wordWrap"),e.strictEqual(r.defaultValue,"off"),e.strictEqual(r.globalValue,"on"),e.strictEqual(r.workspaceValue,"bounded"),e.ok(Object.keys(r).indexOf("workspaceFolderValue")!==-1),e.strictEqual(r.workspaceFolderValue,void 0)}),test("inspect with language overrides",function(){const o=g.file("foo1"),t=g.file("foo2"),a=[];a.push([o,q({"editor.wordWrap":"bounded","[typescript]":{"editor.wordWrap":"unbounded"}})]),a.push([t,q({})]);const f=w();f.$initializeWorkspace({id:"foo",folders:[b(o,0),b(t,1)],name:"foo"},!0);const l=new E(new class extends p(){},f,{defaults:q({"editor.wordWrap":"off","[markdown]":{"editor.wordWrap":"bounded"}}),policy:s.createEmptyModel(new n),application:s.createEmptyModel(new n),user:q({"editor.wordWrap":"bounded","[typescript]":{"editor.lineNumbers":"off"}}),workspace:q({"[typescript]":{"editor.wordWrap":"unbounded","editor.lineNumbers":"off"}}),folders:a,configurationScopes:[]},new n);let i=l.getConfiguration(void 0,{uri:o,languageId:"typescript"}).inspect("editor.wordWrap");e.strictEqual(i.defaultValue,"off"),e.strictEqual(i.globalValue,"bounded"),e.strictEqual(i.workspaceValue,void 0),e.strictEqual(i.workspaceFolderValue,"bounded"),e.strictEqual(i.defaultLanguageValue,void 0),e.strictEqual(i.globalLanguageValue,void 0),e.strictEqual(i.workspaceLanguageValue,"unbounded"),e.strictEqual(i.workspaceFolderLanguageValue,"unbounded"),e.deepStrictEqual(i.languageIds,["markdown","typescript"]),i=l.getConfiguration(void 0,{uri:t,languageId:"typescript"}).inspect("editor.wordWrap"),e.strictEqual(i.defaultValue,"off"),e.strictEqual(i.globalValue,"bounded"),e.strictEqual(i.workspaceValue,void 0),e.strictEqual(i.workspaceFolderValue,void 0),e.strictEqual(i.defaultLanguageValue,void 0),e.strictEqual(i.globalLanguageValue,void 0),e.strictEqual(i.workspaceLanguageValue,"unbounded"),e.strictEqual(i.workspaceFolderLanguageValue,void 0),e.deepStrictEqual(i.languageIds,["markdown","typescript"])}),test("application is not set in inspect",()=>{const o=new E(new class extends p(){},w(),{defaults:new s({editor:{wordWrap:"off",lineNumbers:"on",fontSize:"12px"}},["editor.wordWrap"],[],void 0,new n),policy:s.createEmptyModel(new n),application:new s({editor:{wordWrap:"on"}},["editor.wordWrap"],[],void 0,new n),user:new s({editor:{wordWrap:"auto",lineNumbers:"off"}},["editor.wordWrap"],[],void 0,new n),workspace:new s({},[],[],void 0,new n),folders:[],configurationScopes:[]},new n);let t=o.getConfiguration().inspect("editor.wordWrap");e.strictEqual(t.defaultValue,"off"),e.strictEqual(t.globalValue,"auto"),e.strictEqual(t.workspaceValue,void 0),e.strictEqual(t.workspaceFolderValue,void 0),e.strictEqual(o.getConfiguration().get("editor.wordWrap"),"auto"),t=o.getConfiguration().inspect("editor.lineNumbers"),e.strictEqual(t.defaultValue,"on"),e.strictEqual(t.globalValue,"off"),e.strictEqual(t.workspaceValue,void 0),e.strictEqual(t.workspaceFolderValue,void 0),e.strictEqual(o.getConfiguration().get("editor.lineNumbers"),"off"),t=o.getConfiguration().inspect("editor.fontSize"),e.strictEqual(t.defaultValue,"12px"),e.strictEqual(t.globalValue,void 0),e.strictEqual(t.workspaceValue,void 0),e.strictEqual(t.workspaceFolderValue,void 0),e.strictEqual(o.getConfiguration().get("editor.fontSize"),"12px")}),test("getConfiguration vs get",function(){const o=c({farboo:{config0:!0,config4:38}});let t=o.getConfiguration("farboo.config0");e.strictEqual(t.get(""),void 0),e.strictEqual(t.has(""),!1),t=o.getConfiguration("farboo"),e.strictEqual(t.get("config0"),!0),e.strictEqual(t.has("config0"),!0)}),test("name vs property",function(){const t=c({farboo:{get:"get-prop"}}).getConfiguration("farboo");e.ok(t.has("get")),e.strictEqual(t.get("get"),"get-prop"),e.deepStrictEqual(t.get,t.get),e.throws(()=>t.get="get-prop")}),test("update: no target passes null",function(){const o=new C;c({foo:{bar:1,far:1}},o).getConfiguration("foo").update("bar",42),e.strictEqual(o.lastArgs[0],null)}),test("update/section to key",function(){const o=new C,t=c({foo:{bar:1,far:1}},o);let a=t.getConfiguration("foo");a.update("bar",42,!0),e.strictEqual(o.lastArgs[0],S.USER),e.strictEqual(o.lastArgs[1],"foo.bar"),e.strictEqual(o.lastArgs[2],42),a=t.getConfiguration(""),a.update("bar",42,!0),e.strictEqual(o.lastArgs[1],"bar"),a.update("foo.bar",42,!0),e.strictEqual(o.lastArgs[1],"foo.bar")}),test("update, what is #15834",function(){const o=new C;c({editor:{formatOnSave:!0}},o).getConfiguration("editor").update("formatOnSave",{extensions:["ts"]}),e.strictEqual(o.lastArgs[1],"editor.formatOnSave"),e.deepStrictEqual(o.lastArgs[2],{extensions:["ts"]})}),test("update/error-state not OK",function(){const o=new class extends p(){$updateConfigurationOption(t,a,f){return Promise.reject(new Error("Unknown Key"))}};return c({},o).getConfiguration("").update("",!0,!1).then(()=>e.ok(!1),t=>{})}),test("configuration change event",o=>{const t=b(g.file("folder1"),0),a=w();a.$initializeWorkspace({id:"foo",folders:[t],name:"foo"},!0);const f=new E(new class extends p(){},a,k({farboo:{config:!1,updatedConfig:!1}}),new n),l=k({farboo:{config:!1,updatedConfig:!0,newConfig:!0}}),i={keys:["farboo.updatedConfig","farboo.newConfig"],overrides:[]};m.add(f.onDidChangeConfiguration(u=>{e.deepStrictEqual(f.getConfiguration().get("farboo"),{config:!1,updatedConfig:!0,newConfig:!0}),e.ok(u.affectsConfiguration("farboo")),e.ok(u.affectsConfiguration("farboo",t.uri)),e.ok(u.affectsConfiguration("farboo",g.file("any"))),e.ok(u.affectsConfiguration("farboo.updatedConfig")),e.ok(u.affectsConfiguration("farboo.updatedConfig",t.uri)),e.ok(u.affectsConfiguration("farboo.updatedConfig",g.file("any"))),e.ok(u.affectsConfiguration("farboo.newConfig")),e.ok(u.affectsConfiguration("farboo.newConfig",t.uri)),e.ok(u.affectsConfiguration("farboo.newConfig",g.file("any"))),e.ok(!u.affectsConfiguration("farboo.config")),e.ok(!u.affectsConfiguration("farboo.config",t.uri)),e.ok(!u.affectsConfiguration("farboo.config",g.file("any"))),o()})),f.$acceptConfigurationChanged(l,i)}),test("get return instance of array value",function(){const o=c({far:{boo:[]}});o.getConfiguration().get("far.boo",[]).push("a");const a=o.getConfiguration().get("far.boo",[]);e.deepStrictEqual(a,[])});function b(o,t,a=""){return new W({uri:o,name:a,index:t})}function q(o){const t=new y("test",new n);return t.parse(JSON.stringify(o)),t.configurationModel}});
