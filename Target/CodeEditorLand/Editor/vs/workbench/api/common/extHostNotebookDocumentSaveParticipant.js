import{AsyncEmitter as p}from"../../../base/common/event.js";import{URI as d}from"../../../base/common/uri.js";import{SerializableObjectWithBuffers as v}from"../../services/extensions/common/proxyIdentifier.js";import{TextDocumentSaveReason as u,WorkspaceEdit as E}from"./extHostTypeConverters.js";import{WorkspaceEdit as f}from"./extHostTypes.js";class y{constructor(n,i,e,r={timeout:1500,errors:3}){this._logService=n;this._notebooksAndEditors=i;this._mainThreadBulkEdits=e;this._thresholds=r}_onWillSaveNotebookDocumentEvent=new p;dispose(){}getOnWillSaveNotebookDocumentEvent(n){return(i,e,r)=>{const o=function(t){i.call(e,t)};return o.extension=n,this._onWillSaveNotebookDocumentEvent.event(o,void 0,r)}}async $participateInSave(n,i,e){const r=d.revive(n),o=this._notebooksAndEditors.getNotebookDocument(r);if(!o)throw new Error("Unable to resolve notebook document");const s=[];if(await this._onWillSaveNotebookDocumentEvent.fireAsync({notebook:o.apiNotebook,reason:u.to(i)},e,async(c,a)=>{const m=Date.now(),l=await await Promise.resolve(c);Date.now()-m>this._thresholds.timeout&&this._logService.warn("onWillSaveNotebookDocument-listener from extension",a.extension.identifier),!e.isCancellationRequested&&l&&(l instanceof f?s.push(l):this._logService.warn("onWillSaveNotebookDocument-listener from extension",a.extension.identifier,"ignored due to invalid data"))}),e.isCancellationRequested)return!1;if(s.length===0)return!0;const t={edits:[]};for(const c of s){const{edits:a}=E.from(c);t.edits=t.edits.concat(a)}return this._mainThreadBulkEdits.$tryApplyWorkspaceEdit(new v(t))}}export{y as ExtHostNotebookDocumentSaveParticipant};
