var u=Object.defineProperty;var g=Object.getOwnPropertyDescriptor;var f=(d,o,i,e)=>{for(var t=e>1?void 0:e?g(o,i):o,a=d.length-1,n;a>=0;a--)(n=d[a])&&(t=(e?n(o,i,t):n(t))||t);return e&&t&&u(o,i,t),t},v=(d,o)=>(i,e)=>o(i,e,d);import{asArray as y,groupBy as x}from"../../../../vs/base/common/arrays.js";import"../../../../vs/base/common/cancellation.js";import{dirname as _}from"../../../../vs/base/common/path.js";import{compare as I,count as P}from"../../../../vs/base/common/strings.js";import{URI as S}from"../../../../vs/base/common/uri.js";import"../../../../vs/platform/extensions/common/extensions.js";import{createDecorator as b}from"../../../../vs/platform/instantiation/common/instantiation.js";import{ILogService as E}from"../../../../vs/platform/log/common/log.js";import{MainContext as C}from"../../../../vs/workbench/api/common/extHost.protocol.js";import{IExtHostRpcService as R}from"../../../../vs/workbench/api/common/extHostRpcService.js";import{Disposable as k,FileDecoration as $}from"../../../../vs/workbench/api/common/extHostTypes.js";import{checkProposedApiEnabled as F}from"../../../../vs/workbench/services/extensions/common/extensions.js";let s=class{constructor(o,i){this._logService=i;this._proxy=o.getProxy(C.MainThreadDecorations)}static _handlePool=0;static _maxEventSize=250;_serviceBrand;_provider=new Map;_proxy;registerFileDecorationProvider(o,i){const e=s._handlePool++;this._provider.set(e,{provider:o,extensionDescription:i}),this._proxy.$registerDecorationProvider(e,i.identifier.value);const t=o.onDidChangeFileDecorations&&o.onDidChangeFileDecorations(a=>{if(!a){this._proxy.$onDidChange(e,null);return}const n=y(a);if(n.length<=s._maxEventSize){this._proxy.$onDidChange(e,n);return}this._logService.warn("[Decorations] CAPPING events from decorations provider",i.identifier.value,n.length);const m=n.map(r=>({uri:r,rank:P(r.path,"/")})),p=x(m,(r,c)=>r.rank-c.rank||I(r.uri.path,c.uri.path)),l=[];e:for(const r of p){let c;for(const D of r){const h=_(D.uri.path);if(c!==h&&(c=h,l.push(D.uri)>=s._maxEventSize))break e}}this._proxy.$onDidChange(e,l)});return new k(()=>{t?.dispose(),this._proxy.$unregisterDecorationProvider(e),this._provider.delete(e)})}async $provideDecorations(o,i,e){if(!this._provider.has(o))return Object.create(null);const t=Object.create(null),{provider:a,extensionDescription:n}=this._provider.get(o);return await Promise.all(i.map(async m=>{try{const{uri:p,id:l}=m,r=await Promise.resolve(a.provideFileDecoration(S.revive(p),e));if(!r)return;try{$.validate(r),r.badge&&typeof r.badge!="string"&&F(n,"codiconDecoration"),t[l]=[r.propagate,r.tooltip,r.badge,r.color]}catch(c){this._logService.warn(`INVALID decoration from extension '${n.identifier.value}': ${c}`)}}catch(p){this._logService.error(p)}})),t}};s=f([v(0,R),v(1,E)],s);const Y=b("IExtHostDecorations");export{s as ExtHostDecorations,Y as IExtHostDecorations};
