var p=Object.defineProperty;var m=Object.getOwnPropertyDescriptor;var v=(i,e,t,r)=>{for(var o=r>1?void 0:r?m(e,t):e,a=i.length-1,s;a>=0;a--)(s=i[a])&&(o=(r?s(e,t,o):s(o))||o);return r&&o&&p(e,t,o),o},c=(i,e)=>(t,r)=>e(t,r,i);import{toDisposable as h}from"../../../base/common/lifecycle.js";import{MainContext as I}from"./extHost.protocol.js";import{createDecorator as u}from"../../../platform/instantiation/common/instantiation.js";import{FileSearchManager as P}from"../../services/search/common/fileSearchManager.js";import{IExtHostRpcService as T}from"./extHostRpcService.js";import{IURITransformerService as g}from"./extHostUriTransformerService.js";import{ILogService as _}from"../../../platform/log/common/log.js";import"../../services/search/common/search.js";import{URI as f}from"../../../base/common/uri.js";import{TextSearchManager as x}from"../../services/search/common/textSearchManager.js";import"../../../base/common/cancellation.js";import{revive as y}from"../../../base/common/marshalling.js";import{OldAITextSearchProviderConverter as w,OldFileSearchProviderConverter as U,OldTextSearchProviderConverter as F}from"../../services/search/common/searchExtConversionTypes.js";const ie=u("IExtHostSearch");let n=class{constructor(e,t,r){this.extHostRpc=e;this._uriTransformer=t;this._logService=r}_proxy=this.extHostRpc.getProxy(I.MainThreadSearch);_handlePool=0;_textSearchProvider=new Map;_textSearchUsedSchemes=new Set;_aiTextSearchProvider=new Map;_aiTextSearchUsedSchemes=new Set;_fileSearchProvider=new Map;_fileSearchUsedSchemes=new Set;_fileSearchManager=new P;_transformScheme(e){return this._uriTransformer.transformOutgoingScheme(e)}registerTextSearchProviderOld(e,t){if(this._textSearchUsedSchemes.has(e))throw new Error(`a text search provider for the scheme '${e}' is already registered`);this._textSearchUsedSchemes.add(e);const r=this._handlePool++;return this._textSearchProvider.set(r,new F(t)),this._proxy.$registerTextSearchProvider(r,this._transformScheme(e)),h(()=>{this._textSearchUsedSchemes.delete(e),this._textSearchProvider.delete(r),this._proxy.$unregisterProvider(r)})}registerTextSearchProvider(e,t){if(this._textSearchUsedSchemes.has(e))throw new Error(`a text search provider for the scheme '${e}' is already registered`);this._textSearchUsedSchemes.add(e);const r=this._handlePool++;return this._textSearchProvider.set(r,t),this._proxy.$registerTextSearchProvider(r,this._transformScheme(e)),h(()=>{this._textSearchUsedSchemes.delete(e),this._textSearchProvider.delete(r),this._proxy.$unregisterProvider(r)})}registerAITextSearchProviderOld(e,t){if(this._aiTextSearchUsedSchemes.has(e))throw new Error(`an AI text search provider for the scheme '${e}'is already registered`);this._aiTextSearchUsedSchemes.add(e);const r=this._handlePool++;return this._aiTextSearchProvider.set(r,new w(t)),this._proxy.$registerAITextSearchProvider(r,this._transformScheme(e)),h(()=>{this._aiTextSearchUsedSchemes.delete(e),this._aiTextSearchProvider.delete(r),this._proxy.$unregisterProvider(r)})}registerAITextSearchProvider(e,t){if(this._aiTextSearchUsedSchemes.has(e))throw new Error(`an AI text search provider for the scheme '${e}'is already registered`);this._aiTextSearchUsedSchemes.add(e);const r=this._handlePool++;return this._aiTextSearchProvider.set(r,t),this._proxy.$registerAITextSearchProvider(r,this._transformScheme(e)),h(()=>{this._aiTextSearchUsedSchemes.delete(e),this._aiTextSearchProvider.delete(r),this._proxy.$unregisterProvider(r)})}registerFileSearchProviderOld(e,t){if(this._fileSearchUsedSchemes.has(e))throw new Error(`a file search provider for the scheme '${e}' is already registered`);this._fileSearchUsedSchemes.add(e);const r=this._handlePool++;return this._fileSearchProvider.set(r,new U(t)),this._proxy.$registerFileSearchProvider(r,this._transformScheme(e)),h(()=>{this._fileSearchUsedSchemes.delete(e),this._fileSearchProvider.delete(r),this._proxy.$unregisterProvider(r)})}registerFileSearchProvider(e,t){if(this._fileSearchUsedSchemes.has(e))throw new Error(`a file search provider for the scheme '${e}' is already registered`);this._fileSearchUsedSchemes.add(e);const r=this._handlePool++;return this._fileSearchProvider.set(r,t),this._proxy.$registerFileSearchProvider(r,this._transformScheme(e)),h(()=>{this._fileSearchUsedSchemes.delete(e),this._fileSearchProvider.delete(r),this._proxy.$unregisterProvider(r)})}$provideFileSearchResults(e,t,r,o){const a=l(r),s=this._fileSearchProvider.get(e);if(s)return this._fileSearchManager.fileSearch(a,s,S=>{this._proxy.$handleFileMatch(e,t,S.map(d=>d.resource))},o);throw new Error("unknown provider: "+e)}async doInternalFileSearchWithCustomCallback(e,t,r){return{messages:[]}}$clearCache(e){return this._fileSearchManager.clearCache(e),Promise.resolve(void 0)}$provideTextSearchResults(e,t,r,o){const a=this._textSearchProvider.get(e);if(!a||!a.provideTextSearchResults)throw new Error(`Unknown Text Search Provider ${e}`);const s=l(r);return this.createTextSearchManager(s,a).search(d=>this._proxy.$handleTextMatch(e,t,d),o)}$provideAITextSearchResults(e,t,r,o){const a=this._aiTextSearchProvider.get(e);if(!a||!a.provideAITextSearchResults)throw new Error(`Unknown AI Text Search Provider ${e}`);const s=l(r);return this.createAITextSearchManager(s,a).search(d=>this._proxy.$handleTextMatch(e,t,d),o)}$enableExtensionHostSearch(){}async $getAIName(e){const t=this._aiTextSearchProvider.get(e);if(!(!t||!t.provideAITextSearchResults))return t.name??"AI"}createTextSearchManager(e,t){return new x({query:e,provider:t},{readdir:r=>Promise.resolve([]),toCanonicalName:r=>r},"textSearchProvider")}createAITextSearchManager(e,t){return new x({query:e,provider:t},{readdir:r=>Promise.resolve([]),toCanonicalName:r=>r},"aiTextSearchProvider")}};n=v([c(0,T),c(1,g),c(2,_)],n);function l(i){return{...i,folderQueries:i.folderQueries&&i.folderQueries.map(A),extraFileResources:i.extraFileResources&&i.extraFileResources.map(e=>f.revive(e))}}function A(i){return y(i)}export{n as ExtHostSearch,ie as IExtHostSearch,l as reviveQuery};
