import*as d from"../../../base/common/errors.js";import*as _ from"../../../base/common/performance.js";import{URI as t}from"../../../base/common/uri.js";import{getSingletonServiceDescriptors as k}from"../../../platform/instantiation/common/extensions.js";import{InstantiationService as P}from"../../../platform/instantiation/common/instantiationService.js";import{ServiceCollection as w}from"../../../platform/instantiation/common/serviceCollection.js";import{ILogService as E}from"../../../platform/log/common/log.js";import{RPCProtocol as M}from"../../services/extensions/common/rpcProtocol.js";import{MainContext as g}from"./extHost.protocol.js";import{IExtHostExtensionService as y,IHostUtils as b}from"./extHostExtensionService.js";import{IExtHostInitDataService as L}from"./extHostInitDataService.js";import{ExtHostRpcService as F,IExtHostRpcService as h}from"./extHostRpcService.js";import{IExtHostTelemetry as C}from"./extHostTelemetry.js";import{IURITransformerService as $,URITransformerService as j}from"./extHostUriTransformerService.js";class H{static async installEarlyHandler(e){Error.stackTraceLimit=100;const r=e.get(E),o=e.get(h).getProxy(g.MainThreadErrors);d.setUnexpectedErrorHandler(m=>{r.error(m);const a=d.transformErrorForSerialization(m);o.$onUnexpectedError(a)})}static async installFullHandler(e){const r=e.get(E),i=e.get(h),o=e.get(y),m=e.get(C),a=i.getProxy(g.MainThreadExtensionService),l=i.getProxy(g.MainThreadErrors),p=await o.getExtensionPathIndex(),I=new WeakMap;function f(n,c){if(I.has(n))return I.get(n).stack;let s="",v,S;for(const R of c)s+=`
	at ${R.toString()}`,S=R.getFileName(),!v&&S&&(v=p.findSubstr(t.file(S)));const u=`${n.name||"Error"}: ${n.message||""}${s}`;return I.set(n,{extensionIdentifier:v?.identifier,stack:u}),u}const U=Symbol("prepareStackTrace wrapped");let x=f;Object.defineProperty(Error,"prepareStackTrace",{configurable:!1,get(){return x},set(n){if(n===f||!n||n[U]){x=n||f;return}x=(c,s)=>(f(c,s),n.call(Error,c,s)),Object.assign(x,{[U]:!0})}}),d.setUnexpectedErrorHandler(n=>{r.error(n);const c=d.transformErrorForSerialization(n),s=I.get(n);if(!s?.extensionIdentifier){l.$onUnexpectedError(c);return}a.$onExtensionRuntimeError(s.extensionIdentifier,c);const v=m.onExtensionError(s.extensionIdentifier,n);r.trace("forwarded error to extension?",v,s)})}}class T{_hostUtils;_rpcProtocol;_extensionService;_logService;constructor(e,r,i,o,m){this._hostUtils=i,this._rpcProtocol=new M(e,null,o),r=T._transform(r,this._rpcProtocol);const a=new w(...k());a.set(L,{_serviceBrand:void 0,...r,messagePorts:m}),a.set(h,new F(this._rpcProtocol)),a.set($,new j(o)),a.set(b,i);const l=new P(a,!0);l.invokeFunction(H.installEarlyHandler),this._logService=l.invokeFunction(p=>p.get(E)),_.mark("code/extHost/didCreateServices"),this._hostUtils.pid?this._logService.info(`Extension host with pid ${this._hostUtils.pid} started`):this._logService.info("Extension host started"),this._logService.trace("initData",r),this._extensionService=l.invokeFunction(p=>p.get(y)),this._extensionService.initialize(),l.invokeFunction(H.installFullHandler)}async asBrowserUri(e){const r=this._rpcProtocol.getProxy(g.MainThreadExtensionService);return t.revive(await r.$asBrowserUri(e))}terminate(e){this._extensionService.terminate(e)}static _transform(e,r){e.extensions.allExtensions.forEach(o=>{o.extensionLocation=t.revive(r.transformIncomingURIs(o.extensionLocation))}),e.environment.appRoot=t.revive(r.transformIncomingURIs(e.environment.appRoot));const i=e.environment.extensionDevelopmentLocationURI;return i&&(e.environment.extensionDevelopmentLocationURI=i.map(o=>t.revive(r.transformIncomingURIs(o)))),e.environment.extensionTestsLocationURI=t.revive(r.transformIncomingURIs(e.environment.extensionTestsLocationURI)),e.environment.globalStorageHome=t.revive(r.transformIncomingURIs(e.environment.globalStorageHome)),e.environment.workspaceStorageHome=t.revive(r.transformIncomingURIs(e.environment.workspaceStorageHome)),e.environment.extensionTelemetryLogResource=t.revive(r.transformIncomingURIs(e.environment.extensionTelemetryLogResource)),e.nlsBaseUrl=t.revive(r.transformIncomingURIs(e.nlsBaseUrl)),e.logsLocation=t.revive(r.transformIncomingURIs(e.logsLocation)),e.workspace=r.transformIncomingURIs(e.workspace),e}}export{H as ErrorHandler,T as ExtensionHostMain};
