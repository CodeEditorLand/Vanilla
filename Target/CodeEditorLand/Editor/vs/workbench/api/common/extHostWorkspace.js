var Q=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var O=(d,r,e,t)=>{for(var i=t>1?void 0:t?G(r,e):r,n=d.length-1,s;n>=0;n--)(s=d[n])&&(i=(t?s(r,e,i):s(i))||i);return t&&i&&Q(r,e,i),i},k=(d,r)=>(e,t)=>r(e,t,d);import{delta as q,mapArrayOrNot as H}from"../../../base/common/arrays.js";import{AsyncIterableObject as z,Barrier as K}from"../../../base/common/async.js";import{CancellationToken as x}from"../../../base/common/cancellation.js";import{AsyncEmitter as j,Emitter as U}from"../../../base/common/event.js";import{DisposableStore as J,toDisposable as N}from"../../../base/common/lifecycle.js";import{TernarySearchTree as V}from"../../../base/common/ternarySearchTree.js";import{Schemas as X}from"../../../base/common/network.js";import{Counter as Y}from"../../../base/common/numbers.js";import{basename as Z,basenameOrAuthority as $,dirname as D,ExtUri as ee,relativePath as re}from"../../../base/common/resources.js";import{compare as T}from"../../../base/common/strings.js";import{URI as v}from"../../../base/common/uri.js";import{localize as te}from"../../../nls.js";import{FileSystemProviderCapabilities as ie}from"../../../platform/files/common/files.js";import{createDecorator as ne}from"../../../platform/instantiation/common/instantiation.js";import{ILogService as se}from"../../../platform/log/common/log.js";import{Severity as oe}from"../../../platform/notification/common/notification.js";import{Workspace as ae,WorkspaceFolder as de}from"../../../platform/workspace/common/workspace.js";import{IExtHostFileSystemInfo as le}from"./extHostFileSystemInfo.js";import{IExtHostInitDataService as ce}from"./extHostInitDataService.js";import{IExtHostRpcService as ue}from"./extHostRpcService.js";import{GlobPattern as C}from"./extHostTypeConverters.js";import{Range as w}from"./extHostTypes.js";import{IURITransformerService as fe}from"./extHostUriTransformerService.js";import{resultIsMatch as M}from"../../services/search/common/search.js";import{MainContext as B}from"./extHost.protocol.js";import{revive as pe}from"../../../base/common/marshalling.js";import{ExcludeSettingOptions as I,TextSearchContextNew as ve,TextSearchMatchNew as he}from"../../services/search/common/searchExtTypes.js";function F(d,r,e){return new ee(t=>R(t,e)).isEqual(d,r)}function me(d,r,e){return F(d.uri,r.uri,e)?0:T(d.uri.toString(),r.uri.toString())}function ge(d,r,e){return d.index!==r.index?d.index<r.index?-1:1:F(d.uri,r.uri,e)?T(d.name,r.name):T(d.uri.toString(),r.uri.toString())}function A(d,r,e,t){const i=d.slice(0).sort((s,o)=>e(s,o,t)),n=r.slice(0).sort((s,o)=>e(s,o,t));return q(i,n,(s,o)=>e(s,o,t))}function R(d,r){const e=r.getCapabilities(d.scheme);return!(e&&e&ie.PathCaseSensitive)}class y extends ae{constructor(e,t,i,n,s,o,l){super(e,i.map(u=>new de(u)),n,s,l);this._name=t;this._isUntitled=o;this._structure=V.forUris(l,()=>!0),i.forEach(u=>{this._workspaceFolders.push(u),this._structure.set(u.uri,u)})}static toExtHostWorkspace(e,t,i,n){if(!e)return{workspace:null,added:[],removed:[]};const{id:s,name:o,folders:l,configuration:u,transient:a,isUntitled:p}=e,c=[],f=t;t?l.forEach((g,S)=>{const _=v.revive(g.uri),E=y._findFolder(i||t,_,n);E?(E.name=g.name,E.index=g.index,c.push(E)):c.push({uri:_,name:g.name,index:S})}):c.push(...l.map(({uri:g,name:S,index:_})=>({uri:v.revive(g),name:S,index:_}))),c.sort((g,S)=>g.index<S.index?-1:1);const h=new y(s,o,c,!!a,u?v.revive(u):null,!!p,g=>R(g,n)),{added:W,removed:m}=A(f?f.workspaceFolders:[],h.workspaceFolders,me,n);return{workspace:h,added:W,removed:m}}static _findFolder(e,t,i){for(let n=0;n<e.folders.length;n++){const s=e.workspaceFolders[n];if(F(s.uri,t,i))return s}}_workspaceFolders=[];_structure;get name(){return this._name}get isUntitled(){return this._isUntitled}get workspaceFolders(){return this._workspaceFolders.slice(0)}getWorkspaceFolder(e,t){return t&&this._structure.get(e)&&(e=D(e)),this._structure.findSubstr(e)}resolveWorkspaceFolder(e){return this._structure.get(e)}}let P=class{_serviceBrand;_onDidChangeWorkspace=new U;onDidChangeWorkspace=this._onDidChangeWorkspace.event;_onDidGrantWorkspaceTrust=new U;onDidGrantWorkspaceTrust=this._onDidGrantWorkspaceTrust.event;_logService;_requestIdProvider;_barrier;_confirmedWorkspace;_unconfirmedWorkspace;_proxy;_messageService;_extHostFileSystemInfo;_uriTransformerService;_activeSearchCallbacks=[];_trusted=!1;_editSessionIdentityProviders=new Map;constructor(r,e,t,i,n){this._logService=i,this._extHostFileSystemInfo=t,this._uriTransformerService=n,this._requestIdProvider=new Y,this._barrier=new K,this._proxy=r.getProxy(B.MainThreadWorkspace),this._messageService=r.getProxy(B.MainThreadMessageService);const s=e.workspace;this._confirmedWorkspace=s?new y(s.id,s.name,[],!!s.transient,s.configuration?v.revive(s.configuration):null,!!s.isUntitled,o=>R(o,t)):void 0}$initializeWorkspace(r,e){this._trusted=e,this.$acceptWorkspaceData(r),this._barrier.open()}waitForInitializeCall(){return this._barrier.wait()}get workspace(){return this._actualWorkspace}get name(){return this._actualWorkspace?this._actualWorkspace.name:void 0}get workspaceFile(){if(this._actualWorkspace&&this._actualWorkspace.configuration)return this._actualWorkspace.isUntitled?v.from({scheme:X.untitled,path:Z(D(this._actualWorkspace.configuration))}):this._actualWorkspace.configuration}get _actualWorkspace(){return this._unconfirmedWorkspace||this._confirmedWorkspace}getWorkspaceFolders(){if(this._actualWorkspace)return this._actualWorkspace.workspaceFolders.slice(0)}async getWorkspaceFolders2(){if(await this._barrier.wait(),!!this._actualWorkspace)return this._actualWorkspace.workspaceFolders.slice(0)}updateWorkspaceFolders(r,e,t,...i){const n=[];if(Array.isArray(i)&&i.forEach(a=>{v.isUri(a.uri)&&!n.some(p=>F(p.uri,a.uri,this._extHostFileSystemInfo))&&n.push({uri:a.uri,name:a.name||$(a.uri)})}),this._unconfirmedWorkspace||[e,t].some(a=>typeof a!="number"||a<0)||t===0&&n.length===0)return!1;const s=this._actualWorkspace?this._actualWorkspace.workspaceFolders:[];if(e+t>s.length)return!1;const o=s.slice(0);o.splice(e,t,...n.map(a=>({uri:a.uri,name:a.name||$(a.uri),index:void 0})));for(let a=0;a<o.length;a++){const p=o[a];if(o.some((c,f)=>f!==a&&F(p.uri,c.uri,this._extHostFileSystemInfo)))return!1}o.forEach((a,p)=>a.index=p);const{added:l,removed:u}=A(s,o,ge,this._extHostFileSystemInfo);if(l.length===0&&u.length===0)return!1;if(this._proxy){const a=r.displayName||r.name;this._proxy.$updateWorkspaceFolders(a,e,t,n).then(void 0,p=>{this._unconfirmedWorkspace=void 0;const c={source:{identifier:r.identifier,label:r.displayName||r.name}};this._messageService.$showMessage(oe.Error,te("updateerror","Extension '{0}' failed to update workspace folders: {1}",a,p.toString()),c,[])})}return this.trySetWorkspaceFolders(o),!0}getWorkspaceFolder(r,e){if(this._actualWorkspace)return this._actualWorkspace.getWorkspaceFolder(r,e)}async getWorkspaceFolder2(r,e){if(await this._barrier.wait(),!!this._actualWorkspace)return this._actualWorkspace.getWorkspaceFolder(r,e)}async resolveWorkspaceFolder(r){if(await this._barrier.wait(),!!this._actualWorkspace)return this._actualWorkspace.resolveWorkspaceFolder(r)}getPath(){if(!this._actualWorkspace)return;const{folders:r}=this._actualWorkspace;if(r.length!==0)return r[0].uri.fsPath}getRelativePath(r,e){let t,i="";if(typeof r=="string"?(t=v.file(r),i=r):typeof r<"u"&&(t=r,i=r.fsPath),!t)return i;const n=this.getWorkspaceFolder(t,!0);if(!n)return i;typeof e>"u"&&this._actualWorkspace&&(e=this._actualWorkspace.folders.length>1);let s=re(n.uri,t);return e&&n.name&&(s=`${n.name}/${s}`),s}trySetWorkspaceFolders(r){this._actualWorkspace&&(this._unconfirmedWorkspace=y.toExtHostWorkspace({id:this._actualWorkspace.id,name:this._actualWorkspace.name,configuration:this._actualWorkspace.configuration,folders:r,isUntitled:this._actualWorkspace.isUntitled},this._actualWorkspace,void 0,this._extHostFileSystemInfo).workspace||void 0)}$acceptWorkspaceData(r){const{workspace:e,added:t,removed:i}=y.toExtHostWorkspace(r,this._confirmedWorkspace,this._unconfirmedWorkspace,this._extHostFileSystemInfo);this._confirmedWorkspace=e||void 0,this._unconfirmedWorkspace=void 0,this._onDidChangeWorkspace.fire(Object.freeze({added:t,removed:i}))}findFiles(r,e,t,i,n=x.None){this._logService.trace(`extHostWorkspace#findFiles: fileSearch, extension: ${i.value}, entryPoint: findFiles`);let s="",o=!0;return e===null?o=!1:e!==void 0&&(typeof e=="string"?s=e:s=e.pattern),this._findFilesImpl(r,void 0,{exclude:[s],maxResults:t,useExcludeSettings:o?I.FilesExclude:I.None,useIgnoreFiles:{local:!1}},n)}findFiles2(r,e={},t,i=x.None){this._logService.trace(`extHostWorkspace#findFiles2: fileSearch, extension: ${t.value}, entryPoint: findFiles2`);const n=e.useDefaultExcludes??!0,s=e.useDefaultSearchExcludes??!0,o=n?s?I.SearchAndFilesExclude:I.FilesExclude:I.None,l={exclude:e.exclude?[e.exclude]:void 0,useIgnoreFiles:{local:e.useIgnoreFiles,global:e.useGlobalIgnoreFiles,parent:e.useParentIgnoreFiles},useExcludeSettings:o,followSymlinks:e.followSymlinks,maxResults:e.maxResults};return this._findFilesImpl(void 0,r!==void 0?[r]:[],l,i)}findFiles2New(r,e={},t,i=x.None){return this._logService.trace(`extHostWorkspace#findFiles2New: fileSearch, extension: ${t.value}, entryPoint: findFiles2New`),this._findFilesImpl(void 0,r,e,i)}async _findFilesImpl(r,e,t,i=x.None){if(i&&i.isCancellationRequested)return Promise.resolve([]);const s=(r!==void 0?[r]:e)?.map(o=>{const l=L(t.exclude),u={ignoreSymlinks:typeof t.followSymlinks=="boolean"?!t.followSymlinks:void 0,disregardIgnoreFiles:typeof t.useIgnoreFiles?.local=="boolean"?!t.useIgnoreFiles.local:void 0,disregardGlobalIgnoreFiles:typeof t.useIgnoreFiles?.global=="boolean"?!t.useIgnoreFiles.global:void 0,disregardParentIgnoreFiles:typeof t.useIgnoreFiles?.parent=="boolean"?!t.useIgnoreFiles.parent:void 0,disregardExcludeSettings:t.useExcludeSettings!==void 0&&t.useExcludeSettings===I.None,disregardSearchExcludeSettings:t.useExcludeSettings!==void 0&&t.useExcludeSettings!==I.SearchAndFilesExclude,maxResults:t.maxResults,excludePattern:l.length>0?l:void 0,_reason:"startFileSearch",shouldGlobSearch:r?void 0:!0},a=b(C.from(o)),p=a?.folder;return r?u.includePattern=a?.pattern:u.filePattern=a?.pattern,{folder:p,options:u}})??[];return this._findFilesBase(s,i)}async _findFilesBase(r,e){return(await Promise.all(r?.map(i=>this._proxy.$startFileSearch(i.folder??null,i.options,e).then(n=>Array.isArray(n)?n.map(s=>v.revive(s)):[]))??[])).flat()}findTextInFilesNew(r,e,t,i=x.None){this._logService.trace(`extHostWorkspace#findTextInFilesNew: textSearch, extension: ${t.value}, entryPoint: findTextInFilesNew`);const n=c=>{if(!e)return{folder:void 0,options:{}};const f=c?b(C.from(c)):void 0,h=e.exclude?L(e.exclude):void 0;return{options:{ignoreSymlinks:typeof e.followSymlinks=="boolean"?!e.followSymlinks:void 0,disregardIgnoreFiles:typeof e.useIgnoreFiles=="boolean"?!e.useIgnoreFiles:void 0,disregardGlobalIgnoreFiles:typeof e.useIgnoreFiles?.global=="boolean"?!e.useIgnoreFiles?.global:void 0,disregardParentIgnoreFiles:typeof e.useIgnoreFiles?.parent=="boolean"?!e.useIgnoreFiles?.parent:void 0,disregardExcludeSettings:e.useExcludeSettings!==void 0&&e.useExcludeSettings===I.None,disregardSearchExcludeSettings:e.useExcludeSettings!==void 0&&e.useExcludeSettings!==I.SearchAndFilesExclude,fileEncoding:e.encoding,maxResults:e.maxResults,previewOptions:e.previewOptions?{matchLines:e.previewOptions?.numMatchLines??100,charsPerLine:e.previewOptions?.charsPerLine??1e4}:void 0,surroundingContext:e.surroundingContext,includePattern:f?.pattern,excludePattern:h},folder:f?.folder}},o=(e?.include?.map(c=>n(c))??[n(void 0)]).filter(c=>!!c),l=new J,u=l.add(new U),a=this.findTextInFilesBase(r,o,(c,f)=>u.fire({result:c,uri:f}),i);return{results:new z(async c=>{l.add(u.event(f=>{const h=f.result,W=f.uri;M(h)?c.emitOne(new he(W,h.rangeLocations.map(m=>({previewRange:new w(m.preview.startLineNumber,m.preview.startColumn,m.preview.endLineNumber,m.preview.endColumn),sourceRange:new w(m.source.startLineNumber,m.source.startColumn,m.source.endLineNumber,m.source.endColumn)})),h.previewText)):c.emitOne(new ve(W,h.text,h.lineNumber))})),await a}),complete:a.then(c=>(l.dispose(),{limitHit:c?.limitHit??!1}))}}async findTextInFilesBase(r,e,t,i=x.None){const n=this._requestIdProvider.getNext();let s=!1;if(i.onCancellationRequested(o=>{s=!0}),this._activeSearchCallbacks[n]=o=>{if(s)return;const l=v.revive(o.resource);o.results.forEach(u=>{const a=pe(u);t(a,l)})},i.isCancellationRequested)return{};try{const o=await Promise.all(e?.map(l=>this._proxy.$startTextSearch(r,l.folder??null,l.options,n,i)||{})??[]);return delete this._activeSearchCallbacks[n],o.reduce((l,u)=>({limitHit:l?.limitHit||(u?.limitHit??!1),message:[l?.message??[],u?.message??[]].flat()}),{})??{limitHit:!1}}catch(o){throw delete this._activeSearchCallbacks[n],o}}async findTextInFiles(r,e,t,i,n=x.None){this._logService.trace(`extHostWorkspace#findTextInFiles: textSearch, extension: ${i.value}, entryPoint: findTextInFiles`);const s=typeof e.previewOptions>"u"?{matchLines:100,charsPerLine:1e4}:e.previewOptions,o=b(C.from(e.include)),l=typeof e.exclude=="string"?e.exclude:e.exclude?e.exclude.pattern:void 0,u={ignoreSymlinks:typeof e.followSymlinks=="boolean"?!e.followSymlinks:void 0,disregardIgnoreFiles:typeof e.useIgnoreFiles=="boolean"?!e.useIgnoreFiles:void 0,disregardGlobalIgnoreFiles:typeof e.useGlobalIgnoreFiles=="boolean"?!e.useGlobalIgnoreFiles:void 0,disregardParentIgnoreFiles:typeof e.useParentIgnoreFiles=="boolean"?!e.useParentIgnoreFiles:void 0,disregardExcludeSettings:typeof e.useDefaultExcludes=="boolean"?!e.useDefaultExcludes:!0,disregardSearchExcludeSettings:typeof e.useSearchExclude=="boolean"?!e.useSearchExclude:!0,fileEncoding:e.encoding,maxResults:e.maxResults,previewOptions:s,surroundingContext:e.afterContext,includePattern:o?.pattern,excludePattern:l?[{pattern:l}]:void 0},a=(p,c)=>{M(p)?t({uri:c,preview:{text:p.previewText,matches:H(p.rangeLocations,f=>new w(f.preview.startLineNumber,f.preview.startColumn,f.preview.endLineNumber,f.preview.endColumn))},ranges:H(p.rangeLocations,f=>new w(f.source.startLineNumber,f.source.startColumn,f.source.endLineNumber,f.source.endColumn))}):t({uri:c,text:p.text,lineNumber:p.lineNumber})};return this.findTextInFilesBase(r,[{options:u,folder:o?.folder}],a,n)}$handleTextSearchResult(r,e){this._activeSearchCallbacks[e]?.(r)}async save(r){const e=await this._proxy.$save(r,{saveAs:!1});return v.revive(e)}async saveAs(r){const e=await this._proxy.$save(r,{saveAs:!0});return v.revive(e)}saveAll(r){return this._proxy.$saveAll(r)}resolveProxy(r){return this._proxy.$resolveProxy(r)}lookupAuthorization(r){return this._proxy.$lookupAuthorization(r)}lookupKerberosAuthorization(r){return this._proxy.$lookupKerberosAuthorization(r)}loadCertificates(){return this._proxy.$loadCertificates()}get trusted(){return this._trusted}requestWorkspaceTrust(r){return this._proxy.$requestWorkspaceTrust(r)}$onDidGrantWorkspaceTrust(){this._trusted||(this._trusted=!0,this._onDidGrantWorkspaceTrust.fire())}_providerHandlePool=0;registerEditSessionIdentityProvider(r,e){if(this._editSessionIdentityProviders.has(r))throw new Error(`A provider has already been registered for scheme ${r}`);this._editSessionIdentityProviders.set(r,e);const t=this._uriTransformerService.transformOutgoingScheme(r),i=this._providerHandlePool++;return this._proxy.$registerEditSessionIdentityProvider(i,t),N(()=>{this._editSessionIdentityProviders.delete(r),this._proxy.$unregisterEditSessionIdentityProvider(i)})}async $getEditSessionIdentifier(r,e){this._logService.info("Getting edit session identifier for workspaceFolder",r);const t=await this.resolveWorkspaceFolder(v.revive(r));if(!t){this._logService.warn("Unable to resolve workspace folder");return}this._logService.info("Invoking #provideEditSessionIdentity for workspaceFolder",t);const i=this._editSessionIdentityProviders.get(t.uri.scheme);if(this._logService.info(`Provider for scheme ${t.uri.scheme} is defined: `,!!i),!i)return;const n=await i.provideEditSessionIdentity(t,e);if(this._logService.info("Provider returned edit session identifier: ",n),!!n)return n}async $provideEditSessionIdentityMatch(r,e,t,i){this._logService.info("Getting edit session identifier for workspaceFolder",r);const n=await this.resolveWorkspaceFolder(v.revive(r));if(!n){this._logService.warn("Unable to resolve workspace folder");return}this._logService.info("Invoking #provideEditSessionIdentity for workspaceFolder",n);const s=this._editSessionIdentityProviders.get(n.uri.scheme);if(this._logService.info(`Provider for scheme ${n.uri.scheme} is defined: `,!!s),!s)return;const o=await s.provideEditSessionIdentityMatch?.(e,t,i);if(this._logService.info("Provider returned edit session identifier match result: ",o),!!o)return o}_onWillCreateEditSessionIdentityEvent=new j;getOnWillCreateEditSessionIdentityEvent(r){return(e,t,i)=>{const n=function(o){e.call(t,o)};return n.extension=r,this._onWillCreateEditSessionIdentityEvent.event(n,void 0,i)}}async $onWillCreateEditSessionIdentity(r,e,t){const i=await this.resolveWorkspaceFolder(v.revive(r));if(i===void 0)throw new Error("Unable to resolve workspace folder");await this._onWillCreateEditSessionIdentityEvent.fireAsync({workspaceFolder:i},e,async(n,s)=>{const o=Date.now();await Promise.resolve(n),Date.now()-o>t&&this._logService.warn("SLOW edit session create-participant",s.extension.identifier)}),e.isCancellationRequested}_canonicalUriProviders=new Map;registerCanonicalUriProvider(r,e){if(this._canonicalUriProviders.has(r))throw new Error(`A provider has already been registered for scheme ${r}`);this._canonicalUriProviders.set(r,e);const t=this._uriTransformerService.transformOutgoingScheme(r),i=this._providerHandlePool++;return this._proxy.$registerCanonicalUriProvider(i,t),N(()=>{this._canonicalUriProviders.delete(r),this._proxy.$unregisterCanonicalUriProvider(i)})}async provideCanonicalUri(r,e,t){const i=this._canonicalUriProviders.get(r.scheme);if(!i)return;const n=await i.provideCanonicalUri?.(v.revive(r),e,t);if(n)return n}async $provideCanonicalUri(r,e,t){return this.provideCanonicalUri(v.revive(r),{targetScheme:e},t)}};P=O([k(0,ue),k(1,ce),k(2,le),k(3,se),k(4,fe)],P);const vr=ne("IExtHostWorkspace");function b(d){let r,e;if(d)return typeof d=="string"?r=d:(r=d.pattern,e=v.revive(d.baseUri)),{pattern:r,folder:e}}function L(d){return(d?.map(r=>{if(typeof r=="string")return r===""?void 0:{pattern:r,uri:void 0};{const e=b(r);return e?{pattern:e.pattern,uri:e.folder}:void 0}})??[]).filter(r=>!!r)}export{P as ExtHostWorkspace,vr as IExtHostWorkspace};
