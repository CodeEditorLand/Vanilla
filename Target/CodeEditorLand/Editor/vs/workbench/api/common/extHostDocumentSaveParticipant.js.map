{
  "version": 3,
  "sources": ["../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/api/common/extHostDocumentSaveParticipant.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type * as vscode from \"vscode\";\nimport { illegalState } from \"../../../base/common/errors.js\";\nimport type { Event } from \"../../../base/common/event.js\";\nimport { LinkedList } from \"../../../base/common/linkedList.js\";\nimport { URI, type UriComponents } from \"../../../base/common/uri.js\";\nimport type { IExtensionDescription } from \"../../../platform/extensions/common/extensions.js\";\nimport type { ILogService } from \"../../../platform/log/common/log.js\";\nimport type { SaveReason } from \"../../common/editor.js\";\nimport { SerializableObjectWithBuffers } from \"../../services/extensions/common/proxyIdentifier.js\";\nimport type {\n\tExtHostDocumentSaveParticipantShape,\n\tIWorkspaceEditDto,\n\tMainThreadBulkEditsShape,\n} from \"./extHost.protocol.js\";\nimport type { ExtHostDocuments } from \"./extHostDocuments.js\";\nimport {\n\tEndOfLine,\n\tRange,\n\tTextDocumentSaveReason,\n} from \"./extHostTypeConverters.js\";\nimport { TextEdit } from \"./extHostTypes.js\";\n\ntype Listener = [Function, any, IExtensionDescription];\n\nexport class ExtHostDocumentSaveParticipant\n\timplements ExtHostDocumentSaveParticipantShape\n{\n\tprivate readonly _callbacks = new LinkedList<Listener>();\n\tprivate readonly _badListeners = new WeakMap<Function, number>();\n\n\tconstructor(\n\t\tprivate readonly _logService: ILogService,\n\t\tprivate readonly _documents: ExtHostDocuments,\n\t\tprivate readonly _mainThreadBulkEdits: MainThreadBulkEditsShape,\n\t\tprivate readonly _thresholds: { timeout: number; errors: number } = {\n\t\t\ttimeout: 1500,\n\t\t\terrors: 3,\n\t\t},\n\t) {\n\t\t//\n\t}\n\n\tdispose(): void {\n\t\tthis._callbacks.clear();\n\t}\n\n\tgetOnWillSaveTextDocumentEvent(\n\t\textension: IExtensionDescription,\n\t): Event<vscode.TextDocumentWillSaveEvent> {\n\t\treturn (listener, thisArg, disposables) => {\n\t\t\tconst remove = this._callbacks.push([listener, thisArg, extension]);\n\t\t\tconst result = { dispose: remove };\n\t\t\tif (Array.isArray(disposables)) {\n\t\t\t\tdisposables.push(result);\n\t\t\t}\n\t\t\treturn result;\n\t\t};\n\t}\n\n\tasync $participateInSave(\n\t\tdata: UriComponents,\n\t\treason: SaveReason,\n\t): Promise<boolean[]> {\n\t\tconst resource = URI.revive(data);\n\n\t\tlet didTimeout = false;\n\t\tconst didTimeoutHandle = setTimeout(\n\t\t\t() => (didTimeout = true),\n\t\t\tthis._thresholds.timeout,\n\t\t);\n\n\t\tconst results: boolean[] = [];\n\t\ttry {\n\t\t\tfor (const listener of [...this._callbacks]) {\n\t\t\t\t// copy to prevent concurrent modifications\n\t\t\t\tif (didTimeout) {\n\t\t\t\t\t// timeout - no more listeners\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tconst document = this._documents.getDocument(resource);\n\t\t\t\tconst success =\n\t\t\t\t\tawait this._deliverEventAsyncAndBlameBadListeners(\n\t\t\t\t\t\tlistener,\n\t\t\t\t\t\t<any>{\n\t\t\t\t\t\t\tdocument,\n\t\t\t\t\t\t\treason: TextDocumentSaveReason.to(reason),\n\t\t\t\t\t\t},\n\t\t\t\t\t);\n\t\t\t\tresults.push(success);\n\t\t\t}\n\t\t} finally {\n\t\t\tclearTimeout(didTimeoutHandle);\n\t\t}\n\t\treturn results;\n\t}\n\n\tprivate _deliverEventAsyncAndBlameBadListeners(\n\t\t[listener, thisArg, extension]: Listener,\n\t\tstubEvent: vscode.TextDocumentWillSaveEvent,\n\t): Promise<any> {\n\t\tconst errors = this._badListeners.get(listener);\n\t\tif (typeof errors === \"number\" && errors > this._thresholds.errors) {\n\t\t\t// bad listener - ignore\n\t\t\treturn Promise.resolve(false);\n\t\t}\n\n\t\treturn this._deliverEventAsync(\n\t\t\textension,\n\t\t\tlistener,\n\t\t\tthisArg,\n\t\t\tstubEvent,\n\t\t).then(\n\t\t\t() => {\n\t\t\t\t// don't send result across the wire\n\t\t\t\treturn true;\n\t\t\t},\n\t\t\t(err) => {\n\t\t\t\tthis._logService.error(\n\t\t\t\t\t`onWillSaveTextDocument-listener from extension '${extension.identifier.value}' threw ERROR`,\n\t\t\t\t);\n\t\t\t\tthis._logService.error(err);\n\n\t\t\t\tif (\n\t\t\t\t\t!(err instanceof Error) ||\n\t\t\t\t\t(<Error>err).message !== \"concurrent_edits\"\n\t\t\t\t) {\n\t\t\t\t\tconst errors = this._badListeners.get(listener);\n\t\t\t\t\tthis._badListeners.set(listener, errors ? errors + 1 : 1);\n\n\t\t\t\t\tif (\n\t\t\t\t\t\ttypeof errors === \"number\" &&\n\t\t\t\t\t\terrors > this._thresholds.errors\n\t\t\t\t\t) {\n\t\t\t\t\t\tthis._logService.info(\n\t\t\t\t\t\t\t`onWillSaveTextDocument-listener from extension '${extension.identifier.value}' will now be IGNORED because of timeouts and/or errors`,\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn false;\n\t\t\t},\n\t\t);\n\t}\n\n\tprivate _deliverEventAsync(\n\t\textension: IExtensionDescription,\n\t\tlistener: Function,\n\t\tthisArg: any,\n\t\tstubEvent: vscode.TextDocumentWillSaveEvent,\n\t): Promise<any> {\n\t\tconst promises: Promise<vscode.TextEdit[]>[] = [];\n\n\t\tconst t1 = Date.now();\n\t\tconst { document, reason } = stubEvent;\n\t\tconst { version } = document;\n\n\t\tconst event = Object.freeze<vscode.TextDocumentWillSaveEvent>({\n\t\t\tdocument,\n\t\t\treason,\n\t\t\twaitUntil(p: Promise<any | vscode.TextEdit[]>) {\n\t\t\t\tif (Object.isFrozen(promises)) {\n\t\t\t\t\tthrow illegalState(\"waitUntil can not be called async\");\n\t\t\t\t}\n\t\t\t\tpromises.push(Promise.resolve(p));\n\t\t\t},\n\t\t});\n\n\t\ttry {\n\t\t\t// fire event\n\t\t\tlistener.apply(thisArg, [event]);\n\t\t} catch (err) {\n\t\t\treturn Promise.reject(err);\n\t\t}\n\n\t\t// freeze promises after event call\n\t\tObject.freeze(promises);\n\n\t\treturn new Promise<vscode.TextEdit[][]>((resolve, reject) => {\n\t\t\t// join on all listener promises, reject after timeout\n\t\t\tconst handle = setTimeout(\n\t\t\t\t() => reject(new Error(\"timeout\")),\n\t\t\t\tthis._thresholds.timeout,\n\t\t\t);\n\n\t\t\treturn Promise.all(promises)\n\t\t\t\t.then((edits) => {\n\t\t\t\t\tthis._logService.debug(\n\t\t\t\t\t\t`onWillSaveTextDocument-listener from extension '${extension.identifier.value}' finished after ${Date.now() - t1}ms`,\n\t\t\t\t\t);\n\t\t\t\t\tclearTimeout(handle);\n\t\t\t\t\tresolve(edits);\n\t\t\t\t})\n\t\t\t\t.catch((err) => {\n\t\t\t\t\tclearTimeout(handle);\n\t\t\t\t\treject(err);\n\t\t\t\t});\n\t\t}).then((values) => {\n\t\t\tconst dto: IWorkspaceEditDto = { edits: [] };\n\t\t\tfor (const value of values) {\n\t\t\t\tif (\n\t\t\t\t\tArray.isArray(value) &&\n\t\t\t\t\t(<vscode.TextEdit[]>value).every(\n\t\t\t\t\t\t(e) => e instanceof TextEdit,\n\t\t\t\t\t)\n\t\t\t\t) {\n\t\t\t\t\tfor (const { newText, newEol, range } of value) {\n\t\t\t\t\t\tdto.edits.push({\n\t\t\t\t\t\t\tresource: document.uri,\n\t\t\t\t\t\t\tversionId: undefined,\n\t\t\t\t\t\t\ttextEdit: {\n\t\t\t\t\t\t\t\trange: range && Range.from(range),\n\t\t\t\t\t\t\t\ttext: newText,\n\t\t\t\t\t\t\t\teol: newEol && EndOfLine.from(newEol),\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// apply edits if any and if document\n\t\t\t// didn't change somehow in the meantime\n\t\t\tif (dto.edits.length === 0) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\n\t\t\tif (version === document.version) {\n\t\t\t\treturn this._mainThreadBulkEdits.$tryApplyWorkspaceEdit(\n\t\t\t\t\tnew SerializableObjectWithBuffers(dto),\n\t\t\t\t);\n\t\t\t}\n\n\t\t\treturn Promise.reject(new Error(\"concurrent_edits\"));\n\t\t});\n\t}\n}\n"],
  "mappings": "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",
  "names": ["errors"]
}
