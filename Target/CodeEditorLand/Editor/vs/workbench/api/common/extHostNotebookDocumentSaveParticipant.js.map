{
  "version": 3,
  "sources": ["../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/api/common/extHostNotebookDocumentSaveParticipant.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type { NotebookDocumentWillSaveEvent } from \"vscode\";\nimport type { CancellationToken } from \"../../../base/common/cancellation.js\";\nimport { AsyncEmitter, type Event } from \"../../../base/common/event.js\";\nimport { URI, type UriComponents } from \"../../../base/common/uri.js\";\nimport type { IExtensionDescription } from \"../../../platform/extensions/common/extensions.js\";\nimport type { ILogService } from \"../../../platform/log/common/log.js\";\nimport type { SaveReason } from \"../../common/editor.js\";\nimport { SerializableObjectWithBuffers } from \"../../services/extensions/common/proxyIdentifier.js\";\nimport type {\n\tExtHostNotebookDocumentSaveParticipantShape,\n\tIWorkspaceEditDto,\n\tMainThreadBulkEditsShape,\n} from \"./extHost.protocol.js\";\nimport type { ExtHostNotebookController } from \"./extHostNotebook.js\";\nimport {\n\tTextDocumentSaveReason,\n\tWorkspaceEdit as WorksapceEditConverter,\n} from \"./extHostTypeConverters.js\";\nimport { WorkspaceEdit } from \"./extHostTypes.js\";\n\ninterface IExtensionListener<E> {\n\textension: IExtensionDescription;\n\t(e: E): any;\n}\n\nexport class ExtHostNotebookDocumentSaveParticipant\n\timplements ExtHostNotebookDocumentSaveParticipantShape\n{\n\tprivate readonly _onWillSaveNotebookDocumentEvent =\n\t\tnew AsyncEmitter<NotebookDocumentWillSaveEvent>();\n\n\tconstructor(\n\t\tprivate readonly _logService: ILogService,\n\t\tprivate readonly _notebooksAndEditors: ExtHostNotebookController,\n\t\tprivate readonly _mainThreadBulkEdits: MainThreadBulkEditsShape,\n\t\tprivate readonly _thresholds: { timeout: number; errors: number } = {\n\t\t\ttimeout: 1500,\n\t\t\terrors: 3,\n\t\t},\n\t) {}\n\n\tdispose(): void {}\n\n\tgetOnWillSaveNotebookDocumentEvent(\n\t\textension: IExtensionDescription,\n\t): Event<NotebookDocumentWillSaveEvent> {\n\t\treturn (listener, thisArg, disposables) => {\n\t\t\tconst wrappedListener: IExtensionListener<NotebookDocumentWillSaveEvent> =\n\t\t\t\tfunction wrapped(e) {\n\t\t\t\t\tlistener.call(thisArg, e);\n\t\t\t\t};\n\t\t\twrappedListener.extension = extension;\n\t\t\treturn this._onWillSaveNotebookDocumentEvent.event(\n\t\t\t\twrappedListener,\n\t\t\t\tundefined,\n\t\t\t\tdisposables,\n\t\t\t);\n\t\t};\n\t}\n\n\tasync $participateInSave(\n\t\tresource: UriComponents,\n\t\treason: SaveReason,\n\t\ttoken: CancellationToken,\n\t): Promise<boolean> {\n\t\tconst revivedUri = URI.revive(resource);\n\t\tconst document =\n\t\t\tthis._notebooksAndEditors.getNotebookDocument(revivedUri);\n\n\t\tif (!document) {\n\t\t\tthrow new Error(\"Unable to resolve notebook document\");\n\t\t}\n\n\t\tconst edits: WorkspaceEdit[] = [];\n\n\t\tawait this._onWillSaveNotebookDocumentEvent.fireAsync(\n\t\t\t{\n\t\t\t\tnotebook: document.apiNotebook,\n\t\t\t\treason: TextDocumentSaveReason.to(reason),\n\t\t\t},\n\t\t\ttoken,\n\t\t\tasync (thenable: Promise<unknown>, listener) => {\n\t\t\t\tconst now = Date.now();\n\t\t\t\tconst data = await await Promise.resolve(thenable);\n\t\t\t\tif (Date.now() - now > this._thresholds.timeout) {\n\t\t\t\t\tthis._logService.warn(\n\t\t\t\t\t\t\"onWillSaveNotebookDocument-listener from extension\",\n\t\t\t\t\t\t(<IExtensionListener<NotebookDocumentWillSaveEvent>>(\n\t\t\t\t\t\t\tlistener\n\t\t\t\t\t\t)).extension.identifier,\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tif (token.isCancellationRequested) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (data) {\n\t\t\t\t\tif (data instanceof WorkspaceEdit) {\n\t\t\t\t\t\tedits.push(data);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// ignore invalid data\n\t\t\t\t\t\tthis._logService.warn(\n\t\t\t\t\t\t\t\"onWillSaveNotebookDocument-listener from extension\",\n\t\t\t\t\t\t\t(<\n\t\t\t\t\t\t\t\tIExtensionListener<NotebookDocumentWillSaveEvent>\n\t\t\t\t\t\t\t>listener).extension.identifier,\n\t\t\t\t\t\t\t\"ignored due to invalid data\",\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn;\n\t\t\t},\n\t\t);\n\n\t\tif (token.isCancellationRequested) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (edits.length === 0) {\n\t\t\treturn true;\n\t\t}\n\n\t\tconst dto: IWorkspaceEditDto = { edits: [] };\n\t\tfor (const edit of edits) {\n\t\t\tconst { edits } = WorksapceEditConverter.from(edit);\n\t\t\tdto.edits = dto.edits.concat(edits);\n\t\t}\n\n\t\treturn this._mainThreadBulkEdits.$tryApplyWorkspaceEdit(\n\t\t\tnew SerializableObjectWithBuffers(dto),\n\t\t);\n\t}\n}\n"],
  "mappings": ";;AAOA,SAAS,oBAAgC;AACzC,SAAS,WAA+B;AAIxC,SAAS,qCAAqC;AAO9C;AAAA,EACC;AAAA,EACA,iBAAiB;AAAA,OACX;AACP,SAAS,qBAAqB;AAOvB,MAAM,uCAEb;AAAA,EAIC,YACkB,aACA,sBACA,sBACA,cAAmD;AAAA,IACnE,SAAS;AAAA,IACT,QAAQ;AAAA,EACT,GACC;AAPgB;AACA;AACA;AACA;AAAA,EAIf;AAAA,EA5CJ,OAgCA;AAAA;AAAA;AAAA,EACkB,mCAChB,IAAI,aAA4C;AAAA,EAYjD,UAAgB;AAAA,EAAC;AAAA,EAEjB,mCACC,WACuC;AACvC,WAAO,CAAC,UAAU,SAAS,gBAAgB;AAC1C,YAAM,kBACL,gCAAS,QAAQ,GAAG;AACnB,iBAAS,KAAK,SAAS,CAAC;AAAA,MACzB,GAFA;AAGD,sBAAgB,YAAY;AAC5B,aAAO,KAAK,iCAAiC;AAAA,QAC5C;AAAA,QACA;AAAA,QACA;AAAA,MACD;AAAA,IACD;AAAA,EACD;AAAA,EAEA,MAAM,mBACL,UACA,QACA,OACmB;AACnB,UAAM,aAAa,IAAI,OAAO,QAAQ;AACtC,UAAM,WACL,KAAK,qBAAqB,oBAAoB,UAAU;AAEzD,QAAI,CAAC,UAAU;AACd,YAAM,IAAI,MAAM,qCAAqC;AAAA,IACtD;AAEA,UAAM,QAAyB,CAAC;AAEhC,UAAM,KAAK,iCAAiC;AAAA,MAC3C;AAAA,QACC,UAAU,SAAS;AAAA,QACnB,QAAQ,uBAAuB,GAAG,MAAM;AAAA,MACzC;AAAA,MACA;AAAA,MACA,OAAO,UAA4B,aAAa;AAC/C,cAAM,MAAM,KAAK,IAAI;AACrB,cAAM,OAAO,MAAM,MAAM,QAAQ,QAAQ,QAAQ;AACjD,YAAI,KAAK,IAAI,IAAI,MAAM,KAAK,YAAY,SAAS;AAChD,eAAK,YAAY;AAAA,YAChB;AAAA,YAEC,SACE,UAAU;AAAA,UACd;AAAA,QACD;AAEA,YAAI,MAAM,yBAAyB;AAClC;AAAA,QACD;AAEA,YAAI,MAAM;AACT,cAAI,gBAAgB,eAAe;AAClC,kBAAM,KAAK,IAAI;AAAA,UAChB,OAAO;AAEN,iBAAK,YAAY;AAAA,cAChB;AAAA,cAGC,SAAU,UAAU;AAAA,cACrB;AAAA,YACD;AAAA,UACD;AAAA,QACD;AAEA;AAAA,MACD;AAAA,IACD;AAEA,QAAI,MAAM,yBAAyB;AAClC,aAAO;AAAA,IACR;AAEA,QAAI,MAAM,WAAW,GAAG;AACvB,aAAO;AAAA,IACR;AAEA,UAAM,MAAyB,EAAE,OAAO,CAAC,EAAE;AAC3C,eAAW,QAAQ,OAAO;AACzB,YAAM,EAAE,OAAAA,OAAM,IAAI,uBAAuB,KAAK,IAAI;AAClD,UAAI,QAAQ,IAAI,MAAM,OAAOA,MAAK;AAAA,IACnC;AAEA,WAAO,KAAK,qBAAqB;AAAA,MAChC,IAAI,8BAA8B,GAAG;AAAA,IACtC;AAAA,EACD;AACD;",
  "names": ["edits"]
}
