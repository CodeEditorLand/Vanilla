var N=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var C=(o,e,t,r)=>{for(var i=r>1?void 0:r?X(e,t):e,n=o.length-1,s;n>=0;n--)(s=o[n])&&(i=(r?s(e,t,i):s(i))||i);return r&&i&&N(e,t,i),i},T=(o,e)=>(t,r)=>e(t,r,o);import{equals as Y,sortedDiff as Z}from"../../../../vs/base/common/arrays.js";import{asPromise as y}from"../../../../vs/base/common/async.js";import"../../../../vs/base/common/cancellation.js";import{comparePaths as g}from"../../../../vs/base/common/comparers.js";import{debounce as B}from"../../../../vs/base/common/decorators.js";import{Emitter as p,Event as $}from"../../../../vs/base/common/event.js";import"../../../../vs/base/common/htmlContent.js";import{DisposableStore as f,MutableDisposable as S}from"../../../../vs/base/common/lifecycle.js";import{MarshalledId as D}from"../../../../vs/base/common/marshallingIds.js";import{Schemas as I}from"../../../../vs/base/common/network.js";import{isLinux as ee}from"../../../../vs/base/common/platform.js";import"../../../../vs/base/common/sequence.js";import{ThemeIcon as k}from"../../../../vs/base/common/themables.js";import{URI as l}from"../../../../vs/base/common/uri.js";import{ExtensionIdentifierMap as te}from"../../../../vs/platform/extensions/common/extensions.js";import{ILogService as oe}from"../../../../vs/platform/log/common/log.js";import"../../../../vs/workbench/api/common/extHostCommands.js";import"../../../../vs/workbench/api/common/extHostDocuments.js";import{MarkdownString as re}from"../../../../vs/workbench/api/common/extHostTypeConverters.js";import{checkProposedApiEnabled as m,isProposedApiEnabled as P}from"../../../../vs/workbench/services/extensions/common/extensions.js";import{MainContext as G}from"./extHost.protocol.js";function V(o){return o instanceof l}function ne(o,e){return o.scheme===I.file&&e.scheme===I.file&&ee?o.toString()===e.toString():o.toString().toLowerCase()===e.toString().toLowerCase()}function x(o){if(o)return typeof o.iconPath=="string"?l.file(o.iconPath):l.isUri(o.iconPath)||k.isThemeIcon(o.iconPath)?o.iconPath:void 0}function A(o){if(o){if(l.isUri(o))return o;if(k.isThemeIcon(o))return o;{const e=o;return{light:e.light,dark:e.dark}}}else return}function R(o){const e=A(o.icon),t=o.labels?.map(r=>({title:r.title,icon:A(r.icon)}));return{...o,icon:e,labels:t}}function M(o,e){if(!o.iconPath&&!e.iconPath)return 0;if(o.iconPath){if(!e.iconPath)return 1}else return-1;const t=typeof o.iconPath=="string"?o.iconPath:l.isUri(o.iconPath)?o.iconPath.fsPath:o.iconPath.id,r=typeof e.iconPath=="string"?e.iconPath:l.isUri(e.iconPath)?e.iconPath.fsPath:e.iconPath.id;return g(t,r)}function ie(o,e){let t=0;if(o.strikeThrough!==e.strikeThrough)return o.strikeThrough?1:-1;if(o.faded!==e.faded)return o.faded?1:-1;if(o.tooltip!==e.tooltip)return(o.tooltip||"").localeCompare(e.tooltip||"");if(t=M(o,e),t!==0)return t;if(o.light&&e.light)t=M(o.light,e.light);else{if(o.light)return 1;if(e.light)return-1}if(t!==0)return t;if(o.dark&&e.dark)t=M(o.dark,e.dark);else{if(o.dark)return 1;if(e.dark)return-1}return t}function se(o,e){if(o.command!==e.command)return o.command<e.command?-1:1;if(o.title!==e.title)return o.title<e.title?-1:1;if(o.tooltip!==e.tooltip){if(o.tooltip!==void 0&&e.tooltip!==void 0)return o.tooltip<e.tooltip?-1:1;if(o.tooltip!==void 0)return 1;if(e.tooltip!==void 0)return-1}if(o.arguments===e.arguments)return 0;if(o.arguments)if(e.arguments){if(o.arguments.length!==e.arguments.length)return o.arguments.length-e.arguments.length}else return 1;else return-1;for(let t=0;t<o.arguments.length;t++){const r=o.arguments[t],i=e.arguments[t];if(r!==i&&!(V(r)&&V(i)&&ne(r,i)))return r<i?-1:1}return 0}function q(o,e){let t=g(o.resourceUri.fsPath,e.resourceUri.fsPath,!0);if(t!==0)return t;if(o.command&&e.command)t=se(o.command,e.command);else{if(o.command)return 1;if(e.command)return-1}if(t!==0)return t;if(o.decorations&&e.decorations)t=ie(o.decorations,e.decorations);else{if(o.decorations)return 1;if(e.decorations)return-1}if(o.multiFileDiffEditorModifiedUri&&e.multiFileDiffEditorModifiedUri)t=g(o.multiFileDiffEditorModifiedUri.fsPath,e.multiFileDiffEditorModifiedUri.fsPath,!0);else{if(o.multiFileDiffEditorModifiedUri)return 1;if(e.multiFileDiffEditorModifiedUri)return-1}if(o.multiDiffEditorOriginalUri&&e.multiDiffEditorOriginalUri)t=g(o.multiDiffEditorOriginalUri.fsPath,e.multiDiffEditorOriginalUri.fsPath,!0);else{if(o.multiDiffEditorOriginalUri)return 1;if(e.multiDiffEditorOriginalUri)return-1}return t}function ae(o,e){for(let t=0;t<o.length;t++)if(o[t]!==e[t])return!1;return!0}function ue(o,e){return o.command===e.command&&o.title===e.title&&o.tooltip===e.tooltip&&(o.arguments&&e.arguments?ae(o.arguments,e.arguments):o.arguments===e.arguments)}function de(o,e){return Y(o,e,ue)}class ce{constructor(e,t,r,i,n){this._extension=e;this._sourceControlHandle=i;this._documentUri=n;this.#t=t,this.#e=r}#e;#t;_value="";get value(){return this._value}set value(e){e=e??"",this.#e.$setInputBoxValue(this._sourceControlHandle,e),this.updateValue(e)}_onDidChange=new p;get onDidChange(){return this._onDidChange.event}_placeholder="";get placeholder(){return this._placeholder}set placeholder(e){this.#e.$setInputBoxPlaceholder(this._sourceControlHandle,e),this._placeholder=e}_validateInput;get validateInput(){return m(this._extension,"scmValidation"),this._validateInput}set validateInput(e){if(m(this._extension,"scmValidation"),e&&typeof e!="function")throw new Error(`[${this._extension.identifier.value}]: Invalid SCM input box validation function`);this._validateInput=e,this.#e.$setValidationProviderIsEnabled(this._sourceControlHandle,!!e)}_enabled=!0;get enabled(){return this._enabled}set enabled(e){e=!!e,this._enabled!==e&&(this._enabled=e,this.#e.$setInputBoxEnablement(this._sourceControlHandle,e))}_visible=!0;get visible(){return this._visible}set visible(e){e=!!e,this._visible!==e&&(this._visible=e,this.#e.$setInputBoxVisibility(this._sourceControlHandle,e))}get document(){return m(this._extension,"scmTextDocument"),this.#t.getDocument(this._documentUri)}showValidationMessage(e,t){m(this._extension,"scmValidation"),this.#e.$showValidationMessage(this._sourceControlHandle,e,t)}$onInputBoxValueChange(e){this.updateValue(e)}updateValue(e){this._value=e,this._onDidChange.fire(e)}}class E{constructor(e,t,r,i,n,s,u){this._proxy=e;this._commands=t;this._sourceControlHandle=r;this._id=i;this._label=n;this.multiDiffEditorEnableViewChanges=s;this._extension=u}static _handlePool=0;_resourceHandlePool=0;_resourceStates=[];_resourceStatesMap=new Map;_resourceStatesCommandsMap=new Map;_resourceStatesDisposablesMap=new Map;_onDidUpdateResourceStates=new p;onDidUpdateResourceStates=this._onDidUpdateResourceStates.event;_disposed=!1;get disposed(){return this._disposed}_onDidDispose=new p;onDidDispose=this._onDidDispose.event;_handlesSnapshot=[];_resourceSnapshot=[];get id(){return this._id}get label(){return this._label}set label(e){this._label=e,this._proxy.$updateGroupLabel(this._sourceControlHandle,this.handle,e)}_hideWhenEmpty=void 0;get hideWhenEmpty(){return this._hideWhenEmpty}set hideWhenEmpty(e){this._hideWhenEmpty=e,this._proxy.$updateGroup(this._sourceControlHandle,this.handle,this.features)}get features(){return{hideWhenEmpty:this.hideWhenEmpty}}get resourceStates(){return[...this._resourceStates]}set resourceStates(e){this._resourceStates=[...e],this._onDidUpdateResourceStates.fire()}handle=E._handlePool++;getResourceState(e){return this._resourceStatesMap.get(e)}$executeResourceCommand(e,t){const r=this._resourceStatesCommandsMap.get(e);return r?y(()=>this._commands.executeCommand(r.command,...r.arguments||[],t)):Promise.resolve(void 0)}_takeResourceStateSnapshot(){const e=[...this._resourceStates].sort(q),r=Z(this._resourceSnapshot,e,q).map(s=>{const u=s.toInsert.map(a=>{const d=this._resourceHandlePool++;this._resourceStatesMap.set(d,a);const _=a.resourceUri;let c;if(a.command)if(a.command.command==="vscode.open"||a.command.command==="vscode.diff"||a.command.command==="vscode.changes"){const U=new f;c=this._commands.converter.toInternal(a.command,U),this._resourceStatesDisposablesMap.set(d,U)}else this._resourceStatesCommandsMap.set(d,a.command);const H=P(this._extension,"scmMultiDiffEditor"),F=H?a.multiDiffEditorOriginalUri:void 0,L=H?a.multiFileDiffEditorModifiedUri:void 0,w=x(a.decorations),O=a.decorations&&x(a.decorations.light)||w,W=a.decorations&&x(a.decorations.dark)||w,Q=[O,W],j=a.decorations&&a.decorations.tooltip||"",z=a.decorations&&!!a.decorations.strikeThrough,J=a.decorations&&!!a.decorations.faded,K=a.contextValue||"";return{rawResource:[d,_,Q,j,z,J,K,c,F,L],handle:d}});return{start:s.start,deleteCount:s.deleteCount,toInsert:u}}),i=r.map(({start:s,deleteCount:u,toInsert:a})=>[s,u,a.map(d=>d.rawResource)]),n=r.reverse();for(const{start:s,deleteCount:u,toInsert:a}of n){const d=a.map(c=>c.handle),_=this._handlesSnapshot.splice(s,u,...d);for(const c of _)this._resourceStatesMap.delete(c),this._resourceStatesCommandsMap.delete(c),this._resourceStatesDisposablesMap.get(c)?.dispose(),this._resourceStatesDisposablesMap.delete(c)}return this._resourceSnapshot=e,i}dispose(){this._disposed=!0,this._onDidDispose.fire()}}const v=class v{constructor(e,t,r,i,n,s,u){this._extension=e;this._commands=i;this._id=n;this._label=s;this._rootUri=u;this.#e=r;const a=l.from({scheme:I.vscodeSourceControl,path:`${n}/scm${this.handle}/input`,query:u?`rootUri=${encodeURIComponent(u.toString())}`:void 0});this._inputBox=new ce(e,t,this.#e,this.handle,a),this.#e.$registerSourceControl(this.handle,n,s,u,a)}static _handlePool=0;#e;_groups=new Map;get id(){return this._id}get label(){return this._label}get rootUri(){return this._rootUri}_inputBox;get inputBox(){return this._inputBox}_count=void 0;get count(){return this._count}set count(e){this._count!==e&&(this._count=e,this.#e.$updateSourceControl(this.handle,{count:e}))}_quickDiffProvider=void 0;get quickDiffProvider(){return this._quickDiffProvider}set quickDiffProvider(e){this._quickDiffProvider=e;let t;P(this._extension,"quickDiffProvider")&&(t=e?.label),this.#e.$updateSourceControl(this.handle,{hasQuickDiffProvider:!!e,quickDiffLabel:t})}_historyProvider;_historyProviderDisposable=new S;_historyProviderCurrentHistoryItemGroup;get historyProvider(){return m(this._extension,"scmHistoryProvider"),this._historyProvider}set historyProvider(e){m(this._extension,"scmHistoryProvider"),this._historyProvider=e,this._historyProviderDisposable.value=new f,this.#e.$updateSourceControl(this.handle,{hasHistoryProvider:!!e}),e&&this._historyProviderDisposable.value.add(e.onDidChangeCurrentHistoryItemGroup(()=>{this._historyProviderCurrentHistoryItemGroup=e?.currentHistoryItemGroup,this.#e.$onDidChangeHistoryProviderCurrentHistoryItemGroup(this.handle,this._historyProviderCurrentHistoryItemGroup)}))}_commitTemplate=void 0;get commitTemplate(){return this._commitTemplate}set commitTemplate(e){e!==this._commitTemplate&&(this._commitTemplate=e,this.#e.$updateSourceControl(this.handle,{commitTemplate:e}))}_acceptInputDisposables=new S;_acceptInputCommand=void 0;get acceptInputCommand(){return this._acceptInputCommand}set acceptInputCommand(e){this._acceptInputDisposables.value=new f,this._acceptInputCommand=e;const t=this._commands.converter.toInternal(e,this._acceptInputDisposables.value);this.#e.$updateSourceControl(this.handle,{acceptInputCommand:t})}_actionButtonDisposables=new S;_actionButton;get actionButton(){return m(this._extension,"scmActionButton"),this._actionButton}set actionButton(e){m(this._extension,"scmActionButton"),this._actionButtonDisposables.value=new f,this._actionButton=e;const t=e!==void 0?{command:this._commands.converter.toInternal(e.command,this._actionButtonDisposables.value),secondaryCommands:e.secondaryCommands?.map(r=>r.map(i=>this._commands.converter.toInternal(i,this._actionButtonDisposables.value))),description:e.description,enabled:e.enabled}:void 0;this.#e.$updateSourceControl(this.handle,{actionButton:t??null})}_statusBarDisposables=new S;_statusBarCommands=void 0;get statusBarCommands(){return this._statusBarCommands}set statusBarCommands(e){if(this._statusBarCommands&&e&&de(this._statusBarCommands,e))return;this._statusBarDisposables.value=new f,this._statusBarCommands=e;const t=(e||[]).map(r=>this._commands.converter.toInternal(r,this._statusBarDisposables.value));this.#e.$updateSourceControl(this.handle,{statusBarCommands:t})}_selected=!1;get selected(){return this._selected}_onDidChangeSelection=new p;onDidChangeSelection=this._onDidChangeSelection.event;handle=v._handlePool++;createdResourceGroups=new Map;updatedResourceGroups=new Set;createResourceGroup(e,t,r){const i=P(this._extension,"scmMultiDiffEditor")&&r?.multiDiffEditorEnableViewChanges===!0,n=new E(this.#e,this._commands,this.handle,e,t,i,this._extension),s=$.once(n.onDidDispose)(()=>this.createdResourceGroups.delete(n));return this.createdResourceGroups.set(n,s),this.eventuallyAddResourceGroups(),n}eventuallyAddResourceGroups(){const e=[],t=[];for(const[r,i]of this.createdResourceGroups){i.dispose();const n=r.onDidUpdateResourceStates(()=>{this.updatedResourceGroups.add(r),this.eventuallyUpdateResourceStates()});$.once(r.onDidDispose)(()=>{this.updatedResourceGroups.delete(r),n.dispose(),this._groups.delete(r.handle),this.#e.$unregisterGroup(this.handle,r.handle)}),e.push([r.handle,r.id,r.label,r.features,r.multiDiffEditorEnableViewChanges]);const s=r._takeResourceStateSnapshot();s.length>0&&t.push([r.handle,s]),this._groups.set(r.handle,r)}this.#e.$registerGroups(this.handle,e,t),this.createdResourceGroups.clear()}eventuallyUpdateResourceStates(){const e=[];this.updatedResourceGroups.forEach(t=>{const r=t._takeResourceStateSnapshot();r.length!==0&&e.push([t.handle,r])}),e.length>0&&this.#e.$spliceResourceStates(this.handle,e),this.updatedResourceGroups.clear()}getResourceGroup(e){return this._groups.get(e)}setSelectionState(e){this._selected=e,this._onDidChangeSelection.fire(e)}dispose(){this._acceptInputDisposables.dispose(),this._actionButtonDisposables.dispose(),this._statusBarDisposables.dispose(),this._groups.forEach(e=>e.dispose()),this.#e.$unregisterSourceControl(this.handle)}};C([B(100)],v.prototype,"eventuallyAddResourceGroups",1),C([B(100)],v.prototype,"eventuallyUpdateResourceStates",1);let b=v,h=class{constructor(e,t,r,i){this._commands=t;this._extHostDocuments=r;this.logService=i;this._proxy=e.getProxy(G.MainThreadSCM),this._telemetry=e.getProxy(G.MainThreadTelemetry),t.registerArgumentProcessor({processArgument:n=>{if(n&&n.$mid===D.ScmResource){const s=this._sourceControls.get(n.sourceControlHandle);if(!s)return n;const u=s.getResourceGroup(n.groupHandle);return u?u.getResourceState(n.handle):n}else if(n&&n.$mid===D.ScmResourceGroup){const s=this._sourceControls.get(n.sourceControlHandle);return s?s.getResourceGroup(n.groupHandle):n}else if(n&&n.$mid===D.ScmProvider){const s=this._sourceControls.get(n.handle);return s||n}return n}})}static _handlePool=0;_proxy;_telemetry;_sourceControls=new Map;_sourceControlsByExtension=new te;_onDidChangeActiveProvider=new p;get onDidChangeActiveProvider(){return this._onDidChangeActiveProvider.event}_selectedSourceControlHandle;createSourceControl(e,t,r,i){this.logService.trace("ExtHostSCM#createSourceControl",e.identifier.value,t,r,i),this._telemetry.$publicLog2("api/scm/createSourceControl",{extensionId:e.identifier.value});const n=h._handlePool++,s=new b(e,this._extHostDocuments,this._proxy,this._commands,t,r,i);this._sourceControls.set(n,s);const u=this._sourceControlsByExtension.get(e.identifier)||[];return u.push(s),this._sourceControlsByExtension.set(e.identifier,u),s}getLastInputBox(e){this.logService.trace("ExtHostSCM#getLastInputBox",e.identifier.value);const t=this._sourceControlsByExtension.get(e.identifier),r=t&&t[t.length-1];return r&&r.inputBox}$provideOriginalResource(e,t,r){const i=l.revive(t);this.logService.trace("ExtHostSCM#$provideOriginalResource",e,i.toString());const n=this._sourceControls.get(e);return!n||!n.quickDiffProvider||!n.quickDiffProvider.provideOriginalResource?Promise.resolve(null):y(()=>n.quickDiffProvider.provideOriginalResource(i,r)).then(s=>s||null)}$onInputBoxValueChange(e,t){this.logService.trace("ExtHostSCM#$onInputBoxValueChange",e);const r=this._sourceControls.get(e);return r&&r.inputBox.$onInputBoxValueChange(t),Promise.resolve(void 0)}$executeResourceCommand(e,t,r,i){this.logService.trace("ExtHostSCM#$executeResourceCommand",e,t,r);const n=this._sourceControls.get(e);if(!n)return Promise.resolve(void 0);const s=n.getResourceGroup(t);return s?s.$executeResourceCommand(r,i):Promise.resolve(void 0)}$validateInput(e,t,r){this.logService.trace("ExtHostSCM#$validateInput",e);const i=this._sourceControls.get(e);return!i||!i.inputBox.validateInput?Promise.resolve(void 0):y(()=>i.inputBox.validateInput(t,r)).then(n=>{if(!n)return Promise.resolve(void 0);const s=re.fromStrict(n.message);return s?Promise.resolve([s,n.type]):Promise.resolve(void 0)})}$setSelectedSourceControl(e){return this.logService.trace("ExtHostSCM#$setSelectedSourceControl",e),e!==void 0&&this._sourceControls.get(e)?.setSelectionState(!0),this._selectedSourceControlHandle!==void 0&&this._sourceControls.get(this._selectedSourceControlHandle)?.setSelectionState(!1),this._selectedSourceControlHandle=e,Promise.resolve(void 0)}async $resolveHistoryItemGroupCommonAncestor(e,t,r,i){return await this._sourceControls.get(e)?.historyProvider?.resolveHistoryItemGroupCommonAncestor(t,r,i)??void 0}async $resolveHistoryItemGroupCommonAncestor2(e,t,r){return await this._sourceControls.get(e)?.historyProvider?.resolveHistoryItemGroupCommonAncestor2(t,r)??void 0}async $provideHistoryItems(e,t,r,i){return(await this._sourceControls.get(e)?.historyProvider?.provideHistoryItems(t,r,i))?.map(u=>R(u))??void 0}async $provideHistoryItems2(e,t,r){return(await this._sourceControls.get(e)?.historyProvider?.provideHistoryItems2(t,r))?.map(s=>R(s))??void 0}async $provideHistoryItemSummary(e,t,r,i){const n=this._sourceControls.get(e)?.historyProvider;if(typeof n?.provideHistoryItemSummary!="function")return;const s=await n.provideHistoryItemSummary(t,r,i);return s?R(s):void 0}async $provideHistoryItemChanges(e,t,r,i){return await this._sourceControls.get(e)?.historyProvider?.provideHistoryItemChanges(t,r,i)??void 0}};h=C([T(3,oe)],h);export{h as ExtHostSCM,ce as ExtHostSCMInputBox};
