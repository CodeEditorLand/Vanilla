import{coalesce as T}from"../../../base/common/arrays.js";import{raceCancellation as k}from"../../../base/common/async.js";import{toErrorMessage as q}from"../../../base/common/errorMessage.js";import{Emitter as _}from"../../../base/common/event.js";import{Iterable as S}from"../../../base/common/iterator.js";import{Disposable as M,DisposableMap as x,DisposableStore as R,toDisposable as E}from"../../../base/common/lifecycle.js";import{revive as y}from"../../../base/common/marshalling.js";import{StopWatch as H}from"../../../base/common/stopwatch.js";import{assertType as F}from"../../../base/common/types.js";import{URI as $}from"../../../base/common/uri.js";import{ExtensionIdentifier as V}from"../../../platform/extensions/common/extensions.js";import{ChatAgentLocation as P}from"../../contrib/chat/common/chatAgents.js";import{ChatAgentVoteDirection as w}from"../../contrib/chat/common/chatService.js";import{checkProposedApiEnabled as d,isProposedApiEnabled as b}from"../../services/extensions/common/extensions.js";import{MainContext as W}from"./extHost.protocol.js";import*as a from"./extHostTypeConverters.js";import*as c from"./extHostTypes.js";class U{constructor(l,o,n,t,e){this._extension=l;this._request=o;this._proxy=n;this._commandsConverter=t;this._sessionDisposables=e}_stopWatch=H.create(!1);_isClosed=!1;_firstProgress;_apiObject;close(){this._isClosed=!0}get timings(){return{firstProgress:this._firstProgress,totalElapsed:this._stopWatch.elapsed()}}get apiObject(){if(!this._apiObject){let n=function(e){if(o._isClosed){const r=new Error("Response stream has been closed");throw Error.captureStackTrace(r,e),r}};var l=n;const o=this;this._stopWatch.reset();const t=(e,r)=>{if(typeof this._firstProgress>"u"&&(e.kind==="markdownContent"||e.kind==="markdownVuln")&&(this._firstProgress=this._stopWatch.elapsed()),r){const i=this._proxy.$handleProgressChunk(this._request.requestId,e),s={report:p=>{i?.then(h=>{h&&(c.MarkdownString.isMarkdownString(p.value)?this._proxy.$handleProgressChunk(this._request.requestId,a.ChatResponseWarningPart.from(p),h):this._proxy.$handleProgressChunk(this._request.requestId,a.ChatResponseReferencePart.from(p),h))})}};Promise.all([i,r?.(s)]).then(([p,h])=>{p!==void 0&&this._proxy.$handleProgressChunk(this._request.requestId,a.ChatTaskResult.from(h),p)})}else this._proxy.$handleProgressChunk(this._request.requestId,e)};this._apiObject={markdown(e){n(this.markdown);const r=new c.ChatResponseMarkdownPart(e),i=a.ChatResponseMarkdownPart.from(r);return t(i),this},markdownWithVulnerabilities(e,r){n(this.markdown),r&&d(o._extension,"chatParticipantAdditions");const i=new c.ChatResponseMarkdownWithVulnerabilitiesPart(e,r),s=a.ChatResponseMarkdownWithVulnerabilitiesPart.from(i);return t(s),this},codeblockUri(e){n(this.codeblockUri),d(o._extension,"chatParticipantAdditions");const r=new c.ChatResponseCodeblockUriPart(e),i=a.ChatResponseCodeblockUriPart.from(r);return t(i),this},filetree(e,r){n(this.filetree);const i=new c.ChatResponseFileTreePart(e,r),s=a.ChatResponseFilesPart.from(i);return t(s),this},anchor(e,r){n(this.anchor);const i=new c.ChatResponseAnchorPart(e,r),s=a.ChatResponseAnchorPart.from(i);return t(s),this},button(e){n(this.anchor);const r=new c.ChatResponseCommandButtonPart(e),i=a.ChatResponseCommandButtonPart.from(r,o._commandsConverter,o._sessionDisposables);return t(i),this},progress(e,r){n(this.progress);const i=new c.ChatResponseProgressPart2(e,r),s=r?a.ChatTask.from(i):a.ChatResponseProgressPart.from(i);return t(s,r),this},warning(e){n(this.progress),d(o._extension,"chatParticipantAdditions");const r=new c.ChatResponseWarningPart(e),i=a.ChatResponseWarningPart.from(r);return t(i),this},reference(e,r){return this.reference2(e,r)},reference2(e,r,i){if(n(this.reference),typeof e=="object"&&"variableName"in e&&d(o._extension,"chatParticipantAdditions"),typeof e=="object"&&"variableName"in e&&!e.value){const s=o._request.variables.variables.find(p=>p.name===e.variableName);if(s){let p;if(s.references?.length)p=s.references.map(h=>({kind:"reference",reference:{variableName:e.variableName,value:h.reference}}));else{const h=new c.ChatResponseReferencePart(e,r,i);p=[a.ChatResponseReferencePart.from(h)]}return p.forEach(h=>t(h)),this}}else{const s=new c.ChatResponseReferencePart(e,r,i),p=a.ChatResponseReferencePart.from(s);t(p)}return this},codeCitation(e,r,i){n(this.codeCitation),d(o._extension,"chatParticipantAdditions");const s=new c.ChatResponseCodeCitationPart(e,r,i),p=a.ChatResponseCodeCitationPart.from(s);t(p)},textEdit(e,r){n(this.textEdit),d(o._extension,"chatParticipantAdditions");const i=new c.ChatResponseTextEditPart(e,r),s=a.ChatResponseTextEditPart.from(i);return t(s),this},detectedParticipant(e,r){n(this.detectedParticipant),d(o._extension,"chatParticipantAdditions");const i=new c.ChatResponseDetectedParticipantPart(e,r),s=a.ChatResponseDetectedParticipantPart.from(i);return t(s),this},confirmation(e,r,i,s){n(this.confirmation),d(o._extension,"chatParticipantAdditions");const p=new c.ChatResponseConfirmationPart(e,r,i,s),h=a.ChatResponseConfirmationPart.from(p);return t(h),this},push(e){if(n(this.push),(e instanceof c.ChatResponseTextEditPart||e instanceof c.ChatResponseMarkdownWithVulnerabilitiesPart||e instanceof c.ChatResponseDetectedParticipantPart||e instanceof c.ChatResponseWarningPart||e instanceof c.ChatResponseConfirmationPart||e instanceof c.ChatResponseCodeCitationPart||e instanceof c.ChatResponseMovePart)&&d(o._extension,"chatParticipantAdditions"),e instanceof c.ChatResponseReferencePart)this.reference2(e.value,e.iconPath,e.options);else{const r=a.ChatResponsePart.from(e,o._commandsConverter,o._sessionDisposables);t(r)}return this}}}return this._apiObject}}class g extends M{constructor(o,n,t,e){super();this._logService=n;this._commands=t;this._documents=e;this._proxy=o.getProxy(W.MainThreadChatAgents2)}static _idPool=0;_agents=new Map;_proxy;static _participantDetectionProviderIdPool=0;_participantDetectionProviders=new Map;_sessionDisposables=this._register(new x);_completionDisposables=this._register(new x);transferActiveChat(o){this._proxy.$transferActiveChatSession(o)}createChatAgent(o,n,t){const e=g._idPool++,r=new A(o,n,this._proxy,e,t);return this._agents.set(e,r),this._proxy.$registerAgent(e,o.identifier,n,{},void 0),r.apiAgent}createDynamicChatAgent(o,n,t,e){const r=g._idPool++,i=new A(o,n,this._proxy,r,e);return this._agents.set(r,i),this._proxy.$registerAgent(r,o.identifier,n,{isSticky:!0},t),i.apiAgent}registerChatParticipantDetectionProvider(o){const n=g._participantDetectionProviderIdPool++;return this._participantDetectionProviders.set(n,o),this._proxy.$registerChatParticipantDetectionProvider(n),E(()=>{this._participantDetectionProviders.delete(n),this._proxy.$unregisterChatParticipantDetectionProvider(n)})}async $detectChatParticipant(o,n,t,e,r){const{request:i,location:s,history:p}=await this._createRequest(n,t),h=this._participantDetectionProviders.get(o);if(h)return h.provideParticipantDetection(a.ChatAgentRequest.to(i,s),{history:p},{participants:e.participants,location:a.ChatLocation.to(e.location)},r)}async _createRequest(o,n){const t=y(o),e=await this.prepareHistoryTurns(t.agentId,n);let r;if(t.locationData?.type===P.Editor){const i=this._documents.getDocument(t.locationData.document);r=new c.ChatRequestEditorData(i,a.Selection.to(t.locationData.selection),a.Range.to(t.locationData.wholeRange))}else if(t.locationData?.type===P.Notebook){const i=this._documents.getDocument(t.locationData.sessionInputUri);r=new c.ChatRequestNotebookData(i)}else t.locationData?.type,P.Terminal;return{request:t,location:r,history:e}}async $invokeAgent(o,n,t,e){const r=this._agents.get(o);if(!r)throw new Error(`[CHAT](${o}) CANNOT invoke agent because the agent is not registered`);let i;try{const{request:s,location:p,history:h}=await this._createRequest(n,t);let u=this._sessionDisposables.get(s.sessionId);u||(u=new R,this._sessionDisposables.set(s.sessionId,u)),i=new U(r.extension,s,this._proxy,this._commands.converter,u);const f=r.invoke(a.ChatAgentRequest.to(s,p),{history:h},i.apiObject,e);return await k(Promise.resolve(f).then(m=>{if(m?.metadata)try{JSON.stringify(m.metadata)}catch(I){const v=`result.metadata MUST be JSON.stringify-able. Got error: ${I.message}`;return this._logService.error(`[${r.extension.identifier.value}] [@${r.id}] ${v}`,r.extension),{errorDetails:{message:v},timings:i?.timings,nextQuestion:m.nextQuestion}}let C;return m?.errorDetails&&(C={...m.errorDetails,responseIsIncomplete:!0}),C?.responseIsRedacted&&d(r.extension,"chatParticipantPrivate"),{errorDetails:C,timings:i?.timings,metadata:m?.metadata,nextQuestion:m?.nextQuestion}}),e)}catch(s){return this._logService.error(s,r.extension),s instanceof c.LanguageModelError&&s.cause&&(s=s.cause),{errorDetails:{message:q(s),responseIsIncomplete:!0}}}finally{i?.close()}}async prepareHistoryTurns(o,n){const t=[];for(const e of n.history){const r=a.ChatAgentResult.to(e.result),i=o===e.request.agentId?r:{...r,metadata:void 0},s=e.request.variables.variables.filter(f=>!f.isTool).map(a.ChatPromptReference.to),p=e.request.variables.variables.filter(f=>f.isTool).map(a.ChatLanguageModelToolReference.to),h=new c.ChatRequestTurn(e.request.message,e.request.command,s,e.request.agentId);h.toolReferences=p,t.push(h);const u=T(e.response.map(f=>a.ChatResponsePart.toContent(f,this._commands.converter)));t.push(new c.ChatResponseTurn(u,i,e.request.agentId,e.request.command))}return t}$releaseSession(o){this._sessionDisposables.deleteAndDispose(o)}async $provideFollowups(o,n,t,e,r){const i=this._agents.get(n);if(!i)return Promise.resolve([]);const s=y(o),p=await this.prepareHistoryTurns(i.id,e),h=a.ChatAgentResult.to(t);return(await i.provideFollowups(h,{history:p},r)).filter(u=>{const f=!u.participant||S.some(this._agents.values(),m=>m.id===u.participant&&V.equals(m.extension.identifier,i.extension.identifier));return f||this._logService.warn(`[@${i.id}] ChatFollowup refers to an unknown participant: ${u.participant}`),f}).map(u=>a.ChatFollowup.from(u,s))}$acceptFeedback(o,n,t){const e=this._agents.get(o);if(!e)return;const r=a.ChatAgentResult.to(n);let i;switch(t.direction){case w.Down:i=c.ChatResultFeedbackKind.Unhelpful;break;case w.Up:i=c.ChatResultFeedbackKind.Helpful;break}const s={result:r,kind:i,unhelpfulReason:b(e.extension,"chatParticipantAdditions")?t.reason:void 0};e.acceptFeedback(Object.freeze(s))}$acceptAction(o,n,t){const e=this._agents.get(o);if(!e||t.action.kind==="vote")return;const r=a.ChatAgentUserActionEvent.to(n,t,this._commands.converter);r&&e.acceptAction(Object.freeze(r))}async $invokeCompletionProvider(o,n,t){const e=this._agents.get(o);if(!e)return[];let r=this._completionDisposables.get(o);return r?r.clear():(r=new R,this._completionDisposables.set(o,r)),(await e.invokeCompletionProvider(n,t)).map(s=>a.ChatAgentCompletionItem.from(s,this._commands.converter,r))}async $provideWelcomeMessage(o,n,t){const e=this._agents.get(o);if(e)return await e.provideWelcomeMessage(a.ChatLocation.to(n),t)}async $provideChatTitle(o,n,t){const e=this._agents.get(o);if(!e)return;const r=await this.prepareHistoryTurns(e.id,{history:n});return await e.provideTitle({history:r},t)}async $provideSampleQuestions(o,n,t){const e=this._agents.get(o);if(e)return(await e.provideSampleQuestions(a.ChatLocation.to(n),t)).map(r=>a.ChatFollowup.from(r,void 0))}}class A{constructor(l,o,n,t,e){this.extension=l;this.id=o;this._proxy=n;this._handle=t;this._requestHandler=e}_followupProvider;_iconPath;_helpTextPrefix;_helpTextVariablesPrefix;_helpTextPostfix;_isSecondary;_onDidReceiveFeedback=new _;_onDidPerformAction=new _;_supportIssueReporting;_agentVariableProvider;_welcomeMessageProvider;_titleProvider;_requester;_supportsSlowReferences;acceptFeedback(l){this._onDidReceiveFeedback.fire(l)}acceptAction(l){this._onDidPerformAction.fire(l)}async invokeCompletionProvider(l,o){return this._agentVariableProvider?await this._agentVariableProvider.provider.provideCompletionItems(l,o)??[]:[]}async provideFollowups(l,o,n){if(!this._followupProvider)return[];const t=await this._followupProvider.provideFollowups(l,o,n);return t?t.filter(e=>!(e&&"commandId"in e)).filter(e=>!(e&&"message"in e)):[]}async provideWelcomeMessage(l,o){if(!this._welcomeMessageProvider)return[];const n=await this._welcomeMessageProvider.provideWelcomeMessage(l,o);return n?n.map(t=>typeof t=="string"?t:a.MarkdownString.from(t)):[]}async provideTitle(l,o){if(this._titleProvider)return await this._titleProvider.provideChatTitle(l,o)??void 0}async provideSampleQuestions(l,o){if(!this._welcomeMessageProvider||!this._welcomeMessageProvider.provideSampleQuestions)return[];const n=await this._welcomeMessageProvider.provideSampleQuestions(l,o);return n||[]}get apiAgent(){let l=!1,o=!1;const n=()=>{l||o||(o=!0,queueMicrotask(()=>{this._proxy.$updateAgent(this._handle,{icon:this._iconPath?this._iconPath instanceof $?this._iconPath:"light"in this._iconPath?this._iconPath.light:void 0:void 0,iconDark:this._iconPath&&"dark"in this._iconPath?this._iconPath.dark:void 0,themeIcon:this._iconPath instanceof c.ThemeIcon?this._iconPath:void 0,hasFollowups:this._followupProvider!==void 0,isSecondary:this._isSecondary,helpTextPrefix:!this._helpTextPrefix||typeof this._helpTextPrefix=="string"?this._helpTextPrefix:a.MarkdownString.from(this._helpTextPrefix),helpTextVariablesPrefix:!this._helpTextVariablesPrefix||typeof this._helpTextVariablesPrefix=="string"?this._helpTextVariablesPrefix:a.MarkdownString.from(this._helpTextVariablesPrefix),helpTextPostfix:!this._helpTextPostfix||typeof this._helpTextPostfix=="string"?this._helpTextPostfix:a.MarkdownString.from(this._helpTextPostfix),supportIssueReporting:this._supportIssueReporting,requester:this._requester,supportsSlowVariables:this._supportsSlowReferences}),o=!1}))},t=this;return{get id(){return t.id},get iconPath(){return t._iconPath},set iconPath(e){t._iconPath=e,n()},get requestHandler(){return t._requestHandler},set requestHandler(e){F(typeof e=="function","Invalid request handler"),t._requestHandler=e},get followupProvider(){return t._followupProvider},set followupProvider(e){t._followupProvider=e,n()},get helpTextPrefix(){return d(t.extension,"defaultChatParticipant"),t._helpTextPrefix},set helpTextPrefix(e){d(t.extension,"defaultChatParticipant"),t._helpTextPrefix=e,n()},get helpTextVariablesPrefix(){return d(t.extension,"defaultChatParticipant"),t._helpTextVariablesPrefix},set helpTextVariablesPrefix(e){d(t.extension,"defaultChatParticipant"),t._helpTextVariablesPrefix=e,n()},get helpTextPostfix(){return d(t.extension,"defaultChatParticipant"),t._helpTextPostfix},set helpTextPostfix(e){d(t.extension,"defaultChatParticipant"),t._helpTextPostfix=e,n()},get isSecondary(){return d(t.extension,"defaultChatParticipant"),t._isSecondary},set isSecondary(e){d(t.extension,"defaultChatParticipant"),t._isSecondary=e,n()},get supportIssueReporting(){return d(t.extension,"chatParticipantPrivate"),t._supportIssueReporting},set supportIssueReporting(e){d(t.extension,"chatParticipantPrivate"),t._supportIssueReporting=e,n()},get onDidReceiveFeedback(){return t._onDidReceiveFeedback.event},set participantVariableProvider(e){if(d(t.extension,"chatParticipantAdditions"),t._agentVariableProvider=e,e){if(!e.triggerCharacters.length)throw new Error("triggerCharacters are required");t._proxy.$registerAgentCompletionsProvider(t._handle,t.id,e.triggerCharacters)}else t._proxy.$unregisterAgentCompletionsProvider(t._handle,t.id)},get participantVariableProvider(){return d(t.extension,"chatParticipantAdditions"),t._agentVariableProvider},set welcomeMessageProvider(e){d(t.extension,"defaultChatParticipant"),t._welcomeMessageProvider=e,n()},get welcomeMessageProvider(){return d(t.extension,"defaultChatParticipant"),t._welcomeMessageProvider},set titleProvider(e){d(t.extension,"defaultChatParticipant"),t._titleProvider=e,n()},get titleProvider(){return d(t.extension,"defaultChatParticipant"),t._titleProvider},onDidPerformAction:b(this.extension,"chatParticipantAdditions")?this._onDidPerformAction.event:void 0,set requester(e){t._requester=e,n()},get requester(){return t._requester},set supportsSlowReferences(e){d(t.extension,"chatParticipantPrivate"),t._supportsSlowReferences=e,n()},get supportsSlowReferences(){return d(t.extension,"chatParticipantPrivate"),t._supportsSlowReferences},dispose(){l=!0,t._followupProvider=void 0,t._onDidReceiveFeedback.dispose(),t._proxy.$unregisterAgent(t._handle)}}}invoke(l,o,n,t){return this._requestHandler(l,o,n,t)}}export{g as ExtHostChatAgents2};
