import{ok as h}from"../../../base/common/assert.js";import{ReadonlyError as v,illegalArgument as g}from"../../../base/common/errors.js";import{IdGenerator as I}from"../../../base/common/idGenerator.js";import"../../../editor/common/config/editorOptions.js";import"../../../editor/common/core/range.js";import"../../../editor/common/core/editOperation.js";import"./extHost.protocol.js";import*as u from"./extHostTypeConverters.js";import{EndOfLine as E,Position as x,Range as _,Selection as z,TextEditorRevealType as R}from"./extHostTypes.js";import"../../../platform/log/common/log.js";import"../../../base/common/lazy.js";import"../../../platform/extensions/common/extensions.js";class T{static _Keys=new I("TextEditorDecorationType");value;constructor(e,t,n){const i=T._Keys.nextId();e.$registerTextEditorDecorationType(t.identifier,i,u.DecorationRenderOptions.from(n)),this.value=Object.freeze({key:i,dispose(){e.$removeTextEditorDecorationType(i)}})}}class O{_document;_documentVersionId;_undoStopBefore;_undoStopAfter;_collectedEdits=[];_setEndOfLine=void 0;_finalized=!1;constructor(e,t){this._document=e,this._documentVersionId=e.version,this._undoStopBefore=t.undoStopBefore,this._undoStopAfter=t.undoStopAfter}finalize(){return this._finalized=!0,{documentVersionId:this._documentVersionId,edits:this._collectedEdits,setEndOfLine:this._setEndOfLine,undoStopBefore:this._undoStopBefore,undoStopAfter:this._undoStopAfter}}_throwIfFinalized(){if(this._finalized)throw new Error("Edit is only valid while callback runs")}replace(e,t){this._throwIfFinalized();let n=null;if(e instanceof x)n=new _(e,e);else if(e instanceof _)n=e;else throw new Error("Unrecognized location");this._pushEdit(n,t,!1)}insert(e,t){this._throwIfFinalized(),this._pushEdit(new _(e,e),t,!0)}delete(e){this._throwIfFinalized();let t=null;if(e instanceof _)t=e;else throw new Error("Unrecognized location");this._pushEdit(t,null,!0)}_pushEdit(e,t,n){const i=this._document.validateRange(e);this._collectedEdits.push({range:i,text:t,forceMoveMarkers:n})}setEndOfLine(e){if(this._throwIfFinalized(),e!==E.LF&&e!==E.CRLF)throw g("endOfLine");this._setEndOfLine=e}}class w{_proxy;_id;_logService;_tabSize;_indentSize;_originalIndentSize;_insertSpaces;_cursorStyle;_lineNumbers;value;constructor(e,t,n,i){this._proxy=e,this._id=t,this._accept(n),this._logService=i;const r=this;this.value={get tabSize(){return r._tabSize},set tabSize(s){r._setTabSize(s)},get indentSize(){return r._indentSize},set indentSize(s){r._setIndentSize(s)},get insertSpaces(){return r._insertSpaces},set insertSpaces(s){r._setInsertSpaces(s)},get cursorStyle(){return r._cursorStyle},set cursorStyle(s){r._setCursorStyle(s)},get lineNumbers(){return r._lineNumbers},set lineNumbers(s){r._setLineNumbers(s)}}}_accept(e){this._tabSize=e.tabSize,this._indentSize=e.indentSize,this._originalIndentSize=e.originalIndentSize,this._insertSpaces=e.insertSpaces,this._cursorStyle=e.cursorStyle,this._lineNumbers=u.TextEditorLineNumbersStyle.to(e.lineNumbers)}_validateTabSize(e){if(e==="auto")return"auto";if(typeof e=="number"){const t=Math.floor(e);return t>0?t:null}if(typeof e=="string"){const t=parseInt(e,10);return isNaN(t)?null:t>0?t:null}return null}_setTabSize(e){const t=this._validateTabSize(e);if(t!==null){if(typeof t=="number"){if(this._tabSize===t)return;this._tabSize=t}this._warnOnError("setTabSize",this._proxy.$trySetOptions(this._id,{tabSize:t}))}}_validateIndentSize(e){if(e==="tabSize")return"tabSize";if(typeof e=="number"){const t=Math.floor(e);return t>0?t:null}if(typeof e=="string"){const t=parseInt(e,10);return isNaN(t)?null:t>0?t:null}return null}_setIndentSize(e){const t=this._validateIndentSize(e);if(t!==null){if(typeof t=="number"){if(this._originalIndentSize===t)return;this._indentSize=t,this._originalIndentSize=t}this._warnOnError("setIndentSize",this._proxy.$trySetOptions(this._id,{indentSize:t}))}}_validateInsertSpaces(e){return e==="auto"?"auto":e==="false"?!1:!!e}_setInsertSpaces(e){const t=this._validateInsertSpaces(e);if(typeof t=="boolean"){if(this._insertSpaces===t)return;this._insertSpaces=t}this._warnOnError("setInsertSpaces",this._proxy.$trySetOptions(this._id,{insertSpaces:t}))}_setCursorStyle(e){this._cursorStyle!==e&&(this._cursorStyle=e,this._warnOnError("setCursorStyle",this._proxy.$trySetOptions(this._id,{cursorStyle:e})))}_setLineNumbers(e){this._lineNumbers!==e&&(this._lineNumbers=e,this._warnOnError("setLineNumbers",this._proxy.$trySetOptions(this._id,{lineNumbers:u.TextEditorLineNumbersStyle.from(e)})))}assign(e){const t={};let n=!1;if(typeof e.tabSize<"u"){const i=this._validateTabSize(e.tabSize);i==="auto"?(n=!0,t.tabSize=i):typeof i=="number"&&this._tabSize!==i&&(this._tabSize=i,n=!0,t.tabSize=i)}if(typeof e.indentSize<"u"){const i=this._validateIndentSize(e.indentSize);i==="tabSize"?(n=!0,t.indentSize=i):typeof i=="number"&&this._originalIndentSize!==i&&(this._indentSize=i,this._originalIndentSize=i,n=!0,t.indentSize=i)}if(typeof e.insertSpaces<"u"){const i=this._validateInsertSpaces(e.insertSpaces);i==="auto"?(n=!0,t.insertSpaces=i):this._insertSpaces!==i&&(this._insertSpaces=i,n=!0,t.insertSpaces=i)}typeof e.cursorStyle<"u"&&this._cursorStyle!==e.cursorStyle&&(this._cursorStyle=e.cursorStyle,n=!0,t.cursorStyle=e.cursorStyle),typeof e.lineNumbers<"u"&&this._lineNumbers!==e.lineNumbers&&(this._lineNumbers=e.lineNumbers,n=!0,t.lineNumbers=u.TextEditorLineNumbersStyle.from(e.lineNumbers)),n&&this._warnOnError("setOptions",this._proxy.$trySetOptions(this._id,t))}_warnOnError(e,t){t.catch(n=>{this._logService.warn(`ExtHostTextEditorOptions '${e}' failed:'`),this._logService.warn(n)})}}class Y{constructor(e,t,n,i,r,s,m,y){this.id=e;this._proxy=t;this._logService=n;this._selections=r,this._options=new w(this._proxy,this.id,s,n),this._visibleRanges=m,this._viewColumn=y;const a=this;this.value=Object.freeze({get document(){return i.value},set document(o){throw new v("document")},get selection(){return a._selections&&a._selections[0]},set selection(o){if(!(o instanceof z))throw g("selection");a._selections=[o],a._trySetSelection()},get selections(){return a._selections},set selections(o){if(!Array.isArray(o)||o.some(d=>!(d instanceof z)))throw g("selections");a._selections=o,a._trySetSelection()},get visibleRanges(){return a._visibleRanges},set visibleRanges(o){throw new v("visibleRanges")},get options(){return a._options.value},set options(o){a._disposed||a._options.assign(o)},get viewColumn(){return a._viewColumn},set viewColumn(o){throw new v("viewColumn")},edit(o,d={undoStopBefore:!0,undoStopAfter:!0}){if(a._disposed)return Promise.reject(new Error("TextEditor#edit not possible on closed editors"));const p=new O(i.value,d);return o(p),a._applyEdit(p)},insertSnippet(o,d,p={undoStopBefore:!0,undoStopAfter:!0}){if(a._disposed)return Promise.reject(new Error("TextEditor#insertSnippet not possible on closed editors"));let c;if(!d||Array.isArray(d)&&d.length===0)c=a._selections.map(l=>u.Range.from(l));else if(d instanceof x){const{lineNumber:l,column:f}=u.Position.from(d);c=[{startLineNumber:l,startColumn:f,endLineNumber:l,endColumn:f}]}else if(d instanceof _)c=[u.Range.from(d)];else{c=[];for(const l of d)if(l instanceof _)c.push(u.Range.from(l));else{const{lineNumber:f,column:S}=u.Position.from(l);c.push({startLineNumber:f,startColumn:S,endLineNumber:f,endColumn:S})}}return t.$tryInsertSnippet(e,i.value.version,o.value,c,p)},setDecorations(o,d){const p=d.length===0;p&&!a._hasDecorationsForKey.has(o.key)||(p?a._hasDecorationsForKey.delete(o.key):a._hasDecorationsForKey.add(o.key),a._runOnProxy(()=>{if(u.isDecorationOptionsArr(d))return t.$trySetDecorations(e,o.key,u.fromRangeOrRangeWithMessage(d));{const c=new Array(4*d.length);for(let l=0,f=d.length;l<f;l++){const S=d[l];c[4*l]=S.start.line+1,c[4*l+1]=S.start.character+1,c[4*l+2]=S.end.line+1,c[4*l+3]=S.end.character+1}return t.$trySetDecorationsFast(e,o.key,c)}}))},revealRange(o,d){a._runOnProxy(()=>t.$tryRevealRange(e,u.Range.from(o),d||R.Default))},show(o){t.$tryShowEditor(e,u.ViewColumn.from(o))},hide(){t.$tryHideEditor(e)},[Symbol.for("debug.description")](){return`TextEditor(${this.document.uri.toString()})`}})}_selections;_options;_visibleRanges;_viewColumn;_disposed=!1;_hasDecorationsForKey=new Set;value;dispose(){h(!this._disposed),this._disposed=!0}_acceptOptions(e){h(!this._disposed),this._options._accept(e)}_acceptVisibleRanges(e){h(!this._disposed),this._visibleRanges=e}_acceptViewColumn(e){h(!this._disposed),this._viewColumn=e}_acceptSelections(e){h(!this._disposed),this._selections=e}async _trySetSelection(){const e=this._selections.map(u.Selection.from);return await this._runOnProxy(()=>this._proxy.$trySetSelections(this.id,e)),this.value}_applyEdit(e){const t=e.finalize();if(t.edits.length===0&&!t.setEndOfLine)return Promise.resolve(!0);const n=t.edits.map(r=>r.range);n.sort((r,s)=>r.end.line===s.end.line?r.end.character===s.end.character?r.start.line===s.start.line?r.start.character-s.start.character:r.start.line-s.start.line:r.end.character-s.end.character:r.end.line-s.end.line);for(let r=0,s=n.length-1;r<s;r++){const m=n[r].end;if(n[r+1].start.isBefore(m))return Promise.reject(new Error("Overlapping ranges are not allowed!"))}const i=t.edits.map(r=>({range:u.Range.from(r.range),text:r.text,forceMoveMarkers:r.forceMoveMarkers}));return this._proxy.$tryApplyEdits(this.id,t.documentVersionId,i,{setEndOfLine:typeof t.setEndOfLine=="number"?u.EndOfLine.from(t.setEndOfLine):void 0,undoStopBefore:t.undoStopBefore,undoStopAfter:t.undoStopAfter})}_runOnProxy(e){return this._disposed?(this._logService.warn("TextEditor is closed/disposed"),Promise.resolve(void 0)):e().then(()=>this,t=>(t instanceof Error&&t.name==="DISPOSED"||this._logService.warn(t),null))}}export{Y as ExtHostTextEditor,w as ExtHostTextEditorOptions,T as TextEditorDecorationType};
