{
  "version": 3,
  "sources": ["../../../../../../../Dependency/CodeEditorLand/Editor/Source/vs/workbench/api/common/extHostLanguageModelTools.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { raceCancellation } from '../../../base/common/async.js';\nimport { CancellationToken } from '../../../base/common/cancellation.js';\nimport { CancellationError } from '../../../base/common/errors.js';\nimport { IDisposable, toDisposable } from '../../../base/common/lifecycle.js';\nimport { revive } from '../../../base/common/marshalling.js';\nimport { generateUuid } from '../../../base/common/uuid.js';\nimport { IExtensionDescription } from '../../../platform/extensions/common/extensions.js';\nimport { ExtHostLanguageModelToolsShape, IMainContext, IToolDataDto, MainContext, MainThreadLanguageModelToolsShape } from './extHost.protocol.js';\nimport * as typeConvert from './extHostTypeConverters.js';\nimport { IToolInvocation, IToolResult } from '../../contrib/chat/common/languageModelToolsService.js';\nimport type * as vscode from 'vscode';\n\nexport class ExtHostLanguageModelTools implements ExtHostLanguageModelToolsShape {\n\t/** A map of tools that were registered in this EH */\n\tprivate readonly _registeredTools = new Map<string, { extension: IExtensionDescription; tool: vscode.LanguageModelTool }>();\n\tprivate readonly _proxy: MainThreadLanguageModelToolsShape;\n\tprivate readonly _tokenCountFuncs = new Map</* call ID */string, (text: string, token?: vscode.CancellationToken) => Thenable<number>>();\n\n\t/** A map of all known tools, from other EHs or registered in vscode core */\n\tprivate readonly _allTools = new Map<string, IToolDataDto>();\n\n\tconstructor(mainContext: IMainContext) {\n\t\tthis._proxy = mainContext.getProxy(MainContext.MainThreadLanguageModelTools);\n\n\t\tthis._proxy.$getTools().then(tools => {\n\t\t\tfor (const tool of tools) {\n\t\t\t\tthis._allTools.set(tool.id, revive(tool));\n\t\t\t}\n\t\t});\n\t}\n\n\tasync $countTokensForInvocation(callId: string, input: string, token: CancellationToken): Promise<number> {\n\t\tconst fn = this._tokenCountFuncs.get(callId);\n\t\tif (!fn) {\n\t\t\tthrow new Error(`Tool invocation call ${callId} not found`);\n\t\t}\n\n\t\treturn await fn(input, token);\n\t}\n\n\tasync invokeTool(toolId: string, options: vscode.LanguageModelToolInvocationOptions, token: CancellationToken): Promise<vscode.LanguageModelToolResult> {\n\t\tconst callId = generateUuid();\n\t\tif (options.tokenOptions) {\n\t\t\tthis._tokenCountFuncs.set(callId, options.tokenOptions.countTokens);\n\t\t}\n\t\ttry {\n\t\t\t// Making the round trip here because not all tools were necessarily registered in this EH\n\t\t\tconst result = await this._proxy.$invokeTool({\n\t\t\t\ttoolId,\n\t\t\t\tcallId,\n\t\t\t\tparameters: options.parameters,\n\t\t\t\ttokenBudget: options.tokenOptions?.tokenBudget,\n\t\t\t}, token);\n\t\t\treturn typeConvert.LanguageModelToolResult.to(result);\n\t\t} finally {\n\t\t\tthis._tokenCountFuncs.delete(callId);\n\t\t}\n\t}\n\n\t$onDidChangeTools(tools: IToolDataDto[]): void {\n\t\tthis._allTools.clear();\n\t\tfor (const tool of tools) {\n\t\t\tthis._allTools.set(tool.id, tool);\n\t\t}\n\t}\n\n\tget tools(): vscode.LanguageModelToolDescription[] {\n\t\treturn Array.from(this._allTools.values())\n\t\t\t.map(tool => typeConvert.LanguageModelToolDescription.to(tool));\n\t}\n\n\tasync $invokeTool(dto: IToolInvocation, token: CancellationToken): Promise<IToolResult> {\n\t\tconst item = this._registeredTools.get(dto.toolId);\n\t\tif (!item) {\n\t\t\tthrow new Error(`Unknown tool ${dto.toolId}`);\n\t\t}\n\n\t\tconst options: vscode.LanguageModelToolInvocationOptions = { parameters: dto.parameters };\n\t\tif (dto.tokenBudget !== undefined) {\n\t\t\toptions.tokenOptions = {\n\t\t\t\ttokenBudget: dto.tokenBudget,\n\t\t\t\tcountTokens: this._tokenCountFuncs.get(dto.callId) || ((value, token = CancellationToken.None) =>\n\t\t\t\t\tthis._proxy.$countTokensForInvocation(dto.callId, value, token))\n\t\t\t};\n\t\t}\n\n\t\tconst extensionResult = await raceCancellation(Promise.resolve(item.tool.invoke(options, token)), token);\n\t\tif (!extensionResult) {\n\t\t\tthrow new CancellationError();\n\t\t}\n\n\t\tfor (const key of Object.keys(extensionResult)) {\n\t\t\tconst value = extensionResult[key];\n\t\t\tif (value instanceof Promise) {\n\t\t\t\tthrow new Error(`Tool result for '${key}' cannot be a Promise`);\n\t\t\t}\n\t\t}\n\n\t\treturn typeConvert.LanguageModelToolResult.from(extensionResult);\n\t}\n\n\tregisterTool(extension: IExtensionDescription, name: string, tool: vscode.LanguageModelTool): IDisposable {\n\t\tthis._registeredTools.set(name, { extension, tool });\n\t\tthis._proxy.$registerTool(name);\n\n\t\treturn toDisposable(() => {\n\t\t\tthis._registeredTools.delete(name);\n\t\t\tthis._proxy.$unregisterTool(name);\n\t\t});\n\t}\n}\n"],
  "mappings": "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",
  "names": ["token"]
}
