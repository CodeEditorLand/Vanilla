import{raceCancellation as i}from"../../../base/common/async.js";import{CancellationToken as c}from"../../../base/common/cancellation.js";import{CancellationError as g}from"../../../base/common/errors.js";import{toDisposable as u}from"../../../base/common/lifecycle.js";import{revive as T}from"../../../base/common/marshalling.js";import{generateUuid as p}from"../../../base/common/uuid.js";import"../../../platform/extensions/common/extensions.js";import"../../contrib/chat/common/languageModelToolsService.js";import{MainContext as d}from"./extHost.protocol.js";import*as a from"./extHostTypeConverters.js";class O{_registeredTools=new Map;_proxy;_tokenCountFuncs=new Map;_allTools=new Map;constructor(o){this._proxy=o.getProxy(d.MainThreadLanguageModelTools),this._proxy.$getTools().then(e=>{for(const t of e)this._allTools.set(t.id,T(t))})}async $countTokensForInvocation(o,e,t){const n=this._tokenCountFuncs.get(o);if(!n)throw new Error(`Tool invocation call ${o} not found`);return await n(e,t)}async invokeTool(o,e,t){const n=p();e.tokenOptions&&this._tokenCountFuncs.set(n,e.tokenOptions.countTokens);try{const s=await this._proxy.$invokeTool({toolId:o,callId:n,parameters:e.parameters,tokenBudget:e.tokenOptions?.tokenBudget},t);return a.LanguageModelToolResult.to(s)}finally{this._tokenCountFuncs.delete(n)}}$onDidChangeTools(o){this._allTools.clear();for(const e of o)this._allTools.set(e.id,e)}get tools(){return Array.from(this._allTools.values()).map(o=>a.LanguageModelToolDescription.to(o))}async $invokeTool(o,e){const t=this._registeredTools.get(o.toolId);if(!t)throw new Error(`Unknown tool ${o.toolId}`);const n={parameters:o.parameters};o.tokenBudget!==void 0&&(n.tokenOptions={tokenBudget:o.tokenBudget,countTokens:this._tokenCountFuncs.get(o.callId)||((r,l=c.None)=>this._proxy.$countTokensForInvocation(o.callId,r,l))});const s=await i(Promise.resolve(t.tool.invoke(n,e)),e);if(!s)throw new g;for(const r of Object.keys(s))if(s[r]instanceof Promise)throw new Error(`Tool result for '${r}' cannot be a Promise`);return a.LanguageModelToolResult.from(s)}registerTool(o,e,t){return this._registeredTools.set(e,{extension:o,tool:t}),this._proxy.$registerTool(e),u(()=>{this._registeredTools.delete(e),this._proxy.$unregisterTool(e)})}}export{O as ExtHostLanguageModelTools};
