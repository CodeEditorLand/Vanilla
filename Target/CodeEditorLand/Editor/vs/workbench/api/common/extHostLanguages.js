import{disposableTimeout as v}from"../../../base/common/async.js";import{DisposableStore as h}from"../../../base/common/lifecycle.js";import l from"../../../base/common/severity.js";import{checkProposedApiEnabled as y}from"../../services/extensions/common/extensions.js";import{MainContext as x}from"./extHost.protocol.js";import*as d from"./extHostTypeConverters.js";import{LanguageStatusSeverity as p,Range as I,StandardTokenType as b}from"./extHostTypes.js";class w{constructor(t,s,i,m){this._documents=s;this._commands=i;this._uriTransformer=m;this._proxy=t.getProxy(x.MainThreadLanguages)}_proxy;_languageIds=[];$acceptLanguageIds(t){this._languageIds=t}async getLanguages(){return this._languageIds.slice(0)}async changeLanguage(t,s){await this._proxy.$changeLanguage(t,s);const i=this._documents.getDocumentData(t);if(!i)throw new Error(`document '${t.toString()}' NOT found`);return i.document}async tokenAtPosition(t,s){const i=t.version,m=d.Position.from(s),c=await this._proxy.$tokensAtPosition(t.uri,m),o={type:b.Other,range:t.getWordRangeAtPosition(s)??new I(s.line,s.character,s.line,s.character)};if(!c)return o;const r={range:d.Range.to(c.range),type:d.TokenType.to(c.type)};return!r.range.contains(s)||i!==t.version?o:r}_handlePool=0;_ids=new Set;createLanguageStatusItem(t,s,i){const m=this._handlePool++,c=this._proxy,o=this._ids,r=`${t.identifier.value}/${s}`;if(o.has(r))throw new Error(`LanguageStatusItem with id '${s}' ALREADY exists`);o.add(r);const e={selector:i,id:s,name:t.displayName??t.name,severity:p.Information,command:void 0,text:"",detail:"",busy:!1};let u;const g=new h,n=()=>{u?.dispose(),o.has(r)&&(u=v(()=>{g.clear(),this._proxy.$setLanguageStatus(m,{id:r,name:e.name??t.displayName??t.name,source:t.displayName??t.name,selector:d.DocumentSelector.from(e.selector,this._uriTransformer),label:e.text,detail:e.detail??"",severity:e.severity===p.Error?l.Error:e.severity===p.Warning?l.Warning:l.Info,command:e.command&&this._commands.toInternal(e.command,g),accessibilityInfo:e.accessibilityInformation,busy:e.busy})},0))},f={dispose(){g.dispose(),u?.dispose(),c.$removeLanguageStatus(m),o.delete(r)},get id(){return e.id},get name(){return e.name},set name(a){e.name=a,n()},get selector(){return e.selector},set selector(a){e.selector=a,n()},get text(){return e.text},set text(a){e.text=a,n()},set text2(a){y(t,"languageStatusText"),e.text=a,n()},get text2(){return y(t,"languageStatusText"),e.text},get detail(){return e.detail},set detail(a){e.detail=a,n()},get severity(){return e.severity},set severity(a){e.severity=a,n()},get accessibilityInformation(){return e.accessibilityInformation},set accessibilityInformation(a){e.accessibilityInformation=a,n()},get command(){return e.command},set command(a){e.command=a,n()},get busy(){return e.busy},set busy(a){e.busy=a,n()}};return n(),f}}export{w as ExtHostLanguages};
