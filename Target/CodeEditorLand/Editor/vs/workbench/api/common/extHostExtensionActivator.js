var y=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var v=(s,e,t,i)=>{for(var n=i>1?void 0:i?b(e,t):e,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(e,t,n):a(n))||n);return i&&n&&y(e,t,n),n},u=(s,e)=>(t,i)=>e(t,i,s);import*as A from"../../../base/common/errors.js";import{Disposable as h}from"../../../base/common/lifecycle.js";import{ExtensionDescriptionRegistry as w}from"../../services/extensions/common/extensionDescriptionRegistry.js";import{ExtensionIdentifierMap as S}from"../../../platform/extensions/common/extensions.js";import{MissingExtensionDependency as x}from"../../services/extensions/common/extensions.js";import{ILogService as E}from"../../../platform/log/common/log.js";import{Barrier as I}from"../../../base/common/async.js";class d{static NONE=new d(!1,-1,-1,-1);startup;codeLoadingTime;activateCallTime;activateResolvedTime;constructor(e,t,i,n){this.startup=e,this.codeLoadingTime=t,this.activateCallTime=i,this.activateResolvedTime=n}}class ${_startup;_codeLoadingStart;_codeLoadingStop;_activateCallStart;_activateCallStop;_activateResolveStart;_activateResolveStop;constructor(e){this._startup=e,this._codeLoadingStart=-1,this._codeLoadingStop=-1,this._activateCallStart=-1,this._activateCallStop=-1,this._activateResolveStart=-1,this._activateResolveStop=-1}_delta(e,t){return e===-1||t===-1?-1:t-e}build(){return new d(this._startup,this._delta(this._codeLoadingStart,this._codeLoadingStop),this._delta(this._activateCallStart,this._activateCallStop),this._delta(this._activateResolveStart,this._activateResolveStop))}codeLoadingStart(){this._codeLoadingStart=Date.now()}codeLoadingStop(){this._codeLoadingStop=Date.now()}activateCallStart(){this._activateCallStart=Date.now()}activateCallStop(){this._activateCallStop=Date.now()}activateResolveStart(){this._activateResolveStart=Date.now()}activateResolveStop(){this._activateResolveStop=Date.now()}}class _{activationFailed;activationFailedError;activationTimes;module;exports;disposable;constructor(e,t,i,n,o,a){this.activationFailed=e,this.activationFailedError=t,this.activationTimes=i,this.module=n,this.exports=o,this.disposable=a}}class M extends _{constructor(e){super(!1,null,e,{activate:void 0,deactivate:void 0},void 0,h.None)}}class k extends _{constructor(){super(!1,null,d.NONE,{activate:void 0,deactivate:void 0},void 0,h.None)}}class c extends _{constructor(e){super(!0,e,d.NONE,{activate:void 0,deactivate:void 0},void 0,h.None)}}let p=class{constructor(e,t,i,n){this._logService=n;this._registry=e,this._globalRegistry=t,this._host=i,this._operations=new S,this._alreadyActivatedEvents=Object.create(null)}_registry;_globalRegistry;_host;_operations;_alreadyActivatedEvents;dispose(){for(const[e,t]of this._operations)t.dispose()}async waitForActivatingExtensions(){const e=[];for(const[t,i]of this._operations)e.push(i.wait());await Promise.all(e)}isActivated(e){const t=this._operations.get(e);return!!(t&&t.value)}getActivatedExtension(e){const t=this._operations.get(e);if(!t||!t.value)throw new Error(`Extension '${e.value}' is not known or not activated`);return t.value}async activateByEvent(e,t){if(this._alreadyActivatedEvents[e])return;const i=this._registry.getExtensionDescriptionsForActivationEvent(e);await this._activateExtensions(i.map(n=>({id:n.identifier,reason:{startup:t,extensionId:n.identifier,activationEvent:e}}))),this._alreadyActivatedEvents[e]=!0}activateById(e,t){const i=this._registry.getExtensionDescription(e);if(!i)throw new Error(`Extension '${e.value}' is not known`);return this._activateExtensions([{id:i.identifier,reason:t}])}async _activateExtensions(e){const t=e.filter(i=>!this.isActivated(i.id)).map(i=>this._handleActivationRequest(i));await Promise.all(t.map(i=>i.wait()))}_handleActivationRequest(e){if(this._operations.has(e.id))return this._operations.get(e.id);if(this._isHostExtension(e.id))return this._createAndSaveOperation(e,null,[],null);const t=this._registry.getExtensionDescription(e.id);if(!t){const o=new Error(`Cannot activate unknown extension '${e.id.value}'`),a=this._createAndSaveOperation(e,null,[],new c(o));return this._host.onExtensionActivationError(e.id,o,new x(e.id.value)),a}const i=[],n=typeof t.extensionDependencies>"u"?[]:t.extensionDependencies;for(const o of n){if(this._isResolvedExtension(o))continue;const a=this._operations.get(o);if(a){i.push(a);continue}if(this._isHostExtension(o)){i.push(this._handleActivationRequest({id:this._globalRegistry.getExtensionDescription(o).identifier,reason:e.reason}));continue}const r=this._registry.getExtensionDescription(o);if(r){if(!r.main&&!r.browser)continue;i.push(this._handleActivationRequest({id:r.identifier,reason:e.reason}));continue}const f=t.displayName||t.identifier.value,m=new Error(`Cannot activate the '${f}' extension because it depends on unknown extension '${o}'`),g=this._createAndSaveOperation(e,t.displayName,[],new c(m));return this._host.onExtensionActivationError(t.identifier,m,new x(o)),g}return this._createAndSaveOperation(e,t.displayName,i,null)}_createAndSaveOperation(e,t,i,n){const o=new l(e.id,t,e.reason,i,n,this._host,this._logService);return this._operations.set(e.id,o),o}_isHostExtension(e){return w.isHostExtension(e,this._registry,this._globalRegistry)}_isResolvedExtension(e){const t=this._globalRegistry.getExtensionDescription(e);return t?!t.main&&!t.browser:!1}};p=v([u(3,E)],p);let l=class{constructor(e,t,i,n,o,a,r){this._id=e;this._displayName=t;this._reason=i;this._deps=n;this._value=o;this._host=a;this._logService=r;this._initialize()}_barrier=new I;_isDisposed=!1;get value(){return this._value}get friendlyName(){return this._displayName||this._id.value}dispose(){this._isDisposed=!0}wait(){return this._barrier.wait()}async _initialize(){await this._waitForDepsThenActivate(),this._barrier.open()}async _waitForDepsThenActivate(){if(!this._value){for(;this._deps.length>0;){for(let e=0;e<this._deps.length;e++){const t=this._deps[e];if(t.value&&!t.value.activationFailed){this._deps.splice(e,1),e--;continue}if(t.value&&t.value.activationFailed){const i=new Error(`Cannot activate the '${this.friendlyName}' extension because its dependency '${t.friendlyName}' failed to activate`);i.detail=t.value.activationFailedError,this._value=new c(i),this._host.onExtensionActivationError(this._id,i,null);return}}this._deps.length>0&&await Promise.race(this._deps.map(e=>e.wait()))}await this._activate()}}async _activate(){try{this._value=await this._host.actualActivateExtension(this._id,this._reason)}catch(e){const t=new Error;if(e&&e.name&&(t.name=e.name),e&&e.message?t.message=`Activating extension '${this._id.value}' failed: ${e.message}.`:t.message=`Activating extension '${this._id.value}' failed: ${e}.`,e&&e.stack&&(t.stack=e.stack),this._value=new c(t),this._isDisposed&&A.isCancellationError(e))return;this._host.onExtensionActivationError(this._id,t,null),this._logService.error(`Activating extension ${this._id.value} failed due to an error:`),this._logService.error(e)}}};l=v([u(6,E)],l);export{_ as ActivatedExtension,M as EmptyExtension,d as ExtensionActivationTimes,$ as ExtensionActivationTimesBuilder,p as ExtensionsActivator,k as HostExtension};
