import{asArray as Ee,coalesce as ee,isFalsyOrEmpty as te,isNonEmptyArray as B}from"../../../base/common/arrays.js";import{raceCancellationError as Te}from"../../../base/common/async.js";import"../../../base/common/buffer.js";import{CancellationToken as He}from"../../../base/common/cancellation.js";import{NotImplementedError as Ae,isCancellationError as we}from"../../../base/common/errors.js";import{IdGenerator as oe}from"../../../base/common/idGenerator.js";import{DisposableStore as I}from"../../../base/common/lifecycle.js";import{equals as Re,mixin as ke}from"../../../base/common/objects.js";import{StopWatch as Le}from"../../../base/common/stopwatch.js";import{regExpLeadsToEndlessLoop as $e}from"../../../base/common/strings.js";import{assertType as Fe,isObject as Ne}from"../../../base/common/types.js";import{URI as p}from"../../../base/common/uri.js";import"../../../base/common/uriIpc.js";import"../../../editor/common/core/editOperation.js";import"../../../editor/common/core/position.js";import{Range as ne}from"../../../editor/common/core/range.js";import{Selection as Ue}from"../../../editor/common/core/selection.js";import*as C from"../../../editor/common/languages.js";import"../../../editor/common/languages/languageConfiguration.js";import{encodeSemanticTokensDto as j}from"../../../editor/common/services/semanticTokensDto.js";import{localize as ie}from"../../../nls.js";import{ExtensionIdentifier as re}from"../../../platform/extensions/common/extensions.js";import"../../../platform/log/common/log.js";import"./extHostApiDeprecationService.js";import"./extHostCommands.js";import"./extHostDiagnostics.js";import"./extHostDocuments.js";import"./extHostTelemetry.js";import*as d from"./extHostTypeConverters.js";import{CodeActionKind as Me,CompletionList as Oe,Disposable as A,DocumentDropOrPasteEditKind as We,DocumentSymbol as Ke,InlineCompletionTriggerKind as se,InlineEditTriggerKind as ae,InternalDataTransferItem as Ve,Location as ze,NewSymbolNameTriggerKind as de,Range as M,SemanticTokens as qe,SemanticTokensEdit as Be,SemanticTokensEdits as G,SnippetString as je,SyntaxTokenType as Ge}from"./extHostTypes.js";import{checkProposedApiEnabled as Je,isProposedApiEnabled as k}from"../../services/extensions/common/extensions.js";import{Cache as S}from"./cache.js";import*as u from"./extHost.protocol.js";class q{constructor(e,t){this._documents=e;this._provider=t}async provideDocumentSymbols(e,t){const o=this._documents.getDocument(e),n=await this._provider.provideDocumentSymbols(o,t);if(!te(n))return n[0]instanceof Ke?n.map(d.DocumentSymbol.from):q._asDocumentSymbolTree(n)}static _asDocumentSymbolTree(e){e=e.slice(0).sort((n,i)=>{let r=n.location.range.start.compareTo(i.location.range.start);return r===0&&(r=i.location.range.end.compareTo(n.location.range.end)),r});const t=[],o=[];for(const n of e){const i={name:n.name||"!!MISSING: name!!",kind:d.SymbolKind.from(n.kind),tags:n.tags?.map(d.SymbolTag.from)||[],detail:"",containerName:n.containerName,range:d.Range.from(n.location.range),selectionRange:d.Range.from(n.location.range),children:[]};for(;;){if(o.length===0){o.push(i),t.push(i);break}const r=o[o.length-1];if(ne.containsRange(r.range,i.range)&&!ne.equalsRange(r.range,i.range)){r.children?.push(i),o.push(i);break}o.pop()}}return t}}class O{constructor(e,t,o,n,i,r){this._documents=e;this._commands=t;this._provider=o;this._extension=n;this._extTelemetry=i;this._logService=r}_cache=new S("CodeLens");_disposables=new Map;async provideCodeLenses(e,t){const o=this._documents.getDocument(e),n=await this._provider.provideCodeLenses(o,t);if(!n||t.isCancellationRequested)return;const i=this._cache.add(n),r=new I;this._disposables.set(i,r);const s={cacheId:i,lenses:[]};for(let a=0;a<n.length;a++)s.lenses.push({cacheId:[i,a],range:d.Range.from(n[a].range),command:this._commands.toInternal(n[a].command,r)});return s}async resolveCodeLens(e,t){const o=e.cacheId&&this._cache.get(...e.cacheId);if(!o)return;let n;if(typeof this._provider.resolveCodeLens!="function"||o.isResolved?n=o:n=await this._provider.resolveCodeLens(o,t),n||(n=o),t.isCancellationRequested)return;const i=e.cacheId&&this._disposables.get(e.cacheId[0]);if(i){if(!n.command){const r=new Error("INVALID code lens resolved, lacks command: "+this._extension.identifier.value);this._extTelemetry.onExtensionError(this._extension.identifier,r),this._logService.error(r);return}return e.command=this._commands.toInternal(n.command,i),e}}releaseCodeLenses(e){this._disposables.get(e)?.dispose(),this._disposables.delete(e),this._cache.delete(e)}}function W(g){return Array.isArray(g)?g.map(d.DefinitionLink.from):g?[d.DefinitionLink.from(g)]:[]}class ce{constructor(e,t){this._documents=e;this._provider=t}async provideDefinition(e,t,o){const n=this._documents.getDocument(e),i=d.Position.to(t),r=await this._provider.provideDefinition(n,i,o);return W(r)}}class le{constructor(e,t){this._documents=e;this._provider=t}async provideDeclaration(e,t,o){const n=this._documents.getDocument(e),i=d.Position.to(t),r=await this._provider.provideDeclaration(n,i,o);return W(r)}}class ue{constructor(e,t){this._documents=e;this._provider=t}async provideImplementation(e,t,o){const n=this._documents.getDocument(e),i=d.Position.to(t),r=await this._provider.provideImplementation(n,i,o);return W(r)}}class me{constructor(e,t){this._documents=e;this._provider=t}async provideTypeDefinition(e,t,o){const n=this._documents.getDocument(e),i=d.Position.to(t),r=await this._provider.provideTypeDefinition(n,i,o);return W(r)}}class U{constructor(e,t){this._documents=e;this._provider=t}_hoverCounter=0;_hoverMap=new Map;static HOVER_MAP_MAX_SIZE=10;async provideHover(e,t,o,n){const i=this._documents.getDocument(e),r=d.Position.to(t);let s;if(o&&o.verbosityRequest){const v=o.verbosityRequest.previousHover.id,l=this._hoverMap.get(v);if(!l)throw new Error(`Hover with id ${v} not found`);const D={verbosityDelta:o.verbosityRequest.verbosityDelta,previousHover:l};s=await this._provider.provideHover(i,r,n,D)}else s=await this._provider.provideHover(i,r,n);if(!s||te(s.contents))return;s.range||(s.range=i.getWordRangeAtPosition(r)),s.range||(s.range=new M(r,r));const a=d.Hover.from(s),c=this._hoverCounter;if(this._hoverMap.size===U.HOVER_MAP_MAX_SIZE){const v=Math.min(...this._hoverMap.keys());this._hoverMap.delete(v)}return this._hoverMap.set(c,s),this._hoverCounter+=1,{...a,id:c}}releaseHover(e){this._hoverMap.delete(e)}}class pe{constructor(e,t){this._documents=e;this._provider=t}async provideEvaluatableExpression(e,t,o){const n=this._documents.getDocument(e),i=d.Position.to(t),r=await this._provider.provideEvaluatableExpression(n,i,o);if(r)return d.EvaluatableExpression.from(r)}}class ve{constructor(e,t){this._documents=e;this._provider=t}async provideInlineValues(e,t,o,n){const i=this._documents.getDocument(e),r=await this._provider.provideInlineValues(i,d.Range.to(t),d.InlineValueContext.to(o),n);if(Array.isArray(r))return r.map(s=>d.InlineValue.from(s))}}class ge{constructor(e,t){this._documents=e;this._provider=t}async provideDocumentHighlights(e,t,o){const n=this._documents.getDocument(e),i=d.Position.to(t),r=await this._provider.provideDocumentHighlights(n,i,o);if(Array.isArray(r))return r.map(d.DocumentHighlight.from)}}class he{constructor(e,t){this._documents=e;this._provider=t}async provideMultiDocumentHighlights(e,t,o,n){const i=this._documents.getDocument(e),r=o.map(c=>this._documents.getDocument(c)),s=d.Position.to(t),a=await this._provider.provideMultiDocumentHighlights(i,s,r,n);if(Array.isArray(a))return a.map(d.MultiDocumentHighlight.from)}}class fe{constructor(e,t){this._documents=e;this._provider=t}async provideLinkedEditingRanges(e,t,o){const n=this._documents.getDocument(e),i=d.Position.to(t),r=await this._provider.provideLinkedEditingRanges(n,i,o);if(r&&Array.isArray(r.ranges))return{ranges:ee(r.ranges.map(d.Range.from)),wordPattern:r.wordPattern}}}class De{constructor(e,t){this._documents=e;this._provider=t}async provideReferences(e,t,o,n){const i=this._documents.getDocument(e),r=d.Position.to(t),s=await this._provider.provideReferences(i,r,o,n);if(Array.isArray(s))return s.map(d.location.from)}}class x{constructor(e,t,o,n,i,r,s){this._documents=e;this._commands=t;this._diagnostics=o;this._provider=n;this._logService=i;this._extension=r;this._apiDeprecation=s}static _maxCodeActionsPerFile=1e3;_cache=new S("CodeAction");_disposables=new Map;async provideCodeActions(e,t,o,n){const i=this._documents.getDocument(e),r=Ue.isISelection(t)?d.Selection.to(t):d.Range.to(t),s=[];for(const D of this._diagnostics.getDiagnostics(e))if(r.intersection(D.range)&&s.push(D)>x._maxCodeActionsPerFile)break;const a={diagnostics:s,only:o.only?new Me(o.only):void 0,triggerKind:d.CodeActionTriggerKind.to(o.trigger)},c=await this._provider.provideCodeActions(i,r,a,n);if(!B(c)||n.isCancellationRequested)return;const h=this._cache.add(c),v=new I;this._disposables.set(h,v);const l=[];for(let D=0;D<c.length;D++){const m=c[D];if(m)if(x._isCommand(m))this._apiDeprecation.report("CodeActionProvider.provideCodeActions - return commands",this._extension,"Return 'CodeAction' instances instead."),l.push({_isSynthetic:!0,title:m.title,command:this._commands.toInternal(m,v)});else{a.only&&(m.kind?a.only.contains(m.kind)||this._logService.warn(`${this._extension.identifier.value} - Code actions of kind '${a.only.value}' requested but returned code action is of kind '${m.kind.value}'. Code action will be dropped. Please check 'CodeActionContext.only' to only return requested code actions.`):this._logService.warn(`${this._extension.identifier.value} - Code actions of kind '${a.only.value}' requested but returned code action does not have a 'kind'. Code action will be dropped. Please set 'CodeAction.kind'.`));const E=m.ranges??[];l.push({cacheId:[h,D],title:m.title,command:m.command&&this._commands.toInternal(m.command,v),diagnostics:m.diagnostics&&m.diagnostics.map(d.Diagnostic.from),edit:m.edit&&d.WorkspaceEdit.from(m.edit,void 0),kind:m.kind&&m.kind.value,isPreferred:m.isPreferred,isAI:k(this._extension,"codeActionAI")?m.isAI:!1,ranges:k(this._extension,"codeActionRanges")?ee(E.map(d.Range.from)):void 0,disabled:m.disabled?.reason})}}return{cacheId:h,actions:l}}async resolveCodeAction(e,t){const[o,n]=e,i=this._cache.get(o,n);if(!i||x._isCommand(i))return{};if(!this._provider.resolveCodeAction)return{};const r=await this._provider.resolveCodeAction(i,t)??i;let s;r.edit&&(s=d.WorkspaceEdit.from(r.edit,void 0));let a;if(r.command){const c=this._disposables.get(o);c&&(a=this._commands.toInternal(r.command,c))}return{edit:s,command:a}}releaseCodeActions(e){this._disposables.get(e)?.dispose(),this._disposables.delete(e),this._cache.delete(e)}static _isCommand(e){return typeof e.command=="string"&&typeof e.title=="string"}}class L{constructor(e,t,o,n,i){this._proxy=e;this._documents=t;this._provider=o;this._handle=n;this._extension=i}_cache=new S("DocumentPasteEdit");async prepareDocumentPaste(e,t,o,n){if(!this._provider.prepareDocumentPaste)return;const i=this._documents.getDocument(e),r=t.map(c=>d.Range.to(c)),s=d.DataTransfer.toDataTransfer(o,()=>{throw new Ae});if(await this._provider.prepareDocumentPaste(i,r,s,n),n.isCancellationRequested)return;const a=Array.from(s).filter(([,c])=>!(c instanceof Ve));return d.DataTransfer.from(a)}async providePasteEdits(e,t,o,n,i,r){if(!this._provider.provideDocumentPasteEdits)return[];const s=this._documents.getDocument(t),a=o.map(l=>d.Range.to(l)),c=d.DataTransfer.toDataTransfer(n,async l=>(await this._proxy.$resolvePasteFileData(this._handle,e,l)).buffer),h=await this._provider.provideDocumentPasteEdits(s,a,c,{only:i.only?new We(i.only):void 0,triggerKind:i.triggerKind},r);if(!h||r.isCancellationRequested)return[];const v=this._cache.add(h);return h.map((l,D)=>({_cacheId:[v,D],title:l.title??ie("defaultPasteLabel","Paste using '{0}' extension",this._extension.displayName||this._extension.name),kind:l.kind,yieldTo:l.yieldTo?.map(m=>m.value),insertText:typeof l.insertText=="string"?l.insertText:{snippet:l.insertText.value},additionalEdit:l.additionalEdit?d.WorkspaceEdit.from(l.additionalEdit,void 0):void 0}))}async resolvePasteEdit(e,t){const[o,n]=e,i=this._cache.get(o,n);if(!i||!this._provider.resolveDocumentPasteEdit)return{};const r=await this._provider.resolveDocumentPasteEdit(i,t)??i;return{additionalEdit:r.additionalEdit?d.WorkspaceEdit.from(r.additionalEdit,void 0):void 0}}releasePasteEdits(e){this._cache.delete(e)}}class _e{constructor(e,t){this._documents=e;this._provider=t}async provideDocumentFormattingEdits(e,t,o){const n=this._documents.getDocument(e),i=await this._provider.provideDocumentFormattingEdits(n,t,o);if(Array.isArray(i))return i.map(d.TextEdit.from)}}class J{constructor(e,t){this._documents=e;this._provider=t}async provideDocumentRangeFormattingEdits(e,t,o,n){const i=this._documents.getDocument(e),r=d.Range.to(t),s=await this._provider.provideDocumentRangeFormattingEdits(i,r,o,n);if(Array.isArray(s))return s.map(d.TextEdit.from)}async provideDocumentRangesFormattingEdits(e,t,o,n){Fe(typeof this._provider.provideDocumentRangesFormattingEdits=="function","INVALID invocation of `provideDocumentRangesFormattingEdits`");const i=this._documents.getDocument(e),r=t.map(d.Range.to),s=await this._provider.provideDocumentRangesFormattingEdits(i,r,o,n);if(Array.isArray(s))return s.map(d.TextEdit.from)}}class Ie{constructor(e,t){this._documents=e;this._provider=t}autoFormatTriggerCharacters=[];async provideOnTypeFormattingEdits(e,t,o,n,i){const r=this._documents.getDocument(e),s=d.Position.to(t),a=await this._provider.provideOnTypeFormattingEdits(r,s,o,n,i);if(Array.isArray(a))return a.map(d.TextEdit.from)}}class K{constructor(e,t){this._provider=e;this._logService=t}_cache=new S("WorkspaceSymbols");async provideWorkspaceSymbols(e,t){const o=await this._provider.provideWorkspaceSymbols(e,t);if(!B(o))return{symbols:[]};const n=this._cache.add(o),i={cacheId:n,symbols:[]};for(let r=0;r<o.length;r++){const s=o[r];if(!s||!s.name){this._logService.warn("INVALID SymbolInformation",s);continue}i.symbols.push({...d.WorkspaceSymbol.from(s),cacheId:[n,r]})}return i}async resolveWorkspaceSymbol(e,t){if(typeof this._provider.resolveWorkspaceSymbol!="function"||!e.cacheId)return e;const o=this._cache.get(...e.cacheId);if(o){const n=await this._provider.resolveWorkspaceSymbol(o,t);return n&&ke(e,d.WorkspaceSymbol.from(n),!0)}}releaseWorkspaceSymbols(e){this._cache.delete(e)}}class H{constructor(e,t,o){this._documents=e;this._provider=t;this._logService=o}static supportsResolving(e){return typeof e.prepareRename=="function"}async provideRenameEdits(e,t,o,n){const i=this._documents.getDocument(e),r=d.Position.to(t);try{const s=await this._provider.provideRenameEdits(i,r,o,n);return s?d.WorkspaceEdit.from(s):void 0}catch(s){const a=H._asMessage(s);return a?{rejectReason:a,edits:void 0}:Promise.reject(s)}}async resolveRenameLocation(e,t,o){if(typeof this._provider.prepareRename!="function")return Promise.resolve(void 0);const n=this._documents.getDocument(e),i=d.Position.to(t);try{const r=await this._provider.prepareRename(n,i,o);let s,a;if(M.isRange(r)?(s=r,a=n.getText(r)):Ne(r)&&(s=r.range,a=r.placeholder),!s||!a)return;if(s.start.line>i.line||s.end.line<i.line){this._logService.warn("INVALID rename location: position line must be within range start/end lines");return}return{range:d.Range.from(s),text:a}}catch(r){const s=H._asMessage(r);return s?{rejectReason:s,range:void 0,text:void 0}:Promise.reject(r)}}static _asMessage(e){return typeof e=="string"?e:e instanceof Error&&typeof e.message=="string"?e.message:void 0}}class R{constructor(e,t,o){this._documents=e;this._provider=t;this._logService=o}static languageTriggerKindToVSCodeTriggerKind={[C.NewSymbolNameTriggerKind.Invoke]:de.Invoke,[C.NewSymbolNameTriggerKind.Automatic]:de.Automatic};async supportsAutomaticNewSymbolNamesTriggerKind(){return this._provider.supportsAutomaticTriggerKind}async provideNewSymbolNames(e,t,o,n){const i=this._documents.getDocument(e),r=d.Range.to(t);try{const s=R.languageTriggerKindToVSCodeTriggerKind[o],a=await this._provider.provideNewSymbolNames(i,r,s,n);return a?a.map(c=>typeof c=="string"?{newSymbolName:c}:{newSymbolName:c.newSymbolName,tags:c.tags}):void 0}catch(s){this._logService.error(R._asMessage(s)??JSON.stringify(s,null,"	"));return}}static _asMessage(e){return typeof e=="string"?e:e instanceof Error&&typeof e.message=="string"?e.message:void 0}}class X{constructor(e,t){this.resultId=e;this.tokens=t}}class _{constructor(e,t){this._documents=e;this._provider=t;this._previousResults=new Map}_previousResults;_nextResultId=1;async provideDocumentSemanticTokens(e,t,o){const n=this._documents.getDocument(e),i=t!==0?this._previousResults.get(t):null;let r=typeof i?.resultId=="string"&&typeof this._provider.provideDocumentSemanticTokensEdits=="function"?await this._provider.provideDocumentSemanticTokensEdits(n,i.resultId,o):await this._provider.provideDocumentSemanticTokens(n,o);return i&&this._previousResults.delete(t),r?(r=_._fixProvidedSemanticTokens(r),this._send(_._convertToEdits(i,r),r)):null}async releaseDocumentSemanticColoring(e){this._previousResults.delete(e)}static _fixProvidedSemanticTokens(e){return _._isSemanticTokens(e)?_._isCorrectSemanticTokens(e)?e:new qe(new Uint32Array(e.data),e.resultId):_._isSemanticTokensEdits(e)?_._isCorrectSemanticTokensEdits(e)?e:new G(e.edits.map(t=>new Be(t.start,t.deleteCount,t.data?new Uint32Array(t.data):t.data)),e.resultId):e}static _isSemanticTokens(e){return e&&!!e.data}static _isCorrectSemanticTokens(e){return e.data instanceof Uint32Array}static _isSemanticTokensEdits(e){return e&&Array.isArray(e.edits)}static _isCorrectSemanticTokensEdits(e){for(const t of e.edits)if(!(t.data instanceof Uint32Array))return!1;return!0}static _convertToEdits(e,t){if(!_._isSemanticTokens(t)||!e||!e.tokens)return t;const o=e.tokens,n=o.length,i=t.data,r=i.length;let s=0;const a=Math.min(n,r);for(;s<a&&o[s]===i[s];)s++;if(s===n&&s===r)return new G([],t.resultId);let c=0;const h=a-s;for(;c<h&&o[n-c-1]===i[r-c-1];)c++;return new G([{start:s,deleteCount:n-s-c,data:i.subarray(s,r-c)}],t.resultId)}_send(e,t){if(_._isSemanticTokens(e)){const o=this._nextResultId++;return this._previousResults.set(o,new X(e.resultId,e.data)),j({id:o,type:"full",data:e.data})}if(_._isSemanticTokensEdits(e)){const o=this._nextResultId++;return _._isSemanticTokens(t)?this._previousResults.set(o,new X(t.resultId,t.data)):this._previousResults.set(o,new X(e.resultId)),j({id:o,type:"delta",deltas:(e.edits||[]).map(n=>({start:n.start,deleteCount:n.deleteCount,data:n.data}))})}return null}}class ye{constructor(e,t){this._documents=e;this._provider=t}async provideDocumentRangeSemanticTokens(e,t,o){const n=this._documents.getDocument(e),i=await this._provider.provideDocumentRangeSemanticTokens(n,d.Range.to(t),o);return i?this._send(i):null}_send(e){return j({id:0,type:"full",data:e.data})}}class T{constructor(e,t,o,n,i){this._documents=e;this._commands=t;this._provider=o;this._apiDeprecation=n;this._extension=i}static supportsResolving(e){return typeof e.resolveCompletionItem=="function"}_cache=new S("CompletionItem");_disposables=new Map;async provideCompletionItems(e,t,o,n){const i=this._documents.getDocument(e),r=d.Position.to(t),s=i.getWordRangeAtPosition(r)||new M(r,r),a=s.with({end:r}),c=new Le,h=await this._provider.provideCompletionItems(i,r,n,d.CompletionContext.to(o));if(!h||n.isCancellationRequested)return;const v=Array.isArray(h)?new Oe(h):h,l=T.supportsResolving(this._provider)?this._cache.add(v.items):this._cache.add([]),D=new I;this._disposables.set(l,D);const m=[],E={x:l,[u.ISuggestResultDtoField.completions]:m,[u.ISuggestResultDtoField.defaultRanges]:{replace:d.Range.from(s),insert:d.Range.from(a)},[u.ISuggestResultDtoField.isIncomplete]:v.isIncomplete||void 0,[u.ISuggestResultDtoField.duration]:c.elapsed()};for(let y=0;y<v.items.length;y++){const P=v.items[y],be=this._convertCompletionItem(P,[l,y],a,s);m.push(be)}return E}async resolveCompletionItem(e,t){if(typeof this._provider.resolveCompletionItem!="function")return;const o=this._cache.get(...e);if(!o)return;const n=this._convertCompletionItem(o,e),i=await this._provider.resolveCompletionItem(o,t);if(!i)return;const r=this._convertCompletionItem(i,e);return(n[u.ISuggestDataDtoField.insertText]!==r[u.ISuggestDataDtoField.insertText]||n[u.ISuggestDataDtoField.insertTextRules]!==r[u.ISuggestDataDtoField.insertTextRules])&&this._apiDeprecation.report("CompletionItem.insertText",this._extension,"extension MAY NOT change 'insertText' of a CompletionItem during resolve"),(n[u.ISuggestDataDtoField.commandIdent]!==r[u.ISuggestDataDtoField.commandIdent]||n[u.ISuggestDataDtoField.commandId]!==r[u.ISuggestDataDtoField.commandId]||!Re(n[u.ISuggestDataDtoField.commandArguments],r[u.ISuggestDataDtoField.commandArguments]))&&this._apiDeprecation.report("CompletionItem.command",this._extension,"extension MAY NOT change 'command' of a CompletionItem during resolve"),{...n,[u.ISuggestDataDtoField.documentation]:r[u.ISuggestDataDtoField.documentation],[u.ISuggestDataDtoField.detail]:r[u.ISuggestDataDtoField.detail],[u.ISuggestDataDtoField.additionalTextEdits]:r[u.ISuggestDataDtoField.additionalTextEdits],[u.ISuggestDataDtoField.insertText]:r[u.ISuggestDataDtoField.insertText],[u.ISuggestDataDtoField.insertTextRules]:r[u.ISuggestDataDtoField.insertTextRules],[u.ISuggestDataDtoField.commandIdent]:r[u.ISuggestDataDtoField.commandIdent],[u.ISuggestDataDtoField.commandId]:r[u.ISuggestDataDtoField.commandId],[u.ISuggestDataDtoField.commandArguments]:r[u.ISuggestDataDtoField.commandArguments]}}releaseCompletionItems(e){this._disposables.get(e)?.dispose(),this._disposables.delete(e),this._cache.delete(e)}_convertCompletionItem(e,t,o,n){const i=this._disposables.get(t[0]);if(!i)throw Error("DisposableStore is missing...");const r=this._commands.toInternal(e.command,i),s={x:t,[u.ISuggestDataDtoField.label]:e.label,[u.ISuggestDataDtoField.kind]:e.kind!==void 0?d.CompletionItemKind.from(e.kind):void 0,[u.ISuggestDataDtoField.kindModifier]:e.tags&&e.tags.map(d.CompletionItemTag.from),[u.ISuggestDataDtoField.detail]:e.detail,[u.ISuggestDataDtoField.documentation]:typeof e.documentation>"u"?void 0:d.MarkdownString.fromStrict(e.documentation),[u.ISuggestDataDtoField.sortText]:e.sortText!==e.label?e.sortText:void 0,[u.ISuggestDataDtoField.filterText]:e.filterText!==e.label?e.filterText:void 0,[u.ISuggestDataDtoField.preselect]:e.preselect||void 0,[u.ISuggestDataDtoField.insertTextRules]:e.keepWhitespace?C.CompletionItemInsertTextRule.KeepWhitespace:C.CompletionItemInsertTextRule.None,[u.ISuggestDataDtoField.commitCharacters]:e.commitCharacters?.join(""),[u.ISuggestDataDtoField.additionalTextEdits]:e.additionalTextEdits&&e.additionalTextEdits.map(d.TextEdit.from),[u.ISuggestDataDtoField.commandIdent]:r?.$ident,[u.ISuggestDataDtoField.commandId]:r?.id,[u.ISuggestDataDtoField.commandArguments]:r?.$ident?void 0:r?.arguments};e.textEdit?(this._apiDeprecation.report("CompletionItem.textEdit",this._extension,"Use 'CompletionItem.insertText' and 'CompletionItem.range' instead."),s[u.ISuggestDataDtoField.insertText]=e.textEdit.newText):typeof e.insertText=="string"?s[u.ISuggestDataDtoField.insertText]=e.insertText:e.insertText instanceof je&&(s[u.ISuggestDataDtoField.insertText]=e.insertText.value,s[u.ISuggestDataDtoField.insertTextRules]|=C.CompletionItemInsertTextRule.InsertAsSnippet);let a;return e.textEdit?a=e.textEdit.range:e.range&&(a=e.range),M.isRange(a)?s[u.ISuggestDataDtoField.range]=d.Range.from(a):a&&(!o?.isEqual(a.inserting)||!n?.isEqual(a.replacing))&&(s[u.ISuggestDataDtoField.range]={insert:d.Range.from(a.inserting),replace:d.Range.from(a.replacing)}),s}}class w{async provideInlineCompletions(e,t,o,n){}async provideInlineEditsForRange(e,t,o,n){}disposeCompletions(e){}handleDidShowCompletionItem(e,t,o){}handlePartialAccept(e,t,o,n){}}class Xe extends w{constructor(t,o,n,i){super();this._extension=t;this._documents=o;this._provider=n;this._commands=i}_references=new Pe;_isAdditionsProposedApiEnabled=k(this._extension,"inlineCompletionsAdditions");get supportsHandleEvents(){return k(this._extension,"inlineCompletionsAdditions")&&(typeof this._provider.handleDidShowCompletionItem=="function"||typeof this._provider.handleDidPartiallyAcceptCompletionItem=="function")}languageTriggerKindToVSCodeTriggerKind={[C.InlineCompletionTriggerKind.Automatic]:se.Automatic,[C.InlineCompletionTriggerKind.Explicit]:se.Invoke};async provideInlineCompletions(t,o,n,i){const r=this._documents.getDocument(t),s=d.Position.to(o),a=await this._provider.provideInlineCompletionItems(r,s,{selectedCompletionInfo:n.selectedSuggestionInfo?{range:d.Range.to(n.selectedSuggestionInfo.range),text:n.selectedSuggestionInfo.text}:void 0,triggerKind:this.languageTriggerKindToVSCodeTriggerKind[n.triggerKind]},i);if(!a||i.isCancellationRequested)return;const c=Array.isArray(a)?a:a.items,h=this._isAdditionsProposedApiEnabled?Array.isArray(a)?[]:a.commands||[]:[],v=this._isAdditionsProposedApiEnabled&&!Array.isArray(a)?a.enableForwardStability:void 0;let l;return{pid:this._references.createReferenceId({dispose(){l?.dispose()},items:c}),items:c.map((m,E)=>{let y;m.command&&(l||(l=new I),y=this._commands.toInternal(m.command,l));const P=m.insertText;return{insertText:typeof P=="string"?P:{snippet:P.value},filterText:m.filterText,range:m.range?d.Range.from(m.range):void 0,command:y,idx:E,completeBracketPairs:this._isAdditionsProposedApiEnabled?m.completeBracketPairs:!1}}),commands:h.map(m=>(l||(l=new I),this._commands.toInternal(m,l))),suppressSuggestions:!1,enableForwardStability:v}}async provideInlineEditsForRange(t,o,n,i){if(!this._provider.provideInlineEditsForRange)return;Je(this._extension,"inlineCompletionsAdditions");const r=this._documents.getDocument(t),s=d.Range.to(o),a=await this._provider.provideInlineEditsForRange(r,s,{selectedCompletionInfo:n.selectedSuggestionInfo?{range:d.Range.to(n.selectedSuggestionInfo.range),text:n.selectedSuggestionInfo.text}:void 0,triggerKind:this.languageTriggerKindToVSCodeTriggerKind[n.triggerKind],userPrompt:n.userPrompt},i);if(!a||i.isCancellationRequested)return;const c=Array.isArray(a)?a:a.items,h=this._isAdditionsProposedApiEnabled?Array.isArray(a)?[]:a.commands||[]:[],v=this._isAdditionsProposedApiEnabled&&!Array.isArray(a)?a.enableForwardStability:void 0;let l;return{pid:this._references.createReferenceId({dispose(){l?.dispose()},items:c}),items:c.map((m,E)=>{let y;m.command&&(l||(l=new I),y=this._commands.toInternal(m.command,l));const P=m.insertText;return{insertText:typeof P=="string"?P:{snippet:P.value},filterText:m.filterText,range:m.range?d.Range.from(m.range):void 0,command:y,idx:E,completeBracketPairs:this._isAdditionsProposedApiEnabled?m.completeBracketPairs:!1}}),commands:h.map(m=>(l||(l=new I),this._commands.toInternal(m,l))),suppressSuggestions:!1,enableForwardStability:v}}disposeCompletions(t){this._references.disposeReferenceId(t)?.dispose()}handleDidShowCompletionItem(t,o,n){const i=this._references.get(t)?.items[o];i&&this._provider.handleDidShowCompletionItem&&this._isAdditionsProposedApiEnabled&&this._provider.handleDidShowCompletionItem(i,n)}handlePartialAccept(t,o,n,i){const r=this._references.get(t)?.items[o];r&&this._provider.handleDidPartiallyAcceptCompletionItem&&this._isAdditionsProposedApiEnabled&&(this._provider.handleDidPartiallyAcceptCompletionItem(r,n),this._provider.handleDidPartiallyAcceptCompletionItem(r,d.PartialAcceptInfo.to(i)))}}class Y{constructor(e,t,o,n){this._documents=t;this._provider=o;this._commands=n}_references=new Pe;languageTriggerKindToVSCodeTriggerKind={[C.InlineEditTriggerKind.Automatic]:ae.Automatic,[C.InlineEditTriggerKind.Invoke]:ae.Invoke};async provideInlineEdits(e,t,o){const n=this._documents.getDocument(e),i=await this._provider.provideInlineEdit(n,{triggerKind:this.languageTriggerKindToVSCodeTriggerKind[t.triggerKind]},o);if(!i||o.isCancellationRequested)return;let r;const s=this._references.createReferenceId({dispose(){r?.dispose()},item:i});let a;i.accepted&&(r||(r=new I),a=this._commands.toInternal(i.accepted,r));let c;return i.rejected&&(r||(r=new I),c=this._commands.toInternal(i.rejected,r)),{pid:s,text:i.text,range:d.Range.from(i.range),accepted:a,rejected:c}}disposeEdit(e){this._references.disposeReferenceId(e)?.dispose()}}class Pe{_references=new Map;_idPool=1;createReferenceId(e){const t=this._idPool++;return this._references.set(t,e),t}disposeReferenceId(e){const t=this._references.get(e);return this._references.delete(e),t}get(e){return this._references.get(e)}}class Z{constructor(e,t){this._documents=e;this._provider=t}_cache=new S("SignatureHelp");async provideSignatureHelp(e,t,o,n){const i=this._documents.getDocument(e),r=d.Position.to(t),s=this.reviveContext(o),a=await this._provider.provideSignatureHelp(i,r,n,s);if(a){const c=this._cache.add([a]);return{...d.SignatureHelp.from(a),id:c}}}reviveContext(e){let t;if(e.activeSignatureHelp){const o=d.SignatureHelp.to(e.activeSignatureHelp),n=this._cache.get(e.activeSignatureHelp.id,0);n?(t=n,t.activeSignature=o.activeSignature,t.activeParameter=o.activeParameter):t=o}return{...e,activeSignatureHelp:t}}releaseSignatureHelp(e){this._cache.delete(e)}}class V{constructor(e,t,o,n,i){this._documents=e;this._commands=t;this._provider=o;this._logService=n;this._extension=i}_cache=new S("InlayHints");_disposables=new Map;async provideInlayHints(e,t,o){const n=this._documents.getDocument(e),i=d.Range.to(t),r=await this._provider.provideInlayHints(n,i,o);if(!Array.isArray(r)||r.length===0){this._logService.trace(`[InlayHints] NO inlay hints from '${this._extension.identifier.value}' for range ${JSON.stringify(t)}`);return}if(o.isCancellationRequested)return;const s=this._cache.add(r);this._disposables.set(s,new I);const a={hints:[],cacheId:s};for(let c=0;c<r.length;c++)this._isValidInlayHint(r[c],i)&&a.hints.push(this._convertInlayHint(r[c],[s,c]));return this._logService.trace(`[InlayHints] ${a.hints.length} inlay hints from '${this._extension.identifier.value}' for range ${JSON.stringify(t)}`),a}async resolveInlayHint(e,t){if(typeof this._provider.resolveInlayHint!="function")return;const o=this._cache.get(...e);if(!o)return;const n=await this._provider.resolveInlayHint(o,t);if(n&&this._isValidInlayHint(n))return this._convertInlayHint(n,e)}releaseHints(e){this._disposables.get(e)?.dispose(),this._disposables.delete(e),this._cache.delete(e)}_isValidInlayHint(e,t){return!(e.label.length===0||Array.isArray(e.label)&&e.label.every(o=>o.value.length===0)||t&&!t.contains(e.position))}_convertInlayHint(e,t){const o=this._disposables.get(t[0]);if(!o)throw Error("DisposableStore is missing...");const n={label:"",cacheId:t,tooltip:d.MarkdownString.fromStrict(e.tooltip),position:d.Position.from(e.position),textEdits:e.textEdits&&e.textEdits.map(d.TextEdit.from),kind:e.kind&&d.InlayHintKind.from(e.kind),paddingLeft:e.paddingLeft,paddingRight:e.paddingRight};if(typeof e.label=="string")n.label=e.label;else{const i=[];n.label=i;for(const r of e.label){if(!r.value)continue;const s={label:r.value,tooltip:d.MarkdownString.fromStrict(r.tooltip)};ze.isLocation(r.location)&&(s.location=d.location.from(r.location)),r.command&&(s.command=this._commands.toInternal(r.command,o)),i.push(s)}}return n}}class b{constructor(e,t){this._documents=e;this._provider=t}_cache=new S("DocumentLink");async provideLinks(e,t){const o=this._documents.getDocument(e),n=await this._provider.provideDocumentLinks(o,t);if(!(!Array.isArray(n)||n.length===0)&&!t.isCancellationRequested){if(typeof this._provider.resolveDocumentLink!="function")return{links:n.filter(b._validateLink).map(d.DocumentLink.from)};{const i=this._cache.add(n),r={links:[],cacheId:i};for(let s=0;s<n.length;s++){if(!b._validateLink(n[s]))continue;const a=d.DocumentLink.from(n[s]);a.cacheId=[i,s],r.links.push(a)}return r}}}static _validateLink(e){return!(e.target&&e.target.path.length>5e4)}async resolveLink(e,t){if(typeof this._provider.resolveDocumentLink!="function")return;const o=this._cache.get(...e);if(!o)return;const n=await this._provider.resolveDocumentLink(o,t);if(!(!n||!b._validateLink(n)))return d.DocumentLink.from(n)}releaseLinks(e){this._cache.delete(e)}}class Q{constructor(e,t){this._documents=e;this._provider=t}async provideColors(e,t){const o=this._documents.getDocument(e),n=await this._provider.provideDocumentColors(o,t);return Array.isArray(n)?n.map(r=>({color:d.Color.from(r.color),range:d.Range.from(r.range)})):[]}async provideColorPresentations(e,t,o){const n=this._documents.getDocument(e),i=d.Range.to(t.range),r=d.Color.to(t.color),s=await this._provider.provideColorPresentations(r,{document:n,range:i},o);if(Array.isArray(s))return s.map(d.ColorPresentation.from)}}class Ce{constructor(e,t){this._documents=e;this._provider=t}async provideFoldingRanges(e,t,o){const n=this._documents.getDocument(e),i=await this._provider.provideFoldingRanges(n,t,o);if(Array.isArray(i))return i.map(d.FoldingRange.from)}}class Se{constructor(e,t,o){this._documents=e;this._provider=t;this._logService=o}async provideSelectionRanges(e,t,o){const n=this._documents.getDocument(e),i=t.map(d.Position.to),r=await this._provider.provideSelectionRanges(n,i,o);if(!B(r))return[];if(r.length!==i.length)return this._logService.warn("BAD selection ranges, provider must return ranges for each position"),[];const s=[];for(let a=0;a<i.length;a++){const c=[];s.push(c);let h=i[a],v=r[a];for(;;){if(!v.range.contains(h))throw new Error("INVALID selection range, must contain the previous range");if(c.push(d.SelectionRange.from(v)),!v.parent)break;h=v.range,v=v.parent}}return s}}class ${constructor(e,t){this._documents=e;this._provider=t}_idPool=new oe("");_cache=new Map;async prepareSession(e,t,o){const n=this._documents.getDocument(e),i=d.Position.to(t),r=await this._provider.prepareCallHierarchy(n,i,o);if(!r)return;const s=this._idPool.nextId();return this._cache.set(s,new Map),Array.isArray(r)?r.map(a=>this._cacheAndConvertItem(s,a)):[this._cacheAndConvertItem(s,r)]}async provideCallsTo(e,t,o){const n=this._itemFromCache(e,t);if(!n)throw new Error("missing call hierarchy item");const i=await this._provider.provideCallHierarchyIncomingCalls(n,o);if(i)return i.map(r=>({from:this._cacheAndConvertItem(e,r.from),fromRanges:r.fromRanges.map(s=>d.Range.from(s))}))}async provideCallsFrom(e,t,o){const n=this._itemFromCache(e,t);if(!n)throw new Error("missing call hierarchy item");const i=await this._provider.provideCallHierarchyOutgoingCalls(n,o);if(i)return i.map(r=>({to:this._cacheAndConvertItem(e,r.to),fromRanges:r.fromRanges.map(s=>d.Range.from(s))}))}releaseSession(e){this._cache.delete(e)}_cacheAndConvertItem(e,t){const o=this._cache.get(e),n=d.CallHierarchyItem.from(t,e,o.size.toString(36));return o.set(n._itemId,t),n}_itemFromCache(e,t){return this._cache.get(e)?.get(t)}}class F{constructor(e,t){this._documents=e;this._provider=t}_idPool=new oe("");_cache=new Map;async prepareSession(e,t,o){const n=this._documents.getDocument(e),i=d.Position.to(t),r=await this._provider.prepareTypeHierarchy(n,i,o);if(!r)return;const s=this._idPool.nextId();return this._cache.set(s,new Map),Array.isArray(r)?r.map(a=>this._cacheAndConvertItem(s,a)):[this._cacheAndConvertItem(s,r)]}async provideSupertypes(e,t,o){const n=this._itemFromCache(e,t);if(!n)throw new Error("missing type hierarchy item");const i=await this._provider.provideTypeHierarchySupertypes(n,o);if(i)return i.map(r=>this._cacheAndConvertItem(e,r))}async provideSubtypes(e,t,o){const n=this._itemFromCache(e,t);if(!n)throw new Error("missing type hierarchy item");const i=await this._provider.provideTypeHierarchySubtypes(n,o);if(i)return i.map(r=>this._cacheAndConvertItem(e,r))}releaseSession(e){this._cache.delete(e)}_cacheAndConvertItem(e,t){const o=this._cache.get(e),n=d.TypeHierarchyItem.from(t,e,o.size.toString(36));return o.set(n._itemId,t),n}_itemFromCache(e,t){return this._cache.get(e)?.get(t)}}class z{constructor(e,t,o,n,i){this._proxy=e;this._documents=t;this._provider=o;this._handle=n;this._extension=i}_cache=new S("DocumentDropEdit");async provideDocumentOnDropEdits(e,t,o,n,i){const r=this._documents.getDocument(t),s=d.Position.to(o),a=d.DataTransfer.toDataTransfer(n,async l=>(await this._proxy.$resolveDocumentOnDropFileData(this._handle,e,l)).buffer),c=await this._provider.provideDocumentDropEdits(r,s,a,i);if(!c)return;const h=Ee(c),v=this._cache.add(h);return h.map((l,D)=>({_cacheId:[v,D],title:l.title??ie("defaultDropLabel","Drop using '{0}' extension",this._extension.displayName||this._extension.name),kind:l.kind?.value,yieldTo:l.yieldTo?.map(m=>m.value),insertText:typeof l.insertText=="string"?l.insertText:{snippet:l.insertText.value},additionalEdit:l.additionalEdit?d.WorkspaceEdit.from(l.additionalEdit,void 0):void 0}))}async resolveDropEdit(e,t){const[o,n]=e,i=this._cache.get(o,n);if(!i||!this._provider.resolveDocumentDropEdit)return{};const r=await this._provider.resolveDocumentDropEdit(i,t)??i;return{additionalEdit:r.additionalEdit?d.WorkspaceEdit.from(r.additionalEdit,void 0):void 0}}releaseDropEdits(e){this._cache.delete(e)}}class xe{constructor(e,t){this._documents=e;this._provider=t}async provideMappedEdits(e,t,o,n){const i=p.revive(e),r=this._documents.getDocument(i),s=v=>({uri:p.revive(v.uri),version:v.version,ranges:v.ranges.map(l=>d.Range.to(l))}),a=o.documents.map(v=>v.map(s)),c={documents:a,selections:a[0]?.[0]?.ranges??[],conversation:o.conversation?.map(v=>v.type==="response"?{type:"response",message:v.message,references:v.references?.map(s)}:{type:"request",message:v.message})},h=await this._provider.provideMappedEdits(r,t,c,n);return h?d.WorkspaceEdit.from(h):null}}class N{constructor(e,t){this.adapter=e;this.extension=t}}class f{constructor(e,t,o,n,i,r,s,a){this._uriTransformer=t;this._documents=o;this._commands=n;this._diagnostics=i;this._logService=r;this._apiDeprecation=s;this._extensionTelemetry=a;this._proxy=e.getProxy(u.MainContext.MainThreadLanguageFeatures)}static _handlePool=0;_proxy;_adapter=new Map;_transformDocumentSelector(e,t){return d.DocumentSelector.from(e,this._uriTransformer,t)}_createDisposable(e){return new A(()=>{this._adapter.delete(e),this._proxy.$unregister(e)})}_nextHandle(){return f._handlePool++}async _withAdapter(e,t,o,n,i,r=!1){const s=this._adapter.get(e);if(!s||!(s.adapter instanceof t))return n;const a=Date.now();r||this._logService.trace(`[${s.extension.identifier.value}] INVOKE provider '${o.toString().replace(/[\r\n]/g,"")}'`);const c=o(s.adapter,s.extension);return Promise.resolve(c).catch(h=>{we(h)||(this._logService.error(`[${s.extension.identifier.value}] provider FAILED`),this._logService.error(h),this._extensionTelemetry.onExtensionError(s.extension.identifier,h))}).finally(()=>{r||this._logService.trace(`[${s.extension.identifier.value}] provider DONE after ${Date.now()-a}ms`)}),He.isCancellationToken(i)?Te(c,i):c}_addNewAdapter(e,t){const o=this._nextHandle();return this._adapter.set(o,new N(e,t)),o}static _extLabel(e){return e.displayName||e.name}static _extId(e){return e.identifier.value}registerDocumentSymbolProvider(e,t,o,n){const i=this._addNewAdapter(new q(this._documents,o),e),r=n&&n.label||f._extLabel(e);return this._proxy.$registerDocumentSymbolProvider(i,this._transformDocumentSelector(t,e),r),this._createDisposable(i)}$provideDocumentSymbols(e,t,o){return this._withAdapter(e,q,n=>n.provideDocumentSymbols(p.revive(t),o),void 0,o)}registerCodeLensProvider(e,t,o){const n=this._nextHandle(),i=typeof o.onDidChangeCodeLenses=="function"?this._nextHandle():void 0;this._adapter.set(n,new N(new O(this._documents,this._commands.converter,o,e,this._extensionTelemetry,this._logService),e)),this._proxy.$registerCodeLensSupport(n,this._transformDocumentSelector(t,e),i);let r=this._createDisposable(n);if(i!==void 0){const s=o.onDidChangeCodeLenses(a=>this._proxy.$emitCodeLensEvent(i));r=A.from(r,s)}return r}$provideCodeLenses(e,t,o){return this._withAdapter(e,O,n=>n.provideCodeLenses(p.revive(t),o),void 0,o,t.scheme==="output")}$resolveCodeLens(e,t,o){return this._withAdapter(e,O,n=>n.resolveCodeLens(t,o),void 0,void 0,!0)}$releaseCodeLenses(e,t){this._withAdapter(e,O,o=>Promise.resolve(o.releaseCodeLenses(t)),void 0,void 0,!0)}registerDefinitionProvider(e,t,o){const n=this._addNewAdapter(new ce(this._documents,o),e);return this._proxy.$registerDefinitionSupport(n,this._transformDocumentSelector(t,e)),this._createDisposable(n)}$provideDefinition(e,t,o,n){return this._withAdapter(e,ce,i=>i.provideDefinition(p.revive(t),o,n),[],n)}registerDeclarationProvider(e,t,o){const n=this._addNewAdapter(new le(this._documents,o),e);return this._proxy.$registerDeclarationSupport(n,this._transformDocumentSelector(t,e)),this._createDisposable(n)}$provideDeclaration(e,t,o,n){return this._withAdapter(e,le,i=>i.provideDeclaration(p.revive(t),o,n),[],n)}registerImplementationProvider(e,t,o){const n=this._addNewAdapter(new ue(this._documents,o),e);return this._proxy.$registerImplementationSupport(n,this._transformDocumentSelector(t,e)),this._createDisposable(n)}$provideImplementation(e,t,o,n){return this._withAdapter(e,ue,i=>i.provideImplementation(p.revive(t),o,n),[],n)}registerTypeDefinitionProvider(e,t,o){const n=this._addNewAdapter(new me(this._documents,o),e);return this._proxy.$registerTypeDefinitionSupport(n,this._transformDocumentSelector(t,e)),this._createDisposable(n)}$provideTypeDefinition(e,t,o,n){return this._withAdapter(e,me,i=>i.provideTypeDefinition(p.revive(t),o,n),[],n)}registerHoverProvider(e,t,o,n){const i=this._addNewAdapter(new U(this._documents,o),e);return this._proxy.$registerHoverProvider(i,this._transformDocumentSelector(t,e)),this._createDisposable(i)}$provideHover(e,t,o,n,i){return this._withAdapter(e,U,r=>r.provideHover(p.revive(t),o,n,i),void 0,i)}$releaseHover(e,t){this._withAdapter(e,U,o=>Promise.resolve(o.releaseHover(t)),void 0,void 0)}registerEvaluatableExpressionProvider(e,t,o,n){const i=this._addNewAdapter(new pe(this._documents,o),e);return this._proxy.$registerEvaluatableExpressionProvider(i,this._transformDocumentSelector(t,e)),this._createDisposable(i)}$provideEvaluatableExpression(e,t,o,n){return this._withAdapter(e,pe,i=>i.provideEvaluatableExpression(p.revive(t),o,n),void 0,n)}registerInlineValuesProvider(e,t,o,n){const i=typeof o.onDidChangeInlineValues=="function"?this._nextHandle():void 0,r=this._addNewAdapter(new ve(this._documents,o),e);this._proxy.$registerInlineValuesProvider(r,this._transformDocumentSelector(t,e),i);let s=this._createDisposable(r);if(i!==void 0){const a=o.onDidChangeInlineValues(c=>this._proxy.$emitInlineValuesEvent(i));s=A.from(s,a)}return s}$provideInlineValues(e,t,o,n,i){return this._withAdapter(e,ve,r=>r.provideInlineValues(p.revive(t),o,n,i),void 0,i)}registerDocumentHighlightProvider(e,t,o){const n=this._addNewAdapter(new ge(this._documents,o),e);return this._proxy.$registerDocumentHighlightProvider(n,this._transformDocumentSelector(t,e)),this._createDisposable(n)}registerMultiDocumentHighlightProvider(e,t,o){const n=this._addNewAdapter(new he(this._documents,o),e);return this._proxy.$registerMultiDocumentHighlightProvider(n,this._transformDocumentSelector(t,e)),this._createDisposable(n)}$provideDocumentHighlights(e,t,o,n){return this._withAdapter(e,ge,i=>i.provideDocumentHighlights(p.revive(t),o,n),void 0,n)}$provideMultiDocumentHighlights(e,t,o,n,i){return this._withAdapter(e,he,r=>r.provideMultiDocumentHighlights(p.revive(t),o,n.map(s=>p.revive(s)),i),void 0,i)}registerLinkedEditingRangeProvider(e,t,o){const n=this._addNewAdapter(new fe(this._documents,o),e);return this._proxy.$registerLinkedEditingRangeProvider(n,this._transformDocumentSelector(t,e)),this._createDisposable(n)}$provideLinkedEditingRanges(e,t,o,n){return this._withAdapter(e,fe,async i=>{const r=await i.provideLinkedEditingRanges(p.revive(t),o,n);if(r)return{ranges:r.ranges,wordPattern:r.wordPattern?f._serializeRegExp(r.wordPattern):void 0}},void 0,n)}registerReferenceProvider(e,t,o){const n=this._addNewAdapter(new De(this._documents,o),e);return this._proxy.$registerReferenceSupport(n,this._transformDocumentSelector(t,e)),this._createDisposable(n)}$provideReferences(e,t,o,n,i){return this._withAdapter(e,De,r=>r.provideReferences(p.revive(t),o,n,i),void 0,i)}registerCodeActionProvider(e,t,o,n){const i=new I,r=this._addNewAdapter(new x(this._documents,this._commands.converter,this._diagnostics,o,this._logService,e,this._apiDeprecation),e);return this._proxy.$registerCodeActionSupport(r,this._transformDocumentSelector(t,e),{providedKinds:n?.providedCodeActionKinds?.map(s=>s.value),documentation:n?.documentation?.map(s=>({kind:s.kind.value,command:this._commands.converter.toInternal(s.command,i)}))},f._extLabel(e),f._extId(e),!!o.resolveCodeAction),i.add(this._createDisposable(r)),i}$provideCodeActions(e,t,o,n,i){return this._withAdapter(e,x,r=>r.provideCodeActions(p.revive(t),o,n,i),void 0,i)}$resolveCodeAction(e,t,o){return this._withAdapter(e,x,n=>n.resolveCodeAction(t,o),{},void 0)}$releaseCodeActions(e,t){this._withAdapter(e,x,o=>Promise.resolve(o.releaseCodeActions(t)),void 0,void 0)}registerDocumentFormattingEditProvider(e,t,o){const n=this._addNewAdapter(new _e(this._documents,o),e);return this._proxy.$registerDocumentFormattingSupport(n,this._transformDocumentSelector(t,e),e.identifier,e.displayName||e.name),this._createDisposable(n)}$provideDocumentFormattingEdits(e,t,o,n){return this._withAdapter(e,_e,i=>i.provideDocumentFormattingEdits(p.revive(t),o,n),void 0,n)}registerDocumentRangeFormattingEditProvider(e,t,o){const n=typeof o.provideDocumentRangesFormattingEdits=="function",i=this._addNewAdapter(new J(this._documents,o),e);return this._proxy.$registerRangeFormattingSupport(i,this._transformDocumentSelector(t,e),e.identifier,e.displayName||e.name,n),this._createDisposable(i)}$provideDocumentRangeFormattingEdits(e,t,o,n,i){return this._withAdapter(e,J,r=>r.provideDocumentRangeFormattingEdits(p.revive(t),o,n,i),void 0,i)}$provideDocumentRangesFormattingEdits(e,t,o,n,i){return this._withAdapter(e,J,r=>r.provideDocumentRangesFormattingEdits(p.revive(t),o,n,i),void 0,i)}registerOnTypeFormattingEditProvider(e,t,o,n){const i=this._addNewAdapter(new Ie(this._documents,o),e);return this._proxy.$registerOnTypeFormattingSupport(i,this._transformDocumentSelector(t,e),n,e.identifier),this._createDisposable(i)}$provideOnTypeFormattingEdits(e,t,o,n,i,r){return this._withAdapter(e,Ie,s=>s.provideOnTypeFormattingEdits(p.revive(t),o,n,i,r),void 0,r)}registerWorkspaceSymbolProvider(e,t){const o=this._addNewAdapter(new K(t,this._logService),e);return this._proxy.$registerNavigateTypeSupport(o,typeof t.resolveWorkspaceSymbol=="function"),this._createDisposable(o)}$provideWorkspaceSymbols(e,t,o){return this._withAdapter(e,K,n=>n.provideWorkspaceSymbols(t,o),{symbols:[]},o)}$resolveWorkspaceSymbol(e,t,o){return this._withAdapter(e,K,n=>n.resolveWorkspaceSymbol(t,o),void 0,void 0)}$releaseWorkspaceSymbols(e,t){this._withAdapter(e,K,o=>o.releaseWorkspaceSymbols(t),void 0,void 0)}registerRenameProvider(e,t,o){const n=this._addNewAdapter(new H(this._documents,o,this._logService),e);return this._proxy.$registerRenameSupport(n,this._transformDocumentSelector(t,e),H.supportsResolving(o)),this._createDisposable(n)}$provideRenameEdits(e,t,o,n,i){return this._withAdapter(e,H,r=>r.provideRenameEdits(p.revive(t),o,n,i),void 0,i)}$resolveRenameLocation(e,t,o,n){return this._withAdapter(e,H,i=>i.resolveRenameLocation(p.revive(t),o,n),void 0,n)}registerNewSymbolNamesProvider(e,t,o){const n=this._addNewAdapter(new R(this._documents,o,this._logService),e);return this._proxy.$registerNewSymbolNamesProvider(n,this._transformDocumentSelector(t,e)),this._createDisposable(n)}$supportsAutomaticNewSymbolNamesTriggerKind(e){return this._withAdapter(e,R,t=>t.supportsAutomaticNewSymbolNamesTriggerKind(),!1,void 0)}$provideNewSymbolNames(e,t,o,n,i){return this._withAdapter(e,R,r=>r.provideNewSymbolNames(p.revive(t),o,n,i),void 0,i)}registerDocumentSemanticTokensProvider(e,t,o,n){const i=this._addNewAdapter(new _(this._documents,o),e),r=typeof o.onDidChangeSemanticTokens=="function"?this._nextHandle():void 0;this._proxy.$registerDocumentSemanticTokensProvider(i,this._transformDocumentSelector(t,e),n,r);let s=this._createDisposable(i);if(r){const a=o.onDidChangeSemanticTokens(c=>this._proxy.$emitDocumentSemanticTokensEvent(r));s=A.from(s,a)}return s}$provideDocumentSemanticTokens(e,t,o,n){return this._withAdapter(e,_,i=>i.provideDocumentSemanticTokens(p.revive(t),o,n),null,n)}$releaseDocumentSemanticTokens(e,t){this._withAdapter(e,_,o=>o.releaseDocumentSemanticColoring(t),void 0,void 0)}registerDocumentRangeSemanticTokensProvider(e,t,o,n){const i=this._addNewAdapter(new ye(this._documents,o),e);return this._proxy.$registerDocumentRangeSemanticTokensProvider(i,this._transformDocumentSelector(t,e),n),this._createDisposable(i)}$provideDocumentRangeSemanticTokens(e,t,o,n){return this._withAdapter(e,ye,i=>i.provideDocumentRangeSemanticTokens(p.revive(t),o,n),null,n)}registerCompletionItemProvider(e,t,o,n){const i=this._addNewAdapter(new T(this._documents,this._commands.converter,o,this._apiDeprecation,e),e);return this._proxy.$registerCompletionsProvider(i,this._transformDocumentSelector(t,e),n,T.supportsResolving(o),e.identifier),this._createDisposable(i)}$provideCompletionItems(e,t,o,n,i){return this._withAdapter(e,T,r=>r.provideCompletionItems(p.revive(t),o,n,i),void 0,i)}$resolveCompletionItem(e,t,o){return this._withAdapter(e,T,n=>n.resolveCompletionItem(t,o),void 0,o)}$releaseCompletionItems(e,t){this._withAdapter(e,T,o=>o.releaseCompletionItems(t),void 0,void 0)}registerInlineCompletionsProvider(e,t,o,n){const i=new Xe(e,this._documents,o,this._commands.converter),r=this._addNewAdapter(i,e);return this._proxy.$registerInlineCompletionsSupport(r,this._transformDocumentSelector(t,e),i.supportsHandleEvents,re.toKey(e.identifier.value),n?.yieldTo?.map(s=>re.toKey(s))||[]),this._createDisposable(r)}$provideInlineCompletions(e,t,o,n,i){return this._withAdapter(e,w,r=>r.provideInlineCompletions(p.revive(t),o,n,i),void 0,i)}$provideInlineEditsForRange(e,t,o,n,i){return this._withAdapter(e,w,r=>r.provideInlineEditsForRange(p.revive(t),o,n,i),void 0,i)}$handleInlineCompletionDidShow(e,t,o,n){this._withAdapter(e,w,async i=>{i.handleDidShowCompletionItem(t,o,n)},void 0,void 0)}$handleInlineCompletionPartialAccept(e,t,o,n,i){this._withAdapter(e,w,async r=>{r.handlePartialAccept(t,o,n,i)},void 0,void 0)}$freeInlineCompletionsList(e,t){this._withAdapter(e,w,async o=>{o.disposeCompletions(t)},void 0,void 0)}registerInlineEditProvider(e,t,o){const n=new Y(e,this._documents,o,this._commands.converter),i=this._addNewAdapter(n,e);return this._proxy.$registerInlineEditProvider(i,this._transformDocumentSelector(t,e),e.identifier),this._createDisposable(i)}$provideInlineEdit(e,t,o,n){return this._withAdapter(e,Y,i=>i.provideInlineEdits(p.revive(t),o,n),void 0,n)}$freeInlineEdit(e,t){this._withAdapter(e,Y,async o=>{o.disposeEdit(t)},void 0,void 0)}registerSignatureHelpProvider(e,t,o,n){const i=Array.isArray(n)?{triggerCharacters:n,retriggerCharacters:[]}:n,r=this._addNewAdapter(new Z(this._documents,o),e);return this._proxy.$registerSignatureHelpProvider(r,this._transformDocumentSelector(t,e),i),this._createDisposable(r)}$provideSignatureHelp(e,t,o,n,i){return this._withAdapter(e,Z,r=>r.provideSignatureHelp(p.revive(t),o,n,i),void 0,i)}$releaseSignatureHelp(e,t){this._withAdapter(e,Z,o=>o.releaseSignatureHelp(t),void 0,void 0)}registerInlayHintsProvider(e,t,o){const n=typeof o.onDidChangeInlayHints=="function"?this._nextHandle():void 0,i=this._addNewAdapter(new V(this._documents,this._commands.converter,o,this._logService,e),e);this._proxy.$registerInlayHintsProvider(i,this._transformDocumentSelector(t,e),typeof o.resolveInlayHint=="function",n,f._extLabel(e));let r=this._createDisposable(i);if(n!==void 0){const s=o.onDidChangeInlayHints(a=>this._proxy.$emitInlayHintsEvent(n));r=A.from(r,s)}return r}$provideInlayHints(e,t,o,n){return this._withAdapter(e,V,i=>i.provideInlayHints(p.revive(t),o,n),void 0,n)}$resolveInlayHint(e,t,o){return this._withAdapter(e,V,n=>n.resolveInlayHint(t,o),void 0,o)}$releaseInlayHints(e,t){this._withAdapter(e,V,o=>o.releaseHints(t),void 0,void 0)}registerDocumentLinkProvider(e,t,o){const n=this._addNewAdapter(new b(this._documents,o),e);return this._proxy.$registerDocumentLinkProvider(n,this._transformDocumentSelector(t,e),typeof o.resolveDocumentLink=="function"),this._createDisposable(n)}$provideDocumentLinks(e,t,o){return this._withAdapter(e,b,n=>n.provideLinks(p.revive(t),o),void 0,o,t.scheme==="output")}$resolveDocumentLink(e,t,o){return this._withAdapter(e,b,n=>n.resolveLink(t,o),void 0,void 0,!0)}$releaseDocumentLinks(e,t){this._withAdapter(e,b,o=>o.releaseLinks(t),void 0,void 0,!0)}registerColorProvider(e,t,o){const n=this._addNewAdapter(new Q(this._documents,o),e);return this._proxy.$registerDocumentColorProvider(n,this._transformDocumentSelector(t,e)),this._createDisposable(n)}$provideDocumentColors(e,t,o){return this._withAdapter(e,Q,n=>n.provideColors(p.revive(t),o),[],o)}$provideColorPresentations(e,t,o,n){return this._withAdapter(e,Q,i=>i.provideColorPresentations(p.revive(t),o,n),void 0,n)}registerFoldingRangeProvider(e,t,o){const n=this._nextHandle(),i=typeof o.onDidChangeFoldingRanges=="function"?this._nextHandle():void 0;this._adapter.set(n,new N(new Ce(this._documents,o),e)),this._proxy.$registerFoldingRangeProvider(n,this._transformDocumentSelector(t,e),e.identifier,i);let r=this._createDisposable(n);if(i!==void 0){const s=o.onDidChangeFoldingRanges(()=>this._proxy.$emitFoldingRangeEvent(i));r=A.from(r,s)}return r}$provideFoldingRanges(e,t,o,n){return this._withAdapter(e,Ce,i=>i.provideFoldingRanges(p.revive(t),o,n),void 0,n)}registerSelectionRangeProvider(e,t,o){const n=this._addNewAdapter(new Se(this._documents,o,this._logService),e);return this._proxy.$registerSelectionRangeProvider(n,this._transformDocumentSelector(t,e)),this._createDisposable(n)}$provideSelectionRanges(e,t,o,n){return this._withAdapter(e,Se,i=>i.provideSelectionRanges(p.revive(t),o,n),[],n)}registerCallHierarchyProvider(e,t,o){const n=this._addNewAdapter(new $(this._documents,o),e);return this._proxy.$registerCallHierarchyProvider(n,this._transformDocumentSelector(t,e)),this._createDisposable(n)}$prepareCallHierarchy(e,t,o,n){return this._withAdapter(e,$,i=>Promise.resolve(i.prepareSession(p.revive(t),o,n)),void 0,n)}$provideCallHierarchyIncomingCalls(e,t,o,n){return this._withAdapter(e,$,i=>i.provideCallsTo(t,o,n),void 0,n)}$provideCallHierarchyOutgoingCalls(e,t,o,n){return this._withAdapter(e,$,i=>i.provideCallsFrom(t,o,n),void 0,n)}$releaseCallHierarchy(e,t){this._withAdapter(e,$,o=>Promise.resolve(o.releaseSession(t)),void 0,void 0)}registerTypeHierarchyProvider(e,t,o){const n=this._addNewAdapter(new F(this._documents,o),e);return this._proxy.$registerTypeHierarchyProvider(n,this._transformDocumentSelector(t,e)),this._createDisposable(n)}$prepareTypeHierarchy(e,t,o,n){return this._withAdapter(e,F,i=>Promise.resolve(i.prepareSession(p.revive(t),o,n)),void 0,n)}$provideTypeHierarchySupertypes(e,t,o,n){return this._withAdapter(e,F,i=>i.provideSupertypes(t,o,n),void 0,n)}$provideTypeHierarchySubtypes(e,t,o,n){return this._withAdapter(e,F,i=>i.provideSubtypes(t,o,n),void 0,n)}$releaseTypeHierarchy(e,t){this._withAdapter(e,F,o=>Promise.resolve(o.releaseSession(t)),void 0,void 0)}registerDocumentOnDropEditProvider(e,t,o,n){const i=this._nextHandle();return this._adapter.set(i,new N(new z(this._proxy,this._documents,o,i,e),e)),this._proxy.$registerDocumentOnDropEditProvider(i,this._transformDocumentSelector(t,e),k(e,"documentPaste")&&n?{supportsResolve:!!o.resolveDocumentDropEdit,dropMimeTypes:n.dropMimeTypes}:void 0),this._createDisposable(i)}$provideDocumentOnDropEdits(e,t,o,n,i,r){return this._withAdapter(e,z,s=>Promise.resolve(s.provideDocumentOnDropEdits(t,p.revive(o),n,i,r)),void 0,void 0)}$resolveDropEdit(e,t,o){return this._withAdapter(e,z,n=>n.resolveDropEdit(t,o),{},void 0)}$releaseDocumentOnDropEdits(e,t){this._withAdapter(e,z,o=>Promise.resolve(o.releaseDropEdits(t)),void 0,void 0)}registerMappedEditsProvider(e,t,o){const n=this._addNewAdapter(new xe(this._documents,o),e);return this._proxy.$registerMappedEditsProvider(n,this._transformDocumentSelector(t,e),e.displayName??e.name),this._createDisposable(n)}$provideMappedEdits(e,t,o,n,i){return this._withAdapter(e,xe,r=>Promise.resolve(r.provideMappedEdits(t,o,n,i)),null,i)}registerDocumentPasteEditProvider(e,t,o,n){const i=this._nextHandle();return this._adapter.set(i,new N(new L(this._proxy,this._documents,o,i,e),e)),this._proxy.$registerPasteEditProvider(i,this._transformDocumentSelector(t,e),{supportsCopy:!!o.prepareDocumentPaste,supportsPaste:!!o.provideDocumentPasteEdits,supportsResolve:!!o.resolveDocumentPasteEdit,providedPasteEditKinds:n.providedPasteEditKinds?.map(r=>r.value),copyMimeTypes:n.copyMimeTypes,pasteMimeTypes:n.pasteMimeTypes}),this._createDisposable(i)}$prepareDocumentPaste(e,t,o,n,i){return this._withAdapter(e,L,r=>r.prepareDocumentPaste(p.revive(t),o,n,i),void 0,i)}$providePasteEdits(e,t,o,n,i,r,s){return this._withAdapter(e,L,a=>a.providePasteEdits(t,p.revive(o),n,i,r,s),void 0,s)}$resolvePasteEdit(e,t,o){return this._withAdapter(e,L,n=>n.resolvePasteEdit(t,o),{},void 0)}$releasePasteEdits(e,t){this._withAdapter(e,L,o=>Promise.resolve(o.releasePasteEdits(t)),void 0,void 0)}static _serializeRegExp(e){return{pattern:e.source,flags:e.flags}}static _serializeIndentationRule(e){return{decreaseIndentPattern:f._serializeRegExp(e.decreaseIndentPattern),increaseIndentPattern:f._serializeRegExp(e.increaseIndentPattern),indentNextLinePattern:e.indentNextLinePattern?f._serializeRegExp(e.indentNextLinePattern):void 0,unIndentedLinePattern:e.unIndentedLinePattern?f._serializeRegExp(e.unIndentedLinePattern):void 0}}static _serializeOnEnterRule(e){return{beforeText:f._serializeRegExp(e.beforeText),afterText:e.afterText?f._serializeRegExp(e.afterText):void 0,previousLineText:e.previousLineText?f._serializeRegExp(e.previousLineText):void 0,action:e.action}}static _serializeOnEnterRules(e){return e.map(f._serializeOnEnterRule)}static _serializeAutoClosingPair(e){return{open:e.open,close:e.close,notIn:e.notIn?e.notIn.map(t=>Ge.toString(t)):void 0}}static _serializeAutoClosingPairs(e){return e.map(f._serializeAutoClosingPair)}setLanguageConfiguration(e,t,o){const{wordPattern:n}=o;if(n&&$e(n))throw new Error(`Invalid language configuration: wordPattern '${n}' is not allowed to match the empty string.`);n?this._documents.setWordDefinitionFor(t,n):this._documents.setWordDefinitionFor(t,void 0),o.__electricCharacterSupport&&this._apiDeprecation.report("LanguageConfiguration.__electricCharacterSupport",e,"Do not use."),o.__characterPairSupport&&this._apiDeprecation.report("LanguageConfiguration.__characterPairSupport",e,"Do not use.");const i=this._nextHandle(),r={comments:o.comments,brackets:o.brackets,wordPattern:o.wordPattern?f._serializeRegExp(o.wordPattern):void 0,indentationRules:o.indentationRules?f._serializeIndentationRule(o.indentationRules):void 0,onEnterRules:o.onEnterRules?f._serializeOnEnterRules(o.onEnterRules):void 0,__electricCharacterSupport:o.__electricCharacterSupport,__characterPairSupport:o.__characterPairSupport,autoClosingPairs:o.autoClosingPairs?f._serializeAutoClosingPairs(o.autoClosingPairs):void 0};return this._proxy.$setLanguageConfiguration(i,t,r),this._createDisposable(i)}$setWordDefinitions(e){for(const t of e)this._documents.setWordDefinitionFor(t.languageId,new RegExp(t.regexSource,t.regexFlags))}}export{f as ExtHostLanguageFeatures};
