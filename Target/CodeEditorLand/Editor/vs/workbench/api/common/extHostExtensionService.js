var ee=Object.defineProperty;var te=Object.getOwnPropertyDescriptor;var W=(d,r,e,t)=>{for(var i=t>1?void 0:t?te(r,e):r,n=d.length-1,o;n>=0;n--)(o=d[n])&&(i=(t?o(r,e,i):o(i))||i);return t&&i&&ee(r,e,i),i},x=(d,r)=>(e,t)=>r(e,t,d);import{Barrier as H,IntervalTimer as ie,asPromise as ne,timeout as k}from"../../../base/common/async.js";import{VSBuffer as oe}from"../../../base/common/buffer.js";import*as $ from"../../../base/common/errors.js";import{Emitter as se,Event as O}from"../../../base/common/event.js";import{Disposable as re,DisposableStore as ae,dispose as ce,toDisposable as j}from"../../../base/common/lifecycle.js";import{Schemas as le}from"../../../base/common/network.js";import*as M from"../../../base/common/path.js";import*as p from"../../../base/common/performance.js";import{isCI as R,setTimeout0 as de}from"../../../base/common/platform.js";import{extUriBiasedIgnorePathCase as ve,joinPath as he,originalFSPath as N}from"../../../base/common/resources.js";import{StopWatch as xe}from"../../../base/common/stopwatch.js";import{TernarySearchTree as ue}from"../../../base/common/ternarySearchTree.js";import{URI as S}from"../../../base/common/uri.js";import*as z from"../../../nls.js";import{ExtensionIdentifier as V,ExtensionIdentifierMap as me,ExtensionIdentifierSet as K}from"../../../platform/extensions/common/extensions.js";import{IInstantiationService as Ee,createDecorator as J}from"../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as ge}from"../../../platform/instantiation/common/serviceCollection.js";import{ILogService as pe}from"../../../platform/log/common/log.js";import{ManagedRemoteConnection as fe,RemoteAuthorityResolverErrorCode as D,WebSocketRemoteConnection as ye,getRemoteAuthorityPrefix as G}from"../../../platform/remote/common/remoteAuthorityResolver.js";import{ExtensionDescriptionRegistry as C}from"../../services/extensions/common/extensionDescriptionRegistry.js";import{ActivationKind as _e,checkProposedApiEnabled as Ie,isProposedApiEnabled as Re}from"../../services/extensions/common/extensions.js";import{checkActivateWorkspaceContainsExtension as Pe}from"../../services/extensions/common/workspaceContains.js";import{MainContext as U}from"./extHost.protocol.js";import{IExtHostConfiguration as Se}from"./extHostConfiguration.js";import{ActivatedExtension as Te,EmptyExtension as Ae,ExtensionActivationTimes as be,ExtensionActivationTimesBuilder as q,ExtensionsActivator as we,HostExtension as He}from"./extHostExtensionActivator.js";import{IExtHostInitDataService as De}from"./extHostInitDataService.js";import{IExtHostLanguageModels as Ce}from"./extHostLanguageModels.js";import{IExtHostLocalizationService as ke}from"./extHostLocalizationService.js";import{IExtHostManagedSockets as $e}from"./extHostManagedSockets.js";import{ExtensionGlobalMemento as Me,ExtensionMemento as Ue}from"./extHostMemento.js";import{IExtHostRpcService as Fe}from"./extHostRpcService.js";import{ExtHostSecretState as Le,IExtHostSecretState as Be}from"./extHostSecretState.js";import{ExtensionSecrets as We}from"./extHostSecrets.js";import{ExtHostStorage as Oe,IExtHostStorage as je}from"./extHostStorage.js";import{IExtensionStoragePaths as Ne}from"./extHostStoragePaths.js";import{IExtHostTerminalService as ze}from"./extHostTerminalService.js";import{IExtHostTunnelService as Ve}from"./extHostTunnelService.js";import{ManagedResolvedAuthority as F,ExtensionKind as Q,ExtensionMode as L,RemoteAuthorityResolverError as b}from"./extHostTypes.js";import{IExtHostWorkspace as Ke}from"./extHostWorkspace.js";const Je=J("IHostUtils");let A=class extends re{constructor(e,t,i,n,o,s,v,h,l,u,g,m,a){super();this._extHostManagedSockets=m;this._extHostLanguageModels=a;this._hostUtils=t,this._extHostContext=i,this._initData=v,this._extHostWorkspace=n,this._extHostConfiguration=o,this._logService=s,this._extHostTunnelService=l,this._extHostTerminalService=u,this._extHostLocalizationService=g,this._mainThreadWorkspaceProxy=this._extHostContext.getProxy(U.MainThreadWorkspace),this._mainThreadTelemetryProxy=this._extHostContext.getProxy(U.MainThreadTelemetry),this._mainThreadExtensionsProxy=this._extHostContext.getProxy(U.MainThreadExtensionService),this._almostReadyToRunExtensions=new H,this._readyToStartExtensionHost=new H,this._readyToRunExtensions=new H,this._eagerExtensionsActivated=new H,this._activationEventsReader=new Qe(this._initData.extensions.activationEvents),this._globalRegistry=new C(this._activationEventsReader,this._initData.extensions.allExtensions);const f=new K(this._initData.extensions.myExtensions);this._myRegistry=new C(this._activationEventsReader,Z(this._globalRegistry,f)),R&&(this._logService.info(`Creating extension host with the following global extensions: ${T(this._globalRegistry)}`),this._logService.info(`Creating extension host with the following local extensions: ${T(this._myRegistry)}`)),this._storage=new Oe(this._extHostContext,this._logService),this._secretState=new Le(this._extHostContext),this._storagePath=h,this._instaService=this._store.add(e.createChild(new ge([je,this._storage],[Be,this._secretState]))),this._activator=this._register(new we(this._myRegistry,this._globalRegistry,{onExtensionActivationError:(y,P,_)=>{this._mainThreadExtensionsProxy.$onExtensionActivationError(y,$.transformErrorForSerialization(P),_)},actualActivateExtension:async(y,P)=>{if(C.isHostExtension(y,this._myRegistry,this._globalRegistry))return await this._mainThreadExtensionsProxy.$activateExtension(y,P),new He;const _=this._myRegistry.getExtensionDescription(y);return this._activateExtension(_,P)}},this._logService)),this._extensionPathIndex=null,this._resolvers=Object.create(null),this._started=!1,this._remoteConnectionData=this._initData.remote.connectionData}_serviceBrand;_onDidChangeRemoteConnectionData=this._register(new se);onDidChangeRemoteConnectionData=this._onDidChangeRemoteConnectionData.event;_hostUtils;_initData;_extHostContext;_instaService;_extHostWorkspace;_extHostConfiguration;_logService;_extHostTunnelService;_extHostTerminalService;_extHostLocalizationService;_mainThreadWorkspaceProxy;_mainThreadTelemetryProxy;_mainThreadExtensionsProxy;_almostReadyToRunExtensions;_readyToStartExtensionHost;_readyToRunExtensions;_eagerExtensionsActivated;_activationEventsReader;_myRegistry;_globalRegistry;_storage;_secretState;_storagePath;_activator;_extensionPathIndex;_realPathCache=new Map;_resolvers;_started;_isTerminating=!1;_remoteConnectionData;getRemoteConnectionData(){return this._remoteConnectionData}async initialize(){try{await this._beforeAlmostReadyToRunExtensions(),this._almostReadyToRunExtensions.open(),await this._extHostWorkspace.waitForInitializeCall(),p.mark("code/extHost/ready"),this._readyToStartExtensionHost.open(),this._initData.autoStart&&this._startExtensionHost()}catch(e){$.onUnexpectedError(e)}}async _deactivateAll(){this._storagePath.onWillDeactivateAll();let e=[];try{e=this._myRegistry.getAllExtensionDescriptions().map(o=>o.identifier).filter(o=>this.isActivated(o)).map(o=>this._deactivate(o))}catch{}await Promise.all(e)}terminate(e,t=0){if(this._isTerminating)return;this._isTerminating=!0,this._logService.info(`Extension host terminating: ${e}`),this._logService.flush(),this._extHostTerminalService.dispose(),this._activator.dispose(),$.setUnexpectedErrorHandler(n=>{this._logService.error(n)}),this._extHostContext.dispose();const i=this._deactivateAll();Promise.race([k(5e3),i]).finally(()=>{this._hostUtils.pid?this._logService.info(`Extension host with pid ${this._hostUtils.pid} exiting with code ${t}`):this._logService.info(`Extension host exiting with code ${t}`),this._logService.flush(),this._logService.dispose(),this._hostUtils.exit(t)})}isActivated(e){return this._readyToRunExtensions.isOpen()?this._activator.isActivated(e):!1}async getExtension(e){const t=await this._mainThreadExtensionsProxy.$getExtension(e);return t&&{...t,identifier:new V(t.identifier.value),extensionLocation:S.revive(t.extensionLocation)}}_activateByEvent(e,t){return this._activator.activateByEvent(e,t)}_activateById(e,t){return this._activator.activateById(e,t)}activateByIdWithErrors(e,t){return this._activateById(e,t).then(()=>{const i=this._activator.getActivatedExtension(e);if(i.activationFailed)return Promise.reject(i.activationFailedError)})}getExtensionRegistry(){return this._readyToRunExtensions.wait().then(e=>this._myRegistry)}getExtensionExports(e){if(this._readyToRunExtensions.isOpen())return this._activator.getActivatedExtension(e).exports;try{return this._activator.getActivatedExtension(e).exports}catch{return null}}async _realPathExtensionUri(e){if(e.scheme===le.file&&this._hostUtils.fsRealpath){const t=e.fsPath;this._realPathCache.has(t)||this._realPathCache.set(t,this._hostUtils.fsRealpath(t));const i=await this._realPathCache.get(t);return S.file(i)}return e}async getExtensionPathIndex(){return this._extensionPathIndex||(this._extensionPathIndex=this._createExtensionPathIndex(this._myRegistry.getAllExtensionDescriptions()).then(e=>new qe(e))),this._extensionPathIndex}async _createExtensionPathIndex(e){const t=ue.forUris(i=>ve.ignorePathCasing(i));return await Promise.all(e.map(async i=>{if(this._getEntryPoint(i)){const n=await this._realPathExtensionUri(i.extensionLocation);t.set(n,i)}})),t}_deactivate(e){let t=Promise.resolve(void 0);if(!this._readyToRunExtensions.isOpen()||!this._activator.isActivated(e))return t;const i=this._activator.getActivatedExtension(e);if(!i)return t;try{typeof i.module.deactivate=="function"&&(t=Promise.resolve(i.module.deactivate()).then(void 0,n=>(this._logService.error(n),Promise.resolve(void 0))))}catch(n){this._logService.error(`An error occurred when deactivating the extension '${e.value}':`),this._logService.error(n)}try{i.disposable.dispose()}catch(n){this._logService.error(`An error occurred when disposing the subscriptions for extension '${e.value}':`),this._logService.error(n)}return t}async _activateExtension(e,t){return this._initData.remote.isRemote?this._mainThreadExtensionsProxy.$onWillActivateExtension(e.identifier):await this._mainThreadExtensionsProxy.$onWillActivateExtension(e.identifier),this._doActivateExtension(e,t).then(i=>{const n=i.activationTimes;return this._mainThreadExtensionsProxy.$onDidActivateExtension(e.identifier,n.codeLoadingTime,n.activateCallTime,n.activateResolvedTime,t),this._logExtensionActivationTimes(e,t,"success",n),i},i=>{throw this._logExtensionActivationTimes(e,t,"failure"),i})}_logExtensionActivationTimes(e,t,i,n){const o=Y(e,t);this._mainThreadTelemetryProxy.$publicLog2("extensionActivationTimes",{...o,...n||{},outcome:i})}_doActivateExtension(e,t){const i=Y(e,t);this._mainThreadTelemetryProxy.$publicLog2("activatePlugin",i);const n=this._getEntryPoint(e);if(!n)return Promise.resolve(new Ae(be.NONE));this._logService.info(`ExtensionService#_doActivateExtension ${e.identifier.value}, startup: ${t.startup}, activationEvent: '${t.activationEvent}'${e.identifier.value!==t.extensionId.value?`, root cause: ${t.extensionId.value}`:""}`),this._logService.flush();const o=new ae,s=new q(t.startup);return Promise.all([this._loadCommonJSModule(e,he(e.extensionLocation,n),s),this._loadExtensionContext(e,o)]).then(v=>(p.mark(`code/extHost/willActivateExtension/${e.identifier.value}`),A._callActivate(this._logService,e.identifier,v[0],v[1],o,s))).then(v=>(p.mark(`code/extHost/didActivateExtension/${e.identifier.value}`),v))}_loadExtensionContext(e,t){const i=this._extHostLanguageModels.createLanguageModelAccessInformation(e),n=t.add(new Me(e,this._storage)),o=t.add(new Ue(e.identifier.value,!1,this._storage)),s=t.add(new We(e,this._secretState)),v=e.isUnderDevelopment?this._initData.environment.extensionTestsLocationURI?L.Test:L.Development:L.Production,h=this._initData.remote.isRemote?Q.Workspace:Q.UI;return this._logService.trace(`ExtensionService#loadExtensionContext ${e.identifier.value}`),Promise.all([n.whenReady,o.whenReady,this._storagePath.whenReady]).then(()=>{const l=this;let u,g;const m=Re(e,"ipc")?this._initData.messagePorts?.get(V.toKey(e.identifier)):void 0;return Object.freeze({globalState:n,workspaceState:o,secrets:s,subscriptions:[],get languageModelAccessInformation(){return i},get extensionUri(){return e.extensionLocation},get extensionPath(){return e.extensionLocation.fsPath},asAbsolutePath(a){return M.join(e.extensionLocation.fsPath,a)},get storagePath(){return l._storagePath.workspaceValue(e)?.fsPath},get globalStoragePath(){return l._storagePath.globalValue(e).fsPath},get logPath(){return M.join(l._initData.logsLocation.fsPath,e.identifier.value)},get logUri(){return S.joinPath(l._initData.logsLocation,e.identifier.value)},get storageUri(){return l._storagePath.workspaceValue(e)},get globalStorageUri(){return l._storagePath.globalValue(e)},get extensionMode(){return v},get extension(){return u===void 0&&(u=new Ge(l,e.identifier,e,h,!1)),u},get extensionRuntime(){return Ie(e,"extensionRuntime"),l.extensionRuntime},get environmentVariableCollection(){return l._extHostTerminalService.getEnvironmentVariableCollection(e)},get messagePassingProtocol(){if(!g){if(!m)return;const a=O.buffer(O.fromDOMEventEmitter(m,"message",f=>f.data));m.start(),g={onDidReceiveMessage:a,postMessage:m.postMessage.bind(m)}}return g}})})}static _callActivate(e,t,i,n,o,s){return i=i||{activate:void 0,deactivate:void 0},this._callActivateOptional(e,t,i,n,s).then(v=>new Te(!1,null,s.build(),i,v,j(()=>{o.dispose(),ce(n.subscriptions)})))}static _callActivateOptional(e,t,i,n,o){if(typeof i.activate=="function")try{o.activateCallStart(),e.trace(`ExtensionService#_callActivateOptional ${t.value}`);const s=typeof global=="object"?global:self,v=i.activate.apply(s,[n]);return o.activateCallStop(),o.activateResolveStart(),Promise.resolve(v).then(h=>(o.activateResolveStop(),h))}catch(s){return Promise.reject(s)}else return Promise.resolve(i)}_activateOneStartupFinished(e,t){this._activateById(e.identifier,{startup:!1,extensionId:e.identifier,activationEvent:t}).then(void 0,i=>{this._logService.error(i)})}_activateAllStartupFinishedDeferred(e,t=0){const n=Date.now();de(()=>{for(let o=t;o<e.length;o+=1){const s=e[o];for(const v of s.activationEvents??[])if(v==="onStartupFinished")if(Date.now()-n>50){this._activateAllStartupFinishedDeferred(e,o);break}else this._activateOneStartupFinished(s,v)}})}_activateAllStartupFinished(){this._mainThreadExtensionsProxy.$setPerformanceMarks(p.getMarks()),this._extHostConfiguration.getConfigProvider().then(e=>{const t=e.getConfiguration("extensions.experimental").get("deferredStartupFinishedActivation"),i=this._myRegistry.getAllExtensionDescriptions();if(t)this._activateAllStartupFinishedDeferred(i);else for(const n of i)if(n.activationEvents)for(const o of n.activationEvents)o==="onStartupFinished"&&this._activateOneStartupFinished(n,o)})}_handleEagerExtensions(){const e=this._activateByEvent("*",!0).then(void 0,s=>{this._logService.error(s)});this._register(this._extHostWorkspace.onDidChangeWorkspace(s=>this._handleWorkspaceContainsEagerExtensions(s.added)));const t=this._extHostWorkspace.workspace?this._extHostWorkspace.workspace.folders:[],i=this._handleWorkspaceContainsEagerExtensions(t),n=this._handleRemoteResolverEagerExtensions(),o=Promise.all([n,e,i]).then(()=>{});return Promise.race([o,k(1e4)]).then(()=>{this._activateAllStartupFinished()}),o}_handleWorkspaceContainsEagerExtensions(e){return e.length===0?Promise.resolve(void 0):Promise.all(this._myRegistry.getAllExtensionDescriptions().map(t=>this._handleWorkspaceContainsEagerExtension(e,t))).then(()=>{})}async _handleWorkspaceContainsEagerExtension(e,t){if(this.isActivated(t.identifier))return;const i=!this._initData.remote.isRemote&&!!this._initData.remote.authority,n={logService:this._logService,folders:e.map(s=>s.uri),forceUsingSearch:i||!this._hostUtils.fsExists,exists:s=>this._hostUtils.fsExists(s.fsPath),checkExists:(s,v,h)=>this._mainThreadWorkspaceProxy.$checkExists(s,v,h)},o=await Pe(n,t);if(o)return this._activateById(t.identifier,{startup:!0,extensionId:t.identifier,activationEvent:o.activationEvent}).then(void 0,s=>this._logService.error(s))}async _handleRemoteResolverEagerExtensions(){if(this._initData.remote.authority)return this._activateByEvent(`onResolveRemoteAuthority:${this._initData.remote.authority}`,!1)}async $extensionTestsExecute(){await this._eagerExtensionsActivated.wait();try{return await this._doHandleExtensionTests()}catch(e){throw e}}async _doHandleExtensionTests(){const{extensionDevelopmentLocationURI:e,extensionTestsLocationURI:t}=this._initData.environment;if(!e||!t)throw new Error(z.localize("extensionTestError1","Cannot load test runner."));const i=await this._loadCommonJSModule(null,t,new q(!1));if(!i||typeof i.run!="function")throw new Error(z.localize("extensionTestError","Path {0} does not point to a valid extension test runner.",t.toString()));return new Promise((n,o)=>{const s=(l,u)=>{l?(R&&this._logService.error("Test runner called back with error",l),o(l)):(R&&(u?this._logService.info(`Test runner called back with ${u} failures.`):this._logService.info("Test runner called back with successful outcome.")),n(typeof u=="number"&&u>0?1:0))},v=N(t),h=i.run(v,s);h&&h.then&&h.then(()=>{R&&this._logService.info("Test runner finished successfully."),n(0)}).catch(l=>{R&&this._logService.error("Test runner finished with error",l),o(l instanceof Error&&l.stack?l.stack:String(l))})})}_startExtensionHost(){if(this._started)throw new Error("Extension host is already started!");return this._started=!0,this._readyToStartExtensionHost.wait().then(()=>this._readyToRunExtensions.open()).then(()=>Promise.race([this._activator.waitForActivatingExtensions(),k(1e3)])).then(()=>this._handleEagerExtensions()).then(()=>{this._eagerExtensionsActivated.open(),this._logService.info("Eager extensions activated")})}registerRemoteAuthorityResolver(e,t){return this._resolvers[e]=t,j(()=>{delete this._resolvers[e]})}async getRemoteExecServer(e){const{resolver:t}=await this._activateAndGetResolver(e);return t?.resolveExecServer?.(e,{resolveAttempt:0})}async _activateAndGetResolver(e){const t=e.indexOf("+");if(t===-1)throw new b("Not an authority that can be resolved!",D.InvalidAuthority);const i=e.substr(0,t);return await this._almostReadyToRunExtensions.wait(),await this._activateByEvent(`onResolveRemoteAuthority:${i}`,!1),{authorityPrefix:i,resolver:this._resolvers[i]}}async $resolveAuthority(e,t){const i=xe.create(!1),n=()=>`[resolveAuthority(${G(e)},${t})][${i.elapsed()}ms] `,o=c=>this._logService.info(`${n()}${c}`),s=c=>this._logService.warn(`${n()}${c}`),v=(c,E=void 0)=>this._logService.error(`${n()}${c}`,E),h=c=>{if(c instanceof b)return{type:"error",error:{code:c._code,message:c._message,detail:c._detail}};throw c},l=async c=>{o(`activating resolver for ${c}...`);const{resolver:E,authorityPrefix:I}=await this._activateAndGetResolver(c);if(!E)throw v(`no resolver for ${I}`),new b(`No remote extension installed to resolve ${I}.`,D.NoResolverFound);return{resolver:E,authorityPrefix:I,remoteAuthority:c}},u=e.split(/@|%40/g).reverse();o(`activating remote resolvers ${u.join(" -> ")}`);let g;try{g=await Promise.all(u.map(l)).catch(async c=>{if(!(c instanceof b)||c._code!==D.InvalidAuthority)throw c;return s(`resolving nested authorities failed: ${c.message}`),[await l(e)]})}catch(c){return h(c)}const m=new ie;m.cancelAndSet(()=>o("waiting..."),1e3);let a,f;for(const[c,{authorityPrefix:E,resolver:I,remoteAuthority:w}]of g.entries())try{if(c===g.length-1)o("invoking final resolve()..."),p.mark(`code/extHost/willResolveAuthority/${E}`),a=await I.resolve(w,{resolveAttempt:t,execServer:f}),p.mark(`code/extHost/didResolveAuthorityOK/${E}`),o("setting tunnel factory..."),this._register(await this._extHostTunnelService.setTunnelFactory(I,F.isManagedResolvedAuthority(a)?a:void 0));else{if(o(`invoking resolveExecServer() for ${w}`),p.mark(`code/extHost/willResolveExecServer/${E}`),f=await I.resolveExecServer?.(w,{resolveAttempt:t,execServer:f}),!f)throw new b(`Exec server was not available for ${w}`,D.NoResolverFound);p.mark(`code/extHost/didResolveExecServerOK/${E}`)}}catch(B){return p.mark(`code/extHost/didResolveAuthorityError/${E}`),v("returned an error",B),m.dispose(),h(B)}m.dispose();const y={environmentTunnels:a.environmentTunnels,features:a.tunnelFeatures?{elevation:a.tunnelFeatures.elevation,privacyOptions:a.tunnelFeatures.privacyOptions,protocol:a.tunnelFeatures.protocol===void 0?!0:a.tunnelFeatures.protocol}:void 0},P={extensionHostEnv:a.extensionHostEnv,isTrusted:a.isTrusted,authenticationSession:a.authenticationSessionForInitializingExtensions?{id:a.authenticationSessionForInitializingExtensions.id,providerId:a.authenticationSessionForInitializingExtensions.providerId}:void 0};o(`returned ${F.isManagedResolvedAuthority(a)?"managed authority":`${a.host}:${a.port}`}`);let _;if(F.isManagedResolvedAuthority(a)){const c=t;this._extHostManagedSockets.setFactory(c,a.makeConnection),_={authority:e,connectTo:new fe(c),connectionToken:a.connectionToken}}else _={authority:e,connectTo:new ye(a.host,a.port),connectionToken:a.connectionToken};return{type:"ok",value:{authority:_,options:P,tunnelInformation:y}}}async $getCanonicalURI(e,t){this._logService.info(`$getCanonicalURI invoked for authority (${G(e)})`);const{resolver:i}=await this._activateAndGetResolver(e);if(!i)return null;const n=S.revive(t);if(typeof i.getCanonicalURI>"u")return n;const o=await ne(()=>i.getCanonicalURI(n));return o||n}async $startExtensionHost(e){e.toAdd.forEach(s=>s.extensionLocation=S.revive(s.extensionLocation));const{globalRegistry:t,myExtensions:i}=X(this._activationEventsReader,this._globalRegistry,this._myRegistry,e),n=await this._createExtensionPathIndex(i);return(await this.getExtensionPathIndex()).setSearchTree(n),this._globalRegistry.set(t.getAllExtensionDescriptions()),this._myRegistry.set(i),R&&(this._logService.info(`$startExtensionHost: global extensions: ${T(this._globalRegistry)}`),this._logService.info(`$startExtensionHost: local extensions: ${T(this._myRegistry)}`)),this._startExtensionHost()}$activateByEvent(e,t){return t===_e.Immediate?this._almostReadyToRunExtensions.wait().then(i=>this._activateByEvent(e,!1)):this._readyToRunExtensions.wait().then(i=>this._activateByEvent(e,!1))}async $activate(e,t){return await this._readyToRunExtensions.wait(),this._myRegistry.getExtensionDescription(e)?(await this._activateById(e,t),!0):!1}async $deltaExtensions(e){e.toAdd.forEach(s=>s.extensionLocation=S.revive(s.extensionLocation));const{globalRegistry:t,myExtensions:i}=X(this._activationEventsReader,this._globalRegistry,this._myRegistry,e),n=await this._createExtensionPathIndex(i);return(await this.getExtensionPathIndex()).setSearchTree(n),this._globalRegistry.set(t.getAllExtensionDescriptions()),this._myRegistry.set(i),R&&(this._logService.info(`$deltaExtensions: global extensions: ${T(this._globalRegistry)}`),this._logService.info(`$deltaExtensions: local extensions: ${T(this._myRegistry)}`)),Promise.resolve(void 0)}async $test_latency(e){return e}async $test_up(e){return e.byteLength}async $test_down(e){const t=oe.alloc(e),i=Math.random()%256;for(let n=0;n<e;n++)t.writeUInt8(i,n);return t}async $updateRemoteConnectionData(e){this._remoteConnectionData=e,this._onDidChangeRemoteConnectionData.fire()}};A=W([x(0,Ee),x(1,Je),x(2,Fe),x(3,Ke),x(4,Se),x(5,pe),x(6,De),x(7,Ne),x(8,Ve),x(9,ze),x(10,ke),x(11,$e),x(12,Ce)],A);function X(d,r,e,t){d.addActivationEvents(t.addActivationEvents);const i=new C(d,r.getAllExtensionDescriptions());i.deltaExtensions(t.toAdd,t.toRemove);const n=new K(e.getAllExtensionDescriptions().map(s=>s.identifier));for(const s of t.myToRemove)n.delete(s);for(const s of t.myToAdd)n.add(s);const o=Z(i,n);return{globalRegistry:i,myExtensions:o}}function Y(d,r){return{id:d.identifier.value,name:d.name,extensionVersion:d.version,publisherDisplayName:d.publisher,activationEvents:d.activationEvents?d.activationEvents.join(","):null,isBuiltin:d.isBuiltin,reason:r.activationEvent,reasonId:r.extensionId.value}}function T(d){return d.getAllExtensionDescriptions().map(r=>r.identifier.value).join(",")}const kt=J("IExtHostExtensionService");class Ge{#e;#i;#t;id;extensionUri;extensionPath;packageJSON;extensionKind;isFromDifferentExtensionHost;constructor(r,e,t,i,n){this.#e=r,this.#i=e,this.#t=t.identifier,this.id=t.identifier.value,this.extensionUri=t.extensionLocation,this.extensionPath=M.normalize(N(t.extensionLocation)),this.packageJSON=t,this.extensionKind=i,this.isFromDifferentExtensionHost=n}get isActive(){return this.#e.isActivated(this.#t)}get exports(){if(!(this.packageJSON.api==="none"||this.isFromDifferentExtensionHost))return this.#e.getExtensionExports(this.#t)}async activate(){if(this.isFromDifferentExtensionHost)throw new Error("Cannot activate foreign extension");return await this.#e.activateByIdWithErrors(this.#t,{startup:!1,extensionId:this.#i,activationEvent:"api"}),this.exports}}function Z(d,r){return d.getAllExtensionDescriptions().filter(e=>r.has(e.identifier))}class qe{constructor(r){this._searchTree=r}setSearchTree(r){this._searchTree=r}findSubstr(r){return this._searchTree.findSubstr(r)}forEach(r){return this._searchTree.forEach(r)}}class Qe{_map=new me;constructor(r){this.addActivationEvents(r)}readActivationEvents(r){return this._map.get(r.identifier)??[]}addActivationEvents(r){for(const e of Object.keys(r))this._map.set(e,r[e])}}export{A as AbstractExtHostExtensionService,Ge as Extension,qe as ExtensionPaths,kt as IExtHostExtensionService,Je as IHostUtils};
