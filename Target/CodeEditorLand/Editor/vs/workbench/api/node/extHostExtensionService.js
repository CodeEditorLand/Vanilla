import*as l from"../../../base/common/performance.js";import{createApiFactoryAndRegisterActors as h}from"../common/extHost.api.impl.js";import{RequireInterceptor as v}from"../common/extHostRequireInterceptor.js";import"../common/extHostExtensionActivator.js";import{connectProxyResolver as _}from"./proxyResolver.js";import{AbstractExtHostExtensionService as u}from"../common/extHostExtensionService.js";import{ExtHostDownloadService as g}from"./extHostDownloadService.js";import{URI as x}from"../../../base/common/uri.js";import{Schemas as y}from"../../../base/common/network.js";import"../../../platform/extensions/common/extensions.js";import{ExtensionRuntime as S}from"../common/extHostTypes.js";import{CLIServer as E}from"./extHostCLIServer.js";import{realpathSync as I}from"../../../base/node/extpath.js";import{ExtHostConsoleForwarder as R}from"./extHostConsoleForwarder.js";import{ExtHostDiskFileSystemProvider as P}from"./extHostDiskFileSystemProvider.js";import{createRequire as k}from"node:module";const d=k(import.meta.url);class H extends v{_installInterceptor(){const t=this,e=d("module"),o=e._load;e._load=function(i,n,m){return i=p(i),t._factories.has(i)?t._factories.get(i).load(i,x.file(I(n.filename)),c=>o.apply(this,[c,n,m])):o.apply(this,arguments)};const s=e._resolveLookupPaths;e._resolveLookupPaths=(r,i)=>s.call(this,p(r),i);const a=e._resolveFilename;e._resolveFilename=function(i,n,m,c){return i==="vsda"&&Array.isArray(c?.paths)&&c.paths.length===0&&(c.paths=e._nodeModulePaths(import.meta.dirname)),a.call(this,i,n,m,c)};const p=r=>{for(const i of t._alternatives){const n=i(r);if(n){r=n;break}}return r}}}class V extends u{extensionRuntime=S.Node;async _beforeAlmostReadyToRunExtensions(){this._instaService.createInstance(R);const t=this._instaService.invokeFunction(h);if(this._instaService.createInstance(g),this._initData.remote.isRemote&&this._initData.remote.authority){const s=this._instaService.createInstance(E);process.env.VSCODE_IPC_HOOK_CLI=s.ipcHandlePath}this._instaService.createInstance(P),await this._instaService.createInstance(H,t,{mine:this._myRegistry,all:this._globalRegistry}).install(),l.mark("code/extHost/didInitAPI");const o=await this._extHostConfiguration.getConfigProvider();await _(this._extHostWorkspace,o,this,this._logService,this._mainThreadTelemetryProxy,this._initData),l.mark("code/extHost/didInitProxyResolver")}_getEntryPoint(t){return t.main}async _loadCommonJSModule(t,e,o){if(e.scheme!==y.file)throw new Error(`Cannot load URI: '${e}', must be of file-scheme`);let s=null;o.codeLoadingStart(),this._logService.trace(`ExtensionService#loadCommonJSModule ${e.toString(!0)}`),this._logService.flush();const a=t?.identifier.value;t&&await this._extHostLocalizationService.initializeLocalizedMessages(t);try{a&&l.mark(`code/extHost/willLoadExtensionCode/${a}`),s=(d.__$__nodeRequire??d)(e.fsPath)}finally{a&&l.mark(`code/extHost/didLoadExtensionCode/${a}`),o.codeLoadingStop()}return s}async $setRemoteEnvironment(t){if(this._initData.remote.isRemote)for(const e in t){const o=t[e];o===null?delete process.env[e]:process.env[e]=o}}}export{V as ExtHostExtensionService};
