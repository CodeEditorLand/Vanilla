import"../common/extHostWorkspace.js";import"../common/extHostConfiguration.js";import"../common/extHost.protocol.js";import"../../services/extensions/common/extensionHostProtocol.js";import"./extHostExtensionService.js";import{URI as M}from"../../../base/common/uri.js";import{LogLevel as g}from"../../../platform/log/common/log.js";import"../../../platform/extensions/common/extensions.js";import{LogLevel as y,createHttpPatch as R,createProxyResolver as B,createTlsPatch as S,createNetPatch as D,loadSystemCertificates as N}from"@vscode/proxy-agent";import"../../../platform/request/common/request.js";import{createRequire as V}from"node:module";const x=V(import.meta.url),E=x("http"),A=x("https"),k=x("tls"),I=x("net"),$=!1;function fe(o,e,c,r,p,u){const s=u.environment.useHostProxy,h=typeof s=="boolean"?s:!u.remote.isRemote,t={resolveProxy:a=>o.resolveProxy(a),lookupProxyAuthorization:_.bind(void 0,o,r,p,e,{},{},u.remote.isRemote,h),getProxyURL:()=>e.getConfiguration("http").get("proxy"),getProxySupport:()=>e.getConfiguration("http").get("proxySupport")||"off",getNoProxyConfig:()=>e.getConfiguration("http").get("noProxy")||[],addCertificatesV1:()=>H(e),addCertificatesV2:()=>O(e),log:r,getLogLevel:()=>{const a=r.getLevel();switch(a){case g.Trace:return y.Trace;case g.Debug:return y.Debug;case g.Info:return y.Info;case g.Warning:return y.Warning;case g.Error:return y.Error;case g.Off:return y.Off;default:return f(a)}function f(d){return r.error("Unknown log level",d),y.Debug}},proxyResolveTelemetry:()=>{},useHostProxy:h,loadAdditionalCertificates:async()=>{const a=[];if(u.remote.isRemote&&a.push(N({log:r})),h){r.trace("ProxyResolver#loadAdditionalCertificates: Loading certificates from main process");const f=o.loadCertificates();f.then(d=>r.trace("ProxyResolver#loadAdditionalCertificates: Loaded certificates from main process",d.length)),a.push(f)}return u.environment.extensionTestsLocationURI&&A.globalAgent.testCertificates?.length&&(r.trace("ProxyResolver#loadAdditionalCertificates: Loading test certificates"),a.push(Promise.resolve(A.globalAgent.testCertificates))),(await Promise.all(a)).flat()},env:process.env},l=B(t),n=K(t,l);return U(c,n)}function K(o,e){function c(r,p){return Object.assign(r.default||r,p)}return{http:c(E,R(o,E,e)),https:c(A,R(o,A,e)),net:c(I,D(o,I)),tls:c(k,S(o,k))}}function H(o){const e=o.getConfiguration("http");return!e.get("experimental.systemCertificatesV2",$)&&!!e.get("systemCertificates")}function O(o){const e=o.getConfiguration("http");return!!e.get("experimental.systemCertificatesV2",$)&&!!e.get("systemCertificates")}const z=new Map;function U(o,e){return o.getExtensionPathIndex().then(c=>{const r=x("module"),p=r._load;r._load=function(s,h,t){if(s==="net")return e.net;if(s==="tls")return e.tls;if(s!=="http"&&s!=="https")return p.apply(this,arguments);const l=c.findSubstr(M.file(h.filename));let n=z.get(l);if(n||z.set(l,n={}),!n[s]){const a=e[s];n[s]={...a}}return n[s]}})}async function _(o,e,c,r,p,u,s,h,t,l,n){const a=p[t];l&&(p[t]=l),e.trace("ProxyResolver#lookupProxyAuthorization callback",`proxyURL:${t}`,`proxyAuthenticate:${l}`,`proxyAuthenticateCache:${a}`);const f=l||a,d=Array.isArray(f)?f:typeof f=="string"?[f]:[];if(j(c,d,s),d.some(i=>/^(Negotiate|Kerberos)( |$)/i.test(i))&&!n.kerberosRequested){n.kerberosRequested=!0;try{const i=await import("kerberos"),m=new URL(t),P=r.getConfiguration("http").get("proxyKerberosServicePrincipal")||(process.platform==="win32"?`HTTP/${m.hostname}`:`HTTP@${m.hostname}`);return e.debug("ProxyResolver#lookupProxyAuthorization Kerberos authentication lookup",`proxyURL:${t}`,`spn:${P}`),"Negotiate "+await(await i.initializeClient(P)).step("")}catch(i){e.debug("ProxyResolver#lookupProxyAuthorization Kerberos authentication failed",i)}if(s&&h){e.debug("ProxyResolver#lookupProxyAuthorization Kerberos authentication lookup on host",`proxyURL:${t}`);const i=await o.lookupKerberosAuthorization(t);if(i)return"Negotiate "+i}}const v=d.find(i=>/^Basic( |$)/i.test(i));if(v)try{const i=u[t];if(i)if(n.basicAuthCacheUsed)e.debug("ProxyResolver#lookupProxyAuthorization Basic authentication deleting cached credentials",`proxyURL:${t}`),delete u[t];else return e.debug("ProxyResolver#lookupProxyAuthorization Basic authentication using cached credentials",`proxyURL:${t}`),n.basicAuthCacheUsed=!0,i;n.basicAuthAttempt=(n.basicAuthAttempt||0)+1;const m=/ realm="([^"]+)"/i.exec(v)?.[1];e.debug("ProxyResolver#lookupProxyAuthorization Basic authentication lookup",`proxyURL:${t}`,`realm:${m}`);const P=new URL(t),C={scheme:"basic",host:P.hostname,port:Number(P.port),realm:m||"",isProxy:!0,attempt:n.basicAuthAttempt},b=await o.lookupAuthorization(C);if(b){e.debug("ProxyResolver#lookupProxyAuthorization Basic authentication received credentials",`proxyURL:${t}`,`realm:${m}`);const T="Basic "+Buffer.from(`${b.username}:${b.password}`).toString("base64");return u[t]=T,T}else e.debug("ProxyResolver#lookupProxyAuthorization Basic authentication received no credentials",`proxyURL:${t}`,`realm:${m}`)}catch(i){e.error("ProxyResolver#lookupProxyAuthorization Basic authentication failed",i)}}let w=!1;function j(o,e,c){w||!e.length||(w=!0,o.$publicLog2("proxyAuthenticationRequest",{authenticationType:e.map(r=>r.split(" ")[0]).join(","),extensionHostType:c?"remote":"local"}))}export{fe as connectProxyResolver};
