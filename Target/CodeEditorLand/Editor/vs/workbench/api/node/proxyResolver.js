import"../common/extHostWorkspace.js";import"../common/extHostConfiguration.js";import"../common/extHost.protocol.js";import"../../services/extensions/common/extensionHostProtocol.js";import"./extHostExtensionService.js";import{URI as B}from"../../../base/common/uri.js";import{LogLevel as A}from"../../../platform/log/common/log.js";import"../../../platform/extensions/common/extensions.js";import{LogLevel as P,createHttpPatch as E,createProxyResolver as W,createTlsPatch as H,createNetPatch as N,loadSystemCertificates as V}from"@vscode/proxy-agent";import"../../../platform/request/common/request.js";import"../../../base/common/lifecycle.js";import{createRequire as _}from"node:module";const R=_(import.meta.url),k=R("http"),v=R("https"),T=R("tls"),S=R("net"),w=!1,$=!1;function xe(o,e,c,r,u,h,l){j(e,u,h,l);const y=h.environment.useHostProxy,t=typeof y=="boolean"?y:!h.remote.isRemote,n={resolveProxy:s=>o.resolveProxy(s),lookupProxyAuthorization:J.bind(void 0,o,r,u,e,{},{},h.remote.isRemote,t),getProxyURL:()=>e.getConfiguration("http").get("proxy"),getProxySupport:()=>e.getConfiguration("http").get("proxySupport")||"off",getNoProxyConfig:()=>e.getConfiguration("http").get("noProxy")||[],addCertificatesV1:()=>q(e),addCertificatesV2:()=>L(e),log:r,getLogLevel:()=>{const s=r.getLevel();switch(s){case A.Trace:return P.Trace;case A.Debug:return P.Debug;case A.Info:return P.Info;case A.Warning:return P.Warning;case A.Error:return P.Error;case A.Off:return P.Off;default:return d(s)}function d(g){return r.error("Unknown log level",g),P.Debug}},proxyResolveTelemetry:()=>{},useHostProxy:t,loadAdditionalCertificates:async()=>{const s=[];if(h.remote.isRemote&&s.push(V({log:r})),t){r.trace("ProxyResolver#loadAdditionalCertificates: Loading certificates from main process");const d=o.loadCertificates();d.then(g=>r.trace("ProxyResolver#loadAdditionalCertificates: Loaded certificates from main process",g.length)),s.push(d)}return h.environment.extensionTestsLocationURI&&v.globalAgent.testCertificates?.length&&(r.trace("ProxyResolver#loadAdditionalCertificates: Loading test certificates"),s.push(Promise.resolve(v.globalAgent.testCertificates))),(await Promise.all(s)).flat()},env:process.env},i=W(n),p=O(n,i);return G(c,p)}const K=["content-length","host","trailer","te","upgrade","cookie2","keep-alive","transfer-encoding","set-cookie"];function j(o,e,c,r){if(!c.remote.isRemote&&!globalThis.__originalFetch){const u=globalThis.fetch;globalThis.__originalFetch=u;let h=o.getConfiguration("http").get("electronFetch",$);r.add(o.onDidChangeConfiguration(y=>{y.affectsConfiguration("http.electronFetch")&&(h=o.getConfiguration("http").get("electronFetch",$))}));const l=R("electron");globalThis.fetch=async function(t,n){function i(f){return n&&f in n?n[f]:typeof t=="object"&&"cache"in t?t[f]:void 0}const p=typeof t=="string"?t:"cache"in t?t.url:t.toString(),s=p.startsWith("data:");s&&C(e,"data");const d=p.startsWith("blob:");d&&C(e,"blob");const g=i("redirect")==="manual";g&&C(e,"manualRedirect");const a=i("integrity");if(a&&C(e,"integrity"),!h||s||d||g||a){const f=await u(t,n);return M(e,f,p),f}if(n?.headers){const f=new Headers(n.headers);for(const x of K)f.delete(x);n={...n,headers:f}}const m=t instanceof URL?t.toString():t,b=await l.net.fetch(m,n);return M(e,b,p),b}}}function M(o,e,c){const r=e.url;Object.defineProperty(e,"url",{get(){return C(o,"url"),r||c}});const u=e.type;Object.defineProperty(e,"type",{get(){return C(o,"typeProperty"),u!=="default"?u:"basic"}})}const D={url:0,typeProperty:0,data:0,blob:0,integrity:0,manualRedirect:0};let I;function C(o,e){D[e]++||(I&&clearTimeout(I),I=setTimeout(()=>{o.$publicLog2("fetchFeatureUse",D)},1e4),I.unref())}function O(o,e){function c(r,u){return Object.assign(r.default||r,u)}return{http:c(k,E(o,k,e)),https:c(v,E(o,v,e)),net:c(S,N(o,S)),tls:c(T,H(o,T))}}function q(o){const e=o.getConfiguration("http");return!e.get("experimental.systemCertificatesV2",w)&&!!e.get("systemCertificates")}function L(o){const e=o.getConfiguration("http");return!!e.get("experimental.systemCertificatesV2",w)&&!!e.get("systemCertificates")}const U=new Map;function G(o,e){return o.getExtensionPathIndex().then(c=>{const r=R("module"),u=r._load;r._load=function(l,y,t){if(l==="net")return e.net;if(l==="tls")return e.tls;if(l!=="http"&&l!=="https")return u.apply(this,arguments);const n=c.findSubstr(B.file(y.filename));let i=U.get(n);if(i||U.set(n,i={}),!i[l]){const p=e[l];i[l]={...p}}return i[l]}})}async function J(o,e,c,r,u,h,l,y,t,n,i){const p=u[t];n&&(u[t]=n),e.trace("ProxyResolver#lookupProxyAuthorization callback",`proxyURL:${t}`,`proxyAuthenticate:${n}`,`proxyAuthenticateCache:${p}`);const s=n||p,d=Array.isArray(s)?s:typeof s=="string"?[s]:[];if(Q(c,d,l),d.some(a=>/^(Negotiate|Kerberos)( |$)/i.test(a))&&!i.kerberosRequested){i.kerberosRequested=!0;try{const a=await import("kerberos"),m=new URL(t),b=r.getConfiguration("http").get("proxyKerberosServicePrincipal")||(process.platform==="win32"?`HTTP/${m.hostname}`:`HTTP@${m.hostname}`);return e.debug("ProxyResolver#lookupProxyAuthorization Kerberos authentication lookup",`proxyURL:${t}`,`spn:${b}`),"Negotiate "+await(await a.initializeClient(b)).step("")}catch(a){e.debug("ProxyResolver#lookupProxyAuthorization Kerberos authentication failed",a)}if(l&&y){e.debug("ProxyResolver#lookupProxyAuthorization Kerberos authentication lookup on host",`proxyURL:${t}`);const a=await o.lookupKerberosAuthorization(t);if(a)return"Negotiate "+a}}const g=d.find(a=>/^Basic( |$)/i.test(a));if(g)try{const a=h[t];if(a)if(i.basicAuthCacheUsed)e.debug("ProxyResolver#lookupProxyAuthorization Basic authentication deleting cached credentials",`proxyURL:${t}`),delete h[t];else return e.debug("ProxyResolver#lookupProxyAuthorization Basic authentication using cached credentials",`proxyURL:${t}`),i.basicAuthCacheUsed=!0,a;i.basicAuthAttempt=(i.basicAuthAttempt||0)+1;const m=/ realm="([^"]+)"/i.exec(g)?.[1];e.debug("ProxyResolver#lookupProxyAuthorization Basic authentication lookup",`proxyURL:${t}`,`realm:${m}`);const b=new URL(t),f={scheme:"basic",host:b.hostname,port:Number(b.port),realm:m||"",isProxy:!0,attempt:i.basicAuthAttempt},x=await o.lookupAuthorization(f);if(x){e.debug("ProxyResolver#lookupProxyAuthorization Basic authentication received credentials",`proxyURL:${t}`,`realm:${m}`);const F="Basic "+Buffer.from(`${x.username}:${x.password}`).toString("base64");return h[t]=F,F}else e.debug("ProxyResolver#lookupProxyAuthorization Basic authentication received no credentials",`proxyURL:${t}`,`realm:${m}`)}catch(a){e.error("ProxyResolver#lookupProxyAuthorization Basic authentication failed",a)}}let z=!1;function Q(o,e,c){z||!e.length||(z=!0,o.$publicLog2("proxyAuthenticationRequest",{authenticationType:e.map(r=>r.split(" ")[0]).join(","),extensionHostType:c?"remote":"local"}))}export{xe as connectProxyResolver};
