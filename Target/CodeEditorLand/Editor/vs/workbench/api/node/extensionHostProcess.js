import*as _ from"net";import v from"minimist";import"native-watchdog";import{ProcessTimeRunOnceScheduler as k}from"../../../../vs/base/common/async.js";import{VSBuffer as P}from"../../../../vs/base/common/buffer.js";import{isCancellationError as C,isSigPipeError as D,onUnexpectedError as E}from"../../../../vs/base/common/errors.js";import"../../../../vs/base/common/event.js";import"../../../../vs/base/common/lifecycle.js";import*as x from"vs/base/common/performance";import"../../../../vs/base/common/uriIpc.js";import{realpath as b}from"../../../../vs/base/node/extpath.js";import{Promises as O}from"../../../../vs/base/node/pfs.js";import"../../../../vs/base/parts/ipc/common/ipc.js";import{BufferedEmitter as S,PersistentProtocol as M,ProtocolConstants as w}from"../../../../vs/base/parts/ipc/common/ipc.net.js";import{NodeSocket as h,WebSocketNodeSocket as N}from"../../../../vs/base/parts/ipc/node/ipc.net.js";import{boolean as U}from"../../../../vs/editor/common/config/editorOptions.js";import L from"../../../../vs/platform/product/common/product.js";import{ExtensionHostMain as A}from"../../../../vs/workbench/api/common/extensionHostMain.js";import"../../../../vs/workbench/api/common/extHostExtensionService.js";import{createURITransformer as V}from"../../../../vs/workbench/api/node/uriTransformer.js";import{ExtHostConnectionType as H,readExtHostConnection as B}from"../../../../vs/workbench/services/extensions/common/extensionHostEnv.js";import{createMessageOfType as T,ExtensionHostExitCode as W,isMessageOfType as $,MessageType as y}from"../../../../vs/workbench/services/extensions/common/extensionHostProtocol.js";import"../../../../vs/workbench/api/common/extHost.common.services.js";import"../../../../vs/workbench/api/node/extHost.node.services.js";(function(){for(let e=0;e<process.execArgv.length;e++)process.execArgv[e]==="--inspect-port=0"&&(process.execArgv.splice(e,1),e--)})();const f=v(process.argv.slice(2),{boolean:["transformURIs","skipWorkspaceStorageLock"],string:["useHostProxy"]});(function(){const o=globalThis._VSCODE_NODE_MODULES.module,e=o._load;o._load=function(i){if(i==="natives")throw new Error('Either the extension or an NPM dependency is using the [unsupported "natives" node module](https://go.microsoft.com/fwlink/?linkid=871887).');return e.apply(this,arguments)}})();const u=process.exit.bind(process),G=process.on.bind(process);function j(o){process.exit=function(e){if(o)u(e);else{const i=new Error("An extension called process.exit() and this was prevented.");console.warn(i.stack)}},process.crash=function(){const e=new Error("An extension called process.crash() and this was prevented.");console.warn(e.stack)},process.env.ELECTRON_RUN_AS_NODE="1",process.on=function(e,i){e==="uncaughtException"&&(i=function(){try{return i.call(void 0,arguments)}catch{}}),G(e,i)}}let p=function(o){u()};function F(){const o=B(process.env);if(o.type===H.MessagePort)return new Promise((e,i)=>{const t=s=>{const c=s[0],m=new S;c.on("message",n=>m.fire(P.wrap(n.data))),c.on("close",()=>{p("renderer closed the MessagePort")}),c.start(),e({onMessage:m.event,send:n=>c.postMessage(n.buffer)})};process.parentPort.on("message",s=>t(s.ports))});if(o.type===H.Socket)return new Promise((e,i)=>{let t=null;const s=setTimeout(()=>{p("VSCODE_EXTHOST_IPC_SOCKET timeout")},6e4),c=w.ReconnectionGraceTime,m=w.ReconnectionShortGraceTime,n=new k(()=>p("renderer disconnected for too long (1)"),c),r=new k(()=>p("renderer disconnected for too long (2)"),m);process.on("message",(d,g)=>{if(d&&d.type==="VSCODE_EXTHOST_IPC_SOCKET"){g.setNoDelay(!0);const I=P.wrap(Buffer.from(d.initialDataChunk,"base64"));let l;if(d.skipWebSocketFrames)l=new h(g,"extHost-socket");else{const R=P.wrap(Buffer.from(d.inflateBytes,"base64"));l=new N(new h(g,"extHost-socket"),d.permessageDeflate,R,!1)}t?(n.cancel(),r.cancel(),t.beginAcceptReconnection(l,I),t.endAcceptReconnection(),t.sendResume()):(clearTimeout(s),t=new M({socket:l,initialChunk:I}),t.sendResume(),t.onDidDispose(()=>p("renderer disconnected")),e(t),t.onSocketClose(()=>{n.schedule()}))}if(d&&d.type==="VSCODE_EXTHOST_IPC_REDUCE_GRACE_TIME"){if(r.isScheduled())return;n.isScheduled()&&r.schedule()}});const a={type:"VSCODE_EXTHOST_IPC_READY"};process.send?.(a)});{const e=o.pipeName;return new Promise((i,t)=>{const s=_.createConnection(e,()=>{s.removeListener("error",t);const c=new M({socket:new h(s,"extHost-renderer")});c.sendResume(),i(c)});s.once("error",t),s.on("close",()=>{p("renderer closed the socket")})})}}async function X(){const o=await F();return new class{_onMessage=new S;onMessage=this._onMessage.event;_terminating;_protocolListener;constructor(){this._terminating=!1,this._protocolListener=o.onMessage(e=>{$(e,y.Terminate)?(this._terminating=!0,this._protocolListener.dispose(),p("received terminate message from renderer")):this._onMessage.fire(e)})}send(e){this._terminating||o.send(e)}async drain(){if(o.drain)return o.drain()}}}function K(o){return new Promise(e=>{const i=o.onMessage(t=>{i.dispose();const s=JSON.parse(t.toString()),c=s.commit,m=L.commit;if(c&&m&&c!==m&&u(W.VersionMismatch),s.parentPid){let n=0;setInterval(function(){try{process.kill(s.parentPid,0),n=0}catch(a){a&&a.code==="EPERM"?(n++,n>=3&&p(`parent process ${s.parentPid} does not exist anymore (3 x EPERM): ${a.message} (code: ${a.code}) (errno: ${a.errno})`)):p(`parent process ${s.parentPid} does not exist anymore: ${a.message} (code: ${a.code}) (errno: ${a.errno})`)}},1e3);let r;try{r=globalThis._VSCODE_NODE_MODULES["native-watchdog"],r.start(s.parentPid)}catch(a){E(a)}}o.send(T(y.Initialized)),e({protocol:o,initData:s})});o.send(T(y.Ready))})}async function q(){const o=[];process.on("unhandledRejection",(n,r)=>{o.push(r),setTimeout(()=>{const a=o.indexOf(r);a>=0&&r.catch(d=>{o.splice(a,1),C(d)||(console.warn(`rejected promise not handled within 1 second: ${d}`),d&&d.stack&&console.warn(`stack trace: ${d.stack}`),n&&E(n))})},1e3)}),process.on("rejectionHandled",n=>{const r=o.indexOf(n);r>=0&&o.splice(r,1)}),process.on("uncaughtException",function(n){D(n)||E(n)}),x.mark("code/extHost/willConnectToRenderer");const e=await X();x.mark("code/extHost/didConnectToRenderer");const i=await K(e);x.mark("code/extHost/didWaitForInitData");const{initData:t}=i;j(!!t.environment.extensionTestsLocationURI),t.environment.useHostProxy=f.useHostProxy!==void 0?f.useHostProxy!=="false":void 0,t.environment.skipWorkspaceStorageLock=U(f.skipWorkspaceStorageLock,!1);const s=new class{pid=process.pid;exit(r){u(r)}fsExists(r){return O.exists(r)}fsRealpath(r){return b(r)}};let c=null;t.remote.authority&&f.transformURIs&&(c=V(t.remote.authority));const m=new A(i.protocol,t,s,c);p=n=>m.terminate(n)}q().catch(o=>console.log(o));
