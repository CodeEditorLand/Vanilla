var E=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var x=(u,d,r,e)=>{for(var t=e>1?void 0:e?w(d,r):d,s=u.length-1,o;s>=0;s--)(o=u[s])&&(t=(e?o(d,r,t):o(t))||t);return e&&t&&E(d,r,t),t},a=(u,d)=>(r,e)=>d(r,e,u);import*as I from"../../../base/common/path.js";import{URI as k}from"../../../base/common/uri.js";import{win32 as v}from"../../../base/node/processes.js";import"../common/extHostTypes.js";import{IExtHostWorkspace as g}from"../common/extHostWorkspace.js";import"../common/shared/tasks.js";import{IExtHostDocumentsAndEditors as y}from"../common/extHostDocumentsAndEditors.js";import{IExtHostConfiguration as b}from"../common/extHostConfiguration.js";import{WorkspaceFolder as D}from"../../../platform/workspace/common/workspace.js";import"../../../platform/extensions/common/extensions.js";import{IExtHostTerminalService as H}from"../common/extHostTerminalService.js";import{IExtHostRpcService as S}from"../common/extHostRpcService.js";import{IExtHostInitDataService as O}from"../common/extHostInitDataService.js";import{ExtHostTaskBase as P,TaskHandleDTO as A,TaskDTO as h,CustomExecutionDTO as T}from"../common/extHostTask.js";import{Schemas as f}from"../../../base/common/network.js";import{ILogService as _}from"../../../platform/log/common/log.js";import{IExtHostApiDeprecationService as $}from"../common/extHostApiDeprecationService.js";import*as F from"../../../base/common/resources.js";import{homedir as W}from"os";import{IExtHostVariableResolverProvider as R}from"../common/extHostVariableResolverService.js";let l=class extends P{constructor(r,e,t,s,o,i,n,p,c){super(r,e,t,s,o,i,n,p);this.workspaceService=t;this.variableResolver=c;e.remote.isRemote&&e.remote.authority?this.registerTaskSystem(f.vscodeRemote,{scheme:f.vscodeRemote,authority:e.remote.authority,platform:process.platform}):this.registerTaskSystem(f.file,{scheme:f.file,authority:"",platform:process.platform}),this._proxy.$registerSupportedExecutions(!0,!0,!0)}async executeTask(r,e){const t=e;if(!e.execution&&t._id===void 0)throw new Error("Tasks to execute must include an execution");if(t._id!==void 0){const s=A.from(t,this.workspaceService),o=await this._proxy.$getTaskExecution(s);if(o.task===void 0)throw new Error("Task from execution DTO is undefined");const i=await this.getTaskExecution(o,e);return this._proxy.$executeTask(s).catch(()=>{}),i}else{const s=h.from(e,r);if(s===void 0)return Promise.reject(new Error("Task is not valid"));T.is(s.execution)&&await this.addCustomExecution(s,e,!1);const o=await this.getTaskExecution(await this._proxy.$getTaskExecution(s),e);return this._proxy.$executeTask(s).catch(()=>{}),o}}provideTasksInternal(r,e,t,s){const o=[];if(s)for(const i of s){this.checkDeprecation(i,t),(!i.definition||!r[i.definition.type])&&this._logService.warn(`The task [${i.source}, ${i.name}] uses an undefined task type. The task will be ignored in the future.`);const n=h.from(i,t.extension);n&&(o.push(n),T.is(n.execution)&&e.push(this.addCustomExecution(n,i,!0)))}return{tasks:o,extension:t.extension}}async resolveTaskInternal(r){return r}async getAFolder(r){let e=r&&r.length>0?r[0]:void 0;if(!e){const t=k.file(W());e=new D({uri:t,name:F.basename(t),index:0})}return{uri:e.uri,name:e.name,index:e.index,toResource:()=>{throw new Error("Not implemented")}}}async $resolveVariables(r,e){const t=k.revive(r),s={process:void 0,variables:Object.create(null)},o=await this._workspaceProvider.resolveWorkspaceFolder(t),i=await this._workspaceProvider.getWorkspaceFolders2()??[],n=await this.variableResolver.getResolver(),p=o?{uri:o.uri,name:o.name,index:o.index,toResource:()=>{throw new Error("Not implemented")}}:await this.getAFolder(i);for(const c of e.variables)s.variables[c]=await n.resolveAsync(p,c);if(e.process!==void 0){let c;if(e.process.path!==void 0){c=e.process.path.split(I.delimiter);for(let m=0;m<c.length;m++)c[m]=await n.resolveAsync(p,c[m])}s.process=await v.findExecutable(await n.resolveAsync(p,e.process.name),e.process.cwd!==void 0?await n.resolveAsync(p,e.process.cwd):void 0,c)}return s}async $jsonTasksSupported(){return!0}async $findExecutable(r,e,t){return v.findExecutable(r,e,t)}};l=x([a(0,S),a(1,O),a(2,g),a(3,y),a(4,b),a(5,H),a(6,_),a(7,$),a(8,R)],l);export{l as ExtHostTask};
