import{timeout as g}from"../../../base/common/async.js";import{URI as h}from"../../../base/common/uri.js";import{createApiFactoryAndRegisterActors as w}from"../common/extHost.api.impl.js";import{AbstractExtHostExtensionService as _}from"../common/extHostExtensionService.js";import{RequireInterceptor as E}from"../common/extHostRequireInterceptor.js";import{ExtensionRuntime as v}from"../common/extHostTypes.js";import{ExtHostConsoleForwarder as y}from"./extHostConsoleForwarder.js";class $ extends E{_installInterceptor(){}getModule(e,o){for(const n of this._alternatives){const t=n(e);if(t){e=t;break}}if(this._factories.has(e))return this._factories.get(e).load(e,o,()=>{throw new Error("CANNOT LOAD MODULE from here.")})}}class F extends _{extensionRuntime=v.Webworker;_fakeModules;async _beforeAlmostReadyToRunExtensions(){this._instaService.createInstance(y);const e=this._instaService.invokeFunction(w);this._fakeModules=this._instaService.createInstance($,e,{mine:this._myRegistry,all:this._globalRegistry}),await this._fakeModules.install(),performance.mark("code/extHost/didInitAPI"),await this._waitForDebuggerAttachment()}_getEntryPoint(e){return e.browser}async _loadCommonJSModule(e,o,n){o=o.with({path:I(o.path,".js")});const t=e?.identifier.value;t&&performance.mark(`code/extHost/willFetchExtensionCode/${t}`);const m=h.revive(await this._mainThreadExtensionsProxy.$asBrowserUri(o)),a=await fetch(m.toString(!0));if(t&&performance.mark(`code/extHost/didFetchExtensionCode/${t}`),a.status!==200)throw new Error(a.statusText);const u=await a.text(),f=`${o.toString(!0)}#vscode-extension`,p=`${u}
//# sourceURL=${f}`;let d;try{d=new Function("module","exports","require",p)}catch(s){throw s}e&&await this._extHostLocalizationService.initializeLocalizedMessages(e);const i={},c={exports:i},x=s=>{const l=this._fakeModules.getModule(s,o);if(l===void 0)throw new Error(`Cannot load module '${s}'`);return l};try{return n.codeLoadingStart(),t&&performance.mark(`code/extHost/willLoadExtensionCode/${t}`),d(c,i,x),c.exports!==i?c.exports:i}finally{t&&performance.mark(`code/extHost/didLoadExtensionCode/${t}`),n.codeLoadingStop()}}async $setRemoteEnvironment(e){}async _waitForDebuggerAttachment(e=5e3){if(!this._initData.environment.isExtensionDevelopmentDebug)return;const o=Date.now()+e;for(;Date.now()<o&&!("__jsDebugIsReady"in globalThis);)await g(10)}}function I(r,e){return r.endsWith(e)?r:r+e}export{F as ExtHostExtensionService};
