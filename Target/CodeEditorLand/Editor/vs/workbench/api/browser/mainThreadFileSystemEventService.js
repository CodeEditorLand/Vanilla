var P=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var K=(l,e,i)=>e in l?P(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i;var R=(l,e,i,p)=>{for(var m=p>1?void 0:p?H(e,i):e,w=l.length-1,r;w>=0;w--)(r=l[w])&&(m=(p?r(e,i,m):r(m))||m);return p&&m&&P(e,i,m),m},c=(l,e)=>(i,p)=>e(i,p,l);var b=(l,e,i)=>K(l,typeof e!="symbol"?e+"":e,i);import{raceCancellation as V}from"../../../base/common/async.js";import{CancellationTokenSource as q}from"../../../base/common/cancellation.js";import{GLOBSTAR as G}from"../../../base/common/glob.js";import{DisposableMap as Y,DisposableStore as $}from"../../../base/common/lifecycle.js";import W from"../../../base/common/severity.js";import{rtrim as z}from"../../../base/common/strings.js";import{URI as j}from"../../../base/common/uri.js";import{IBulkEditService as J}from"../../../editor/browser/services/bulkEditService.js";import{localize as t}from"../../../nls.js";import{Action2 as Q,registerAction2 as X}from"../../../platform/actions/common/actions.js";import{IConfigurationService as Z}from"../../../platform/configuration/common/configuration.js";import{IDialogService as ee}from"../../../platform/dialogs/common/dialogs.js";import{IEnvironmentService as te}from"../../../platform/environment/common/environment.js";import{FileOperation as d,IFileService as ie}from"../../../platform/files/common/files.js";import{normalizeWatcherPattern as ne}from"../../../platform/files/common/watcher.js";import{ILogService as D}from"../../../platform/log/common/log.js";import{IProgressService as re,ProgressLocation as oe}from"../../../platform/progress/common/progress.js";import{IStorageService as N,StorageScope as C,StorageTarget as ae}from"../../../platform/storage/common/storage.js";import{IUriIdentityService as se}from"../../../platform/uriIdentity/common/uriIdentity.js";import{IWorkspaceContextService as ce}from"../../../platform/workspace/common/workspace.js";import{extHostNamedCustomer as le}from"../../services/extensions/common/extHostCustomers.js";import{IWorkingCopyFileService as pe}from"../../services/workingCopy/common/workingCopyFileService.js";import{ExtHostContext as me,MainContext as de}from"../common/extHost.protocol.js";import{reviveWorkspaceEditDto as he}from"./mainThreadBulkEdits.js";let u=class{constructor(e,i,p,m,w,r,n,h,x,s,g,F,fe){this._fileService=i;this._contextService=g;this._logService=F;this._configurationService=fe;this._proxy=e.getProxy(me.ExtHostFileSystemEventService),this._listener.add(i.onDidFilesChange(f=>{this._proxy.$onFileEvent({created:f.rawAdded,changed:f.rawUpdated,deleted:f.rawDeleted})}));const A=this,T=new class{async participate(f,v,_,E,L){if(_?.isUndoing)return;const k=new q(L),U=setTimeout(()=>k.cancel(),E),o=await w.withProgress({location:oe.Notification,title:this._progressLabel(v),cancellable:!0,delay:Math.min(E/2,3e3)},()=>{const a=A._proxy.$onWillRunFileOperation(v,f,E,k.token);return V(a,k.token)},()=>{k.cancel()}).finally(()=>{k.dispose(),clearTimeout(U)});if(!o||o.edit.edits.length===0)return;const M=o.edit.edits.some(a=>a.metadata?.needsConfirmation);let y=n.getBoolean(u.MementoKeyAdditionalEdits,C.PROFILE);if(x.extensionTestsLocationURI&&(y=!1),y===void 0){let a;if(o.extensionNames.length===1?v===d.CREATE?a=t("ask.1.create","Extension '{0}' wants to make refactoring changes with this file creation",o.extensionNames[0]):v===d.COPY?a=t("ask.1.copy","Extension '{0}' wants to make refactoring changes with this file copy",o.extensionNames[0]):v===d.MOVE?a=t("ask.1.move","Extension '{0}' wants to make refactoring changes with this file move",o.extensionNames[0]):a=t("ask.1.delete","Extension '{0}' wants to make refactoring changes with this file deletion",o.extensionNames[0]):v===d.CREATE?a=t({key:"ask.N.create",comment:['{0} is a number, e.g "3 extensions want..."']},"{0} extensions want to make refactoring changes with this file creation",o.extensionNames.length):v===d.COPY?a=t({key:"ask.N.copy",comment:['{0} is a number, e.g "3 extensions want..."']},"{0} extensions want to make refactoring changes with this file copy",o.extensionNames.length):v===d.MOVE?a=t({key:"ask.N.move",comment:['{0} is a number, e.g "3 extensions want..."']},"{0} extensions want to make refactoring changes with this file move",o.extensionNames.length):a=t({key:"ask.N.delete",comment:['{0} is a number, e.g "3 extensions want..."']},"{0} extensions want to make refactoring changes with this file deletion",o.extensionNames.length),M){const{confirmed:I}=await r.confirm({type:W.Info,message:a,primaryButton:t("preview","Show &&Preview"),cancelButton:t("cancel","Skip Changes")});if(y=!0,!I)return}else{let I;(S=>(S[S.OK=0]="OK",S[S.Preview=1]="Preview",S[S.Cancel=2]="Cancel"))(I||={});const{result:O,checkboxChecked:B}=await r.prompt({type:W.Info,message:a,buttons:[{label:t({key:"ok",comment:["&& denotes a mnemonic"]},"&&OK"),run:()=>0},{label:t({key:"preview",comment:["&& denotes a mnemonic"]},"Show &&Preview"),run:()=>1}],cancelButton:{label:t("cancel","Skip Changes"),run:()=>2},checkbox:{label:t("again","Do not ask me again")}});if(O===2)return;y=O===1,B&&n.store(u.MementoKeyAdditionalEdits,y,C.PROFILE,ae.USER)}}h.info("[onWill-handler] applying additional workspace edit from extensions",o.extensionNames),await m.apply(he(o.edit,s),{undoRedoGroupId:_?.undoRedoGroupId,showPreview:y})}_progressLabel(f){switch(f){case d.CREATE:return t("msg-create","Running 'File Create' participants...");case d.MOVE:return t("msg-rename","Running 'File Rename' participants...");case d.COPY:return t("msg-copy","Running 'File Copy' participants...");case d.DELETE:return t("msg-delete","Running 'File Delete' participants...");case d.WRITE:return t("msg-write","Running 'File Write' participants...")}}};this._listener.add(p.addFileOperationParticipant(T)),this._listener.add(p.onDidRunWorkingCopyFileOperation(f=>this._proxy.$onDidRunFileOperation(f.operation,f.files)))}_proxy;_listener=new $;_watches=new Y;async $watch(e,i,p,m,w){const r=j.revive(p),n={...m};if(n.recursive)try{(await this._fileService.stat(r)).isDirectory||(n.recursive=!1)}catch{}if(w){this._logService.trace(`MainThreadFileSystemEventService#$watch(): request to start watching correlated (extension: ${e}, path: ${r.toString(!0)}, recursive: ${n.recursive}, session: ${i})`);const h=new $,x=h.add(this._fileService.createWatcher(r,n));h.add(x.onDidChange(s=>{this._proxy.$onFileEvent({session:i,created:s.rawAdded,changed:s.rawUpdated,deleted:s.rawDeleted})})),this._watches.set(i,h)}else{this._logService.trace(`MainThreadFileSystemEventService#$watch(): request to start watching uncorrelated (extension: ${e}, path: ${r.toString(!0)}, recursive: ${n.recursive}, session: ${i})`);const h=this._contextService.getWorkspaceFolder(r);if(n.recursive&&n.excludes.length===0){const s=this._configurationService.getValue();if(s.files?.watcherExclude)for(const g in s.files.watcherExclude)g&&s.files.watcherExclude[g]===!0&&n.excludes.push(g)}else if(!n.recursive&&h){const s=this._configurationService.getValue();if(s.files?.watcherExclude){for(const g in s.files.watcherExclude)if(g&&s.files.watcherExclude[g]===!0){n.includes||(n.includes=[]);const F=`${z(g,"/")}/${G}`;n.includes.push(ne(h.uri.fsPath,F))}}if(!n.includes||n.includes.length===0){this._logService.trace(`MainThreadFileSystemEventService#$watch(): ignoring request to start watching because path is inside workspace and no excludes are configured (extension: ${e}, path: ${r.toString(!0)}, recursive: ${n.recursive}, session: ${i})`);return}}const x=this._fileService.watch(r,n);this._watches.set(i,x)}}$unwatch(e){this._watches.has(e)&&(this._logService.trace(`MainThreadFileSystemEventService#$unwatch(): request to stop watching (session: ${e})`),this._watches.deleteAndDispose(e))}dispose(){this._listener.dispose(),this._watches.dispose()}};b(u,"MementoKeyAdditionalEdits","file.particpants.additionalEdits"),u=R([le(de.MainThreadFileSystemEventService),c(1,ie),c(2,pe),c(3,J),c(4,re),c(5,ee),c(6,N),c(7,D),c(8,te),c(9,se),c(10,ce),c(11,D),c(12,Z)],u),X(class extends Q{constructor(){super({id:"files.participants.resetChoice",title:{value:t("label","Reset choice for 'File operation needs preview'"),original:"Reset choice for 'File operation needs preview'"},f1:!0})}run(e){e.get(N).remove(u.MementoKeyAdditionalEdits,C.PROFILE)}});export{u as MainThreadFileSystemEventService};
