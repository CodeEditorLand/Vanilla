import{equals as E}from"../../../base/common/arrays.js";import{Emitter as g}from"../../../base/common/event.js";import{DisposableStore as f}from"../../../base/common/lifecycle.js";import"../../../editor/browser/editorBrowser.js";import{cursorStyleToString as b,EditorOption as _,RenderLineNumbersType as a,TextEditorCursorStyle as I}from"../../../editor/common/config/editorOptions.js";import"../../../editor/common/core/editOperation.js";import{Range as h}from"../../../editor/common/core/range.js";import{Selection as S}from"../../../editor/common/core/selection.js";import{ScrollType as c}from"../../../editor/common/editorCommon.js";import"../../../editor/common/model.js";import"../../../editor/common/services/model.js";import{CodeEditorStateFlag as m,EditorState as v}from"../../../editor/contrib/editorState/browser/editorState.js";import{SnippetController2 as T}from"../../../editor/contrib/snippet/browser/snippetController2.js";import{SnippetParser as C}from"../../../editor/contrib/snippet/browser/snippetParser.js";import"../../../editor/contrib/snippet/browser/snippetSession.js";import"../../../platform/clipboard/common/clipboardService.js";import"../../common/editor.js";import{TextEditorRevealType as p}from"../common/extHost.protocol.js";import"./mainThreadDocuments.js";class n{constructor(e,t,i){this.selections=e;this.options=t;this.visibleRanges=i}static readFromEditor(e,t,i){const o=n._readSelectionsFromCodeEditor(e,i),r=n._readOptionsFromCodeEditor(e,t,i),s=n._readVisibleRangesFromCodeEditor(e,i);return new n(o,r,s)}static _readSelectionsFromCodeEditor(e,t){let i=null;return t&&(i=t.getSelections()),!i&&e&&(i=e.selections),i||(i=[new S(1,1,1,1)]),i}static _readOptionsFromCodeEditor(e,t,i){if(t.isDisposed()){if(e)return e.options;throw new Error("No valid properties")}let o,r;if(i){const d=i.getOptions(),l=d.get(_.lineNumbers);o=d.get(_.cursorStyle),r=l.renderType}else e?(o=e.options.cursorStyle,r=e.options.lineNumbers):(o=I.Line,r=a.On);const s=t.getOptions();return{insertSpaces:s.insertSpaces,tabSize:s.tabSize,indentSize:s.indentSize,originalIndentSize:s.originalIndentSize,cursorStyle:o,lineNumbers:r}}static _readVisibleRangesFromCodeEditor(e,t){return t?t.getVisibleRanges():[]}generateDelta(e,t){const i={options:null,selections:null,visibleRanges:null};return(!e||!n._selectionsEqual(e.selections,this.selections))&&(i.selections={selections:this.selections,source:t??void 0}),(!e||!n._optionsEqual(e.options,this.options))&&(i.options=this.options),(!e||!n._rangesEqual(e.visibleRanges,this.visibleRanges))&&(i.visibleRanges=this.visibleRanges),i.selections||i.options||i.visibleRanges?i:null}static _selectionsEqual(e,t){return E(e,t,(i,o)=>i.equalsSelection(o))}static _rangesEqual(e,t){return E(e,t,(i,o)=>i.equalsRange(o))}static _optionsEqual(e,t){return e&&!t||!e&&t?!1:!e&&!t?!0:e.tabSize===t.tabSize&&e.indentSize===t.indentSize&&e.insertSpaces===t.insertSpaces&&e.cursorStyle===t.cursorStyle&&e.lineNumbers===t.lineNumbers}}class ae{_id;_model;_mainThreadDocuments;_modelService;_clipboardService;_modelListeners=new f;_codeEditor;_focusTracker;_codeEditorListeners=new f;_properties;_onPropertiesChanged;constructor(e,t,i,o,r,s,d){this._id=e,this._model=t,this._codeEditor=null,this._properties=null,this._focusTracker=o,this._mainThreadDocuments=r,this._modelService=s,this._clipboardService=d,this._onPropertiesChanged=new g,this._modelListeners.add(this._model.onDidChangeOptions(l=>{this._updatePropertiesNow(null)})),this.setCodeEditor(i),this._updatePropertiesNow(null)}dispose(){this._modelListeners.dispose(),this._codeEditor=null,this._codeEditorListeners.dispose()}_updatePropertiesNow(e){this._setProperties(n.readFromEditor(this._properties,this._model,this._codeEditor),e)}_setProperties(e,t){const i=e.generateDelta(this._properties,t);this._properties=e,i&&this._onPropertiesChanged.fire(i)}getId(){return this._id}getModel(){return this._model}getCodeEditor(){return this._codeEditor}hasCodeEditor(e){return this._codeEditor===e}setCodeEditor(e){if(!this.hasCodeEditor(e)&&(this._codeEditorListeners.clear(),this._codeEditor=e,this._codeEditor)){this._codeEditorListeners.add(this._codeEditor.onDidChangeModel(()=>{this.setCodeEditor(null)})),this._codeEditorListeners.add(this._codeEditor.onDidFocusEditorWidget(()=>{this._focusTracker.onGainedFocus()})),this._codeEditorListeners.add(this._codeEditor.onDidBlurEditorWidget(()=>{this._focusTracker.onLostFocus()}));let t=null;this._codeEditorListeners.add(this._mainThreadDocuments.onIsCaughtUpWithContentChanges(r=>{if(r.toString()===this._model.uri.toString()){const s=t;t=null,this._updatePropertiesNow(s)}}));const i=()=>this._codeEditor&&this._codeEditor.getModel()===this._model,o=r=>{this._mainThreadDocuments.isCaughtUpWithContentChanges(this._model.uri)?(t=null,this._updatePropertiesNow(r)):t=r};this._codeEditorListeners.add(this._codeEditor.onDidChangeCursorSelection(r=>{i()&&o(r.source)})),this._codeEditorListeners.add(this._codeEditor.onDidChangeConfiguration(r=>{i()&&o(null)})),this._codeEditorListeners.add(this._codeEditor.onDidLayoutChange(()=>{i()&&o(null)})),this._codeEditorListeners.add(this._codeEditor.onDidScrollChange(()=>{i()&&o(null)})),this._updatePropertiesNow(null)}}isVisible(){return!!this._codeEditor}getProperties(){return this._properties}get onPropertiesChanged(){return this._onPropertiesChanged.event}setSelections(e){if(this._codeEditor){this._codeEditor.setSelections(e);return}const t=e.map(S.liftSelection);this._setProperties(new n(t,this._properties.options,this._properties.visibleRanges),null)}_setIndentConfiguration(e){const t=this._modelService.getCreationOptions(this._model.getLanguageId(),this._model.uri,this._model.isForSimpleWidget);if(e.tabSize==="auto"||e.insertSpaces==="auto"){let o=t.insertSpaces,r=t.tabSize;e.insertSpaces!=="auto"&&typeof e.insertSpaces<"u"&&(o=e.insertSpaces),e.tabSize!=="auto"&&typeof e.tabSize<"u"&&(r=e.tabSize),this._model.detectIndentation(o,r);return}const i={};typeof e.insertSpaces<"u"&&(i.insertSpaces=e.insertSpaces),typeof e.tabSize<"u"&&(i.tabSize=e.tabSize),typeof e.indentSize<"u"&&(i.indentSize=e.indentSize),this._model.updateOptions(i)}setConfiguration(e){if(this._setIndentConfiguration(e),!!this._codeEditor){if(e.cursorStyle){const t=b(e.cursorStyle);this._codeEditor.updateOptions({cursorStyle:t})}if(typeof e.lineNumbers<"u"){let t;switch(e.lineNumbers){case a.On:t="on";break;case a.Relative:t="relative";break;case a.Interval:t="interval";break;default:t="off"}this._codeEditor.updateOptions({lineNumbers:t})}}}setDecorations(e,t){this._codeEditor&&this._codeEditor.setDecorationsByType("exthost-api",e,t)}setDecorationsFast(e,t){if(!this._codeEditor)return;const i=[];for(let o=0,r=Math.floor(t.length/4);o<r;o++)i[o]=new h(t[4*o],t[4*o+1],t[4*o+2],t[4*o+3]);this._codeEditor.setDecorationsByTypeFast(e,i)}revealRange(e,t){if(this._codeEditor)switch(t){case p.Default:this._codeEditor.revealRange(e,c.Smooth);break;case p.InCenter:this._codeEditor.revealRangeInCenter(e,c.Smooth);break;case p.InCenterIfOutsideViewport:this._codeEditor.revealRangeInCenterIfOutsideViewport(e,c.Smooth);break;case p.AtTop:this._codeEditor.revealRangeAtTop(e,c.Smooth);break;default:console.warn(`Unknown revealType: ${t}`);break}}isFocused(){return this._codeEditor?this._codeEditor.hasTextFocus():!1}matches(e){return e?e.getControl()===this._codeEditor:!1}applyEdits(e,t,i){if(this._model.getVersionId()!==e||!this._codeEditor)return!1;typeof i.setEndOfLine<"u"&&this._model.pushEOL(i.setEndOfLine);const o=t.map(r=>({range:h.lift(r.range),text:r.text,forceMoveMarkers:r.forceMoveMarkers}));return i.undoStopBefore&&this._codeEditor.pushUndoStop(),this._codeEditor.executeEdits("MainThreadTextEditor",o),i.undoStopAfter&&this._codeEditor.pushUndoStop(),!0}async insertSnippet(e,t,i,o){if(!this._codeEditor||!this._codeEditor.hasModel())return!1;let r;if(C.guessNeedsClipboard(t)){const u=new v(this._codeEditor,m.Value|m.Position);if(r=await this._clipboardService.readText(),!u.validate(this._codeEditor))return!1}if(this._codeEditor.getModel().getVersionId()!==e)return!1;const d=T.get(this._codeEditor);if(!d)return!1;this._codeEditor.focus();const l=i.map(u=>({range:h.lift(u),template:t}));return d.apply(l,{overwriteBefore:0,overwriteAfter:0,undoStopBefore:o.undoStopBefore,undoStopAfter:o.undoStopAfter,clipboardText:r}),!0}}export{ae as MainThreadTextEditor,n as MainThreadTextEditorProperties};
