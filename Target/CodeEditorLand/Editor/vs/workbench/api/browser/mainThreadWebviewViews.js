var h=Object.defineProperty;var g=Object.getOwnPropertyDescriptor;var c=(w,r,i,e)=>{for(var t=e>1?void 0:e?g(r,i):r,s=w.length-1,a;s>=0;s--)(a=w[s])&&(t=(e?a(r,i,t):a(t))||t);return e&&t&&h(r,i,t),t},l=(w,r)=>(i,e)=>r(i,e,w);import{onUnexpectedError as x}from"../../../base/common/errors.js";import{Disposable as V,DisposableMap as p}from"../../../base/common/lifecycle.js";import{generateUuid as W}from"../../../base/common/uuid.js";import{ITelemetryService as f}from"../../../platform/telemetry/common/telemetry.js";import{IWebviewViewService as u}from"../../contrib/webviewView/browser/webviewViewService.js";import*as y from"../common/extHost.protocol.js";import{reviveWebviewExtension as _}from"./mainThreadWebviews.js";let d=class extends V{constructor(i,e,t,s){super();this.mainThreadWebviews=e;this._telemetryService=t;this._webviewViewService=s;this._proxy=i.getProxy(y.ExtHostContext.ExtHostWebviewViews)}_proxy;_webviewViews=this._register(new p);_webviewViewProviders=this._register(new p);$setWebviewViewTitle(i,e){const t=this.getWebviewView(i);t.title=e}$setWebviewViewDescription(i,e){const t=this.getWebviewView(i);t.description=e}$setWebviewViewBadge(i,e){const t=this.getWebviewView(i);t.badge=e}$show(i,e){this.getWebviewView(i).show(e)}$registerWebviewViewProvider(i,e,t){if(this._webviewViewProviders.has(e))throw new Error(`View provider for ${e} already registered`);const s=_(i),a=this._webviewViewService.register(e,{resolve:async(o,m)=>{const n=W();this._webviewViews.set(n,o),this.mainThreadWebviews.addWebview(n,o.webview,{serializeBuffersForPostMessage:t.serializeBuffersForPostMessage});let b;if(o.webview.state)try{b=JSON.parse(o.webview.state)}catch{}o.webview.extension=s,t&&(o.webview.options=t),o.onDidChangeVisibility(v=>{this._proxy.$onDidChangeWebviewViewVisibility(n,v)}),o.onDispose(()=>{this._proxy.$disposeWebviewView(n),this._webviewViews.deleteAndDispose(n)}),this._telemetryService.publicLog2("webviews:createWebviewView",{extensionId:s.id.value,id:e});try{await this._proxy.$resolveWebviewView(n,e,o.title,b,m)}catch(v){x(v),o.webview.setHtml(this.mainThreadWebviews.getWebviewResolvedFailedContent(e))}}});this._webviewViewProviders.set(e,a)}$unregisterWebviewViewProvider(i){if(!this._webviewViewProviders.has(i))throw new Error(`No view provider for ${i} registered`);this._webviewViewProviders.deleteAndDispose(i)}getWebviewView(i){const e=this._webviewViews.get(i);if(!e)throw new Error("unknown webview view");return e}};d=c([l(2,f),l(3,u)],d);export{d as MainThreadWebviewsViews};
