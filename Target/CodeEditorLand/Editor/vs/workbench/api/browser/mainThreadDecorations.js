var D=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var c=(n,e,o,t)=>{for(var r=t>1?void 0:t?f(e,o):e,i=n.length-1,s;i>=0;i--)(s=n[i])&&(r=(t?s(e,o,r):s(r))||r);return t&&r&&D(e,o,r),r},d=(n,e)=>(o,t)=>e(o,t,n);import{CancellationToken as x}from"../../../base/common/cancellation.js";import{Emitter as b}from"../../../base/common/event.js";import{dispose as u}from"../../../base/common/lifecycle.js";import{URI as y}from"../../../base/common/uri.js";import{IDecorationsService as q}from"../../services/decorations/common/decorations.js";import{extHostNamedCustomer as C}from"../../services/extensions/common/extHostCustomers.js";import{ExtHostContext as I,MainContext as g}from"../common/extHost.protocol.js";class w{constructor(e,o){this._proxy=e;this._handle=o}_idPool=0;_requests=new Map;_resolver=new Map;_timer;enqueue(e,o){const t=++this._idPool,r=new Promise(s=>{this._requests.set(t,{id:t,uri:e}),this._resolver.set(t,s),this._processQueue()}),i=o.onCancellationRequested(()=>{this._requests.delete(t),this._resolver.delete(t)});return r.finally(()=>i.dispose())}_processQueue(){typeof this._timer!="number"&&(this._timer=setTimeout(()=>{const e=this._requests,o=this._resolver;this._proxy.$provideDecorations(this._handle,[...e.values()],x.None).then(t=>{for(const[r,i]of o)i(t[r])}),this._requests=new Map,this._resolver=new Map,this._timer=void 0},0))}}let a=class{constructor(e,o){this._decorationsService=o;this._proxy=e.getProxy(I.ExtHostDecorations)}_provider=new Map;_proxy;dispose(){this._provider.forEach(e=>u(e)),this._provider.clear()}$registerDecorationProvider(e,o){const t=new b,r=new w(this._proxy,e),i=this._decorationsService.registerDecorationsProvider({label:o,onDidChange:t.event,provideDecorations:async(s,v)=>{const p=await r.enqueue(s,v);if(!p)return;const[m,l,h,_]=p;return{weight:10,bubble:m??!1,color:_?.id,tooltip:l,letter:h}}});this._provider.set(e,[t,i])}$onDidChange(e,o){const t=this._provider.get(e);if(t){const[r]=t;r.fire(o&&o.map(i=>y.revive(i)))}}$unregisterDecorationProvider(e){const o=this._provider.get(e);o&&(u(o),this._provider.delete(e))}};a=c([C(g.MainThreadDecorations),d(1,q)],a);export{a as MainThreadDecorations};
