var W=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var f=(p,e,r,i)=>{for(var t=i>1?void 0:i?x(e,r):e,o=p.length-1,s;o>=0;o--)(s=p[o])&&(t=(i?s(e,r,t):s(t))||t);return i&&t&&W(e,r,t),t},n=(p,e)=>(r,i)=>e(r,i,p);import{coalesce as T}from"../../../base/common/arrays.js";import{isCancellationError as g}from"../../../base/common/errors.js";import{DisposableStore as E}from"../../../base/common/lifecycle.js";import{revive as k}from"../../../base/common/marshalling.js";import{isNative as b}from"../../../base/common/platform.js";import{URI as d}from"../../../base/common/uri.js";import{localize as l}from"../../../nls.js";import{IEnvironmentService as P}from"../../../platform/environment/common/environment.js";import{IFileService as U}from"../../../platform/files/common/files.js";import{IInstantiationService as D}from"../../../platform/instantiation/common/instantiation.js";import{ILabelService as M}from"../../../platform/label/common/label.js";import{INotificationService as F}from"../../../platform/notification/common/notification.js";import{IRequestService as R}from"../../../platform/request/common/request.js";import{ICanonicalUriService as $}from"../../../platform/workspace/common/canonicalUri.js";import{IEditSessionIdentityService as q}from"../../../platform/workspace/common/editSessions.js";import{IWorkspaceContextService as A,WorkbenchState as w,isUntitledWorkspace as B}from"../../../platform/workspace/common/workspace.js";import{IWorkspaceTrustManagementService as H,IWorkspaceTrustRequestService as z}from"../../../platform/workspace/common/workspaceTrust.js";import{EditorResourceAccessor as O,SaveReason as Q,SideBySideEditor as I}from"../../common/editor.js";import{IEditorService as j}from"../../services/editor/common/editorService.js";import{extHostNamedCustomer as G}from"../../services/extensions/common/extHostCustomers.js";import{checkGlobFileExists as L}from"../../services/extensions/common/workspaceContains.js";import{QueryBuilder as Y}from"../../services/search/common/queryBuilder.js";import{ISearchService as K}from"../../services/search/common/search.js";import{IWorkspaceEditingService as X}from"../../services/workspaces/common/workspaceEditing.js";import{ExtHostContext as J,MainContext as N}from"../common/extHost.protocol.js";let v=class{constructor(e,r,i,t,o,s,a,u,S,m,y,c,_,V,Z){this._searchService=r;this._contextService=i;this._editSessionIdentityService=t;this._canonicalUriService=o;this._editorService=s;this._workspaceEditingService=a;this._notificationService=u;this._requestService=S;this._instantiationService=m;this._labelService=y;this._environmentService=c;this._workspaceTrustManagementService=V;this._workspaceTrustRequestService=Z;this._proxy=e.getProxy(J.ExtHostWorkspace);const h=this._contextService.getWorkspace();h.configuration&&!b&&!_.hasProvider(h.configuration)?this._proxy.$initializeWorkspace(this.getWorkspaceData(h),this.isWorkspaceTrusted()):this._contextService.getCompleteWorkspace().then(C=>this._proxy.$initializeWorkspace(this.getWorkspaceData(C),this.isWorkspaceTrusted())),this._contextService.onDidChangeWorkspaceFolders(this._onDidChangeWorkspace,this,this._toDispose),this._contextService.onDidChangeWorkbenchState(this._onDidChangeWorkspace,this,this._toDispose),this._workspaceTrustManagementService.onDidChangeTrust(this._onDidGrantWorkspaceTrust,this,this._toDispose)}_toDispose=new E;_activeCancelTokens=Object.create(null);_proxy;_queryBuilder=this._instantiationService.createInstance(Y);dispose(){this._toDispose.dispose();for(const e in this._activeCancelTokens)this._activeCancelTokens[e].cancel()}$updateWorkspaceFolders(e,r,i,t){const o=t.map(s=>({uri:d.revive(s.uri),name:s.name}));return this._notificationService.status(this.getStatusMessage(e,o.length,i),{hideAfter:10*1e3}),this._workspaceEditingService.updateFolders(r,i,o,!0)}getStatusMessage(e,r,i){let t;const o=r>0,s=i>0;return o&&!s?r===1?t=l("folderStatusMessageAddSingleFolder","Extension '{0}' added 1 folder to the workspace",e):t=l("folderStatusMessageAddMultipleFolders","Extension '{0}' added {1} folders to the workspace",e,r):s&&!o?i===1?t=l("folderStatusMessageRemoveSingleFolder","Extension '{0}' removed 1 folder from the workspace",e):t=l("folderStatusMessageRemoveMultipleFolders","Extension '{0}' removed {1} folders from the workspace",e,i):t=l("folderStatusChangeFolder","Extension '{0}' changed folders of the workspace",e),t}_onDidChangeWorkspace(){this._proxy.$acceptWorkspaceData(this.getWorkspaceData(this._contextService.getWorkspace()))}getWorkspaceData(e){return this._contextService.getWorkbenchState()===w.EMPTY?null:{configuration:e.configuration||void 0,isUntitled:e.configuration?B(e.configuration,this._environmentService):!1,folders:e.folders,id:e.id,name:this._labelService.getWorkspaceLabel(e),transient:e.transient}}$startFileSearch(e,r,i){const t=d.revive(e),o=this._contextService.getWorkspace(),s=this._queryBuilder.file(t?[t]:o.folders,k(r));return this._searchService.fileSearch(s,i).then(a=>a.results.map(u=>u.resource),a=>g(a)?null:Promise.reject(a))}$startTextSearch(e,r,i,t,o){const s=d.revive(r),a=this._contextService.getWorkspace(),u=s?[s]:a.folders.map(c=>c.uri),S=this._queryBuilder.text(e,u,k(i));S._reason="startTextSearch";const m=c=>{c.results&&this._proxy.$handleTextSearchResult(c,t)};return this._searchService.textSearch(S,o,m).then(c=>({limitHit:c.limitHit}),c=>g(c)?null:Promise.reject(c))}$checkExists(e,r,i){return this._instantiationService.invokeFunction(t=>L(t,e,r,i))}async $save(e,r){const i=d.revive(e),t=[...this._editorService.findEditors(i,{supportSideBySide:I.PRIMARY})],o=await this._editorService.save(t,{reason:Q.EXPLICIT,saveAs:r.saveAs,force:!r.saveAs});return this._saveResultToUris(o).at(0)}_saveResultToUris(e){return e.success?T(e.editors.map(r=>O.getCanonicalUri(r,{supportSideBySide:I.PRIMARY}))):[]}$saveAll(e){return this._editorService.saveAll({includeUntitled:e}).then(r=>r.success)}$resolveProxy(e){return this._requestService.resolveProxy(e)}$lookupAuthorization(e){return this._requestService.lookupAuthorization(e)}$lookupKerberosAuthorization(e){return this._requestService.lookupKerberosAuthorization(e)}$loadCertificates(){return this._requestService.loadCertificates()}$requestWorkspaceTrust(e){return this._workspaceTrustRequestService.requestWorkspaceTrust(e)}isWorkspaceTrusted(){return this._workspaceTrustManagementService.isWorkspaceTrusted()}_onDidGrantWorkspaceTrust(){this._proxy.$onDidGrantWorkspaceTrust()}registeredEditSessionProviders=new Map;$registerEditSessionIdentityProvider(e,r){const i=this._editSessionIdentityService.registerEditSessionIdentityProvider({scheme:r,getEditSessionIdentifier:async(t,o)=>this._proxy.$getEditSessionIdentifier(t.uri,o),provideEditSessionIdentityMatch:async(t,o,s,a)=>this._proxy.$provideEditSessionIdentityMatch(t.uri,o,s,a)});this.registeredEditSessionProviders.set(e,i),this._toDispose.add(i)}$unregisterEditSessionIdentityProvider(e){this.registeredEditSessionProviders.get(e)?.dispose(),this.registeredEditSessionProviders.delete(e)}registeredCanonicalUriProviders=new Map;$registerCanonicalUriProvider(e,r){const i=this._canonicalUriService.registerCanonicalUriProvider({scheme:r,provideCanonicalUri:async(t,o,s)=>{const a=await this._proxy.$provideCanonicalUri(t,o,s);return a&&d.revive(a)}});this.registeredCanonicalUriProviders.set(e,i),this._toDispose.add(i)}$unregisterCanonicalUriProvider(e){this.registeredCanonicalUriProviders.get(e)?.dispose(),this.registeredCanonicalUriProviders.delete(e)}};v=f([G(N.MainThreadWorkspace),n(1,K),n(2,A),n(3,q),n(4,$),n(5,j),n(6,X),n(7,F),n(8,R),n(9,D),n(10,M),n(11,P),n(12,U),n(13,H),n(14,z)],v);export{v as MainThreadWorkspace};
