var S=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var C=(d,e,t,n)=>{for(var i=n>1?void 0:n?R(e,t):e,r=d.length-1,a;r>=0;r--)(a=d[r])&&(i=(n?a(e,t,i):a(i))||i);return n&&i&&S(e,t,i),i},g=(d,e)=>(t,n)=>e(t,n,d);import{Codicon as w}from"../../../base/common/codicons.js";import{Emitter as l}from"../../../base/common/event.js";import{Disposable as D,DisposableStore as V}from"../../../base/common/lifecycle.js";import{MarshalledId as _}from"../../../base/common/marshallingIds.js";import{Schemas as v}from"../../../base/common/network.js";import{URI as x}from"../../../base/common/uri.js";import{Range as E}from"../../../editor/common/core/range.js";import*as M from"../../../editor/common/languages.js";import{localize as k}from"../../../nls.js";import{SyncDescriptor as f}from"../../../platform/instantiation/common/descriptors.js";import{Registry as b}from"../../../platform/registry/common/platform.js";import{registerIcon as H}from"../../../platform/theme/common/iconRegistry.js";import{IUriIdentityService as A}from"../../../platform/uriIdentity/common/uriIdentity.js";import{ViewPaneContainer as L}from"../../browser/parts/views/viewPaneContainer.js";import{IViewDescriptorService as P,ViewContainerLocation as q,Extensions as T}from"../../common/views.js";import{ICommentService as $}from"../../contrib/comments/browser/commentService.js";import{revealCommentThread as O}from"../../contrib/comments/browser/commentsController.js";import{COMMENTS_VIEW_ID as h,COMMENTS_VIEW_STORAGE_ID as U,COMMENTS_VIEW_TITLE as y}from"../../contrib/comments/browser/commentsTreeViewer.js";import{CommentsPanel as N}from"../../contrib/comments/browser/commentsView.js";import{IEditorService as F}from"../../services/editor/common/editorService.js";import{extHostNamedCustomer as W}from"../../services/extensions/common/extHostCustomers.js";import{IViewsService as j}from"../../services/views/common/viewsService.js";import{ExtHostContext as K,MainContext as B}from"../common/extHost.protocol.js";class J{constructor(e,t,n,i,r,a,o,m,s,p){this.commentThreadHandle=e;this.controllerHandle=t;this.extensionId=n;this.threadId=i;this.resource=r;this._range=a;this._canReply=m;this._isTemplate=s;this.editorId=p;this._isDisposed=!1,s?this.comments=[]:o&&(this._comments=o)}_input;get input(){return this._input}set input(e){this._input=e,this._onDidChangeInput.fire(e)}_onDidChangeInput=new l;get onDidChangeInput(){return this._onDidChangeInput.event}_label;get label(){return this._label}set label(e){this._label=e,this._onDidChangeLabel.fire(this._label)}_contextValue;get contextValue(){return this._contextValue}set contextValue(e){this._contextValue=e}_onDidChangeLabel=new l;onDidChangeLabel=this._onDidChangeLabel.event;_comments;get comments(){return this._comments}set comments(e){this._comments=e,this._onDidChangeComments.fire(this._comments)}_onDidChangeComments=new l;get onDidChangeComments(){return this._onDidChangeComments.event}set range(e){this._range=e}get range(){return this._range}_onDidChangeCanReply=new l;get onDidChangeCanReply(){return this._onDidChangeCanReply.event}set canReply(e){this._canReply=e,this._onDidChangeCanReply.fire(this._canReply)}get canReply(){return this._canReply}_collapsibleState;get collapsibleState(){return this._collapsibleState}set collapsibleState(e){e!==this._collapsibleState&&(this._collapsibleState=e,this._onDidChangeCollapsibleState.fire(this._collapsibleState))}_initialCollapsibleState;get initialCollapsibleState(){return this._initialCollapsibleState}set initialCollapsibleState(e){this._initialCollapsibleState=e,this.collapsibleState===void 0&&(this.collapsibleState=this.initialCollapsibleState),this._onDidChangeInitialCollapsibleState.fire(e)}_onDidChangeCollapsibleState=new l;onDidChangeCollapsibleState=this._onDidChangeCollapsibleState.event;_onDidChangeInitialCollapsibleState=new l;onDidChangeInitialCollapsibleState=this._onDidChangeInitialCollapsibleState.event;_isDisposed;get isDisposed(){return this._isDisposed}isDocumentCommentThread(){return this._range===void 0||E.isIRange(this._range)}_state;get state(){return this._state}set state(e){this._state=e,this._onDidChangeState.fire(this._state)}_applicability;get applicability(){return this._applicability}set applicability(e){this._applicability=e,this._onDidChangeApplicability.fire(e)}_onDidChangeApplicability=new l;onDidChangeApplicability=this._onDidChangeApplicability.event;get isTemplate(){return this._isTemplate}_onDidChangeState=new l;onDidChangeState=this._onDidChangeState.event;batchUpdate(e){const t=n=>Object.prototype.hasOwnProperty.call(e,n);t("range")&&(this._range=e.range),t("label")&&(this._label=e.label),t("contextValue")&&(this._contextValue=e.contextValue===null?void 0:e.contextValue),t("comments")&&(this.comments=e.comments),t("collapseState")&&(this.initialCollapsibleState=e.collapseState),t("canReply")&&(this.canReply=e.canReply),t("state")&&(this.state=e.state),t("applicability")&&(this.applicability=e.applicability),t("isTemplate")&&(this._isTemplate=e.isTemplate)}hasComments(){return!!this.comments&&this.comments.length>0}dispose(){this._isDisposed=!0,this._onDidChangeCollapsibleState.dispose(),this._onDidChangeComments.dispose(),this._onDidChangeInput.dispose(),this._onDidChangeLabel.dispose(),this._onDidChangeState.dispose()}toJSON(){return{$mid:_.CommentThread,commentControlHandle:this.controllerHandle,commentThreadHandle:this.commentThreadHandle}}}class z{constructor(e,t,n,i,r,a,o){this._proxy=e;this._commentService=t;this._handle=n;this._uniqueId=i;this._id=r;this._label=a;this._features=o}get handle(){return this._handle}get id(){return this._id}get contextValue(){return this._id}get proxy(){return this._proxy}get label(){return this._label}_reactions;get reactions(){return this._reactions}set reactions(e){this._reactions=e}get options(){return this._features.options}_threads=new Map;activeEditingCommentThread;get features(){return this._features}get owner(){return this._id}async setActiveCommentAndThread(e){return this._proxy.$setActiveComment(this._handle,e?{commentThreadHandle:e.thread.commentThreadHandle,uniqueIdInThread:e.comment?.uniqueIdInThread}:void 0)}updateFeatures(e){this._features=e}createCommentThread(e,t,n,i,r,a,o,m){const s=new J(t,this.handle,e,n,x.revive(i).toString(),r,a,!0,o,m);return this._threads.set(t,s),s.isDocumentCommentThread()?this._commentService.updateComments(this._uniqueId,{added:[s],removed:[],changed:[],pending:[]}):this._commentService.updateNotebookComments(this._uniqueId,{added:[s],removed:[],changed:[],pending:[]}),s}updateCommentThread(e,t,n,i){const r=this.getKnownThread(e);r.batchUpdate(i),r.isDocumentCommentThread()?this._commentService.updateComments(this._uniqueId,{added:[],removed:[],changed:[r],pending:[]}):this._commentService.updateNotebookComments(this._uniqueId,{added:[],removed:[],changed:[r],pending:[]})}deleteCommentThread(e){const t=this.getKnownThread(e);this._threads.delete(e),t.dispose(),t.isDocumentCommentThread()?this._commentService.updateComments(this._uniqueId,{added:[],removed:[t],changed:[],pending:[]}):this._commentService.updateNotebookComments(this._uniqueId,{added:[],removed:[t],changed:[],pending:[]})}deleteCommentThreadMain(e){this._threads.forEach(t=>{t.threadId===e&&this._proxy.$deleteCommentThread(this._handle,t.commentThreadHandle)})}updateInput(e){const t=this.activeEditingCommentThread;if(t&&t.input){const n=t.input;n.value=e,t.input=n}}updateCommentingRanges(e){this._commentService.updateCommentingRanges(this._uniqueId,e)}getKnownThread(e){const t=this._threads.get(e);if(!t)throw new Error("unknown thread");return t}async getDocumentComments(e,t){if(e.scheme===v.vscodeNotebookCell)return{uniqueOwner:this._uniqueId,label:this.label,threads:[],commentingRanges:{resource:e,ranges:[],fileComments:!1}};const n=[];for(const r of[...this._threads.keys()]){const a=this._threads.get(r);a.resource===e.toString()&&a.isDocumentCommentThread()&&n.push(a)}const i=await this._proxy.$provideCommentingRanges(this.handle,e,t);return{uniqueOwner:this._uniqueId,label:this.label,threads:n,commentingRanges:{resource:e,ranges:i?.ranges||[],fileComments:!!i?.fileComments}}}async getNotebookComments(e,t){if(e.scheme!==v.vscodeNotebookCell)return{uniqueOwner:this._uniqueId,label:this.label,threads:[]};const n=[];for(const i of[...this._threads.keys()]){const r=this._threads.get(i);r.resource===e.toString()&&(r.isDocumentCommentThread()||n.push(r))}return{uniqueOwner:this._uniqueId,label:this.label,threads:n}}async toggleReaction(e,t,n,i,r){return this._proxy.$toggleReaction(this._handle,t.commentThreadHandle,e,n,i)}getAllComments(){const e=[];for(const t of[...this._threads.keys()])e.push(this._threads.get(t));return e}createCommentThreadTemplate(e,t,n){return this._proxy.$createCommentThreadTemplate(this.handle,e,t,n)}async updateCommentThreadTemplate(e,t){await this._proxy.$updateCommentThreadTemplate(this.handle,e,t)}toJSON(){return{$mid:_.CommentController,handle:this.handle}}}const I=H("comments-view-icon",w.commentDiscussion,k("commentsViewIcon","View icon of the comments view."));let u=class extends D{constructor(t,n,i,r,a,o){super();this._commentService=n;this._viewsService=i;this._viewDescriptorService=r;this._uriIdentityService=a;this._editorService=o;this._proxy=t.getProxy(K.ExtHostComments),this._commentService.unregisterCommentController(),this._register(this._commentService.onDidChangeActiveEditingCommentThread(async m=>{const s=m.controllerHandle,p=this._commentControllers.get(s);p&&(this._activeEditingCommentThreadDisposables.clear(),this._activeEditingCommentThread=m,p.activeEditingCommentThread=this._activeEditingCommentThread)}))}_proxy;_handlers=new Map;_commentControllers=new Map;_activeEditingCommentThread;_activeEditingCommentThreadDisposables=this._register(new V);_openViewListener=null;$registerCommentController(t,n,i,r){const a=`${n}-${r}`;this._handlers.set(t,a);const o=new z(this._proxy,this._commentService,t,a,n,i,{});this._commentService.registerCommentController(a,o),this._commentControllers.set(t,o);const m=!!this._viewDescriptorService.getViewDescriptorById(h);m||this.registerView(m),this.registerViewListeners(m),this._commentService.setWorkspaceComments(String(t),[])}$unregisterCommentController(t){const n=this._handlers.get(t);this._handlers.delete(t),this._commentControllers.delete(t),typeof n=="string"&&this._commentService.unregisterCommentController(n)}$updateCommentControllerFeatures(t,n){const i=this._commentControllers.get(t);i&&i.updateFeatures(n)}$createCommentThread(t,n,i,r,a,o,m,s,p){const c=this._commentControllers.get(t);if(c)return c.createCommentThread(m.value,n,i,r,a,o,s,p)}$updateCommentThread(t,n,i,r,a){const o=this._commentControllers.get(t);if(o)return o.updateCommentThread(n,i,r,a)}$deleteCommentThread(t,n){const i=this._commentControllers.get(t);if(i)return i.deleteCommentThread(n)}$updateCommentingRanges(t,n){const i=this._commentControllers.get(t);i&&i.updateCommentingRanges(n)}async $revealCommentThread(t,n,i,r){const a=this._commentControllers.get(t);if(!a)return Promise.resolve();const o=a.getAllComments().find(s=>s.commentThreadHandle===n);if(!o||!o.isDocumentCommentThread())return Promise.resolve();const m=o.comments?.find(s=>s.uniqueIdInThread===i);O(this._commentService,this._editorService,this._uriIdentityService,o,m,r.focusReply,void 0,r.preserveFocus)}async $hideCommentThread(t,n){const i=this._commentControllers.get(t);if(!i)return Promise.resolve();const r=i.getAllComments().find(a=>a.commentThreadHandle===n);if(!r||!r.isDocumentCommentThread())return Promise.resolve();r.collapsibleState=M.CommentThreadCollapsibleState.Collapsed}registerView(t){if(!t){const n=b.as(T.ViewContainersRegistry).registerViewContainer({id:h,title:y,ctorDescriptor:new f(L,[h,{mergeViewWithContainerWhenSingleView:!0}]),storageId:U,hideIfEmpty:!0,icon:I,order:10},q.Panel);b.as(T.ViewsRegistry).registerViews([{id:h,name:y,canToggleVisibility:!1,ctorDescriptor:new f(N),canMoveView:!0,containerIcon:I,focusCommand:{id:"workbench.action.focusCommentsPanel"}}],n)}}setComments(){[...this._commentControllers.keys()].forEach(t=>{const n=this._commentControllers.get(t).getAllComments();if(n.length){const i=this.getHandler(t);this._commentService.setWorkspaceComments(i,n)}})}registerViewOpenedListener(){this._openViewListener||(this._openViewListener=this._viewsService.onDidChangeViewVisibility(t=>{t.id===h&&t.visible&&(this.setComments(),this._openViewListener&&(this._openViewListener.dispose(),this._openViewListener=null))}))}registerViewListeners(t){t||this.registerViewOpenedListener(),this._register(this._viewDescriptorService.onDidChangeContainer(n=>{n.views.find(i=>i.id===h)&&(this.setComments(),this.registerViewOpenedListener())})),this._register(this._viewDescriptorService.onDidChangeContainerLocation(n=>{const i=this._viewDescriptorService.getViewContainerByViewId(h);n.viewContainer.id===i?.id&&(this.setComments(),this.registerViewOpenedListener())}))}getHandler(t){if(!this._handlers.has(t))throw new Error("Unknown handler");return this._handlers.get(t)}};u=C([W(B.MainThreadComments),g(1,$),g(2,j),g(3,P),g(4,A),g(5,F)],u);export{z as MainThreadCommentController,J as MainThreadCommentThread,u as MainThreadComments};
