var h=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var d=(o,i,e,t)=>{for(var r=t>1?void 0:t?p(i,e):i,s=o.length-1,a;s>=0;s--)(a=o[s])&&(r=(t?a(i,e,r):a(r))||r);return t&&r&&h(i,e,r),r},n=(o,i)=>(e,t)=>i(e,t,o);import{SequencerByKey as v}from"../../../base/common/async.js";import{Disposable as m}from"../../../base/common/lifecycle.js";import{ILogService as l}from"../../../platform/log/common/log.js";import{ISecretStorageService as u}from"../../../platform/secrets/common/secrets.js";import{IBrowserWorkbenchEnvironmentService as w}from"../../services/environment/browser/environmentService.js";import{extHostNamedCustomer as f}from"../../services/extensions/common/extHostCustomers.js";import{ExtHostContext as y,MainContext as P}from"../common/extHost.protocol.js";let c=class extends m{constructor(e,t,r,s){super();this.secretStorageService=t;this.logService=r;this._proxy=e.getProxy(y.ExtHostSecretState),this._register(this.secretStorageService.onDidChangeSecret(a=>{try{const{extensionId:S,key:g}=this.parseKey(a);S&&g&&this._proxy.$onDidChangePassword({extensionId:S,key:g})}catch{}}))}_proxy;_sequencer=new v;$getPassword(e,t){return this.logService.trace(`[mainThreadSecretState] Getting password for ${e} extension: `,t),this._sequencer.queue(e,()=>this.doGetPassword(e,t))}async doGetPassword(e,t){const r=this.getKey(e,t),s=await this.secretStorageService.get(r);return this.logService.trace(`[mainThreadSecretState] ${s?"P":"No p"}assword found for: `,e,t),s}$setPassword(e,t,r){return this.logService.trace(`[mainThreadSecretState] Setting password for ${e} extension: `,t),this._sequencer.queue(e,()=>this.doSetPassword(e,t,r))}async doSetPassword(e,t,r){const s=this.getKey(e,t);await this.secretStorageService.set(s,r),this.logService.trace("[mainThreadSecretState] Password set for: ",e,t)}$deletePassword(e,t){return this.logService.trace(`[mainThreadSecretState] Deleting password for ${e} extension: `,t),this._sequencer.queue(e,()=>this.doDeletePassword(e,t))}async doDeletePassword(e,t){const r=this.getKey(e,t);await this.secretStorageService.delete(r),this.logService.trace("[mainThreadSecretState] Password deleted for: ",e,t)}getKey(e,t){return JSON.stringify({extensionId:e,key:t})}parseKey(e){return JSON.parse(e)}};c=d([f(P.MainThreadSecretState),n(1,u),n(2,l),n(3,w)],c);export{c as MainThreadSecretState};
