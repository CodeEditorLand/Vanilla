var v=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var c=(a,e,o,t)=>{for(var r=t>1?void 0:t?x(e,o):e,n=a.length-1,i;n>=0;n--)(i=a[n])&&(r=(t?i(e,o,r):i(r))||r);return t&&r&&v(e,o,r),r},s=(a,e)=>(o,t)=>e(o,t,a);import{IStorageService as h,StorageScope as m}from"../../../platform/storage/common/storage.js";import{MainContext as y,ExtHostContext as _}from"../common/extHost.protocol.js";import{extHostNamedCustomer as E}from"../../services/extensions/common/extHostCustomers.js";import{DisposableStore as l}from"../../../base/common/lifecycle.js";import{isWeb as p}from"../../../base/common/platform.js";import{IExtensionStorageService as d}from"../../../platform/extensionManagement/common/extensionStorage.js";import{migrateExtensionStorage as f}from"../../services/extensions/common/extensionStorageMigration.js";import{IInstantiationService as u}from"../../../platform/instantiation/common/instantiation.js";import{ILogService as w}from"../../../platform/log/common/log.js";let S=class{constructor(e,o,t,r,n){this._extensionStorageService=o;this._storageService=t;this._instantiationService=r;this._logService=n;this._proxy=e.getProxy(_.ExtHostStorage),this._storageListener.add(this._storageService.onDidChangeValue(m.PROFILE,void 0,this._storageListener)(i=>{if(this._sharedStorageKeysToWatch.has(i.key)){const g=this._extensionStorageService.getExtensionStateRaw(i.key,!0);typeof g=="string"&&this._proxy.$acceptValue(!0,i.key,g)}}))}_proxy;_storageListener=new l;_sharedStorageKeysToWatch=new Map;dispose(){this._storageListener.dispose()}async $initializeExtensionStorage(e,o){return await this.checkAndMigrateExtensionStorage(o,e),e&&this._sharedStorageKeysToWatch.set(o,!0),this._extensionStorageService.getExtensionStateRaw(o,e)}async $setValue(e,o,t){this._extensionStorageService.setExtensionState(o,t,e)}$registerExtensionStorageKeysToSync(e,o){this._extensionStorageService.setKeysForSync(e,o)}async checkAndMigrateExtensionStorage(e,o){try{let t=this._extensionStorageService.getSourceExtensionToMigrate(e);!t&&p&&e!==e.toLowerCase()&&(t=e.toLowerCase()),t&&(p&&t!==t.toLowerCase()&&this._extensionStorageService.getExtensionState(t.toLowerCase(),o)&&!this._extensionStorageService.getExtensionState(t,o)&&(t=t.toLowerCase()),await f(t,e,o,this._instantiationService))}catch(t){this._logService.error(t)}}};S=c([E(y.MainThreadStorage),s(1,d),s(2,h),s(3,u),s(4,w)],S);export{S as MainThreadStorage};
