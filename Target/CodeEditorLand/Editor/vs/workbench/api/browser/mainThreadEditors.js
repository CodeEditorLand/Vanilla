var f=Object.defineProperty;var g=Object.getOwnPropertyDescriptor;var m=(n,t,e,o)=>{for(var i=o>1?void 0:o?g(t,e):t,r=n.length-1,s;r>=0;r--)(s=n[r])&&(i=(o?s(t,e,i):s(i))||i);return o&&i&&f(t,e,i),i},p=(n,t)=>(e,o)=>t(e,o,n);import{illegalArgument as d}from"../../../../vs/base/common/errors.js";import{DisposableStore as l,dispose as u}from"../../../../vs/base/common/lifecycle.js";import{equals as h}from"../../../../vs/base/common/objects.js";import{URI as I}from"../../../../vs/base/common/uri.js";import{getCodeEditor as _}from"../../../../vs/editor/browser/editorBrowser.js";import{ICodeEditorService as S}from"../../../../vs/editor/browser/services/codeEditorService.js";import"../../../../vs/editor/common/core/editOperation.js";import"../../../../vs/editor/common/core/range.js";import"../../../../vs/editor/common/core/selection.js";import"../../../../vs/editor/common/diff/legacyLinesDiffComputer.js";import"../../../../vs/editor/common/editorCommon.js";import{CommandsRegistry as x}from"../../../../vs/platform/commands/common/commands.js";import{IConfigurationService as T}from"../../../../vs/platform/configuration/common/configuration.js";import{EditorActivation as D,EditorResolution as P}from"../../../../vs/platform/editor/common/editor.js";import{IEnvironmentService as C}from"../../../../vs/platform/environment/common/environment.js";import"../../../../vs/platform/extensions/common/extensions.js";import"../../../../vs/platform/instantiation/common/instantiation.js";import"../../../../vs/workbench/api/browser/mainThreadEditor.js";import{ExtHostContext as y}from"../../../../vs/workbench/api/common/extHost.protocol.js";import"../../../../vs/workbench/common/editor.js";import"../../../../vs/workbench/contrib/scm/browser/dirtydiffDecorator.js";import{columnToEditorGroup as v,editorGroupToColumn as b}from"../../../../vs/workbench/services/editor/common/editorGroupColumn.js";import{IEditorGroupsService as $}from"../../../../vs/workbench/services/editor/common/editorGroupsService.js";import{IEditorService as O}from"../../../../vs/workbench/services/editor/common/editorService.js";import"../../../../vs/workbench/services/extensions/common/extHostCustomers.js";import{IWorkingCopyService as L}from"../../../../vs/workbench/services/workingCopy/common/workingCopyService.js";let a=class{constructor(t,e,o,i,r,s){this._editorLocator=t;this._codeEditorService=o;this._editorService=i;this._editorGroupService=r;this._configurationService=s;this._instanceId=String(++a.INSTANCE_COUNT),this._proxy=e.getProxy(y.ExtHostEditors),this._textEditorsListenersMap=Object.create(null),this._editorPositionData=null,this._toDispose.add(this._editorService.onDidVisibleEditorsChange(()=>this._updateActiveAndVisibleTextEditors())),this._toDispose.add(this._editorGroupService.onDidRemoveGroup(()=>this._updateActiveAndVisibleTextEditors())),this._toDispose.add(this._editorGroupService.onDidMoveGroup(()=>this._updateActiveAndVisibleTextEditors())),this._registeredDecorationTypes=Object.create(null)}static INSTANCE_COUNT=0;_instanceId;_proxy;_toDispose=new l;_textEditorsListenersMap;_editorPositionData;_registeredDecorationTypes;dispose(){Object.keys(this._textEditorsListenersMap).forEach(t=>{u(this._textEditorsListenersMap[t])}),this._textEditorsListenersMap=Object.create(null),this._toDispose.dispose();for(const t in this._registeredDecorationTypes)this._codeEditorService.removeDecorationType(t);this._registeredDecorationTypes=Object.create(null)}handleTextEditorAdded(t){const e=t.getId(),o=[];o.push(t.onPropertiesChanged(i=>{this._proxy.$acceptEditorPropertiesChanged(e,i)})),this._textEditorsListenersMap[e]=o}handleTextEditorRemoved(t){u(this._textEditorsListenersMap[t]),delete this._textEditorsListenersMap[t]}_updateActiveAndVisibleTextEditors(){const t=this._getTextEditorPositionData();h(this._editorPositionData,t)||(this._editorPositionData=t,this._proxy.$acceptEditorPositionData(this._editorPositionData))}_getTextEditorPositionData(){const t=Object.create(null);for(const e of this._editorService.visibleEditorPanes){const o=this._editorLocator.findTextEditorIdFor(e);o&&(t[o]=b(this._editorGroupService,e.group))}return t}async $tryShowTextDocument(t,e){const o=I.revive(t),i={preserveFocus:e.preserveFocus,pinned:e.pinned,selection:e.selection,activation:e.preserveFocus?D.RESTORE:void 0,override:P.EXCLUSIVE_ONLY},r={resource:o,options:i},s=await this._editorService.openEditor(r,v(this._editorGroupService,this._configurationService,e.position));if(!s)return;const E=s.getControl(),c=_(E);return c?this._editorLocator.getIdOfCodeEditor(c):void 0}async $tryShowEditor(t,e){const o=this._editorLocator.getEditor(t);if(o){const i=o.getModel();await this._editorService.openEditor({resource:i.uri,options:{preserveFocus:!1}},v(this._editorGroupService,this._configurationService,e));return}}async $tryHideEditor(t){const e=this._editorLocator.getEditor(t);if(e){const o=this._editorService.visibleEditorPanes;for(const i of o)if(e.matches(i)){await i.group.closeEditor(i.input);return}}}$trySetSelections(t,e){const o=this._editorLocator.getEditor(t);return o?(o.setSelections(e),Promise.resolve(void 0)):Promise.reject(d(`TextEditor(${t})`))}$trySetDecorations(t,e,o){e=`${this._instanceId}-${e}`;const i=this._editorLocator.getEditor(t);return i?(i.setDecorations(e,o),Promise.resolve(void 0)):Promise.reject(d(`TextEditor(${t})`))}$trySetDecorationsFast(t,e,o){e=`${this._instanceId}-${e}`;const i=this._editorLocator.getEditor(t);return i?(i.setDecorationsFast(e,o),Promise.resolve(void 0)):Promise.reject(d(`TextEditor(${t})`))}$tryRevealRange(t,e,o){const i=this._editorLocator.getEditor(t);return i?(i.revealRange(e,o),Promise.resolve()):Promise.reject(d(`TextEditor(${t})`))}$trySetOptions(t,e){const o=this._editorLocator.getEditor(t);return o?(o.setConfiguration(e),Promise.resolve(void 0)):Promise.reject(d(`TextEditor(${t})`))}$tryApplyEdits(t,e,o,i){const r=this._editorLocator.getEditor(t);return r?Promise.resolve(r.applyEdits(e,o,i)):Promise.reject(d(`TextEditor(${t})`))}$tryInsertSnippet(t,e,o,i,r){const s=this._editorLocator.getEditor(t);return s?Promise.resolve(s.insertSnippet(e,o,i,r)):Promise.reject(d(`TextEditor(${t})`))}$registerTextEditorDecorationType(t,e,o){e=`${this._instanceId}-${e}`,this._registeredDecorationTypes[e]=!0,this._codeEditorService.registerDecorationType(`exthost-api-${t}`,e,o)}$removeTextEditorDecorationType(t){t=`${this._instanceId}-${t}`,delete this._registeredDecorationTypes[t],this._codeEditorService.removeDecorationType(t)}$getDiffInformation(t){const e=this._editorLocator.getEditor(t);if(!e)return Promise.reject(new Error("No such TextEditor"));const o=e.getCodeEditor();if(!o)return Promise.reject(new Error("No such CodeEditor"));const i=o.getId(),r=this._codeEditorService.listDiffEditors(),[s]=r.filter(c=>c.getOriginalEditor().getId()===i||c.getModifiedEditor().getId()===i);if(s)return Promise.resolve(s.getLineChanges()||[]);const E=o.getContribution("editor.contrib.dirtydiff");return E?Promise.resolve(E.getChanges()):Promise.resolve([])}};a=m([p(2,S),p(3,O),p(4,$),p(5,T)],a),x.registerCommand("_workbench.revertAllDirty",async function(n){if(!n.get(C).extensionTestsLocationURI)throw new Error("Command is only available when running extension tests.");const e=n.get(L);for(const o of e.dirtyWorkingCopies)await o.revert({soft:!0})});export{a as MainThreadTextEditors};
