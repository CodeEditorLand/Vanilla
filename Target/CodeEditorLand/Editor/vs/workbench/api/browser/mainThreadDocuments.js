var U=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var _=(l,i,e,t)=>{for(var o=t>1?void 0:t?R(i,e):i,n=l.length-1,r;n>=0;n--)(r=l[n])&&(o=(t?r(i,e,o):r(o))||o);return t&&o&&U(i,e,o),o},d=(l,i)=>(e,t)=>i(e,t,l);import{toErrorMessage as M}from"../../../base/common/errorMessage.js";import{dispose as m,Disposable as g}from"../../../base/common/lifecycle.js";import{Schemas as f}from"../../../base/common/network.js";import{URI as I}from"../../../base/common/uri.js";import{shouldSynchronizeModel as x}from"../../../editor/common/model.js";import{IModelService as w}from"../../../editor/common/services/model.js";import{ITextModelService as E}from"../../../editor/common/services/resolverService.js";import{IFileService as k,FileOperation as C}from"../../../platform/files/common/files.js";import{ExtHostContext as T}from"../common/extHost.protocol.js";import{ITextFileService as b}from"../../services/textfile/common/textfiles.js";import{IWorkbenchEnvironmentService as D}from"../../services/environment/common/environmentService.js";import{toLocalResource as F,extUri as W}from"../../../base/common/resources.js";import{IWorkingCopyFileService as $}from"../../services/workingCopy/common/workingCopyFileService.js";import{IUriIdentityService as P}from"../../../platform/uriIdentity/common/uriIdentity.js";import{Emitter as L,Event as H}from"../../../base/common/event.js";import{IPathService as V}from"../../services/path/common/pathService.js";import{ResourceMap as A}from"../../../base/common/map.js";import"../../services/extensions/common/extHostCustomers.js";import{ErrorNoTelemetry as h}from"../../../base/common/errors.js";class z{constructor(i,e=1e3*60*3,t=1024*1024*80,o=50){this._extUri=i;this._maxAge=e;this._maxLength=t;this._maxSize=o}_data=new Array;_length=0;dispose(){this._data=m(this._data)}remove(i){for(const e of[...this._data])this._extUri.isEqualOrParent(e.uri,i)&&e.dispose()}add(i,e,t=0){const o=()=>{const a=this._data.indexOf(r);a>=0&&(this._length-=t,e.dispose(),clearTimeout(n),this._data.splice(a,1))},n=setTimeout(o,this._maxAge),r={uri:i,length:t,dispose:o};this._data.push(r),this._length+=t,this._cleanup()}_cleanup(){for(;this._length>this._maxLength;)this._data[0].dispose();const i=Math.ceil(this._maxSize*1.2);this._data.length>=i&&m(this._data.slice(0,i-this._maxSize))}}class O extends g{constructor(e,t,o,n){super();this._model=e;this._onIsCaughtUpWithContentChanges=t;this._proxy=o;this._textFileService=n;this._knownVersionId=this._model.getVersionId(),this._store.add(this._model.onDidChangeContent(r=>{this._knownVersionId=r.versionId,this._proxy.$acceptModelChanged(this._model.uri,r,this._textFileService.isDirty(this._model.uri)),this.isCaughtUpWithContentChanges()&&this._onIsCaughtUpWithContentChanges.fire(this._model.uri)}))}_knownVersionId;isCaughtUpWithContentChanges(){return this._model.getVersionId()===this._knownVersionId}}let c=class extends g{constructor(e,t,o,n,r,a,y,S,B){super();this._modelService=t;this._textFileService=o;this._fileService=n;this._textModelResolverService=r;this._environmentService=a;this._uriIdentityService=y;this._pathService=B;this._modelReferenceCollection=this._store.add(new z(y.extUri)),this._proxy=e.getProxy(T.ExtHostDocuments),this._store.add(t.onModelLanguageChanged(this._onModelModeChanged,this)),this._store.add(o.files.onDidSave(s=>{this._shouldHandleFileEvent(s.model.resource)&&this._proxy.$acceptModelSaved(s.model.resource)})),this._store.add(o.files.onDidChangeDirty(s=>{this._shouldHandleFileEvent(s.resource)&&this._proxy.$acceptDirtyStateChanged(s.resource,s.isDirty())})),this._store.add(S.onDidRunWorkingCopyFileOperation(s=>{const p=s.operation===C.MOVE;if(p||s.operation===C.DELETE)for(const u of s.files){const v=p?u.source:u.target;v&&this._modelReferenceCollection.remove(v)}}))}_onIsCaughtUpWithContentChanges=this._store.add(new L);onIsCaughtUpWithContentChanges=this._onIsCaughtUpWithContentChanges.event;_proxy;_modelTrackers=new A;_modelReferenceCollection;dispose(){m(this._modelTrackers.values()),this._modelTrackers.clear(),super.dispose()}isCaughtUpWithContentChanges(e){const t=this._modelTrackers.get(e);return t?t.isCaughtUpWithContentChanges():!0}_shouldHandleFileEvent(e){const t=this._modelService.getModel(e);return!!t&&x(t)}handleModelAdded(e){x(e)&&this._modelTrackers.set(e.uri,new O(e,this._onIsCaughtUpWithContentChanges,this._proxy,this._textFileService))}_onModelModeChanged(e){const{model:t}=e;this._modelTrackers.has(t.uri)&&this._proxy.$acceptModelLanguageChanged(t.uri,t.getLanguageId())}handleModelRemoved(e){this._modelTrackers.has(e)&&(this._modelTrackers.get(e).dispose(),this._modelTrackers.delete(e))}async $trySaveDocument(e){return!!await this._textFileService.save(I.revive(e))}async $tryOpenDocument(e){const t=I.revive(e);if(!t.scheme||!(t.fsPath||t.authority))throw new h("Invalid uri. Scheme and authority or path must be set.");const o=this._uriIdentityService.asCanonicalUri(t);let n;switch(o.scheme){case f.untitled:n=this._handleUntitledScheme(o);break;case f.file:default:n=this._handleAsResourceInput(o);break}let r;try{r=await n}catch(a){throw new h(`cannot open ${o.toString()}. Detail: ${M(a)}`)}if(r)if(W.isEqual(r,o)){if(this._modelTrackers.has(o))return o;throw new h(`cannot open ${o.toString()}. Detail: Files above 50MB cannot be synchronized with extensions.`)}else throw new h(`cannot open ${o.toString()}. Detail: Actual document opened as ${r.toString()}`);else throw new h(`cannot open ${o.toString()}`)}$tryCreateDocument(e){return this._doCreateUntitled(void 0,e?e.language:void 0,e?e.content:void 0)}async _handleAsResourceInput(e){const t=await this._textModelResolverService.createModelReference(e);return this._modelReferenceCollection.add(e,t,t.object.textEditorModel.getValueLength()),t.object.textEditorModel.uri}async _handleUntitledScheme(e){const t=F(e,this._environmentService.remoteAuthority,this._pathService.defaultUriScheme);return await this._fileService.exists(t)?Promise.reject(new Error("file already exists")):await this._doCreateUntitled(e.path?e:void 0)}async _doCreateUntitled(e,t,o){const n=this._textFileService.untitled.create({associatedResource:e,languageId:t,initialValue:o}),r=n.resource,a=await this._textModelResolverService.createModelReference(r);if(!this._modelTrackers.has(r))throw a.dispose(),new Error(`expected URI ${r.toString()} to have come to LIFE`);return this._modelReferenceCollection.add(r,a,a.object.textEditorModel.getValueLength()),H.once(n.onDidRevert)(()=>this._modelReferenceCollection.remove(r)),this._proxy.$acceptDirtyStateChanged(r,!0),r}};c=_([d(1,w),d(2,b),d(3,k),d(4,E),d(5,D),d(6,P),d(7,$),d(8,V)],c);export{z as BoundModelReferenceCollection,c as MainThreadDocuments};
