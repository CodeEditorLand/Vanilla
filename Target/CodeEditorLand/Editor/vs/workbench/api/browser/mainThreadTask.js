var z=Object.defineProperty;var J=Object.getOwnPropertyDescriptor;var N=(c,a,t,e)=>{for(var o=e>1?void 0:e?J(a,t):a,n=c.length-1,r;n>=0;n--)(r=c[n])&&(o=(e?r(a,t,o):r(o))||o);return e&&o&&z(a,t,o),o},b=(c,a)=>(t,e)=>a(t,e,c);import*as X from"../../../nls.js";import{Disposable as Y}from"../../../base/common/lifecycle.js";import*as g from"../../../base/common/platform.js";import*as T from"../../../base/common/types.js";import{URI as P}from"../../../base/common/uri.js";import{generateUuid as Z}from"../../../base/common/uuid.js";import{IWorkspaceContextService as ee}from"../../../platform/workspace/common/workspace.js";import{CommandOptions as _,ConfiguringTask as w,ContributedTask as v,CustomTask as oe,PresentationOptions as K,RunOptions as L,RuntimeType as k,TaskDefinition as ne,TaskEventKind as O,TaskScope as h,TaskSourceKind as W}from"../../contrib/tasks/common/tasks.js";import{ITaskService as te}from"../../contrib/tasks/common/taskService.js";import{ErrorNoTelemetry as re}from"../../../base/common/errors.js";import{IConfigurationResolverService as ie}from"../../services/configurationResolver/common/configurationResolver.js";import{extHostNamedCustomer as se}from"../../services/extensions/common/extHostCustomers.js";import{ExtHostContext as ae,MainContext as ce}from"../common/extHost.protocol.js";var $;(a=>{function c(t){return{id:t.id,task:u.from(t.task)}}a.from=c})($||={});var U;(a=>{function c(t,e){return{id:t.id,processId:e}}a.from=c})(U||={});var B;(a=>{function c(t,e){return{id:t.id,exitCode:e}}a.from=c})(B||={});var F;(t=>{function c(e){const o=Object.assign(Object.create(null),e);return delete o._key,o}t.from=c;function a(e,o){let n=ne.createTaskIdentifier(e,console);return n===void 0&&o&&(n={_key:Z(),type:"$executeOnly"}),n}t.to=a})(F||={});var R;(t=>{function c(e){if(e!=null)return Object.assign(Object.create(null),e)}t.from=c;function a(e){return e==null?K.defaults:Object.assign(Object.create(null),K.defaults,e)}t.to=a})(R||={});var H;(t=>{function c(e){if(e!=null)return Object.assign(Object.create(null),e)}t.from=c;function a(e){return e==null?L.defaults:Object.assign(Object.create(null),L.defaults,e)}t.to=a})(H||={});var M;(t=>{function c(e){if(e!=null)return{cwd:e.cwd,env:e.env}}t.from=c;function a(e){return e==null?_.defaults:{cwd:e.cwd||_.defaults.cwd,env:e.env}}t.to=a})(M||={});var S;(e=>{function c(o){const n=o;return n&&!!n.process}e.is=c;function a(o){const n=T.isString(o.name)?o.name:o.name.value,r=o.args?o.args.map(i=>T.isString(i)?i:i.value):[],s={process:n,args:r};return o.options&&(s.options=M.from(o.options)),s}e.from=a;function t(o){const n={runtime:k.Process,name:o.process,args:o.args,presentation:void 0};return n.options=M.to(o.options),n}e.to=t})(S||={});var j;(t=>{function c(e){if(e==null)return;const o={cwd:e.cwd||_.defaults.cwd,env:e.env};return e.shell&&(o.executable=e.shell.executable,o.shellArgs=e.shell.args,o.shellQuoting=e.shell.quoting),o}t.from=c;function a(e){if(e==null)return;const o={cwd:e.cwd,env:e.env};return e.executable&&(o.shell={executable:e.executable},e.shellArgs&&(o.shell.args=e.shellArgs),e.shellQuoting&&(o.shell.quoting=e.shellQuoting)),o}t.to=a})(j||={});var E;(e=>{function c(o){const n=o;return n&&(!!n.commandLine||!!n.command)}e.is=c;function a(o){const n={};return o.name&&T.isString(o.name)&&(o.args===void 0||o.args===null||o.args.length===0)?n.commandLine=o.name:(n.command=o.name,n.args=o.args),o.options&&(n.options=j.from(o.options)),n}e.from=a;function t(o){const n={runtime:k.Shell,name:o.commandLine?o.commandLine:o.command,args:o.args,presentation:void 0};return o.options&&(n.options=j.to(o.options)),n}e.to=t})(E||={});var x;(e=>{function c(o){const n=o;return n&&n.customExecution==="customExecution"}e.is=c;function a(o){return{customExecution:"customExecution"}}e.from=a;function t(o){return{runtime:k.CustomExecution,presentation:void 0}}e.to=t})(x||={});var A;(t=>{function c(e){const o={label:e.label};return e.kind===W.Extension?(o.extensionId=e.extension,e.workspaceFolder?o.scope=e.workspaceFolder.uri:o.scope=e.scope):e.kind===W.Workspace&&(o.extensionId="$core",o.scope=e.config.workspaceFolder?e.config.workspaceFolder.uri:h.Global),o}t.from=c;function a(e,o){let n,r;return e.scope===void 0||typeof e.scope=="number"&&e.scope!==h.Global?o.getWorkspace().folders.length===0?(n=h.Global,r=void 0):(n=h.Folder,r=o.getWorkspace().folders[0]):typeof e.scope=="number"?n=e.scope:(n=h.Folder,r=o.getWorkspaceFolder(P.revive(e.scope))??void 0),{kind:W.Extension,label:e.label,extension:e.extensionId,scope:n,workspaceFolder:r}}t.to=a})(A||={});var G;(a=>{function c(t){const e=t;return e&&T.isString(e.id)&&!!e.workspaceFolder}a.is=c})(G||={});var u;(t=>{function c(e){if(e==null||!oe.is(e)&&!v.is(e)&&!w.is(e))return;const o={_id:e._id,name:e.configurationProperties.name,definition:F.from(e.getDefinition(!0)),source:A.from(e._source),execution:void 0,presentationOptions:!w.is(e)&&e.command?R.from(e.command.presentation):void 0,isBackground:e.configurationProperties.isBackground,problemMatchers:[],hasDefinedMatchers:v.is(e)?e.hasDefinedMatchers:!1,runOptions:H.from(e.runOptions)};if(o.group=Q.from(e.configurationProperties.group),e.configurationProperties.detail&&(o.detail=e.configurationProperties.detail),!w.is(e)&&e.command)switch(e.command.runtime){case k.Process:o.execution=S.from(e.command);break;case k.Shell:o.execution=E.from(e.command);break;case k.CustomExecution:o.execution=x.from(e.command);break}if(e.configurationProperties.problemMatchers)for(const n of e.configurationProperties.problemMatchers)T.isString(n)&&o.problemMatchers.push(n);return o}t.from=c;function a(e,o,n,r,s){if(!e||typeof e.name!="string")return;let i;if(e.execution&&(E.is(e.execution)?i=E.to(e.execution):S.is(e.execution)?i=S.to(e.execution):x.is(e.execution)&&(i=x.to(e.execution))),!i)return;i.presentation=R.to(e.presentationOptions);const d=A.to(e.source,o),f=X.localize("task.label","{0}: {1}",d.label,e.name),p=F.to(e.definition,n),I=x.is(e.execution)&&e._id?e._id:`${e.source.extensionId}.${p._key}`;return new v(I,d,f,p.type,p,i,e.hasDefinedMatchers,H.to(e.runOptions),{name:e.name,identifier:f,group:e.group,isBackground:!!e.isBackground,problemMatchers:e.problemMatchers.slice(),detail:e.detail,icon:r,hide:s})}t.to=a})(u||={});var Q;(a=>{function c(t){if(t!==void 0)return{_id:typeof t=="string"?t:t._id,isDefault:typeof t=="string"||typeof t.isDefault=="string"?!1:t.isDefault}}a.from=c})(Q||={});var q;(t=>{function c(e){return e}t.from=c;function a(e){return e}t.to=a})(q||={});let y=class extends Y{constructor(t,e,o,n){super();this._taskService=e;this._workspaceContextServer=o;this._configurationResolverService=n;this._proxy=t.getProxy(ae.ExtHostTask),this._providers=new Map,this._register(this._taskService.onDidStateChange(async r=>{if(r.kind===O.Changed)return;const s=r.__task;if(r.kind===O.Start){const i=$.from(s.getTaskExecution());let d=i.task.definition;if(i.task?.execution&&x.is(i.task.execution)&&r.resolvedVariables){const f={};for(const[p,I]of r.resolvedVariables.entries())f[p]=I;d=await this._configurationResolverService.resolveAnyAsync(s.getWorkspaceFolder(),i.task.definition,f)}this._proxy.$onDidStartTask(i,r.terminalId,d)}else r.kind===O.ProcessStarted?this._proxy.$onDidStartTaskProcess(U.from(s.getTaskExecution(),r.processId)):r.kind===O.ProcessEnded?this._proxy.$onDidEndTaskProcess(B.from(s.getTaskExecution(),r.exitCode)):r.kind===O.End&&this._proxy.$OnDidEndTask($.from(s.getTaskExecution()))}))}_extHostContext;_proxy;_providers;dispose(){for(const t of this._providers.values())t.disposable.dispose();this._providers.clear(),super.dispose()}$createTaskId(t){return new Promise((e,o)=>{const n=u.to(t,this._workspaceContextServer,!0);n?e(n._id):o(new Error("Task could not be created from DTO"))})}$registerTaskProvider(t,e){const o={provideTasks:r=>Promise.resolve(this._proxy.$provideTasks(t,r)).then(s=>{const i=[];for(const d of s.tasks){const f=u.to(d,this._workspaceContextServer,!0);f&&i.push(f)}return{tasks:i,extension:s.extension}}),resolveTask:r=>{const s=u.from(r);return s?(s.name=s.name===void 0?"":s.name,Promise.resolve(this._proxy.$resolveTask(t,s)).then(i=>{if(i)return u.to(i,this._workspaceContextServer,!0,r.configurationProperties.icon,r.configurationProperties.hide)})):Promise.resolve(void 0)}},n=this._taskService.registerTaskProvider(o,e);return this._providers.set(t,{disposable:n,provider:o}),Promise.resolve(void 0)}$unregisterTaskProvider(t){const e=this._providers.get(t);return e&&(e.disposable.dispose(),this._providers.delete(t)),Promise.resolve(void 0)}$fetchTasks(t){return this._taskService.tasks(q.to(t)).then(e=>{const o=[];for(const n of e){const r=u.from(n);r&&o.push(r)}return o})}getWorkspace(t){let e;if(typeof t=="string")e=t;else{const o=this._workspaceContextServer.getWorkspace(),n=P.revive(t);o.configuration?.toString()===n.toString()?e=o:e=this._workspaceContextServer.getWorkspaceFolder(n)}return e}async $getTaskExecution(t){if(G.is(t)){const e=this.getWorkspace(t.workspaceFolder);if(e){const o=await this._taskService.getTask(e,t.id,!0);if(o)return{id:o._id,task:u.from(o)};throw new Error("Task not found")}else throw new Error("No workspace folder")}else{const e=u.to(t,this._workspaceContextServer,!0);return{id:e._id,task:u.from(e)}}}$executeTask(t){return new Promise((e,o)=>{if(G.is(t)){const n=this.getWorkspace(t.workspaceFolder);n?this._taskService.getTask(n,t.id,!0).then(r=>{if(r){const s={id:t.id,task:u.from(r)};this._taskService.run(r).then(i=>{(i?.exitCode===void 0||i.exitCode!==0)&&this._proxy.$OnDidEndTask(s)},i=>{}),e(s)}else o(new Error("Task not found"))},r=>{o(new Error("Task not found"))}):o(new Error("No workspace folder"))}else{const n=u.to(t,this._workspaceContextServer,!0);this._taskService.run(n).then(void 0,s=>{});const r={id:n._id,task:u.from(n)};e(r)}})}$customExecutionComplete(t,e){return new Promise((o,n)=>{this._taskService.getActiveTasks().then(r=>{for(const s of r)if(t===s._id){this._taskService.extensionCallbackTaskComplete(s,e).then(i=>{o(void 0)},i=>{n(i)});return}n(new Error("Task to mark as complete not found"))})})}$terminateTask(t){return new Promise((e,o)=>{this._taskService.getActiveTasks().then(n=>{for(const r of n)if(t===r._id){this._taskService.terminate(r).then(s=>{e(void 0)},s=>{o(void 0)});return}o(new re("Task to terminate not found"))})})}$registerTaskSystem(t,e){let o;switch(e.platform){case"Web":o=g.Platform.Web;break;case"win32":o=g.Platform.Windows;break;case"darwin":o=g.Platform.Mac;break;case"linux":o=g.Platform.Linux;break;default:o=g.platform}this._taskService.registerTaskSystem(t,{platform:o,uriProvider:n=>P.from({scheme:e.scheme,authority:e.authority,path:n}),context:this._extHostContext,resolveVariables:(n,r,s)=>{const i=[];return r.variables.forEach(d=>i.push(d)),Promise.resolve(this._proxy.$resolveVariables(n.uri,{process:r.process,variables:i})).then(d=>{const f=Array.from(Object.values(d.variables));return new Promise((p,I)=>{this._configurationResolverService.resolveWithInteraction(n,f,"tasks",void 0,s).then(l=>{l||p(void 0);const D={process:void 0,variables:new Map};for(let m=0;m<f.length;m++){const C=i[m].substring(2,i[m].length-1);if(l&&d.variables[i[m]]===i[m]){const V=l.get(C);typeof V=="string"&&D.variables.set(C,V)}else D.variables.set(C,f[m])}T.isString(d.process)&&(D.process=d.process),p(D)},l=>{I(l)})})})},findExecutable:(n,r,s)=>this._proxy.$findExecutable(n,r,s)})}async $registerSupportedExecutions(t,e,o){return this._taskService.registerSupportedExecutions(t,e,o)}};y=N([se(ce.MainThreadTask),b(1,te),b(2,ee),b(3,ie)],y);export{y as MainThreadTask};
