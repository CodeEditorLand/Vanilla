var k=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var v=(a,o,e,t)=>{for(var n=t>1?void 0:t?C(o,e):o,s=a.length-1,d;s>=0;s--)(d=a[s])&&(n=(t?d(o,e,n):d(n))||n);return t&&n&&k(o,e,n),n},u=(a,o)=>(e,t)=>o(e,t,a);import{DisposableStore as b,dispose as f}from"../../../base/common/lifecycle.js";import{ResourceMap as y}from"../../../base/common/map.js";import{URI as m}from"../../../base/common/uri.js";import{BoundModelReferenceCollection as D}from"./mainThreadDocuments.js";import"../../contrib/notebook/common/model/notebookTextModel.js";import{NotebookCellsChangeType as r}from"../../contrib/notebook/common/notebookCommon.js";import{INotebookEditorModelResolverService as E}from"../../contrib/notebook/common/notebookEditorModelResolverService.js";import{IUriIdentityService as x}from"../../../platform/uriIdentity/common/uriIdentity.js";import{ExtHostContext as _}from"../common/extHost.protocol.js";import{NotebookDto as l}from"./mainThreadNotebookDto.js";import{SerializableObjectWithBuffers as g}from"../../services/extensions/common/proxyIdentifier.js";import"../../services/extensions/common/extHostCustomers.js";let c=class{constructor(o,e,t){this._notebookEditorModelResolverService=e;this._uriIdentityService=t;this._proxy=o.getProxy(_.ExtHostNotebookDocuments),this._modelReferenceCollection=new D(this._uriIdentityService.extUri),this._disposables.add(this._notebookEditorModelResolverService.onDidChangeDirty(n=>this._proxy.$acceptDirtyStateChanged(n.resource,n.isDirty()))),this._disposables.add(this._notebookEditorModelResolverService.onDidSaveNotebook(n=>this._proxy.$acceptModelSaved(n))),this._disposables.add(e.onWillFailWithConflict(n=>{this._modelReferenceCollection.remove(n.resource)}))}_disposables=new b;_proxy;_documentEventListenersMapping=new y;_modelReferenceCollection;dispose(){this._disposables.dispose(),this._modelReferenceCollection.dispose(),f(this._documentEventListenersMapping.values())}handleNotebooksAdded(o){for(const e of o){const t=new b;t.add(e.onDidChangeContent(n=>{const s={versionId:n.versionId,rawEvents:[]};for(const i of n.rawEvents)switch(i.kind){case r.ModelChange:s.rawEvents.push({kind:i.kind,changes:i.changes.map(p=>[p[0],p[1],p[2].map(h=>l.toNotebookCellDto(h))])});break;case r.Move:s.rawEvents.push({kind:i.kind,index:i.index,length:i.length,newIdx:i.newIdx});break;case r.Output:s.rawEvents.push({kind:i.kind,index:i.index,outputs:i.outputs.map(l.toNotebookOutputDto)});break;case r.OutputItem:s.rawEvents.push({kind:i.kind,index:i.index,outputId:i.outputId,outputItems:i.outputItems.map(l.toNotebookOutputItemDto),append:i.append});break;case r.ChangeCellLanguage:case r.ChangeCellContent:case r.ChangeCellMetadata:case r.ChangeCellInternalMetadata:s.rawEvents.push(i);break}const d=n.rawEvents.find(i=>i.kind===r.ChangeDocumentMetadata);this._proxy.$acceptModelChanged(e.uri,new g(s),this._notebookEditorModelResolverService.isDirty(e.uri),d?e.metadata:void 0)})),this._documentEventListenersMapping.set(e.uri,t)}}handleNotebooksRemoved(o){for(const e of o)this._documentEventListenersMapping.get(e)?.dispose(),this._documentEventListenersMapping.delete(e)}async $tryCreateNotebook(o){if(o.content){const e=await this._notebookEditorModelResolverService.resolve({untitledResource:void 0},o.viewType);if(e.object.notebook.onWillDispose(()=>{e.dispose()}),this._proxy.$acceptDirtyStateChanged(e.object.resource,!0),o.content){const t=l.fromNotebookDataDto(o.content);e.object.notebook.reset(t.cells,t.metadata,e.object.notebook.transientOptions)}return e.object.notebook.uri}else return(await this._notebookEditorModelResolverService.createUntitledNotebookTextModel(o.viewType)).uri}async $tryOpenNotebook(o){const e=m.revive(o),t=await this._notebookEditorModelResolverService.resolve(e,void 0);return o.scheme==="untitled"&&t.object.notebook.onWillDispose(()=>{t.dispose()}),this._modelReferenceCollection.add(e,t),e}async $trySaveNotebook(o){const e=m.revive(o),t=await this._notebookEditorModelResolverService.resolve(e),n=await t.object.save();return t.dispose(),n}};c=v([u(1,E),u(2,x)],c);export{c as MainThreadNotebookDocuments};
