var l=Object.defineProperty;var m=Object.getOwnPropertyDescriptor;var c=(s,t,n,e)=>{for(var r=e>1?void 0:e?m(t,n):t,o=s.length-1,i;o>=0;o--)(i=s[o])&&(r=(e?i(t,n,r):i(r))||r);return e&&r&&l(t,n,r),r},d=(s,t)=>(n,e)=>t(n,e,s);import{CancellationTokenSource as v}from"../../../../vs/base/common/cancellation.js";import{onUnexpectedError as g}from"../../../../vs/base/common/errors.js";import{DisposableMap as u,dispose as x}from"../../../../vs/base/common/lifecycle.js";import{URI as S}from"../../../../vs/base/common/uri.js";import{EditOperation as h}from"../../../../vs/editor/common/core/editOperation.js";import{Range as C}from"../../../../vs/editor/common/core/range.js";import{ILanguageService as _}from"../../../../vs/editor/common/languages/language.js";import"../../../../vs/editor/common/model.js";import{IEditorWorkerService as f}from"../../../../vs/editor/common/services/editorWorker.js";import{IModelService as y}from"../../../../vs/editor/common/services/model.js";import{ITextModelService as M}from"../../../../vs/editor/common/services/resolverService.js";import{extHostNamedCustomer as I}from"../../../../vs/workbench/services/extensions/common/extHostCustomers.js";import{ExtHostContext as P,MainContext as T}from"../common/extHost.protocol.js";let p=class{constructor(t,n,e,r,o){this._textModelResolverService=n;this._languageService=e;this._modelService=r;this._editorWorkerService=o;this._proxy=t.getProxy(P.ExtHostDocumentContentProviders)}_resourceContentProvider=new u;_pendingUpdate=new Map;_proxy;dispose(){this._resourceContentProvider.dispose(),x(this._pendingUpdate.values())}$registerTextContentProvider(t,n){const e=this._textModelResolverService.registerTextModelContentProvider(n,{provideTextContent:r=>this._proxy.$provideTextDocumentContent(t,r).then(o=>{if(typeof o=="string"){const i=o.substr(0,1+o.search(/\r?\n/)),a=this._languageService.createByFilepathOrFirstLine(r,i);return this._modelService.createModel(o,a,r)}return null})});this._resourceContentProvider.set(t,e)}$unregisterTextContentProvider(t){this._resourceContentProvider.deleteAndDispose(t)}async $onVirtualDocumentChange(t,n){const e=this._modelService.getModel(S.revive(t));if(!e)return;this._pendingUpdate.get(e.id)?.cancel();const o=new v;this._pendingUpdate.set(e.id,o);try{const i=await this._editorWorkerService.computeMoreMinimalEdits(e.uri,[{text:n,range:e.getFullModelRange()}]);if(this._pendingUpdate.delete(e.id),o.token.isCancellationRequested)return;i&&i.length>0&&e.applyEdits(i.map(a=>h.replace(C.lift(a.range),a.text)))}catch(i){g(i)}}};p=c([I(T.MainThreadDocumentContentProviders),d(1,M),d(2,_),d(3,y),d(4,f)],p);export{p as MainThreadDocumentContentProviders};
