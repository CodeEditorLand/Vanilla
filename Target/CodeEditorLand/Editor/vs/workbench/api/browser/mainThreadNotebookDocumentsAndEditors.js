var b=Object.defineProperty;var u=Object.getOwnPropertyDescriptor;var l=(c,e,o,t)=>{for(var i=t>1?void 0:t?u(e,o):e,d=c.length-1,s;d>=0;d--)(s=c[d])&&(i=(t?s(e,o,i):s(i))||i);return t&&i&&b(e,o,i),i},n=(c,e)=>(o,t)=>e(o,t,c);import{diffMaps as E,diffSets as _}from"../../../base/common/collections.js";import{combinedDisposable as k,DisposableStore as D,DisposableMap as N}from"../../../base/common/lifecycle.js";import"../../../base/common/uri.js";import{IInstantiationService as S}from"../../../platform/instantiation/common/instantiation.js";import{ILogService as I}from"../../../platform/log/common/log.js";import{MainThreadNotebookDocuments as f}from"./mainThreadNotebookDocuments.js";import{NotebookDto as g}from"./mainThreadNotebookDto.js";import{MainThreadNotebookEditors as A}from"./mainThreadNotebookEditors.js";import{extHostCustomer as y}from"../../services/extensions/common/extHostCustomers.js";import{editorGroupToColumn as M}from"../../services/editor/common/editorGroupColumn.js";import{getNotebookEditorFromEditorPane as m}from"../../contrib/notebook/browser/notebookBrowser.js";import{INotebookEditorService as T}from"../../contrib/notebook/browser/services/notebookEditorService.js";import"../../contrib/notebook/common/model/notebookTextModel.js";import{INotebookService as w}from"../../contrib/notebook/common/notebookService.js";import{IEditorGroupsService as x}from"../../services/editor/common/editorGroupsService.js";import{IEditorService as R}from"../../services/editor/common/editorService.js";import{ExtHostContext as C,MainContext as p}from"../common/extHost.protocol.js";import{SerializableObjectWithBuffers as P}from"../../services/extensions/common/proxyIdentifier.js";class h{constructor(e,o,t,i){this.documents=e;this.textEditors=o;this.activeEditor=t;this.visibleEditors=i}static delta(e,o){if(!e)return{addedDocuments:[...o.documents],removedDocuments:[],addedEditors:[...o.textEditors.values()],removedEditors:[],visibleEditors:[...o.visibleEditors].map(r=>r[0])};const t=_(e.documents,o.documents),i=E(e.textEditors,o.textEditors),d=e.activeEditor!==o.activeEditor?o.activeEditor:void 0,s=E(e.visibleEditors,o.visibleEditors);return{addedDocuments:t.added,removedDocuments:t.removed.map(r=>r.uri),addedEditors:i.added,removedEditors:i.removed.map(r=>r.getId()),newActiveEditor:d,visibleEditors:s.added.length===0&&s.removed.length===0?void 0:[...o.visibleEditors].map(r=>r[0])}}}let a=class{constructor(e,o,t,i,d,s,r){this._notebookService=t;this._notebookEditorService=i;this._editorService=d;this._editorGroupService=s;this._logService=r;this._proxy=e.getProxy(C.ExtHostNotebook),this._mainThreadNotebooks=o.createInstance(f,e),this._mainThreadEditors=o.createInstance(A,e),e.set(p.MainThreadNotebookDocuments,this._mainThreadNotebooks),e.set(p.MainThreadNotebookEditors,this._mainThreadEditors),this._notebookService.onWillAddNotebookDocument(()=>this._updateState(),this,this._disposables),this._notebookService.onDidRemoveNotebookDocument(()=>this._updateState(),this,this._disposables),this._editorService.onDidActiveEditorChange(()=>this._updateState(),this,this._disposables),this._editorService.onDidVisibleEditorsChange(()=>this._updateState(),this,this._disposables),this._notebookEditorService.onDidAddNotebookEditor(this._handleEditorAdd,this,this._disposables),this._notebookEditorService.onDidRemoveNotebookEditor(this._handleEditorRemove,this,this._disposables),this._updateState()}_proxy;_disposables=new D;_editorListeners=new N;_currentState;_mainThreadNotebooks;_mainThreadEditors;dispose(){this._mainThreadNotebooks.dispose(),this._mainThreadEditors.dispose(),this._disposables.dispose(),this._editorListeners.dispose()}_handleEditorAdd(e){this._editorListeners.set(e.getId(),k(e.onDidChangeModel(()=>this._updateState()),e.onDidFocusWidget(()=>this._updateState(e)))),this._updateState()}_handleEditorRemove(e){this._editorListeners.deleteAndDispose(e.getId()),this._updateState()}_updateState(e){const o=new Map,t=new Map;for(const r of this._notebookEditorService.listNotebookEditors())r.hasModel()&&o.set(r.getId(),r);const i=m(this._editorService.activeEditorPane);let d=null;i?d=i.getId():e?.textModel&&(d=e.getId()),d&&!o.has(d)&&(this._logService.trace("MainThreadNotebooksAndEditors#_updateState: active editor is not in editors list",d,o.keys()),d=null);for(const r of this._editorService.visibleEditorPanes){const v=m(r);v?.hasModel()&&o.has(v.getId())&&t.set(v.getId(),v)}const s=new h(new Set(this._notebookService.listNotebookDocuments()),o,d,t);this._onDelta(h.delta(this._currentState,s)),this._currentState=s}_onDelta(e){if(a._isDeltaEmpty(e))return;const o={removedDocuments:e.removedDocuments,removedEditors:e.removedEditors,newActiveEditor:e.newActiveEditor,visibleEditors:e.visibleEditors,addedDocuments:e.addedDocuments.map(a._asModelAddData),addedEditors:e.addedEditors.map(this._asEditorAddData,this)};this._proxy.$acceptDocumentAndEditorsDelta(new P(o)),this._mainThreadEditors.handleEditorsRemoved(e.removedEditors),this._mainThreadNotebooks.handleNotebooksRemoved(e.removedDocuments),this._mainThreadNotebooks.handleNotebooksAdded(e.addedDocuments),this._mainThreadEditors.handleEditorsAdded(e.addedEditors)}static _isDeltaEmpty(e){return!(e.addedDocuments!==void 0&&e.addedDocuments.length>0||e.removedDocuments!==void 0&&e.removedDocuments.length>0||e.addedEditors!==void 0&&e.addedEditors.length>0||e.removedEditors!==void 0&&e.removedEditors.length>0||e.visibleEditors!==void 0&&e.visibleEditors.length>0||e.newActiveEditor!==void 0)}static _asModelAddData(e){return{viewType:e.viewType,uri:e.uri,metadata:e.metadata,versionId:e.versionId,cells:e.cells.map(g.toNotebookCellDto)}}_asEditorAddData(e){const o=this._editorService.visibleEditorPanes.find(t=>m(t)===e);return{id:e.getId(),documentUri:e.textModel.uri,selections:e.getSelections(),visibleRanges:e.visibleRanges,viewColumn:o&&M(this._editorGroupService,o.group),viewType:e.getViewModel().viewType}}};a=l([y,n(1,S),n(2,w),n(3,T),n(4,R),n(5,x),n(6,I)],a);export{a as MainThreadNotebooksAndEditors};
