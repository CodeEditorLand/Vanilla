var F=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var E=(c,e,t,d)=>{for(var r=d>1?void 0:d?O(e,t):e,n=c.length-1,o;n>=0;n--)(o=c[n])&&(r=(d?o(e,t,r):o(r))||r);return d&&r&&F(e,t,r),r},s=(c,e)=>(t,d)=>e(t,d,c);import{diffMaps as R,diffSets as b}from"../../../base/common/collections.js";import{Event as f}from"../../../base/common/event.js";import{DisposableMap as G,DisposableStore as S,combinedDisposable as L}from"../../../base/common/lifecycle.js";import{isCodeEditor as $,isDiffEditor as j}from"../../../editor/browser/editorBrowser.js";import{ICodeEditorService as D}from"../../../editor/browser/services/codeEditorService.js";import{shouldSynchronizeModel as v}from"../../../editor/common/model.js";import{IModelService as g}from"../../../editor/common/services/model.js";import{ITextModelService as W}from"../../../editor/common/services/resolverService.js";import{IClipboardService as k}from"../../../platform/clipboard/common/clipboardService.js";import{IConfigurationService as H}from"../../../platform/configuration/common/configuration.js";import{IFileService as U}from"../../../platform/files/common/files.js";import{IUriIdentityService as V}from"../../../platform/uriIdentity/common/uriIdentity.js";import{AbstractTextEditor as z}from"../../browser/parts/editor/textEditor.js";import{ViewContainerLocation as l}from"../../common/views.js";import{editorGroupToColumn as B}from"../../services/editor/common/editorGroupColumn.js";import{IEditorGroupsService as N}from"../../services/editor/common/editorGroupsService.js";import{IEditorService as I}from"../../services/editor/common/editorService.js";import{IWorkbenchEnvironmentService as q}from"../../services/environment/common/environmentService.js";import{extHostCustomer as J}from"../../services/extensions/common/extHostCustomers.js";import{IPaneCompositePartService as T}from"../../services/panecomposite/browser/panecomposite.js";import{IPathService as K}from"../../services/path/common/pathService.js";import{ITextFileService as Q}from"../../services/textfile/common/textfiles.js";import{IWorkingCopyFileService as X}from"../../services/workingCopy/common/workingCopyFileService.js";import{ExtHostContext as Y,MainContext as x}from"../common/extHost.protocol.js";import{MainThreadDocuments as Z}from"./mainThreadDocuments.js";import{MainThreadTextEditor as ee}from"./mainThreadEditor.js";import{MainThreadTextEditors as te}from"./mainThreadEditors.js";class ie{constructor(e){this.editor=e;this.id=`${e.getId()},${e.getModel().id}`}id}class u{constructor(e,t,d,r,n,o){this.removedDocuments=e;this.addedDocuments=t;this.removedEditors=d;this.addedEditors=r;this.oldActiveEditor=n;this.newActiveEditor=o;this.isEmpty=this.removedDocuments.length===0&&this.addedDocuments.length===0&&this.removedEditors.length===0&&this.addedEditors.length===0&&n===o}isEmpty;toString(){let e=`DocumentAndEditorStateDelta
`;return e+=`	Removed Documents: [${this.removedDocuments.map(t=>t.uri.toString(!0)).join(", ")}]
`,e+=`	Added Documents: [${this.addedDocuments.map(t=>t.uri.toString(!0)).join(", ")}]
`,e+=`	Removed Editors: [${this.removedEditors.map(t=>t.id).join(", ")}]
`,e+=`	Added Editors: [${this.addedEditors.map(t=>t.id).join(", ")}]
`,e+=`	New Active Editor: ${this.newActiveEditor}
`,e}}class _{constructor(e,t,d){this.documents=e;this.textEditors=t;this.activeEditor=d}static compute(e,t){if(!e)return new u([],[...t.documents.values()],[],[...t.textEditors.values()],void 0,t.activeEditor);const d=b(e.documents,t.documents),r=R(e.textEditors,t.textEditors),n=e.activeEditor!==t.activeEditor?e.activeEditor:void 0,o=e.activeEditor!==t.activeEditor?t.activeEditor:void 0;return new u(d.removed,d.added,r.removed,r.added,n,o)}}var oe=(t=>(t[t.Editor=0]="Editor",t[t.Panel=1]="Panel",t))(oe||{});let h=class{constructor(e,t,d,r,n){this._onDidChangeState=e;this._modelService=t;this._codeEditorService=d;this._editorService=r;this._paneCompositeService=n;this._modelService.onModelAdded(this._updateStateOnModelAdd,this,this._toDispose),this._modelService.onModelRemoved(o=>this._updateState(),this,this._toDispose),this._editorService.onDidActiveEditorChange(o=>this._updateState(),this,this._toDispose),this._codeEditorService.onCodeEditorAdd(this._onDidAddEditor,this,this._toDispose),this._codeEditorService.onCodeEditorRemove(this._onDidRemoveEditor,this,this._toDispose),this._codeEditorService.listCodeEditors().forEach(this._onDidAddEditor,this),f.filter(this._paneCompositeService.onDidPaneCompositeOpen,o=>o.viewContainerLocation===l.Panel)(o=>this._activeEditorOrder=1,void 0,this._toDispose),f.filter(this._paneCompositeService.onDidPaneCompositeClose,o=>o.viewContainerLocation===l.Panel)(o=>this._activeEditorOrder=0,void 0,this._toDispose),this._editorService.onDidVisibleEditorsChange(o=>this._activeEditorOrder=0,void 0,this._toDispose),this._updateState()}_toDispose=new S;_toDisposeOnEditorRemove=new G;_currentState;_activeEditorOrder=0;dispose(){this._toDispose.dispose(),this._toDisposeOnEditorRemove.dispose()}_onDidAddEditor(e){this._toDisposeOnEditorRemove.set(e.getId(),L(e.onDidChangeModel(()=>this._updateState()),e.onDidFocusEditorText(()=>this._updateState()),e.onDidFocusEditorWidget(()=>this._updateState(e)))),this._updateState()}_onDidRemoveEditor(e){const t=e.getId();this._toDisposeOnEditorRemove.has(t)&&(this._toDisposeOnEditorRemove.deleteAndDispose(t),this._updateState())}_updateStateOnModelAdd(e){if(v(e)){if(!this._currentState){this._updateState();return}this._currentState=new _(this._currentState.documents.add(e),this._currentState.textEditors,this._currentState.activeEditor),this._onDidChangeState(new u([],[e],[],[],void 0,void 0))}}_updateState(e){const t=new Set;for(const i of this._modelService.getModels())v(i)&&t.add(i);const d=new Map;let r=null;for(const i of this._codeEditorService.listCodeEditors()){if(i.isSimpleWidget)continue;const a=i.getModel();if(i.hasModel()&&a&&v(a)&&!a.isDisposed()&&this._modelService.getModel(a.uri)){const m=new ie(i);d.set(m.id,m),(i.hasTextFocus()||e===i&&i.hasWidgetFocus())&&(r=m.id)}}if(!r){let i;if(this._activeEditorOrder===0?i=this._getActiveEditorFromEditorPart()||this._getActiveEditorFromPanel():i=this._getActiveEditorFromPanel()||this._getActiveEditorFromEditorPart(),i)for(const a of d.values())i===a.editor&&(r=a.id)}const n=new _(t,d,r),o=_.compute(this._currentState,n);o.isEmpty||(this._currentState=n,this._onDidChangeState(o))}_getActiveEditorFromPanel(){const e=this._paneCompositeService.getActivePaneComposite(l.Panel);if(e instanceof z){const t=e.getControl();if($(t))return t}}_getActiveEditorFromEditorPart(){let e=this._editorService.activeTextEditorControl;return j(e)&&(e=e.getModifiedEditor()),e}};h=E([s(1,g),s(2,D),s(3,I),s(4,T)],h);let p=class{constructor(e,t,d,r,n,o,i,a,m,y,A,C,de,M,P){this._modelService=t;this._textFileService=d;this._editorService=r;this._editorGroupService=a;this._clipboardService=de;this._proxy=e.getProxy(Y.ExtHostDocumentsAndEditors),this._mainThreadDocuments=this._toDispose.add(new Z(e,this._modelService,this._textFileService,o,i,y,C,A,M)),e.set(x.MainThreadDocuments,this._mainThreadDocuments),this._mainThreadEditors=this._toDispose.add(new te(this,e,n,this._editorService,this._editorGroupService,P)),e.set(x.MainThreadTextEditors,this._mainThreadEditors),this._toDispose.add(new h(w=>this._onDelta(w),t,n,this._editorService,m))}_toDispose=new S;_proxy;_mainThreadDocuments;_mainThreadEditors;_textEditors=new Map;dispose(){this._toDispose.dispose()}_onDelta(e){const t=[],d=[],r=e.removedDocuments.map(i=>i.uri);for(const i of e.addedEditors){const a=new ee(i.id,i.editor.getModel(),i.editor,{onGainedFocus(){},onLostFocus(){}},this._mainThreadDocuments,this._modelService,this._clipboardService);this._textEditors.set(i.id,a),d.push(a)}for(const{id:i}of e.removedEditors){const a=this._textEditors.get(i);a&&(a.dispose(),this._textEditors.delete(i),t.push(i))}const n=Object.create(null);let o=!0;e.newActiveEditor!==void 0&&(o=!1,n.newActiveEditor=e.newActiveEditor),r.length>0&&(o=!1,n.removedDocuments=r),t.length>0&&(o=!1,n.removedEditors=t),e.addedDocuments.length>0&&(o=!1,n.addedDocuments=e.addedDocuments.map(i=>this._toModelAddData(i))),e.addedEditors.length>0&&(o=!1,n.addedEditors=d.map(i=>this._toTextEditorAddData(i))),o||(this._proxy.$acceptDocumentsAndEditorsDelta(n),r.forEach(this._mainThreadDocuments.handleModelRemoved,this._mainThreadDocuments),e.addedDocuments.forEach(this._mainThreadDocuments.handleModelAdded,this._mainThreadDocuments),t.forEach(this._mainThreadEditors.handleTextEditorRemoved,this._mainThreadEditors),d.forEach(this._mainThreadEditors.handleTextEditorAdded,this._mainThreadEditors))}_toModelAddData(e){return{uri:e.uri,versionId:e.getVersionId(),lines:e.getLinesContent(),EOL:e.getEOL(),languageId:e.getLanguageId(),isDirty:this._textFileService.isDirty(e.uri)}}_toTextEditorAddData(e){const t=e.getProperties();return{id:e.getId(),documentUri:e.getModel().uri,options:t.options,selections:t.selections,visibleRanges:t.visibleRanges,editorPosition:this._findEditorPosition(e)}}_findEditorPosition(e){for(const t of this._editorService.visibleEditorPanes)if(e.matches(t))return B(this._editorGroupService,t.group)}findTextEditorIdFor(e){for(const[t,d]of this._textEditors)if(d.matches(e))return t}getIdOfCodeEditor(e){for(const[t,d]of this._textEditors)if(d.getCodeEditor()===e)return t}getEditor(e){return this._textEditors.get(e)}};p=E([J,s(1,g),s(2,Q),s(3,I),s(4,D),s(5,U),s(6,W),s(7,N),s(8,T),s(9,q),s(10,X),s(11,V),s(12,k),s(13,K),s(14,H)],p);export{p as MainThreadDocumentsAndEditors};
