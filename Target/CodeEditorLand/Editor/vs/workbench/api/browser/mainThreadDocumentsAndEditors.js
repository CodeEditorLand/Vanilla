var F=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var v=(c,e,t,d)=>{for(var r=d>1?void 0:d?O(e,t):e,n=c.length-1,o;n>=0;n--)(o=c[n])&&(r=(d?o(e,t,r):o(r))||r);return d&&r&&F(e,t,r),r},s=(c,e)=>(t,d)=>e(t,d,c);import{Event as f}from"../../../base/common/event.js";import{combinedDisposable as R,DisposableStore as S,DisposableMap as b}from"../../../base/common/lifecycle.js";import{isCodeEditor as G,isDiffEditor as L}from"../../../editor/browser/editorBrowser.js";import{ICodeEditorService as D}from"../../../editor/browser/services/codeEditorService.js";import{shouldSynchronizeModel as p}from"../../../editor/common/model.js";import{IModelService as g}from"../../../editor/common/services/model.js";import{ITextModelService as $}from"../../../editor/common/services/resolverService.js";import{IFileService as W}from"../../../platform/files/common/files.js";import{extHostCustomer as j}from"../../services/extensions/common/extHostCustomers.js";import{MainThreadDocuments as k}from"./mainThreadDocuments.js";import{MainThreadTextEditor as H}from"./mainThreadEditor.js";import{MainThreadTextEditors as U}from"./mainThreadEditors.js";import{ExtHostContext as V,MainContext as I}from"../common/extHost.protocol.js";import{AbstractTextEditor as z}from"../../browser/parts/editor/textEditor.js";import{editorGroupToColumn as B}from"../../services/editor/common/editorGroupColumn.js";import{IEditorService as T}from"../../services/editor/common/editorService.js";import{IEditorGroupsService as N}from"../../services/editor/common/editorGroupsService.js";import{ITextFileService as q}from"../../services/textfile/common/textfiles.js";import{IWorkbenchEnvironmentService as J}from"../../services/environment/common/environmentService.js";import{IWorkingCopyFileService as K}from"../../services/workingCopy/common/workingCopyFileService.js";import{IUriIdentityService as Q}from"../../../platform/uriIdentity/common/uriIdentity.js";import{IClipboardService as X}from"../../../platform/clipboard/common/clipboardService.js";import{IPathService as Y}from"../../services/path/common/pathService.js";import{diffSets as Z,diffMaps as ee}from"../../../base/common/collections.js";import{IPaneCompositePartService as x}from"../../services/panecomposite/browser/panecomposite.js";import{ViewContainerLocation as l}from"../../common/views.js";import{IConfigurationService as te}from"../../../platform/configuration/common/configuration.js";class ie{constructor(e){this.editor=e;this.id=`${e.getId()},${e.getModel().id}`}id}class u{constructor(e,t,d,r,n,o){this.removedDocuments=e;this.addedDocuments=t;this.removedEditors=d;this.addedEditors=r;this.oldActiveEditor=n;this.newActiveEditor=o;this.isEmpty=this.removedDocuments.length===0&&this.addedDocuments.length===0&&this.removedEditors.length===0&&this.addedEditors.length===0&&n===o}isEmpty;toString(){let e=`DocumentAndEditorStateDelta
`;return e+=`	Removed Documents: [${this.removedDocuments.map(t=>t.uri.toString(!0)).join(", ")}]
`,e+=`	Added Documents: [${this.addedDocuments.map(t=>t.uri.toString(!0)).join(", ")}]
`,e+=`	Removed Editors: [${this.removedEditors.map(t=>t.id).join(", ")}]
`,e+=`	Added Editors: [${this.addedEditors.map(t=>t.id).join(", ")}]
`,e+=`	New Active Editor: ${this.newActiveEditor}
`,e}}class _{constructor(e,t,d){this.documents=e;this.textEditors=t;this.activeEditor=d}static compute(e,t){if(!e)return new u([],[...t.documents.values()],[],[...t.textEditors.values()],void 0,t.activeEditor);const d=Z(e.documents,t.documents),r=ee(e.textEditors,t.textEditors),n=e.activeEditor!==t.activeEditor?e.activeEditor:void 0,o=e.activeEditor!==t.activeEditor?t.activeEditor:void 0;return new u(d.removed,d.added,r.removed,r.added,n,o)}}var oe=(t=>(t[t.Editor=0]="Editor",t[t.Panel=1]="Panel",t))(oe||{});let h=class{constructor(e,t,d,r,n){this._onDidChangeState=e;this._modelService=t;this._codeEditorService=d;this._editorService=r;this._paneCompositeService=n;this._modelService.onModelAdded(this._updateStateOnModelAdd,this,this._toDispose),this._modelService.onModelRemoved(o=>this._updateState(),this,this._toDispose),this._editorService.onDidActiveEditorChange(o=>this._updateState(),this,this._toDispose),this._codeEditorService.onCodeEditorAdd(this._onDidAddEditor,this,this._toDispose),this._codeEditorService.onCodeEditorRemove(this._onDidRemoveEditor,this,this._toDispose),this._codeEditorService.listCodeEditors().forEach(this._onDidAddEditor,this),f.filter(this._paneCompositeService.onDidPaneCompositeOpen,o=>o.viewContainerLocation===l.Panel)(o=>this._activeEditorOrder=1,void 0,this._toDispose),f.filter(this._paneCompositeService.onDidPaneCompositeClose,o=>o.viewContainerLocation===l.Panel)(o=>this._activeEditorOrder=0,void 0,this._toDispose),this._editorService.onDidVisibleEditorsChange(o=>this._activeEditorOrder=0,void 0,this._toDispose),this._updateState()}_toDispose=new S;_toDisposeOnEditorRemove=new b;_currentState;_activeEditorOrder=0;dispose(){this._toDispose.dispose(),this._toDisposeOnEditorRemove.dispose()}_onDidAddEditor(e){this._toDisposeOnEditorRemove.set(e.getId(),R(e.onDidChangeModel(()=>this._updateState()),e.onDidFocusEditorText(()=>this._updateState()),e.onDidFocusEditorWidget(()=>this._updateState(e)))),this._updateState()}_onDidRemoveEditor(e){const t=e.getId();this._toDisposeOnEditorRemove.has(t)&&(this._toDisposeOnEditorRemove.deleteAndDispose(t),this._updateState())}_updateStateOnModelAdd(e){if(p(e)){if(!this._currentState){this._updateState();return}this._currentState=new _(this._currentState.documents.add(e),this._currentState.textEditors,this._currentState.activeEditor),this._onDidChangeState(new u([],[e],[],[],void 0,void 0))}}_updateState(e){const t=new Set;for(const i of this._modelService.getModels())p(i)&&t.add(i);const d=new Map;let r=null;for(const i of this._codeEditorService.listCodeEditors()){if(i.isSimpleWidget)continue;const a=i.getModel();if(i.hasModel()&&a&&p(a)&&!a.isDisposed()&&this._modelService.getModel(a.uri)){const m=new ie(i);d.set(m.id,m),(i.hasTextFocus()||e===i&&i.hasWidgetFocus())&&(r=m.id)}}if(!r){let i;if(this._activeEditorOrder===0?i=this._getActiveEditorFromEditorPart()||this._getActiveEditorFromPanel():i=this._getActiveEditorFromPanel()||this._getActiveEditorFromEditorPart(),i)for(const a of d.values())i===a.editor&&(r=a.id)}const n=new _(t,d,r),o=_.compute(this._currentState,n);o.isEmpty||(this._currentState=n,this._onDidChangeState(o))}_getActiveEditorFromPanel(){const e=this._paneCompositeService.getActivePaneComposite(l.Panel);if(e instanceof z){const t=e.getControl();if(G(t))return t}}_getActiveEditorFromEditorPart(){let e=this._editorService.activeTextEditorControl;return L(e)&&(e=e.getModifiedEditor()),e}};h=v([s(1,g),s(2,D),s(3,T),s(4,x)],h);let E=class{constructor(e,t,d,r,n,o,i,a,m,A,C,y,de,M,P){this._modelService=t;this._textFileService=d;this._editorService=r;this._editorGroupService=a;this._clipboardService=de;this._proxy=e.getProxy(V.ExtHostDocumentsAndEditors),this._mainThreadDocuments=this._toDispose.add(new k(e,this._modelService,this._textFileService,o,i,A,y,C,M)),e.set(I.MainThreadDocuments,this._mainThreadDocuments),this._mainThreadEditors=this._toDispose.add(new U(this,e,n,this._editorService,this._editorGroupService,P)),e.set(I.MainThreadTextEditors,this._mainThreadEditors),this._toDispose.add(new h(w=>this._onDelta(w),t,n,this._editorService,m))}_toDispose=new S;_proxy;_mainThreadDocuments;_mainThreadEditors;_textEditors=new Map;dispose(){this._toDispose.dispose()}_onDelta(e){const t=[],d=[],r=e.removedDocuments.map(i=>i.uri);for(const i of e.addedEditors){const a=new H(i.id,i.editor.getModel(),i.editor,{onGainedFocus(){},onLostFocus(){}},this._mainThreadDocuments,this._modelService,this._clipboardService);this._textEditors.set(i.id,a),d.push(a)}for(const{id:i}of e.removedEditors){const a=this._textEditors.get(i);a&&(a.dispose(),this._textEditors.delete(i),t.push(i))}const n=Object.create(null);let o=!0;e.newActiveEditor!==void 0&&(o=!1,n.newActiveEditor=e.newActiveEditor),r.length>0&&(o=!1,n.removedDocuments=r),t.length>0&&(o=!1,n.removedEditors=t),e.addedDocuments.length>0&&(o=!1,n.addedDocuments=e.addedDocuments.map(i=>this._toModelAddData(i))),e.addedEditors.length>0&&(o=!1,n.addedEditors=d.map(i=>this._toTextEditorAddData(i))),o||(this._proxy.$acceptDocumentsAndEditorsDelta(n),r.forEach(this._mainThreadDocuments.handleModelRemoved,this._mainThreadDocuments),e.addedDocuments.forEach(this._mainThreadDocuments.handleModelAdded,this._mainThreadDocuments),t.forEach(this._mainThreadEditors.handleTextEditorRemoved,this._mainThreadEditors),d.forEach(this._mainThreadEditors.handleTextEditorAdded,this._mainThreadEditors))}_toModelAddData(e){return{uri:e.uri,versionId:e.getVersionId(),lines:e.getLinesContent(),EOL:e.getEOL(),languageId:e.getLanguageId(),isDirty:this._textFileService.isDirty(e.uri)}}_toTextEditorAddData(e){const t=e.getProperties();return{id:e.getId(),documentUri:e.getModel().uri,options:t.options,selections:t.selections,visibleRanges:t.visibleRanges,editorPosition:this._findEditorPosition(e)}}_findEditorPosition(e){for(const t of this._editorService.visibleEditorPanes)if(e.matches(t))return B(this._editorGroupService,t.group)}findTextEditorIdFor(e){for(const[t,d]of this._textEditors)if(d.matches(e))return t}getIdOfCodeEditor(e){for(const[t,d]of this._textEditors)if(d.getCodeEditor()===e)return t}getEditor(e){return this._textEditors.get(e)}};E=v([j,s(1,g),s(2,q),s(3,T),s(4,D),s(5,W),s(6,$),s(7,N),s(8,x),s(9,J),s(10,K),s(11,Q),s(12,X),s(13,Y),s(14,te)],E);export{E as MainThreadDocumentsAndEditors};
