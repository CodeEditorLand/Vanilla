var k=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var b=(s,e,r,i)=>{for(var t=i>1?void 0:i?E(e,r):e,o=s.length-1,n;o>=0;o--)(n=s[o])&&(t=(i?n(e,r,t):n(t))||t);return i&&t&&k(e,r,t),t},c=(s,e)=>(r,i)=>e(r,i,s);import{Barrier as V}from"../../../base/common/async.js";import{CancellationToken as v}from"../../../base/common/cancellation.js";import{structuralEquals as F}from"../../../base/common/equals.js";import{Emitter as m,Event as O}from"../../../base/common/event.js";import"../../../base/common/htmlContent.js";import{combinedDisposable as q,Disposable as L,DisposableStore as N,dispose as x}from"../../../base/common/lifecycle.js";import{MarshalledId as S}from"../../../base/common/marshallingIds.js";import{Schemas as Q}from"../../../base/common/network.js";import{observableValue as h,observableValueOpts as A}from"../../../base/common/observable.js";import{basename as W}from"../../../base/common/resources.js";import{ResourceTree as j}from"../../../base/common/resourceTree.js";import{ThemeIcon as C}from"../../../base/common/themables.js";import{URI as a}from"../../../base/common/uri.js";import"../../../editor/common/languages.js";import{ILanguageService as J}from"../../../editor/common/languages/language.js";import"../../../editor/common/model.js";import{IModelService as z}from"../../../editor/common/services/model.js";import{ITextModelService as K}from"../../../editor/common/services/resolverService.js";import{IUriIdentityService as X}from"../../../platform/uriIdentity/common/uriIdentity.js";import{IWorkspaceContextService as Y}from"../../../platform/workspace/common/workspace.js";import"../../contrib/scm/common/history.js";import{IQuickDiffService as Z}from"../../contrib/scm/common/quickDiff.js";import{ISCMService as ee,ISCMViewService as re}from"../../contrib/scm/common/scm.js";import{extHostNamedCustomer as ie}from"../../services/extensions/common/extHostCustomers.js";import{ExtHostContext as te,MainContext as oe}from"../common/extHost.protocol.js";function se(s){if(s!==void 0){if(a.isUri(s))return a.revive(s);if(C.isThemeIcon(s))return s;{const e=s;return{light:a.revive(e.light),dark:a.revive(e.dark)}}}}function ne(s){const e=s.labels?.map(t=>({title:t.title,icon:se(t.icon)})),r=s.message.indexOf(`
`),i=r===-1?s.message:`${s.message.substring(0,r)}\u2026`;return{...s,subject:i,labels:e}}class ae extends L{constructor(r,i,t){super();this.modelService=i;this.languageService=t;this._register(r.registerTextModelContentProvider(Q.vscodeSourceControl,this))}async provideTextContent(r){const i=this.modelService.getModel(r);return i||this.modelService.createModel("",this.languageService.createById("scminput"),r)}}class de{constructor(e,r,i,t,o,n,p,d){this.sourceControlHandle=e;this.handle=r;this.provider=i;this.features=t;this.label=o;this.id=n;this.multiDiffEditorEnableViewChanges=p;this._uriIdentService=d}resources=[];_resourceTree;get resourceTree(){if(!this._resourceTree){const e=this.provider.rootUri??a.file("/");this._resourceTree=new j(this,e,this._uriIdentService.extUri);for(const r of this.resources)this._resourceTree.add(r.sourceUri,r)}return this._resourceTree}_onDidChange=new m;onDidChange=this._onDidChange.event;_onDidChangeResources=new m;onDidChangeResources=this._onDidChangeResources.event;get hideWhenEmpty(){return!!this.features.hideWhenEmpty}toJSON(){return{$mid:S.ScmResourceGroup,sourceControlHandle:this.sourceControlHandle,groupHandle:this.handle}}splice(e,r,i){this.resources.splice(e,r,...i),this._resourceTree=void 0,this._onDidChangeResources.fire()}$updateGroup(e){this.features={...this.features,...e},this._onDidChange.fire()}$updateGroupLabel(e){this.label=e,this._onDidChange.fire()}}class ue{constructor(e,r,i,t,o,n,p,d,l,u,M){this.proxy=e;this.sourceControlHandle=r;this.groupHandle=i;this.handle=t;this.sourceUri=o;this.resourceGroup=n;this.decorations=p;this.contextValue=d;this.command=l;this.multiDiffEditorOriginalUri=u;this.multiDiffEditorModifiedUri=M}open(e){return this.proxy.$executeResourceCommand(this.sourceControlHandle,this.groupHandle,this.handle,e)}toJSON(){return{$mid:S.ScmResource,sourceControlHandle:this.sourceControlHandle,groupHandle:this.groupHandle,handle:this.handle}}}class pe{constructor(e,r){this.proxy=e;this.handle=r}_currentHistoryItemGroup=A({owner:this,equalsFn:F},void 0);get currentHistoryItemGroup(){return this._currentHistoryItemGroup}async resolveHistoryItemGroupCommonAncestor(e){return this.proxy.$resolveHistoryItemGroupCommonAncestor(this.handle,e,v.None)}async provideHistoryItems(e){return(await this.proxy.$provideHistoryItems(this.handle,e,v.None))?.map(i=>ne(i))}async provideHistoryItemChanges(e,r){return(await this.proxy.$provideHistoryItemChanges(this.handle,e,r,v.None))?.map(t=>({uri:a.revive(t.uri),originalUri:t.originalUri&&a.revive(t.originalUri),modifiedUri:t.modifiedUri&&a.revive(t.modifiedUri),renameUri:t.renameUri&&a.revive(t.renameUri)}))}$onDidChangeCurrentHistoryItemGroup(e){this._currentHistoryItemGroup.set(e,void 0)}}class I{constructor(e,r,i,t,o,n,p,d,l){this.proxy=e;this._handle=r;this._providerId=i;this._label=t;this._rootUri=o;this._inputBoxTextModel=n;this._quickDiffService=p;this._uriIdentService=d;this._workspaceContextService=l;if(o){const u=this._workspaceContextService.getWorkspaceFolder(o);u?.uri.toString()===o.toString()?this._name=u.name:o.path!=="/"&&(this._name=W(o))}}static ID_HANDLE=0;_id=`scm${I.ID_HANDLE++}`;get id(){return this._id}groups=[];_onDidChangeResourceGroups=new m;onDidChangeResourceGroups=this._onDidChangeResourceGroups.event;_onDidChangeResources=new m;onDidChangeResources=this._onDidChangeResources.event;_groupsByHandle=Object.create(null);features={};get handle(){return this._handle}get label(){return this._label}get rootUri(){return this._rootUri}get inputBoxTextModel(){return this._inputBoxTextModel}get contextValue(){return this._providerId}get acceptInputCommand(){return this.features.acceptInputCommand}get actionButton(){return this.features.actionButton??void 0}_count=h(this,void 0);get count(){return this._count}_statusBarCommands=h(this,void 0);get statusBarCommands(){return this._statusBarCommands}_name;get name(){return this._name??this._label}_commitTemplate=h(this,"");get commitTemplate(){return this._commitTemplate}_onDidChange=new m;onDidChange=this._onDidChange.event;_quickDiff;isSCM=!0;_historyProvider=h(this,void 0);get historyProvider(){return this._historyProvider}$updateSourceControl(e){if(this.features={...this.features,...e},this._onDidChange.fire(),typeof e.commitTemplate<"u"&&this._commitTemplate.set(e.commitTemplate,void 0),typeof e.count<"u"&&this._count.set(e.count,void 0),typeof e.statusBarCommands<"u"&&this._statusBarCommands.set(e.statusBarCommands,void 0),e.hasQuickDiffProvider&&!this._quickDiff?this._quickDiff=this._quickDiffService.addQuickDiffProvider({label:e.quickDiffLabel??this.label,rootUri:this.rootUri,isSCM:this.isSCM,getOriginalResource:r=>this.getOriginalResource(r)}):e.hasQuickDiffProvider===!1&&this._quickDiff&&(this._quickDiff.dispose(),this._quickDiff=void 0),e.hasHistoryProvider&&!this.historyProvider.get()){const r=new pe(this.proxy,this.handle);this._historyProvider.set(r,void 0)}else e.hasHistoryProvider===!1&&this.historyProvider.get()&&this._historyProvider.set(void 0,void 0)}$registerGroups(e){const r=e.map(([i,t,o,n,p])=>{const d=new de(this.handle,i,this,n,o,t,p,this._uriIdentService);return this._groupsByHandle[i]=d,d});this.groups.splice(this.groups.length,0,...r),this._onDidChangeResourceGroups.fire()}$updateGroup(e,r){const i=this._groupsByHandle[e];i&&i.$updateGroup(r)}$updateGroupLabel(e,r){const i=this._groupsByHandle[e];i&&i.$updateGroupLabel(r)}$spliceGroupResourceStates(e){for(const[r,i]of e){const t=this._groupsByHandle[r];if(!t){console.warn(`SCM group ${r} not found in provider ${this.label}`);continue}i.reverse();for(const[o,n,p]of i){const d=p.map(l=>{const[u,M,D,R,w,P,G,H,T,$]=l,[f,g]=D,_=C.isThemeIcon(f)?f:a.revive(f),B=(C.isThemeIcon(g)?g:a.revive(g))||_,U={icon:_,iconDark:B,tooltip:R,strikeThrough:w,faded:P};return new ue(this.proxy,this.handle,r,u,a.revive(M),t,U,G||void 0,H,a.revive(T),a.revive($))});t.splice(o,n,d)}}this._onDidChangeResources.fire()}$unregisterGroup(e){const r=this._groupsByHandle[e];r&&(delete this._groupsByHandle[e],this.groups.splice(this.groups.indexOf(r),1),this._onDidChangeResourceGroups.fire())}async getOriginalResource(e){if(!this.features.hasQuickDiffProvider)return null;const r=await this.proxy.$provideOriginalResource(this.handle,e,v.None);return r&&a.revive(r)}$onDidChangeHistoryProviderCurrentHistoryItemGroup(e){this.historyProvider.get()&&this._historyProvider.get()?.$onDidChangeCurrentHistoryItemGroup(e)}toJSON(){return{$mid:S.ScmProvider,handle:this.handle}}dispose(){this._quickDiff?.dispose()}}let y=class{constructor(e,r,i,t,o,n,p,d,l){this.scmService=r;this.scmViewService=i;this.languageService=t;this.modelService=o;this.textModelService=n;this.quickDiffService=p;this._uriIdentService=d;this.workspaceContextService=l;this._proxy=e.getProxy(te.ExtHostSCM),this._disposables.add(new ae(this.textModelService,this.modelService,this.languageService))}_proxy;_repositories=new Map;_repositoryBarriers=new Map;_repositoryDisposables=new Map;_disposables=new N;dispose(){x(this._repositories.values()),this._repositories.clear(),x(this._repositoryDisposables.values()),this._repositoryDisposables.clear(),this._disposables.dispose()}async $registerSourceControl(e,r,i,t,o){this._repositoryBarriers.set(e,new V);const n=await this.textModelService.createModelReference(a.revive(o)),p=new I(this._proxy,e,r,i,t?a.revive(t):void 0,n.object.textEditorModel,this.quickDiffService,this._uriIdentService,this.workspaceContextService),d=this.scmService.registerSCMProvider(p);this._repositories.set(e,d);const l=q(n,O.filter(this.scmViewService.onDidFocusRepository,u=>u===d)(u=>this._proxy.$setSelectedSourceControl(e)),d.input.onDidChange(({value:u})=>this._proxy.$onInputBoxValueChange(e,u)));this._repositoryDisposables.set(e,l),this.scmViewService.focusedRepository===d&&setTimeout(()=>this._proxy.$setSelectedSourceControl(e),0),d.input.value&&setTimeout(()=>this._proxy.$onInputBoxValueChange(e,d.input.value),0),this._repositoryBarriers.get(e)?.open()}async $updateSourceControl(e,r){await this._repositoryBarriers.get(e)?.wait();const i=this._repositories.get(e);if(!i)return;i.provider.$updateSourceControl(r)}async $unregisterSourceControl(e){await this._repositoryBarriers.get(e)?.wait();const r=this._repositories.get(e);r&&(this._repositoryDisposables.get(e).dispose(),this._repositoryDisposables.delete(e),r.dispose(),this._repositories.delete(e))}async $registerGroups(e,r,i){await this._repositoryBarriers.get(e)?.wait();const t=this._repositories.get(e);if(!t)return;const o=t.provider;o.$registerGroups(r),o.$spliceGroupResourceStates(i)}async $updateGroup(e,r,i){await this._repositoryBarriers.get(e)?.wait();const t=this._repositories.get(e);if(!t)return;t.provider.$updateGroup(r,i)}async $updateGroupLabel(e,r,i){await this._repositoryBarriers.get(e)?.wait();const t=this._repositories.get(e);if(!t)return;t.provider.$updateGroupLabel(r,i)}async $spliceResourceStates(e,r){await this._repositoryBarriers.get(e)?.wait();const i=this._repositories.get(e);if(!i)return;i.provider.$spliceGroupResourceStates(r)}async $unregisterGroup(e,r){await this._repositoryBarriers.get(e)?.wait();const i=this._repositories.get(e);if(!i)return;i.provider.$unregisterGroup(r)}async $setInputBoxValue(e,r){await this._repositoryBarriers.get(e)?.wait();const i=this._repositories.get(e);i&&i.input.setValue(r,!1)}async $setInputBoxPlaceholder(e,r){await this._repositoryBarriers.get(e)?.wait();const i=this._repositories.get(e);i&&(i.input.placeholder=r)}async $setInputBoxEnablement(e,r){await this._repositoryBarriers.get(e)?.wait();const i=this._repositories.get(e);i&&(i.input.enabled=r)}async $setInputBoxVisibility(e,r){await this._repositoryBarriers.get(e)?.wait();const i=this._repositories.get(e);i&&(i.input.visible=r)}async $showValidationMessage(e,r,i){await this._repositoryBarriers.get(e)?.wait();const t=this._repositories.get(e);t&&t.input.showValidationMessage(r,i)}async $setValidationProviderIsEnabled(e,r){await this._repositoryBarriers.get(e)?.wait();const i=this._repositories.get(e);i&&(r?i.input.validateInput=async(t,o)=>{const n=await this._proxy.$validateInput(e,t,o);return n&&{message:n[0],type:n[1]}}:i.input.validateInput=async()=>{})}async $onDidChangeHistoryProviderCurrentHistoryItemGroup(e,r){await this._repositoryBarriers.get(e)?.wait();const i=this._repositories.get(e);if(!i)return;i.provider.$onDidChangeHistoryProviderCurrentHistoryItemGroup(r)}};y=b([ie(oe.MainThreadSCM),c(1,ee),c(2,re),c(3,J),c(4,z),c(5,K),c(6,Z),c(7,X),c(8,Y)],y);export{y as MainThreadSCM};
