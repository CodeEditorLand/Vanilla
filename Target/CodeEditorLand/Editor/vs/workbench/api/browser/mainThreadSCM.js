var F=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var H=(s,e,r,i)=>{for(var t=i>1?void 0:i?O(e,r):e,o=s.length-1,n;o>=0;o--)(n=s[o])&&(t=(i?n(e,r,t):n(t))||t);return i&&t&&F(e,r,t),t},c=(s,e)=>(r,i)=>e(r,i,s);import{Barrier as N}from"../../../../vs/base/common/async.js";import{CancellationToken as m}from"../../../../vs/base/common/cancellation.js";import{Emitter as h,Event as q}from"../../../../vs/base/common/event.js";import"../../../../vs/base/common/htmlContent.js";import{combinedDisposable as L,Disposable as Q,DisposableStore as A,dispose as R}from"../../../../vs/base/common/lifecycle.js";import{MarshalledId as S}from"../../../../vs/base/common/marshallingIds.js";import{Schemas as W}from"../../../../vs/base/common/network.js";import{derived as v,observableValue as y,observableValueOpts as J}from"../../../../vs/base/common/observable.js";import{basename as j}from"../../../../vs/base/common/resources.js";import{ResourceTree as z}from"../../../../vs/base/common/resourceTree.js";import{ThemeIcon as C}from"../../../../vs/base/common/themables.js";import{URI as a}from"../../../../vs/base/common/uri.js";import"../../../../vs/editor/common/languages.js";import{ILanguageService as K}from"../../../../vs/editor/common/languages/language.js";import"../../../../vs/editor/common/model.js";import{IModelService as X}from"../../../../vs/editor/common/services/model.js";import{ITextModelService as Y}from"../../../../vs/editor/common/services/resolverService.js";import{IUriIdentityService as Z}from"../../../../vs/platform/uriIdentity/common/uriIdentity.js";import{IWorkspaceContextService as ee}from"../../../../vs/platform/workspace/common/workspace.js";import"../../../../vs/workbench/contrib/scm/common/history.js";import{IQuickDiffService as re}from"../../../../vs/workbench/contrib/scm/common/quickDiff.js";import{ISCMService as ie,ISCMViewService as te}from"../../../../vs/workbench/contrib/scm/common/scm.js";import{extHostNamedCustomer as oe}from"../../../../vs/workbench/services/extensions/common/extHostCustomers.js";import{ExtHostContext as se,MainContext as ne}from"../common/extHost.protocol.js";function D(s){if(s!==void 0){if(a.isUri(s))return a.revive(s);if(C.isThemeIcon(s))return s;{const e=s;return{light:a.revive(e.light),dark:a.revive(e.dark)}}}}function M(s){const e=D(s.icon),r=s.labels?.map(i=>({title:i.title,icon:D(i.icon)}));return{...s,icon:e,labels:r}}class ae extends Q{constructor(r,i,t){super();this.modelService=i;this.languageService=t;this._register(r.registerTextModelContentProvider(W.vscodeSourceControl,this))}async provideTextContent(r){const i=this.modelService.getModel(r);return i||this.modelService.createModel("",this.languageService.createById("scminput"),r)}}class de{constructor(e,r,i,t,o,n,p,d){this.sourceControlHandle=e;this.handle=r;this.provider=i;this.features=t;this.label=o;this.id=n;this.multiDiffEditorEnableViewChanges=p;this._uriIdentService=d}resources=[];_resourceTree;get resourceTree(){if(!this._resourceTree){const e=this.provider.rootUri??a.file("/");this._resourceTree=new z(this,e,this._uriIdentService.extUri);for(const r of this.resources)this._resourceTree.add(r.sourceUri,r)}return this._resourceTree}_onDidChange=new h;onDidChange=this._onDidChange.event;_onDidChangeResources=new h;onDidChangeResources=this._onDidChangeResources.event;get hideWhenEmpty(){return!!this.features.hideWhenEmpty}toJSON(){return{$mid:S.ScmResourceGroup,sourceControlHandle:this.sourceControlHandle,groupHandle:this.handle}}splice(e,r,i){this.resources.splice(e,r,...i),this._resourceTree=void 0,this._onDidChangeResources.fire()}$updateGroup(e){this.features={...this.features,...e},this._onDidChange.fire()}$updateGroupLabel(e){this.label=e,this._onDidChange.fire()}}class ue{constructor(e,r,i,t,o,n,p,d,l,u,b){this.proxy=e;this.sourceControlHandle=r;this.groupHandle=i;this.handle=t;this.sourceUri=o;this.resourceGroup=n;this.decorations=p;this.contextValue=d;this.command=l;this.multiDiffEditorOriginalUri=u;this.multiDiffEditorModifiedUri=b}open(e){return this.proxy.$executeResourceCommand(this.sourceControlHandle,this.groupHandle,this.handle,e)}toJSON(){return{$mid:S.ScmResource,sourceControlHandle:this.sourceControlHandle,groupHandle:this.groupHandle,handle:this.handle}}}class pe{constructor(e,r){this.proxy=e;this.handle=r}currentHistoryItemGroupId=v(this,e=>this.currentHistoryItemGroup.read(e)?.id);currentHistoryItemGroupName=v(this,e=>this.currentHistoryItemGroup.read(e)?.name);currentHistoryItemGroupRevision=v(this,e=>this.currentHistoryItemGroup.read(e)?.revision);currentHistoryItemGroupRemoteId=v(this,e=>this.currentHistoryItemGroup.read(e)?.remote?.id);currentHistoryItemGroupRemoteRevision=v(this,e=>this.currentHistoryItemGroup.read(e)?.remote?.revision);_currentHistoryItemGroup=J({owner:this,equalsFn:()=>!1},void 0);get currentHistoryItemGroup(){return this._currentHistoryItemGroup}async resolveHistoryItemGroupCommonAncestor(e,r){return this.proxy.$resolveHistoryItemGroupCommonAncestor(this.handle,e,r,m.None)}async resolveHistoryItemGroupCommonAncestor2(e){return this.proxy.$resolveHistoryItemGroupCommonAncestor2(this.handle,e,m.None)}async provideHistoryItems(e,r){return(await this.proxy.$provideHistoryItems(this.handle,e,r,m.None))?.map(t=>M(t))}async provideHistoryItems2(e){return(await this.proxy.$provideHistoryItems2(this.handle,e,m.None))?.map(i=>M(i))}async provideHistoryItemSummary(e,r){const i=await this.proxy.$provideHistoryItemSummary(this.handle,e,r,m.None);return i?M(i):void 0}async provideHistoryItemChanges(e,r){return(await this.proxy.$provideHistoryItemChanges(this.handle,e,r,m.None))?.map(t=>({uri:a.revive(t.uri),originalUri:t.originalUri&&a.revive(t.originalUri),modifiedUri:t.modifiedUri&&a.revive(t.modifiedUri),renameUri:t.renameUri&&a.revive(t.renameUri)}))}$onDidChangeCurrentHistoryItemGroup(e){this._currentHistoryItemGroup.set(e,void 0)}}class _{constructor(e,r,i,t,o,n,p,d,l){this.proxy=e;this._handle=r;this._providerId=i;this._label=t;this._rootUri=o;this._inputBoxTextModel=n;this._quickDiffService=p;this._uriIdentService=d;this._workspaceContextService=l;if(o){const u=this._workspaceContextService.getWorkspaceFolder(o);u?.uri.toString()===o.toString()?this._name=u.name:o.path!=="/"&&(this._name=j(o))}}static ID_HANDLE=0;_id=`scm${_.ID_HANDLE++}`;get id(){return this._id}groups=[];_onDidChangeResourceGroups=new h;onDidChangeResourceGroups=this._onDidChangeResourceGroups.event;_onDidChangeResources=new h;onDidChangeResources=this._onDidChangeResources.event;_groupsByHandle=Object.create(null);features={};get handle(){return this._handle}get label(){return this._label}get rootUri(){return this._rootUri}get inputBoxTextModel(){return this._inputBoxTextModel}get contextValue(){return this._providerId}get acceptInputCommand(){return this.features.acceptInputCommand}get actionButton(){return this.features.actionButton??void 0}_count=y(this,void 0);get count(){return this._count}_statusBarCommands=y(this,void 0);get statusBarCommands(){return this._statusBarCommands}_name;get name(){return this._name??this._label}_commitTemplate=y(this,"");get commitTemplate(){return this._commitTemplate}_onDidChange=new h;onDidChange=this._onDidChange.event;_quickDiff;isSCM=!0;_historyProvider=y(this,void 0);get historyProvider(){return this._historyProvider}$updateSourceControl(e){if(this.features={...this.features,...e},this._onDidChange.fire(),typeof e.commitTemplate<"u"&&this._commitTemplate.set(e.commitTemplate,void 0),typeof e.count<"u"&&this._count.set(e.count,void 0),typeof e.statusBarCommands<"u"&&this._statusBarCommands.set(e.statusBarCommands,void 0),e.hasQuickDiffProvider&&!this._quickDiff?this._quickDiff=this._quickDiffService.addQuickDiffProvider({label:e.quickDiffLabel??this.label,rootUri:this.rootUri,isSCM:this.isSCM,getOriginalResource:r=>this.getOriginalResource(r)}):e.hasQuickDiffProvider===!1&&this._quickDiff&&(this._quickDiff.dispose(),this._quickDiff=void 0),e.hasHistoryProvider&&!this.historyProvider.get()){const r=new pe(this.proxy,this.handle);this._historyProvider.set(r,void 0)}else e.hasHistoryProvider===!1&&this.historyProvider.get()&&this._historyProvider.set(void 0,void 0)}$registerGroups(e){const r=e.map(([i,t,o,n,p])=>{const d=new de(this.handle,i,this,n,o,t,p,this._uriIdentService);return this._groupsByHandle[i]=d,d});this.groups.splice(this.groups.length,0,...r),this._onDidChangeResourceGroups.fire()}$updateGroup(e,r){const i=this._groupsByHandle[e];i&&i.$updateGroup(r)}$updateGroupLabel(e,r){const i=this._groupsByHandle[e];i&&i.$updateGroupLabel(r)}$spliceGroupResourceStates(e){for(const[r,i]of e){const t=this._groupsByHandle[r];if(!t){console.warn(`SCM group ${r} not found in provider ${this.label}`);continue}i.reverse();for(const[o,n,p]of i){const d=p.map(l=>{const[u,b,P,w,G,T,$,B,U,k]=l,[g,I]=P,x=C.isThemeIcon(g)?g:a.revive(g),E=(C.isThemeIcon(I)?I:a.revive(I))||x,V={icon:x,iconDark:E,tooltip:w,strikeThrough:G,faded:T};return new ue(this.proxy,this.handle,r,u,a.revive(b),t,V,$||void 0,B,a.revive(U),a.revive(k))});t.splice(o,n,d)}}this._onDidChangeResources.fire()}$unregisterGroup(e){const r=this._groupsByHandle[e];r&&(delete this._groupsByHandle[e],this.groups.splice(this.groups.indexOf(r),1),this._onDidChangeResourceGroups.fire())}async getOriginalResource(e){if(!this.features.hasQuickDiffProvider)return null;const r=await this.proxy.$provideOriginalResource(this.handle,e,m.None);return r&&a.revive(r)}$onDidChangeHistoryProviderCurrentHistoryItemGroup(e){this.historyProvider.get()&&this._historyProvider.get()?.$onDidChangeCurrentHistoryItemGroup(e)}toJSON(){return{$mid:S.ScmProvider,handle:this.handle}}dispose(){this._quickDiff?.dispose()}}let f=class{constructor(e,r,i,t,o,n,p,d,l){this.scmService=r;this.scmViewService=i;this.languageService=t;this.modelService=o;this.textModelService=n;this.quickDiffService=p;this._uriIdentService=d;this.workspaceContextService=l;this._proxy=e.getProxy(se.ExtHostSCM),this._disposables.add(new ae(this.textModelService,this.modelService,this.languageService))}_proxy;_repositories=new Map;_repositoryBarriers=new Map;_repositoryDisposables=new Map;_disposables=new A;dispose(){R(this._repositories.values()),this._repositories.clear(),R(this._repositoryDisposables.values()),this._repositoryDisposables.clear(),this._disposables.dispose()}async $registerSourceControl(e,r,i,t,o){this._repositoryBarriers.set(e,new N);const n=await this.textModelService.createModelReference(a.revive(o)),p=new _(this._proxy,e,r,i,t?a.revive(t):void 0,n.object.textEditorModel,this.quickDiffService,this._uriIdentService,this.workspaceContextService),d=this.scmService.registerSCMProvider(p);this._repositories.set(e,d);const l=L(n,q.filter(this.scmViewService.onDidFocusRepository,u=>u===d)(u=>this._proxy.$setSelectedSourceControl(e)),d.input.onDidChange(({value:u})=>this._proxy.$onInputBoxValueChange(e,u)));this._repositoryDisposables.set(e,l),this.scmViewService.focusedRepository===d&&setTimeout(()=>this._proxy.$setSelectedSourceControl(e),0),d.input.value&&setTimeout(()=>this._proxy.$onInputBoxValueChange(e,d.input.value),0),this._repositoryBarriers.get(e)?.open()}async $updateSourceControl(e,r){await this._repositoryBarriers.get(e)?.wait();const i=this._repositories.get(e);if(!i)return;i.provider.$updateSourceControl(r)}async $unregisterSourceControl(e){await this._repositoryBarriers.get(e)?.wait();const r=this._repositories.get(e);r&&(this._repositoryDisposables.get(e).dispose(),this._repositoryDisposables.delete(e),r.dispose(),this._repositories.delete(e))}async $registerGroups(e,r,i){await this._repositoryBarriers.get(e)?.wait();const t=this._repositories.get(e);if(!t)return;const o=t.provider;o.$registerGroups(r),o.$spliceGroupResourceStates(i)}async $updateGroup(e,r,i){await this._repositoryBarriers.get(e)?.wait();const t=this._repositories.get(e);if(!t)return;t.provider.$updateGroup(r,i)}async $updateGroupLabel(e,r,i){await this._repositoryBarriers.get(e)?.wait();const t=this._repositories.get(e);if(!t)return;t.provider.$updateGroupLabel(r,i)}async $spliceResourceStates(e,r){await this._repositoryBarriers.get(e)?.wait();const i=this._repositories.get(e);if(!i)return;i.provider.$spliceGroupResourceStates(r)}async $unregisterGroup(e,r){await this._repositoryBarriers.get(e)?.wait();const i=this._repositories.get(e);if(!i)return;i.provider.$unregisterGroup(r)}async $setInputBoxValue(e,r){await this._repositoryBarriers.get(e)?.wait();const i=this._repositories.get(e);i&&i.input.setValue(r,!1)}async $setInputBoxPlaceholder(e,r){await this._repositoryBarriers.get(e)?.wait();const i=this._repositories.get(e);i&&(i.input.placeholder=r)}async $setInputBoxEnablement(e,r){await this._repositoryBarriers.get(e)?.wait();const i=this._repositories.get(e);i&&(i.input.enabled=r)}async $setInputBoxVisibility(e,r){await this._repositoryBarriers.get(e)?.wait();const i=this._repositories.get(e);i&&(i.input.visible=r)}async $showValidationMessage(e,r,i){await this._repositoryBarriers.get(e)?.wait();const t=this._repositories.get(e);t&&t.input.showValidationMessage(r,i)}async $setValidationProviderIsEnabled(e,r){await this._repositoryBarriers.get(e)?.wait();const i=this._repositories.get(e);i&&(r?i.input.validateInput=async(t,o)=>{const n=await this._proxy.$validateInput(e,t,o);return n&&{message:n[0],type:n[1]}}:i.input.validateInput=async()=>{})}async $onDidChangeHistoryProviderCurrentHistoryItemGroup(e,r){await this._repositoryBarriers.get(e)?.wait();const i=this._repositories.get(e);if(!i)return;i.provider.$onDidChangeHistoryProviderCurrentHistoryItemGroup(r)}};f=H([oe(ne.MainThreadSCM),c(1,ie),c(2,te),c(3,K),c(4,X),c(5,Y),c(6,re),c(7,Z),c(8,ee)],f);export{f as MainThreadSCM};
