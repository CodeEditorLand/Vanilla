var F=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var B=(l,e,t,r)=>{for(var s=r>1?void 0:r?G(e,t):e,n=l.length-1,i;n>=0;n--)(i=l[n])&&(s=(r?i(e,t,s):i(s))||s);return r&&s&&F(e,t,s),s},g=(l,e)=>(t,r)=>e(t,r,l);import{createReadStream as J,promises as _}from"fs";import*as D from"path";import*as K from"url";import*as I from"cookie";import*as Q from"crypto";import{isEqualOrParent as z}from"../../base/common/extpath.js";import{getMediaMime as X}from"../../base/common/mime.js";import{isLinux as q}from"../../base/common/platform.js";import{ILogService as V}from"../../platform/log/common/log.js";import{IServerEnvironmentService as Y}from"./serverEnvironmentService.js";import{extname as Z,dirname as ee,join as L,normalize as te}from"../../base/common/path.js";import{FileAccess as w,connectionTokenCookieName as A,connectionTokenQueryName as W,Schemas as re,builtinExtensionsPath as se}from"../../base/common/network.js";import{generateUuid as ie}from"../../base/common/uuid.js";import{IProductService as ne}from"../../platform/product/common/productService.js";import{ServerConnectionTokenType as oe}from"./serverConnectionToken.js";import{asTextOrError as ae,IRequestService as ce}from"../../platform/request/common/request.js";import{CancellationToken as le}from"../../base/common/cancellation.js";import{URI as N}from"../../base/common/uri.js";import{streamToBuffer as ue}from"../../base/common/buffer.js";import{isString as j}from"../../base/common/types.js";import{CharCode as M}from"../../base/common/charCode.js";import{isESM as O}from"../../base/common/amd.js";import{ICSSDevelopmentService as he}from"../../platform/cssDev/node/cssDevService.js";const pe={".html":"text/html",".js":"text/javascript",".json":"application/json",".css":"text/css",".svg":"image/svg+xml"};async function d(l,e,t,r){e.writeHead(t,{"Content-Type":"text/plain"}),e.end(r)}var me=(r=>(r[r.NO_CACHING=0]="NO_CACHING",r[r.ETAG=1]="ETAG",r[r.NO_EXPIRY=2]="NO_EXPIRY",r))(me||{});async function de(l,e,t,r,s,n){try{const i=await _.stat(l);if(e===1){const a=`W/"${[i.ino,i.size,i.mtime.getTime()].join("-")}"`;if(r.headers["if-none-match"]===a)return s.writeHead(304),void s.end();n.Etag=a}else e===2?n["Cache-Control"]="public, max-age=31536000":e===0&&(n["Cache-Control"]="no-store");n["Content-Type"]=pe[Z(l)]||X(l)||"text/plain",s.writeHead(200,n),J(l).pipe(s)}catch(i){return i.code!=="ENOENT"?(t.error(i),console.error(i.toString())):console.error(`File not found: ${l}`),s.writeHead(404,{"Content-Type":"text/plain"}),void s.end("Not found")}}const P=ee(w.asFileUri("").fsPath);let C=class{constructor(e,t,r,s,n,i,a,h){this._connectionToken=e;this._basePath=t;this.serverRootPath=r;this._environmentService=s;this._logService=n;this._requestService=i;this._productService=a;this._cssDevService=h;this._webExtensionResourceUrlTemplate=this._productService.extensionsGallery?.resourceUrlTemplate?N.parse(this._productService.extensionsGallery.resourceUrlTemplate):void 0,this._staticRoute=`${r}/static`,this._callbackRoute=`${r}/callback`,this._webExtensionRoute=`${r}/web-extension-resource`}_webExtensionResourceUrlTemplate;_staticRoute;_callbackRoute;_webExtensionRoute;async handle(e,t,r){try{const s=r.pathname;return s.startsWith(this._staticRoute)&&s.charCodeAt(this._staticRoute.length)===M.Slash?this._handleStatic(e,t,r):s===this._basePath?this._handleRoot(e,t,r):s===this._callbackRoute?this._handleCallback(t):s.startsWith(this._webExtensionRoute)&&s.charCodeAt(this._webExtensionRoute.length)===M.Slash?this._handleWebExtensionResource(e,t,r):d(e,t,404,"Not found.")}catch(s){return this._logService.error(s),console.error(s.toString()),d(e,t,500,"Internal Server Error.")}}async _handleStatic(e,t,r){const s=Object.create(null),i=decodeURIComponent(r.pathname).substring(this._staticRoute.length+1),a=L(P,i);return z(a,P,!q)?de(a,this._environmentService.isBuilt?2:1,this._logService,e,t,s):d(e,t,400,"Bad request.")}_getResourceURLTemplateAuthority(e){const t=e.authority.indexOf(".");return t!==-1?e.authority.substring(t+1):void 0}async _handleWebExtensionResource(e,t,r){if(!this._webExtensionResourceUrlTemplate)return d(e,t,500,"No extension gallery service configured.");const s=decodeURIComponent(r.pathname),n=te(s.substring(this._webExtensionRoute.length+1)),i=N.parse(n).with({scheme:this._webExtensionResourceUrlTemplate.scheme,authority:n.substring(0,n.indexOf("/")),path:n.substring(n.indexOf("/")+1)});if(this._getResourceURLTemplateAuthority(this._webExtensionResourceUrlTemplate)!==this._getResourceURLTemplateAuthority(i))return d(e,t,403,"Request Forbidden");const a={},h=c=>{const u=e.headers[c];u&&(j(u)||u[0])?a[c]=j(u)?u:u[0]:c!==c.toLowerCase()&&h(c.toLowerCase())};h("X-Client-Name"),h("X-Client-Version"),h("X-Machine-Id"),h("X-Client-Commit");const m=await this._requestService.request({type:"GET",url:i.toString(!0),headers:a},le.None),v=m.res.statusCode||500;if(v!==200){let c=null;try{c=await ae(m)}catch{}return d(e,t,v,c||`Request failed with status ${v}`)}const y=Object.create(null),f=c=>{const u=m.res.headers[c];u?y[c]=u:c!==c.toLowerCase()&&f(c.toLowerCase())};f("Cache-Control"),f("Content-Type"),t.writeHead(200,y);const b=await ue(m.stream);return void t.end(b.buffer)}async _handleRoot(e,t,r){const s=r.query[W];if(typeof s=="string"){const o=Object.create(null);o["Set-Cookie"]=I.serialize(A,s,{sameSite:"lax",maxAge:60*60*24*7});const p=Object.create(null);for(const k in r.query)k!==W&&(p[k]=r.query[k]);const S=K.format({pathname:r.pathname,query:p});return o.Location=S,t.writeHead(302,o),void t.end()}const n=o=>{const p=e.headers[o];return Array.isArray(p)?p[0]:p},i=!this._environmentService.isBuilt&&this._environmentService.args["use-test-resolver"],a=i?"test+test":n("x-original-host")||n("x-forwarded-host")||e.headers.host;if(!a)return d(e,t,400,"Bad request.");function h(o){return JSON.stringify(o).replace(/"/g,"&quot;")}let m;this._environmentService.args["enable-smoke-test-driver"]&&(m=!1);const v=o=>o&&N.file(D.resolve(o)).with({scheme:re.vscodeRemote,authority:a}),y=w.asFileUri(`vs/code/browser/workbench/workbench${this._environmentService.isBuilt?"":"-dev"}.${O?"esm.":""}html`).fsPath,f=!this._environmentService.isBuilt&&this._environmentService.args["github-auth"]?{id:ie(),providerId:"github",accessToken:this._environmentService.args["github-auth"],scopes:[["user:email"],["repo"]]}:void 0,b={embedderIdentifier:"server-distro",extensionsGallery:this._webExtensionResourceUrlTemplate&&this._productService.extensionsGallery?{...this._productService.extensionsGallery,resourceUrlTemplate:this._webExtensionResourceUrlTemplate.with({scheme:"http",authority:a,path:`${this._webExtensionRoute}/${this._webExtensionResourceUrlTemplate.authority}${this._webExtensionResourceUrlTemplate.path}`}).toString(!0)}:void 0};if(!this._environmentService.isBuilt)try{const o=JSON.parse((await _.readFile(L(P,"product.overrides.json"))).toString());Object.assign(b,o)}catch{}const c={remoteAuthority:a,serverBasePath:this._basePath,_wrapWebWorkerExtHostInIframe:m,developmentOptions:{enableSmokeTestDriver:this._environmentService.args["enable-smoke-test-driver"]?!0:void 0,logLevel:this._logService.getLevel()},settingsSyncOptions:!this._environmentService.isBuilt&&this._environmentService.args["enable-sync"]?{enabled:!0}:void 0,enableWorkspaceTrust:!this._environmentService.args["disable-workspace-trust"],folderUri:v(this._environmentService.args["default-folder"]),workspaceUri:v(this._environmentService.args["default-workspace"]),productConfiguration:b,callbackRoute:this._callbackRoute},U=I.parse(e.headers.cookie||"")["vscode.nls.locale"]||e.headers["accept-language"]?.split(",")[0]?.toLowerCase()||"en";let R,E;!U.startsWith("en")&&this._productService.nlsCoreBaseUrl?(R=this._productService.nlsCoreBaseUrl,E=`${R}${this._productService.commit}/${this._productService.version}/${U}/nls.messages.js`):E="";const T={WORKBENCH_WEB_CONFIGURATION:h(c),WORKBENCH_AUTH_SESSION:f?h(f):"",WORKBENCH_WEB_BASE_URL:this._staticRoute,WORKBENCH_NLS_URL:E,WORKBENCH_NLS_FALLBACK_URL:`${this._staticRoute}/out/nls.messages.js`};if(this._cssDevService.isEnabled){const o=await this._cssDevService.getCssModules();T.WORKBENCH_DEV_CSS_MODULES=JSON.stringify(o)}if(i){const o=[];for(const p of["vscode-test-resolver","github-authentication"]){const S=JSON.parse((await _.readFile(w.asFileUri(`${se}/${p}/package.json`).fsPath)).toString());o.push({extensionPath:p,packageJSON:S})}T.WORKBENCH_BUILTIN_EXTENSIONS=h(o)}let x;try{x=(await _.readFile(y)).toString().replace(/\{\{([^}]+)\}\}/g,(p,S)=>T[S]??"undefined")}catch{return t.writeHead(404,{"Content-Type":"text/plain"}),void t.end("Not found")}const H=O?"sha256-2Q+j4hfT09+1+imS46J2YlkCtHWQt0/BE79PXjJ0ZJ8=":"sha256-V28GQnL3aYxbwgpV3yW1oJ+VKKe/PBSzWntNyH8zVXA=",$={"Content-Type":"text/html","Content-Security-Policy":["default-src 'self';","img-src 'self' https: data: blob:;","media-src 'self';",O?`script-src 'self' 'unsafe-eval' ${R??""} blob: 'nonce-1nline-m4p' ${this._getScriptCspHashes(x).join(" ")} '${H}' 'sha256-/r7rqQ+yrxt57sxLuQ6AMYcy/lUpvAIzHjIJt/OeLWU=' ${i?"":`http://${a}`};`:`script-src 'self' 'unsafe-eval' ${R??""} ${this._getScriptCspHashes(x).join(" ")} '${H}' ${i?"":`http://${a}`};`,"child-src 'self';","frame-src 'self' https://*.vscode-cdn.net data:;","worker-src 'self' data: blob:;","style-src 'self' 'unsafe-inline';","connect-src 'self' ws: wss: https:;","font-src 'self' blob:;","manifest-src 'self';"].join(" ")};return this._connectionToken.type!==oe.None&&($["Set-Cookie"]=I.serialize(A,this._connectionToken.value,{sameSite:"lax",maxAge:60*60*24*7})),t.writeHead(200,$),void t.end(x)}_getScriptCspHashes(e){const t=/<script>([\s\S]+?)<\/script>/img,r=[];let s;for(;s=t.exec(e);){const n=Q.createHash("sha256"),i=s[1].replace(/\r\n/g,`
`),a=n.update(Buffer.from(i)).digest().toString("base64");r.push(`'sha256-${a}'`)}return r}async _handleCallback(e){const t=w.asFileUri("vs/code/browser/workbench/callback.html").fsPath,r=(await _.readFile(t)).toString(),s=["default-src 'self';","img-src 'self' https: data: blob:;","media-src 'none';",`script-src 'self' ${this._getScriptCspHashes(r).join(" ")};`,"style-src 'self' 'unsafe-inline';","font-src 'self' blob:;"].join(" ");return e.writeHead(200,{"Content-Type":"text/html","Content-Security-Policy":s}),void e.end(r)}};C=B([g(3,Y),g(4,V),g(5,ce),g(6,ne),g(7,he)],C);export{me as CacheControl,C as WebClientServer,d as serveError,de as serveFile};
