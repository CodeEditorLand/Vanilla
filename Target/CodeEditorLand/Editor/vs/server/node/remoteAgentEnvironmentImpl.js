import{basename as h}from"../../base/common/path.js";import*as S from"../../base/common/performance.js";import*as u from"../../base/common/platform.js";import{joinPath as P}from"../../base/common/resources.js";import{URI as p}from"../../base/common/uri.js";import{transformOutgoingURIs as I}from"../../base/common/uriIpc.js";import{listProcesses as d}from"../../base/node/ps.js";import{collectWorkspaceStats as y,getMachineInfo as _}from"../../platform/diagnostics/node/diagnosticsService.js";import{createURITransformer as l}from"../../workbench/api/node/uriTransformer.js";import{ServerConnectionTokenType as E}from"./serverConnectionToken.js";class f{constructor(t,r,e,o){this._connectionToken=t;this._environmentService=r;this._userDataProfilesService=e;this._extensionHostStatusService=o}static _namePool=1;async call(t,r,e){switch(r){case"getEnvironmentData":{const o=e,s=l(o.remoteAuthority);let i=await this._getEnvironmentData(o.profile);return i=I(i,s),i}case"getExtensionHostExitInfo":{const o=e;return this._extensionHostStatusService.getExitInfo(o.reconnectionToken)}case"getDiagnosticInfo":{const o=e,s={machineInfo:_()},i=o.includeProcesses?d(process.pid):Promise.resolve();let m=[];const c={};if(o.folders){const a=l("");m=o.folders.map(n=>p.revive(a.transformIncoming(n))).filter(n=>n.scheme==="file").map(n=>y(n.fsPath,["node_modules",".git"]).then(g=>{c[h(n.fsPath)]=g}))}return Promise.all([i,...m]).then(([a,v])=>(s.processes=a||void 0,s.workspaceMetadata=o.folders?c:void 0,s))}}throw new Error(`IPC Command ${r} not found`)}listen(t,r,e){throw new Error("Not supported")}async _getEnvironmentData(t){t&&!this._userDataProfilesService.profiles.some(e=>e.id===t)&&await this._userDataProfilesService.createProfile(t,t);let r=!1;if(process.platform==="linux"){const e=process.glibcVersion;r=(e?Number.parseInt(e.split(".")[1]):28)<=27}return{pid:process.pid,connectionToken:this._connectionToken.type!==E.None?this._connectionToken.value:"",appRoot:p.file(this._environmentService.appRoot),settingsPath:this._environmentService.machineSettingsResource,logsPath:this._environmentService.logsHome,extensionHostLogsPath:P(this._environmentService.logsHome,`exthost${f._namePool++}`),globalStorageHome:this._userDataProfilesService.defaultProfile.globalStorageHome,workspaceStorageHome:this._environmentService.workspaceStorageHome,localHistoryHome:this._environmentService.localHistoryHome,userHome:this._environmentService.userHome,os:u.OS,arch:process.arch,marks:S.getMarks(),useHostProxy:!!this._environmentService.args["use-host-proxy"],profiles:{home:this._userDataProfilesService.profilesHome,all:[...this._userDataProfilesService.profiles].map(e=>({...e}))},isUnsupportedGlibc:r}}}export{f as RemoteAgentEnvironmentChannel};
