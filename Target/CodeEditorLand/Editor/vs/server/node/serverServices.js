import{hostname as oe,release as ie}from"os";import{Emitter as se}from"../../../vs/base/common/event.js";import{toDisposable as me}from"../../../vs/base/common/lifecycle.js";import{Schemas as k}from"../../../vs/base/common/network.js";import*as y from"../../../vs/base/common/path.js";import"../../../vs/base/common/uriIpc.js";import{getdevDeviceId as ce,getMachineId as ae,getSqmMachineId as le}from"../../../vs/base/node/id.js";import{Promises as M}from"../../../vs/base/node/pfs.js";import{IPCServer as ve,StaticRouter as fe}from"../../../vs/base/parts/ipc/common/ipc.js";import{ProtocolConstants as H}from"../../../vs/base/parts/ipc/common/ipc.net.js";import{localize as ge}from"../../../vs/nls.js";import{IConfigurationService as Se}from"../../../vs/platform/configuration/common/configuration.js";import{ConfigurationService as pe}from"../../../vs/platform/configuration/common/configurationService.js";import{CSSDevelopmentService as de,ICSSDevelopmentService as Ce}from"../../../vs/platform/cssDev/node/cssDevService.js";import{ExtensionHostDebugBroadcastChannel as U}from"../../../vs/platform/debug/common/extensionHostDebugIpc.js";import{IDownloadService as ue}from"../../../vs/platform/download/common/download.js";import{DownloadServiceChannelClient as he}from"../../../vs/platform/download/common/downloadIpc.js";import{IEnvironmentService as Ie,INativeEnvironmentService as Ee}from"../../../vs/platform/environment/common/environment.js";import{ExtensionGalleryServiceWithNoStorageService as we}from"../../../vs/platform/extensionManagement/common/extensionGalleryService.js";import{IExtensionGalleryService as _}from"../../../vs/platform/extensionManagement/common/extensionManagement.js";import{ExtensionManagementCLI as xe}from"../../../vs/platform/extensionManagement/common/extensionManagementCLI.js";import{ExtensionManagementChannel as ye}from"../../../vs/platform/extensionManagement/common/extensionManagementIpc.js";import{IExtensionsProfileScannerService as Le}from"../../../vs/platform/extensionManagement/common/extensionsProfileScannerService.js";import{IExtensionsScannerService as G}from"../../../vs/platform/extensionManagement/common/extensionsScannerService.js";import{ExtensionManagementService as Te,INativeServerExtensionManagementService as F}from"../../../vs/platform/extensionManagement/node/extensionManagementService.js";import{ExtensionSignatureVerificationService as Pe,IExtensionSignatureVerificationService as Re}from"../../../vs/platform/extensionManagement/node/extensionSignatureVerificationService.js";import{ExtensionsProfileScannerService as Ae}from"../../../vs/platform/extensionManagement/node/extensionsProfileScannerService.js";import{IFileService as De}from"../../../vs/platform/files/common/files.js";import{FileService as be}from"../../../vs/platform/files/common/fileService.js";import{DiskFileSystemProvider as Ne}from"../../../vs/platform/files/node/diskFileSystemProvider.js";import{SyncDescriptor as f}from"../../../vs/platform/instantiation/common/descriptors.js";import"../../../vs/platform/instantiation/common/instantiation.js";import{InstantiationService as $e}from"../../../vs/platform/instantiation/common/instantiationService.js";import{ServiceCollection as ke}from"../../../vs/platform/instantiation/common/serviceCollection.js";import{ILanguagePackService as O}from"../../../vs/platform/languagePacks/common/languagePacks.js";import{NativeLanguagePackService as Me}from"../../../vs/platform/languagePacks/node/languagePacks.js";import{AbstractLogger as He,DEFAULT_LOG_LEVEL as Ue,getLogLevel as q,ILoggerService as _e,ILogService as Ge,log as Fe,LogLevel as u,LogLevelToString as Oe}from"../../../vs/platform/log/common/log.js";import{LoggerChannel as qe}from"../../../vs/platform/log/common/logIpc.js";import{LogService as je}from"../../../vs/platform/log/common/logService.js";import{LoggerService as Ve}from"../../../vs/platform/log/node/loggerService.js";import{NullPolicyService as Be}from"../../../vs/platform/policy/common/policy.js";import ze from"../../../vs/platform/product/common/product.js";import{IProductService as Ke}from"../../../vs/platform/product/common/productService.js";import"../../../vs/platform/remote/common/remoteAgentEnvironment.js";import{RemoteExtensionsScannerChannelName as We}from"../../../vs/platform/remote/common/remoteExtensionsScanner.js";import{IRequestService as j}from"../../../vs/platform/request/common/request.js";import{RequestChannel as Ye}from"../../../vs/platform/request/common/requestIpc.js";import{RequestService as Je}from"../../../vs/platform/request/node/requestService.js";import{resolveCommonProperties as Qe}from"../../../vs/platform/telemetry/common/commonProperties.js";import{ServerTelemetryChannel as Xe}from"../../../vs/platform/telemetry/common/remoteTelemetryChannel.js";import{IServerTelemetryService as L,ServerNullTelemetryService as Ze,ServerTelemetryService as er}from"../../../vs/platform/telemetry/common/serverTelemetryService.js";import{ITelemetryService as V,TelemetryLevel as h}from"../../../vs/platform/telemetry/common/telemetry.js";import"../../../vs/platform/telemetry/common/telemetryService.js";import{getPiiPathsFromEnvironment as rr,isInternalTelemetry as tr,isLoggingOnly as nr,NullAppender as or,supportsTelemetry as ir}from"../../../vs/platform/telemetry/common/telemetryUtils.js";import{OneDataSystemAppender as sr}from"../../../vs/platform/telemetry/node/1dsAppender.js";import mr from"../../../vs/platform/telemetry/node/errorTelemetry.js";import{IPtyService as cr,TerminalSettingId as ar}from"../../../vs/platform/terminal/common/terminal.js";import{NodePtyHostStarter as lr}from"../../../vs/platform/terminal/node/nodePtyHostStarter.js";import{PtyHostService as vr}from"../../../vs/platform/terminal/node/ptyHostService.js";import{IUriIdentityService as fr}from"../../../vs/platform/uriIdentity/common/uriIdentity.js";import{UriIdentityService as gr}from"../../../vs/platform/uriIdentity/common/uriIdentityService.js";import{IUserDataProfilesService as Sr}from"../../../vs/platform/userDataProfile/common/userDataProfile.js";import{RemoteUserDataProfilesServiceChannel as pr}from"../../../vs/platform/userDataProfile/common/userDataProfileIpc.js";import{ServerUserDataProfilesService as dr}from"../../../vs/platform/userDataProfile/node/userDataProfile.js";import{ExtensionHostStatusService as Cr,IExtensionHostStatusService as ur}from"../../../vs/server/node/extensionHostStatusService.js";import{ExtensionsScannerService as hr}from"../../../vs/server/node/extensionsScannerService.js";import{RemoteAgentEnvironmentChannel as Ir}from"../../../vs/server/node/remoteAgentEnvironmentImpl.js";import{RemoteExtensionsScannerChannel as Er,RemoteExtensionsScannerService as wr}from"../../../vs/server/node/remoteExtensionsScanner.js";import{RemoteAgentFileSystemProviderChannel as xr}from"../../../vs/server/node/remoteFileSystemProviderServer.js";import{RemoteTerminalChannel as yr}from"../../../vs/server/node/remoteTerminalChannel.js";import"../../../vs/server/node/serverConnectionToken.js";import{ServerEnvironmentService as Lr}from"../../../vs/server/node/serverEnvironmentService.js";import{createURITransformer as Tr}from"../../../vs/workbench/api/node/uriTransformer.js";import{REMOTE_TERMINAL_CHANNEL_NAME as Pr}from"../../../vs/workbench/contrib/terminal/common/remote/remoteTerminalChannel.js";import{REMOTE_FILE_SYSTEM_CHANNEL_NAME as Rr}from"../../../vs/workbench/services/remote/common/remoteFileSystemProviderClient.js";const Ar="monacoworkbench";async function vn(s,e,o,g){const r=new ke,m=new Dr,c={_serviceBrand:void 0,...ze};r.set(Ke,c);const t=new Lr(e,c);r.set(Ie,t),r.set(Ee,t);const E=new Ve(q(t),t.logsHome);r.set(_e,E),m.registerChannel("logger",new qe(E,i=>I(i.remoteAuthority)));const B=E.createLogger("remoteagent",{name:ge("remoteExtensionLog","Server")}),n=new je(B,[new br(q(t))]);r.set(Ge,n),setTimeout(()=>Nr(t.logsHome.with({scheme:k.file}).fsPath).then(null,i=>n.error(i)),1e4),n.onDidChangeLogLevel(i=>Fe(n,i,`Log level changed to ${Oe(n.getLevel())}`)),n.trace(`Remote configuration data at ${o}`),n.trace("process arguments:",t.args),Array.isArray(c.serverGreeting)&&n.info(`

${c.serverGreeting.join(`
`)}

`),m.registerChannel(U.ChannelName,new U);const z=new fe(i=>i.clientId==="renderer"),d=g.add(new be(n));r.set(De,d),d.registerProvider(k.file,g.add(new Ne(n)));const R=new gr(d);r.set(fr,R);const S=new pe(t.machineSettingsResource,d,new Be,n);r.set(Se,S);const C=new dr(R,t,d,n);r.set(Sr,C),m.registerChannel("userDataProfiles",new pr(C,i=>I(i.remoteAuthority))),r.set(Ce,new f(de,void 0,!0));const[,,K,W,Y]=await Promise.all([S.initialize(),C.init(),ae(n.error.bind(n)),le(n.error.bind(n)),ce(n.error.bind(n))]),A=new Cr;r.set(ur,A);const D=new Je(S,t,n,E);r.set(j,D);let w=or;const b=tr(c,S);if(ir(c,t)){!nr(c,t)&&c.aiConfig?.ariaKey&&(w=new sr(D,b,Ar,null,c.aiConfig.ariaKey),g.add(me(()=>w?.flush())));const i={appenders:[w],commonProperties:Qe(ie(),oe(),process.arch,c.commit,c.version+"-remote",K,W,Y,b,"remoteAgent"),piiPaths:rr(t)},l=t.args["telemetry-level"];let v=h.USAGE;l==="all"?v=h.USAGE:l==="error"?v=h.ERROR:l==="crash"?v=h.CRASH:l!==void 0&&(v=h.NONE),r.set(L,new f(er,[i,v]))}else r.set(L,Ze);r.set(_,new f(we));const J=m.getChannel("download",z);r.set(ue,new he(J,()=>I("renderer"))),r.set(Le,new f(Ae)),r.set(G,new f(hr)),r.set(Re,new f(Pe)),r.set(F,new f(Te));const p=new $e(r);r.set(O,p.createInstance(Me));const Q=p.createInstance(lr,{graceTime:H.ReconnectionGraceTime,shortGraceTime:H.ReconnectionShortGraceTime,scrollback:S.getValue(ar.PersistentSessionScrollback)??100}),N=p.createInstance(vr,Q);return r.set(cr,N),p.invokeFunction(i=>{const l=i.get(F),v=i.get(G),X=i.get(_),Z=i.get(O),ee=new Ir(s,t,C,A);m.registerChannel("remoteextensionsenvironment",ee);const re=new Xe(i.get(L),w);m.registerChannel("telemetry",re),m.registerChannel(Pr,new yr(t,n,N,c,l,S));const $=new wr(p.createInstance(xe,n),t,C,v,n,X,Z);m.registerChannel(We,new Er($,x=>I(x.remoteAuthority)));const te=g.add(new xr(n,t));m.registerChannel(Rr,te),m.registerChannel("request",new Ye(i.get(j)));const ne=new ye(l,x=>I(x.remoteAuthority));return m.registerChannel("extensions",ne),$.whenExtensionsReady().then(()=>l.cleanUp()),g.add(new mr(i.get(V))),{telemetryService:i.get(V)}}),{socketServer:m,instantiationService:p}}const T=Object.create(null);function I(s){return T[s]||(T[s]=Tr(s)),T[s]}class Dr extends ve{_onDidConnectEmitter;constructor(){const e=new se;super(e.event),this._onDidConnectEmitter=e}acceptConnection(e,o){this._onDidConnectEmitter.fire({protocol:e,onDidClientDisconnect:o})}}class br extends He{useColors;constructor(e=Ue){super(),this.setLevel(e),this.useColors=!!process.stdout.isTTY}trace(e,...o){this.checkLogLevel(u.Trace)&&(this.useColors?console.log(`\x1B[90m[${a()}]\x1B[0m`,e,...o):console.log(`[${a()}]`,e,...o))}debug(e,...o){this.checkLogLevel(u.Debug)&&(this.useColors?console.log(`\x1B[90m[${a()}]\x1B[0m`,e,...o):console.log(`[${a()}]`,e,...o))}info(e,...o){this.checkLogLevel(u.Info)&&(this.useColors?console.log(`\x1B[90m[${a()}]\x1B[0m`,e,...o):console.log(`[${a()}]`,e,...o))}warn(e,...o){this.checkLogLevel(u.Warning)&&(this.useColors?console.warn(`\x1B[93m[${a()}]\x1B[0m`,e,...o):console.warn(`[${a()}]`,e,...o))}error(e,...o){this.checkLogLevel(u.Error)&&(this.useColors?console.error(`\x1B[91m[${a()}]\x1B[0m`,e,...o):console.error(`[${a()}]`,e,...o))}flush(){}}function a(){const s=new Date;return`${P(s.getHours())}:${P(s.getMinutes())}:${P(s.getSeconds())}`}function P(s){return s<10?`0${s}`:String(s)}async function Nr(s){const e=y.basename(s),o=y.dirname(s),m=(await M.readdir(o)).filter(t=>/^\d{8}T\d{6}$/.test(t)).sort().filter(t=>t!==e),c=m.slice(0,Math.max(0,m.length-9));await Promise.all(c.map(t=>M.rm(y.join(o,t))))}export{Dr as SocketServer,vn as setupServerServices};
