import{ServiceCollection as d}from"../../platform/instantiation/common/serviceCollection.js";import{ConsoleLogger as h,getLogLevel as I,ILoggerService as w,ILogService as p,NullLogger as x}from"../../platform/log/common/log.js";import{SyncDescriptor as o}from"../../platform/instantiation/common/descriptors.js";import{ConfigurationService as E}from"../../platform/configuration/common/configurationService.js";import{IConfigurationService as g}from"../../platform/configuration/common/configuration.js";import{IRequestService as y}from"../../platform/request/common/request.js";import{RequestService as P}from"../../platform/request/node/requestService.js";import{NullTelemetryService as L}from"../../platform/telemetry/common/telemetryUtils.js";import{ITelemetryService as D}from"../../platform/telemetry/common/telemetry.js";import{IExtensionGalleryService as b}from"../../platform/extensionManagement/common/extensionManagement.js";import{ExtensionGalleryServiceWithNoStorageService as N}from"../../platform/extensionManagement/common/extensionGalleryService.js";import{ExtensionManagementService as R,INativeServerExtensionManagementService as V}from"../../platform/extensionManagement/node/extensionManagementService.js";import{ExtensionSignatureVerificationService as U,IExtensionSignatureVerificationService as A}from"../../platform/extensionManagement/node/extensionSignatureVerificationService.js";import{InstantiationService as C}from"../../platform/instantiation/common/instantiationService.js";import"../../platform/instantiation/common/instantiation.js";import f from"../../platform/product/common/product.js";import{Disposable as M}from"../../base/common/lifecycle.js";import{FileService as O}from"../../platform/files/common/fileService.js";import{DiskFileSystemProvider as F}from"../../platform/files/node/diskFileSystemProvider.js";import{Schemas as _}from"../../base/common/network.js";import{IFileService as H}from"../../platform/files/common/files.js";import{IProductService as k}from"../../platform/product/common/productService.js";import{IServerEnvironmentService as T,ServerEnvironmentService as X}from"./serverEnvironmentService.js";import{ExtensionManagementCLI as q}from"../../platform/extensionManagement/common/extensionManagementCLI.js";import{ILanguagePackService as z}from"../../platform/languagePacks/common/languagePacks.js";import{NativeLanguagePackService as G}from"../../platform/languagePacks/node/languagePacks.js";import"../../base/common/errors.js";import{URI as W}from"../../base/common/uri.js";import{isAbsolute as $,join as j}from"../../base/common/path.js";import{cwd as B}from"../../base/common/process.js";import{DownloadService as J}from"../../platform/download/common/downloadService.js";import{IDownloadService as K}from"../../platform/download/common/download.js";import{IUriIdentityService as Q}from"../../platform/uriIdentity/common/uriIdentity.js";import{UriIdentityService as Y}from"../../platform/uriIdentity/common/uriIdentityService.js";import"../../platform/environment/node/argv.js";import{isWindows as S}from"../../base/common/platform.js";import{IExtensionsScannerService as Z}from"../../platform/extensionManagement/common/extensionsScannerService.js";import{ExtensionsScannerService as ee}from"./extensionsScannerService.js";import{IUserDataProfilesService as re}from"../../platform/userDataProfile/common/userDataProfile.js";import{IExtensionsProfileScannerService as ie}from"../../platform/extensionManagement/common/extensionsProfileScannerService.js";import{NullPolicyService as te}from"../../platform/policy/common/policy.js";import{ServerUserDataProfilesService as oe}from"../../platform/userDataProfile/node/userDataProfile.js";import{ExtensionsProfileScannerService as se}from"../../platform/extensionManagement/node/extensionsProfileScannerService.js";import{LogService as ne}from"../../platform/log/common/logService.js";import{LoggerService as ae}from"../../platform/log/node/loggerService.js";import{localize as ce}from"../../nls.js";import{addUNCHostToAllowlist as me,disableUNCAccessRestrictions as le}from"../../base/node/unc.js";class ve extends M{constructor(e,r){super();this.args=e;this.remoteDataFolder=r;this.registerListeners()}registerListeners(){process.once("exit",()=>this.dispose())}async run(){const e=await this.initServices();await e.invokeFunction(async r=>{const t=r.get(g),n=r.get(p);S&&(t.getValue("security.restrictUNCAccess")===!1?le():me(t.getValue("security.allowedUNCHosts")));try{await this.doRun(e.createInstance(q,new h(n.getLevel(),!1)))}catch(i){throw n.error(i),i}})}async initServices(){const e=new d,r={_serviceBrand:void 0,...f};e.set(k,r);const t=new X(this.args,r);e.set(T,t);const n=new ae(I(t),t.logsHome);e.set(w,n);const i=new ne(this._register(n.createLogger("remoteCLI",{name:ce("remotecli","Remote CLI")})));e.set(p,i),i.trace(`Remote configuration data at ${this.remoteDataFolder}`),i.trace("process arguments:",this.args);const a=this._register(new O(i));e.set(H,a),a.registerProvider(_.file,this._register(new F(i)));const l=new Y(a);e.set(Q,l);const c=this._register(new oe(l,t,a,i));e.set(re,c);const v=this._register(new E(c.defaultProfile.settingsResource,a,new te,i));return e.set(g,v),await Promise.all([v.initialize(),c.init()]),e.set(y,new o(P,[new x])),e.set(K,new o(J)),e.set(D,L),e.set(b,new o(N)),e.set(ie,new o(se)),e.set(Z,new o(ee)),e.set(A,new o(U)),e.set(V,new o(R)),e.set(z,new o(G)),new C(e)}async doRun(e){if(this.args["list-extensions"])return e.listExtensions(!!this.args["show-versions"],this.args.category);if(this.args["install-extension"]||this.args["install-builtin-extension"]){const r={isMachineScoped:!!this.args["do-not-sync"],installPreReleaseVersion:!!this.args["pre-release"]};return e.installExtensions(this.asExtensionIdOrVSIX(this.args["install-extension"]||[]),this.asExtensionIdOrVSIX(this.args["install-builtin-extension"]||[]),r,!!this.args.force)}else{if(this.args["uninstall-extension"])return e.uninstallExtensions(this.asExtensionIdOrVSIX(this.args["uninstall-extension"]),!!this.args.force);if(this.args["update-extensions"])return e.updateExtensions();if(this.args["locate-extension"])return e.locateExtension(this.args["locate-extension"])}}asExtensionIdOrVSIX(e){return e.map(r=>/\.vsix$/i.test(r)?W.file($(r)?r:j(B(),r)):r)}}function u(s){setTimeout(()=>process.exit(s),0)}async function pr(s,m,e){if(s.help){const t=f.serverApplicationName+(S?".cmd":"");return}if(s.version)return;const r=new ve(s,m);try{await r.run(),u(0)}catch{u(1)}finally{r.dispose()}}export{pr as run};
