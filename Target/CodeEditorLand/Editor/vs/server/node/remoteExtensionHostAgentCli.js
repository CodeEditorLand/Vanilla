import{getErrorMessage as d}from"../../../vs/base/common/errors.js";import{Disposable as h}from"../../../vs/base/common/lifecycle.js";import{Schemas as I}from"../../../vs/base/common/network.js";import{isAbsolute as w,join as x}from"../../../vs/base/common/path.js";import{isWindows as p}from"../../../vs/base/common/platform.js";import{cwd as y}from"../../../vs/base/common/process.js";import{URI as E}from"../../../vs/base/common/uri.js";import{addUNCHostToAllowlist as P,disableUNCAccessRestrictions as L}from"vs/base/node/unc";import{localize as D}from"../../../vs/nls.js";import{IConfigurationService as g}from"../../../vs/platform/configuration/common/configuration.js";import{ConfigurationService as R}from"../../../vs/platform/configuration/common/configurationService.js";import{IDownloadService as N}from"../../../vs/platform/download/common/download.js";import{DownloadService as U}from"../../../vs/platform/download/common/downloadService.js";import{buildHelpMessage as V,buildVersionMessage as b}from"../../../vs/platform/environment/node/argv.js";import{ExtensionGalleryServiceWithNoStorageService as A}from"../../../vs/platform/extensionManagement/common/extensionGalleryService.js";import{IExtensionGalleryService as C}from"../../../vs/platform/extensionManagement/common/extensionManagement.js";import{ExtensionManagementCLI as O}from"../../../vs/platform/extensionManagement/common/extensionManagementCLI.js";import{IExtensionsProfileScannerService as F}from"../../../vs/platform/extensionManagement/common/extensionsProfileScannerService.js";import{IExtensionsScannerService as M}from"../../../vs/platform/extensionManagement/common/extensionsScannerService.js";import{ExtensionManagementService as _,INativeServerExtensionManagementService as k}from"../../../vs/platform/extensionManagement/node/extensionManagementService.js";import{ExtensionSignatureVerificationService as H,IExtensionSignatureVerificationService as T}from"../../../vs/platform/extensionManagement/node/extensionSignatureVerificationService.js";import{ExtensionsProfileScannerService as X}from"../../../vs/platform/extensionManagement/node/extensionsProfileScannerService.js";import{IFileService as q}from"../../../vs/platform/files/common/files.js";import{FileService as z}from"../../../vs/platform/files/common/fileService.js";import{DiskFileSystemProvider as G}from"../../../vs/platform/files/node/diskFileSystemProvider.js";import{SyncDescriptor as o}from"../../../vs/platform/instantiation/common/descriptors.js";import"../../../vs/platform/instantiation/common/instantiation.js";import{InstantiationService as W}from"../../../vs/platform/instantiation/common/instantiationService.js";import{ServiceCollection as $}from"../../../vs/platform/instantiation/common/serviceCollection.js";import{ILanguagePackService as j}from"../../../vs/platform/languagePacks/common/languagePacks.js";import{NativeLanguagePackService as B}from"../../../vs/platform/languagePacks/node/languagePacks.js";import{ConsoleLogger as J,getLogLevel as K,ILoggerService as Q,ILogService as S}from"../../../vs/platform/log/common/log.js";import{LogService as Y}from"../../../vs/platform/log/common/logService.js";import{LoggerService as Z}from"../../../vs/platform/log/node/loggerService.js";import{NullPolicyService as ee}from"../../../vs/platform/policy/common/policy.js";import n from"../../../vs/platform/product/common/product.js";import{IProductService as re}from"../../../vs/platform/product/common/productService.js";import{IRequestService as ie}from"../../../vs/platform/request/common/request.js";import{RequestService as te}from"../../../vs/platform/request/node/requestService.js";import{ITelemetryService as oe}from"../../../vs/platform/telemetry/common/telemetry.js";import{NullTelemetryService as se}from"../../../vs/platform/telemetry/common/telemetryUtils.js";import{IUriIdentityService as ne}from"../../../vs/platform/uriIdentity/common/uriIdentity.js";import{UriIdentityService as ae}from"../../../vs/platform/uriIdentity/common/uriIdentityService.js";import{IUserDataProfilesService as ce}from"../../../vs/platform/userDataProfile/common/userDataProfile.js";import{ServerUserDataProfilesService as me}from"../../../vs/platform/userDataProfile/node/userDataProfile.js";import{ExtensionsScannerService as le}from"../../../vs/server/node/extensionsScannerService.js";import{IServerEnvironmentService as ve,ServerEnvironmentService as fe}from"../../../vs/server/node/serverEnvironmentService.js";class pe extends h{constructor(e,r){super();this.args=e;this.remoteDataFolder=r;this.registerListeners()}registerListeners(){process.once("exit",()=>this.dispose())}async run(){const e=await this.initServices();await e.invokeFunction(async r=>{const t=r.get(g),a=r.get(S);p&&(t.getValue("security.restrictUNCAccess")===!1?L():P(t.getValue("security.allowedUNCHosts")));try{await this.doRun(e.createInstance(O,new J(a.getLevel(),!1)))}catch(i){throw a.error(i),console.error(d(i)),i}})}async initServices(){const e=new $,r={_serviceBrand:void 0,...n};e.set(re,r);const t=new fe(this.args,r);e.set(ve,t);const a=new Z(K(t),t.logsHome);e.set(Q,a);const i=new Y(this._register(a.createLogger("remoteCLI",{name:D("remotecli","Remote CLI")})));e.set(S,i),i.trace(`Remote configuration data at ${this.remoteDataFolder}`),i.trace("process arguments:",this.args);const c=this._register(new z(i));e.set(q,c),c.registerProvider(I.file,this._register(new G(i)));const v=new ae(c);e.set(ne,v);const m=this._register(new me(v,t,c,i));e.set(ce,m);const f=this._register(new R(m.defaultProfile.settingsResource,c,new ee,i));return e.set(g,f),await Promise.all([f.initialize(),m.init()]),e.set(ie,new o(te)),e.set(N,new o(U)),e.set(oe,se),e.set(C,new o(A)),e.set(F,new o(X)),e.set(M,new o(le)),e.set(T,new o(H)),e.set(k,new o(_)),e.set(j,new o(B)),new W(e)}async doRun(e){if(this.args["list-extensions"])return e.listExtensions(!!this.args["show-versions"],this.args.category);if(this.args["install-extension"]||this.args["install-builtin-extension"]){const r={isMachineScoped:!!this.args["do-not-sync"],installPreReleaseVersion:!!this.args["pre-release"]};return e.installExtensions(this.asExtensionIdOrVSIX(this.args["install-extension"]||[]),this.asExtensionIdOrVSIX(this.args["install-builtin-extension"]||[]),r,!!this.args.force)}else{if(this.args["uninstall-extension"])return e.uninstallExtensions(this.asExtensionIdOrVSIX(this.args["uninstall-extension"]),!!this.args.force);if(this.args["update-extensions"])return e.updateExtensions();if(this.args["locate-extension"])return e.locateExtension(this.args["locate-extension"])}}asExtensionIdOrVSIX(e){return e.map(r=>/\.vsix$/i.test(r)?E.file(w(r)?r:x(y(),r)):r)}}function u(s){setTimeout(()=>process.exit(s),0)}async function vr(s,l,e){if(s.help){const t=n.serverApplicationName+(p?".cmd":"");console.log(V(n.nameLong,t,n.version,e,{noInputFiles:!0,noPipe:!0}));return}if(s.version){console.log(b(n.version,n.commit));return}const r=new pe(s,l);try{await r.run(),u(0)}catch{u(1)}finally{r.dispose()}}export{vr as run};
